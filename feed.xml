<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="ko"><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://sweetlittlebird.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://sweetlittlebird.github.io/" rel="alternate" type="text/html" hreflang="ko" /><updated>2024-12-08T01:08:56+09:00</updated><id>https://sweetlittlebird.github.io/feed.xml</id><title type="html">Sweet Little Bird</title><subtitle>ê³µë¶€ ê¸°ë¡ê³¼ ê°œë°œ ì´ì•¼ê¸°ë¥¼ ë‹´ì€ ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.</subtitle><entry><title type="html">[CI/CD ë§›ë³´ê¸°] Jenkins CI/CD + Docker</title><link href="https://sweetlittlebird.github.io/posts/2024-12-08-CICD-Lite-Week1/" rel="alternate" type="text/html" title="[CI/CD ë§›ë³´ê¸°] Jenkins CI/CD + Docker" /><published>2024-12-08T00:50:18+09:00</published><updated>2024-12-08T00:50:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/CICD%20Lite%20-%20Week1</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2024-12-08-CICD-Lite-Week1/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ìŠ¤í„°ë”” ì‹œê°„ì´ ë‹¤ì‹œ ëŒì•„ì™”ìŠµë‹ˆë‹¤. ^^ ì´ë²ˆ ìŠ¤í„°ë””ëŠ” 3ì£¼ì°¨ì˜ ë‹¤ì†Œ ì§§ì€ ìŠ¤í„°ë””ë¡œ CI/CDì— ê´€ë ¨í•´ì„œ ì§„í–‰ë©ë‹ˆë‹¤.
ì¦ê±°ìš´ ì—°ë§ ë‹¤ì‹œ í•œë²ˆ ê³¼ì œë¡œ ë‹¬ë ¤ë³´ê² ìŠµë‹ˆë‹¤. :laughing:</p>

<p>ì´ë²ˆ ì£¼ì—ëŠ” Jenkinsì™€ Git, Dockerë¥¼ ì´ìš©í•˜ì—¬ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h2 id="jenkins-cicd--docker">Jenkins CI/CD + Docker</h2>

<h3 id="cicdë€">CI/CDë€?</h3>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_1.png" alt="img.png" class="image-center" />
<em class="image-caption">CI/CD íŒŒì´í”„ë¼ì¸ (ì¶œì²˜:<a href="https://blog.devgenius.io/what-is-ci-cd-concept-375cb226cf3d">Dev Genius</a>)</em></p>

<ul>
  <li>CI/CDëŠ” Continuous Integration(ì§€ì†ì  í†µí•©)ê³¼ Continuous Deployment(ì§€ì†ì  ë°°í¬)ì˜ ì•½ìë¡œ ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œì˜ ê³„íšë‹¨ê³„ì—ì„œ ë¶€í„° ë°°í¬/ìš´ì˜ê¹Œì§€ ì „ ê³¼ì •ì— ê±¸ì³
ìë™í™”ëœ í”„ë¡œì„¸ìŠ¤ë¥¼ í†µí•´ ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ ë¹ ë¥´ê²Œ, ì•ˆì •ì ìœ¼ë¡œ ë°°í¬í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë°©ë²•ë¡ ì…ë‹ˆë‹¤.</li>
  <li>CIì™€ CDë¡œ ë‚˜ëˆ ì„œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>CI : ì—¬ëŸ¬ ê°œë°œìë“¤ì´ ì‘ì„±í•œ ì½”ë“œë¥¼ í•˜ë‚˜ë¡œ í†µí•©í•˜ëŠ” ì½”ë“œì˜ í†µí•©ì„ ì§€ì†ì ìœ¼ë¡œ ì§„í–‰í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
        <ul>
          <li>CIì˜ ë‹¨ê³„ : ê³„íš -&gt; ì½”ë”© -&gt; ë¹Œë“œ -&gt; í…ŒìŠ¤íŠ¸ -&gt; íŒ¨í‚¤ì§•</li>
        </ul>
      </li>
      <li>CD : CIë¥¼ í†µí•´ ë¹Œë“œëœ ê²°ê³¼ë¬¼ì„ ë°°í¬í•˜ê³  ìš´ì˜í•˜ê³ , ëª¨ë‹ˆí„°ë§ì„ í†µí•´ ê°œì„ í•  ì ì„ íŒŒì•…í•˜ëŠ” ê³¼ì •ì„ ì§€ì†ì ìœ¼ë¡œ ì§„í–‰í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
        <ul>
          <li>CDì˜ ë‹¨ê³„ : ë°°í¬ -&gt; ìš´ì˜ -&gt; ëª¨ë‹ˆí„°ë§ -&gt; í”¼ë“œë°±</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>CI/CDëŠ” ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ ë‹¤ì–‘í•œ íˆ´ë“¤ë¡œ êµ¬ì„±ì´ ë˜ë©° ì´ë²ˆì£¼ì—ëŠ” Jenkinsì™€ Git, Dockerë¥¼ ì´ìš©í•˜ì—¬ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ì»¨í…Œì´ë„ˆë¥¼-ì´ìš©í•œ-ì–´í”Œë¦¬ì¼€ì´ì…˜-ê°œë°œ">ì»¨í…Œì´ë„ˆë¥¼ ì´ìš©í•œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œ</h3>

<p>CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•˜ê¸° ìœ„í•´ Dockerë¥¼ ì´ìš©í•˜ì—¬ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì»¨í…Œì´ë„ˆí™”í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h4 id="rubyë¡œ-íŠ¹ì •-ë¬¸ìì—´-ì¶œë ¥í•˜ëŠ”-ê°„ë‹¨í•œ-ì–´í”Œë¦¬ì¼€ì´ì…˜-ë§Œë“¤ê¸°">rubyë¡œ íŠ¹ì • ë¬¸ìì—´ ì¶œë ¥í•˜ëŠ” ê°„ë‹¨í•œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë§Œë“¤ê¸°</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span><span class="nb">mkdir </span>1.1 <span class="o">&amp;&amp;</span> <span class="nb">cd </span>1.1
  <span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'puts "Hello Docker!"'</span> <span class="o">&gt;</span> hello.rb
  
  <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Dockerfile <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
  FROM ruby:3.3
  COPY hello.rb /app/
  WORKDIR /app
  CMD ["ruby", "hello.rb"]
</span><span class="no">  EOF
  
</span>  <span class="c"># ì´ë¯¸ì§€ ë¹Œë“œ</span>
  <span class="nv">$ </span>docker build <span class="nt">-t</span> hello <span class="nb">.</span>
  <span class="c"># =&gt; [+] Building 36.6s (9/9) FINISHED</span>
  <span class="nv">$ </span>docker image <span class="nb">ls</span> <span class="nt">-f</span> <span class="nv">reference</span><span class="o">=</span>hello
  <span class="c"># =&gt; REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span>
  <span class="c">#    hello        latest    d0c55f1ebe18   35 seconds ago   1GB</span>
  
  <span class="c"># ì‹¤í–‰</span>
  <span class="nv">$ </span>docker run hello
  <span class="c"># =&gt; Hello Docker!</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ì½”ë“œ ìˆ˜ì •</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì½”ë“œ ìˆ˜ì •</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"puts 'Hello CloudNet@'"</span> <span class="o">&gt;</span> hello.rb
  
<span class="c"># ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ</span>
<span class="nv">$ </span>docker build <span class="nb">.</span> <span class="nt">-t</span> hello:1
<span class="nv">$ </span>docker image <span class="nb">ls</span> <span class="nt">-f</span> <span class="nv">reference</span><span class="o">=</span>hello
<span class="c"># =&gt; REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span>
<span class="c">#    hello        1         7fe4f428d492   3 seconds ago   1GB</span>
<span class="c">#    hello        latest    d0c55f1ebe18   3 minutes ago   1GB  </span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ Latest íƒœê·¸ëŠ” IMAGE IDë¥¼ í†µí•´ ì•„ì§ ì´ì „ì˜ ì´ë¯¸ì§€ë¥¼ ê°–ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
  
<span class="c"># 1ë²ˆ íƒœê·¸ì— ì¶”ê°€ì ìœ¼ë¡œ latest íƒœê·¸ë¥¼ ë¶™ì—¬ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>docker tag hello:1 hello:latest
<span class="nv">$ </span>docker image <span class="nb">ls</span> <span class="nt">-f</span> <span class="nv">reference</span><span class="o">=</span>hello
<span class="c"># =&gt; REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span>
<span class="c">#    hello        1         7fe4f428d492   36 seconds ago   1GB</span>
<span class="c">#    hello        latest    7fe4f428d492   36 seconds ago   1GB</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ Latest íƒœê·¸ë„ ë™ì¼í•œ IMAGE IDë¥¼ ê°–ê²Œë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
  
<span class="c"># ì»¨í…Œì´ë„ˆ ì‹¤í–‰</span>
<span class="nv">$ </span>docker run <span class="nt">--rm</span> hello:1
<span class="c"># =&gt; Hello CloudNet@</span>
<span class="nv">$ </span>docker run <span class="nt">--rm</span> hello
<span class="c"># =&gt; Hello CloudNet@</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="compiling-code-in-docker">Compiling code in Docker</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># ì½”ë“œ ì‘ì„±</span>
  <span class="nv">$ </span><span class="nb">mkdir </span>1.2 <span class="o">&amp;&amp;</span> <span class="nb">cd </span>1.2
  
  <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Hello.java <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
  class Hello {
      public static void main(String[] args) {
          System.out.println("Hello Docker");
      }
  }
</span><span class="no">  EOF
  
</span>  <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Dockerfile <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
  FROM openjdk
  COPY . /app
  WORKDIR /app
  RUN javac Hello.java    # ì»´íŒŒì¼
  CMD java Hello
</span><span class="no">  EOF
  
</span>  <span class="c"># ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ</span>
  <span class="nv">$ </span>docker pull openjdk
  <span class="nv">$ </span>docker build <span class="nb">.</span> <span class="nt">-t</span> hello:2 <span class="nt">-t</span> hello:latest
  <span class="c"># =&gt; [+] Building 0.8s (9/9) FINISHED</span>
  <span class="nv">$ </span>docker image <span class="nb">ls</span> <span class="nt">-f</span> <span class="nv">reference</span><span class="o">=</span>hello
  <span class="c"># =&gt; REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span>
  <span class="c">#    hello        2         ba37ddf45c26   10 seconds ago   487MB</span>
  <span class="c">#    hello        latest    ba37ddf45c26   10 seconds ago   487MB</span>
  <span class="c">#    hello        1         7fe4f428d492   9 minutes ago    1GB</span>
  
  <span class="c"># ì»¨í…Œì´ë„ˆ ì‹¤í–‰</span>
  <span class="nv">$ </span>docker run <span class="nt">--rm</span> hello:2
  <span class="c"># =&gt; Hello Docker</span>
  <span class="nv">$ </span>docker run <span class="nt">--rm</span> hello
  <span class="c"># =&gt; Hello Docker</span>
  
  <span class="c"># ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë‚´ë¶€ì— íŒŒì¼ ëª©ë¡ì„ ë³´ë©´ ì–´ë–¤ê°€ìš”? ê¼­ í•„ìš”í•œ íŒŒì¼ë§Œ ìˆëŠ”ê°€ìš”? ë³´ì•ˆì ìœ¼ë¡œ ì–´ë–¨ê¹Œìš”?</span>
  <span class="nv">$ </span>docker run <span class="nt">--rm</span> hello <span class="nb">ls</span> <span class="nt">-l</span>
  <span class="c"># =&gt; -rw-r--r-- 1 root root  89 Dec  5 15:04 Dockerfile</span>
  <span class="c">#    -rw-r--r-- 1 root root 416 Dec  5 15:05 Hello.class</span>
  <span class="c">#    -rw-r--r-- 1 root root 111 Dec  5 15:04 Hello.java</span>
  <span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê¼­ í•„ìš”í•œ íŒŒì¼ ì™¸ì—ë„ Dockerfile, *.java íŒŒì¼, java ì»´íŒŒì¼ëŸ¬ ë“±ì´ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
  <span class="c"># &lt;span style="color: green;"&gt;   ì´ íŒŒì¼ë“¤ì€ ì •ë³´ ìœ ì¶œì´ë‚˜ ê³µê²© ëŒ€ìƒì´ ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì— ì—†ì–´ì•¼ í•©ë‹ˆë‹¤.&lt;/span&gt;</span>
  
  <span class="c"># RUN ì»´íŒŒì¼ ì‹œ ì†ŒìŠ¤ì½”ë“œì™€ java ì»´íŒŒì¼ëŸ¬(javac)ê°€ í¬í•¨ë˜ì–´ ìˆìŒ. ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ì— í•„ìš” ì—†ìŒ. </span>
  <span class="nv">$ </span>docker run <span class="nt">--rm</span> hello javac <span class="nt">--help</span>
  <span class="c"># =&gt; Usage: javac &amp;lt;options&amp;gt; &amp;lt;source files&amp;gt;</span>
  <span class="c">#    where possible options include:</span>
  <span class="c">#      @&amp;lt;filename&amp;gt;                  Read options and filenames from file</span>
  <span class="c">#    ...</span>
</code></pre></div></div>

<h4 id="ë©€í‹°-ìŠ¤í…Œì´ì§€-ë¹Œë“œ">ë©€í‹° ìŠ¤í…Œì´ì§€ ë¹Œë“œ</h4>
<ul>
  <li>ë©€í‹° ìŠ¤í…Œì´ì§€ ë¹Œë“œëŠ” ë¹Œë“œë¥¼ ì—¬ëŸ¬ ë‹¨ê³„ë¡œ ë‚˜ëˆ„ì–´ì„œ ì§„í–‰í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.</li>
  <li>ê° ë‹¨ê³„ë§ˆë‹¤ í•„ìš”í•œ í™˜ê²½ì„ êµ¬ì„±í•˜ì—¬ ë¹Œë“œë¥¼ ì§„í–‰í•˜ê³ , ìµœì¢…ì ìœ¼ë¡œ í•„ìš”í•œ íŒŒì¼ë§Œì„ ì¶”ì¶œí•˜ì—¬ ë¶ˆí•„ìš”í•œ íŒŒì¼ë“¤ì´ ì œì™¸ëœ
ê°€ë³ê³  ì•ˆì „í•œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  <img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_2.png" alt="img.png" class="image-center" />
  <em class="image-caption">ë©€í‹° ìŠ¤í…Œì´ì§€ ë¹Œë“œ ë™ì‘</em></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># ì½”ë“œ ì‘ì„±</span>
  <span class="nv">$ </span><span class="nb">mkdir </span>1.3 <span class="o">&amp;&amp;</span> <span class="nb">cd </span>1.3
  
  <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Hello.java <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
  class Hello {
      public static void main(String[] args) {
          System.out.println("Hello Multistage container build");
      }
  }
</span><span class="no">  EOF
  
</span>  <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Dockerfile <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
  FROM openjdk:11 AS buildstage
  COPY . /app
  WORKDIR /app
  RUN javac Hello.java
  
  FROM openjdk:11-jre-slim
  COPY --from=buildstage /app/Hello.class /app/
  WORKDIR /app
  CMD java Hello
</span><span class="no">  EOF
  
</span>  <span class="c"># ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ : ìš©ëŸ‰ ë¹„êµ í•´ë³´ì!</span>
  <span class="nv">$ </span>docker build <span class="nb">.</span> <span class="nt">-t</span> hello:3 <span class="nt">-t</span> hello:latest
  <span class="nv">$ </span>docker image <span class="nb">ls</span> <span class="nt">-f</span> <span class="nv">reference</span><span class="o">=</span>hello
  <span class="c"># =&gt; REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span>
  <span class="c">#    hello        3         4a058414ac44   11 seconds ago   216MB</span>
  <span class="c">#    hello        latest    4a058414ac44   11 seconds ago   216MB</span>
  <span class="c">#    hello        2         ba37ddf45c26   24 minutes ago   487MB</span>
  <span class="c">#    ...</span>
  <span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ Compilerê°€ ì—†ëŠ” ê°€ë²¼ìš´ jre ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ í¬ê¸°ë„ ì¤„ì–´ë“  ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
  
  <span class="c"># ì»¨í…Œì´ë„ˆ ì‹¤í–‰</span>
  <span class="nv">$ </span>docker run <span class="nt">--rm</span> hello:3
  <span class="c"># =&gt; Hello Multistage container build</span>
  <span class="nv">$ </span>docker run <span class="nt">--rm</span> hello
  <span class="c"># =&gt; Hello Multistage container build</span>
  
  <span class="c"># ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë‚´ë¶€ì— íŒŒì¼ ëª©ë¡ì„ ë³´ë©´ ì–´ë–¤ê°€ìš”?</span>
  <span class="nv">$ </span>docker run <span class="nt">--rm</span> hello <span class="nb">ls</span> <span class="nt">-l</span>
  <span class="c"># =&gt; total 4</span>
  <span class="c">#    -rw-r--r-- 1 root root 436 Dec  5 15:26 Hello.class</span>
  <span class="nv">$ </span>docker run <span class="nt">--rm</span> hello javac <span class="nt">--help</span>
  <span class="c"># =&gt; docker: Error response from daemon: OCI runtime create failed: container_linux.go:380: starting container process caused: exec: &amp;quot;javac&amp;quot;: executable file not found in $PATH: unknown.</span>
  <span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ javacê°€ ì—†ì–´ì„œ ì´ì „ë³´ë‹¤ ì•ˆì „í•œê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h4 id="jibë¡œ-ìë°”-ì»¨í…Œì´ë„ˆ-ë¹Œë“œ">Jibë¡œ ìë°” ì»¨í…Œì´ë„ˆ ë¹Œë“œ</h4>
<p><a href="https://cloud.google.com/java/getting-started/jib?hl=ko">ë¬¸ì„œ</a>, 
  <a href="https://colevelup.tistory.com/53">ê´€ë ¨ ë¸”ë¡œê·¸1</a>,
  <a href="https://jh-labs.tistory.com/509">ê´€ë ¨ ë¸”ë¡œê·¸2</a></p>
<ul>
  <li>JibëŠ” Googleì—ì„œ ë§Œë“  ì˜¤í”ˆì†ŒìŠ¤ ë„êµ¬ë¡œ, Java ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¡œ ë¹Œë“œí•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.</li>
  <li>JibëŠ” docker ì—†ì´ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•  ìˆ˜ ìˆìœ¼ë©°, ë¹Œë“œ ì†ë„ê°€ ë¹ ë¥´ê³ , ì´ë¯¸ì§€ í¬ê¸°ê°€ ì‘ì•„ì„œ ë°°í¬ê°€ ìš©ì´í•©ë‹ˆë‹¤.</li>
  <li>Maven ë˜ëŠ” Gradle í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê¸°ì¡´ì˜ Docker ì´ë¯¸ì§€ ë¹Œë“œ íë¦„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_3.png" alt="img.png" /></li>
  <li>JibëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë¹Œë“œ íë¦„ì´ ê°„ì†Œí™”ë©ë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_4.png" alt="img.png" />
    <ul>
      <li>ë¹Œë“œì™€ ë™ì‹œì— ì´ë¯¸ì§€ê°€ ë§Œë“¤ì–´ì§€ê³  ì €ì¥ì†Œì— í‘¸ì‹œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li>Jenkins ë“±ì˜ CI ì„œë²„ì— Dockerê°€ ì—†ì–´ë„ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ì´ë¯¸ì§€ ë ˆì´ì–´ ìºì‹±ì„ í†µí•´ ë¹Œë“œ ì†ë„ê°€ ë¹ ë¦…ë‹ˆë‹¤.</li>
      <li>ì´ë¯¸ì§€ í¬ê¸°ê°€ ì‘ì•„ì„œ ë°°í¬ê°€ ìš©ì´í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h4 id="ì–´í”Œë¦¬ì¼€ì´ì…˜-ì„œë²„-ì»¨í…Œì´ë„ˆí™”-í•˜ê¸°">ì–´í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ ì»¨í…Œì´ë„ˆí™” í•˜ê¸°</h4>

<ul>
  <li>ë°ëª¨ë¥¼ ìœ„í•´ HTTP ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì»¨í…Œì´ë„ˆí™” í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ë‹¤ìŒì€ ruby ì–¸ì–´ë¡œ ì‘ì„±í•œ ê¸°ë³¸ì ì¸ ì›¹ì„œë²„ë¡œ, í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ì„ í‘œì‹œí•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir </span>1.4 <span class="o">&amp;&amp;</span> <span class="nb">cd </span>1.4

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> app.rb <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
require 'sinatra'

get '/' do
  "Hello, World! The time is #{Time.now}"
end
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Dockerfile <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
FROM ruby:3.3
RUN gem install sinatra rackup puma
COPY app.rb /app/
WORKDIR /app
CMD ["ruby", "app.rb", "-o", "0.0.0.0"]
</span><span class="no">EOF

</span><span class="c"># ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ</span>

<span class="nv">$ </span>docker build <span class="nb">.</span> <span class="nt">-t</span> timeserver:1 <span class="o">&amp;&amp;</span> docker tag timeserver:1 timeserver:latest
<span class="nv">$ </span>docker image <span class="nb">ls</span> <span class="nt">-f</span> <span class="nv">reference</span><span class="o">=</span>timeserver
<span class="c"># =&gt; REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span>
<span class="c">#    timeserver   1         6393669e5e68   12 seconds ago   1GB</span>
<span class="c">#    timeserver   latest    6393669e5e68   12 seconds ago   1GB</span>

<span class="c"># ì»¨í…Œì´ë„ˆ ì‹¤í–‰</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 8080:4567 <span class="nt">--name</span><span class="o">=</span>timeserver timeserver

<span class="c"># ì»¨í…Œì´ë„ˆ ì ‘ì† ë° ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>curl http://localhost:8080
<span class="c"># =&gt; Hello, World! The time is 2024-10-01 15:28:18 +0000</span>
<span class="nv">$ </span>docker logs timeserver
<span class="c"># =&gt; Puma starting in single mode...</span>
<span class="c">#    * Puma version: 6.5.0 (&amp;quot;Sky's Version&amp;quot;)</span>
<span class="c">#    == Sinatra (v4.1.1) has taken the stage on 4567 for development with backup from Puma</span>
<span class="c">#    * Ruby version: ruby 3.3.6 (2024-10-01 revision 75015d4c1f) [aarch64-linux]</span>
<span class="c">#    *  Min threads: 0</span>
<span class="c">#    *  Max threads: 5</span>
<span class="c">#    *  Environment: development</span>
<span class="c">#    *          PID: 1</span>
<span class="c">#    * Listening on http://0.0.0.0:4567</span>
<span class="c">#    Use Ctrl-C to stop</span>
<span class="c">#    172.17.0.1 - - [01/Oct/2024:15:28:07 +0000] &amp;quot;GET / HTTP/1.1&amp;quot; 200 51 0.0048</span>

<span class="c"># ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë‚´ë¶€ì— íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> timeserver <span class="nb">ls</span> <span class="nt">-l</span>
<span class="c"># =&gt; total 4</span>
<span class="c">#    -rw-r--r-- 1 root root 76 Dec  6 15:20 app.rb</span>
</code></pre></div></div>

<ul>
  <li>ë„ì»¤ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ì†ŒìŠ¤ì½”ë“œë¥¼ ìˆ˜ì •í•´ì„œ ë°˜ì˜ë˜ëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_5.png" alt="20241205_cicd_lite_w1_5.png" class="image-center" />
<em class="image-caption">vscodeì— docker í™•ì¥ ì„¤ì¹˜</em></p>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_6.png" alt="20241205_cicd_lite_w1_6.png" class="image-center" />
<em class="image-caption">timeserver ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ app.rb íŒŒì¼ ìˆ˜ì •</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë‚´ë¶€ì— app.rb íŒŒì¼ ìˆ˜ì • í›„ ë°˜ì˜ í™•ì¸ : VSCODE ê²½ìš° docker í™•ì¥í”„ë¡œê·¸ë¨ í™œìš©</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> timeserver <span class="nb">cat </span>app.rb
<span class="c"># =&gt; require 'sinatra'</span>
<span class="c">#    </span>
<span class="c">#    get '/' do</span>
<span class="c">#      &amp;quot;Hello, World! ğŸ˜€ The time is #{Time.now}&amp;quot;</span>
<span class="c">#    end</span>

<span class="c"># ì»¨í…Œì´ë„ˆ ì ‘ì† í›„ í™•ì¸ </span>
<span class="nv">$ </span>curl http://localhost:8080
<span class="c"># =&gt; Hello, World! The time is 2024-10-01 15:45:09 +0000%</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ìˆ˜ì • ì‚¬í•­ì´ ë°˜ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!&lt;/span&gt;</span>

<span class="c"># ì»¨í…Œì´ë„ˆ ì‚­ì œ</span>
<span class="nv">$ </span>docker <span class="nb">rm</span> <span class="nt">-f</span> timeserver
</code></pre></div></div>

<ul>
  <li>ì–´í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì •í•´ì„œ í…ŒìŠ¤íŠ¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s#World!#World! ğŸ˜€ Hello CloudNeta Study!#'</span> app.rb
<span class="nv">$ </span><span class="nb">cat </span>app.rb
<span class="c"># =&gt; require 'sinatra'</span>
<span class="c">#    </span>
<span class="c">#    get '/' do</span>
<span class="c">#      &amp;quot;Hello, World! ğŸ˜€ Hello CloudNeta Study! The time is #{Time.now}&amp;quot;</span>
<span class="c">#    end</span>

<span class="c"># ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ</span>
<span class="nv">$ </span>docker build <span class="nb">.</span> <span class="nt">-t</span> timeserver:2 <span class="nt">-t</span> timeserver:latest
<span class="nv">$ </span>docker image <span class="nb">ls</span> <span class="nt">-f</span> <span class="nv">reference</span><span class="o">=</span>timeserver
<span class="c"># =&gt; REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span>
<span class="c">#    timeserver   2         80f230757e3c   2 seconds ago    1.01GB</span>
<span class="c">#    timeserver   latest    80f230757e3c   2 seconds ago    1.01GB</span>
<span class="c">#    timeserver   1         c7055ab70155   27 minutes ago   1.01GB</span>

<span class="c"># ì»¨í…Œì´ë„ˆ ì‹¤í–‰</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 8080:4567 <span class="nt">--name</span><span class="o">=</span>timeserver timeserver
<span class="c"># =&gt; 278108d26b3998c8281add75b631d59a9d44abd4eb3e4f173b0b156d66e5da75</span>

<span class="c"># ì»¨í…Œì´ë„ˆ ì ‘ì† ë° ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>curl http://localhost:8080
<span class="c"># =&gt; Hello, World! ğŸ˜€ Hello CloudNeta Study! The time is 2024-10-01 15:55:19 +0000</span>

<span class="c"># ì»¨í…Œì´ë„ˆ ì‚­ì œ</span>
<span class="nv">$ </span>docker <span class="nb">rm</span> <span class="nt">-f</span> timeserver
</code></pre></div></div>

<h4 id="ë¡œì»¬-ê°œë°œì„-ìœ„í•œ-ë°©ì•ˆ">ë¡œì»¬ ê°œë°œì„ ìœ„í•œ ë°©ì•ˆ</h4>

<ul>
  <li>ì†ŒìŠ¤ë¥¼ ìˆ˜ì •í•  ë•Œë§ˆë‹¤ ìœ„ì™€ ê°™ì´ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•˜ëŠ” ê²ƒì€ ë²ˆê±°ë¡­ìŠµë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ í¸ë¦¬í•˜ê²Œ í•˜ê¸° ìœ„í•´ì„œ ë¡œì»¬ í´ë”ì™€ ì»¨í…Œì´ë„ˆì˜ ì•± ì†ŒìŠ¤ë¥¼ ë§¤í•‘í•˜ê³ , ì½”ë“œ ë‚´ìš©ì„ ë™ì ìœ¼ë¡œ ë°˜ì˜í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir </span>1.5 <span class="o">&amp;&amp;</span> <span class="nb">cd </span>1.5

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> app.rb <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
require 'sinatra/base'

class App &lt; Sinatra::Base
  get '/' do
    "Hello, World! The time is #{Time.now}"
  end
end
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> config.ru <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
require 'rack/unreloader'
require 'sinatra'
Unreloader = Rack::Unreloader.new{App}
Unreloader.require './app.rb'

run Unreloader
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Dockerfile <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
FROM ruby:3.3
RUN gem install sinatra rackup puma </span><span class="se">\</span><span class="sh">
    rack-unreloader # ì†ŒìŠ¤ì½”ë“œ ë³€ê²½ì‹œ ìë™ìœ¼ë¡œ ë°˜ì˜í•˜ê¸°ìœ„í•œ íˆ´
COPY app.rb config.ru /app/
WORKDIR /app
CMD ["rackup", "--host", "0.0.0.0"]
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> docker-compose.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
services:
  frontend:
    build: .
    command: rackup --host 0.0.0.0
    volumes:
      - type: bind
        source: .
        target: /app
    ports:
      - "8080:9292"
</span><span class="no">EOF

</span><span class="c"># ë„ì»¤ ì»´í¬ì¦ˆë¡œ ì»¨í…Œì´ë„ˆ ë¹Œë“œ</span>
<span class="nv">$ </span>docker compose build 
<span class="c"># ë„ì»¤ ì»´í¬ì¦ˆë¡œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ </span>
<span class="nv">$ </span>docker compose up <span class="nt">-d</span>
<span class="c"># =&gt; [+] Running 1/1</span>
<span class="c">#     â ¿ Container 15-frontend-1  Started 0.4s</span>

<span class="c"># ì»´í¬ì¦ˆë¡œ ì‹¤í–‰ ì‹œ ì´ë¯¸ì§€ì™€ ì»¨í…Œì´ë„ˆ ë„¤ì´ë° ê·œì¹™ì„ ì•Œì•„ë³´ì!</span>
<span class="nv">$ </span>docker compose ps
<span class="c"># =&gt; NAME                COMMAND                  SERVICE             STATUS              PORTS</span>
<span class="c">#    15-frontend-1       &amp;quot;rackup --host 0.0.0â€¦&amp;quot;   frontend            running             0.0.0.0:8080-&amp;gt;9292/tcp</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì»´í¬ì¦ˆë¡œ ì‹¤í–‰ì‹œ í˜„ì¬ ë””ë ‰í„°ë¦¬ ì´ë¦„ì—ì„œ íŠ¹ìˆ˜ë¬¸ìë¥¼ ì œì™¸í•œ ê²ƒì— ì»¨í…Œì´ë„ˆ ì´ë¦„ì— "-1"ë¥¼ ë¶™ì´ëŠ”ë“¯ í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>docker compose images
<span class="c"># =&gt; Container           Repository          Tag                 Image Id            Size</span>
<span class="c">#    15-frontend-1       15_frontend         latest              4aa2b680f319        1.01GB</span>

<span class="c">#</span>
<span class="nv">$ </span>curl http://localhost:8080
<span class="c"># =&gt; Hello, World! The time is 2024-10-01 05:55:18 +0000!!!!!%</span>
<span class="nv">$ </span>docker compose logs
<span class="c"># =&gt; 15-frontend-1  | Puma starting in single mode...</span>
<span class="c">#    15-frontend-1  | * Puma version: 6.5.0 (&amp;quot;Sky's Version&amp;quot;)</span>
<span class="c">#    15-frontend-1  | * Ruby version: ruby 3.3.6 (2024-10-01 revision 75015d4c1f) [aarch64-linux]</span>
<span class="c">#    15-frontend-1  | *  Min threads: 0</span>
<span class="c">#    15-frontend-1  | *  Max threads: 5</span>
<span class="c">#    15-frontend-1  | *  Environment: development</span>
<span class="c">#    15-frontend-1  | *          PID: 1</span>
<span class="c">#    15-frontend-1  | * Listening on http://0.0.0.0:9292</span>
<span class="c">#    15-frontend-1  | Use Ctrl-C to stop</span>
<span class="c">#    15-frontend-1  | 172.23.0.1 - - [01/Oct/2024:03:58:23 +0000] &amp;quot;GET / HTTP/1.1&amp;quot; 200 51 0.0153</span>
</code></pre></div></div>

<ul>
  <li>ì†ŒìŠ¤ì½”ë“œ ìˆ˜ì • í›„ ë°˜ì˜ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>app.rb
<span class="c"># =&gt; require 'sinatra/base'</span>
<span class="c">#    </span>
<span class="c">#    class App &amp;lt; Sinatra::Base</span>
<span class="c">#      get '/' do</span>
<span class="c">#        &amp;quot;Hello, World! The time is #{Time.now}&amp;quot;</span>
<span class="c">#      end</span>
<span class="c">#    end</span>

<span class="c"># ì†ŒìŠ¤ì½”ë“œ ìˆ˜ì •</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s#World!#World! ğŸ˜€ Hello CloudNeta Study!#'</span> app.rb
<span class="nv">$ </span><span class="nb">cat </span>app.rb
<span class="c"># =&gt; require 'sinatra/base'</span>
<span class="c">#    </span>
<span class="c">#    class App &amp;lt; Sinatra::Base</span>
<span class="c">#      get '/' do</span>
<span class="c">#        &amp;quot;Hello, World! ğŸ˜€ Hello CloudNeta Study! The time is #{Time.now}!!!!!&amp;quot;</span>
<span class="c">#      end</span>
<span class="c">#    end</span>

<span class="nv">$ </span>curl http://localhost:8080
<span class="c"># =&gt; Hello, World! ğŸ˜€ Hello CloudNeta Study! The time is 2024-10-01 05:57:05 +0000!!!!!</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë³€ê²½ì‚¬í•­ì´ ì˜ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤. :)&lt;/span&gt;</span>

<span class="c"># ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ</span>
<span class="nv">$ </span>docker compose down
</code></pre></div></div>

<h3 id="cicd-ì‹¤ìŠµí™˜ê²½-êµ¬ì„±">CI/CD ì‹¤ìŠµí™˜ê²½ êµ¬ì„±</h3>

<ul>
  <li>Jenkinsì™€ Gitlabì„ ì´ìš©í•˜ì—¬ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>JenkinsëŠ” Dockerì— ì„¤ì¹˜í•´ì„œ ì‚¬ìš©í•˜ê³  Gitlabì€ <a href="https://www.gitlab.com">gitlab.com</a>ë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="jenkins-ì†Œê°œ">Jenkins ì†Œê°œ</h4>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_7.png" alt="img.png" class="image-center" /></p>
<ul>
  <li>JenkinsëŠ” ì˜¤í”ˆì†ŒìŠ¤ CI/CD ë„êµ¬ë¡œ, ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë°°í¬ ë“±ì˜ ì‘ì—…ì„ ìë™í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>JenkinsëŠ” CI/CDë¼ëŠ” ìš©ì–´ê°€ ìˆê¸° ì „ë¶€í„° ì‚¬ìš©ë˜ë˜ ë„êµ¬ë¡œ, CI/CDì— êµ­í•œë˜ì§€ ì•Šê³  ë‹¤ì–‘í•œ ì‘ì—…ì„ ìë™í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì£¼ìš” ê¸°ëŠ¥ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    <ol>
      <li><strong>í™•ì¥ì„±</strong> : ë‹¤ì–‘í•œ í”ŒëŸ¬ê·¸ì¸ ìƒíƒœê³„ë¥¼ ê°€ì§€ê³  ìˆì–´ ê¸°ëŠ¥ì„ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Git, Docker, Kubernetes ë“± ë‹¤ì–‘í•œ ë„êµ¬ ë° í”Œë«í¼ê³¼ í†µí•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>ë¶„ì‚° ë¹Œë“œ</strong> : ë¶„ì‚° ë¹Œë“œë¥¼ ì§€ì›í•˜ì—¬ ì—¬ëŸ¬ ë¨¸ì‹ ì—ì„œ ì‘ì—…ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¶€í•˜ë¥¼ ë¶„ì‚°ì‹œí‚¤ê³  ë¹Œë“œ ì†ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>ìë™í™”ëœ í…ŒìŠ¤íŠ¸</strong> : í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì„ ìë™í™”í•˜ì—¬ ì½”ë“œ í’ˆì§ˆì— ëŒ€í•œ ì¦‰ê°ì ì¸ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤. ë‹¤ì–‘í•œ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ ë° ë„êµ¬ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
      <li><strong>ì½”ë“œ íŒŒì´í”„ë¼ì¸</strong> : Jenkinsfileì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë°°í¬ íŒŒì´í”„ë¼ì¸ì„ ì½”ë“œë¡œ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë²„ì „ ê´€ë¦¬ì™€ í˜‘ì—…ì´ ìš©ì´í•©ë‹ˆë‹¤.</li>
      <li><strong>ì§€ì†ì  í†µí•© ë° ì§€ì†ì  ë°°í¬ (CI/CD)</strong> : ì½”ë“œ ë³€ê²½ ì‚¬í•­ì„ í†µí•©í•˜ê³ , ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œí•˜ê³ , í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³ , ë°°í¬í•˜ëŠ” ê³¼ì •ì„ ìë™í™”í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì¼ê´€ë˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë°°í¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.</li>
    </ol>
  </li>
  <li>í”íˆ ì‚¬ìš©ë˜ëŠ” CI/CD ì›Œí¬í”Œë¡œìš°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    <ol>
      <li><strong>ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°</strong> : ê°œë°œì„ ìœ„í•´ ì¤‘ì•™ ì½”ë“œ ë¦¬í¬ì§€í„°ë¦¬ì—ì„œ ë¡œì»¬ ì‹œìŠ¤í…œìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìµœì‹  ì½”ë“œë¥¼ ê°€ì ¸</li>
      <li><strong>ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ êµ¬í˜„ê³¼ ì‹¤í–‰</strong> : ì½”ë“œ ì‘ì„± ì „ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ë¨¼ì € ì‘ì„±</li>
      <li><strong>ì½”ë“œ ê°œë°œ</strong> : ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì„±ê³µìœ¼ë¡œ ë°”ê¾¸ë©´ì„œ ì½”ë“œ ê°œë°œ</li>
      <li><strong>ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¬ì‹¤í–‰</strong> : ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‹¤í–‰ ì‹œ í†µê³¼(ì„±ê³µ!)</li>
      <li><strong>ì½”ë“œ í‘¸ì‹œì™€ ë³‘í•©</strong> : ê°œë°œ ì†ŒìŠ¤ ì½”ë“œë¥¼ ì¤‘ì•™ ë¦¬í¬ì§€í„°ë¦¬ë¡œ í‘¸ì‹œí•˜ê³ , ì½”ë“œ ë³‘í•©</li>
      <li><strong>ì½”ë“œ ë³‘í•© í›„ ì»´íŒŒì¼</strong> : ë³€ê²½ í•¨ìˆ˜ ì½”ë“œê°€ ë³‘í•¨ë˜ë©´ ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì»´íŒŒì¼ëœë‹¤</li>
      <li><strong>ë³‘í•©ëœ ì½”ë“œì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</strong> : ê°œë³„ í…ŒìŠ¤íŠ¸ë¿ë§Œ ì•„ë‹ˆë¼ ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ë¬¸ì œ ì—†ëŠ”ì§€ í™•ì¸</li>
      <li><strong>ì•„í‹°íŒ©íŠ¸ ë°°í¬</strong> : ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œí•˜ê³ , ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ì˜ í”„ë¡œë•ì…˜ í™˜ê²½ì— ë°°í¬</li>
      <li><strong>ë°°í¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ E-E í…ŒìŠ¤íŠ¸ ì‹¤í–‰</strong> : ì…€ë ˆëŠ„ Seleniumê³¼ ê°™ì€ User Interface ìë™í™” ë„êµ¬ë¥¼ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì „ì²´ ì›Œí¬í”Œë¡œê°€ ì •ìƒ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ì¢…ë‹¨ê°„ End-to-End í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰.</li>
    </ol>
  </li>
  <li>ì´ëŸ¬í•œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì½”ë“œ ì»¤ë°‹/í‘¸ì‹œì™€ ê°™ì€ ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="jenkins-ì»¨í…Œì´ë„ˆì—ì„œ-í˜¸ìŠ¤íŠ¸ì—-ë„ì»¤-ë°ëª¬-ì‚¬ìš©-ì„¤ì •">Jenkins ì»¨í…Œì´ë„ˆì—ì„œ í˜¸ìŠ¤íŠ¸ì— ë„ì»¤ ë°ëª¬ ì‚¬ìš© ì„¤ì •</h5>

<ul>
  <li>ì»¨í…Œì´ë„ˆì—ì„œ ë„ì»¤ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” DinD(Docker in Docker)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ë„ì»¤ë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜
DooD(Docker outside of Docker)ë¥¼ ì‚¬ìš©í•˜ì—¬ í˜¸ìŠ¤íŠ¸ì˜ ë„ì»¤ ë°ëª¬ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ë²ˆì—ëŠ” Docker outside of Dockerë¥¼ ì‚¬ìš©í•˜ì—¬ í˜¸ìŠ¤íŠ¸ì˜ ë„ì»¤ ë°ëª¬ì„ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_8.png" alt="img.png" class="image-center" />
<em class="image-caption">DinDì™€ DooD êµ¬ì¡° ë¹„êµ</em></li>
</ul>

<h4 id="jenkins-ì»¨í…Œì´ë„ˆ-ì‹¤í–‰-ë°-ì„¤ì •">Jenkins ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë° ì„¤ì •</h4>

<ul>
  <li>ë¨¼ì € Jenkins ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„± í›„ ì´ë™</span>
<span class="nv">$ </span><span class="nb">mkdir </span>cicd-labs <span class="o">&amp;&amp;</span> <span class="nb">cd </span>cicd-labs

<span class="c"># </span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; docker-compose.yaml
services:
  jenkins:
    container_name: jenkins
    image: jenkins/jenkins
    restart: unless-stopped
    networks:
      - cicd-network
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - jenkins_home:/var/jenkins_home
volumes:
  jenkins_home:
networks:
  cicd-network:
    driver: bridge
</span><span class="no">EOT

</span><span class="c"># ë°°í¬</span>
<span class="nv">$ </span>docker compose up <span class="nt">-d</span>
<span class="c"># =&gt; [+] Running 13/13</span>
<span class="c">#     â ¿ jenkins Pulled                                                                                                                                                      13.7s</span>
<span class="c">#    [+] Running 3/3</span>
<span class="c">#     â ¿ Network cicd-labs_cicd-network   Created                                                                                                                             0.0s</span>
<span class="c">#     â ¿ Volume &amp;quot;cicd-labs_jenkins_home&amp;quot;  Created                                                                                                                             0.0s</span>
<span class="c">#     â ¿ Container jenkins                Started</span>
<span class="nv">$ </span>docker compose ps
<span class="c"># =&gt; NAME                COMMAND                  SERVICE             STATUS              PORTS</span>
<span class="c">#    jenkins             &amp;quot;/usr/bin/tini -- /uâ€¦&amp;quot;   jenkins             running             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp</span>

<span class="c"># ê¸°ë³¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>jenkins <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; container : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker compose <span class="nb">exec</span> <span class="nv">$i</span> sh <span class="nt">-c</span> <span class="s2">"whoami &amp;&amp; pwd"</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; container : jenkins &amp;lt;&amp;lt;</span>
<span class="c">#    jenkins</span>
<span class="c">#    /</span>

<span class="c"># ë„ì»¤ë¥¼ ì´ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆë¡œ ì ‘ì†</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins bash
<span class="nv">$ </span><span class="nb">exit</span>
</code></pre></div></div>

<ul>
  <li>Jenkins ì´ˆê¸° ì„¤ì •ì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ í™•ì¸</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins <span class="nb">cat</span> /var/jenkins_home/secrets/initialAdminPassword
<span class="c"># =&gt; dcc757c8c4f14fc09795ed0440baf157</span>

<span class="c"># ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì†í•˜ì—¬ ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥í›„ ì„¤ì • ì§„í–‰ : ê³„ì • / ì•”í˜¸ ì…ë ¥ &gt;&gt; admin / qwe123</span>
<span class="nv">$ </span>open http://localhost:8080
</code></pre></div></div>

<ul>
  <li>jenkins ì»¨í…Œì´ë„ˆì—ì„œ í˜¸ìŠ¤íŠ¸ì˜ ë„ì»¤ ë°ëª¬ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì„¤ì •ì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># jenkins ì»¨í…Œì´ë„ˆì—ì„œ í˜¸ìŠ¤íŠ¸ì˜ ë„ì»¤ ë°ëª¬ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„¤ì •</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins bash
<span class="nt">-----------------------------------------------------</span>
<span class="nv">$ </span><span class="nb">id</span>
<span class="c"># =&gt; uid=0(root) gid=0(root) groups=0(root)</span>

<span class="nv">$ </span>curl <span class="nt">-fsSL</span> https://download.docker.com/linux/debian/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nv">$ </span><span class="nb">chmod </span>a+r /etc/apt/keyrings/docker.asc
<span class="nv">$ </span><span class="nb">echo</span> <span class="se">\</span>
  <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian </span><span class="se">\</span><span class="s2">
  </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="se">\</span>
  <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
<span class="nv">$ </span>apt-get update <span class="o">&amp;&amp;</span> apt <span class="nb">install </span>docker-ce-cli curl tree jq <span class="nt">-y</span>

<span class="nv">$ </span>docker info
<span class="c"># =&gt; Client: Docker Engine - Community</span>
<span class="c">#     Version:    27.3.1</span>
<span class="c">#     Context:    default</span>
<span class="c">#     Debug Mode: false</span>
<span class="c">#     Plugins:</span>
<span class="c">#      buildx: Docker Buildx (Docker Inc.)</span>
<span class="c">#        Version:  v0.17.1</span>
<span class="c">#        Path:     /usr/libexec/docker/cli-plugins/docker-buildx</span>
<span class="c">#      compose: Docker Compose (Docker Inc.)</span>
<span class="c">#        Version:  v2.29.7</span>
<span class="c">#        Path:     /usr/libexec/docker/cli-plugins/docker-compose</span>
<span class="c">#    </span>
<span class="c">#    Server:</span>
<span class="c">#     Containers: 27</span>
<span class="c">#      Running: 3</span>
<span class="c">#      Paused: 0</span>
<span class="c">#      Stopped: 24</span>
<span class="c">#     Images: 37</span>
<span class="c">#     Server Version: 20.10.12</span>
<span class="c">#     Storage Driver: overlay2</span>
<span class="c">#      Backing Filesystem: extfs</span>
<span class="c">#      Supports d_type: true</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                              NAMES</span>
<span class="c">#    06409fe2219f   jenkins/jenkins        &amp;quot;/usr/bin/tini -- /uâ€¦&amp;quot;   25 minutes ago   Up 25 minutes   0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ Docker-out-of-Docker ì´ê¸° ë•Œë¬¸ì— í˜¸ìŠ¤íŠ¸ ë„ì»¤ ë°ëª¬ì—ì„œ ìš´ì˜ë˜ëŠ” ì»¨í…Œì´ë„ˆë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!&lt;/span&gt;</span>
<span class="nv">$ </span>which docker
<span class="c"># =&gt; /usr/bin/docker</span>

<span class="c"># Jenkins ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ rootê°€ ì•„ë‹Œ jenkins ìœ ì €ë„ dockerë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ ë¶€ì—¬</span>
<span class="nv">$ </span>groupadd <span class="nt">-g</span> 2000 <span class="nt">-f</span> docker
<span class="nv">$ </span><span class="nb">chgrp </span>docker /var/run/docker.sock
<span class="nv">$ </span><span class="nb">chmod </span>770 /var/run/docker.sock
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /var/run/docker.sock
<span class="c"># =&gt; srwxr-xr-x 1 root docker 0 Dec  7 03:12 /var/run/docker.sock</span>
<span class="nv">$ </span>usermod <span class="nt">-aG</span> docker jenkins
<span class="nv">$ </span><span class="nb">cat</span> /etc/group | <span class="nb">grep </span>docker
<span class="c"># =&gt; docker:x:2000:jenkins</span>

<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">--------------------------------------------</span>

<span class="c"># jenkins item ì‹¤í–‰ ì‹œ docker ëª…ë ¹ ì‹¤í–‰ ê¶Œí•œ ì—ëŸ¬ ë°œìƒ : Jenkins ì»¨í…Œì´ë„ˆ ì¬ê¸°ë™ìœ¼ë¡œ ìœ„ ì„¤ì • ë‚´ìš©ì„ Jenkins app ì—ë„ ì ìš© í•„ìš”</span>
<span class="nv">$ </span>docker compose restart jenkins
<span class="c"># $ sudo docker compose restart jenkins  # Windows ê²½ìš° ì´í›„ë¶€í„° sudo ë¶™ì—¬ì„œ ì‹¤í–‰</span>

<span class="c"># jenkins userë¡œ docker ëª…ë ¹ ì‹¤í–‰ í™•ì¸</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins <span class="nb">id</span>
<span class="c"># =&gt; uid=1000(jenkins) gid=1000(jenkins) groups=1000(jenkins),2000(docker)</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins docker info
<span class="c"># =&gt; Client: Docker Engine - Community</span>
<span class="c">#     Version:    27.3.1</span>
<span class="c">#     Context:    default</span>
<span class="c">#     ...</span>
<span class="c">#    </span>
<span class="c">#    Server:</span>
<span class="c">#     Containers: 27</span>
<span class="c">#      Running: 3</span>
<span class="c">#      Paused: 0</span>
<span class="c">#      Stopped: 24</span>
<span class="c">#     Images: 37</span>
<span class="c">#     Server Version: 20.10.12</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS         PORTS                                              NAMES</span>
<span class="c">#    06409fe2219f   jenkins/jenkins        &amp;quot;/usr/bin/tini -- /uâ€¦&amp;quot;   30 minutes ago   Up 2 minutes   0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h4 id="gitlab-ì†Œê°œ">Gitlab ì†Œê°œ</h4>

<ul>
  <li>Gitlabì€ Githubì™€ ìœ ì‚¬í•œ Git ê¸°ë°˜ì˜ ì½”ë“œ ì €ì¥ì†Œ ì„œë¹„ìŠ¤ë¡œ, ì½”ë“œ ì €ì¥ì†Œ, ì´ìŠˆ íŠ¸ë˜ì»¤, CI/CD íŒŒì´í”„ë¼ì¸, ì½”ë“œ ê²€í†  ë“±ì˜ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
<a href="https://www.gitlab.com">Gitlab.com</a></li>
  <li>ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” ì½”ë“œ ì €ì¥ì†Œ ê¸°ëŠ¥ë§Œ ì‚¬ìš©í•˜ê³  Jenkinsì˜ CI/CD íŒŒì´í”„ë¼ì¸ì„ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.</li>
  <li>ì£¼ìš” ê¸°ëŠ¥
    <ul>
      <li><strong>ì†ŒìŠ¤ ì½”ë“œ ê´€ë¦¬</strong> : GitLabì€ Git ê¸°ë°˜ì˜ ì†ŒìŠ¤ ì½”ë“œ ì €ì¥ì†Œë¥¼ ì œê³µí•˜ì—¬ ë²„ì „ ê´€ë¦¬ë¥¼ ì‰½ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>CI/CD íŒŒì´í”„ë¼ì¸</strong> : GitLabì€ CI/CD íŒŒì´í”„ë¼ì¸ì„ í†µí•´ ì½”ë“œì˜ ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë°°í¬ë¥¼ ìë™í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>ì´ìŠˆ íŠ¸ë˜í‚¹</strong> : í”„ë¡œì íŠ¸ì˜ ë²„ê·¸, ê¸°ëŠ¥ ìš”ì²­ ë“±ì„ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ì´ìŠˆ íŠ¸ë˜í‚¹ ì‹œìŠ¤í…œì„ ì œê³µí•©ë‹ˆë‹¤.</li>
      <li><strong>ì½”ë“œ ë¦¬ë·°</strong> : ë³‘í•© ìš”ì²­(Merge Request)ì„ í†µí•´ ì½”ë“œ ë¦¬ë·°ë¥¼ ì‰½ê²Œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>ìœ„í‚¤</strong> : í”„ë¡œì íŠ¸ ê´€ë ¨ ë¬¸ì„œë¥¼ ì‘ì„±í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ìœ„í‚¤ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
      <li><strong>í”„ë¡œì íŠ¸ ê´€ë¦¬</strong> : ë§ˆì¼ìŠ¤í†¤, ë³´ë“œ, ë¼ë²¨ ë“±ì„ í†µí•´ í”„ë¡œì íŠ¸ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>í†µí•© ë° í™•ì¥ì„±</strong> : ë‹¤ì–‘í•œ ì™¸ë¶€ ë„êµ¬ì™€ì˜ í†µí•© ë° í™•ì¥ì„ ì§€ì›í•˜ì—¬ ìœ ì—°í•œ ê°œë°œ í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>ì…€í”„ í˜¸ìŠ¤íŠ¸ ê°€ëŠ¥</strong> : GitLabì€ ì˜¤í”ˆì†ŒìŠ¤ë¡œ ì œê³µë˜ì–´ ë¬´ë£Œë¡œ ìì²´ ì„œë²„ì— ì„¤ì¹˜í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì¼ë¶€ ê¸°ëŠ¥ ì°¨ì´ê°€ ìˆìŒ)</li>
    </ul>
  </li>
</ul>

<h4 id="gitlab-í”„ë¡œì íŠ¸-ìƒì„±-ë°-ì„¤ì •">Gitlab í”„ë¡œì íŠ¸ ìƒì„± ë° ì„¤ì •</h4>

<ul>
  <li>
    <p>Gitlab.comì—ì„œ ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_9.png" alt="img.png" class="image-center" />
<em class="image-caption">Gitlab í”„ë¡œì íŠ¸ ìƒì„±</em></p>
  </li>
  <li>
    <p>í”„ë¡œì íŠ¸ ìƒì„±ì‹œ í”„ë¡œì íŠ¸ ì´ë¦„ê³¼ ê°€ì‹œì„±ì„ ì„¤ì •í•˜ê³  ìƒì„±í•©ë‹ˆë‹¤.</p>
    <ul>
      <li><strong>í”„ë¡œì íŠ¸ ì´ë¦„</strong> : 2024-cicd-lite-w1</li>
      <li><strong>ê°€ì‹œì„±</strong> : Private</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_10.png" alt="img_1.png" class="image-center" />
<em class="image-caption">Jenkinsì™€ ì—°ë™ì„ ìœ„í•´ í† í° ë°œê¸‰</em></p>

<ul>
  <li>í”„ë¡œì íŠ¸ ìƒì„± í›„ í”„ë¡œì íŠ¸ ì„¤ì •ì—ì„œ CI/CD íŒŒì´í”„ë¼ì¸ì„ ìœ„í•œ í† í°ì„ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤.</li>
  <li>í”„ë¡œí•„ ì•„ì´ì½˜ í´ë¦­ &gt; Preferences &gt; Access Tokens &gt; Add new tokenì„ í´ë¦­í•˜ì—¬ í† í°ì„ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤.
    <ul>
      <li><strong>í† í° ì´ë¦„</strong> : jenkins</li>
      <li><strong>ê¶Œí•œ</strong> : read_repository, write_repository</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_11.png" alt="img_2.png" class="image-center" />
<em class="image-caption">í† í° ë°œê¸‰ ì™„ë£Œ</em></p>

<ul>
  <li>í† í°ì´ ì™„ë£Œë˜ë©´ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´í›„ì—ëŠ” ë‹¤ì‹œ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì˜ ê¸°ë¡í•´ë‘ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="gitlabì—ì„œ-ì†ŒìŠ¤-ë°›ê¸°">Gitlabì—ì„œ ì†ŒìŠ¤ ë°›ê¸°</h5>

<ul>
  <li>ì†ŒìŠ¤ë¥¼ ë°›ê¸° ìœ„í•´ git ì£¼ì†Œë¥¼ ë³µì‚¬í•©ë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_12.png" alt="img.png" class="image-center" />
<em class="image-caption">Gitlab í”„ë¡œì íŠ¸ ì£¼ì†Œ ë³µì‚¬</em></li>
  <li>í”„ë¡œì íŠ¸ í˜ì´ì§€ì— ì ‘ì† í›„ Code ë²„íŠ¼ì„ í´ë¦­í•˜ê³  í´ë¦½ë³´ë“œ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ ì£¼ì†Œë¥¼ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë³µì‚¬í•œ ì£¼ì†Œë¡œ ì†ŒìŠ¤ë¥¼ ë°›ì•„ì„œ í•„ìš”í•œ íŒŒì¼ë“¤ì„ ìƒì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¬¼ìœ¼ë©´ í† í°ì´ë¦„ê³¼ ë°œê¸‰ë°›ì€ í† í°ì„ ì…ë ¥í•˜ì‹œë©´ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>git clone https://gitlab.com/littlebird/2024-cicd-lite-w1.git
<span class="c"># =&gt; Cloning into '2024-cicd-lite-w1'...</span>
<span class="c">#    Username for 'https://gitlab.com': jenkins</span>
<span class="c">#    Password for 'https://jenkins@gitlab.com': glpat-ABCD1234</span>
<span class="c">#    remote: Enumerating objects: 3, done.</span>
<span class="c">#    remote: Counting objects: 100% (3/3), done.</span>
<span class="c">#    remote: Compressing objects: 100% (2/2), done.</span>
<span class="c">#    remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0 (from 0)</span>
<span class="c">#    Receiving objects: 100% (3/3), done.</span>
<span class="nv">$ </span><span class="nb">cd </span>2024-cicd-lite-w1/

<span class="c"># ì†ŒìŠ¤ì½”ë“œ ì‘ì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> app.rb <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
require 'sinatra'

get '/' do
  "Hello, World! The time is #{Time.now}"
end
</span><span class="no">EOF

</span><span class="c"># Dockerfile ì‘ì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Dockerfile <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
FROM ruby:3.3
RUN gem install sinatra rackup puma
COPY app.rb /app/
WORKDIR /app
CMD ["ruby", "app.rb", "-o", "0.0.0.0"]
</span><span class="no">EOF

</span><span class="c"># VERSION íŒŒì¼ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"0.0.1"</span> <span class="o">&gt;</span> VERSION

<span class="c">#</span>
<span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Initial commit"</span>
<span class="c"># =&gt; [main 569ce3c] Initial commit</span>
<span class="c">#     3 files changed, 11 insertions(+)</span>
<span class="c">#     create mode 100644 Dockerfile</span>
<span class="c">#     create mode 100644 VERSION</span>
<span class="c">#     create mode 100644 app.rb</span>
<span class="nv">$ </span>git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; Enumerating objects: 6, done.</span>
<span class="c">#    Counting objects: 100% (6/6), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (4/4), done.</span>
<span class="c">#    Writing objects: 100% (5/5), 536 bytes | 536.00 KiB/s, done.</span>
<span class="c">#    Total 5 (delta 0), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To https://gitlab.com/littlebird/2024-cicd-lite-w1.git</span>
<span class="c">#       fe2fb73..569ce3c  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div></div>

<ul>
  <li>Gitlab ë¦¬íŒŒì§€í† ë¦¬ì—ì„œ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_13.png" alt="img.png" /></p>

<ul>
  <li>Gitlab í”„ë¡œì íŠ¸ì— ì†ŒìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì—…ë¡œë“œ ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="docker-hub-ì†Œê°œ">Docker Hub ì†Œê°œ</h4>

<ul>
  <li><a href="https://hub.docker.com">ë„ì»¤í—ˆë¸Œ(Docker Hub)</a>ëŠ” ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ê³  ê³µìœ í•  ìˆ˜ ìˆëŠ” í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</li>
  <li>ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ìì‹ ì´ ë§Œë“  ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì„œë¡œ ììœ ë¡­ê²Œ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ìœ ì˜ ì‚¬í•­
    <ul>
      <li>Docker HubëŠ” ë¬´ë£Œë¡œ ëˆ„êµ¬ë‚˜ ì—…ë¡œë“œ í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, ê³µì‹(Official) ë¼ë²¨ì´ ì—†ëŠ” ì´ë¯¸ì§€ëŠ” ë³´ì•ˆì— ì·¨ì•½í•  ìˆ˜ ìˆê³ , ì‚¬ìš©ë²•ì„ ì•Œ ìˆ˜ ì—†ê±°ë‚˜, ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ë„ì»¤ ì•…ì„± ì´ë¯¸ì§€ë¥¼ í†µí•œ ì·¨ì•½ì  ê³µê²© ê¸°ì‚¬ ëª¨ìŒ
        <ul>
          <li>ë„ì»¤ë„ ì´ì œ ê³µê²© í†µë¡œ! ì•…ì„± ì´ë¯¸ì§€ ëŠ˜ì–´ë‚˜ê³  ìˆë‹¤ - <a href="https://www.boannews.com/media/view.asp?idx=93080&amp;page=1&amp;kind=1">ë§í¬</a></li>
          <li>ë„ì»¤ í™˜ê²½ ê³µê²©í•˜ëŠ” í•´ì»¤ë“¤, ì „ëµì„ ë˜ ë³€ê²½í–ˆë‹¤ - <a href="https://www.boannews.com/media/view.asp?idx=89841&amp;page=1&amp;kind=1">ë§í¬</a></li>
          <li>ì•”í˜¸í™”í ì±„êµ´ ê³µê²©ìë“¤, ì˜ëª» ì„¤ì •ëœ ë„ì»¤ ì§‘ì¤‘ ê³µëµ - <a href="https://www.boannews.com/media/view.asp?idx=87427&amp;page=1&amp;kind=1">ë§í¬</a></li>
          <li>ë¦¬ëˆ…ìŠ¤ ë…¸ë¦¬ë˜ ë´‡ë„· ë©€ì›¨ì–´ ë‘˜, ìµœê·¼ ë“¤ì–´ ë„ì»¤ ì„œë²„ë„ ë…¸ë¦¬ê¸° ì‹œì‘ - <a href="https://www.boannews.com/media/view.asp?idx=89205&amp;page=1&amp;kind=1">ë§í¬</a></li>
          <li>ë„ì»¤ í˜¸ìŠ¤íŠ¸ ê°ì—¼ì‹œì¼œê°€ë©° ì•”í˜¸í™”í ì±„êµ´í•˜ëŠ” ì›œ ë°œê²¬ - <a href="https://www.boannews.com/media/view.asp?idx=83854&amp;page=1&amp;kind=1">ë§í¬</a>  *</li>
        </ul>
      </li>
      <li>ì‚¬ìš©ìë‹¹ 1ê°œì˜ Private Repositoryë§Œ ë¬´ë£Œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì£¼ìš” ê¸°ëŠ¥
    <ul>
      <li><strong>ë„ì»¤ ì´ë¯¸ì§€ ì €ì¥ì†Œ</strong> : ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ê³  ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>ìë™ ë¹Œë“œ</strong> : Github, Gitlabê³¼ ì—°ë™í•˜ì—¬ ì½”ë“œê°€ ì—…ë°ì´íŠ¸ ë  ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>ì›¹í›…</strong> : íƒ€ ì„œë¹„ìŠ¤ì™€ ì—°ë™í•˜ì—¬ ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œë§ˆë‹¤ íŠ¹ì • URLë¡œ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>Docker Hub CLI ë„êµ¬</strong> : ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì»¤ë§¨ë“œë¼ì¸ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ë„êµ¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h4 id="docker-hubì—-dev-app-private-repo-ìƒì„±">Docker Hubì— dev-app (private) repo ìƒì„±</h4>

<ul>
  <li>Docker Hubì— dev-appì´ë¼ëŠ” private ë¦¬í¬ì§€í† ë¦¬ë¥¼ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤.</li>
  <li>Docker Hubì— ë¡œê·¸ì¸ í›„ Repositories &gt; Create Repositoryë¥¼ í´ë¦­í•˜ì—¬ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    <ul>
      <li><strong>Repository Name</strong> : dev-app</li>
      <li><strong>Visibility</strong> : Private</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_14.png" alt="img.png" /></p>

<h3 id="jenkins-ê¸°ë³¸-ì‚¬ìš©">Jenkins ê¸°ë³¸ ì‚¬ìš©</h3>

<ul>
  <li>Jenkinsë¥¼ ì‚¬ìš©í•˜ì—¬ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ì‘ì—… ì†Œê°œ
    <ol>
      <li><strong>Trigger</strong> : ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ì‹œì ì„ ì§€ì •í•©ë‹ˆë‹¤.
        <ul>
          <li>ì‘ì—… ìˆ˜í–‰ íƒœìŠ¤í¬ taskê°€ ì–¸ì œ ì‹œì‘ë ì§€ë¥¼ ì§€ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><strong>Built step</strong> : ì‘ì—…ì„ êµ¬ì„±í•˜ëŠ” ë‹¨ê³„ë³„ íƒœìŠ¤í¬ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
        <ul>
          <li>íŠ¹ì • ëª©í‘œë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ íƒœìŠ¤í¬ë¥¼ ë‹¨ê³„ë³„ stepë¡œ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ì´ê²ƒì„ ì  í‚¨ìŠ¤ì—ì„œëŠ” ë¹Œë“œ ìŠ¤í… build stepì´ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><strong>Post-build action</strong> : íƒœìŠ¤í¬ê°€ ì™„ë£Œ í›„ ìˆ˜í–‰í•  ëª…ë ¹ì„ ì§€ì •í•©ë‹ˆë‹¤.
        <ul>
          <li>ì˜ˆë¥¼ ë“¤ì–´ ì‘ì—…ì˜ ê²°ê³¼(ì„±ê³µ or ì‹¤íŒ¨)ë¥¼ ì‚¬ìš©ìì—ê²Œ ì•Œë ¤ì£¼ëŠ” í›„ì† ë™ì‘ì´ë‚˜, ìë°” ì½”ë“œë¥¼ ì»´íŒŒì¼í•œ í›„ ìƒì„±ëœ í´ë˜ìŠ¤ íŒŒì¼ì„ íŠ¹ì • ìœ„ì¹˜ë¡œ ë³µì‚¬ ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     - (ì°¸ê³ ) ì  í‚¨ìŠ¤ì˜ <strong>ë¹Œë“œ</strong> : ì  í‚¨ìŠ¤ ì‘ì—…ì˜ íŠ¹ì • ì‹¤í–‰ ë²„ì „
       - ì‚¬ìš©ìëŠ” ì  í‚¨ìŠ¤ ì‘ì—…ì„ ì—¬ëŸ¬ë²ˆ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ”ë°, ì‹¤í–‰ë  ë•Œë§ˆë‹¤ <strong>ê³ ìœ  ë¹Œë“œ ë²ˆí˜¸</strong>ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.
       - ì‘ì—… ì‹¤í–‰ ì¤‘ì— ìƒì„±ëœ <strong>ì•„í‹°íŒ©íŠ¸</strong>, <strong>ì½˜ì†” ë¡œë“œ</strong> ë“± íŠ¹ì • ì‹¤í–‰ ë²„ì „ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì„¸ë¶€ ì •ë³´ê°€ í•´ë‹¹ ë¹Œë“œ ë²ˆí˜¸ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ol>
  </li>
  <li>ì²«ë²ˆì§¸ ì‘ì—… ìƒì„±
    <ul>
      <li>name : first</li>
      <li>item type : freestyle project</li>
      <li>Build Steps : Execute shell
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"docker check"</span> | <span class="nb">tee </span>test.txt
docker ps
</code></pre></div>        </div>
        <p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_15.png" alt="img.png" class="image-center" />
<em class="image-caption">Jenkins ì²«ë²ˆì§¸ ì‘ì—… ìƒì„±</em></p>
      </li>
    </ul>
  </li>
  <li>
    <p>â€œBuild Nowâ€(ì§€ê¸ˆ ì‹¤í–‰) ë©”ë‰´ë¥¼ í´ë¦­í•˜ì—¬ ì‘ì—…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_16.png" alt="img.png" class="image-center" />
<em class="image-caption">ë¹Œë“œ ê²°ê³¼ (Console Output)</em></p>
  </li>
  <li>ì‘ì—… ê³µê°„ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins <span class="nb">ls</span> /var/jenkins_home/workspace
<span class="c"># =&gt; first</span>

<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins <span class="nb">ls</span> /var/jenkins_home/workspace/first
<span class="c"># =&gt; test.txt</span>

<span class="c"># ì‘ì—… ê²°ê³¼ í™•ì¸</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins <span class="nb">cat</span> /var/jenkins_home/workspace/first/test.txt
<span class="c"># =&gt; docker check</span>
</code></pre></div></div>

<h4 id="jenkins-í”ŒëŸ¬ê·¸ì¸-ì„¤ì¹˜">Jenkins í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜</h4>

<ul>
  <li>Jenkins í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜í•˜ì—¬ ë” ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Dashboard &gt; Manage Jenkins ë©”ë‰´ë¥¼ í´ë¦­í•˜ê³ , í”ŒëŸ¬ê·¸ì¸ ê´€ë¦¬ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.</li>
  <li>Available plugins ë¥¼ í´ë¦­í•˜ì—¬ ë‹¤ì–‘í•œ í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_17.png" alt="img.png" class="image-center" />
<em class="image-caption">Jenkins í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ í™”ë©´</em></p>

<ul>
  <li>ë‹¤ìŒì˜ plugin ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
    <ul>
      <li><strong>Pipeline Stage View</strong> : íŒŒì´í”„ë¼ì¸ ìŠ¤í…Œì´ì§€ë¥¼ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” í”ŒëŸ¬ê·¸ì¸ <a href="https://plugins.jenkins.io/pipeline-stage-view/">ë§í¬</a></li>
      <li><strong>Docker Pipeline</strong> : íŒŒì´í”„ë¼ì¸ì—ì„œ ë„ì»¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ <a href="https://plugins.jenkins.io/docker-workflow/">ë§í¬</a></li>
      <li><strong>Gitlab</strong> : Gitlabê³¼ Jenkinsë¥¼ ì—°ë™í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ <a href="https://plugins.jenkins.io/gitlab-plugin/">ë§í¬</a></li>
    </ul>
  </li>
  <li>Dashboard &gt; Manage Jenkins &gt; Credentials &gt; System &gt; Global credentials (unrestricted) &gt; Add Credentials ë¥¼ í´ë¦­í•˜ì—¬ ìê²©ì¦ëª…ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
    <ul>
      <li>Docker hub í¬ë ˆë´ì…œ
        <ul>
          <li>Kind : Username with password</li>
          <li>Username : <code class="language-plaintext highlighter-rouge">&lt;docker hub ê³„ì •&gt;</code></li>
          <li>Password : <code class="language-plaintext highlighter-rouge">&lt;docker hub ë¹„ë°€ë²ˆí˜¸ í˜¹ì€ í† í°&gt;</code></li>
          <li>ID : <code class="language-plaintext highlighter-rouge">dockerhub-credentials</code> =&gt; ìê²©ì¦ëª… ì´ë¦„ìœ¼ë¡œ pipelineì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>Gitlab ì €ì¥ì†Œ í¬ë ˆë´ì…œ
        <ul>
          <li>Kind : Username with password</li>
          <li>Username : <code class="language-plaintext highlighter-rouge">&lt;gitlab í† í° ì´ë¦„&gt;</code></li>
          <li>Password : <code class="language-plaintext highlighter-rouge">&lt;gitlab í† í°&gt;</code></li>
          <li>ID : <code class="language-plaintext highlighter-rouge">gitlab-credentials</code> =&gt; ìê²©ì¦ëª… ì´ë¦„ìœ¼ë¡œ pipelineì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="íŒŒì´í”„ë¼ì¸">íŒŒì´í”„ë¼ì¸</h4>

<ul>
  <li>pipelineì€ CI/CD íŒŒì´í”„ë¼ì¸ì„ ì½”ë“œë¡œ ì •ì˜í•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. <a href="https://www.jenkins.io/doc/book/pipeline/">docs</a></li>
</ul>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_18.png" alt="img.png" /></p>

<ul>
  <li>íŒŒì´í”„ë¼ì¸ì˜ <strong>ì¥ì </strong>
    <ul>
      <li><strong>ì½”ë“œ</strong> : ì• í”Œë¦¬ì¼€ì´ì…˜ CI/CD í”„ë¡œì„¸ìŠ¤ë¥¼ ì½”ë“œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•  ìˆ˜ ìˆê³ , í•´ë‹¹ ì½”ë“œë¥¼ ì¤‘ì•™ ë¦¬í¬ì§€í„°ë¦¬ì— ì €ì¥í•˜ì—¬ íŒ€ì›ê³¼ ê³µìœ  ë° ì‘ì—… ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li><strong>ë‚´êµ¬ì„±</strong> : ì  í‚¨ìŠ¤ ì„œë¹„ìŠ¤ê°€ ì˜ë„ì ìœ¼ë¡œ ë˜ëŠ” ìš°ë°œì ìœ¼ë¡œ ì¬ì‹œì‘ë˜ë”ë¼ë„ ë¬¸ì œì—†ì´ ìœ ì§€ë©ë‹ˆë‹¤.</li>
      <li><strong>ì¼ì‹œ ì¤‘ì§€ ê°€ëŠ¥</strong> : íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ëŠ” ë„ì¤‘ ì‚¬ëŒì˜ ìŠ¹ì¸ì´ë‚˜ ì…ë ¥ì„ ê¸°ë‹¤ë¦¬ê¸° ìœ„í•´ ì¤‘ë‹¨í•˜ê±°ë‚˜ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li><strong>ë‹¤ì–‘ì„±</strong> : ë¶„ê¸°ë‚˜ ë°˜ë³µ, ë³‘ë ¬ ì²˜ë¦¬ì™€ ê°™ì€ ë‹¤ì–‘í•œ CI/CD ìš”êµ¬ ì‚¬í•­ì„ ì§€ì›í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>íŒŒì´í”„ë¼ì¸ ìš©ì–´
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_19.png" alt="img.png" class="image-center" />
    <ul>
      <li><strong>Pipeline(íŒŒì´í”„ë¼ì¸)</strong> : ì „ì²´ ë¹Œë“œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì •ì˜í•˜ëŠ” ì½”ë“œ</li>
      <li><strong>Node(ë…¸ë“œ) = Agent</strong> : íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ëŠ” ì‹œìŠ¤í…œ</li>
      <li><strong>Stages</strong> : ìˆœì°¨ ì‘ì—… ëª…ì„¸ì¸ stage ë“¤ì˜ ë¬¶ìŒ</li>
      <li><strong>Stage</strong> : íŠ¹ì • ë‹¨ê³„ì—ì„œ ìˆ˜í–‰ë˜ëŠ” ì‘ì—…ë“¤ì˜ ì •ì˜</li>
      <li><strong>Steps</strong> : íŒŒì´í”„ë¼ì¸ì˜ íŠ¹ì • ë‹¨ê³„ì—ì„œ ìˆ˜í–‰ë˜ëŠ” ë‹¨ì¼ ì‘ì—…ì„ ì˜ë¯¸.</li>
      <li><strong>Post</strong> : ë¹Œë“œ í›„ ì¡°ì¹˜, ì¼ë°˜ì ìœ¼ë¡œ stages ì‘ì—…ì´ ëë‚œ í›„ ì¶”ê°€ì ì¸ steps/step</li>
      <li><strong>Directive</strong> - <a href="https://www.jenkins.io/doc/book/pipeline/syntax/#declarative-directives">Docs</a>
        <ul>
          <li><strong>Environment</strong> (key=value) : íŒŒì´í”„ë¼ì¸ ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ë³€ìˆ˜</li>
          <li><strong>Parameters</strong> : ì…ë ¥ ë°›ì•„ì•¼í•  ë³€ìˆ˜ë¥¼ ì •ì˜ - Type(string, text, choice, password â€¦)</li>
          <li><strong>Triggers</strong> : íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ëŠ” ì¡°ê±´ ì„¤ì •</li>
          <li><strong>Input</strong> : íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì‚¬ìš©ì ì…ë ¥ì„ ë°›ì„ ìˆ˜ ìˆë„ë¡ ì„¤ì •</li>
          <li><strong>When</strong> : stage ë¥¼ ì‹¤í–‰ í•  ì¡°ê±´ ì„¤ì •</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>íŒŒì´í”„ë¼ì¸ êµ¬ì„± í˜•íƒœ 3ê°€ì§€
    <ol>
      <li><strong>Pipeline Script</strong> : ì¼ë°˜ì ì¸ ë°©ì‹ìœ¼ë¡œ Jenkins íŒŒì´í”„ë¼ì¸ì„ ìƒì„±í•˜ì—¬ Shell Script í˜•íƒœë¡œ ì‘ì„± <a href="https://www.jenkins.io/doc/book/pipeline/getting-started/#through-the-classic-ui">ë§í¬</a></li>
      <li><strong>Pipeline Script from SCM</strong> : Jenkinsfileì„ git ë“±ì˜ SCM(Source Code Management)ì— ì €ì¥í•˜ê³ , ë¹Œë“œ ì‹œì‘ ì‹œ í•´ë‹¹ íŒŒì¼ì„ ì½ì–´ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰ <a href="https://www.jenkins.io/doc/book/pipeline/getting-started/#defining-a-pipeline-in-scm">ë§í¬</a></li>
      <li><strong>Blue Ocean ê¸°ë°˜</strong> : Blue Ocean í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜í•˜ì—¬ UIë¡œ íŒŒì´í”„ë¼ì¸ì„ êµ¬ì„±í•˜ë©´ Jenkinsfileì´ ìë™ìœ¼ë¡œ ìƒì„±ë¨ <a href="https://www.jenkins.io/doc/book/pipeline/getting-started/#through-blue-ocean">ë§í¬</a></li>
    </ol>
  </li>
  <li>íŒŒì´í”„ë¼ì¸ êµ¬ë¬¸ í˜•íƒœ 2ê°€ì§€
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_20.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">íŒŒì´í”„ë¼ì¸ êµ¬ë¬¸ í˜•íƒœë³„ êµ¬ì¡°</em>
    <ol>
      <li><strong>Declarative Pipeline</strong> : ê°„ê²°í•˜ê³  ê°€ë…ì„±ì´ ì¢‹ìœ¼ë©°, ìµœê·¼ ë¬¸ë²•ì´ê³ , ê¶Œì¥í•˜ëŠ” ë°©ë²•. stepì€ í•„ìˆ˜ë¡œ ì‚¬ìš©
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pipeline <span class="o">{</span>
   agent any     <span class="c"># Execute this Pipeline or any of its stages, on any available agent.</span>
   stages <span class="o">{</span>
     stage<span class="o">(</span><span class="s1">'Build'</span><span class="o">)</span> <span class="o">{</span>   <span class="c"># Defines the "Build" stage.</span>
         steps <span class="o">{</span>
             //         <span class="c"># Perform some steps related to the "Build" stage.</span>
         <span class="o">}</span>
     <span class="o">}</span>
     stage<span class="o">(</span><span class="s1">'Test'</span><span class="o">)</span> <span class="o">{</span> 
         steps <span class="o">{</span>
             // 
         <span class="o">}</span>
     <span class="o">}</span>
     stage<span class="o">(</span><span class="s1">'Deploy'</span><span class="o">)</span> <span class="o">{</span> 
         steps <span class="o">{</span>
             // 
         <span class="o">}</span>
     <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>
      </li>
      <li><strong>Scripted Pipeline</strong> : ì»¤ìŠ¤í…€ì´ ìš©ì´í•˜ë‚˜ ë³µì¡ë„ê°€ ë†’ê³ , stepì€ í•„ìˆ˜ê°€ ì•„ë‹˜
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node <span class="o">{</span>             <span class="c"># Execute this Pipeline or any of its stages, on any available agent.</span>
  stage<span class="o">(</span><span class="s1">'Build'</span><span class="o">)</span> <span class="o">{</span> <span class="c"># Defines the "Build" stage. stage blocks are optional in Scripted Pipeline syntax. However, implementing stage blocks in a Scripted Pipeline provides clearer visualization of each stage's subset of tasks/steps in the Jenkins UI.</span>
   //              <span class="c"># Perform some steps related to the "Build" stage.</span>
  <span class="o">}</span>
  stage<span class="o">(</span><span class="s1">'Test'</span><span class="o">)</span> <span class="o">{</span> 
   // 
  <span class="o">}</span>
  stage<span class="o">(</span><span class="s1">'Deploy'</span><span class="o">)</span> <span class="o">{</span> 
   // 
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
</ul>

<h5 id="jenkins-pipeline-ì‹¤ìŠµ">Jenkins Pipeline ì‹¤ìŠµ</h5>

<ul>
  <li>New Item &gt; Pipeline ìœ¼ë¡œ íŒŒì´í”„ë¼ì¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
    <ul>
      <li><strong>Name</strong> : First-Pipeline</li>
      <li><strong>Definition</strong> : Pipeline script</li>
      <li><strong>Script</strong> : ì•„ë˜ì˜ íŒŒì´í”„ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pipeline <span class="o">{</span>
    agent any

    stages <span class="o">{</span>
        stage<span class="o">(</span><span class="s1">'Hello'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                <span class="nb">echo</span> <span class="s1">'Hello World'</span>
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'Deploy'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                <span class="nb">echo</span> <span class="s2">"Deployed successfully!"</span><span class="p">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Save í•˜ì—¬ ì €ì¥í›„ â€œBuild Nowâ€ë¥¼ í´ë¦­í•˜ì—¬ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_21.png" alt="img.png" class="image-center" />
<em class="image-caption">íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ê²°ê³¼</em></p>
  </li>
  <li>
    <p>ì•„ë˜ ì²˜ëŸ¼ ìˆ˜ì • í›„ í™•ì¸: í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©, ë¬¸ìì—´ ë³´ê°„ â†’ Console Output í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pipeline <span class="o">{</span>
    agent any
    environment <span class="o">{</span> 
        CC <span class="o">=</span> <span class="s1">'clang'</span>
    <span class="o">}</span>
      
    stages <span class="o">{</span>
        stage<span class="o">(</span><span class="s1">'Example'</span><span class="o">)</span> <span class="o">{</span>
            environment <span class="o">{</span> 
                AN_ACCESS_KEY <span class="o">=</span> <span class="s1">'abcdefg'</span>
            <span class="o">}</span>
            steps <span class="o">{</span>
                <span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">CC</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span>
                sh <span class="s1">'echo ${AN_ACCESS_KEY}'</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_22.png" alt="img.png" class="image-center" />
<em class="image-caption">Console Output</em></p>
  </li>
  <li>
    <p>ì•„ë˜ ì²˜ëŸ¼ ìˆ˜ì • í›„ í™•ì¸: íŒŒì´í”„ë¼ì¸ ë¹Œë“œ ì‹œì‘(íŠ¸ë¦¬ê±°) â†’ Console Output í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pipeline <span class="o">{</span>
    agent any
    triggers <span class="o">{</span>
        cron<span class="o">(</span><span class="s1">'H */4 * * 1-5'</span><span class="o">)</span>
    <span class="o">}</span>
    stages <span class="o">{</span>
        stage<span class="o">(</span><span class="s1">'Example'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                <span class="nb">echo</span> <span class="s1">'Hello World'</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_23.png" alt="img.png" class="image-center" />
<em class="image-caption">Console Output</em></p>
  </li>
  <li>
    <p>ì•„ë˜ ì²˜ëŸ¼ ìˆ˜ì • í›„ í™•ì¸: íŒŒë¼ë¯¸í„°ì™€ í•¨ê»˜ ë¹Œë“œ â†’ Console Output í™•ì¸ â‡’ ë‹¤ì‹œ í•œë²ˆ ë” ë¹Œë“œ í´ë¦­ (ë³€ìˆ˜ ì…ë ¥ ì¹¸ í™•ì¸)</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pipeline <span class="o">{</span>
    agent any
    parameters <span class="o">{</span>
        string<span class="o">(</span>name: <span class="s1">'PERSON'</span>, defaultValue: <span class="s1">'Mr Jenkins'</span>, description: <span class="s1">'Who should I say hello to?'</span><span class="o">)</span>
        text<span class="o">(</span>name: <span class="s1">'BIOGRAPHY'</span>, defaultValue: <span class="s1">''</span>, description: <span class="s1">'Enter some information about the person'</span><span class="o">)</span>
        booleanParam<span class="o">(</span>name: <span class="s1">'TOGGLE'</span>, defaultValue: <span class="nb">true</span>, description: <span class="s1">'Toggle this value'</span><span class="o">)</span>
        choice<span class="o">(</span>name: <span class="s1">'CHOICE'</span>, choices: <span class="o">[</span><span class="s1">'One'</span>, <span class="s1">'Two'</span>, <span class="s1">'Three'</span><span class="o">]</span>, description: <span class="s1">'Pick something'</span><span class="o">)</span>
        password<span class="o">(</span>name: <span class="s1">'PASSWORD'</span>, defaultValue: <span class="s1">'SECRET'</span>, description: <span class="s1">'Enter a password'</span><span class="o">)</span>
    <span class="o">}</span>
    stages <span class="o">{</span>
        stage<span class="o">(</span><span class="s1">'Example'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                <span class="nb">echo</span> <span class="s2">"Hello </span><span class="k">${</span><span class="nv">params</span><span class="p">.PERSON</span><span class="k">}</span><span class="s2">"</span>
                <span class="nb">echo</span> <span class="s2">"Biography: </span><span class="k">${</span><span class="nv">params</span><span class="p">.BIOGRAPHY</span><span class="k">}</span><span class="s2">"</span>
                <span class="nb">echo</span> <span class="s2">"Toggle: </span><span class="k">${</span><span class="nv">params</span><span class="p">.TOGGLE</span><span class="k">}</span><span class="s2">"</span>
                <span class="nb">echo</span> <span class="s2">"Choice: </span><span class="k">${</span><span class="nv">params</span><span class="p">.CHOICE</span><span class="k">}</span><span class="s2">"</span>
                <span class="nb">echo</span> <span class="s2">"Password: </span><span class="k">${</span><span class="nv">params</span><span class="p">.PASSWORD</span><span class="k">}</span><span class="s2">"</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>íŒŒì´í”„ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìˆ˜ì •í•˜ê³  ì €ì¥ í›„ â€œBuild with Parametersâ€ë¥¼ í´ë¦­í•˜ì—¬ íŒŒë¼ë¯¸í„°ë¥¼ ì…ë ¥í•˜ê³  ë¹Œë“œë¥¼ ì‹¤í–‰í•˜ë©´
ì•„ë˜ì™€ ê°™ì´ ì§€ì •ëœ íŒŒë¼ë¯¸í„°ë¡œ ë¹Œë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_24.png" alt="img.png" class="image-center" />
<em class="image-caption">Build with Parameters í™”ë©´</em></p>

<ul>
  <li>
    <p>ì•„ë˜ì²˜ëŸ¼ post (ë¹Œë“œ í›„ ì¡°ì¹˜) ë¸”ë¡ì„ ì¶”ê°€í•˜ì—¬ ë¹Œë“œ í›„ ì¡°ì¹˜ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pipeline <span class="o">{</span>
    agent any
    stages <span class="o">{</span>
        stage<span class="o">(</span><span class="s1">'Compile'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                <span class="nb">echo</span> <span class="s2">"Compiled successfully!"</span><span class="p">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
  
        stage<span class="o">(</span><span class="s1">'JUnit'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                <span class="nb">echo</span> <span class="s2">"JUnit passed successfully!"</span><span class="p">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
  
        stage<span class="o">(</span><span class="s1">'Code Analysis'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                <span class="nb">echo</span> <span class="s2">"Code Analysis completed successfully!"</span><span class="p">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
  
        stage<span class="o">(</span><span class="s1">'Deploy'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                <span class="nb">echo</span> <span class="s2">"Deployed successfully!"</span><span class="p">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    post <span class="o">{</span> 
        always <span class="o">{</span> 
            <span class="nb">echo</span> <span class="s1">'I will always say Hello again!'</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_25.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">step ë³„ ë©”ì‹œì§€ì™€ post ë©”ì‹œì§€</em></p>

    <ul>
      <li>postì—ëŠ” always ì™¸ì—ë„ ë‹¤ìŒê³¼ ê°™ì€ ì˜µì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        <ul>
          <li><strong>always</strong> : í•­ìƒ ì‹¤í–‰</li>
          <li><strong>changed</strong> : ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ ì‹¤í–‰</li>
          <li><strong>success</strong> : ì„±ê³µí–ˆì„ ë•Œ ì‹¤í–‰</li>
          <li><strong>failure</strong> : ì‹¤íŒ¨í–ˆì„ ë•Œ ì‹¤í–‰</li>
          <li><strong>unstable</strong> : ë¶ˆì•ˆì •í•œ ìƒíƒœì¼ ë•Œ ì‹¤í–‰</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Pipeline Syntax -&gt; Snippet Generator ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì´í”„ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_26.png" alt="img.png" class="image-center w-80" /></p>
  </li>
</ul>

<h5 id="gitlabê³¼-jenkins-pipeline-ì—°ë™-ì‹¤ìŠµ">Gitlabê³¼ Jenkins pipeline ì—°ë™ ì‹¤ìŠµ</h5>

<ul>
  <li>Gitlabì—ì„œ ì†ŒìŠ¤ë¥¼ ë°›ì•„ ë¹Œë“œ í›„ Docker Hubì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ëŠ” íŒŒì´í”„ë¼ì¸ì„ êµ¬ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>Pipeline script</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pipeline <span class="o">{</span>
    agent any
    environment <span class="o">{</span>
        DOCKER_IMAGE <span class="o">=</span> <span class="s1">'sweetlittlebird/dev-app'</span> // Docker ì´ë¯¸ì§€ ì´ë¦„
    <span class="o">}</span>
    stages <span class="o">{</span>
        stage<span class="o">(</span><span class="s1">'Checkout'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                 git branch: <span class="s1">'main'</span>,
                 url: <span class="s1">'https://gitlab.com/littlebird/2024-cicd-lite-w1.git'</span>,  // Gitì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                 credentialsId: <span class="s1">'gitlab-credentials'</span>  // Credentials ID
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'Read VERSION'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                script <span class="o">{</span>
                    // VERSION íŒŒì¼ ì½ê¸°
                    def version <span class="o">=</span> readFile<span class="o">(</span><span class="s1">'VERSION'</span><span class="o">)</span>.trim<span class="o">()</span>
                    <span class="nb">echo</span> <span class="s2">"Version found: </span><span class="k">${</span><span class="nv">version</span><span class="k">}</span><span class="s2">"</span>
                    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                    env.DOCKER_TAG <span class="o">=</span> version
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'Docker Build and Push'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                script <span class="o">{</span>
                    docker.withRegistry<span class="o">(</span><span class="s1">'https://index.docker.io/v1/'</span>, <span class="s1">'dockerhub-credentials'</span><span class="o">)</span> <span class="o">{</span>
                        // DOCKER_TAG ì‚¬ìš©
                        def appImage <span class="o">=</span> docker.build<span class="o">(</span><span class="s2">"</span><span class="k">${</span><span class="nv">DOCKER_IMAGE</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">DOCKER_TAG</span><span class="k">}</span><span class="s2">"</span><span class="o">)</span>
                        appImage.push<span class="o">()</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    post <span class="o">{</span>
        success <span class="o">{</span>
            <span class="nb">echo</span> <span class="s2">"Docker image </span><span class="k">${</span><span class="nv">DOCKER_IMAGE</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">DOCKER_TAG</span><span class="k">}</span><span class="s2"> has been built and pushed successfully!"</span>
        <span class="o">}</span>
        failure <span class="o">{</span>
            <span class="nb">echo</span> <span class="s2">"Pipeline failed. Please check the logs."</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Build Now -&gt; Console Output í™•ì¸</p>

    <p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_27.png" alt="img.png" class="image-center w-80" /></p>
  </li>
  <li>
    <p>Docker Hubì—ì„œ ì´ë¯¸ì§€ í™•ì¸</p>

    <p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_28.png" alt="img.png" class="image-center" /></p>
  </li>
</ul>

<h4 id="ë„ì»¤-ê¸°ë°˜-ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜-cicd-êµ¬ì„±">ë„ì»¤ ê¸°ë°˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ CI/CD êµ¬ì„±</h4>

<ul>
  <li>Jenkinsì™€ Gitlabì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒ ê·¸ë¦¼ê³¼ ê°™ì€ í˜•íƒœì˜ ë„ì»¤ ê¸°ë°˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_29.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">ëª©í‘œ CI/CD íŒŒì´í”„ë¼ì¸</em></p>

<h5 id="gitlabì—ì„œ-jenkins-ì—°ë™-ì„¤ì •">Gitlabì—ì„œ Jenkins ì—°ë™ ì„¤ì •</h5>

<ul>
  <li>gitlab í”„ë¡œì íŠ¸ í˜ì´ì§€ &gt; Settings &gt; Integrations &gt; Jenkins ì—°ê²°í›„ ì•„ë˜ì˜ ì •ë³´ë¥¼ ì…ë ¥ í•©ë‹ˆë‹¤.
    <ul>
      <li><strong>Enable integration</strong> : Active ì²´í¬</li>
      <li><strong>Trigger</strong> : Push, Merge request ì²´í¬</li>
      <li><strong>URL</strong> : <code class="language-plaintext highlighter-rouge">http://&lt;Jenkinsì ‘ì†ì£¼ì†Œ&gt;:&lt;Jenkinsí¬íŠ¸&gt;</code></li>
      <li><strong>Project name</strong> : <code class="language-plaintext highlighter-rouge">SCM-Pipeline</code> (Jenkins í”„ë¡œì íŠ¸ ì´ë¦„)</li>
      <li><strong>Username</strong> : <code class="language-plaintext highlighter-rouge">&lt;Jenkins ì•„ì´ë””&gt;</code></li>
      <li><strong>Password</strong> : <code class="language-plaintext highlighter-rouge">&lt;Jenkins ë¹„ë°€ë²ˆí˜¸&gt;</code></li>
    </ul>

    <p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_30.png" alt="img.png" class="image-center" /></p>
  </li>
</ul>

<h5 id="jenkinsì—ì„œ-gitlab-ì—°ë™-ì„¤ì •">Jenkinsì—ì„œ Gitlab ì—°ë™ ì„¤ì •</h5>

<ul>
  <li>Jenkins Item ìƒì„±
    <ul>
      <li>Dashboard &gt; New Item &gt; Pipeline (item name : <code class="language-plaintext highlighter-rouge">SCM-Pipeline</code>)</li>
    </ul>
  </li>
  <li>Build Triggers ì„¤ì •
    <ul>
      <li>Configuration &gt; Build Triggers
        <ul>
          <li><strong>Build when a change is pushed to GitLab</strong> ì²´í¬</li>
          <li><strong>Push Events</strong> ì²´í¬</li>
          <li><strong>Accepted Merge Request Events</strong> ì²´í¬
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_31.png" alt="img.png" /></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Jenkins íŒŒì¼ ìƒì„± í›„ push</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Jenkinsfile <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
pipeline {
    agent any
    environment {
        DOCKER_IMAGE = 'sweetlittlebird/dev-app' // Docker ì´ë¯¸ì§€ ì´ë¦„
    }
    stages {
        stage('Checkout') {
            steps {
                 git branch: 'main',
                 url: 'https://gitlab.com/littlebird/2024-cicd-lite-w1.git',  // Gitì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                 credentialsId: 'gitlab-credentials'  // Credentials ID
            }
        }
        stage('Read VERSION') {
            steps {
                script {
                    // VERSION íŒŒì¼ ì½ê¸°
                    def version = readFile('VERSION').trim()
                    echo "Version found: </span><span class="se">\$</span><span class="sh">{version}"
                    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                    env.DOCKER_TAG = version
                }
            }
        }
        stage('Docker Build and Push') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-credentials') {
                        // DOCKER_TAG ì‚¬ìš©
                        def appImage = docker.build("</span><span class="se">\$</span><span class="sh">{DOCKER_IMAGE}:</span><span class="se">\$</span><span class="sh">{DOCKER_TAG}")
                        appImage.push()
                    }
                }
            }
        }
    }
    post {
        success {
            echo "Docker image </span><span class="se">\$</span><span class="sh">{DOCKER_IMAGE}:</span><span class="se">\$</span><span class="sh">{DOCKER_TAG} has been built and pushed successfully!"
        }
        failure {
            echo "Pipeline failed. Please check the logs."
        }
    }
}
</span><span class="no">EOF
  
</span><span class="c"># ë²„ì „ ì—…ë°ì´íŠ¸</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; VERSION
0.0.2
</span><span class="no">EOF
  
</span><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add Jenkinsfile"</span>
<span class="c"># =&gt; [main e5671f2] Add Jenkinsfile</span>
<span class="c">#     1 file changed, 45 insertions(+)</span>
<span class="c">#     create mode 100644 Jenkinsfile</span>
<span class="nv">$ </span>git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; Enumerating objects: 4, done.</span>
<span class="c">#    Counting objects: 100% (4/4), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (3/3), done.</span>
<span class="c">#    Writing objects: 100% (3/3), 859 bytes | 859.00 KiB/s, done.</span>
<span class="c">#    Total 3 (delta 1), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To https://gitlab.com/littlebird/2024-cicd-lite-w1.git</span>
<span class="c">#       41a6efc..e5671f2  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div>    </div>
  </li>
  <li>Jenkins íŠ¸ë¦¬ê±° ë¹Œë“œ í™•ì¸
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_32.png" alt="img.png" />
    <ul>
      <li>git pushì— ì˜í•´ ìë™ìœ¼ë¡œ ë¹Œë“œê°€ ì˜ ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Docker ì €ì¥ì†Œ í™•ì¸
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_33.png" alt="img.png" />
    <ul>
      <li>Docker Hubì— ìˆ˜ì •ëœ 0.0.2 ë²„ì „ì˜ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œ ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>
    <p>Gitlab Webhook ê¸°ë¡ í™•ì¸
<img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_34.png" alt="img.png" class="image-center" /></p>
  </li>
  <li>
    <p>app.rb ì†ŒìŠ¤ì™€ VERSION ë³€ê²½ í›„ Jenkins íŠ¸ë¦¬ê±° ì‘ì—… í•œë²ˆ ë” í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># app.rb ìˆ˜ì •</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s/Hello, World!/Hello, Jenkins! ğŸ˜€/'</span> app.rb
  
<span class="c"># VERSION ìˆ˜ì •</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"0.0.3"</span> <span class="o">&gt;</span> VERSION
  
<span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Update app.rb and VERSION </span><span class="si">$(</span><span class="nb">cat </span>VERSION<span class="si">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; [main a100e97] Update app.rb and VERSION 0.0.3</span>
<span class="c">#     3 files changed, 7 insertions(+), 2 deletions(-)</span>
<span class="c">#     create mode 100644 app.rb-e</span>
<span class="c">#    Enumerating objects: 7, done.</span>
<span class="c">#    Counting objects: 100% (7/7), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (3/3), done.</span>
<span class="c">#    Writing objects: 100% (4/4), 509 bytes | 509.00 KiB/s, done.</span>
<span class="c">#    Total 4 (delta 0), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To https://gitlab.com/littlebird/2024-cicd-lite-w1.git</span>
<span class="c">#       1bd4fcb..a100e97  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div>    </div>

    <p><img src="/assets/2024/cicd-lite/w1/20241205_cicd_lite_w1_35.png" alt="img.png" /></p>
    <ul>
      <li>ë¹Œë“œê°€ ì˜ ë˜ê³  Docker Hubì— ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œ ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h5 id="jenkins-ë¹Œë“œ-í›„-ì»¨í…Œì´ë„ˆ-ì‹¤í–‰">Jenkins ë¹Œë“œ í›„ ì»¨í…Œì´ë„ˆ ì‹¤í–‰</h5>

<ul>
  <li>Jenkins pipline ë¹Œë“œ í›„ Docker ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ëŠ” íŒŒì´í”„ë¼ì¸ì„ êµ¬ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>
    <p>Jenkinsfile ìˆ˜ì •</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pipeline <span class="o">{</span>
    agent any
    environment <span class="o">{</span>
        DOCKER_IMAGE <span class="o">=</span> <span class="s1">'sweetlittlebird/dev-app'</span> // Docker ì´ë¯¸ì§€ ì´ë¦„
        CONTAINER_NAME <span class="o">=</span> <span class="s1">'dev-app'</span>  // Docker ì»¨í…Œì´ë„ˆ ì´ë¦„
    <span class="o">}</span>
    stages <span class="o">{</span>
        stage<span class="o">(</span><span class="s1">'Checkout'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                git branch: <span class="s1">'main'</span>,
                url: <span class="s1">'https://gitlab.com/littlebird/2024-cicd-lite-w1.git'</span>,  // Gitì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                credentialsId: <span class="s1">'gitlab-credentials'</span>  // Credentials ID
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'Read VERSION'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                script <span class="o">{</span>
                    // VERSION íŒŒì¼ ì½ê¸°
                    def version <span class="o">=</span> readFile<span class="o">(</span><span class="s1">'VERSION'</span><span class="o">)</span>.trim<span class="o">()</span>
                    <span class="nb">echo</span> <span class="s2">"Version found: </span><span class="k">${</span><span class="nv">version</span><span class="k">}</span><span class="s2">"</span>
                    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                    env.DOCKER_TAG <span class="o">=</span> version
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'Docker Build and Push'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                script <span class="o">{</span>
                    docker.withRegistry<span class="o">(</span><span class="s1">'https://index.docker.io/v1/'</span>, <span class="s1">'dockerhub-credentials'</span><span class="o">)</span> <span class="o">{</span>
                        // DOCKER_TAG ì‚¬ìš©
                        def appImage <span class="o">=</span> docker.build<span class="o">(</span><span class="s2">"</span><span class="k">${</span><span class="nv">DOCKER_IMAGE</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">DOCKER_TAG</span><span class="k">}</span><span class="s2">"</span><span class="o">)</span>
                        appImage.push<span class="o">()</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'Check, Stop and Run Docker Container'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                script <span class="o">{</span>
                    // ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
                    def isRunning <span class="o">=</span> sh<span class="o">(</span>
                        script: <span class="s2">"docker ps -q -f name=</span><span class="k">${</span><span class="nv">CONTAINER_NAME</span><span class="k">}</span><span class="s2">"</span>,
                        returnStdout: <span class="nb">true</span>
                    <span class="o">)</span>.trim<span class="o">()</span>
                      
                    <span class="k">if</span> <span class="o">(</span>isRunning<span class="o">)</span> <span class="o">{</span>
                        <span class="nb">echo</span> <span class="s2">"Container '</span><span class="k">${</span><span class="nv">CONTAINER_NAME</span><span class="k">}</span><span class="s2">' is already running. Stopping it..."</span>
                        // ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
                        sh <span class="s2">"docker stop </span><span class="k">${</span><span class="nv">CONTAINER_NAME</span><span class="k">}</span><span class="s2">"</span>
                        // ì»¨í…Œì´ë„ˆ ì œê±°
                        sh <span class="s2">"docker rm </span><span class="k">${</span><span class="nv">CONTAINER_NAME</span><span class="k">}</span><span class="s2">"</span>
                        <span class="nb">echo</span> <span class="s2">"Container '</span><span class="k">${</span><span class="nv">CONTAINER_NAME</span><span class="k">}</span><span class="s2">' stopped and removed."</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="nb">echo</span> <span class="s2">"Container '</span><span class="k">${</span><span class="nv">CONTAINER_NAME</span><span class="k">}</span><span class="s2">' is not running."</span>
                    <span class="o">}</span>
                      
                    // 5ì´ˆ ëŒ€ê¸°
                    <span class="nb">echo</span> <span class="s2">"Waiting for 5 seconds before starting the new container..."</span>
                    <span class="nb">sleep</span><span class="o">(</span>5<span class="o">)</span>
                      
                    // ì‹ ê·œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                    <span class="nb">echo</span> <span class="s2">"Starting a new container '</span><span class="k">${</span><span class="nv">CONTAINER_NAME</span><span class="k">}</span><span class="s2">'..."</span>
                    sh <span class="s2">"""
                    docker run -d --name </span><span class="k">${</span><span class="nv">CONTAINER_NAME</span><span class="k">}</span><span class="s2"> -p 4000:4567 </span><span class="k">${</span><span class="nv">DOCKER_IMAGE</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">DOCKER_TAG</span><span class="k">}</span><span class="s2">
                    """</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>        
    <span class="o">}</span>
    post <span class="o">{</span>
        success <span class="o">{</span>
            <span class="nb">echo</span> <span class="s2">"Docker image </span><span class="k">${</span><span class="nv">DOCKER_IMAGE</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">DOCKER_TAG</span><span class="k">}</span><span class="s2"> has been built and pushed successfully!"</span>
        <span class="o">}</span>
        failure <span class="o">{</span>
            <span class="nb">echo</span> <span class="s2">"Pipeline failed. Please check the logs."</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>git commit í›„ push</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo </span>0.0.4 <span class="o">&gt;</span> VERSION
  
<span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Update Jenkinsfile </span><span class="si">$(</span><span class="nb">cat </span>VERSION<span class="si">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; [main 25e5c95] Update Jenkinsfile 0.0.4</span>
<span class="c">#     2 files changed, 2 insertions(+), 1 deletion(-)</span>
<span class="c">#    Enumerating objects: 7, done.</span>
<span class="c">#    Counting objects: 100% (7/7), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (3/3), done.</span>
<span class="c">#    Writing objects: 100% (4/4), 385 bytes | 385.00 KiB/s, done.</span>
<span class="c">#    Total 4 (delta 2), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To https://gitlab.com/littlebird/2024-cicd-lite-w1.git</span>
<span class="c">#       26c809d..25e5c95  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ìƒì„±ëœ ì»¨í…Œì´ë„ˆ ì ‘ì† í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker image <span class="nb">ls</span>
<span class="c"># =&gt; REPOSITORY                                                                   TAG           IMAGE ID       CREATED             SIZE</span>
<span class="c">#    sweetlittlebird/dev-app                                                      0.0.4         2f5f42fa7dd6   9 minutes ago       1.01GB</span>
<span class="c">#    ... </span>
<span class="nv">$ </span>docker ps <span class="nt">--filter</span> <span class="nv">name</span><span class="o">=</span>dev-app
<span class="c"># =&gt; CONTAINER ID   IMAGE                           COMMAND                  CREATED         STATUS         PORTS                  NAMES</span>
<span class="c">#    e5d4760ea725   sweetlittlebird/dev-app:0.0.4   &amp;quot;ruby app.rb -o 0.0.â€¦&amp;quot;   2 minutes ago   Up 2 minutes   0.0.0.0:4000-&amp;gt;80/tcp   dev-app</span>
<span class="nv">$ </span>curl http://localhost:4000
<span class="c"># =&gt; Hello, Jenkins! ğŸ˜€ The time is 2024-10-01 15:49:44 +0000!!</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>app.rbì™€ VERSION ìˆ˜ì • í›„ push í›„ ì»¨í…Œì´ë„ˆ ì ‘ì† í›„ ë°˜ì˜ í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># app.rb ìˆ˜ì •</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s/Hello, Jenkins! ğŸ˜€/Hello, Jenkins again!!! ğŸ˜/'</span> app.rb
  
<span class="c"># VERSION ìˆ˜ì •</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"0.0.5"</span> <span class="o">&gt;</span> VERSION
  
<span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Update app.rb and VERSION </span><span class="si">$(</span><span class="nb">cat </span>VERSION<span class="si">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; [main 70eaa32] Update app.rb and VERSION 0.0.5</span>
<span class="c">#     3 files changed, 3 insertions(+), 3 deletions(-)</span>
<span class="c">#    Enumerating objects: 7, done.</span>
<span class="c">#    Counting objects: 100% (7/7), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (3/3), done.</span>
<span class="c">#    Writing objects: 100% (4/4), 519 bytes | 519.00 KiB/s, done.</span>
<span class="c">#    Total 4 (delta 0), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To https://gitlab.com/littlebird/2024-cicd-lite-w1.git</span>
<span class="c">#       cc87e97..70eaa32  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
  
<span class="c"># í˜¸ìŠ¤íŠ¸ PCì—ì„œ ë°˜ë³µ ì ‘ì† ì‹¤í–‰ : ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì‹œê°„ ì²´í¬!</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:4000 <span class="p">;</span> <span class="nb">date</span><span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Hello, Jenkins again!!! ğŸ˜ The time is 2024-10-01 15:52:25 +0000!!Sun Oct  1 00:52:25 KST 2024</span>
<span class="c">#    Hello, Jenkins again!!! ğŸ˜ The time is 2024-10-01 15:52:26 +0000!!Sun Oct  1 00:52:26 KST 2024</span>
<span class="c">#    Sun Oct  1 00:52:27 KST 2024</span>
<span class="c">#    Sun Oct  1 00:52:28 KST 2024</span>
<span class="c">#    Sun Oct  1 00:52:29 KST 2024</span>
<span class="c">#    Sun Oct  1 00:52:30 KST 2024</span>
<span class="c">#    Sun Oct  1 00:52:31 KST 2024</span>
<span class="c">#    Sun Oct  1 00:52:32 KST 2024</span>
<span class="c">#    Hello, Jenkins again!!! ğŸ˜ The time is 2024-10-01 15:52:33 +0000!!Sun Oct  1 00:52:33 KST 2024</span>
<span class="c">#    Hello, Jenkins again!!! ğŸ˜ The time is 2024-10-01 15:52:34 +0000!!Sun Oct  1 00:52:34 KST 2024</span>
<span class="c">#    Hello, Jenkins again!!! ğŸ˜ The time is 2024-10-01 15:52:35 +0000!!Sun Oct  1 00:52:35 KST 2024</span>
</code></pre></div>    </div>
  </li>
  <li>ìˆ˜ì •ì‚¬í•­ì´ ì ìš©ì€ ì˜ ë˜ì—ˆì§€ë§Œ 6~7ì´ˆ ê°€ëŸ‰ ì„œë¹„ìŠ¤ê°€ ì¤‘ë‹¨ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì¬ì‹œì‘ ì‹œê°„ì´ ì†Œìš”ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
  <li>ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ docker swarmì´ë‚˜ kubernetes ë“±ì˜ ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ íˆ´ì„ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ì´ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ ë¶€ë¶„ì€ ë‹¤ìŒì— ë‹¤ë£¨ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆ ì‹œê°„ì—ëŠ” Jenkins, Gitlab ë“±ì„ ì‚¬ìš©í•˜ì—¬ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì„±í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.
ë‹¤ì–‘í•˜ê²Œ í…ŒìŠ¤íŠ¸í•´ë³´ê³  ì‹¶ì—ˆëŠ”ë° ìƒê°ë³´ë‹¤ ì •ë¦¬í•˜ëŠ”ë° ì‹œê°„ì´ ë§ì´ ì†Œìš”ë˜ì–´ ë‹¤ì–‘í•œ ì˜ˆì œë¥¼ ë‹¤ë£¨ì§€ ëª»í•œ ì ì´ ì•„ì‰½ìŠµë‹ˆë‹¤.</p>

<p>JenkinsëŠ” ì˜ˆì „ì— ì¨ë³´ê³  Teamcityë‚˜ Github actionì„ ì£¼ë¡œ ì‚¬ìš©í•´ì™”ëŠ”ë°, 
ë‹¤ì‹œ ì‚¬ìš©í•´ë³´ë‹ˆ Jenkinsë„ Jenkinsfileê³¼ Pipelineë„ ì§€ì›í•˜ê³  ì˜ˆì „ì— ë¹„í•´ì„œ í›¨ì”¬ ì¢‹ì•„ì§„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ì´ë²ˆ ìŠ¤í„°ë””ë¥¼ í†µí•´ Jenkinsë¥¼ ì¬ë°œê²¬í•œê²ƒ ê°™ìŠµë‹ˆë‹¤.
ì¤€ë¹„í•´ì£¼ì‹  Gasida ë‹˜ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.</p>]]></content><author><name></name></author><category term="kans" /><category term="cicd," /><category term="jenkins," /><category term="git," /><category term="linux" /><summary type="html"><![CDATA[Jenkinsì™€ Git, Dockerë¥¼ ì´ìš©í•˜ì—¬ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•´ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[KANS 3ê¸°] AWS EKS : VPC CNI</title><link href="https://sweetlittlebird.github.io/posts/2024-11-03-KANS-Study-Week9/" rel="alternate" type="text/html" title="[KANS 3ê¸°] AWS EKS : VPC CNI" /><published>2024-11-03T00:00:18+09:00</published><updated>2024-11-03T00:00:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/KANS%20Study%20-%20Week9</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2024-11-03-KANS-Study-Week9/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì•ˆë…•í•˜ì„¸ìš”. ì´ë²ˆ ì£¼ì—ëŠ” AWS EKSì˜ VPC CNIì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
KANS 3ê¸° 9ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="aws-eks--vpc-cni">AWS EKS : VPC CNI</h2>

<h3 id="aws-vpc-cni-ì†Œê°œ">AWS VPC CNI ì†Œê°œ</h3>

<ul>
  <li>AWS VPC CNIëŠ” AWSì—ì„œ ì œê³µí•˜ëŠ” CNI(Container Network Interface) í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ, AWS VPC(Virtual Private Cloud)ì˜ ë„¤íŠ¸ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒë“œ ê°„ í†µì‹ ì„ ì§€ì›í•˜ëŠ” CNI í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</li>
  <li>AWS VPC CNIì˜ íŠ¹ì§•
    <ul>
      <li>ê°€ì¥ í° íŠ¹ì§•ì€ íŒŒë“œì˜ IP ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ê³¼ ë…¸ë“œ(ì¸ìŠ¤í„´ìŠ¤)ì˜ IP ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì´ ê°™ì•„ì„œ ì§ì ‘ í†µì‹ ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. - 
<a href="https://github.com/aws/amazon-vpc-cni-k8s">Github</a>, <a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md">Proposal</a></li>
      <li>ë˜í•œ VPCì™€ í†µí•©ë˜ì–´ VPC Flow logsë‚˜ VPC ë¼ìš°íŒ… ì •ì±…, ë³´ì•ˆ ê·¸ë£¹(Security Group) ë“±ì„ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ì•„ë˜ì—ì„œ ì„¤ëª…í•  Warm Poolì„ í†µí•´ ë…¸ë“œì˜ IP ì£¼ì†Œë¥¼ ì¬ì‚¬ìš©í•˜ì—¬ íŒŒë“œì˜ ìƒì„±ê³¼ ì‚­ì œë¥¼ ë¹ ë¥´ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Amazon VPC CNIëŠ” í¬ê²Œ ë‘ê°€ì§€ êµ¬ì„±ìš”ì†Œë¡œ  ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.
    <ul>
      <li>CNI ë°”ì´ë„ˆë¦¬ : íŒŒë“œê°„ í†µì‹ ì„ í™œì„±í™” í•˜ë„ë¡ íŒŒë“œ ë„¤íŠ¸ì›Œí¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. CNI ë°”ì´ë„ˆë¦¬ëŠ” ë…¸ë“œì˜ ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ì‹¤í–‰ë˜ë©°,
ìƒˆë¡œìš´ íŒŒë“œê°€ ì¶”ê°€ë˜ê±°ë‚˜, ê¸°ì¡´ íŒŒë“œê°€ ì œê±° ë ë•Œ kubeletì— ì˜í•´ í˜¸ì¶œë©ë‹ˆë‹¤.</li>
      <li>ipamd : IP ì£¼ì†Œë¥¼ í• ë‹¹í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë°ëª¬ìœ¼ë¡œ ë‹¤ìŒì„ ë‹´ë‹¹ í•©ë‹ˆë‹¤.
        <ul>
          <li>ë…¸ë“œì—ì„œ ENI(<code class="language-plaintext highlighter-rouge">Elastic Network Interface</code> - EC2ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì¼ì¢…ì˜ ê°€ìƒ ëœì¹´ë“œ) ê´€ë¦¬</li>
          <li>ì‚¬ìš©ê°€ëŠ¥í•œ IP ì£¼ì†Œë“¤ì˜ ì›œí’€ ìœ ì§€</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ë©´ EC2ëŠ” ê¸°ë³¸ ì„œë¸Œë„·ê³¼ ì—°ê²°ëœ ê¸°ë³¸ ENIë¥¼ ìƒì„±í•˜ê³  ì—°ê²°í•©ë‹ˆë‹¤.
í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” í¬ë“œëŠ” ë…¸ë“œ ê¸°ë³¸ ENIì— í• ë‹¹ëœ ê¸°ë³¸ IP ì£¼ì†Œë¥¼ 
ì‚¬ìš©í•˜ë©° í˜¸ìŠ¤íŠ¸ì™€ ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê³µìœ í•©ë‹ˆë‹¤.</li>
</ul>

<blockquote>
  <p><strong>ì›œí’€(warm pool)</strong>ì€
  ë…¸ë“œê°€ í”„ë¡œë¹„ì €ë‹ ë  ë•Œ ë¯¸ë¦¬ í• ë‹¹ëœ IP ì£¼ì†Œë“¤ì˜ ì§‘í•©ì…ë‹ˆë‹¤. 
  ì´ê²ƒì€ ë…¸ë“œê°€ í”„ë¡œë¹„ì €ë‹ ë  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ IP ì£¼ì†Œë¥¼ í• ë‹¹í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê³ , ë…¸ë“œê°€ ì‚­ì œë˜ì–´ë„ IP ì£¼ì†Œë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ì—¬
  ì¡°ê¸ˆ ë” ë¹ ë¥¸ íŒŒë“œì˜ ìƒì„±ê³¼ ì‚­ì œë¥¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.</p>
</blockquote>

<ul>
  <li>EC2 ì¸ìŠ¤í„´ìŠ¤ë³„ ìµœëŒ€ ì‚¬ìš©ê°€ëŠ¥í•œ ENI ê°¯ìˆ˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥´ë©°, 
ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ë³„ ENI ê°¯ìˆ˜ëŠ” <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#network-cards">ì—¬ê¸°</a>ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
ì´ ENI ê°¯ìˆ˜ì— ë”°ë¼ í• ë‹¹ ê°€ëŠ¥í•œ IP ì£¼ì†Œì˜ ê°¯ìˆ˜ê°€ ê²°ì •ë˜ë©°, ì´ì— ë”°ë¼ íŒŒë“œì˜ ê°¯ìˆ˜ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>
    <p>ê° ENIëŠ” í• ë‹¹í•  ìˆ˜ ìˆëŠ” IPìˆ˜ê°€ ì œí•œë˜ì–´ ìˆìœ¼ë©°, ì´ ìˆ˜ëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤.
ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ë³„ ENI ë‹¹ IP í• ë‹¹ ìˆ˜ëŠ” <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AvailableIpPerENI.html">ì—¬ê¸°</a>ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ENI ë‹¹ í• ë‹¹í•  ìˆ˜ ìˆëŠ” IP ë¥¼ slot ì´ë¼ê³  í•˜ë©°, ì´ slotì€ VPC CNIë¥¼ í†µí•´ íŒŒë“œì— í• ë‹¹ë©ë‹ˆë‹¤.</p>

    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_1.png" alt="img.png" class="image-center" />
<em class="image-caption">íŒŒë“œì— IPë¥¼ í• ë‹¹í•˜ê¸° ìœ„í•œ ì ˆì°¨</em></p>
  </li>
</ul>

<h4 id="calico-cniì™€ì˜-ì°¨ì´ì ">Calico CNIì™€ì˜ ì°¨ì´ì </h4>

<ul>
  <li>ë…¸ë“œì™€ íŒŒë“œì˜ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì„ ë™ì¼í•˜ê²Œ ì„¤ì •í•¨ìœ¼ë¡œì¨ NAT(Network Address Translation)ì„ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ë˜ê¸° ë•Œë¬¸ì—
ì„±ëŠ¥ì´ í–¥ìƒë˜ê³  ì§€ì—°ì´ ìµœì†Œí™” ë©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_2.png" alt="img.png" class="image-center w-80" /></p>

<ul>
  <li>íŒŒë“œê°„ í†µì‹ ì‹œ Calico CNI ë“±ì˜ ì¼ë°˜ì ì¸ CNIëŠ” ì˜¤ë²„ë ˆì´(VXLAN, IP-in-IP)ë¥¼ ì‚¬ìš©í•˜ì—¬ í†µì‹ í•˜ì§€ë§Œ,
AWS VPC CNIëŠ” VPCì˜ ë„¤íŠ¸ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ì ‘ í†µì‹ í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_3.png" alt="img_1.png" class="image-center w-90" /></p>

<h4 id="ipv4-prefix-ìœ„ì„-delegation">IPv4 Prefix ìœ„ì„ (Delegation)</h4>

<ul>
  <li>ì•ì„œ ì•Œì•„ ë³¸ê²ƒ ì²˜ëŸ¼ ê° íŒŒë“œëŠ” ë…¸ë“œì˜ ENIì— í• ë‹¹ëœ IP ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ê³ , ENIë‹¹ IP (slot) ìˆ˜ì™€ ENI ê°¯ìˆ˜ëŠ”
ì¸ìŠ¤í„´ìŠ¤ë³„ë¡œ ì œí•œì´ ìˆê³ , ì´ ê°’ì´ í° í¸ì´ ì•„ë‹™ë‹ˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸°ìœ„í•´ IPv4 Prefix ìœ„ì„ì´ ë„ì…ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>IPv4 PrefixëŠ” ENI ë³„ë¡œ IPë¥¼ í• ë‹¹í•˜ì§€ ì•Šê³ , /28ì˜ ì ‘ë‘ì‚¬ ê¸¸ì´ CIDR ë¸”ë¡ì„ ë…¸ë“œì— í• ë‹¹í•˜ì—¬ íŒŒë“œì— í• ë‹¹í•  IP ì£¼ì†Œë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
ì´ë ‡ê²Œ í•˜ë©´ ê° ìŠ¬ëë‹¹ 16ê°œì˜ IPì£¼ì†Œë¥¼ í• ë‹¹í•  ìˆ˜ ìˆì–´ì„œ ë‹¤ìŒê³¼ ê°™ì€ ê°¯ìˆ˜ì˜ ìµœëŒ€ IP ë˜ëŠ” íŒŒë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ìµœëŒ€ ì‚¬ìš©ê°€ëŠ¥í•œ IP ìˆ˜ ê³„ì‚° : 
<code class="language-plaintext highlighter-rouge">ì‚¬ìš©ê°€ëŠ¥í•œ íŒŒë“œ IP ìˆ˜ = (ìµœëŒ€ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤(ENI) ê°¯ìˆ˜ * (ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ë‹¹ slot ìˆ˜ - 1) * 16)</code>
    <ul>
      <li>ë‹¨, ì‹¤ì œë¡œëŠ” ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•ë³„ë¡œ ê¶Œì¥ë˜ëŠ” ìµœëŒ€ ê°¯ìˆ˜ë¡œ ì„ ì •ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_4.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>ì°¸ê³  ë§í¬ : <a href="https://trans.yonghochoi.com/translations/aws_vpc_cni_increase_pods_per_node_limits.ko">Amazon VPC CNI í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ ë…¸ë“œë‹¹ íŒŒë“œìˆ˜ ì œí•œ ëŠ˜ë¦¬ê¸°</a></li>
</ul>

<hr />

<h3 id="ì‹¤ìŠµ-ì¤€ë¹„">ì‹¤ìŠµ ì¤€ë¹„</h3>

<h4 id="êµ¬ì„±-í™˜ê²½">êµ¬ì„± í™˜ê²½</h4>

<ul>
  <li>ì‚¬ì „ ì¤€ë¹„ë¬¼ : AWS ê³„ì •, SSH í‚¤ í˜ì–´, IAM ê³„ì • ìƒì„± í›„ í‚¤</li>
  <li>ì „ì²´ êµ¬ì„±ë„ : VPC 1ê°œ(í¼ë¸”ë¦­ ì„œë¸Œë„· 3ê°œ, í”„ë¼ì´ë¹— ì„œë¸Œë„· 3ê°œ), EKS í´ëŸ¬ìŠ¤í„°(Control Plane), ê´€ë¦¬í˜• ë…¸ë“œ ê·¸ë£¹(EC2 3ëŒ€), Add-on
<img src="/assets/2024/kans-3th/w9/20241102_kans_w9_28.png" alt="img.png" class="image-center" />
    <ul>
      <li>CloudFormation ìŠ¤íƒ ì‹¤í–‰ ì‹œ <strong>íŒŒë¼ë¯¸í„°</strong>ë¥¼ ê¸°ì…í•˜ë©´, í•´ë‹¹ ì •ë³´ê°€ ë°˜ì˜ë˜ì–´ ë°°í¬ë©ë‹ˆë‹¤.</li>
      <li>ì‹¤ìŠµ í™˜ê²½ì„ ìœ„í•œ <strong>VPC</strong> 1ê°œê°€ ìƒì„±ë˜ê³ , <strong>í¼ë¸”ë¦­</strong> ì„œë¸Œë„· 3ê°œì™€ <strong>í”„ë¼ì´ë¹—</strong> ì„œë¸Œë„· 3ê°œê°€ ìƒì„±ë©ë‹ˆë‹¤.</li>
      <li>CloudFormation ì— EC2ì˜ <strong>UserData</strong> ë¶€ë¶„(<strong>Script</strong> ì‹¤í–‰)ìœ¼ë¡œ Amazon EKS <strong>ì„¤ì¹˜(with OIDC, Endpoint Public)</strong>ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</li>
      <li><strong>ê´€ë¦¬í˜• ë…¸ë“œ ê·¸ë£¹</strong>(ì›Œì»¤ ë…¸ë“œ)ëŠ” AZ1~AZ3ë¥¼ ì‚¬ìš©í•˜ì—¬, ê¸°ë³¸ <strong>3</strong>ëŒ€ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤</li>
      <li><strong>Add-on</strong> ê°™ì´ ì„¤ì¹˜ ë¨ : ìµœì‹  ë²„ì „ - kube-proxy, coredns, aws vpc cni - <a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-add-ons.html">ë§í¬</a></li>
      <li><strong>ë…¸ë“œ</strong>ì— <strong>EC2 IAM Profile</strong> ê¶Œí•œ ì¶”ê°€ : external-dns-access, full-ecr-access, alb-ingress-access, awsLoadBalancerController</li>
    </ul>
  </li>
</ul>

<h4 id="ë°°í¬-ë°-í…ŒìŠ¤íŠ¸">ë°°í¬ ë° í…ŒìŠ¤íŠ¸</h4>

<ul>
  <li>ë°°í¬
    <ul>
      <li>aws clië¥¼ ì„¤ì¹˜í•˜ê³ , aws configureë¡œ ìê²©ì¦ëª…ì„ ì„¤ì • í›„ ì•„ë˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.</li>
      <li>ë‹¤ìŒì˜ íŒŒë¼ë¯¸í„°ê°€ ìˆê³ , :point_right: í‘œì‹œê°€ ìˆëŠ” ë¶€ë¶„ì€ í•„ìˆ˜ë¡œ ì„¤ì •í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.
        <ul>
          <li><strong>Deploy EC2</strong>
            <ol>
              <li>:point_right: <strong>KeyName</strong> : ì‘ì—…ìš© bastion ec2ì— SSH ì ‘ì†ì„ ìœ„í•œ <strong>SSH í‚¤í˜ì–´</strong> ì„ íƒ <em>â† ë¯¸ë¦¬ SSH í‚¤ ìƒì„± í•´ë‘ì!</em></li>
              <li>:point_right: <strong>MyIamUserAccessKeyID</strong> : <strong>ê´€ë¦¬ì</strong> ìˆ˜ì¤€ì˜ ê¶Œí•œì„ ê°€ì§„ IAM Userì˜ ì•¡ì„¸ìŠ¤ í‚¤ID ì…ë ¥</li>
              <li>:point_right: <strong>MyIamUserSecretAccessKey</strong> : <strong>ê´€ë¦¬ì</strong> ìˆ˜ì¤€ì˜ ê¶Œí•œì„ ê°€ì§„ IAM Userì˜ <strong>ì‹œí¬ë¦¿ í‚¤ID</strong> ì…ë ¥ <strong>â† ë…¸ì¶œë˜ì§€ ì•Šê²Œ ë³´ì•ˆ ì£¼ì˜</strong></li>
              <li>:point_right: <strong>SgIngressSshCidr</strong> : ì‘ì—…ìš© bastion ec2ì— <strong>SSH ì ‘ì† ê°€ëŠ¥í•œ IP</strong> ì…ë ¥ (<strong>ì§‘ ê³µì¸IP</strong>/32 ì…ë ¥), ë³´ì•ˆê·¸ë£¹ ì¸ë°”ìš´ë“œ ê·œì¹™ì— ë°˜ì˜ë¨</li>
              <li>MyInstanceType: ì‘ì—…ìš© bastion EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ íƒ€ì… (ê¸°ë³¸ <strong>t3.medium</strong>) â‡’ ë³€ê²½ ê°€ëŠ¥</li>
              <li>LatestAmiId : ì‘ì—…ìš© bastion EC2ì— ì‚¬ìš©í•  AMIëŠ” ì•„ë§ˆì¡´ë¦¬ëˆ…ìŠ¤2 ìµœì‹  ë²„ì „ ì‚¬ìš©</li>
            </ol>
          </li>
          <li><strong>EKS Config</strong>
            <ol>
              <li><strong>ClusterBaseName</strong> : EKS <strong>í´ëŸ¬ìŠ¤í„° ì´ë¦„</strong>ì´ë©°, <strong>myeks</strong> ê¸°ë³¸ê°’ ì‚¬ìš©ì„ ê¶Œì¥ â†’ ì´ìœ : ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ íƒœê·¸ëª…ê³¼ ì‹¤ìŠµ ì»¤ë©˜ë“œì—ì„œ ì‚¬ìš©</li>
              <li><strong>KubernetesVersion</strong> : EKS í˜¸í™˜, ì¿ ë²„ë„¤í‹°ìŠ¤ ë²„ì „ (ê¸°ë³¸ v1.30, ì‹¤ìŠµì€ <strong>1.30</strong> ë²„ì „ ì‚¬ìš©)</li>
              <li><strong>WorkerNodeInstanceType</strong>: ì›Œì»¤ ë…¸ë“œ EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ íƒ€ì… (ê¸°ë³¸ <strong>t3.medium</strong>) â‡’ ë³€ê²½ ê°€ëŠ¥</li>
              <li><strong>WorkerNodeCount</strong> : ì›Œì»¤ë…¸ë“œì˜ ê°¯ìˆ˜ë¥¼ ì…ë ¥ (ê¸°ë³¸ 3ëŒ€) â‡’ ë³€ê²½ ê°€ëŠ¥</li>
              <li><strong>WorkerNodeVolumesize</strong> : ì›Œì»¤ë…¸ë“œì˜ EBS ë³¼ë¥¨ í¬ê¸° (ê¸°ë³¸ 80GiB) â‡’ ë³€ê²½ ê°€ëŠ¥</li>
            </ol>
          </li>
          <li><strong>Region AZ</strong> : ë¦¬ì „ê³¼ ê°€ìš©ì˜ì—­ì„ ì§€ì •, ê¸°ë³¸ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># YAML íŒŒì¼ ë‹¤ìš´ë¡œë“œ</span>
<span class="nv">$ </span>curl <span class="nt">-O</span> https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/kans/eks-oneclick.yaml

<span class="c"># CloudFormation ìŠ¤íƒ ë°°í¬</span>
<span class="c"># aws cloudformation deploy --template-file eks-oneclick.yaml --stack-name myeks --parameter-overrides KeyName=&lt;My SSH Keyname&gt; SgIngressSshCidr=&lt;My Home Public IP Address&gt;/32 MyIamUserAccessKeyID=&lt;IAM Userì˜ ì•¡ì„¸ìŠ¤í‚¤&gt; MyIamUserSecretAccessKey=&lt;IAM Userì˜ ì‹œí¬ë¦¿ í‚¤&gt; ClusterBaseName='&lt;eks ì´ë¦„&gt;' --region ap-northeast-2</span>
<span class="c"># ì˜ˆì‹œ) aws cloudformation deploy --template-file eks-oneclick.yaml --stack-name myeks --parameter-overrides KeyName=aws-ec2 SgIngressSshCidr=$(curl -s ipinfo.io/ip)/32  MyIamUserAccessKeyID=AKIA5... MyIamUserSecretAccessKey='CVNa2...' ClusterBaseName=myeks --region ap-northeast-2</span>

<span class="c">## Tip. ì›Œì»¤ë…¸ë“œ ì¸ìŠ¤í„´ìŠ¤ íƒ€ì… ë³€ê²½ : WorkerNodeInstanceType=t3.xlarge</span>
<span class="c"># ì˜ˆì‹œ) aws cloudformation deploy --template-file eks-oneclick.yaml --stack-name myeks --parameter-overrides KeyName=aws-ec2 SgIngressSshCidr=$(curl -s ipinfo.io/ip)/32  MyIamUserAccessKeyID=AKIA5... MyIamUserSecretAccessKey='CVNa2...' ClusterBaseName=myeks --region ap-northeast-2 WorkerNodeInstanceType=t3.xlarge </span>

<span class="nv">$ </span>aws cloudformation deploy <span class="nt">--template-file</span> eks-oneclick.yaml <span class="nt">--stack-name</span> myeks <span class="se">\</span>
  <span class="nt">--parameter-overrides</span> <span class="nv">KeyName</span><span class="o">=</span>aws-ec2 <span class="se">\</span>
  <span class="nv">SgIngressSshCidr</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span>/32 <span class="se">\</span>
  <span class="nv">MyIamUserAccessKeyID</span><span class="o">=</span>AKIA5... <span class="se">\</span>
  <span class="nv">MyIamUserSecretAccessKey</span><span class="o">=</span><span class="s1">'CVNa2...'</span> <span class="se">\ </span> 
  <span class="nv">ClusterBaseName</span><span class="o">=</span>myeks <span class="se">\ </span>
  <span class="nt">--region</span> ap-northeast-2
<span class="c"># =&gt; Waiting for changeset to be created..</span>
<span class="c">#    Waiting for stack create/update to complete</span>
<span class="c">#    Successfully created/updated stack - myeks</span>

<span class="c"># CloudFormation ìŠ¤íƒ ë°°í¬ ì™„ë£Œ í›„ ì‘ì—…ìš© EC2 IP ì¶œë ¥</span>
<span class="nv">$ </span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> myeks <span class="nt">--query</span> <span class="s1">'Stacks[*].Outputs[0].OutputValue'</span> <span class="nt">--output</span> text
<span class="c"># =&gt; 3.35.140.75</span>

<span class="c"># ì‘ì—…ìš© EC2 SSH ì ‘ì†</span>
<span class="nv">$ </span>ssh <span class="nt">-i</span> ~/.ssh/aws-ec2-key.cer ec2-user@<span class="si">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> myeks <span class="nt">--query</span> <span class="s1">'Stacks[*].Outputs[0].OutputValue'</span> <span class="nt">--output</span> text<span class="si">)</span>
<span class="c"># =&gt;    ,     #_</span>
<span class="c">#       ~\_  ####_        Amazon Linux 2</span>
<span class="c">#      ~~  \_#####\</span>
<span class="c">#      ~~     \###|       AL2 End of Life is 2025-06-30.</span>
<span class="c">#      ~~       \#/ ___</span>
<span class="c">#       ~~       V~' '-&amp;gt;</span>
<span class="c">#        ~~~         /    A newer version of Amazon Linux is available!</span>
<span class="c">#          ~~._.   _/</span>
<span class="c">#             _/ _/       Amazon Linux 2023, GA and supported until 2028-03-15.</span>
<span class="c">#           _/m/'           https://aws.amazon.com/linux/amazon-linux-2023/</span>
<span class="c">#    </span>
<span class="c">#    10 package(s) needed for security, out of 13 available</span>
<span class="c">#    Run &amp;quot;sudo yum update&amp;quot; to apply all updates.</span>
<span class="c">#    [root@myeks-bastion ~]#</span>
</code></pre></div></div>

<ul>
  <li>ì‘ì—…ìš© EC2ì— SSH í‚¤ íŒŒì¼ ì‚¬ìš©í•˜ì—¬ SSH ì ‘ì† í›„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ ì •ìƒ ì„¤ì¹˜ í™•ì¸ì€ ìŠ¤íƒ ìƒì„± ì‹œì‘ í›„ 20ë¶„ í›„ ì ‘ì†í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</li>
  <li>ì ‘ì† í›„ ê¸°ë³¸ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># SSH ì ‘ì†</span>
<span class="nv">$ </span>ssh <span class="nt">-i</span> ~/.ssh/aws-ec2-key.cer ec2-user@<span class="si">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> myeks <span class="nt">--query</span> <span class="s1">'Stacks[*].Outputs[0].OutputValue'</span> <span class="nt">--output</span> text<span class="si">)</span>

<span class="c"># cloud-init ì‹¤í–‰ ê³¼ì • ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-f</span> /var/log/cloud-init-output.log
<span class="c"># =&gt;  ...</span>
<span class="c">#     69  dnsmasq                  available    [ =stable ]</span>
<span class="c">#     70  unbound1.17              available    [ =stable ]</span>
<span class="c">#     72  collectd-python3         available    [ =stable ]</span>
<span class="c">#    â€  Note on end-of-support. Use 'info' subcommand.</span>
<span class="c">#    Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span>
<span class="c">#    cloudinit End!</span>
<span class="c">#    Cloud-init v. 19.3-46.amzn2.0.2 finished at Sat, 01 Nov 2024 07:27:24 +0000. Datasource DataSourceEc2.  Up 84.79 seconds</span>

<span class="c"># cloud-init ì •ìƒ ì™„ë£Œ í›„ eksctl ì‹¤í–‰ ê³¼ì • ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-f</span> /root/create-eks.log
<span class="c"># =&gt; ...</span>
<span class="c">#    2024-10-01 16:26:46 [â„¹]  deploying stack &amp;quot;eksctl-myeks-cluster&amp;quot;</span>
<span class="c">#    2024-10-01 16:27:16 [â„¹]  waiting for CloudFormation stack &amp;quot;eksctl-myeks-cluster&amp;quot;</span>
<span class="c">#    ...</span>
<span class="c">#    2024-10-01 16:40:31 [âœ”]  EKS cluster &amp;quot;myeks&amp;quot; in &amp;quot;ap-northeast-2&amp;quot; region is ready</span>

<span class="c"># default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì ìš©</span>
<span class="nv">$ </span>kubectl ns default
<span class="c"># =&gt; Context &amp;quot;anonym@myeks.ap-northeast-2.eksctl.io&amp;quot; modified.</span>
<span class="c">#    Active namespace is &amp;quot;default&amp;quot;.</span>

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://CF0FD5E1EEB937DD6FF881B7EBADDFD4.yl4.ap-northeast-2.eks.amazonaws.com</span>
<span class="c">#    CoreDNS is running at https://CF0FD5E1EEB937DD6FF881B7EBADDFD4.yl4.ap-northeast-2.eks.amazonaws.com/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="nv">$ </span>eksctl get cluster
<span class="c"># =&gt; NAME REGION    EKSCTL CREATED</span>
<span class="c">#    myeks  ap-northeast-2  True</span>
<span class="nv">$ </span>eksctl get nodegroup <span class="nt">--cluster</span> <span class="nv">$CLUSTER_NAME</span>
<span class="c"># =&gt; CLUSTER  NODEGROUP STATUS  CREATED               MIN SIZE  MAX SIZE  DESIRED CAPACITY  INSTANCE TYPE  IMAGE ID    ASG NAME                                      TYPE</span>
<span class="c">#    myeks    ng1       ACTIVE  2024-10-01T07:37:58Z  3         3         3                 t3.medium      AL2_x86_64  eks-ng1-4ec975e7-9584-1403-37c4-fc55cc2ec860  managed</span>

<span class="c"># í™˜ê²½ë³€ìˆ˜ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">export</span> | egrep <span class="s1">'ACCOUNT|AWS_|CLUSTER|KUBERNETES|VPC|Subnet'</span>
<span class="nv">$ </span><span class="nb">export</span> | egrep <span class="s1">'ACCOUNT|AWS_|CLUSTER|KUBERNETES|VPC|Subnet'</span> | egrep <span class="nt">-v</span> <span class="s1">'SECRET|KEY'</span>
<span class="c"># =&gt; declare -x ACCOUNT_ID=&amp;quot;123456789012&amp;quot;</span>
<span class="c">#    declare -x AWS_DEFAULT_REGION=&amp;quot;ap-northeast-2&amp;quot;</span>
<span class="c">#    declare -x AWS_PAGER=&amp;quot;&amp;quot;</span>
<span class="c">#    declare -x AWS_REGION=&amp;quot;ap-northeast-2&amp;quot;</span>
<span class="c">#    declare -x CLUSTER_NAME=&amp;quot;myeks&amp;quot;</span>
<span class="c">#    declare -x KUBERNETES_VERSION=&amp;quot;1.30&amp;quot;</span>
<span class="c">#    declare -x PrivateSubnet1=&amp;quot;subnet-02550e25cd3a9d814&amp;quot;</span>
<span class="c">#    declare -x PrivateSubnet2=&amp;quot;subnet-0c2adfcc3d586e58d&amp;quot;</span>
<span class="c">#    declare -x PrivateSubnet3=&amp;quot;subnet-04dd8e21b159de4cb&amp;quot;</span>
<span class="c">#    declare -x PubSubnet1=&amp;quot;subnet-0a06ed52d587bd707&amp;quot;</span>
<span class="c">#    declare -x PubSubnet2=&amp;quot;subnet-00b4dacf7eef35d33&amp;quot;</span>
<span class="c">#    declare -x PubSubnet3=&amp;quot;subnet-03c911c48452b41b2&amp;quot;</span>
<span class="c">#    declare -x VPCID=&amp;quot;vpc-0837921f515624150&amp;quot;</span>

<span class="c"># ì¸ì¦ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> /root/.kube/config
<span class="nv">$ </span>kubectl config view
<span class="nv">$ </span>kubectl ctx
<span class="c"># =&gt; anonym@myeks.ap-northeast-2.eksctl.io</span>

<span class="c"># ë…¸ë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get node <span class="nt">--label-columns</span><span class="o">=</span>node.kubernetes.io/instance-type,eks.amazonaws.com/capacityType,topology.kubernetes.io/zone
<span class="c"># =&gt; NAME                                               STATUS   ROLES    AGE     VERSION               INSTANCE-TYPE   CAPACITYTYPE   ZONE</span>
<span class="c">#    ip-192-168-1-186.ap-northeast-2.compute.internal   Ready    &amp;lt;none&amp;gt;   7m26s   v1.30.4-eks-a737599   t3.medium       ON_DEMAND      ap-northeast-2a</span>
<span class="c">#    ip-192-168-2-92.ap-northeast-2.compute.internal    Ready    &amp;lt;none&amp;gt;   7m22s   v1.30.4-eks-a737599   t3.medium       ON_DEMAND      ap-northeast-2b</span>
<span class="c">#    ip-192-168-3-235.ap-northeast-2.compute.internal   Ready    &amp;lt;none&amp;gt;   7m22s   v1.30.4-eks-a737599   t3.medium       ON_DEMAND      ap-northeast-2c</span>
<span class="nv">$ </span>eksctl get iamidentitymapping <span class="nt">--cluster</span> myeks
<span class="c"># =&gt; ARN                      USERNAME        GROUPS          ACCOUNT</span>
<span class="c">#    arn:aws:iam::123456789012:role/eksctl-myeks-nodegroup-ng1-NodeInstanceRole-kPdCWLD1sAsU  system:node: system:bootstrappers,system:nodes</span>

<span class="c"># krew í”ŒëŸ¬ê·¸ì¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl krew list
<span class="c"># =&gt; PLUGIN   VERSION</span>
<span class="c">#    ctx      v0.9.5</span>
<span class="c">#    get-all  v1.3.8</span>
<span class="c">#    krew     v0.4.4</span>
<span class="c">#    neat     v2.0.4</span>
<span class="c">#    ns       v0.9.5</span>
<span class="c">#    stern    v1.31.0</span>

<span class="c"># ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ëª¨ë“  ë¦¬ì†ŒìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>kubectl get-all
</code></pre></div></div>

<ul>
  <li>ë…¸ë“œ ì ‘ì† í™•ì¸ ë° SSH ì ‘ì†</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë…¸ë“œ IP í™•ì¸ ë° PrivateIP ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ </span>aws ec2 describe-instances <span class="nt">--query</span> <span class="s2">"Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key=='Name']|[0].Value,Status:State.Name}"</span> <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>instance-state-name,Values<span class="o">=</span>running <span class="nt">--output</span> table
<span class="c"># =&gt; ------------------------------------------------------------------</span>
<span class="c">#    |                        DescribeInstances                       |</span>
<span class="c">#    +----------------+-----------------+------------------+----------+</span>
<span class="c">#    |  InstanceName  |  PrivateIPAdd   |   PublicIPAdd    | Status   |</span>
<span class="c">#    +----------------+-----------------+------------------+----------+</span>
<span class="c">#    |  myeks-ng1-Node|  192.168.2.92   |  43.203.143.233  |  running |</span>
<span class="c">#    |  myeks-ng1-Node|  192.168.3.235  |  15.164.95.12    |  running |</span>
<span class="c">#    |  myeks-bastion |  192.168.1.100  |  3.35.140.75     |  running |</span>
<span class="c">#    |  myeks-ng1-Node|  192.168.1.186  |  3.38.183.82     |  running |</span>
<span class="c">#    +----------------+-----------------+------------------+----------+</span>
<span class="nv">$ N1</span><span class="o">=</span><span class="si">$(</span>kubectl get node <span class="nt">--label-columns</span><span class="o">=</span>topology.kubernetes.io/zone <span class="nt">--selector</span><span class="o">=</span>topology.kubernetes.io/zone<span class="o">=</span>ap-northeast-2a <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[0].status.addresses[0].address<span class="o">}</span><span class="si">)</span>
<span class="nv">$ N2</span><span class="o">=</span><span class="si">$(</span>kubectl get node <span class="nt">--label-columns</span><span class="o">=</span>topology.kubernetes.io/zone <span class="nt">--selector</span><span class="o">=</span>topology.kubernetes.io/zone<span class="o">=</span>ap-northeast-2b <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[0].status.addresses[0].address<span class="o">}</span><span class="si">)</span>
<span class="nv">$ N3</span><span class="o">=</span><span class="si">$(</span>kubectl get node <span class="nt">--label-columns</span><span class="o">=</span>topology.kubernetes.io/zone <span class="nt">--selector</span><span class="o">=</span>topology.kubernetes.io/zone<span class="o">=</span>ap-northeast-2c <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[0].status.addresses[0].address<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export N1=</span><span class="nv">$N1</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export N2=</span><span class="nv">$N2</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export N3=</span><span class="nv">$N3</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$N1</span>, <span class="nv">$N2</span>, <span class="nv">$N3</span>
<span class="c"># =&gt; 192.168.1.186, 192.168.2.92, 192.168.3.235</span>

<span class="c"># ë³´ì•ˆê·¸ë£¹ IDì™€ ë³´ì•ˆê·¸ë£¹ ì´ë¦„(Nameì•„ë‹˜ì„ ì£¼ì˜!) í™•ì¸</span>
<span class="nv">$ </span>aws ec2 describe-security-groups <span class="nt">--query</span> <span class="s1">'SecurityGroups[*].[GroupId, GroupName]'</span> <span class="nt">--output</span> text
<span class="c"># =&gt; sg-07b8900660cb85dff default</span>
<span class="c">#    sg-0ece66fedd1fb4abe myeks-EKSEC2SG-1GNaTdbIbBNG</span>
<span class="c">#    sg-07663468a536ba88b eksctl-myeks-cluster-ControlPlaneSecurityGroup-S7dWa32uw1S7</span>
<span class="c">#    sg-0edc706b941f0aef7 eksctl-myeks-cluster-ClusterSharedNodeSecurityGroup-sO3DEJP4xewT</span>
<span class="c">#    sg-02c614a038ec1f7e7 eks-cluster-sg-myeks-104368993</span>
<span class="c">#    sg-036e220bf3d8aaf20 eksctl-myeks-nodegroup-ng1-remoteAccess</span>
<span class="c">#    sg-035e2b98b5ac89231 default</span>

<span class="c"># ë…¸ë“œ ë³´ì•ˆê·¸ë£¹ ID í™•ì¸</span>
<span class="nv">$ </span>aws ec2 describe-security-groups <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>group-name,Values<span class="o">=</span><span class="k">*</span>ng1<span class="k">*</span> <span class="nt">--query</span> <span class="s2">"SecurityGroups[*].[GroupId]"</span> <span class="nt">--output</span> text
<span class="c"># =&gt; sg-036e220bf3d8aaf20</span>
<span class="nv">$ NGSGID</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-security-groups <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>group-name,Values<span class="o">=</span><span class="k">*</span>ng1<span class="k">*</span> <span class="nt">--query</span> <span class="s2">"SecurityGroups[*].[GroupId]"</span> <span class="nt">--output</span> text<span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NGSGID</span>
<span class="c"># =&gt; sg-036e220bf3d8aaf20</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export NGSGID=</span><span class="nv">$NGSGID</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile

<span class="c"># ë…¸ë“œ ë³´ì•ˆê·¸ë£¹ì— eksctl-host ì—ì„œ ë…¸ë“œ(íŒŒë“œ)ì— ì ‘ì† ê°€ëŠ¥í•˜ê²Œ ë£°(Rule) ì¶”ê°€ ì„¤ì •</span>
<span class="nv">$ </span>aws ec2 authorize-security-group-ingress <span class="nt">--group-id</span> <span class="nv">$NGSGID</span> <span class="nt">--protocol</span> <span class="s1">'-1'</span> <span class="nt">--cidr</span> 192.168.1.100/32

<span class="c"># eksctl-host ì—ì„œ ë…¸ë“œì˜IPë‚˜ coredns íŒŒë“œIPë¡œ ping í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 <span class="nv">$N1</span>
<span class="c"># =&gt; PING 192.168.1.186 (192.168.1.186) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.1.186: icmp_seq=1 ttl=255 time=0.492 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.1.186 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.492/0.492/0.492/0.000 ms</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 <span class="nv">$N2</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 <span class="nv">$N3</span>

<span class="c"># ì›Œì»¤ ë…¸ë“œ SSH ì ‘ì† : '-i ~/.ssh/id_rsa' ìƒëµ ê°€ëŠ¥</span>
<span class="nv">$ </span><span class="k">for </span>node <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span>ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no ec2-user@<span class="nv">$node</span> <span class="nb">hostname</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N1</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N2</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N3</span>
<span class="nv">$ </span><span class="nb">exit</span>
</code></pre></div></div>

<ul>
  <li>Add-on ì •ë³´í™•ì¸ : ìµœì‹  ë²„ì „ - kube-proxy, coredns, aws vpc cni - ë§í¬ mgmt</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë“  íŒŒë“œì˜ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pods <span class="nt">--all-namespaces</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].spec.containers[*].image}"</span> | <span class="nb">tr</span> <span class="nt">-s</span> <span class="s1">'[[:space:]]'</span> <span class="s1">'\n'</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span>
<span class="c"># =&gt;       3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-network-policy-agent:v1.1.4-eksbuild.1</span>
<span class="c">#          3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon-k8s-cni:v1.18.6-eksbuild.1</span>
<span class="c">#          2 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/eks/coredns:v1.11.3-eksbuild.2</span>
<span class="c">#          3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/eks/kube-proxy:v1.30.5-minimal-eksbuild.2</span>
<span class="c"># ìœ„ ë²„ì „ì€ Add-on ìœ¼ë¡œ ìµœì‹  ë²„ì „ ì„¤ì¹˜</span>
<span class="nv">$ </span>kubectl get pods <span class="nt">-A</span>
<span class="nv">$ </span>kubectl get pods <span class="nt">--all-namespaces</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].spec.containers[*].image}"</span> | <span class="nb">tr</span> <span class="nt">-s</span> <span class="s1">'[[:space:]]'</span> <span class="s1">'\n'</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span>
<span class="c"># =&gt;       3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-network-policy-agent:v1.1.4-eksbuild.1</span>
<span class="c">#          3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon-k8s-cni:v1.18.6-eksbuild.1</span>
<span class="c">#          2 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/eks/coredns:v1.11.3-eksbuild.2</span>
<span class="c">#          3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/eks/kube-proxy:v1.30.5-minimal-eksbuild.2</span>

<span class="c"># eksctl ì„¤ì¹˜/ì—…ë°ì´íŠ¸ addon í™•ì¸</span>
<span class="nv">$ </span>eksctl get addon <span class="nt">--cluster</span> <span class="nv">$CLUSTER_NAME</span>
<span class="c"># =&gt; NAME        VERSION             STATUS  ISSUES      IAMROLE                                                                       UPDATE                AVAILABLE  CONFIGURATION  VALUES  POD      IDENTITY  ASSOCIATION  ROLES</span>
<span class="c">#    coredns     v1.11.3-eksbuild.2  ACTIVE  0</span>
<span class="c">#    kube-proxy  v1.30.5-eksbuild.2  ACTIVE  0</span>
<span class="c">#    vpc-cni     v1.18.6-eksbuild.1  ACTIVE  0           arn:aws:iam::123456789012:role/eksctl-myeks-addon-vpc-cni-Role1-QUy8qUBqFjcx  enableNetworkPolicy:  &amp;quot;true&amp;quot;</span>

<span class="c"># (ì°¸ê³ ) eks ì„¤ì¹˜ yaml ì¤‘ addon ë‚´ìš©</span>
<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-n11</span> myeks.yaml
<span class="c"># =&gt; addons:</span>
<span class="c">#      - name: vpc-cni # no version is specified so it deploys the default version</span>
<span class="c">#        version: latest # auto discovers the latest available</span>
<span class="c">#        attachPolicyARNs:</span>
<span class="c">#          - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy</span>
<span class="c">#        configurationValues: |-</span>
<span class="c">#          enableNetworkPolicy: &amp;quot;true&amp;quot;</span>
<span class="c">#      - name: kube-proxy</span>
<span class="c">#        version: latest</span>
<span class="c">#      - name: coredns</span>
<span class="c">#        version: latest</span>
</code></pre></div></div>

<hr />

<h3 id="ë…¸ë“œì—ì„œ-ê¸°ë³¸-ë„¤íŠ¸ì›Œí¬-ì •ë³´-í™•ì¸">ë…¸ë“œì—ì„œ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</h3>

<h4 id="ì›Œì»¤-ë…¸ë“œ-ê¸°ë³¸-ë„¤íŠ¸ì›Œí¬-êµ¬ì„±">ì›Œì»¤ ë…¸ë“œ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ êµ¬ì„±</h4>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_5.png" alt="img.png" class="image-center w-60" /></p>

<ul>
  <li>ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” í˜¸ìŠ¤íŠ¸(Root)ì™€ íŒŒë“œë³„(Per Pod)ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤.</li>
  <li>íŠ¹ì •í•œ íŒŒë“œ (kube-proxy, aws-node)ëŠ” í˜¸ìŠ¤íŠ¸ì˜ IPë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. =&gt; íŒŒë“œì˜ Host Network ì˜µì…˜ - <a href="https://xn--vj5b11biyw.kr/306">ì°¸ê³ </a></li>
  <li>t3.medium ì˜ ê²½ìš° ENI ë§ˆë‹¤ ìµœëŒ€ 6ê°œì˜ IPë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ENI ë‹¹ 5ê°œì˜ ë³´ì¡° IP)</li>
  <li>ENI0, ENI1 ìœ¼ë¡œ 2ê°œì˜ ENIëŠ” ìì‹ ì˜ IP ì´ì™¸ì— ì¶”ê°€ì ìœ¼ë¡œ 5ê°œì˜ ë³´ì¡° í”„ë¼ì´ë¹— IPë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>coredns íŒŒë“œëŠ” vethìœ¼ë¡œ í˜¸ìŠ¤íŠ¸ì—ëŠ” eniY@ifN ì¸í„°í˜ì´ìŠ¤ì™€ íŒŒë“œì— eth0ê³¼ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="ì‹¤ìŠµ-ë³´ì¡°-ipv4-ì£¼ì†Œë¥¼-íŒŒë“œê°€-ì‚¬ìš©í•˜ëŠ”ì§€-í™•ì¸">[ì‹¤ìŠµ] ë³´ì¡° IPv4 ì£¼ì†Œë¥¼ íŒŒë“œê°€ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># coredns íŒŒë“œ IP ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                       READY   STATUS    RESTARTS   AGE   IP             NODE                                               NOMINATED NODE   READINESS GATES</span>
<span class="c">#    coredns-699d8c5988-bvxtz   1/1     Running   0          18m   192.168.1.30   ip-192-168-1-186.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    coredns-699d8c5988-vt68k   1/1     Running   0          18m   192.168.3.82   ip-192-168-3-235.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># ë…¸ë“œì˜ ë¼ìš°íŒ… ì •ë³´ í™•ì¸ &gt;&gt; EC2 ë„¤íŠ¸ì›Œí¬ ì •ë³´ì˜ 'ë³´ì¡° í”„ë¼ì´ë¹— IPv4 ì£¼ì†Œ'ì™€ ë¹„êµí•´ë³´ì</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-c</span> route<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.1.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.186</span>
<span class="c">#    192.168.1.30 dev eni319ad74733c scope link</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.2.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.2.0/24 dev eth0 proto kernel scope link src 192.168.2.92</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.3.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.3.0/24 dev eth0 proto kernel scope link src 192.168.3.235</span>
<span class="c">#    192.168.3.82 dev enid438418b082 scope link</span>

<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë…¸ë“œì˜ IPì™€ íŒŒë“œì˜ IPê°€ ê°™ì€ ëŒ€ì—­ì„ì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    ì˜ˆë¥¼ ë“¤ì–´ì„œ ë…¸ë“œ IPê°€ 192.168.1.186ì¸ ê²½ìš° íŒŒë“œëŠ” 192.168.1.30ìœ¼ë¡œ&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    ë™ì¼í•œ IP ëŒ€ì—­ìœ¼ë¡œ, ë³´ì¡° IPv4ê°€ ì‚¬ìš©ë¨ì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h4 id="ì‹¤ìŠµ-í…ŒìŠ¤íŠ¸ìš©-íŒŒë“œ-ìƒì„±---nicolakanetshoot">[ì‹¤ìŠµ] í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ ìƒì„± - <a href="https://github.com/nicolaka/netshoot">nicolaka/netshoot</a></h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [í„°ë¯¸ë„1~3] ë…¸ë“œ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N1</span>
<span class="c"># =&gt; [ec2-user@ip-192-168-1-186 ~]$</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"ip link | egrep 'eth|eni' ;echo;echo "</span><span class="o">[</span>ROUTE TABLE]<span class="s2">"; route -n | grep eni"</span>
<span class="c"># =&gt; 2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc</span>
<span class="c">#     mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 02:35:26:fe:f6:2f brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    3: eni319ad74733c@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    mtu 9001 qdisc noqueue state UP mode DEFAULT group defaul</span>
<span class="c">#    t</span>
<span class="c">#        link/ether 16:69:60:63:cf:f7 brd ff:ff:ff:ff:ff:ff li</span>
<span class="c">#    nk-netns cni-a953612e-ef39-78ca-660c-2a1ecde16b39</span>
<span class="c">#    4: eth1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc</span>
<span class="c">#     mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 02:86:42:43:71:d1 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    </span>
<span class="c">#    [ROUTE TABLE]</span>
<span class="c">#    192.168.1.30    0.0.0.0         255.255.255.255 UH    0</span>
<span class="c">#        0        0 eni319ad74733c</span>

<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N2</span>
<span class="c"># =&gt; [ec2-user@ip-192-168-2-92 ~]$</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"ip link | egrep 'eth|eni' ;echo;echo "</span><span class="o">[</span>ROUTE TABLE]<span class="s2">"; route -n | grep eni"</span>
<span class="c"># =&gt; 2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc</span>
<span class="c">#     mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 06:bc:36:ed:7c:d3 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    </span>
<span class="c">#    [ROUTE TABLE]</span>

<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N3</span>
<span class="c"># =&gt; [ec2-user@ip-192-168-3-235 ~]$</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"ip link | egrep 'eth|eni' ;echo;echo "</span><span class="o">[</span>ROUTE TABLE]<span class="s2">"; route -n | grep eni"</span>
<span class="c"># =&gt; 2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc</span>
<span class="c">#     mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 0a:3e:a1:00:00:05 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    3: enid438418b082@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    mtu 9001 qdisc noqueue state UP mode DEFAULT group defaul</span>
<span class="c">#    t</span>
<span class="c">#        link/ether 02:50:3a:92:0e:1b brd ff:ff:ff:ff:ff:ff li</span>
<span class="c">#    nk-netns cni-23569158-d846-4981-4105-ec08005e9b95</span>
<span class="c">#    4: eth1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc</span>
<span class="c">#     mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 0a:e8:ac:41:8c:ab brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    </span>
<span class="c">#    [ROUTE TABLE]</span>
<span class="c">#    192.168.3.82    0.0.0.0         255.255.255.255 UH    0</span>
<span class="c">#        0        0 enid438418b082</span>

<span class="c"># í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ netshoot-pod ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netshoot-pod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: netshoot-pod
  template:
    metadata:
      labels:
        app: netshoot-pod
    spec:
      containers:
      - name: netshoot-pod
        image: nicolaka/netshoot
        command: ["tail"]
        args: ["-f", "/dev/null"]
      terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/netshoot-pod created</span>

<span class="c"># íŒŒë“œ ì´ë¦„ ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ PODNAME1</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[0].metadata.name<span class="o">}</span><span class="si">)</span>
<span class="nv">$ PODNAME2</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[1].metadata.name<span class="o">}</span><span class="si">)</span>
<span class="nv">$ PODNAME3</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[2].metadata.name<span class="o">}</span><span class="si">)</span>

<span class="c"># íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                            READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES</span>
<span class="c">#    netshoot-pod-74b7555dc7-6qsvf   1/1     Running   0          29s   192.168.1.112   ip-192-168-1-186.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    netshoot-pod-74b7555dc7-x6lxb   1/1     Running   0          29s   192.168.2.172   ip-192-168-2-92.ap-northeast-2.compute.internal    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    netshoot-pod-74b7555dc7-x7r96   1/1     Running   0          29s   192.168.3.246   ip-192-168-3-235.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span><span class="o">=</span>custom-columns<span class="o">=</span>NAME:.metadata.name,IP:.status.podIP
<span class="c"># =&gt; NAME                            IP</span>
<span class="c">#    netshoot-pod-74b7555dc7-6qsvf   192.168.1.112</span>
<span class="c">#    netshoot-pod-74b7555dc7-x6lxb   192.168.2.172</span>
<span class="c">#    netshoot-pod-74b7555dc7-x7r96   192.168.3.246</span>

<span class="c"># ë…¸ë“œì— ë¼ìš°íŒ… ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-c</span> route<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.1.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.186</span>
<span class="c">#    192.168.1.30 dev eni319ad74733c scope link</span>
<span class="c">#    192.168.1.112 dev eni7ecb7efa346 scope link  # &lt;span style="color: green;"&gt;ğŸ‘‰ ì¶”ê°€ëœ ì‹ ê·œ íŒŒë“œì˜ IPv4 ë³´ì¡° IP&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.2.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.2.0/24 dev eth0 proto kernel scope link src 192.168.2.92</span>
<span class="c">#    192.168.2.172 dev enif06a5cbfaaa scope link  # &lt;span style="color: green;"&gt;ğŸ‘‰ ì¶”ê°€ëœ ì‹ ê·œ íŒŒë“œì˜ IPv4 ë³´ì¡° IP&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.3.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.3.0/24 dev eth0 proto kernel scope link src 192.168.3.235</span>
<span class="c">#    192.168.3.82 dev enid438418b082 scope link</span>
<span class="c">#    192.168.3.246 dev eniea7f0ec96dd scope link  # &lt;span style="color: green;"&gt;ğŸ‘‰ ì¶”ê°€ëœ ì‹ ê·œ íŒŒë“œì˜ IPv4 ë³´ì¡° IP&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>íŒŒë“œê°€ ìƒì„±ë˜ë©´, ì›Œì»¤ ë…¸ë“œì— eniY@ifN ì¶”ê°€ë˜ê³  ë¼ìš°íŒ… í…Œì´ë¸”ì—ë„ ì •ë³´ê°€ ì¶”ê°€ëœê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ eniY ì •ë³´ í™•ì¸ - ì›Œì»¤ ë…¸ë“œ EC2</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë…¸ë“œ3ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N3</span>
<span class="nt">----------------</span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> addr show
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8 ::1/128</span>
<span class="c">#    eth0             UP             192.168.3.235/24 fe80::83e:a1ff:fe00:5/64</span>
<span class="c">#    enid438418b082@if3 UP             fe80::50:3aff:fe92:e1b/64</span>
<span class="c">#    eth1             UP             192.168.3.236/24 fe80::8e8:acff:fe41:8cab/64</span>
<span class="c">#    eniea7f0ec96dd@if3 UP             fe80::8cd8:57ff:fee7:29c/64</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span>
<span class="c"># =&gt; 1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
<span class="c">#    2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 0a:3e:a1:00:00:05 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    3: enid438418b082@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP mode DEFAULT group default</span>
<span class="c">#        link/ether 02:50:3a:92:0e:1b brd ff:ff:ff:ff:ff:ff link-netns cni-23569158-d846-4981-4105-ec08005e9b95</span>
<span class="c">#    4: eth1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 0a:e8:ac:41:8c:ab brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    5: eniea7f0ec96dd@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP mode DEFAULT group default</span>
<span class="c">#        link/ether 8e:d8:57:e7:02:9c brd ff:ff:ff:ff:ff:ff link-netns cni-508d7216-7484-4497-a023-c6236435d535</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc mq state UP group default qlen 1000</span>
<span class="c">#        link/ether 0a:3e:a1:00:00:05 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 192.168.3.235/24 brd 192.168.3.255 scope global dynamic eth0</span>
<span class="c">#           valid_lft 2166sec preferred_lft 2166sec</span>
<span class="c">#        inet6 fe80::83e:a1ff:fe00:5/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    3: enid438418b082@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP group default</span>
<span class="c">#        link/ether 02:50:3a:92:0e:1b brd ff:ff:ff:ff:ff:ff link-netns cni-23569158-d846-4981-4105-ec08005e9b95</span>
<span class="c">#        inet6 fe80::50:3aff:fe92:e1b/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    4: eth1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc mq state UP group default qlen 1000</span>
<span class="c">#        link/ether 0a:e8:ac:41:8c:ab brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 192.168.3.236/24 brd 192.168.3.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::8e8:acff:fe41:8cab/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    5: eniea7f0ec96dd@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP group default</span>
<span class="c">#        link/ether 8e:d8:57:e7:02:9c brd ff:ff:ff:ff:ff:ff link-netns cni-508d7216-7484-4497-a023-c6236435d535</span>
<span class="c">#        inet6 fe80::8cd8:57ff:fee7:29c/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>ip route <span class="c"># í˜¹ì€ route -n</span>
<span class="c"># =&gt; default via 192.168.3.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.3.0/24 dev eth0 proto kernel scope link src 192.168.3.235</span>
<span class="c">#    192.168.3.82 dev enid438418b082 scope link</span>
<span class="c">#    192.168.3.246 dev eniea7f0ec96dd scope link</span>
  
<span class="c"># ë§ˆì§€ë§‰ ìƒì„±ëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì •ë³´ ì¶œë ¥ -t net(ë„¤íŠ¸ì›Œí¬ íƒ€ì…)</span>
<span class="nv">$ </span><span class="nb">sudo </span>lsns <span class="nt">-o</span> PID,COMMAND <span class="nt">-t</span> net | <span class="nb">awk</span> <span class="s1">'NR&gt;2 {print $1}'</span> | <span class="nb">tail</span> <span class="nt">-n</span> 1
<span class="c"># =&gt; 9774</span>
  
<span class="c"># ë§ˆì§€ë§‰ ìƒì„±ëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ net PID ì •ë³´ ì¶œë ¥ -t net(ë„¤íŠ¸ì›Œí¬ íƒ€ì…)ë¥¼ ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ MyPID</span><span class="o">=</span><span class="si">$(</span><span class="nb">sudo </span>lsns <span class="nt">-o</span> PID,COMMAND <span class="nt">-t</span> net | <span class="nb">awk</span> <span class="s1">'NR&gt;2 {print $1}'</span> | <span class="nb">tail</span> <span class="nt">-n</span> 1<span class="si">)</span>
  
<span class="c"># PID ì •ë³´ë¡œ íŒŒë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> <span class="nv">$MyPID</span> <span class="nt">-n</span> ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    3: eth0@if5: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP group default</span>
<span class="c">#        link/ether 6a:d5:4d:a7:45:7e brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
<span class="c">#        inet 192.168.3.246/32 scope global eth0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::68d5:4dff:fea7:457e/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> <span class="nv">$MyPID</span> <span class="nt">-n</span> ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 169.254.1.1 dev eth0</span>
<span class="c">#    169.254.1.1 dev eth0 scope link</span>
  
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------</span>
</code></pre></div></div>

<ul>
  <li>í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ ì ‘ì†(exec) í›„ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ ì ‘ì†(exec) í›„ Shell ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> zsh
<span class="c"># =&gt;  netshoot-pod-74b7555dc7-6qsvf î‚° ~ î‚°</span>
  
<span class="c"># ì•„ë˜ë¶€í„°ëŠ” pod-1 Shell ì—ì„œ ì‹¤í–‰ : ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</span>
<span class="nt">----------------------------</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    3: eth0@if5: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP group default</span>
<span class="c">#        link/ether c6:cb:41:a0:85:57 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
<span class="c">#        inet 192.168.1.112/32 scope global eth0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::c4cb:41ff:fea0:8557/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 169.254.1.1 dev eth0</span>
<span class="c">#    169.254.1.1 dev eth0 scope link</span>
<span class="nv">$ </span>route <span class="nt">-n</span>
<span class="c"># =&gt; Kernel IP routing table</span>
<span class="c">#    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span>
<span class="c">#    0.0.0.0         169.254.1.1     0.0.0.0         UG    0      0        0 eth0</span>
<span class="c">#    169.254.1.1     0.0.0.0         255.255.255.255 UH    0      0        0 eth0</span>
<span class="c">#$ ping -c 1 &lt;pod-2 IP&gt;</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 192.168.2.172
<span class="c"># =&gt; PING 192.168.2.172 (192.168.2.172) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.2.172: icmp_seq=1 ttl=125 time=1.25 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.2.172 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.249/1.249/1.249/0.000 ms</span>
<span class="nv">$ </span>ps
<span class="c"># =&gt; PID   USER     TIME  COMMAND</span>
<span class="c">#        1 root      0:00 tail -f /dev/null</span>
<span class="c">#      109 root      0:00 zsh</span>
<span class="c">#      186 root      0:00 ps</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/resolv.conf
<span class="c"># =&gt; search default.svc.cluster.local svc.cluster.local cluster.local ap-northeast-2.compute.internal</span>
<span class="c">#    nameserver 10.100.0.10</span>
<span class="c">#    options ndots:5</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------</span>
  
<span class="c"># íŒŒë“œ2 Shell ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME2</span> <span class="nt">--</span> ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    3: eth0@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP group default</span>
<span class="c">#        link/ether 02:ea:11:63:f6:9f brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
<span class="c">#        inet 192.168.2.172/32 scope global eth0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::ea:11ff:fe63:f69f/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
  
<span class="c"># íŒŒë“œ3 Shell ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME3</span> <span class="nt">--</span> ip <span class="nt">-br</span> <span class="nt">-c</span> addr
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8 ::1/128</span>
<span class="c">#    eth0@if5         UP             192.168.3.246/32 fe80::68d5:4dff:fea7:457e/64</span>
</code></pre></div></div>

<hr />

<h3 id="ë…¸ë“œê°„-íŒŒë“œ-í†µì‹ ">ë…¸ë“œê°„ íŒŒë“œ í†µì‹ </h3>

<ul>
  <li><strong>íŒŒë“œê°„ í†µì‹  íë¦„</strong> : AWS VPC CNIì˜ ê²½ìš° ë³„ë„ì˜ ì˜¤ë²„ë ˆì´(Overlay) í†µì‹  ê¸°ìˆ ì—†ì´, VPCì—ì„œ Nativeí•˜ê²Œ íŒŒë“œê°„ ì§ì ‘ í†µì‹ ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_6.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>íŒŒë“œê°„ í†µì‹  ê³¼ì • ì°¸ê³ </li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_7.png" alt="img.png" class="image-center" />
<em class="image-caption"><a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md">https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md</a></em></p>

<h4 id="ì‹¤ìŠµ-íŒŒë“œê°„-í†µì‹ -í…ŒìŠ¤íŠ¸-ë°-í™•ì¸--ë³„ë„ì˜-nat-ë™ì‘-ì—†ì´-í†µì‹ -ê°€ëŠ¥">[ì‹¤ìŠµ] íŒŒë“œê°„ í†µì‹  í…ŒìŠ¤íŠ¸ ë° í™•ì¸ : ë³„ë„ì˜ NAT ë™ì‘ ì—†ì´ í†µì‹  ê°€ëŠ¥!</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë“œ IP ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ PODIP1</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[0].status.podIP<span class="o">}</span><span class="si">)</span>
<span class="nv">$ PODIP2</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[1].status.podIP<span class="o">}</span><span class="si">)</span>
<span class="nv">$ PODIP3</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[2].status.podIP<span class="o">}</span><span class="si">)</span>

<span class="c"># íŒŒë“œ1 Shell ì—ì„œ íŒŒë“œ2ë¡œ ping í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nv">$PODIP2</span>
<span class="c"># =&gt; PING 192.168.2.172 (192.168.2.172) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.2.172: icmp_seq=1 ttl=125 time=0.915 ms</span>
<span class="c">#    64 bytes from 192.168.2.172: icmp_seq=2 ttl=125 time=0.870 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.2.172 ping statistics ---</span>
<span class="c">#    2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.870/0.892/0.915/0.022 ms</span>

<span class="c"># íŒŒë“œ2 Shell ì—ì„œ íŒŒë“œ3ë¡œ ping í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME2</span> <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nv">$PODIP3</span>
<span class="c"># =&gt; PING 192.168.3.246 (192.168.3.246) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.3.246: icmp_seq=1 ttl=125 time=1.79 ms</span>
<span class="c">#    64 bytes from 192.168.3.246: icmp_seq=2 ttl=125 time=1.25 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.3.246 ping statistics ---</span>
<span class="c">#    2 packets transmitted, 2 received, 0% packet loss, time 1002ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.245/1.516/1.788/0.271 ms</span>

<span class="c"># íŒŒë“œ3 Shell ì—ì„œ íŒŒë“œ1ë¡œ ping í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME3</span> <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nv">$PODIP1</span>
<span class="c"># =&gt; PING 192.168.1.112 (192.168.1.112) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.1.112: icmp_seq=1 ttl=125 time=1.08 ms</span>
<span class="c">#    64 bytes from 192.168.1.112: icmp_seq=2 ttl=125 time=1.23 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.1.112 ping statistics ---</span>
<span class="c">#    2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.084/1.155/1.227/0.071 ms</span>

<span class="c"># ì›Œì»¤ ë…¸ë“œ EC2 : TCPDUMP í™•ì¸</span>
<span class="c">## For Pod to external (outside VPC) traffic, we will program iptables to SNAT using Primary IP address on the Primary ENI.</span>
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> any <span class="nt">-nn</span> icmp
<span class="c"># =&gt; 08:11:33.865634 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 1, length 64</span>
<span class="c">#    08:11:33.865684 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 1, length 64</span>
<span class="c">#    08:11:33.867117 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 1, length 64</span>
<span class="c">#    08:11:33.867195 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 1, length 64</span>
<span class="c">#    08:11:34.866610 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 2, length 64</span>
<span class="c">#    08:11:34.866654 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 2, length 64</span>
<span class="c">#    08:11:34.867865 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 2, length 64</span>
<span class="c">#    08:11:34.867891 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 2, length 64</span>
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> eth1 <span class="nt">-nn</span> icmp
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ìº¡ì³ëœ íŒ¨í‚·ì´ ì—†ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> icmp
<span class="c"># =&gt; 08:11:33.865689 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 1, length 64</span>
<span class="c">#    08:11:33.867117 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 1, length 64</span>
<span class="c">#    08:11:34.866654 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 2, length 64</span>
<span class="c">#    08:11:34.867865 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 2, length 64</span>
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> eniYYYYYYYY <span class="nt">-nn</span> icmp
<span class="c"># =&gt; 08:11:33.865643 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 1, length 64</span>
<span class="c">#    08:11:33.867195 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 1, length 64</span>
<span class="c">#    08:11:34.866610 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 2, length 64</span>
<span class="c">#    08:11:34.867891 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 2, length 64</span>

<span class="c"># [ì›Œì»¤ ë…¸ë“œ1]</span>
<span class="c"># routing policy database management í™•ì¸</span>
<span class="nv">$ </span>ip rule
<span class="c"># =&gt; 0: from all lookup local</span>
<span class="c">#    512: from all to 192.168.1.30 lookup main</span>
<span class="c">#    512: from all to 192.168.1.112 lookup main</span>
<span class="c">#    1024:  from all fwmark 0x80/0x80 lookup main</span>
<span class="c">#    32766: from all lookup main</span>
<span class="c">#    32767: from all lookup default</span>

<span class="c"># routing table management í™•ì¸</span>
<span class="nv">$ </span>ip route show table <span class="nb">local</span>
<span class="c"># =&gt; broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1</span>
<span class="c">#    local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1</span>
<span class="c">#    local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1</span>
<span class="c">#    broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1</span>
<span class="c">#    broadcast 192.168.1.0 dev eth0 proto kernel scope link src 192.168.1.186</span>
<span class="c">#    broadcast 192.168.1.0 dev eth1 proto kernel scope link src 192.168.1.9</span>
<span class="c">#    local 192.168.1.9 dev eth1 proto kernel scope host src 192.168.1.9</span>
<span class="c">#    local 192.168.1.186 dev eth0 proto kernel scope host src 192.168.1.186</span>
<span class="c">#    broadcast 192.168.1.255 dev eth0 proto kernel scope link src 192.168.1.186</span>
<span class="c">#    broadcast 192.168.1.255 dev eth1 proto kernel scope link src 192.168.1.9</span>

<span class="c"># ë””í´íŠ¸ ë„¤íŠ¸ì›Œí¬ ì •ë³´ë¥¼ eth0 ì„ í†µí•´ì„œ ë¹ ì ¸ë‚˜ê°„ë‹¤</span>
<span class="nv">$ </span>ip route show table main
<span class="c"># =&gt; default via 192.168.1.1 dev eth0</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<hr />

<h3 id="íŒŒë“œì—ì„œ-ì™¸ë¶€-í†µì‹ ">íŒŒë“œì—ì„œ ì™¸ë¶€ í†µì‹ </h3>

<ul>
  <li>íŒŒë“œì—ì„œ ì™¸ë¶€ í†µì‹  íë¦„ : iptable ì— SNAT ì„ í†µí•˜ì—¬ ë…¸ë“œì˜ eth0 IPë¡œ ë³€ê²½ë˜ì–´ì„œ ì™¸ë¶€ì™€ í†µì‹ í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_8.png" alt="img.png" class="image-center" />
<em class="image-caption"><a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md">https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md</a></em></p>

<ul>
  <li>VPC CNI ì˜ External source network address translation (<code class="language-plaintext highlighter-rouge">SNAT</code>) ì„¤ì •ì— ë”°ë¼, ì™¸ë¶€(ì¸í„°ë„·) í†µì‹  ì‹œ <strong>SNAT</strong> í•˜ê±°ë‚˜ í˜¹ì€ <strong>SNAT ì—†ì´</strong> í†µì‹ ì„ í•  ìˆ˜ ìˆë‹¤ - <a href="https://docs.aws.amazon.com/eks/latest/userguide/external-snat.html">ë§í¬</a></li>
</ul>

<h4 id="ì‹¤ìŠµ-íŒŒë“œì—ì„œ-ì™¸ë¶€-í†µì‹ -í…ŒìŠ¤íŠ¸-ë°-í™•ì¸"><strong>[ì‹¤ìŠµ] íŒŒë“œì—ì„œ ì™¸ë¶€ í†µì‹ </strong> í…ŒìŠ¤íŠ¸ ë° í™•ì¸</h4>

<ul>
  <li>íŒŒë“œ shell ì‹¤í–‰ í›„ ì™¸ë¶€ë¡œ ping í…ŒìŠ¤íŠ¸ &amp; ì›Œì»¤ ë…¸ë“œì—ì„œ tcpdump ë° iptables ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì‘ì—…ìš© EC2 : pod-1 Shell ì—ì„œ ì™¸ë¶€ë¡œ ping</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> ping <span class="nt">-c</span> 1 www.google.com
<span class="c"># =&gt; PING www.google.com (172.217.25.164) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from kix06s19-in-f4.1e100.net (172.217.25.164): icmp_seq=1 ttl=104 time=39.0 ms</span>
<span class="c">#    </span>
<span class="c">#    --- www.google.com ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 38.967/38.967/38.967/0.000 ms</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> ping <span class="nt">-i</span> 0.1 www.google.com
  
<span class="c"># ì›Œì»¤ ë…¸ë“œ EC2 : TCPDUMP í™•ì¸</span>
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> any <span class="nt">-nn</span> icmp
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> icmp
  
<span class="c"># ì‘ì—…ìš© EC2 : í¼ë¸”ë¦­IP í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> curl <span class="nt">-s</span> ipinfo.io/ip<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  
<span class="c"># ì‘ì—…ìš© EC2 : pod-1 Shell ì—ì„œ ì™¸ë¶€ ì ‘ì† í™•ì¸ - ê³µì¸IPëŠ” ì–´ë–¤ ì£¼ì†Œì¸ê°€?</span>
<span class="c">## The right way to check the weather - [ë§í¬](https://github.com/chubin/wttr.in)</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$PODNAME1</span> <span class="nv">$PODNAME2</span> <span class="nv">$PODNAME3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; Pod : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$i</span> <span class="nt">--</span> curl <span class="nt">-s</span> ipinfo.io/ip<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> curl <span class="nt">-s</span> wttr.in/seoul
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> curl <span class="nt">-s</span> wttr.in/seoul?format<span class="o">=</span>3
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> curl <span class="nt">-s</span> wttr.in/Moon
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> curl <span class="nt">-s</span> wttr.in/:help
  
<span class="c"># ì›Œì»¤ ë…¸ë“œ EC2</span>
<span class="nv">$ </span>ip rule
<span class="nv">$ </span>ip route show table main
<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-L</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-t</span> nat
<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
  
<span class="c"># íŒŒë“œê°€ ì™¸ë¶€ì™€ í†µì‹ ì‹œì—ëŠ” ì•„ë˜ ì²˜ëŸ¼ 'AWS-SNAT-CHAIN-0' ë£°(rule)ì— ì˜í•´ì„œ SNAT ë˜ì–´ì„œ ì™¸ë¶€ì™€ í†µì‹ !</span>
<span class="c"># ì°¸ê³ ë¡œ ë’¤ IPëŠ” eth0(ENI ì²«ë²ˆì§¸)ì˜ IP ì£¼ì†Œì…ë‹ˆë‹¤.</span>
<span class="c"># --random-fully ë™ì‘ - [ë§í¬1](https://ssup2.github.io/issue/Linux_TCP_SYN_Packet_Drop_SNAT_Port_Race_Condition/)  [ë§í¬2](https://ssup2.github.io/issue/Kubernetes_TCP_Connection_Delay_VXLAN_CNI_Plugin/)</span>
<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A AWS-SNAT-CHAIN'</span>
<span class="c"># =&gt; -A AWS-SNAT-CHAIN-0 -d 192.168.0.0/16 -m comment --comment &amp;quot;AWS SNAT CHAIN&amp;quot; -j RETURN</span>
<span class="c">#    -A AWS-SNAT-CHAIN-0 ! -o vlan+ -m comment --comment &amp;quot;AWS, SNAT&amp;quot; -m addrtype ! --dst-type LOCAL -j SNAT --to-source 192.168.2.92 --random-fully</span>
  
<span class="c">## ì•„ë˜ 'mark 0x4000/0x4000' ë§¤ì¹­ë˜ì§€ ì•Šì•„ì„œ RETURN ë¨!</span>
<span class="c"># =&gt; -A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN</span>
<span class="c">#    -A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0</span>
<span class="c">#    -A KUBE-POSTROUTING -m comment --comment &amp;quot;kubernetes service traffic requiring SNAT&amp;quot; -j MASQUERADE --random-fully</span>
<span class="c">#    ...</span>
  
<span class="c"># ì¹´ìš´íŠ¸ í™•ì¸ ì‹œ AWS-SNAT-CHAIN-0ì— ë§¤ì¹­ë˜ì–´, ëª©ì ì§€ê°€ 192.168.0.0/16 ì•„ë‹ˆê³  ì™¸ë¶€ ë¹ ì ¸ë‚˜ê°ˆë•Œ SNAT 192.168.1.251(EC2 ë…¸ë“œ1 IP) ë³€ê²½ë˜ì–´ ë‚˜ê°‘ë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> filter <span class="nt">--zero</span><span class="p">;</span> <span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">--zero</span><span class="p">;</span> <span class="nb">sudo </span>iptables <span class="nt">-t</span> mangle <span class="nt">--zero</span><span class="p">;</span> <span class="nb">sudo </span>iptables <span class="nt">-t</span> raw <span class="nt">--zero</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'sudo iptables -v --numeric --table nat --list AWS-SNAT-CHAIN-0; echo ; sudo iptables -v --numeric --table nat --list KUBE-POSTROUTING; echo ; sudo iptables -v --numeric --table nat --list POSTROUTING'</span>
<span class="c"># =&gt; Chain AWS-SNAT-CHAIN-0 (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination</span>
<span class="c">#       12  1106 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16  /* AWS SNAT CHAIN */</span>
<span class="c">#       31  1924 SNAT       all  --  *      !vlan+  0.0.0.0/0            0.0.0.0/0            /* AWS, SNAT */ ADDRTYPE match dst-type !LOCAL to:192.168.2.92 random-fully</span>
<span class="c">#    </span>
<span class="c">#    Chain KUBE-POSTROUTING (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination</span>
<span class="c">#       53  3630 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match ! 0x4000/0x4000</span>
<span class="c">#        0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            MARK xor 0x4000</span>
<span class="c">#        0     0 MASQUERADE  all  --  * * 0.0.0.0/0            0.0.0.0/0            /* kubernetes service traffic requiring SNAT */ random-fully</span>
<span class="c">#    </span>
<span class="c">#    Chain POSTROUTING (policy ACCEPT 22 packets, 1706 bytes)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination</span>
<span class="c">#       53  3630 KUBE-POSTROUTING  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */</span>
<span class="c">#       53  3630 AWS-SNAT-CHAIN-0  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* AWS SNAT CHAIN */</span>
  
<span class="c"># conntrack í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>conntrack <span class="nt">-L</span> <span class="nt">-n</span> |grep <span class="nt">-v</span> <span class="s1">'169.254.169'</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    udp      17 29 src=192.168.1.186 dst=146.56.40.151 sport=50772 dport=123 src=146.56.40.151 dst=192.168.1.186 sport=123 dport=47629 mark=128 use=1</span>
<span class="c">#    tcp      6 86395 ESTABLISHED src=192.168.1.186 dst=52.95.197.175 sport=45832 dport=443 src=52.95.197.175 dst=192.168.1.186 sport=443 dport=30346 [ASSURED] mark=128 use=1</span>
<span class="c">#    tcp      6 86395 ESTABLISHED src=192.168.1.186 dst=52.95.195.121 sport=48862 dport=443 src=52.95.195.121 dst=192.168.1.186 sport=443 dport=41664 [ASSURED] mark=128 use=1</span>
<span class="c">#    conntrack v1.4.4 (conntrack-tools): 59 flow entries have been shown.</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    conntrack v1.4.4 (conntrack-tools): 50 flow entries have been shown.</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    conntrack v1.4.4 (conntrack-tools): 51 flow entries have been shown.</span>
<span class="c">#    udp      17 23 src=192.168.3.235 dst=146.56.40.151 sport=51849 dport=123 src=146.56.40.151 dst=192.168.3.235 sport=123 dport=29777 mark=128 use=1</span>
</code></pre></div></div>

<ul>
  <li>ë‹¤ìŒ ì‹¤ìŠµì„ ìœ„í•´ì„œ íŒŒë“œ ì‚­ì œ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete deploy netshoot-pod
<span class="c"># =&gt; deployment.apps &amp;quot;netshoot-pod&amp;quot; deleted</span>
</code></pre></div></div>

<hr />

<h3 id="ë…¸ë“œì˜-íŒŒë“œ-ìƒì„±-ê°¯ìˆ˜-ì œí•œ">ë…¸ë“œì˜ íŒŒë“œ ìƒì„± ê°¯ìˆ˜ ì œí•œ</h3>

<h4 id="ì‚¬ì „-ì¤€ë¹„--kube-ops-view-ì„¤ì¹˜">ì‚¬ì „ ì¤€ë¹„ : kube-ops-view ì„¤ì¹˜</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kube-ops-view</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="c"># =&gt; &amp;quot;geek-cookbook&amp;quot; has been added to your repositories</span>
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>LoadBalancer <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system
<span class="c"># =&gt; NAME: kube-ops-view</span>
<span class="c">#    LAST DEPLOYED: Sat Oct  1 17:30:33 2024</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    1. Get the application URL by running these commands:</span>
<span class="c">#         NOTE: It may take a few minutes for the LoadBalancer IP to be available.</span>
<span class="c">#               You can watch the status of by running 'kubectl get svc -w kube-ops-view'</span>
<span class="c">#      export SERVICE_IP=$(kubectl get svc --namespace kube-system kube-ops-view -o jsonpath='{.status.loadBalancer.ingress[0].ip}')</span>
<span class="c">#      echo http://$SERVICE_IP:8080</span>

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 ë°°ìœ¨)</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> kube-system kube-ops-view <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span> | <span class="nb">awk</span> <span class="s1">'{ print "KUBE-OPS-VIEW URL = http://"$1":8080/#scale=1.5"}'</span>
<span class="c"># =&gt; KUBE-OPS-VIEW URL = http://ae19b387d6fee48239f44d3f9f121378-262130081.ap-northeast-2.elb.amazonaws.com:8080/#scale=1.5</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_29.png" alt="img.png" class="image-center" /></p>

<ul>
  <li><strong>Secondary IPv4 addresses</strong> (ê¸°ë³¸ê°’) : ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•ì— ìµœëŒ€ ENI ê°¯ìˆ˜ì™€ í• ë‹¹ ê°€ëŠ¥ IP ìˆ˜ë¥¼ ì¡°í•©í•˜ì—¬ ì„ ì •</li>
</ul>

<h4 id="ì›Œì»¤-ë…¸ë“œì˜-ì¸ìŠ¤í„´ìŠ¤-íƒ€ì…-ë³„-íŒŒë“œ-ìƒì„±-ê°¯ìˆ˜-ì œí•œ">ì›Œì»¤ ë…¸ë“œì˜ ì¸ìŠ¤í„´ìŠ¤ íƒ€ì… ë³„ íŒŒë“œ ìƒì„± ê°¯ìˆ˜ ì œí•œ</h4>

<ul>
  <li><strong>ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…</strong> ë³„ ENI ìµœëŒ€ ê°¯ìˆ˜ì™€ í• ë‹¹ ê°€ëŠ¥í•œ ìµœëŒ€ IP ê°¯ìˆ˜ì— ë”°ë¼ì„œ íŒŒë“œ ë°°ì¹˜ ê°¯ìˆ˜ê°€ ê²°ì •ë¨</li>
  <li>ë‹¨, aws-node ì™€ kube-proxy íŒŒë“œëŠ” í˜¸ìŠ¤íŠ¸ì˜ IPë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œ ìµœëŒ€ ê°¯ìˆ˜ì—ì„œ ì œì™¸í•¨</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_9.png" alt="img.png" class="image-center w-90" /></p>

<blockquote>
  <p>ğŸ‘‰ ìµœëŒ€ íŒŒë“œ ìƒì„± ê°¯ìˆ˜ : <code class="language-plaintext highlighter-rouge">(Number of network interfaces for the instance type Ã— (the number of IP addressess per network interface - 1)) + 2</code></p>
</blockquote>

<h4 id="ì›Œì»¤-ë…¸ë“œì˜-ì¸ìŠ¤í„´ìŠ¤-ì •ë³´-í™•ì¸--t3medium-ì‚¬ìš©-ì‹œ">ì›Œì»¤ ë…¸ë“œì˜ ì¸ìŠ¤í„´ìŠ¤ ì •ë³´ í™•ì¸ : t3.medium ì‚¬ìš© ì‹œ</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># t3 íƒ€ì…ì˜ ì •ë³´(í•„í„°) í™•ì¸</span>
<span class="nv">$ </span>aws ec2 describe-instance-types <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>instance-type,Values<span class="o">=</span>t3.<span class="k">*</span> <span class="se">\</span>
  <span class="nt">--query</span> <span class="s2">"InstanceTypes[].{Type: InstanceType, MaxENI: NetworkInfo.MaximumNetworkInterfaces, IPv4addr: NetworkInfo.Ipv4AddressesPerInterface}"</span> <span class="se">\</span>
  <span class="nt">--output</span> table
<span class="c"># =&gt; --------------------------------------</span>
<span class="c">#    |        DescribeInstanceTypes       |</span>
<span class="c">#    +----------+----------+--------------+</span>
<span class="c">#    | IPv4addr | MaxENI   |    Type      |</span>
<span class="c">#    +----------+----------+--------------+</span>
<span class="c">#    |  12      |  3       |  t3.large    |</span>
<span class="c">#    |  6       |  3       |  t3.medium   |</span>
<span class="c">#    |  15      |  4       |  t3.2xlarge  |</span>
<span class="c">#    |  15      |  4       |  t3.xlarge   |</span>
<span class="c">#    |  2       |  2       |  t3.micro    |</span>
<span class="c">#    |  2       |  2       |  t3.nano     |</span>
<span class="c">#    |  4       |  3       |  t3.small    |</span>
<span class="c">#    +----------+----------+--------------+</span>

<span class="c"># c5 íƒ€ì…ì˜ ì •ë³´(í•„í„°) í™•ì¸</span>
<span class="nv">$ </span>aws ec2 describe-instance-types <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>instance-type,Values<span class="o">=</span>c5<span class="k">*</span>.<span class="k">*</span> <span class="se">\</span>
  <span class="nt">--query</span> <span class="s2">"InstanceTypes[].{Type: InstanceType, MaxENI: NetworkInfo.MaximumNetworkInterfaces, IPv4addr: NetworkInfo.Ipv4AddressesPerInterface}"</span> <span class="se">\</span>
  <span class="nt">--output</span> table
<span class="c"># =&gt; ----------------------------------------</span>
<span class="c">#    |         DescribeInstanceTypes        |</span>
<span class="c">#    +----------+----------+----------------+</span>
<span class="c">#    | IPv4addr | MaxENI   |     Type       |</span>
<span class="c">#    +----------+----------+----------------+</span>
<span class="c">#    |  30      |  8       |  c5d.12xlarge  |</span>
<span class="c">#    |  10      |  3       |  c5d.large     |</span>
<span class="c">#    |  10      |  3       |  c5n.large     |</span>
<span class="c">#    |  15      |  4       |  c5n.2xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5.4xlarge    |</span>
<span class="c">#    |  15      |  4       |  c5a.xlarge    |</span>
<span class="c">#    |  30      |  8       |  c5a.4xlarge   |</span>
<span class="c">#    |  15      |  4       |  c5d.2xlarge   |</span>
<span class="c">#    |  50      |  15      |  c5d.24xlarge  |</span>
<span class="c">#    |  30      |  8       |  c5.12xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5n.9xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5a.12xlarge  |</span>
<span class="c">#    |  15      |  4       |  c5.xlarge     |</span>
<span class="c">#    |  30      |  8       |  c5n.4xlarge   |</span>
<span class="c">#    |  50      |  15      |  c5n.18xlarge  |</span>
<span class="c">#    |  50      |  15      |  c5.24xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5d.4xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5.9xlarge    |</span>
<span class="c">#    |  15      |  4       |  c5a.2xlarge   |</span>
<span class="c">#    |  50      |  15      |  c5.metal      |</span>
<span class="c">#    |  50      |  15      |  c5a.24xlarge  |</span>
<span class="c">#    |  50      |  15      |  c5d.18xlarge  |</span>
<span class="c">#    |  50      |  15      |  c5a.16xlarge  |</span>
<span class="c">#    |  30      |  8       |  c5a.8xlarge   |</span>
<span class="c">#    |  50      |  15      |  c5n.metal     |</span>
<span class="c">#    |  50      |  15      |  c5d.metal     |</span>
<span class="c">#    |  10      |  3       |  c5.large      |</span>
<span class="c">#    |  15      |  4       |  c5.2xlarge    |</span>
<span class="c">#    |  15      |  4       |  c5d.xlarge    |</span>
<span class="c">#    |  10      |  3       |  c5a.large     |</span>
<span class="c">#    |  50      |  15      |  c5.18xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5d.9xlarge   |</span>
<span class="c">#    |  15      |  4       |  c5n.xlarge    |</span>
<span class="c">#    +----------+----------+----------------+  </span>

<span class="c"># íŒŒë“œ ì‚¬ìš© ê°€ëŠ¥ ê³„ì‚° ì˜ˆì‹œ : aws-node ì™€ kube-proxy íŒŒë“œëŠ” host-networking ì‚¬ìš©ìœ¼ë¡œ IP 2ê°œ ë‚¨ìŒ</span>
<span class="c"># ((MaxENI * (IPv4addr-1)) + 2)</span>
<span class="c"># t3.medium ê²½ìš° : ((3 * (6 - 1) + 2 ) = 17ê°œ &gt;&gt; aws-node ì™€ kube-proxy 2ê°œ ì œì™¸í•˜ë©´ 15ê°œ</span>

<span class="c"># ì›Œì»¤ë…¸ë“œ ìƒì„¸ ì •ë³´ í™•ì¸ : ë…¸ë“œ ìƒì„¸ ì •ë³´ì˜ Allocatable ì— pods ì— 17ê°œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe node | <span class="nb">grep </span>Allocatable: <span class="nt">-A6</span>
<span class="c"># =&gt; Allocatable:</span>
<span class="c">#      cpu:                1930m</span>
<span class="c">#      ephemeral-storage:  27905944324</span>
<span class="c">#      hugepages-1Gi:      0</span>
<span class="c">#      hugepages-2Mi:      0</span>
<span class="c">#      memory:             3388304Ki</span>
<span class="c">#      pods:               17</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h4 id="ìµœëŒ€-íŒŒë“œ-ìƒì„±-ë°-í™•ì¸">ìµœëŒ€ íŒŒë“œ ìƒì„± ë° í™•ì¸</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì›Œì»¤ ë…¸ë“œ EC2 - ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>ip <span class="nt">-br</span> <span class="nt">-c</span> addr show <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">date</span> <span class="s2">"+%Y-%m-%d %H:%M:%S"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>

<span class="c"># ì‘ì—…ìš© EC2 - í„°ë¯¸ë„1</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pods -o wide'</span>

<span class="c"># ì‘ì—…ìš© EC2 - í„°ë¯¸ë„2</span>
<span class="c"># ë””í”Œë¡œì´ë¨¼íŠ¸ ìƒì„±</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-O</span> https://raw.githubusercontent.com/gasida/PKOS/main/2/nginx-dp.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> nginx-dp.yaml
<span class="c"># =&gt; deployment.apps/nginx-deployment created</span>

<span class="c"># íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span><span class="o">=</span>custom-columns<span class="o">=</span>NAME:.metadata.name,IP:.status.podIP
<span class="c"># =&gt; NAME                                IP</span>
<span class="c">#    nginx-deployment-6f999cfffb-44rw7   192.168.1.230</span>
<span class="c">#    nginx-deployment-6f999cfffb-xk4nh   192.168.3.246</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-brief</span> addr | <span class="nb">wc</span> <span class="nt">-l</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    5</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    4</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    5</span>

<span class="c"># íŒŒë“œ ì¦ê°€ í…ŒìŠ¤íŠ¸ &gt;&gt; íŒŒë“œ ì •ìƒ ìƒì„± í™•ì¸, ì›Œì»¤ ë…¸ë“œì—ì„œ eth, eni ê°¯ìˆ˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl scale deployment nginx-deployment <span class="nt">--replicas</span><span class="o">=</span>8
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-brief</span> addr | <span class="nb">wc</span> <span class="nt">-l</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    7</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    6</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    7</span>

<span class="c"># íŒŒë“œ ì¦ê°€ í…ŒìŠ¤íŠ¸ &gt;&gt; íŒŒë“œ ì •ìƒ ìƒì„± í™•ì¸, ì›Œì»¤ ë…¸ë“œì—ì„œ eth, eni ê°¯ìˆ˜ í™•ì¸ &gt;&gt; ì–´ë–¤ì¼ì´ ë²Œì–´ì¡ŒëŠ”ê°€?</span>
<span class="nv">$ </span>kubectl scale deployment nginx-deployment <span class="nt">--replicas</span><span class="o">=</span>15
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-brief</span> addr | <span class="nb">wc</span> <span class="nt">-l</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    9</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    9</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    10</span>

<span class="c"># íŒŒë“œ ì¦ê°€ í…ŒìŠ¤íŠ¸ &gt;&gt; íŒŒë“œ ì •ìƒ ìƒì„± í™•ì¸, ì›Œì»¤ ë…¸ë“œì—ì„œ eth, eni ê°¯ìˆ˜ í™•ì¸ &gt;&gt; ì–´ë–¤ì¼ì´ ë²Œì–´ì¡ŒëŠ”ê°€?</span>
<span class="nv">$ </span>kubectl scale deployment nginx-deployment <span class="nt">--replicas</span><span class="o">=</span>30
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-brief</span> addr | <span class="nb">wc</span> <span class="nt">-l</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    15</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    15</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    15</span>

<span class="c"># íŒŒë“œ ì¦ê°€ í…ŒìŠ¤íŠ¸ &gt;&gt; íŒŒë“œ ì •ìƒ ìƒì„± í™•ì¸, ì›Œì»¤ ë…¸ë“œì—ì„œ eth, eni ê°¯ìˆ˜ í™•ì¸ &gt;&gt; ì–´ë–¤ì¼ì´ ë²Œì–´ì¡ŒëŠ”ê°€?</span>
<span class="nv">$ </span>kubectl scale deployment nginx-deployment <span class="nt">--replicas</span><span class="o">=</span>50
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-brief</span> addr | <span class="nb">wc</span> <span class="nt">-l</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    19</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    19</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    19</span>

<span class="c"># íŒŒë“œ ìƒì„± ì‹¤íŒ¨!</span>
<span class="nv">$ </span>kubectl get pods | <span class="nb">grep </span>Pending
<span class="c"># =&gt; nginx-deployment-6f999cfffb-59cj6   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-5z5qg   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-6gk4m   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-bhzc8   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-hlns8   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-n64nc   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-w8x7g   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-zb2pk   0/1     Pending   0          69s</span>

<span class="c">#$ kubectl describe pod &lt;Pending íŒŒë“œ&gt; | grep Events: -A5</span>
<span class="nv">$ </span>kubectl describe pod nginx-deployment-6f999cfffb-59cj6 | <span class="nb">grep </span>Events: <span class="nt">-A5</span>
<span class="c"># =&gt; Events:</span>
<span class="c">#      Type     Reason            Age   From               Message</span>
<span class="c">#      ----     ------            ----  ----               -------</span>
<span class="c">#      Warning  FailedScheduling  101s  default-scheduler  0/3 nodes are available: 3 Too many pods. preemption: 0/3 nodes are available: 3 No preemption victims found for incoming pod.</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_30.png" alt="img.png" class="image-center" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë””í”Œë¡œì´ë¨¼íŠ¸ ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete deploy nginx-deployment
<span class="c"># =&gt; deployment.apps &amp;quot;nginx-deployment&amp;quot; deleted</span>
</code></pre></div></div>

<ul>
  <li>ğŸ‘‰ í•´ê²° ë°©ì•ˆ : IPv4 Prefix Delegation, WARM &amp; MIN IP/Prefix Targets, Custom Network</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_10.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">IPv4 Prefix Delegationì„ í†µí•œ IP ê°¯ìˆ˜ ì œí•œ í•´ì†Œ</em></p>

<hr />

<h3 id="service--aws-loadbalancer-controller">Service &amp; AWS LoadBalancer Controller</h3>

<h4 id="ì„œë¹„ìŠ¤-ì¢…ë¥˜">ì„œë¹„ìŠ¤ ì¢…ë¥˜</h4>

<ul>
  <li>ClusterIP íƒ€ì…</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_16.png" alt="img.png" class="image-center w-90" /></p>

<ul>
  <li>NodePort íƒ€ì…</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_17.png" alt="img_1.png" class="image-center w-90" /></p>

<ul>
  <li>LoadBalancer íƒ€ì… (ê¸°ë³¸ ëª¨ë“œ) : NLB ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_18.png" alt="img_2.png" class="image-center w-90" /></p>

<ul>
  <li>Service (LoadBalancer Controller) : AWS Load Balancer Controller + NLB IP ëª¨ë“œ ë™ì‘ with AWS VPC CNI</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_19.png" alt="img_3.png" class="image-center w-90" /></p>

<h4 id="nlb-ëª¨ë“œ-ì „ì²´-ì •ë¦¬">NLB ëª¨ë“œ ì „ì²´ ì •ë¦¬</h4>

<h5 id="instance-mode">Instance mode</h5>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_20.png" alt="img_4.png" class="image-center w-90" />
<em class="image-caption"><a href="https://aws.amazon.com/blogs/networking-and-content-delivery/deploying-aws-load-balancer-controller-on-amazon-eks/">https://aws.amazon.com/blogs/networking-and-content-delivery/deploying-aws-load-balancer-controller-on-amazon-eks/</a></em></p>

<ul>
  <li><strong>externalTrafficPolicy</strong>ì— ë”°ë¥¸ ë™ì‘ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">externalTrafficPolicy: ClusterIP</code> : 2ë²ˆ ë¶„ì‚° ë° SNATìœ¼ë¡œ Client IP í™•ì¸ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. &lt;- LoadBalancer íƒ€ì… (ê¸°ë³¸ ëª¨ë“œ) ë™ì‘</li>
      <li><code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> : 1ë²ˆ ë¶„ì‚° ë° ClientIPê°€ ìœ ì§€ë˜ê³ , ì›Œì»¤ ë…¸ë“œì˜ iptablesì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        <ul>
          <li>
            <p><strong>í†µì‹  íë¦„</strong> : ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ê°€ â€˜ë¡œë“œë°¸ëŸ°ì„œâ€™ ì ‘ì† ì‹œ ë¶€í•˜ë¶„ì‚° ë˜ì–´ ë…¸ë“œ ë„ë‹¬ í›„ iptables ë£°ë¡œ ëª©ì ì§€ íŒŒë“œì™€ í†µì‹ ë©ë‹ˆë‹¤.</p>

            <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_21.png" alt="img_5.png" class="image-center w-90" />
<em class="image-caption"><code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code>ì¼ë•Œì˜ í†µì‹ íë¦„ì˜ ì˜ˆ</em></p>

            <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_22.png" alt="img_6.png" class="image-center w-90" /></p>

            <ul>
              <li>ë…¸ë“œëŠ” ì™¸ë¶€ì— ê³µê°œë˜ì§€ ì•Šê³  ë¡œë“œë°¸ëŸ°ì„œë§Œ ì™¸ë¶€ì— ê³µê°œë˜ë©°, ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ëŠ” ë¡œë“œë°¸ëœì„œì— ì ‘ì†ì„ í•  ë¿ ë‚´ë¶€ ë…¸ë“œì˜ ì •ë³´ë¥¼ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
              <li>ë¡œë“œë°¸ëŸ°ì„œê°€ ë¶€í•˜ë¶„ì‚°í•˜ì—¬ íŒŒë“œê°€ ì¡´ì¬í•˜ëŠ” ë…¸ë“œë“¤ì—ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤. iptables ë£°ì—ì„œëŠ” ìì‹ ì˜ ë…¸ë“œì— ìˆëŠ” íŒŒë“œë§Œ ì—°ê²°í•©ë‹ˆë‹¤. (<code class="language-plaintext highlighter-rouge">externalTrafficPolicy: local</code>)</li>
              <li>DNATê°€ 2ë²ˆ ë™ì‘í•©ë‹ˆë‹¤. (1) ë¡œë“œë°¸ëŸ°ì„œ ì ‘ì† í›„ ë¹ ì ¸ ë‚˜ê°ˆë•Œ, (2) ë…¸ë“œì˜ iptables ë£°ì—ì„œ íŒŒë“œIP ì „ë‹¬ ì‹œ</li>
              <li>ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ì˜ IPê°€ ë³´ì¡´ë©ë‹ˆë‹¤. AWS NLB ëŠ” <strong>íƒ€ì¼“</strong>ì´ <strong>ì¸ìŠ¤í„´ìŠ¤</strong>ì¼ ê²½ìš° í´ë¼ì´ì–¸íŠ¸ IPë¥¼ ìœ ì§€, iptables ë£° ê²½ìš°ë„ <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: local</code> ë¡œ í´ë¼ì´ì–¸íŠ¸ IPë¥¼ ë³´ì¡´í•©ë‹ˆë‹¤.</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ë¶€í•˜ë¶„ì‚° ìµœì í™”</strong> : ë…¸ë“œì— íŒŒë“œê°€ ì—†ì„ ê²½ìš° â€˜ë¡œë“œë°¸ëŸ°ì„œâ€™ì—ì„œ ë…¸ë“œì— í—¬ìŠ¤ ì²´í¬(ìƒíƒœ ê²€ì‚¬)ê°€ ì‹¤íŒ¨í•˜ì—¬ í•´ë‹¹ ë…¸ë“œë¡œëŠ” ì™¸ë¶€ ìš”ì²­ íŠ¸ë˜í”½ì„ ì „ë‹¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_23.png" alt="img_7.png" class="image-center w-90" />
<img src="/assets/2024/kans-3th/w9/20241102_kans_w9_26.png" alt="img.png" /></p>

    <p>ìœ„ì˜ ì´ë¯¸ì§€ ì²˜ëŸ¼ 3ë²ˆì§¸ ì¸ìŠ¤í„´ìŠ¤(Node3)ì€ ìƒíƒœ í™•ì¸ì´ ì‹¤íŒ¨í•œ ê²½ìš°, í•´ë‹¹ ë…¸ë“œë¡œëŠ” ì™¸ë¶€ ìš”ì²­ íŠ¸ë˜í”½ ì „ë‹¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<h5 id="ip-mode">IP mode</h5>

<ul>
  <li>
    <p>IP ëª¨ë“œëŠ” ë°˜ë“œì‹œ AWS LoadBalancer ì»¨íŠ¸ë¡¤ëŸ¬ íŒŒë“œ ë° ì •ì±… ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>

    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_24.png" alt="img_8.png" class="image-center w-90" />
<em class="image-caption"><a href="https://aws.amazon.com/blogs/networking-and-content-delivery/deploying-aws-load-balancer-controller-on-amazon-eks/">https://aws.amazon.com/blogs/networking-and-content-delivery/deploying-aws-load-balancer-controller-on-amazon-eks/</a></em></p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">Proxy Protocol v2 ë¹„í™œì„±í™”</code> â‡’ NLBì—ì„œ ë°”ë¡œ íŒŒë“œë¡œ ì¸ì…ë˜ë©°, ë‹¨ ClientIPê°€ NLBë¡œ SNAT ë˜ì–´ Client IP í™•ì¸ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">Proxy Protocol v2 í™œì„±í™”</code> â‡’ NLBì—ì„œ ë°”ë¡œ íŒŒë“œë¡œ ì¸ì… ë° ClientIP í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¨, PPv2ë¥¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¸ì§€í•  ìˆ˜ ìˆê²Œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>
    <p><strong>AWS LoadBalancer Controller ë°°í¬</strong> - <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/deploy/installation/"><strong>Link</strong></a></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Helm Chart ì„¤ì¹˜</span>
<span class="nv">$ </span>helm repo add eks https://aws.github.io/eks-charts
<span class="c"># =&gt; &amp;quot;eks&amp;quot; has been added to your repositories</span>
<span class="nv">$ </span>helm repo update
<span class="c"># =&gt; Hang tight while we grab the latest from your chart repositories...</span>
<span class="c">#    ...Successfully got an update from the &amp;quot;eks&amp;quot; chart repository</span>
<span class="c">#    ...Successfully got an update from the &amp;quot;geek-cookbook&amp;quot; chart repository</span>
<span class="c">#    Update Complete. âˆHappy Helming!âˆ</span>
<span class="nv">$ </span>helm <span class="nb">install </span>aws-load-balancer-controller eks/aws-load-balancer-controller <span class="nt">-n</span> kube-system <span class="nt">--set</span> <span class="nv">clusterName</span><span class="o">=</span><span class="nv">$CLUSTER_NAME</span>
<span class="c"># =&gt; NAME: aws-load-balancer-controller</span>
<span class="c">#    LAST DEPLOYED: Sat Oct  1 17:45:09 2024</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    AWS Load Balancer controller installed!</span>
  
<span class="c">## ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl get crd
<span class="c"># =&gt; NAME                                         CREATED AT</span>
<span class="c">#    ...</span>
<span class="c">#    ingressclassparams.elbv2.k8s.aws             2024-10-01T08:45:08Z</span>
<span class="c">#    ...</span>
<span class="c">#    targetgroupbindings.elbv2.k8s.aws            2024-10-01T08:45:08Z</span>
<span class="nv">$ </span>kubectl get deployment <span class="nt">-n</span> kube-system aws-load-balancer-controller
<span class="c"># =&gt; NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    aws-load-balancer-controller   2/2     2            2           58s</span>
<span class="nv">$ </span>kubectl describe deploy <span class="nt">-n</span> kube-system aws-load-balancer-controller
<span class="nv">$ </span>kubectl describe deploy <span class="nt">-n</span> kube-system aws-load-balancer-controller | <span class="nb">grep</span> <span class="s1">'Service Account'</span>
<span class="c"># =&gt;   Service Account:  aws-load-balancer-controller</span>
  
<span class="c"># í´ëŸ¬ìŠ¤í„°ë¡¤, ë¡¤ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe clusterrolebindings.rbac.authorization.k8s.io aws-load-balancer-controller-rolebinding
<span class="nv">$ </span>kubectl describe clusterroles.rbac.authorization.k8s.io aws-load-balancer-controller-role
<span class="c"># =&gt; ...</span>
<span class="c">#    PolicyRule:</span>
<span class="c">#      Resources                                     Non-Resource URLs  Resource Names  Verbs</span>
<span class="c">#      ---------                                     -----------------  --------------  -----</span>
<span class="c">#      targetgroupbindings.elbv2.k8s.aws             []                 []              [create delete get list patch update watch]</span>
<span class="c">#      events                                        []                 []              [create patch]</span>
<span class="c">#      configmaps                                    []                 []              [get delete create update]</span>
<span class="c">#      ingresses                                     []                 []              [get list patch update watch]</span>
<span class="c">#      services                                      []                 []              [get list patch update watch]</span>
<span class="c">#      ingresses.extensions                          []                 []              [get list patch update watch]</span>
<span class="c">#      services.extensions                           []                 []              [get list patch update watch]</span>
<span class="c">#      ingresses.networking.k8s.io                   []                 []              [get list patch update watch]</span>
<span class="c">#      services.networking.k8s.io                    []                 []              [get list patch update watch]</span>
<span class="c">#      endpoints                                     []                 []              [get list watch]</span>
<span class="c">#      namespaces                                    []                 []              [get list watch]</span>
<span class="c">#      nodes                                         []                 []              [get list watch]</span>
<span class="c">#      pods                                          []                 []              [get list watch]</span>
<span class="c">#      endpointslices.discovery.k8s.io               []                 []              [get list watch]</span>
<span class="c">#      ingressclassparams.elbv2.k8s.aws              []                 []              [get list watch]</span>
<span class="c">#      ingressclasses.networking.k8s.io              []                 []              [get list watch]</span>
<span class="c">#      ingresses/status                              []                 []              [update patch]</span>
<span class="c">#      pods/status                                   []                 []              [update patch]</span>
<span class="c">#      services/status                               []                 []              [update patch]</span>
<span class="c">#      targetgroupbindings/status                    []                 []              [update patch]</span>
<span class="c">#      ingresses.elbv2.k8s.aws/status                []                 []              [update patch]</span>
<span class="c">#      pods.elbv2.k8s.aws/status                     []                 []              [update patch]</span>
<span class="c">#      services.elbv2.k8s.aws/status                 []                 []              [update patch]</span>
<span class="c">#      targetgroupbindings.elbv2.k8s.aws/status      []                 []              [update patch]</span>
<span class="c">#      ingresses.extensions/status                   []                 []              [update patch]</span>
<span class="c">#      pods.extensions/status                        []                 []              [update patch]</span>
<span class="c">#      services.extensions/status                    []                 []              [update patch]</span>
<span class="c">#      targetgroupbindings.extensions/status         []                 []              [update patch]</span>
<span class="c">#      ingresses.networking.k8s.io/status            []                 []              [update patch]</span>
<span class="c">#      pods.networking.k8s.io/status                 []                 []              [update patch]</span>
<span class="c">#      services.networking.k8s.io/status             []                 []              [update patch]</span>
<span class="c">#      targetgroupbindings.networking.k8s.io/status  []                 []              [update patch]</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ì„œë¹„ìŠ¤/íŒŒë“œ ë°°í¬ í…ŒìŠ¤íŠ¸ with NLB - <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/service/nlb/">ë§í¬</a> <a href="https://docs.aws.amazon.com/eks/latest/userguide/network-load-balancing.html">NLB</a></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod,svc,ep
  
<span class="c"># ì‘ì—…ìš© EC2 - ë””í”Œë¡œì´ë¨¼íŠ¸ &amp; ì„œë¹„ìŠ¤ ìƒì„±</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-O</span> https://raw.githubusercontent.com/gasida/PKOS/main/2/echo-service-nlb.yaml
<span class="nv">$ </span><span class="nb">cat </span>echo-service-nlb.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> echo-service-nlb.yaml
<span class="c"># =&gt; deployment.apps/deploy-echo created</span>
<span class="c">#    service/svc-nlb-ip-type created</span>
  
<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,pod
<span class="c"># =&gt; NAME                          READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/deploy-echo   2/2     2            2           10s</span>
<span class="c">#    </span>
<span class="c">#    NAME                               READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/deploy-echo-857b6cfb88-452cd   1/1     Running   0          10s</span>
<span class="c">#    pod/deploy-echo-857b6cfb88-5xz5j   1/1     Running   0          10s</span>
<span class="nv">$ </span>kubectl get svc,ep,ingressclassparams,targetgroupbindings
<span class="c"># =&gt; NAME                      TYPE           CLUSTER-IP      EXTERNAL-IP                                                                         PORT(S)        AGE</span>
<span class="c">#    service/kubernetes        ClusterIP      10.100.0.1      &amp;lt;none&amp;gt;                                                                              443/TCP        76m</span>
<span class="c">#    service/svc-nlb-ip-type   LoadBalancer   10.100.83.184   k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com   80:30771/TCP   21s</span>
<span class="c">#    </span>
<span class="c">#    NAME                        ENDPOINTS                              AGE</span>
<span class="c">#    endpoints/kubernetes        192.168.1.65:443,192.168.3.189:443     76m</span>
<span class="c">#    endpoints/svc-nlb-ip-type   192.168.1.112:8080,192.168.2.24:8080   21s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                   GROUP-NAME   SCHEME   IP-ADDRESS-TYPE   AGE</span>
<span class="c">#    ingressclassparams.elbv2.k8s.aws/alb                                           3m9s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                               SERVICE-NAME      SERVICE-PORT   TARGET-TYPE   AGE</span>
<span class="c">#    targetgroupbinding.elbv2.k8s.aws/k8s-default-svcnlbip-f58255c318   svc-nlb-ip-type   80             ip            16s</span>
<span class="nv">$ </span>kubectl get targetgroupbindings <span class="nt">-o</span> json | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;apiVersion&amp;quot;: &amp;quot;v1&amp;quot;,</span>
<span class="c">#      &amp;quot;items&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;apiVersion&amp;quot;: &amp;quot;elbv2.k8s.aws/v1beta1&amp;quot;,</span>
<span class="c">#          &amp;quot;kind&amp;quot;: &amp;quot;TargetGroupBinding&amp;quot;,</span>
<span class="c">#          &amp;quot;metadata&amp;quot;: {</span>
<span class="c">#            &amp;quot;annotations&amp;quot;: {</span>
<span class="c">#              &amp;quot;elbv2.k8s.aws/checkpoint&amp;quot;: &amp;quot;gs98wrXMlQMdFGryEbrFbVngcODAXK0Yk4czpOdn9bg/biShKK1OQPD05qA040YQHH29qU6aPNq6J-fRu4M-dKY&amp;quot;,</span>
<span class="c">#              &amp;quot;elbv2.k8s.aws/checkpoint-timestamp&amp;quot;: &amp;quot;1730537287&amp;quot;</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;creationTimestamp&amp;quot;: &amp;quot;2024-10-01T08:48:04Z&amp;quot;,</span>
<span class="c">#            &amp;quot;finalizers&amp;quot;: [</span>
<span class="c">#              &amp;quot;elbv2.k8s.aws/resources&amp;quot;</span>
<span class="c">#            ],</span>
<span class="c">#            &amp;quot;generation&amp;quot;: 1,</span>
<span class="c">#            &amp;quot;labels&amp;quot;: {</span>
<span class="c">#              &amp;quot;service.k8s.aws/stack-name&amp;quot;: &amp;quot;svc-nlb-ip-type&amp;quot;,</span>
<span class="c">#              &amp;quot;service.k8s.aws/stack-namespace&amp;quot;: &amp;quot;default&amp;quot;</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;name&amp;quot;: &amp;quot;k8s-default-svcnlbip-f58255c318&amp;quot;,</span>
<span class="c">#            &amp;quot;namespace&amp;quot;: &amp;quot;default&amp;quot;,</span>
<span class="c">#            &amp;quot;resourceVersion&amp;quot;: &amp;quot;17369&amp;quot;,</span>
<span class="c">#            &amp;quot;uid&amp;quot;: &amp;quot;bdf37bcf-7fab-47ad-8b73-fb97c0239c9a&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;spec&amp;quot;: {</span>
<span class="c">#            &amp;quot;ipAddressType&amp;quot;: &amp;quot;ipv4&amp;quot;,</span>
<span class="c">#            &amp;quot;networking&amp;quot;: {</span>
<span class="c">#              &amp;quot;ingress&amp;quot;: [</span>
<span class="c">#                {</span>
<span class="c">#                  &amp;quot;from&amp;quot;: [</span>
<span class="c">#                    {</span>
<span class="c">#                      &amp;quot;securityGroup&amp;quot;: {</span>
<span class="c">#                        &amp;quot;groupID&amp;quot;: &amp;quot;sg-0a7a0dcdcda95c9fc&amp;quot;</span>
<span class="c">#                      }</span>
<span class="c">#                    }</span>
<span class="c">#                  ],</span>
<span class="c">#                  &amp;quot;ports&amp;quot;: [</span>
<span class="c">#                    {</span>
<span class="c">#                      &amp;quot;port&amp;quot;: 8080,</span>
<span class="c">#                      &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;</span>
<span class="c">#                    }</span>
<span class="c">#                  ]</span>
<span class="c">#                }</span>
<span class="c">#              ]</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;serviceRef&amp;quot;: {</span>
<span class="c">#              &amp;quot;name&amp;quot;: &amp;quot;svc-nlb-ip-type&amp;quot;,</span>
<span class="c">#              &amp;quot;port&amp;quot;: 80</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;targetGroupARN&amp;quot;: &amp;quot;arn:aws:elasticloadbalancing:ap-northeast-2:123456789012:targetgroup/k8s-default-svcnlbip-f58255c318/0cfa12d6c579f11b&amp;quot;,</span>
<span class="c">#            &amp;quot;targetType&amp;quot;: &amp;quot;ip&amp;quot;,</span>
<span class="c">#            &amp;quot;vpcID&amp;quot;: &amp;quot;vpc-0837921f515624150&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;status&amp;quot;: {</span>
<span class="c">#            &amp;quot;observedGeneration&amp;quot;: 1</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      ],</span>
<span class="c">#      &amp;quot;kind&amp;quot;: &amp;quot;List&amp;quot;,</span>
<span class="c">#      &amp;quot;metadata&amp;quot;: {</span>
<span class="c">#        &amp;quot;resourceVersion&amp;quot;: &amp;quot;&amp;quot;</span>
<span class="c">#      }</span>
<span class="c">#    }</span>
  
<span class="c"># (ì˜µì…˜) ë¹ ë¥¸ ì‹¤ìŠµì„ ìœ„í•´ì„œ ë“±ë¡ ì·¨ì†Œ ì§€ì—°(ë“œë ˆì´ë‹ ê°„ê²©) ìˆ˜ì • : ê¸°ë³¸ê°’ 300ì´ˆ</span>
<span class="nv">$ </span>vi echo-service-nlb.yaml
<span class="nt">---</span>
..
apiVersion: v1
kind: Service
metadata:
  name: svc-nlb-ip-type
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: <span class="s2">"8080"</span>
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: <span class="s2">"true"</span>
    service.beta.kubernetes.io/aws-load-balancer-target-group-attributes: deregistration_delay.timeout_seconds<span class="o">=</span>60
...
:wq!
<span class="nt">---</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> echo-service-nlb.yaml
<span class="c"># =&gt; deployment.apps/deploy-echo unchanged</span>
<span class="c">#    service/svc-nlb-ip-type configured</span>
  
<span class="c"># AWS ELB(NLB) ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>aws elbv2 describe-load-balancers | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;LoadBalancers&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;LoadBalancerArn&amp;quot;: &amp;quot;arn:aws:elasticloadbalancing:ap-northeast-2:123456789012:loadbalancer/net/k8s-default-svcnlbip-50f5d03f41/f28c6aa861a2e815&amp;quot;,</span>
<span class="c">#          &amp;quot;DNSName&amp;quot;: &amp;quot;k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com&amp;quot;,</span>
<span class="c">#          &amp;quot;CanonicalHostedZoneId&amp;quot;: &amp;quot;ZIBE1TIR4HY56&amp;quot;,</span>
<span class="c">#          &amp;quot;CreatedTime&amp;quot;: &amp;quot;2024-10-01T08:48:03.532000+00:00&amp;quot;,</span>
<span class="c">#          &amp;quot;LoadBalancerName&amp;quot;: &amp;quot;k8s-default-svcnlbip-50f5d03f41&amp;quot;,</span>
<span class="c">#          &amp;quot;Scheme&amp;quot;: &amp;quot;internet-facing&amp;quot;,</span>
<span class="c">#          &amp;quot;VpcId&amp;quot;: &amp;quot;vpc-0837921f515624150&amp;quot;,</span>
<span class="c">#          &amp;quot;State&amp;quot;: {</span>
<span class="c">#            &amp;quot;Code&amp;quot;: &amp;quot;provisioning&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;Type&amp;quot;: &amp;quot;network&amp;quot;,</span>
<span class="c">#          &amp;quot;AvailabilityZones&amp;quot;: [</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;ZoneName&amp;quot;: &amp;quot;ap-northeast-2a&amp;quot;,</span>
<span class="c">#              &amp;quot;SubnetId&amp;quot;: &amp;quot;subnet-0a06ed52d587bd707&amp;quot;,</span>
<span class="c">#              &amp;quot;LoadBalancerAddresses&amp;quot;: []</span>
<span class="c">#            },</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;ZoneName&amp;quot;: &amp;quot;ap-northeast-2c&amp;quot;,</span>
<span class="c">#              &amp;quot;SubnetId&amp;quot;: &amp;quot;subnet-03c911c48452b41b2&amp;quot;,</span>
<span class="c">#              &amp;quot;LoadBalancerAddresses&amp;quot;: []</span>
<span class="c">#            },</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;ZoneName&amp;quot;: &amp;quot;ap-northeast-2b&amp;quot;,</span>
<span class="c">#              &amp;quot;SubnetId&amp;quot;: &amp;quot;subnet-00b4dacf7eef35d33&amp;quot;,</span>
<span class="c">#              &amp;quot;LoadBalancerAddresses&amp;quot;: []</span>
<span class="c">#            }</span>
<span class="c">#          ],</span>
<span class="c">#          &amp;quot;SecurityGroups&amp;quot;: [</span>
<span class="c">#            &amp;quot;sg-0a7a0dcdcda95c9fc&amp;quot;,</span>
<span class="c">#            &amp;quot;sg-0e325a379a10ced56&amp;quot;</span>
<span class="c">#          ],</span>
<span class="c">#          &amp;quot;IpAddressType&amp;quot;: &amp;quot;ipv4&amp;quot;,</span>
<span class="c">#          &amp;quot;EnablePrefixForIpv6SourceNat&amp;quot;: &amp;quot;off&amp;quot;</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
<span class="nv">$ </span>aws elbv2 describe-load-balancers <span class="nt">--query</span> <span class="s1">'LoadBalancers[*].State.Code'</span> <span class="nt">--output</span> text
<span class="c"># =&gt; provisioning</span>
<span class="nv">$ ALB_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-load-balancers <span class="nt">--query</span> <span class="s1">'LoadBalancers[?contains(LoadBalancerName, `k8s-default-svcnlbip`) == `true`].LoadBalancerArn'</span> | jq <span class="nt">-r</span> <span class="s1">'.[0]'</span><span class="si">)</span>
<span class="nv">$ </span>aws elbv2 describe-target-groups <span class="nt">--load-balancer-arn</span> <span class="nv">$ALB_ARN</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;TargetGroups&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;TargetGroupArn&amp;quot;: &amp;quot;arn:aws:elasticloadbalancing:ap-northeast-2:123456789012:targetgroup/k8s-default-svcnlbip-f58255c318/0cfa12d6c579f11b&amp;quot;,</span>
<span class="c">#          &amp;quot;TargetGroupName&amp;quot;: &amp;quot;k8s-default-svcnlbip-f58255c318&amp;quot;,</span>
<span class="c">#          &amp;quot;Protocol&amp;quot;: &amp;quot;TCP&amp;quot;,</span>
<span class="c">#          &amp;quot;Port&amp;quot;: 8080,</span>
<span class="c">#          &amp;quot;VpcId&amp;quot;: &amp;quot;vpc-0837921f515624150&amp;quot;,</span>
<span class="c">#          &amp;quot;HealthCheckProtocol&amp;quot;: &amp;quot;TCP&amp;quot;,</span>
<span class="c">#          &amp;quot;HealthCheckPort&amp;quot;: &amp;quot;8080&amp;quot;,</span>
<span class="c">#          &amp;quot;HealthCheckEnabled&amp;quot;: true,</span>
<span class="c">#          &amp;quot;HealthCheckIntervalSeconds&amp;quot;: 10,</span>
<span class="c">#          &amp;quot;HealthCheckTimeoutSeconds&amp;quot;: 10,</span>
<span class="c">#          &amp;quot;HealthyThresholdCount&amp;quot;: 3,</span>
<span class="c">#          &amp;quot;UnhealthyThresholdCount&amp;quot;: 3,</span>
<span class="c">#          &amp;quot;LoadBalancerArns&amp;quot;: [</span>
<span class="c">#            &amp;quot;arn:aws:elasticloadbalancing:ap-northeast-2:123456789012:loadbalancer/net/k8s-default-svcnlbip-50f5d03f41/f28c6aa861a2e815&amp;quot;</span>
<span class="c">#          ],</span>
<span class="c">#          &amp;quot;TargetType&amp;quot;: &amp;quot;ip&amp;quot;,</span>
<span class="c">#          &amp;quot;IpAddressType&amp;quot;: &amp;quot;ipv4&amp;quot;</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
<span class="nv">$ TARGET_GROUP_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-target-groups <span class="nt">--load-balancer-arn</span> <span class="nv">$ALB_ARN</span> | jq <span class="nt">-r</span> <span class="s1">'.TargetGroups[0].TargetGroupArn'</span><span class="si">)</span>
<span class="nv">$ </span>aws elbv2 describe-target-health <span class="nt">--target-group-arn</span> <span class="nv">$TARGET_GROUP_ARN</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;TargetHealthDescriptions&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Target&amp;quot;: {</span>
<span class="c">#            &amp;quot;Id&amp;quot;: &amp;quot;192.168.2.24&amp;quot;,</span>
<span class="c">#            &amp;quot;Port&amp;quot;: 8080,</span>
<span class="c">#            &amp;quot;AvailabilityZone&amp;quot;: &amp;quot;ap-northeast-2b&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;HealthCheckPort&amp;quot;: &amp;quot;8080&amp;quot;,</span>
<span class="c">#          &amp;quot;TargetHealth&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;healthy&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;AdministrativeOverride&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;no_override&amp;quot;,</span>
<span class="c">#            &amp;quot;Reason&amp;quot;: &amp;quot;AdministrativeOverride.NoOverride&amp;quot;,</span>
<span class="c">#            &amp;quot;Description&amp;quot;: &amp;quot;No override is currently active on target&amp;quot;</span>
<span class="c">#          }</span>
<span class="c">#        },</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Target&amp;quot;: {</span>
<span class="c">#            &amp;quot;Id&amp;quot;: &amp;quot;192.168.1.112&amp;quot;,</span>
<span class="c">#            &amp;quot;Port&amp;quot;: 8080,</span>
<span class="c">#            &amp;quot;AvailabilityZone&amp;quot;: &amp;quot;ap-northeast-2a&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;HealthCheckPort&amp;quot;: &amp;quot;8080&amp;quot;,</span>
<span class="c">#          &amp;quot;TargetHealth&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;initial&amp;quot;,</span>
<span class="c">#            &amp;quot;Reason&amp;quot;: &amp;quot;Elb.InitialHealthChecking&amp;quot;,</span>
<span class="c">#            &amp;quot;Description&amp;quot;: &amp;quot;Initial health checks in progress&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;AdministrativeOverride&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;no_override&amp;quot;,</span>
<span class="c">#            &amp;quot;Reason&amp;quot;: &amp;quot;AdministrativeOverride.NoOverride&amp;quot;,</span>
<span class="c">#            &amp;quot;Description&amp;quot;: &amp;quot;No override is currently active on target&amp;quot;</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
  
<span class="c"># ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc svc-nlb-ip-type <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span> | <span class="nb">awk</span> <span class="s1">'{ print "Pod Web URL = http://"$1 }'</span>
<span class="c"># =&gt; Pod Web URL = http://k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com</span>
  
<span class="c"># íŒŒë“œ ë¡œê¹… ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>deploy-websrv <span class="nt">-f</span>
  
<span class="c"># ë¶„ì‚° ì ‘ì† í™•ì¸</span>
<span class="nv">$ NLB</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-nlb-ip-type <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span>
<span class="c"># =&gt; Hostname: deploy-echo-857b6cfb88-5xz5j</span>
<span class="c">#    </span>
<span class="c">#    Pod Information:</span>
<span class="c">#     -no pod information available-</span>
<span class="c">#    </span>
<span class="c">#    Server values:</span>
<span class="c">#     server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#    </span>
<span class="c">#    Request Information:</span>
<span class="c">#     client_address=192.168.3.171</span>
<span class="c">#     method=GET</span>
<span class="c">#     real path=/</span>
<span class="c">#     query=</span>
<span class="c">#     request_version=1.1</span>
<span class="c">#     request_uri=http://k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com:8080/</span>
<span class="c">#    </span>
<span class="c">#    Request Headers:</span>
<span class="c">#     accept=*/*</span>
<span class="c">#     host=k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com</span>
<span class="c">#     user-agent=curl/8.3.0</span>
<span class="c">#    </span>
<span class="c">#    Request Body:</span>
<span class="c">#     -no body in request-</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span> | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt; 52 Hostname: deploy-echo-857b6cfb88-452cd</span>
<span class="c">#    48 Hostname: deploy-echo-857b6cfb88-5xz5j</span>
  
<span class="c"># ì§€ì†ì ì¸ ì ‘ì† ì‹œë„ : ì•„ë˜ ìƒì„¸ ë™ì‘ í™•ì¸ ì‹œ ìœ ìš©(íŒ¨í‚· ë¤í”„ ë“±)</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$NLB</span> | egrep <span class="s1">'Hostname|client_address'</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"----------"</span> <span class="p">;</span> <span class="nb">date</span> <span class="s2">"+%Y-%m-%d %H:%M:%S"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Hostname: deploy-echo-857b6cfb88-5xz5j</span>
<span class="c">#     client_address=192.168.1.39</span>
<span class="c">#    ----------</span>
<span class="c">#    2024-10-01 17:52:08</span>
<span class="c">#    Hostname: deploy-echo-857b6cfb88-452cd</span>
<span class="c">#     client_address=192.168.3.171</span>
<span class="c">#    ----------</span>
<span class="c">#    2024-10-01 17:52:09</span>
<span class="c">#    Hostname: deploy-echo-857b6cfb88-5xz5j</span>
<span class="c">#     client_address=192.168.1.39</span>
<span class="c">#    ----------</span>
<span class="c">#    2024-10-01 17:52:10</span>
<span class="c">#    Hostname: deploy-echo-857b6cfb88-452cd</span>
<span class="c">#     client_address=192.168.3.171</span>
<span class="c">#    ...</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>íŒŒë“œ 2ê°œ â†’ 1ê°œ â†’ 3ê°œ ì„¤ì • ì‹œ ë™ì‘ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤. íŒŒë“œì˜ IPê°€ auto discoveryë˜ëŠ”ë° ì´ê²ƒì€ serviceì— ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ë¥¼ ì‚¬ìš©í•œ ê²ƒì…ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># (ì‹ ê·œ í„°ë¯¸ë„) ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws elbv2 describe-target-health <span class="nt">--target-group-arn</span> <span class="nv">$TARGET_GROUP_ARN</span> <span class="nt">--output</span> text<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; TARGETHEALTHDESCRIPTIONS 8080</span>
<span class="c">#    ADMINISTRATIVEOVERRIDE No override is currently active on target AdministrativeOverride.NoOverride no_override</span>
<span class="c">#    TARGET ap-northeast-2b 192.168.2.24  8080</span>
<span class="c">#    TARGETHEALTH healthy</span>
<span class="c">#    TARGETHEALTHDESCRIPTIONS 8080</span>
<span class="c">#    ADMINISTRATIVEOVERRIDE No override is currently active on target AdministrativeOverride.NoOverride no_override</span>
<span class="c">#    TARGET ap-northeast-2a 192.168.1.112 8080</span>
<span class="c">#    TARGETHEALTH healthy</span>
<span class="c">#    ...</span>
    
<span class="c"># ì‘ì—…ìš© EC2 - íŒŒë“œ 1ê°œ ì„¤ì • </span>
<span class="nv">$ </span>kubectl scale deployment deploy-echo <span class="nt">--replicas</span><span class="o">=</span>1
    
<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep
<span class="c"># =&gt; NAME                          READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/deploy-echo   1/1     1            1           6m34s</span>
<span class="c">#    </span>
<span class="c">#    NAME                               READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/deploy-echo-857b6cfb88-452cd   1/1     Running   0          6m34s</span>
<span class="c">#    </span>
<span class="c">#    NAME                      TYPE           CLUSTER-IP      EXTERNAL-IP                                                                         PORT(S)        AGE</span>
<span class="c">#    service/kubernetes        ClusterIP      10.100.0.1      &amp;lt;none&amp;gt;                                                                              443/TCP        82m</span>
<span class="c">#    service/svc-nlb-ip-type   LoadBalancer   10.100.83.184   k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com   80:30771/TCP   6m34s</span>
<span class="c">#    </span>
<span class="c">#    NAME                        ENDPOINTS                            AGE</span>
<span class="c">#    endpoints/kubernetes        192.168.1.65:443,192.168.3.189:443   82m</span>
<span class="c">#    endpoints/svc-nlb-ip-type   192.168.2.24:8080                    6m34s</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span>
<span class="c"># =&gt; Hostname: deploy-echo-857b6cfb88-452cd</span>
<span class="c">#    </span>
<span class="c">#    Pod Information:</span>
<span class="c">#     -no pod information available-</span>
<span class="c">#    </span>
<span class="c">#    Server values:</span>
<span class="c">#     server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#    </span>
<span class="c">#    Request Information:</span>
<span class="c">#     client_address=192.168.3.171</span>
<span class="c">#     method=GET</span>
<span class="c">#     real path=/</span>
<span class="c">#     query=</span>
<span class="c">#     request_version=1.1</span>
<span class="c">#     request_uri=http://k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com:8080/</span>
<span class="c">#    </span>
<span class="c">#    Request Headers:</span>
<span class="c">#     accept=*/*</span>
<span class="c">#     host=k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com</span>
<span class="c">#     user-agent=curl/8.3.0</span>
<span class="c">#    </span>
<span class="c">#    Request Body:</span>
<span class="c">#     -no body in request-</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$NLB</span> | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;     100 Hostname: deploy-echo-857b6cfb88-452cd</span>
    
<span class="c"># ì‘ì—…ìš© EC2 - íŒŒë“œ 3ê°œ ì„¤ì • </span>
<span class="nv">$ </span>kubectl scale deployment deploy-echo <span class="nt">--replicas</span><span class="o">=</span>3
<span class="c"># =&gt; deployment.apps/deploy-echo scaled</span>
    
<span class="c"># í™•ì¸ : NLB ëŒ€ìƒ íƒ€ì¼“ì´ ì•„ì§ initial ì¼ ë•Œ 100ë²ˆ ë°˜ë³µ ì ‘ì† ì‹œ ì–´ë–»ê²Œ ë˜ëŠ”ì§€ í™•ì¸í•´ë³´ì!</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep
<span class="c"># =&gt; NAME                          READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/deploy-echo   3/3     3            3           7m41s</span>
<span class="c">#    </span>
<span class="c">#    NAME                               READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    ...</span>
<span class="c">#    pod/deploy-echo-857b6cfb88-8wn7b   1/1     Running   0          10s</span>
<span class="c">#    pod/deploy-echo-857b6cfb88-qhqbt   1/1     Running   0          10s</span>
<span class="c">#    </span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAME                        ENDPOINTS                                                 AGE</span>
<span class="c">#    ...</span>
<span class="c">#    endpoints/svc-nlb-ip-type   192.168.1.161:8080,192.168.2.24:8080,192.168.3.241:8080   7m41s</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$NLB</span> | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      37 Hostname: deploy-echo-857b6cfb88-452cd</span>
<span class="c">#         33 Hostname: deploy-echo-857b6cfb88-8wn7b</span>
<span class="c">#         30 Hostname: deploy-echo-857b6cfb88-qhqbt</span>
    
<span class="c"># </span>
<span class="nv">$ </span>kubectl describe deploy <span class="nt">-n</span> kube-system aws-load-balancer-controller | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s1">'Service Account'</span>
<span class="c"># =&gt;   Service Account:  aws-load-balancer-controller</span>
    
<span class="c"># [AWS LB Ctrl] í´ëŸ¬ìŠ¤í„° ë¡¤ ë°”ì¸ë”© ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe clusterrolebindings.rbac.authorization.k8s.io aws-load-balancer-controller-rolebinding
    
<span class="c"># [AWS LB Ctrl] í´ëŸ¬ìŠ¤í„°ë¡¤ í™•ì¸ </span>
<span class="nv">$ </span>kubectl describe clusterroles.rbac.authorization.k8s.io aws-load-balancer-controller-role
</code></pre></div>    </div>

    <ul>
      <li>ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ:  <code class="language-plaintext highlighter-rouge">kubectl delete deploy deploy-echo; kubectl delete svc svc-nlb-ip-type</code></li>
    </ul>
  </li>
  <li><strong>(ì‹¬í™”) Pod readiness gate</strong> : ALB/NLB ëŒ€ìƒ(ip mode)ì´ ALB/NLBì˜ í—¬ìŠ¤ì²´í¬ì— ì˜í•´ ì •ìƒì¼ ê²½ìš° í•´ë‹¹ íŒŒë“œë¡œ ì „ë‹¬í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. - <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.7/deploy/pod_readiness_gate/">Link</a> <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-readiness-gate">K8S</a>
    <ul>
      <li>
        <p>ì‚¬ì „ ì¤€ë¹„</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°”ë¡œ ìœ„ì—ì„œ ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œí–ˆë‹¤ë©´, ë‹¤ì‹œ ìƒì„± : deregistration_delay.timeout_seconds=60 í™•ì¸</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> echo-service-nlb.yaml
<span class="c"># =&gt; deployment.apps/deploy-echo created</span>
<span class="c">#    service/svc-nlb-ip-type created</span>
<span class="nv">$ </span>kubectl scale deployment deploy-echo <span class="nt">--replicas</span><span class="o">=</span>1
<span class="c"># =&gt; deployment.apps/deploy-echo scaled</span>
    
<span class="c">#</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                           READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES</span>
<span class="c">#    deploy-echo-857b6cfb88-sx8lg   1/1     Running   0          14m   192.168.3.124   ip-192-168-3-235.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
    
<span class="c"># mutatingwebhookconfigurations í™•ì¸ : mutating ëŒ€ìƒ(ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì•„ë˜ ë§¤ì¹­ ì‹œ)</span>
<span class="nv">$ </span>kubectl get mutatingwebhookconfigurations
<span class="c"># =&gt; NAME                            WEBHOOKS   AGE</span>
<span class="c">#    aws-load-balancer-webhook       3          28m</span>
<span class="c">#    pod-identity-webhook            1          102m</span>
<span class="c">#    vpc-resource-mutating-webhook   1          102m</span>
<span class="nv">$ </span>kubectl get mutatingwebhookconfigurations aws-load-balancer-webhook <span class="nt">-o</span> yaml | kubectl neat
<span class="c"># =&gt; ...</span>
<span class="c">#      name: mpod.elbv2.k8s.aws</span>
<span class="c">#      namespaceSelector:</span>
<span class="c">#        matchExpressions:</span>
<span class="c">#        - key: elbv2.k8s.aws/pod-readiness-gate-inject</span>
<span class="c">#          operator: In</span>
<span class="c">#          values:</span>
<span class="c">#          - enabled</span>
<span class="c">#      objectSelector:</span>
<span class="c">#        matchExpressions:</span>
<span class="c">#        - key: app.kubernetes.io/name</span>
<span class="c">#          operator: NotIn</span>
<span class="c">#          values:</span>
<span class="c">#          - aws-load-balancer-controller</span>
<span class="c">#    ...</span>
    
<span class="c"># í˜„ì¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get ns <span class="nt">--show-labels</span>
<span class="c"># =&gt; NAME              STATUS   AGE    LABELS</span>
<span class="c">#    default           Active   103m   kubernetes.io/metadata.name=default</span>
<span class="c">#    kube-node-lease   Active   103m   kubernetes.io/metadata.name=kube-node-lease</span>
<span class="c">#    kube-public       Active   103m   kubernetes.io/metadata.name=kube-public</span>
<span class="c">#    kube-system       Active   103m   kubernetes.io/metadata.name=kube-system</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì„¤ì • ë° í™•ì¸</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># (í„°ë¯¸ë„ ê°ê° 2ê°œ) ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ ALB_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-load-balancers <span class="nt">--query</span> <span class="s1">'LoadBalancers[?contains(LoadBalancerName, `k8s-default-svcnlbip`) == `true`].LoadBalancerArn'</span> | jq <span class="nt">-r</span> <span class="s1">'.[0]'</span><span class="si">)</span>
<span class="nv">$ TARGET_GROUP_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-target-groups <span class="nt">--load-balancer-arn</span> <span class="nv">$ALB_ARN</span> | jq <span class="nt">-r</span> <span class="s1">'.TargetGroups[0].TargetGroupArn'</span><span class="si">)</span>
    
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod,svc,ep <span class="nt">-owide</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws elbv2 describe-target-health <span class="nt">--target-group-arn</span> <span class="nv">$TARGET_GROUP_ARN</span> <span class="nt">--output</span> text<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
    
<span class="c">#</span>
<span class="nv">$ </span>kubectl label namespace default elbv2.k8s.aws/pod-readiness-gate-inject<span class="o">=</span>enabled
<span class="c"># =&gt; namespace/default labeled</span>
<span class="nv">$ </span>kubectl get ns <span class="nt">--show-labels</span>
<span class="c"># =&gt; NAME              STATUS   AGE    LABELS</span>
<span class="c">#    default           Active   108m   elbv2.k8s.aws/pod-readiness-gate-inject=enabled,kubernetes.io/metadata.name=default</span>
<span class="c">#    kube-node-lease   Active   108m   kubernetes.io/metadata.name=kube-node-lease</span>
<span class="c">#    kube-public       Active   108m   kubernetes.io/metadata.name=kube-public</span>
<span class="c">#    kube-system       Active   108m   kubernetes.io/metadata.name=kube-system</span>
    
<span class="c"># READINESS GATES í•­ëª© ì¶”ê°€ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe pod
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                           READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES</span>
<span class="c">#    deploy-echo-857b6cfb88-sx8lg   1/1     Running   0          20m   192.168.3.124   ip-192-168-3-235.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
    
<span class="c">#</span>
<span class="nv">$ </span>kubectl delete pod <span class="nt">--all</span>
<span class="c"># =&gt; pod &amp;quot;deploy-echo-857b6cfb88-sx8lg&amp;quot; deleted</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                           READY   STATUS    RESTARTS   AGE   IP             NODE                                              NOMINATED NODE   READINESS GATES</span>
<span class="c">#    deploy-echo-857b6cfb88-njwdj   1/1     Running   0          54s   192.168.2.18   ip-192-168-2-92.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           1/1</span>
    
<span class="nv">$ </span>kubectl describe pod
<span class="c"># =&gt; ...</span>
<span class="c">#    Readiness Gates:</span>
<span class="c">#      Type                                                          Status</span>
<span class="c">#      target-health.elbv2.k8s.aws/k8s-default-svcnlbip-2e5acb9719   True</span>
<span class="c">#    Conditions:</span>
<span class="c">#      Type                                                          Status</span>
<span class="c">#      target-health.elbv2.k8s.aws/k8s-default-svcnlbip-2e5acb9719   True</span>
<span class="c">#      PodReadyToStartContainers                                     True</span>
<span class="c">#      Initialized                                                   True</span>
<span class="c">#      Ready                                                         True</span>
<span class="c">#      ContainersReady                                               True</span>
<span class="c">#      PodScheduled                                                  True</span>
<span class="c">#      ...</span>
    
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> yaml | yh
<span class="c"># =&gt; ...</span>
<span class="c">#        readinessGates:</span>
<span class="c">#        - conditionType: target-health.elbv2.k8s.aws/k8s-default-svcnlbip-2e5acb9719</span>
<span class="c">#    ...</span>
<span class="c">#      status:</span>
<span class="c">#        conditions:</span>
<span class="c">#        - lastProbeTime: null</span>
<span class="c">#          lastTransitionTime: &amp;quot;2024-10-01T09:21:28Z&amp;quot;</span>
<span class="c">#          status: &amp;quot;True&amp;quot;</span>
<span class="c">#          type: target-health.elbv2.k8s.aws/k8s-default-svcnlbip-2e5acb9719</span>
<span class="c">#    ...</span>
    
<span class="c"># ë¶„ì‚° ì ‘ì† í™•ì¸</span>
<span class="nv">$ NLB</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-nlb-ip-type <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span>
<span class="c"># =&gt; Hostname: deploy-echo-857b6cfb88-njwdj</span>
<span class="c">#    </span>
<span class="c">#    Pod Information:</span>
<span class="c">#     -no pod information available-</span>
<span class="c">#    </span>
<span class="c">#    Server values:</span>
<span class="c">#     server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#    </span>
<span class="c">#    Request Information:</span>
<span class="c">#     client_address=192.168.3.71</span>
<span class="c">#     method=GET</span>
<span class="c">#     real path=/</span>
<span class="c">#     query=</span>
<span class="c">#     request_version=1.1</span>
<span class="c">#     request_uri=http://k8s-default-svcnlbip-f4c21d9697-0d3512de2bf74357.elb.ap-northeast-2.amazonaws.com:8080/</span>
<span class="c">#    </span>
<span class="c">#    Request Headers:</span>
<span class="c">#     accept=*/*</span>
<span class="c">#     host=k8s-default-svcnlbip-f4c21d9697-0d3512de2bf74357.elb.ap-northeast-2.amazonaws.com</span>
<span class="c">#     user-agent=curl/8.3.0</span>
<span class="c">#    </span>
<span class="c">#    Request Body:</span>
<span class="c">#     -no body in request-</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span> | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;     100 Hostname: deploy-echo-857b6cfb88-njwdj</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ:  <code class="language-plaintext highlighter-rouge">kubectl delete deploy deploy-echo; kubectl delete svc svc-nlb-ip-type</code></p>
      </li>
    </ul>
  </li>
  <li>NLB ëŒ€ìƒ íƒ€ì¼“ì„ <strong>Instance mode</strong> ë¡œ ì„¤ì •í•´ë³´ê¸°
    <ul>
      <li>ë‹¤ìŒ ë§í¬ì—ì„œ í™•ì¸í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<a href="https://www.notion.so/AWS-NLB-Client-IP-Proxy-protocol-57827e2c83fc474992b37e65db81f669?pvs=21">AWS NLB - Client IP í™•ì¸ &amp; Proxy protocol</a></li>
    </ul>
  </li>
  <li>
    <p>NLB IP Target &amp; <strong>Proxy Protocol v2</strong> í™œì„±í™” : NLBì—ì„œ ë°”ë¡œ íŒŒë“œë¡œ ì¸ì… ë° ClientIP í™•ì¸ ì„¤ì • - <a href="https://www.notion.so/AWS-NLB-Client-IP-Proxy-protocol-57827e2c83fc474992b37e65db81f669?pvs=21">ë§í¬</a> <a href="https://hub.docker.com/r/gasida/httpd/tags">image</a> <a href="https://canaryrelease.tistory.com/42">ì°¸ê³ </a></p>

    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_25.png" alt="img_9.png" class="image-center w-90" /></p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gasida-web
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gasida-web
  template:
    metadata:
      labels:
        app: gasida-web
    spec:
      terminationGracePeriodSeconds: 0
      containers:
      - name: gasida-web
        image: sweetlittlebird/httpd:pp
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: svc-nlb-ip-type-pp
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: "*"
spec:
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
  type: LoadBalancer
  loadBalancerClass: service.k8s.aws/nlb
  selector:
    app: gasida-web
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/gasida-web created</span>
<span class="c">#    service/svc-nlb-ip-type-pp created</span>

<span class="c"># apacheì— proxy protocol í™œì„±í™” í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>deploy/gasida-web <span class="nt">--</span> apachectl <span class="nt">-t</span> <span class="nt">-D</span> DUMP_MODULES
<span class="c"># =&gt; Loaded Modules:</span>
<span class="c">#     ...</span>
<span class="c">#     remoteip_module (shared)</span>
<span class="c">#     ...</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>deploy/gasida-web <span class="nt">--</span> <span class="nb">cat</span> /usr/local/apache2/conf/httpd.conf
<span class="c"># =&gt; ...</span>
<span class="c">#    RemoteIPProxyProtocol On</span>
<span class="c">#    ...</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc,ep
<span class="c"># =&gt; NAME                         TYPE           CLUSTER-IP       EXTERNAL-IP                                                                         PORT(S)        AGE</span>
<span class="c">#    service/kubernetes           ClusterIP      10.100.0.1       &amp;lt;none&amp;gt;                                                                              443/TCP        5h52m</span>
<span class="c">#    service/svc-nlb-ip-type-pp   LoadBalancer   10.100.160.172   k8s-default-svcnlbip-c11e4bd02e-ec82d8f688f176d3.elb.ap-northeast-2.amazonaws.com   80:31348/TCP   36m</span>
<span class="c">#    </span>
<span class="c">#    NAME                           ENDPOINTS                            AGE</span>
<span class="c">#    endpoints/kubernetes           192.168.1.65:443,192.168.3.189:443   5h52m</span>
<span class="c">#    endpoints/svc-nlb-ip-type-pp   192.168.2.51:80                      36m</span>
<span class="nv">$ </span>kubectl describe svc svc-nlb-ip-type-pp
<span class="nv">$ </span>kubectl describe svc svc-nlb-ip-type-pp | <span class="nb">grep </span>Annotations: <span class="nt">-A5</span>
<span class="c"># =&gt; Annotations: service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: true</span>
<span class="c">#                 service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip   # &lt;span style="color: green;"&gt;ğŸ‘‰ NLB Target Typeì´ IPì…ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#                 service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: *</span>
<span class="c">#                 service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing</span>
<span class="c">#    Selector:    app=gasida-web</span>
<span class="c">#    Type:        LoadBalancer</span>

<span class="c"># ì ‘ì† í™•ì¸</span>
<span class="nv">$ NLB</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-nlb-ip-type-pp <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span>
<span class="c"># =&gt; &amp;lt;html&amp;gt;&amp;lt;body&amp;gt;&amp;lt;h1&amp;gt;It works!&amp;lt;/h1&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;</span>

<span class="c"># ì§€ì†ì ì¸ ì ‘ì† ì‹œë„ : ì•„ë˜ ìƒì„¸ ë™ì‘ í™•ì¸ ì‹œ ìœ ìš©(íŒ¨í‚· ë¤í”„ ë“±)</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$NLB</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"----------"</span> <span class="p">;</span> <span class="nb">date</span> <span class="s2">"+%Y-%m-%d %H:%M:%S"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>

<span class="c"># ë² ìŠ¤ì³” í˜¸ìŠ¤íŠ¸ IP í™•ì¸</span>
<span class="nv">$ </span>curl ipinfo.io/ip
<span class="c"># =&gt; 3.35.140.75</span>

<span class="c"># ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>gasida-web <span class="nt">-f</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    3.35.140.75 - - [01/Oct/2024:13:46:35 +0000] &amp;quot;GET / HTTP/1.1&amp;quot; 200 45</span>
<span class="c">#    3.35.140.75 - - [01/Oct/2024:13:46:36 +0000] &amp;quot;GET / HTTP/1.1&amp;quot; 200 45</span>
<span class="c">#    3.35.140.75 - - [01/Oct/2024:13:46:37 +0000] &amp;quot;GET / HTTP/1.1&amp;quot; 200 45</span>
<span class="c">#    3.35.140.75 - - [01/Oct/2024:13:46:38 +0000] &amp;quot;GET / HTTP/1.1&amp;quot; 200 45</span>

<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ proxy protocolì„ í†µí•´ ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ì˜ IPê°€ ì „ë‹¬ë˜ì–´ ë¡œê·¸ì— ë‚¨ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete deploy gasida-web<span class="p">;</span> kubectl delete svc svc-nlb-ip-type-pp
</code></pre></div></div>

<hr />

<h3 id="ingress">Ingress</h3>

<ul>
  <li>IngressëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ì„œë¹„ìŠ¤(ClusterIP, NodePort, Loadbalancer)ë¥¼ ì™¸ë¶€ë¡œ ë…¸ì¶œ(<strong>HTTP/HTTPS</strong>)ì‹œí‚¤ëŠ” ì¼ì¢…ì˜ Web Proxy ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="aws-load-balancer-controller--ingress-alb-ip-ëª¨ë“œ-ë™ì‘-with-aws-vpc-cni"><strong>AWS Load Balancer Controller</strong> + <strong>Ingress (ALB) IP ëª¨ë“œ</strong> ë™ì‘ with <strong>AWS VPC CNI</strong></h4>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_11.png" alt="img.png" class="image-center w-90" /></p>

<ul>
  <li>
    <p>ì„œë¹„ìŠ¤/íŒŒë“œ ë°°í¬ í…ŒìŠ¤íŠ¸ with Ingress(ALB) - <a href="https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html">ALB</a></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ê²Œì„ íŒŒë“œì™€ Service, Ingress ë°°í¬</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-O</span> https://raw.githubusercontent.com/gasida/PKOS/main/3/ingress1.yaml
<span class="nv">$ </span><span class="nb">cat </span>ingress1.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ingress1.yaml
<span class="c"># =&gt; namespace/game-2048 created</span>
<span class="c">#    deployment.apps/deployment-2048 created</span>
<span class="c">#    service/service-2048 created</span>
<span class="c">#    ingress.networking.k8s.io/ingress-2048 created</span>
  
<span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod,ingress,svc,ep <span class="nt">-n</span> game-2048
  
<span class="c"># ìƒì„± í™•ì¸</span>
<span class="nv">$ </span>kubectl get-all <span class="nt">-n</span> game-2048
<span class="c"># =&gt; NAME                                                               NAMESPACE  AGE</span>
<span class="c">#    configmap/kube-root-ca.crt                                         game-2048  38s</span>
<span class="c">#    endpoints/service-2048                                             game-2048  38s</span>
<span class="c">#    pod/deployment-2048-85f8c7d69-gz295                                game-2048  38s</span>
<span class="c">#    pod/deployment-2048-85f8c7d69-t2blb                                game-2048  38s</span>
<span class="c">#    serviceaccount/default                                             game-2048  38s</span>
<span class="c">#    service/service-2048                                               game-2048  38s</span>
<span class="c">#    deployment.apps/deployment-2048                                    game-2048  38s</span>
<span class="c">#    replicaset.apps/deployment-2048-85f8c7d69                          game-2048  38s</span>
<span class="c">#    endpointslice.discovery.k8s.io/service-2048-s58q4                  game-2048  38s</span>
<span class="c">#    targetgroupbinding.elbv2.k8s.aws/k8s-game2048-service2-00c3b27023  game-2048  34s</span>
<span class="c">#    ingress.networking.k8s.io/ingress-2048                             game-2048  38s</span>
<span class="nv">$ </span>kubectl get ingress,svc,ep,pod <span class="nt">-n</span> game-2048
<span class="c"># =&gt; NAME                                     CLASS   HOSTS   ADDRESS                                                                       PORTS   AGE</span>
<span class="c">#    ingress.networking.k8s.io/ingress-2048   alb     *       k8s-game2048-ingress2-70d50ce3fd-333540411.ap-northeast-2.elb.amazonaws.com   80      49s</span>
<span class="c">#    </span>
<span class="c">#    NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/service-2048   NodePort   10.100.41.151   &amp;lt;none&amp;gt;        80:32522/TCP   49s</span>
<span class="c">#    </span>
<span class="c">#    NAME                     ENDPOINTS                          AGE</span>
<span class="c">#    endpoints/service-2048   192.168.1.112:80,192.168.2.18:80   49s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                  READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/deployment-2048-85f8c7d69-gz295   1/1     Running   0          49s</span>
<span class="c">#    pod/deployment-2048-85f8c7d69-t2blb   1/1     Running   0          49s</span>
<span class="nv">$ </span>kubectl get targetgroupbindings <span class="nt">-n</span> game-2048
<span class="c"># =&gt; NAME                               SERVICE-NAME   SERVICE-PORT   TARGET-TYPE   AGE</span>
<span class="c">#    k8s-game2048-service2-00c3b27023   service-2048   80             ip            56s</span>
  
<span class="c"># ALB ìƒì„± í™•ì¸</span>
<span class="nv">$ </span>aws elbv2 describe-load-balancers <span class="nt">--query</span> <span class="s1">'LoadBalancers[?contains(LoadBalancerName, `k8s-game2048`) == `true`]'</span> | jq
<span class="nv">$ ALB_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-load-balancers <span class="nt">--query</span> <span class="s1">'LoadBalancers[?contains(LoadBalancerName, `k8s-game2048`) == `true`].LoadBalancerArn'</span> | jq <span class="nt">-r</span> <span class="s1">'.[0]'</span><span class="si">)</span>
<span class="nv">$ </span>aws elbv2 describe-target-groups <span class="nt">--load-balancer-arn</span> <span class="nv">$ALB_ARN</span>
<span class="nv">$ TARGET_GROUP_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-target-groups <span class="nt">--load-balancer-arn</span> <span class="nv">$ALB_ARN</span> | jq <span class="nt">-r</span> <span class="s1">'.TargetGroups[0].TargetGroupArn'</span><span class="si">)</span>
<span class="nv">$ </span>aws elbv2 describe-target-health <span class="nt">--target-group-arn</span> <span class="nv">$TARGET_GROUP_ARN</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;TargetHealthDescriptions&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Target&amp;quot;: {</span>
<span class="c">#            &amp;quot;Id&amp;quot;: &amp;quot;192.168.1.112&amp;quot;,</span>
<span class="c">#            &amp;quot;Port&amp;quot;: 80,</span>
<span class="c">#            &amp;quot;AvailabilityZone&amp;quot;: &amp;quot;ap-northeast-2a&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;HealthCheckPort&amp;quot;: &amp;quot;80&amp;quot;,</span>
<span class="c">#          &amp;quot;TargetHealth&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;healthy&amp;quot;</span>
<span class="c">#          }</span>
<span class="c">#        },</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Target&amp;quot;: {</span>
<span class="c">#            &amp;quot;Id&amp;quot;: &amp;quot;192.168.2.18&amp;quot;,</span>
<span class="c">#            &amp;quot;Port&amp;quot;: 80,</span>
<span class="c">#            &amp;quot;AvailabilityZone&amp;quot;: &amp;quot;ap-northeast-2b&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;HealthCheckPort&amp;quot;: &amp;quot;80&amp;quot;,</span>
<span class="c">#          &amp;quot;TargetHealth&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;healthy&amp;quot;</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
  
<span class="c"># Ingress í™•ì¸</span>
<span class="nv">$ </span>kubectl describe ingress <span class="nt">-n</span> game-2048 ingress-2048
<span class="nv">$ </span>kubectl get ingress <span class="nt">-n</span> game-2048 ingress-2048 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.loadBalancer.ingress[*].hostname}{'</span><span class="se">\n</span><span class="s2">'}"</span>
<span class="c"># =&gt; k8s-game2048-ingress2-70d50ce3fd-333540411.ap-northeast-2.elb.amazonaws.com</span>
  
<span class="c"># ê²Œì„ ì ‘ì† : ALB ì£¼ì†Œë¡œ ì›¹ ì ‘ì†</span>
<span class="nv">$ </span>kubectl get ingress <span class="nt">-n</span> game-2048 ingress-2048 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span> | <span class="nb">awk</span> <span class="s1">'{ print "Game URL = http://"$1 }'</span>
<span class="c"># =&gt; Game URL = http://k8s-game2048-ingress2-70d50ce3fd-333540411.ap-northeast-2.elb.amazonaws.com</span>
  
<span class="c"># íŒŒë“œ IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> game-2048 <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                              READY   STATUS    RESTARTS   AGE     IP              NODE                                               NOMINATED NODE   READINESS GATES</span>
<span class="c">#    deployment-2048-85f8c7d69-gz295   1/1     Running   0          3m42s   192.168.2.18    ip-192-168-2-92.ap-northeast-2.compute.internal    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    deployment-2048-85f8c7d69-t2blb   1/1     Running   0          3m42s   192.168.1.112   ip-192-168-1-186.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
</code></pre></div>    </div>
    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_31.png" alt="img.png" /></p>

    <ul>
      <li>
        <p><strong>ALB ëŒ€ìƒ ê·¸ë£¹</strong>ì— ë“±ë¡ëœ ëŒ€ìƒ í™•ì¸ : ALBì—ì„œ íŒŒë“œ IPë¡œ ì§ì ‘ ì „ë‹¬</p>

        <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_32.png" alt="img.png" class="image-center" />
<em class="image-caption">íŒŒë“œ IPë¡œ ë°”ë¡œ ì§ì ‘ ì—°ê²°ëœ ALB ëŒ€ìƒ ê·¸ë£¹</em></p>
      </li>
      <li>
        <p>íŒŒë“œ 3ê°œë¡œ ì¦ê°€</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„1</span>
<span class="nv">$ </span>watch kubectl get pod <span class="nt">-n</span> game-2048
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws elbv2 describe-target-health <span class="nt">--target-group-arn</span> <span class="nv">$TARGET_GROUP_ARN</span> <span class="nt">--output</span> text<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
    
<span class="c"># í„°ë¯¸ë„2 : íŒŒë“œ 3ê°œë¡œ ì¦ê°€</span>
<span class="nv">$ </span>kubectl scale deployment <span class="nt">-n</span> game-2048 deployment-2048 <span class="nt">--replicas</span> 3
<span class="c"># =&gt; deployment.apps/deployment-2048 scaled</span>
</code></pre></div>        </div>
        <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_33.png" alt="img.png" class="image-center" />
<em class="image-caption">ì¶”ê°€ëœ íŒŒë“œ IPê°€ ì—°ê²°ë¨</em></p>
      </li>
      <li>
        <p>íŒŒë“œ 1ê°œë¡œ ê°ì†Œ</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„2 : íŒŒë“œ 1ê°œë¡œ ê°ì†Œ</span>
<span class="nv">$ </span>kubectl scale deployment <span class="nt">-n</span> game-2048 deployment-2048 <span class="nt">--replicas</span> 1
<span class="c"># =&gt; deployment.apps/deployment-2048 scaled</span>
</code></pre></div>        </div>

        <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_34.png" alt="img.png" class="image-center" />
<em class="image-caption">ì‚­ì œë˜ëŠ” 2ê°œì˜ íŒŒë“œê°€ ì‚­ì œ ì¤‘ì„ì„ í™•ì¸</em></p>
      </li>
      <li>
        <p>ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤  ì‚­ì œ</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete ingress ingress-2048 <span class="nt">-n</span> game-2048
<span class="nv">$ </span>kubectl delete svc service-2048 <span class="nt">-n</span> game-2048 <span class="o">&amp;&amp;</span> kubectl delete deploy deployment-2048 <span class="nt">-n</span> game-2048 <span class="o">&amp;&amp;</span> kubectl delete ns game-2048
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h4 id="kubernetes-ì‘ìš©í”„ë¡œê·¸ë¨ì„-ì™¸ë¶€ë¡œ-ë…¸ì¶œ-ì‹œí‚¤ëŠ”-ë°©ë²•ë“¤-ë¹„êµ">Kubernetes ì‘ìš©í”„ë¡œê·¸ë¨ì„ ì™¸ë¶€ë¡œ ë…¸ì¶œ ì‹œí‚¤ëŠ” ë°©ë²•ë“¤ ë¹„êµ</h4>

<ul>
  <li>ê°„ëµí•˜ê²Œ Kubernetes ì‘ìš©í”„ë¡œê·¸ë¨ì„ ì™¸ë¶€ë¡œ ë…¸ì¶œ ì‹œê¸°ëŠ” ë°©ë²•ë“¤ì„ ë¹„êµí•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒ ë¸”ë¡œê·¸ì—ì„œ ì‚´í´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://aws.amazon.com/blogs/containers/exposing-kubernetes-applications-part-1-service-and-ingress-resources/">Exposing Kubernetes Applications, Part 1: Service and Ingress Resources </a>
    <ol>
      <li>Exposing a <strong>Service</strong> : In-tree Service Controller
  <img src="/assets/2024/kans-3th/w9/20241102_kans_w9_12.png" alt="img.png" class="image-center" />
        <ul>
          <li>AWS CLB(Classic Load Balancer)ë‚˜ AWS NLB(Network Load Balancer)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ì§ì ‘ ì™¸ë¶€ë¡œ ë…¸ì¶œí•©ë‹ˆë‹¤.
 í•˜ì§€ë§Œ ì„œë¹„ìŠ¤ ìˆ˜ê°€ ë§ì•„ì§€ë©´ Load Balancerì˜ ìˆ˜ë„ ë§ì•„ì§€ê²Œ ë˜ì–´ ê´€ë¦¬ê°€ ì–´ë ¤ì›Œì§‘ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><strong>Ingress Implementations : External Load Balancer</strong>
  <img src="/assets/2024/kans-3th/w9/20241102_kans_w9_13.png" alt="img.png" class="image-center" />
        <ul>
          <li>ì™¸ë¶€ì— ALB(Application Load Balancer)ë¥¼ ìƒì„±í•˜ê³  ë¼ìš°íŒ…í•©ë‹ˆë‹¤. ì´ë•Œ ì™¸ë¶€ì˜ ALBê°€ Ingress ruleì„ ALB ruleë¡œ ë³€í™˜í•˜ì—¬ 
 ì™¸ë¶€ ALBê°€ ì§ì ‘ íŒŒë“œì™€ í†µì‹ í•©ë‹ˆë‹¤. ì•ì—ì„œ ë³¸ ì„œë¹„ìŠ¤ë¥¼ ì§ì ‘ ì™¸ë¶€ë¡œ ë…¸ì¶œí•˜ëŠ”ê²ƒ ë³´ë‹¤, CSP(Cloud Service Provider)ì—ì„œ ì œê³µí•˜ëŠ”
 í™•ì¥ì„±ì´ë‚˜, DDOS ë°©ì–´ê¸°ëŠ¥ ë“±ì„ í™œìš© í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><strong>Ingress Implementations : Internal Reverse Proxy</strong>
  <img src="/assets/2024/kans-3th/w9/20241102_kans_w9_14.png" alt="img.png" class="image-center" />
        <ul>
          <li>ì™¸ë¶€ì˜ ALBì— ë”í•´ nginx ë“±ì˜ Layer 7 ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ ë‘ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ì´ ë°©ì‹ì€ ì™¸ë¶€ ALBê°€ ì§ì ‘ íŒŒë“œì™€ í†µì‹ í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼,
 ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ í†µí•´ í†µì‹ í•˜ê²Œ ë©ë‹ˆë‹¤. ì„±ëŠ¥ìƒìœ¼ë¡œëŠ” ë¶ˆì´ìµì´ ìˆì§€ë§Œ L7 ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œì—ì„œ ì œê³µí•˜ëŠ” ì¶”ê°€ ê¸°ëŠ¥ë“¤ì„ í™œìš© í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>í•˜ì§€ë§Œ ê´€ë¦¬ìš”ì†Œê°€ ì¶”ê°€ë˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ì´ë¥¼ ê³ ë ¤í•˜ì—¬ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><strong>Kubernetes Gateway API</strong>
  <img src="/assets/2024/kans-3th/w9/20241102_kans_w9_15.png" alt="img.png" class="image-center" />
        <ul>
          <li>Kubernetes Gateway APIëŠ” Ingress Controllerë¥¼ ëŒ€ì²´í•˜ëŠ” ìƒˆë¡œìš´ APIë¡œ í˜„ì‹œì ì—ì„œ Beta ìƒíƒœë¡œ, ì •ì‹ ì§€ì›í•˜ì§€ëŠ” ì•ŠëŠ”ë“¯í•˜ë©°,
 ì™¸ë¶€ Loadbalancerë‚˜ Internal reverse proxy ë°©ì‹ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ol>
  </li>
</ul>

<h3 id="externaldns">ExternalDNS</h3>

<ul>
  <li>
    <p>K8S ì„œë¹„ìŠ¤/ì¸ê·¸ë ˆìŠ¤ ìƒì„± ì‹œ ë„ë©”ì¸ì„ ì„¤ì •í•˜ë©´, AWS(Route 53), Azure(DNS), GCP(Cloud DNS)ì— A ë ˆì½”ë“œ(TXT ë ˆì½”ë“œ)ê°€ ìë™ìœ¼ë¡œ ìƒì„±/ì‚­ì œë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w9/20241102_kans_w9_27.png" alt="img.png" class="image-center" />
<em class="image-caption"><a href="https://edgehog.blog/a-self-hosted-external-dns-resolver-for-kubernetes-111a27d6fc2c">https://edgehog.blog/a-self-hosted-external-dns-resolver-for-kubernetes-111a27d6fc2c</a></em></p>
  </li>
  <li>
    <p>AWS Route 53 ì •ë³´ í™•ì¸ &amp; ë³€ìˆ˜ ì§€ì • : Public ë„ë©”ì¸ ì†Œìœ ë¥¼ í•˜ê³  ìˆì–´ì•¼ í•©ë‹ˆë‹¤</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìì‹ ì˜ ë„ë©”ì¸ ë³€ìˆ˜ ì§€ì • : ì†Œìœ í•˜ê³  ìˆëŠ” ìì‹ ì˜ ë„ë©”ì¸ì„ ì…ë ¥í•˜ì‹œë©´ ë©ë‹ˆë‹¤</span>
<span class="c">#$ MyDomain=&lt;ìì‹ ì˜ ë„ë©”ì¸&gt;</span>
<span class="nv">$ MyDomain</span><span class="o">=</span>kans.loremipsum.sweetlittlebird.io
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export MyDomain=kans.loremipsum.sweetlittlebird.io"</span> <span class="o">&gt;&gt;</span> /etc/profile
  
<span class="c"># ìì‹ ì˜ Route 53 ë„ë©”ì¸ ID ì¡°íšŒ ë° ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ </span>aws route53 list-hosted-zones-by-name <span class="nt">--dns-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDomain</span><span class="k">}</span><span class="s2">."</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;HostedZones&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Id&amp;quot;: &amp;quot;/hostedzone/Z0416620XQJAGAPWXO31&amp;quot;,</span>
<span class="c">#          &amp;quot;Name&amp;quot;: &amp;quot;kans.loremipsum.sweetlittlebird.io.&amp;quot;,</span>
<span class="c">#          &amp;quot;CallerReference&amp;quot;: &amp;quot;3aba3324-d6a0-44a4-82b5-004044e06dd6&amp;quot;,</span>
<span class="c">#          &amp;quot;Config&amp;quot;: {</span>
<span class="c">#            &amp;quot;Comment&amp;quot;: &amp;quot;&amp;quot;,</span>
<span class="c">#            &amp;quot;PrivateZone&amp;quot;: false</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;ResourceRecordSetCount&amp;quot;: 3</span>
<span class="c">#        }</span>
<span class="c">#      ],</span>
<span class="c">#      &amp;quot;DNSName&amp;quot;: &amp;quot;kans.loremipsum.sweetlittlebird.io.&amp;quot;,</span>
<span class="c">#      &amp;quot;IsTruncated&amp;quot;: false,</span>
<span class="c">#      &amp;quot;MaxItems&amp;quot;: &amp;quot;100&amp;quot;</span>
<span class="c">#    }</span>
<span class="nv">$ </span>aws route53 list-hosted-zones-by-name <span class="nt">--dns-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDomain</span><span class="k">}</span><span class="s2">."</span> <span class="nt">--query</span> <span class="s2">"HostedZones[0].Name"</span>
<span class="c"># =&gt; &amp;quot;kans.loremipsum.sweetlittlebird.io.&amp;quot;</span>
<span class="nv">$ </span>aws route53 list-hosted-zones-by-name <span class="nt">--dns-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDomain</span><span class="k">}</span><span class="s2">."</span> <span class="nt">--query</span> <span class="s2">"HostedZones[0].Id"</span> <span class="nt">--output</span> text
<span class="c"># =&gt; /hostedzone/Z0416620XQJAGAPWXO31</span>
<span class="nv">$ MyDnzHostedZoneId</span><span class="o">=</span><span class="sb">`</span>aws route53 list-hosted-zones-by-name <span class="nt">--dns-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDomain</span><span class="k">}</span><span class="s2">."</span> <span class="nt">--query</span> <span class="s2">"HostedZones[0].Id"</span> <span class="nt">--output</span> text<span class="sb">`</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$MyDnzHostedZoneId</span>
<span class="c"># =&gt; /hostedzone/Z0416620XQJAGAPWXO31</span>
  
<span class="c"># (ì˜µì…˜) NS ë ˆì½”ë“œ íƒ€ì… ì²«ë²ˆì§¸ ì¡°íšŒ</span>
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--output</span> json <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'NS']"</span> | jq <span class="nt">-r</span> <span class="s1">'.[0].ResourceRecords[].Value'</span>
<span class="c"># =&gt; ns-979.awsdns-58.net.</span>
<span class="c">#    ns-1489.awsdns-58.org.</span>
<span class="c">#    ns-355.awsdns-44.com.</span>
<span class="c">#    ns-1760.awsdns-28.co.uk.</span>
<span class="c"># (ì˜µì…˜) A ë ˆì½”ë“œ íƒ€ì… ëª¨ë‘ ì¡°íšŒ</span>
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--output</span> json <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A']"</span>
<span class="c"># =&gt; []</span>
  
<span class="c"># A ë ˆì½”ë“œ íƒ€ì… ì¡°íšŒ</span>
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A']"</span> | jq
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A'].Name"</span> | jq
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A'].Name"</span> <span class="nt">--output</span> text
  
<span class="c"># A ë ˆì½”ë“œ ê°’ ë°˜ë³µ ì¡°íšŒ</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A']"</span> | jq <span class="p">;</span> <span class="nb">date</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
</code></pre></div>    </div>
  </li>
  <li>ExternalDNS ì„¤ì¹˜ - <a href="https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md">ë§í¬</a>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># EKS ë°°í¬ ì‹œ Node IAM Role ì„¤ì •ë˜ì–´ ìˆìŒ</span>
<span class="c"># eksctl create cluster ... --external-dns-access ...</span>
  
<span class="c"># </span>
<span class="c">#$ MyDomain=&lt;ìì‹ ì˜ ë„ë©”ì¸&gt;</span>
<span class="nv">$ MyDomain</span><span class="o">=</span>kans.loremipsum.sweetlittlebird.io
  
<span class="c"># ìì‹ ì˜ Route 53 ë„ë©”ì¸ ID ì¡°íšŒ ë° ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ MyDnzHostedZoneId</span><span class="o">=</span><span class="si">$(</span>aws route53 list-hosted-zones-by-name <span class="nt">--dns-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDomain</span><span class="k">}</span><span class="s2">."</span> <span class="nt">--query</span> <span class="s2">"HostedZones[0].Id"</span> <span class="nt">--output</span> text<span class="si">)</span>
  
<span class="c"># ë³€ìˆ˜ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$MyDomain</span>, <span class="nv">$MyDnzHostedZoneId</span>
<span class="c"># =&gt; kans.loremipsum.sweetlittlebird.io, /hostedzone/Z0416620XQJAGAPWXO31</span>
  
<span class="c"># ExternalDNS ë°°í¬</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-O</span> https://raw.githubusercontent.com/gasida/PKOS/main/aews/externaldns.yaml
<span class="nv">$ </span><span class="nb">cat </span>externaldns.yaml
<span class="nv">$ MyDomain</span><span class="o">=</span><span class="nv">$MyDomain</span> <span class="nv">MyDnzHostedZoneId</span><span class="o">=</span><span class="nv">$MyDnzHostedZoneId</span> envsubst &lt; externaldns.yaml | kubectl apply <span class="nt">-f</span> -
<span class="c"># =&gt; serviceaccount/external-dns created</span>
<span class="c">#    clusterrole.rbac.authorization.k8s.io/external-dns created</span>
<span class="c">#    clusterrolebinding.rbac.authorization.k8s.io/external-dns-viewer created</span>
<span class="c">#    deployment.apps/external-dns created</span>
  
<span class="c"># í™•ì¸ ë° ë¡œê·¸ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-l</span> app.kubernetes.io/name<span class="o">=</span>external-dns <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME                            READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    external-dns-648996678b-7r4mz   1/1     Running   0          12s</span>
<span class="nv">$ </span>kubectl logs deploy/external-dns <span class="nt">-n</span> kube-system <span class="nt">-f</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p>(ì°¸ê³ ) ê¸°ì¡´ì— ExternalDNSë¥¼ í†µí•´ ì‚¬ìš©í•œ A/TXT ë ˆì½”ë“œê°€ ìˆëŠ” ì¡´ì˜ ê²½ìš°ì— policy ì •ì±…ì„ upsert-only ë¡œ ì„¤ì • í›„ ì‚¬ìš© í•˜ì - <a href="https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md#deploy-externaldns">Link</a></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- <span class="c">#--policy=upsert-only # would prevent ExternalDNS from deleting any records, omit to enable full synchronization</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Service(<strong>NLB</strong>) + ë„ë©”ì¸ ì—°ë™(<strong>ExternalDNS</strong>) - <a href="https://www.whatsmydns.net/">ë„ë©”ì¸ì²´í¬</a>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„1 (ëª¨ë‹ˆí„°ë§)</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pod,svc'</span>
<span class="nv">$ </span>kubectl logs deploy/external-dns <span class="nt">-n</span> kube-system <span class="nt">-f</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:18:10Z&amp;quot; level=info msg=&amp;quot;Instantiating new Kubernetes client&amp;quot;</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:18:10Z&amp;quot; level=info msg=&amp;quot;Using inCluster-config based on serviceaccount-token&amp;quot;</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:18:10Z&amp;quot; level=info msg=&amp;quot;Created Kubernetes client https://10.100.0.1:443&amp;quot;</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:18:11Z&amp;quot; level=info msg=&amp;quot;Applying provider record filter for domains: [kans.loremipsum.sweetlittlebird.io. .kans.loremipsum.sweetlittlebird.io.]&amp;quot;</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:18:11Z&amp;quot; level=info msg=&amp;quot;All records are already up to date&amp;quot;</span>
<span class="c">#    ... (deployment ë°°í¬ í›„) ...</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:20:11Z&amp;quot; level=info msg=&amp;quot;Applying provider record filter for domains: [kans.loremipsum.sweetlittlebird.io. .kans.loremipsum.sweetlittlebird.io.]&amp;quot;</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:20:12Z&amp;quot; level=info msg=&amp;quot;Desired change: CREATE cname-tetris.kans.loremipsum.sweetlittlebird.io TXT&amp;quot; profile=default zoneID=/hostedzone/Z0416620XQJAGAPWXO31 zoneName=kans.loremipsum.sweetlittlebird.io.</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:20:12Z&amp;quot; level=info msg=&amp;quot;Desired change: CREATE tetris.kans.loremipsum.sweetlittlebird.io A&amp;quot; profile=default zoneID=/hostedzone/Z0416620XQJAGAPWXO31 zoneName=kans.loremipsum.sweetlittlebird.io.</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:20:12Z&amp;quot; level=info msg=&amp;quot;Desired change: CREATE tetris.kans.loremipsum.sweetlittlebird.io TXT&amp;quot; profile=default zoneID=/hostedzone/Z0416620XQJAGAPWXO31 zoneName=kans.loremipsum.sweetlittlebird.io.</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:20:12Z&amp;quot; level=info msg=&amp;quot;3 record(s) were successfully updated&amp;quot; profile=default zoneID=/hostedzone/Z0416620XQJAGAPWXO31 zoneName=kans.loremipsum.sweetlittlebird.io.</span>
  
<span class="c"># í…ŒíŠ¸ë¦¬ìŠ¤ ë””í”Œë¡œì´ë¨¼íŠ¸ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tetris
  labels:
    app: tetris
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tetris
  template:
    metadata:
      labels:
        app: tetris
    spec:
      containers:
      - name: tetris
        image: bsord/tetris
---
apiVersion: v1
kind: Service
metadata:
  name: tetris
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
    #service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "80"
spec:
  selector:
    app: tetris
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  type: LoadBalancer
  loadBalancerClass: service.k8s.aws/nlb
</span><span class="no">EOF
  
</span><span class="c"># ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep tetris
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/tetris   0/1     1            0           5s</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE           CLUSTER-IP      EXTERNAL-IP                                                                       PORT(S)        AGE</span>
<span class="c">#    service/tetris   LoadBalancer   10.100.39.204   k8s-default-tetris-4d2a39458c-e91cd840ce214644.elb.ap-northeast-2.amazonaws.com   80:32310/TCP   5s</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS   AGE</span>
<span class="c">#    endpoints/tetris   &amp;lt;none&amp;gt;      5s</span>
  
<span class="c"># NLBì— ExternanDNS ë¡œ ë„ë©”ì¸ ì—°ê²°</span>
<span class="nv">$ </span>kubectl annotate service tetris <span class="s2">"external-dns.alpha.kubernetes.io/hostname=tetris.</span><span class="nv">$MyDomain</span><span class="s2">"</span>
<span class="c"># =&gt; service/tetris annotated</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A']"</span> | jq <span class="p">;</span> <span class="nb">date</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; [</span>
<span class="c">#      {</span>
<span class="c">#        &amp;quot;Name&amp;quot;: &amp;quot;tetris.kans.loremipsum.sweetlittlebird.io.&amp;quot;,</span>
<span class="c">#        &amp;quot;Type&amp;quot;: &amp;quot;A&amp;quot;,</span>
<span class="c">#        &amp;quot;AliasTarget&amp;quot;: {</span>
<span class="c">#          &amp;quot;HostedZoneId&amp;quot;: &amp;quot;ZIBE1TIR4HY56&amp;quot;,</span>
<span class="c">#          &amp;quot;DNSName&amp;quot;: &amp;quot;k8s-default-tetris-4d2a39458c-e91cd840ce214644.elb.ap-northeast-2.amazonaws.com.&amp;quot;,</span>
<span class="c">#          &amp;quot;EvaluateTargetHealth&amp;quot;: true</span>
<span class="c">#        }</span>
<span class="c">#      }</span>
<span class="c">#    ]</span>
<span class="c">#    Sat Oct  1 23:21:27 KST 2024</span>
<span class="c">#    ...</span>
  
<span class="c"># Route53ì— Aë ˆì½”ë“œ í™•ì¸</span>
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A']"</span> | jq
<span class="c"># =&gt; [</span>
<span class="c">#      {</span>
<span class="c">#        &amp;quot;Name&amp;quot;: &amp;quot;tetris.kans.loremipsum.sweetlittlebird.io.&amp;quot;,</span>
<span class="c">#        &amp;quot;Type&amp;quot;: &amp;quot;A&amp;quot;,</span>
<span class="c">#        &amp;quot;AliasTarget&amp;quot;: {</span>
<span class="c">#          &amp;quot;HostedZoneId&amp;quot;: &amp;quot;ZIBE1TIR4HY56&amp;quot;,</span>
<span class="c">#          &amp;quot;DNSName&amp;quot;: &amp;quot;k8s-default-tetris-4d2a39458c-e91cd840ce214644.elb.ap-northeast-2.amazonaws.com.&amp;quot;,</span>
<span class="c">#          &amp;quot;EvaluateTargetHealth&amp;quot;: true</span>
<span class="c">#        }</span>
<span class="c">#      }</span>
<span class="c">#    ]</span>
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A'].Name"</span> | jq .[]
<span class="c"># =&gt; &amp;quot;tetris.kans.loremipsum.sweetlittlebird.io.&amp;quot;</span>
  
<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>dig +short tetris.<span class="nv">$MyDomain</span> @8.8.8.8
<span class="c"># =&gt; 3.38.82.70</span>
<span class="c">#    3.36.187.152</span>
<span class="c">#    3.35.184.161</span>
<span class="nv">$ </span>dig +short tetris.<span class="nv">$MyDomain</span>
<span class="c"># =&gt; 3.38.82.70</span>
  
<span class="c"># ë„ë©”ì¸ ì²´í¬</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"My Domain Checker = https://www.whatsmydns.net/#A/tetris.</span><span class="nv">$MyDomain</span><span class="s2">"</span>
<span class="c"># =&gt; My Domain Checker = https://www.whatsmydns.net/#A/tetris.kans.loremipsum.sweetlittlebird.io</span>
  
<span class="c"># ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸ ë° ì ‘ì†</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Tetris Game URL = http://tetris.</span><span class="nv">$MyDomain</span><span class="s2">"</span>
<span class="c"># =&gt; Tetris Game URL = http://tetris.kans.loremipsum.sweetlittlebird.io</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p>ì›¹ ì ‘ì†(http) â†’ í™”ì‚´í‘œí‚¤, ì¼ì‹œì¤‘ì§€(space bar)</p>

        <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_35.png" alt="img.png" class="image-center" /></p>
      </li>
    </ul>
  </li>
  <li>
    <p>Ingress(ALB + HTTPS) + ë„ë©”ì¸ ì—°ë™(ExternalDNS)</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í…ŒíŠ¸ë¦¬ìŠ¤ ë””í”Œë¡œì´ë¨¼íŠ¸ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tetris
  labels:
    app: tetris
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tetris
  template:
    metadata:
      labels:
        app: tetris
    spec:
      containers:
      - name: tetris
        image: bsord/tetris
---
apiVersion: v1
kind: Service
metadata:
  name: tetris
  labels:
    app: tetris
spec:
  selector:
    app: tetris
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  type: LoadBalancer
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tetris-ingress
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:123456789012:certificate/256538f4-6c5d-4109-9d4d-9aa6af41adaa
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'
spec:
  ingressClassName: alb
  rules:
    - http:
        paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: tetris
              port:
                number: 80  
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/tetris created</span>
<span class="c">#    service/tetris created</span>
<span class="c">#    ingress.networking.k8s.io/tetris-ingress created</span>
  
<span class="c"># ingressì— ë„ë©”ì¸ ë¶€ì—¬</span>
<span class="nv">$ </span>kubectl annotate ingress tetris-ingress <span class="s2">"external-dns.alpha.kubernetes.io/hostname=tetris2.</span><span class="nv">$MyDomain</span><span class="s2">"</span>
<span class="c"># =&gt; ingress.networking.k8s.io/tetris-ingress annotated</span>
  
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê¸°ì¡´ì— ì‚¬ìš©í–ˆë˜ ë„ë©”ì¸(tetris.$MyDomain)ì„ ì‚¬ìš©í•˜ë©´ DNS ë ˆì½”ë“œê°€ ì „íŒŒë˜ëŠ”ë° ì‹œê°„ì´ ë” ê±¸ë¦¬ê¸° ë•Œë¬¸ì—&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ë‹¤ë¥¸ ë„ë©”ì¸ (tetris2.$MyDomain)ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div>    </div>

    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_36.png" alt="img.png" class="image-center" />
<em class="image-caption">dns ì ìš© í™•ì¸ (<a href="https://www.whatsmydns.net/">í™•ì¸ ì‚¬ì´íŠ¸ ë§í¬</a>)</em></p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">https://tetris2.kans.loremipsum.sweetlittlebird.io</code> ë¡œ ì ‘ì†í•˜ì—¬ https í†µì‹  í™•ì¸
<img src="/assets/2024/kans-3th/w9/20241102_kans_w9_37.png" alt="img.png" class="image-center" />
<em class="image-caption">https ì ìš© í™•ì¸</em></li>
    </ul>
  </li>
  <li><strong>ë¦¬ì†ŒìŠ¤ ì‚­ì œ</strong> : <code class="language-plaintext highlighter-rouge">kubectl delete deploy,svc tetris</code> â† ì‚­ì œ ì‹œ externaldns ì— ì˜í•´ì„œ Aë ˆì½”ë“œë„ ê°™ì´ ì‚­ì œë©ë‹ˆë‹¤.</li>
</ul>

<ul>
  <li>
    <p>(ì°¸ê³ ) ACM í¼ë¸”ë¦­ ì¸ì¦ì„œ ìš”ì²­ ë° í•´ë‹¹ ì¸ì¦ì„œì— ëŒ€í•œ Route53 ë„ë©”ì¸ ê²€ì¦ ì„¤ì • with AWS CLI</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ê°ì ìì‹ ì˜ ë„ë©”ì¸ ë³€ìˆ˜ ì§€ì •</span>
<span class="c">#$ MyDomain=&lt;ê°ì ìì‹ ì˜ ë„ë©”ì¸&gt;</span>
<span class="nv">$ MyDomain</span><span class="o">=</span>kans.loremipsum.sweetlittlebird.io
  
<span class="c"># ACM í¼ë¸”ë¦­ ì¸ì¦ì„œ ìš”ì²­</span>
<span class="nv">$ CERT_ARN</span><span class="o">=</span><span class="si">$(</span>aws acm request-certificate <span class="se">\</span>
  <span class="nt">--domain-name</span> <span class="nv">$MyDomain</span> <span class="se">\</span>
  <span class="nt">--validation-method</span> <span class="s1">'DNS'</span> <span class="se">\</span>
  <span class="nt">--key-algorithm</span> <span class="s1">'RSA_2048'</span> <span class="se">\</span>
  | jq <span class="nt">--raw-output</span> <span class="s1">'.CertificateArn'</span><span class="si">)</span>
  
<span class="c"># ìƒì„±í•œ ì¸ì¦ì„œ CNAME ì´ë¦„ ê°€ì ¸ì˜¤ê¸°</span>
<span class="nv">$ CnameName</span><span class="o">=</span><span class="si">$(</span>aws acm describe-certificate <span class="se">\</span>
  <span class="nt">--certificate-arn</span> <span class="nv">$CERT_ARN</span> <span class="se">\</span>
  <span class="nt">--query</span> <span class="s1">'Certificate.DomainValidationOptions[*].ResourceRecord.Name'</span> <span class="se">\</span>
  <span class="nt">--output</span> text<span class="si">)</span>
  
<span class="c"># ìƒì„±í•œ ì¸ì¦ì„œ CNAME ê°’ ê°€ì ¸ì˜¤ê¸°</span>
<span class="nv">$ CnameValue</span><span class="o">=</span><span class="si">$(</span>aws acm describe-certificate <span class="se">\</span>
  <span class="nt">--certificate-arn</span> <span class="nv">$CERT_ARN</span> <span class="se">\</span>
  <span class="nt">--query</span> <span class="s1">'Certificate.DomainValidationOptions[*].ResourceRecord.Value'</span> <span class="se">\</span>
  <span class="nt">--output</span> text<span class="si">)</span>
  
<span class="c"># ì •ìƒ ì¶œë ¥ í™•ì¸í•˜ê¸°</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CERT_ARN</span>, <span class="nv">$CnameName</span>, <span class="nv">$CnameValue</span>
<span class="c"># =&gt; arn:aws:acm:ap-northeast-2:123456789012:certificate/256538f4-6c5d-4109-9d4d-9aa6af41adaa, _e784949706a5e6eee7f350436cc9d501.kans.loremipsum.sweetlittlebird.io., _e62ee6e59a48ea2f3d1ab952d289bcea.djqtsrsxkq.acm-validations.aws.</span>
  
<span class="c"># ë ˆì½”ë“œ íŒŒì¼</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; cname.json
{
  "Comment": "create a acm's CNAME record",
  "Changes": [
    {
      "Action": "CREATE",
      "ResourceRecordSet": {
        "Name": "CnameName",
        "Type": "CNAME",
        "TTL": 300,
        "ResourceRecords": [
          {
            "Value": "CnameValue"
          }
        ]
      }
    }
  ]
}
</span><span class="no">EOT
  
</span><span class="c"># CNAME ì´ë¦„, ê°’ ì¹˜í™˜í•˜ê¸°</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/CnameName/</span><span class="nv">$CnameName</span><span class="s2">/g"</span> cname.json
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/CnameValue/</span><span class="nv">$CnameValue</span><span class="s2">/g"</span> cname.json
<span class="nv">$ </span><span class="nb">cat </span>cname.json
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;Comment&amp;quot;: &amp;quot;create a acm's CNAME record&amp;quot;,</span>
<span class="c">#      &amp;quot;Changes&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Action&amp;quot;: &amp;quot;CREATE&amp;quot;,</span>
<span class="c">#          &amp;quot;ResourceRecordSet&amp;quot;: {</span>
<span class="c">#            &amp;quot;Name&amp;quot;: &amp;quot;_e784949706a5e6eee7f350436cc9d501.kans.loremipsum.sweetlittlebird.io.&amp;quot;,</span>
<span class="c">#            &amp;quot;Type&amp;quot;: &amp;quot;CNAME&amp;quot;,</span>
<span class="c">#            &amp;quot;TTL&amp;quot;: 300,</span>
<span class="c">#            &amp;quot;ResourceRecords&amp;quot;: [</span>
<span class="c">#              {</span>
<span class="c">#                &amp;quot;Value&amp;quot;: &amp;quot;_e62ee6e59a48ea2f3d1ab952d289bcea.djqtsrsxkq.acm-validations.aws.&amp;quot;</span>
<span class="c">#              }</span>
<span class="c">#            ]</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
  
<span class="c"># í•´ë‹¹ ì¸ì¦ì„œì— ëŒ€í•œ Route53 ë„ë©”ì¸ ê²€ì¦ ì„¤ì •ì„ ìœ„í•œ Route53 ë ˆì½”ë“œ ìƒì„±</span>
<span class="nv">$ </span>aws route53 change-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="nv">$MyDnzHostedZoneId</span> <span class="nt">--change-batch</span> file://cname.json
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="ì‹¤ìŠµ-ì™„ë£Œ-í›„-ìì›-ì‚­ì œ">ì‹¤ìŠµ ì™„ë£Œ í›„ ìì› ì‚­ì œ</h3>

<ul>
  <li>ì‚­ì œ : ì¥ì (1ì¤„ ëª…ë ¹ì–´ë¡œ ì™„ì „ ì‚­ì œ), ë‹¨ì (ì‚­ì œ ì‹¤í–‰ê³¼ ì™„ë£Œê¹Œì§€ SSH ì„¸ì…˜ ìœ ì§€ í•„ìš”)
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>eksctl delete cluster <span class="nt">--name</span> <span class="nv">$CLUSTER_NAME</span> <span class="o">&amp;&amp;</span> aws cloudformation delete-stack <span class="nt">--stack-name</span> <span class="nv">$CLUSTER_NAME</span>
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì™€.. ë“œë””ì–´ ë§ˆì§€ë§‰ ì£¼ì°¨ì¸ 9ì£¼ì°¨ ê³¼ì œë¥¼ ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤.
ë§ˆì§€ë§‰ ì£¼ì°¨ì¸ ë§Œí¼ ê³¼ì œë¥¼ ë¹¨ë¦¬ ë§ˆì¹˜ê³  ì‹¶ì—ˆì§€ë§Œ, ìƒê°ë³´ë‹¤ ì‹œê°„ì´ ë§ì´ ê±¸ë ¤ì„œ ê²°êµ­ ì˜¤ëŠ˜ë„ ìì •ì„ ë„˜ê¸´ ì¼ìš”ì¼ì…ë‹ˆë‹¤. :cry:
ë§¤ê³¼ì œë§ˆë‹¤ ì €ë„ ì‹œê°„ì„ ë§ì´ ìŸì§€ë§Œ, ê°€ì‹œë‹¤ ë‹˜ì„ ë¹„ë¡¯í•˜ì—¬ ìŠ¤í„°ë”” ì¡°ë ¥ìë¶„ë“¤ì´ ì´ ìŠ¤í„°ë””ë¥¼ ìœ„í•´ ì§€ê¸ˆê¹Œì§€ ì–¼ë§ˆë‚˜ ë§ì€ ì‹œê°„ì„ íˆ¬ìí•˜ì…¨ì„ì§€
ìƒê°í•˜ë©´ ìŠ¤ìŠ¤ë¡œê°€ ë¨¸ì“±í•˜ë©´ì„œë„, ê°ì‚¬í•¨ê³¼ ì¡´ê²½ì‹¬ì„ ëŠë‚ë‹ˆë‹¤.</p>

<p>ì´ë²ˆ ìŠ¤í„°ë””ë¥¼ í†µí•´ ë§ì€ ê²ƒì„ ë°°ì› ê³ , ë¸”ë¡œê·¸ë¥¼ ì‘ì„±í•˜ëŠ”ë° ìˆì–´ì„œë„ ë§ì€ ë„ì›€ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.
íšŒì‚¬ì—ì„œ í•„ìš”í•œ ê¸€ë§Œ ì“°ë‹¤ê°€, ì •ë§ ì˜¤ëœë§Œì— ê°œì¸ì„ ìœ„í•œ ê¸€ë„ ì´ë ‡ê²Œ ê¾¸ì¤€íˆ ì“´ê²ƒë„ ì°¸ ì˜¤ëœë§Œì…ë‹ˆë‹¤. 
ì§€ë‚œ í…Œë¼í¼ ìŠ¤í„°ë””ë¶€í„° í•˜ë©´ 5ê°œì›” ì •ë„ëŠ” ê±°ì˜ ë§¤ì£¼ ê¸€ì„ ì¼ë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤. 
â€”ë¬¼ë¡  ì‹¤ìŠµ ìœ„ì£¼ì—¬ì„œ â€œê¸€â€ì„ ì“´ê²Œ ë§ëƒëŠ” ë¬¸ì œê°€ ìˆê¸´í•©ë‹ˆë‹¤.â€” 
ì˜ˆì „ì—ëŠ” ì •ë§ ì‹œë¥ì–ì€ ë¸”ë¡œê·¸ ê¸€ë„ ë§ì´ ì¼ì—ˆëŠ”ë°, ë‚˜ì´ë„ ë“¤ê³ , ì‚¬íšŒì  ì§€ìœ„ë„ (ì•„ì§ì€ ë‚®ì§€ë§Œ ì˜ˆì „ë³´ë‹¤) ë†’ì•„ì§€ë‹¤ë³´ë‹ˆ
ê¸€ì„ ì“°ëŠ”ë° ìˆì–´ì„œë„ ì¡°ê¸ˆì€ ë¶€ë‹´ì´ ë˜ì—ˆì—ˆëŠ”ë°, ì´ë²ˆ ìŠ¤í„°ë””ë¥¼ í†µí•´ ë‹¤ì‹œ ê¸€ì„ ì“°ëŠ” ì¬ë¯¸ì™€ ê¸€ì„ ì“¸ ìˆ˜ ìˆë‹¤ëŠ” ìì‹ ê°ì„ ëŠë¼ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
ì•ìœ¼ë¡œë„ ìŠ¤í„°ë””ê°€ ì•„ë‹ˆë”ë¼ë„ ê¾¸ì¤€íˆ ê¸€ì„ ì“°ê³  ì‹¶ìŠµë‹ˆë‹¤.</p>

<p>ì•½ 3ê°œì›” ê°„ ìŠ¤í„°ë””ë¥¼ ì˜ ì´ëŒì–´ì£¼ì‹  ê°€ì‹œë‹¤ ë‹˜ê³¼ ì¡°ë ¥ì ë¶„ë“¤ê»˜ í° ê°ì‚¬ë¥¼ ë“œë¦½ë‹ˆë‹¤. :bow:</p>

<p>ìŠ¤í„°ë””ì— ì°¸ì—¬í•˜ì‹  ëª¨ë“  ë¶„ë“¤ë„ ê³ ìƒ ë§ìœ¼ì…¨ìŠµë‹ˆë‹¤. ë‹¤ìŒì— ë˜ ëµ ìˆ˜ ìˆê¸°ë¥¼ ê¸°ëŒ€í•©ë‹ˆë‹¤. :smile:</p>]]></content><author><name></name></author><category term="kans" /><category term="kubernetes," /><category term="network," /><category term="linux" /><summary type="html"><![CDATA[ì´ë²ˆ ì£¼ì—ëŠ” AWS EKSì˜ VPC CNIì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[KANS 3ê¸°] Cilium CNI</title><link href="https://sweetlittlebird.github.io/posts/2024-10-26-KANS-Study-Week8/" rel="alternate" type="text/html" title="[KANS 3ê¸°] Cilium CNI" /><published>2024-10-26T01:00:18+09:00</published><updated>2024-10-26T01:00:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/KANS%20Study%20-%20Week8</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2024-10-26-KANS-Study-Week8/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆì£¼ì—ëŠ” ë“œë””ì–´ CNIì˜ ëíŒ ì™•(ì œê°€ ì•„ëŠ” í•œì—ì„œ)ì¸ Ciliumì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
ì–´ë–¤ ê²ƒë“¤ì´ ê°€ëŠ¥í• ì§€ ê¶ê¸ˆí•©ë‹ˆë‹¤. 
KANS 3ê¸° 8ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="cilium">Cilium</h2>

<p>Ciliumì€ eBPF(Berkeley Packet Filter)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ë° ë¼ìš°íŒ…ì„ ì œê³µí•˜ëŠ” CNI(Container Network Interface) í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.
ë¨¼ì € Ciliumì˜ ê·¼ê°„ì´ ë˜ëŠ” eBPFì— ëŒ€í•´ ê°„ë‹¨íˆ ì†Œê°œí•˜ê³ , Ciliumì— ëŒ€í•œ ì†Œê°œì™€ ì‹¤ìŠµì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h3 id="bpfebpf-ì†Œê°œ">BPF/eBPF ì†Œê°œ</h3>

<ul>
  <li>ì†Œê°œê¸€ : <a href="https://hyeyoo.com/133">ë§í¬</a></li>
</ul>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_1.png" alt="img.png" class="image-center" />
<em class="image-caption">ê¸°ì¡´ ë¦¬ëˆ…ìŠ¤ Netfilter ê¸°ë°˜ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒ</em></p>

<p>ê¸°ì¡´ì˜ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì€ Netfilter ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ë©°, ë³µì¡í•œ ë„¤íŠ¸ì›Œí¬ ë ˆì´ì–´ë¥¼ ê±°ì³ì•¼í•˜ê³  ì´ ë ˆì´ì–´ë¥¼ ê±´ë„ˆë›°ê¸° ì–´ë µìŠµë‹ˆë‹¤.
ë˜í•œ kube-proxyì™€ ê°™ì€ userland í”„ë¡œì„¸ìŠ¤ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. 
ê·¸ëŸ¬ë‹¤ë³´ë‹ˆ ì˜¤ë²„í—¤ë“œê°€ ì»¤ì ¸ì„œ ì„±ëŠ¥ì´ ë–¨ì–´ì§€ê³ , ë£°ì´ ë³µì¡í•´ì§ˆ ê²½ìš° ìˆ˜ ë§ì€ ë£°ì„ ê´€ë¦¬í•´ì•¼í•˜ëŠ” ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_2.png" alt="img_1.png" class="image-center" />
<em class="image-caption">eBPF ê¸°ë°˜ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒ</em></p>

<p>eBPFëŠ” ì»¤ë„ ë‚´ë¶€ì—ì„œ ë™ì‘í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
íŠ¹íˆ ìƒŒë“œë°•ìŠ¤ ë°©ì‹ì„ í†µí•´ eBPF í”„ë¡œê·¸ë¨ì´ ì»¤ë„ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šë„ë¡ ë³´í˜¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
ì¦‰, eBPF í”„ë¡œê·¸ë¨ì´ ì˜ëª»ëœ ë™ì‘ì„ í•˜ë”ë¼ë„ ì»¤ë„ íŒ¨ë‹‰ë“±ì˜ ë°œìƒì´ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤.</p>

<p>ë˜í•œ XDP(eXpress Data Path)ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìœ¼ë©°, 
ì´ XDPëŠ” ë„¤íŠ¸ì›Œí¬ ì¹´ë“œ(Offloaded mode), ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„(Native mode), ì»¤ë„ ìŠ¤í˜ì´ìŠ¤(Generic Mode)ì—ì„œ
ë™ì‘í•˜ì—¬ í›¨ì”¬ ë¹ ë¥´ê²Œ íŒ¨í‚·ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_3.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">iptablesì™€ eBPF ì„±ëŠ¥ ë¹„êµ</em></p>

<ul>
  <li>eBPF í™œìš©ì²˜
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_4.png" alt="img.png" class="image-center w-80" />
    <ul>
      <li><strong>Security</strong> (ë³´ì•ˆ) : eBPFëŠ” í•˜ë“œì›¨ì–´ ë ˆë²¨ì—ì„œ ë¶€í„° ëª¨ë“  ì‹œìŠ¤í…œ ì½œì„ ì´í•´í•˜ê³  ì²˜ë¦¬í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë³´ë‹¤ ë” ì„¸ë°€í•˜ê³  ê°•ë ¥í•œ ë³´ì•ˆ ì •ì±…ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>Tracing &amp; Profiling</strong> (ì¶”ì  ë° í”„ë¡œíŒŒì¼ë§) : eBPFëŠ” ì»¤ë„ ë‚´ë¶€ì˜ ëª¨ë“  ì´ë²¤íŠ¸ë¥¼ ì¶”ì í•˜ê³  í”„ë¡œíŒŒì¼ë§ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ì¡´ì— í•´ê²°í•˜ê¸° ì–´ë ¤ì› ë˜ ì„±ëŠ¥ ë¬¸ì œë“¤ë„ eBPFë¥¼ í†µí•´ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>Networking</strong> (ë„¤íŠ¸ì›Œí‚¹) : eBPFëŠ” ì»¤ë„ ìŠ¤í˜ì´ìŠ¤ë¥¼ ë– ë‚˜ì§€ ì•Šê³  ìƒˆë¡œìš´ í”„ë¡œí† ì½œì„ ë§Œë“ ë‹¤ë˜ì§€, ë¼ìš°íŒ…ì„ êµ¬í˜„í•˜ëŠ” ë“±ì˜ ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ ê¸°ëŠ¥ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>Observability</strong> (ê°€ì‹œì„±) : ì»¤ë„ë‚´ë¶€ì—ì„œ ë‹¤ì–‘í•œ ì†ŒìŠ¤ì—ì„œ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ê³ , ì²˜ë¦¬í•  ìˆ˜ ìˆê³ , ì¼ë¶€ ë°ì´í„°ë§Œ ìƒ˜í”Œë§í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ëª¨ë“  ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="cilium-ì†Œê°œ">Cilium ì†Œê°œ</h3>

<ul>
  <li><strong>Cilium</strong>ì€ ê¸°ì¡´ì˜ ë³µì¡í•œ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ <strong>eBPF</strong>ë¥¼ í†µí•´ <strong>ê°„ì†Œí™”</strong>í•˜ê³ , <strong>ë¹ ë¥´ê²Œ ì²˜ë¦¬</strong>í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” CNI í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_5.png" alt="img.png" class="image-center w-80" />
<em class="image-caption"><a href="https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/">https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/</a></em></p>

<ul>
  <li>Cilium eBPFëŠ” ì¶”ê°€ì ì¸ ì½”ë“œ ìˆ˜ì •ì´ë‚˜ ì„¤ì • ë³€ê²½ì—†ì´, ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ ë™ì‘í•˜ëŠ” Bytecodeë¥¼ ììœ ë¡­ê²Œ í”„ë¡œê·¸ë˜ë°í•˜ì—¬ ì»¤ë„ì— ë¡œë”©ì‹œì¼œ ë™ì‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. <a href="https://www.youtube.com/watch?v=qsnR-s4XuGo&amp;t=1059s">ë§í¬</a></li>
  <li>ë˜í•œ eBPFëŠ” ëª¨ë“  íŒ¨í‚·ì„ ê°€ë¡œì±„ê¸° ìœ„í•´ì„œ ìˆ˜ì‹  NICì˜ ingress TC(<a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/">Traffic Control</a>) hooksë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_6.png" alt="img.png" class="image-center w-60" />
<em class="image-caption">NICì˜ TC Hooksì— eBPF í”„ë¡œê·¸ë¨ì´ attach ëœ ì˜ˆ</em></li>
  <li>Ciliumì€ í„°ë„ëª¨ë“œ(VXLAN, GENEVE), ë„¤ì´í‹°ë¸Œ ë¼ìš°íŒ… ëª¨ë“œì˜ 2ê°€ì§€ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.
    <ul>
      <li><strong>í„°ë„ëª¨ë“œ</strong> : Ciliumì´ VXLAN(UDP 8472), GENEVE(UDP 6081) ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ ì´ë“¤ì„ í†µí•´ íŠ¸ë˜í”½ì„ ì „ë‹¬í•©ë‹ˆë‹¤. Encapsulation ëª¨ë“œë¼ê³ ë„ í•©ë‹ˆë‹¤.</li>
      <li><strong>ë„¤ì´í‹°ë¸Œ ë¼ìš°íŒ… ëª¨ë“œ</strong> : Ciliumê°€ íŒ¨í‚· ì „ë‹¬ì„ ìœ„í•´ êµ¬ì„±ì„ ë³€ê²½í•˜ì§€ ì•Šê³ , ì™¸ë¶€ì—ì„œ ì œê³µë˜ëŠ” íŒ¨í‚· ì „ë‹¬ ë°©ë²•(í´ë¼ìš°ë“œ ë˜ëŠ” BGP ë¼ìš°íŒ…ë“±)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. Direct Routing ëª¨ë“œë¼ê³ ë„ í•©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_7.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">Cilium ë„¤íŠ¸ì›Œí¬ ëª¨ë“œ - <a href="https://docs.cilium.io/en/stable/network/concepts/routing/">ë§í¬</a></em></li>
    </ul>
  </li>
  <li>2021ë…„ 10ì›” Ciliumì€ CNCFì— ì±„íƒë˜ì—ˆìŠµë‹ˆë‹¤. <a href="https://cilium.io/blog/2021/10/13/cilium-joins-cncf/">ë§í¬</a></li>
  <li>Googke GKE dataplaneê³¼ AWS EKS Anywhereì—ì„œ ê¸°ë³¸ CNIë¡œ Ciliumì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. <a href="https://isovalent.com/blog/post/2021-09-aws-eks-anywhere-chooses-cilium/">ë§í¬</a></li>
  <li>Ciliumì€ Kube-Proxyë¥¼ 100% ëŒ€ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    <ul>
      <li>iptablesë¥¼ ê±°ì˜ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ ë™ì‘í•˜ë©°, ì´ë¥¼ í†µí•´ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>í•˜ì§€ë§Œ istio, FHRP, VRRP ë“±ê³¼ ê°™ì´ iptables ê¸°ëŠ¥ì„ í™œìš©í•˜ëŠ” ë™ì‘ë“¤ì€ ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©°, ì°¨ì¸° í•´ê²°í•´ ë‚˜ê°€ê³  ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h4 id="cilium-ì•„í‚¤í…ì³">Cilium ì•„í‚¤í…ì³</h4>

<ul>
  <li>êµ¬ì„±ìš”ì†Œ - <a href="https://ssup2.github.io/blog-software/docs/theory-analysis/kubernetes-cilium-plugin/">ë§í¬</a>
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_8.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">Cilium ì•„í‚¤í…ì³ - <a href="https://github.com/cilium/cilium">ì¶œì²˜</a></em>
    <ul>
      <li>Cilium <strong>Agent</strong> : ë°ëª¬ì…‹ìœ¼ë¡œ ì‹¤í–‰, K8S API ì„¤ì •ìœ¼ë¡œ ë¶€í„° â€˜ë„¤íŠ¸ì›Œí¬ ì„¤ì •, ë„¤íŠ¸ì›Œí¬ ì •ì±…, ì„œë¹„ìŠ¤ ë¶€í•˜ë¶„ì‚°, ëª¨ë‹ˆí„°ë§â€™ ë“±ì„ ìˆ˜í–‰í•˜ë©°, eBPF í”„ë¡œê·¸ë¨ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
      <li>Cilium <strong>Client</strong> (CLI) : Cilium ì»¤ë©˜ë“œíˆ´ë¡œ eBPF maps ì— ì§ì ‘ ì ‘ì†í•˜ì—¬ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>Cilium <strong>Operator</strong> : K8S í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ í•œ ë²ˆì”© ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ì‘ì—…ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
      <li><strong>Hubble</strong> : ë„¤íŠ¸ì›Œí¬ì™€ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ í”Œë«í¼ ì—­í• ì„ í•˜ì—¬, Server, Relay, Client, Graphical UI ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>Data Store</strong> : Cilium Agent ê°„ì˜ ìƒíƒœë¥¼ ì €ì¥í•˜ê³  ì „íŒŒí•˜ëŠ” ë°ì´í„° ì €ì¥ì†Œ, 2ê°€ì§€ ì¢…ë¥˜ ì¤‘ ì„ íƒ(K8S CRDs, Key-Value Store)í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="cilium-ì‹¤ìŠµ">Cilium ì‹¤ìŠµ</h3>

<p>ì‹¤ìŠµì„ í†µí•´ Cilium CNIì— ëŒ€í•´ì„œ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤. ë¨¼ì € Ciliumì„ ì„¤ì¹˜í•˜ê³ , ê¸°ë³¸ì ì¸ ì„¤ì •ì„ í™•ì¸í•˜ê³ , ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ì„¤ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h4 id="cilium-ì„¤ì¹˜">Cilium ì„¤ì¹˜</h4>

<h5 id="helmì„-í†µí•œ-ì„¤ì¹˜-ë°-í™•ì¸">Helmì„ í†µí•œ ì„¤ì¹˜ ë° í™•ì¸</h5>

<ul>
  <li>helm ì˜µì…˜ : <a href="https://docs.cilium.io/en/stable/helm-reference/">https://docs.cilium.io/en/stable/helm-reference/</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get node,pod <span class="nt">-A</span> <span class="nt">-owide</span>

<span class="c">#</span>
<span class="nv">$ </span>helm repo add cilium https://helm.cilium.io/
<span class="c"># =&gt; &amp;quot;cilium&amp;quot; has been added to your repositories</span>
<span class="nv">$ </span>helm repo update
<span class="c"># =&gt; ...Successfully got an update from the &amp;quot;cilium&amp;quot; chart repository</span>
<span class="c">#    Update Complete. âˆHappy Helming!âˆ</span>

<span class="c">#</span>
<span class="nv">$ </span>helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> 1.16.3 <span class="nt">--namespace</span> kube-system <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.10 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">rollOutCiliumPods</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.hostRouting<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> endpointRoutes.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> ipam.mode<span class="o">=</span>kubernetes <span class="nt">--set</span> k8s.requireIPv4PodCIDR<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>192.168.0.0/16 <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns:query;ignoreAAAA,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.replicas<span class="o">=</span>1
<span class="c"># =&gt; NAME: cilium</span>
<span class="c">#    LAST DEPLOYED: Sat Oct 01 07:23:34 2024</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    You have successfully installed Cilium with Hubble Relay and Hubble UI.</span>
<span class="c">#    </span>
<span class="c">#    Your release version is 1.16.3.</span>
<span class="c">#    </span>
<span class="c">#    For any further help, visit https://docs.cilium.io/en/v1.16/gettinghelp</span>

<span class="c">## ì£¼ìš” íŒŒë¼ë¯¸í„° ì„¤ëª…</span>
<span class="c"># --set debug.enabled=true # cilium íŒŒë“œì— ë¡œê·¸ ë ˆë²¨ì„ debug ì„¤ì •</span>
<span class="c"># --set autoDirectNodeRoutes=true # ë™ì¼ ëŒ€ì—­ ë‚´ì˜ ë…¸ë“œë“¤ ë¼ë¦¬ëŠ” ìƒëŒ€ ë…¸ë“œì˜ podCIDR ëŒ€ì—­ì˜ ë¼ìš°íŒ…ì´ ìë™ìœ¼ë¡œ ì„¤ì •</span>
<span class="c"># --set endpointRoutes.enabled=true # í˜¸ìŠ¤íŠ¸ì— endpoint(íŒŒë“œ)ë³„ ê°œë³„ ë¼ìš°íŒ… ì„¤ì •</span>
<span class="c"># --set hubble.relay.enabled=true --set hubble.ui.enabled=true # hubble í™œì„±í™”</span>
<span class="c"># --set ipam.mode=kubernetes --set k8s.requireIPv4PodCIDR=true # k8s IPAM í™œìš©</span>
<span class="c"># --set kubeProxyReplacement=true # kube-proxy ì—†ì´ (ìµœëŒ€í•œ) ëŒ€ì²˜í• ìˆ˜ ìˆìˆ˜ ìˆê²Œ</span>
<span class="c"># --set ipv4NativeRoutingCIDR=192.168.0.0/16 # í•´ë‹¹ ëŒ€ì—­ê³¼ í†µì‹  ì‹œ IP Masq í•˜ì§€ ì•ŠìŒ, ë³´í†µ ì‚¬ë‚´ë§ ëŒ€ì—­ì„ ì§€ì •</span>
<span class="c"># --set operator.replicas=1 # cilium-operator íŒŒë“œ ê¸°ë³¸ 1ê°œ</span>
<span class="c"># --set enableIPv4Masquerade=true --set bpf.masquerade=true # íŒŒë“œë¥¼ ìœ„í•œ Masquerade , ì¶”ê°€ë¡œ Masquerade ì„ BPF ë¡œ ì²˜ë¦¬ &gt;&gt; enableIPv4Masquerade=true ì¸ ìƒíƒœì—ì„œ ì¶”ê°€ë¡œ bpf.masquerade=true ì ìš©ì´ ê°€ëŠ¥</span>

<span class="c"># ì„¤ì • ë° í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    4: cilium_net@cilium_host: &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether 3a:03:2f:7e:cc:72 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::3803:2fff:fe7e:cc72/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    5: cilium_host@cilium_net: &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether ca:73:d2:a6:00:b4 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 172.16.0.227/32 scope global cilium_host</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::c873:d2ff:fea6:b4/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get node,pod,svc <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAME          STATUS   ROLES                  AGE     VERSION        INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION       CONTAINER-RUNTIME</span>
<span class="c">#    node/k3s-m    Ready    control-plane,master   3h58m   v1.30.5+k3s1   192.168.10.10    &amp;lt;none&amp;gt;        Ubuntu 22.04.5 LTS   5.15.0-119-generic   containerd://1.7.21-k3s2</span>
<span class="c">#    node/k3s-w1   Ready    &amp;lt;none&amp;gt;                 3h57m   v1.30.5+k3s1   192.168.10.101   &amp;lt;none&amp;gt;        Ubuntu 22.04.5 LTS   5.15.0-119-generic   containerd://1.7.21-k3s2</span>
<span class="c">#    node/k3s-w2   Ready    &amp;lt;none&amp;gt;                 3h55m   v1.30.5+k3s1   192.168.10.102   &amp;lt;none&amp;gt;        Ubuntu 22.04.5 LTS   5.15.0-119-generic   containerd://1.7.21-k3s2</span>
<span class="c">#    </span>
<span class="c">#    NAMESPACE     NAME                                          READY   STATUS    RESTARTS         AGE     IP               NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system   pod/cilium-envoy-9q7c6                        1/1     Running   0                5m19s   192.168.10.102   k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/cilium-ljv9t                              1/1     Running   0                5m19s   192.168.10.101   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/cilium-operator-76bb588dbc-gxrqx          1/1     Running   0                5m19s   192.168.10.101   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/cilium-q96l4                              1/1     Running   0                5m19s   192.168.10.102   k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/coredns-7b98449c4-x5756                   1/1     Running   0                2m59s   172.16.1.21      k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/hubble-relay-88f7f89d4-fcq2s              1/1     Running   0                5m19s   172.16.1.99      k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/hubble-ui-59bb4cb67b-r48tz                2/2     Running   0                5m19s   172.16.0.238     k3s-m    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/local-path-provisioner-6795b5f9d8-84m96   1/1     Running   11 (5m28s ago)   3h58m   172.16.2.184     k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/metrics-server-cdcc87586-g5m2d            1/1     Running   11 (5m10s ago)   3h58m   172.16.2.223     k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAMESPACE     NAME                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE     SELECTOR</span>
<span class="c">#    default       service/kubernetes       ClusterIP   10.10.200.1     &amp;lt;none&amp;gt;        443/TCP                  3h58m   &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   service/cilium-envoy     ClusterIP   None            &amp;lt;none&amp;gt;        9964/TCP                 5m19s   k8s-app=cilium-envoy</span>
<span class="c">#    kube-system   service/hubble-metrics   ClusterIP   None            &amp;lt;none&amp;gt;        9965/TCP                 5m19s   k8s-app=cilium</span>
<span class="c">#    kube-system   service/hubble-peer      ClusterIP   10.10.200.203   &amp;lt;none&amp;gt;        443/TCP                  5m19s   k8s-app=cilium</span>
<span class="c">#    kube-system   service/hubble-relay     ClusterIP   10.10.200.175   &amp;lt;none&amp;gt;        80/TCP                   5m19s   k8s-app=hubble-relay</span>
<span class="c">#    kube-system   service/hubble-ui        ClusterIP   10.10.200.125   &amp;lt;none&amp;gt;        80/TCP                   5m19s   k8s-app=hubble-ui</span>
<span class="c">#    kube-system   service/kube-dns         ClusterIP   10.10.200.10    &amp;lt;none&amp;gt;        53/UDP,53/TCP,9153/TCP   3h58m   k8s-app=kube-dns</span>
<span class="c">#    kube-system   service/metrics-server   ClusterIP   10.10.200.180   &amp;lt;none&amp;gt;        443/TCP                  3h58m   k8s-app=metrics-server</span>

<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
<span class="nv">$ </span>conntrack <span class="nt">-L</span>

<span class="nv">$ </span>kubectl get crd | <span class="nb">grep </span>cilium
<span class="c"># =&gt; ciliumcidrgroups.cilium.io                   2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumclusterwidenetworkpolicies.cilium.io   2024-10-01T11:10:58Z</span>
<span class="c">#    ciliumendpoints.cilium.io                    2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumexternalworkloads.cilium.io            2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumidentities.cilium.io                   2024-10-01T11:10:58Z</span>
<span class="c">#    ciliuml2announcementpolicies.cilium.io       2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumloadbalancerippools.cilium.io          2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumnetworkpolicies.cilium.io              2024-10-01T11:10:58Z</span>
<span class="c">#    ciliumnodeconfigs.cilium.io                  2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumnodes.cilium.io                        2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumpodippools.cilium.io                   2024-10-01T11:10:57Z</span>
<span class="nv">$ </span>kubectl get ciliumnodes <span class="c"># cilium_host ì¸í„°í˜ì´ìŠ¤ì˜ IP í™•ì¸ : CILIUMINTERNALIP</span>
<span class="c"># =&gt; NAME     CILIUMINTERNALIP   INTERNALIP       AGE</span>
<span class="c">#    k3s-m    172.16.0.227       192.168.10.10    21m</span>
<span class="c">#    k3s-w1   172.16.1.82        192.168.10.101   21m</span>
<span class="c">#    k3s-w2   172.16.2.25        192.168.10.102   21m</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE     NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    kube-system   coredns-7b98449c4-x5756                   11970               ready            172.16.1.21</span>
<span class="c">#    kube-system   hubble-relay-88f7f89d4-fcq2s              4124                ready            172.16.1.99</span>
<span class="c">#    kube-system   hubble-ui-59bb4cb67b-r48tz                37523               ready            172.16.0.238</span>
<span class="c">#    kube-system   local-path-provisioner-6795b5f9d8-84m96   11088               ready            172.16.2.184</span>
<span class="c">#    kube-system   metrics-server-cdcc87586-g5m2d            27624               ready            172.16.2.223</span>

<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq

<span class="nv">$ </span>kubetail <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium <span class="nt">--since</span> 1h
<span class="nv">$ </span>kubetail <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium-envoy <span class="nt">--since</span> 1h

<span class="c"># Native XDP ì§€ì› NIC í™•ì¸ : https://docs.cilium.io/en/stable/bpf/progtypes/#xdp-drivers</span>
<span class="nv">$ </span>ethtool <span class="nt">-i</span> enp0s8
<span class="c"># =&gt; driver: virtio_net   # &gt;= XDP 4.10 ë¶€í„° ì§€ì›ë˜ëŠ”ë“¯ í•©ë‹ˆë‹¤.</span>
<span class="c">#    version: 1.0.0</span>
<span class="c">#    ...</span>

<span class="c"># https://docs.cilium.io/en/stable/operations/performance/tuning/#bypass-iptables-connection-tracking</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod <span class="nt">-A</span> <span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Release &amp;quot;cilium&amp;quot; has been upgraded. Happy Helming!</span>
<span class="c">#    NAME: cilium</span>
<span class="c">#    LAST DEPLOYED: Sat Oct 01 11:42:10 2024</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 2</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    You have successfully installed Cilium with Hubble Relay and Hubble UI.</span>
<span class="c">#    </span>
<span class="c">#    Your release version is 1.16.3.</span>
<span class="c">#    </span>
<span class="c">#    For any further help, visit https://docs.cilium.io/en/v1.16/gettinghelp</span>

<span class="c"># í™•ì¸: ê¸°ì¡´ raw ì— ì•„ë˜ rule ì¶”ê°€ í™•ì¸</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span> | <span class="nb">grep </span>notrack
<span class="c"># =&gt; -A CILIUM_OUTPUT_raw -d 192.168.0.0/16 -m comment --comment "cilium: NOTRACK for pod traffic" -j CT --notrack</span>
<span class="c">#    -A CILIUM_OUTPUT_raw -s 192.168.0.0/16 -m comment --comment "cilium: NOTRACK for pod traffic" -j CT --notrack</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>conntrack <span class="nt">-F</span>
<span class="nv">$ </span>conntrack <span class="nt">-L</span>
<span class="nv">$ </span>conntrack <span class="nt">-L</span> |grep <span class="nt">-v</span> 2379
</code></pre></div></div>

<h5 id="cilium-clië¥¼-í†µí•œ-í™•ì¸">Cilium CLIë¥¼ í†µí•œ í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium CLI ì„¤ì¹˜</span>
<span class="nv">$ CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">$ CLI_ARCH</span><span class="o">=</span>amd64
<span class="nv">$ </span><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi</span>
<span class="nv">$ </span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
<span class="nv">$ </span><span class="nb">sha256sum</span> <span class="nt">--check</span> cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz.sha256sum
<span class="nv">$ </span><span class="nb">sudo tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nv">$ </span><span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>

<span class="c"># í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>cilium status <span class="nt">--wait</span>
<span class="c"># =&gt;     /Â¯Â¯\</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Cilium:             OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Operator:           OK</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Envoy DaemonSet:    OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Hubble Relay:       OK</span>
<span class="c">#        \__/       ClusterMesh:        disabled</span>
<span class="c">#    </span>
<span class="c">#    DaemonSet              cilium             Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    DaemonSet              cilium-envoy       Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    Deployment             cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Deployment             hubble-relay       Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Deployment             hubble-ui          Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Containers:            cilium             Running: 3</span>
<span class="c">#                           cilium-envoy       Running: 3</span>
<span class="c">#                           cilium-operator    Running: 1</span>
<span class="c">#                           hubble-relay       Running: 1</span>
<span class="c">#                           hubble-ui          Running: 1</span>
<span class="c">#    Cluster Pods:          5/5 managed by Cilium</span>
<span class="c">#    Helm chart version:    1.16.3</span>
<span class="c">#    Image versions         cilium             quay.io/cilium/cilium:v1.16.3@sha256:62d2a09bbef840a46099ac4c69421c90f84f28d018d479749049011329aa7f28: 3</span>
<span class="c">#                           cilium-envoy       quay.io/cilium/cilium-envoy:v1.29.9-1728346947-0d05e48bfbb8c4737ec40d5781d970a550ed2bbd@sha256:42614a44e508f70d03a04470df5f61e3cffd22462471a0be0544cf116f2c50ba: 3</span>
<span class="c">#                           cilium-operator    quay.io/cilium/operator-generic:v1.16.3@sha256:6e2925ef47a1c76e183c48f95d4ce0d34a1e5e848252f910476c3e11ce1ec94b: 1</span>
<span class="c">#                           hubble-relay       quay.io/cilium/hubble-relay:v1.16.3@sha256:feb60efd767e0e7863a94689f4a8db56a0acc7c1d2b307dee66422e3dc25a089: 1</span>
<span class="c">#                           hubble-ui          quay.io/cilium/hubble-ui-backend:v0.13.1@sha256:0e0eed917653441fded4e7cdb096b7be6a3bddded5a2dd10812a27b1fc6ed95b: 1</span>
<span class="c">#                           hubble-ui          quay.io/cilium/hubble-ui:v0.13.1@sha256:e2e9313eb7caf64b0061d9da0efbdad59c6c461f6ca1752768942bfeda0796c6: 1</span>

<span class="nv">$ </span>cilium connectivity <span class="nb">test</span>

<span class="nv">$ </span>cilium config view
<span class="c"># =&gt; agent-not-ready-taint-key                         node.cilium.io/agent-not-ready</span>
<span class="c">#    arping-refresh-period                             30s</span>
<span class="c">#    auto-direct-node-routes                           true</span>
<span class="c">#    bpf-events-drop-enabled                           true</span>
<span class="c">#    bpf-events-policy-verdict-enabled                 true</span>
<span class="c">#    bpf-events-trace-enabled                          true</span>
<span class="c">#    bpf-lb-acceleration                               disabled</span>
<span class="c">#    bpf-lb-external-clusterip                         false</span>
<span class="c">#    bpf-lb-map-max                                    65536</span>
<span class="c">#    bpf-lb-sock                                       false</span>
<span class="c">#    bpf-lb-sock-terminate-pod-connections             false</span>
<span class="c">#    bpf-map-dynamic-size-ratio                        0.0025</span>
<span class="c">#    bpf-policy-map-max                                16384</span>
<span class="c">#    bpf-root                                          /sys/fs/bpf</span>
<span class="c">#    ...</span>
<span class="c">#    ipv4-native-routing-cidr                          192.168.0.0/16</span>
<span class="c">#    ...</span>
<span class="c">#    kube-proxy-replacement                            true</span>
<span class="c">#    kube-proxy-replacement-healthz-bind-address</span>
<span class="c">#    max-connected-clusters                            255</span>
<span class="c">#    mesh-auth-enabled                                 true</span>
<span class="c">#    ...</span>

<span class="c"># cilium ë°ëª¬ì…‹ íŒŒë“œ ë‚´ì—ì„œ cilium ëª…ë ¹ì–´ë¡œ ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k3s-m  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span>c0 status <span class="nt">--verbose</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    KubeProxyReplacement:   True   [enp0s3   10.0.2.15 fe80::6d:daff:feb3:d4d3, enp0s8   192.168.10.10 fe80::27ff:fe8a:de00 (Direct Routing)]</span>
<span class="c">#    ...</span>
<span class="c">#    IPAM:                   IPv4: 4/254 allocated from 172.16.0.0/24, </span>
<span class="c">#    Allocated addresses:</span>
<span class="c">#      172.16.0.223 (kube-system/hubble-ui-59bb4cb67b-r48tz)</span>
<span class="c">#      172.16.0.227 (router)</span>
<span class="c">#      172.16.0.26 (health)</span>
<span class="c">#      172.16.0.44 (cilium-test-1/client3-67f959dd9b-ptl65)</span>
<span class="c">#    ...</span>
<span class="c">#    Routing:                Network: Native   Host: BPF</span>
<span class="c">#    ...</span>
<span class="c">#    Device Mode:            veth</span>
<span class="c">#    Masquerading:           BPF   [ens5]   192.168.0.0/16 [IPv4: Enabled, IPv6: Disabled]</span>
<span class="c">#    ...  </span>
<span class="c">#    Proxy Status:            OK, ip 172.16.0.227, 0 redirects active on ports 10000-20000, Envoy: external</span>
<span class="c">#    ...</span>
<span class="c">#    KubeProxyReplacement Details:</span>
<span class="c">#      Status:                 True</span>
<span class="c">#      Socket LB:              Enabled</span>
<span class="c">#      Socket LB Tracing:      Enabled</span>
<span class="c">#      Socket LB Coverage:     Full</span>
<span class="c">#      Devices:                enp0s3   10.0.2.15 fe80::6d:daff:feb3:d4d3, enp0s8   192.168.10.10 fe80::27ff:fe8a:de00 (Direct Routing)</span>
<span class="c">#      Mode:                   SNAT</span>
<span class="c">#      Backend Selection:      Random</span>
<span class="c">#      Session Affinity:       Enabled</span>
<span class="c">#      Graceful Termination:   Enabled</span>
<span class="c">#      NAT46/64 Support:       Disabled</span>
<span class="c">#      XDP Acceleration:       Disabled</span>
<span class="c">#      Services:</span>
<span class="c">#      - ClusterIP:      Enabled</span>
<span class="c">#      - NodePort:       Enabled (Range: 30000-32767) </span>
<span class="c">#      - LoadBalancer:   Enabled </span>
<span class="c">#      - externalIPs:    Enabled </span>
<span class="c">#      - HostPort:       Enabled</span>
<span class="c">#    BPF Maps:   dynamic sizing: on (ratio: 0.002500)</span>
<span class="c">#    ...</span>

<span class="c"># Native Routing í™•ì¸ : # 192.168.0.0/16 ëŒ€ì—­ì€ IP Masq ì—†ì´ ë¼ìš°íŒ…</span>
<span class="nv">$ </span>c0 status | <span class="nb">grep </span>KubeProxyReplacement
<span class="c"># =&gt; KubeProxyReplacement:    True   [enp0s3   10.0.2.15 fe80::6d:daff:feb3:d4d3, enp0s8   192.168.10.10 fe80::27ff:fe8a:de00 (Direct Routing)]</span>

<span class="c"># enableIPv4Masquerade=true(ê¸°ë³¸ê°’) , bpf.masquerade=true í™•ì¸</span>
<span class="nv">$ </span>cilium config view | egrep <span class="s1">'enable-ipv4-masquerade|enable-bpf-masquerade'</span>
<span class="c"># =&gt; enable-bpf-masquerade                             true</span>
<span class="c">#    enable-ipv4-masquerade                            true</span>

<span class="nv">$ </span>c0 status <span class="nt">--verbose</span> | <span class="nb">grep </span>Masquerading
<span class="c"># =&gt; Masquerading:           BPF   [enp0s3, enp0s8]   192.168.0.0/16 [IPv4: Enabled, IPv6: Disabled]</span>

<span class="c"># Configure the eBPF-based ip-masq-agent</span>
<span class="c"># https://docs.cilium.io/en/stable/network/concepts/masquerading/</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="nt">--set</span> ipMasqAgent.enabled<span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Release &amp;quot;cilium&amp;quot; has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> masq
<span class="c"># =&gt; enable-bpf-masquerade                             true</span>
<span class="c">#    enable-ip-masq-agent                              true</span>
<span class="c">#    ...</span>

<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k3s-m  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span>c0 status <span class="nt">--verbose</span> | <span class="nb">grep </span>Masquerading
<span class="c"># =&gt; Masquerading:           BPF (ip-masq-agent)   [enp0s3, enp0s8]   192.168.0.0/16 [IPv4: Enabled, IPv6: Disabled]</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ BPFê°€ BPF (ip-masq-agent)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ip-masq-agentëŠ” k8s í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ IP ë§ˆìŠ¤ì»¤ë ˆì´ë”©ì„ ê´€ë¦¬í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ë¡œ,&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ë§ˆìŠ¤ì»¤ë ˆì´ë”© ì—¬ë¶€ë¥¼ ê²°ì •í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ìì› ì‚¬ìš©ì„ ìµœì í™” í•´ì¤ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> yaml  | <span class="nb">grep </span>ip-masq
<span class="c"># =&gt;   enable-ip-masq-agent: &amp;quot;true&amp;quot;</span>
</code></pre></div></div>

<h4 id="cilium-ê¸°ë³¸ì •ë³´-í™•ì¸">Cilium ê¸°ë³¸ì •ë³´ í™•ì¸</h4>

<h5 id="ë³€ìˆ˜--ë‹¨ì¶•í‚¤">ë³€ìˆ˜ &amp; ë‹¨ì¶•í‚¤</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium íŒŒë“œ ì´ë¦„</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k3s-m  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k3s-w1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k3s-w2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>

<span class="c"># ë‹¨ì¶•í‚¤(alias) ì§€ì •</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>

<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>

<span class="c"># Hubble UI ì›¹ ì ‘ì†</span>
<span class="nv">$ </span>kubectl patch <span class="nt">-n</span> kube-system svc hubble-ui <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>
<span class="c"># =&gt; service/hubble-ui patched</span>
<span class="nv">$ HubbleUiNodePort</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> kube-system hubble-ui <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Hubble UI URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$HubbleUiNodePort</span><span class="s2">"</span>
<span class="c"># =&gt; Hubble UI URL = http://54.180.146.116:30732</span>
</code></pre></div></div>

<h5 id="ìì£¼-ì“°ëŠ”-cilium-cli-ëª…ë ¹ì–´">ìì£¼ ì“°ëŠ” Cilium CLI ëª…ë ¹ì–´</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium <span class="nt">-owide</span>
<span class="c"># =&gt; NAME           READY   STATUS    RESTARTS   AGE     IP               NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    cilium-5gx8w   1/1     Running   0          9m12s   192.168.10.102   k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    cilium-92k6s   1/1     Running   0          8m53s   192.168.10.101   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    cilium-zv22g   1/1     Running   0          9m12s   192.168.10.10    k3s-m    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># cilium íŒŒë“œ ì¬ì‹œì‘</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span>kubectl delete pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium
<span class="c"># =&gt; pod &amp;quot;cilium-5p4q4&amp;quot; deleted</span>
<span class="c">#    pod &amp;quot;cilium-bc7jz&amp;quot; deleted</span>
<span class="c">#    pod &amp;quot;cilium-zqs9l&amp;quot; deleted</span>

<span class="c"># cilium ì„¤ì • ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>cilium config view

<span class="c"># cilium íŒŒë“œì˜ cilium ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>c0 status <span class="nt">--verbose</span>

<span class="c"># cilium ì—”ë“œí¬ì¸íŠ¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE       NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    kube-system     coredns-7b98449c4-x5756                   11970               ready            172.16.1.21</span>
<span class="c">#    kube-system     hubble-relay-88f7f89d4-fcq2s              4124                ready            172.16.1.99</span>
<span class="c">#    kube-system     hubble-ui-59bb4cb67b-r48tz                37523               ready            172.16.0.223</span>
<span class="c">#    kube-system     local-path-provisioner-6795b5f9d8-84m96   11088               ready            172.16.2.184</span>
<span class="c">#    kube-system     metrics-server-cdcc87586-g5m2d            27624               ready            172.16.2.223</span>
<span class="nv">$ </span>c0 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    640        Disabled           Disabled          37523      k8s:app.kubernetes.io/name=hubble-ui                                                172.16.0.223   ready</span>
<span class="c">#                                                               k8s:app.kubernetes.io/part-of=cilium</span>
<span class="c">#                                                               k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#                                                               k8s:k8s-app=hubble-ui</span>
<span class="c">#    1196       Disabled           Disabled          1          k8s:node-role.kubernetes.io/control-plane=true                                                     ready</span>
<span class="c">#                                                               k8s:node-role.kubernetes.io/master=true</span>
<span class="c">#                                                               k8s:node.kubernetes.io/instance-type=k3s</span>
<span class="c">#                                                               reserved:host</span>
<span class="c">#    1598       Disabled           Disabled          4          reserved:health                                                                     172.16.0.26    ready</span>
<span class="nv">$ </span>c0 bpf endpoint list
<span class="c"># =&gt; IP ADDRESS        LOCAL ENDPOINT INFO</span>
<span class="c">#    172.16.0.26:0     id=1598  sec_id=4     flags=0x0000 ifindex=17  mac=CE:24:50:27:35:B9 nodemac=FE:57:C1:AD:A6:28</span>
<span class="c">#    172.16.0.223:0    id=640   sec_id=37523 flags=0x0000 ifindex=9   mac=AE:B8:81:A6:B1:28 nodemac=C2:21:B8:92:DA:FD</span>
<span class="c">#    172.16.0.227:0    (localhost)</span>
<span class="c">#    192.168.10.10:0   (localhost)</span>
<span class="c">#    10.0.2.15:0       (localhost)</span>
<span class="nv">$ </span>c0 map get cilium_lxc
<span class="c"># =&gt; Key              Value                                                                                            State   Error</span>
<span class="c">#    172.16.0.223:0   id=640   sec_id=37523 flags=0x0000 ifindex=9   mac=AE:B8:81:A6:B1:28 nodemac=C2:21:B8:92:DA:FD   sync</span>
<span class="c">#    172.16.0.26:0    id=1598  sec_id=4     flags=0x0000 ifindex=17  mac=CE:24:50:27:35:B9 nodemac=FE:57:C1:AD:A6:28   sync</span>
<span class="nv">$ </span>c0 ip list

<span class="c"># Manage the IPCache mappings for IP/CIDR &lt;-&gt; Identity</span>
<span class="nv">$ </span>c0 bpf ipcache list

<span class="c"># Service/NAT List í™•ì¸</span>
<span class="nv">$ </span>c0 service list
<span class="c"># =&gt; ID   Frontend              Service Type   Backend</span>
<span class="c">#    1    10.10.200.1:443       ClusterIP      1 =&amp;gt; 192.168.10.10:6443 (active)</span>
<span class="c">#    ...</span>
<span class="c">#    6    10.10.200.10:9153     ClusterIP      1 =&amp;gt; 172.16.1.21:9153 (active)</span>
<span class="c">#    7    10.10.200.180:443     ClusterIP      1 =&amp;gt; 172.16.2.223:10250 (active)</span>
<span class="c">#    16   0.0.0.0:30732         NodePort       1 =&amp;gt; 172.16.0.223:8081 (active)</span>
<span class="c">#    17   10.0.2.15:30732       NodePort       1 =&amp;gt; 172.16.0.223:8081 (active)</span>
<span class="c">#    18   192.168.10.10:30732   NodePort       1 =&amp;gt; 172.16.0.223:8081 (active)</span>
<span class="nv">$ </span>c0 bpf lb list
<span class="c"># =&gt; SERVICE ADDRESS           BACKEND ADDRESS (REVNAT_ID) (SLOT)</span>
<span class="c">#    10.10.200.1:443 (0)       0.0.0.0:0 (1) (0) [ClusterIP, non-routable]</span>
<span class="c">#    ...</span>
<span class="c">#    10.10.200.10:9153 (0)     0.0.0.0:0 (6) (0) [ClusterIP, non-routable]</span>
<span class="c">#    10.10.200.180:443 (1)     172.16.2.223:10250 (7) (1)</span>
<span class="c">#    0.0.0.0:30732 (0)         0.0.0.0:0 (16) (0) [NodePort, non-routable]</span>
<span class="c">#    192.168.10.10:30732 (0)   0.0.0.0:0 (18) (0) [NodePort]</span>
<span class="c">#    10.0.2.15:30732 (0)       0.0.0.0:0 (17) (0) [NodePort]</span>
<span class="nv">$ </span>c0 bpf lb list <span class="nt">--revnat</span>
<span class="c"># =&gt; ID   BACKEND ADDRESS (REVNAT_ID) (SLOT)</span>
<span class="c">#    7    10.10.200.180:443</span>
<span class="c">#    6    10.10.200.10:9153</span>
<span class="c">#    ...</span>
<span class="c">#    1    10.10.200.1:443</span>
<span class="c">#    17   10.0.2.15:30732</span>
<span class="c">#    16   0.0.0.0:30732</span>
<span class="c">#    18   192.168.10.10:30732</span>
<span class="nv">$ </span>c0 bpf nat list
<span class="c"># =&gt; TCP OUT 192.168.10.10:34576 -&amp;gt; 192.168.10.101:4240 XLATE_SRC 192.168.10.10:34576 Created=409sec ago NeedsCT=1</span>
<span class="c">#    TCP IN 192.168.10.101:4240 -&amp;gt; 192.168.10.10:34576 XLATE_DST 192.168.10.10:34576 Created=409sec ago NeedsCT=1</span>
<span class="c">#    ICMP OUT 192.168.10.10:35656 -&amp;gt; 172.16.1.224:0 XLATE_SRC 192.168.10.10:35656 Created=169sec ago NeedsCT=1</span>
<span class="c">#    ICMP OUT 192.168.10.10:35656 -&amp;gt; 192.168.10.102:0 XLATE_SRC 192.168.10.10:35656 Created=169sec ago NeedsCT=1</span>
<span class="c">#    ...</span>

<span class="c"># List all open BPF maps</span>
<span class="nv">$ </span>c0 map list
<span class="c"># =&gt; Name                       Num entries   Num errors   Cache enabled</span>
<span class="c">#    cilium_lb4_backends_v3     2             0            true</span>
<span class="c">#    cilium_lb4_source_range    0             0            true</span>
<span class="c">#    cilium_policy_01196        2             0            true</span>
<span class="c">#    cilium_policy_01598        3             0            true</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 map list <span class="nt">--verbose</span>

<span class="c"># List contents of a policy BPF map : Dump all policy maps</span>
<span class="nv">$ </span>c0 bpf policy get <span class="nt">--all</span>
<span class="nv">$ </span>c0 bpf policy get <span class="nt">--all</span> <span class="nt">-n</span>

<span class="c"># cilium monitor</span>
<span class="nv">$ </span>c0 monitor <span class="nt">-v</span>
<span class="c"># =&gt; Listening for events on 4 CPUs with 64x4096 of shared memory</span>
<span class="c">#    Press Ctrl-C to quit</span>
<span class="c">#    time=&amp;quot;2024-10-01T12:11:28Z&amp;quot; level=info msg=&amp;quot;Initializing dissection cache...&amp;quot; subsys=monitor</span>
<span class="c">#    -&amp;gt; network flow 0x206747a1 , identity health-&amp;gt;remote-node state reply ifindex enp0s8 orig-ip 0.0.0.0: 172.16.0.26:4240 -&amp;gt; 192.168.10.102:39142 tcp ACK</span>
<span class="c">#    -&amp;gt; endpoint 1598 flow 0x0 , identity remote-node-&amp;gt;health state established ifindex lxc_health orig-ip 192.168.10.102: 192.168.10.102:39142 -&amp;gt; 172.16.0.26:4240 tcp ACK</span>
<span class="c">#    -&amp;gt; endpoint 640 flow 0x665dd157 , identity host-&amp;gt;37523 state new ifindex lxcdd00fea91485 orig-ip 10.0.2.15: 10.0.2.15:37040 -&amp;gt; 172.16.0.223:8081 tcp SYN</span>
<span class="c">#    -&amp;gt; stack flow 0xf0f2648f , identity 37523-&amp;gt;host state reply ifindex 0 orig-ip 0.0.0.0: 172.16.0.223:8081 -&amp;gt; 10.0.2.15:37040 tcp SYN, ACK</span>
<span class="c">#    -&amp;gt; endpoint 640 flow 0x665dd157 , identity host-&amp;gt;37523 state established ifindex lxcdd00fea91485 orig-ip 10.0.2.15: 10.0.2.15:37040 -&amp;gt; 172.16.0.223:8081 tcp ACK</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ cilium monitorëŠ” ìì²´ì ìœ¼ë¡œ ë§ˆì¹˜ tcpdumpì²˜ëŸ¼ íŒ¨í‚·ì˜ ì´ë™ì„ ëª¨ë‹ˆí„°ë§ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>c0 monitor <span class="nt">-v</span> <span class="nt">--type</span> l7   <span class="c"># Layer 7 (Application layer) ë§Œì„ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</span>
<span class="c"># =&gt; CPU 01: [pre-xlate-rev] cgroup_id: 5161 sock_cookie: 14187, dst [10.0.2.15]:43070 tcp</span>
<span class="c">#    CPU 01: [pre-xlate-rev] cgroup_id: 2800 sock_cookie: 14188, dst [172.16.0.223]:8081 tcp</span>
<span class="c">#    CPU 01: [pre-xlate-rev] cgroup_id: 5161 sock_cookie: 14189, dst [10.0.2.15]:43080 tcp</span>
<span class="c">#    CPU 01: [pre-xlate-rev] cgroup_id: 2800 sock_cookie: 10103, dst [172.16.0.223]:8081 tcp</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h5 id="ë„¤íŠ¸ì›Œí¬-ê¸°ë³¸-ì •ë³´-í™•ì¸--k3s-w1w2-ì—-ssh-ì ‘ì†-í›„-ip--c-linkroute-ì •ë³´-í™•ì¸">ë„¤íŠ¸ì›Œí¬ ê¸°ë³¸ ì •ë³´ í™•ì¸ : k3s-w1/w2 ì— SSH ì ‘ì† í›„ ip -c link/route ì •ë³´ í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nb">link</span>
<span class="c"># =&gt; lo               UNKNOWN        00:00:00:00:00:00 &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    enp0s3           UP             02:6d:da:b3:d4:d3 &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    enp0s8           UP             08:00:27:35:1b:07 &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    cilium_net@cilium_host UP             16:9d:bb:67:fc:a0 &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    cilium_host@cilium_net UP             7e:ea:43:69:1e:4b &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    lxcb0b60514c056@if10 UP             be:61:78:59:9a:b9 &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    lxcb6d4cfe53c6a@if12 UP             b6:62:74:02:2f:32 &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    lxc_health@if18  UP             aa:7e:99:a8:fd:c3 &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> addr
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8 ::1/128</span>
<span class="c">#    enp0s3           UP             10.0.2.15/24 metric 100 fe80::6d:daff:feb3:d4d3/64</span>
<span class="c">#    enp0s8           UP             192.168.10.101/24 fe80::a00:27ff:fe35:1b07/64</span>
<span class="c">#    cilium_net@cilium_host UP             fe80::149d:bbff:fe67:fca0/64</span>
<span class="c">#    cilium_host@cilium_net UP             172.16.1.82/32 fe80::7cea:43ff:fe69:1e4b/64</span>
<span class="c">#    lxcb0b60514c056@if10 UP             fe80::bc61:78ff:fe59:9ab9/64</span>
<span class="c">#    lxcb6d4cfe53c6a@if12 UP             fe80::b462:74ff:fe02:2f32/64</span>
<span class="c">#    lxc_health@if18  UP             fe80::a87e:99ff:fea8:fdc3/64</span>

<span class="nt">--------------------------------------------</span>
<span class="c"># cilium_net ê³¼ cilium_host ëŠ” veth peer ê´€ê³„ì´ë©°, cilium_host ëŠ” íŒŒë“œì˜ GW IP ì£¼ì†Œë¡œ ì§€ì •ë˜ë©° 32bit ì´ë‹¤</span>
<span class="c"># =&gt; 4: cilium_net@cilium_host: &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether 16:9d:bb:67:fc:a0 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::149d:bbff:fe67:fca0/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    5: cilium_host@cilium_net: &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether 7e:ea:43:69:1e:4b brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 172.16.1.82/32 scope global cilium_host</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::7cea:43ff:fe69:1e4b/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># proxy arp ëŠ” disable(0) ìƒíƒœì´ë©°, íŒŒë“œì™€ ì—°ê²°ëœ lxc ë„ ëª¨ë‘ 0 ì´ë‹¤</span>
<span class="c"># íŒŒë“œì˜ 32bit ipì˜ gw ê°€ ê°ê° ì—°ê²°ëœ veth ì¸í„°í˜ì´ìŠ¤ì˜ mac ìœ¼ë¡œ cilium_host ì˜ IP/MAC ì‘ë‹µì„ ì²˜ë¦¬í•œë‹¤, ì–´ë–»ê²Œ ë™ì‘ì´ ë˜ëŠ”ê±¸ê¹Œìš”? &gt;&gt; eBPF program!!!</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/net/ipv4/conf/cilium_net/proxy_arp
<span class="c"># =&gt; 0</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/net/ipv4/conf/cilium_host/proxy_arp
<span class="c"># =&gt; 0</span>

<span class="c"># lxc_health ì¸í„°í˜ì´ìŠ¤ëŠ” veth ë¡œ cilium(NET NS 0, í˜¸ìŠ¤íŠ¸ì™€ ë‹¤ë¦„)ê³¼ veth pair ì´ë‹¤ - ë§í¬</span>
<span class="c"># cilium ì¸í„°í˜ì´ìŠ¤ì— íŒŒë“œ IPê°€ í• ë‹¹ë˜ì–´ ìˆìœ¼ë©°, cilium-health-responder ë¡œ ë™ì‘í•œë‹¤</span>
<span class="nv">$ </span>lsns <span class="nt">-t</span> net
<span class="c"># =&gt;         NS TYPE NPROCS   PID USER     NETNSID NSFS                                                COMMAND</span>
<span class="c">#    4026531840 net     133     1 root  unassigned                                                     /sbin/init</span>
<span class="c">#    4026532195 net       2  8433 65535          1 /run/netns/cni-0943b57a-e695-904e-87f6-7edb4fb0cd92 /pause</span>
<span class="c">#    4026532350 net       1 18060 root           0                                                     cilium-health-responder --listen 4240 --pidfile /var/run/cilium/state/health-endp</span>
<span class="c">#    4026532359 net       2 10652 65535          2 /run/netns/cni-1b359731-9a53-2db0-eee1-63b0c5643c27 /pause</span>
</code></pre></div></div>

<h4 id="hubble">Hubble</h4>

<p>Cilliumì€ Hubbleì„ í†µí•´ í†µì‹  ë° ì„œë¹„ìŠ¤ì™€ ë„¤íŠ¸ì›Œí‚¹ ì¸í”„ë¼ì˜ ë™ì‘ì— ëŒ€í•œ ì‹¬ì¸µì ì¸ ê°€ì‹œì„±ì„ ì™„ì „íˆ íˆ¬ëª…í•œ ë°©ì‹ìœ¼ë¡œ ê´€ì°°ì„±ì„ ì œê³µí•©ë‹ˆë‹¤. - <a href="https://cilium.io/blog/2019/11/19/announcing-hubble/">ì°¸ê³ </a></p>
<ul>
  <li>Hubbleì€ <strong>ì™„ì „íˆ ë¶„ì‚°ëœ ë„¤íŠ¸ì›Œí‚¹ ë° ë³´ì•ˆ ëª¨ë‹ˆí„°ë§</strong> í”Œë«í¼ì…ë‹ˆë‹¤</li>
  <li>Cilium ê³¼ eBPF ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ë©°, <strong>ì–´í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì •ì—†ì´ë„</strong> ë³´ë‹¤ ì‹¬ë„ìˆëŠ” ê°€ì‹œì„±ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>Hubbleì€ ì»¨í…Œì´ë„ˆ ê¸°ë°˜ ì›Œí¬ë¡œë“œ ë¿ë§Œ ì•„ë‹ˆë¼ ì „í†µì ì¸ <strong>í‘œì¤€ ë¦¬ëˆ…ìŠ¤ í”„ë¡œì„¸ìŠ¤ë‚˜ VM ê¸°ë°˜ ì›Œí¬ë¡œë“œì— ëŒ€í•´ì„œë„ ê°€ì‹œì„±ì„ ì œê³µ</strong>í•©ë‹ˆë‹¤.</li>
  <li>eBPFë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ì „í†µì ì¸ IP ê¸°ë°˜ì´ ì•„ë‹Œ <strong>ì„œë¹„ìŠ¤/íŒŒë“œ/ì»¨í…Œì´ë„ˆ ìˆ˜ì¤€ì˜ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½</strong>ì— ëŒ€í•´ì„œ ë³´ì•ˆ ê°€ì‹œì„± ë° í†µì œë¥¼ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë˜í•œ <strong>ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆì´ì–´(L7)ì—ì„œ í•„í„°ë§ í•  ìˆ˜ ë„</strong> ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê¸°ë³¸ì ìœ¼ë¡œ Hubble APIëŠ” Cilium ì—ì´ì „íŠ¸ê°€ ì‹¤í–‰ë˜ëŠ” ê°œë³„ ë…¸ë“œì˜ ë²”ìœ„ ë‚´ì—ì„œ ì‘ë™í•©ë‹ˆë‹¤. 
ì´ëŠ” ë„¤íŠ¸ì›Œí¬ í†µì°°ë ¥ì„ ë¡œì»¬ Cilium ì—ì´ì „íŠ¸ê°€ ê´€ì°°í•œ íŠ¸ë˜í”½ìœ¼ë¡œ ì œí•œí•©ë‹ˆë‹¤.<br />
Hubble <strong>CLI</strong>(<code class="language-plaintext highlighter-rouge">hubble</code>)ë¥¼ ì‚¬ìš©í•˜ì—¬ <strong>ë¡œì»¬ Unix Domain Socket</strong>ì„ í†µí•´ ì œê³µëœ <strong>Hubble APIë¥¼ ì¿¼ë¦¬</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Hubble CLI ë°”ì´ë„ˆë¦¬ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Cilium ì—ì´ì „íŠ¸ í¬ë“œì— ì„¤ì¹˜ë©ë‹ˆë‹¤.</li>
  <li><strong>Hubble Relay</strong>ë¥¼ ë°°í¬í•˜ë©´ ì „ì²´ í´ëŸ¬ìŠ¤í„° ë˜ëŠ” ClusterMesh ì‹œë‚˜ë¦¬ì˜¤ì˜ ì—¬ëŸ¬ <strong>í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ê°€ì‹œì„±</strong>ì´ ì œê³µë©ë‹ˆë‹¤. ì´ ëª¨ë“œì—ì„œ Hubble ë°ì´í„°ëŠ” Hubble CLI(<code class="language-plaintext highlighter-rouge">hubble</code>)ë¥¼ Hubble Relay ì„œë¹„ìŠ¤ë¡œ ì§€ì •í•˜ê±°ë‚˜ Hubble UIë¥¼ í†µí•´ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Hubble UIëŠ” L3/L4 ë° L7 ê³„ì¸µì—ì„œ ì„œë¹„ìŠ¤ ì¢…ì†ì„± ê·¸ë˜í”„ë¥¼ ìë™ìœ¼ë¡œ ê²€ìƒ‰í•  ìˆ˜ ìˆëŠ” ì›¹ ì¸í„°í˜ì´ìŠ¤ë¡œ, ì‚¬ìš©ì ì¹œí™”ì ì¸ ì‹œê°í™” ë° ì„œë¹„ìŠ¤ ë§µìœ¼ë¡œì„œì˜ ë°ì´í„° íë¦„ í•„í„°ë§ì„ í—ˆìš©í•©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_10.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">Hubble Relayë¥¼ í†µí•œ ì „ì²´ í´ëŸ¬ìŠ¤í„° ëª¨ë‹ˆí„°ë§ <a href="https://cilium.io/blog/2020/06/22/cilium-18/">ë§í¬</a></em></li>
  <li>ë©”íŠ¸ë¦­ì€ <strong>Prometheus</strong>ë¡œ ìˆ˜ì§‘ë˜ë©°, <strong>Grafana</strong>ë¥¼ í†µí•´ ì‹œê°í™”í•  ìˆ˜ë„ ìˆì–´ì„œ ê¸°ì¡´ì˜ ëŒ€ì‹œë³´ë“œì™€ í†µí•©ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_9.png" alt="img.png" class="image-center w-80" />
<em class="image-caption"><a href="https://cilium.io/blog/2019/11/19/announcing-hubble/">https://cilium.io/blog/2019/11/19/announcing-hubble/</a></em></li>
  <li>Hubble UI í™”ë©´
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_11.png" alt="img.png" class="image-center w-100" />
<em class="image-caption">ì„œë¹„ìŠ¤ ì¢…ì†ì„± ê·¸ë˜í”„</em></li>
  <li>í†µì œ ì˜ˆì‹œ
    <ul>
      <li><code class="language-plaintext highlighter-rouge">/public/.*</code> ê²½ë¡œì— ëŒ€í•œ <code class="language-plaintext highlighter-rouge">GET</code> ìš”ì²­ë§Œ í—ˆìš©í•˜ê³ , ë‹¤ë¥¸ ëª¨ë“  ìš”ì²­ì€ ê±°ë¶€</li>
      <li><code class="language-plaintext highlighter-rouge">service1</code>ì´ <code class="language-plaintext highlighter-rouge">topic1</code>ì´ë¼ëŠ” í† í”½ì„ ìƒì‚°í•˜ê³ , <code class="language-plaintext highlighter-rouge">service2</code>ê°€ <code class="language-plaintext highlighter-rouge">topic1</code>ì„ ì†Œë¹„í•˜ë„ë¡ í—ˆìš©í•˜ê³ , ê·¸ ì™¸ì˜ ëª¨ë“  ì¹´í”„ì¹´ ë©”ì‹œì§€ëŠ” ê±°ë¶€</li>
      <li>HTTP í—¤ë”ì— <code class="language-plaintext highlighter-rouge">X-Token: [0-9]+</code>ê°€ í¬í•¨ëœ ëª¨ë“  ìš”ì²­ì„ í—ˆìš©í•˜ê³ , ê·¸ë ‡ì§€ ì•Šì€ ìš”ì²­ì€ ê±°ë¶€</li>
    </ul>
  </li>
</ul>

<h5 id="hubble-uicli-ì ‘ê·¼-ë°-í™•ì¸">Hubble UI/CLI ì ‘ê·¼ ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í™•ì¸</span>
<span class="nv">$ </span>cilium status
<span class="c"># =&gt;     /Â¯Â¯\</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Cilium:             OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Operator:           OK</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Envoy DaemonSet:    OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Hubble Relay:       OK</span>
<span class="c">#        \__/       ClusterMesh:        disabled</span>
<span class="c">#    </span>
<span class="c">#    DaemonSet              cilium             Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    ...</span>

<span class="c"># UI íŒŒë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>hubble-ui <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                         READY   STATUS    RESTARTS      AGE    IP             NODE    NOMINATED NODE   READINESS GATES</span>
<span class="c">#    hubble-ui-59bb4cb67b-r48tz   2/2     Running   2 (87m ago)   101m   172.16.0.223   k3s-m   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># Hubble UI ì›¹ ì ‘ì†</span>
<span class="nv">$ </span>kubectl patch <span class="nt">-n</span> kube-system svc hubble-ui <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>
<span class="c"># =&gt; service/hubble-ui patched</span>
<span class="nv">$ HubbleUiNodePort</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> kube-system hubble-ui <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Hubble UI URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$HubbleUiNodePort</span><span class="s2">"</span>
<span class="c"># =&gt; Hubble UI URL = http://54.180.146.116:30732</span>

<span class="c">## Service NodePort ìƒì„± í›„ ì•„ë˜ ì •ë³´ í™•ì¸!</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="c"># =&gt; -P PREROUTING ACCEPT</span>
<span class="c">#    -P INPUT ACCEPT</span>
<span class="c">#    -P OUTPUT ACCEPT</span>
<span class="c">#    -P POSTROUTING ACCEPT</span>
<span class="c">#    ...</span>
<span class="c">#    -N KUBE-EXT-ZGWW2L4XLRSDZ3EF</span>
<span class="c">#    -N KUBE-MARK-MASQ</span>
<span class="c">#    -N KUBE-NODEPORTS</span>
<span class="c">#    ...</span>
<span class="c">#    -N KUBE-SEP-UOFUVE4S3JB7NP6T</span>
<span class="c">#    -N KUBE-SERVICES</span>
<span class="c">#    ...</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (1)&lt;/span&gt;-A PREROUTING -m comment --comment &amp;quot;kubernetes service portals&amp;quot; -j KUBE-SERVICES</span>
<span class="c">#    ...</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (4)&lt;/span&gt;-A KUBE-EXT-ZGWW2L4XLRSDZ3EF -m comment --comment &amp;quot;masquerade traffic for kube-system/hubble-ui:http external destinations&amp;quot; -j KUBE-MARK-MASQ</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (5)&lt;/span&gt;-A KUBE-EXT-ZGWW2L4XLRSDZ3EF -j KUBE-SVC-ZGWW2L4XLRSDZ3EF</span>
<span class="c">#    -A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (3)&lt;/span&gt;-A KUBE-NODEPORTS -p tcp -m comment --comment &amp;quot;kube-system/hubble-ui:http&amp;quot; -m tcp --dport 30732 -j KUBE-EXT-ZGWW2L4XLRSDZ3EF</span>
<span class="c">#    ...</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (8)&lt;/span&gt;-A KUBE-SEP-UOFUVE4S3JB7NP6T -s 172.16.0.223/32 -m comment --comment &amp;quot;kube-system/hubble-ui:http&amp;quot; -j KUBE-MARK-MASQ</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (9)&lt;/span&gt;-A KUBE-SEP-UOFUVE4S3JB7NP6T -p tcp -m comment --comment &amp;quot;kube-system/hubble-ui:http&amp;quot; -m tcp -j DNAT --to-destination 172.16.0.223:8081</span>
<span class="c">#    ...</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (2)&lt;/span&gt;-A KUBE-SERVICES -m comment --comment &amp;quot;kubernetes service nodeports; NOTE: this must be the last rule in this chain&amp;quot; -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS</span>
<span class="c">#    ...</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (6)&lt;/span&gt;-A KUBE-SVC-ZGWW2L4XLRSDZ3EF ! -s 172.16.0.0/16 -d 10.10.200.125/32 -p tcp -m comment --comment &amp;quot;kube-system/hubble-ui:http cluster IP&amp;quot; -m tcp --dport 80 -j KUBE-MARK-MASQ</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (7)&lt;/span&gt;-A KUBE-SVC-ZGWW2L4XLRSDZ3EF -m comment --comment &amp;quot;kube-system/hubble-ui:http -&amp;gt; 172.16.0.223:8081&amp;quot; -j KUBE-SEP-UOFUVE4S3JB7NP6T</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ (1) PREROUTING =&gt; (2) KUBE-SERVICES =&gt; (3) KUBE-NODEPORTS &lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    if ë…¸ë“œ í¬íŠ¸ì¸ 30732ë¡œ ì ‘ì†:&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;        =&gt; (4,5) KUBE-EXT-ZGWW2L4XLRSDZ3EF&lt;/span&gt; </span>
<span class="c"># &lt;span style="color: green;"&gt;        =&gt; (6,7) KUBE-SVC-ZGWW2L4XLRSDZ3EF =&gt; (8,9) KUBE-SEP-UOFUVE4S3JB7NP6T =&gt; 172.16.0.223:8081&lt;/span&gt;</span>

<span class="nv">$ </span>conntrack <span class="nt">-L</span>
<span class="nv">$ </span>conntrack <span class="nt">-L</span> |grep <span class="nt">-v</span> 2379

<span class="c"># Install Hubble Client</span>
<span class="nv">$ HUBBLE_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="si">)</span>
<span class="nv">$ HUBBLE_ARCH</span><span class="o">=</span>amd64
<span class="nv">$ </span><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">HUBBLE_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi</span>
<span class="nv">$ </span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/hubble/releases/download/<span class="nv">$HUBBLE_VERSION</span>/hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
<span class="nv">$ </span><span class="nb">sha256sum</span> <span class="nt">--check</span> hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz.sha256sum
<span class="nv">$ </span><span class="nb">sudo tar </span>xzvfC hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="c"># =&gt; hubble</span>
<span class="nv">$ </span><span class="nb">rm </span>hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>

<span class="c"># Hubble API Access : localhost TCP 4245 Relay ë¥¼ í†µí•´ ì ‘ê·¼, observe ë¥¼ í†µí•´ì„œ flow ì¿¼ë¦¬ í™•ì¸ ê°€ëŠ¥!</span>
<span class="nv">$ </span>cilium hubble port-forward &amp;
<span class="c"># =&gt; [1] 16534</span>

<span class="c"># CLI ë¡œ Hubble API ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>hubble status
<span class="c"># =&gt; Healthcheck (via localhost:4245): Ok</span>
<span class="c">#    Current/Max Flows: 12,285/12,285 (100.00%)</span>
<span class="c">#    Flows/s: 24.50</span>
<span class="c">#    Connected Nodes: 3/3</span>

<span class="c"># query the flow API and look for flows</span>
<span class="nv">$ </span>hubble observe
<span class="c"># =&gt; Oct 01 13:26:17.501: kube-system/local-path-provisioner-6795b5f9d8-84m96:60994 (ID:11088) -&amp;gt; 192.168.10.10:6443 (kube-apiserver) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 13:26:17.660: kube-system/hubble-ui-59bb4cb67b-r48tz:47372 (ID:37523) -&amp;gt; kube-system/hubble-relay-88f7f89d4-fcq2s:4245 (ID:4124) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 13:26:17.797: 127.0.0.1:36150 (world) &amp;lt;&amp;gt; kube-system/hubble-ui-59bb4cb67b-r48tz (ID:37523) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Oct 01 13:26:17.914: 192.168.10.102:38716 (host) -&amp;gt; 192.168.10.10:6443 (kube-apiserver) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 13:26:18.011: 127.0.0.1:36160 (world) &amp;lt;&amp;gt; kube-system/hubble-ui-59bb4cb67b-r48tz (ID:37523) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Oct 01 13:26:18.067: 10.0.2.15:59486 (host) -&amp;gt; kube-system/metrics-server-cdcc87586-g5m2d:10250 (ID:27624) to-endpoint FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 13:26:18.067: 10.0.2.15:59486 (host) &amp;lt;- kube-system/metrics-server-cdcc87586-g5m2d:10250 (ID:27624) to-stack FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    ...</span>
<span class="c"># hubble observe --pod netpod</span>
<span class="c"># hubble observe --namespace galaxy --http-method POST --http-path /v1/request-landing</span>
<span class="c"># hubble observe --pod deathstar --protocol http</span>
<span class="c"># hubble observe --pod deathstar --verdict DROPPED</span>
</code></pre></div></div>

<h4 id="ë…¸ë“œê°„-íŒŒë“œ-í†µì‹ ">ë…¸ë“œê°„ íŒŒë“œ í†µì‹ </h4>

<ul>
  <li>
    <p>Endpoint to Endpoint í†µì‹  íŒ¨í‚· íë¦„ë„
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_12.png" alt="img.png" class="image-center w-100" /></p>
  </li>
  <li>
    <p>Egress to Endpoint í†µì‹  íŒ¨í‚· íë¦„ë„
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_13.png" alt="img_1.png" class="image-center w-100" /></p>
  </li>
  <li>
    <p>Ingress to Endpoint í†µì‹  íŒ¨í‚· íë¦„ë„
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_14.png" alt="img_2.png" class="image-center w-100" /></p>
  </li>
  <li>
    <p>íŒŒë“œ ìƒì„± ë° í™•ì¸</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: netpod
  labels:
    app: netpod
spec:
  nodeName: k3s-m
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod1
  labels:
    app: webpod
spec:
  nodeName: k3s-w1
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod2
  labels:
    app: webpod
spec:
  nodeName: k3s-w2
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/netpod created</span>
<span class="c">#    pod/webpod1 created</span>
<span class="c">#    pod/webpod2 created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME      READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    netpod    1/1     Running   0          36s   172.16.0.147   k3s-m    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    webpod1   1/1     Running   0          36s   172.16.1.247   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    webpod2   1/1     Running   0          36s   172.16.2.84    k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="nv">$ </span>c0 status <span class="nt">--verbose</span> | <span class="nb">grep </span>Allocated <span class="nt">-A5</span>
<span class="c"># =&gt; Allocated addresses:</span>
<span class="c">#      172.16.0.147 (default/netpod)</span>
<span class="c">#      172.16.0.223 (kube-system/hubble-ui-59bb4cb67b-r48tz [restored])</span>
<span class="c">#      172.16.0.227 (router)</span>
<span class="c">#      172.16.0.26 (health)</span>
<span class="c">#    IPv4 BIG TCP:           Disabled</span>
<span class="nv">$ </span>c1 status <span class="nt">--verbose</span> | <span class="nb">grep </span>Allocated <span class="nt">-A5</span>
<span class="c"># =&gt; Allocated addresses:</span>
<span class="c">#      172.16.1.21 (kube-system/coredns-7b98449c4-x5756 [restored])</span>
<span class="c">#      172.16.1.224 (health)</span>
<span class="c">#      172.16.1.247 (default/webpod1)</span>
<span class="c">#      172.16.1.82 (router)</span>
<span class="c">#      172.16.1.99 (kube-system/hubble-relay-88f7f89d4-fcq2s [restored])</span>
<span class="nv">$ </span>c2 status <span class="nt">--verbose</span> | <span class="nb">grep </span>Allocated <span class="nt">-A5</span>
<span class="c"># =&gt; Allocated addresses:</span>
<span class="c">#      172.16.2.184 (kube-system/local-path-provisioner-6795b5f9d8-84m96 [restored])</span>
<span class="c">#      172.16.2.223 (kube-system/metrics-server-cdcc87586-g5m2d [restored])</span>
<span class="c">#      172.16.2.25 (router)</span>
<span class="c">#      172.16.2.8 (health)</span>
<span class="c">#      172.16.2.84 (default/webpod2)</span>

<span class="nv">$ </span>kubectl get ciliumendpoints
<span class="c"># =&gt; NAME      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    netpod    27629               ready            172.16.0.147</span>
<span class="c">#    webpod1   64309               ready            172.16.1.247</span>
<span class="c">#    webpod2   64309               ready            172.16.2.84</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>
<span class="c"># =&gt; root@k3s-m:~# kubectl get ciliumendpoints -A</span>
<span class="c">#    NAMESPACE     NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    default       netpod                                    27629               ready            172.16.0.147</span>
<span class="c">#    default       webpod1                                   64309               ready            172.16.1.247</span>
<span class="c">#    default       webpod2                                   64309               ready            172.16.2.84</span>
<span class="c">#    kube-system   coredns-7b98449c4-x5756                   11970               ready            172.16.1.21</span>
<span class="c">#    kube-system   hubble-relay-88f7f89d4-fcq2s              4124                ready            172.16.1.99</span>
<span class="c">#    kube-system   hubble-ui-59bb4cb67b-r48tz                37523               ready            172.16.0.223</span>
<span class="c">#    kube-system   local-path-provisioner-6795b5f9d8-84m96   11088               ready            172.16.2.184</span>
<span class="c">#    kube-system   metrics-server-cdcc87586-g5m2d            27624               ready            172.16.2.223</span>
<span class="nv">$ </span>c0 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    640        Disabled           Disabled          37523      k8s:app.kubernetes.io/name=hubble-ui                                                172.16.0.223   ready</span>
<span class="c">#                                                               k8s:app.kubernetes.io/part-of=cilium</span>
<span class="c">#                                                               k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#                                                               k8s:k8s-app=hubble-ui</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 bpf endpoint list
<span class="c"># =&gt; IP ADDRESS        LOCAL ENDPOINT INFO</span>
<span class="c">#    192.168.10.10:0   (localhost)</span>
<span class="c">#    10.0.2.15:0       (localhost)</span>
<span class="c">#    172.16.0.147:0    id=2724  sec_id=27629 flags=0x0000 ifindex=19  mac=52:59:78:2F:C0:BE nodemac=7E:77:FA:0A:D3:CC</span>
<span class="c">#    172.16.0.26:0     id=1598  sec_id=4     flags=0x0000 ifindex=17  mac=CE:24:50:27:35:B9 nodemac=FE:57:C1:AD:A6:28</span>
<span class="c">#    172.16.0.223:0    id=640   sec_id=37523 flags=0x0000 ifindex=9   mac=AE:B8:81:A6:B1:28 nodemac=C2:21:B8:92:DA:FD</span>
<span class="c">#    172.16.0.227:0    (localhost)</span>
<span class="nv">$ </span>c0 map get cilium_lxc
<span class="c"># =&gt; Key              Value                                                                                            State   Error</span>
<span class="c">#    172.16.0.147:0   id=2724  sec_id=27629 flags=0x0000 ifindex=19  mac=52:59:78:2F:C0:BE nodemac=7E:77:FA:0A:D3:CC   sync</span>
<span class="c">#    172.16.0.223:0   id=640   sec_id=37523 flags=0x0000 ifindex=9   mac=AE:B8:81:A6:B1:28 nodemac=C2:21:B8:92:DA:FD   sync</span>
<span class="c">#    172.16.0.26:0    id=1598  sec_id=4     flags=0x0000 ifindex=17  mac=CE:24:50:27:35:B9 nodemac=FE:57:C1:AD:A6:28   sync</span>
<span class="nv">$ </span>c0 ip list
<span class="c"># =&gt; IP                  IDENTITY                                                                         SOURCE</span>
<span class="c">#    0.0.0.0/0           reserved:world</span>
<span class="c">#    10.0.2.15/32        reserved:host</span>
<span class="c">#                        reserved:kube-apiserver</span>
<span class="c">#    172.16.0.26/32      reserved:health</span>
<span class="c">#    172.16.0.147/32     k8s:app=netpod                                                                   custom-resource</span>
<span class="c">#                        k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>íŒŒë“œ ë³€ìˆ˜ ì§€ì •</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í…ŒìŠ¤íŠ¸ íŒŒë“œë“¤ IP</span>
<span class="nv">$ NETPODIP</span><span class="o">=</span><span class="si">$(</span>kubectl get pods netpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.podIP}'</span><span class="si">)</span>
<span class="nv">$ WEBPOD1IP</span><span class="o">=</span><span class="si">$(</span>kubectl get pods webpod1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.podIP}'</span><span class="si">)</span>
<span class="nv">$ WEBPOD2IP</span><span class="o">=</span><span class="si">$(</span>kubectl get pods webpod2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.podIP}'</span><span class="si">)</span>

<span class="c"># ë‹¨ì¶•í‚¤(alias) ì§€ì •</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">p0</span><span class="o">=</span><span class="s2">"kubectl exec -it netpod  -- "</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">p1</span><span class="o">=</span><span class="s2">"kubectl exec -it webpod1 -- "</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">p2</span><span class="o">=</span><span class="s2">"kubectl exec -it webpod2 -- "</span>
</code></pre></div></div>

<ul>
  <li>íŒŒë“œì˜ ARP ë™ì‘ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># netpod ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>p0 ip <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    18: eth0@if19: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000 link-netnsid 0</span>
<span class="c">#        inet 172.16.0.147/32 scope global eth0</span>
<span class="nv">$ </span>p0 route <span class="nt">-n</span>
<span class="c"># =&gt; Kernel IP routing table</span>
<span class="c">#    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span>
<span class="c">#    0.0.0.0         172.16.0.227    0.0.0.0         UG    0      0        0 eth0</span>
<span class="c">#    172.16.0.227    0.0.0.0         255.255.255.255 UH    0      0        0 eth0</span>
<span class="nv">$ </span>p0 ping <span class="nt">-c</span> 1 <span class="nv">$WEBPOD1IP</span> <span class="o">&amp;&amp;</span> p0 ping <span class="nt">-c</span> 1 <span class="nv">$WEBPOD2IP</span>
<span class="c"># =&gt; PING 172.16.1.247 (172.16.1.247) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.16.1.247: icmp_seq=1 ttl=62 time=0.642 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.16.1.247 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.642/0.642/0.642/0.000 ms</span>
<span class="c">#    PING 172.16.2.84 (172.16.2.84) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.16.2.84: icmp_seq=1 ttl=62 time=0.716 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.16.2.84 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.716/0.716/0.716/0.000 ms</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_15.png" alt="img.png" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>p0 curl <span class="nt">-s</span> <span class="nv">$WEBPOD1IP</span> <span class="o">&amp;&amp;</span> p0 curl <span class="nt">-s</span> <span class="nv">$WEBPOD2IP</span>
<span class="c"># =&gt; Hostname: webpod1</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 172.16.1.247</span>
<span class="c">#    RemoteAddr: 172.16.0.147:51692</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 172.16.1.247</span>
<span class="c">#    User-Agent: curl/8.7.1</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    </span>
<span class="c">#    Hostname: webpod2</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 172.16.2.84</span>
<span class="c">#    RemoteAddr: 172.16.0.147:32796</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 172.16.2.84</span>
<span class="c">#    User-Agent: curl/8.7.1</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>p0 curl <span class="nt">-s</span> <span class="nv">$WEBPOD1IP</span>:8080 <span class="p">;</span> p0 curl <span class="nt">-s</span> <span class="nv">$WEBPOD2IP</span>:8080
<span class="c"># =&gt; command terminated with exit code 7</span>
<span class="c">#    command terminated with exit code 7</span>
<span class="nv">$ </span>p0 ping <span class="nt">-c</span> 1 8.8.8.8 <span class="o">&amp;&amp;</span> p0 curl <span class="nt">-s</span> wttr.in/seoul
<span class="c"># =&gt; PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 8.8.8.8: icmp_seq=1 ttl=61 time=39.1 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 8.8.8.8 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 39.095/39.095/39.095/0.000 ms</span>
<span class="c">#    Weather report: seoul</span>
<span class="c">#    </span>
<span class="c">#         \  /       Partly cloudy</span>
<span class="c">#       _ /&amp;quot;&amp;quot;.-.     16 Â°C</span>
<span class="c">#         \_(   ).   â† 4 km/h</span>
<span class="c">#         /(___(__)  10 km</span>
<span class="c">#                    0.0 mm</span>
<span class="c">#                                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Sat 26 Oct â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”‚            Morning           â”‚             Noon      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     Evening           â”‚             Night            â”‚</span>
<span class="c">#    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="c">#    â”‚     \   /     Sunny          â”‚     \   /     Sunny          â”‚               Overcast       â”‚    \  /       Partly Cloudy  â”‚</span>
<span class="c">#    â”‚      .-.      16 Â°C          â”‚      .-.      21 Â°C          â”‚      .--.     20 Â°C          â”‚  _ /&amp;quot;&amp;quot;.-.     19 Â°C          â”‚</span>
<span class="c">#    â”‚   â€• (   ) â€•   â†™ 5-7 km/h     â”‚   â€• (   ) â€•   â†™ 5-6 km/h     â”‚   .-(    ).   â† 4-6 km/h     â”‚    \_(   ).   â†™ 4-7 km/h     â”‚</span>
<span class="c">#    â”‚      `-â€™      10 km          â”‚      `-â€™      10 km          â”‚  (___.__)__)  10 km          â”‚    /(___(__)  10 km          â”‚</span>
<span class="c">#    â”‚     /   \     0.0 mm | 0%    â”‚     /   \     0.0 mm | 0%    â”‚               0.0 mm | 0%    â”‚               0.0 mm | 0%    â”‚</span>
<span class="c">#    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="c">#                                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Sun 27 Oct â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”‚            Morning           â”‚             Noon      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     Evening           â”‚             Night            â”‚</span>
<span class="c">#    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="c">#    â”‚               Overcast       â”‚               Cloudy         â”‚     \   /     Clear          â”‚     \   /     Clear          â”‚</span>
<span class="c">#    â”‚      .--.     16 Â°C          â”‚      .--.     19 Â°C          â”‚      .-.      19 Â°C          â”‚      .-.      17 Â°C          â”‚</span>
<span class="c">#    â”‚   .-(    ).   â† 1 km/h       â”‚   .-(    ).   â†“ 4-5 km/h     â”‚   â€• (   ) â€•   â†˜ 9-13 km/h    â”‚   â€• (   ) â€•   â†˜ 5-7 km/h     â”‚</span>
<span class="c">#    â”‚  (___.__)__)  10 km          â”‚  (___.__)__)  10 km          â”‚      `-â€™      10 km          â”‚      `-â€™      10 km          â”‚</span>
<span class="c">#    â”‚               0.0 mm | 0%    â”‚               0.0 mm | 0%    â”‚     /   \     0.0 mm | 0%    â”‚     /   \     0.0 mm | 0%    â”‚</span>
<span class="c">#    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="c">#                                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Mon 28 Oct â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”‚            Morning           â”‚             Noon      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     Evening           â”‚             Night            â”‚</span>
<span class="c">#    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="c">#    â”‚     \   /     Sunny          â”‚    \  /       Partly Cloudy  â”‚               Cloudy         â”‚  _`/&amp;quot;&amp;quot;.-.     Patchy rain neâ€¦â”‚</span>
<span class="c">#    â”‚      .-.      16 Â°C          â”‚  _ /&amp;quot;&amp;quot;.-.     20 Â°C          â”‚      .--.     20 Â°C          â”‚   ,\_(   ).   19 Â°C          â”‚</span>
<span class="c">#    â”‚   â€• (   ) â€•   â† 5-6 km/h     â”‚    \_(   ).   â† 6-7 km/h     â”‚   .-(    ).   â†™ 6-9 km/h     â”‚    /(___(__)  â† 8-10 km/h    â”‚</span>
<span class="c">#    â”‚      `-â€™      10 km          â”‚    /(___(__)  10 km          â”‚  (___.__)__)  10 km          â”‚      â€˜ â€˜ â€˜ â€˜  10 km          â”‚</span>
<span class="c">#    â”‚     /   \     0.0 mm | 0%    â”‚               0.0 mm | 0%    â”‚               0.0 mm | 0%    â”‚     â€˜ â€˜ â€˜ â€˜   0.0 mm | 67%   â”‚</span>
<span class="c">#    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="c">#    Location: á„‰á…¥á„‹á…®á†¯á„á…³á†¨á„‡á…§á†¯á„‰á…µ, á„ƒá…¢á„’á…¡á†«á„†á…µá†«á„€á…®á†¨ [37.5666791,126.9782914]</span>
<span class="c">#    </span>
<span class="c">#    Follow @igor_chubin for wttr.in updates</span>

<span class="nv">$ </span>p0 ip <span class="nt">-c</span> neigh
<span class="c"># =&gt; 172.16.0.227 dev eth0 lladdr 7e:77:fa:0a:d3:cc STALE</span>

<span class="c"># hubble cli í™•ì¸</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> netpod
<span class="c"># =&gt; Oct 01 14:29:21.248: kube-system/coredns-7b98449c4-7kqtg:53 (ID:11970) &amp;lt;&amp;gt; default/netpod (ID:27629) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Oct 01 14:29:21.248: kube-system/kube-dns:53 (world) &amp;lt;&amp;gt; default/netpod (ID:27629) post-xlate-rev TRANSLATED (UDP)</span>
<span class="c">#    Oct 01 14:29:21.248: default/netpod:34162 (ID:27629) -&amp;gt; 5.9.243.187:80 (world) to-network FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 14:29:21.481: default/netpod:34162 (ID:27629) -&amp;gt; 5.9.243.187:80 (world) to-network FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:29:21.481: default/netpod:34162 (ID:27629) &amp;lt;- 5.9.243.187:80 (world) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Oct 01 14:29:21.481: default/netpod:34162 (ID:27629) -&amp;gt; 5.9.243.187:80 (world) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 14:29:21.816: default/netpod:34162 (ID:27629) &amp;lt;- 5.9.243.187:80 (world) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:29:21.819: default/netpod:34162 (ID:27629) -&amp;gt; 5.9.243.187:80 (world) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:29:22.052: default/netpod:34162 (ID:27629) &amp;lt;- 5.9.243.187:80 (world) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:29:22.052: default/netpod:34162 (ID:27629) -&amp;gt; 5.9.243.187:80 (world) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> webpod1
<span class="c"># =&gt; Oct 01 14:33:40.392: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 14:33:40.392: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Oct 01 14:33:40.392: default/netpod:60282 (ID:27629) &amp;lt;&amp;gt; default/webpod1 (ID:64309) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Oct 01 14:33:40.392: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 14:33:40.392: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:33:40.393: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:33:40.393: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:33:40.393: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:33:40.394: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 14:33:40.405: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 14:33:40.406: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Oct 01 14:33:40.406: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 14:33:40.406: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:33:40.407: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:33:40.407: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:33:40.408: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:33:40.408: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 80í¬íŠ¸ë¡œ ì ‘ì†í–ˆì„ë•Œ ì •ìƒì ì¸ ì‘ë‹µ íŒ¨í‚·ë“¤&lt;/span&gt;</span>

<span class="c">#    Oct 01 14:33:43.956: default/netpod:34488 (ID:27629) -&amp;gt; default/webpod1:8080 (ID:64309) to-endpoint FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 14:33:43.956: default/netpod:34488 (ID:27629) &amp;lt;- default/webpod1:8080 (ID:64309) to-network FORWARDED (TCP Flags: ACK, RST)</span>
<span class="c">#    Oct 01 14:33:43.970: default/netpod:34488 (ID:27629) -&amp;gt; default/webpod1:8080 (ID:64309) to-network FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 14:33:43.970: default/netpod:34488 (ID:27629) &amp;lt;- default/webpod1:8080 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK, RST)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì—´ë ¤ìˆì§€ ì•Šì€ 8080í¬íŠ¸ë¡œ ì ‘ì†í–ˆì„ë•Œ ì˜¤ë¥˜ê°€ ë°œìƒí•œ íŒ¨í‚·ë“¤&lt;/span&gt;</span>

<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> webpod2

<span class="c"># BPF maps : ëª©ì ì§€ íŒŒë“œì™€ í†µì‹  ì‹œ ì–´ëŠê³³ìœ¼ë¡œ ë³´ë‚´ì•¼ ë ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤</span>
<span class="nv">$ </span>c0 map get cilium_ipcache
<span class="c"># =&gt; Key                 Value                                                                     State   Error</span>
<span class="c">#    172.16.2.182/32     identity=27624 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    172.16.2.8/32       identity=4 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;       sync</span>
<span class="c">#    172.16.0.147/32     identity=27629 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;          sync</span>
<span class="c">#    172.16.0.223/32     identity=37523 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;          sync</span>
<span class="c">#    192.168.10.10/32    identity=1 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    172.16.0.26/32      identity=4 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    10.0.2.15/32        identity=1 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    192.168.10.102/32   identity=6 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    172.16.1.82/32      identity=6 encryptkey=0 tunnelendpoint=192.168.10.101, flags=&amp;lt;none&amp;gt;       sync</span>
<span class="c">#    172.16.2.237/32     identity=11970 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    172.16.2.216/32     identity=64309 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    0.0.0.0/0           identity=2 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    172.16.2.111/32     identity=11088 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    172.16.1.224/32     identity=4 encryptkey=0 tunnelendpoint=192.168.10.101, flags=&amp;lt;none&amp;gt;       sync</span>
<span class="c">#    172.16.2.25/32      identity=6 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;       sync</span>
<span class="c">#    192.168.10.101/32   identity=6 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    172.16.0.148/32     identity=4124 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;           sync</span>
<span class="c">#    172.16.1.247/32     identity=64309 encryptkey=0 tunnelendpoint=192.168.10.101, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    172.16.0.227/32     identity=1 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="nv">$ </span>c0 map get cilium_ipcache | <span class="nb">grep</span> <span class="nv">$WEBPOD1IP</span>
<span class="c"># =&gt; 172.16.1.247/32     identity=64309 encryptkey=0 tunnelendpoint=192.168.10.101, flags=&amp;lt;none&amp;gt;   sync</span>

<span class="c"># netpod ì˜ LXC ë³€ìˆ˜ ì§€ì •</span>
<span class="c">#$ LXC=&lt;k3s-mì˜ ê°€ì¥ ë‚˜ì¤‘ì— lxc ì´ë¦„&gt;</span>
<span class="nv">$ LXC</span><span class="o">=</span>lxcd551b3b4058f

<span class="c"># íŒŒë“œì™€ veth pair ì— IPê°€ ì—†ìŠµë‹ˆë‹¤! proxy_arp ë„ ì—†ìŠµë‹ˆë‹¤! í•˜ì§€ë§Œ GW MAC ìš”ì²­ ì‹œ lxc(veth)ì˜ MAC ìœ¼ë¡œ ì‘ë‹µì´ ì˜µë‹ˆë‹¤! &gt;&gt; eBPF Magic!</span>
<span class="c"># Cilium hijacks ARP table of POD1, forces the next hop to be the peer end (host side) of the veth pair.</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr show dev <span class="nv">$LXC</span>
<span class="c"># =&gt; 23: lxcd551b3b4058f@if22: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether fa:32:54:4b:16:d7 brd ff:ff:ff:ff:ff:ff link-netns cni-8634ff07-8cb9-608a-1baf-dc929d510a84</span>
<span class="c">#        inet6 fe80::f832:54ff:fe4b:16d7/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_16.png" alt="img.png" class="image-center" />
<em class="image-caption">webpod1,2ì™€ wttr.in ì ‘ì† í…ŒìŠ¤íŠ¸ í›„ Hubble UI</em></p>

<h4 id="ì„œë¹„ìŠ¤-í†µì‹ -í™•ì¸">ì„œë¹„ìŠ¤ í†µì‹  í™•ì¸</h4>

<h5 id="ì†Œì¼“-ê¸°ë°˜-ë¡œë“œë°¸ëŸ°ì‹±-ì†Œê°œ">ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± ì†Œê°œ</h5>

<ul>
  <li>ì°¸ê³  : <a href="https://velog.io/@haruband/K8SCilium-Socket-Based-LoadBalancing-%EA%B8%B0%EB%B2%95">https://velog.io/@haruband/K8SCilium-Socket-Based-LoadBalancing-%EA%B8%B0%EB%B2%95</a></li>
  <li>ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±(ì™¼ìª½) vs ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±(ì˜¤ë¥¸ìª½) ë¹„êµ
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_17.png" alt="img.png" />
ìœ„ì˜ ê·¸ë¦¼ì—ì„œ ì²˜ëŸ¼ ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±ì€ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ DNAT ë˜ëŠ” ê³¼ì •ì„ ê±°ì¹˜ëŠ”ë°, <strong>ì†Œì¼“ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±ì€ DNATí•˜ëŠ” ê³¼ì •ì´ í•„ìš”ê°€ ì—†ìŠµ</strong>ë‹ˆë‹¤.
    <ul>
      <li>ìœ„ì˜ ê·¸ë¦¼ì„ í’€ì–´ì„œ ì„¤ëª…í•˜ìë©´ ìœ„ì˜ ì˜ˆì—ì„œ Pod1ì—ì„œ ë™ì‘í•˜ëŠ” ì•±ì´ <code class="language-plaintext highlighter-rouge">connect()</code> ì‹œìŠ¤í…œ ì½œì„ ì´ìš©í•´ì„œ ì†Œì¼“ì„ ì—°ê²°í• ë•Œ ëª©ì ì§€ ì£¼ì†Œê°€
ì„œë¹„ìŠ¤ ì£¼ì†Œ (192.168.0.1)ì´ë©´ ì†Œì¼“ì˜ ëª©ì ì§€ ì£¼ì†Œë¥¼ ë°”ë¡œ ë°±ì—”ë“œ ì£¼ì†Œ(10.0.0.2)ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. ì´í›„ ë°ì´í„° ì „ì†¡ì€ 
<strong>ë°”ë¡œ ë°±ì—”ë“œ ì£¼ì†Œ(10.0.0.2)ë¡œ ì „ì†¡ë˜ê¸° ë•Œë¬¸</strong>ì— <strong>DNAT ë³€í™˜ ë° ì—­ë³€í™˜ ê³¼ì •ì´ í•„ìš”ì—†ì–´</strong>ì§‘ë‹ˆë‹¤.</li>
      <li><em>ì´ëŠ” ciliumì´ L7ì—ì„œ íŒŒë“œ/ì„œë¹„ìŠ¤ì˜ ì˜ë¯¸ë¥¼ ì´í•´í•˜ê³  ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤!</em></li>
      <li>ì‹¬ì§€ì–´ ì„œë¹„ìŠ¤ ì£¼ì†Œë¥¼ ë°±ì—”ë“œ ì£¼ì†Œë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì€ <strong>ì‹œìŠ¤í…œì½œ ë ˆë²¨ì—ì„œ ì´ë£¨ì–´ì§€ë©°</strong>, ì»¤ë„ì—ì„œ íŒ¨í‚·ì´ ìƒì„±ë˜ê¸°ë„ ì „ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Socket Operations : BPF Socket Operations programì€ root cgroupì— ì—°ê²°ë˜ë©° TCP event(ESTABLISHED)ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.</li>
  <li>Socket send/recv : Socket send/recv í›…ì€ TCP socketì˜ ëª¨ë“  ì†¡ìˆ˜ì‹  ì‘ì—…ì—ì„œ ì‹¤í–‰ë˜ë©°, hookì—ì„œ ê²€ì‚¬/ì‚­ì œ/ë¦¬ë‹¤ì´ë ‰ì…˜ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">connect()</code>ì™€ <code class="language-plaintext highlighter-rouge">sendto()</code> ì†Œì¼“ í•¨ìˆ˜ì— ì—°ê²°ëœ í”„ë¡œê·¸ë¨(<code class="language-plaintext highlighter-rouge">connect4</code>, <code class="language-plaintext highlighter-rouge">sendmsg4</code>)ì—ì„œëŠ” ì†Œì¼“ì˜ ëª©ì ì§€ ì£¼ì†Œë¥¼ ë°±ì—”ë“œ ì£¼ì†Œì™€ í¬íŠ¸ë¡œ ë³€í™˜í•˜ê³ , 
cilium_lb4_backends ë§µì— ë°±ì—”ë“œ ì£¼ì†Œì™€ í¬íŠ¸ë¥¼ ë“±ë¡í•´ë†“ìŠµë‹ˆë‹¤. ì´í›„ <code class="language-plaintext highlighter-rouge">recvmsg()</code> ì†Œì¼“ í•¨ìˆ˜ì— ì—°ê²°ëœ í”„ë¡œê·¸ë¨(<code class="language-plaintext highlighter-rouge">recvmsg4</code>)ì—ì„œëŠ”
ilium_lb4_reverse_nat ë§µì„ ì´ìš©í•´ì„œ ëª©ì ì§€ ì£¼ì†Œì™€ í¬íŠ¸ë¥¼ ë‹¤ì‹œ ì„œë¹„ìŠ¤ ì£¼ì†Œì™€ í¬íŠ¸ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_18.png" alt="img.png" class="image-center" />
<em class="image-caption">ciliumì˜ ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± ë™ì‘ ë°©ì‹ - <a href="https://k8s.networkop.co.uk/services/clusterip/dataplane/ebpf/">ë§í¬</a></em></li>
</ul>

<h5 id="ì„œë¹„ìŠ¤-ìƒì„±-ë°-ì ‘ì†-í™•ì¸">ì„œë¹„ìŠ¤ ìƒì„± ë° ì ‘ì† í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì„œë¹„ìŠ¤ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Service
metadata:
  name: svc
spec:
  ports:
    - name: svc-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; service/svc created</span>

<span class="c"># ì„œë¹„ìŠ¤ ìƒì„± í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc,ep svc
<span class="c"># =&gt; NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/svc   ClusterIP   10.10.200.121   &amp;lt;none&amp;gt;        80/TCP    13s</span>
<span class="c">#    </span>
<span class="c">#    NAME            ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/svc   172.16.1.247:80,172.16.2.216:80   13s</span>

<span class="c"># ë…¸ë“œì— iptables ë”ì´ìƒ KUBE-SVC rule ì´ ìƒì„±ë˜ì§€ ì•ŠëŠ”ë‹¤!</span>
<span class="nv">$ </span>iptables-save | <span class="nb">grep </span>KUBE-SVC
<span class="nv">$ </span>iptables-save | <span class="nb">grep </span>CILIUM

<span class="c"># ì„œë¹„ìŠ¤IPë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
<span class="nv">$ SVCIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.clusterIP}'</span><span class="si">)</span>

<span class="c"># Pod1 ì—ì„œ Service(ClusterIP) ì ‘ì† íŠ¸ë˜í”½ ë°œìƒ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>netpod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$SVCIP</span>
<span class="c"># =&gt; Hostname: webpod2</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.16.2.216</span>
<span class="c">#    IP: fe80::844e:b2ff:fed0:7d5</span>
<span class="c">#    RemoteAddr: 172.16.0.147:36844</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 10.10.200.121</span>
<span class="c">#    User-Agent: curl/8.7.1</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>netpod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$SVCIP</span> | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod1</span>

<span class="c"># ì§€ì†ì ìœ¼ë¡œ ì ‘ì† íŠ¸ë˜í”½ ë°œìƒ</span>
<span class="nv">$ SVCIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.clusterIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec </span>netpod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$SVCIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span><span class="nb">echo</span> <span class="s2">"-----"</span><span class="p">;</span><span class="nb">sleep </span>1<span class="p">;</span><span class="k">done</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>netpod <span class="nt">--</span> tcpdump <span class="nt">-enni</span> any <span class="nt">-q</span>
<span class="c"># =&gt; 15:01:03.468433 eth0  Out ifindex 18 52:59:78:2f:c0:be 172.16.0.147.57744 &amp;gt; 172.16.1.247.80: tcp 0</span>
<span class="c">#    15:01:03.468761 eth0  In  ifindex 18 7e:77:fa:0a:d3:cc 172.16.1.247.80 &amp;gt; 172.16.0.147.57744: tcp 0</span>
<span class="c">#    15:01:03.468801 eth0  Out ifindex 18 52:59:78:2f:c0:be 172.16.0.147.57744 &amp;gt; 172.16.1.247.80: tcp 0</span>
<span class="c">#    15:01:03.469249 eth0  Out ifindex 18 52:59:78:2f:c0:be 172.16.0.147.57744 &amp;gt; 172.16.1.247.80: tcp 76</span>
<span class="c">#    15:01:03.469852 eth0  In  ifindex 18 7e:77:fa:0a:d3:cc 172.16.1.247.80 &amp;gt; 172.16.0.147.57744: tcp 0</span>
<span class="c">#    15:01:03.469852 eth0  In  ifindex 18 7e:77:fa:0a:d3:cc 172.16.1.247.80 &amp;gt; 172.16.0.147.57744: tcp 312</span>
<span class="c">#    15:01:03.469888 eth0  Out ifindex 18 52:59:78:2f:c0:be 172.16.0.147.57744 &amp;gt; 172.16.1.247.80: tcp 0</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ íŒŒë“œì—ì„œ SVC(ClusterIP) ì ‘ì† ì‹œ tcpdump ë¡œ í™•ì¸ &gt;&gt; íŒŒë“œ ë‚´ë¶€ ìº¡ì³ì¸ë°,&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    SVC(10.10.200.121)ëŠ” ë³´ì´ì§€ ì•Šê³ , DNAT ëœ web-pod ì˜ IPê°€ í™•ì¸ë©ë‹ˆë‹¤! It's Magic!&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>netpod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s2">"ngrep -tW byline -d eth0 '' 'tcp port 80'"</span>
<span class="c"># =&gt; T 2024/10/01 15:02:58.406586 172.16.0.147:48018 -&amp;gt; 172.16.2.216:80 [AP] #4</span>
<span class="c">#    GET / HTTP/1.1.</span>
<span class="c">#    Host: 10.10.200.121.</span>
<span class="c">#    User-Agent: curl/8.7.1.</span>
<span class="c">#    Accept: */*.</span>
<span class="c">#    ...</span>

<span class="c"># ì„œë¹„ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>c0 service list
<span class="c"># =&gt; ID   Frontend              Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    11   10.10.200.121:80      ClusterIP      1 =&amp;gt; 172.16.1.247:80 (active)</span>
<span class="c">#                                              2 =&amp;gt; 172.16.2.216:80 (active)</span>
<span class="nv">$ </span>c0 bpf lb list
<span class="c"># =&gt; SERVICE ADDRESS           BACKEND ADDRESS (REVNAT_ID) (SLOT)</span>
<span class="c">#    0.0.0.0:30405 (0)         0.0.0.0:0 (8) (0) [NodePort, non-routable]</span>
<span class="c">#    ...</span>
<span class="c">#    10.10.200.121:80 (1)      172.16.1.247:80 (11) (1)</span>
<span class="c">#    10.10.200.121:80 (2)      172.16.2.216:80 (11) (2)</span>
<span class="c">#    ...</span>

<span class="c"># BPF maps</span>
<span class="nv">$ </span>c0 map list <span class="nt">--verbose</span>
<span class="nv">$ </span>c0 map list <span class="nt">--verbose</span> | <span class="nb">grep </span>lb
<span class="c"># =&gt; ## Map: cilium_lb4_backends_v3</span>
<span class="c">#    ## Map: cilium_lb_affinity_match</span>
<span class="c">#    ## Map: cilium_lb4_source_range</span>
<span class="c">#    ## Map: cilium_lb4_affinity</span>
<span class="c">#    ## Map: cilium_lb4_services_v2</span>
<span class="c">#    ## Map: cilium_lb4_reverse_nat</span>
<span class="c">#    ## Map: cilium_lb4_reverse_sk</span>
<span class="c">#    ## Map: cilium_skip_lb4</span>
<span class="nv">$ </span>c0 map get cilium_lb4_services_v2
<span class="c"># =&gt; Key                       Value                 State   Error</span>
<span class="c">#    ...</span>
<span class="c">#    10.10.200.121:80 (1)      20 0 (11) [0x0 0x0]   sync</span>
<span class="c">#    10.10.200.121:80 (0)      0 2 (11) [0x0 0x0]    sync</span>
<span class="c">#    10.10.200.121:80 (2)      21 0 (11) [0x0 0x0]   sync</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 map get cilium_lb4_backends_v3
<span class="c"># =&gt; Key                       Value                 State   Error</span>
<span class="c">#    ...</span>
<span class="c">#    21    ANY://172.16.2.216    sync</span>
<span class="c">#    20    ANY://172.16.1.247    sync</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 map get cilium_lb4_reverse_nat
<span class="c"># =&gt; Key                       Value                 State   Error</span>
<span class="c">#    ...</span>
<span class="c">#    11    10.10.200.121:80      sync</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 map get cilium_lb4_reverse_sk
<span class="c"># =&gt; Key                       Value                 State   Error</span>
<span class="c">#    ...</span>
<span class="c">#    [172.16.2.216]:20480, 22906     [10.10.200.121]:20480, 2816</span>
<span class="c">#    [172.16.1.247]:20480, 19024     [10.10.200.121]:20480, 2816</span>
<span class="c">#    [172.16.2.216]:20480, 30734     [10.10.200.121]:20480, 2816</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 map get cilium_lxc
<span class="c"># =&gt; Key              Value                                                                                            State   Error</span>
<span class="c">#    172.16.0.147:0   id=2724  sec_id=27629 flags=0x0000 ifindex=19  mac=52:59:78:2F:C0:BE nodemac=7E:77:FA:0A:D3:CC   sync</span>
<span class="c">#    172.16.0.223:0   id=640   sec_id=37523 flags=0x0000 ifindex=9   mac=AE:B8:81:A6:B1:28 nodemac=C2:21:B8:92:DA:FD   sync</span>
<span class="c">#    172.16.0.26:0    id=1606  sec_id=4     flags=0x0000 ifindex=21  mac=A2:52:92:B7:C0:D9 nodemac=C2:C0:3A:67:BE:B2   sync</span>
<span class="c">#    172.16.0.148:0   id=655   sec_id=4124  flags=0x0000 ifindex=23  mac=2E:AF:13:F1:DD:88 nodemac=FA:32:54:4B:16:D7   sync</span>
<span class="nv">$ </span>c0 map get cilium_ipcache
<span class="c"># =&gt; 172.16.2.216/32     identity=64309 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    172.16.1.247/32     identity=64309 encryptkey=0 tunnelendpoint=192.168.10.101, flags=&amp;lt;none&amp;gt;   sync</span>
</code></pre></div></div>

<h4 id="prometheusì™€-grafanaë¥¼-í†µí•œ-cilium-ëª¨ë‹ˆí„°ë§">Prometheusì™€ Grafanaë¥¼ í†µí•œ Cilium ëª¨ë‹ˆí„°ë§</h4>

<h5 id="ì„¤ì •">ì„¤ì •</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.16.3/examples/kubernetes/addons/prometheus/monitoring-example.yaml
<span class="c"># =&gt; namespace/cilium-monitoring created</span>
<span class="c">#    serviceaccount/prometheus-k8s created</span>
<span class="c">#    configmap/grafana-config created</span>
<span class="c">#    configmap/grafana-cilium-dashboard created</span>
<span class="c">#    configmap/grafana-cilium-operator-dashboard created</span>
<span class="c">#    configmap/grafana-hubble-dashboard created</span>
<span class="c">#    configmap/grafana-hubble-l7-http-metrics-by-workload created</span>
<span class="c">#    configmap/prometheus created</span>
<span class="c">#    clusterrole.rbac.authorization.k8s.io/prometheus created</span>
<span class="c">#    clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span>
<span class="c">#    service/grafana created</span>
<span class="c">#    service/prometheus created</span>
<span class="c">#    deployment.apps/grafana created</span>
<span class="c">#    deployment.apps/prometheus created</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME                              READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/grafana-65d4578dc4-zcmgz      1/1     Running   0          36s</span>
<span class="c">#    pod/prometheus-7cc8784659-bqchf   1/1     Running   0          36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/grafana      ClusterIP   10.10.200.223   &amp;lt;none&amp;gt;        3000/TCP   36s</span>
<span class="c">#    service/prometheus   ClusterIP   10.10.200.90    &amp;lt;none&amp;gt;        9090/TCP   36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/grafana      1/1     1            1           36s</span>
<span class="c">#    deployment.apps/prometheus   1/1     1            1           36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                    DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/grafana-65d4578dc4      1         1         1       36s</span>
<span class="c">#    replicaset.apps/prometheus-7cc8784659   1         1         1       36s</span>

<span class="c"># íŒŒë“œì™€ ì„œë¹„ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod,svc,ep <span class="nt">-o</span> wide <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME                              READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/grafana-65d4578dc4-zcmgz      1/1     Running   0          49s   172.16.1.208   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/prometheus-7cc8784659-bqchf   1/1     Running   0          49s   172.16.1.248   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE   SELECTOR</span>
<span class="c">#    service/grafana      ClusterIP   10.10.200.223   &amp;lt;none&amp;gt;        3000/TCP   49s   app=grafana</span>
<span class="c">#    service/prometheus   ClusterIP   10.10.200.90    &amp;lt;none&amp;gt;        9090/TCP   49s   app=prometheus</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS           AGE</span>
<span class="c">#    endpoints/grafana      172.16.1.208:3000   49s</span>
<span class="c">#    endpoints/prometheus   172.16.1.248:9090   49s</span>

<span class="c"># NodePort ì„¤ì •</span>
<span class="nv">$ </span>kubectl patch svc grafana <span class="nt">-n</span> cilium-monitoring <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>
<span class="nv">$ </span>kubectl patch svc prometheus <span class="nt">-n</span> cilium-monitoring <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>

<span class="c"># Grafana ì›¹ ì ‘ì†</span>
<span class="nv">$ GPT</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> cilium-monitoring grafana <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Grafana URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$GPT</span><span class="s2">"</span>
<span class="c"># =&gt; Grafana URL = http://54.180.146.116:32172</span>

<span class="c"># Prometheus ì›¹ ì ‘ì† ì •ë³´ í™•ì¸</span>
<span class="nv">$ PPT</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> cilium-monitoring prometheus <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Prometheus URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$PPT</span><span class="s2">"</span>
<span class="c"># =&gt; Prometheus URL = http://54.180.146.116:30426</span>
</code></pre></div></div>

<h5 id="grafana--prometheus-nodeport-ë¡œ-ì›¹-ì ‘ì†-í›„-í™•ì¸">grafana , prometheus NodePort ë¡œ ì›¹ ì ‘ì† í›„ í™•ì¸</h5>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_19.png" alt="img.png" class="image-center" />
<em class="image-caption">Prometheus ëª¨ë‹ˆí„°ë§ í™”ë©´</em></p>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_21.png" alt="img_1.png" class="image-center" />
<em class="image-caption">Grafana ëª¨ë‹ˆí„°ë§ í™”ë©´</em></p>

<h4 id="network-policy-l3-l4-l7">Network Policy (L3, L4, L7)</h4>

<h5 id="cilium-ë³´ì•ˆ-ì†Œê°œ">Cilium ë³´ì•ˆ ì†Œê°œ</h5>

<p>Ciliumì€ ì—¬ëŸ¬ ë ˆë²¨ì˜ ë³´ì•ˆ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/security/network/intro/">ë¬¸ì„œ</a>
ê·¸ ì¤‘ì—ì„œ ë‹¤ìŒ 3ê°€ì§€ë¥¼ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>ID ê¸°ë°˜ (L3) : ì—”ë“œí¬ì¸íŠ¸ ê°„ì˜ ì—°ê²° ì •ì±…ì„ ì •ì˜í•  ë•Œ, ì—”ë“œí¬ì¸íŠ¸ì˜ IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ IDëŠ” ì—”ë“œí¬ì¸íŠ¸ì˜ ë„¤íŠ¸ì›Œí¬ ì£¼ì†Œì™€ ë¬´ê´€í•˜ê²Œ ìœ ì§€ë˜ë©°, 
k8sì˜ labelì„ í†µí•´ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤. ì¦‰, íŒŒë“œê°„ì— ê³µìœ í•  ìˆ˜ ìˆìœ¼ë©°, ë„¤íŠ¸ì›Œí¬ ì£¼ì†Œê°€ ë³€ê²½ë˜ì–´ë„ ìœ ì§€ë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_22.png" alt="img.png" class="image-center w-80" />
<em class="image-caption"><a href="https://docs.cilium.io/en/stable/security/network/identity/">https://docs.cilium.io/en/stable/security/network/identity/</a></em></li>
  <li>í¬íŠ¸ê¸°ë°˜ (L4) : ì—”ë“œí¬ì¸íŠ¸ ê°„ì˜ ì—°ê²° ì •ì±…ì„ ì •ì˜í•  ë•Œ, í¬íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŠ” L3 ì •ì±…ê³¼ í•¨ê»˜ ì‚¬ìš©ë  ìˆ˜ ìˆì–´ì„œ,
<code class="language-plaintext highlighter-rouge">role=frontend</code>ë¼ëŠ” ë ˆì´ë¸”ì„ ê°€ì§„ ì—”ë“œí¬ì¸íŠ¸ëŠ” 443 í¬íŠ¸ë¡œ outgoing ì—°ê²°ì„ í—ˆìš©í•˜ê³ , <code class="language-plaintext highlighter-rouge">role=backend</code>ë¼ëŠ” ë ˆì´ë¸”ì„ ê°€ì§„ ì—”ë“œí¬ì¸íŠ¸ëŠ” 
443 í¬íŠ¸ë¡œ incoming ì—°ê²°ì„ í—ˆìš©í•˜ëŠ” ë“±ì˜ ì •ì±…ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì–´í”Œë¦¬ì¼€ì´ì…˜ (http) ê¸°ë°˜ (L7) : HTTPí†µì‹ ê³¼ RPC í”„ë¡œí† ì½œì˜ ë³´ì•ˆì„ ìœ„í•´ì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì •ë°€í•˜ê²Œ ì •ì±…ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ëŠ” HTTP í—¤ë”, ë©”ì†Œë“œ, ê²½ë¡œ, ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë“±ì„ ì‚¬ìš©í•˜ì—¬ ì •ì±…ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>í”„ë¡ì‹œ ì£¼ì… : Envoy - <a href="https://docs.cilium.io/en/stable/security/network/proxy/">Docs</a>, <a href="https://docs.cilium.io/en/stable/security/network/proxy/envoy/">Envoy</a>
        <ul>
          <li>Ciliumì€ ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ëŒ€í•´ Layer 4 í”„ë¡ì‹œ(ì˜ˆ) Envoy)ë¥¼ ì£¼ì…ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ëŠ” ê³ ì°¨ì›ì˜ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ê°•ì œí•  ìˆ˜ ìˆëŠ” ê¸°ë°˜ì´ ë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_23.png" alt="img.png" class="image-center" />
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_24.png" alt="img.png" class="image-center" /></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="network-policy-ê´€ë ¨-ebpf-datapath">Network Policy ê´€ë ¨ eBPF Datapath</h5>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_25.png" alt="img.png" class="image-center w-80" /></p>

<ul>
  <li>Prefilter : PrefilterëŠ” XDP í”„ë¡œê·¸ë¨ì„ í†µí•´ ìˆ˜í–‰ë˜ë©°, ìµœê³ ì˜ ì„±ëŠ¥ì„ ìœ„í•´ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ í•„í„°ë§í•˜ëŠ” prefilter ê·œì¹™ë“¤ì„ ì œê³µí•©ë‹ˆë‹¤.
íŠ¹íˆ CIDR mapë“¤ì„ ì‚¬ìš©í•´ IP ì£¼ì†Œë¥¼ í•„í„°ë§í•˜ëŠ” ë“±ì˜ ë™ì‘ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Endpoint policy : ì •ì±…ì— ë”°ë¼ íŒ¨í‚·ì„ ì°¨ë‹¨/ì „ë‹¬í•˜ê±°ë‚˜, ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬í•˜ê±°ë‚˜, L7ë¡œ ì •ì±… ì „ë‹¬ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>Cilium datapathëŠ” L3ì™€ L4 ì •ì±…ì„ ê°•ì œí•˜ê±°ë‚˜, íŒ¨í‚·ê³¼ IDë¥¼ ë§¤í•‘í•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>L7 policy : L7 ì •ì±…ì€ í”„ë¡ì‹œ íŠ¸ë˜í”½ì„ Ciliumì˜ userspace proxy instance, ì¦‰ Envoyë¡œ ì „ë‹¬í•©ë‹ˆë‹¤. Envoy ëŠ” íŠ¸ë˜í”½ì„ ì „ë‹¬í•˜ê±°ë‚˜
L7 ì •ì±…ì— ì˜í•´ ì°¨ë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>ğŸ‘‰ L7 ì •ì±…ì€ hookê³¼ Userspace Proxy(envoy)ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ ì¡°ê¸ˆ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h5 id="ì‹¤ìŠµ">ì‹¤ìŠµ</h5>

<ul>
  <li>ìŠ¤íƒ€ì›Œì¦ˆì—ì„œ ì˜ê°ë°›ì€ ì˜ˆì œë¥¼ í†µí•´ Network Policyë¥¼ ì ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>ë””í”Œë¡œì´ë¨¼íŠ¸(ì›¹ ì„œë²„, deathstar, replicas 2), íŒŒë“œ(xwing, tiefighter), ì„œë¹„ìŠ¤(ClusterIP, service/deathstar)</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬</span>
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.16.3/examples/minikube/http-sw-app.yaml
<span class="c"># =&gt; service/deathstar created</span>
<span class="c">#    deployment.apps/deathstar created</span>
<span class="c">#    pod/tiefighter created</span>
<span class="c">#    pod/xwing created</span>
<span class="nv">$ </span>kubectl get all
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/deathstar-689f66b57d-mm72v   1/1     Running   0          15s</span>
<span class="c">#    pod/deathstar-689f66b57d-pz56p   1/1     Running   0          15s</span>
<span class="c">#    pod/tiefighter                   1/1     Running   0          15s</span>
<span class="c">#    pod/xwing                        1/1     Running   0          15s</span>
<span class="c">#    </span>
<span class="c">#    NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/deathstar    ClusterIP   10.10.200.162   &amp;lt;none&amp;gt;        80/TCP    15s</span>
<span class="c">#    service/kubernetes   ClusterIP   10.10.200.1     &amp;lt;none&amp;gt;        443/TCP   8h</span>
<span class="c">#    </span>
<span class="c">#    NAME                        READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/deathstar   2/2     2            2           15s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                   DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/deathstar-689f66b57d   2         2         2       15s</span>

<span class="c"># íŒŒë“œ ë¼ë²¨ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">--show-labels</span>
<span class="c"># =&gt; NAME                         READY   STATUS    RESTARTS   AGE   LABELS</span>
<span class="c">#    deathstar-689f66b57d-mm72v   1/1     Running   0          24s   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=689f66b57d</span>
<span class="c">#    deathstar-689f66b57d-pz56p   1/1     Running   0          24s   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=689f66b57d</span>
<span class="c">#    tiefighter                   1/1     Running   0          24s   app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire</span>
<span class="c">#    xwing                        1/1     Running   0          24s   app.kubernetes.io/name=xwing,class=xwing,org=alliance</span>

<span class="c"># cilium endpoint í™•ì¸</span>
<span class="nv">$ </span>kubectl get ciliumendpoints
<span class="c"># =&gt; NAME                         SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    deathstar-689f66b57d-mm72v   391                 ready            172.16.2.35</span>
<span class="c">#    deathstar-689f66b57d-pz56p   391                 ready            172.16.1.232</span>
<span class="c">#    tiefighter                   9002                ready            172.16.0.5</span>
<span class="c">#    xwing                        10812               ready            172.16.2.31</span>

<span class="nv">$ </span>c0 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    ...</span>
<span class="c">#    2481       Disabled           Disabled          9002       k8s:app.kubernetes.io/name=tiefighter                                               172.16.0.5     ready</span>
<span class="c">#                                                               k8s:class=tiefighter</span>
<span class="c">#                                                               k8s:org=empire</span>
<span class="nv">$ </span>c1 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                        IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    ...</span>
<span class="c">#    1063       Disabled           Disabled          391        k8s:app.kubernetes.io/name=deathstar                                                      172.16.1.232   ready</span>
<span class="c">#                                                               k8s:class=deathstar</span>
<span class="c">#                                                               k8s:org=empire</span>
<span class="nv">$ </span>c2 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                      IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    ...</span>
<span class="c">#    1695       Disabled           Disabled          391        k8s:app.kubernetes.io/name=deathstar                                                    172.16.2.35    ready</span>
<span class="c">#                                                               k8s:class=deathstar</span>
<span class="c">#                                                               k8s:org=empire</span>
<span class="c">#    2810       Disabled           Disabled          10812      k8s:app.kubernetes.io/name=xwing                                                        172.16.2.31    ready</span>
<span class="c">#                                                               k8s:class=xwing</span>
<span class="c">#                                                               k8s:org=alliance</span>

<span class="c"># ë°ìŠ¤ìŠ¤íƒ€ SVC(ClusterIP) ì ‘ì†í•˜ì—¬ ì›¹ íŒŒë“œ ì—°ê²° í™•ì¸ &gt;&gt; Hubble UI ì—ì„œ ì‹¤ì‹œê°„ í™•ì¸í•´ë³´ì!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>hubble observe
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_26.png" alt="img.png" /></p>

<ul>
  <li>Identity-Aware and HTTP-Aware Policy Enforcement <code class="language-plaintext highlighter-rouge">Apply an L3/L4 Policy</code> - <a href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-an-l3-l4-policy">Link</a> &amp; Hubble CLI - <a href="https://docs.cilium.io/en/stable/gettingstarted/hubble_cli/">ë§í¬</a>
    <ul>
      <li>Cilium ì—ì„œëŠ” Endpoint IP ëŒ€ì‹ , <strong>íŒŒë“œ</strong>ì˜ <strong>Labels(ë¼ë²¨)</strong>ì„ ì‚¬ìš©(ê¸°ì¤€)í•˜ì—¬ <strong>ë³´ì•ˆ ì •ì±…ì„ ì ìš©</strong>í•©ë‹ˆë‹¤.</li>
      <li><strong>IP/Port</strong> í•„í„°ë§ì„ <strong>L3/L4 ë„¤íŠ¸ì›Œí¬ ì •ì±…</strong>ì´ë¼ê³  í•©ë‹ˆë‹¤.</li>
      <li>ì•„ë˜ ì²˜ëŸ¼ â€˜org=empireâ€™ Labels(ë¼ë²¨) ë¶€ì°©ëœ íŒŒë“œë§Œ í—ˆìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
      <li>Cilium ì€ <strong>stateful connection tracking</strong>ì„ ì§€ì›í•˜ë¯€ë¡œ ë¦¬í„´ íŠ¸ë˜í”½ì€ ìë™ìœ¼ë¡œ í—ˆìš©ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># L3/L4 ì •ì±… ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f - 
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "rule1"
spec:
  description: "L3-L4 policy to restrict deathstar access to empire ships only"
  endpointSelector:
    matchLabels:
      org: empire
      class: deathstar
  ingress:
  - fromEndpoints:
    - matchLabels:
        org: empire
    toPorts:
    - ports:
      - port: "80"
        protocol: TCP
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/rule1 created</span>

<span class="c"># ì •ì±… í™•ì¸</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME    AGE</span>
<span class="c">#    rule1   9s</span>
<span class="nv">$ </span>kubectl describe cnp rule1
<span class="nv">$ </span>c0 policy get
<span class="c"># =&gt; [</span>
<span class="c">#      {</span>
<span class="c">#        &amp;quot;endpointSelector&amp;quot;: {</span>
<span class="c">#          &amp;quot;matchLabels&amp;quot;: {</span>
<span class="c">#            &amp;quot;any:class&amp;quot;: &amp;quot;deathstar&amp;quot;,</span>
<span class="c">#            &amp;quot;any:org&amp;quot;: &amp;quot;empire&amp;quot;,</span>
<span class="c">#            &amp;quot;k8s:io.kubernetes.pod.namespace&amp;quot;: &amp;quot;default&amp;quot;</span>
<span class="c">#          }</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;ingress&amp;quot;: [</span>
<span class="c">#          {</span>
<span class="c">#            &amp;quot;fromEndpoints&amp;quot;: [</span>
<span class="c">#              {</span>
<span class="c">#                &amp;quot;matchLabels&amp;quot;: {</span>
<span class="c">#                  &amp;quot;any:org&amp;quot;: &amp;quot;empire&amp;quot;,</span>
<span class="c">#                  &amp;quot;k8s:io.kubernetes.pod.namespace&amp;quot;: &amp;quot;default&amp;quot;</span>
<span class="c">#                }</span>
<span class="c">#              }</span>
<span class="c">#            ],</span>
<span class="c">#            &amp;quot;toPorts&amp;quot;: [</span>
<span class="c">#              {</span>
<span class="c">#                &amp;quot;ports&amp;quot;: [</span>
<span class="c">#                  {</span>
<span class="c">#                    &amp;quot;port&amp;quot;: &amp;quot;80&amp;quot;,</span>
<span class="c">#                    &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;</span>
<span class="c">#                  }</span>
<span class="c">#                ]</span>
<span class="c">#              }</span>
<span class="c">#            ]</span>
<span class="c">#          }</span>
<span class="c">#        ],</span>
<span class="c">#        ...</span>
<span class="c">#        &amp;quot;enableDefaultDeny&amp;quot;: {</span>
<span class="c">#          &amp;quot;ingress&amp;quot;: true,</span>
<span class="c">#          &amp;quot;egress&amp;quot;: false</span>
<span class="c">#        },</span>
<span class="c">#        ...</span>
<span class="c">#      }</span>
<span class="c">#    ]</span>

<span class="c"># íŒŒë“œ curl ì ‘ì† ì‹œë„ ì‹œ íŒŒë“œ sh ì ‘ì† í›„ curl ì‹œë„í•˜ì!</span>
<span class="c"># ë°ìŠ¤ìŠ¤íƒ€ SVC(ClusterIP) ì ‘ì†í•˜ì—¬ ì›¹ íŒŒë“œ ì—°ê²° í™•ì¸ &gt;&gt; Hubble UI ì—ì„œ drop í™•ì¸!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; (ì—†ìŒ)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì ‘ì†ì´ drop ë©ë‹ˆë‹¤. xwingì€ í—ˆìš©ë˜ëŠ” `org=empire`ì¸ ì—”ë“œí¬ì¸íŠ¸ê°€ ì•„ë‹Œ `org=alliance`ì¸ ì—”ë“œí¬ì¸íŠ¸ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># hubble cli ëª¨ë‹ˆí„°ë§ </span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> xwing
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> tiefighter
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar
<span class="c"># =&gt; Oct 01 16:28:28.825: default/xwing:39224 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-mm72v:80 (ID:391) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 16:28:28.825: default/xwing:39224 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-mm72v:80 (ID:391) Policy denied DROPPED (TCP Flags: SYN)</span>

<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar <span class="nt">--verdict</span> DROPPED
<span class="c"># =&gt; Oct 01 16:27:50.894: default/xwing:43148 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-pz56p:80 (ID:391) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 16:27:50.894: default/xwing:43148 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-pz56p:80 (ID:391) Policy denied DROPPED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 16:28:24.676: default/xwing:43148 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-pz56p:80 (ID:391) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 16:28:24.676: default/xwing:43148 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-pz56p:80 (ID:391) Policy denied DROPPED (TCP Flags: SYN)</span>

<span class="c"># Inspecting the Policy</span>
<span class="c"># If we run cilium endpoint list again we will see that the pods with the label org=empire and class=deathstar</span>
<span class="c"># now have ingress policy enforcement enabled as per the policy above.</span>

<span class="c"># endpoint list ì—ì„œ ì •ì±… ì ìš© í™•ì¸</span>
<span class="nv">$ </span>c0 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    2481       Disabled           Disabled          9002       k8s:app.kubernetes.io/name=tiefighter                                               172.16.0.5     ready</span>
<span class="c">#                                                               k8s:class=tiefighter</span>
<span class="c">#                                                               k8s:org=empire </span>
<span class="nv">$ </span>c1 endpoint list | <span class="nb">grep </span>deathstar
<span class="c"># =&gt; 1063       Enabled            Disabled          391        k8s:app.kubernetes.io/name=deathstar                                                      172.16.1.232   ready</span>
<span class="c">#                                                               k8s:class=deathstar</span>
<span class="nv">$ </span>c2 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                      IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    1695       Enabled            Disabled          391        k8s:app.kubernetes.io/name=deathstar                                                    172.16.2.35    ready</span>
<span class="c">#                                                               k8s:class=deathstar</span>
<span class="c">#                                                               k8s:org=empire</span>
<span class="c">#    2810       Disabled           Disabled          10812      k8s:app.kubernetes.io/name=xwing                                                        172.16.2.31    ready</span>
<span class="c">#                                                               k8s:class=xwing</span>
<span class="c">#                                                               k8s:org=alliance</span>
</code></pre></div></div>

<ul>
  <li>Identity-Aware and HTTP-Aware Policy Enforcement Apply and Test HTTP-aware L7 Policy - <a href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-and-test-http-aware-l7-policy">Docs</a>
    <ul>
      <li>HTTP L7 í•„í„°ë§ì„ ì ìš© : PUT /v1/exhaust-port ìš”ì²­ì„ ì°¨ë‹¨í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°ìŠ¤ìŠ¤íƒ€ SVC(ClusterIP) ì ‘ì†</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPUT</span> deathstar.default.svc.cluster.local/v1/exhaust-port
<span class="c"># =&gt; Panic: deathstar exploded</span>
<span class="c">#    ...</span>

<span class="c"># POST /v1/request-landing API í˜¸ì¶œë§Œ í—ˆìš© ì •ì±…ìœ¼ë¡œ ê¸°ì¡´ ì •ì±… ë‚´ìš©ì„ ì—…ë°ì´íŠ¸(configured)!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f - 
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "rule1"
spec:
  description: "L7 policy to restrict access to specific HTTP call"
  endpointSelector:
    matchLabels:
      org: empire
      class: deathstar
  ingress:
  - fromEndpoints:
    - matchLabels:
        org: empire
    toPorts:
    - ports:
      - port: "80"
        protocol: TCP
      rules:
        http:
        - method: "POST"
          path: "/v1/request-landing"
</span><span class="no">EOF

</span><span class="c"># ì •ì±… í™•ì¸</span>
<span class="nv">$ </span>kubectl describe ciliumnetworkpolicies
<span class="c"># =&gt; Name:         rule1</span>
<span class="c">#    Namespace:    default</span>
<span class="c">#    Labels:       &amp;lt;none&amp;gt;</span>
<span class="c">#    Annotations:  &amp;lt;none&amp;gt;</span>
<span class="c">#    API Version:  cilium.io/v2</span>
<span class="c">#    Kind:         CiliumNetworkPolicy</span>
<span class="c">#    Metadata:</span>
<span class="c">#      Creation Timestamp:  2024-10-01T16:24:53Z</span>
<span class="c">#      Generation:          2</span>
<span class="c">#      Resource Version:    32642</span>
<span class="c">#      UID:                 d3527eec-5832-4273-b805-c006c728a8af</span>
<span class="c">#    Spec:</span>
<span class="c">#      Description:  L7 policy to restrict access to specific HTTP call</span>
<span class="c">#      Endpoint Selector:</span>
<span class="c">#        Match Labels:</span>
<span class="c">#          Class:  deathstar</span>
<span class="c">#          Org:    empire</span>
<span class="c">#      Ingress:</span>
<span class="c">#        From Endpoints:</span>
<span class="c">#          Match Labels:</span>
<span class="c">#            Org:  empire</span>
<span class="c">#        To Ports:</span>
<span class="c">#          Ports:</span>
<span class="c">#            Port:      80</span>
<span class="c">#            Protocol:  TCP</span>
<span class="c">#          Rules:</span>
<span class="c">#            Http:</span>
<span class="c">#              Method:  POST</span>
<span class="c">#              Path:    /v1/request-landing</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 policy get

<span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>c1 monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
<span class="nv">$ </span>c2 monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
<span class="c"># =&gt; &amp;lt;- Request http from 0 ([k8s:app.kubernetes.io/name=tiefighter k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]) to 1695 ([k8s:app.kubernetes.io/name=deathstar k8s:class=deathstar k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]), identity 9002-&amp;gt;391, verdict Forwarded POST http://deathstar.default.svc.cluster.local/v1/request-landing =&amp;gt; 0</span>
<span class="c">#    &amp;lt;- Response http to 0 ([k8s:app.kubernetes.io/name=tiefighter k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]) from 1695 ([k8s:app.kubernetes.io/name=deathstar k8s:class=deathstar k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]), identity 391-&amp;gt;9002, verdict Forwarded POST http://deathstar.default.svc.cluster.local/v1/request-landing =&amp;gt; 200</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar <span class="nt">--verdict</span> DROPPED

<span class="c"># ì ‘ê·¼ í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPUT</span> deathstar.default.svc.cluster.local/v1/exhaust-port
<span class="c"># =&gt; Access denied</span>

<span class="c">## hubble cli ì— ì°¨ë‹¨ ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar <span class="nt">--verdict</span> DROPPED
<span class="c"># =&gt; Oct 01 16:41:48.094: default/tiefighter:51860 (ID:9002) -&amp;gt; default/deathstar-689f66b57d-mm72v:80 (ID:391) http-request DROPPED (HTTP/1.1 PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port)</span>
<span class="c">#    Oct 01 16:41:48.094: default/tiefighter:51860 (ID:9002) &amp;lt;- default/deathstar-689f66b57d-mm72v:80 (ID:391) http-response FORWARDED (HTTP/1.1 403 0ms (PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port))</span>

<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar <span class="nt">--protocol</span> http
<span class="c"># =&gt; Oct 01 16:39:57.041: default/tiefighter:57616 (ID:9002) &amp;lt;- default/deathstar-689f66b57d-mm72v:80 (ID:391) http-response FORWARDED (HTTP/1.1 200 2ms (POST http://deathstar.default.svc.cluster.local/v1/request-landing))</span>

<span class="c"># ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.16.3/examples/minikube/http-sw-app.yaml
<span class="c"># =&gt; service &amp;quot;deathstar&amp;quot; deleted</span>
<span class="c">#    deployment.apps &amp;quot;deathstar&amp;quot; deleted</span>
<span class="c">#    pod &amp;quot;tiefighter&amp;quot; deleted</span>
<span class="c">#    pod &amp;quot;xwing&amp;quot; deleted</span>
<span class="nv">$ </span>kubectl delete cnp rule1
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io &amp;quot;rule1&amp;quot; deleted</span>
</code></pre></div></div>

<h4 id="bandwidth-manager">Bandwidth Manager</h4>

<h5 id="bandwidth-manager-ì†Œê°œ">Bandwidth Manager ì†Œê°œ</h5>

<ul>
  <li>Ciliumì€ Bandwidth(ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­)ê³¼ Latency optimization(ì§€ì—° ì‹œê°„ ìµœì í™”)ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/network/kubernetes/bandwidth-manager/">Link</a> , <a href="https://cilium.io/use-cases/bandwidth-optimization/">Home</a> , <a href="https://www.youtube.com/watch?v=QTSS6ktK8hY">Youtube</a>
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_27.png" alt="img.png" class="image-center w-80" />
<em class="image-caption"><a href="https://cilium.io/use-cases/bandwidth-optimization/">https://cilium.io/use-cases/bandwidth-optimization/</a></em>
    <ul>
      <li>bandwidth managerëŠ” TCPì™€ UDP ë¶€í•˜ë¥¼ ìµœì í™” í•˜ê³ , íš¨ìœ¨ì ìœ¼ë¡œ ê°œë³„ íŒŒë“œì˜ ì ‘ì†ë¥ ì„ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. - <strong>EDT</strong>(Earliest Departure Time) ì™€ <strong>eBPF</strong> ì‚¬ìš©</li>
      <li><code class="language-plaintext highlighter-rouge">kubernetes.io/egress-bandwidth</code> Pod <strong>annotation</strong> ì€ egress íŠ¸ë˜í”½ì— ëŒ€í•´ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ì˜ ëŒ€ì—­í­ ì œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤.</li>
      <li><del><code class="language-plaintext highlighter-rouge">kubernetes.io/ingress-bandwidth</code></del> <strong>annotation</strong> ì€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
      <li>direct routing mode, tunneling mode ë‘˜ ë‹¤ ì§€ì›í•©ë‹ˆë‹¤.</li>
      <li>Limitations : L7 ì •ì±…ê³¼ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_28.png" alt="img.png" class="image-center w-80" /></li>
    </ul>
  </li>
</ul>

<h5 id="ì„¤ì •-ë°-í™•ì¸">ì„¤ì • ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì¸í„°í˜ì´ìŠ¤ tc qdisc í™•ì¸</span>
<span class="nv">$ </span>tc qdisc show dev enp0s8
<span class="c"># =&gt; qdisc fq_codel 0: root refcnt 2 limit 10240p flows 1024 quantum 1514 target 5ms interval 100ms memory_limit 32Mb ecn drop_batch 64</span>
<span class="c">#    qdisc clsact ffff: parent ffff:fff1</span>

<span class="c"># ì„¤ì •</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="nt">--set</span> bandwidthManager.enabled<span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Release &amp;quot;cilium&amp;quot; has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="c"># ì ìš© í™•ì¸</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>bandwidth
<span class="c"># =&gt; enable-bandwidth-manager                          true</span>

<span class="c"># egress bandwidth limitation ë™ì‘í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>c0 status | <span class="nb">grep  </span>BandwidthManager
<span class="c"># =&gt; BandwidthManager:        EDT with BPF [CUBIC] [enp0s3, enp0s8]</span>

<span class="c"># ì¸í„°í˜ì´ìŠ¤ tc qdisc í™•ì¸ : ì„¤ì • ì „í›„ ì˜µì…˜ê°’ë“¤ì´ ìƒë‹¹íˆ ì¶”ê°€ëœë‹¤</span>
<span class="nv">$ </span>tc qdisc
<span class="nv">$ </span>tc qdisc show dev enp0s8
<span class="c"># =&gt; qdisc fq 8006: root refcnt 2 limit 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 3028b initial_quantum 15140b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_cap</span>
<span class="c">#    qdisc clsact ffff: parent ffff:fff1</span>
</code></pre></div></div>

<h5 id="ë™ì‘-ë°-í™•ì¸">ë™ì‘ ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ íŠ¸ë˜í”½ ë°œìƒ ì„œë²„/í´ë¼ì´ì–¸íŠ¸ íŒŒë“œ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
---
apiVersion: v1
kind: Pod
metadata:
  annotations:
    # Limits egress bandwidth to 10Mbit/s.
    kubernetes.io/egress-bandwidth: "10M"
  labels:
    # This pod will act as server.
    app.kubernetes.io/name: netperf-server
  name: netperf-server
spec:
  containers:
  - name: netperf
    image: cilium/netperf
    ports:
    - containerPort: 12865
---
apiVersion: v1
kind: Pod
metadata:
  # This Pod will act as client.
  name: netperf-client
spec:
  affinity:
    # Prevents the client from being scheduled to the
    # same node as the server.
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - netperf-server
        topologyKey: kubernetes.io/hostname
  containers:
  - name: netperf
    args:
    - sleep
    - infinity
    image: cilium/netperf
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/netperf-server created</span>
<span class="c">#    pod/netperf-client created</span>

<span class="c"># egress BW ì œí•œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe pod netperf-server | <span class="nb">grep </span>Annotations:
<span class="c"># =&gt; Annotations:      kubernetes.io/egress-bandwidth: 10M</span>

<span class="c"># egress BW ì œí•œì´ ì„¤ì •ëœ íŒŒë“œê°€ ìˆëŠ” cilium pod ì—ì„œ ì œí•œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>c0 bpf bandwidth list
<span class="nv">$ </span>c1 bpf bandwidth list
<span class="nv">$ </span>c2 bpf bandwidth list
<span class="c"># =&gt; IDENTITY   EGRESS BANDWIDTH (BitsPerSec)</span>
<span class="c">#    1391       10M</span>

<span class="nv">$ </span>c0 endpoint list
<span class="nv">$ </span>c1 endpoint list
<span class="nv">$ </span>c2 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                      IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    1391       Disabled           Disabled          8191       k8s:app.kubernetes.io/name=netperf-server                                               172.16.2.106   ready</span>
<span class="c">#    ...</span>

<span class="c"># íŠ¸ë˜í”½ ë°œìƒ &gt;&gt; Hubble UI ì—ì„œ í™•ì¸</span>
<span class="c"># egress traffic of the netperf-server Pod has been limited to 10Mbit per second. </span>
<span class="nv">$ NETPERF_SERVER_IP</span><span class="o">=</span><span class="si">$(</span>kubectl get pod netperf-server <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>netperf-client <span class="nt">--</span> netperf <span class="nt">-t</span> TCP_MAERTS <span class="nt">-H</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NETPERF_SERVER_IP</span><span class="k">}</span><span class="s2">"</span>
<span class="c"># =&gt; Recv   Send    Send</span>
<span class="c">#    Socket Socket  Message  Elapsed</span>
<span class="c">#    Size   Size    Size     Time     Throughput</span>
<span class="c">#    bytes  bytes   bytes    secs.    10^6bits/sec</span>
<span class="c">#    131072  16384  16384    10.01       9.13</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 10Mbps ì œí•œ í™•ì¸!&lt;/span&gt;</span>

<span class="c"># 5M ì œí•œ ì„¤ì • í›„ í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl get pod netperf-server <span class="nt">-o</span> json | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s|10M|5M|g'</span> | kubectl apply <span class="nt">-f</span> -
<span class="c"># =&gt; pod/netperf-server configured</span>
<span class="nv">$ </span>c0 bpf bandwidth list
<span class="nv">$ </span>c1 bpf bandwidth list
<span class="nv">$ </span>c2 bpf bandwidth list
<span class="c"># =&gt; IDENTITY   EGRESS BANDWIDTH (BitsPerSec)</span>
<span class="c">#    1391       5M</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>netperf-client <span class="nt">--</span> netperf <span class="nt">-t</span> TCP_MAERTS <span class="nt">-H</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NETPERF_SERVER_IP</span><span class="k">}</span><span class="s2">"</span>
<span class="c"># =&gt; Recv   Send    Send</span>
<span class="c">#    Socket Socket  Message  Elapsed</span>
<span class="c">#    Size   Size    Size     Time     Throughput</span>
<span class="c">#    bytes  bytes   bytes    secs.    10^6bits/sec</span>
<span class="c">#    </span>
<span class="c">#    131072  16384  16384    10.01       4.59</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 4.5Mbps ì œí•œ í™•ì¸!&lt;/span&gt;</span>

<span class="c"># 20M ì œí•œ ì„¤ì • í›„ í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl get pod netperf-server <span class="nt">-o</span> json | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s|5M|20M|g'</span> | kubectl apply <span class="nt">-f</span> -
<span class="c"># =&gt; pod/netperf-server configured</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>netperf-client <span class="nt">--</span> netperf <span class="nt">-t</span> TCP_MAERTS <span class="nt">-H</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NETPERF_SERVER_IP</span><span class="k">}</span><span class="s2">"</span>
<span class="c"># =&gt; Recv   Send    Send</span>
<span class="c">#    Socket Socket  Message  Elapsed</span>
<span class="c">#    Size   Size    Size     Time     Throughput</span>
<span class="c">#    bytes  bytes   bytes    secs.    10^6bits/sec</span>
<span class="c">#    131072  16384  16384    10.00      18.40</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 19Mbps ì œí•œ í™•ì¸!&lt;/span&gt;</span>

<span class="nv">$ </span>tc qdisc show dev enp0s8
<span class="c"># =&gt; qdisc fq 8006: root refcnt 2 limit 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 3028b initial_quantum 15140b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_cap</span>
<span class="c">#    qdisc clsact ffff: parent ffff:fff1</span>

<span class="c"># ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete pod netperf-client netperf-server
</code></pre></div></div>

<h4 id="l2-announcements--l2-aware-lb-beta">L2 Announcements / L2 Aware LB (Beta)</h4>

<ul>
  <li>ì°¸ê³  ë§í¬ : <a href="https://docs.cilium.io/en/stable/network/l2-announcements/">Link</a> , <a href="https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/">Blog</a></li>
  <li>L2 AnnouncementsëŠ” ë¡œì»¬ ì˜ì—­ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì„œë¹„ìŠ¤ë¥¼ í‘œì‹œí•˜ê³  ë„ë‹¬ ê°€ëŠ¥í•˜ê²Œ ë§Œë“œëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. 
ì´ ê¸°ëŠ¥ì€ ì£¼ë¡œ ì‚¬ë¬´ì‹¤ ë˜ëŠ” ìº í¼ìŠ¤ ë„¤íŠ¸ì›Œí¬ì™€ ê°™ì´ BGP ê¸°ë°˜ ë¼ìš°íŒ…ì´ ì—†ëŠ” ë„¤íŠ¸ì›Œí¬ ë‚´ì—ì„œ ì˜¨í”„ë ˆë¯¸ìŠ¤ ë°°í¬ë¥¼ ìœ„í•´ ê³ ì•ˆë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ExternalIP ë° LoadBalancer IPì— ëŒ€í•œ ARP ì¿¼ë¦¬ì— ì‘ë‹µí•©ë‹ˆë‹¤. 
ì´ëŸ¬í•œ IPëŠ” ì—¬ëŸ¬ ë…¸ë“œì˜ ê°€ìƒ IP(ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ì— ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ)ì´ë¯€ë¡œ ê° ì„œë¹„ìŠ¤ì— ëŒ€í•´ í•œ ë²ˆì— í•œ ë…¸ë“œê°€ 
ARP ì¿¼ë¦¬ì— ì‘ë‹µí•˜ê³  MAC ì£¼ì†Œë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.
ì´ ë…¸ë“œëŠ” ì„œë¹„ìŠ¤ ë¡œë“œ ë°¸ëŸ°ì‹± ê¸°ëŠ¥ìœ¼ë¡œ ë¡œë“œ ë°¸ëŸ°ì‹±ì„ ìˆ˜í–‰í•˜ì—¬ ë¶ìª½/ë‚¨ìª½ ë¡œë“œ ë°¸ëŸ°ì„œ ì—­í• ì„ í•©ë‹ˆë‹¤.</li>
  <li>NodePort ì„œë¹„ìŠ¤ì— ë¹„í•´ ì´ ê¸°ëŠ¥ì˜ ì¥ì ì€ ê° ì„œë¹„ìŠ¤ê°€ ê³ ìœ í•œ IPë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ê°€ ë™ì¼í•œ í¬íŠ¸ ë²ˆí˜¸ë¥¼
ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. 
NodePortë¥¼ ì‚¬ìš©í•  ë•Œ íŠ¸ë˜í”½ì„ ë³´ë‚¼ í˜¸ìŠ¤íŠ¸ë¥¼ ê²°ì •í•˜ëŠ” ê²ƒì€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë‹¬ë ¤ ìˆìœ¼ë©° ë…¸ë“œê°€ ë‹¤ìš´ë˜ë©´
IP+Port ì½¤ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤. L2 ê³µì§€ë¥¼ ì‚¬ìš©í•˜ë©´ ì„œë¹„ìŠ¤ VIPê°€ ë‹¤ë¥¸ ë…¸ë“œë¡œ ê°„ë‹¨íˆ ë§ˆì´ê·¸ë ˆì´ì…˜ë˜ê³  ê³„ì† ì‘ë™í•©ë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ í†µí•´ MetalLBì™€ ê°™ì€ ì™¸ë¶€ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ Ciliumìœ¼ë¡œ ëŒ€ì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_29.png" alt="img.png" class="image-center w-80" />
<em class="image-caption"><a href="https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/">https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/</a></em></p>

<h5 id="ì„¤ì •-ë°-í™•ì¸-1">ì„¤ì • ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> l2announcements.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> externalIPs.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> l2announcements.leaseDuration<span class="o">=</span>3s <span class="nt">--set</span> l2announcements.leaseRenewDeadline<span class="o">=</span>1s <span class="nt">--set</span> l2announcements.leaseRetryPeriod<span class="o">=</span>200ms
<span class="c"># =&gt; Release &amp;quot;cilium&amp;quot; has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>
 
<span class="c">#</span>
<span class="nv">$ </span>c0 config <span class="nt">--all</span> | <span class="nb">grep </span>L2
<span class="c"># =&gt; EnableL2Announcements             : true</span>
<span class="c">#    EnableL2NeighDiscovery            : true</span>

<span class="c"># CiliumL2AnnouncementPolicy ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f - 
apiVersion: "cilium.io/v2alpha1"
kind: CiliumL2AnnouncementPolicy
metadata:
  name: policy1
spec:
  serviceSelector:
    matchLabels:
      color: blue
  nodeSelector:
    matchExpressions:
      - key: node-role.kubernetes.io/control-plane
        operator: DoesNotExist
  interfaces:
  - ^enp0s[0-9]+
  externalIPs: true
  loadBalancerIPs: true
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliuml2announcementpolicy.cilium.io/policy1 created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get ciliuml2announcementpolicy
<span class="c"># =&gt; NAME      AGE</span>
<span class="c">#    policy1   7s</span>
<span class="nv">$ </span>kubectl describe l2announcement

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f - 
apiVersion: "cilium.io/v2alpha1"
kind: CiliumLoadBalancerIPPool
metadata:
  name: "cilium-pool"
spec:
  allowFirstLastIPs: "No"
  blocks:
  - cidr: "10.10.200.0/29"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumloadbalancerippool.cilium.io/cilium-pool created</span>

<span class="c"># cilium ip pool ì¡°íšŒ</span>
<span class="nv">$ </span>kubectl get CiliumLoadBalancerIPPool
<span class="c"># =&gt; NAME          DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-pool   false      False         6               9s</span>
</code></pre></div></div>

<h5 id="í…ŒìŠ¤íŠ¸ìš©-íŒŒë“œ-ì„œë¹„ìŠ¤-ìƒì„±">í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ, ì„œë¹„ìŠ¤ ìƒì„±</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: webpod1
  labels:
    app: webpod
spec:
  nodeName: k3s-w1
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod2
  labels:
    app: webpod
spec:
  nodeName: k3s-w2
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Service
metadata:
  name: svc1
spec:
  ports:
    - name: svc1-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer  # ğŸ‘‰ ì„œë¹„ìŠ¤ íƒ€ì…ì´ LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: svc2
spec:
  ports:
    - name: svc2-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer  # ğŸ‘‰ ì„œë¹„ìŠ¤ íƒ€ì…ì´ LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: svc3
spec:
  ports:
    - name: svc3-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer  # ğŸ‘‰ ì„œë¹„ìŠ¤ íƒ€ì…ì´ LoadBalancer
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/webpod1 created</span>
<span class="c">#    pod/webpod2 created</span>
<span class="c">#    service/svc1 created</span>
<span class="c">#    service/svc2 created</span>
<span class="c">#    service/svc3 created</span>
</code></pre></div></div>

<h5 id="ì ‘ì†-í™•ì¸">ì ‘ì† í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get svc,ep
<span class="c"># =&gt; NAME                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/kubernetes   ClusterIP      10.10.200.1     &amp;lt;none&amp;gt;        443/TCP        10h</span>
<span class="c">#    service/svc1         LoadBalancer   10.10.200.214   10.10.200.1   80:30456/TCP   98s</span>
<span class="c">#    service/svc2         LoadBalancer   10.10.200.240   10.10.200.2   80:30367/TCP   98s</span>
<span class="c">#    service/svc3         LoadBalancer   10.10.200.155   10.10.200.3   80:31800/TCP   98s</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                        AGE</span>
<span class="c">#    endpoints/kubernetes   192.168.10.10:6443               10h</span>
<span class="c">#    endpoints/svc1         172.16.1.32:80,172.16.2.115:80   98s</span>
<span class="c">#    endpoints/svc2         172.16.1.32:80,172.16.2.115:80   98s</span>
<span class="c">#    endpoints/svc3         172.16.1.32:80,172.16.2.115:80   98s</span>

<span class="c">#</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> 10.10.200.1
<span class="c"># =&gt; Hostname: webpod1</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 172.16.1.32</span>
<span class="c">#    RemoteAddr: 192.168.10.10:58036</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 10.10.200.1</span>
<span class="c">#    User-Agent: curl/7.81.0</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> 10.10.200.2
<span class="c"># =&gt; Hostname: webpod2</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 172.16.2.115</span>
<span class="c">#    RemoteAddr: 192.168.10.10:53496</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 10.10.200.2</span>
<span class="c">#    User-Agent: curl/7.81.0</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> 10.10.200.3
<span class="c"># =&gt; Hostname: webpod1</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 172.16.1.32</span>
<span class="c">#    RemoteAddr: 192.168.10.10:54098</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 10.10.200.3</span>
<span class="c">#    User-Agent: curl/7.81.0</span>
<span class="c">#    Accept: */*</span>
</code></pre></div></div>

<p>ì´ìƒê³¼ ê°™ì´ Cilium ë§Œìœ¼ë¡œ Loadbalancerìœ í˜•ì˜ Serviceë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆ ê¸€ì—ì„œëŠ” Cilium CNIì˜ ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì„ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.
Cilium CNIì€ ì•Œë©´ ì•Œìˆ˜ë¡ â€œëíŒì™•â€, â€œItâ€™s magic!â€ì´ë¼ëŠ” ë§ì´ ê³„ì† ë– ì˜¬ëìŠµë‹ˆë‹¤.
ì•„ë˜ì˜ ë§ê³¼ ì°¸ ë§ë‹¿ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<blockquote>
  <p>â€œì¶©ë¶„íˆ ë°œë‹¬í•œ ê³¼í•™ ê¸°ìˆ ì€ ë§ˆë²•ê³¼ êµ¬ë³„í•  ìˆ˜ ì—†ë‹¤â€ - ì•„ì„œ í´ë¼í¬</p>
</blockquote>

<p>ìŠ¤í„°ë”” ì¤‘ì—ë„ ê°€ì‹œë‹¤ ë‹˜ì´ â€œë©ë‹ˆë‹¤â€ë¥¼ ì—°ë°œí•˜ì…”ì„œ â€œë‹¤ ë˜ëŠ” í˜ì´â€ KB í˜ì´ ê´‘ê³ ê°€ ìƒê°ë‚¬ìŠµë‹ˆë‹¤. 
ì •ë§ ë‹¤ ë˜ëŠ” CNIì¸ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ë¬¼ë¡  eBPFë‚˜ Envoyì™€ ê°™ì€ ê¸°ìˆ ë“¤ì´ ìˆì—ˆê¸°ì— Ciliumì´ ê°€ëŠ¥í•œ ê²ƒì´ì§€ë§Œ, ì°¸ ëŒ€ë‹¨í•©ë‹ˆë‹¤.
ì´ë²ˆì— ì‹¤ìŠµí•œê²ƒ ì™¸ì—ë„ ë” ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì´ ìˆì–´ì„œ, ë”ìš±ë” ê³µë¶€í•´ì•¼ê² ë‹¤ëŠ” ìƒê°ì´ ë“­ë‹ˆë‹¤.</p>

<p>ì–´ëŠë§ ë‹¤ìŒì£¼ê°€ ë§ˆì§€ë§‰ ì£¼ì°¨ì…ë‹ˆë‹¤. ì´ëŸ° ì €ëŸ° ì¼ë“¤ë¡œ ìŠ¤í„°ë”” í¬ê¸°í• ê¹Œ í•˜ëŠ” ë•Œë„ ìˆì—ˆëŠ”ë° ì–´ì°Œì €ì°Œ ì˜ ë²„í…¼ìŠµë‹ˆë‹¤. 
ë‹¤ìŒì£¼ì—ëŠ” ì¢€ ë” ì¼ì° ê³¼ì œë¥¼ ì œì¶œí•  ìˆ˜ ìˆê¸°ë¥¼ ë°”ë¼ë©°
ì´ë§Œ í¬ìŠ¤íŒ…ì„ ë§ˆì¹˜ê² ìŠµë‹ˆë‹¤.</p>]]></content><author><name></name></author><category term="kans" /><category term="kubernetes," /><category term="network," /><category term="linux" /><summary type="html"><![CDATA[ì´ë²ˆì£¼ì—ëŠ” ë“œë””ì–´ CNIì˜ ëíŒ ì™•(ì œê°€ ì•„ëŠ” í•œì—ì„œ)ì¸ Ciliumì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[KANS 3ê¸°] Service Mesh : Istio - Mode (Sidecar, Ambient)</title><link href="https://sweetlittlebird.github.io/posts/2024-10-19-KANS-Study-Week7/" rel="alternate" type="text/html" title="[KANS 3ê¸°] Service Mesh : Istio - Mode (Sidecar, Ambient)" /><published>2024-10-19T01:00:18+09:00</published><updated>2024-10-19T01:00:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/KANS%20Study%20-%20Week7</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2024-10-19-KANS-Study-Week7/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆì£¼ì—ëŠ” Service Meshì™€ ëŒ€í‘œì ì¸ ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ì¸ Istioì— ëŒ€í•´ ì•Œì•„ ë³´ê² ìŠµë‹ˆë‹¤.
KANS 3ê¸° 7ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="istio-ì†Œê°œ">Istio ì†Œê°œ</h2>

<p>IstioëŠ” ì„œë¹„ìŠ¤ ë©”ì‹œë¥¼ êµ¬ì¶•í•˜ê³  ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì˜¤í”ˆì†ŒìŠ¤ í”Œë«í¼ì…ë‹ˆë‹¤. Istioë¥¼ ì•Œì•„ë³´ê¸°ì— ì•ì„œ ì„œë¹„ìŠ¤ ë©”ì‹œì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h3 id="ì„œë¹„ìŠ¤-ë©”ì‹œ-service-meshë€">ì„œë¹„ìŠ¤ ë©”ì‹œ (Service Mesh)ë€?</h3>

<ul>
  <li><strong>ì„œë¹„ìŠ¤ ë©”ì‹œ</strong>ëŠ” ì„œë¹„ìŠ¤ ê°„ <strong>í†µì‹ ì„ ì œì–´</strong>í•˜ê³  <strong>ëª¨ë‹ˆí„°ë§</strong>í•˜ëŠ” ë ˆì´ì–´ë¥¼ ì œê³µí•˜ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ê³„ì¸µì…ë‹ˆë‹¤.</li>
  <li><strong>ë“±ì¥ë°°ê²½</strong> : MSA í™˜ê²½ì—ì„œ ì„œë¹„ìŠ¤ê°€ ë§ì•„ì§€ë‹¤ ë³´ë‹ˆ ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì´ ë³µì¡í•´ì§€ê³ , ì´ë¡œ ì¸í•´ ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì„ ê´€ë¦¬í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ëŠ” ê²ƒì´ ì–´ë ¤ì›Œì¡ŒìŠµë‹ˆë‹¤.
ì´ë¡œì¸í•´ ì¥ì• ê°€ ë°œìƒí•˜ê±°ë‚˜ ë³‘ëª© í˜„ìƒì´ ë°œìƒí–ˆì„ë•Œ ì›ì¸ê³¼ ë°œìƒí•˜ëŠ” êµ¬ê°„ì„ ì°¾ê¸°ê°€ ì–´ë ¤ì›Œì¡ŒìŠµë‹ˆë‹¤. ì´ê²ƒì„ í•´ê²° í•˜ê¸° ìœ„í•´ ë“±ì¥í•œ ê²ƒì´ ì„œë¹„ìŠ¤ ë©”ì‹œì…ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_1.png" alt="img.png" class="image-center w-80" /></li>
  <li><strong>ê°œë…</strong> : ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ê°„ì— í†µì‹ ì´ë‚˜ ê²½ë¡œë¥¼ ì œì–´ - ì˜ˆ) istio, linkerd, consul, envoy, â€¦</li>
  <li><strong>ê¸°ë³¸ ë™ì‘</strong> : íŒŒë“œê°„ í†µì‹ ê²½ë¡œì— í”„ë¡ì‹œë¥¼ ë‘ê³  íŠ¸ë˜í”½ì„ ëª¨ë‹ˆí„°ë§í•˜ê±°ë‚˜ ì»¨íŠ¸ë¡¤ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ê¸°ì¡´ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ìˆ˜ì •í•˜ì§€ ì•Šê³ ë„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_2.png" alt="img.png" class="image-center w-80" />
ìœ„ì˜ ê·¸ë¦¼ ì²˜ëŸ¼ ì„œë¹„ìŠ¤ ë©”ì‹œëŠ” ê° íŒŒë“œì— í”„ë¡ì‹œë¥¼ ë‘ê³  í”„ë¡ì‹œë¥¼ í†µí•´ í†µì‹ ì„ í•˜ë„ë¡í•œ ë‹¤ìŒ í”„ë¡ì‹œë¥¼ í†µí•´ íŠ¸ë˜í”½ì„ ëª¨ë‹ˆí„°ë§í•˜ê±°ë‚˜ ì»¨íŠ¸ë¡¤ í•©ë‹ˆë‹¤.
    <ul>
      <li>ì´ë•Œ í”„ë¡ì‹œëŠ” <strong>Sidecar</strong> ëª¨ë“œë¡œ ë™ì‘í•˜ê±°ë‚˜ <strong>Ambient</strong> ëª¨ë“œë¡œ ë™ì‘í•˜ë©° ëŒ€í‘œì ì¸ í”„ë¡ì‹œë¡œëŠ” Envoysê°€ ìˆìŠµë‹ˆë‹¤.</li>
      <li>EnvoyëŠ” êµ¬ê¸€, IBM, Lyftê°€ ì¤‘ì‹¬ì´ ë˜ì–´ ê°œë°œí•˜ê³  ìˆëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡ì‹œì…ë‹ˆë‹¤.</li>
      <li>ë„¤íŠ¸ì›Œí¬ íˆ¬ëª…ì„±ì„ ëª©í‘œë¡œ ë‹¤ì–‘í•œ í•„í„° ì²´ì¸ ì§€ì›(L3, L4, L7), ë™ì  Configuration APIë¥¼ ì œê³µí•˜ê³ , hot reloadë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li><strong>ì£¼ìš”ê¸°ëŠ¥</strong>
    <ul>
      <li><strong>íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§</strong> : ìš”ì²­ì˜ ì—ëŸ¬ìœ¨, ì§€ì—°ì‹œê°„, ì»¨ë„¥ì…˜ ê°œìˆ˜, ìš”ì²­ê°œìˆ˜ ë“±ì˜ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ì—¬ ëª¨ë‹ˆí„°ë§í•˜ê³ , ì„œë¹„ìŠ¤ê°„ í˜¹ì€ íŠ¹ì • ìš”ì²­ ê²½ë¡œë¥¼ í•„í„°ë§ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
=&gt; ì›ì¸ íŒŒì•… ìš©ì´</li>
      <li><strong>íŠ¸ë˜í”½ ì»¨íŠ¸ë¡¤</strong>
        <ul>
          <li>íŠ¸ë˜í”½ ì‹œí”„íŒ…(traffic shifting) : íŠ¸ë˜í”½ì„ ì„œë¹„ìŠ¤ê°„ì— ë¶„ì‚°ì‹œí‚¤ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ, íŠ¹ì • ë‹¨ë§/ì‚¬ìš©ìëŠ” ì‹ ê·œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ì—°ê²°í•˜ë„ë¡ í•˜ëŠ” ì¹´ë‚˜ë¦¬ ë°°í¬ë“±ì— í™œìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ì„œí‚· ë¸Œë ˆì´ì»¤(circuit breaker) : íŠ¹ì • ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ìˆì„ë•Œ ì ‘ì†ì„ ì°¨ë‹¨í•˜ê³ , ì¶œë°œì§€ ì„œë¹„ìŠ¤ì— ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ë„ë¡ í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. (ì—°ì‡„ì¥ì• , ì‹œìŠ¤í…œ ì „ì²´ ì¥ì•  ë°©ì§€)</li>
          <li>í”ŒíŠ¸ ì¸ì ì…˜(fault injection) : ì˜ë„ì ìœ¼ë¡œ ìš”ì²­ì„ ì§€ì—°ì‹œí‚¤ê±°ë‚˜ ì‹¤íŒ¨í•˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ë¹„ì •ìƒ ìƒí™© í…ŒìŠ¤íŠ¸)</li>
          <li>ì†ë„ ì œí•œ(rate limiting) : íŠ¹ì • ì„œë¹„ìŠ¤ì— ëŒ€í•œ ìš”ì²­ ê°œìˆ˜ë¥¼ ì œí•œí•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="envoy">Envoy</h3>

<ul>
  <li>ì§€ë‚œì£¼ì— ì‚´ì§ ì–¸ê¸‰ë˜ì—ˆë˜ ë‚´ìš©ì¸ë° ì´ë²ˆ ì£¼ì— ì¢€ ë” ìì„¸íˆ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>EnvoyëŠ” êµ¬ê¸€, IBM, Lyftê°€ ì¤‘ì‹¬ì´ ë˜ì–´ ê°œë°œí•˜ê³  ìˆëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡ì‹œì…ë‹ˆë‹¤.</li>
  <li>Istioì˜ í•µì‹¬ ê¸°ëŠ¥ë“¤ì€ Envoyë¥¼ ê°ì‹¼ istio proxyë¥¼ í†µí•´ ì´ë£¨ì–´ì§€ë¯€ë¡œ Envoyì— ëŒ€í•œ ì´í•´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_4.svg" alt="20241019_kans_w7_4.svg" class="image-center w-80" /></p>

<ul>
  <li>Envoyì—ì„œ ì‚¬ìš©í•˜ëŠ” ìš©ì–´ ë“¤ì„ ì •ë¦¬í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>ìš©ì–´</th>
      <th>ì„¤ëª…</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Cluster</td>
      <td>envoyê°€ íŠ¸ë˜í”½ì„ í¬ì›Œë”©í•  ìˆ˜ ìˆëŠ” ë…¼ë¦¬ì  ì„œë¹„ìŠ¤ (ì—”ë“œí¬ì¸íŠ¸ ì…‹íŠ¸)</td>
    </tr>
    <tr>
      <td>Endpoint</td>
      <td>IP ì£¼ì†Œì™€ í¬íŠ¸ ë²ˆí˜¸ë¡œ êµ¬ì„±ëœ ì„œë¹„ìŠ¤ì˜ ì‹¤ì œ ì¸ìŠ¤í„´ìŠ¤. ì—”ë“œí¬ì¸íŠ¸ê°€ ëª¨ì—¬ì„œ í•˜ë‚˜ì˜ Clusterë¥¼ ì´ë£¸</td>
    </tr>
    <tr>
      <td>Listener</td>
      <td>í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ì†í•˜ëŠ” í¬íŠ¸, ìœ ë‹‰ìŠ¤ ë„ë©”ì¸ ì†Œì¼“ ë“±ì„ ë…¸ì¶œí•˜ê³ , ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë¶€í„° ë°›ì€ ìš”ì²­ì„ ì²˜ë¦¬</td>
    </tr>
    <tr>
      <td>Route</td>
      <td>Listenerë¡œ ë“¤ì–´ì˜¨ ìš”ì²­ì„ ì–´ë–¤ í´ëŸ¬ìŠ¤í„°ë¡œ ë³´ë‚¼ì§€ ì •ì˜</td>
    </tr>
    <tr>
      <td>Filter</td>
      <td>Listenerë¡œ ë¶€í„° ì„œë¹„ìŠ¤ì— íŠ¸ë˜í”½ ì „ë‹¬í•˜ê¸° ì „ì— íŠ¸ë˜í”½ì„ ê°€ê³µí•˜ê±°ë‚˜ ì°¨ë‹¨í•˜ëŠ” ì—­í• ì„ í•˜ëŠ” ì»´í¬ë„ŒíŠ¸</td>
    </tr>
    <tr>
      <td>UpStream</td>
      <td>envoy ìš”ì²­ì„ í¬ì›Œë”©í•´ì„œ ì—°ê²°í•˜ëŠ” ë°±ì—”ë“œ ë„¤íŠ¸ì›Œí¬ ë…¸ë“œ - ì‚¬ì´ë“œì¹´ì¼ë•ŒëŠ” application app, ì•„ë‹ë•ŒëŠ” ì›ê²© ë°±ì—”ë“œ</td>
    </tr>
    <tr>
      <td>DownStream</td>
      <td>envoyë¡œ ì—°ê²°í•˜ì—¬ ìš”ì²­ì„ ë³´ë‚´ëŠ” ê°œì²´. ì‚¬ì´ë“œì¹´ê°€ ì•„ë‹ë•ŒëŠ” ì›ê²©ì§€ì˜ í´ë¼ì´ì–¸íŠ¸</td>
    </tr>
    <tr>
      <td>Host</td>
      <td>ë„¤íŠ¸ì›Œí¬ í†µì‹ ì´ ê°€ëŠ¥í•œ ê°œì²´ (PC, ì„œë²„, íœ´ëŒ€í°, ë„¤íŠ¸ì›Œí¬ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë“±)</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>ë§ì€ Service Mesh ì†”ë£¨ì…˜ì´ë‚˜, Gateway API êµ¬í˜„ì²´ë“¤ì´ ë‚´ë¶€ì ìœ¼ë¡œ Envoyë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©°, Envoyê°€ ì œê³µí•˜ëŠ” ë™ì  êµ¬ì„±ì„ ìœ„í•œ API(xDS Sync API)ë¥¼ 
ì´ìš©í•˜ì—¬ ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ êµ¬ì„±í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
  <li>Envoyì˜ xDS Sync APIëŠ” ì•„ë˜ì™€ ê°™ì€ ë ˆì´ì–´ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.
    <ul>
      <li>LDS - Listener Discovery Service</li>
      <li>RDS - Route Discovery Service</li>
      <li>CDS - Cluster Discovery Service</li>
      <li>EDS - Endpoint Discovery Service</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_5.png" alt="img.png" class="image-center w-80" /></p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_6.png" alt="img.png" class="image-center w-80" /></p>

<h4 id="envoy-ì‹¤ìŠµ">Envoy ì‹¤ìŠµ</h4>

<ul>
  <li>test pcì— Envoy ì„¤ì¹˜</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì„¤ì¹˜</span>
<span class="c"># echo "deb [signed-by=/etc/apt/keyrings/envoy-keyring.gpg] https://apt.envoyproxy.io focal main" | sudo tee /etc/apt/sources.list.d/envoy.list</span>
<span class="nv">$ </span>wget <span class="nt">-O-</span> https://apt.envoyproxy.io/signing.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/envoy-keyring.gpg
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/envoy-keyring.gpg] https://apt.envoyproxy.io jammy main"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/envoy.list
<span class="nv">$ </span><span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install </span>envoy <span class="nt">-y</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>envoy <span class="nt">--version</span>
<span class="c"># =&gt; envoy  version: e3b4a6e9570da15ac1caffdded17a8bebdc7dfc9/1.32.0/Clean/RELEASE/BoringSSL</span>

<span class="c"># ë„ì›€ë§</span>
<span class="nv">$ </span>envoy <span class="nt">--help</span>
</code></pre></div></div>

<ul>
  <li>Envoy proxy ì‹¤ìŠµ - <a href="https://www.envoyproxy.io/docs/envoy/latest/start/quick-start/">Link</a>
    <ul>
      <li>envoy-demo.yml ì‘ì„±
        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># envoy-demo.yml</span>
<span class="na">static_resources</span><span class="pi">:</span>
    
  <span class="na">listeners</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">listener_0</span>
    <span class="na">address</span><span class="pi">:</span>
      <span class="na">socket_address</span><span class="pi">:</span>
        <span class="na">address</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
        <span class="na">port_value</span><span class="pi">:</span> <span class="m">10000</span>
    <span class="na">filter_chains</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">filters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.network.http_connection_manager</span>
        <span class="na">typed_config</span><span class="pi">:</span>
          <span class="s2">"</span><span class="s">@type"</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>
          <span class="s">stat_prefix</span><span class="err">:</span> <span class="s">ingress_http</span>
          <span class="s">access_log</span><span class="err">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.access_loggers.stdout</span>
            <span class="na">typed_config</span><span class="pi">:</span>
              <span class="s2">"</span><span class="s">@type"</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog</span>
          <span class="na">http_filters</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.http.router</span>
          <span class="na">route_config</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">local_route</span>
            <span class="na">virtual_hosts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">local_service</span>
              <span class="na">domains</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">*"</span><span class="pi">]</span>
              <span class="na">routes</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
                  <span class="na">prefix</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/"</span>
                <span class="na">route</span><span class="pi">:</span>
                  <span class="na">host_rewrite_literal</span><span class="pi">:</span> <span class="s">www.envoyproxy.io</span>
                  <span class="na">cluster</span><span class="pi">:</span> <span class="s">service_envoyproxy_io</span>
    
  <span class="na">clusters</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">service_envoyproxy_io</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">LOGICAL_DNS</span>
    <span class="c1"># Comment out the following line to test on v6 networks</span>
    <span class="na">dns_lookup_family</span><span class="pi">:</span> <span class="s">V4_ONLY</span>
    <span class="na">connect_timeout</span><span class="pi">:</span> <span class="s">5s</span>
    <span class="na">load_assignment</span><span class="pi">:</span>
      <span class="na">cluster_name</span><span class="pi">:</span> <span class="s">service_envoyproxy_io</span>
      <span class="na">endpoints</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">lb_endpoints</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">endpoint</span><span class="pi">:</span>
            <span class="na">address</span><span class="pi">:</span>
              <span class="na">socket_address</span><span class="pi">:</span>
                <span class="na">address</span><span class="pi">:</span> <span class="s">www.envoyproxy.io</span>
                <span class="na">port_value</span><span class="pi">:</span> <span class="m">443</span>
    <span class="na">transport_socket</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.transport_sockets.tls</span>
      <span class="na">typed_config</span><span class="pi">:</span>
        <span class="s2">"</span><span class="s">@type"</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext</span>
        <span class="s">sni</span><span class="err">:</span> <span class="s">www.envoyproxy.io</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì‹¤í–‰</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># (í„°ë¯¸ë„1) ë°ëª¨ config ì ìš©í•˜ì—¬ ì‹¤í–‰</span>
  <span class="nv">$ </span>curl <span class="nt">-O</span> https://www.envoyproxy.io/docs/envoy/latest/_downloads/92dcb9714fb6bc288d042029b34c0de4/envoy-demo.yaml
  <span class="nv">$ </span>envoy <span class="nt">-c</span> envoy-demo.yaml
  <span class="c"># =&gt; [2024-10-01 16:41:51.547][4479][info][main] [source/server/server.cc:426] initializing epoch 0 (base id=0, hot restart version=11.104)</span>
  <span class="c">#    ...</span>
    
  <span class="c"># (í„°ë¯¸ë„2) ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>ss <span class="nt">-tnlp</span>
  <span class="c"># =&gt; State           Recv-Q           Send-Q                     Local Address:Port                      Peer Address:Port          Process</span>
  <span class="c">#    LISTEN          0                4096                             0.0.0.0:10000                          0.0.0.0:*              users:((&amp;quot;envoy&amp;quot;,pid=4479,fd=35))</span>
  <span class="c">#    LISTEN          0                4096                             0.0.0.0:10000                          0.0.0.0:*              users:((&amp;quot;envoy&amp;quot;,pid=4479,fd=34))</span>
  <span class="c">#    LISTEN          0                4096                             0.0.0.0:10000                          0.0.0.0:*              users:((&amp;quot;envoy&amp;quot;,pid=4479,fd=33))</span>
  <span class="c">#    LISTEN          0                4096                             0.0.0.0:10000                          0.0.0.0:*              users:((&amp;quot;envoy&amp;quot;,pid=4479,fd=32))</span>
  <span class="c">#    ...</span>
    
  <span class="c"># ì ‘ì† í…ŒìŠ¤íŠ¸</span>
  <span class="nv">$ </span>curl <span class="nt">-s</span> http://127.0.0.1:10000 | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
  <span class="c"># =&gt; &amp;lt;title&amp;gt;Envoy proxy - home&amp;lt;/title&amp;gt;</span>
    
  <span class="c"># ì™¸ë¶€ ì ‘ì† ì •ë³´ ì¶œë ¥</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:10000"</span>
  <span class="c"># =&gt; http://54.123.42.212:10000</span>
    
  <span class="nt">--------------------</span>
  <span class="c"># ìì‹ ì˜ PC ì›¹ë¸Œë¼ìš°ì €ì—ì„œ ì™¸ë¶€ ì ‘ì† ì •ë³´ ì ‘ì† í™•ì¸!</span>
    
  <span class="c"># k3s-m ì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
  <span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.56.104:10000 | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
  <span class="c"># =&gt; &amp;lt;title&amp;gt;Envoy proxy - home&amp;lt;/title&amp;gt; </span>
  <span class="nt">--------------------</span>
    
  <span class="c"># ì—°ê²° ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>ss <span class="nt">-tnp</span>
    
  <span class="c"># (í„°ë¯¸ë„1) envoy ì‹¤í–‰ ì·¨ì†Œ(CTRL+C) í›„ (ê´€ë¦¬ìí˜ì´ì§€) ì„¤ì • ë®ì–´ì“°ê¸° - ë§í¬</span>
  <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; envoy-override.yaml
  admin:
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 9902
</span><span class="no">  EOT
</span>  <span class="nv">$ </span>envoy <span class="nt">-c</span> envoy-demo.yaml <span class="nt">--config-yaml</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">cat </span>envoy-override.yaml<span class="si">)</span><span class="s2">"</span>
    
  <span class="c"># envoy ê´€ë¦¬í˜ì´ì§€ ì™¸ë¶€ ì ‘ì† ì •ë³´ ì¶œë ¥</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:9902"</span>
  <span class="c"># =&gt; http://54.123.42.212:9902</span>
    
  <span class="nt">--------------------</span>
  <span class="c"># ìì‹ ì˜ PC ì›¹ë¸Œë¼ìš°ì €ì—ì„œ ê´€ë¦¬ í˜ì´ì§€ ì™¸ë¶€ ì ‘ì† ì •ë³´ ì ‘ì† í™•ì¸!</span>
</code></pre></div>        </div>

        <p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_7.png" alt="img.png" class="image-center" />
  <em class="image-caption">PCì—ì„œ ì ‘ì†í•œ í™”ë©´</em></p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="istio-ì†Œê°œ-1">Istio ì†Œê°œ</h3>

<ul>
  <li><strong>Istio</strong>ëŠ” ì„œë¹„ìŠ¤ ë©”ì‹œë¥¼ êµ¬ì¶•í•˜ê³  ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì˜¤í”ˆì†ŒìŠ¤ í”Œë«í¼ì…ë‹ˆë‹¤.</li>
  <li><strong>Istioì˜ êµ¬ì„±</strong>
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_3.svg" alt="20241019_kans_w7_3.svg" class="image-center w-80" />
    <ul>
      <li>íŒŒì¼ëŸ¿(Pilot) : ëª¨ë“  Envoy ì‚¬ì´ë“œì¹´ì—ì„œ í”„ë¡ì‹œ ë¼ìš°íŒ… ê·œì¹™ì„ ê´€ë¦¬í•˜ë©°, ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬, ë¡œë“œë°¸ëŸ°ì‹± ì„¤ì •ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
      <li>ê²”ë¦¬(Galley) : Istioì™€ ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì—°ê²°í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ë©”ì‹œ êµ¬ì„± ë°ì´í„°ë¥¼ ê²€ì¦í•˜ê³  ë³€í™˜í•©ë‹ˆë‹¤.</li>
      <li>ì‹œíƒ€ë¸(Citadel) : ì„œë¹„ìŠ¤ ê°„ì˜ ì¸ì¦ê³¼ ë³´ì•ˆì„ ê´€ë¦¬í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ê°„ì˜ TLS í†µì‹ ì„ ì œê³µí•˜ê³ , ì„œë¹„ìŠ¤ ê°„ì˜ ì¸ì¦ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Istioì˜ êµ¬ì„±ìš”ì†Œ
    <ul>
      <li>istiod : Istioì˜ ì¤‘ì•™ ì œì–´ í”Œë ˆì¸ìœ¼ë¡œ, Pilot, Citadel, Galleyë¥¼ í¬í•¨í•©ë‹ˆë‹¤.</li>
      <li>istio proxy : Envoy ê¸°ë°˜ì˜ í”„ë¡ì‹œë¡œ, istiodì™€ í†µì‹ í•˜ë©°, ì„œë¹„ìŠ¤ íŠ¸ë˜í”½ì„ í†µì œí•˜ê³  ì˜µì €ë¹Œë¦¬í‹°ë¥¼ ìœ„í•œ ë©”íŠ¸ë¦­ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>íŠ¹ì§•
    <ul>
      <li>IstioëŠ” ê° íŒŒë“œì•ˆì—ì„œ ì‚¬ì´ë“œì¹´ë¡œ ë™ì‘í•˜ëŠ” Envoyê°€ íŠ¸ë˜í”½ì„ ì œì–´í•˜ê³  ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.</li>
      <li>ëª¨ë“  ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ê°„ í†µì‹ ì€ Envoyë¥¼ í†µí•´ ì´ë£¨ì–´ì§€ë©°, ì´ë¥¼ í†µí•´ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ê±°ë‚˜ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>íŠ¸ë˜í”½ì„ ì»¨íŠ¸ë¡¤ í•˜ê¸° ìœ„í•´ì„œ Envoy í”„ë¡ì‹œì— ì „ì†¡ë£°ì„ ì •ì˜ í•©ë‹ˆë‹¤.</li>
      <li>ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ê°„ì˜ í†µì‹ ì„ mutual TLS ì¸ì¦(mTLS)ì„ í†µí•´ ë³´ì•ˆí•©ë‹ˆë‹¤.</li>
      <li>ê° ì–´í”Œë¦¬ì¼€ì´ì…˜ì€ íŒŒë“œ ë‚´ì˜ ì—”ë³´ì´ í”„ë¡ì‹œì— ì ‘ì†í•˜ê¸° ìœ„í•´ localhostì— TCP ì ‘ì†ì„ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="istio-ì„¤ì¹˜-sidecar-ëª¨ë“œ">Istio ì„¤ì¹˜ (Sidecar ëª¨ë“œ)</h3>

<ul>
  <li>Istio ê³µì‹ ë¬¸ì„œ : <a href="https://istio.io/latest/docs/">Link</a>
    <ul>
      <li>Istio Sidecar mode ì„¤ì¹˜ : v1.23.2 - 
<a href="https://istio.io/latest/docs/releases/supported-releases/#support-status-of-istio-releases">ë²„ì „</a>
<a href="https://istio.io/latest/docs/setup/getting-started/">ì„¤ì¹˜</a>,</li>
      <li>without GwApi - <a href="https://istio.io/latest/docs/setup/additional-setup/getting-started-istio-apis/">Docs</a></li>
      <li>Operator ë°©ì‹ ì„¤ì¹˜ : https://istio.io/latest/docs/setup/install/operator/ (Istio OperatorëŠ” <strong>Deprecated</strong> ë˜ì—ˆìŠµë‹ˆë‹¤.)</li>
    </ul>
  </li>
  <li>Istio ì„¤ì¹˜
```bash</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># istioctl ì„¤ì¹˜</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">ISTIOV</span><span class="o">=</span>1.23.2
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export ISTIOV=1.23.2"</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-L</span> https://istio.io/downloadIstio | <span class="nv">ISTIO_VERSION</span><span class="o">=</span><span class="nv">$ISTIOV</span> <span class="nv">TARGET_ARCH</span><span class="o">=</span>x86_64 sh -
<span class="nv">$ </span>tree istio-<span class="nv">$ISTIOV</span> <span class="nt">-L</span> 2 <span class="c"># sample yaml í¬í•¨</span>
<span class="c"># =&gt; istio-1.23.2</span>
<span class="c">#    â”œâ”€â”€ LICENSE</span>
<span class="c">#    â”œâ”€â”€ README.md</span>
<span class="c">#    â”œâ”€â”€ bin</span>
<span class="c">#    â”‚   â””â”€â”€ istioctl</span>
<span class="c">#    â”œâ”€â”€ manifest.yaml</span>
<span class="c">#    â”œâ”€â”€ manifests</span>
<span class="c">#    â”‚   â”œâ”€â”€ charts</span>
<span class="c">#    â”‚   â””â”€â”€ profiles</span>
<span class="c">#    â”œâ”€â”€ samples</span>
<span class="c">#    â”‚   ...</span>
<span class="c">#    â””â”€â”€ tools</span>
<span class="c">#        â”œâ”€â”€ _istioctl</span>
<span class="c">#        â”œâ”€â”€ certs</span>
<span class="c">#        â””â”€â”€ istioctl.bash</span>
<span class="nv">$ </span><span class="nb">cp </span>istio-<span class="nv">$ISTIOV</span>/bin/istioctl /usr/local/bin/istioctl
<span class="nv">$ </span>istioctl version <span class="nt">--remote</span><span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; client version: 1.23.2</span>

<span class="c"># (demo í”„ë¡œíŒŒì¼) ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë°°í¬ - ë§í¬ Customizing</span>
<span class="c"># The istioctl command supports the full IstioOperator API via command-line options for individual settings or for passing a yaml file containing an IstioOperator custom resource (CR).</span>
<span class="nv">$ </span>istioctl profile list
<span class="c"># =&gt; Istio configuration profiles:</span>
<span class="c">#        ambient</span>
<span class="c">#        default</span>
<span class="c">#        demo</span>
<span class="c">#        empty</span>
<span class="c">#        minimal</span>
<span class="c">#        openshift</span>
<span class="c">#        openshift-ambient</span>
<span class="c">#        preview</span>
<span class="c">#        remote</span>
<span class="c">#        stable</span>
<span class="nv">$ </span>istioctl profile dump default
<span class="nv">$ </span>istioctl profile dump <span class="nt">--config-path</span> components.ingressGateways
<span class="c"># =&gt; - enabled: true</span>
<span class="c">#      name: istio-ingressgateway</span>
<span class="nv">$ </span>istioctl profile dump <span class="nt">--config-path</span> values.gateways.istio-ingressgateway
<span class="c"># =&gt; {}</span>
<span class="nv">$ </span>istioctl profile dump demo
<span class="c"># =&gt; apiVersion: install.istio.io/v1alpha1</span>
<span class="c">#    kind: IstioOperator</span>
<span class="c">#    spec:</span>
<span class="c">#      components:</span>
<span class="c">#        base:</span>
<span class="c">#          enabled: true</span>
<span class="c">#        egressGateways:</span>
<span class="c">#        - enabled: true</span>
<span class="c">#          name: istio-egressgateway</span>
<span class="c">#        ingressGateways:</span>
<span class="c">#        - enabled: true</span>
<span class="c">#          name: istio-ingressgateway</span>
<span class="c">#        pilot:</span>
<span class="c">#          enabled: true</span>
<span class="c">#      hub: docker.io/istio</span>
<span class="c">#      profile: demo</span>
<span class="c">#      tag: 1.23.2</span>
<span class="c">#      values:</span>
<span class="c">#        defaultRevision: &amp;quot;&amp;quot;</span>
<span class="c">#        gateways:</span>
<span class="c">#          istio-egressgateway: {}</span>
<span class="c">#          istio-ingressgateway: {}</span>
<span class="c">#        global:</span>
<span class="c">#          configValidation: true</span>
<span class="c">#          istioNamespace: istio-system</span>
<span class="c">#        profile: demo</span>

<span class="nv">$ </span>istioctl profile dump demo <span class="o">&gt;</span> demo-profile.yaml
<span class="nv">$ </span>vi demo-profile.yaml <span class="c"># ë³µì¡ì„±ì„ ì¤„ì´ê²Œ ì‹¤ìŠµ ì‹œë‚˜ë¦¬ì˜¤ í™˜ê²½ ë§ì¶¤</span>
<span class="nt">--------------------</span>
    egressGateways:
    - enabled: <span class="nb">false</span>
<span class="nt">--------------------</span>    

<span class="nv">$ </span>istioctl <span class="nb">install</span> <span class="nt">-f</span> demo-profile.yaml <span class="nt">-y</span>
<span class="c"># =&gt; âœ” Istio core installed â›µï¸</span>
<span class="c">#    âœ” Istiod installed ğŸ§ </span>
<span class="c">#    âœ” Ingress gateways installed ğŸ›¬</span>
<span class="c">#    âœ” Installation complete</span>
<span class="c">#    Made this installation the default for cluster-wide operations.</span>

<span class="c"># ì„¤ì¹˜ í™•ì¸ : istiod, istio-ingressgateway</span>
<span class="nv">$ </span>kubectl get all,svc,ep,sa,cm,secret,pdb <span class="nt">-n</span> istio-system
<span class="c"># =&gt; NAME                                        READY   STATUS    RESTARTS      AGE</span>
<span class="c">#    pod/istio-ingressgateway-5f9f654d46-l7mqp   1/1     Running   0             14m</span>
<span class="c">#    pod/istiod-7f8b586864-8mc4c                 1/1     Running   1 (82s ago)   14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                           TYPE           CLUSTER-IP      EXTERNAL-IP                                    PORT(S)                                                                      AGE</span>
<span class="c">#    service/istio-ingressgateway   LoadBalancer   10.10.200.171   192.168.10.101,192.168.10.102,192.168.10.103   15021:30953/TCP,80:31677/TCP,443:30737/TCP,31400:30617/TCP,15443:31668/TCP   14m</span>
<span class="c">#    service/istiod                 ClusterIP      10.10.200.215   &amp;lt;none&amp;gt;                                         15010/TCP,15012/TCP,443/TCP,15014/TCP                                        14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/istio-ingressgateway   1/1     1            1           14m</span>
<span class="c">#    deployment.apps/istiod                 1/1     1            1           14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                                              DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/istio-ingressgateway-5f9f654d46   1         1         1       14m</span>
<span class="c">#    replicaset.apps/istiod-7f8b586864                 1         1         1       14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                             ENDPOINTS                                                           AGE</span>
<span class="c">#    endpoints/istio-ingressgateway   172.16.2.14:15443,172.16.2.14:15021,172.16.2.14:31400 + 2 more...   14m</span>
<span class="c">#    endpoints/istiod                 172.16.3.16:15012,172.16.3.16:15010,172.16.3.16:15017 + 1 more...   14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                  SECRETS   AGE</span>
<span class="c">#    serviceaccount/istio-ingressgateway-service-account   0         14m</span>
<span class="c">#    serviceaccount/istio-reader-service-account           0         14m</span>
<span class="c">#    serviceaccount/istiod                                 0         14m</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAME                                            DATA   AGE</span>
<span class="c">#    configmap/istio                                 2      14m</span>
<span class="c">#    configmap/istio-sidecar-injector                2      14m</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAME                     TYPE               DATA   AGE</span>
<span class="c">#    secret/istio-ca-secret   istio.io/ca-root   5      14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                                              MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE</span>
<span class="c">#    poddisruptionbudget.policy/istio-ingressgateway   1               N/A               0                     14m</span>
<span class="c">#    poddisruptionbudget.policy/istiod                 1               N/A               0                     14m</span>
<span class="nv">$ </span>kubectl get crd | <span class="nb">grep </span>istio.io | <span class="nb">sort</span>
<span class="c"># =&gt; authorizationpolicies.security.istio.io      2024-10-01T05:26:47Z</span>
<span class="c">#    destinationrules.networking.istio.io         2024-10-01T05:26:47Z</span>
<span class="c">#    envoyfilters.networking.istio.io             2024-10-01T05:26:47Z</span>
<span class="c">#    gateways.networking.istio.io                 2024-10-01T05:26:47Z</span>
<span class="c">#    peerauthentications.security.istio.io        2024-10-01T05:26:47Z</span>
<span class="c">#    proxyconfigs.networking.istio.io             2024-10-01T05:26:47Z</span>
<span class="c">#    requestauthentications.security.istio.io     2024-10-01T05:26:47Z</span>
<span class="c">#    serviceentries.networking.istio.io           2024-10-01T05:26:47Z</span>
<span class="c">#    sidecars.networking.istio.io                 2024-10-01T05:26:47Z</span>
<span class="c">#    telemetries.telemetry.istio.io               2024-10-01T05:26:48Z</span>
<span class="c">#    virtualservices.networking.istio.io          2024-10-01T05:26:48Z</span>
<span class="c">#    wasmplugins.extensions.istio.io              2024-10-01T05:26:48Z</span>
<span class="c">#    workloadentries.networking.istio.io          2024-10-01T05:26:48Z</span>
<span class="c">#    workloadgroups.networking.istio.io           2024-10-01T05:26:48Z</span>

<span class="c"># istio-ingressgateway ì˜ envoy ë²„ì „ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">-c</span> istio-proxy <span class="nt">--</span> envoy <span class="nt">--version</span>
<span class="c"># =&gt; envoy  version: 6c72b2179f5a58988b920a55b0be8346de3f7b35/1.31.2-dev/Clean/RELEASE/BoringSSL</span>

<span class="c"># istio-ingressgateway ì„œë¹„ìŠ¤ NodePortë¡œ ë³€ê²½</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> istio-system istio-ingressgateway <span class="nt">-p</span> <span class="s1">'{"spec":{"type":"NodePort"}}'</span>
<span class="c"># =&gt; service/istio-ingressgateway patched</span>

<span class="c"># istio-ingressgateway ì„œë¹„ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> istio-system istio-ingressgateway
<span class="c"># =&gt; NAME                           TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE</span>
<span class="c">#    service/istio-ingressgateway   NodePort   10.10.200.171   &amp;lt;none&amp;gt;        15021:30953/TCP,80:31677/TCP,443:30737/TCP,31400:30617/TCP,15443:31668/TCP   16m</span>
<span class="c">#    </span>
<span class="c">#    NAME                             ENDPOINTS                                                           AGE</span>
<span class="c">#    endpoints/istio-ingressgateway   172.16.2.14:15443,172.16.2.14:15021,172.16.2.14:31400 + 2 more...   16m</span>

<span class="c">## istio-ingressgateway ì„œë¹„ìŠ¤ í¬íŠ¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> istio-system istio-ingressgateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[<span class="k">*</span><span class="o">]}</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;name&amp;quot;: &amp;quot;https&amp;quot;,</span>
<span class="c">#      &amp;quot;nodePort&amp;quot;: 30737,</span>
<span class="c">#      &amp;quot;port&amp;quot;: 443,</span>
<span class="c">#      &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;,</span>
<span class="c">#      &amp;quot;targetPort&amp;quot;: 8443</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;name&amp;quot;: &amp;quot;tcp&amp;quot;,</span>
<span class="c">#      &amp;quot;nodePort&amp;quot;: 30617,</span>
<span class="c">#      &amp;quot;port&amp;quot;: 31400,</span>
<span class="c">#      &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;,</span>
<span class="c">#      &amp;quot;targetPort&amp;quot;: 31400</span>
<span class="c">#    }</span>
<span class="c">#    ...</span>

<span class="c">## istio-ingressgateway ë””í”Œë¡œì´ë¨¼íŠ¸ íŒŒë“œì˜ í¬íŠ¸ ì •ë³´ í™•ì¸ </span>
<span class="nv">$ </span>kubectl get deploy/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.template.spec.containers[0].ports[<span class="k">*</span><span class="o">]}</span> | jq
<span class="c"># =&gt; ...</span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;containerPort&amp;quot;: 8443,</span>
<span class="c">#      &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;containerPort&amp;quot;: 31400,</span>
<span class="c">#      &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;</span>
<span class="c">#    }</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get deploy/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.template.spec.containers[0].readinessProbe<span class="o">}</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;failureThreshold&amp;quot;: 30,</span>
<span class="c">#      &amp;quot;httpGet&amp;quot;: {</span>
<span class="c">#        &amp;quot;path&amp;quot;: &amp;quot;/healthz/ready&amp;quot;,</span>
<span class="c">#        &amp;quot;port&amp;quot;: 15021,</span>
<span class="c">#        &amp;quot;scheme&amp;quot;: &amp;quot;HTTP&amp;quot;</span>
<span class="c">#      },</span>
<span class="c">#      &amp;quot;initialDelaySeconds&amp;quot;: 1,</span>
<span class="c">#      &amp;quot;periodSeconds&amp;quot;: 2,</span>
<span class="c">#      &amp;quot;successThreshold&amp;quot;: 1,</span>
<span class="c">#      &amp;quot;timeoutSeconds&amp;quot;: 1</span>
<span class="c">#    }</span>

<span class="c"># istiod(ì»¨íŠ¸ë¡¤í”Œë ˆì¸) ë””í”Œë¡œì´ë¨¼íŠ¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-tnlp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-tnp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ps <span class="nt">-ef</span>
<span class="c"># =&gt; UID          PID    PPID  C STIME TTY          TIME CMD</span>
<span class="c">#    istio-p+       1       0  0 05:39 ?        00:00:01 /usr/local/bin/pilot-discovery discovery --monitoringAddr=:15014 --log_output_level=default:info --domain cluster.local --ke</span>

<span class="c"># istio-ingressgateway ë””í”Œë¡œì´ë¨¼íŠ¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-tnlp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-tnp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> ps <span class="nt">-ef</span>
<span class="c"># =&gt; UID          PID    PPID  C STIME TTY          TIME CMD</span>
<span class="c">#    istio-p+       1       0  0 05:27 ?        00:00:08 /usr/local/bin/pilot-agent proxy router --domain istio-system.svc.cluster.local</span>
<span class="c">#    istio-p+      16       1  0 05:27 ?        00:00:04 /usr/local/bin/envoy -c etc/istio/proxy/envoy-rev.json --drain-time-s 45 --drai</span>
<span class="c"># # &lt;span style="color: green;"&gt;ğŸ‘‰ pilot-agentì™€ envoyê°€ ë™ì‘ ì¤‘ì…ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># envoy ì„¤ì • í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> <span class="nb">cat</span> /etc/istio/proxy/envoy-rev.json
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-xnlp</span>
<span class="c"># =&gt; Netid      State       Recv-Q      Send-Q                                          Local Address:Port              Peer Address:Port      Process</span>
<span class="c">#    u_str      LISTEN      0           4096               var/run/secrets/workload-spiffe-uds/socket 32430                        * 0          users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=9))</span>
<span class="c">#    u_str      LISTEN      0           4096                                      etc/istio/proxy/XDS 32431                        * 0          users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=10))</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-xnp</span>
<span class="c"># =&gt; Netid State Recv-Q Send-Q                              Local Address:Port  Peer Address:Port Process</span>
<span class="c">#    u_str ESTAB 0      0                                               * 39978            * 37977 users:((&amp;quot;envoy&amp;quot;,pid=16,fd=19))</span>
<span class="c">#    u_str ESTAB 0      0                                               * 37501            * 37981 users:((&amp;quot;envoy&amp;quot;,pid=16,fd=32))</span>
<span class="c">#    u_str ESTAB 0      0                             etc/istio/proxy/XDS 37977            * 39978 users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=11))</span>
<span class="c">#    u_str ESTAB 0      0      var/run/secrets/workload-spiffe-uds/socket 37981            * 37501 users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=15))</span>
</code></pre></div></div>

<ul>
  <li>Auto Injection with namespace label</li>
  <li>
    <p>í•´ë‹¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìƒì„±ë˜ëŠ” ëª¨ë“  íŒŒë“œë“¤ì€ istio ì‚¬ì´ë“œì¹´ê°€ ìë™ìœ¼ë¡œ injection ë©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># mutating Webhook admisstion controller ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl label namespace default istio-injection<span class="o">=</span>enabled
<span class="c"># =&gt; namespace/default labeled</span>
<span class="nv">$ </span>kubectl get ns <span class="nt">-L</span> istio-injection
<span class="c"># =&gt; NAME              STATUS   AGE     ISTIO-INJECTION</span>
<span class="c">#    default           Active   7d      enabled</span>
<span class="c">#    ...</span>
</code></pre></div>    </div>

    <p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_8.png" alt="img.png" class="image-center" /></p>
  </li>
  <li>Istio ì ‘ì† í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ë³€ìˆ˜ ì§€ì • ë° k3s-mì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k3s-m)</span>
<span class="c"># istio ingress gw NodePort(HTTP ì ‘ì†ìš©) ë³€ìˆ˜ ì§€ì • </span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">IGWHTTP</span><span class="o">=</span><span class="si">$(</span>kubectl get service <span class="nt">-n</span> istio-system istio-ingressgateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[1].nodePort}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; 31677</span>

<span class="c"># /etc/hosts íŒŒì¼ ìˆ˜ì •</span>
<span class="c"># $ MYDOMAIN=&lt;ê°ì ìì‹ ì˜ www ë„ë©”ì¸&gt; # ë‹¨, ì‚¬ìš©í•˜ê³  ìˆì§€ ì•ŠëŠ” ê³µì¸ ë„ë©”ì¸ì„ ì‚¬ìš© í•  ê²ƒ</span>
<span class="c"># $ echo "&lt;istio-ingressgateway íŒŒë“œê°€ ìˆëŠ” ì›Œì»¤ ë…¸ë“œ&gt; $MYDOMAIN" &gt;&gt; /etc/hosts</span>

<span class="nv">$ </span><span class="nb">export </span><span class="nv">MYDOMAIN</span><span class="o">=</span>sweetlittlebird.com
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"192.168.10.10 </span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"export MYDOMAIN=</span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile

<span class="c"># istio ingress gw ì ‘ì† í…ŒìŠ¤íŠ¸ : ì•„ì§ì€ ì„¤ì •ì´ ì—†ì–´ì„œ ì ‘ì† ì‹¤íŒ¨ê°€ ë©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; *   Trying 192.168.10.10:31677...</span>
<span class="c">#    * connect to 192.168.10.10 port 31677 failed: Connection refused</span>
<span class="c">#    * Failed to connect to sweetlittlebird.com port 31677 after 3 ms: Connection refused</span>
<span class="c">#    * Closing connection 0</span>
</code></pre></div></div>

<ul>
  <li>testpcì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì•„ë˜ ë³€ìˆ˜ëŠ” ê°ì ìì‹ ì˜ ê°’ì„ ì§ì ‘ ì…ë ¥ í•  ê²ƒ</span>
<span class="c"># $ IGWHTTP=&lt;ê°ì ì¶œë ¥ëœ NodePort&gt;</span>
<span class="nv">$ IGWHTTP</span><span class="o">=</span>31677
<span class="nv">$ </span><span class="nb">export </span><span class="nv">MYDOMAIN</span><span class="o">=</span>sweetlittlebird.com
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"192.168.10.10 </span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"export MYDOMAIN=</span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile

<span class="c"># istio ingress gw ì ‘ì† í…ŒìŠ¤íŠ¸ : ì•„ì§ì€ ì„¤ì •ì´ ì—†ì–´ì„œ ì ‘ì† ì‹¤íŒ¨ê°€ ëœë‹¤</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; * Host sweetlittlebird.com:31677 was resolved.</span>
<span class="c">#    * ...</span>
<span class="c">#    * Failed to connect to sweetlittlebird.com port 31677 after 2 ms: Couldn't connect to server</span>
<span class="c">#    * ...</span>
</code></pre></div></div>

<ul>
  <li>ìì‹ ì˜ pcì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì•„ë˜ ë³€ìˆ˜ëŠ” ê°ì ìì‹ ì˜ ê°’ì„ ì§ì ‘ ì…ë ¥ í•  ê²ƒ</span>
<span class="c"># $ IGWHTTP=&lt;ê°ì ì¶œë ¥ëœ NodePort&gt;</span>
<span class="nv">$ IGWHTTP</span><span class="o">=</span>31677
<span class="c"># $ ISTIONODEIP=&lt;k3s-m ì˜ ìœ ë™ ê³µì¸ IP&gt;</span>
<span class="nv">$ ISTIONODEIP</span><span class="o">=</span>54.123.42.212

<span class="nv">$ </span><span class="nb">export </span><span class="nv">MYDOMAIN</span><span class="o">=</span>sweetlittlebird.com
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"192.168.10.10 </span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"export MYDOMAIN=</span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile

<span class="c"># istio ingress gw ì ‘ì† í…ŒìŠ¤íŠ¸ : ì•„ì§ì€ ì„¤ì •ì´ ì—†ì–´ì„œ ì ‘ì† ì‹¤íŒ¨ê°€ ëœë‹¤</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; * Host sweetlittlebird.com:31677 was resolved.</span>
<span class="c">#    * ...</span>
<span class="c">#    * Failed to connect to sweetlittlebird.com port 31677 after 2 ms: Couldn't connect to server</span>
<span class="c">#    * ...</span>
</code></pre></div></div>

<h3 id="istioë¥¼-í†µí•œ-ì™¸ë¶€-ë…¸ì¶œ">Istioë¥¼ í†µí•œ ì™¸ë¶€ ë…¸ì¶œ</h3>

<ul>
  <li>Nginx ë””í”Œë¡œì´ë¨¼íŠ¸ì™€ ì„œë¹„ìŠ¤ ë°°í¬</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë¡œê·¸ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> istio-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>istiod
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS      AGE</span>
<span class="c">#    istiod-7f8b586864-8mc4c   1/1     Running   1 (60m ago)   73m</span>
<span class="nv">$ </span>kubetail <span class="nt">-n</span> istio-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>istiod <span class="nt">-f</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> istio-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>istio-ingressgateway
<span class="c"># =&gt; NAME                                    READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    istio-ingressgateway-5f9f654d46-l7mqp   1/1     Running   0          74m</span>
<span class="nv">$ </span>kubetail <span class="nt">-n</span> istio-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>istio-ingressgateway <span class="nt">-f</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kans-nginx
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-websrv
spec:
  replicas: 1
  selector:
    matchLabels:
      app: deploy-websrv
  template:
    metadata:
      labels:
        app: deploy-websrv
    spec:
      serviceAccountName: kans-nginx
      terminationGracePeriodSeconds: 0
      containers:
      - name: deploy-websrv
        image: nginx:alpine
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: svc-clusterip
spec:
  ports:
    - name: svc-webport
      port: 80
      targetPort: 80
  selector:
    app: deploy-websrv
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; serviceaccount/kans-nginx created</span>
<span class="c">#    deployment.apps/deploy-websrv created</span>
<span class="c">#    service/svc-clusterip created</span>

<span class="c"># ì‚¬ì´ë“œì¹´ ì»¨í…Œì´ë„ˆ ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod,svc,ep,sa <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                                 READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/deploy-websrv-778ffd6947-cxf5k   2/2     Running   0          50s   172.16.1.13   k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE     SELECTOR</span>
<span class="c">#    service/kubernetes      ClusterIP   10.10.200.1     &amp;lt;none&amp;gt;        443/TCP   6d16h   &amp;lt;none&amp;gt;</span>
<span class="c">#    service/svc-clusterip   ClusterIP   10.10.200.243   &amp;lt;none&amp;gt;        80/TCP    50s     app=deploy-websrv</span>
<span class="c">#    </span>
<span class="c">#    NAME                      ENDPOINTS            AGE</span>
<span class="c">#    endpoints/kubernetes      192.168.10.10:6443   6d16h</span>
<span class="c">#    endpoints/svc-clusterip   172.16.1.13:80       50s</span>
<span class="c">#    </span>
<span class="c">#    NAME                        SECRETS   AGE</span>
<span class="c">#    serviceaccount/default      0         7d1h</span>
<span class="c">#    serviceaccount/kans-nginx   0         50s</span>

<span class="nv">$ </span>kubectl describe pod
<span class="c"># =&gt; Name:             deploy-websrv-778ffd6947-cxf5k</span>
<span class="c">#    Namespace:        default</span>
<span class="c">#    Priority:         0</span>
<span class="c">#    Service Account:  kans-nginx</span>
<span class="c">#    Node:             k3s-w2/192.168.10.102</span>
<span class="c">#    Labels:           app=deploy-websrv</span>
<span class="c">#                      security.istio.io/tlsMode=istio</span>
<span class="c">#                      ...</span>
<span class="c">#    Annotations:      istio.io/rev: default</span>
<span class="c">#                      sidecar.istio.io/status:</span>
<span class="c">#                        {&amp;quot;initContainers&amp;quot;:[&amp;quot;istio-init&amp;quot;],&amp;quot;containers&amp;quot;:[&amp;quot;istio-proxy&amp;quot;],&amp;quot;volumes&amp;quot;:[&amp;quot;workload-socket&amp;quot;,&amp;quot;credential-socket&amp;quot;,&amp;quot;workload-certs&amp;quot;,&amp;quot;istio-env...</span>
<span class="c">#    Status:           Running</span>
<span class="c">#    ...</span>
<span class="c">#    Controlled By:  ReplicaSet/deploy-websrv-778ffd6947</span>
<span class="c">#    &lt;span style="color: red;"&gt;Init Containers:&lt;/span&gt;  # &lt;span style="color: green;"&gt;ğŸ‘‰ init containerê°€ íŒŒë“œë‚´ iptables ì…‹íŒ…&lt;/span&gt;</span>
<span class="c">#      istio-init:</span>
<span class="c">#        Container ID:  containerd://2a114fe0624581b35bda9ca257c6d3c831138e8a44900a6130e988bb51eb05da</span>
<span class="c">#        Image:         docker.io/istio/proxyv2:1.23.2</span>
<span class="c">#        Image ID:      docker.io/istio/proxyv2@sha256:2876cfc2fdf47e4b9665390ccc9ccf2bf913b71379325b8438135c9f35578e1a</span>
<span class="c">#        Port:          &amp;lt;none&amp;gt;</span>
<span class="c">#        Host Port:     &amp;lt;none&amp;gt;</span>
<span class="c">#        Args:</span>
<span class="c">#          &lt;span style="color: red;"&gt;istio-iptables&lt;/span&gt;</span>
<span class="c">#          -p</span>
<span class="c">#          15001</span>
<span class="c">#          -z</span>
<span class="c">#          15006</span>
<span class="c">#          -u</span>
<span class="c">#          1337</span>
<span class="c">#          -m</span>
<span class="c">#          REDIRECT</span>
<span class="c">#          -i</span>
<span class="c">#          *</span>
<span class="c">#          -x</span>
<span class="c">#    </span>
<span class="c">#          -b</span>
<span class="c">#          *</span>
<span class="c">#          -d</span>
<span class="c">#          15090,15021,15020</span>
<span class="c">#          --log_output_level=default:info</span>
<span class="c">#        State:          Terminated</span>
<span class="c">#          Reason:       Completed</span>
<span class="c">#        ...</span>
<span class="c">#    Containers:</span>
<span class="c">#      deploy-websrv:</span>
<span class="c">#        Container ID:   containerd://8918e0bb760bce8d090e84818bc189ae3ababdf9e74eb7dd3fb9709b356891f9</span>
<span class="c">#        Image:          nginx:alpine</span>
<span class="c">#        ...</span>
<span class="c">#      &lt;span style="color: red;"&gt;istio-proxy:&lt;/span&gt;  # &lt;span style="color: green;"&gt;ğŸ‘‰ istio-proxyë¼ëŠ” ì»¨í…Œì´ë„ˆê°€ sidecarë¡œ ë™ì‘ ì¤‘&lt;/span&gt;</span>
<span class="c">#        Container ID:  containerd://71d9e07a530dfce2ec34810d60a28dc3f9445b8eab714c2a7e204c459c59bcd3</span>
<span class="c">#        Image:         docker.io/istio/proxyv2:1.23.2</span>
<span class="c">#        Image ID:      docker.io/istio/proxyv2@sha256:2876cfc2fdf47e4b9665390ccc9ccf2bf913b71379325b8438135c9f35578e1a</span>
<span class="c">#        Port:          15090/TCP</span>
<span class="c">#        Host Port:     0/TCP</span>
<span class="c">#        Args:</span>
<span class="c">#          proxy</span>
<span class="c">#          sidecar</span>
<span class="c">#          --domain</span>
<span class="c">#          $(POD_NAMESPACE).svc.cluster.local</span>
<span class="c">#          --proxyLogLevel=warning</span>
<span class="c">#          --proxyComponentLogLevel=misc:error</span>
<span class="c">#          --log_output_level=default:info</span>
<span class="c">#        State:          Running</span>
<span class="c">#        ...</span>
</code></pre></div></div>

<ul>
  <li>Istio Gateway/VirtualService ì„¤ì • - Host ê¸°ë°˜ íŠ¸ë˜í”½ ë¼ìš°íŒ… ì„¤ì • <a href="https://istio.io/latest/docs/setup/additional-setup/gateway/">ë§í¬</a>
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_9.png" alt="img.png" class="image-center w-80" />
    <ul>
      <li>í´ë¼ì´ì–¸íŠ¸ PC â†’ (Service:NodePort) Istio ingressgateway íŒŒë“œ â†’ (Gateway, VirtualService, Service ëŠ” Bypass) â†’ Endpoint(íŒŒë“œ : ì‚¬ì´ë“œì¹´ - Application ì»¨í…Œì´ë„ˆ)</li>
      <li>Gateway : ì§€ì •í•œ ì¸ê·¸ë ˆìŠ¤ ê²Œì´íŠ¸ì›¨ì´ë¡œë¶€í„° íŠ¸ë˜í”½ì´ ì¸ì…, í”„ë¡œí† ì½œ ë° í¬íŠ¸, HOSTS, Proxy ë“± ì„¤ì • ê°€ëŠ¥ <a href="https://istio.io/latest/docs/setup/additional-setup/gateway/">ë§í¬</a></li>
      <li>VirtualService : ì¸ì… ì²˜ë¦¬í•  hosts ì„¤ì •, L7 PATH ë³„ ë¼ìš°íŒ…, ëª©ì ì§€ì— ëŒ€í•œ ì •ì±… ì„¤ì • ê°€ëŠ¥ (envoy route config)</li>
      <li>(ì°¸ê³ ) Introducing Istio v1 APIs - <a href="https://istio.io/latest/blog/2024/v1-apis/">Blog</a></li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: test-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
---
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: nginx-service
spec:
  hosts:
  - "</span><span class="nv">$MYDOMAIN</span><span class="sh">"
  gateways:
  - test-gateway
  http:
  - route:
    - destination:
        host: svc-clusterip
        port:
          number: 80
</span><span class="no">EOF
</span><span class="c"># =&gt; gateway.networking.istio.io/test-gateway created</span>
<span class="c">#    virtualservice.networking.istio.io/nginx-service created</span>

<span class="c"># Istio Gateway(=gw)/VirtualService(=vs) ì„¤ì • ì •ë³´ë¥¼ í™•ì¸</span>
<span class="nv">$ </span>kubectl explain gateways.networking.istio.io
<span class="nv">$ </span>kubectl explain virtualservices.networking.istio.io
<span class="nv">$ </span>kubectl api-resources  | <span class="nb">grep </span>istio
<span class="c"># =&gt; wasmplugins                                      extensions.istio.io/v1alpha1      true         WasmPlugin</span>
<span class="c">#    destinationrules                    dr           networking.istio.io/v1            true         DestinationRule</span>
<span class="c">#    envoyfilters                                     networking.istio.io/v1alpha3      true         EnvoyFilter</span>
<span class="c">#    gateways                            gw           networking.istio.io/v1            true         Gateway</span>
<span class="c">#    proxyconfigs                                     networking.istio.io/v1beta1       true         ProxyConfig</span>
<span class="c">#    serviceentries                      se           networking.istio.io/v1            true         ServiceEntry</span>
<span class="c">#    sidecars                                         networking.istio.io/v1            true         Sidecar</span>
<span class="c">#    virtualservices                     vs           networking.istio.io/v1            true         VirtualService</span>
<span class="c">#    workloadentries                     we           networking.istio.io/v1            true         WorkloadEntry</span>
<span class="c">#    workloadgroups                      wg           networking.istio.io/v1            true         WorkloadGroup</span>
<span class="c">#    authorizationpolicies               ap           security.istio.io/v1              true         AuthorizationPolicy</span>
<span class="c">#    peerauthentications                 pa           security.istio.io/v1              true         PeerAuthentication</span>
<span class="c">#    requestauthentications              ra           security.istio.io/v1              true         RequestAuthentication</span>
<span class="c">#    telemetries                         telemetry    telemetry.istio.io/v1             true         Telemetry</span>

<span class="c"># virtual service ëŠ” ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ì„œë¹„ìŠ¤(ex. svc-nn.&lt;ns&gt;)ë„ ì°¸ì¡°í•  ìˆ˜ ìˆë‹¤</span>
<span class="nv">$ </span>kubectl get gw,vs
<span class="c"># =&gt; NAME                                       AGE</span>
<span class="c">#    gateway.networking.istio.io/test-gateway   105s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                               GATEWAYS           HOSTS                     AGE</span>
<span class="c">#    virtualservice.networking.istio.io/nginx-service   [&amp;quot;test-gateway&amp;quot;]   [&amp;quot;sweetlittlebird.com&amp;quot;]   105s</span>

<span class="c"># Retrieves last sent and last acknowledged xDS sync from Istiod to each Envoy in the mesh</span>
<span class="c"># istioctl proxy-status command was improved to include the time since last change, and more relevant status values.</span>
<span class="nv">$ </span>istioctl proxy-status <span class="c"># ë‹¨ì¶•ì–´ ps</span>
<span class="nv">$ </span>istioctl ps
<span class="c"># =&gt; NAME                                                   CLUSTER        CDS                LDS                EDS              RDS                ECDS        ISTIOD                      VERSION</span>
<span class="c">#    deploy-websrv-778ffd6947-cxf5k.default                 Kubernetes     SYNCED (22m)       SYNCED (22m)       SYNCED (22m)     SYNCED (22m)       IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    istio-ingressgateway-5f9f654d46-l7mqp.istio-system     Kubernetes     SYNCED (2m14s)     SYNCED (2m14s)     SYNCED (22m)     SYNCED (2m14s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
</code></pre></div></div>

<ul>
  <li>Istioë¥¼ í†µí•œ Nginx íŒŒë“œ ì ‘ì† í…ŒìŠ¤íŠ¸
    <ul>
      <li>ì™¸ë¶€ (ìì‹ ì˜ PC, test pc)ì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># istio ingress gw ë¥¼ í†µí•œ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span> | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
<span class="c"># =&gt; &lt;title&gt;Welcome to nginx!&lt;/title&gt;</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; * Host sweetlittlebird.com:31677 was resolved.</span>
<span class="c">#    * IPv6: (none)</span>
<span class="c">#    * IPv4: 192.168.10.10, 192.168.10.10</span>
<span class="c">#    *   Trying 192.168.10.10:31677...</span>
<span class="c">#    * Connected to sweetlittlebird.com (192.168.10.10) port 31677</span>
<span class="c">#    &amp;gt; GET / HTTP/1.1</span>
<span class="c">#    &amp;gt; Host: sweetlittlebird.com:31677</span>
<span class="c">#    &amp;gt; User-Agent: curl/8.5.0</span>
<span class="c">#    &amp;gt; Accept: */*</span>
<span class="c">#    &amp;gt;</span>
<span class="c">#    &amp;lt; HTTP/1.1 200 OK</span>
<span class="c">#    &amp;lt; server: istio-envoy</span>
<span class="c">#    &amp;lt; date: Sat, 19 Oct 2024 07:14:25 GMT</span>
<span class="c">#    &amp;lt; content-type: text/html</span>
<span class="c">#    &amp;lt; content-length: 615</span>
<span class="c">#    &amp;lt; last-modified: Wed, 02 Oct 2024 16:07:39 GMT</span>
<span class="c">#    &amp;lt; etag: &amp;quot;66fd6fcb-267&amp;quot;</span>
<span class="c">#    &amp;lt; accept-ranges: bytes</span>
<span class="c">#    &amp;lt; x-envoy-upstream-service-time: 1</span>
<span class="c">#    ...</span>
<span class="c"># $ curl -v -s &lt;ìœ ë™ê³µì¸ì´IP&gt;:$IGWHTTP</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> 54.123.42.212:<span class="nv">$IGWHTTP</span>
</code></pre></div></div>

<ul>
  <li>ì¶œë ¥ ë¡œê·¸ ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubetail <span class="nt">-n</span> istio-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>istio-ingressgateway <span class="nt">-f</span>
<span class="c"># =&gt; [istio-ingressgateway-5f9f654d46-l7mqp] [2024-10-01T07:49:20.833Z] &amp;quot;GET / HTTP/1.1&amp;quot; 200 - via_upstream - &amp;quot;-&amp;quot; 0 615 6 5 &amp;quot;172.16.0.0&amp;quot; &amp;quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&amp;quot; &amp;quot;6f246b4e-d675-971e-9a9d-dd809f560c6f&amp;quot; &amp;quot;sweetlittlebird.com:31677&amp;quot; &amp;quot;172.16.1.13:80&amp;quot; </span>
<span class="c">#    &lt;span style="color: red;"&gt;outbound|80||svc-clusterip.default.svc.cluster.local&lt;/span&gt; 172.16.2.14:60786 172.16.2.14:8080 172.16.0.0:8773 - -</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>deploy-websrv
<span class="c"># =&gt; [deploy-websrv-778ffd6947-cxf5k istio-proxy] [2024-10-01T07:49:20.866Z] &amp;quot;GET / HTTP/1.1&amp;quot; 200 - via_upstream - &amp;quot;-&amp;quot; 0 615 2 1 &amp;quot;172.16.0.0&amp;quot; &amp;quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&amp;quot; &amp;quot;6f246b4e-d675-971e-9a9d-dd809f560c6f&amp;quot; &amp;quot;sweetlittlebird.com:31677&amp;quot; &amp;quot;172.16.1.13:80&amp;quot; </span>
<span class="c">#    &lt;span style="color: red;"&gt;inbound|80||&lt;/span&gt; 127.0.0.6:40337 172.16.1.13:80 172.16.0.0:0 invalid:outbound_.80_._.svc-clusterip.default.svc.cluster.local default</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_10.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>istioctl ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>istioctl proxy-status
<span class="c"># =&gt; NAME                                                   CLUSTER        CDS              LDS              EDS              RDS              ECDS        ISTIOD                      VERSION</span>
<span class="c">#    deploy-websrv-778ffd6947-cxf5k.default                 Kubernetes     SYNCED (19m)     SYNCED (19m)     SYNCED (19m)     SYNCED (19m)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    istio-ingressgateway-5f9f654d46-l7mqp.istio-system     Kubernetes     SYNCED (24m)     SYNCED (24m)     SYNCED (24m)     SYNCED (24m)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>

<span class="c"># Envoy config dump : all, cluster, endpoint, listener ë“±</span>
<span class="nv">$ </span>istioctl proxy-config <span class="nt">--help</span> 
<span class="nv">$ </span>istioctl proxy-config all deploy-websrv-778ffd6947-cxf5k
<span class="nv">$ </span>istioctl proxy-config all deploy-websrv-778ffd6947-cxf5k <span class="nt">-o</span> json | jq
<span class="nv">$ </span>istioctl proxy-config route deploy-websrv-778ffd6947-cxf5k <span class="nt">-o</span> json | jq
</code></pre></div></div>

<ul>
  <li>pilot : istio-proxyë‚´ udsë¡œ envoyì™€ grpcí†µì‹ , istiodì—ì„œ ë°›ì•„ì˜¨ dynamic configë¥¼ envoyì— ì „ë‹¬</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># istio-proxy ì‚¬ìš©ì ì •ë³´ í™•ì¸ : uid(1337):gid(1337) í™•ì¸ -&gt; iptables rule ì—ì„œ ì‚¬ìš©ë¨</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> <span class="nb">tail</span> <span class="nt">-n</span> 3 /etc/passwd
<span class="c"># =&gt; ubuntu:x:1000:1000:Ubuntu:/home/ubuntu:/bin/bash</span>
<span class="c">#    tcpdump:x:100:102::/nonexistent:/usr/sbin/nologin</span>
<span class="c">#    istio-proxy:x:1337:1337::/home/istio-proxy:/bin/sh</span>

<span class="c"># envoy ì„¤ì • ì •ë³´ í™•ì¸ : dynamic_resources , static_resources - listeners  </span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> <span class="nb">cat</span> /etc/istio/proxy/envoy-rev.json
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> ss <span class="nt">-nlp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> ss <span class="nt">-np</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> netstat <span class="nt">-np</span>
<span class="c"># =&gt; Active Internet connections (w/o servers)</span>
<span class="c">#    Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span>
<span class="c">#    tcp        0      0 127.0.0.1:33168         127.0.0.1:15020         ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 127.0.0.1:33156         127.0.0.1:15020         ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 172.16.1.13:15006       172.16.2.14:33006       ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 172.16.1.13:59774       10.10.200.215:15012     ESTABLISHED 1/pilot-agent</span>
<span class="c">#    tcp        0      0 172.16.1.13:15006       172.16.2.14:60786       ESTABLISHED 13/envoy</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 172.16.1.13 : deploy-websrv íŒŒë“œ ip&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    172.16.2.14 : istio-ingressgateway íŒŒë“œ ip&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    10.10.200.215 : istiod ì„œë¹„ìŠ¤ì˜ Cluster-IP&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c">#    Active UNIX domain sockets (w/o servers)</span>
<span class="c">#    Proto RefCnt Flags       Type       State         I-Node   PID/Program name     Path</span>
<span class="c">#    unix  3      [ ]         STREAM     CONNECTED     54162    13/envoy</span>
<span class="c">#    unix  3      [ ]         STREAM     CONNECTED     54709    1/pilot-agent        var/run/secrets/workload-spiffe-uds/socket</span>
<span class="c">#    unix  3      [ ]         STREAM     CONNECTED     71034    1/pilot-agent        etc/istio/proxy/XDS</span>
<span class="c">#    unix  3      [ ]         STREAM     CONNECTED     72979    13/envoy</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> ps <span class="nt">-ef</span>
<span class="c"># =&gt; UID          PID    PPID  C STIME TTY          TIME CMD</span>
<span class="c">#    istio-p+       1       0  0 06:43 ?        00:00:01 /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --proxyLogLevel=warning --proxyComponentLogLevel=mi</span>
<span class="c">#    istio-p+      13       1  0 06:43 ?        00:00:34 /usr/local/bin/envoy -c etc/istio/proxy/envoy-rev.json --drain-time-s 45 --drain-strategy immediate --local-address-ip-version</span>

<span class="c"># </span>
<span class="nv">$ </span>kubectl get pod,svc <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE      NAME                                            READY   STATUS    RESTARTS        AGE     IP            NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    default        pod/deploy-websrv-778ffd6947-cxf5k              2/2     Running   0               91m     172.16.1.13   k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    istio-system   pod/istio-ingressgateway-5f9f654d46-l7mqp       1/1     Running   0               167m    172.16.2.14   k3s-w3   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    istio-system   pod/istiod-7f8b586864-8mc4c                     1/1     Running   1 (154m ago)    167m    172.16.3.16   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAMESPACE      NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE     SELECTOR</span>
<span class="c">#    default        service/kubernetes                           ClusterIP   10.10.200.1     &amp;lt;none&amp;gt;        443/TCP                                                                      6d17h   &amp;lt;none&amp;gt;</span>
<span class="c">#    default        service/svc-clusterip                        ClusterIP   10.10.200.243   &amp;lt;none&amp;gt;        80/TCP                                                                       91m     app=deploy-websrv</span>
<span class="c">#    istio-system   service/istio-ingressgateway                 NodePort    10.10.200.171   &amp;lt;none&amp;gt;        15021:30953/TCP,80:31677/TCP,443:30737/TCP,31400:30617/TCP,15443:31668/TCP   167m    app=istio-ingressgateway,istio=ingressgateway</span>
<span class="c">#    istio-system   service/istiod                               ClusterIP   10.10.200.215   &amp;lt;none&amp;gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP                                        167m    app=istiod,istio=pilot</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> netstat <span class="nt">-antp</span>
<span class="c"># =&gt; Active Internet connections (servers and established)</span>
<span class="c">#    Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span>
<span class="c">#    tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -</span>
<span class="c">#    ...</span>
<span class="c">#    tcp        0      0 127.0.0.1:33168         127.0.0.1:15020         ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 127.0.0.1:33156         127.0.0.1:15020         ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 172.16.1.13:15006       172.16.2.14:33006       ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 172.16.1.13:59774       10.10.200.215:15012     ESTABLISHED 1/pilot-agent</span>
<span class="c">#    tcp        0      0 172.16.1.13:15006       172.16.2.14:60786       ESTABLISHED 13/envoy</span>
<span class="c">#    tcp6       0      0 127.0.0.1:15020         127.0.0.1:33168         ESTABLISHED 1/pilot-agent</span>
<span class="c">#    tcp6       0      0 127.0.0.1:15020         127.0.0.1:33156         ESTABLISHED 1/pilot-agent</span>

<span class="c"># istiod ì •ë³´ ê°™ì´ í™•ì¸ : ì¶œë ¥ë˜ëŠ” IPê°€ ëˆ„êµ¬ì¸ì§€ í™•ì¸ í•´ë³´ì</span>
<span class="nv">$ </span>kubectl get pod,svc <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ps <span class="nt">-ef</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> netstat <span class="nt">-antp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-nlp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-np</span>
<span class="c"># =&gt; Netid  State  Recv-Q  Send-Q         Local Address:Port           Peer Address:Port   Process</span>
<span class="c">#    tcp    ESTAB  0       0                172.16.3.16:33552           10.10.200.1:443     users:((&amp;quot;pilot-discovery&amp;quot;,pid=1,fd=7))</span>
<span class="c">#    tcp    ESTAB  0       0       [::ffff:172.16.3.16]:15012  [::ffff:172.16.2.14]:37102   users:((&amp;quot;pilot-discovery&amp;quot;,pid=1,fd=13))</span>
<span class="c">#    tcp    ESTAB  0       0       [::ffff:172.16.3.16]:15012  [::ffff:172.16.1.13]:56560   users:((&amp;quot;pilot-discovery&amp;quot;,pid=1,fd=14))</span>
</code></pre></div></div>

<ul>
  <li>istio-proxy, istiodê°€ ê°ê° ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ ì •ë³´ <a href="https://istio.io/latest/docs/ops/deployment/application-requirements/">ë§í¬</a>
    <ul>
      <li>
        <p>istio-proxy</p>

        <table>
          <thead>
            <tr>
              <th>Port</th>
              <th>Protocol</th>
              <th>Description</th>
              <th>Pod-internal only</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>15000</td>
              <td>TCP</td>
              <td>Envoy admin port (commands/diagnostics)</td>
              <td>Yes</td>
            </tr>
            <tr>
              <td>15001</td>
              <td>TCP</td>
              <td>Envoy outbound</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15004</td>
              <td>HTTP</td>
              <td>Debug port</td>
              <td>Yes</td>
            </tr>
            <tr>
              <td>15006</td>
              <td>TCP</td>
              <td>Envoy inbound</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15008</td>
              <td>HTTP2</td>
              <td>HBONE mTLS tunnel port</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15020</td>
              <td>HTTP</td>
              <td>Merged Prometheus telemetry from Istio agent, Envoy, and application No</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15021</td>
              <td>HTTP</td>
              <td>Health checks</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15053</td>
              <td>DNS</td>
              <td>DNS port, if capture is enabled</td>
              <td>Yes</td>
            </tr>
            <tr>
              <td>15090</td>
              <td>HTTP</td>
              <td>Envoy Prometheus telemetry</td>
              <td>No</td>
            </tr>
          </tbody>
        </table>
      </li>
      <li>
        <p>istiod (ì»¨íŠ¸ë¡¤í”Œë ˆì¸)</p>

        <table>
          <thead>
            <tr>
              <th>Port</th>
              <th>Protocol</th>
              <th>Description</th>
              <th>Pod-internal only</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>443</td>
              <td>HTTPS</td>
              <td>Webhooks service port</td>
              <td>No</td>
            </tr>
            <tr>
              <td>8080</td>
              <td>HTTP</td>
              <td>Debug interface (deprecated, container port only)</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15010</td>
              <td>GRPC</td>
              <td>XDS and CA services (Plaintext, only for secure networks)</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15012</td>
              <td>GRPC</td>
              <td>XDS and CA services (TLS and mTLS, recommended for production use)</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15014</td>
              <td>HTTP</td>
              <td>Control plane monitoring</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15017</td>
              <td>HTTPS</td>
              <td>Webhook container port, forwarded from 443</td>
              <td>No</td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>
  </li>
  <li>Istio - Istio proxyì™€ Envoy í”„ë¡œì„¸ìŠ¤ê°„ ìœ ë‹‰ìŠ¤ ë„ë©”ì¸ ì†Œì¼“ í†µì‹  í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    deploy-websrv-778ffd6947-cxf5k   2/2     Running   0          106m</span>

<span class="c"># istio ì»¨í…Œì´ë„ˆ ì ‘ì†</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> bash
<span class="nt">---------------------------------------------------------------</span>
<span class="c"># SDS, XDS ëŠ” ì†Œì¼“ íƒ€ì…</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /etc/istio/proxy
<span class="c"># =&gt; total 24</span>
<span class="c">#    drwxrwxrwt 2 root        root          100 Oct 19 06:43 .</span>
<span class="c">#    drwxr-xr-x 4 root        root         4096 Oct 19 06:43 ..</span>
<span class="c">#    srw-rw-rw- 1 istio-proxy istio-proxy     0 Oct 19 06:43 XDS</span>
<span class="c">#    -rw-r--r-- 1 istio-proxy istio-proxy 13644 Oct 19 06:43 envoy-rev.json</span>
<span class="c">#    -rw-r--r-- 1 istio-proxy istio-proxy  2747 Oct 19 06:43 grpc-bootstrap.json</span>

<span class="c"># .json íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span>more /etc/istio/proxy/envoy-rev.json
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;node&amp;quot;: {</span>
<span class="c">#        &amp;quot;id&amp;quot;: &amp;quot;sidecar~172.16.1.13~deploy-websrv-778ffd6947-cxf5k.default~default.svc.cluster.local&amp;quot;,</span>
<span class="c">#        &amp;quot;cluster&amp;quot;: &amp;quot;deploy-websrv.default&amp;quot;,</span>
<span class="c">#    ...</span>
<span class="c">#      &amp;quot;admin&amp;quot;: {</span>
<span class="c">#        &amp;quot;access_log&amp;quot;: [</span>
<span class="c">#          {</span>
<span class="c">#            &amp;quot;name&amp;quot;: &amp;quot;envoy.access_loggers.file&amp;quot;,</span>
<span class="c">#            &amp;quot;typed_config&amp;quot;: {</span>
<span class="c">#              &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog&amp;quot;,</span>
<span class="c">#              &amp;quot;path&amp;quot;: &amp;quot;/dev/null&amp;quot;</span>
<span class="c">#            }</span>
<span class="c">#          }</span>
<span class="c">#        ],</span>
<span class="c">#        &amp;quot;profile_path&amp;quot;: &amp;quot;/var/lib/istio/data/envoy.prof&amp;quot;,</span>
<span class="c">#        &amp;quot;address&amp;quot;: {</span>
<span class="c">#          &amp;quot;socket_address&amp;quot;: {</span>
<span class="c">#            &amp;quot;address&amp;quot;: &amp;quot;127.0.0.1&amp;quot;,</span>
<span class="c">#            &amp;quot;port_value&amp;quot;: 15000</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      },</span>
<span class="c">#    ...</span>
<span class="c">#    &amp;quot;dynamic_resources&amp;quot;: {</span>
<span class="c">#        &amp;quot;lds_config&amp;quot;: {</span>
<span class="c">#          &amp;quot;ads&amp;quot;: {},</span>
<span class="c">#          &amp;quot;initial_fetch_timeout&amp;quot;: &amp;quot;0s&amp;quot;,</span>
<span class="c">#          &amp;quot;resource_api_version&amp;quot;: &amp;quot;V3&amp;quot;</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;cds_config&amp;quot;: {</span>
<span class="c">#          &amp;quot;ads&amp;quot;: {},</span>
<span class="c">#          &amp;quot;initial_fetch_timeout&amp;quot;: &amp;quot;0s&amp;quot;,</span>
<span class="c">#          &amp;quot;resource_api_version&amp;quot;: &amp;quot;V3&amp;quot;</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;ads_config&amp;quot;: {</span>
<span class="c">#          &amp;quot;api_type&amp;quot;: &amp;quot;GRPC&amp;quot;,</span>
<span class="c">#          &amp;quot;set_node_on_first_message_only&amp;quot;: true,</span>
<span class="c">#          &amp;quot;transport_api_version&amp;quot;: &amp;quot;V3&amp;quot;,</span>
<span class="c">#          &amp;quot;grpc_services&amp;quot;: [</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;envoy_grpc&amp;quot;: {</span>
<span class="c">#                &amp;quot;cluster_name&amp;quot;: &amp;quot;xds-grpc&amp;quot;</span>
<span class="c">#    ...</span>
<span class="c">#    &amp;quot;static_resources&amp;quot;: {</span>
<span class="c">#        &amp;quot;clusters&amp;quot;: [</span>
<span class="c">#          {</span>
<span class="c">#            ...</span>
<span class="c">#            &amp;quot;name&amp;quot;: &amp;quot;xds-grpc&amp;quot;,</span>
<span class="c">#            &amp;quot;alt_stat_name&amp;quot;: &amp;quot;xds-grpc;&amp;quot;,</span>
<span class="c">#            &amp;quot;type&amp;quot; : &amp;quot;STATIC&amp;quot;,</span>
<span class="c">#            &amp;quot;connect_timeout&amp;quot;: &amp;quot;1s&amp;quot;,</span>
<span class="c">#            &amp;quot;lb_policy&amp;quot;: &amp;quot;ROUND_ROBIN&amp;quot;,</span>
<span class="c">#            &amp;quot;load_assignment&amp;quot;: {</span>
<span class="c">#              &amp;quot;cluster_name&amp;quot;: &amp;quot;xds-grpc&amp;quot;,</span>
<span class="c">#              &amp;quot;endpoints&amp;quot;: [{</span>
<span class="c">#                &amp;quot;lb_endpoints&amp;quot;: [{</span>
<span class="c">#                  &amp;quot;endpoint&amp;quot;: {</span>
<span class="c">#                    &amp;quot;address&amp;quot;:{</span>
<span class="c">#                      &amp;quot;pipe&amp;quot;: {</span>
<span class="c">#                        &amp;quot;path&amp;quot;: &amp;quot;./etc/istio/proxy/XDS&amp;quot;</span>
<span class="c">#                      }</span>
<span class="c">#    ...</span>
<span class="c">#    &amp;quot;listeners&amp;quot;:[</span>
<span class="c">#      ...</span>
<span class="c">#      &amp;quot;address&amp;quot;: {</span>
<span class="c">#        &amp;quot;socket_address&amp;quot;: {</span>
<span class="c">#          &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;,</span>
<span class="c">#          &amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,</span>
<span class="c">#          &amp;quot;port_value&amp;quot;: 15090</span>
<span class="c">#        }</span>
<span class="c">#      },</span>
<span class="c">#     &amp;quot;filter_chains&amp;quot;: [</span>
<span class="c">#                &amp;quot;filters&amp;quot;: [</span>
<span class="c">#                  {</span>
<span class="c">#                    &amp;quot;name&amp;quot;: &amp;quot;envoy.filters.network.http_connection_manager&amp;quot;,</span>
<span class="c">#                    &amp;quot;typed_config&amp;quot;: {</span>
<span class="c">#                      &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&amp;quot;,</span>
<span class="c">#                      &amp;quot;codec_type&amp;quot;: &amp;quot;AUTO&amp;quot;,</span>
<span class="c">#                      &amp;quot;stat_prefix&amp;quot;: &amp;quot;agent&amp;quot;,</span>
<span class="c">#                      &amp;quot;route_config&amp;quot;: {</span>
<span class="c">#                        &amp;quot;virtual_hosts&amp;quot;: [</span>
<span class="c">#                          {</span>
<span class="c">#                            &amp;quot;name&amp;quot;: &amp;quot;backend&amp;quot;,</span>
<span class="c">#                            &amp;quot;domains&amp;quot;: [</span>
<span class="c">#                              &amp;quot;*&amp;quot;</span>
<span class="c">#                            ],</span>
<span class="c">#                            &amp;quot;routes&amp;quot;: [</span>
<span class="c">#                              {</span>
<span class="c">#                                &amp;quot;match&amp;quot;: {</span>
<span class="c">#                                  &amp;quot;prefix&amp;quot;: &amp;quot;/healthz/ready&amp;quot;</span>
<span class="c">#                                },</span>
<span class="c">#                                &amp;quot;route&amp;quot;: {</span>
<span class="c">#                                  &amp;quot;cluster&amp;quot;: &amp;quot;agent&amp;quot;</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>more /etc/istio/proxy/grpc-bootstrap.json
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;xds_servers&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;server_uri&amp;quot;: &lt;span style="color: red;"&gt;&amp;quot;unix:///etc/istio/proxy/XDS&amp;quot;,&lt;/span&gt;</span>
<span class="c">#          ...</span>
<span class="c">#        }</span>
<span class="c">#      ],</span>
<span class="c">#      &amp;quot;node&amp;quot;: {</span>
<span class="c">#        &amp;quot;id&amp;quot;: &amp;quot;sidecar~172.16.1.13~deploy-websrv-778ffd6947-cxf5k.default~default.svc.cluster.local&amp;quot;,</span>
<span class="c">#        &amp;quot;metadata&amp;quot;: {</span>
<span class="c">#          &amp;quot;ANNOTATIONS&amp;quot;: {</span>
<span class="c">#            &amp;quot;istio.io/rev&amp;quot;: &amp;quot;default&amp;quot;,</span>
<span class="c">#            &amp;quot;kubectl.kubernetes.io/default-container&amp;quot;: &amp;quot;deploy-websrv&amp;quot;,</span>
<span class="c">#            &amp;quot;kubectl.kubernetes.io/default-logs-container&amp;quot;: &amp;quot;deploy-websrv&amp;quot;,</span>
<span class="c">#            ...</span>
<span class="c">#            &amp;quot;sidecar.istio.io/status&amp;quot;: &amp;quot;{\&amp;quot;initContainers\&amp;quot;:[\&amp;quot;istio-init\&amp;quot;],\&amp;quot;containers\&amp;quot;:[\&amp;quot;istio-proxy\&amp;quot;],\&amp;quot;volumes\&amp;quot;:[\&amp;quot;workload-socket\&amp;quot;,\&amp;quot;credential-socket\&amp;quot;,\&amp;quot;workload-certs\&amp;quot;</span>
<span class="c">#    ,\&amp;quot;istio-envoy\&amp;quot;,\&amp;quot;istio-data\&amp;quot;,\&amp;quot;istio-podinfo\&amp;quot;,\&amp;quot;istio-token\&amp;quot;,\&amp;quot;istiod-ca-cert\&amp;quot;],\&amp;quot;imagePullSecrets\&amp;quot;:null,\&amp;quot;revision\&amp;quot;:\&amp;quot;default\&amp;quot;}&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          ...</span>
<span class="c">#          &amp;quot;SERVICE_ACCOUNT&amp;quot;: &amp;quot;kans-nginx&amp;quot;,</span>
<span class="c">#          &amp;quot;WORKLOAD_NAME&amp;quot;: &amp;quot;deploy-websrv&amp;quot;</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;locality&amp;quot;: {},</span>
<span class="c">#        &amp;quot;UserAgentVersionType&amp;quot;: null</span>
<span class="c">#      },</span>
<span class="c">#      &amp;quot;server_listener_resource_name_template&amp;quot;: &amp;quot;xds.istio.io/grpc/lds/inbound/%s&amp;quot;</span>
<span class="c">#    }</span>

<span class="c"># display only Unix domain sockets : Listener ê³¼ ESTAB ìƒíƒœ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ss <span class="nt">-xpl</span>
<span class="c"># =&gt; Netid State  Recv-Q Send-Q                              Local Address:Port  Peer Address:PortProcess</span>
<span class="c">#    u_str LISTEN 0      4096                          etc/istio/proxy/XDS 54694            * 0    users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=11))</span>
<span class="c">#    u_str LISTEN 0      4096   var/run/secrets/workload-spiffe-uds/socket 54693            * 0    users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=9))</span>
<span class="nv">$ </span>ss <span class="nt">-xp</span>
<span class="c"># =&gt; Netid State Recv-Q Send-Q                              Local Address:Port  Peer Address:Port Process</span>
<span class="c">#    u_str ESTAB 0      0                             etc/istio/proxy/XDS 79304            * 82228 users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=10))</span>
<span class="c">#    u_str ESTAB 0      0      var/run/secrets/workload-spiffe-uds/socket 54709            * 54162 users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=16))</span>
<span class="c">#    u_str ESTAB 0      0                                               * 82228            * 79304 users:((&amp;quot;envoy&amp;quot;,pid=13,fd=19))</span>
<span class="c">#    u_str ESTAB 0      0                                               * 54162            * 54709 users:((&amp;quot;envoy&amp;quot;,pid=13,fd=32))</span>

<span class="c"># display only TCP sockets and display only IP version 4 sockets : TCP ìƒíƒœ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ss <span class="nt">-4tpl</span>
<span class="c"># =&gt; LISTEN 0      4096         0.0.0.0:15090      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=21))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15090      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=20))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15021      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=23))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15021      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=22))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15001      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=35))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15001      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=34))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15006      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=37))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15006      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=36))</span>
<span class="c">#    LISTEN 0      4096       127.0.0.1:15000      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=18))</span>
<span class="c">#    LISTEN 0      4096       127.0.0.1:15004      0.0.0.0:*    users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=13))</span>
<span class="c">#    LISTEN 0      511          0.0.0.0:http       0.0.0.0:*</span>
</code></pre></div></div>

<h3 id="bookinfo-ì‹¤ìŠµ-ë°-istio-ê¸°ëŠ¥-í™•ì¸">Bookinfo ì‹¤ìŠµ ë° Istio ê¸°ëŠ¥ í™•ì¸</h3>

<h4 id="bookinfo">Bookinfo</h4>

<ul>
  <li>BookinfoëŠ” istioì˜ ê¸°ëŠ¥ì„ ì„¤ëª…í•˜ê¸°ìœ„í•œ MSA(Microservices Architecture)  ê¸°ë°˜ì˜ ì˜ˆì œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_11.png" alt="img.png" class="image-center" />
<em class="image-caption">Bookinfo ì–´í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì„±</em>
    <ul>
      <li>productpage, details, reviews, ratings ì„œë¹„ìŠ¤ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. <a href="https://istio.io/latest/docs/examples/bookinfo/">ì†Œê°œ ë§í¬</a></li>
      <li><strong>ProductPage</strong> í˜ì´ì§€ì—ì„œ ìš”ì²­ì„ ë°›ìœ¼ë©´, ë„ì„œ ë¦¬ë·°ë¥¼ ë³´ì—¬ì£¼ëŠ” <strong>Reviews</strong> ì„œë¹„ìŠ¤ì™€ ë„ì„œ ìƒì„¸ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ëŠ” <strong>Details</strong> ì„œë¹„ìŠ¤ì— ì ‘ì†í•˜ê³ ,</li>
      <li>ProductPage ëŠ” <strong>Reviews</strong> ì™€ <strong>Details</strong> ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ì‘ë‹µí•©ë‹ˆë‹¤.</li>
      <li><strong>Reviews</strong> ì„œë¹„ìŠ¤ëŠ” v1, v2, v3 ì„¸ ê°œì˜ ë²„ì „ì´ ìˆê³  v2, v3 ë²„ì „ì˜ ê²½ìš° <strong>Ratings</strong> ì„œë¹„ìŠ¤ì— ì ‘ì†Œê°›ì—¬ ë„ì„œì— ëŒ€í•œ 5ë‹¨ê³„ í‰ê°€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.</li>
      <li>Reviews ì„œë¹„ìŠ¤ì˜ ì°¨ì´ëŠ”, v1ì€ Rating ì´ <strong>ì—†ê³ </strong>, v2ëŠ” <strong>ê²€ì€ìƒ‰</strong> ë³„ë¡œ Ratings ê°€ í‘œì‹œë˜ë©°, v3ëŠ” <strong>ìƒ‰ê¹”ì´</strong> ìˆëŠ” ë³„ë¡œ Ratings ê°€ í‘œì‹œë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì„¤ì¹˜ ë° í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pod -owide;echo;kubectl get svc'</span>

<span class="c"># Bookinfo ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$ISTIOV</span>
<span class="c"># =&gt; 1.23.2</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/platform/kube/bookinfo.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/platform/kube/bookinfo.yaml
<span class="c"># =&gt; service/details created</span>
<span class="c">#    serviceaccount/bookinfo-details created</span>
<span class="c">#    deployment.apps/details-v1 created</span>
<span class="c">#    service/ratings created</span>
<span class="c">#    serviceaccount/bookinfo-ratings created</span>
<span class="c">#    deployment.apps/ratings-v1 created</span>
<span class="c">#    service/reviews created</span>
<span class="c">#    serviceaccount/bookinfo-reviews created</span>
<span class="c">#    deployment.apps/reviews-v1 created</span>
<span class="c">#    deployment.apps/reviews-v2 created</span>
<span class="c">#    deployment.apps/reviews-v3 created</span>
<span class="c">#    service/productpage created</span>
<span class="c">#    serviceaccount/bookinfo-productpage created</span>
<span class="c">#    deployment.apps/productpage-v1 created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get all,sa
<span class="c"># =&gt; NAME                                 READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/details-v1-65cfcf56f9-8465x      2/2     Running   0          87s</span>
<span class="c">#    pod/productpage-v1-d5789fdfb-f8gdf   2/2     Running   0          86s</span>
<span class="c">#    pod/ratings-v1-7c9bd4b87f-s9gxs      2/2     Running   0          87s</span>
<span class="c">#    pod/reviews-v1-6584ddcf65-gnc9j      2/2     Running   0          87s</span>
<span class="c">#    pod/reviews-v2-6f85cb9b7c-cfc68      2/2     Running   0          87s</span>
<span class="c">#    pod/reviews-v3-6f5b775685-cw7tc      2/2     Running   0          87s</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/details         ClusterIP   10.10.200.54    &amp;lt;none&amp;gt;        9080/TCP   87s</span>
<span class="c">#    service/productpage     ClusterIP   10.10.200.184   &amp;lt;none&amp;gt;        9080/TCP   87s</span>
<span class="c">#    service/ratings         ClusterIP   10.10.200.163   &amp;lt;none&amp;gt;        9080/TCP   87s</span>
<span class="c">#    service/reviews         ClusterIP   10.10.200.214   &amp;lt;none&amp;gt;        9080/TCP   87s</span>
<span class="c">#    </span>
<span class="c">#    NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/details-v1       1/1     1            1           87s</span>
<span class="c">#    deployment.apps/productpage-v1   1/1     1            1           86s</span>
<span class="c">#    deployment.apps/ratings-v1       1/1     1            1           87s</span>
<span class="c">#    deployment.apps/reviews-v1       1/1     1            1           87s</span>
<span class="c">#    deployment.apps/reviews-v2       1/1     1            1           87s</span>
<span class="c">#    deployment.apps/reviews-v3       1/1     1            1           87s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                       DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/details-v1-65cfcf56f9      1         1         1       87s</span>
<span class="c">#    replicaset.apps/productpage-v1-d5789fdfb   1         1         1       86s</span>
<span class="c">#    replicaset.apps/ratings-v1-7c9bd4b87f      1         1         1       87s</span>
<span class="c">#    replicaset.apps/reviews-v1-6584ddcf65      1         1         1       87s</span>
<span class="c">#    replicaset.apps/reviews-v2-6f85cb9b7c      1         1         1       87s</span>
<span class="c">#    replicaset.apps/reviews-v3-6f5b775685      1         1         1       87s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                  SECRETS   AGE</span>
<span class="c">#    serviceaccount/bookinfo-details       0         87s</span>
<span class="c">#    serviceaccount/bookinfo-productpage   0         86s</span>
<span class="c">#    serviceaccount/bookinfo-ratings       0         87s</span>
<span class="c">#    serviceaccount/bookinfo-reviews       0         87s</span>

<span class="c"># product ì›¹ ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="s2">"</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>ratings <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span><span class="s2">"</span> <span class="nt">-c</span> ratings <span class="nt">--</span> curl <span class="nt">-sS</span> productpage:9080/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
<span class="c"># =&gt; &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>

<span class="c"># ë¡œê·¸</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>productpage <span class="nt">-f</span>
</code></pre></div></div>

<h4 id="istioë¥¼-í†µí•œ-ì¸ì…-ê¸°ë³¸-ì„¤ì •">Istioë¥¼ í†µí•œ ì¸ì… ê¸°ë³¸ ì„¤ì •</h4>

<h5 id="istio-gatewayvirtualservice-ì„¤ì •">Istio Gateway/VirtualService ì„¤ì •</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Istio Gateway/VirtualService ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/networking/bookinfo-gateway.yaml
<span class="c"># =&gt; apiVersion: networking.istio.io/v1alpha3</span>
<span class="c">#    kind: Gateway</span>
<span class="c">#    metadata:</span>
<span class="c">#      name: bookinfo-gateway</span>
<span class="c">#    spec:</span>
<span class="c">#      # The selector matches the ingress gateway pod labels.</span>
<span class="c">#      # If you installed Istio using Helm following the standard documentation, this would be &amp;quot;istio=ingress&amp;quot;</span>
<span class="c">#      selector:</span>
<span class="c">#        istio: ingressgateway # use istio default controller</span>
<span class="c">#      servers:</span>
<span class="c">#      - port:</span>
<span class="c">#          number: 8080</span>
<span class="c">#          name: http</span>
<span class="c">#          protocol: HTTP</span>
<span class="c">#        hosts:</span>
<span class="c">#        - &amp;quot;*&amp;quot;</span>
<span class="c">#    ---</span>
<span class="c">#    apiVersion: networking.istio.io/v1alpha3</span>
<span class="c">#    kind: VirtualService</span>
<span class="c">#    metadata:</span>
<span class="c">#      name: bookinfo</span>
<span class="c">#    spec:</span>
<span class="c">#      hosts:</span>
<span class="c">#      - &amp;quot;*&amp;quot;</span>
<span class="c">#      gateways:</span>
<span class="c">#      - bookinfo-gateway</span>
<span class="c">#      http:</span>
<span class="c">#      - match:</span>
<span class="c">#        - uri:</span>
<span class="c">#            exact: /productpage</span>
<span class="c">#        - uri:</span>
<span class="c">#            prefix: /static</span>
<span class="c">#        - uri:</span>
<span class="c">#            exact: /login</span>
<span class="c">#        - uri:</span>
<span class="c">#            exact: /logout</span>
<span class="c">#        - uri:</span>
<span class="c">#            prefix: /api/v1/products</span>
<span class="c">#        route:</span>
<span class="c">#        - destination:</span>
<span class="c">#            host: productpage</span>
<span class="c">#            port:</span>
<span class="c">#              number: 9080</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/networking/bookinfo-gateway.yaml
<span class="c"># =&gt; gateway.networking.istio.io/bookinfo-gateway created</span>
<span class="c">#    virtualservice.networking.istio.io/bookinfo created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get gw,vs
<span class="nv">$ </span>istioctl proxy-status
<span class="c"># =&gt; NAME                                                   CLUSTER        CDS                LDS                EDS                RDS                ECDS        ISTIOD                      VERSION</span>
<span class="c">#    deploy-websrv-778ffd6947-cxf5k.default                 Kubernetes     SYNCED (5m9s)      SYNCED (5m9s)      SYNCED (4m24s)     SYNCED (5m9s)      IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    details-v1-65cfcf56f9-8465x.default                    Kubernetes     SYNCED (4m43s)     SYNCED (4m43s)     SYNCED (4m24s)     SYNCED (4m43s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    istio-ingressgateway-5f9f654d46-l7mqp.istio-system     Kubernetes     SYNCED (10s)       SYNCED (10s)       SYNCED (4m24s)     SYNCED (10s)       IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    productpage-v1-d5789fdfb-f8gdf.default                 Kubernetes     SYNCED (4m53s)     SYNCED (4m53s)     SYNCED (4m24s)     SYNCED (4m53s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    ratings-v1-7c9bd4b87f-s9gxs.default                    Kubernetes     SYNCED (4m24s)     SYNCED (4m24s)     SYNCED (4m24s)     SYNCED (4m24s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    reviews-v1-6584ddcf65-gnc9j.default                    Kubernetes     SYNCED (4m47s)     SYNCED (4m47s)     SYNCED (4m24s)     SYNCED (4m47s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    reviews-v2-6f85cb9b7c-cfc68.default                    Kubernetes     SYNCED (4m41s)     SYNCED (4m41s)     SYNCED (4m24s)     SYNCED (4m41s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    reviews-v3-6f5b775685-cw7tc.default                    Kubernetes     SYNCED (4m43s)     SYNCED (4m43s)     SYNCED (4m24s)     SYNCED (4m43s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>

<span class="c"># productpage íŒŒë“œì˜ istio-proxy ë¡œê·¸ í™•ì¸ Access log ê°€ ì¶œë ¥ - Default access log format : ë§í¬</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>productpage <span class="nt">-c</span> istio-proxy <span class="nt">-f</span>
</code></pre></div></div>

<ul>
  <li><strong>k3s-m</strong> NodePort ì ‘ì† í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">IGWHTTP</span><span class="o">=</span><span class="si">$(</span>kubectl get service <span class="nt">-n</span> istio-system istio-ingressgateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[1].nodePort}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; 31677</span>

<span class="c"># ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> istio-system istio-ingressgateway
<span class="c"># =&gt; NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE</span>
<span class="c">#    istio-ingressgateway   NodePort   10.10.200.171   &amp;lt;none&amp;gt;        15021:30953/TCP,80:31677/TCP,443:30737/TCP,31400:30617/TCP,15443:31668/TCP   3h31m</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> http://localhost:<span class="nv">$IGWHTTP</span>/productpage
<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.10.101:<span class="nv">$IGWHTTP</span>/productpage
<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.10.102:<span class="nv">$IGWHTTP</span>/productpage
<span class="c"># =&gt; &amp;lt;meta charset=&amp;quot;utf-8&amp;quot;&amp;gt;</span>
<span class="c">#    &amp;lt;meta http-equiv=&amp;quot;X-UA-Compatible&amp;quot; content=&amp;quot;IE=edge&amp;quot;&amp;gt;</span>
<span class="c">#    &amp;lt;meta name=&amp;quot;viewport&amp;quot; content=&amp;quot;width=device-width, initial-scale=1.0&amp;quot;&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    ...</span>

<span class="c"># ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$MYDOMAIN</span>
<span class="c"># =&gt; sweetlittlebird.com</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
<span class="c"># =&gt; ...</span>
<span class="c">#    127.0.2.1 k3s-m k3s-m</span>
<span class="c">#    192.168.10.10 k3s-m</span>
<span class="c">#    192.168.10.101 k3s-w1</span>
<span class="c">#    192.168.10.102 k3s-w2</span>
<span class="c">#    192.168.10.103 k3s-w3</span>
<span class="c">#    192.168.10.10 sweetlittlebird.com</span>

<span class="c">#</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> http://<span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage
<span class="c"># =&gt; &amp;lt;meta charset=&amp;quot;utf-8&amp;quot;&amp;gt;</span>
<span class="c">#    &amp;lt;meta http-equiv=&amp;quot;X-UA-Compatible&amp;quot; content=&amp;quot;IE=edge&amp;quot;&amp;gt;</span>
<span class="c">#    &amp;lt;meta name=&amp;quot;viewport&amp;quot; content=&amp;quot;width=device-width, initial-scale=1.0&amp;quot;&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>ìì‹ ì˜ PCì—ì„œ ì ‘ì† í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$MYDOMAIN</span> <span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; sweetlittlebird.com 31677</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts

<span class="c">#</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_12.png" alt="img.png" class="image-center" />
<em class="image-caption">Bookinfo ì ‘ì† ê²°ê³¼ - ìƒˆë¡œê³ ì¹¨ í•  ë•Œ ë§ˆë‹¤ ë‹¤ë¥¸ íŒŒë“œì— ì ‘ì†ë˜ë©´ì„œ ë¦¬ë·°ê°€ ë‹¬ë¼ì§</em></p>

<ul>
  <li><strong>testpc ì—ì„œ ì ‘ì† ì‹¤í–‰</strong></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># istio ingress gw ë¥¼ í†µí•œ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
<span class="c"># =&gt; &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    --------------</span>
<span class="c">#    &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    --------------</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h4 id="ëª¨ë‹ˆí„°ë§">ëª¨ë‹ˆí„°ë§</h4>

<ul>
  <li>ì˜µì €ë¹Œë¦¬í‹° ì—°ë™ ë¬¸ì„œ : <a href="https://istio.io/latest/docs/ops/integrations/">ë§í¬</a></li>
</ul>

<h5 id="kiali-í‚¤ì•Œë¦¬-ì†Œê°œ">Kiali (í‚¤ì•Œë¦¬) ì†Œê°œ</h5>

<ul>
  <li>KialiëŠ” Istio ì„œë¹„ìŠ¤ ë©”ì‹œì˜ ëª¨ë‹ˆí„°ë§ ë° ì‹œê°í™” ë„êµ¬ì…ë‹ˆë‹¤.</li>
  <li>ì£¼ ë°ì´í„° ì†ŒìŠ¤ëŠ” Prometheusì™€ Jaeger ë“±ì…ë‹ˆë‹¤.</li>
  <li>íŠ¹íˆ Jaegerì™€ ì—°ë™í•˜ì—¬ ì„œë¹„ìŠ¤ ê°„ì˜ í˜¸ì¶œ ê´€ê³„ë¥¼ ì‹œê°í™”í•˜ì—¬ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Istiodì˜ health ìƒíƒœë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ istiod íŒŒë“œë¥¼ ì§ì ‘ ì ‘ì†í•©ë‹ˆë‹¤. (ê¸°ë³¸ 15014í¬íŠ¸)</li>
</ul>

<h5 id="kiali-ì„¤ì¹˜-ë°-í™•ì¸">Kiali ì„¤ì¹˜ ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install Kiali and the other addons and wait for them to be deployed. : Kiali dashboard, along with Prometheus, Grafana, and Jaeger.</span>
<span class="nv">$ </span>tree ~/istio-<span class="nv">$ISTIOV</span>/samples/addons/
<span class="c"># =&gt; /root/istio-1.23.2/samples/addons/</span>
<span class="c">#    â”œâ”€â”€ README.md</span>
<span class="c">#    â”œâ”€â”€ extras</span>
<span class="c">#    â”‚   â”œâ”€â”€ prometheus-operator.yaml</span>
<span class="c">#    â”‚   â”œâ”€â”€ skywalking.yaml</span>
<span class="c">#    â”‚   â””â”€â”€ zipkin.yaml</span>
<span class="c">#    â”œâ”€â”€ grafana.yaml</span>
<span class="c">#    â”œâ”€â”€ jaeger.yaml</span>
<span class="c">#    â”œâ”€â”€ kiali.yaml</span>
<span class="c">#    â”œâ”€â”€ loki.yaml</span>
<span class="c">#    â””â”€â”€ prometheus.yaml</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/addons <span class="c"># ë””ë ‰í„°ë¦¬ì— ìˆëŠ” ëª¨ë“  yaml ìì›ì„ ìƒì„±</span>
<span class="c"># =&gt; deployment.apps/grafana created</span>
<span class="c">#    deployment.apps/jaeger created</span>
<span class="c">#    deployment.apps/kiali created</span>
<span class="c">#    deployment.apps/prometheus created</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl rollout status deployment/kiali <span class="nt">-n</span> istio-system
<span class="c"># =&gt; deployment &amp;quot;kiali&amp;quot; successfully rolled out</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get all,sa,cm <span class="nt">-n</span> istio-system
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> istio-system
<span class="c"># =&gt; NAME                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE</span>
<span class="c">#    service/grafana                ClusterIP   10.10.200.178   &amp;lt;none&amp;gt;        3000/TCP                                                                     69s</span>
<span class="c">#    service/istio-ingressgateway   NodePort    10.10.200.171   &amp;lt;none&amp;gt;        15021:30953/TCP,80:31677/TCP,443:30737/TCP,31400:30617/TCP,15443:31668/TCP   5h48m</span>
<span class="c">#    service/istiod                 ClusterIP   10.10.200.215   &amp;lt;none&amp;gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP                                        5h48m</span>
<span class="c">#    service/jaeger-collector       ClusterIP   10.10.200.121   &amp;lt;none&amp;gt;        14268/TCP,14250/TCP,9411/TCP,4317/TCP,4318/TCP                               69s</span>
<span class="c">#    service/kiali                  ClusterIP   10.10.200.19    &amp;lt;none&amp;gt;        20001/TCP,9090/TCP                                                           68s</span>
<span class="c">#    service/loki                   ClusterIP   10.10.200.227   &amp;lt;none&amp;gt;        3100/TCP,9095/TCP                                                            68s</span>
<span class="c">#    service/loki-headless          ClusterIP   None            &amp;lt;none&amp;gt;        3100/TCP                                                                     68s</span>
<span class="c">#    service/loki-memberlist        ClusterIP   None            &amp;lt;none&amp;gt;        7946/TCP                                                                     68s</span>
<span class="c">#    service/prometheus             ClusterIP   10.10.200.148   &amp;lt;none&amp;gt;        9090/TCP                                                                     68s</span>
<span class="c">#    service/tracing                ClusterIP   10.10.200.133   &amp;lt;none&amp;gt;        80/TCP,16685/TCP                                                             69s</span>
<span class="c">#    service/zipkin                 ClusterIP   10.10.200.29    &amp;lt;none&amp;gt;        9411/TCP                                                                     69s</span>
<span class="c">#    </span>
<span class="c">#    NAME                             ENDPOINTS                                                           AGE</span>
<span class="c">#    endpoints/grafana                172.16.2.17:3000                                                    69s</span>
<span class="c">#    endpoints/istio-ingressgateway   172.16.2.14:15443,172.16.2.14:15021,172.16.2.14:31400 + 2 more...   5h48m</span>
<span class="c">#    endpoints/istiod                 172.16.3.16:15012,172.16.3.16:15010,172.16.3.16:15017 + 1 more...   5h48m</span>
<span class="c">#    endpoints/jaeger-collector       172.16.3.19:9411,172.16.3.19:14250,172.16.3.19:4317 + 2 more...     69s</span>
<span class="c">#    endpoints/kiali                  172.16.1.16:9090,172.16.1.16:20001                                  68s</span>
<span class="c">#    endpoints/loki                                                                                       68s</span>
<span class="c">#    endpoints/loki-headless                                                                              68s</span>
<span class="c">#    endpoints/loki-memberlist                                                                            68s</span>
<span class="c">#    endpoints/prometheus             172.16.3.20:9090                                                    67s</span>
<span class="c">#    endpoints/tracing                172.16.3.19:16685,172.16.3.19:16686                                 69s</span>
<span class="c">#    endpoints/zipkin                 172.16.3.19:9411                                                    69s</span>

<span class="c"># kiali ì„œë¹„ìŠ¤ ë³€ê²½</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> istio-system kiali <span class="nt">-p</span> <span class="s1">'{"spec":{"type":"NodePort"}}'</span>
<span class="c"># =&gt; service/kiali patched</span>

<span class="c"># kiali ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ KIALINodePort</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> istio-system kiali <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KIALI UI URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$KIALINodePort</span><span class="s2">"</span>
<span class="c"># =&gt; KIALI UI URL = http://54.123.42.212:31274</span>

<span class="c"># Grafana ì„œë¹„ìŠ¤ ë³€ê²½</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> istio-system grafana <span class="nt">-p</span> <span class="s1">'{"spec":{"type":"NodePort"}}'</span>
<span class="c"># =&gt; service/grafana patched</span>

<span class="c"># Grafana ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸ : 7ê°œì˜ ëŒ€ì‹œë³´ë“œ</span>
<span class="nv">$ GRAFANANodePort</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> istio-system grafana <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Grafana URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$GRAFANANodePort</span><span class="s2">"</span>
<span class="c"># =&gt; Grafana URL = http://54.123.42.212:30266</span>

<span class="c"># Prometheus ì„œë¹„ìŠ¤ ë³€ê²½</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> istio-system prometheus <span class="nt">-p</span> <span class="s1">'{"spec":{"type":"NodePort"}}'</span>
<span class="c"># =&gt; service/prometheus patched</span>

<span class="c"># Prometheus ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ PROMENodePort</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> istio-system prometheus <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Prometheus URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$PROMENodePort</span><span class="s2">"</span>
<span class="c"># =&gt; Prometheus URL = http://54.123.42.212:30506</span>
</code></pre></div></div>

<ul>
  <li>Prometheus : Targets - íŒŒë“œë³„ë¡œ tcp/15020ì˜ /stats/prometheusë¥¼ í†µí•´ ìˆ˜ì§‘</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_13.png" alt="img.png" class="image-center" /></p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_14.png" alt="img.png" class="image-center" /></p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_15.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>Grafana : 7ê°œì˜ ëŒ€ì‹œë³´ë“œ</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_17.png" alt="img.png" class="image-center" /></p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_16.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>Kiali : ì„œë¹„ìŠ¤ê°„ì˜ í˜¸ì¶œ ê´€ê³„ë¥¼ ì‹œê°í™”</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_18.png" alt="img.png" class="image-center" /></p>

<h5 id="kiali-í‚¤ì•Œë¦¬-ëŒ€ì‹œë³´ë“œ-ë‘˜ëŸ¬ë³´ê¸°">Kiali (í‚¤ì•Œë¦¬) ëŒ€ì‹œë³´ë“œ ë‘˜ëŸ¬ë³´ê¸°</h5>

<ul>
  <li>Namespace ë¥¼ default ë¡œ ì„ íƒ í›„ Graph (Traffic, Versioned app graph) ì—ì„œ Display ì˜µì…˜ ì¤‘ â€˜Traffic Distributionâ€™ê³¼
â€˜Traffic Animationâ€™ í™œì„±í™”, Security ì²´í¬ í•´ì„œ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>íŠ¸ë˜í”½ì„ ë°œìƒì‹œì¼œì„œ Kiali ëŒ€ì‹œë³´ë“œë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># testpc ì—ì„œ ì•„ë˜ ì‹¤í–‰</span>
<span class="c"># ë°˜ë³µ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">sleep </span>0.5<span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..1000<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li><strong>Traffic Graph</strong>ì—ì„œëŠ” íŠ¸ë˜í”½ íë¦„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_19.png" alt="img.png" class="image-center" /></p>

<ul>
  <li><strong>Workloads</strong>ì—ì„œëŠ” Log ë“±ì„ í™•ì¸í•  ìˆ˜ ìˆê³ , Envoy ê´€ë ¨ ì„¤ì • ì •ë³´(Listener, Cluster, Route, Endpoint ë“±)ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_20.png" alt="img.png" class="image-center" /></p>

<ul>
  <li><strong>Istio Config</strong>ì—ì„œ Istio ê´€ë ¨ ì„¤ì •ì„ ë³¼ ìˆ˜ ìˆê³ , <strong>Action</strong> ìœ¼ë¡œ Istio ê´€ë ¨ ì˜¤ë¸Œì íŠ¸ë¥¼ ì„¤ì •/ì‚­ì œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="traffic-management">Traffic Management</h4>

<ul>
  <li><strong>ë™ì‘ ì†Œê°œ</strong> : í´ë¼ì´ì–¸íŠ¸ PC â†’ Istio <strong>ingressgateway</strong> íŒŒë“œ â†’ (Gateway, <strong>VirtualService</strong> + <strong>DestinationRule</strong>) â†’ Cluster(<strong>Endpoint</strong> - íŒŒë“œ)
    <ul>
      <li><strong>Gateway</strong> : ì§€ì •í•œ ì¸ê·¸ë ˆìŠ¤ ê²Œì´íŠ¸ì›¨ì´ë¡œë¶€í„° íŠ¸ë˜í”½ì´ ì¸ì…, í”„ë¡œí† ì½œ ë° í¬íŠ¸, HOSTS, Proxy ë“± ì„¤ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li><strong>VirtualService</strong> : ì¸ì… ì²˜ë¦¬í•  hosts ì„¤ì •, L7 PATH ë³„ ë¼ìš°íŒ…, ëª©ì ì§€ì— ëŒ€í•œ ì •ì±… ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤. (envoy route config) - <a href="https://istio.io/latest/docs/concepts/traffic-management/#virtual-services">ë§í¬</a>
        <ul>
          <li>VirtualService ëŠ” DestinationRule ì—ì„œ ì„¤ì •ëœ <strong>ì„œë¸Œì…‹(subset)</strong>ì„ ì‚¬ìš©í•˜ì—¬ <strong>íŠ¸ë˜í”½ ì»¨íŠ¸ë¡¤</strong>ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li><strong>hosts í•„ë“œ</strong> : ëª©ì ì§€ ì£¼ì†Œ - IP address, a DNS name (FQDN), í˜¹ì€ k8s svc ì´ë¦„, wildcard (â€*â€) prefixes</li>
          <li><strong>Routing rules</strong> : HTTP ê²½ìš° - Match í•„ë“œ(ì˜ˆ) í—¤ë”), Destination(istio/envoy ì— ë“±ë¡ëœ ëŒ€ìƒ, subnet ì— DestinationRule í™œìš©)
            <ul>
              <li><strong>HTTPRoute</strong> : redirect , rewrite , fault(ì¥ì•  ì£¼ì…) , mirror(ë³µì œ, ê¸°ë³¸ 100%) , corsPolicy(CORS ì‚½ì…) , headers(í—¤ë” ì¡°ì‘) ë“± - <a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRoute">ë§í¬</a></li>
            </ul>
          </li>
          <li>Routing rule precedence : Routing rules are evaluated in sequential order from top to bottom - ìœ„ì—ì„œ ìˆœì°¨ì  ì ìš©</li>
        </ul>
      </li>
      <li>DestinationRule : ì‹¤ì œ ë„ì°©ì§€(ì„œë¹„ìŠ¤ì™€ 1:1 ì—°ê²°)ì˜ ì •êµí•œ ì •ì±…(ë¶€í•˜ë¶„ì‚°, ì—°ê²° ì˜µì…˜, ì„œí‚· ë¸Œë ˆì´í¬, TLS ë“±)ì„ ì„¤ì • - <a href="https://istio.io/latest/docs/concepts/traffic-management/#destination-rules">ë§í¬</a>
        <ul>
          <li><strong>Load balancing options</strong> : Round robin(ê¸°ë³¸ê°’) , Random , Weighted , Least requests - <a href="https://www.envoyproxy.io/docs/envoy/v1.5.0/intro/arch_overview/load_balancing">ë§í¬</a>
            <ul>
              <li><strong>Destination Rule</strong> : TrafficPolicy , Subset , ConnectionPoolSettings ë“± - <a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/">ë§í¬</a></li>
              <li>ì„œë¸Œì…‹(subsets)ì„ ì •ì˜í•  ìˆ˜ ìˆì–´ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ <strong>ë²„ì „ë³„ë¡œ ë¼ìš°íŒ…</strong>í•  ë•Œ ì‚¬ìš©í•œë‹¤</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="request-routing-ì‹¤ìŠµ">Request Routing ì‹¤ìŠµ</h5>

<ul>
  <li>ì‹¤ìŠµì „ ê¸°ë³¸ DestinationRule ì ìš©</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ íŒŒì¼ë“¤ í™•ì¸</span>
<span class="nv">$ </span>tree ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/networking
<span class="c"># =&gt; /root/istio-1.23.2/samples/bookinfo/networking</span>
<span class="c">#    â”œâ”€â”€ bookinfo-gateway.yaml</span>
<span class="c">#    â”œâ”€â”€ certmanager-gateway.yaml</span>
<span class="c">#    â”œâ”€â”€ destination-rule-all-mtls.yaml</span>
<span class="c">#    â”œâ”€â”€ destination-rule-all.yaml</span>
<span class="c">#    â”œâ”€â”€ destination-rule-reviews.yaml</span>
<span class="c">#    â”œâ”€â”€ egress-rule-google-apis.yaml</span>
<span class="c">#    â”œâ”€â”€ fault-injection-details-v1.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-all-v1.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-details-v2.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-ratings-db.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-ratings-mysql-vm.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-ratings-mysql.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-ratings-test-abort.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-ratings-test-delay.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-50-v3.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-80-20.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-90-10.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-jason-v2-v3.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-test-v2.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-v2-v3.yaml</span>
<span class="c">#    â””â”€â”€ virtual-service-reviews-v3.yaml</span>

<span class="c"># ê¸°ë³¸ DestinationRule ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/networking/destination-rule-all.yaml
<span class="c"># =&gt; destinationrule.networking.istio.io/productpage created</span>
<span class="c">#    destinationrule.networking.istio.io/reviews created</span>
<span class="c">#    destinationrule.networking.istio.io/ratings created</span>
<span class="c">#    destinationrule.networking.istio.io/details created</span>

<span class="c"># DestinationRule í™•ì¸ dr(=destinationrules) : KIALI Services í™•ì¸ ì‹œ GW, VS, DR í™•ì¸</span>
<span class="nv">$ </span>kubectl get dr
<span class="c"># =&gt; NAME          HOST          AGE</span>
<span class="c">#    details       details       31s</span>
<span class="c">#    productpage   productpage   31s</span>
<span class="c">#    ratings       ratings       31s</span>
<span class="c">#    reviews       reviews       31s</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_21.png" alt="img.png" /></p>

<ul>
  <li><strong>virtual-service-all-v1.yaml</strong> : 4ê°œ ì„œë¹„ìŠ¤ ëª¨ë‘ v1 ì˜ ì„œë¸Œì…‹(subset) ì— ì „ì†¡í•˜ëŠ” ì •ì±… í…ŒìŠ¤íŠ¸</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># virtual-service-all-v1.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">productpage</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">productpage</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">productpage</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">reviews</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">reviews</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ratings</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ratings</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">ratings</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">details</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">details</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">details</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
<span class="nn">---</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># istio vs(virtualservices) í™•ì¸</span>
<span class="nv">$ </span>kubectl get vs
<span class="c"># =&gt; NAME       GATEWAYS               HOSTS   AGE</span>
<span class="c">#    bookinfo   [&amp;quot;bookinfo-gateway&amp;quot;]   [&amp;quot;*&amp;quot;]   3h30m</span>

<span class="c"># ëª¨ë“  ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì— ëŒ€í•´ v1 ì˜ ì„œë¸Œì…‹(subset) ì— ì „ì†¡ë˜ê²Œ virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-all-v1.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/productpage created</span>
<span class="c">#    virtualservice.networking.istio.io/reviews created</span>
<span class="c">#    virtualservice.networking.istio.io/ratings created</span>
<span class="c">#    virtualservice.networking.istio.io/details created</span>

<span class="c"># istio vs(virtualservices) í™•ì¸ &gt;&gt; KIALI ì—ì„œ reviews v2,v3 í–¥í•˜ëŠ” íŠ¸ë˜í”½ ê²½ë¡œê°€ ì‚¬ë¼ì§„ë‹¤!</span>
<span class="nv">$ </span>kubectl get virtualservices
<span class="c"># =&gt; NAME          GATEWAYS               HOSTS             AGE</span>
<span class="c">#    bookinfo      [&amp;quot;bookinfo-gateway&amp;quot;]   [&amp;quot;*&amp;quot;]             3h30m</span>
<span class="c">#    details                              [&amp;quot;details&amp;quot;]       10s</span>
<span class="c">#    productpage                          [&amp;quot;productpage&amp;quot;]   10s</span>
<span class="c">#    ratings                              [&amp;quot;ratings&amp;quot;]       10s</span>
<span class="c">#    reviews                              [&amp;quot;reviews&amp;quot;]       10s</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_22.png" alt="img.png" /></p>

<ul>
  <li>
    <p>ëª¨ë“  íŠ¸ë˜í”½ì´ v1ìœ¼ë¡œ í–¥í•˜ê²Œ ë˜ì–´ì„œ ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë„ v1ë§Œ ë‚˜ì˜¤ê²Œ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>virtual-service-reviews-test-v2.yaml</strong> : User Identity ê¸°ë°˜ ë¼ìš°íŒ…, end-user ì»¤ìŠ¤í…€ í—¤ë”ì— <strong>jason</strong> ë§¤ì¹­ ì‹œ <strong>reviews v2</strong> ë¡œ ì „ë‹¬</p>
    <ul>
      <li>Match ì¡°ê±´ì—ëŠ” ì™„ì „ ì¼ì¹˜(exact) , ì „ë°© ì¼ì¹˜(prefix) , ì •ê·œ í‘œí˜„(regex) - 3ê°€ì§€ íŒ¨í„´ì„ ì„ íƒí•  ìˆ˜ ìˆë‹¤</li>
    </ul>
  </li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># virtual-service-reviews-test-v2.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">reviews</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">reviews</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">headers</span><span class="pi">:</span>
        <span class="na">end-user</span><span class="pi">:</span>
          <span class="na">exact</span><span class="pi">:</span> <span class="s">jason</span>
    <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v2</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë“  ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì— ëŒ€í•´ v1 ì˜ ì„œë¸Œì…‹(subset) ì— ì „ì†¡ë˜ê²Œ virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-reviews-test-v2.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/reviews configured</span>

<span class="c"># jason ë¡œê·¸ì¸ ì‹œ ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>productpage <span class="nt">-f</span>
<span class="c"># =&gt; [productpage-v1-d5789fdfb-f8gdf productpage] DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): details:9080</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] send: b'GET /details/0 HTTP/1.1\r\nHost: details:9080\r\nuser-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15\r\nAccept-Encoding: gzip, deflate\r\nAccept: */*\r\nConnection: keep-alive\r\nx-request-id: 3aa3c711-d014-930f-8c2a-563c3dbbd8b5\r\n\r\n'</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] reply: 'HTTP/1.1 200 OK\r\n'</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: content-type: application/json</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: server: envoy</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: date: Sat, 19 Oct 2024 14:32:09 GMT</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: content-length: 178</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: x-envoy-upstream-service-time: 6</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] DEBUG:urllib3.connectionpool:http://details:9080 &amp;quot;GET /details/0 HTTP/1.1&amp;quot; 200 178</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): reviews:9080</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] send: b'GET /reviews/0 HTTP/1.1</span>
<span class="c">#    Host: reviews:9080</span>
<span class="c">#    user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15</span>
<span class="c">#    Accept-Encoding: gzip, deflate</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    Connection: keep-alive</span>
<span class="c">#    x-request-id: 3aa3c711-d014-930f-8c2a-563c3dbbd8b5\r\n\r\n'</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] reply: 'HTTP/1.1 200 OK\r\n'</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: x-powered-by: Servlet/3.1</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: content-type: application/json</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: date: Sat, 19 Oct 2024 14:32:09 GMT</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: content-language: en-US</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: content-length: 358</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: x-envoy-upstream-service-time: 1</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: server: envoy</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] DEBUG:urllib3.connectionpool:http://reviews:9080 &amp;quot;GET /reviews/0 HTTP/1.1&amp;quot; 200 358</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] INFO:werkzeug:::ffff:127.0.0.6 - - [19/Oct/2024 14:32:09] &amp;quot;GET /productpage HTTP/1.1&amp;quot; 200 -</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>ì›¹ë¸Œë¼ìš°ì €ì—ì„œ productpageë¡œ ì ‘ì† í›„ ìƒˆë¡œê³ ì¹¨ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>ë¡œê·¸ì¸ ì „ì—ëŠ” v1ìœ¼ë¡œ ì ‘ì† ë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_23.png" alt="img.png" /></li>
    </ul>
  </li>
  <li>ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ Sign in í´ë¦­ í›„ jasonìœ¼ë¡œ ë¡œê·¸ì¸ í›„ ìƒˆë¡œê³ ì¹¨ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>ë¡œê·¸ì¸ í›„ì—ëŠ” v2ë¡œ ì ‘ì† ë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_24.png" alt="img_1.png" /></li>
      <li>
        <p>í—¤ë”ì—ëŠ” end-user:jason ì´ ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë¡œê·¸ì¸ í›„ í—¤ë”í—¤ë”</span>
<span class="c"># =&gt; [productpage-v1-d5789fdfb-f8gdf productpage] send: b'GET /reviews/0 HTTP/1.1</span>
<span class="c">#    Host: reviews:9080</span>
<span class="c">#    user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15</span>
<span class="c">#    Accept-Encoding: gzip, deflate</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    Connection: keep-alive</span>
<span class="c">#    &lt;span style="color: red;"&gt;end-user: jason&lt;/span&gt;</span>
<span class="c">#    x-request-id: 03366677-7032-9291-a4b9-7009a6257394</span>
<span class="c">#    cookie: session=eyJ1c2VyIjoiamFzb24ifQ.ZxPUxA.3MJkXTFH8zJtg_YlXlvzq8xArpc'</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h5 id="fault-injection-ì‹¤ìŠµ">Fault Injection ì‹¤ìŠµ</h5>

<ul>
  <li><strong>virtual-service-ratings-test-delay.yaml</strong> : end-user ê°€ jason ëŠ” ratings v1 ì— 7ì´ˆ ì§€ì—° ë°œìƒ, ê·¸ì™¸ ì‚¬ìš©ìëŠ” ratings v1 ì •ìƒ ì—°ê²°</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># virtual-service-ratings-test-delay.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ratings</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ratings</span>
  <span class="na">http</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">headers</span><span class="pi">:</span>
            <span class="na">end-user</span><span class="pi">:</span>
              <span class="na">exact</span><span class="pi">:</span> <span class="s">jason</span>
      <span class="na">fault</span><span class="pi">:</span>
        <span class="na">delay</span><span class="pi">:</span>
          <span class="na">percentage</span><span class="pi">:</span>
            <span class="na">value</span><span class="pi">:</span> <span class="m">100.0</span>
          <span class="na">fixedDelay</span><span class="pi">:</span> <span class="s">7s</span>
      <span class="na">route</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
            <span class="na">host</span><span class="pi">:</span> <span class="s">ratings</span>
            <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
            <span class="na">host</span><span class="pi">:</span> <span class="s">ratings</span>
            <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-ratings-test-delay.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/ratings configured</span>

<span class="c"># ë¡œê·¸ í™•ì¸ : product ì…ì¥ì—ì„œ ì ‘ì† ì‚¬ìš©ì(clinet) ì—°ê²°ì„ ëŠì–´ë²„ë¦¼ 0 DC downstream_remote_disconnect</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>productpage <span class="nt">-f</span>
</code></pre></div></div>

<ul>
  <li>ì›¹ë¸Œë¼ìš°ì €ì—ì„œ jasonìœ¼ë¡œ ë¡œê·¸ì¸ëœ ìƒíƒœì—ì„œ ì ‘ì†ì‹œ 6~7ì´ˆ ì§€ì—°ì´ ë°œìƒí•˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_25.png" alt="img.png" /></p>

<ul>
  <li><strong>virtual-service-ratings-test-abort.yaml</strong> : end-user ê°€ jason ëŠ” ratings v1 ì— 500 ì—ëŸ¬ ë¦¬í„´, ê·¸ì™¸ ì‚¬ìš©ìëŠ” ratings v1 ì •ìƒ ì—°ê²°</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># virtual-service-ratings-test-abort.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ratings</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ratings</span>
  <span class="na">http</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">headers</span><span class="pi">:</span>
            <span class="na">end-user</span><span class="pi">:</span>
              <span class="na">exact</span><span class="pi">:</span> <span class="s">jason</span>
      <span class="na">fault</span><span class="pi">:</span>
        <span class="na">abort</span><span class="pi">:</span>
          <span class="na">percentage</span><span class="pi">:</span>
            <span class="na">value</span><span class="pi">:</span> <span class="m">100.0</span>
          <span class="na">httpStatus</span><span class="pi">:</span> <span class="m">500</span>
      <span class="na">route</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
            <span class="na">host</span><span class="pi">:</span> <span class="s">ratings</span>
            <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
            <span class="na">host</span><span class="pi">:</span> <span class="s">ratings</span>
            <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-ratings-test-abort.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/ratings configured</span>

<span class="c"># ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">version</span><span class="o">=</span>v2 <span class="nt">-f</span>
</code></pre></div></div>

<p>jasonìœ¼ë¡œ ë¡œê·¸ì¸ í–ˆì„ë•Œ Rating ì„œë¹„ìŠ¤ì— 500 ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_26.png" alt="img.png" /></p>

<p>ë˜í•œ kialiì—ì„œë„ ì–´ëŠ êµ¬ê°„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°, Flagsë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log-format-response-flags">ë§í¬</a><br />
(ì´ê²½ìš° FIëŠ” Fault Injectionì„ ì˜ë¯¸ìœ¼ë¡œ ì¼ë¶€ëŸ¬ ì˜¤ë¥˜ë¥¼ ì¼ìœ¼í‚¨ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)</p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_27.png" alt="img.png" /></p>

<h5 id="traffic-shifting-ì‹¤ìŠµ">Traffic Shifting ì‹¤ìŠµ</h5>

<ul>
  <li>
    <p>ì¹´ë‚˜ë¼ ë°°í¬ ì „ëµ ë“± í™œìš© - <a href="https://istio.io/latest/docs/tasks/traffic-management/traffic-shifting/">ë§í¬</a></p>
  </li>
  <li>
    <p><strong>virtual-service-reviews-50-v3.yaml</strong> : ê°€ì¤‘ì¹˜ (weight-based routing), reviews ì— v1(50%), v3(50%)</p>
  </li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">reviews</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">reviews</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">50</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v3</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">50</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-reviews-50-v3.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/reviews configured</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-m</span> 1 <span class="s2">"reviews-v</span><span class="se">\?</span><span class="s2">"</span> <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span>
<span class="c"># =&gt;      53                   reviews-v1-6584ddcf65-gnc9j</span>
<span class="c">#         47                   reviews-v3-6f5b775685-cw7tc</span>
</code></pre></div></div>

<p>ëŒ€ëµ 50%ì˜ í™•ë¥ ë¡œ v1ê³¼ v3ë¡œ ì ‘ì†ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li><strong>virtual-service-reviews-80-20.yaml</strong> : ê°€ì¤‘ì¹˜ (weight-based routing), reviews ì— v1(80%), v2(20%)</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">reviews</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">reviews</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">80</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v2</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">20</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-reviews-80-20.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/reviews configured</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-m</span> 1 <span class="s2">"reviews-v</span><span class="se">\?</span><span class="s2">"</span> <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span>
<span class="c"># =&gt;      79                   reviews-v1-6584ddcf65-gnc9j</span>
<span class="c">#         21                   reviews-v2-6f85cb9b7c-cfc68</span>
</code></pre></div></div>

<p>ëŒ€ëµ 80%ì˜ í™•ë¥ ë¡œ v1ê³¼ 20%ì˜ í™•ë¥ ë¡œ v2ë¡œ ì ‘ì†ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>kialiì—ì„œë„ ì–´ëŠ êµ¬ê°„ì—ì„œ ì–´ë– í•œ ë¹„ì¤‘ìœ¼ë¡œ íŠ¸ë˜í”½ì´ í˜ëŸ¬ê°€ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_28.png" alt="img.png" /></p>

<h4 id="security-ë³´ì•ˆ">Security (ë³´ì•ˆ)</h4>

<ul>
  <li>ìš”êµ¬ì‚¬í•­
    <ul>
      <li>MITM (Man-In-The-Middle) ê³µê²© ë°©ì§€ë¥¼ ìœ„í•´ ëª¨ë“  íŠ¸ë˜í”½ì€ mTLSë¡œ ì•”í˜¸í™” ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>ë˜í•œ ì ‘ê·¼ ì œì–´ ì •ì±…ì´ í•„ìš”í•˜ë©°, ê°ì‚¬ ë¡œê¹…ì„ í†µí•´ ë³´ì•ˆ ì´ìŠˆë¥¼ ì‹ë³„ì´ ê°€ëŠ¥ í•´ì•¼ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ëª©í‘œ
    <ul>
      <li>ê¸°ë³¸ ì…‹íŒ…ì„ ì•ˆì „í•˜ê²Œ í•˜ê¸° : ë³„ë„ì˜ ì…‹íŒ…ì´ ì—†ì–´ë„ ë³´ì•ˆì„ ìœ ì§€í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •</li>
      <li>ê¹Šì€ ë°©ì–´ : ê¸°ì¡´ì— ì¡´ì¬í•˜ëŠ” ë³´ì•ˆ ì‹œìŠ¤í…œê³¼ í†µí•©ë˜ì–´, ë‹¤ì¸µ ë°©ì–´ë¥¼ êµ¬ì„±</li>
      <li><strong>Zero-trust network</strong> : ë„¤íŠ¸ì›Œí¬ë¥¼ ì‹ ë¢°í•˜ì§€ ì•ŠìŒìœ¼ë¡œì¨ ë³´ì•ˆ ê°•í™” <a href="https://genians.co.kr/genians-nac/zt/">https://genians.co.kr/genians-nac/zt/</a></li>
    </ul>
  </li>
  <li>êµ¬ì„±ìš”ì†Œ
    <ul>
      <li>Certification Authority (CA) : ì¸ì¦ì„œ ë°œê¸‰, ê´€ë¦¬, ê°±ì‹ </li>
      <li>ë³´ì•ˆ ì •ì±… (ì¸ì¦ì •ì±…, ì¸ê°€ì •ì±… ë“±) ê´€ë ¨ ì„¤ì •ì„ ê° í”„ë¡ì‹œì— ì „ë‹¬í•˜ëŠ” API ì„œë²„</li>
      <li>ì‚¬ì´ë“œì¹´ì™€ í”„ë¡ì‹œë¥¼ ì •ì±… ê°•ì œ ì§€ì (Policy Enforcement Point-PEPs)ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°„ì˜ í†µì‹ ì„ ë³´í˜¸</li>
      <li>Envoy Proxy í™•ì¥ ê¸°ëŠ¥ì„ í†µí•´ telemetryì™€ ê°ì‚¬ ë¡œê¹… ìˆ˜ì§‘</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_29.svg" alt="20241019_kans_w7_29.svg" class="image-center" />
<em class="image-caption">istio ë³´ì•ˆ ì•„í‚¤í…ì³</em></p>

<ul>
  <li>TLSì™€ mTLS
    <ul>
      <li><strong>TLS (Transport Layer Security)</strong> : í†µì‹  ë³´ì•ˆì„ ìœ„í•œ í”„ë¡œí† ì½œë¡œ, ì¸í„°ë„· ìƒì—ì„œ ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•˜ëŠ” í‘œì¤€í™”ëœ ë°©ë²•ì…ë‹ˆë‹¤.
ê¸°ë³¸ì ìœ¼ë¡œ ì„œë²„ì˜ ì¸ì¦ì„œë§Œ í™•ì¸í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
      <li><strong>mTLS (mutual TLS)</strong> : ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë¡œ ì¸ì¦ì„ í•˜ê³  ì„œë¡œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Authentication (ì¸ì¦), Authorization (ì¸ê°€) (Auto mTLS)
    <ul>
      <li>IstioëŠ” ëª¨ë“  ì›Œí¬ë¡œë“œì— X.509 ì¸ì¦ì„œë¥¼ ë¶€ì—¬í•˜ê³ , ì„œë¡œ ì¸ì¦ì„ í†µí•´ í†µì‹ ì„ ë³´í˜¸í•©ë‹ˆë‹¤.</li>
      <li>Envoy proxyì™€ í•¨ê»˜ ì‹¤í–‰ë˜ëŠ” Istio agentëŠ” istiodì™€ í•¨ê»˜ ë™ì‘í•˜ë©´ì„œ ìë™ìœ¼ë¡œ ì¸ì¦ì„œë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤. 
 <img src="/assets/2024/kans-3th/w7/20241019_kans_w7_30.svg" alt="20241019_kans_w7_30.svg" class="image-center" />
        <ol>
          <li>istiodëŠ” CSR(ì¸ì¦ì„œ ì„œëª… ìš”ì²­)ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ gRPC ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
          <li>EnvoyëŠ” SDS(Secret Discovery Serice) APIë¥¼ í†µí•´ ì¸ì¦ì„œì™€ í‚¤ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.</li>
          <li>istio-agentëŠ” SDs ìš”ì²­ì„ ë°›ìœ¼ë©´ Private Keyì™€ CSRì„ ìƒì„±í•œ í›„ ìê²©ì¦ëª…
   (credential)ê³¼ í•¨ê»˜ CSR istiodì— ì „ì†¡í•˜ì—¬ ì„œëª…ì„ ìš”ì²­í•©ë‹ˆë‹¤.</li>
          <li>CAëŠ” CSRì— í¬í•¨ëœ ìê²©ì¦ëª…(credential) ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ê³  CSRì— ì„œëª…í•˜ì—¬ ì¸ì¦ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
          <li>istio-agentëŠ” istiodë¡œë¶€í„° ë°›ì€ ì¸ì¦ì„œ(certiftcate)ì™€ ê°œì¸í‚¤ private Key)ë¥¼ Envoy SDS
   APIë¥¼ í†µí•´ Envoyì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.</li>
          <li>ìœ„ì˜ CSR í”„ë¡œì„¸ìŠ¤ëŠ” ì¸ì¦ì„œ ë° í‚¤ ìˆœí™˜ì„ ìœ„í•´ ì£¼ê¸°ì ìœ¼ë¡œ ë°˜ë³µë©ë‹ˆë‹¤</li>
        </ol>
      </li>
    </ul>
  </li>
  <li>Authentication (ì¸ì¦) : 2ê°€ì§€ íƒ€ì… ì œê³µ
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_31.svg" alt="20241019_kans_w7_31.svg" />
    <ol>
      <li>Peer Authentication :
        <ul>
          <li>ì„œë¹„ìŠ¤ê°„ ì¸ì¦ì— ì‚¬ìš©ë˜ë©° Clientê°€ ì—°ê²°ì„ í™•ì¸í•˜ëŠ”ë° ì‚¬ìš©. ì„œë¹„ìŠ¤ ì½”ë“œ ë³€ê²½ì—†ì´ mTLS ì œê³µ</li>
        </ul>
      </li>
      <li>Request Authentication :
        <ul>
          <li>Requestì— ì²¨ë¶€ëœ ìê²©ì¦ëª…(Credential)ì„ í†µí•´ ìµœì¢… ì‚¬ìš©ì ì¸ì¦ì— ì‚¬ìš©</li>
          <li>istioëŠ” JWT (JSON Web Token)ì„ ì§€ì›í•˜ì—¬ ìµœì¢… ì‚¬ìš©ì ì¸ì¦ì„ ì œê³µ</li>
          <li>ì»¤ìŠ¤í…€ ì¸ì¦ ì œê³µìë¥¼ ë¹„ë¡¯í•˜ì—¬ OpenID Connect, Keycloak, Auth0 ë“± ë‹¤ì–‘í•œ ì¸ì¦ ë°©ì‹ì„ ì§€ì›</li>
        </ul>
      </li>
    </ol>
  </li>
  <li>Authorization (ì¸ê°€)
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_32.svg" alt="20241019_kans_w7_32.svg" />
    <ul>
      <li>istioëŠ” mesh ë‹¨ìœ„, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‹¨ìœ„, ì›Œí¬ë¡œë“œ ë‹¨ìœ„ë¡œ ì ‘ê·¼ì„ ì œì–´ í•  ìˆ˜ ìˆëŠ” ì¸ê°€ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ì´ì ì´ ìˆìŠµë‹ˆë‹¤.
        <ul>
          <li>ì›Œí¬ë¡œë“œì™€ ì›Œí¬ë¡œë“œê°„, ë˜ëŠ” ì‚¬ìš©ìì™€ ì›Œí¬ë¡œë“œê°„ ì¸ê°€ ì œê³µ</li>
          <li>ë‹¨ì¼í•œ AuthorizationPolicy CRDë¥¼ ì‚¬ìš©í•œ ë‹¨ìˆœí•œ API ì œê³µ</li>
          <li>ìœ ì—°í•œ ì •ì±… ì œê³µ : ì»¤ìŠ¤í…€ ì¡°ê±´ì„ ë“±ë¡í•  ìˆ˜ ìˆê³ , CUSTOM, DENY, ALLOW ì•¡ì…˜ ì§€ì›</li>
          <li>ê³ ì„±ëŠ¥ : Envoy Proxyë¥¼ í†µí•´ ì¸ê°€ ì •ì±…ì„ ì ìš©í•˜ë¯€ë¡œ ì„±ëŠ¥ ì €í•˜ê°€ ì—†ìŒ</li>
          <li>ë†’ì€ í˜¸í™˜ì„± : gRPC, HTTP, HTTPS ë“±ì„ ì§€ì›í•˜ë©°, ì¼ë°˜ì ì¸ TCP í”„ë¡œí† ì½œë„ ì§€ì›</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="authentication-auto-mtls-ì‹¤ìŠµ">Authentication (Auto mTLS) ì‹¤ìŠµ</h5>

<ul>
  <li>
    <p>ê¸°ì¡´ íŒŒë“œì— ë¡œê·¸ì—ì„œ ì¸ì¦ì„œ ë“± ë³´ì•ˆ ê´€ë ¨ ë‚´ìš© í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># CA Endpoint, CA(/var/run/secret/istio/root-cert,pem), citadelclient, SDS server ë“±ë“±</span>
  <span class="nv">$ </span>kubectl logs ratings-v1-7c9bd4b87f-s9gxs <span class="nt">-c</span> istio-proxy <span class="nt">-f</span>
  <span class="nv">$ </span>kubetail
  
  <span class="c"># ì¸ì¦ì •ì±… í™•ì¸</span>
  <span class="nv">$ </span>kubectl get peerauthentications.security.istio.io
  <span class="c"># =&gt; No resources found </span>
    
  <span class="c"># envoy ì— cert ì •ë³´ í™•ì¸ : istio-proxy ì— adminí˜ì´ì§€ ì ‘ì† or kaila ì—ì„œ envoy ì—ì„œ í™•ì¸    </span>
</code></pre></div>    </div>
  </li>
  <li>bookinfo â†’ kiali â†’ product ê³„ì† ì ‘ì†</li>
  <li>kiali ì—ì„œ Display(Security ì²´í¬) í›„ ìë¬¼ì‡  í´ë¦­í•˜ë©´ ì˜¤ë¥¸ìª½ ì°½ì—ì„œ ë³´ì•ˆì„¤ì •ì„ í™•ì´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. : mTLS Enabled, spiffe(Secure name)</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_33.png" alt="img.png" /></p>

<ul>
  <li>test ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± í›„ íŒŒë“œ ìƒì„±(sidecar ë¯¸ì ìš©) í›„ ratings ì ‘ì†</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±</span>
<span class="nv">$ </span>kubectl create ns <span class="nb">test</span>
<span class="c"># =&gt; namespace/test created</span>

<span class="c"># íŒŒë“œ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: netpod
  namespace: test
spec:
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF

</span><span class="c"># í™•ì¸ : sidecar ë¯¸ì ìš©</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> <span class="nb">test</span>
<span class="c"># =&gt; NAME     READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    netpod   1/1     Running   0          19s</span>

<span class="c"># ratings ì„œë¹„ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc ratings
<span class="c"># =&gt; NAME      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    ratings   ClusterIP   10.10.200.163   &amp;lt;none&amp;gt;        9080/TCP   8h</span>

<span class="c"># ratings ì ‘ì† ì‹œë„ : ì„±ê³µ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> <span class="nb">test </span>netpod <span class="nt">--</span> curl ratings.default:9080/health <span class="p">;</span><span class="nb">echo</span>
<span class="nv">$ </span><span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"Ratings is healthy"</span><span class="o">}</span>

<span class="c"># ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>ratings <span class="nt">-f</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_34.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">NS(default, test ì²´í¬) netpod ì—ì„œ ì ‘ì† ì‹œ unknown ìœ¼ë¡œ í‘œê¸°ë˜ë©°, ì ‘ê·¼ ì„±ê³µ(ë…¹ìƒ‰) í™•ì¸</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Peer authentication ì„¤ì • ë³€ê²½ : PERMISSIVE(mTLS ì‚¬ìš©/ë¯¸ì‚¬ìš© ëª¨ë‘ í—ˆìš©) â†’ STRICT(ë°˜ë“œì‹œ mTLS ì‚¬ìš©, ë¯¸ì‚¬ìš© ì‹œ ê±°ë¶€)</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default-strict
spec:
  mtls:
    mode: STRICT
</span><span class="no">EOF

</span><span class="c"># ratings ì ‘ì† ì‹œë„ : ì‹¤íŒ¨!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> <span class="nb">test </span>netpod <span class="nt">--</span> curl ratings.default:9080/health <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; curl: (56) Recv failure: Connection reset by peer</span>
<span class="c">#    command terminated with exit code 56</span>

<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>ratings <span class="nt">-f</span>
<span class="c"># =&gt; [ratings-v1-7c9bd4b87f-s9gxs istio-proxy] [2024-10-01T17:21:12.708Z] &amp;quot;- - -&amp;quot; 0 NR filter_chain_not_found - &amp;quot;-&amp;quot; 0 0 0 - &amp;quot;-&amp;quot; &amp;quot;-&amp;quot; &amp;quot;-&amp;quot; &amp;quot;-&amp;quot; &amp;quot;-&amp;quot; - - 172.16.3.17:9080 172.16.1.17:34938 - -</span>
</code></pre></div></div>

<ul>
  <li>ì‹¤ìŠµ ìì› ì‚­ì œ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete PeerAuthentication default-strict
<span class="c"># =&gt; peerauthentication.security.istio.io &amp;quot;default-strict&amp;quot; deleted</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> <span class="nb">test </span>netpod <span class="nt">--</span> curl ratings.default:9080/health <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; {&amp;quot;status&amp;quot;:&amp;quot;Ratings is healthy&amp;quot;}</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì¸ì¦ì •ì±… ê°•ì œ ì •ì±… ì‚­ì œì‹œ ë‹¤ì‹œ í†µì‹ ì´ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl delete pod <span class="nt">-n</span> <span class="nb">test </span>netpod
<span class="nv">$ </span>kubectl delete ns <span class="nb">test</span>
</code></pre></div></div>

<h3 id="istio-í†µì‹ -íë¦„">Istio í†µì‹  íë¦„</h3>

<p>istio ì‚¬ìš©ì‹œ íŠ¸ë˜í”½ì€ í˜¸ìŠ¤íŠ¸ì˜ tcp/ip ìŠ¤íƒê³¼ iptables, íŒŒë“œë‚´ì˜ iptablesì™€ envoyë¥¼ ê²½ìœ í•˜ê²Œ ë©ë‹ˆë‹¤.
istioëŠ” ê°•ë ¥í•˜ê³  ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì„ ì œê³µí•˜ì§€ë§Œ ë¹„ìš©(ì§€ì—°ì¶”ê°€, í”„ë¡œì„¸ì„œ ì‚¬ìš©ëŸ‰ ì¶”ê°€, ë³µì¡í•œ êµ¬ì¡°)ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_35.png" alt="img.png" class="image-center w-80" /></p>

<p>ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸(PC ë“±)ì—ì„œ íŒŒë“œë¡œ ì ‘ì†ë˜ëŠ” ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_36.png" alt="img_1.png" /></p>

<p>ìœ„ì˜ ê·¸ë¦¼ì—ì„œ ì²˜ëŸ¼ iptablesë¥¼ ì—¬ëŸ¬ë²ˆ ê±°ì¹˜ê³ , DNATë“±ì„ í†µí•´ í¬íŠ¸ë²ˆí˜¸ë“±ì´ 80 (http) =&gt; 15006 (istio-proxy) ë¡œ ë³€ê²½ë˜ëŠ” ë“±ì˜ ì‘ì—…ì„ ì—¬ëŸ¬ë²ˆ ê±°ì¹©ë‹ˆë‹¤.
ë˜í•œ íŒŒë“œì™€ í˜¸ìŠ¤íŠ¸ê°„ í†µì‹  envoyë¥¼ ìš”ì²­ì„ ë°›ì„ë•Œì™€ ì‘ë‹µí• ë•Œ ëª¨ë‘ ê±°ì³ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>íŒŒë“œ ë‚´ Iptables ì ìš© íë¦„</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_37.png" alt="img.png" class="image-center" />
<em class="image-caption">ì¶œì²˜ : <a href="https://jimmysong.io/en/blog/sidecar-injection-iptables-and-traffic-routing/#understand-outbound-handler">Jimmy song</a> ë¸”ë¡œê·¸</em></p>

<p>ë‹¤ìŒ ë¸”ë¡œê·¸ì—ì„œ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<a href="https://jimmysong.io/en/blog/sidecar-injection-iptables-and-traffic-routing/#understand-outbound-handler">Understanding the Sidecar Injection, Traffic Intercepting &amp; Routing Process in Istio</a></p>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>1ì£¼ì°¨ ì»¨í…Œì´ë„ˆ ê²©ë¦¬ ì´í›„ì— ë˜ ë‹¤ì‹œ ë‡Œì •ì§€ê°€ ì°¾ì•„ì˜¨ ì£¼ì°¨ì˜€ìŠµë‹ˆë‹¤.
ì´ë²ˆì£¼ì— í•™ìŠµí•œê²ƒë„ ë§ì€ë°, ì´ê²ƒì´ ì¼ë¶€ë§Œ ì‚´í´ë³¸ê²ƒì´ë¼ë‹ˆ ë†€ëìŠµë‹ˆë‹¤.
ì •ë§ ë§Œë“  ë¶„ë“¤ë„, ì“°ëŠ” ë¶„ë“¤ë„, ìŠ¤í„°ë””ë¥¼ ì§„í–‰í•´ì£¼ì‹œëŠ” ë¶„ë“¤ë„ ëŒ€ë‹¨í•©ë‹ˆë‹¤. :thumbsup:</p>

<p>ì¸ì¦ì´ë‚˜ ì¸ê°€ ë“± gateway apiì—ì„œ ì•„ì‰¬ì› ë˜ ë¶€ë¶„ë“¤ì´ ë‚˜ì™€ì„œ ì¢‹ì•˜ìŠµë‹ˆë‹¤.
ì°¾ë˜ ê¸°ëŠ¥ì¸ë° ë§ˆì¹¨ ì´ë²ˆì£¼ì— ë‹¤ë£¨ê²Œ ë˜ì–´ì„œ ì¢‹ì•˜ìŠµë‹ˆë‹¤. 
Kialië¥¼ í†µí•œ íŠ¸ë˜í”½ ì‹œê°í™”ë„ ì •ë§ ìœ ìš©í•˜ê²Œ ì“°ì¼ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ë³µì¡í•˜ê¸´ í•˜ì§€ë§Œ ì¢‹ì€ ê¸°ëŠ¥ë“¤ì´ ë§ì•˜ìŠµë‹ˆë‹¤.</p>

<p>ì‹œê°„ì´ ëª¨ìë¼ì„œ ë¯¸ì²˜ ì‹¤ìŠµí•˜ì§€ ëª»í•œ ë¶€ë¶„ë“¤ê³¼ Ambient Meshë„ ë°”ìœì¼ì´ ì§€ë‚˜ê°€ë©´ ë‹¤ì‹œ ì‚´í´ë´ì•¼ê² ìŠµë‹ˆë‹¤.
ìŠ¤í„°ë””ë¥¼ ì¤€ë¹„í•´ì£¼ì‹  ê°€ì‹œë‹¤ë‹˜ê³¼ ì°¸ì—¬í•˜ì‹  ë¶„ë“¤ ê°ì‚¬í•©ë‹ˆë‹¤. :pray:</p>]]></content><author><name></name></author><category term="kans" /><category term="kubernetes," /><category term="network," /><category term="linux" /><summary type="html"><![CDATA[ì´ë²ˆì£¼ì—ëŠ” Service Meshì™€ ëŒ€í‘œì ì¸ ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ì¸ Istioì— ëŒ€í•´ ì•Œì•„ ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[KANS 3ê¸°] Ingress &amp;amp; Gateway API</title><link href="https://sweetlittlebird.github.io/posts/2024-10-13-KANS-Study-Week6/" rel="alternate" type="text/html" title="[KANS 3ê¸°] Ingress &amp;amp; Gateway API" /><published>2024-10-13T01:00:18+09:00</published><updated>2024-10-13T01:00:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/KANS%20Study%20-%20Week6</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2024-10-13-KANS-Study-Week6/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆì£¼ì—ëŠ” ingressì™€ gateway api ì—ëŒ€í•´ ì•Œì•„ ë³´ê² ìŠµë‹ˆë‹¤.
KANS 3ê¸° 6ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="ingress">Ingress</h2>

<h3 id="ingressë€">Ingressë€?</h3>

<ul>
  <li>IngressëŠ” í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ë¡œ HTTP ë° HTTPS íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…í•˜ëŠ” Web Proxy ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
  <li>ì§€ë‚œì£¼ì— ìŠ¤í„°ë””í–ˆë˜ LoadBalancerì™€ ë¹„ìŠ·í•œ ì—­í• ì„ ìˆ˜í–‰í•˜ì§€ë§Œ, LoadBalancerëŠ” Layer 4ì—ì„œ ë™ì‘í•˜ëŠ” ë°˜ë©´ IngressëŠ” Layer 7ì—ì„œ ë™ì‘í•œë‹¤ëŠ” ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤.</li>
  <li>IngressëŠ” HTTPì™€ HTTPSë¥¼ ì´í•´í•˜ê¸° ë•Œë¬¸ì— í˜¸ìŠ¤íŠ¸ëª…, ê²½ë¡œ ë“±ì— ë”°ë¼ íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…í•  ìˆ˜ë„ ìˆê³ , SSL Offloading ë“±ì˜ ê¸°ëŠ¥ë„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>ì´ë ‡ê²Œ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì´ ìˆì§€ë§Œ <strong>IngressëŠ” ë™ê²°ì²˜ë¦¬</strong> ë˜ì—ˆìœ¼ë©°, <strong>ì‹ ê·œ ê¸°ëŠ¥ë“¤ì€ Gateway APIë¼ëŠ” ë‹¤ë¥¸ APIì— ì¶”ê°€ë˜ê³  ìˆê³ </strong>, í–¥í›„ì—ëŠ” Ingress ëŒ€ì‹  Gateway APIë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_1.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>íŠ¹ì´í•œ ì ì€ Ingress ë¥¼ í†µí•œ íŠ¸ë˜í”½ì€ ì„œë¹„ìŠ¤ë¥¼ í†µí•˜ì§€ ì•Šê³ , ì„œë¹„ìŠ¤ë¥¼ í†µí•´ì„œ íŒŒë“œì˜ IPë¥¼ í™•ì¸í•˜ê³ , ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ ì„œë¹„ìŠ¤ë¥¼ ê±°ì¹˜ì§€ ì•Šê³  íŒŒë“œì™€ ì§ì ‘ í†µì‹ í•©ë‹ˆë‹¤.</li>
</ul>

<h3 id="ingress-controllerì˜-ì¢…ë¥˜">Ingress Controllerì˜ ì¢…ë¥˜</h3>

<ul>
  <li>IngressëŠ” Kubernetesì— ë‚´ì¥ëœ ê¸°ëŠ¥ì´ ì•„ë‹ˆì–´ì„œ ë³„ë„ì˜ Ingress Controllerë¥¼ ì„¤ì¹˜í•´ì•¼ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
ë§ì´ ì‚¬ìš©ë˜ëŠ” Ingress ControllerëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>êµ¬ë¶„</th>
      <th>íŠ¹ì§•</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Pomerium</td>
      <td>ë³´ì•ˆì— íŠ¹í™” ëœ Ingressë¡œ Identity-Aware ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©° Zero Trust ëª¨ë¸ì„ ì§€ì›í•©ë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td>NGINX Ingress Controller</td>
      <td>ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì•ˆì •ì ìœ¼ë¡œ, ë¼ìš°íŒ…ì´ ìœ ì—°í•˜ê³ , Lua ìŠ¤í¬ë¦½íŠ¸ ë“±ìœ¼ë¡œ ê¸°ëŠ¥í™•ì¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td>Traefik</td>
      <td>Auto-discoveryë¥¼ ì œê³µí•˜ê³ , ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ë˜ë©°, ê´€ë¦¬ ëŒ€ì‹œë³´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤. ë™ì ìœ¼ë¡œ ìš´ì˜í•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td>HAProxy Ingress</td>
      <td>ê³ ì„±ëŠ¥ì´ë©°, ë‹¤ì–‘í•œ ê³ ê¸‰ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td>Envoy</td>
      <td>í™•ì¥ì„±ì´ ìˆìœ¼ë©° ì¬ì‹œë„, ì„œí‚· ë¸Œë ˆì´ì»¤, ë ˆì´íŠ¸ ì œí•œ ë“± ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td>Istio Ingress Gateway</td>
      <td>íŠ¸ë˜í”½ ê´€ë¦¬ì— ê°•ì ì´ ìˆìœ¼ë©°, Istio ì„œë¹„ìŠ¤ ë©”ì‹œì™€ ì—°ë™í•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td>Contour</td>
      <td>HTTP/2ì™€ gRPCë¥¼ ì§€ì›í•˜ëŠ” ê²½ëŸ‰ì˜ ê³ ì„±ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td>Kong Ingress Controller</td>
      <td>Kongì€ API Gatewayë¡œ ë„ë¦¬ ì•Œë ¤ì ¸ìˆì§€ë§Œ Ingress Controller ê¸°ëŠ¥ë„ ì œê³µí•©ë‹ˆë‹¤. NGINX Ingress Controllerì˜ ê¸°ëŠ¥ì— ì¶”ê°€ì ì¸ ê¸°ëŠ¥ì„ ì œê³µí•˜ì§€ë§Œ í•™ìŠµ ê³¡ì„ ì´ ë†’ì€ í¸ì…ë‹ˆë‹¤.</td>
    </tr>
  </tbody>
</table>

<p>ì´ì™¸ì—ë„ ë‹¤ì–‘í•œ Ingress Controllerê°€ ì¡´ì¬í•˜ë©° ë‹¤ìŒì˜ ë§í¬ì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://docs.google.com/spreadsheets/d/191WWNpjJ2za6-nbG4ZoUMXMpUK8KlCIosvQB0f-oq3k/">Kubernetes Ingress Controllers ë¹„êµ</a></p>

<h3 id="ì‹¤ìŠµ-í™˜ê²½-ì¤€ë¹„">ì‹¤ìŠµ í™˜ê²½ ì¤€ë¹„</h3>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì—ëŠ” k3së¼ëŠ” ê²½ëŸ‰ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤. k3sëŠ” Rancherì—ì„œ ê°œë°œí•œ ê²½ëŸ‰ Kubernetes í´ëŸ¬ìŠ¤í„°ë¡œ, ì‰½ê²Œ ì„¤ì¹˜ê°€ ê°€ëŠ¥í•˜ê³ , 
ì „ì²´ê°€ 100MBë³´ë‹¤ ì ì„ ì •ë„ë¡œ ì ì€ ìì›ìœ¼ë¡œë„ Kubernetesë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>í•˜ì§€ë§Œ K8Sì™€ëŠ” ê¸°ëŠ¥ ì°¨ì´ê°€ ìˆê¸° ë•Œë¬¸ì—, ì´ëŸ¬í•œ ë¶€ë¶„ì„ ê°ì•ˆí•˜ê³  ì‚¬ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤.</li>
</ul>

<h4 id="k3s-íŠ¹ì§•">k3s íŠ¹ì§•</h4>

<ul>
  <li>k3sì˜ íŠ¹ì§•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤
    <ul>
      <li>ë‹¨ì¼ ë°”ì´ë„ˆë¦¬ ë˜ëŠ” ìµœì†Œ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¡œ ë°°í¬ë©ë‹ˆë‹¤.</li>
      <li>ê¸°ë³¸ ì €ì¥ì†Œ ë°±ì—”ë“œë¡œ sqlite3ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ê²½ëŸ‰ ë°ì´í„° ì €ì¥ì†Œê°€ ì‚¬ìš©ë©ë‹ˆë‹¤. etcd, MySQL ë° Postgresë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>TLS ë° ì˜µì…˜ì˜ ë³µì¡ì„±ì„ ì²˜ë¦¬í•˜ëŠ” ëŸ°ì²˜ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ê²½ëŸ‰ í™˜ê²½ì— ì í•©í•œ í•©ë¦¬ì ì¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³´ì•ˆì— ì‹ ê²½ì„ ì¼ìŠµë‹ˆë‹¤.</li>
      <li>ëª¨ë“  Kubernetes ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ êµ¬ì„± ìš”ì†Œì˜ ì‘ë™ì´ ë‹¨ì¼ ë°”ì´ë„ˆë¦¬ ë° í”„ë¡œì„¸ìŠ¤ì— ìº¡ìŠí™”ë˜ì–´ ìˆê³ , k3sê°€ ì¸ì¦ì„œ ë°°í¬ì™€ ê°™ì€ ë³µì¡í•œ í´ëŸ¬ìŠ¤í„° ì‘ì—…ì„ ìë™í™”í•©ë‹ˆë‹¤.</li>
      <li>ì™¸ë¶€ ì¢…ì†ì„±ì´ ìµœì†Œí™”ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”í•œ ê²ƒì€ ìµœì‹  ì»¤ë„ê³¼ cgroup ë§ˆìš´íŠ¸ë¿ì…ë‹ˆë‹¤.</li>
      <li>ì†ì‰¬ìš´ í´ëŸ¬ìŠ¤í„° ìƒì„±ì„ ìœ„í•´ í•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ê¸°ë³¸ ì œê³µí•©ë‹ˆë‹¤:
        <ul>
          <li>containerd / cri-dockerd ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ (CRI)</li>
          <li>Flannel ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ (CNI)</li>
          <li>CoreDNS í´ëŸ¬ìŠ¤í„° DNS</li>
          <li>Traefik Ingress ì»¨íŠ¸ë¡¤ëŸ¬</li>
          <li>ServiceLB ë¡œë“œ ë°¸ëŸ°ì„œ ì»¨íŠ¸ë¡¤ëŸ¬</li>
          <li>Kube-router ë„¤íŠ¸ì›Œí¬ ì •ì±… ì»¨íŠ¸ë¡¤ëŸ¬</li>
          <li>Local-path-provisioner ì˜êµ¬ ë³¼ë¥¨ ì»¨íŠ¸ë¡¤ëŸ¬</li>
          <li>Spegel ë¶„ì‚° ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¯¸ëŸ¬</li>
          <li>í˜¸ìŠ¤íŠ¸ ìœ í‹¸ë¦¬í‹° (iptables, socat ë“±)</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="k3sì˜-ì•„í‚¤í…ì³">k3sì˜ ì•„í‚¤í…ì³</h4>

<ul>
  <li>k3sëŠ” ì„œë²„ (Control Plane)ì™€ ì—ì´ì „íŠ¸ (Worker Node)ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>ì„œë²„ ë…¸ë“œëŠ” Kubernetesì˜ <code class="language-plaintext highlighter-rouge">k3s server</code> ëª…ë ¹ìœ¼ë¡œ ì‹¤í–‰ë˜ë©° ëª¨ë“  ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ êµ¬ì„± ìš”ì†Œì™€ ë°ì´í„° ì €ì¥ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‹¤í–‰í•˜ë©° k3sê°€ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
      <li>ì—ì´ì „íŠ¸ ë…¸ë“œëŠ” <code class="language-plaintext highlighter-rouge">k3s agent</code> ëª…ë ¹ìœ¼ë¡œ ì‹¤í–‰ë˜ë©° ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ìš”ì†Œë“± ì—†ì´ ì›Œì»¤ ë…¸ë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤.</li>
      <li>ëª¨ë“  ì„œë²„ì™€ ì—ì´ì „íŠ¸ëŠ” kublet, ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„, CNI ë“±ì„ í¬í•¨í•œ ëª¨ë“  Kubernetes êµ¬ì„± ìš”ì†Œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.</li>
      <li>ë” ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒ ë§í¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”. <a href="https://docs.k3s.io/advanced#running-agentless-servers-experimental">ë§í¬</a>
<img src="/assets/2024/kans-3th/w6/20241012_kans_w6_2.svg" alt="20241012_kans_w6_2.svg" /></li>
    </ul>
  </li>
  <li>ë‹¨ì¼ ì„œë²„ êµ¬ì„± : 1ëŒ€ K3S ì„œë²„(ê²½ëŸ‰ DB = SQLite), í•„ìš”í•œ ë§Œí¼ì˜ K3S Agents (Worker Node) êµ¬ì„±
<img src="/assets/2024/kans-3th/w6/20241012_kans_w6_3.png" alt="img.png" /></li>
  <li>ê³ ê°€ìš©ì„± êµ¬ì„± : Embedded DB (etcd ë“±), ì™¸ë¶€ DB (MySQL, PostgreSQL ë“±) ì‚¬ìš© ê°€ëŠ¥
<img src="/assets/2024/kans-3th/w6/20241012_kans_w6_4.png" alt="img_1.png" /></li>
</ul>

<h4 id="k3s-ì„¤ì¹˜">k3s ì„¤ì¹˜</h4>

<ul>
  <li>k3sëŠ” ê¸°ë³¸ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">traefik</code>ì„ Ingress Controllerë¡œ ì‚¬ìš©í•˜ëŠ”ë° ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” nginx ingress controllerë¥¼ ì‚¬ìš©í•  ê²ƒì´ê¸° ë•Œë¬¸ì— <code class="language-plaintext highlighter-rouge">traefik</code>ì„ ì„¤ì¹˜í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤.</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">INSTALL_K3S_EXEC=" --disable=traefik"</code> ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ traefikì„ ì„¤ì¹˜í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install k3s-server</span>
<span class="nv">$ </span>curl <span class="nt">-sfL</span> https://get.k3s.io | <span class="nv">INSTALL_K3S_EXEC</span><span class="o">=</span><span class="s2">" --disable=traefik"</span>  sh <span class="nt">-s</span> - server <span class="nt">--token</span> <span class="o">[[</span>ì¸ì¦í† í°]] <span class="nt">--cluster-cidr</span> <span class="s2">"172.16.0.0/16"</span> <span class="nt">--service-cidr</span> <span class="s2">"10.10.200.0/24"</span> <span class="nt">--write-kubeconfig-mode</span> 644 
  
<span class="c"># Install k3s-agent</span>
<span class="nv">$ </span>curl <span class="nt">-sfL</span> https://get.k3s.io | <span class="nv">K3S_URL</span><span class="o">=</span>https://192.168.10.10:6443 <span class="nv">K3S_TOKEN</span><span class="o">=[[</span>ì¸ì¦í† í°]]  sh <span class="nt">-s</span> -
</code></pre></div>    </div>
  </li>
  <li>k3s ì„¤ì¹˜ í›„, k3ì˜ ì„¤ì •ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë…¸ë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME     STATUS   ROLES                  AGE     VERSION        INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION       CONTAINER-RUNTIME</span>
<span class="c">#    k3s-m    Ready    control-plane,master   30m     v1.30.5+k3s1   10.0.2.15     &amp;lt;none&amp;gt;        Ubuntu 22.04.5 LTS   5.15.0-119-generic   containerd://1.7.21-k3s2</span>
<span class="c">#    k3s-w1   Ready    &amp;lt;none&amp;gt;                 4m24s   v1.30.5+k3s1   10.0.2.15     &amp;lt;none&amp;gt;        Ubuntu 22.04.5 LTS   5.15.0-119-generic   containerd://1.7.21-k3s2</span>
<span class="c">#    k3s-w2   Ready    &amp;lt;none&amp;gt;                 26m     v1.30.5+k3s1   10.0.2.15     &amp;lt;none&amp;gt;        Ubuntu 22.04.5 LTS   5.15.0-119-generic   containerd://1.7.21-k3s2</span>
<span class="c">#    k3s-w3   Ready    &amp;lt;none&amp;gt;                 24m     v1.30.5+k3s1   10.0.2.15     &amp;lt;none&amp;gt;        Ubuntu 22.04.5 LTS   5.15.0-119-generic   containerd://1.7.21-k3s2</span>

<span class="nv">$ </span>kubectl describe node k3s-m | <span class="nb">grep </span>Taint  <span class="c"># Taints ì—†ìŒ</span>
<span class="c"># =&gt; Taints:             &amp;lt;none&amp;gt;</span>
<span class="nv">$ </span>kubectl describe node k3s-w1 | <span class="nb">grep </span>Taint  <span class="c"># Taints ì—†ìŒ</span>
<span class="c"># =&gt; Taints:             &amp;lt;none&amp;gt;</span>

<span class="c"># íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME                                      READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    coredns-7b98449c4-8l64d                   1/1     Running   0          31m</span>
<span class="c">#    local-path-provisioner-6795b5f9d8-b5gt6   1/1     Running   0          31m</span>
<span class="c">#    metrics-server-cdcc87586-d87gv            1/1     Running   0          31m</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl top node
<span class="c"># =&gt; NAME     CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span>
<span class="c">#    k3s-m    147m         3%     1128Mi          28%</span>
<span class="c">#    k3s-w1   147m         3%     1128Mi          57%</span>
<span class="c">#    k3s-w2   147m         3%     1128Mi          57%</span>
<span class="c">#    k3s-w3   147m         3%     1128Mi          57%</span>
<span class="nv">$ </span>kubectl top pod <span class="nt">-A</span> <span class="nt">--sort-by</span><span class="o">=</span><span class="s1">'cpu'</span>
<span class="c"># =&gt; NAMESPACE     NAME                                      CPU(cores)   MEMORY(bytes)</span>
<span class="c">#    kube-system   metrics-server-cdcc87586-d87gv            15m          19Mi</span>
<span class="c">#    kube-system   coredns-7b98449c4-8l64d                   4m           13Mi</span>
<span class="c">#    kube-system   local-path-provisioner-6795b5f9d8-b5gt6   1m           6Mi</span>
<span class="nv">$ </span>kubectl top pod <span class="nt">-A</span> <span class="nt">--sort-by</span><span class="o">=</span><span class="s1">'memory'</span>
<span class="nv">$ </span>kubectl get storageclass
<span class="c"># =&gt; NAME                   PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span>
<span class="c">#    local-path (default)   rancher.io/local-path   Delete          WaitForFirstConsumer   false                  32m</span>

<span class="c"># config ì •ë³´(ìœ„ì¹˜) í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-v</span><span class="o">=</span>6
<span class="c"># =&gt; I1012 05:55:56.507623    6817 loader.go:395] Config loaded from file:  /etc/rancher/k3s/k3s.yaml</span>
<span class="c">#    I1012 05:55:56.518338    6817 round_trippers.go:553] GET https://127.0.0.1:6443/api/v1/namespaces/default/pods?limit=500 200 OK in 5 milliseconds</span>
<span class="c">#    No resources found in default namespace.</span>

<span class="nv">$ </span><span class="nb">cat</span> /etc/rancher/k3s/k3s.yaml
<span class="c"># =&gt; apiVersion: v1</span>
<span class="c">#    clusters:</span>
<span class="c">#    - cluster:</span>
<span class="c">#        certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJlRENDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUzTWpnM01UQTJNREF3SGhjTk1qUXhNREV5TURVeU16SXdXaGNOTXpReE1ERXdNRFV5TXpJdwpXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUzTWpnM01UQTJNREF3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFReEdLOFFEcHMvNmNHdE45RWRCYmZJRmg2UjBpQlFLYUhHYWhVQXVMdjUKWHhpd1JjTVdia1FZNmxBdWM1RC9zWWYrTmhZYUFjcmNzMk01LzAyTkQ5bERvMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVXJzL1ZVODFCZEJnS3N2YmJDRmhjCkJ5aStxUTB3Q2dZSUtvWkl6ajBFQXdJRFNRQXdSZ0loQUxwWXpzZkVMdjZScG56OGdqcDZXYkZuUFk2S3FrQ2gKTWYwRWZvMnRzM2d5QWlFQXhkaDM4akJCMWJrTWlwWDNSMTFyTnBtZmc2S2huZzliNUJDTUs0M3UyTjA9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span>
<span class="c">#        server: https://127.0.0.1:6443</span>
<span class="c">#      name: default</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="nb">export</span> | <span class="nb">grep </span>KUBECONFIG
<span class="c"># =&gt; (ê³µë°±)</span>

<span class="c"># ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸ : flannel CNI(vxlan mode), podCIDR</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    4: flannel.1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1450 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether 02:21:77:da:a3:91 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 172.16.0.0/32 scope global flannel.1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    5: cni0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1450 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether ca:30:a0:c8:5c:cd brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 172.16.0.1/24 brd 172.16.0.255 scope global cni0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    6: veth41d9e3b2@if2: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1450 qdisc noqueue master cni0 state UP group default</span>
<span class="c">#        link/ether fa:47:5c:4a:8d:af brd ff:ff:ff:ff:ff:ff link-netns cni-9c26655e-b22f-97a1-f97c-db88daccc77f</span>
<span class="c">#    7: veth5c3de18a@if2: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1450 qdisc noqueue master cni0 state UP group default</span>
<span class="c">#        link/ether 6a:5e:39:72:4f:4c brd ff:ff:ff:ff:ff:ff link-netns cni-cff25bf8-d23b-790a-91d0-ed5c4ee526d5</span>
<span class="c">#    8: vethfaeebb1c@if2: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1450 qdisc noqueue master cni0 state UP group default</span>
<span class="c">#        link/ether c6:f5:31:a1:56:21 brd ff:ff:ff:ff:ff:ff link-netns cni-06a3672f-70dc-7445-48c9-8cf8c26e7fb3</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev enp0s3 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    ...</span>
<span class="c">#    172.16.0.0/24 dev cni0 proto kernel scope link src 172.16.0.1</span>
<span class="c">#    172.16.1.0/24 via 172.16.1.0 dev flannel.1 onlink</span>
<span class="c">#    172.16.2.0/24 via 172.16.2.0 dev flannel.1 onlink</span>
<span class="c">#    172.16.3.0/24 via 172.16.3.0 dev flannel.1 onlink</span>
<span class="c">#    192.168.10.0/24 dev enp0s8 proto kernel scope link src 192.168.10.10</span>
<span class="nv">$ </span><span class="nb">cat</span> /run/flannel/subnet.env
<span class="c"># =&gt; FLANNEL_NETWORK=172.16.0.0/16</span>
<span class="c">#    FLANNEL_SUBNET=172.16.0.1/24</span>
<span class="c">#    FLANNEL_MTU=1450</span>
<span class="c">#    FLANNEL_IPMASQ=true</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].spec.podCIDR}'</span> <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; 172.16.0.0/24 172.16.3.0/24 172.16.1.0/24 172.16.2.0/24</span>
<span class="nv">$ </span>kubectl describe node | <span class="nb">grep</span> <span class="nt">-A3</span> Annotations
<span class="c"># =&gt; Annotations:        alpha.kubernetes.io/provided-node-ip: 10.0.2.15</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-data: {&amp;quot;VNI&amp;quot;:1,&amp;quot;VtepMAC&amp;quot;:&amp;quot;02:21:77:da:a3:91&amp;quot;}</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-type: vxlan</span>
<span class="c">#                        flannel.alpha.coreos.com/kube-subnet-manager: true</span>
<span class="c">#    --</span>
<span class="c">#    Annotations:        alpha.kubernetes.io/provided-node-ip: 10.0.2.15</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-data: {&amp;quot;VNI&amp;quot;:1,&amp;quot;VtepMAC&amp;quot;:&amp;quot;72:95:9e:3d:c6:35&amp;quot;}</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-type: vxlan</span>
<span class="c">#                        flannel.alpha.coreos.com/kube-subnet-manager: true</span>
<span class="c">#    --</span>
<span class="c">#    Annotations:        alpha.kubernetes.io/provided-node-ip: 10.0.2.15</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-data: {&amp;quot;VNI&amp;quot;:1,&amp;quot;VtepMAC&amp;quot;:&amp;quot;ae:28:43:65:df:f4&amp;quot;}</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-type: vxlan</span>
<span class="c">#                        flannel.alpha.coreos.com/kube-subnet-manager: true</span>
<span class="c">#    --</span>
<span class="c">#    Annotations:        alpha.kubernetes.io/provided-node-ip: 10.0.2.15</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-data: {&amp;quot;VNI&amp;quot;:1,&amp;quot;VtepMAC&amp;quot;:&amp;quot;8e:91:37:7d:c1:d7&amp;quot;}</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-type: vxlan</span>
<span class="c">#                        flannel.alpha.coreos.com/kube-subnet-manager: true</span>
<span class="nv">$ </span>brctl show
<span class="c"># =&gt; bridge name     bridge id               STP enabled     interfaces</span>
<span class="c">#    cni0            8000.ca30a0c85ccd       no              veth41d9e3b2</span>
<span class="c">#                                                            veth5c3de18a</span>
<span class="c">#                                                            vethfaeebb1c</span>

<span class="c"># ì„œë¹„ìŠ¤ì™€ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE     NAME                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE</span>
<span class="c">#    default       service/kubernetes       ClusterIP   10.10.200.1     &amp;lt;none&amp;gt;        443/TCP                  38m</span>
<span class="c">#    kube-system   service/kube-dns         ClusterIP   10.10.200.10    &amp;lt;none&amp;gt;        53/UDP,53/TCP,9153/TCP   38m</span>
<span class="c">#    kube-system   service/metrics-server   ClusterIP   10.10.200.103   &amp;lt;none&amp;gt;        443/TCP                  38m</span>
<span class="c">#    </span>
<span class="c">#    NAMESPACE     NAME                       ENDPOINTS                                     AGE</span>
<span class="c">#    default       endpoints/kubernetes       10.0.2.15:6443                                38m</span>
<span class="c">#    kube-system   endpoints/kube-dns         172.16.0.4:53,172.16.0.4:53,172.16.0.4:9153   38m</span>
<span class="c">#    kube-system   endpoints/metrics-server   172.16.0.3:10250                              38m</span>

<span class="c"># iptables ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>

<span class="c"># tcp listen í¬íŠ¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span>
</code></pre></div></div>

<ul>
  <li>flannel CNIë¥¼ ì‚¬ìš©í•˜ê³  ìˆê³ , í´ëŸ¬ìŠ¤í„° IPëŠ” 172.16.0.0/16ì´ë©°, ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì˜ê¸°ëŠ¥ë“¤ì´ ë§ì´ ë‚´ì¥ë˜ì–´ìˆì–´ ì‹¤í–‰ì¤‘ì¸ íŒŒë“œê°€ ì ìŒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="nginx-ingress-controller-ì„¤ì¹˜">Nginx Ingress Controller ì„¤ì¹˜</h3>

<ul>
  <li>Nginx Ingress ControllerëŠ” ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” Ingress Controller ì¤‘ í•˜ë‚˜ë¡œ Ingress ì‹¤ìŠµì„ ìœ„í•´ ì„¤ì¹˜í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ë¨¼ì € NGINX Ingress ì˜ íŠ¹ì§•ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>NGINX IngressëŠ” ê³ ì„±ëŠ¥ ì›¹ì„œë²„ì¸ NGINXë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ë©°, Layer 7ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.</li>
      <li>k8sì˜ configmap ì„¤ì •ì„ lua ìŠ¤í¬ë¦½íŠ¸ë¡œ ê°€ê³µí•˜ì—¬ nginx configë¡œ ë³€í™˜í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
      <li>ì„¤ì •ì„ ë³€ê²½í•˜ë©´ ë‚´ë¶€ì˜ nginxê°€ reload ë˜ë©´ì„œ ìë™ìœ¼ë¡œ ì ìš©ë˜ë©°, ì„¤ì •ì„ ì‰½ê²Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Ingress-Nginx ì»¨íŠ¸ë¡¤ëŸ¬ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; ingress-nginx-values.yaml
controller:
  service:
    type: NodePort
    nodePorts:
      http: 30080
      https: 30443
  nodeSelector:
    kubernetes.io/hostname: "k3s-s"
  metrics:
    enabled: true
  serviceMonitor:
      enabled: true
</span><span class="no">EOT

</span><span class="nv">$ </span>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
<span class="c"># =&gt; "ingress-nginx" has been added to your repositories</span>
<span class="nv">$ </span>helm repo update
<span class="c"># =&gt; ...Successfully got an update from the "ingress-nginx" chart repository</span>

<span class="nv">$ </span>kubectl create ns ingress
<span class="c"># =&gt; namespace/ingress created</span>
<span class="nv">$ </span>helm <span class="nb">install </span>ingress-nginx ingress-nginx/ingress-nginx <span class="nt">-f</span> ingress-nginx-values.yaml <span class="nt">--namespace</span> ingress <span class="nt">--version</span> 4.11.2
<span class="c"># =&gt; Release &amp;quot;ingress-nginx&amp;quot; has been upgraded. Happy Helming!</span>
<span class="c">#    NAME: ingress-nginx</span>
<span class="c">#    NAMESPACE: ingress</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    ...</span>
<span class="c">#    The ingress-nginx controller has been installed.</span>
<span class="c">#    Get the application URL by running these commands:</span>
<span class="c">#      export HTTP_NODE_PORT=30080</span>
<span class="c">#      export HTTPS_NODE_PORT=30443</span>
<span class="c">#      export NODE_IP=&amp;quot;$(kubectl get nodes --output jsonpath=&amp;quot;{.items[0].status.addresses[1].address}&amp;quot;)&amp;quot;</span>
<span class="c">#    </span>
<span class="c">#      echo &amp;quot;Visit http://${NODE_IP}:${HTTP_NODE_PORT} to access your application via HTTP.&amp;quot;</span>
<span class="c">#      echo &amp;quot;Visit https://${NODE_IP}:${HTTPS_NODE_PORT} to access your application via HTTPS.&amp;quot;</span>
<span class="c">#    ...</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> ingress
<span class="c"># =&gt; NAME                                            READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/ingress-nginx-controller-7b67846f8f-jdt65   1/1     Running   0          47s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span>
<span class="c">#    service/ingress-nginx-controller             NodePort    10.10.200.113   &amp;lt;none&amp;gt;        80:30080/TCP,443:30443/TCP   47s</span>
<span class="c">#    service/ingress-nginx-controller-admission   ClusterIP   10.10.200.176   &amp;lt;none&amp;gt;        443/TCP                      47s</span>
<span class="c">#    service/ingress-nginx-controller-metrics     ClusterIP   10.10.200.218   &amp;lt;none&amp;gt;        10254/TCP                    47s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/ingress-nginx-controller   1/1     1            1           47s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                  DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/ingress-nginx-controller-7b67846f8f   1         1         1       47s</span>

<span class="nv">$ </span>kubectl describe svc <span class="nt">-n</span> ingress ingress-nginx-controller
<span class="c"># =&gt; Name:                     ingress-nginx-controller</span>
<span class="c">#    Namespace:                ingress</span>
<span class="c">#    Labels:                   app.kubernetes.io/component=controller</span>
<span class="c">#                              app.kubernetes.io/instance=ingress-nginx</span>
<span class="c">#    ...</span>
<span class="c">#    Selector:                 app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx</span>
<span class="c">#    Type:                     NodePort</span>
<span class="c">#    IP Family Policy:         SingleStack</span>
<span class="c">#    IP Families:              IPv4</span>
<span class="c">#    IP:                       10.10.200.113</span>
<span class="c">#    ...</span>
<span class="c">#    Port:                     http  80/TCP</span>
<span class="c">#    TargetPort:               http/TCP</span>
<span class="c">#    NodePort:                 http  30080/TCP</span>
<span class="c">#    Endpoints:                172.16.0.16:80</span>
<span class="c">#    Port:                     https  443/TCP</span>
<span class="c">#    TargetPort:               https/TCP</span>
<span class="c">#    NodePort:                 https  30443/TCP</span>
<span class="c">#    Endpoints:                172.16.0.16:443</span>
<span class="c">#    ...</span>

<span class="c"># externalTrafficPolicy ì„¤ì •</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> ingress ingress-nginx-controller <span class="nt">-p</span> <span class="s1">'{"spec":{"externalTrafficPolicy": "Local"}}'</span>
<span class="c"># =&gt; service/ingress-nginx-controller patched</span>

<span class="c"># ê¸°ë³¸ nginx conf íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> ingress ingress-nginx-controller
<span class="c"># =&gt; ...</span>
<span class="c">#    Data</span>
<span class="c">#    ====</span>
<span class="c">#    allow-snippet-annotations:</span>
<span class="c">#    ----</span>
<span class="c">#    false</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>deploy/ingress-nginx-controller <span class="nt">-n</span> ingress <span class="nt">-it</span> <span class="nt">--</span> <span class="nb">cat</span> /etc/nginx/nginx.conf
<span class="c"># =&gt; # Configuration checksum: 13054992059071414660</span>
<span class="c">#    # setup custom paths that do not require root access</span>
<span class="c">#    pid /tmp/nginx/nginx.pid;</span>
<span class="c">#    </span>
<span class="c">#    daemon off;</span>
<span class="c">#    worker_processes 4;</span>
<span class="c">#    worker_rlimit_nofile 1047552;</span>
<span class="c">#    worker_shutdown_timeout 240s ;</span>
<span class="c">#    </span>
<span class="c">#    events {</span>
<span class="c">#            multi_accept        on;</span>
<span class="c">#            worker_connections  16384;</span>
<span class="c">#            use                 epoll;</span>
<span class="c">#    }</span>
<span class="c">#    </span>
<span class="c">#    http {</span>
<span class="c">#            lua_package_path &amp;quot;/etc/nginx/lua/?.lua;;&amp;quot;;</span>
<span class="c">#            lua_shared_dict balancer_ewma 10M;</span>
<span class="c">#    ...</span>

<span class="c"># ê´€ë ¨ëœ ì •ë³´ í™•ì¸ : í¬ë“œ(Nginx ì„œë²„), ì„œë¹„ìŠ¤, ë””í”Œë¡œì´ë¨¼íŠ¸, ë¦¬í”Œë¦¬ì¹´ì…‹, ì»¨í”¼ê·¸ë§µ, ë¡¤, í´ëŸ¬ìŠ¤í„°ë¡¤, ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ ë“±</span>
<span class="nv">$ </span>kubectl get all,sa,cm,secret,roles <span class="nt">-n</span> ingress
<span class="c"># =&gt; NAME                                            READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/ingress-nginx-controller-7b67846f8f-jdt65   1/1     Running   0          4m21s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span>
<span class="c">#    service/ingress-nginx-controller             NodePort    10.10.200.113   &amp;lt;none&amp;gt;        80:30080/TCP,443:30443/TCP   4m21s</span>
<span class="c">#    service/ingress-nginx-controller-admission   ClusterIP   10.10.200.176   &amp;lt;none&amp;gt;        443/TCP                      4m21s</span>
<span class="c">#    service/ingress-nginx-controller-metrics     ClusterIP   10.10.200.218   &amp;lt;none&amp;gt;        10254/TCP                    4m21s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/ingress-nginx-controller   1/1     1            1           4m21s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                  DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/ingress-nginx-controller-7b67846f8f   1         1         1       4m21s</span>
<span class="c">#    </span>
<span class="c">#    NAME                           SECRETS   AGE</span>
<span class="c">#    serviceaccount/default         0         4m29s</span>
<span class="c">#    serviceaccount/ingress-nginx   0         4m21s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                 DATA   AGE</span>
<span class="c">#    configmap/ingress-nginx-controller   1      4m21s</span>
<span class="c">#    configmap/kube-root-ca.crt           1      4m30s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                         TYPE                 DATA   AGE</span>
<span class="c">#    secret/ingress-nginx-admission               Opaque               3      4m24s</span>
<span class="c">#    secret/sh.helm.release.v1.ingress-nginx.v1   helm.sh/release.v1   1      4m26s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                           CREATED AT</span>
<span class="c">#    role.rbac.authorization.k8s.io/ingress-nginx   2024-01-01T08:53:04Z</span>
<span class="nv">$ </span>kubectl describe clusterroles ingress-nginx
<span class="nv">$ </span>kubectl get pod,svc,ep <span class="nt">-n</span> ingress <span class="nt">-o</span> wide <span class="nt">-l</span> app.kubernetes.io/component<span class="o">=</span>controller

<span class="c"># ë²„ì „ ì •ë³´ í™•ì¸</span>
<span class="nv">$ POD_NAMESPACE</span><span class="o">=</span>ingress
<span class="nv">$ POD_NAME</span><span class="o">=</span><span class="si">$(</span>kubectl get pods <span class="nt">-n</span> <span class="nv">$POD_NAMESPACE</span> <span class="nt">-l</span> app.kubernetes.io/name<span class="o">=</span>ingress-nginx <span class="nt">--field-selector</span><span class="o">=</span>status.phase<span class="o">=</span>Running <span class="nt">-o</span> name<span class="si">)</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nv">$POD_NAME</span> <span class="nt">-n</span> <span class="nv">$POD_NAMESPACE</span> <span class="nt">--</span> /nginx-ingress-controller <span class="nt">--version</span>
<span class="c"># =&gt; -------------------------------------------------------------------------------</span>
<span class="c">#    NGINX Ingress controller</span>
<span class="c">#      Release:       v1.11.2</span>
<span class="c">#      Build:         46e76e5916813cfca2a9b0bfdc34b69a0000f6b9</span>
<span class="c">#      Repository:    https://github.com/kubernetes/ingress-nginx</span>
<span class="c">#      nginx version: nginx/1.25.5</span>
<span class="c">#    -------------------------------------------------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>Ingress Controllerê°€ ì„¤ì¹˜ë˜ì—ˆìœ¼ë©°, NodePortë¡œ ì„œë¹„ìŠ¤ê°€ ìƒì„±ëœê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>
    <p>ë˜í•œ Nginx Ingress Controllerì˜ ê²½ìš° ë‚´ë¶€ì ìœ¼ë¡œëŠ” ì¼ë°˜ì ì¸ <strong>nginx ì„œë²„ê°€ ë™ì¼í•˜ê²Œ ë™ì‘</strong>í•˜ê³ , <strong>lua ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ configmapì˜ ì„¤ì •ì´ ì ìš©/ê´€ë¦¬</strong>ë˜ê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>(ì˜µì…˜) kubectl krew ì„¤ì¹˜ - <a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">ë§í¬</a> &amp; ingress-nginx plugin ì„¤ì¹˜ - <a href="https://kubernetes.github.io/ingress-nginx/kubectl-plugin/">ë§í¬</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># (ì°¸ê³ ) ìš´ì˜ì²´ì œ í™•ì¸ : linux</span>
<span class="nv">$ OS</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> | <span class="nb">tr</span> <span class="s1">'[:upper:]'</span> <span class="s1">'[:lower:]'</span><span class="si">)</span><span class="s2">"</span>
<span class="c"># (ì°¸ê³ )  CPU ì•„í‚¤í…ì²˜ í™•ì¸ : amd64</span>
<span class="nv">$ ARCH</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span> | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/x86_64/amd64/'</span> <span class="nt">-e</span> <span class="s1">'s/\(arm\)\(64\)\?.*/\1\2/'</span> <span class="nt">-e</span> <span class="s1">'s/aarch64$/arm64/'</span><span class="si">)</span><span class="s2">"</span>
<span class="c"># (ì°¸ê³ )  KREW ì§€ì • : krew-linux_amd64</span>
<span class="nv">$ KREW</span><span class="o">=</span><span class="s2">"krew-</span><span class="k">${</span><span class="nv">OS</span><span class="k">}</span><span class="s2">_</span><span class="k">${</span><span class="nv">ARCH</span><span class="k">}</span><span class="s2">"</span>

<span class="c"># kubectl krew ì„¤ì¹˜</span>
<span class="c"># curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz"</span>
<span class="nv">$ </span>curl <span class="nt">-fsSLO</span> <span class="s2">"https://github.com/kubernetes-sigs/krew/releases/latest/download/krew-linux_amd64.tar.gz"</span> <span class="o">&amp;&amp;</span> <span class="nb">tar </span>zxvf krew-linux_amd64.tar.gz <span class="o">&amp;&amp;</span> ./krew-linux_amd64 <span class="nb">install </span>krew
<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">KREW_ROOT</span><span class="k">:-</span><span class="nv">$HOME</span><span class="p">/.krew</span><span class="k">}</span><span class="s2">/bin:</span><span class="nv">$PATH</span><span class="s2">"</span>

<span class="c"># í”ŒëŸ¬ê·¸ì¸ ì •ë³´ ì—…ë°ì´íŠ¸ í›„ í™•ì¸ - ë§í¬</span>
<span class="nv">$ </span>kubectl krew update
<span class="nv">$ </span>kubectl krew search

<span class="c"># ingress-nginx í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜</span>
<span class="nv">$ </span>kubectl krew <span class="nb">install </span>ingress-nginx
<span class="c"># =&gt; (ì•„ì‰½ê²Œë„ ì˜›ë‚  ë²„ì „ì´ë¼ì„œ ì„¤ì¹˜ê°€ ì•ˆ ë©ë‹ˆë‹¤.) </span>

<span class="c"># ingress-nginx í”ŒëŸ¬ê·¸ì¸ ëª…ë ¹ì–´ ì‹¤í–‰(ë„ì›€ë§ ì¶œë ¥)</span>
<span class="nv">$ </span>kubectl ingress-nginx

<span class="c"># nginx ctrl ì˜ backends ì„¤ì • ì •ë³´ ì¶œë ¥</span>
<span class="nv">$ </span>kubectl ingress-nginx backends <span class="nt">-n</span> ingress-nginx <span class="nt">--list</span>
<span class="nv">$ </span>kubectl ingress-nginx backends <span class="nt">-n</span> ingress-nginx

<span class="c"># conf ì¶œë ¥</span>
<span class="nv">$ </span>kubectl ingress-nginx conf <span class="nt">-n</span> ingress-nginx
<span class="c">## íŠ¹ì • í˜¸ìŠ¤íŠ¸(ë„ë©”ì¸) ì„¤ì • í™•ì¸</span>
<span class="nv">$ </span>kubectl ingress-nginx conf <span class="nt">-n</span> ingress-nginx <span class="nt">--host</span> gasida.cndk.link
<span class="nv">$ </span>kubectl ingress-nginx conf <span class="nt">-n</span> ingress-nginx <span class="nt">--host</span> nasida.cndk.link

<span class="c"># ì •ë³´ ë³´ê¸° í¸í•¨!</span>
<span class="nv">$ </span>kubectl ingress-nginx ingresses
<span class="nv">$ </span>kubectl ingress-nginx ingresses <span class="nt">--all-namespaces</span>
</code></pre></div></div>

<h3 id="ì¸ê·¸ë ˆìŠ¤ingress-ì‹¤ìŠµ-ë°-í†µì‹ -íë¦„-í™•ì¸">ì¸ê·¸ë ˆìŠ¤(Ingress) ì‹¤ìŠµ ë° í†µì‹  íë¦„ í™•ì¸</h3>

<ul>
  <li>ì‹¤ìŠµ êµ¬ì„±ë„
    <ul>
      <li>ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œì— ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬(Nginx) íŒŒë“œë¥¼ ìƒì„±í•˜ê³ , NodePort ë¡œ ì™¸ë¶€ì— ë…¸ì¶œí•©ë‹ˆë‹¤.</li>
      <li>ì¸ê·¸ë ˆìŠ¤ ì •ì±… ì„¤ì • : Host/Path routing, ì‹¤ìŠµì˜ í¸ë¦¬ë¥¼ ìœ„í•´ì„œ ë„ë©”ì¸ ì—†ì´ IPë¡œ ì ‘ì† ì„¤ì • ê°€ëŠ¥í•˜ë„ë¡ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_5.png" alt="img.png" /></p>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_6.png" alt="img_1.png" /></p>

<h4 id="deploymentì™€-service-ìƒì„±">deploymentì™€ service ìƒì„±</h4>

<ul>
  <li>svc1-pod.yml ìƒì„±
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># svc1-pod.yml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">deploy1-websrv</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">websrv</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">websrv</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pod-web</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">svc1-web</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">web-port</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">9001</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">websrv</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
</code></pre></div>    </div>
  </li>
  <li>svc2-pod.yml ìƒì„±
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># svc2-pod.yml </span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">deploy2-guestsrv</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">guestsrv</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">guestsrv</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pod-guest</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google-samples/kubernetes-bootcamp:v1</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">svc2-guest</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">guest-port</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">9002</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">guestsrv</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
</code></pre></div>    </div>
  </li>
  <li>svc3-pod.yml ìƒì„±
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># svc3-pod.yml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">deploy3-adminsrv</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">adminsrv</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">adminsrv</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pod-admin</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">k8s.gcr.io/echoserver:1.5</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">svc3-admin</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">admin-port</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">9003</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">adminsrv</span>
</code></pre></div>    </div>
  </li>
  <li>ìƒì„± ë° í™•ì¸
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get ingress,svc,ep,pod -owide'</span>
  
<span class="c"># ìƒì„±</span>
<span class="nv">$ </span>kubectl taint nodes k3s-m <span class="nv">role</span><span class="o">=</span>controlplane:NoSchedule
<span class="c"># &lt;span style="color: green;"&gt;&lt;/span&gt;</span>
  
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> svc1-pod.yml,svc2-pod.yml,svc3-pod.yml
<span class="c"># =&gt; deployment.apps/deploy1-websrv created</span>
<span class="c">#    service/svc1-web created</span>
<span class="c">#    deployment.apps/deploy2-guestsrv created</span>
<span class="c">#    service/svc2-guest created</span>
<span class="c">#    deployment.apps/deploy3-adminsrv created</span>
<span class="c">#    service/svc3-admin created</span>
  
<span class="c"># í™•ì¸ : svc1, svc3 ì€ ClusterIP ë¡œ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œëŠ” ì ‘ì†í•  ìˆ˜ ì—†ë‹¤ &gt;&gt; Ingress ëŠ” ì—°ê²° ê°€ëŠ¥!</span>
<span class="nv">$ </span>kubectl get pod,svc,ep
<span class="c"># =&gt; NAME                                    READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/deploy1-websrv-5c6b88bd77-ht5hl     1/1     Running   0          34s</span>
<span class="c">#    pod/deploy2-guestsrv-649875f78b-8wh8r   1/1     Running   0          34s</span>
<span class="c">#    pod/deploy2-guestsrv-649875f78b-jcvrf   1/1     Running   0          34s</span>
<span class="c">#    pod/deploy3-adminsrv-7c8f8b8c87-4mzv7   1/1     Running   0          34s</span>
<span class="c">#    pod/deploy3-adminsrv-7c8f8b8c87-4sqmh   1/1     Running   0          34s</span>
<span class="c">#    pod/deploy3-adminsrv-7c8f8b8c87-ztltl   1/1     Running   0          34s</span>
<span class="c">#    </span>
<span class="c">#    NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/kubernetes   ClusterIP   10.10.200.1     &amp;lt;none&amp;gt;        443/TCP          5h52m</span>
<span class="c">#    service/svc1-web     ClusterIP   10.10.200.141   &amp;lt;none&amp;gt;        9001/TCP         34s</span>
<span class="c">#    service/svc2-guest   NodePort    10.10.200.60    &amp;lt;none&amp;gt;        9002:30901/TCP   34s</span>
<span class="c">#    service/svc3-admin   ClusterIP   10.10.200.171   &amp;lt;none&amp;gt;        9003/TCP         34s</span>
<span class="c">#    &lt;span style="color: green;"&gt;# ingressëŠ” pod ì •ë³´ë¡œ ë°”ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë¯€ë¡œ ì„œë¹„ìŠ¤ê°€ ClusterIPì´ë“  NodePort íƒ€ì…ì´ë“  ê´€ê³„ ì—†ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                                         AGE</span>
<span class="c">#    endpoints/kubernetes   192.168.10.10:6443                                5h52m</span>
<span class="c">#    endpoints/svc1-web     172.16.1.8:80                                     34s</span>
<span class="c">#    endpoints/svc2-guest   172.16.2.8:8080,172.16.3.7:8080                   34s</span>
<span class="c">#    endpoints/svc3-admin   172.16.1.7:8080,172.16.2.9:8080,172.16.3.8:8080   34s</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="ì¸ê·¸ë ˆìŠ¤ì •ì±…-ìƒì„±">ì¸ê·¸ë ˆìŠ¤(ì •ì±…) ìƒì„±</h4>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_7.png" alt="img.png" class="image-center" />
<em class="image-caption">ingress ì •ì±… ì ìš© êµ¬ì¡° (<a href="https://kschoi728.tistory.com/266">ì¶œì²˜</a>)</em></p>

<ul>
  <li>ingress1.yml íŒŒì¼ ìƒì„±</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; ingress1.yml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-1
  annotations:
    #nginx.ingress.kubernetes.io/upstream-hash-by: "true"
spec:
  ingressClassName: nginx
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: svc1-web
            port:
              number: 80
      - path: /guest
        pathType: Prefix
        backend:
          service:
            name: svc2-guest
            port:
              number: 8080
      - path: /admin
        pathType: Prefix
        backend:
          service:
            name: svc3-admin
            port:
              number: 8080
</span><span class="no">EOT
</span></code></pre></div></div>

<ul>
  <li>ingress ì •ì±… ìƒì„±</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get ingress,svc,ep,pod -owide'</span>

<span class="c"># ìƒì„±</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ingress1.yml
<span class="c"># =&gt; ingress.networking.k8s.io/ingress-1 created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get ingress
<span class="c"># =&gt; NAME        CLASS   HOSTS   ADDRESS   PORTS   AGE</span>
<span class="c">#    ingress-1   nginx   *                 80      11s</span>
<span class="nv">$ </span>kubectl describe ingress ingress-1
<span class="c"># =&gt; ...</span>
<span class="c">#    Rules:</span>
<span class="c">#      Host        Path  Backends</span>
<span class="c">#      ----        ----  --------</span>
<span class="c">#      *</span>
<span class="c">#                  /        svc1-web:80 ()</span>
<span class="c">#                  /guest   svc2-guest:8080 ()</span>
<span class="c">#                  /admin   svc3-admin:8080 ()</span>
<span class="c">#    ...</span>

<span class="c"># ì„¤ì •ì´ ë°˜ì˜ëœ nginx conf íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>deploy/ingress-nginx-controller <span class="nt">-n</span> ingress <span class="nt">-it</span> <span class="nt">--</span> <span class="nb">cat</span> /etc/nginx/nginx.conf
<span class="nv">$ </span>kubectl <span class="nb">exec </span>deploy/ingress-nginx-controller <span class="nt">-n</span> ingress <span class="nt">-it</span> <span class="nt">--</span> <span class="nb">cat</span> /etc/nginx/nginx.conf | <span class="nb">grep</span> <span class="s1">'location /'</span> <span class="nt">-A5</span>
<span class="c"># =&gt;      location /guest/ {</span>
<span class="c">#    </span>
<span class="c">#         set $namespace      &amp;quot;default&amp;quot;;</span>
<span class="c">#         set $ingress_name   &amp;quot;ingress-1&amp;quot;;</span>
<span class="c">#         set $service_name   &amp;quot;svc2-guest&amp;quot;;</span>
<span class="c">#         set $service_port   &amp;quot;8080&amp;quot;;</span>
<span class="c">#    --</span>
<span class="c">#         location /admin/ {</span>
<span class="c">#    </span>
<span class="c">#         set $namespace      &amp;quot;default&amp;quot;;</span>
<span class="c">#         set $ingress_name   &amp;quot;ingress-1&amp;quot;;</span>
<span class="c">#         set $service_name   &amp;quot;svc3-admin&amp;quot;;</span>
<span class="c">#         set $service_port   &amp;quot;8080&amp;quot;;</span>
<span class="c">#    --</span>
<span class="c">#         location / {</span>
<span class="c">#    </span>
<span class="c">#         set $namespace      &amp;quot;default&amp;quot;;</span>
<span class="c">#         set $ingress_name   &amp;quot;ingress-1&amp;quot;;</span>
<span class="c">#         set $service_name   &amp;quot;svc1-web&amp;quot;;</span>
<span class="c">#         set $service_port   &amp;quot;80&amp;quot;;</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h4 id="ingressë¥¼-í†µí•œ-ë‚´ë¶€-ì ‘ì†">ingressë¥¼ í†µí•œ ë‚´ë¶€ ì ‘ì†</h4>

<ul>
  <li>
    <p>Nginx ingress controllerë¥¼ í†µí•´ ì ‘ì†ì‹œ ì„œë¹„ìŠ¤ëŠ” íŒŒë“œì˜ ì—”ë“œí¬ì¸íŠ¸ì˜ ì •ë³´ë§Œ ì°¸ì¡°ë˜ê³ , ì„œë¹„ìŠ¤ë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ë°”ë¡œ íŒŒë“œë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w6/20241012_kans_w6_8.png" alt="img.png" class="w-80 image-center" />
<em class="image-caption">ì¸ê·¸ë ˆìŠ¤ ì ‘ì† ê²½ë¡œ(ì„œë¹„ìŠ¤ Bypass) : Ingress â†’ ì• í”Œë¦¬ì¼€ì´ì…˜(Deploy, Pod ë“±)</em></p>
  </li>
  <li>ì°¸ê³  : URI(Uniform Resource Identifier)ëŠ” RFC 3986ì— ì •ì˜ëœ í†µí•© ìì› ì‹ë³„ìë¡œ, í”íˆ ì‚¬ìš©ë˜ëŠ” URL(Uniform Resource Locator)ê³¼ URN(Uniform Resource Name)ì„ í¬í•¨í•©ë‹ˆë‹¤.
    <ul>
      <li>Request URIëŠ” ì„œë²„ ì£¼ì†Œë‚˜ íŒŒì¼ì´ë¦„, íŒŒë¼ë¯¸í„° ë“± ë‹¤ì–‘í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì‹ë³„í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ë¬¸ìì—´ì…ë‹ˆë‹¤.</li>
      <li>ì ˆëŒ€ URI(absolute URI)ëŠ” ìŠ¤í‚¤ë§ˆì™€ í˜¸ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ ì™„ì „í•œ URIë¥¼ ì˜ë¯¸í•˜ë©°, ìƒëŒ€ URI(relative URI)ëŠ” ìŠ¤í‚¤ë§ˆì™€ í˜¸ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ì§€ ì•Šê³  í˜„ì¬ ìœ„ì¹˜ì—ì„œ ìƒëŒ€ì ì¸ ìœ„ì¹˜ë¥¼ ê¸°ë¡í•œ URIë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
        <ul>
          <li>URIì˜ êµ¬ì¡°ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w6/20241012_kans_w6_9.png" alt="img.png" class="image-center" />
<em class="image-caption">ì±… â€˜ê·¸ë¦¼ìœ¼ë¡œ ê³µë¶€í•˜ëŠ” TCP/IP êµ¬ì¡°â€™ ì¤‘ ë°œì·Œ</em></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ì°¸ê³  : X-Forwarded-For í—¤ë”, X-Forwarded-Proto í—¤ë”
    <ul>
      <li>X-Forwarded-For í—¤ë”ëŠ” ì†¡ì‹ ì§€ IP ì£¼ì†Œê°€ ë³€í™˜ë˜ëŠ” í™˜ê²½(ì¥ë¹„, ì„œë²„, ì†”ë£¨ì…˜ ë“±)ì—ì„œ, ë³€í™˜ ì „ ì†¡ì‹ ì§€(í´ë¼ì´ì–¸íŠ¸) IP ì£¼ì†Œë¥¼ ì €ì¥í•˜ëŠ” í—¤ë”ì…ë‹ˆë‹¤.
        <ul>
          <li>ì—¬ëŸ¬ ì¥ë¹„ë‚˜ ì†”ë£¨ì…˜ì„ ê±°ì¹  ê²½ìš° <code class="language-plaintext highlighter-rouge">,</code>ë¡œ êµ¬ë¶„í•˜ì—¬ ì—¬ëŸ¬ ê±´ì´ ë„˜ì–´ì˜¬ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ´ ê²½ìš° ê°€ì¥ ì™¼ìª½ ê²ƒì´ í´ë¼ì´ì–¸íŠ¸ IPì´ê³ , ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê°ˆ ìˆ˜ë¡ ë‚˜ì¤‘ì— ì²˜ë¦¬ëœ ì¥ë¹„/ì†”ë£¨ì…˜ì˜ IPê°€ ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>X-Forwarded-Proto í—¤ë”ëŠ” ë³€í™˜ ì „ í”„ë¡œí† ì½œì„ ì €ì¥í•©ë‹ˆë‹¤. (ì˜ˆ. SSL Offload í™˜ê²½ì—ì„œ ì„œë²„ ì¸¡ì—ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ ì‹œ ì‚¬ìš©í•œ ì›ë˜ í”„ë¡œí† ì½œì„ í™•ì¸)</li>
      <li>ì´ëŸ¬í•œ í—¤ë”ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ IP ì£¼ì†Œë¥¼ í™•ì¸í•˜ê±°ë‚˜, í”„ë¡œí† ì½œì„ í™•ì¸í•˜ëŠ” ë“±ì˜ ìš©ë„ë¡œ ì‚¬ìš©ë˜ë©°, ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ NodePortë‚˜ LoadBalancerë¥¼ í†µí•´ì„œ ì ‘ì†ë˜ì—ˆì„ë•Œë„ ì›ë˜ì˜ í´ë¼ì´ì–¸íŠ¸ì˜ IPë¥¼ í™•ì¸í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. (<code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code>ë¥¼ ì‚¬ìš©í•  í•„ìš”ê°€ ì¤„ì–´ë“­ë‹ˆë‹¤!)</li>
      <li>ì›ë˜ì˜ IPë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•ì€ ë‹¤ìŒì˜ ë°©ë²•ë“¤ì´ ìˆìŠµë‹ˆë‹¤.
        <ul>
          <li>Http request header ì¤‘ ë‹¤ìŒ ê°’ë“¤ì—ì„œ ì›ë˜ì˜ IP ì°¾ê¸°
            <ol>
              <li>X-Forwarded-For : HTTP RFC í‘œì¤€ì—ëŠ” ì—†ì§€ë§Œ ì‚¬ì‹¤ìƒ í‘œì¤€!!!</li>
              <li>Proxy-Client-IP : íŠ¹ì • ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš© (ì˜ˆ. WebLogic Connector - mod_wl)</li>
              <li>WL-Proxy-Client-IP : íŠ¹ì • ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš© (ì˜ˆ. WebLogic Connector - mod_wl)</li>
              <li>CLIENT_IP</li>
            </ol>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ì¸ê·¸ë ˆìŠ¤(Nginx ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬)ë¥¼ í†µí•œ ì ‘ì†(HTTP ì¸ì…)ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># (krew í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ì‹œ) ì¸ê·¸ë ˆìŠ¤ ì •ì±… í™•ì¸</span>
<span class="c"># $ kubectl ingress-nginx ingresses</span>
<span class="c"># INGRESS NAME   HOST+PATH   ADDRESSES       TLS   SERVICE      SERVICE PORT   ENDPOINTS</span>
<span class="c"># ingress-1      /           192.168.10.10   NO    svc1-web     80             1</span>
<span class="c"># ingress-1      /guest      192.168.10.10   NO    svc2-guest   8080           2</span>
<span class="c"># ingress-1      /admin      192.168.10.10   NO    svc3-admin   8080           3</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get ingress
<span class="c"># =&gt; NAME        CLASS   HOSTS   ADDRESS         PORTS   AGE</span>
<span class="c">#    ingress-1   nginx   *       10.10.200.113   80      18m</span>
 
<span class="nv">$ </span>kubectl describe ingress ingress-1 | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s2">"5, </span><span class="se">\$</span><span class="s2">p"</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Rules:</span>
<span class="c">#      Host        Path  Backends</span>
<span class="c">#      ----        ----  --------</span>
<span class="c">#      *</span>
<span class="c">#                  /        svc1-web:80 ()</span>
<span class="c">#                  /guest   svc2-guest:8080 ()</span>
<span class="c">#                  /admin   svc3-admin:8080 ()</span>
<span class="c">#    ...</span>

<span class="c"># ì ‘ì† ë¡œê·¸ í™•ì¸ : kubetail ì„¤ì¹˜ë˜ì–´ ìˆìŒ - ì¶œë ¥ë˜ëŠ” nginx ì˜ ë¡œê·¸ì˜ IP í™•ì¸</span>
<span class="nv">$ </span>kubetail <span class="nt">-n</span> ingress <span class="nt">-l</span> app.kubernetes.io/component<span class="o">=</span>controller

<span class="nt">-------------------------------</span>
<span class="c"># ìì‹ ì˜ ì§‘ PCì—ì„œ ì¸ê·¸ë ˆìŠ¤ë¥¼ í†µí•œ ì ‘ì† : ê°ê° </span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Ingress1 sv1-web URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:30080"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Ingress1 sv2-guest URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:30080/guest"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Ingress1 sv3-admin URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:30080/admin"</span>

<span class="c"># svc1-web ì ‘ì†</span>
<span class="c"># $ MYIP=&lt;EC2 ê³µì¸ IP ë˜ëŠ” ì»¨íŠ¸ë¡¤í”Œë ˆì¸ node ip&gt;</span>
<span class="nv">$ MYIP</span><span class="o">=</span>192.168.10.10
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$MYIP</span>:30080
<span class="c"># =&gt; ...</span>
<span class="c">#    &amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;</span>
<span class="c">#    &amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and</span>
<span class="c">#    working. Further configuration is required.&amp;lt;/p&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;lt;p&amp;gt;For online documentation and support please refer to</span>
<span class="c">#    &amp;lt;a href=&amp;quot;http://nginx.org/&amp;quot;&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;</span>
<span class="c">#    Commercial support is available at</span>
<span class="c">#    &amp;lt;a href=&amp;quot;http://nginx.com/&amp;quot;&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you for using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;</span>
<span class="c">#    ...</span>

<span class="c"># svc2-guest ì ‘ì†</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$MYIP</span>:30080/guest
<span class="c"># =&gt; Hello Kubernetes bootcamp! | Running on: deploy2-guestsrv-649875f78b-jcvrf | v=1</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYIP</span>:30080/guest <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      51 Hello Kubernetes bootcamp! | Running on: deploy2-guestsrv-649875f78b-8wh8r | v=1</span>
<span class="c">#         49 Hello Kubernetes bootcamp! | Running on: deploy2-guestsrv-649875f78b-jcvrf | v=1</span>

<span class="c"># svc3-admin ì ‘ì† &gt; ê¸°ë³¸ì ìœ¼ë¡œ Nginx ëŠ” ë¼ìš´ë“œë¡œë¹ˆ ë¶€í•˜ë¶„ì‚° ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš© &gt;&gt; Client_address ì™€ XFF ì£¼ì†ŒëŠ” ì–´ë–¤ ì£¼ì†Œì¸ê°€ìš”?</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$MYIP</span>:30080/admin
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$MYIP</span>:30080/admin | egrep <span class="s1">'(client_address|x-forwarded-for)'</span>
<span class="c"># =&gt;  client_address=172.16.0.16</span>
<span class="c">#     x-forwarded-for=172.16.0.1</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYIP</span>:30080/admin | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      34 Hostname: deploy3-adminsrv-7c8f8b8c87-4sqmh</span>
<span class="c">#         33 Hostname: deploy3-adminsrv-7c8f8b8c87-ztltl</span>
<span class="c">#         33 Hostname: deploy3-adminsrv-7c8f8b8c87-4mzv7</span>

<span class="c"># (ì˜µì…˜) ë””í”Œë¡œì´ë¨¼íŠ¸ì˜ íŒŒë“œ ê°¯ìˆ˜ë¥¼ ì¦ê°€/ê°ì†Œ ì„¤ì • í›„ ì ‘ì† í…ŒìŠ¤íŠ¸ í•´ë³´ì</span>
<span class="nv">$ </span>kubectl scale deployment deploy3-adminsrv <span class="nt">--replicas</span> 2   <span class="c"># svc3-adminì˜ íŒŒë“œ ê°¯ìˆ˜ë¥¼ 2ê°œë¡œ ê°ì†Œ</span>
<span class="c"># =&gt; deployment.apps/deploy3-adminsrv scaled</span>
<span class="nv">$ </span>kubectl get deploy deploy3-adminsrv
<span class="c"># =&gt; NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deploy3-adminsrv   2/2     2            2           80m</span>
<span class="c"># &lt;span style="color: green;"&gt;íŒŒë“œìˆ˜ê°€ 3ê°œ =&gt; 2ê°œë¡œ ì¤„ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
 
<span class="c"># ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYIP</span>:30080/admin | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      50 Hostname: deploy3-adminsrv-7c8f8b8c87-4sqmh</span>
<span class="c">#         50 Hostname: deploy3-adminsrv-7c8f8b8c87-4mzv7</span>
<span class="c"># &lt;span style="color: green;"&gt;2ê°œë¡œ ì¤„ì–´ë“  íŒŒë“œìˆ˜ë§Œí¼ 2ê°œì˜ íŒŒë“œì— ë¶€í•˜ê°€ ë¶„ì‚° ë˜ëŠ”ê²ƒì„ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>ë…¸ë“œì—ì„œ íŒ¨í‚· ìº¡ì³ í™•ì¸ : flannel vxlanì˜ íŒŒë“œê°„ í†µì‹ ì‹œ IPì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ngrepì„ ì´ìš©í•´ íŒ¨í‚· ìº¡ì³</span>
<span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> enp0s8 <span class="s1">''</span> udp port 8472 or tcp port 80
<span class="c"># =&gt; interface: enp0s8 (192.168.10.0/255.255.255.0)</span>
<span class="c">#    filter: ( udp port 8472 or tcp port 80 ) and ((ip || ip6) || (vlan &amp;amp;&amp;amp; (ip || ip6)))</span>
<span class="c">#    #</span>
<span class="c">#    U 2024/10/12 12:42:39.071289 192.168.10.10:39828 -&amp;gt; 192.168.10.102:8472 #1</span>
<span class="c">#    .........(Ce...!w.....E..&amp;lt;..@.?............|.P...........\...........</span>
<span class="c">#    d9?.........</span>
<span class="c">#    #</span>
<span class="c">#    U 2024/10/12 12:42:39.072521 192.168.10.102:37126 -&amp;gt; 192.168.10.10:8472 #2</span>
<span class="c">#    .........!w....(Ce....E..&amp;lt;..@.?............P.|(3c@.......4.y.........</span>
<span class="c">#    ....d9?.....</span>
<span class="c">#    #</span>
<span class="c">#    U 2024/10/12 12:42:39.072734 192.168.10.10:39828 -&amp;gt; 192.168.10.102:8472 #3</span>
<span class="c">#    .........(Ce...!w.....E..4..@.?............|.P....(3cA.....K.....</span>
<span class="c">#    d9?.....</span>
<span class="c">#    #</span>
<span class="c">#    U 2024/10/12 12:42:39.072855 192.168.10.10:39828 -&amp;gt; 192.168.10.102:8472 #4</span>
<span class="c">#    .........(Ce...!w.....E..c..@.?..Y.........|.P....(3cA...........</span>
<span class="c">#    d9?.....GET / HTTP/1.1.</span>
<span class="c">#    Host: localhost:30080.</span>
<span class="c">#    X-Request-ID: e8aa4e70150ae6ae8de5a34637e294e6.</span>
<span class="c">#    X-Real-IP: 172.16.0.1.</span>
<span class="c">#    X-Forwarded-For: 172.16.0.1.</span>
<span class="c">#    X-Forwarded-Host: localhost:30080.</span>
<span class="c">#    X-Forwarded-Port: 80.</span>
<span class="c">#    X-Forwarded-Proto: http.</span>
<span class="c">#    X-Forwarded-Scheme: http.</span>
<span class="c">#    X-Scheme: http.</span>
<span class="c">#    User-Agent: curl/7.81.0.</span>
<span class="c">#    Accept: */*.</span>
<span class="c">#    ...</span>

<span class="c"># tcp dumpë¥¼ ì´ìš©í•´ vxlan(udp 8472) í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> enp0s8 udp port 8472 <span class="nt">-nn</span>
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="c">#    listening on enp0s8, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="c">#    12:42:13.504948 IP 192.168.10.10.55617 &amp;gt; 192.168.10.102.8472: OTV, flags [I] (0x08), overlay 0, instance 1</span>
<span class="c">#    IP 172.16.0.16.57692 &amp;gt; 172.16.1.8.80: Flags [S], seq 911277209, win 64860, options [mss 1410,sackOK,TS val 1681447926 ecr 0,nop,wscale 7], length 0</span>
<span class="c">#    ...</span>

<span class="c"># vethYëŠ” ê°ì k3s-s ì˜ ê°€ì¥ ë§ˆì§€ë§‰ veth ë¥¼ ì§€ì •</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> vethY tcp port 8080 <span class="nt">-nn</span>
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="c">#    listening on veth5ae3dd58, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="c">#    12:44:11.609334 IP 172.16.0.16.41240 &amp;gt; 172.16.2.9.8080: Flags [S], seq 1593288127, win 64860, options [mss 1410,sackOK,TS val 3487210526 ecr 0,nop,wscale 7], length 0</span>
<span class="c">#    12:44:11.610875 IP 172.16.2.9.8080 &amp;gt; 172.16.0.16.41240: Flags [S.], seq 1820942288, ack 1593288128, win 64308, options [mss 1410,sackOK,TS val 257720908 ecr 3487210526,nop,wscale 7], length 0</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> vethY tcp port 8080 <span class="nt">-w</span> /tmp/ingress-nginx.pcap

<span class="nt">---</span> 

<span class="c"># ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ svc3-admin ì ‘ì†</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$MYIP</span>:30080/admin 

<span class="nt">---</span>

<span class="c"># ìì‹ ì˜ PCì—ì„œ k3s-s EC2 ê³µì¸ IPë¡œ pcap ë‹¤ìš´ë¡œë“œ</span>
<span class="c"># $ scp ubuntu@&lt;k3s-s EC2 ê³µì¸ IP&gt;:/tmp/ingress-nginx.pcap ~/Downloads</span>
<span class="nv">$ </span>scp ubuntu@43.202.1.177:/tmp/ingress-nginx.pcap ~/Downloads
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_10.png" alt="20241012_kans_w6_10.png" class="image-center" />
<em class="image-caption">ì¸ê·¸ë ˆìŠ¤ë¥¼ í†µí•œ ì ‘ì† íë¦„</em></p>

<ul>
  <li>íŒ¨í‚· ìº¡ì³ ê²°ê³¼ ingress controllerì—ì„œ íŒŒë“œì˜ ipë¡œ ë°”ë¡œ ì ‘ì† ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
  <li>
    <p>ë˜í•œ, flannel CNIë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— vxlanì„ í†µí•´ í†µì‹ ì´ ì´ë£¨ì–´ì§€ê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>Nginx íŒŒë“œê°€ endpoint ì •ë³´ ë“±ì„ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥í•œ ì´ìœ ëŠ” í´ëŸ¬ìŠ¤í„°ë¡¤ê³¼ ë¡¤(ì—”ë“œí¬ì¸íŠ¸ list, watch)ë¥¼ ë°”ì¸ë”©ëœ ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ë¥¼ íŒŒë“œê°€ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl describe deployments.apps <span class="nt">-n</span> ingress ingress-nginx-controller | <span class="nb">grep</span> <span class="s1">'Service Account'</span>
<span class="c"># =&gt;   Service Account:  ingress-nginx</span>

<span class="nv">$ </span>kubectl get <span class="nt">-n</span> ingress clusterrolebindings ingress-nginx
<span class="c"># =&gt; NAME            ROLE                        AGE</span>
<span class="c">#    ingress-nginx   ClusterRole/ingress-nginx   4h9m</span>

<span class="nv">$ </span>kubectl get <span class="nt">-n</span> ingress rolebindings ingress-nginx
<span class="c"># =&gt; NAME            ROLE                 AGE</span>
<span class="c">#    ingress-nginx   Role/ingress-nginx   4h9m</span>

<span class="nv">$ </span>kubectl describe clusterrole ingress <span class="nt">-n</span> ingress | egrep <span class="s1">'(Verbs|endpoints)'</span>
<span class="c"># =&gt;   Resources                           Non-Resource URLs  Resource Names  Verbs</span>
<span class="c">#      endpointslices.discovery.k8s.io     []                 []              [list watch get]</span>
<span class="c">#      endpoints                           []                 []              [list watch]</span>

<span class="nv">$ </span>kubectl describe roles ingress-nginx <span class="nt">-n</span> ingress | egrep <span class="s1">'(Verbs|endpoints)'</span>
<span class="c"># =&gt;   Resources                           Non-Resource URLs  Resource Names          Verbs</span>
<span class="c">#      endpoints                           []                 []                      [get list watch]</span>
<span class="c">#      endpointslices.discovery.k8s.io     []                 []                      [list watch get]</span>
</code></pre></div></div>

<h4 id="íŒ¨í‚·-ë¶„ì„">íŒ¨í‚· ë¶„ì„</h4>

<ul>
  <li>í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ì ‘ì† í›„ ë‚´ë¶€ë¡œ ì ‘ì†í•˜ëŠ” íŒ¨í‚·ì„ ë¶„ì„í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ìœ„ì˜ ì‹¤ìŠµê³¼ ë™ì¼í•˜ì§€ë§Œ vethì—ì„œ 8080ì„ ìº¡ì³í•˜ê³  ë…¸ë“œì˜ nicì—ì„œ 8472 (vxnet)ë¥¼ ìº¡ì³í•˜ì—¬ ë³‘í•©(merge)í•˜ì—¬ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.</li>
  <li>ë˜í•œ, í´ë¼ì´ì–¸íŠ¸ì˜ IP ì£¼ì†Œë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ X-Forwarded-For í—¤ë”ë¥¼ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_11.png" alt="20241012_kans_w6_11.png" /></p>

<ul>
  <li>ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ í”„ë¡œí† ì½œì˜ ì •ë³´ë¥¼ ê·¸ë¦¼ìœ¼ë¡œ ë³´ë ¤ë©´ ì•„ë˜ì™€ ê°™ì´ í™˜ê²½ì„¤ì •ì—ì„œ Appearance &gt; Layoutì—ì„œ Pane 3ì— 
â€œPacket Diagramâ€ì„ ì„ íƒí•˜ì‹œë©´ ë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w6/20241012_kans_w6_12.png" alt="20241012_kans_w6_12.png" class="w-80 image-center" /></li>
</ul>

<h4 id="nginx-ë¶„ì‚°-ì•Œê³ ë¦¬ì¦˜-ë³€ê²½">Nginx ë¶„ì‚° ì•Œê³ ë¦¬ì¦˜ ë³€ê²½</h4>

<ul>
  <li>nginxëŠ” ê¸°ë³¸ RR(Round Robin) ë°©ì‹ìœ¼ë¡œ ë¶€í•˜ë¶„ì‚°ì„ ìˆ˜í–‰í•˜ì§€ë§Œ, IP-Hashë‚˜ Session Cookie ì„¤ì •ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>íŠ¹íˆ IP-Hash ë‚˜ Session Cookieë¥¼ ì‚¬ìš©í•˜ë©´ ê° í´ë¼ì´ì–¸íŠ¸ì—ì„œ ëŒ€ìƒ íŒŒë“œë¥¼ ê³ ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ ë³€ê²½í•˜ê¸° ìœ„í•´ì„œëŠ” <code class="language-plaintext highlighter-rouge">nginx.ingress.kubernetes.io/upstream-hash-by</code> annotationì„ ì‚¬ìš©í•˜ì—¬ ë³€ê²½í•˜ì—¬ì•¼ í•˜ëŠ”ë° ì‹¤ìŠµì„ í†µí•´ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># mypc</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYIP</span>:30080/admin | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;   51 Hostname: deploy3-adminsrv-7c8f8b8c87-4sqmh</span>
<span class="c">#      49 Hostname: deploy3-adminsrv-7c8f8b8c87-4mzv7</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$MYIP</span>:30080/admin | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="nb">date</span> <span class="s2">"+%Y-%m-%d %H:%M:%S"</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>

<span class="c"># ì•„ë˜ ingress ì„¤ì • ì¤‘ IP-Hash ì„¤ì • &gt; # ì£¼ì„ ì œê±°</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/#nginx.ingress/nginx.ingress/g'</span> ingress1.yml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ingress1.yml
<span class="c"># =&gt; ingress.networking.k8s.io/ingress-1 configured</span>

<span class="c"># ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYIP</span>:30080/admin | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;  100 Hostname: deploy3-adminsrv-7c8f8b8c87-4sqmh</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$MYIP</span>:30080/admin | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="nb">date</span> <span class="s2">"+%Y-%m-%d %H:%M:%S"</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>

<span class="c"># ë‹¤ì‹œ ì›ë³µ(ë¼ìš´ë“œ ë¡œë¹ˆ) &gt; # ì£¼ì„ ì¶”ê°€</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/nginx.ingress/#nginx.ingress/g'</span> ingress1.yml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ingress1.yml
<span class="c"># =&gt; ingress.networking.k8s.io/ingress-1 configured</span>

<span class="c"># ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYIP</span>:30080/admin | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;   50 Hostname: deploy3-adminsrv-7c8f8b8c87-4sqmh</span>
<span class="c">#      50 Hostname: deploy3-adminsrv-7c8f8b8c87-4mzv7</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$MYIP</span>:30080/admin | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="nb">date</span> <span class="s2">"+%Y-%m-%d %H:%M:%S"</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>ip-hash ì„¤ì •ì„ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì˜ IP ì£¼ì†Œë¥¼ í•´ì‹±í•˜ì—¬ íŠ¹ì • íŒŒë“œë¡œ ì ‘ì†ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì˜¤ë¸Œì íŠ¸ ì‚­ì œ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete deployments,svc,ingress <span class="nt">--all</span>
</code></pre></div></div>

<h4 id="host-ê¸°ë°˜-ë¼ìš°íŒ…">Host ê¸°ë°˜ ë¼ìš°íŒ…</h4>

<ul>
  <li>ingress2.yml íŒŒì¼ ìƒì„±</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ingressClassName</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">kans.com</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">svc3-admin</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">8080</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*.kans.com"</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/echo</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">svc3-admin</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div></div>

<ul>
  <li>ingress ì •ì±… ìƒì„±</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„1</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get ingresses,svc,ep,pod -owide'</span>

<span class="c"># ë„ë©”ì¸ ë³€ê²½</span>
<span class="c"># $ MYDOMAIN1=&lt;ê°ì ìì‹ ì˜ ë‹‰ë„¤ì„ì˜ ë„ë©”ì¸&gt; ì˜ˆì‹œ) gasida.com</span>
<span class="nv">$ MYDOMAIN1</span><span class="o">=</span>sweetlittlebird.com
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/kans.com/</span><span class="nv">$MYDOMAIN1</span><span class="s2">/g"</span> ingress2.yaml

<span class="c"># ìƒì„±</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ingress2.yaml,svc3-pod.yaml
<span class="c"># =&gt; ingress.networking.k8s.io/ingress-2 created</span>
<span class="c">#    deployment.apps/deploy3-adminsrv created</span>
<span class="c">#    service/svc3-admin created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get ingress
<span class="c"># =&gt; NAME        CLASS   HOSTS                                       ADDRESS         PORTS   AGE</span>
<span class="c">#    ingress-2   nginx   sweetlittlebird.com,*.sweetlittlebird.com   10.10.200.113   80      14s</span>
<span class="nv">$ </span>kubectl describe ingress ingress-2
<span class="nv">$ </span>kubectl describe ingress ingress-2 | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s2">"5, </span><span class="se">\$</span><span class="s2">p"</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Default backend:  &amp;lt;default&amp;gt;</span>
<span class="c">#    Rules:</span>
<span class="c">#      Host                   Path    Backends</span>
<span class="c">#      ----                   ----    --------</span>
<span class="c">#      sweetlittlebird.com    /       svc3-admin:8080 ()</span>
<span class="c">#      *.sweetlittlebird.com  /echo   svc3-admin:8080 ()</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>Host ê¸°ë°˜ ë¼ìš°íŒ…ì„ í†µí•´ ì„œë¹„ìŠ¤ì— ì ‘ì†í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë¡œê·¸ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>kubetail <span class="nt">-n</span> ingress <span class="nt">-l</span> app.kubernetes.io/component<span class="o">=</span>controller
<span class="c"># =&gt; Will tail 1 logs...</span>
<span class="c">#    ingress-nginx-controller-7b67846f8f-jdt65</span>
<span class="c"># =&gt; [ingress-nginx-controller-7b67846f8f-jdt65] 192.168.10.1 - - [01/Jan/2024:13:52:42 +0000] &amp;quot;GET / HTTP/1.1&amp;quot; 200 677 &amp;quot;-&amp;quot; &amp;quot;curl/8.5.0&amp;quot; 88 0.002 [default-svc3-admin-8080] [] 172.16.3.10:8080 852 0.002 200 f22ddba305f55138796fc866f7416890</span>
<span class="c">#    [ingress-nginx-controller-7b67846f8f-jdt65] 192.168.10.1 - - [01/Jan/2024:13:53:47 +0000] &amp;quot;GET /admin HTTP/1.1&amp;quot; 200 687 &amp;quot;-&amp;quot; &amp;quot;curl/8.5.0&amp;quot; 93 0.002 [default-svc3-admin-8080] [] 172.16.2.10:8080 863 0.002 200 966f7a55060f1497eed20818d4bef890</span>
<span class="c">#    ...</span>

<span class="nt">------------</span>
<span class="c"># ìì‹ ì˜ PC ì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="c"># svc3-admin ì ‘ì† &gt; ê²°ê³¼ í™•ì¸ : ì™œ ì ‘ì†ì´ ë˜ì§€ ì•ŠëŠ”ê°€? HTTP í—¤ë”ì— Host í•„ë“œë¥¼ ì˜ í™•ì¸í•´ë³´ì!</span>
<span class="nv">$ </span>curl <span class="nv">$MYIP</span>:30080 <span class="nt">-v</span>
<span class="nv">$ </span>curl <span class="nv">$MYIP</span>:30080/echo <span class="nt">-v</span>

<span class="c"># mypcì—ì„œ ì ‘ì†ì„ ìœ„í•œ ì„¤ì •</span>
<span class="c">## /etc/hosts ìˆ˜ì • : ë„ë©”ì¸ ì´ë¦„ìœ¼ë¡œ ì ‘ì†í•˜ê¸° ìœ„í•´ì„œ ë³€ìˆ˜ ì§€ì •</span>
<span class="c">## ìœˆë„ìš° C:\Windows\System32\drivers\etc\hosts</span>
<span class="c">## ë§¥ sudo vim /etc/hosts</span>
<span class="c"># $ MYDOMAIN1=&lt;ê°ì ìì‹ ì˜ ë‹‰ë„¤ì„ì˜ ë„ë©”ì¸&gt;</span>
<span class="c"># $ MYDOMAIN2=&lt;test.ê°ì ìì‹ ì˜ ë‹‰ë„¤ì„ì˜ ë„ë©”ì¸&gt;</span>
<span class="nv">$ MYDOMAIN1</span><span class="o">=</span>sweetlittlebird.com
<span class="nv">$ MYDOMAIN2</span><span class="o">=</span>test.sweetlittlebird.com
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$MYIP</span> <span class="nv">$MYDOMAIN1</span> <span class="nv">$MYDOMAIN2</span>
<span class="c"># =&gt; 192.168.10.10 sweetlittlebird.com test.sweetlittlebird.com</span>

<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$MYIP</span><span class="s2"> </span><span class="nv">$MYDOMAIN1</span><span class="s2">"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$MYIP</span><span class="s2"> </span><span class="nv">$MYDOMAIN2</span><span class="s2">"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts | <span class="nb">grep</span> <span class="nv">$MYDOMAIN1</span>
<span class="c"># =&gt; 192.168.10.10 sweetlittlebird.com</span>
<span class="c">#    192.168.10.10 test.sweetlittlebird.com</span>

<span class="c"># svc3-admin ì ‘ì† &gt; ê²°ê³¼ í™•ì¸</span>
<span class="nv">$ </span>curl <span class="nv">$MYDOMAIN1</span>:30080 <span class="nt">-v</span>
<span class="c"># =&gt; * Host sweetlittlebird.com:30080 was resolved.</span>
<span class="c">#    * IPv4: 192.168.10.10</span>
<span class="c">#    *   Trying 192.168.10.10:30080...</span>
<span class="c">#    * Connected to sweetlittlebird.com (192.168.10.10) port 30080</span>
<span class="c">#    &amp;gt; GET / HTTP/1.1</span>
<span class="c">#    &amp;gt; Host: sweetlittlebird.com:30080</span>
<span class="c">#    &amp;gt; User-Agent: curl/8.5.0</span>
<span class="c">#    &amp;gt; Accept: */*</span>
<span class="c">#    &amp;gt;</span>
<span class="c">#    &amp;lt; HTTP/1.1 200 OK</span>
<span class="c">#    &amp;lt; Date: Sat, 01 Jan 2024 13:52:42 GMT</span>
<span class="c">#    &amp;lt; Content-Type: text/plain</span>
<span class="c">#    &amp;lt; Transfer-Encoding: chunked</span>
<span class="c">#    &amp;lt; Connection: keep-alive</span>
<span class="c">#    &amp;lt;</span>
<span class="c">#    </span>
<span class="c">#    Hostname: deploy3-adminsrv-7c8f8b8c87-48xwp</span>
<span class="c">#    </span>
<span class="c">#    Pod Information:</span>
<span class="c">#            -no pod information available-</span>
<span class="c">#    </span>
<span class="c">#    Server values:</span>
<span class="c">#            server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#    </span>
<span class="c">#    Request Information:</span>
<span class="c">#            client_address=172.16.0.16</span>
<span class="c">#            method=GET</span>
<span class="c">#            real path=/</span>
<span class="c">#            query=</span>
<span class="c">#            request_version=1.1</span>
<span class="c">#            request_uri=http://sweetlittlebird.com:8080/</span>
<span class="c">#    </span>
<span class="c">#    Request Headers:</span>
<span class="c">#            accept=*/*</span>
<span class="c">#            host=sweetlittlebird.com:30080</span>
<span class="c">#            user-agent=curl/8.5.0</span>
<span class="c">#            x-forwarded-for=192.168.10.1</span>
<span class="c">#            x-forwarded-host=sweetlittlebird.com:30080</span>
<span class="c">#            x-forwarded-port=80</span>
<span class="c">#            x-forwarded-proto=http</span>
<span class="c">#            ...</span>
<span class="nv">$ </span>curl <span class="nv">$MYDOMAIN1</span>:30080/admin
<span class="c"># =&gt; </span>
<span class="c">#    </span>
<span class="c">#    Hostname: deploy3-adminsrv-7c8f8b8c87-bm7dq</span>
<span class="c">#            ...</span>
<span class="c">#            client_address=172.16.0.16</span>
<span class="c">#            method=GET</span>
<span class="c">#            real path=/admin</span>
<span class="c">#            ...</span>
<span class="c">#            request_uri=http://sweetlittlebird.com:8080/admin</span>
<span class="c">#    </span>
<span class="c">#    Request Headers:</span>
<span class="c">#            accept=*/*</span>
<span class="c">#            host=sweetlittlebird.com:30080</span>
<span class="c">#            user-agent=curl/8.5.0</span>
<span class="c">#            x-forwarded-for=192.168.10.1</span>
<span class="c">#            x-forwarded-host=sweetlittlebird.com:30080</span>
<span class="c">#            x-forwarded-port=80</span>
<span class="c">#            x-forwarded-proto=http</span>
<span class="c">#            x-forwarded-scheme=http</span>
<span class="c">#            ...</span>
<span class="nv">$ </span>curl <span class="nv">$MYDOMAIN1</span>:30080/echo
<span class="c"># =&gt; Hostname: deploy3-adminsrv-7c8f8b8c87-ndwkj</span>
<span class="c">#            ...</span>
<span class="c">#            client_address=172.16.0.16</span>
<span class="c">#            method=GET</span>
<span class="c">#            real path=/echo</span>
<span class="c">#            ...</span>
<span class="c">#            request_uri=http://sweetlittlebird.com:8080/echo</span>
<span class="c">#    </span>
<span class="c">#    Request Headers:</span>
<span class="c">#            accept=*/*</span>
<span class="c">#            host=sweetlittlebird.com:30080</span>
<span class="c">#            user-agent=curl/8.5.0</span>
<span class="c">#            x-forwarded-for=192.168.10.1</span>
<span class="c">#            x-forwarded-host=sweetlittlebird.com:30080</span>
<span class="c">#            x-forwarded-port=80</span>
<span class="c">#            x-forwarded-proto=http</span>
<span class="c">#            x-forwarded-scheme=http</span>
<span class="c">#            ...    </span>
<span class="nv">$ </span>curl <span class="nv">$MYDOMAIN1</span>:30080/echo/1
<span class="c"># =&gt; Hostname: deploy3-adminsrv-7c8f8b8c87-48xwp</span>
<span class="c">#    </span>
<span class="c">#    Pod Information:</span>
<span class="c">#            -no pod information available-</span>
<span class="c">#    </span>
<span class="c">#    Server values:</span>
<span class="c">#            server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#    </span>
<span class="c">#    Request Information:</span>
<span class="c">#            client_address=172.16.0.16</span>
<span class="c">#            method=GET</span>
<span class="c">#            real path=/echo/1</span>
<span class="c">#            query=</span>
<span class="c">#            request_version=1.1</span>
<span class="c">#            request_uri=http://sweetlittlebird.com:8080/echo/1</span>
<span class="c">#            ...</span>

<span class="nv">$ </span>curl <span class="nv">$MYDOMAIN2</span>:30080 <span class="nt">-v</span>
<span class="c"># =&gt; * Host test.sweetlittlebird.com:30080 was resolved.</span>
<span class="c">#    * IPv4: 192.168.10.10</span>
<span class="c">#    *   Trying 192.168.10.10:30080...</span>
<span class="c">#    * Connected to test.sweetlittlebird.com (192.168.10.10) port 30080</span>
<span class="c">#    &amp;gt; GET / HTTP/1.1</span>
<span class="c">#    &amp;gt; Host: test.sweetlittlebird.com:30080</span>
<span class="c">#    ...</span>
<span class="c">#    &amp;lt; HTTP/1.1 404 Not Found</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>curl <span class="nv">$MYDOMAIN2</span>:30080/admin
<span class="c"># =&gt; &amp;lt;html&amp;gt;</span>
<span class="c">#    &amp;lt;head&amp;gt;&amp;lt;title&amp;gt;404 Not Found&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;</span>
<span class="c">#    &amp;lt;body&amp;gt;</span>
<span class="c">#    &amp;lt;center&amp;gt;&amp;lt;h1&amp;gt;404 Not Found&amp;lt;/h1&amp;gt;&amp;lt;/center&amp;gt;</span>
<span class="c">#    &amp;lt;hr&amp;gt;&amp;lt;center&amp;gt;nginx&amp;lt;/center&amp;gt;</span>
<span class="c">#    &amp;lt;/body&amp;gt;</span>
<span class="c">#    &amp;lt;/html&amp;gt;</span>
<span class="nv">$ </span>curl <span class="nv">$MYDOMAIN2</span>:30080/echo
<span class="c"># =&gt; Hostname: deploy3-adminsrv-7c8f8b8c87-ndwkj</span>
<span class="c">#    </span>
<span class="c">#    Pod Information:</span>
<span class="c">#            -no pod information available-</span>
<span class="c">#    </span>
<span class="c">#    Server values:</span>
<span class="c">#            server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#    </span>
<span class="c">#    Request Information:</span>
<span class="c">#            client_address=172.16.0.16</span>
<span class="c">#            method=GET</span>
<span class="c">#            real path=/echo</span>
<span class="c">#            ...</span>
<span class="c">#            request_uri=http://test.sweetlittlebird.com:8080/echo</span>
<span class="c">#    </span>
<span class="c">#    Request Headers:</span>
<span class="c">#            accept=*/*</span>
<span class="c">#            host=test.sweetlittlebird.com:30080</span>
<span class="c">#            user-agent=curl/8.5.0</span>
<span class="c">#            x-forwarded-for=192.168.10.1</span>
<span class="c">#            x-forwarded-host=test.sweetlittlebird.com:30080</span>
<span class="c">#            x-forwarded-port=80</span>
<span class="c">#            x-forwarded-proto=http</span>
<span class="c">#            x-forwarded-scheme=http</span>
<span class="c">#            ...</span>
<span class="nv">$ </span>curl <span class="nv">$MYDOMAIN2</span>:30080/echo/1
<span class="nv">$ </span>curl <span class="nv">$MYDOMAIN2</span>:30080/echo/1/2

<span class="c">## (ì˜µì…˜) /etc/hosts íŒŒì¼ ë³€ê²½ ì—†ì´ ì ‘ì† ë°©ì•ˆ</span>
<span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"host: </span><span class="nv">$MYDOMAIN1</span><span class="s2">"</span> <span class="nv">$MYIP</span>:30080
<span class="c"># =&gt; (ì •ìƒ)</span>
<span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"host: </span><span class="nv">$MYDOMAIN2</span><span class="s2">"</span> <span class="nv">$MYIP</span>:30080
<span class="c"># =&gt; (404 ì—ëŸ¬)</span>
<span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"host: </span><span class="nv">$MYDOMAIN2</span><span class="s2">"</span> <span class="nv">$MYIP</span>:30080/echo
<span class="c"># =&gt; (ì •ìƒ ì‘ë‹µ ì˜´)</span>
</code></pre></div></div>

<ul>
  <li>ì‹¤ìŠµê²°ê³¼ sweetlittlebird.comìœ¼ë¡œëŠ” ëª¨ë“  ì‘ë‹µì´ 200 OK ì‘ë‹µì´ ì˜¤ê³ ,
test.sweetlittlebird.comìœ¼ë¡œ ì ‘ì†ì‹œì—ëŠ” /echo ê²½ë¡œë¡œ ì ‘ì†í•´ì•¼ë§Œ 200 OK ì‘ë‹µì´ ì˜¤ê³ , ê·¸ ì™¸ì˜ ê²½ë¡œë¡œ ì ‘ì†ì‹œì—ëŠ” 404 ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì•„ë˜ì˜ ë£°ëŒ€ë¡œ ì˜ ì ‘ì†ì´ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># sweetlittlebird.comì´ë¼ëŠ” í˜¸ìŠ¤íŠ¸ë¡œ ì ‘ì†ì‹œ ëª¨ë“  ê²½ë¡œì— ëŒ€í•´ì„œ 200 OK ì‘ë‹µ</span>
sweetlittlebird.com    /       svc3-admin:8080   
  
<span class="c"># test.sweetlittlebird.com ì²˜ëŸ¼ ì„œë¸Œ ë„ë©”ì¸ì´ ìˆëŠ” í˜¸ìŠ¤íŠ¸ëª…ìœ¼ë¡œ ì ‘ì†ì‹œ /echo ê²½ë¡œë¡œë§Œ 200 OK ì‘ë‹µ</span>
<span class="k">*</span>.sweetlittlebird.com  /echo   svc3-admin:8080   
</code></pre></div>    </div>
  </li>
  <li>ì˜¤ë¸Œì íŠ¸ ì‚­ì œ
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete deployments,svc,ingress <span class="nt">--all</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="ì¹´ë‚˜ë¦¬-ì—…ë°ì´íŠ¸">ì¹´ë‚˜ë¦¬ ì—…ë°ì´íŠ¸</h4>

<ul>
  <li>ì¹´ë‚˜ë¦¬ ì—…ë°ì´íŠ¸ëŠ” ìƒˆë¡œìš´ ë²„ì „ì˜ íŒŒë“œë¥¼  ë°°í¬í•˜ê³ , ì¼ë¶€ íŠ¸ë˜í”½ë§Œ ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ ì „í™˜í•˜ê³ , ìƒˆë¡œìš´ ë²„ì „ì˜ ì •ìƒë™ì‘ í™•ì¸ í›„ ì „ì²´ë¥¼ ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ ì „í™˜í•˜ëŠ” ì—…ë°ì´íŠ¸ ë°©ì‹ì…ë‹ˆë‹¤.</li>
  <li>ë°°í¬ ìë™í™”ì‹œ ìµœì†Œ ì¤‘ë‹¨/ë¬´ì¤‘ë‹¨ìœ¼ë¡œ í•˜ëŠ” ë°©ë²•ì„ ëª‡ê°€ì§€ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.
    <ol>
      <li>ë¡¤ë§ ì—…ë°ì´íŠ¸
  <img src="/assets/2024/kans-3th/w6/20241012_kans_w6_13.png" alt="img.png" class="w-80 image-center" />
        <ul>
          <li>íŒŒë“œë¥¼ í•˜ë‚˜ì”© ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ êµì²´í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ, ê¸°ì¡´ ë²„ì „ì˜ íŒŒë“œê°€ ì •ìƒë™ì‘í•˜ëŠ”ì§€ í™•ì¸ í›„ ë‹¤ìŒ íŒŒë“œë¡œ êµì²´í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ì¹´ë‚˜ë¦¬ ì—…ë°ì´íŠ¸
  <img src="/assets/2024/kans-3th/w6/20241012_kans_w6_14.png" alt="img_1.png" class="w-80 image-center" />
        <ul>
          <li>ì¼ë¶€ íŠ¸ë˜í”½ì„ ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ ì „í™˜í•˜ê³ , ì •ìƒë™ì‘ í™•ì¸ í›„ ì „ì²´ë¡œ ì „í™˜í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ë¸”ë£¨/ê·¸ë¦° ì—…ë°ì´íŠ¸
  <img src="/assets/2024/kans-3th/w6/20241012_kans_w6_15.png" alt="img_2.png" class="w-80 image-center" />
        <ul>
          <li>ìƒˆë¡œìš´ ë²„ì „ì˜ íŒŒë“œë¥¼ ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ë¡œ ë°°í¬í•˜ê³ , ëª¨ë“  íŒŒë“œ ë°°í¬ í›„, í•˜ë‚˜ì”© ì „í™˜í•˜ëŠ” ë¡¤ë§ ì—…ë°ì´íŠ¸ì™€ëŠ” ë‹¤ë¥´ê²Œ ì „ì²´ íŠ¸ë˜í”½ì„ í•œêº¼ë²ˆì— ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ë¡œ ì „í™˜í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ol>
  </li>
  <li>ì‹¤ìŠµì„ í†µí•´ nginx ingress controllerë¥¼ ì´ìš©í•œ ì¹´ë‚˜ë¦¬ ì—…ë°ì´íŠ¸ë¥¼ ì§„í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>
        <p>canary-svc1-pod.yml íŒŒì¼ ìƒì„±</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dp-v1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">svc-v1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">svc-v1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pod-v1</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">k8s.gcr.io/echoserver:1.5</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">svc-v1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">web-port</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">9001</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">svc-v1</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>canary-svc2-pod.yml íŒŒì¼ ìƒì„±</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dp-v2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">svc-v2</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">svc-v2</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pod-v2</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">k8s.gcr.io/echoserver:1.6</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">svc-v2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">web-port</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">9001</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">svc-v2</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ìƒì„± ë° í™•ì¸</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„1</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get ingress,svc,ep,pod -owide'</span>
    
<span class="c"># ìƒì„±</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> canary-svc1-pod.yml,canary-svc2-pod.yml
<span class="c"># =&gt; deployment.apps/dp-v1 created</span>
<span class="c">#    service/svc-v1 created</span>
<span class="c">#    deployment.apps/dp-v2 created</span>
<span class="c">#    service/svc-v2 created</span>
    
<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc,ep,pod
<span class="c"># =&gt; NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/kubernetes   ClusterIP   10.10.200.1     &amp;lt;none&amp;gt;        443/TCP    12m</span>
<span class="c">#    service/svc-v1       ClusterIP   10.10.200.231   &amp;lt;none&amp;gt;        9001/TCP   18s</span>
<span class="c">#    service/svc-v2       ClusterIP   10.10.200.216   &amp;lt;none&amp;gt;        9001/TCP   18s</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                                            AGE</span>
<span class="c">#    endpoints/kubernetes   192.168.10.10:6443                                   12m</span>
<span class="c">#    endpoints/svc-v1       172.16.1.10:8080,172.16.2.12:8080,172.16.3.11:8080   18s</span>
<span class="c">#    endpoints/svc-v2       172.16.1.11:8080,172.16.2.11:8080,172.16.3.12:8080   18s</span>
<span class="c">#    </span>
<span class="c">#    NAME                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/dp-v1-8684d45558-22nbv   1/1     Running   0          18s</span>
<span class="c">#    pod/dp-v1-8684d45558-59pnl   1/1     Running   0          18s</span>
<span class="c">#    pod/dp-v1-8684d45558-87xrs   1/1     Running   0          18s</span>
<span class="c">#    pod/dp-v2-7757c4bdc-5xmcm    1/1     Running   0          18s</span>
<span class="c">#    pod/dp-v2-7757c4bdc-bm2gq    1/1     Running   0          18s</span>
<span class="c">#    pod/dp-v2-7757c4bdc-h7fzl    1/1     Running   0          18s</span>
    
<span class="c"># íŒŒë“œ ë²„ì „ í™•ì¸: 1.13.0 vs 1.13.1</span>
<span class="nv">$ </span><span class="k">for </span>pod <span class="k">in</span> <span class="si">$(</span>kubectl get pod <span class="nt">-o</span> wide <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>svc-v1 |awk <span class="s1">'NR&gt;1 {print $6}'</span><span class="si">)</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$pod</span>:8080 | egrep <span class="s1">'(Hostname|nginx)'</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Hostname: dp-v1-8684d45558-22nbv</span>
<span class="c">#     server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>pod <span class="k">in</span> <span class="si">$(</span>kubectl get pod <span class="nt">-o</span> wide <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>svc-v2 |awk <span class="s1">'NR&gt;1 {print $6}'</span><span class="si">)</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$pod</span>:8080 | egrep <span class="s1">'(Hostname|nginx)'</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Hostname: dp-v2-7757c4bdc-5xmcm</span>
<span class="c">#     server_version=nginx: 1.13.1 - lua: 10008</span>
<span class="c">#    ...		</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>canary-ingress1.yml</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-canary-v1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ingressClassName</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">kans.com</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">svc-v1</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>canary-ingress2.yml</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-canary-v2</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">nginx.ingress.kubernetes.io/canary</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="na">nginx.ingress.kubernetes.io/canary-weight</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ingressClassName</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">kans.com</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">svc-v2</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì¹´ë‚˜ë¦¬ ì—…ê·¸ë ˆì´ë“œ í™•ì¸</p>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„1</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get ingress,svc,ep'</span>
    
<span class="c"># ë„ë©”ì¸ ë³€ê²½</span>
<span class="c"># $ MYDOMAIN1=&lt;ê°ì ìì‹ ì˜ ë‹‰ë„¤ì„ì˜ ë„ë©”ì¸&gt; ì˜ˆì‹œ) gasida.com</span>
<span class="nv">$ MYDOMAIN1</span><span class="o">=</span>sweetlittlebird.com
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/kans.com/</span><span class="nv">$MYDOMAIN1</span><span class="s2">/g"</span> canary-ingress1.yml
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/kans.com/</span><span class="nv">$MYDOMAIN1</span><span class="s2">/g"</span> canary-ingress2.yml
    
<span class="c"># ìƒì„±</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> canary-ingress1.yml,canary-ingress2.yml
<span class="c"># =&gt; ingress.networking.k8s.io/ingress-canary-v1 created</span>
<span class="c">#    ingress.networking.k8s.io/ingress-canary-v2 created</span>
    
<span class="c"># ë¡œê·¸ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>kubetail <span class="nt">-n</span> ingress <span class="nt">-l</span> app.kubernetes.io/component<span class="o">=</span>controller
    
<span class="c"># ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN1</span>:30080
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN1</span>:30080 | <span class="nb">grep </span>nginx
<span class="c"># =&gt; &amp;lt;hr&amp;gt;&amp;lt;center&amp;gt;nginx&amp;lt;/center&amp;gt;</span>
    
<span class="c"># ì ‘ì† ì‹œ v1 v2 ë²„ì „ë³„ ë¹„ìœ¨ì´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”? ì™œ ì´ë ‡ê²Œ ë˜ë‚˜ìš”?</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN1</span>:30080 | <span class="nb">grep </span>nginx <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      84         server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#         16         server_version=nginx: 1.13.1 - lua: 10008</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..1000<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN1</span>:30080 | <span class="nb">grep </span>nginx <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;     919         server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#         81         server_version=nginx: 1.13.1 - lua: 10008</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$MYDOMAIN1</span>:30080 | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">date</span> <span class="s2">"+%Y-%m-%d %H:%M:%S"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ v2ì˜ canary ë¹„ìœ¨ì„ 10%ë¡œ ë‘ì–´ì„œ ê·¸ë ‡ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
    
<span class="c"># ë¹„ìœ¨ ì¡°ì •í•˜ì—¬ ì ˆë°˜ì„ v2ë¡œ ì „í™˜í•˜ê² ìŠµë‹ˆë‹¤. &gt;&gt; ê°œë°œ ë°°í¬ ë²„ì „ ì „ëµì— ìœ ìš©í•˜ë‹¤!</span>
<span class="nv">$ </span>kubectl annotate <span class="nt">--overwrite</span> ingress ingress-canary-v2 nginx.ingress.kubernetes.io/canary-weight<span class="o">=</span>50
    
<span class="c"># ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN1</span>:30080 | <span class="nb">grep </span>nginx <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      53         server_version=nginx: 1.13.1 - lua: 10008</span>
<span class="c">#         47         server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..1000<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN1</span>:30080 | <span class="nb">grep </span>nginx <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;     526         server_version=nginx: 1.13.1 - lua: 10008</span>
<span class="c">#        474         server_version=nginx: 1.13.0 - lua: 10008</span>
        
<span class="c"># (ì˜µì…˜) ë¹„ìœ¨ ì¡°ì • &lt;&lt; ì–´ë–»ê²Œ ë¹„ìœ¨ì´ ì¡°ì •ë ê¹Œìš”?</span>
<span class="nv">$ </span>kubectl annotate <span class="nt">--overwrite</span> ingress ingress-canary-v2 nginx.ingress.kubernetes.io/canary-weight<span class="o">=</span>100
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN1</span>:30080 | <span class="nb">grep </span>nginx <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;    100         server_version=nginx: 1.13.1 - lua: 10008</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì¹´ë‚˜ë¦¬ ë¹„ìœ¨ì„ 100%ë¡œ í•˜ë‹ˆ v2ë²„ì „ìœ¼ë¡œ 100% ì „í™˜ ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
    
<span class="c"># (ì˜µì…˜) ë¹„ìœ¨ ì¡°ì • &lt;&lt; ì–´ë–»ê²Œ ë¹„ìœ¨ì´ ì¡°ì •ë ê¹Œìš”?</span>
<span class="nv">$ </span>kubectl annotate <span class="nt">--overwrite</span> ingress ingress-canary-v2 nginx.ingress.kubernetes.io/canary-weight<span class="o">=</span>0
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN1</span>:30080 | <span class="nb">grep </span>nginx <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;     100         server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì¹´ë‚˜ë¦¬ ë¹„ìœ¨ì„ 0%ë¡œ í•˜ë‹ˆ v2ë²„ì „ìœ¼ë¡œ 0% ë¡œ ì „í™˜ ë˜ê³  ëª¨ë“  íŠ¸ë˜í”½ì´ v1ìœ¼ë¡œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>ì˜¤ë¸Œì íŠ¸ ì‚­ì œ
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete deployments,svc,ingress <span class="nt">--all</span>
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="gateway-api">Gateway API</h2>

<h3 id="gateway-api-ì†Œê°œ">Gateway API ì†Œê°œ</h3>

<p>ì•ì„œ Ingressë¥¼ ì‚´í´ë³¼ë•Œ ë§ì”€ë“œë¦°ê²ƒ ì²˜ëŸ¼ IngressëŠ” Frozen ë˜ì–´ì„œ ë”ì´ìƒ ì—…ë°ì´íŠ¸ ë˜ì§€ ì•Šê³ , Gateway APIì— ê¸°ëŠ¥ì„ ì¶”ê°€í•  ê³„íšì´ë¼ê³  í•©ë‹ˆë‹¤.
ì´ì–´ì„œ Gateway APIì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

<p>Gateway APIëŠ” Kubernetesì—ì„œ API Gatewayë¥¼ ì •ì˜í•˜ê³  êµ¬ì„±í•˜ê¸° ìœ„í•œ APIë¥¼ ì œê³µí•˜ëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤. <a href="https://medium.com/@disha.20.10/introduction-to-the-gateway-api-revolutionizing-kubernetes-networking-7b0c9a696038">Gateway API ì†Œê°œ</a>
Gateway APIëŠ” ì„œë¹„ìŠ¤ ë©”ì‹œ(ì˜ˆ) istio ë“±)ì—ì„œ ì œê³µí•˜ëŠ” í’ë¶€í•œ ê¸°ëŠ¥ ì¤‘ ì¼ë¶€ ê¸°ëŠ¥ë“¤ê³¼ ìš´ì˜ ê´€ë¦¬ì— í•„ìš”í•œ ê¸°ëŠ¥ë“¤ì„ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤.
ì¶”ê°€ëœ ê¸°ëŠ¥ì˜ ì˜ˆë¡œëŠ” í—¤ë” ê¸°ë°˜ ë¼ìš°íŒ…, í—¤ë” ë³€ì¡°, íŠ¸ë˜í”½ ë¯¸ëŸ¬ë§(ì‰½ê²Œ íŠ¸ë˜í”½ ë³µì œ), ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ ë“±ì´ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_16.png" alt="img.png" class="w-80 image-center" /></p>

<p>Gateway APIëŠ” ì´ë¥¼ í†µí•´ ë™ì  ì¸í”„ë¼ êµ¬ì„±ì„ ì§€ì›í•˜ê³ , ê³ ê¸‰ íŠ¸ë˜í”½ ë¼ìš°íŒ…ì„ ì§€ì›í•©ë‹ˆë‹¤.</p>

<ul>
  <li>Gateway APIì˜ ì£¼ìš” ê¸°ëŠ¥ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    <ol>
      <li>
        <dl>
          <dt><strong>ê°œì„ ëœ ë¦¬ì†ŒìŠ¤ ëª¨ë¸</strong></dt>
          <dd>APIëŠ” GatewayClass, Gateway ë° Route(HTTPRoute, TCPRoute ë“±)ì™€ ê°™ì€ ìƒˆë¡œìš´ ì‚¬ìš©ì ì •ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ë„ì…í•˜ì—¬ ë¼ìš°íŒ… ê·œì¹™ì„ ì •ì˜í•˜ëŠ” ë³´ë‹¤ ì„¸ë¶€ì ì´ê³  í‘œí˜„ë ¥ ìˆëŠ” ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.</dd>
        </dl>
      </li>
      <li>
        <dl>
          <dt><strong>í”„ë¡œí† ì½œ ë…ë¦½ì </strong></dt>
          <dd>ì£¼ë¡œ HTTPìš©ìœ¼ë¡œ ì„¤ê³„ëœ Ingressì™€ ë‹¬ë¦¬ Gateway APIëŠ” TCP, UDP, TLSë¥¼ í¬í•¨í•œ ì—¬ëŸ¬ í”„ë¡œí† ì½œì„ ì§€ì›í•©ë‹ˆë‹¤.</dd>
        </dl>
      </li>
      <li>
        <dl>
          <dt><strong>ê°•í™”ëœ ë³´ì•ˆ</strong></dt>
          <dd>TLS êµ¬ì„± ë° ë³´ë‹¤ ì„¸ë¶€ì ì¸ ì•¡ì„¸ìŠ¤ ì œì–´ì— ëŒ€í•œ ê¸°ë³¸ ì œê³µ ì§€ì›.</dd>
        </dl>
      </li>
      <li>
        <dl>
          <dt><strong>êµì°¨ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§€ì›</strong></dt>
          <dd>ì„œë¡œ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ì„œë¹„ìŠ¤ë¡œ íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…í•˜ì—¬ ë³´ë‹¤ ìœ ì—°í•œ ì•„í‚¤í…ì²˜ë¥¼ êµ¬ì¶•í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</dd>
        </dl>
      </li>
      <li>
        <dl>
          <dt><strong>í™•ì¥ì„±</strong></dt>
          <dd>APIëŠ” ì‚¬ìš©ì ì •ì˜ ë¦¬ì†ŒìŠ¤ ë° ì •ì±…ìœ¼ë¡œ ì‰½ê²Œ í™•ì¥í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.</dd>
        </dl>
      </li>
      <li>
        <dl>
          <dt><strong>ì—­í•  ì§€í–¥</strong></dt>
          <dd>í´ëŸ¬ìŠ¤í„° ìš´ì˜ì, ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œì, ë³´ì•ˆ íŒ€ ê°„ì˜ ìš°ë ¤ë¥¼ ëª…í™•í•˜ê²Œ ë¶„ë¦¬í•©ë‹ˆë‹¤.</dd>
        </dl>
      </li>
    </ol>
  </li>
  <li>ë‹¤ìŒì˜ êµ¬ì„±ìš”ì†Œ (Resource)ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
    <ul>
      <li>GatewayClass, Gateway, HTTPRoute, TCPRoute, Service
<img src="/assets/2024/kans-3th/w6/20241012_kans_w6_17.png" alt="img.png" />
        <ul>
          <li><strong>GatewayClass:</strong> ê³µí†µ êµ¬ì„±ì„ ê°€ì§„ ê²Œì´íŠ¸ì›¨ì´ ì„¸íŠ¸ë¥¼ ì •ì˜í•˜ê³  í´ë˜ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì— ì˜í•´ ê´€ë¦¬ë©ë‹ˆë‹¤.</li>
          <li><strong>Gateway:</strong> í´ë¼ìš°ë“œ ë¡œë“œ ë°¸ëŸ°ì„œì™€ ê°™ì€ íŠ¸ë˜í”½ ì²˜ë¦¬ ì¸í”„ë¼ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.</li>
          <li><strong>HTTPRoute:</strong> Gateway ë¦¬ìŠ¤ë„ˆì—ì„œ ë°±ì—”ë“œ ë„¤íŠ¸ì›Œí¬ ì—”ë“œí¬ì¸íŠ¸ì˜ í‘œí˜„ìœ¼ë¡œ íŠ¸ë˜í”½ì„ ë§¤í•‘í•˜ê¸° ìœ„í•œ HTTP ì „ìš© ê·œì¹™ì„ ì •ì˜í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì—”ë“œí¬ì¸íŠ¸ëŠ” ì¢…ì¢… <a href="https://kubernetes.io/docs/concepts/services-networking/service/">Service</a>ë¡œ í‘œí˜„ë©ë‹ˆë‹¤<br />
<img src="/assets/2024/kans-3th/w6/20241012_kans_w6_18.png" alt="img.png" class="image-center" />
<em class="image-caption">ì¶œì²˜ : <a href="https://gateway-api.sigs.k8s.io/">https://gateway-api.sigs.k8s.io/</a></em></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ë¦¬í€˜ìŠ¤íŠ¸ íë¦„
<img src="/assets/2024/kans-3th/w6/20241012_kans_w6_19.svg" alt="20241012_kans_w6_19.svg" /></li>
  <li>role-oriented  API ê°€ ì¤‘ìš”í•œ ì´ìœ 
    <ul>
      <li>ë‹´ë‹¹ ì—…ë¬´ì˜ ì—­í• ì— ë”°ë¼ì„œ ë™ì‘/ê¶Œí•œì„ ìœ ì—°í•˜ê²Œ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ì•„ë˜ ê·¸ë¦¼ ì²˜ëŸ¼ â€˜ìŠ¤í† ì–´ ê°œë°œìâ€™ëŠ” Store ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë‚´ì—ì„œ í•´ë‹¹ store PATH ë¼ìš°íŒ… ê´€ë ¨ ì •ì±…ì„ ìŠ¤ìŠ¤ë¡œ ê´€ë¦¬ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w6/20241012_kans_w6_20.png" alt="img.png" /></li>
      <li>ì—­í• ì˜ ì˜ˆì‹œì…ë‹ˆë‹¤.
        <ul>
          <li><strong>ì¸í”„ë¼ ì œê³µì:</strong> ì—¬ëŸ¬ ê²©ë¦¬ëœ í´ëŸ¬ìŠ¤í„°ê°€ ì—¬ëŸ¬ í…Œë„ŒíŠ¸ë¥¼ ì„œë¹„ìŠ¤í•  ìˆ˜ ìˆë„ë¡ ì¸í”„ë¼ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. ì˜ˆ: í´ë¼ìš°ë“œ ì œê³µì.</li>
          <li><strong>í´ëŸ¬ìŠ¤í„° ìš´ì˜ì:</strong> í´ëŸ¬ìŠ¤í„°ë¥¼ ê´€ë¦¬í•˜ë©° ì£¼ë¡œ ì •ì±…, ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼, ì• í”Œë¦¬ì¼€ì´ì…˜ ê¶Œí•œ ë“±ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
          <li><strong>ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œì:</strong> í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê´€ë¦¬í•˜ë©° ì£¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì¤€ì˜ êµ¬ì„± ë° <a href="https://kubernetes.io/docs/concepts/services-networking/service/">ì„œë¹„ìŠ¤</a> êµ¬ì„±ì— ê´€ì‹¬ì´ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ì¶”ì²œê¸€
    <ul>
      <li><a href="https://www.anyflow.net/sw-engineer/kubernetes-gateway-api-1">Ingress + API Gateway = Kubernetes Gateway API</a></li>
      <li><a href="https://www.anyflow.net/sw-engineer/kubernetes-gateway-api-2">API Gateway + Service Mesh = Kubernetes Gateway API</a></li>
    </ul>
  </li>
</ul>

<h3 id="gloo-gateway">Gloo Gateway</h3>

<p>Gloo GatewayëŠ” Solo.ioì—ì„œ ê°œë°œí•œ API Gatewayë¡œ, Gateway APIë¥¼ êµ¬í˜„í•œ ëŒ€í‘œì ì¸ ì œí’ˆ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. 
Gloo GatewayëŠ” ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì–´ ìˆìœ¼ë©°, ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ì§•ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li><strong>Envoy Proxy ê¸°ë°˜</strong> : Gloo GatewayëŠ” ê³ ì„±ëŠ¥ì˜ Envoy Proxyë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ ë›°ì–´ë‚œ í™•ì¥ì„±ê³¼ ì„±ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li><strong>API ê´€ë¦¬ ë° ë¼ìš°íŒ…</strong> : ë‹¤ì–‘í•œ API ë¼ìš°íŒ… ì˜µì…˜ì„ ì œê³µí•˜ë©°, REST, gRPC, GraphQL ë“±ì˜ ë‹¤ì–‘í•œ í”„ë¡œí† ì½œì„ ì§€ì›í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë³µì¡í•œ íŠ¸ë˜í”½ ê´€ë¦¬ì™€ ë¼ìš°íŒ…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li><strong>ë³´ì•ˆ ê¸°ëŠ¥</strong> : ì¸ì¦, ì¸ê°€, TLS ì•”í˜¸í™”, OAuth, OpenID Connect ë“± ë‹¤ì–‘í•œ ë³´ì•ˆ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ APIë¥¼ ì•ˆì „í•˜ê²Œ ë³´í˜¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>í™•ì¥ì„±</strong> : í”ŒëŸ¬ê·¸ì¸ ì•„í‚¤í…ì²˜ë¥¼ í†µí•´ ì‰½ê²Œ í™•ì¥í•  ìˆ˜ ìˆìœ¼ë©°, ë‹¤ì–‘í•œ ì„œë“œíŒŒí‹° í†µí•©ì„ ì§€ì›í•©ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ê¸°ëŠ¥ì„ í™•ì¥í•˜ê±°ë‚˜ ì‚¬ìš©ì ì •ì˜ ê¸°ëŠ¥ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬</strong> : Kubernetes, Consul, EC2 ë“± ë‹¤ì–‘í•œ ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ ë©”ì»¤ë‹ˆì¦˜ì„ ì§€ì›í•˜ì—¬ ë™ì  í™˜ê²½ì—ì„œë„ íš¨ìœ¨ì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.</li>
  <li><strong>Observability</strong> : íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§, ë¡œê¹…, íŠ¸ë ˆì´ì‹± ë“±ì˜ ê¸°ëŠ¥ì„ ì œê³µí•˜ì—¬ ìš´ì˜ ì¤‘ì¸ ì‹œìŠ¤í…œì˜ ìƒíƒœë¥¼ ì‰½ê²Œ íŒŒì•…í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>ìœ ì—°í•œ</strong> ë°°í¬ : í´ë¼ìš°ë“œ, ì˜¨í”„ë ˆë¯¸ìŠ¤, í•˜ì´ë¸Œë¦¬ë“œ í™˜ê²½ ë“± ë‹¤ì–‘í•œ ë°°í¬ ì˜µì…˜ì„ ì§€ì›í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë‹¤ì–‘í•œ ì¸í”„ë¼ í™˜ê²½ì— ë§ì¶° ìœ ì—°í•˜ê²Œ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="gloo-gateway-architecture">Gloo Gateway Architecture</h4>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_21.png" alt="img.png" /></p>

<ul>
  <li>Envoyë¥¼ í†µí•´ì„œ Httpì˜ L7 ë¼ìš°íŒ…ì„ ì§€ì›í•˜ë©°, Glooì˜ ì—­í• ì€ ë¼ìš°íŒ… ê·œì¹™ì„ ê´€ë¦¬í•˜ê³  Envoyì— ì „ë‹¬í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.</li>
</ul>

<p>Gloo GatewayëŠ” ë‚´ìš©ì´ ë°©ëŒ€í•˜ê¸° ë•Œë¬¸ì— ì•„ë˜ì˜ ë§í¬ë“¤ë¡œ ì„¤ëª…ì„ ëŒ€ì²´í•˜ê² ìŠµë‹ˆë‹¤.</p>

<ul>
  <li><a href="https://www.solo.io/blog/">Gloo Blog</a></li>
  <li><a href="https://docs.solo.io/gateway/latest/quickstart/">Docs</a></li>
  <li><a href="https://www.solo.io/blog/gateway-api-tutorial-blog/">https://www.solo.io/blog/gateway-api-tutorial-blog/</a></li>
  <li><a href="https://www.solo.io/blog/gateway-api-workshop/">https://www.solo.io/blog/gateway-api-workshop/</a></li>
  <li><a href="https://www.solo.io/blog/fast-and-furious-gateway-api-at-scale-with-envoy-proxy-and-gloo-gateway/">https://www.solo.io/blog/fast-and-furious-gateway-api-at-scale-with-envoy-proxy-and-gloo-gateway/</a></li>
  <li><a href="https://www.solo.io/blog/getting-the-most-out-of-gateway-api-lessons-learned-from-gloo-migrations/">https://www.solo.io/blog/getting-the-most-out-of-gateway-api-lessons-learned-from-gloo-migrations/</a></li>
  <li><a href="https://www.solo.io/blog/solving-an-information-leakage-problem-with-the-envoy-extproc-filter-and-kube-gateway-api/">https://www.solo.io/blog/solving-an-information-leakage-problem-with-the-envoy-extproc-filter-and-kube-gateway-api/</a></li>
  <li><a href="https://www.solo.io/blog/gateway-api-gitops-argo-tutorial-blog/">https://www.solo.io/blog/gateway-api-gitops-argo-tutorial-blog/</a></li>
</ul>

<h4 id="ì‹¤ìŠµ">ì‹¤ìŠµ</h4>

<p>ì‹¤ìŠµì„ í†µí•´ Gloo Gatewayë¥¼ ì„¤ì¹˜í•˜ê³ , Gateway APIë¥¼ ì‚¬ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.
ì‹¤ìŠµì€ <a href="https://www.solo.io/blog/gateway-api-tutorial-blog/">[Tutorial] Hands-On with the Kubernetes Gateway API and Envoy Proxy</a>ë¥¼ ì°¸ê³ í•˜ì˜€ìŠµë‹ˆë‹¤.
kindë¥¼ í†µí•´ì„œ ì‹¤ìŠµí•  ìˆ˜ ìˆë„ë¡ ì˜ êµ¬ì„±ë˜ì—ˆê³  30ë¶„ ì •ë„ë©´ ë”°ë¼í•  ìˆ˜ ìˆë‹¤ê³  í•©ë‹ˆë‹¤.</p>

<h5 id="install">Install</h5>

<p><strong>Install KinD Cluster</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; kind-1node.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
</span><span class="no">EOT

</span><span class="c"># Install KinD Cluster</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--image</span> kindest/node:v1.30.0 <span class="nt">--config</span> kind-1node.yaml <span class="nt">--name</span> myk8s

<span class="c"># ë…¸ë“œì— ê¸°ë³¸ íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget bsdmainutils bridge-utils net-tools dnsutils tcpdump ngrep iputils-ping git vim -y'</span>

<span class="c"># ë…¸ë“œ/íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   32s   v1.30.0   172.20.0.2    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.15</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-system          coredns-7db6d8ff4d-45mzg                      1/1     Running   0          38s</span>
<span class="c">#    kube-system          coredns-7db6d8ff4d-gc4zp                      1/1     Running   0          38s</span>
<span class="c">#    kube-system          etcd-myk8s-control-plane                      1/1     Running   0          52s</span>
<span class="c">#    kube-system          kindnet-h4dwk                                 1/1     Running   0          38s</span>
<span class="c">#    kube-system          kube-apiserver-myk8s-control-plane            1/1     Running   0          54s</span>
<span class="c">#    kube-system          kube-controller-manager-myk8s-control-plane   1/1     Running   0          52s</span>
<span class="c">#    kube-system          kube-proxy-sptf6                              1/1     Running   0          38s</span>
<span class="c">#    kube-system          kube-scheduler-myk8s-control-plane            1/1     Running   0          52s</span>
<span class="c">#    local-path-storage   local-path-provisioner-988d74bc-gl679         1/1     Running   0          38s</span>
</code></pre></div></div>

<p><strong>Install Gateway API CRDs</strong> : The Kubernetes Gateway API abstractions are expressed using Kubernetes CRDs.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># CRDs ì„¤ì¹˜ ë° í™•ì¸</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.0.0/standard-install.yaml
<span class="nv">$ </span>kubectl get crd
<span class="c"># =&gt; NAME                                        CREATED AT</span>
<span class="c">#    gatewayclasses.gateway.networking.k8s.io    2024-10-01T15:50:32Z</span>
<span class="c">#    gateways.gateway.networking.k8s.io          2024-10-01T15:50:32Z</span>
<span class="c">#    httproutes.gateway.networking.k8s.io        2024-10-01T15:50:32Z</span>
<span class="c">#    referencegrants.gateway.networking.k8s.io   2024-10-01T15:50:32Z</span>
</code></pre></div></div>

<p><strong>Install Glooctl Utility</strong> : GLOOCTL is a command-line utility that allows users to view, manage, and debug Gloo Gateway deployments - <a href="https://docs.solo.io/gloo-edge/latest/installation/glooctl_setup/">Link</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [ì‹ ê·œ í„°ë¯¸ë„] ì•„ë˜ bash ì§„ì… í›„ glooctl íˆ´ ì‚¬ìš©</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nt">----------------------------------------</span>
<span class="c"># Install Glooctl Utility</span>
<span class="c">## glooctl install gateway     # install gloo's function gateway functionality into the 'gloo-system' namespace</span>
<span class="c">## glooctl install ingress     # install very basic Kubernetes Ingress support with Gloo into namespace gloo-system</span>
<span class="c">## glooctl install knative     # install Knative serving with Gloo configured as the default cluster ingress</span>
<span class="c">## curl -sL https://run.solo.io/gloo/install | sh</span>
<span class="nv">$ </span>curl <span class="nt">-sL</span> https://run.solo.io/gloo/install | <span class="nv">GLOO_VERSION</span><span class="o">=</span>v1.17.7 sh
<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/.gloo/bin:<span class="nv">$PATH</span>

<span class="c"># ë²„ì „ í™•ì¸</span>
<span class="nv">$ </span>glooctl version
<span class="c"># =&gt; Server: version undefined, could not find any version of gloo running</span>
<span class="c">#    </span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;client&amp;quot;: {</span>
<span class="c">#        &amp;quot;version&amp;quot;: &amp;quot;1.17.7&amp;quot;</span>
<span class="c">#      },</span>
<span class="c">#      &amp;quot;kubernetesCluster&amp;quot;: {</span>
<span class="c">#        &amp;quot;major&amp;quot;: &amp;quot;1&amp;quot;,</span>
<span class="c">#        &amp;quot;minor&amp;quot;: &amp;quot;30&amp;quot;,</span>
<span class="c">#        &amp;quot;gitVersion&amp;quot;: &amp;quot;v1.30.0&amp;quot;,</span>
<span class="c">#        &amp;quot;buildDate&amp;quot;: &amp;quot;2024-05-13T22:02:25Z&amp;quot;,</span>
<span class="c">#        &amp;quot;platform&amp;quot;: &amp;quot;linux/arm64&amp;quot;</span>
<span class="c">#      }</span>
<span class="c">#    }</span>

<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì„œë²„ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— í´ë¼ì´ì–¸íŠ¸ ì •ë³´ë§Œ ë‚˜ì˜µë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nt">----------------------------------------</span>
</code></pre></div></div>

<p><strong>Install Gloo Gateway : ì˜¤í”ˆì†ŒìŠ¤ ë²„ì „</strong></p>

<p><strong>rosetta ë¹„í™œì„±í™” ë°©ë²•</strong></p>

<ul>
  <li>
    <p>[macOS mì‹œë¦¬ì¦ˆ] <strong>Docker Desktop</strong> : ì•„ë˜ ì˜µì…˜ Uncheck í•´ë‘˜ ê²ƒ â†’ Apply &amp; restart</p>

    <p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_22.png" alt="img.png" /></p>
  </li>
  <li>
    <p>[macOS mì‹œë¦¬ì¦ˆ] <strong>Orbstack</strong> : í„°ë¯¸ë„ì—ì„œ ì•„ë˜ ì…ë ¥</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># rosetta ë¹„í™œì„±í™” </span>
  <span class="nv">$ </span>orb config <span class="nb">set </span>rosetta <span class="nb">false</span>
    
  <span class="c">#  orb ì„¤ì • í™•ì¸ </span>
  <span class="nv">$ </span>orb config show
    
  <span class="c"># orbstack ì¬ì‹œì‘ </span>
  <span class="nv">$ </span>orb stop 
  <span class="nv">$ </span>orb start 
</code></pre></div>    </div>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [ì‹ ê·œ í„°ë¯¸ë„] ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod,svc,endpointslices,ep <span class="nt">-n</span> gloo-system

<span class="c"># Install Gloo Gateway</span>
<span class="c">## --set kubeGateway.enabled=true: Kubernetes Gateway ê¸°ëŠ¥ì„ í™œì„±í™”í•©ë‹ˆë‹¤.</span>
<span class="c">## --set gloo.disableLeaderElection=true: Glooì˜ ë¦¬ë” ì„ ì¶œ ê¸°ëŠ¥ì„ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤. (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ Glooë¥¼ ì‹¤í–‰ ì‹œ ìœ ìš©)</span>
<span class="c">## --set discovery.enabled=false: ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ ê¸°ëŠ¥ì„ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>helm repo add gloo https://storage.googleapis.com/solo-public-helm
<span class="c"># =&gt; &amp;quot;gloo&amp;quot; has been added to your repositories</span>
<span class="nv">$ </span>helm repo update
<span class="nv">$ </span>helm <span class="nb">install</span> <span class="nt">-n</span> gloo-system gloo-gateway gloo/gloo <span class="se">\</span>
<span class="nt">--create-namespace</span> <span class="se">\</span>
<span class="nt">--version</span> 1.17.7 <span class="se">\</span>
<span class="nt">--set</span> kubeGateway.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> gloo.disableLeaderElection<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> discovery.enabled<span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; NAME: gloo-gateway</span>
<span class="c">#    LAST DEPLOYED: Sun Oct 13 00:57:27 2024</span>
<span class="c">#    NAMESPACE: gloo-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>

<span class="c"># Confirm that the Gloo control plane has successfully been deployed using this command</span>
<span class="nv">$ </span>kubectl rollout status deployment/gloo <span class="nt">-n</span> gloo-system
<span class="c"># =&gt; deployment &amp;quot;gloo&amp;quot; successfully rolled out</span>

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl get crd | <span class="nb">grep</span> <span class="s1">'networking.k8s.io'</span>
<span class="c"># =&gt; gatewayclasses.gateway.networking.k8s.io    2024-10-01T15:50:32Z</span>
<span class="c">#    gateways.gateway.networking.k8s.io          2024-10-01T15:50:32Z</span>
<span class="c">#    httproutes.gateway.networking.k8s.io        2024-10-01T15:50:32Z</span>
<span class="c">#    referencegrants.gateway.networking.k8s.io   2024-10-01T15:50:32Z</span>
<span class="nv">$ </span>kubectl get crd | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'networking.k8s.io'</span>
<span class="nv">$ </span>kubectl get pod,svc,endpointslices <span class="nt">-n</span> gloo-system
<span class="c"># =&gt; NAME                                    READY   STATUS      RESTARTS   AGE</span>
<span class="c">#    pod/gateway-proxy-57c49d4f48-xm8vv      1/1     Running     0          87s</span>
<span class="c">#    pod/gloo-748d877c4-24ngk                1/1     Running     0          87s</span>
<span class="c">#    pod/gloo-resource-rollout-5bt7d         0/1     Completed   0          87s</span>
<span class="c">#    pod/gloo-resource-rollout-check-xwxd4   0/1     Completed   0          86s</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                AGE</span>
<span class="c">#    service/gateway-proxy   LoadBalancer   10.96.69.126    &amp;lt;pending&amp;gt;     80:30172/TCP,443:32484/TCP                             87s</span>
<span class="c">#    service/gloo            ClusterIP      10.96.100.145   &amp;lt;none&amp;gt;        9977/TCP,9976/TCP,9988/TCP,9966/TCP,9979/TCP,443/TCP   87s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                 ADDRESSTYPE   PORTS                        ENDPOINTS    AGE</span>
<span class="c">#    endpointslice.discovery.k8s.io/gateway-proxy-n7f7v   IPv4          8080,8443                    10.244.0.7   87s</span>
<span class="c">#    endpointslice.discovery.k8s.io/gloo-9bf7g            IPv4          9979,9988,9966 + 3 more...   10.244.0.8   87s</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl explain gatewayclasses
<span class="nv">$ </span>kubectl get gatewayclasses
<span class="c"># =&gt; NAME           CONTROLLER             ACCEPTED   AGE</span>
<span class="c">#    gloo-gateway   solo.io/gloo-gateway   True       2m18s</span>

<span class="nv">$ </span>kubectl get gatewayclasses <span class="nt">-o</span> yaml
<span class="c"># =&gt; apiVersion: v1</span>
<span class="c">#    items:</span>
<span class="c">#    - apiVersion: gateway.networking.k8s.io/v1</span>
<span class="c">#      kind: GatewayClass</span>
<span class="c">#      metadata:</span>
<span class="c">#        labels:</span>
<span class="c">#          app: gloo</span>
<span class="c">#        name: gloo-gateway</span>
<span class="c">#      spec:</span>
<span class="c">#        controllerName: solo.io/gloo-gateway</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<p><strong>Install Httpbin Application</strong> : A simple HTTP Request &amp; Response Service - <a href="https://httpbin.org/">Link</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod,svc,endpointslices,ep <span class="nt">-n</span> httpbin

<span class="c"># Install Httpbin Application</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/solo-io/solo-blog/main/gateway-api-tutorial/01-httpbin-svc.yaml
<span class="c"># =&gt; namespace/httpbin created</span>
<span class="c">#    serviceaccount/httpbin created</span>
<span class="c">#    service/httpbin created</span>
<span class="c">#    deployment.apps/httpbin created</span>

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,endpointslices,sa <span class="nt">-n</span> httpbin
<span class="c"># =&gt; NAME                      READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/httpbin   0/1     1            0           10s</span>
<span class="c">#    </span>
<span class="c">#    NAME                           READY   STATUS              RESTARTS   AGE</span>
<span class="c">#    pod/httpbin-5855dc8bdd-xh2vf   0/1     ContainerCreating   0          10s</span>
<span class="c">#    </span>
<span class="c">#    NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/httpbin   ClusterIP   10.96.169.139   &amp;lt;none&amp;gt;        8000/TCP   10s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                           ADDRESSTYPE   PORTS     ENDPOINTS   AGE</span>
<span class="c">#    endpointslice.discovery.k8s.io/httpbin-6zhsk   IPv4          &amp;lt;unset&amp;gt;   &amp;lt;unset&amp;gt;     10s</span>
<span class="c">#    </span>
<span class="c">#    NAME                     SECRETS   AGE</span>
<span class="c">#    serviceaccount/default   0         10s</span>
<span class="c">#    serviceaccount/httpbin   0         10s</span>
<span class="nv">$ </span>kubectl rollout status deploy/httpbin <span class="nt">-n</span> httpbin
<span class="c"># =&gt; deployment &amp;quot;httpbin&amp;quot; successfully rolled out</span>

<span class="c"># (ì˜µì…˜) NodePort ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  labels:
    app: httpbin
    service: httpbin
  name: httpbin
  namespace: httpbin
spec:
  type: NodePort
  ports:
  - name: http
    port: 8000
    targetPort: 80
    nodePort: 30000
  selector:
    app: httpbin
</span><span class="no">EOF
</span><span class="c"># =&gt; service/httpbin configured</span>

<span class="c"># (ì˜µì…˜) ë¡œì»¬ ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"httpbin web - http://localhost:30000"</span>     <span class="c"># macOS ì‚¬ìš©ì</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"httpbin web - http://192.168.50.10:30000"</span> <span class="c"># Windows ì‚¬ìš©ì</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_23.png" alt="img.png" class="w-80 image-center" />
<em class="image-caption">httpbin ì„¤ì¹˜ê²°ê³¼</em></p>

<p><strong>Gateway API ì¢…ë¥˜</strong> - <a href="https://kubernetes.io/docs/concepts/services-networking/gateway/#resource-model">Docs</a></p>

<ul>
  <li><strong>GatewayClass:</strong> Defines a set of gateways with <strong>common configuration</strong> and managed by a controller that implements the <strong>class</strong>. - ì˜ˆ) ì¸í”„ë¼ ì—”ì§€ë‹ˆì–´ê°€ ê´€ë¦¬</li>
  <li><strong>Gateway:</strong> Defines an instance of traffic handling <strong>infrastructure</strong>, such as cloud load balancer. - ì˜ˆ) ë°ë¸Œì˜µìŠ¤ ì—”ì§€ë‹ˆì–´ê°€ ê´€ë¦¬</li>
  <li><strong>HTTPRoute:</strong> Defines <strong>HTTP-specific rules</strong> for mapping traffic from a Gateway listener to a representation of backend network endpoints. These endpoints are often represented as a <a href="https://kubernetes.io/docs/concepts/services-networking/service/">Service</a>. - ì˜ˆ) ê°œë°œìê°€ ê´€ë¦¬</li>
</ul>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_24.png" alt="img.png" class="image-center" /></p>

<h5 id="control--envoy-data-plane-and-the-gloo-control-plane">Control : <strong>Envoy</strong> data plane and the <strong>Gloo</strong> control plane.</h5>

<ul>
  <li>Now weâ€™ll configure a <strong>Gateway listener</strong>, establish external access to <strong>Gloo Gateway,</strong> and test the <strong>routing</strong> <strong>rules</strong> that are the core of the proxy configuration.</li>
</ul>

<p><strong>Configure a Gateway Listener</strong></p>

<ul>
  <li>Letâ€™s begin by establishing a Gateway resource that sets up an HTTP listener on port 8080 to expose routes from all our namespaces. Gateway custom resources like this are part of the Gateway API standard.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 02-gateway.yaml</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; 02-gateway.yaml
kind: Gateway
apiVersion: gateway.networking.k8s.io/v1
metadata:
  name: http
  namespace: gloo-system
spec:
  gatewayClassName: gloo-gateway
  listeners:
  - protocol: HTTP
    port: 8080
    name: http
    allowedRoutes:
      namespaces:
        from: All
</span><span class="no">EOF

</span><span class="c"># gateway ë¦¬ì†ŒìŠ¤ ìƒì„±</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> 02-gateway.yaml
<span class="c"># =&gt; gateway.gateway.networking.k8s.io/http created</span>

<span class="c"># í™•ì¸ : Now we can confirm that the Gateway has been activated</span>
<span class="nv">$ </span>kubectl get gateway <span class="nt">-n</span> gloo-system
<span class="c"># =&gt; NAME   CLASS          ADDRESS   PROGRAMMED   AGE</span>
<span class="c">#    http   gloo-gateway             True         8s</span>
<span class="nv">$ </span>kubectl get gateway <span class="nt">-n</span> gloo-system <span class="nt">-o</span> yaml
<span class="c"># =&gt; apiVersion: v1</span>
<span class="c">#    items:</span>
<span class="c">#    - apiVersion: gateway.networking.k8s.io/v1</span>
<span class="c">#      kind: Gateway</span>
<span class="c">#      metadata:</span>
<span class="c">#        name: http</span>
<span class="c">#        namespace: gloo-system</span>
<span class="c">#      spec:</span>
<span class="c">#        gatewayClassName: gloo-gateway</span>
<span class="c">#        listeners:</span>
<span class="c">#        - allowedRoutes:</span>
<span class="c">#            namespaces:</span>
<span class="c">#              from: All</span>
<span class="c">#          name: http</span>
<span class="c">#          port: 8080</span>
<span class="c">#          protocol: HTTP</span>
<span class="c">#    ...</span>

<span class="c"># You can also confirm that Gloo Gateway has spun up an Envoy proxy instance in response to the creation of this Gateway object by deploying gloo-proxy-http:</span>
<span class="nv">$ </span>kubectl get deployment gloo-proxy-http <span class="nt">-n</span> gloo-system
<span class="c"># =&gt; NAME              READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    gloo-proxy-http   1/1     1            1           66s</span>

<span class="c"># envoy ì‚¬ìš© í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> gloo-system
<span class="c"># =&gt; NAME                               READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    gateway-proxy-57c49d4f48-xm8vv     1/1     Running   0          13m</span>
<span class="c">#    gloo-748d877c4-24ngk               1/1     Running   0          13m</span>
<span class="c">#    gloo-proxy-http-587765f6b6-mpnt5   1/1     Running   0          78s</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> gloo-system  |grep Image:
<span class="c"># =&gt;     Image:         quay.io/solo-io/gloo-envoy-wrapper:1.17.7 # &lt;span style="color: green;"&gt;ğŸ‘‰ ì´ë¦„ì—ì„œ ì•Œ ìˆ˜ ìˆë“¯ì´ envoyê°€ ë“¤ì–´ìˆê³  ê°ì‹¸ê³  ìˆëŠ”ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#        Image:          quay.io/solo-io/gloo:1.17.7</span>
<span class="c">#        Image:         quay.io/solo-io/gloo-envoy-wrapper:1.17.7</span>

<span class="c"># gloo-proxy-http ì„œë¹„ìŠ¤ëŠ” External-IPëŠ” Pending ìƒíƒœ</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> gloo-system gloo-proxy-http
<span class="c"># =&gt; NAME              TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    gloo-proxy-http   LoadBalancer   10.96.104.226   &amp;lt;pending&amp;gt;     8080:31461/TCP   101s</span>

<span class="c"># gloo-proxy-http NodePort 30001 ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/instance: http
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: gloo-proxy-http
    app.kubernetes.io/version: 1.17.7
    gateway.networking.k8s.io/gateway-name: http
    gloo: kube-gateway
    helm.sh/chart: gloo-gateway-1.17.7
  name: gloo-proxy-http
  namespace: gloo-system
spec:
  ports:
  - name: http
    nodePort: 30001
    port: 8080
  selector:
    app.kubernetes.io/instance: http
    app.kubernetes.io/name: gloo-proxy-http
    gateway.networking.k8s.io/gateway-name: http
  type: LoadBalancer
</span><span class="no">EOF
</span><span class="c"># =&gt; service/gloo-proxy-http configured</span>

<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> gloo-system gloo-proxy-http
<span class="c"># =&gt; NAME              TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    gloo-proxy-http   LoadBalancer   10.96.104.226   &amp;lt;pending&amp;gt;     8080:30001/TCP   2m17s </span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë…¸ë“œí¬íŠ¸ê°€ 30001ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<p><strong>Establish External Access to Proxy</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ê°„í¸í•œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ port-forwardë¥¼ ì‚¬ìš©í•˜ì—¬ ì™¸ë¶€ë¡œ ë…¸ì¶œí•˜ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl port-forward deployment/gloo-proxy-http <span class="nt">-n</span> gloo-system 8080:8080 &amp;
</code></pre></div></div>

<p><strong>Configure Simple Routing with an HTTPRoute</strong></p>

<p>Letâ€™s begin our routing configuration with the simplest possible <strong>route</strong> to expose the <strong>/get</strong> operation on <strong>httpbin</strong></p>

<p><code class="language-plaintext highlighter-rouge">HTTPRoute</code> is one of the new Kubernetes CRDs introduced by the Gateway API, as documented <a href="https://gateway-api.sigs.k8s.io/api-types/httproute/">here</a>. Weâ€™ll start by introducing a simple <code class="language-plaintext highlighter-rouge">HTTPRoute</code> for our service.</p>

<p><strong>HTTPRoute Spec</strong></p>

<ul>
  <li><a href="https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.ParentRef">ParentRefs</a>-Define which <strong>Gateways</strong> this <strong>Route</strong> wants to be <strong>attached</strong> to.</li>
  <li><a href="https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.Hostname">Hostnames</a> (optional)- Define a list of <strong>hostnames</strong> to use for matching the <strong>Host header</strong> of HTTP requests.</li>
  <li><a href="https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteRule">Rules</a>-Define a list of <strong>rules</strong> to perform <strong>actions</strong> against matching HTTP requests.
    <ul>
      <li>Each rule consists of <a href="https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteMatch">matches</a>, <a href="https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteFilter">filters</a> (optional), <a href="https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPBackendRef">backendRefs</a> (optional) and <a href="https://gateway-api.sigs.k8s.io/reference/spec/#gateway.networking.k8s.io/v1.HTTPRouteTimeouts">timeouts</a> (optional) fields.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: httpbin
  namespace: httpbin
  labels:
    example: httpbin-route
spec:
  parentRefs:
    - name: http
      namespace: gloo-system
  hostnames:
    - <span class="s2">"api.example.com"</span>
  rules:
  - matches:
    - path:
        <span class="nb">type</span>: Exact
        value: /get
    backendRefs:
      - name: httpbin
        port: 8000
</code></pre></div></div>

<p>This example <strong>attaches</strong> to the default <code class="language-plaintext highlighter-rouge">Gateway</code> object created for us when we installed Gloo Gateway earlier.</p>

<p>See the <code class="language-plaintext highlighter-rouge">gloo-system/http</code> reference in the <code class="language-plaintext highlighter-rouge">parentRefs</code> stanza.</p>

<p>The <a href="https://gateway-api.sigs.k8s.io/api-types/gateway/">Gateway</a> object simply represents a host:port listener that the proxy will expose to accept ingress traffic.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Our route watches for HTTP requests directed at the host api.example.com with the request path /get and then forwards the request to the httpbin service on port 8000.</span>
<span class="c"># Letâ€™s establish this route now:</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/03-httpbin-route.yaml
<span class="c"># =&gt; httproute.gateway.networking.k8s.io/httpbin created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get httproute <span class="nt">-n</span> httpbin
<span class="c"># =&gt; NAME      HOSTNAMES             AGE</span>
<span class="c">#    httpbin   [&amp;quot;api.example.com&amp;quot;]   12s</span>

<span class="nv">$ </span>kubectl describe httproute <span class="nt">-n</span> httpbin
<span class="c"># =&gt; ...</span>
<span class="c">#    Spec:</span>
<span class="c">#      Hostnames:</span>
<span class="c">#        api.example.com</span>
<span class="c">#      Parent Refs:</span>
<span class="c">#        Group:      gateway.networking.k8s.io</span>
<span class="c">#        Kind:       Gateway</span>
<span class="c">#        Name:       http</span>
<span class="c">#        Namespace:  gloo-system</span>
<span class="c">#      Rules:</span>
<span class="c">#        Backend Refs:</span>
<span class="c">#          Group:   </span>
<span class="c">#          Kind:    Service</span>
<span class="c">#          Name:    httpbin</span>
<span class="c">#          Port:    8000</span>
<span class="c">#          Weight:  1</span>
<span class="c">#        Matches:</span>
<span class="c">#          Path:</span>
<span class="c">#            Type:   Exact</span>
<span class="c">#            Value:  /get</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<p><strong>Test the Simple Route with Curl</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># letâ€™s use curl to display the response with the -i option to additionally show the HTTP response code and headers.</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"127.0.0.1 api.example.com"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"httproute - http://api.example.com:30001/get"</span> <span class="c"># ì›¹ë¸Œë¼ìš°ì €</span>
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/get <span class="c"># kubectl port-forward ì‚¬ìš© ì‹œ</span>
<span class="c"># =&gt; HTTP/1.1 200 OK</span>
<span class="c">#    &lt;span style="color: red;"&gt;server: envoy&lt;/span&gt; # &lt;span style="color: green;"&gt;ğŸ‘‰ ì„œë²„ê°€ envoyì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#    date: Sat, 1 Oct 2024 16:19:18 GMT</span>
<span class="c">#    content-type: application/json</span>
<span class="c">#    content-length: 239</span>
<span class="c">#    access-control-allow-origin: *</span>
<span class="c">#    access-control-allow-credentials: true</span>
<span class="c">#    x-envoy-upstream-service-time: 13</span>
<span class="c">#    </span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;args&amp;quot;: {},</span>
<span class="c">#      &amp;quot;headers&amp;quot;: {</span>
<span class="c">#        &amp;quot;Accept&amp;quot;: &amp;quot;*/*&amp;quot;,</span>
<span class="c">#        &amp;quot;Host&amp;quot;: &amp;quot;api.example.com&amp;quot;,</span>
<span class="c">#        &amp;quot;User-Agent&amp;quot;: &amp;quot;curl/8.1.2&amp;quot;,</span>
<span class="c">#        &amp;quot;X-Envoy-Expected-Rq-Timeout-Ms&amp;quot;: &amp;quot;15000&amp;quot;</span>
<span class="c">#      },</span>
<span class="c">#      &amp;quot;origin&amp;quot;: &amp;quot;10.244.0.12&amp;quot;,</span>
<span class="c">#      &amp;quot;url&amp;quot;: &amp;quot;http://api.example.com/get&amp;quot;</span>
<span class="c">#    }</span>
</code></pre></div></div>

<p>Note that if we attempt to invoke another valid endpoint <code class="language-plaintext highlighter-rouge">/delay</code> on the <code class="language-plaintext highlighter-rouge">httpbin</code> service, it will fail with a <code class="language-plaintext highlighter-rouge">404 Not Found</code> error. Why? Because our <code class="language-plaintext highlighter-rouge">HTTPRoute</code> policy is only exposing access to <code class="language-plaintext highlighter-rouge">/get</code>, one of the many endpoints available on the service. If we try to consume an alternative <code class="language-plaintext highlighter-rouge">httpbin</code> endpoint like <code class="language-plaintext highlighter-rouge">/delay</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í˜¸ì¶œ ì‘ë‹µ ì™œ ê·¸ëŸ´ê¹Œ?</span>
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/delay/1
<span class="c"># =&gt; Handling connection for 8080</span>
<span class="c">#    HTTP/1.1 404 Not Found</span>
<span class="c">#    date: Sat, 1 Oct 2024 16:20:23 GMT</span>
<span class="c">#    server: envoy</span>
<span class="c">#    content-length: 0</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ glooë¥¼ í†µí–ˆì„ë•ŒëŠ” HTTProute ì„¤ì •ì—ì„œ /get ì´ë¼ëŠ” ê²½ë¡œì—ëŒ€í•´ì„œ ì •í™•í•˜ê²Œ ì¼ì¹˜(Exact) í•  ê²½ìš°ì—ë§Œ ë¼ìš°íŒ…í•˜ë„ë¡ í•´ì„œ ê·¸ë ‡ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># nodeport ì§ì ‘ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"httproute - http://api.example.com:30000/delay/1"</span> <span class="c"># 1ì´ˆ í›„ ì‘ë‹µ</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"httproute - http://api.example.com:30000/delay/5"</span> <span class="c"># 5ì´ˆ í›„ ì‘ë‹µ</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë…¸ë“œí¬íŠ¸ë¡œ ì§ì ‘ ì ‘ì†í•  ê²½ìš° gloo HTTPRouteë¥¼ ê±°ì¹˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<p>kind í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í• ë•Œ 30000 í¬íŠ¸ë¥¼ ì—´ì—ˆê¸° ë•Œë¬¸ì— NodePortë¡œ ì§ì ‘ ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_25.png" alt="img.png" class="w-80 image-center" />
<em class="image-caption">http://api.example.com:30000/delay/1 í˜¸ì¶œ ê²°ê³¼ =&gt; 1ì´ˆí›„ ì‘ë‹µ</em></p>

<p><strong>[ì •ê·œì‹ íŒ¨í„´ ë§¤ì¹­] Explore Routing with Regex Matching Patterns</strong></p>

<p>Letâ€™s assume that now we DO want to expose other <code class="language-plaintext highlighter-rouge">httpbin</code> endpoints like <code class="language-plaintext highlighter-rouge">/delay</code>. Our initial <code class="language-plaintext highlighter-rouge">HTTPRoute</code> is inadequate, because it is looking for an exact path match with <code class="language-plaintext highlighter-rouge">/get</code>.</p>

<p>Weâ€™ll <strong>modify</strong> it in a couple of ways. <strong>First</strong>, weâ€™ll modify the matcher to look for <strong>path prefix matches</strong> instead of an <strong>exact match</strong>. <strong>Second</strong>, weâ€™ll add a <strong>new request filter</strong> to <strong>rewrite</strong> the matched <code class="language-plaintext highlighter-rouge">/api/httpbin/</code> prefix with just a <code class="language-plaintext highlighter-rouge">/</code> prefix, which will give us the flexibility to access any endpoint available on the <code class="language-plaintext highlighter-rouge">httpbin</code> service. So a path like <code class="language-plaintext highlighter-rouge">/api/httpbin/delay/1</code> will be sent to <code class="language-plaintext highlighter-rouge">httpbin</code> with the path <code class="language-plaintext highlighter-rouge">/delay/1</code>.</p>

<p>URLì— íŒ¨í„´ì´ ë§¤ì¹˜ê°€ ë˜ë©´ rewriteí•´ì„œ ì‹¤ì œ ì ‘ì†ë˜ëŠ” ê²½ë¡œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<ul>
  <li>ì˜ˆì‹œ) <code class="language-plaintext highlighter-rouge">/api/httpbin/delay/1</code> â‡’ <code class="language-plaintext highlighter-rouge">/delay/1</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Here are the modifications weâ€™ll apply to our HTTPRoute:</span>

    - matches:
        <span class="c"># Switch from an Exact Matcher(ì •í™•í•œ ë§¤íŒ…) to a PathPrefix (ê²½ë¡œ ë§¤íŒ…) Matcher</span>
        - path:
            <span class="nb">type</span>: PathPrefix
            value: /api/httpbin/
      filters:
        <span class="c"># Replace(ë³€ê²½) the /api/httpbin matched prefix with /</span>
        - <span class="nb">type</span>: URLRewrite
          urlRewrite:
            path:
              <span class="nb">type</span>: ReplacePrefixMatch
              replacePrefixMatch: /
</code></pre></div></div>

<ul>
  <li>2ê°€ì§€ ìˆ˜ì • ë‚´ìš© ì ìš© í›„ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/04-httpbin-rewrite.yaml
<span class="c"># =&gt; httproute.gateway.networking.k8s.io/httpbin configured</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl describe httproute <span class="nt">-n</span> httpbin
<span class="c"># =&gt; ...</span>
<span class="c">#    Spec:</span>
<span class="c">#      Hostnames:</span>
<span class="c">#        api.example.com</span>
<span class="c">#      Parent Refs:</span>
<span class="c">#        Group:      gateway.networking.k8s.io</span>
<span class="c">#        Kind:       Gateway</span>
<span class="c">#        Name:       http</span>
<span class="c">#        Namespace:  gloo-system</span>
<span class="c">#      Rules:</span>
<span class="c">#        Backend Refs:</span>
<span class="c">#          Group:</span>
<span class="c">#          Kind:    Service</span>
<span class="c">#          Name:    httpbin</span>
<span class="c">#          Port:    8000</span>
<span class="c">#          Weight:  1</span>
<span class="c">#        Filters:</span>
<span class="c">#          Type:  URLRewrite</span>
<span class="c">#          URL Rewrite:</span>
<span class="c">#            Path:</span>
<span class="c">#              Replace Prefix Match:  /</span>
<span class="c">#              Type:                  ReplacePrefixMatch</span>
<span class="c">#        Matches:</span>
<span class="c">#          Path:</span>
<span class="c">#            Type:   PathPrefix</span>
<span class="c">#            Value:  /api/httpbin/</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<p><strong>Test Routing with Regex Matching Patterns</strong></p>

<p>When we used only a single route with an exact match pattern, we could only exercise the httpbin <code class="language-plaintext highlighter-rouge">/get</code> endpoint. Letâ€™s now use <code class="language-plaintext highlighter-rouge">curl</code> to confirm that both <code class="language-plaintext highlighter-rouge">/get</code> and <code class="language-plaintext highlighter-rouge">/delay</code> work as expected.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"httproute - http://api.example.com:30001/api/httpbin/get"</span> <span class="c"># ì›¹ë¸Œë¼ìš°ì €</span>
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/httpbin/get <span class="c"># kubectl port-forward ì‚¬ìš© ì‹œ</span>
<span class="c"># =&gt; HTTP/1.1 200 OK</span>
<span class="c">#    server: envoy</span>
<span class="c">#    date: Sat, 1 Oct 2024 16:33:20 GMT</span>
<span class="c">#    content-type: application/json</span>
<span class="c">#    content-length: 289</span>
<span class="c">#    access-control-allow-origin: *</span>
<span class="c">#    access-control-allow-credentials: true</span>
<span class="c">#    x-envoy-upstream-service-time: 20</span>
<span class="c">#    </span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;args&amp;quot;: {},</span>
<span class="c">#      &amp;quot;headers&amp;quot;: {</span>
<span class="c">#        &amp;quot;Accept&amp;quot;: &amp;quot;*/*&amp;quot;,</span>
<span class="c">#        &amp;quot;Host&amp;quot;: &amp;quot;api.example.com&amp;quot;,</span>
<span class="c">#        &amp;quot;User-Agent&amp;quot;: &amp;quot;curl/8.1.2&amp;quot;,</span>
<span class="c">#        &amp;quot;X-Envoy-Expected-Rq-Timeout-Ms&amp;quot;: &amp;quot;15000&amp;quot;,</span>
<span class="c">#        &amp;quot;X-Envoy-Original-Path&amp;quot;: &amp;quot;/api/httpbin/get&amp;quot;</span>
<span class="c">#      },</span>
<span class="c">#      &amp;quot;origin&amp;quot;: &amp;quot;10.244.0.12&amp;quot;,</span>
<span class="c">#      &amp;quot;url&amp;quot;: &amp;quot;http://api.example.com/get&amp;quot;</span>
<span class="c">#    }</span>

<span class="c"># ì•„ë˜ NodePort ì™€ GW API í†µí•œ ì ‘ì† ë¹„êµ</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"httproute - http://api.example.com:30001/api/httpbin/get"</span>
<span class="c"># =&gt; HTTP/1.1 200 OK</span>
<span class="c">#    ...</span>
<span class="c">#      &amp;quot;url&amp;quot;: &amp;quot;&lt;span style="color: red;"&gt;http://api.example.com/get&lt;/span&gt;&amp;quot;</span>
<span class="c">#    }</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ gloo gatewayê°€ /app/httpbin/get =&gt; / ë¡œ ë³€ê²½í•˜ì—¬ ì˜ ì ‘ì†ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"httproute - http://api.example.com:30000/api/httpbin/get"</span> <span class="c"># NodePort ì§ì ‘ ì ‘ê·¼</span>
<span class="c"># =&gt; HTTP/1.1 404 NOT FOUND</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ NodePortì— ì§ì ‘ ì ‘ê·¼ì‹œì—ëŠ” /app/httpbin/getì´ ê·¸ëŒ€ë¡œ íŒŒë“œì— ì „ë‹¬ë˜ì–´ ì—†ëŠ” ê²½ë¡œë¼ì„œ 404 ì—ëŸ¬ê°€ ë‚©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nt">---</span>
<span class="c">#</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"httproute - http://api.example.com:30001/api/httpbin/delay/1"</span> <span class="c"># ì›¹ë¸Œë¼ìš°ì €</span>
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/httpbin/delay/1 <span class="c"># kubectl port-forward ì‚¬ìš© ì‹œ</span>
<span class="c"># =&gt; HTTP/1.1 200 OK</span>
<span class="c">#    server: envoy</span>
<span class="c">#    date: Sat, 1 Oct 2024 16:36:49 GMT</span>
<span class="c">#    content-type: application/json</span>
<span class="c">#    content-length: 343</span>
<span class="c">#    access-control-allow-origin: *</span>
<span class="c">#    access-control-allow-credentials: true</span>
<span class="c">#    x-envoy-upstream-service-time: 1049     # envoy ê°€ ì—…ìŠ¤íŠ¸ë¦¼ httpbin ìš”ì²­ ì²˜ë¦¬ì— ê±¸ë¦¬ ì‹œê°„ 1ì´ˆ ì´ìƒ</span>
<span class="c">#    </span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;args&amp;quot;: {},</span>
<span class="c">#      &amp;quot;data&amp;quot;: &amp;quot;&amp;quot;,</span>
<span class="c">#      &amp;quot;files&amp;quot;: {},</span>
<span class="c">#      &amp;quot;form&amp;quot;: {},</span>
<span class="c">#      &amp;quot;headers&amp;quot;: {</span>
<span class="c">#        &amp;quot;Accept&amp;quot;: &amp;quot;*/*&amp;quot;,</span>
<span class="c">#        &amp;quot;Host&amp;quot;: &amp;quot;api.example.com&amp;quot;,</span>
<span class="c">#        &amp;quot;User-Agent&amp;quot;: &amp;quot;curl/8.1.2&amp;quot;,</span>
<span class="c">#        &amp;quot;X-Envoy-Expected-Rq-Timeout-Ms&amp;quot;: &amp;quot;15000&amp;quot;,</span>
<span class="c">#        &amp;quot;X-Envoy-Original-Path&amp;quot;: &amp;quot;/api/httpbin/delay/1&amp;quot;</span>
<span class="c">#      },</span>
<span class="c">#      &amp;quot;origin&amp;quot;: &amp;quot;10.244.0.12&amp;quot;,</span>
<span class="c">#      &amp;quot;url&amp;quot;: &amp;quot;http://api.example.com/delay/1&amp;quot;</span>
<span class="c">#    }</span>

<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/httpbin/delay/2
<span class="c"># =&gt; ...</span>
<span class="c">#    x-envoy-upstream-service-time: 2133</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<p>Perfect! It works just as expected! Note that the <code class="language-plaintext highlighter-rouge">/delay</code> operation completed successfully and that the 1-second delay was applied. The response header <code class="language-plaintext highlighter-rouge">x-envoy-upstream-service-time: 1023</code> indicates that Envoy reported that the upstream <code class="language-plaintext highlighter-rouge">httpbin</code> service required just over 1 second (1,023 milliseconds) to process the request. In the initial <code class="language-plaintext highlighter-rouge">/get</code> operation, which doesnâ€™t inject an artificial delay, observe that the same header reported only 14 milliseconds of upstream processing time.</p>

<p><strong>[ì—…ìŠ¤íŠ¸ë¦¼ ë² ì–´ëŸ¬ í† í°ì„ ì‚¬ìš©í•œ ë³€í™˜] Test Transformations with Upstream Bearer Tokens</strong></p>

<p><strong>ëª©ì </strong> : ìš”ì²­ì„ ë¼ìš°íŒ…í•˜ëŠ” <strong>ë°±ì—”ë“œ</strong> ì‹œìŠ¤í…œ ì¤‘ í•˜ë‚˜ì—ì„œ <strong>ì¸ì¦</strong>í•´ì•¼ í•˜ëŠ” <strong>ìš”êµ¬</strong> ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°ëŠ” ì–´ë–»ê²Œ í• ê¹Œìš”? ì´ ì—…ìŠ¤íŠ¸ë¦¼ ì‹œìŠ¤í…œì—ëŠ” ê¶Œí•œ ë¶€ì—¬ë¥¼ ìœ„í•œ API í‚¤ê°€ í•„ìš”í•˜ê³ , ì´ë¥¼ ì†Œë¹„í•˜ëŠ” <strong>í´ë¼ì´ì–¸íŠ¸ì— ì§ì ‘ ë…¸ì¶œí•˜ê³  ì‹¶ì§€ ì•Šë‹¤</strong>ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤. ì¦‰<strong>, í”„ë¡ì‹œ ê³„ì¸µ</strong>ì—ì„œ <strong>ìš”ì²­</strong>ì— <strong>ì£¼ì…</strong>í•  ê°„ë‹¨í•œ <strong>ë² ì–´ëŸ¬ í† í°</strong>ì„ êµ¬ì„±í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤. (ì •ì  API í‚¤ í† í°ì„ ì§ì ‘ ì£¼ì…)</p>

<p>What if we have a requirement to <strong>authenticate</strong> with one of the <strong>backend</strong> systems to which we route our requests?</p>

<p>Letâ€™s assume that this <strong>upstream</strong> system requires an <strong>API key</strong> for authorization, and that we <strong>donâ€™t</strong> want to expose this directly to the <strong>consuming client</strong>. In other words, weâ€™d like to configure a <strong>simple bearer toke</strong>n to be <strong>injected</strong> into the <strong>request</strong> at the <strong>proxy layer.</strong></p>

<p>We can <strong>express</strong> this in the <strong>Gateway API</strong> by adding a <strong>filter</strong> that applies a simple <strong>transformation</strong> to the i<strong>ncoming request</strong>.</p>

<p>This will be applied along with the <strong>URLRewrite</strong> filter we created in the previous step.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># The new filters stanza in our HTTPRoute now looks like this:</span>

      filters:
        - <span class="nb">type</span>: URLRewrite
          urlRewrite:
            path:
              <span class="nb">type</span>: ReplacePrefixMatch
              replacePrefixMatch: /
              
        <span class="c"># Add a Bearer token to supply a static API key when routing to backend system</span>
        - <span class="nb">type</span>: RequestHeaderModifier
          requestHeaderModifier:
            add:
              - name: Authorization
                value: Bearer my-api-key
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/05-httpbin-rewrite-xform.yaml

<span class="c">#</span>
<span class="nv">$ </span>kubectl describe httproute <span class="nt">-n</span> httpbin
<span class="c"># =&gt; ...</span>
<span class="c">#    Spec:</span>
<span class="c">#      ...</span>
<span class="c">#      Rules:</span>
<span class="c">#        Backend Refs:</span>
<span class="c">#          Group:</span>
<span class="c">#          Kind:    Service</span>
<span class="c">#          Name:    httpbin</span>
<span class="c">#          Port:    8000</span>
<span class="c">#          Weight:  1</span>
<span class="c">#        Filters:</span>
<span class="c">#          Type:  URLRewrite</span>
<span class="c">#          URL Rewrite:</span>
<span class="c">#            Path:</span>
<span class="c">#              Replace Prefix Match:  /</span>
<span class="c">#              Type:                  ReplacePrefixMatch</span>
<span class="c">#          Request Header Modifier:</span>
<span class="c">#            Add:</span>
<span class="c">#              Name:   Authorization</span>
<span class="c">#              Value:  Bearer my-api-key</span>
<span class="c">#          Type:       RequestHeaderModifier</span>
<span class="c">#        Matches:</span>
<span class="c">#          Path:</span>
<span class="c">#            Type:   PathPrefix</span>
<span class="c">#            Value:  /api/httpbin/</span>
</code></pre></div></div>

<ul>
  <li>ë™ì‘ í…ŒìŠ¤íŠ¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"httproute - http://api.example.com:30001/api/httpbin/get"</span> <span class="c"># ì›¹ë¸Œë¼ìš°ì €</span>
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/httpbin/get <span class="c"># kubectl port-forward ì‚¬ìš© ì‹œ</span>
<span class="c"># =&gt; HTTP/1.1 200 OK</span>
<span class="c">#    server: envoy</span>
<span class="c">#    date: Sat, 1 Oct 2024 16:40:59 GMT</span>
<span class="c">#    content-type: application/json</span>
<span class="c">#    content-length: 332</span>
<span class="c">#    access-control-allow-origin: *</span>
<span class="c">#    access-control-allow-credentials: true</span>
<span class="c">#    x-envoy-upstream-service-time: 19</span>
<span class="c">#    </span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;args&amp;quot;: {},</span>
<span class="c">#      &amp;quot;headers&amp;quot;: {</span>
<span class="c">#        &amp;quot;Accept&amp;quot;: &amp;quot;*/*&amp;quot;,</span>
<span class="c">#        &lt;span style="color: red"&gt;&amp;quot;Authorization&amp;quot;: &amp;quot;Bearer my-api-key&amp;quot;,&lt;/span&gt; </span>
<span class="c">#        &amp;quot;Host&amp;quot;: &amp;quot;api.example.com&amp;quot;,</span>
<span class="c">#        &amp;quot;User-Agent&amp;quot;: &amp;quot;curl/8.1.2&amp;quot;,</span>
<span class="c">#        &amp;quot;X-Envoy-Expected-Rq-Timeout-Ms&amp;quot;: &amp;quot;15000&amp;quot;,</span>
<span class="c">#        &amp;quot;X-Envoy-Original-Path&amp;quot;: &amp;quot;/api/httpbin/get&amp;quot;</span>
<span class="c">#      },</span>
<span class="c">#      &amp;quot;origin&amp;quot;: &amp;quot;10.244.0.12&amp;quot;,</span>
<span class="c">#      &amp;quot;url&amp;quot;: &amp;quot;http://api.example.com/get&amp;quot;</span>
<span class="c">#    }</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” Authorization í—¤ë”ë¥¼ ì•ˆ ì£¼ì—ˆì§€ë§Œ, Gloo gatewayë¥¼ í†µí•˜ì&lt;/span&gt; </span>
<span class="c"># &lt;span style="color: green;"&gt;    Authorization í—¤ë”ì— Bearer my-api-key ê°€ ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="migrate">Migrate</h5>

<p>In this section, weâ€™ll explore how a couple of common service migration techniques, <strong>dark launches with header-based routing</strong> and <strong>canary releases with percentage-based routing,</strong> are supported by the Gateway API standard.</p>

<p><strong>Configure Two Workloads for Migration Routing</strong></p>

<p>Letâ€™s first establish <strong>two versions</strong> of a <strong>workload</strong> to facilitate our migration example. Weâ€™ll use the open-source <a href="https://github.com/nicholasjackson/fake-service">Fake Service</a> to enable this.</p>

<ul>
  <li><strong>Fake service</strong> that can handle both <strong>HTTP</strong> and <strong>gRPC</strong> traffic, for <strong>testing</strong> upstream service communications and testing service mesh and other scenarios.</li>
</ul>

<p>Letâ€™s establish a <code class="language-plaintext highlighter-rouge">v1</code> of our <code class="language-plaintext highlighter-rouge">my-workload</code> service thatâ€™s configured to return a response string containing â€œv1â€. Weâ€™ll create a corresponding <code class="language-plaintext highlighter-rouge">my-workload-v2</code> service as well.</p>

<ul>
  <li>ingressì˜ ì¹´ë‚˜ë¦¬ ë°°í¬ì™€ ìœ ì‚¬í•˜ê²Œ V1ì˜ ì¼ë¶€ íŠ¸ë˜í”½ì„ V2ë¡œ ë¼ìš°íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># You should see the response below, indicating deployments for both v1 and v2 of my-workload have been created in the my-workload namespace.</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/06-workload-svcs.yaml
<span class="c"># =&gt; namespace/my-workload created</span>
<span class="c">#    serviceaccount/my-workload created</span>
<span class="c">#    deployment.apps/my-workload-v1 created</span>
<span class="c">#    deployment.apps/my-workload-v2 created</span>
<span class="c">#    service/my-workload-v1 created</span>
<span class="c">#    service/my-workload-v2 created</span>

<span class="c"># v1,v2 2ê°€ì§€ ë²„ì „ ì›Œí¬ë¡œë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,endpointslices <span class="nt">-n</span> my-workload
<span class="c"># =&gt; NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/my-workload-v1   1/1     1            1           15s</span>
<span class="c">#    deployment.apps/my-workload-v2   1/1     1            1           15s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                  READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/my-workload-v1-644f98bbd9-q6cs5   1/1     Running   0          15s</span>
<span class="c">#    pod/my-workload-v2-5bb5fcfcbc-bq88c   1/1     Running   0          15s</span>
<span class="c">#    </span>
<span class="c">#    NAME                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/my-workload-v1   ClusterIP   10.96.203.193   &amp;lt;none&amp;gt;        8080/TCP   15s</span>
<span class="c">#    service/my-workload-v2   ClusterIP   10.96.210.160   &amp;lt;none&amp;gt;        8080/TCP   15s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                  ADDRESSTYPE   PORTS   ENDPOINTS     AGE</span>
<span class="c">#    endpointslice.discovery.k8s.io/my-workload-v1-d9sqd   IPv4          8080    10.244.0.14   15s</span>
<span class="c">#    endpointslice.discovery.k8s.io/my-workload-v2-mv7fq   IPv4          8080    10.244.0.13   15s</span>
</code></pre></div></div>

<p><strong>Test Simple V1 Routing</strong></p>

<p>Before we dive into routing to multiple services, weâ€™ll start by building a simple <strong><code class="language-plaintext highlighter-rouge">HTTPRoute</code></strong> that sends HTTP requests to host <code class="language-plaintext highlighter-rouge">api.example.com</code> whose paths begin with <strong><code class="language-plaintext highlighter-rouge">/api/my-workload</code></strong> to the <strong><code class="language-plaintext highlighter-rouge">v1</code></strong> workload:</p>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_26.png" alt="img.png" /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">gateway.networking.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HTTPRoute</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">my-workload</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">my-workload</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">example</span><span class="pi">:</span> <span class="s">my-workload-route</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">parentRefs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
      <span class="na">namespace</span><span class="pi">:</span> <span class="s">gloo-system</span>
  <span class="na">hostnames</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">api.example.com"</span>
  <span class="na">rules</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">matches</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">PathPrefix</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">/api/my-workload</span>
      <span class="na">backendRefs</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">my-workload-v1</span>
          <span class="na">namespace</span><span class="pi">:</span> <span class="s">my-workload</span>
          <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div></div>

<p>Now apply this route:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/07-workload-route.yaml
<span class="c"># =&gt; httproute.gateway.networking.k8s.io/my-workload created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get httproute <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE     NAME          HOSTNAMES             AGE</span>
<span class="c">#    httpbin       httpbin       [&amp;quot;api.example.com&amp;quot;]   29m</span>
<span class="c">#    my-workload   my-workload   [&amp;quot;api.example.com&amp;quot;]   29s</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl describe httproute <span class="nt">-n</span> my-workload
<span class="c"># =&gt; ...</span>
<span class="c">#    Spec:</span>
<span class="c">#      Hostnames:</span>
<span class="c">#        api.example.com</span>
<span class="c">#      Parent Refs:</span>
<span class="c">#        Group:      gateway.networking.k8s.io</span>
<span class="c">#        Kind:       Gateway</span>
<span class="c">#        Name:       http</span>
<span class="c">#        Namespace:  gloo-system</span>
<span class="c">#      Rules:</span>
<span class="c">#        Backend Refs:</span>
<span class="c">#          Group:</span>
<span class="c">#          Kind:       Service</span>
<span class="c">#          Name:       my-workload-v1</span>
<span class="c">#          Namespace:  my-workload</span>
<span class="c">#          Port:       8080</span>
<span class="c">#          Weight:     1</span>
<span class="c">#        Matches:</span>
<span class="c">#          Path:</span>
<span class="c">#            Type:   PathPrefix</span>
<span class="c">#            Value:  /api/my-workload</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> http://api.example.com:8080/api/my-workload | <span class="nb">grep </span>Workload<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;  100   &amp;quot;body&amp;quot;: &amp;quot;Hello From My Workload (v1)!&amp;quot;,</span>

<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í˜„ì¬ëŠ” ëª¨ë“  ì—°ê²°ì´ v1ìœ¼ë¡œ í–¥í•©ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<p><strong>Simulate a v2 Dark Launch with Header-Based Routing</strong></p>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_27.png" alt="img.png" /></p>

<p><a href="https://www.cloudbees.com/blog/when-dark-launch-right-release-strategy">Dark Launch</a> is a great cloud migration technique that <strong>releases new feature</strong>s to a select <strong>subset of users</strong> to gather <strong>feedback</strong> and experiment with improvements <strong>before</strong> potentially disrupting a larger user community.</p>

<ul>
  <li>Dark Launch : ì¼ë¶€ ì‚¬ìš©ìì—ê²Œ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì¶œì‹œí•˜ì—¬ í”¼ë“œë°±ì„ ìˆ˜ì§‘í•˜ê³  ì ì¬ì ìœ¼ë¡œ ë” í° ì‚¬ìš©ì ì»¤ë®¤ë‹ˆí‹°ë¥¼ ë°©í•´í•˜ê¸° ì „ì— ê°œì„  ì‚¬í•­ì„ ì‹¤í—˜í•˜ëŠ” í›Œë¥­í•œ í´ë¼ìš°ë“œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê¸°ìˆ </li>
</ul>

<p>We will simulate a dark launch in our example by installing the <strong>new cloud version</strong> of our <strong>service</strong> in our Kubernetes cluster, and then using declarative policy to route only requests containing a <strong>particular heade</strong>r to the new <code class="language-plaintext highlighter-rouge">v2</code> instance. The <strong>vast majority of users</strong> will continue to use the original <strong><code class="language-plaintext highlighter-rouge">v1</code></strong> of the service just as before.</p>

<ul>
  <li>ìš°ë¦¬ëŠ” Kubernetes í´ëŸ¬ìŠ¤í„°ì— ì„œë¹„ìŠ¤ì˜ ìƒˆë¡œìš´ í´ë¼ìš°ë“œ ë²„ì „ì„ ì„¤ì¹˜í•œ ë‹¤ìŒ ì„ ì–¸ì  ì •ì±…ì„ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • í—¤ë”ë¥¼ í¬í•¨í•˜ëŠ” ìš”ì²­ë§Œ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë¼ìš°íŒ…í•˜ì—¬ ì˜ˆì œì—ì„œ ë‹¤í¬ ëŸ°ì¹˜ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•  ê²ƒì…ë‹ˆë‹¤ . ëŒ€ë‹¤ìˆ˜ì˜ ì‚¬ìš©ìëŠ” ì´ì „ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì„œë¹„ìŠ¤ì˜ <code class="language-plaintext highlighter-rouge">v1</code>ì„ ê³„ì† ì‚¬ìš©í•  ê²ƒ ì…ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  rules:
    - matches:
      - path:
          <span class="nb">type</span>: PathPrefix
          value: /api/my-workload
        <span class="c"># Add a matcher to route requests with a v2 version header to v2</span>
        <span class="c"># version=v2 í—¤ë”ê°’ì´ ìˆëŠ” ì‚¬ìš©ìë§Œ v2 ë¼ìš°íŒ…</span>
        headers:
        - name: version
          value: v2
      backendRefs:
        - name: my-workload-v2
          namespace: my-workload
          port: 8080      
    - matches:
      <span class="c"># Route requests without the version header to v1 as before</span>
      <span class="c"># ëŒ€ë‹¤ìˆ˜ ì¼ë°˜ ì‚¬ìš©ìëŠ” ê¸°ì¡´ ì²˜ëŸ¼ v1 ë¼ìš°íŒ…</span>
      - path:
          <span class="nb">type</span>: PathPrefix
          value: /api/my-workload
      backendRefs:
        - name: my-workload-v1
          namespace: my-workload
          port: 8080
</code></pre></div></div>

<p>Configure two separate routes, one for <code class="language-plaintext highlighter-rouge">v1</code> that the majority of service consumers will still use, and another route for <code class="language-plaintext highlighter-rouge">v2</code> that will be accessed by specifying a request header with name <code class="language-plaintext highlighter-rouge">version</code> and value <code class="language-plaintext highlighter-rouge">v2</code>. Letâ€™s apply the modified <code class="language-plaintext highlighter-rouge">HTTPRoute</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/08-workload-route-header.yaml
<span class="c"># =&gt; httproute.gateway.networking.k8s.io/my-workload configured</span>

<span class="c"># </span>
<span class="nv">$ </span>kubectl describe httproute <span class="nt">-n</span> my-workload
<span class="c"># =&gt; ...</span>
<span class="c">#    Spec:  </span>
<span class="c">#      Rules:</span>
<span class="c">#        Backend Refs:</span>
<span class="c">#          Group:</span>
<span class="c">#          Kind:       Service</span>
<span class="c">#          Name:       my-workload-v2</span>
<span class="c">#          Namespace:  my-workload</span>
<span class="c">#          Port:       8080</span>
<span class="c">#          Weight:     1</span>
<span class="c">#        Matches:</span>
<span class="c">#          Headers:</span>
<span class="c">#            Name:   version</span>
<span class="c">#            Type:   Exact</span>
<span class="c">#            Value:  v2</span>
<span class="c">#          Path:</span>
<span class="c">#            Type:   PathPrefix</span>
<span class="c">#            Value:  /api/my-workload</span>
<span class="c">#        Backend Refs:</span>
<span class="c">#          Group:</span>
<span class="c">#          Kind:       Service</span>
<span class="c">#          Name:       my-workload-v1</span>
<span class="c">#          Namespace:  my-workload</span>
<span class="c">#          Port:       8080</span>
<span class="c">#          Weight:     1</span>
<span class="c">#        Matches:</span>
<span class="c">#          Path:</span>
<span class="c">#            Type:   PathPrefix</span>
<span class="c">#            Value:  /api/my-workload</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># version: v2 í—¤ë”ê°€ ì—†ëŠ” ê²½ìš° v1ìœ¼ë¡œ ë¼ìš°íŒ…ë©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/my-workload
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/my-workload | <span class="nb">grep </span>body
<span class="c"># =&gt; "body": "Hello From My Workload (v1)!",</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> http://api.example.com:8080/api/my-workload | <span class="nb">grep </span>Workload<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;  100   &amp;quot;body&amp;quot;: &amp;quot;Hello From My Workload (v1)!&amp;quot;,</span>

<span class="c"># í•˜ì§€ë§Œ version: v2 í—¤ë”ê°€ ìˆëŠ” ê²½ìš° v2ë¡œ ë¼ìš°íŒ…ë©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> <span class="nt">-H</span> <span class="s2">"version: v2"</span> http://localhost:8080/api/my-workload
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> <span class="nt">-H</span> <span class="s2">"version: v2"</span> http://localhost:8080/api/my-workload | <span class="nb">grep </span>body
<span class="c"># =&gt;   &amp;quot;body&amp;quot;: &amp;quot;Hello From My Workload (v2)!&amp;quot;,</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> http://api.example.com:8080/api/my-workload | <span class="nb">grep </span>Workload<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;  100   &amp;quot;body&amp;quot;: &amp;quot;Hello From My Workload (v1)!&amp;quot;,</span>
</code></pre></div></div>

<p><strong>Expand V2 Testing with Percentage-Based Routing</strong></p>

<p>After a successful dark-launch, we may want a period where we use a <strong>blue-green strategy</strong> of gradually <strong>shifting</strong> user traffic from the <strong>old</strong> version to the <strong>new</strong> one. Letâ€™s explore this with a routing policy that splits our traffic evenly, sending half our traffic to <strong><code class="language-plaintext highlighter-rouge">v1</code></strong> and the other <strong>half</strong> to <strong><code class="language-plaintext highlighter-rouge">v2</code></strong>.</p>

<ul>
  <li>ì„±ê³µì ì¸ ë‹¤í¬ ëŸ°ì¹­ ì´í›„, ìš°ë¦¬ëŠ” <strong>ì ì§„ì </strong>ìœ¼ë¡œ ì´ì „ ë²„ì „ì—ì„œ ìƒˆ ë²„ì „ìœ¼ë¡œ ì‚¬ìš©ì íŠ¸ë˜í”½ì„ ì˜®ê¸°ëŠ” <strong>ë¸”ë£¨-ê·¸ë¦° ì „ëµ</strong>ì„ ì‚¬ìš©í•˜ëŠ” ê¸°ê°„ì„ ì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¸ë˜í”½ì„ ê· ë“±í•˜ê²Œ ë¶„í• í•˜ê³  íŠ¸ë˜í”½ì˜ ì ˆë°˜ì„ ë¡œ ë³´ë‚´ê³  <code class="language-plaintext highlighter-rouge">v1</code>ë‚˜ë¨¸ì§€ ì ˆë°˜ì„ ë¡œ ë³´ë‚´ëŠ” ë¼ìš°íŒ… ì •ì±…ìœ¼ë¡œ ì´ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤ <code class="language-plaintext highlighter-rouge">v2</code>.</li>
</ul>

<p>We will modify our <strong><code class="language-plaintext highlighter-rouge">HTTPRoute</code></strong> to accomplish this by removing the header-based routing rule that drove our dark launch. Then we will <strong>replace</strong> that with a <strong>50-50 <code class="language-plaintext highlighter-rouge">weight</code></strong> applied to each of the routes, as shown below:</p>

<p><img src="/assets/2024/kans-3th/w6/20241012_kans_w6_28.png" alt="img.png" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  rules:
    - matches:
      - path:
          <span class="nb">type</span>: PathPrefix
          value: /api/my-workload
      <span class="c"># Configure a 50-50 traffic split across v1 and v2 : ë²„ì „ 1,2 50:50 ë¹„ìœ¨</span>
      backendRefs:
        - name: my-workload-v1
          namespace: my-workload
          port: 8080
          weight: 50
        - name: my-workload-v2
          namespace: my-workload
          port: 8080
          weight: 50
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Apply this 50-50 routing policy with kubectl:</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/09-workload-route-split.yaml
<span class="c"># =&gt; httproute.gateway.networking.k8s.io/my-workload configured</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl describe httproute <span class="nt">-n</span> my-workload
<span class="c"># =&gt; Spec:</span>
<span class="c">#      ...</span>
<span class="c">#      Rules:</span>
<span class="c">#        Backend Refs:</span>
<span class="c">#          Group:</span>
<span class="c">#          Kind:       Service</span>
<span class="c">#          Name:       my-workload-v1</span>
<span class="c">#          Namespace:  my-workload</span>
<span class="c">#          Port:       8080</span>
<span class="c">#          Weight:     50</span>
<span class="c">#          Group:</span>
<span class="c">#          Kind:       Service</span>
<span class="c">#          Name:       my-workload-v2</span>
<span class="c">#          Namespace:  my-workload</span>
<span class="c">#          Port:       8080</span>
<span class="c">#          Weight:     50</span>
<span class="c">#        Matches:</span>
<span class="c">#          Path:</span>
<span class="c">#            Type:   PathPrefix</span>
<span class="c">#            Value:  /api/my-workload</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°˜ë³µ ì ‘ì† í›„ ëŒ€ëµ ë¹„ë¥  í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/my-workload/ | <span class="nb">grep </span>body<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;   51   &amp;quot;body&amp;quot;: &amp;quot;Hello From My Workload (v1)!&amp;quot;,</span>
<span class="c">#      49   &amp;quot;body&amp;quot;: &amp;quot;Hello From My Workload (v2)!&amp;quot;,</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..200<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/my-workload/ | <span class="nb">grep </span>body<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;  116   &amp;quot;body&amp;quot;: &amp;quot;Hello From My Workload (v1)!&amp;quot;,</span>
<span class="c">#      84   &amp;quot;body&amp;quot;: &amp;quot;Hello From My Workload (v2)!&amp;quot;,</span>
</code></pre></div></div>

<h5 id="debug">Debug</h5>

<p><strong>Solve a Problem with Glooctl CLI</strong></p>

<p>A common source of Gloo configuration <strong>errors</strong> is <strong>mistyping</strong> an upstream reference, perhaps when copy/pasting it from another source but â€œmissing a spotâ€ when changing the name of the backend service target. In this example, weâ€™ll simulate making an error like that, and then demonstrating how <code class="language-plaintext highlighter-rouge">glooctl</code> can be used to detect it.</p>

<ul>
  <li>Gloo êµ¬ì„± ì˜¤ë¥˜ì˜ ì¼ë°˜ì ì¸ ì›ì¸ì€ <strong>ì—…ìŠ¤íŠ¸ë¦¼ ì°¸ì¡°ë¥¼ ì˜ëª» ì…ë ¥</strong>í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì•„ë§ˆë„ ë‹¤ë¥¸ ì†ŒìŠ¤ì—ì„œ ë³µì‚¬/ë¶™ì—¬ë„£ì„ ë•Œì´ì§€ë§Œ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ëŒ€ìƒì˜ ì´ë¦„ì„ ë³€ê²½í•  ë•Œ â€œí•œ êµ°ë°ë¥¼ ë†“ì¹œâ€ ê²ƒì…ë‹ˆë‹¤. ì´ ì˜ˆì—ì„œ ìš°ë¦¬ëŠ” ê·¸ëŸ° ì˜¤ë¥˜ë¥¼ ë§Œë“œëŠ” ê²ƒì„ ì‹œë®¬ë ˆì´ì…˜í•˜ê³ , <code class="language-plaintext highlighter-rouge">glooctl</code>ê·¸ê²ƒì„ ê°ì§€í•˜ëŠ” ë° ì–´ë–»ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ ë³´ì—¬ì¤ë‹ˆë‹¤.</li>
</ul>

<p><strong>First</strong>, letâ€™s apply a change to simulate the <strong>mistyping</strong> of an upstream config so that it is targeting a <strong>non-existent <code class="language-plaintext highlighter-rouge">my-bad-workload-v2</code></strong> backend service, rather than the correct <strong><code class="language-plaintext highlighter-rouge">my-workload-v2</code></strong>.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">my-bad-workload-v2</code> ì—…ìŠ¤íŠ¸ë¦¼ êµ¬ì„±ì˜ ì˜¤íƒ€ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ì—¬ ì˜¬ë°”ë¥¸ íƒ€ê²ŸíŒ…í•˜ëŠ” ëŒ€ì‹  ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë¥¼ íƒ€ê²ŸíŒ…í•˜ë„ë¡ ë³€ê²½</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [ì‹ ê·œ í„°ë¯¸ë„] ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>kubectl get httproute <span class="nt">-n</span> my-workload my-workload <span class="nt">-o</span> yaml <span class="nt">-w</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/10-workload-route-split-bad-dest.yaml
<span class="c"># =&gt; httproute.gateway.networking.k8s.io/my-workload configured</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl describe httproute <span class="nt">-n</span> my-workload
<span class="c"># =&gt; ...</span>
<span class="c">#    Spec:</span>
<span class="c">#      Rules:</span>
<span class="c">#        Backend Refs:</span>
<span class="c">#          Group:</span>
<span class="c">#          Kind:       Service</span>
<span class="c">#          Name:       my-workload-v1</span>
<span class="c">#          Namespace:  my-workload</span>
<span class="c">#          Port:       8080</span>
<span class="c">#          Weight:     50</span>
<span class="c">#          Group:</span>
<span class="c">#          Kind:       Service</span>
<span class="c">#          Name:       my-bad-workload-v2</span>
<span class="c">#          Namespace:  my-workload</span>
<span class="c">#          Port:       8080</span>
<span class="c">#          Weight:     50</span>
<span class="c">#        Matches:</span>
<span class="c">#          Path:</span>
<span class="c">#            Type:   PathPrefix</span>
<span class="c">#            Value:  /api/my-workload</span>
<span class="c">#    Status:</span>
<span class="c">#      Parents:</span>
<span class="c">#        Conditions:</span>
<span class="c">#          Last Transition Time:  2024-10-12T16:55:06Z</span>
<span class="c">#          Message:               Service &amp;quot;my-bad-workload-v2&amp;quot; not found</span>
<span class="c">#          Observed Generation:   4</span>
<span class="c">#          Reason:                BackendNotFound</span>
<span class="c">#          Status:                False</span>
<span class="c">#          Type:                  ResolvedRefs</span>
<span class="c">#          Last Transition Time:  2024-10-12T16:45:41Z</span>
<span class="c">#          Message:</span>
<span class="c">#          Observed Generation:   4</span>
<span class="c">#          Reason:                Accepted</span>
<span class="c">#          Status:                True</span>
<span class="c">#          Type:                  Accepted</span>
<span class="c">#        Controller Name:         solo.io/gloo-gateway</span>
<span class="c">#        Parent Ref:</span>
<span class="c">#          Group:      gateway.networking.k8s.io</span>
<span class="c">#          Kind:       Gateway</span>
<span class="c">#          Name:       http</span>
<span class="c">#          Namespace:  gloo-system</span>
<span class="c">#    Events:           &amp;lt;none&amp;gt;</span>
</code></pre></div></div>

<p>When we test this out, note that the 50-50 traffic split is still in place. This means that about half of the requests will be routed to <code class="language-plaintext highlighter-rouge">my-workload-v1</code> and succeed, while the others will attempt to use the non-existent <code class="language-plaintext highlighter-rouge">my-bad-workload-v2</code> and fail like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/my-workload
<span class="c"># =&gt; HTTP/1.1 500 Internal Server Error</span>
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/my-workload
<span class="c"># =&gt; HTTP/1.1 200 OK</span>
<span class="c">#    vary: Origin</span>
<span class="c">#    date: Sat, 12 Oct 2024 16:56:37 GMT</span>
<span class="c">#    content-length: 292</span>
<span class="c">#    content-type: text/plain; charset=utf-8</span>
<span class="c">#    x-envoy-upstream-service-time: 5</span>
<span class="c">#    server: envoy</span>
<span class="c">#    ...</span>

<span class="c"># </span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/my-workload/ | <span class="nb">grep </span>body<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;   55   &amp;quot;body&amp;quot;: &amp;quot;Hello From My Workload (v1)!&amp;quot;,</span>

<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë””ë²„ê¹… í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì¼ë¶€ëŸ¬ 50%ì˜ ì›Œí¬ë¡œë“œì—ëŠ” ì˜¤íƒ€ë¥¼ ë‚´ì–´ì„œ&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    50%ì˜ ìš”ì²­ì€ v1ë¡œ ë¼ìš°íŒ…ë˜ì–´ ì„±ê³µí•˜ê³  ë‚˜ë¨¸ì§€ 50%ëŠ” ì‹¤íŒ¨í•©ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<p>So weâ€™ll deploy one of the first weapons from the Gloo debugging arsenal, the <code class="language-plaintext highlighter-rouge">glooctl check</code> utility. It verifies a number of Gloo resources, confirming that they are configured correctly and are interconnected with other resources correctly. For example, in this case, <code class="language-plaintext highlighter-rouge">glooctl</code> will detect the error in the mis-connection between the <code class="language-plaintext highlighter-rouge">HTTPRoute</code> and its backend target:</p>

<ul>
  <li>glooì—ì„œ ì œê³µí•˜ëŠ” <code class="language-plaintext highlighter-rouge">glooctl check</code> ëª…ë ¹ìœ¼ë¡œ êµ¬ì„± ì˜¤ë¥˜ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="c"># -----------------------------------</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/.gloo/bin:<span class="nv">$PATH</span>
<span class="nv">$ </span>glooctl check
<span class="c"># =&gt; ...</span>
<span class="c">#    Checking Gateways... OK</span>
<span class="c">#    Checking Proxies... 1 Errors!</span>
<span class="c">#    </span>
<span class="c">#    Detected Kubernetes Gateway integration!</span>
<span class="c">#    Checking Kubernetes GatewayClasses... OK</span>
<span class="c">#    Checking Kubernetes Gateways... OK</span>
<span class="c">#    Checking Kubernetes HTTPRoutes... 1 Errors!</span>
<span class="c">#    </span>
<span class="c">#    Skipping Gloo Instance check -- Gloo Federation not detected.</span>
<span class="c">#    Error: 2 errors occurred:</span>
<span class="c">#     * Found proxy with warnings by 'gloo-system': gloo-system gloo-system-http</span>
<span class="c">#    Reason: warning:</span>
<span class="c">#      Route Warning: InvalidDestinationWarning. Reason: invalid destination in weighted destination list: *v1.Upstream { blackhole_ns.kube-svc:blackhole-ns-blackhole-cluster-8080 } not found</span>
<span class="c">#    </span>
<span class="c">#     * HTTPRoute my-workload.my-workload.http status (ResolvedRefs) is not set to expected (True). Reason: BackendNotFound, Message: Service &amp;quot;my-bad-workload-v2&amp;quot; not found</span>

<span class="c"># ì›ì¸ ê´€ë ¨ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get httproute my-workload <span class="nt">-n</span> my-workload <span class="nt">-o</span> yaml
<span class="c"># =&gt; ...</span>
<span class="c">#    status:</span>
<span class="c">#      parents:</span>
<span class="c">#      - conditions:</span>
<span class="c">#        - lastTransitionTime: &amp;quot;2024-10-12T16:55:06Z&amp;quot;</span>
<span class="c">#          message: Service &amp;quot;my-bad-workload-v2&amp;quot; not found</span>
<span class="c">#          observedGeneration: 4</span>
<span class="c">#          reason: BackendNotFound</span>
<span class="c">#          status: &amp;quot;False&amp;quot;</span>
<span class="c">#          type: ResolvedRefs</span>
<span class="c">#          ...</span>

<span class="c"># ì •ìƒ ì„¤ì •ìœ¼ë¡œ í•´ê²° configuration is again clean.</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/09-workload-route-split.yaml
<span class="c"># =&gt; httproute.gateway.networking.k8s.io/my-workload configured</span>
<span class="nv">$ </span>kubectl get httproute my-workload <span class="nt">-n</span> my-workload <span class="nt">-o</span> yaml

<span class="c">#</span>
<span class="nv">$ </span>glooctl check
<span class="c"># =&gt; Checking Deployments... OK</span>
<span class="c">#    Checking Pods... OK</span>
<span class="c">#    Checking Upstreams... OK</span>
<span class="c">#    Checking UpstreamGroups... OK</span>
<span class="c">#    Checking AuthConfigs... OK</span>
<span class="c">#    Checking RateLimitConfigs... OK</span>
<span class="c">#    Checking VirtualHostOptions... OK</span>
<span class="c">#    Checking RouteOptions... OK</span>
<span class="c">#    Checking Secrets... OK</span>
<span class="c">#    Checking VirtualServices... OK</span>
<span class="c">#    Checking Gateways... OK</span>
<span class="c">#    Checking Proxies... OK</span>
<span class="c">#    </span>
<span class="c">#    Detected Kubernetes Gateway integration!</span>
<span class="c">#    Checking Kubernetes GatewayClasses... OK</span>
<span class="c">#    Checking Kubernetes Gateways... OK</span>
<span class="c">#    Checking Kubernetes HTTPRoutes... OK</span>
<span class="c">#    </span>
<span class="c">#    Skipping Gloo Instance check -- Gloo Federation not detected.</span>
<span class="c">#    No problems detected.</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì´ì œ ë¬¸ì œê°€ ì—†ë‹¤ê³  í•©ë‹ˆë‹¤. ğŸ˜€&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="observe">Observe</h5>

<p><strong>Explore Envoy Metrics</strong></p>

<p><strong>Envoy</strong> publishes a host of <strong>metrics</strong> that may be useful for observing system behavior. In our very modest kind cluster for this exercise, you can count over <strong>3,000 individual metrics</strong>! You can learn more about them in the Envoy documentation <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats">here</a>.</p>

<p>For this 30-minute exercise, letâ€™s take a quick look at a couple of the useful metrics that Envoy produces for every one of our backend targets.</p>

<p>First, weâ€™ll <strong>port-forward</strong> the <strong>Envoy</strong> <strong>administrative</strong> <strong>port</strong> <strong>19000</strong> to our local workstation:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> gloo-system port-forward deployment/gloo-proxy-http 19000 &amp;

<span class="c"># ì•„ë˜ ê´€ë¦¬ í˜ì´ì§€ì—ì„œ ê°ê° ë©”ë‰´ ë§í¬ í´ë¦­ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"Envoy Proxy Admin - http://localhost:19000"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"Envoy Proxy Admin - http://localhost:19000/stats/prometheus"</span>tZBli7jsXv<span class="s1">'XALZnaKnB2MSBvJNI
</span></code></pre></div></div>

<p>For this exercise, letâ€™s view <strong>two</strong> of the relevant <strong>metrics</strong> from the first part of this exercise: one that counts the <strong>number</strong> of <strong>successful</strong> (HTTP 2xx) requests processed by our <code class="language-plaintext highlighter-rouge">httpbin</code> backend (or <strong><code class="language-plaintext highlighter-rouge">cluster</code></strong>, in Envoy terminology), and another that <strong>counts</strong> the number of requests <strong>returning</strong> server errors (HTTP <strong>5xx</strong>) from that same backend:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 2xx, 5xx ìš”ì²­ í™•ì¸</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> http://localhost:19000/stats | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s2">"(^cluster.kube-svc_httpbin-httpbin-8000_httpbin.upstream.*(2xx|5xx))"</span>
<span class="c"># =&gt; cluster.kube-svc_httpbin-httpbin-8000_httpbin.upstream_rq_2xx: 7</span>

<span class="c"># If we apply a curl request that forces a 500 failure from the httpbin backend, using the /status/500 endpoint, Iâ€™d expect the number of 2xx requests to remain the same, and the number of 5xx requests to increment by one:</span>
<span class="nv">$ </span>curl <span class="nt">-is</span> <span class="nt">-H</span> <span class="s2">"Host: api.example.com"</span> http://localhost:8080/api/httpbin/status/500
<span class="c"># =&gt; HTTP/1.1 500 Internal Server Error</span>
<span class="c">#    server: envoy</span>
<span class="c">#    date: Sat, 12 Oct 2024 17:02:53 GMT</span>
<span class="c">#    content-type: text/html; charset=utf-8</span>
<span class="c">#    access-control-allow-origin: *</span>
<span class="c">#    access-control-allow-credentials: true</span>
<span class="c">#    content-length: 0</span>
<span class="c">#    x-envoy-upstream-service-time: 38</span>

<span class="c"># 500ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ì 500ì—ëŸ¬ê°€ 1ê°œ ì¦ê°€í•˜ê³  2xxëŠ” ë³€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> http://localhost:19000/stats | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s2">"(^cluster.kube-svc_httpbin-httpbin-8000_httpbin.upstream.*(2xx|5xx))"</span>
<span class="c"># =&gt; cluster.kube-svc_httpbin-httpbin-8000_httpbin.upstream_rq_2xx: 7</span>
<span class="c">#    cluster.kube-svc_httpbin-httpbin-8000_httpbin.upstream_rq_5xx: 1</span>
</code></pre></div></div>

<h5 id="ì •ë¦¬">ì •ë¦¬</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kind delete cluster <span class="nt">--name</span> myk8s
<span class="c"># =&gt; Deleted nodes: [&amp;quot;myk8s-control-plane&amp;quot;]</span>
</code></pre></div></div>

<h3 id="ê¸°íƒ€-gateway-api-êµ¬í˜„ì²´">ê¸°íƒ€ Gateway API êµ¬í˜„ì²´</h3>

<ul>
  <li>
    <dl>
      <dt><strong><code class="language-plaintext highlighter-rouge">Cilium</code></strong></dt>
      <dd>Ciliumì€ CNIë¡œ ì•Œë ¤ì ¸ìˆì§€ë§Œ Gateway API ì—­í• ë„ ì§€ì›í•©ë‹ˆë‹¤.</dd>
    </dl>
    <ul>
      <li><strong>(ì°¸ê³ ) [OnlineLab] Cilium Gateway API - <a href="https://isovalent.com/labs/cilium-gateway-api/">Link</a></strong></li>
      <li><strong>(ì°¸ê³ ) [OnlineLab] Advanced Gateway API Use Cases - <a href="https://isovalent.com/labs/cilium-gateway-api-advanced/">Link</a></strong></li>
    </ul>
  </li>
  <li>
    <dl>
      <dt><strong><code class="language-plaintext highlighter-rouge">Istio</code></strong></dt>
      <dd>IstioëŠ” Service Meshë¡œ ì•Œë ¤ì ¸ìˆì§€ë§Œ Gateway API ì—­í• ë„ ì§€ì›í•©ë‹ˆë‹¤. Gateway API ìì²´ê°€ Service Meshì¸ Istio ë“±ì„ ì°¸ì¡°í•˜ì˜€ê¸°ì— ì–´ì°Œë³´ë©´ ë‹¹ì—°í•œ ì¼ì…ë‹ˆë‹¤.</dd>
    </dl>
    <ul>
      <li>Kubernetes Traffic Management: Combining Gateway API with Service Mesh for North-South and East-West Use Cases - <a href="https://medium.com/@disha.20.10/kubernetes-traffic-management-combining-gateway-api-with-service-mesh-for-north-south-and-63e39ad95dcc">Blog</a></li>
      <li>Istio Gateway API í™œìš©í•˜ê¸° <a href="https://devops-james.tistory.com/317">https://devops-james.tistory.com/317</a></li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">Kong API Gateway</code></strong>
    <ul>
      <li>Kong API Gateway ë¥¼ Gateway API í˜•íƒœ ì„¤ì¹˜ <a href="https://mokpolar.tistory.com/68">https://mokpolar.tistory.com/68</a></li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">Envoy Gateway</code></strong>
    <ul>
      <li>Envoy Gateway ì‚¬ìš©í•˜ì—¬ + ë¶€í•˜ë¶„ì‚° <a href="https://devops-james.tistory.com/320">https://devops-james.tistory.com/320</a></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>íŒŒë“œ í†µì‹ ì—ì„œ ë¶€í„° CNI, ì„œë¹„ìŠ¤(ClusterIP, NodePort, LoadBalancer)ë¥¼ ê±°ì³, ingress, gateway apiê¹Œì§€ ì™”ìŠµë‹ˆë‹¤.
ë‚˜ì¤‘ì— ë°°ìš´ ê¸°ìˆ ì´ ì´ì „ ê¸°ìˆ ì„ í•„ìš”ì—†ê²Œ ë§Œë“œëŠ” ë¶€ë¶„ë„ ìˆì§€ë§Œ, ê¸°ì´ˆì˜ ì¤‘ìš”ì„±ì„ ì•Œê¸°ì— ë”ìš± ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤.</p>

<p>ê·¸ëŸ°ë° gateway apië¥¼ ë§Œë“¤ë©´ì„œ ingressë¥¼ frozen í•˜ê²Œ ëœê²ƒì€ ì‚´ì§ ì¶©ê²©ì ì…ë‹ˆë‹¤.
ingressë¥¼ ì—†ì•¤ë‹¤ëŠ” ì–˜ê¸°ëŠ” ì—†ì§€ë§Œ ê²°êµ­ gateway apiê°€ ë” ì¢‹ì€ ê¸°ìˆ ì´ê³ , 
ingressëŠ” ì ì  ì ìœ ìœ¨ì„ ìƒë‹¤ê°€ ì¡°ìš©íˆ deprecated ë ê²ƒ ê°™ì€ ëŠë‚Œì…ë‹ˆë‹¤.
ingressê°€ ì‹¬ì‹¬í•˜ì§€ ì•Šë„ë¡ ë” ìì£¼ ì¨ì¤˜ì•¼ê² ìŠµë‹ˆë‹¤.</p>

<p>ì´ë²ˆì£¼ëŠ” íŠ¹íˆë‚˜ ì‹¤ìŠµì´ ë§ì•˜ë˜ê²ƒ ê°™ì€ë°, ë‹¤ë¥¸ ë¶„ë“¤ë„ ë‹¤ë“¤ ì˜ ìƒì¡´í–ˆìœ¼ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.
(ì¼ë‹¨ ì €ë¶€í„° ìŠ¤í„°ë””ì—ì„œ ìƒì¡´í•˜ê¸°ë¥¼ ë¹•ë‹ˆë‹¤.. :smile:)</p>]]></content><author><name></name></author><category term="kans" /><category term="kubernetes," /><category term="network," /><category term="linux" /><summary type="html"><![CDATA[ì´ë²ˆì£¼ì—ëŠ” ingressì™€ gateway api ì—ëŒ€í•´ ì•Œì•„ ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[KANS 3ê¸°] LoadBalancer(MetalLB), IPVS</title><link href="https://sweetlittlebird.github.io/posts/2024-10-05-KANS-Study-Week5/" rel="alternate" type="text/html" title="[KANS 3ê¸°] LoadBalancer(MetalLB), IPVS" /><published>2024-10-05T01:00:18+09:00</published><updated>2024-10-05T01:00:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/KANS%20Study%20-%20Week5</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2024-10-05-KANS-Study-Week5/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆ ì£¼ì—ëŠ” LoadBalancer ì„œë¹„ìŠ¤ì™€ MetalLB, ê·¸ë¦¬ê³  kube-proxyì˜ ëª¨ë“œì¤‘ í•˜ë‚˜ì¸ IPVSì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
KANS 3ê¸° 5ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="loadbalancer-ì„œë¹„ìŠ¤">LoadBalancer ì„œë¹„ìŠ¤</h2>

<h3 id="loadbalancerë€">LoadBalancerë€?</h3>

<ul>
  <li>LoadBalancerëŠ” Kubernetesì˜ Service ìœ í˜•ì˜ í•˜ë‚˜ë¡œ, í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„œë¹„ìŠ¤ë¥¼
ë…¸ì¶œì‹œí‚¤ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.</li>
  <li>Kubernetesì—ì„œëŠ” ìì²´ì ìœ¼ë¡œ LoadBalancerë¥¼ ì œê³µí•˜ì§€ ì•Šê³ , í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì œê³µì—…ì²´ì˜ LoadBalancer(AWSì˜ ALB, NLB),
LoadBalancer í•˜ë“œì›¨ì–´ ì¥ë¹„(Citrix, F5 networks), ë˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ LoadBalancer (MetalLB ë“±)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>ê¸°ë³¸ì ìœ¼ë¡œ LoadBalancerë¥¼ ì‚¬ìš©í•˜ë©´ NodePortë¥¼ ë¨¼ì € ìƒì„±í•œ ë‹¤ìŒ LoadBalancerì™€ ì—°ê²°í•´ì•¼ í•˜ì§€ë§Œ (NodePort ì ‘ê·¼ ë°©ì‹),
êµ¬ì„±ì— ë”°ë¼ NodePort ì—†ì´ ë°”ë¡œ LoadBalancerë¥¼ ìƒì„±í•  ìˆ˜ë„ (Pod Direct ì ‘ê·¼ ë°©ì‹) ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="í™˜ê²½ë³„-loadbalancer">í™˜ê²½ë³„ LoadBalancer</h3>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_1.png" alt="í™˜ê²½ë³„ LoadBalancer ë¹„êµ" class="image-center" />
<em class="image-caption">í™˜ê²½ë³„ LoadBalancer ë¹„êµ</em></p>

<h4 id="í´ë¼ìš°ë“œ-ì„œë¹„ìŠ¤-ì œê³µì—…ì²´ì˜-loadbalancer">í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì œê³µì—…ì²´ì˜ LoadBalancer</h4>

<ul>
  <li>í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì œê³µì—…ì²´ì˜ LoadBalancerëŠ” í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì œê³µì—…ì²´ê°€ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ë¡œ, í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì œê³µì—…ì²´ì˜
LoadBalancerë¥¼ ì‚¬ìš©í•˜ë©´ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì œê³µì—…ì²´ì˜ LoadBalancerë¥¼ í†µí•´ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ì„œë¹„ìŠ¤ì—
ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>í•˜ì§€ë§Œ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì œê³µì—…ì²´ë§ˆë‹¤ ë™ì‘ ë°©ì‹ê³¼ ê¸°ëŠ¥ì´ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ê° í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì œê³µì—…ì²´ì˜ LoadBalancerë¥¼
ì‚¬ìš©í•  ë•ŒëŠ” í•´ë‹¹ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì œê³µì—…ì²´ì˜ LoadBalancerì˜ ë™ì‘ ë°©ì‹ê³¼ ê¸°ëŠ¥ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>ëŒ€í‘œì ì¸ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì œê³µì—…ì²´ì¸ Amazon Web ServiceëŠ” ë‹¤ìŒì˜ LoadBalancerë¥¼ ì œê³µí•©ë‹ˆë‹¤.
    <ul>
      <li><strong>Classic Load Balancer (CLB)</strong> : ê°€ì¥ ì˜¤ë˜ëœ ë¡œë“œë°¸ëŸ°ì„œë¡œ NLB, ALBë³´ë‹¤ ê¸°ëŠ¥ì´ ì ìŠµë‹ˆë‹¤.</li>
      <li><strong>Network Load Balancer (NLB)</strong> : Layer 4 ê³„ì¸µì˜ ë„¤íŠ¸ì›Œí¬ ë¡œë“œë°¸ëŸ°ì„œë¡œ TCP/UDP/TLS íŠ¸ë˜í”½ì„ ì§€ì›í•©ë‹ˆë‹¤. CLB/ALBì— ë¹„í•´ì„œ ì²˜ë¦¬ì†ë„ê°€ ë¹ ë¦…ë‹ˆë‹¤.
(<strong>Application Load Balancer (ALB)</strong>ëŠ” Layer 7 ê³„ì¸µì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë“œë°¸ëŸ°ì„œë¡œ http/https/gRPC íŠ¸ë˜í”½ì„ ì§€ì›í•©ë‹ˆë‹¤. ALBëŠ” Ingressì‹œ ìƒì„±ë©ë‹ˆë‹¤.)</li>
    </ul>
  </li>
</ul>

<h5 id="í´ë¼ìš°ë“œ-ì„œë¹„ìŠ¤-ì œê³µì—…ì²´ì˜-loadbalancer-ì„œë¹„ìŠ¤-ë™ì‘-ë°©ì‹">í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì œê³µì—…ì²´ì˜ LoadBalancer ì„œë¹„ìŠ¤ ë™ì‘ ë°©ì‹</h5>

<ol>
  <li>NodePort ì ‘ê·¼ ë°©ì‹
<img src="/assets/2024/kans-3th/w5/20241005_kans_w5_3.png" alt="img.png" class="w-80 image-center" />
    <ul>
      <li>ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ëŠ” LoadBalancerì˜ IP ì£¼ì†Œë¡œ ìš”ì²­ì„ ë³´ë‚´ë©´ LoadBalancerëŠ” ìš”ì²­ì„ ë°›ì•„ì„œ ë…¸ë“œë“¤ì˜ NodePortë¡œ ë¶€í•˜ë¥¼ ë¶„ì‚°í•˜ì—¬ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
      <li>ì´ë•Œ NodePortë¡œ ì¸ì… í›„ì— iptablesë¥¼ í†µí•´ íŒŒë“œë¡œ ëœë¤ ë¶€í•˜ë¶„ì‚°ì„ í†µí•´ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
      <li>ì´ ê³¼ì •ì—ì„œ DNATë¥¼ í†µí•œ ë¶€í•˜ ë¶„ì‚°ê³¼ì •ì´ ë‘ë²ˆ ìˆ˜í–‰ë©ë‹ˆë‹¤. (LoadBalancerì—ì„œ NodePortë¡œ ì „ë‹¬ë ë•Œ, ë…¸ë“œì˜ iptables ë£°ë¡œ íŒŒë“œ IPë¡œ ì „ë‹¬ë ë•Œ)</li>
    </ul>
  </li>
  <li>Pod Direct ì ‘ê·¼ ë°©ì‹
<img src="/assets/2024/kans-3th/w5/20241005_kans_w5_4.png" alt="img.png" class="w-80 image-center" />
    <ul>
      <li>LoadBalancerì—ì„œ íŒŒë“œì˜ IPë¡œ ì§ì ‘ ë¶€í•˜ë¶„ì‚°í•´ì„œ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
      <li>LoadBalancerê°€ íŒŒë“œì˜ IP ì •ë³´ë¥¼ ì•Œê¸° ìœ„í•´ì„œ, ë³„ë„ì˜ LoadBalancer Controllerë¥¼ êµ¬ì„±í•˜ê³  LoadBalancer Controllerê°€ 
LoadBalancerì—ê²Œ íŒŒë“œì˜ IPë¥¼ ë™ì ìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
      <li>ì´ ê³¼ì •ì—ì„œ ë¶€í•˜ ë¶„ì‚°ê³¼ì •ì´ í•œë²ˆ ìˆ˜í–‰ë˜ë©° NodePort ë°©ì‹ ë³´ë‹¤ íš¨ìœ¨ ì ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ol>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_2.png" alt="í´ë¼ìš°ë“œì˜ LoadBalancer ì œê³µ ë°©ì‹ ë¹„êµ" class="image-center" />
<em class="image-caption">í´ë¼ìš°ë“œì˜ LoadBalancer ì œê³µ ë°©ì‹ ë¹„êµ</em></p>

<h4 id="ì˜¨í”„ë ˆë¯¸ìŠ¤-í™˜ê²½ì—ì„œì˜-loadbalancer">ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œì˜ LoadBalancer</h4>

<h5 id="í•˜ë“œì›¨ì–´-ì¥ë¹„-ê¸°ë°˜-loadbalancer-ì„œë¹„ìŠ¤-ë™ì‘-ë°©ì‹">í•˜ë“œì›¨ì–´ ì¥ë¹„ ê¸°ë°˜ LoadBalancer ì„œë¹„ìŠ¤ ë™ì‘ ë°©ì‹</h5>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_5.png" alt="img.png" class="w-80 image-center" /></p>
<ul>
  <li>í•˜ë“œì›¨ì–´ ì¥ë¹„ ê¸°ë°˜ LoadBalancerëŠ” AWS LoadBalancer ì„œë¹„ìŠ¤ì™€ ê±°ì˜ ë™ì¼í•˜ê²Œ ë³„ë„ì˜ ì¥ë¹„ë¡œ ì ‘ì† í›„ ë…¸ë“œì— NodePort í˜¹ì€ íŒŒë“œë¡œ ì§ì ‘
ì „ë‹¬í•˜ì—¬ í†µì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ëŒ€í‘œì ìœ¼ë¡œ Citrix, F5 Networksì˜ ì œí’ˆ ë“±ì´ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì˜ˆì‹œ) Citrix ADC for K8S - <a href="https://www.citrix.com/blogs/2019/09/16/citrix-adc-for-kubernetes-service-of-type-loadbalancer/">ë§í¬</a> &amp; Citrix ADC(Ingress/Service) with k8s - <a href="https://www.notion.so/e57b6056f1334c9094f444d1c183f378">ë§í¬</a>
<img src="/assets/2024/kans-3th/w5/20241005_kans_w5_17.png" alt="img.png" /></li>
</ul>

<h5 id="ì†Œí”„íŠ¸ì›¨ì–´-ê¸°ë°˜-loadbalancer-ì„œë¹„ìŠ¤-ë™ì‘-ë°©ì‹">ì†Œí”„íŠ¸ì›¨ì–´ ê¸°ë°˜ LoadBalancer ì„œë¹„ìŠ¤ ë™ì‘ ë°©ì‹</h5>

<ul>
  <li>ì†Œí”„íŠ¸ì›¨ì–´ ê¸°ë°˜ LoadBalancerëŠ” ë³„ë„ì˜ ë„¤íŠ¸ì›Œí¬ ì¥ë¹„ ì—†ì´ ì†Œí”„íŠ¸ì›¨ì–´ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</li>
  <li>ëŒ€í‘œì ìœ¼ë¡œ MetalLB, OpenELB, PubeLB, kube-vip, LoxiLB ë“±ì´ ìˆìŠµë‹ˆë‹¤.</li>
  <li>MetalLBì— ëŒ€í•´ì„œëŠ” ì¢€ ë” ìì„¸íˆ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="metallb">MetalLB</h3>

<ul>
  <li>MetalLBëŠ” Bare<strong>MetalL</strong>oad<strong>B</strong>alancerì˜ ì•½ìë¡œ, ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì˜¤í”ˆì†ŒìŠ¤ LoadBalancerì…ë‹ˆë‹¤.</li>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” DaemonSetìœ¼ë¡œ Speaker íŒŒë“œë¥¼ ìƒì„±í•˜ì—¬ External IPë¥¼ ì „íŒŒí•©ë‹ˆë‹¤. External IPëŠ” ë…¸ë“œì˜ IP ëŒ€ì‹  ì™¸ë¶€ì—ì„œ 
ì ‘ì†í•  ìˆ˜ ìˆëŠ” IP ì…ë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ í†µí•´ ë…¸ë“œì˜ IPë¥¼ ì™¸ë¶€ì— ë…¸ì¶œí•˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´ì„œ ë³´ì•ˆì„±ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Speaker íŒŒë“œëŠ” External IP ì „íŒŒë¥¼ ìœ„í•´ í‘œì¤€ í”„ë¡œí† ì½œì¸ ARP(Address Resolution Protocol) í˜¹ì€ BGP(Border Gateway Protocol)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>MetalLBëŠ” ì¼ë¶€ í¼ë¸”ë¦­ í´ë¼ìš°ë“œ í”Œë«í¼ í™˜ê²½ì—ì„œ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ìœ ëŠ” ê°€ìƒì„œë²„ IPì— ë§¤ì¹­ë˜ëŠ” MAC ì£¼ì†Œê°€ ì•„ë‹Œ IPì— ëŒ€í•œ ARP ìš”ì²­ì„ ì°¨ë‹¨í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
  <li>ë˜í•œ ì¼ë¶€ CNIì—ì„œì˜ ë™ì‘ì— ì´ìŠˆê°€ ìˆìŠµë‹ˆë‹¤. Calicoì˜ IPIP ëª¨ë“œì—ì„œ BGP ì‚¬ìš©ì‹œ MetalLBì˜ BGPì™€ ì¶©ëŒì´ ìƒê²¨ ë¬¸ì œê°€ ë°œìƒí•˜ê³¤ í•©ë‹ˆë‹¤.</li>
  <li>ì‹¤ë¬´ì—ì„œ ì‚¬ìš©ì‹œì—ëŠ” ì´ìŠˆë‚˜ ì œì•½ì‚¬í•­ì„ í™•ì¸í•˜ê³ , ì‚¬ì „ í…ŒìŠ¤íŠ¸ ì§„í–‰í›„ ì‚¬ìš©í•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="layer2-ëª¨ë“œ">Layer2 ëª¨ë“œ</h4>

<ul>
  <li>Layer2 ëª¨ë“œëŠ” ARP(Address Resolution Protocol)ë¥¼ í†µí•´ì„œ External IPë¥¼ ì „íŒŒí•©ë‹ˆë‹¤.</li>
  <li>ARPë€?
<img src="/assets/2024/kans-3th/w5/20241005_kans_w5_6.png" alt="img.png" class="w-80 image-center" />
<em class="image-caption">ARP ë™ì‘ ëª¨ì‹ë„ (<a href="https://velog.io/@louie/ARPAddress-Resolution-Protocol">ì¶œì²˜</a>)</em>
    <ul>
      <li>ë™ì¼ ë„¤íŠ¸ì›Œí¬ ë‚´ë¶€ì—ì„œ í†µì‹ ì„ ìœ„í•´ì„œëŠ” ìƒëŒ€ë°©ì˜ MAC(Media Access Control) ì£¼ì†Œë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>ì´ë•Œ IP ì£¼ì†Œë¥¼ ì „ì†¡í•˜ë©´ì„œ ì´ IPì˜ ì£¼ì¸ì˜ MAC ì£¼ì†Œë¥¼ ì•Œë ¤ë‹¬ë¼ëŠ” íŒ¨í‚·ì„ ë³´ë‚´ë©´, í•´ë‹¹ IP ì£¼ì†Œë¥¼ ê°€ì§„ í˜¸ìŠ¤íŠ¸ì—ì„œ ìì‹ ì˜ MAC ì£¼ì†Œë¥¼ ì‘ë‹µí•©ë‹ˆë‹¤.</li>
      <li>ì´ê²ƒì´ ARPì˜ ë™ì‘ ë°©ì‹ì´ë©°, ARP í…Œì´ë¸”ì— IPì™€ MAC ì£¼ì†Œë¥¼ ì €ì¥í•˜ê³ , ì´í›„ í†µì‹ ì‹œ ARP í…Œì´ë¸”ì„ ì°¸ì¡°í•˜ì—¬ í†µì‹ ì„ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ARPì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì•˜ìœ¼ë‹ˆ Layer2 ë™ì‘ì— ëŒ€í•´ ë‹¤ì‹œ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w5/20241005_kans_w5_7.png" alt="img.png" class="image-center" />
<em class="image-caption">MetalLB Layer2 ë™ì‘ (ì¶œì²˜: ì¶”ê°€ì˜ˆì •)</em></li>
  <li>ìœ„ì˜ ê·¸ë¦¼ì—ì„œ í˜¸ìŠ¤íŠ¸ NS/íŒŒë“œ NSì˜ NSëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì˜ë¯¸í•˜ë©°, ì—¬ê¸°ì„œì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ì²«ì£¼ì°¨ ì»¨í…Œì´ë„ˆ ê²©ë¦¬ì—ì„œ ë°°ì› ë˜
Linux OS ì°¨ì›ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
  <li>íë¦„ì„ íŒŒì•…í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.
    <ol>
      <li>LoadBalancer ì„œë¹„ìŠ¤ ë¦¬ì†ŒìŠ¤ ìƒì„±ì‹œ MetalLB ìŠ¤í”¼ì»¤ íŒŒë“œì¤‘ì— ë¦¬ë”(Leader) ìŠ¤í”¼ì»¤ íŒŒë“œê°€ ì„ íƒë©ë‹ˆë‹¤. ë¦¬ë” ìŠ¤í”¼ì»¤ íŒŒë“œëŠ”
í•´ë‹¹ LoadBalancer ì„œë¹„ìŠ¤ì˜ External IPë¥¼ ê°€ì§€ê³  ARP ì‘ë‹µì„ í•©ë‹ˆë‹¤. ë˜í•œ GARP(Gratuitous ARP)ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ ë‚´ì˜ ëª¨ë“  í˜¸ìŠ¤íŠ¸ì—ê²Œ
í•´ë‹¹ External IPì˜ MAC ì£¼ì†Œë¥¼ ì „íŒŒí•©ë‹ˆë‹¤.
        <ul>
          <li>ë°ëª¬ì…‹ìœ¼ë¡œ ë°°í¬ëœ speaker íŒŒë“œëŠ” <code class="language-plaintext highlighter-rouge">NetworkMode: host</code>ë¡œ í˜¸ìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê³µìœ í•˜ë©°, í˜¸ìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ARP ì‘ë‹µì„ í•©ë‹ˆë‹¤.</li>
          <li>ë§Œì•½ ë¦¬ë” ìŠ¤í”¼ì»¤ íŒŒë“œì— ì¥ì• ê°€ ë°œìƒí•˜ë©´, ë‹¤ë¥¸ ìŠ¤í”¼ì»¤ íŒŒë“œê°€ ë¦¬ë” ìŠ¤í”¼ì»¤ íŒŒë“œë¡œ ì„ ì¶œë©ë‹ˆë‹¤.
            <ul>
              <li>ë©¤ë²„ ë¦¬ìŠ¤í„° ë° ìì•  ë°œê²¬ì€ hashicorpì˜ memberlistë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>í´ë¼ì´ì–¸íŠ¸1ì´ SVC1ì˜ External IPë¡œ ì ‘ì†ì„ ì‹œë„í•˜ë©´, í•´ë‹¹ íŠ¸ë˜í”½ì€ SVC1ì˜ External IP ì •ë³´ë¥¼ ì „íŒŒí•˜ëŠ” ë¦¬ë” ìŠ¤í”¼ì»¤íŒŒë“œê°€ 
ìˆëŠ” ë…¸ë“œ1ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤. ë˜í•œ í´ë¼ì´ì–¸íŠ¸2ëŠ” SVC2ì˜ External IPë¡œ ì ‘ì†ì„ ì‹œë„í•˜ë©´, í•´ë‹¹ íŠ¸ë˜í”½ì€ SVC2ì˜ External IP ì •ë³´ë¥¼ ì „íŒŒí•˜ëŠ”
ë¦¬ë” ìŠ¤í”¼ì»¤íŒŒë“œê°€ ìˆëŠ” ë…¸ë“œ3ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</li>
      <li>ë…¸ë“œì— ë„ì°©í•œ íŠ¸ë˜í”½ì€ í•´ë‹¹ ë…¸ë“œì˜ iptablesë¥¼ í†µí•´ ClusterIPì™€ ë™ì¼í•˜ê²Œ í•´ë‹¹ ì„œë¹„ìŠ¤ì— ì—°ë™ëœ ì—”ë“œí¬ì¸íŠ¸ íŒŒë“œë“¤ë¡œ
(4) ëœë¤ ë¶€í•˜ë¶„ì‚° ë˜ì–´ ì „ë‹¬ë©ë‹ˆë‹¤.</li>
    </ol>
  </li>
  <li>Layer2 ëª¨ë“œì˜ ë‹¨ì 
    <ul>
      <li>single-node bottlenecking : ë¦¬ë” ìŠ¤í”¼ì»¤ íŒŒë“œê°€ ìˆëŠ” ë…¸ë“œì—ë§Œ íŠ¸ë˜í”½ì´ ì¸ì…ë˜ì–´ ë¶€í•˜ê°€ ì§‘ì¤‘ ë©ë‹ˆë‹¤.</li>
      <li>potentially slow failover : ë¦¬ë” ìŠ¤í”¼ì»¤ íŒŒë“œì— ì¥ì• ê°€ ë°œìƒí•˜ë©´, ë‚˜ë¨¸ì§€ ë…¸ë“œ ë¦¬ë”ê°€ ì„ ì¶œë˜ê³ , ARP ì „íŒŒ ë° ê°±ì‹  ì™„ë£Œì „ê¹Œì§€ëŠ”
ì¥ì• ê°€ ë°œìƒë©ë‹ˆë‹¤. (ëŒ€ëµ 10ì´ˆ~20ì´ˆ ì†Œìš”)</li>
    </ul>
  </li>
</ul>

<h4 id="bgp-ëª¨ë“œ">BGP ëª¨ë“œ</h4>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_8.png" alt="img.png" /></p>

<ul>
  <li>BGP ëª¨ë“œëŠ” Routing í”„ë¡œí† ì½œì¸ BGP(Border Gateway Protocol)ë¥¼ í†µí•´ì„œ External IPë¥¼ ì „íŒŒí•©ë‹ˆë‹¤.
    <ul>
      <li>ê¸°ë³¸ì€ IPì£¼ì†Œ(32bit)ë¥¼ ì „íŒŒí•˜ë©°, ì„¤ì •ìœ¼ë¡œ ì¶•ì•½ëœ ë„¤íŠ¸ì›Œí¬ ì •ë³´ë¥¼ ì „íŒŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (bgp-advertisementsì— aggregation-length ì„¤ì •)</li>
      <li>BGP ì»¤ë®¤ë‹ˆí‹°, localpref ë“± ë‹¤ì–‘í•œ BGP ì†ì„±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>IP ì£¼ì†Œì˜ ë§ˆì§€ë§‰ì´ 0ê³¼ 255ë¡œ ëë‚˜ëŠ” IPë¥¼ ì²˜ë¦¬ ëª»í•˜ëŠ” ë¼ìš°í„° ì¥ë¹„ê°€ ìˆëŠ” ê²½ìš° <code class="language-plaintext highlighter-rouge">avoid-buggy-ips: true</code> ì„¤ì •ì„ í†µí•´ IPê°€ 0ê³¼ 255ë¡œ ëë‚˜ëŠ” IPë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì™¸ë¶€ì—ì„œ ë¼ìš°í„°ë¥¼ í†µí•´ ECMP(Equal Cost Multi Path) ë¼ìš°íŒ…ì„ í†µí•´ ë¶€í•˜ ë¶„ì‚°ì„ ì§€ì›í•©ë‹ˆë‹¤.
    <ul>
      <li>ì¼ë°˜ì ìœ¼ë¡œ ECMPëŠ” 5-tuple(í”„ë¡œí† ì½œ, ì¶œë°œì§€ IP, ëª©ì ì§€ IP, ì¶œë°œì§€ í¬íŠ¸, ëª©ì ì§€ í¬íŠ¸)ì„ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</li>
      <li>ë¼ìš°í„° ì¥ë¹„ì— ë”°ë¼ ë‹¤ì–‘í•œ ë¼ìš°íŒ…(ë¶„ì‚°) ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>BGP ëª¨ë“œì˜ ì œí•œì‚¬í•­
    <ul>
      <li>ë¼ìš°í„°ì—ì„œ ì„œë¹„ìŠ¤ë¡œ ì¸ì…ì´ ë˜ê¸° ë•Œë¬¸ì—, ë¼ìš°í„° ì„¤ì •ì´ ì¤‘ìš”í•˜ë©° ë„¤íŠ¸ì›Œí¬ íŒ€ê³¼ í˜‘ì—…ì´ ê¶Œì¥ë©ë‹ˆë‹¤.</li>
      <li>Speaker ë…¸ë“œ íŒŒë“œ ì¥ì• ì‹œ BGP Timer ì„¤ì • ë“±, êµ¬ì„±í•˜ê³  ìˆëŠ” ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì— ë§ê²Œ ìµœì í™” ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
      <li>ECMP ë¶€í•˜ ë¶„ì‚° ì ‘ì†ì‹œ íŠ¹ì • íŒŒë“œì— ë¶€í•˜ê°€ ì§‘ì¤‘ë˜ê±°ë‚˜, ì„¸ì…˜ ê³ ì •, flapping ë“± ë‹¤ì–‘í•œ í™˜ê²½ì— ëŒ€ì‘ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
      <li>BGP ë¼ìš°íŒ… ì„¤ì • ë° ë¼ìš°íŒ… ì „íŒŒ ê´€ë ¨ ìµœì í™” ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="metallb-ì‹¤ìŠµ">MetalLB ì‹¤ìŠµ</h3>

<h4 id="ì‹¤ìŠµí™˜ê²½-ì¤€ë¹„">ì‹¤ìŠµí™˜ê²½ ì¤€ë¹„</h4>

<ul>
  <li>ì´ë²ˆì—ë„ KINDë¥¼ í†µí•´ ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="kind-í´ëŸ¬ìŠ¤í„°-êµ¬ì„±">KIND í´ëŸ¬ìŠ¤í„° êµ¬ì„±</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kind í´ëŸ¬ìŠ¤í„° ì„¤ì • íŒŒì¼ ì‘ì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; kind-svc-2w.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
featureGates:
  "InPlacePodVerticalScaling": true  #ì‹¤í–‰ ì¤‘ì¸ íŒŒë“œì˜ ë¦¬ì†ŒìŠ¤ ìš”ì²­ ë° ì œí•œì„ ë³€ê²½í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
  "MultiCIDRServiceAllocator": true  #ì„œë¹„ìŠ¤ì— ëŒ€í•´ ì—¬ëŸ¬ CIDR ë¸”ë¡ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
nodes:
- role: control-plane
  labels:
    mynode: control-plane
    topology.kubernetes.io/zone: ap-northeast-2a
  extraPortMappings:  #ì»¨í…Œì´ë„ˆ í¬íŠ¸ë¥¼ í˜¸ìŠ¤íŠ¸ í¬íŠ¸ì— ë§¤í•‘í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  - containerPort: 30003
    hostPort: 30003
  - containerPort: 30004
    hostPort: 30004
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
      extraArgs:  #API ì„œë²„ì— ì¶”ê°€ ì¸ìˆ˜ë¥¼ ì œê³µ
        runtime-config: api/all=true  #ëª¨ë“  API ë²„ì „ì„ í™œì„±í™”
    controllerManager:
      extraArgs:
        bind-address: 0.0.0.0
    etcd:
      local:
        extraArgs:
          listen-metrics-urls: http://0.0.0.0:2381
    scheduler:
      extraArgs:
        bind-address: 0.0.0.0
  - |
    kind: KubeProxyConfiguration
    metricsBindAddress: 0.0.0.0
- role: worker
  labels:
    mynode: worker1
    topology.kubernetes.io/zone: ap-northeast-2a
- role: worker
  labels:
    mynode: worker2
    topology.kubernetes.io/zone: ap-northeast-2b
- role: worker
  labels:
    mynode: worker3
    topology.kubernetes.io/zone: ap-northeast-2c
networking:
  podSubnet: 10.10.0.0/16  #íŒŒë“œ IPë¥¼ ìœ„í•œ CIDR ë²”ìœ„ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. íŒŒë“œëŠ” ì´ ë²”ìœ„ì—ì„œ IPë¥¼ í• ë‹¹ë°›ìŠµë‹ˆë‹¤.
  serviceSubnet: 10.200.1.0/24  #ì„œë¹„ìŠ¤ IPë¥¼ ìœ„í•œ CIDR ë²”ìœ„ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ëŠ” ì´ ë²”ìœ„ì—ì„œ IPë¥¼ í• ë‹¹ë°›ìŠµë‹ˆë‹¤.
</span><span class="no">EOT

</span><span class="c"># k8s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-svc-2w.yaml <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.31.0
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                                             NAMES</span>
<span class="c">#    83661e652fb1   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   39 seconds ago   Up 34 seconds   0.0.0.0:30000-30004-&amp;gt;30000-30004/tcp, 127.0.0.1:59215-&amp;gt;6443/tcp   myk8s-control-plane</span>
<span class="c">#    242777ad8f3c   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   39 seconds ago   Up 34 seconds                                                                     myk8s-worker</span>
<span class="c">#    f8022585c864   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   39 seconds ago   Up 34 seconds                                                                     myk8s-worker2</span>
<span class="c">#    80988133cdfc   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   39 seconds ago   Up 34 seconds                                                                     myk8s-worker3</span>

<span class="c"># ë…¸ë“œì— ê¸°ë³¸ íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget bsdmainutils bridge-utils net-tools dnsutils ipset ipvsadm nfacct tcpdump ngrep iputils-ping arping git vim arp-scan -y'</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget bsdmainutils bridge-utils net-tools dnsutils ipset ipvsadm nfacct tcpdump ngrep iputils-ping arping -y'</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># k8s v1.31.0 ë²„ì „ í™•ì¸</span>
<span class="nv">$ </span>kubectl get node
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE    VERSION</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   110s   v1.31.0</span>
<span class="c">#    myk8s-worker          Ready    &amp;lt;none&amp;gt;          100s   v1.31.0</span>
<span class="c">#    myk8s-worker2         Ready    &amp;lt;none&amp;gt;          100s   v1.31.0</span>
<span class="c">#    myk8s-worker3         Ready    &amp;lt;none&amp;gt;          100s   v1.31.0</span>

<span class="c"># ë…¸ë“œ labels í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].metadata.labels}"</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;kubernetes.io/hostname&amp;quot;: &amp;quot;myk8s-control-plane&amp;quot;,</span>
<span class="c">#      &amp;quot;mynode&amp;quot;: &amp;quot;control-plane&amp;quot;,</span>
<span class="c">#      ...</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;kubernetes.io/hostname&amp;quot;: &amp;quot;myk8s-worker&amp;quot;,</span>
<span class="c">#      &amp;quot;mynode&amp;quot;: &amp;quot;worker1&amp;quot;,</span>
<span class="c">#      ...</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;kubernetes.io/hostname&amp;quot;: &amp;quot;myk8s-worker2&amp;quot;,</span>
<span class="c">#      &amp;quot;mynode&amp;quot;: &amp;quot;worker2&amp;quot;,</span>
<span class="c">#      ...</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;kubernetes.io/hostname&amp;quot;: &amp;quot;myk8s-worker3&amp;quot;,</span>
<span class="c">#      &amp;quot;mynode&amp;quot;: &amp;quot;worker3&amp;quot;,</span>
<span class="c">#      ...</span>
<span class="c">#    }</span>

<span class="c"># kind network ì¤‘ ì»¨í…Œì´ë„ˆ(ë…¸ë“œ) IP(ëŒ€ì—­) í™•ì¸</span>
<span class="nv">$ </span>docker ps <span class="nt">-q</span> | xargs docker inspect <span class="nt">--format</span> <span class="s1">' '</span>
<span class="c"># =&gt; /myk8s-control-plane 172.20.0.5</span>
<span class="c">#    /myk8s-worker 172.20.0.4</span>
<span class="c">#    /myk8s-worker2 172.20.0.2</span>
<span class="c">#    /myk8s-worker3 172.20.0.3</span>

<span class="c"># íŒŒë“œCIDR ê³¼ Service ëŒ€ì—­ í™•ì¸ : CNIëŠ” kindnet ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system kubeadm-config <span class="nt">-oyaml</span> | <span class="nb">grep</span> <span class="nt">-i</span> subnet
<span class="c"># =&gt; podSubnet: 10.10.0.0/16</span>
<span class="c">#    serviceSubnet: 10.200.1.0/24</span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt; &amp;quot;--service-cluster-ip-range=10.200.1.0/24&amp;quot;,</span>
<span class="c">#    &amp;quot;--cluster-cidr=10.10.0.0/16&amp;quot;,</span>

<span class="c"># MultiCIDRServiceAllocator : https://kubernetes.io/docs/tasks/network/extend-service-ip-ranges/</span>
<span class="nv">$ </span>kubectl get servicecidr
<span class="c"># =&gt; NAME         CIDRS           AGE</span>
<span class="c">#    kubernetes   10.200.1.0/24   4m59s</span>

<span class="c"># ë…¸ë“œë§ˆë‹¤ í• ë‹¹ëœ dedicated subnet (podCIDR) í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].spec.podCIDR}"</span>
<span class="c"># =&gt; 10.10.0.0/24 10.10.3.0/24 10.10.2.0/24 10.10.1.0/24</span>

<span class="c"># kube-proxy configmap í™•ì¸</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kube-proxy
<span class="c"># =&gt; ...</span>
<span class="c">#    mode: iptables</span>
<span class="c">#    iptables:</span>
<span class="c">#      localhostNodePorts: null</span>
<span class="c">#      masqueradeAll: false</span>
<span class="c">#      masqueradeBit: null</span>
<span class="c">#      minSyncPeriod: 1s</span>
<span class="c">#      syncPeriod: 0s</span>
<span class="c">#    ...</span>

<span class="c"># ë…¸ë“œ ë³„ ë„¤íŠ¸ì›ŒíŠ¸ ì •ë³´ í™•ì¸ : CNIëŠ” kindnet ì‚¬ìš©</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> <span class="nb">cat</span> /etc/cni/net.d/10-kindnet.conflist<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    {</span>
<span class="c">#     &amp;quot;cniVersion&amp;quot;: &amp;quot;0.3.1&amp;quot;,</span>
<span class="c">#     &amp;quot;name&amp;quot;: &amp;quot;kindnet&amp;quot;,</span>
<span class="c">#     &amp;quot;plugins&amp;quot;: [</span>
<span class="c">#     {</span>
<span class="c">#       &amp;quot;type&amp;quot;: &amp;quot;ptp&amp;quot;,</span>
<span class="c">#       &amp;quot;ipMasq&amp;quot;: false,</span>
<span class="c">#       &amp;quot;ipam&amp;quot;: {</span>
<span class="c">#         &amp;quot;type&amp;quot;: &amp;quot;host-local&amp;quot;,</span>
<span class="c">#         &amp;quot;dataDir&amp;quot;: &amp;quot;/run/cni-ipam-state&amp;quot;,</span>
<span class="c">#         &amp;quot;routes&amp;quot;: [</span>
<span class="c">#           { &amp;quot;dst&amp;quot;: &amp;quot;0.0.0.0/0&amp;quot; }</span>
<span class="c">#         ],</span>
<span class="c">#         &amp;quot;ranges&amp;quot;: [</span>
<span class="c">#           [ { &amp;quot;subnet&amp;quot;: &amp;quot;10.10.0.0/24&amp;quot; } ]</span>
<span class="c">#         ]</span>
<span class="c">#       },</span>
<span class="c">#       &amp;quot;mtu&amp;quot;: 1500</span>
<span class="c">#     },</span>
<span class="c">#     ...</span>
<span class="c">#     ]</span>
<span class="c">#    }</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    default via &lt;span style="color:purple;"&gt;172.20.0.1 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.0.2 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;veth545bb56e &lt;/span&gt;scope host </span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.0.3 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;veth184fcd53 &lt;/span&gt;scope host </span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.0.4 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;vethc5dfe430 &lt;/span&gt;scope host </span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.1.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.3 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.2.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.2 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.3.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.4 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.0/16 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;proto kernel scope link src &lt;span style="color:purple;"&gt;172.20.0.5 &lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    default via &lt;span style="color:purple;"&gt;172.20.0.1 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.0.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.5 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.1.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.3 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.2.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.2 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.0/16 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;proto kernel scope link src &lt;span style="color:purple;"&gt;172.20.0.4 &lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker2 &amp;lt;&amp;lt;</span>
<span class="c">#    default via &lt;span style="color:purple;"&gt;172.20.0.1 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.0.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.5 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.1.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.3 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.3.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.4 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.0/16 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;proto kernel scope link src &lt;span style="color:purple;"&gt;172.20.0.2 &lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker3 &amp;lt;&amp;lt;</span>
<span class="c">#    default via &lt;span style="color:purple;"&gt;172.20.0.1 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.0.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.5 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.2.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.2 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.3.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.4 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.0/16 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;proto kernel scope link src &lt;span style="color:purple;"&gt;172.20.0.3 &lt;/span&gt;</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    1: &lt;span style="color:teal;"&gt;lo: &lt;/span&gt;&amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span>
<span class="c">#        link/loopback &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt; brd &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt;</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;127.0.0.1&lt;/span&gt;/8 scope host lo</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    2: &lt;span style="color:teal;"&gt;tunl0@NONE: &lt;/span&gt;&amp;lt;NOARP&amp;gt; mtu 1480 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ipip &lt;span style="color:olive;"&gt;0.0.0.0&lt;/span&gt; brd &lt;span style="color:olive;"&gt;0.0.0.0&lt;/span&gt;</span>
<span class="c">#    4: &lt;span style="color:teal;"&gt;veth545bb56e@if4: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;0e:8b:3c:4f:43:43&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns cni-98b7b37a-bb7a-ea56-47c9-ce3a0b1fb08a</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.10.0.1&lt;/span&gt;/32 scope global veth545bb56e</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    5: &lt;span style="color:teal;"&gt;vethc5dfe430@if4: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;8a:70:dd:42:02:96&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns cni-79ddddfd-6177-bbd6-5fdc-3f7f6bf07fdc</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.10.0.1&lt;/span&gt;/32 scope global vethc5dfe430</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    6: &lt;span style="color:teal;"&gt;veth184fcd53@if4: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;8a:92:74:11:f9:d9&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns cni-5e4ecb7e-2120-f372-76cc-9a467c85159b</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.10.0.1&lt;/span&gt;/32 scope global veth184fcd53</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    28: &lt;span style="color:teal;"&gt;eth0@if29: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;02:42:ac:14:00:05&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netnsid 0</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;172.20.0.5&lt;/span&gt;/16 brd &lt;span style="color:purple;"&gt;172.20.255.255 &lt;/span&gt;scope global eth0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    1: &lt;span style="color:teal;"&gt;lo: &lt;/span&gt;&amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span>
<span class="c">#        link/loopback &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt; brd &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt;</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;127.0.0.1&lt;/span&gt;/8 scope host lo</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    2: &lt;span style="color:teal;"&gt;tunl0@NONE: &lt;/span&gt;&amp;lt;NOARP&amp;gt; mtu 1480 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ipip &lt;span style="color:olive;"&gt;0.0.0.0&lt;/span&gt; brd &lt;span style="color:olive;"&gt;0.0.0.0&lt;/span&gt;</span>
<span class="c">#    26: &lt;span style="color:teal;"&gt;eth0@if27: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;02:42:ac:14:00:04&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netnsid 0</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;172.20.0.4&lt;/span&gt;/16 brd &lt;span style="color:purple;"&gt;172.20.255.255 &lt;/span&gt;scope global eth0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    ...</span>

<span class="c"># iptables ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker3 iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># ê° ë…¸ë“œ bash ì ‘ì†</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker3 bash
<span class="c"># ----------------------------------------</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="c"># ----------------------------------------</span>

<span class="c"># kind ì„¤ì¹˜ ì‹œ kind ì´ë¦„ì˜ ë„ì»¤ ë¸Œë¦¬ì§€ê°€ ìƒì„±ëœë‹¤ : 172.20.0.0/16 ëŒ€ì—­</span>
<span class="nv">$ </span>docker network <span class="nb">ls</span>
<span class="c"># =&gt; NETWORK ID     NAME                     DRIVER    SCOPE</span>
<span class="c">#    a8d530305515   bridge                   bridge    local</span>
<span class="c">#    8204a0851463   host                     host      local</span>
<span class="c">#    3bbcc6aa8f38   kind                     bridge    local</span>

<span class="nv">$ </span>docker inspect kind
<span class="c"># =&gt; [</span>
<span class="c">#        {</span>
<span class="c">#            &amp;quot;Name&amp;quot;: &amp;quot;kind&amp;quot;,</span>
<span class="c">#            &amp;quot;Id&amp;quot;: &amp;quot;3bbcc6aa8f388f86f02478f41de1e4dd917e5812b6cf6257972e4af0bedf5021&amp;quot;,</span>
<span class="c">#            &amp;quot;Created&amp;quot;: &amp;quot;2020-01-01T11:37:09.195259833Z&amp;quot;,</span>
<span class="c">#            &amp;quot;Scope&amp;quot;: &amp;quot;local&amp;quot;,</span>
<span class="c">#            &amp;quot;Driver&amp;quot;: &amp;quot;bridge&amp;quot;,</span>
<span class="c">#            &amp;quot;IPAM&amp;quot;: {</span>
<span class="c">#                &amp;quot;Driver&amp;quot;: &amp;quot;default&amp;quot;,</span>
<span class="c">#                &amp;quot;Options&amp;quot;: {},</span>
<span class="c">#                &amp;quot;Config&amp;quot;: [</span>
<span class="c">#                    {</span>
<span class="c">#                        &amp;quot;Subnet&amp;quot;: &amp;quot;172.20.0.0/16&amp;quot;,</span>
<span class="c">#                        &amp;quot;Gateway&amp;quot;: &amp;quot;172.20.0.1&amp;quot;</span>
<span class="c">#                    }</span>
<span class="c">#                ]</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;Internal&amp;quot;: false,</span>
<span class="c">#            &amp;quot;Attachable&amp;quot;: false,</span>
<span class="c">#            &amp;quot;Ingress&amp;quot;: false,</span>
<span class="c">#            &amp;quot;ConfigFrom&amp;quot;: {</span>
<span class="c">#                &amp;quot;Network&amp;quot;: &amp;quot;&amp;quot;</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;ConfigOnly&amp;quot;: false,</span>
<span class="c">#            &amp;quot;Containers&amp;quot;: {</span>
<span class="c">#                &amp;quot;242777ad8f3c7009963155c3d7c4551e1407570d6986d9ef6346e6d33990e538&amp;quot;: {</span>
<span class="c">#                    &amp;quot;Name&amp;quot;: &amp;quot;myk8s-worker&amp;quot;,</span>
<span class="c">#                    &amp;quot;EndpointID&amp;quot;: &amp;quot;f6fb304fa38125ed1075d9c71b83559cff5066e71630c272e94311258021144e&amp;quot;,</span>
<span class="c">#                    &amp;quot;MacAddress&amp;quot;: &amp;quot;02:42:ac:14:00:04&amp;quot;,</span>
<span class="c">#                    &amp;quot;IPv4Address&amp;quot;: &amp;quot;172.20.0.4/16&amp;quot;,</span>
<span class="c">#                },</span>
<span class="c">#                &amp;quot;80988133cdfcfaafe520b35cec924b9fa87f26ea474102b833e92d7ca693fb2b&amp;quot;: {</span>
<span class="c">#                    &amp;quot;Name&amp;quot;: &amp;quot;myk8s-worker3&amp;quot;,</span>
<span class="c">#                    &amp;quot;EndpointID&amp;quot;: &amp;quot;42aec973b496fdc7b8ede07c11fd94fe35631216d3ecd54d2ab794849b834787&amp;quot;,</span>
<span class="c">#                    &amp;quot;MacAddress&amp;quot;: &amp;quot;02:42:ac:14:00:03&amp;quot;,</span>
<span class="c">#                    &amp;quot;IPv4Address&amp;quot;: &amp;quot;172.20.0.3/16&amp;quot;,</span>
<span class="c">#                },</span>
<span class="c">#                &amp;quot;83661e652fb1d34542b760209f670f330e25b1c51c8c0404e69d47eb9c79f407&amp;quot;: {</span>
<span class="c">#                    &amp;quot;Name&amp;quot;: &amp;quot;myk8s-control-plane&amp;quot;,</span>
<span class="c">#                    &amp;quot;EndpointID&amp;quot;: &amp;quot;d1e1efb2d90b7d8e9ce16b6274a62e7799d923681739dc8826c36c8b122d09c0&amp;quot;,</span>
<span class="c">#                    &amp;quot;MacAddress&amp;quot;: &amp;quot;02:42:ac:14:00:05&amp;quot;,</span>
<span class="c">#                    &amp;quot;IPv4Address&amp;quot;: &amp;quot;172.20.0.5/16&amp;quot;,</span>
<span class="c">#                },</span>
<span class="c">#                &amp;quot;f8022585c864bd53b31b84e22e2b4381da6c5b7a2ada1583f18136e7f8c6b3b9&amp;quot;: {</span>
<span class="c">#                    &amp;quot;Name&amp;quot;: &amp;quot;myk8s-worker2&amp;quot;,</span>
<span class="c">#                    &amp;quot;EndpointID&amp;quot;: &amp;quot;0866892fb0c2c1c8c2021d92a665a130a20aae5b76fbdc1549138da642a60883&amp;quot;,</span>
<span class="c">#                    &amp;quot;MacAddress&amp;quot;: &amp;quot;02:42:ac:14:00:02&amp;quot;,</span>
<span class="c">#                    &amp;quot;IPv4Address&amp;quot;: &amp;quot;172.20.0.2/16&amp;quot;,</span>
<span class="c">#                }</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;Options&amp;quot;: {</span>
<span class="c">#                &amp;quot;com.docker.network.bridge.enable_ip_masquerade&amp;quot;: &amp;quot;true&amp;quot;,</span>
<span class="c">#                &amp;quot;com.docker.network.driver.mtu&amp;quot;: &amp;quot;1500&amp;quot;</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;Labels&amp;quot;: {}</span>
<span class="c">#        }</span>
<span class="c">#    ]</span>

<span class="c"># arp scan í•´ë‘ê¸°</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane arp-scan <span class="nt">--interfac</span><span class="o">=</span>eth0 <span class="nt">--localnet</span>
<span class="c"># =&gt; Interface: eth0, type: EN10MB, MAC: 02:42:ac:14:00:05, IPv4: 172.20.0.5</span>
<span class="c">#    Starting arp-scan 1.10.0 with 65536 hosts (https://github.com/royhills/arp-scan)</span>
<span class="c">#    172.20.0.1      02:42:a0:b9:45:0f       (Unknown: locally administered)</span>
<span class="c">#    172.20.0.2      02:42:ac:14:00:02       (Unknown: locally administered)</span>
<span class="c">#    172.20.0.3      02:42:ac:14:00:03       (Unknown: locally administered)</span>
<span class="c">#    172.20.0.4      02:42:ac:14:00:04       (Unknown: locally administered)</span>

<span class="c"># mypc ì»¨í…Œì´ë„ˆ ê¸°ë™ : kind ë„ì»¤ ë¸Œë¦¬ì§€ë¥¼ ì‚¬ìš©í•˜ê³ , ì»¨í…Œì´ë„ˆ IPë¥¼ ì§€ì • ì—†ì´ í˜¹ì€ ì§€ì • í•´ì„œ ì‚¬ìš©</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">--rm</span> <span class="nt">--name</span> mypc <span class="nt">--network</span> kind <span class="nt">--ip</span> 172.20.0.100 nicolaka/netshoot <span class="nb">sleep </span>infinity <span class="c"># IP ì§€ì • ì‹¤í–‰ ì‹œ</span>
<span class="c"># =&gt; docker: Error response from daemon: Invalid address 172.20.0.100: It does not belong to any of this network's subnets.</span>
<span class="c"># IP ì§€ì • ì‹¤í–‰ ì‹œ ì—ëŸ¬ ë°œìƒ ì‹œ ì•„ë˜ ì²˜ëŸ¼ IP ì§€ì • ì—†ì´ ì‹¤í–‰</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">--rm</span> <span class="nt">--name</span> mypc <span class="nt">--network</span> kind nicolaka/netshoot <span class="nb">sleep </span>infinity <span class="c"># IP ì§€ì • ì—†ì´ ì‹¤í–‰ ì‹œ</span>
<span class="c"># =&gt; 5863ee53a7334a4a524c8c965b2505237c43037ff33f435340b6c167e3484eb6</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                                             NAMES</span>
<span class="c">#    5863ee53a733   nicolaka/netshoot      &amp;quot;sleep infinity&amp;quot;         15 seconds ago   Up 14 seconds                                                                     mypc</span>
<span class="c">#    ...</span>

<span class="c"># mypc2 ì»¨í…Œì´ë„ˆ ê¸°ë™ : kind ë„ì»¤ ë¸Œë¦¬ì§€ë¥¼ ì‚¬ìš©í•˜ê³ , ì»¨í…Œì´ë„ˆ IPë¥¼ ì§€ì • ì—†ì´ í˜¹ì€ ì§€ì • í•´ì„œ ì‚¬ìš©</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">--rm</span> <span class="nt">--name</span> mypc2 <span class="nt">--network</span> kind <span class="nt">--ip</span> 172.20.0.200 nicolaka/netshoot <span class="nb">sleep </span>infinity <span class="c"># IP ì§€ì • ì‹¤í–‰ ì‹œ</span>
<span class="c"># =&gt; docker: Error response from daemon: Invalid address 172.20.0.200: It does not belong to any of this network's subnets.</span>
<span class="c"># IP ì§€ì • ì‹¤í–‰ ì‹œ ì—ëŸ¬ ë°œìƒ ì‹œ ì•„ë˜ ì²˜ëŸ¼ IP ì§€ì • ì—†ì´ ì‹¤í–‰</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">--rm</span> <span class="nt">--name</span> mypc2 <span class="nt">--network</span> kind nicolaka/netshoot <span class="nb">sleep </span>infinity <span class="c"># IP ì§€ì • ì—†ì´ ì‹¤í–‰ ì‹œ</span>
<span class="c"># =&gt; 0d1d3bc32161bafcf5e188e4788553c88cd278d0a2e8dac02d42216e80a9985c</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS              PORTS                                                             NAMES</span>
<span class="c">#    0d1d3bc32161   nicolaka/netshoot      &amp;quot;sleep infinity&amp;quot;         9 seconds ago        Up 7 seconds                                                                          mypc2</span>
<span class="c">#    5863ee53a733   nicolaka/netshoot      &amp;quot;sleep infinity&amp;quot;         About a minute ago   Up About a minute                                                                     mypc</span>
<span class="c">#    ...</span>

<span class="c"># kind network ì¤‘ ì»¨í…Œì´ë„ˆ(ë…¸ë“œ) IP(ëŒ€ì—­) í™•ì¸</span>
<span class="nv">$ </span>docker ps <span class="nt">-q</span> | xargs docker inspect <span class="nt">--format</span> <span class="s1">' '</span>
<span class="c"># =&gt; /myk8s-control-plane 172.20.0.5</span>
<span class="c">#    /myk8s-worker 172.20.0.4</span>
<span class="c">#    /myk8s-worker2 172.20.0.2</span>
<span class="c">#    /myk8s-worker3 172.20.0.3</span>
<span class="c">#    /mypc 172.20.0.6</span>
<span class="c">#    /mypc2 172.20.0.7</span>

<span class="c"># kube-ops-view ì„¤ì¹˜</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>NodePort,service.main.ports.http.nodePort<span class="o">=</span>30000 <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system
<span class="c"># =&gt; NAME: kube-ops-view</span>
<span class="c">#    LAST DEPLOYED: Sun Jan  1 15:57:45 2020</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    1. Get the application URL by running these commands:</span>
<span class="c">#      export NODE_PORT=$(kubectl get --namespace kube-system -o jsonpath="{.spec.ports[0].nodePort}" services kube-ops-view)</span>
<span class="c">#      export NODE_IP=$(kubectl get nodes --namespace kube-system -o jsonpath="{.items[0].status.addresses[0].address}")</span>
<span class="c">#      echo http://$NODE_IP:$NODE_PORT</span>

<span class="c"># myk8s-control-plane ë°°ì¹˜í•˜ê¸° ìœ„í•´ì„œ nodeSelector, tolerations ì„¤ì •</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system edit deploy kube-ops-view
<span class="c"># =&gt; ---</span>
<span class="c">#    spec:</span>
<span class="c">#      ...</span>
<span class="c">#      template:</span>
<span class="c">#        ...</span>
<span class="c">#        spec:</span>
<span class="c">#          nodeSelector:</span>
<span class="c">#            mynode: control-plane</span>
<span class="c">#          tolerations:</span>
<span class="c">#          - key: "node-role.kubernetes.io/control-plane"</span>
<span class="c">#            operator: "Equal"</span>
<span class="c">#            effect: "NoSchedule"</span>
<span class="c">#    ---</span>

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get pod <span class="nt">-o</span> wide <span class="nt">-l</span> app.kubernetes.io/instance<span class="o">=</span>kube-ops-view
<span class="c"># =&gt; NAME                             READY   STATUS              RESTARTS   AGE   IP       NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-ops-view-58f96c464d-kp8l8   0/1     ContainerCreating   0          5s    &amp;lt;none&amp;gt;   &lt;span style="color: red;"&gt;myk8s-control-plane&lt;/span&gt;   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 , 2 ë°°ìœ¨) : macOS ì‚¬ìš©ì</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:30000/#scale=1.5"</span>
<span class="c"># =&gt; KUBE-OPS-VIEW URL = http://localhost:30000/#scale=1.5</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:30000/#scale=2"</span>

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 , 2 ë°°ìœ¨) : Windows ì‚¬ìš©ì</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://192.168.50.10:30000/#scale=1.5"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://192.168.50.10:30000/#scale=2"</span>

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 , 2 ë°°ìœ¨) : AWS_EC2 ì‚¬ìš©ì</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:30000/#scale=1.5"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:30000/#scale=2"</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_9.png" alt="img.png" class="image-center" />
<em class="image-caption">ì‹¤ìŠµí™˜ê²½ì´ êµ¬ì¶• ì™„ë£Œëœ kube-ops-view í™”ë©´</em></p>

<h5 id="í”„ë¡œë©”í…Œìš°ìŠ¤-ìŠ¤íƒ-ì„¤ì¹˜">í”„ë¡œë©”í…Œìš°ìŠ¤ ìŠ¤íƒ ì„¤ì¹˜</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
<span class="c"># =&gt; "prometheus-community" has been added to your repositories</span>

<span class="c"># íŒŒë¼ë¯¸í„° íŒŒì¼ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; monitor-values.yaml
prometheus:
  service:
    type: NodePort
    nodePort: 30001

  prometheusSpec:
    podMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelectorNilUsesHelmValues: false
    nodeSelector:
      mynode: control-plane
    tolerations:
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Equal"
      effect: "NoSchedule"


grafana:
  defaultDashboardsTimezone: Asia/Seoul
  adminPassword: kans1234

  service:
    type: NodePort
    nodePort: 30002
  nodeSelector:
    mynode: control-plane
  tolerations:
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Equal"
    effect: "NoSchedule"

  #  sidecar:
  #    dashboards:
  #      enabled: true
  #  dashboards:
  #    default:
  #      custom-dashboard:
  #        gnetId: 20162  # MetalLB ëŒ€ì‹œë³´ë“œ ID
  #        datasource: Prometheus  # ì‚¬ìš©í•  ë°ì´í„°ì†ŒìŠ¤ ì´ë¦„ì„ ëª…ì‹œ
  #        revision: 1    # ëŒ€ì‹œë³´ë“œì˜ ë²„ì „

defaultRules:
  create: false
alertmanager:
  enabled: false
</span><span class="no">EOT

</span><span class="c"># ë°°í¬</span>
<span class="nv">$ </span>kubectl create ns monitoring
<span class="c"># =&gt; namespace/monitoring created</span>
<span class="nv">$ </span>helm <span class="nb">install </span>kube-prometheus-stack prometheus-community/kube-prometheus-stack <span class="nt">--version</span> 62.3.0 <span class="nt">-f</span> monitor-values.yaml <span class="nt">--namespace</span> monitoring
<span class="c"># =&gt; NAME: kube-prometheus-stack</span>
<span class="c">#    LAST DEPLOYED: Sun Jan  1 16:16:32 2020</span>
<span class="c">#    NAMESPACE: monitoring</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    NOTES:</span>
<span class="c">#    kube-prometheus-stack has been installed. Check its status by running:</span>
<span class="c">#      kubectl --namespace monitoring get pods -l &amp;quot;release=kube-prometheus-stack&amp;quot;</span>
<span class="c">#    </span>
<span class="c">#    Visit https://github.com/prometheus-operator/kube-prometheus for instructions on how to create &amp;amp; configure Alertmanager and Prometheus instances using the Operator.</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>helm list <span class="nt">-n</span> monitoring
<span class="c"># =&gt; NAME                   NAMESPACE   REVISION  UPDATED                               STATUS    CHART                         APP VERSION</span>
<span class="c">#    kube-prometheus-stack  monitoring  1         2020-01-01 16:16:32.988771 +0900 KST  deployed  kube-prometheus-stack-62.3.0  v0.76.0    </span>

<span class="c"># Grafana ì ‘ì† ê³„ì • : admin / kans1234 : macOS ì‚¬ìš©ì</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Prometheus URL = http://localhost:30001"</span>
<span class="c"># =&gt; Prometheus URL = http://localhost:30001</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Grafana URL = http://localhost:30002"</span>
<span class="c"># =&gt; Grafana URL = http://localhost:30002</span>

<span class="c"># Grafana ì ‘ì† ê³„ì • : admin / kans1234 : Windows ì‚¬ìš©ì</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Prometheus URL = http://192.168.50.10:30001"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Grafana URL = http://192.168.50.10:30002"</span>

<span class="c"># Grafana ì ‘ì† ê³„ì • : admin / kans1234 : AWS_EC2 ì‚¬ìš©ì</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Prometheus URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:30001"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Grafana URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:30002"</span>

<span class="c"># (ì°¸ê³ ) helm ì‚­ì œ</span>
<span class="nv">$ </span>helm uninstall <span class="nt">-n</span> monitoring kube-prometheus-stack
</code></pre></div></div>

<ul>
  <li>ê·¸ë¼íŒŒë‚˜ ì ‘ì† í›„ MetalLB ëŒ€ì‹œë³´ë“œ import
    <ul>
      <li>Dashboards &gt; Manage &gt; Import</li>
      <li>GnetId : 20162</li>
      <li>Datasource : Prometheus</li>
      <li>Import ë²„íŠ¼ í´ë¦­</li>
    </ul>
  </li>
  <li>ê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œ í™•ì¸
    <ul>
      <li>Home &gt; MetalLB ëŒ€ì‹œë³´ë“œ ì„ íƒ
<img src="/assets/2024/kans-3th/w5/20241005_kans_w5_10.png" alt="img.png" class="image-center" /></li>
    </ul>
  </li>
</ul>

<h5 id="íŒŒë“œ-ìƒì„±">íŒŒë“œ ìƒì„±</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: webpod1
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod2
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker2
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/webpod1 created</span>
<span class="c">#    pod/webpod2 created</span>

<span class="c"># íŒŒë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME      READY   STATUS    RESTARTS   AGE   IP          NODE            NOMINATED NODE   READINESS GATES</span>
<span class="c">#    webpod1   1/1     Running   0          38s   10.10.3.2   myk8s-worker    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    webpod2   1/1     Running   0          38s   10.10.2.3   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># íŒŒë“œ IPì£¼ì†Œë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
<span class="nv">$ WPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get pod webpod1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.podIP}"</span><span class="si">)</span>
<span class="nv">$ WPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get pod webpod2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.podIP}"</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WPOD1</span> <span class="nv">$WPOD2</span>
<span class="c"># =&gt; 10.10.3.2 10.10.2.3</span>

<span class="c"># ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  ping <span class="nt">-i</span> 1 <span class="nt">-W</span> 1 <span class="nt">-c</span> 1 <span class="nv">$WPOD1</span>
<span class="c"># =&gt; PING 10.10.3.2 (10.10.3.2) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 10.10.3.2: icmp_seq=1 ttl=63 time=0.082 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 10.10.3.2 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.082/0.082/0.082/0.000 ms</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  ping <span class="nt">-i</span> 1 <span class="nt">-W</span> 1 <span class="nt">-c</span> 1 <span class="nv">$WPOD2</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$WPOD1</span> | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod1</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$WPOD2</span> | <span class="nb">grep </span>Hostname
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$WPOD1</span> | egrep <span class="s1">'Hostname|RemoteAddr|Host:'</span>
<span class="c"># =&gt; Hostname: webpod1</span>
<span class="c">#    RemoteAddr: 172.20.0.5:41896</span>
<span class="c">#    Host: 10.10.3.2</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$WPOD2</span> | egrep <span class="s1">'Hostname|RemoteAddr|Host:'</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_11.png" alt="img.png" /></p>

<h4 id="metallb---layer2-ëª¨ë“œ-ì‹¤ìŠµ">MetalLB - Layer2 ëª¨ë“œ ì‹¤ìŠµ</h4>

<h5 id="metallb-ì„¤ì¹˜">MetalLB ì„¤ì¹˜</h5>

<ul>
  <li>ë§í¬ : <a href="https://metallb.universe.tf/installation/">https://metallb.universe.tf/installation/</a></li>
  <li>ì„¤ì¹˜ ë°©ë²• : Kubernetes manifests, Kustomize, using Helm
    <ul>
      <li>kube-proxyê°€ ipvs ëª¨ë“œ ì‚¬ìš©ì‹œ <code class="language-plaintext highlighter-rouge">strictARP: true</code> ì„¤ì • í•„ìš”</li>
    </ul>
  </li>
  <li>ê°„ë‹¨í•˜ê²Œ manifestsë¡œ ì„¤ì¹˜í•˜ê² ìŠµë‹ˆë‹¤. - <a href="https://github.com/metallb/metallb/tree/main/config/manifests">ë§í¬</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Kubernetes manifests ë¡œ ì„¤ì¹˜</span>
<span class="c"># kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.8/config/manifests/metallb-native.yaml</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/metallb/metallb/refs/heads/main/config/manifests/metallb-native-prometheus.yaml
<span class="c"># =&gt; namespace/metallb-system created</span>
<span class="c">#    ...</span>
<span class="c">#    serviceaccount/speaker created</span>
<span class="c">#    ...</span>
<span class="c">#    daemonset.apps/speaker created</span>
<span class="c">#    servicemonitor.monitoring.coreos.com/controller-monitor created</span>
<span class="c">#    servicemonitor.monitoring.coreos.com/speaker-monitor created</span>
<span class="c">#    validatingwebhookconfiguration.admissionregistration.k8s.io/metallb-webhook-configuration created</span>

<span class="c"># metallb crd í™•ì¸</span>
<span class="nv">$ </span>kubectl get crd | <span class="nb">grep </span>metallb
<span class="c"># =&gt; bfdprofiles.metallb.io                      2020-01-01T07:31:16Z</span>
<span class="c">#    bgpadvertisements.metallb.io                2020-01-01T07:31:16Z</span>
<span class="c">#    bgppeers.metallb.io                         2020-01-01T07:31:16Z</span>
<span class="c">#    communities.metallb.io                      2020-01-01T07:31:16Z</span>
<span class="c">#    ipaddresspools.metallb.io                   2020-01-01T07:31:17Z</span>
<span class="c">#    l2advertisements.metallb.io                 2020-01-01T07:31:17Z</span>
<span class="c">#    servicel2statuses.metallb.io                2020-01-01T07:31:17Z</span>

<span class="c"># ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ í™•ì¸ : metallb-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±, íŒŒë“œ(ì»¨íŠ¸ë¡¤ëŸ¬, ìŠ¤í”¼ì»¤) ìƒì„±, RBAC(ì„œë¹„ìŠ¤/íŒŒë“œ/ì»¨í”¼ê·¸ë§µ ì¡°íšŒ ë“±ë“± ê¶Œí•œë“¤), SA ë“±</span>
<span class="nv">$ </span>kubectl get-all <span class="nt">-n</span> metallb-system <span class="c"># kubectl krew í”ŒëŸ¬ê·¸ì¸ get-all ì„¤ì¹˜ í›„ ì‚¬ìš© ê°€ëŠ¥</span>
<span class="nv">$ </span>kubectl get all,configmap,secret,ep <span class="nt">-n</span> metallb-system
<span class="c"># =&gt; NAME                              READY   STATUS    RESTARTS      AGE</span>
<span class="c">#    pod/controller-679855f7d7-m8spp   2/2     Running   0             5m36s</span>
<span class="c">#    pod/speaker-dm26z                 2/2     Running   4 (91s ago)   5m36s</span>
<span class="c">#    pod/speaker-dr8kh                 2/2     Running   0             5m36s</span>
<span class="c">#    pod/speaker-pctt7                 2/2     Running   3 (90s ago)   5m36s</span>
<span class="c">#    pod/speaker-w69v6                 2/2     Running   4 (91s ago)   5m36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/controller-monitor-service   ClusterIP   None           &amp;lt;none&amp;gt;        9120/TCP   5m36s</span>
<span class="c">#    service/metallb-webhook-service      ClusterIP   10.200.1.191   &amp;lt;none&amp;gt;        443/TCP    5m36s</span>
<span class="c">#    service/speaker-monitor-service      ClusterIP   None           &amp;lt;none&amp;gt;        9120/TCP   5m36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span>
<span class="c">#    daemonset.apps/speaker   4         4         4       4            4           kubernetes.io/os=linux   5m36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/controller   1/1     1            1           5m36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                    DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/controller-679855f7d7   1         1         1       5m36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                          DATA   AGE</span>
<span class="c">#    configmap/kube-root-ca.crt    1      5m37s</span>
<span class="c">#    configmap/metallb-excludel2   1      5m36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                          TYPE     DATA   AGE</span>
<span class="c">#    secret/memberlist             Opaque   1      5m18s</span>
<span class="c">#    secret/metallb-webhook-cert   Opaque   4      5m36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                   ENDPOINTS                                                     AGE</span>
<span class="c">#    endpoints/controller-monitor-service   10.10.1.3:9120                                                5m36s</span>
<span class="c">#    endpoints/metallb-webhook-service      10.10.1.3:9443                                                5m36s</span>
<span class="c">#    endpoints/speaker-monitor-service      172.20.0.2:9120,172.20.0.3:9120,172.20.0.4:9120 + 1 more...   5m36s</span>

<span class="c"># íŒŒë“œ ë‚´ì— kube-rbac-proxy ì»¨í…Œì´ë„ˆëŠ” í”„ë¡œë©”í…Œìš°ìŠ¤ ìµìŠ¤í¬í„° ì—­í•  ì œê³µ</span>
<span class="nv">$ </span>kubectl get pods <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>metallb <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{range .items[*]}{.metadata.name}{':</span><span class="se">\n</span><span class="s2">'}{range .spec.containers[*]}{'  '}{.name}{' -&gt; '}{.image}{'</span><span class="se">\n</span><span class="s2">'}{end}{end}"</span>
<span class="c"># =&gt; controller-679855f7d7-m8spp:</span>
<span class="c">#      kube-rbac-proxy -&amp;gt; gcr.io/kubebuilder/kube-rbac-proxy:v0.12.0</span>
<span class="c">#      controller -&amp;gt; quay.io/metallb/controller:main</span>
<span class="c">#    speaker-dm26z:</span>
<span class="c">#      kube-rbac-proxy -&amp;gt; gcr.io/kubebuilder/kube-rbac-proxy:v0.12.0</span>
<span class="c">#      speaker -&amp;gt; quay.io/metallb/speaker:main</span>
<span class="c">#    speaker-dr8kh:</span>
<span class="c">#      kube-rbac-proxy -&amp;gt; gcr.io/kubebuilder/kube-rbac-proxy:v0.12.0</span>
<span class="c">#      speaker -&amp;gt; quay.io/metallb/speaker:main</span>
<span class="c">#    speaker-pctt7:</span>
<span class="c">#      kube-rbac-proxy -&amp;gt; gcr.io/kubebuilder/kube-rbac-proxy:v0.12.0</span>
<span class="c">#      speaker -&amp;gt; quay.io/metallb/speaker:main</span>
<span class="c">#    speaker-w69v6:</span>
<span class="c">#      kube-rbac-proxy -&amp;gt; gcr.io/kubebuilder/kube-rbac-proxy:v0.12.0</span>
<span class="c">#      speaker -&amp;gt; quay.io/metallb/speaker:main</span>

<span class="c">## metallb ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ë””í”Œë¡œì´ë¨¼íŠ¸ë¡œ ë°°í¬ë¨</span>
<span class="nv">$ </span>kubectl get ds,deploy <span class="nt">-n</span> metallb-system
<span class="c"># =&gt; NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span>
<span class="c">#    daemonset.apps/speaker   4         4         4       4            4           kubernetes.io/os=linux   6m26s</span>
<span class="c">#    </span>
<span class="c">#    NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/controller   1/1     1            1           6m26s</span>

<span class="c">## ë°ëª¬ì…‹ìœ¼ë¡œ ë°°í¬ë˜ëŠ” metallb ìŠ¤í”¼ì»¤ íŒŒë“œì˜ IPëŠ” ë„¤íŠ¸ì›Œí¬ê°€ host ëª¨ë“œì´ë¯€ë¡œ ë…¸ë“œì˜ IPë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> metallb-system <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                          READY   STATUS    RESTARTS   AGE   IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    controller-679855f7d7-rg9pw   2/2     Running   0          22m   10.10.1.3    myk8s-worker3         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    speaker-9njww                 2/2     Running   0          22m   172.20.0.3   myk8s-worker3         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    speaker-lk9wt                 2/2     Running   0          22m   172.20.0.2   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    speaker-wz9w5                 2/2     Running   0          22m   172.20.0.5   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    speaker-zbwdq                 2/2     Running   0          22m   172.20.0.4   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># (ì°¸ê³ ) ìƒì„¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get sa,cm,secret <span class="nt">-n</span> metallb-system
<span class="nv">$ </span>kubectl describe role <span class="nt">-n</span> metallb-system
<span class="nv">$ </span>kubectl describe deploy controller <span class="nt">-n</span> metallb-system
<span class="nv">$ </span>kubectl describe ds speaker <span class="nt">-n</span> metallb-system
</code></pre></div></div>

<ul>
  <li>ì»¨í”¼ê·¸ë§µ ìƒì„± : ëª¨ë“œ ë° ì„œë¹„ìŠ¤ ëŒ€ì—­ ì§€ì •
    <ul>
      <li>ì„œë¹„ìŠ¤(External-IP) ëŒ€ì—­ì„ ë…¸ë“œê°€ ì†í•œ eth0ì˜ ëŒ€ì—­ì´ ì•„ë‹ˆì—¬ë„ ìƒê´€ì—†ìŠµë‹ˆë‹¤.
ë‹¤ë§Œ, ì´ ê²½ìš° GW ì—­í• ì˜ ë¼ìš°í„°ì—ì„œ ë…¸ë“œë“¤ë¡œ ë¼ìš°íŒ… ê²½ë¡œ ì§€ì • í•„ìš”í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kind ì„¤ì¹˜ ì‹œ kind ì´ë¦„ì˜ ë„ì»¤ ë¸Œë¦¬ì§€ê°€ ìƒì„±ë©ë‹ˆë‹¤ : 172.20.0.0/16 ëŒ€ì—­</span>
<span class="nv">$ </span>docker network <span class="nb">ls</span>
<span class="c"># =&gt; NETWORK ID     NAME                     DRIVER    SCOPE</span>
<span class="c">#    a8d530305515   bridge                   bridge    local</span>
<span class="c">#    8204a0851463   host                     host      local</span>
<span class="c">#    3bbcc6aa8f38   kind                     bridge    local</span>
<span class="nv">$ </span>docker inspect kind
<span class="c"># kind network ì¤‘ ì»¨í…Œì´ë„ˆ(ë…¸ë“œ) IP(ëŒ€ì—­) í™•ì¸ : 172.20.0.2~ ë¶€í„° í• ë‹¹ë˜ë©°, control-plane ì´ ê¼­ 172.20.0.2ê°€ ì•ˆë  ìˆ˜ ë„ ìˆìŒ</span>
<span class="nv">$ </span>docker ps <span class="nt">-q</span> | xargs docker inspect <span class="nt">--format</span> <span class="s1">' '</span>
<span class="c"># =&gt; /mypc2 172.20.0.7</span>
<span class="c">#    /mypc 172.20.0.6</span>
<span class="c">#    /myk8s-worker 172.20.0.4</span>
<span class="c">#    /myk8s-control-plane 172.20.0.5</span>
<span class="c">#    /myk8s-worker2 172.20.0.2</span>
<span class="c">#    /myk8s-worker3 172.20.0.3</span>

<span class="c"># IPAddressPool ìƒì„± : LoadBalancer External IPë¡œ ì‚¬ìš©í•  IP ëŒ€ì—­</span>
<span class="c">## MetalLBëŠ” ì„œë¹„ìŠ¤ë¥¼ ìœ„í•œ ì™¸ë¶€ IP ì£¼ì†Œë¥¼ ê´€ë¦¬í•˜ê³ , ì„œë¹„ìŠ¤ê°€ ìƒì„±ë  ë•Œ í•´ë‹¹ IP ì£¼ì†Œë¥¼ ë™ì ìœ¼ë¡œ í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl explain ipaddresspools.metallb.io

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: my-ippool
  namespace: metallb-system
spec:
  addresses:
  - 172.20.255.200-172.20.255.250
</span><span class="no">EOF
</span><span class="c"># =&gt; ipaddresspool.metallb.io/my-ippool unchanged</span>

<span class="nv">$ </span>kubectl get ipaddresspools <span class="nt">-n</span> metallb-system
<span class="c"># =&gt; NAME        AUTO ASSIGN   AVOID BUGGY IPS   ADDRESSES</span>
<span class="c">#    my-ippool   true          false             [&amp;quot;172.20.255.200-172.20.255.250&amp;quot;]</span>

<span class="c"># L2Advertisement ìƒì„± : ì„¤ì •í•œ IPpoolì„ ê¸°ë°˜ìœ¼ë¡œ Layer2 ëª¨ë“œë¡œ LoadBalancer IP ì‚¬ìš© í—ˆìš©</span>
<span class="c">## Kubernetes í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ì„œë¹„ìŠ¤ê°€ ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ì— IP ì£¼ì†Œë¥¼ ê´‘ê³ í•˜ëŠ” ë°©ì‹ì„ ì •ì˜</span>

<span class="nv">$ </span>kubectl explain l2advertisements.metallb.io

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: my-l2-advertise
  namespace: metallb-system
spec:
  ipAddressPools:
  - my-ippool
</span><span class="no">EOF
</span><span class="c"># =&gt; l2advertisement.metallb.io/my-l2-advertise created</span>

<span class="nv">$ </span>kubectl get l2advertisements <span class="nt">-n</span> metallb-system
<span class="c"># =&gt; NAME              IPADDRESSPOOLS   IPADDRESSPOOL SELECTORS   INTERFACES</span>
<span class="c">#    my-l2-advertise   [&amp;quot;my-ippool&amp;quot;]                              </span>
</code></pre></div></div>

<ul>
  <li>ë¡œê·¸ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># (ì˜µì…˜) metallb-speaker íŒŒë“œ ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>metallb <span class="nt">-f</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>speaker <span class="nt">--since</span> 1h
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>speaker <span class="nt">-f</span>

<span class="c"># (ì˜µì…˜) kubectl krew í”ŒëŸ¬ê·¸ì¸ stern ì„¤ì¹˜ í›„ ì•„ë˜ ëª…ë ¹ ì‚¬ìš© ê°€ëŠ¥</span>
<span class="nv">$ </span>kubectl stern <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>metallb
<span class="nv">$ </span>kubectl stern <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>speaker <span class="nt">--since</span> 1h
<span class="nv">$ </span>kubectl stern <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>speaker <span class="c"># ê¸°ë³¸ ì„¤ì •ì´ follow</span>
<span class="nv">$ </span>kubectl stern <span class="nt">-n</span> metallb-system speaker  <span class="c"># ë§¤ì¹­ ì‚¬ìš© ê°€ëŠ¥</span>
</code></pre></div></div>

<h5 id="ì„œë¹„ìŠ¤-ìƒì„±-ë°-í™•ì¸">ì„œë¹„ìŠ¤ ìƒì„± ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: svc1
spec:
  ports:
    - name: svc1-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer  # ì„œë¹„ìŠ¤ íƒ€ì…ì´ LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: svc2
spec:
  ports:
    - name: svc2-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: svc3
spec:
  ports:
    - name: svc3-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer
</span><span class="no">EOF
</span><span class="c"># =&gt; service/svc1 created</span>
<span class="c">#    service/svc2 created</span>
<span class="c">#    service/svc3 created</span>
</code></pre></div></div>

<h5 id="ì„œë¹„ìŠ¤-í™•ì¸-ë°-ë¦¬ë”-speaker-íŒŒë“œ-í™•ì¸">ì„œë¹„ìŠ¤ í™•ì¸ ë° ë¦¬ë” Speaker íŒŒë“œ í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># arp scan í•´ë‘ê¸°</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane arp-scan <span class="nt">--interfac</span><span class="o">=</span>eth0 <span class="nt">--localnet</span>
<span class="c"># =&gt; Interface: eth0, type: EN10MB, MAC: 02:42:ac:14:00:05, IPv4: 172.20.0.5</span>
<span class="c">#    Starting arp-scan 1.10.0 with 65536 hosts (https://github.com/royhills/arp-scan)</span>
<span class="c">#    172.20.0.1      02:42:1f:41:79:66       (Unknown: locally administered)</span>
<span class="c">#    172.20.0.2      02:42:ac:14:00:02       (Unknown: locally administered)</span>
<span class="c">#    172.20.0.3      02:42:ac:14:00:03       (Unknown: locally administered)</span>
<span class="c">#    172.20.0.4      02:42:ac:14:00:04       (Unknown: locally administered)</span>
<span class="c">#    172.20.0.6      02:42:ac:14:00:06       (Unknown: locally administered)</span>
<span class="c">#    172.20.0.7      02:42:ac:14:00:07       (Unknown: locally administered)</span>

<span class="c"># LoadBalancer íƒ€ì…ì˜ ì„œë¹„ìŠ¤ ìƒì„± í™•ì¸ : EXTERNAL-IPê°€ ì„œë¹„ìŠ¤ ë§ˆë‹¤ í• ë‹¹ë˜ë©°, ì‹¤ìŠµ í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ</span>
<span class="c">## LoadBalancer íƒ€ì…ì˜ ì„œë¹„ìŠ¤ëŠ” NodePort ì™€ ClusterIP ë¥¼ í¬í•¨í•¨ - 'allocateLoadBalancerNodePorts : true' ê¸°ë³¸ê°’</span>
<span class="c">## ExternalIP ë¡œ ì ‘ì† ì‹œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ëŠ” PORT(S) ì˜ ì•ì— ìˆëŠ” ê°’ì„ ì‚¬ìš© (ì•„ë˜ì˜ ê²½ìš°ëŠ” TCP 80 ì„)</span>
<span class="c">## ë§Œì•½ ë…¸ë“œì˜ IPì— NodePort ë¡œ ì ‘ì† ì‹œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ëŠ” PORT(S) ì˜ ë’¤ì— ìˆëŠ” ê°’ì„ ì‚¬ìš© (ì•„ë˜ëŠ” 30485 ì„)</span>
<span class="nv">$ </span>kubectl get service,ep
<span class="c"># =&gt; NAME                 TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)        AGE</span>
<span class="c">#    service/kubernetes   ClusterIP      10.200.1.1     &amp;lt;none&amp;gt;           443/TCP        3h55m</span>
<span class="c">#    service/svc1         LoadBalancer   10.200.1.213   172.20.255.200   80:32145/TCP   128m</span>
<span class="c">#    service/svc2         LoadBalancer   10.200.1.59    172.20.255.201   80:32238/TCP   128m</span>
<span class="c">#    service/svc3         LoadBalancer   10.200.1.201   172.20.255.202   80:31593/TCP   128m</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                   AGE</span>
<span class="c">#    endpoints/kubernetes   172.20.0.5:6443             3h55m</span>
<span class="c">#    endpoints/svc1         10.10.2.3:80,10.10.3.2:80   128m</span>
<span class="c">#    endpoints/svc2         10.10.2.3:80,10.10.3.2:80   128m</span>
<span class="c">#    endpoints/svc3         10.10.2.3:80,10.10.3.2:80   128m</span>

<span class="c"># LoadBalancer íƒ€ì…ì€ ê¸°ë³¸ì ìœ¼ë¡œ NodePortë¥¼ í¬í•¨ ì‚¬ìš©. NodePortëŠ” ClusterIPë¥¼ í¬í•¨ ì‚¬ìš©.</span>
<span class="c">## í´ë¼ìš°ë“œì‚¬ì—…ì LB Typeì´ë‚˜ ì˜¨í”„ë ˆë¯¸ìŠ¤í™˜ê²½ HW LB Type ê²½ìš° LB ì‚¬ìš© ì‹œ NodePort ë¯¸ì‚¬ìš© ì„¤ì • ê°€ëŠ¥</span>
<span class="nv">$ </span>kubectl describe svc svc1
<span class="c"># =&gt; Name:                     svc1</span>
<span class="c">#    ...</span>
<span class="c">#    Annotations:              metallb.io/ip-allocated-from-pool: my-ippool</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     LoadBalancer</span>
<span class="c">#    IP Family Policy:         SingleStack</span>
<span class="c">#    IP Families:              IPv4</span>
<span class="c">#    IP:                       10.200.1.213</span>
<span class="c">#    IPs:                      10.200.1.213</span>
<span class="c">#    LoadBalancer Ingress:     172.20.255.200 (VIP)</span>
<span class="c">#    Port:                     svc1-webport  80/TCP</span>
<span class="c">#    TargetPort:               80/TCP</span>
<span class="c">#    NodePort:                 svc1-webport  32145/TCP</span>
<span class="c">#    Endpoints:                10.10.3.2:80,10.10.2.3:80</span>
<span class="c">#    Session Affinity:         None</span>
<span class="c">#    External Traffic Policy:  Cluster</span>
<span class="c">#    Internal Traffic Policy:  Cluster</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason       Age    From                Message</span>
<span class="c">#      ----    ------       ----   ----                -------</span>
<span class="c">#      Normal  IPAllocated  3m19s  metallb-controller  Assigned IP [&amp;quot;172.20.255.200&amp;quot;]</span>
<span class="c">#      Normal  nodeAssigned  5m55s (x2 over 5m55s)  metallb-speaker  announcing from node &amp;quot;myk8s-worker&amp;quot; with protocol &amp;quot;layer2&amp;quot;</span>

<span class="c">## ì•„ë˜ ì²˜ëŸ¼ LB VIP ë³„ë¡œ ì´ë˜ speaker ë°°í¬ëœ ë…¸ë“œê°€ ë¦¬ë” ì—­í• ì„ í•˜ëŠ”ì§€ í™•ì¸ ê°€ëŠ¥</span>
<span class="nv">$ </span>kubectl describe svc | <span class="nb">grep </span>Events: <span class="nt">-A5</span>
<span class="c"># =&gt; Events:                   &amp;lt;none&amp;gt;</span>
<span class="c">#</span>
<span class="c">#    Name:                     svc1</span>
<span class="c">#    Namespace:                default</span>
<span class="c">#    Labels:                   &amp;lt;none&amp;gt;</span>
<span class="c">#    --</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason       Age    From                Message</span>
<span class="c">#      ----    ------       ----   ----                -------</span>
<span class="c">#      Normal  IPAllocated  4m24s  metallb-controller  Assigned IP [&amp;quot;172.20.255.200&amp;quot;]</span>
<span class="c">#      Normal  nodeAssigned 6m42s (x2 over 6m42s)  metallb-speaker  announcing from node "myk8s-worker" with protocol "layer2"</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get svc svc1 <span class="nt">-o</span> json | jq
<span class="c"># =&gt; ...</span>
<span class="c">#      &amp;quot;spec&amp;quot;: {</span>
<span class="c">#        &amp;quot;allocateLoadBalancerNodePorts&amp;quot;: true,</span>
<span class="c">#      ...</span>
<span class="c">#      &amp;quot;status&amp;quot;: {</span>
<span class="c">#        &amp;quot;loadBalancer&amp;quot;: {</span>
<span class="c">#          &amp;quot;ingress&amp;quot;: [</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;ip&amp;quot;: &amp;quot;172.20.255.200&amp;quot;,</span>
<span class="c">#              &amp;quot;ipMode&amp;quot;: &amp;quot;VIP&amp;quot;</span>
<span class="c">#    ...</span>

<span class="c"># metallb CRDì¸ servicel2status ë¡œ ìƒíƒœ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl explain servicel2status
<span class="nv">$ </span>kubectl get servicel2status <span class="nt">-n</span> metallb-system
<span class="c"># =&gt; NAME       ALLOCATED NODE   SERVICE NAME   SERVICE NAMESPACE</span>
<span class="c">#    l2-cm8sw   myk8s-worker     svc2           default</span>
<span class="c">#    l2-j6w4k   myk8s-worker     svc1           default</span>
<span class="c">#    l2-k5cdm   myk8s-worker3    svc3           default</span>
<span class="nv">$ </span>kubectl describe servicel2status <span class="nt">-n</span> metallb-system
<span class="nv">$ </span>kubectl get servicel2status <span class="nt">-n</span> metallb-system <span class="nt">-o</span> json <span class="nt">--watch</span> <span class="c"># watch ëª¨ë“œ</span>

<span class="c"># í˜„ì¬ SVC EXTERNAL-IPë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
<span class="nv">$ SVC1EXIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ SVC2EXIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ SVC3EXIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc3 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$SVC1EXIP</span> <span class="nv">$SVC2EXIP</span> <span class="nv">$SVC3EXIP</span>
<span class="c"># =&gt; 172.20.255.200 172.20.255.201 172.20.255.202</span>

<span class="c"># mypc/mypc2 ì—ì„œ í˜„ì¬ SVC EXTERNAL-IPë¥¼ ë‹´ë‹¹í•˜ëŠ” ë¦¬ë” Speaker íŒŒë“œ ì°¾ëŠ”ë²• : arping íˆ´ ì‚¬ìš©</span>
<span class="c">## Unicast reply from 172.20.255.200: í•´ë‹¹ IP ì£¼ì†Œì—ì„œ ì‘ë‹µì„ ë°›ì•˜ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. </span>
<span class="c">## Sent 1 probes (1 broadcast(s)): í•˜ë‚˜ì˜ ARP ìš”ì²­ì„ ë³´ëƒˆê³ , ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë°©ì‹ìœ¼ë¡œ ìš”ì²­ì„ ì „ì†¡í–ˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</span>
<span class="c">## Received 1 response(s): í•˜ë‚˜ì˜ ì‘ë‹µì„ ìˆ˜ì‹ í–ˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc arping <span class="nt">-I</span> eth0 <span class="nt">-f</span> <span class="nt">-c</span> 1 <span class="nv">$SVC1EXIP</span>
<span class="c"># =&gt; ARPING 172.20.255.200 from 172.20.0.6 eth0</span>
<span class="c">#    Unicast reply from 172.20.255.200 [02:42:AC:14:00:03]  1.139ms</span>
<span class="c">#    Sent 1 probes (1 broadcast(s))</span>
<span class="c">#    Received 1 response(s)</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc arping <span class="nt">-I</span> eth0 <span class="nt">-f</span> <span class="nt">-c</span> 1 <span class="nv">$SVC2EXIP</span>
<span class="c"># =&gt; ARPING 172.20.255.201 from 172.20.0.6 eth0</span>
<span class="c">#    Unicast reply from 172.20.255.201 [02:42:AC:14:00:02]  1.827ms</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc arping <span class="nt">-I</span> eth0 <span class="nt">-f</span> <span class="nt">-c</span> 1 <span class="nv">$SVC3EXIP</span>
<span class="c"># =&gt; ARPING 172.20.255.202 from 172.20.0.6 eth0</span>
<span class="c">#    Unicast reply from 172.20.255.202 [02:42:AC:14:00:04]  0.982ms</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$SVC1EXIP</span> <span class="nv">$SVC2EXIP</span> <span class="nv">$SVC3EXIP</span><span class="p">;</span> <span class="k">do </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc arping <span class="nt">-I</span> eth0 <span class="nt">-f</span> <span class="nt">-c</span> 1 <span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; ARPING 172.20.255.200 from 172.20.0.6 eth0</span>
<span class="c">#    Unicast reply from 172.20.255.200 [02:42:AC:14:00:03]  1.016ms</span>
<span class="c">#    Sent 1 probes (1 broadcast(s))</span>
<span class="c">#    Received 1 response(s)</span>
<span class="c">#    ARPING 172.20.255.201 from 172.20.0.6 eth0</span>
<span class="c">#    Unicast reply from 172.20.255.201 [02:42:AC:14:00:02]  1.965ms</span>
<span class="c">#    ...</span>
<span class="c">#    ARPING 172.20.255.202 from 172.20.0.6 eth0</span>
<span class="c">#    Unicast reply from 172.20.255.202 [02:42:AC:14:00:04]  1.789ms</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ip <span class="nt">-c</span> neigh
<span class="c"># =&gt; &lt;span style="color:purple;"&gt;172.20.0.1 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:1f:41:79:66 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.4 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:04 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.5 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:05 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.200 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:03 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.201 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:02 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.202 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:04 &lt;/span&gt;REACHABLE </span>

<span class="c"># &lt;span style="color: green;"&gt;pingì€ ëª¨ë‘ íŒ¨í‚· 100% ë¡œìŠ¤ë˜ë©´ì„œ ì‹¤íŒ¨í•©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ì„œë¹„ìŠ¤ portë¡œë§Œ ì—´ë ¤ìˆê¸°ë•Œë¬¸ì— pingì€ ì‹¤íŒ¨í•˜ëŠ”ê²ƒì…ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ì—¬ê¸°ì„œ pingì„ í•˜ëŠ” ì´ìœ ëŠ” arp tableì„ ìƒì„±í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.&lt;/span&gt;</span>
  
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ping <span class="nt">-c</span> 1 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$SVC1EXIP</span>
<span class="c"># =&gt; PING 172.20.255.200 (172.20.255.200) 56(84) bytes of data.</span>
<span class="c">#    </span>
<span class="c">#    --- 172.20.255.200 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 0 received, 100% packet loss, time 0ms</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ping <span class="nt">-c</span> 1 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$SVC2EXIP</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ping <span class="nt">-c</span> 1 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$SVC3EXIP</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$SVC1EXIP</span> <span class="nv">$SVC2EXIP</span> <span class="nv">$SVC3EXIP</span><span class="p">;</span> <span class="k">do </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ping <span class="nt">-c</span> 1 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>172.20.0.2 172.20.0.3 172.20.0.4 172.20.0.5<span class="p">;</span> <span class="k">do </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ping <span class="nt">-c</span> 1 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># mypc/mypc2 ì—ì„œ arp í…Œì´ë¸” ì •ë³´ í™•ì¸ &gt;&gt; SVC IPë³„ë¡œ ë¦¬ë” íŒŒë“œ(ìŠ¤í”¼ì»¤) ì—­í• ì˜ ë…¸ë“œë¥¼ í™•ì¸!</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ip <span class="nt">-c</span> neigh | <span class="nb">sort</span>
<span class="c"># =&gt; &lt;span style="color:purple;"&gt;172.20.0.1 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:1f:41:79:66 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.2 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:02 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.3 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:03 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.4 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:04 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.5 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:05 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.200 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:03 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.201 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:02 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.202 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:04 &lt;/span&gt;REACHABLE </span>

<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span> <span class="c"># mac ì£¼ì†Œì— ë§¤ì¹­ë˜ëŠ” IP(ë…¸ë“œ) ì°¾ê¸°</span>
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   4h35m   v1.31.0   172.20.0.5    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker          Ready    &amp;lt;none&amp;gt;          4h34m   v1.31.0   172.20.0.4    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker2         Ready    &amp;lt;none&amp;gt;          4h34m   v1.31.0   172.20.0.2    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker3         Ready    &amp;lt;none&amp;gt;          4h34m   v1.31.0   172.20.0.3    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>

<span class="c"># (ì˜µì…˜) ë…¸ë“œì—ì„œ ARP íŒ¨í‚· ìº¡ì³ í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> arp
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker        tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> arp
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2       tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> arp
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker3       tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> arp

<span class="c"># (ì˜µì…˜) metallb-speaker íŒŒë“œ ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>metallb <span class="nt">-f</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>speaker <span class="nt">--since</span> 1h
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>speaker <span class="nt">-f</span>

<span class="c"># (ì˜µì…˜) kubectl krew í”ŒëŸ¬ê·¸ì¸ stern ì„¤ì¹˜ í›„ ì•„ë˜ ëª…ë ¹ ì‚¬ìš© ê°€ëŠ¥</span>
<span class="nv">$ </span>kubectl stern <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>metallb
<span class="nv">$ </span>kubectl stern <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>speaker <span class="nt">--since</span> 1h
<span class="nv">$ </span>kubectl stern <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>speaker <span class="c"># ê¸°ë³¸ ì„¤ì •ì´ follow</span>
<span class="nv">$ </span>kubectl stern <span class="nt">-n</span> metallb-system speaker  <span class="c"># ë§¤ì¹­ ì‚¬ìš© ê°€ëŠ¥</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_12.png" alt="20241005_kans_w5_12.png" /></p>

<h5 id="ì„œë¹„ìŠ¤-ì ‘ì†-í…ŒìŠ¤íŠ¸">ì„œë¹„ìŠ¤ ì ‘ì† í…ŒìŠ¤íŠ¸</h5>

<ul>
  <li>í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ external ipì™€ portë¥¼ í†µí•´ k8s í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ì„œë¹„ìŠ¤ì— ì ‘ì†í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í˜„ì¬ SVC EXTERNAL-IPë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
<span class="nv">$ SVC1EXIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ SVC2EXIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ SVC3EXIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc3 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$SVC1EXIP</span> <span class="nv">$SVC2EXIP</span> <span class="nv">$SVC3EXIP</span>
<span class="c"># =&gt; 172.20.255.200 172.20.255.201 172.20.255.202</span>

<span class="c"># mypc/mypc2 ì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nv">$SVC1EXIP</span>
<span class="c"># =&gt; Hostname: webpod2</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 10.10.2.3</span>
<span class="c">#    RemoteAddr: 172.20.0.3:40816</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 172.20.255.200</span>
<span class="c">#    User-Agent: curl/8.7.1</span>
<span class="c">#    Accept: */*</span>

<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nv">$SVC1EXIP</span> | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod2</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$SVC1EXIP</span> <span class="nv">$SVC2EXIP</span> <span class="nv">$SVC3EXIP</span><span class="p">;</span> <span class="k">do </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nv">$i</span> | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Hostname: webpod1</span>
<span class="c">#    Hostname: webpod2</span>
<span class="c">#    Hostname: webpod2</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$SVC1EXIP</span> <span class="nv">$SVC2EXIP</span> <span class="nv">$SVC3EXIP</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; Access Service External-IP : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span> <span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nv">$i</span> | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; Access Service External-IP : 172.20.255.200 &amp;lt;&amp;lt;</span>
<span class="c">#    Hostname: webpod1</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; Access Service External-IP : 172.20.255.201 &amp;lt;&amp;lt;</span>
<span class="c">#    Hostname: webpod2</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; Access Service External-IP : 172.20.255.202 &amp;lt;&amp;lt;</span>
<span class="c">#    Hostname: webpod1    </span>

<span class="c">## RemoteAddr ì£¼ì†ŒëŠ” ì–´ë–»ê²Œ ë‚˜ì˜¤ë‚˜ìš”? ì™œ ê·¸ëŸ´ê¹Œìš”?</span>
<span class="c">##  NodePort ê¸°ë³¸ ë™ì‘ê³¼ ë™ì¼í•˜ê²Œ ì¸ì…í•œ ë…¸ë“œì˜ ì¸í„°í˜ì´ìŠ¤ë¡œ SNAT ë˜ì–´ì„œ ìµœì¢… íŒŒë“œë¡œ ì „ë‹¬ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$SVC1EXIP</span> <span class="nv">$SVC2EXIP</span> <span class="nv">$SVC3EXIP</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; Access Service External-IP : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span> <span class="p">;</span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nv">$i</span> | egrep <span class="s1">'Hostname|RemoteAddr|Host:'</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; Access Service External-IP : 172.20.255.200 &amp;lt;&amp;lt;</span>
<span class="c">#    Hostname: webpod2</span>
<span class="c">#    RemoteAddr: 172.20.0.3:23163</span>
<span class="c">#    Host: 172.20.255.200</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; Access Service External-IP : 172.20.255.201 &amp;lt;&amp;lt;</span>
<span class="c">#    Hostname: webpod2</span>
<span class="c">#    RemoteAddr: 10.10.2.1:15401</span>
<span class="c">#    Host: 172.20.255.201</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; Access Service External-IP : 172.20.255.202 &amp;lt;&amp;lt;</span>
<span class="c">#    Hostname: webpod2</span>
<span class="c">#    RemoteAddr: 172.20.0.4:12711</span>
<span class="c">#    Host: 172.20.255.202</span>

<span class="c"># ë¶€í•˜ë¶„ì‚° ì ‘ì†ë¨</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$SVC1EXIP</span><span class="s2"> | grep Hostname; done | sort | uniq -c | sort -nr"</span>
<span class="c"># =&gt;      54 Hostname: webpod2</span>
<span class="c">#         46 Hostname: webpod1</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$SVC2EXIP</span><span class="s2"> | grep Hostname; done | sort | uniq -c | sort -nr"</span>
<span class="c"># =&gt;      56 Hostname: webpod1</span>
<span class="c">#         44 Hostname: webpod2</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$SVC3EXIP</span><span class="s2"> | grep Hostname; done | sort | uniq -c | sort -nr"</span>
<span class="c"># =&gt;      53 Hostname: webpod1</span>
<span class="c">#         47 Hostname: webpod2</span>

<span class="c"># ì§€ì†ì ìœ¼ë¡œ ë°˜ë³µ ì ‘ì†</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$SVC1EXIP</span><span class="s2"> | egrep 'Hostname|RemoteAddr'; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>
<span class="c"># =&gt; Hostname: webpod1</span>
<span class="c">#    RemoteAddr: 172.20.0.3:39516</span>
<span class="c">#    2024-01-01 11:22:10</span>
<span class="c">#    </span>
<span class="c">#    Hostname: webpod1</span>
<span class="c">#    RemoteAddr: 172.20.0.3:20966</span>
<span class="c">#    2024-01-01 11:22:11</span>
<span class="c">#    </span>
<span class="c">#    Hostname: webpod2</span>
<span class="c">#    RemoteAddr: 172.20.0.3:3638</span>
<span class="c">#    2024-01-01 11:22:12</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$SVC2EXIP</span><span class="s2"> | egrep 'Hostname|RemoteAddr'; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$SVC3EXIP</span><span class="s2"> | egrep 'Hostname|RemoteAddr'; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>

<span class="c"># LoadBalancer Typeì€ ê¸°ë³¸ê°’ìœ¼ë¡œ NodePort í¬í•¨. NodePort ì„œë¹„ìŠ¤ëŠ” ClusterIP ë¥¼ í¬í•¨</span>
<span class="c"># NodePort:PORT ë° CLUSTER-IP:PORT ë¡œ ì ‘ì† ê°€ëŠ¥!</span>
<span class="nv">$ </span>kubectl get svc svc1
<span class="c"># =&gt; NAME   TYPE           CLUSTER-IP    EXTERNAL-IP      PORT(S)        AGE</span>
<span class="c">#    svc1   LoadBalancer   10.200.1.89   172.20.255.200   80:30613/TCP   22m</span>

<span class="c"># ì»¨íŠ¸ë¡¤ë…¸ë“œì—ì„œ ê°ê° ì ‘ì† í™•ì¸ ì‹¤í–‰ í•´ë³´ì</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane curl <span class="nt">-s</span> 127.0.0.1:30613 <span class="c"># NodePort Type</span>
<span class="c"># =&gt; Hostname: webpod2</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 10.10.2.3</span>
<span class="c">#    RemoteAddr: 172.20.0.5:44387</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 127.0.0.1:30613</span>
<span class="c">#    User-Agent: curl/7.88.1</span>
<span class="c">#    Accept: */*    </span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane curl <span class="nt">-s</span> 10.200.1.89     <span class="c"># ClusterIP Tpye</span>
<span class="c"># =&gt; Hostname: webpod2</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 10.10.2.3</span>
<span class="c">#    RemoteAddr: 172.20.0.5:28647</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 10.200.1.89</span>
<span class="c">#    User-Agent: curl/7.88.1</span>
<span class="c">#    Accept: */*</span>
</code></pre></div></div>

<h5 id="failover-í…ŒìŠ¤íŠ¸">Failover í…ŒìŠ¤íŠ¸</h5>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_13.png" alt="img.png" /></p>

<ul>
  <li>ìœ„ì˜ ê·¸ë¦¼ì²˜ëŸ¼ ì¥ì•  ë°œìƒì „ì— ì›Œì»¤ë…¸ë“œ 1ì˜ ìŠ¤í”¼ì»¤ íŒŒë“œê°€ SVC1, SVC2 ì„œë¹„ìŠ¤ì˜ ë¦¬ë” ì—­í• ì„ í•˜ê³  ìˆëŠ” ìƒíƒœì—ì„œ,
ì›Œì»¤ë…¸ë“œ 1ì— ì¥ì• ê°€ ë°œìƒí•˜ë©´, ë‚¨ì•„ìˆëŠ” ìŠ¤í”¼ì»¤ íŒŒë“œë“¤ì´ ì›Œì»¤ë…¸ë“œ 1ì˜ ì¥ì•  ìƒí™©ì„ ì¸ì§€í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
  <li>ì´í›„ ì¥ì• ê°€ ë°œìƒí•œ ìŠ¤í”¼ì»¤ íŒŒë“œê°€ ì†Œìœ í•œ ExternalIPì— ëŒ€í•´ ë¦¬ë”íŒŒë“œë¥¼ ë‹¤ì‹œ ì„ ì¶œí•˜ê³  GARPë¡œ ìƒˆë¡œ ì„ ì¶œëœ ë¦¬ë”íŒŒë“œì˜ MAC ì£¼ì†Œë¥¼ ì „íŒŒí•©ë‹ˆë‹¤.</li>
  <li>ë‹¤ë§Œ ì¥ì•  ë°œìƒìœ¼ë¡œ ë¬¸ì œë¥¼ ì¸ì‹í•˜ëŠ” ì‹œê°„ê³¼ ARP ì •ë³´ê°€ ì „íŒŒë˜ëŠ” ì‹œê°„, ê·¸ë¦¬ê³  í´ë¼ì´ì–¸íŠ¸ì˜ ARP ìºì‹œ ê°±ì‹  ì‹œê°„ ë“±ì„ 
ê³ ë ¤í•˜ë©´ 20ì´ˆ~1ë¶„ ì´ë‚´ì˜ ì¥ì•  ì§€ì†ì‹œê°„ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>í˜„ì¬ ì‹¤ìŠµì—ì„œ SVC1 =&gt; worker node 3, SVC2 =&gt; worker node 2, SVC3 =&gt; worker node 1 ì— ë°°í¬ë˜ì–´ ìˆëŠ” ìƒíƒœì—ì„œ
ì›Œì»¤ë…¸ë“œ ì¤‘ 1ëŒ€ë¥¼ ì¤‘ì§€í•˜ì—¬ ì¥ì• ë¥¼ ë°œìƒì‹œí‚¤ê³ , ì¥ì• ì‹œê°„ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì‚¬ì „ ì¤€ë¹„</span>
<span class="c">## ì§€ì†ì ìœ¼ë¡œ ë°˜ë³µ ì ‘ì†</span>
<span class="nv">$ SVC1EXIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$SVC1EXIP</span><span class="s2"> | egrep 'Hostname|RemoteAddr'; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>

<span class="c">## ìƒíƒœ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod,svc,ep

<span class="c">## ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>metallb <span class="nt">-f</span>
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span>kubectl stern <span class="nt">-n</span> metallb-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>metallb


<span class="c"># ì¥ì•  ì¬ì—°</span>
<span class="c">## ë¦¬ë” Speaker íŒŒë“œê°€ ì¡´ì¬í•˜ëŠ” ë…¸ë“œ(ì‹¤ì œëŠ” ì»¨í…Œì´ë„ˆ)ë¥¼ ì¤‘ì§€</span>
<span class="c"># $ docker stop &lt;svc1 ë²ˆ ë¦¬ë” Speaker íŒŒë“œê°€ ì¡´ì¬í•˜ëŠ” ë…¸ë“œ(ì‹¤ì œëŠ” ì»¨í…Œì´ë„ˆ)&gt; --signal 9</span>
<span class="nv">$ </span>docker stop myk8s-worker <span class="nt">--signal</span> 9
<span class="c"># í˜¹ì€</span>
<span class="c"># $ docker stop &lt;svc1 ë²ˆ ë¦¬ë” Speaker íŒŒë“œê°€ ì¡´ì¬í•˜ëŠ” ë…¸ë“œ(ì‹¤ì œëŠ” ì»¨í…Œì´ë„ˆ)&gt; --signal 15</span>
<span class="nv">$ </span>docker stop myk8s-worker <span class="nt">--signal</span> 15

<span class="nv">$ </span>docker ps <span class="nt">-a</span>
<span class="nv">$ </span>docker ps <span class="nt">-a</span> | <span class="nb">grep </span>worker<span class="err">$</span>
<span class="c"># =&gt; 242777ad8f3c   kindest/node:v1.31.0                 "/usr/local/bin/entrâ€¦"   6 hours ago     Exited (130) 7 minutes ago    myk8s-worker</span>

<span class="c">## ì§€ì†ì ìœ¼ë¡œ ë°˜ë³µ ì ‘ì† ìƒíƒœ ëª¨ë‹ˆí„°ë§</span>
<span class="c">### curl ì—°ì† ì ‘ì† ì‹œë„ &gt;&gt; ëŒ€ëµ 10ì´ˆ ì´ë‚´ì— ì •ìƒ ì ‘ê·¼ ë˜ì—ˆì§€ë§Œ, 20ì´ˆê¹Œì§€ëŠ” ë¶ˆì•ˆì •í•˜ê²Œ ì ‘ì†ì´ ë˜ì—ˆë‹¤</span>
<span class="c">### ì‹¤ì œë¡œëŠ” ë‹¤ë¥¸ ë…¸ë“œì˜ speaker íŒŒë“œê°€ ë¦¬ë”ê°€ ë˜ê³ , ì´í›„ ë‹¤ì‹œ ë…¸ë“œ(ì»¨í…Œì´ë„ˆ)ê°€ ì •ìƒí™”ë˜ë©´, ë‹¤ì‹œ ë¦¬ë” speaker ê°€ ë¨</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$SVC1EXIP</span><span class="s2"> | egrep 'Hostname|RemoteAddr'; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>
<span class="c"># =&gt; Hostname: webpod2</span>
<span class="c">#    RemoteAddr: 172.20.0.3:25432</span>
<span class="c">#    2024-10-05 12:04:30</span>
<span class="c">#    </span>
<span class="c">#    2024-10-05 12:04:32</span>
<span class="c">#    </span>
<span class="c">#    2024-10-05 12:04:34</span>
<span class="c">#    </span>
<span class="c">#    Hostname: webpod2</span>
<span class="c">#    RemoteAddr: 172.20.0.3:18511</span>
<span class="c">#    2024-10-05 12:04:35</span>
<span class="c">#    </span>
<span class="c">#    2024-10-05 12:04:37</span>
<span class="c">#    </span>
<span class="c">#    2024-10-05 12:04:39</span>
<span class="c">#    ...</span>

<span class="c"># ë³€ê²½ëœ ë¦¬ë” Speaker íŒŒë“œ í™•ì¸</span>
<span class="c"># mypc/mypc2 ì—ì„œ í˜„ì¬ SVC EXTERNAL-IPë¥¼ ë‹´ë‹¹í•˜ëŠ” ë¦¬ë” Speaker íŒŒë“œ ì°¾ê¸°</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$SVC1EXIP</span> <span class="nv">$SVC2EXIP</span> <span class="nv">$SVC3EXIP</span><span class="p">;</span> <span class="k">do </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ping <span class="nt">-c</span> 1 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># mypc/mypc2 ì—ì„œ arp í…Œì´ë¸” ì •ë³´ í™•ì¸ &gt;&gt; SVC IPë³„ë¡œ ë¦¬ë” íŒŒë“œ(ìŠ¤í”¼ì»¤) ì—­í• ì˜ ë…¸ë“œë¥¼ í™•ì¸!</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ip <span class="nt">-c</span> neigh | <span class="nb">sort</span>
<span class="c"># =&gt; &lt;span style="color:purple;"&gt;172.20.0.1 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:1f:41:79:66 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.2 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:02 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.3 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:03 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.4 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:04 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.5 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:05 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.200 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:03 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.201 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:02 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.202 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:03 &lt;/span&gt;REACHABLE </span>
<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span> <span class="c"># mac ì£¼ì†Œì— ë§¤ì¹­ë˜ëŠ” IP(ë…¸ë“œ) ì°¾ê¸°</span>
<span class="c"># =&gt; NAME                  STATUS     ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    myk8s-control-plane   Ready      control-plane   5h47m   v1.31.0   172.20.0.5    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker          NotReady   &amp;lt;none&amp;gt;          5h47m   v1.31.0   172.20.0.4    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker2         Ready      &amp;lt;none&amp;gt;          5h47m   v1.31.0   172.20.0.2    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker3         Ready      &amp;lt;none&amp;gt;          5h47m   v1.31.0   172.20.0.3    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>

<span class="c"># &lt;span style="color: green;"&gt;ì›ë˜ ë¦¬ë” Speaker íŒŒë“œê°€ ì¡´ì¬í–ˆë˜ myk8s-worker ë…¸ë“œê°€ ì•„ë‹Œ&lt;/span&gt; </span>
<span class="c"># &lt;span style="color: green;"&gt;myk8s-worker3 ë…¸ë“œê°€ ë¦¬ë” Speaker íŒŒë“œë¥¼ ê°€ì§€ê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì¥ì•  ì›ë³µ(ë…¸ë“œ ì •ìƒí™”)</span>
<span class="c">## ë…¸ë“œ(ì‹¤ì œ ì»¨í…Œì´ë„ˆ) ì •ìƒí™” </span>
<span class="c"># $ docker start &lt;svc1 ë²ˆ ë¦¬ë” Speaker íŒŒë“œê°€ ì¡´ì¬í•˜ëŠ” ë…¸ë“œ(ì‹¤ì œëŠ” ì»¨í…Œì´ë„ˆ)&gt;</span>
<span class="nv">$ </span>docker start myk8s-worker

<span class="c"># ë³€ê²½ëœ ë¦¬ë” Speaker íŒŒë“œ í™•ì¸</span>
<span class="c"># mypc/mypc2 ì—ì„œ í˜„ì¬ SVC EXTERNAL-IPë¥¼ ë‹´ë‹¹í•˜ëŠ” ë¦¬ë” Speaker íŒŒë“œ ì°¾ê¸°</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$SVC1EXIP</span> <span class="nv">$SVC2EXIP</span> <span class="nv">$SVC3EXIP</span><span class="p">;</span> <span class="k">do </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ping <span class="nt">-c</span> 1 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># mypc/mypc2 ì—ì„œ arp í…Œì´ë¸” ì •ë³´ í™•ì¸ &gt;&gt; SVC IPë³„ë¡œ ë¦¬ë” íŒŒë“œ(ìŠ¤í”¼ì»¤) ì—­í• ì˜ ë…¸ë“œë¥¼ í™•ì¸!</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ip <span class="nt">-c</span> neigh | <span class="nb">sort</span>
<span class="c"># =&gt; &lt;span style="color:purple;"&gt;172.20.0.1 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:1f:41:79:66 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.2 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:02 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.3 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:03 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.4 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:04 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.5 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:05 &lt;/span&gt;STALE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.200 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:03 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.201 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:02 &lt;/span&gt;REACHABLE </span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.255.202 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;lladdr &lt;span style="color:olive;"&gt;02:42:ac:14:00:04 &lt;/span&gt;REACHABLE </span>
<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span> <span class="c"># mac ì£¼ì†Œì— ë§¤ì¹­ë˜ëŠ” IP(ë…¸ë“œ) ì°¾ê¸°</span>

<span class="c"># &lt;span style="color: green;"&gt;myk8s-workerë¥¼ ë³µêµ¬í•˜ë‹ˆ SVC3ì˜ ë¦¬ë” ìŠ¤í”¼ì»¤ íŒŒë“œê°€ ë‹¤ì‹œ myk8s-workerê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt; </span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_14.png" alt="20241005_kans_w5_14.png" class="image-center" />
<em class="image-caption">ì¥ì• ë°œìƒí›„ ë³µêµ¬ ë˜ê¸°ê¹Œì§€ ì‹¤ìŠµ í™”ë©´</em></p>

<h5 id="ì˜µì…˜-externaltrafficpolicy-local">(ì˜µì…˜) externalTrafficPolicy: Local</h5>

<ul>
  <li>LoadBalancerë„ NodePortì™€ ë§ˆì°¬ê°€ì§€ë¡œ externalTrafficPolicy ì˜µì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì„¤ì • ë°©ë²•</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl patch svc svc1 <span class="nt">-p</span> <span class="s1">'{"spec":{"externalTrafficPolicy": "Local"}}'</span>
<span class="nv">$ </span>kubectl patch svc svc2 <span class="nt">-p</span> <span class="s1">'{"spec":{"externalTrafficPolicy": "Local"}}'</span>
<span class="nv">$ </span>kubectl patch svc svc3 <span class="nt">-p</span> <span class="s1">'{"spec":{"externalTrafficPolicy": "Local"}}'</span>
</code></pre></div></div>

<ul>
  <li>í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë¹„ìŠ¤ì˜ External IPë¡œ ì ‘ì†ì‹œ, ë¦¬ë” ìŠ¤í”¼ì»¤ ë…¸ë“œì— ìœ„ì¹˜í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒë“œë¡œë§Œ ì ‘ì†ì´ ë˜ë©°, í´ë¼ì´ì–¸íŠ¸ IPê°€ ë³´ì¡´ë©ë‹ˆë‹¤.</li>
  <li>ë‹¨ì 
    <ul>
      <li>ë¶€í•˜ë¶„ì‚°ì´ ë˜ì§€ ì•Šì•„ ë¹„íš¨ìœ¨ì ì…ë‹ˆë‹¤.</li>
      <li>ë¦¬ë” ë…¸ë“œì— ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒë“œê°€ ì—†ì„ ê²½ìš° ì„œë¹„ìŠ¤ ì ‘ì†ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ë”°ë¼ì„œ MetalLBì—ì„œëŠ” externalTrafficPolicy: Local ì˜µì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="metallb---bgp-ëª¨ë“œ">MetalLB - BGP ëª¨ë“œ</h4>

<ul>
  <li>í˜„ì¬ ì‹¤ìŠµí™˜ê²½ì´ KIND ì—¬ì„œ BGP ëª¨ë“œëŠ” ì‹¤ìŠµì„ ëª»í•´ë³´ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
  <li>í–¥í›„ì— baremetalì´ë‚˜ VMìœ¼ë¡œ êµ¬ì„±ëœ í´ëŸ¬ìŠ¤í„°ì—ì„œ BGP ëª¨ë“œë¥¼ ì‹¤ìŠµí•´ ë³´ê³  ì´ë²ˆì—ëŠ” ì´ë¡ ë§Œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_15.png" alt="img.png" /></p>

<ul>
  <li>BGP ëª¨ë“œì—ì„œëŠ” ARPë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , BGP ë°ëª¬ì„ ì‚¬ìš©í•˜ì—¬, í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì˜ ë¼ìš°í„°ì— External IPë¥¼ ì „íŒŒí•©ë‹ˆë‹¤.</li>
  <li>ARP ëª¨ë“œëŠ” ìŠ¤í”¼ì»¤ ë¦¬ë”ê°€ ìˆëŠ” ë…¸ë“œë¡œë§Œ íŠ¸ë˜í”½ì´ ì „ë‹¬ë˜ì—ˆì§€ë§Œ, BGP ëª¨ë“œì—ì„œëŠ” ECMPë¥¼ ì§€ì›í•˜ì—¬ ì—¬ëŸ¬ ë…¸ë“œì— ì„œë¹„ìŠ¤ë¥¼ ë¶„ì‚°ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>BGP íŒ¨í‚·ì„ ìº¡ì³í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ Serviceì˜ External IPë¥¼ ì „íŒŒí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w5/20241005_kans_w5_16.png" alt="img.png" /></li>
  <li>ì´ë•ŒëŠ” <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> ì˜ ì‚¬ìš©ì„ ì ê·¹ ê¶Œì¥í•©ë‹ˆë‹¤.</li>
  <li>ë˜í•œ Failoverê°€ ë§¤ìš° ë¹ ë¥´ë©° ê±°ì˜ ë¬´ì¤‘ë‹¨ìœ¼ë¡œ ì„œë¹„ìŠ¤ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="bgp-ëª¨ë“œ-ì„¤ì •">BGP ëª¨ë“œ ì„¤ì •</h5>

<ul>
  <li>
    <p>MetalLBì˜ BGP ëª¨ë“œ ì„¤ì •ì€ ConfigMapì„ í†µí•´ ì„¤ì •í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl replace --force -f -
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    peers:
    - peer-address: 192.168.10.254
      peer-asn: 64513
      my-asn: 64512
    address-pools:
    - name: default
      protocol: bgp
      avoid-buggy-ips: true
      addresses:
      - 172.20.1.0/24
</span><span class="no">EOF
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>ë¦¬ëˆ…ìŠ¤ ë¼ìš°í„°ì— BGP ì„¤ì • ì˜ˆì‹œ</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>router bgp 64513
  bgp router-id 192.168.10.254
  maximum-paths 4
  network 10.1.1.0/24
  neighbor 192.168.10.10  remote-as 64512
  neighbor 192.168.10.101 remote-as 64512
  neighbor 192.168.10.102 remote-as 64512
  ...
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="externalip-ì„œë¹„ìŠ¤">ExternalIP ì„œë¹„ìŠ¤</h2>

<ul>
  <li>ExternalIP ì„œë¹„ìŠ¤ëŠ” NodePort ì„œë¹„ìŠ¤ì™€ ìœ ì‚¬í•˜ê²Œ ì™¸ë¶€ IPë¥¼ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</li>
  <li>ExternalIP ì„œë¹„ìŠ¤ëŠ” íŠ¹ì • ë…¸ë“œIPë¡œ ì¸ì…í•œ íŠ¸ë˜í”½ì„ í•´ë‹¹ ë…¸ë“œì˜ íŒŒë“œë¡œ ì „ë‹¬í•´ì„œ ì™¸ë¶€ì—ì„œ ì ‘ì†í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.</li>
  <li>ë‹¨ ì‚¬ìš©ì„ ê¶Œì¥í•˜ê³  ìˆì§€ëŠ” ì•Šìœ¼ë©°, íŠ¹ë³„í•œ ì´ìœ ê°€ ì—†ë‹¤ë©´ NodePortë¥¼ ì‚¬ìš©í•˜ëŠ”ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>ì„¤ì • í•­ëª©</th>
      <th>ì„¤ëª…</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>spec.externalIPs</td>
      <td>ë…¸ë“œ IP ì£¼ì†Œ(ExternalIP)</td>
    </tr>
    <tr>
      <td>spec.ports[].port</td>
      <td>ExternalIP ì™€ ClusterIP ì—ì„œ ìˆ˜ì‹ í•  í¬íŠ¸ ë²ˆí˜¸</td>
    </tr>
    <tr>
      <td>spec.ports[].targetPort</td>
      <td>ëª©ì ì§€ ì»¨í…Œì´ë„ˆ í¬íŠ¸ ë²ˆí˜¸</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>ì‹¤ìŠµ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-echo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: deploy-websrv
  template:
    metadata:
      labels:
        app: deploy-websrv
    spec:
      terminationGracePeriodSeconds: 0
      containers:
      - name: ndks-websrv
        image: k8s.gcr.io/echoserver:1.5
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: svc-externalip
spec:
  type: ClusterIP
  externalIPs:
    - 192.168.10.101
    - 192.168.10.102
  ports:
    - name: svc-webport
      port: 9000
      targetPort: 8080
  selector:
    app: deploy-websrv
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/deploy-echo created</span>
<span class="c">#    service/svc-externalip created</span>

<span class="c"># í™•ì¸ : ExternalIP ë„ ê²°êµ­ ClusterIPë¥¼ ì‚¬ìš©(í¬í•¨)</span>
<span class="nv">$ </span>kubectl get svc svc-externalip
<span class="c"># =&gt; NAME             TYPE        CLUSTER-IP    EXTERNAL-IP                     PORT(S)    AGE</span>
<span class="c">#    svc-externalip   ClusterIP   10.200.1.42   192.168.10.101,192.168.10.102   9000/TCP   14s</span>

<span class="nv">$ </span>kubectl describe svc svc-externalip
<span class="c"># =&gt; Name:                     svc-externalip</span>
<span class="c">#    Namespace:                default</span>
<span class="c">#    Labels:                   &amp;lt;none&amp;gt;</span>
<span class="c">#    Annotations:              &amp;lt;none&amp;gt;</span>
<span class="c">#    Selector:                 app=deploy-websrv</span>
<span class="c">#    Type:                     ClusterIP</span>
<span class="c">#    IP Family Policy:         SingleStack</span>
<span class="c">#    IP Families:              IPv4</span>
<span class="c">#    IP:                       10.200.1.42</span>
<span class="c">#    IPs:                      10.200.1.42</span>
<span class="c">#    External IPs:             192.168.10.101,192.168.10.102</span>
<span class="c">#    Port:                     svc-webport  9000/TCP</span>
<span class="c">#    TargetPort:               8080/TCP</span>
<span class="c">#    Endpoints:                10.10.1.3:8080,10.10.3.2:8080</span>
<span class="c">#    Session Affinity:         None</span>
<span class="c">#    External Traffic Policy:  Cluster</span>
<span class="c">#    Internal Traffic Policy:  Cluster</span>
<span class="c">#    Events:                   &amp;lt;none&amp;gt;</span>

<span class="c"># ExternalTrafficPolicy ì„¤ì •ì´ ì—†ìŒ</span>
<span class="nv">$ </span>kubectl get svc svc-externalip <span class="nt">-o</span> yaml
<span class="c"># =&gt; apiVersion: v1</span>
<span class="c">#    kind: Service</span>
<span class="c">#    metadata:</span>
<span class="c">#      creationTimestamp: &amp;quot;2024-10-05T12:45:06Z&amp;quot;</span>
<span class="c">#      name: svc-externalip</span>
<span class="c">#      namespace: default</span>
<span class="c">#      resourceVersion: &amp;quot;38088&amp;quot;</span>
<span class="c">#      uid: b64588f5-1589-4b9b-9652-b5979f8872a1</span>
<span class="c">#    spec:</span>
<span class="c">#      clusterIP: 10.200.1.42</span>
<span class="c">#      clusterIPs:</span>
<span class="c">#      - 10.200.1.42</span>
<span class="c">#      externalIPs:</span>
<span class="c">#      - 192.168.10.101</span>
<span class="c">#      - 192.168.10.102</span>
<span class="c">#      externalTrafficPolicy: Cluster</span>
<span class="c">#      internalTrafficPolicy: Cluster</span>
<span class="c">#      ipFamilies:</span>
<span class="c">#      - IPv4</span>
<span class="c">#      ipFamilyPolicy: SingleStack</span>
<span class="c">#      ports:</span>
<span class="c">#      - name: svc-webport</span>
<span class="c">#        port: 9000</span>
<span class="c">#        protocol: TCP</span>
<span class="c">#        targetPort: 8080</span>
<span class="c">#      selector:</span>
<span class="c">#        app: deploy-websrv</span>
<span class="c">#      sessionAffinity: None</span>
<span class="c">#      type: ClusterIP</span>
<span class="c">#    status:</span>
<span class="c">#      loadBalancer: {}</span>
</code></pre></div></div>

<hr />

<h2 id="ipvs-proxy-ëª¨ë“œ">IPVS Proxy ëª¨ë“œ</h2>

<h3 id="ipvs-proxy-ëª¨ë“œ-ì†Œê°œ">IPVS Proxy ëª¨ë“œ ì†Œê°œ</h3>

<ul>
  <li>IPVS Proxy ëª¨ë“œëŠ” ì§€ë‚œì£¼ì— ì‚´í´ë³´ì•˜ë˜ <strong>kube-proxyì˜ ëª¨ë“œì¤‘ í•˜ë‚˜</strong>ë¡œ, ë¦¬ëˆ…ìŠ¤ <strong>ì»¤ë„ì˜ IPVS ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ë¡œë“œë°¸ëŸ°ì‹±ì„ ìˆ˜í–‰</strong>í•©ë‹ˆë‹¤.</li>
  <li>IPVSëŠ” L4 ë ˆì´ì–´ì—ì„œ ë™ì‘í•˜ë©°, kube-proxyì˜ iptables ëª¨ë“œë³´ë‹¤ <strong>ì„±ëŠ¥ì´ ìš°ìˆ˜</strong>í•˜ê³ , ëŒ€ê·œëª¨ í´ëŸ¬ìŠ¤í„°ì—ì„œ ë” <strong>íš¨ìœ¨ì ìœ¼ë¡œ ë™ì‘</strong>í•©ë‹ˆë‹¤.</li>
  <li>iptablesì´ ë¹„í•´ ì¢€ ë” ë†’ì€ ì„±ëŠ¥ì„ ë³´ì—¬ì£¼ë©°, ê·œì¹™ ê°¯ìˆ˜ë„ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë¶€í•˜ë¶„ì‚° ì•Œê³ ë¦¬ì¦˜ë„ ë‹¤ìŒê³¼ ê°™ì´ ë‹¤ì–‘í•˜ê²Œ ì§€ì›í•©ë‹ˆë‹¤.
    <ul>
      <li>ë¼ìš´ë“œ ë¡œë¹ˆ (Round Robin) : ìš°ì„ ìˆœìœ„ë¥¼ ë‘ì§€ ì•Šê³  ìš”ì²­ì„ ìˆœì°¨ì ìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
        <ul>
          <li>ê°€ì¤‘ì¹˜ ë¼ìš´ë“œ ë¡œë¹ˆ (Weighted Round Robin) : ì„œë²„ì— ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•˜ì—¬ ìš”ì²­ì„ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ìµœì†Œ ì—°ê²° (Least Connection) : í˜„ì¬ ì—°ê²° ìˆ˜ê°€ ê°€ì¥ ì ì€ ì„œë²„ë¡œ ìš”ì²­ì„ ì „ë‹¬í•©ë‹ˆë‹¤.
        <ul>
          <li>ê°€ì¤‘ì¹˜ ìµœì†Œ ì—°ê²° (Weighted Least Connection) : ì„œë²„ì— ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•˜ì—¬ ì—°ê²° ìˆ˜ê°€ ê°€ì¥ ì ì€ ì„œë²„ë¡œ ìš”ì²­ì„ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
          <li>ì§€ì—­ì„± ê¸°ë°˜ ìµœì†Œ ì—°ê²° (Locality-Based Least Connection) : í´ë¼ì´ì–¸íŠ¸ì™€ ê°€ê¹Œìš°ë©´ì„œ ìš”ì²­ì´ ì ì€ ì„œë²„ë¡œ ìš”ì²­ì„ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ëª©ì ì§€ í•´ì‹± (Destination Hashing) : ìš”ì²­ì˜ ëª©ì ì§€ IP ì£¼ì†Œë¥¼ í•´ì‹±í•˜ì—¬ ì„œë²„ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</li>
      <li>ì¶œë°œì§€ í•´ì‹± (Source Hashing) : ìš”ì²­ì˜ ì¶œë°œì§€ IP ì£¼ì†Œë¥¼ í•´ì‹±í•˜ì—¬ ì„œë²„ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</li>
      <li>ìµœë‹¨ ì§€ì—° (Shortest Expected Delay) : ì„œë²„ì˜ ì‘ë‹µ ì§€ì—° ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì„œë²„ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</li>
      <li>íì‰ ë°©ì§€ (Never Queue) : ì—°ê²°ì´ ì—†ëŠ” ì„œë²„ì— ìš°ì„ ì ìœ¼ë¡œ íŠ¸ë˜í”½ì„ ë³´ë‚´ê³ , ëª¨ë“  ì„œë²„ì— íŠ¸ë˜í”½ì´ ìˆìœ¼ë©´ ìµœë‹¨ ì§€ì—° ë°©ì‹ìœ¼ë¡œ íŠ¸ë˜í”½ì„ ë³´ëƒ…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="ipvs-proxy-ëª¨ë“œ-ì‹¤ìŠµ">IPVS Proxy ëª¨ë“œ ì‹¤ìŠµ</h3>

<h4 id="ì‹¤ìŠµí™˜ê²½-ì„¤ì •">ì‹¤ìŠµí™˜ê²½ ì„¤ì •</h4>

<ul>
  <li>ë¨¼ì € ê¸°ì¡´ ì‹¤ìŠµ í™˜ê²½ì„ ì‚­ì œí•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kind delete cluster <span class="nt">--name</span> myk8s
<span class="c"># =&gt; Deleting cluster "myk8s" ...</span>
<span class="c">#    Deleted nodes: ["myk8s-worker" "myk8s-control-plane" "myk8s-worker2" "myk8s-worker3"]</span>
</code></pre></div></div>

<ul>
  <li>ì‹¤ìŠµí™˜ê²½ì€ KINDë¥¼ ì‚¬ìš©í•˜ë©°, KIND í´ëŸ¬ìŠ¤í„°ì— IPVS Proxy ëª¨ë“œë¥¼ ì ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ì‹¤ìŠµ í™˜ê²½ : K8S v1.31.0, CNI(Kindnet / Direct Routing mode),  IPVS proxy mode
    <ul>
      <li>ë…¸ë“œ(ì‹¤ì œë¡œëŠ” ì»¨í…Œì´ë„ˆ) ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ : 172.20.0.0/16</li>
      <li>íŒŒë“œ ì‚¬ìš© ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ : 10.10.0.0/16 â‡’ ê°ê° 10.10.1.0/24, 10.10.2.0/24, 10.10.3.0/24, 10.10.4.0/24</li>
      <li>ì„œë¹„ìŠ¤ ì‚¬ìš© ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ : 10.200.1.0/24</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_18.png" alt="img.png" class="image-center" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒì¼ ì‘ì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; kind-svc-2w-ipvs.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
featureGates:
  "InPlacePodVerticalScaling": true
  "MultiCIDRServiceAllocator": true
nodes:
- role: control-plane
  labels:
    mynode: control-plane
    topology.kubernetes.io/zone: ap-northeast-2a
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  - containerPort: 30003
    hostPort: 30003
  - containerPort: 30004
    hostPort: 30004
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
      extraArgs:
        runtime-config: api/all=true
    controllerManager:
      extraArgs:
        bind-address: 0.0.0.0
    etcd:
      local:
        extraArgs:
          listen-metrics-urls: http://0.0.0.0:2381
    scheduler:
      extraArgs:
        bind-address: 0.0.0.0
  - |
    kind: KubeProxyConfiguration
    metricsBindAddress: 0.0.0.0
    ipvs:
      strictARP: true
- role: worker
  labels:
    mynode: worker1
    topology.kubernetes.io/zone: ap-northeast-2a
- role: worker
  labels:
    mynode: worker2
    topology.kubernetes.io/zone: ap-northeast-2b
- role: worker
  labels:
    mynode: worker3
    topology.kubernetes.io/zone: ap-northeast-2c
networking:
  podSubnet: 10.10.0.0/16
  serviceSubnet: 10.200.1.0/24
  kubeProxyMode: "ipvs"        
</span><span class="no">EOT

</span><span class="c"># k8s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-svc-2w-ipvs.yaml <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.31.0
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS         PORTS                                                             NAMES</span>
<span class="c">#    aa2f031f0959   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   2 minutes ago   Up 2 minutes                                                                     myk8s-worker3</span>
<span class="c">#    0a67b245f7ee   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   2 minutes ago   Up 2 minutes   0.0.0.0:30000-30004-&amp;gt;30000-30004/tcp, 127.0.0.1:49623-&amp;gt;6443/tcp   myk8s-control-plane</span>
<span class="c">#    4525aac3b06f   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   2 minutes ago   Up 2 minutes                                                                     myk8s-worker2</span>
<span class="c">#    0087fe52e3d2   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   2 minutes ago   Up 2 minutes                                                                     myk8s-worker</span>

<span class="c"># ë…¸ë“œì— ê¸°ë³¸ íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget bsdmainutils bridge-utils net-tools dnsutils ipset ipvsadm nfacct tcpdump ngrep iputils-ping arping git vim arp-scan -y'</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget bsdmainutils bridge-utils net-tools dnsutils ipset ipvsadm nfacct tcpdump ngrep iputils-ping arping -y'</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># kube-proxy configmap í™•ì¸</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kube-proxy
<span class="c"># =&gt; ...</span>
<span class="c">#    mode: ipvs</span>
<span class="c">#    ipvs: # ì•„ë˜ ê°ê° ì˜µì…˜ ì˜ë¯¸ ì¡°ì‚¬í•´ë´…ì‹œë‹¤.</span>
<span class="c">#      excludeCIDRs: null   # IPVSì—ì„œ ì œì™¸í•  CIDRì„ ì§€ì •í•©ë‹ˆë‹¤. IPVS ë£°ì„ ì •ë¦¬í• ë•Œ ì œì™¸í•  ëŒ€ì—­ì„ ì§€ì •í•©ë‹ˆë‹¤.</span>
<span class="c">#      minSyncPeriod: 0s    # IPVS ë£°ì„ ë™ê¸°í™”í•  ìµœì†Œ ì£¼ê¸°ë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì´ ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ IPVS ë£°ì„ ë™ê¸°í™”í•˜ëŠ” ì£¼ê¸°ë¥¼ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
<span class="c">#      scheduler: ""        # IPVS ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” IPVSê°€ ì‚¬ìš©í•  ë¡œë“œë°¸ëŸ°ì‹± ì•Œê³ ë¦¬ì¦˜ì„ ì§€ì •í•©ë‹ˆë‹¤.</span>
<span class="c">#      strictARP: true      # MetalLB ë™ì‘ì„ ìœ„í•´ì„œ true ì„¤ì • ë³€ê²½ í•„ìš”</span>
<span class="c">#      syncPeriod: 0s       # IPVS ë£°ì„ ë™ê¸°í™”í•  ì£¼ê¸°ë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì´ ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ IPVS ë£°ì„ ë™ê¸°í™”í•˜ëŠ” ì£¼ê¸°ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
<span class="c">#      tcpFinTimeout: 0s    # IPVSì—ì„œ TCP ì—°ê²°ì´ ì¢…ë£Œëœ í›„ FIN ìƒíƒœë¥¼ ìœ ì§€í•˜ëŠ” ì‹œê°„ì„ ì§€ì •í•©ë‹ˆë‹¤.</span>
<span class="c">#      tcpTimeout: 0s       # IPVSì—ì„œ TCP íŒ¨í‚·ì„ ì²˜ë¦¬í•˜ëŠ” ì‹œê°„ì„ ì§€ì •í•©ë‹ˆë‹¤.</span>
<span class="c">#      udpTimeout: 0s       # IPVSì—ì„œ UDP íŒ¨í‚·ì„ ì²˜ë¦¬í•˜ëŠ” ì‹œê°„ì„ ì§€ì •í•©ë‹ˆë‹¤.</span>
<span class="c">#    ...</span>

<span class="c"># strictARP: trueëŠ” ARP íŒ¨í‚·ì„ ë³´ë‹¤ ì—„ê²©í•˜ê²Œ ì²˜ë¦¬í•˜ê² ë‹¤ëŠ” ì„¤ì •ì…ë‹ˆë‹¤.</span>
<span class="c">## IPVS ëª¨ë“œì—ì„œ strict ARPê°€ í™œì„±í™”ë˜ë©´, ë…¸ë“œì˜ ì¸í„°í˜ì´ìŠ¤ëŠ” ìì‹ ì—ê²Œ í• ë‹¹ëœ IP ì£¼ì†Œì— ëŒ€í•´ì„œë§Œ ARP ì‘ë‹µì„ ë³´ë‚´ê²Œ ë©ë‹ˆë‹¤. </span>
<span class="c">## ì´ëŠ” IPVSë¡œ ë¡œë“œë°¸ëŸ°ì‹±í•  ë•Œ ARP íŒ¨í‚·ì´ ì˜ëª»ëœ ì¸í„°í˜ì´ìŠ¤ë¡œ ì „ë‹¬ë˜ëŠ” ë¬¸ì œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.</span>
<span class="c">## ì´ ì„¤ì •ì€ íŠ¹íˆ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì¼í•œ IPë¥¼ ê°–ëŠ” VIP(Virtual IP)ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ì¤‘ìš”í•©ë‹ˆë‹¤.</span>

<span class="c"># ë…¸ë“œ ë³„ ë„¤íŠ¸ì›ŒíŠ¸ ì •ë³´ í™•ì¸ : kube-ipvs0 ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    default via &lt;span style="color:purple;"&gt;172.20.0.1 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.0.2 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;vethc61550c2 &lt;/span&gt;scope host </span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.0.3 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;veth85b53091 &lt;/span&gt;scope host </span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.0.4 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;veth8ad445fd &lt;/span&gt;scope host </span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.1.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.3 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.2.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.2 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.3.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.4 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.0/16 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;proto kernel scope link src &lt;span style="color:purple;"&gt;172.20.0.5 &lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    default via &lt;span style="color:purple;"&gt;172.20.0.1 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.0.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.5 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.1.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.3 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;10.10.2.0/24 &lt;/span&gt;via &lt;span style="color:purple;"&gt;172.20.0.2 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:purple;"&gt;172.20.0.0/16 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;eth0 &lt;/span&gt;proto kernel scope link src &lt;span style="color:purple;"&gt;172.20.0.4 &lt;/span&gt;</span>
<span class="c">#    ...</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    1: &lt;span style="color:teal;"&gt;lo: &lt;/span&gt;&amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span>
<span class="c">#        link/loopback &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt; brd &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt;</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;127.0.0.1&lt;/span&gt;/8 scope host lo</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    2: &lt;span style="color:teal;"&gt;tunl0@NONE: &lt;/span&gt;&amp;lt;NOARP&amp;gt; mtu 1480 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ipip &lt;span style="color:olive;"&gt;0.0.0.0&lt;/span&gt; brd &lt;span style="color:olive;"&gt;0.0.0.0&lt;/span&gt;</span>
<span class="c">#    4: &lt;span style="color:teal;"&gt;kube-ipvs0: &lt;/span&gt;&amp;lt;BROADCAST,NOARP&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;0a:91:66:a1:e6:bb&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt;</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.1&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.10&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    5: &lt;span style="color:teal;"&gt;vethc61550c2@if4: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;de:a6:86:25:bb:08&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns cni-4751a95b-cc8c-ff23-9dd5-35e7f1a2223b</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.10.0.1&lt;/span&gt;/32 scope global vethc61550c2</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    6: &lt;span style="color:teal;"&gt;veth85b53091@if4: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;ea:36:d9:10:fc:2f&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns cni-db21fe8b-f48c-f3fe-6c6a-b2f204eea0e5</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.10.0.1&lt;/span&gt;/32 scope global veth85b53091</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    7: &lt;span style="color:teal;"&gt;veth8ad445fd@if4: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;b6:bb:1b:44:13:eb&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns cni-26749ed0-4863-eef5-640b-96f804e871ae</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.10.0.1&lt;/span&gt;/32 scope global veth8ad445fd</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    46: &lt;span style="color:teal;"&gt;eth0@if47: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;02:42:ac:14:00:05&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netnsid 0</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;172.20.0.5&lt;/span&gt;/16 brd &lt;span style="color:purple;"&gt;172.20.255.255 &lt;/span&gt;scope global eth0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    1: &lt;span style="color:teal;"&gt;lo: &lt;/span&gt;&amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span>
<span class="c">#        link/loopback &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt; brd &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt;</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;127.0.0.1&lt;/span&gt;/8 scope host lo</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    2: &lt;span style="color:teal;"&gt;tunl0@NONE: &lt;/span&gt;&amp;lt;NOARP&amp;gt; mtu 1480 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ipip &lt;span style="color:olive;"&gt;0.0.0.0&lt;/span&gt; brd &lt;span style="color:olive;"&gt;0.0.0.0&lt;/span&gt;</span>
<span class="c">#    4: &lt;span style="color:teal;"&gt;kube-ipvs0: &lt;/span&gt;&amp;lt;BROADCAST,NOARP&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;fe:2c:45:76:c8:8d&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt;</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.1&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.10&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    44: &lt;span style="color:teal;"&gt;eth0@if45: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;02:42:ac:14:00:04&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netnsid 0</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;172.20.0.4&lt;/span&gt;/16 brd &lt;span style="color:purple;"&gt;172.20.255.255 &lt;/span&gt;scope global eth0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    ...</span>

<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë…¸ë“œë³„ë¡œ kube-ipvs0 ì¸í„°í˜ì´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìœ¼ë©°, IP ì£¼ì†Œê°€ í• ë‹¹ë˜ì–´ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-br</span> <span class="nt">-c</span> addr show kube-ipvs0<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    &lt;span style="color:teal;"&gt;kube-ipvs0       &lt;/span&gt;&lt;span style="color:red;"&gt;DOWN           &lt;/span&gt;&lt;span style="color:purple;"&gt;10.200.1.1&lt;/span&gt;/32 &lt;span style="color:purple;"&gt;10.200.1.10&lt;/span&gt;/32 </span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    &lt;span style="color:teal;"&gt;kube-ipvs0       &lt;/span&gt;&lt;span style="color:red;"&gt;DOWN           &lt;/span&gt;&lt;span style="color:purple;"&gt;10.200.1.1&lt;/span&gt;/32 &lt;span style="color:purple;"&gt;10.200.1.10&lt;/span&gt;/32 </span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker2 &amp;lt;&amp;lt;</span>
<span class="c">#    &lt;span style="color:teal;"&gt;kube-ipvs0       &lt;/span&gt;&lt;span style="color:red;"&gt;DOWN           &lt;/span&gt;&lt;span style="color:purple;"&gt;10.200.1.1&lt;/span&gt;/32 &lt;span style="color:purple;"&gt;10.200.1.10&lt;/span&gt;/32 </span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker3 &amp;lt;&amp;lt;</span>
<span class="c">#    &lt;span style="color:teal;"&gt;kube-ipvs0       &lt;/span&gt;&lt;span style="color:red;"&gt;DOWN           &lt;/span&gt;&lt;span style="color:purple;"&gt;10.200.1.1&lt;/span&gt;/32 &lt;span style="color:purple;"&gt;10.200.1.10&lt;/span&gt;/32 </span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-d</span> <span class="nt">-c</span> addr show kube-ipvs0<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    4: &lt;span style="color:teal;"&gt;kube-ipvs0: &lt;/span&gt;&amp;lt;BROADCAST,NOARP&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;0a:91:66:a1:e6:bb&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; promiscuity 0 minmtu 0 maxmtu 0 </span>
<span class="c">#        dummy numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 </span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.1&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.10&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    4: &lt;span style="color:teal;"&gt;kube-ipvs0: &lt;/span&gt;&amp;lt;BROADCAST,NOARP&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;fe:2c:45:76:c8:8d&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; promiscuity 0 minmtu 0 maxmtu 0 </span>
<span class="c">#        dummy numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 </span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.1&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.10&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker2 &amp;lt;&amp;lt;</span>
<span class="c">#    4: &lt;span style="color:teal;"&gt;kube-ipvs0: &lt;/span&gt;&amp;lt;BROADCAST,NOARP&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;5a:26:49:54:18:21&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; promiscuity 0 minmtu 0 maxmtu 0 </span>
<span class="c">#        dummy numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 </span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.1&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.10&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker3 &amp;lt;&amp;lt;</span>
<span class="c">#    4: &lt;span style="color:teal;"&gt;kube-ipvs0: &lt;/span&gt;&amp;lt;BROADCAST,NOARP&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default </span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;fa:0c:2d:44:52:23&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; promiscuity 0 minmtu 0 maxmtu 0 </span>
<span class="c">#        dummy numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 </span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.1&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;10.200.1.10&lt;/span&gt;/32 scope global kube-ipvs0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># kube-ipvs0 ì— í• ë‹¹ëœ IP(ê¸°ë³¸ IP + ë³´ì¡° IPë“¤) ì •ë³´ í™•ì¸ </span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE     NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                  AGE</span>
<span class="c">#    default       service/kubernetes   ClusterIP   10.200.1.1    &amp;lt;none&amp;gt;        443/TCP                  31m</span>
<span class="c">#    kube-system   service/kube-dns     ClusterIP   10.200.1.10   &amp;lt;none&amp;gt;        53/UDP,53/TCP,9153/TCP   31m</span>
<span class="c">#    </span>
<span class="c">#    NAMESPACE     NAME                   ENDPOINTS                                            AGE</span>
<span class="c">#    default       endpoints/kubernetes   172.20.0.5:6443                                      31m</span>
<span class="c">#    kube-system   endpoints/kube-dns     10.10.0.3:53,10.10.0.4:53,10.10.0.3:53 + 3 more...   31m</span>

<span class="c"># ipvsadm íˆ´ë¡œ ë¶€í•˜ë¶„ì‚° ë˜ëŠ” ì •ë³´ í™•ì¸ : ì„œë¹„ìŠ¤ì˜ IPì™€ ì„œë¹„ìŠ¤ì— ì—°ë™ë˜ì–´ ìˆëŠ” íŒŒë“œì˜ IP ë¥¼ í™•ì¸</span>
<span class="c">## Service IP(VIP) ì²˜ë¦¬ë¥¼ ipvs ì—ì„œ ë‹´ë‹¹ -&gt; ì´ë¥¼ í†µí•´ iptables ì— ì²´ì¸/ì •ì±…ì´ ìƒë‹¹ ìˆ˜ì¤€ ì¤„ì–´ë“¬</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ipvsadm <span class="nt">-Ln</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    IP Virtual Server version 1.2.1 (size=4096)</span>
<span class="c">#    Prot LocalAddress:Port Scheduler Flags</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span>
<span class="c">#    TCP  10.200.1.1:443 rr</span>
<span class="c">#      -&amp;gt; 172.20.0.5:6443              Masq    1      3          0         </span>
<span class="c">#    TCP  10.200.1.10:53 rr</span>
<span class="c">#      -&amp;gt; 10.10.0.3:53                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.0.4:53                 Masq    1      0          0         </span>
<span class="c">#    TCP  10.200.1.10:9153 rr</span>
<span class="c">#      -&amp;gt; 10.10.0.3:9153               Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.0.4:9153               Masq    1      0          0         </span>
<span class="c">#    UDP  10.200.1.10:53 rr</span>
<span class="c">#      -&amp;gt; 10.10.0.3:53                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.0.4:53                 Masq    1      0          0         </span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    IP Virtual Server version 1.2.1 (size=4096)</span>
<span class="c">#    Prot LocalAddress:Port Scheduler Flags</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span>
<span class="c">#    TCP  10.200.1.1:443 rr</span>
<span class="c">#      -&amp;gt; 172.20.0.5:6443              Masq    1      0          0         </span>
<span class="c">#    TCP  10.200.1.10:53 rr</span>
<span class="c">#      -&amp;gt; 10.10.0.3:53                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.0.4:53                 Masq    1      0          0         </span>
<span class="c">#    TCP  10.200.1.10:9153 rr</span>
<span class="c">#      -&amp;gt; 10.10.0.3:9153               Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.0.4:9153               Masq    1      0          0         </span>
<span class="c">#    UDP  10.200.1.10:53 rr</span>
<span class="c">#      -&amp;gt; 10.10.0.3:53                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.0.4:53                 Masq    1      0          0         </span>
<span class="c">#    ...</span>

<span class="c">## IPSET í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker ipset <span class="nt">-h</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker ipset <span class="nt">-L</span>

<span class="c"># iptables ì •ë³´ í™•ì¸ : ì •ì±… ê°¯ìˆ˜ë¥¼ iptables proxy ëª¨ë“œì™€ ë¹„êµí•´ë³´ì</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker3 iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># ê° ë…¸ë“œ bash ì ‘ì†</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker3 bash
<span class="nt">----------------------------------------</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------------------</span>

<span class="c"># mypc ì»¨í…Œì´ë„ˆ ê¸°ë™ : kind ë„ì»¤ ë¸Œë¦¬ì§€ë¥¼ ì‚¬ìš©í•˜ê³ , ì»¨í…Œì´ë„ˆ IPë¥¼ ì§ì ‘ ì§€ì • í˜¹ì€ IP ì§€ì • ì—†ì´ ë°°í¬</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">--rm</span> <span class="nt">--name</span> mypc <span class="nt">--network</span> kind <span class="nt">--ip</span> 172.20.0.100 nicolaka/netshoot <span class="nb">sleep </span>infinity
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">--rm</span> <span class="nt">--name</span> mypc <span class="nt">--network</span> kind nicolaka/netshoot <span class="nb">sleep </span>infinity

<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                                             NAMES</span>
<span class="c">#    16b541ee953e   nicolaka/netshoot      &amp;quot;sleep infinity&amp;quot;         31 seconds ago   Up 31 seconds                                                                     mypc</span>
<span class="c">#    aa2f031f0959   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   34 minutes ago   Up 34 minutes                                                                     myk8s-worker3</span>
<span class="c">#    0a67b245f7ee   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   34 minutes ago   Up 34 minutes   0.0.0.0:30000-30004-&amp;gt;30000-30004/tcp, 127.0.0.1:49623-&amp;gt;6443/tcp   myk8s-control-plane</span>
<span class="c">#    4525aac3b06f   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   34 minutes ago   Up 34 minutes                                                                     myk8s-worker2</span>
<span class="c">#    0087fe52e3d2   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   34 minutes ago   Up 34 minutes                                                                     myk8s-worker</span>
</code></pre></div></div>

<h5 id="ipvs-ì •ë³´-í™•ì¸">IPVS ì •ë³´ í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kube-proxy ë¡œê·¸ í™•ì¸ :  ê¸°ë³¸ê°’ ë¶€í•˜ë¶„ì‚° ìŠ¤ì¼€ì¤„ëŸ¬(RoundRobin = RR)</span>
<span class="nv">$ </span>kubectl stern <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-proxy <span class="nt">--since</span> 2h | egrep <span class="s1">'(ipvs|IPVS)'</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    kube-proxy-24z49 kube-proxy I1005 15:10:04.041490       1 server_linux.go:230] "Using ipvs Proxier"</span>
<span class="c">#    kube-proxy-24z49 kube-proxy I1005 15:10:04.048394       1 proxier.go:364] "IPVS scheduler not specified, use rr by default" ipFamily="IPv4"</span>
<span class="c">#    kube-proxy-24z49 kube-proxy I1005 15:10:04.048529       1 proxier.go:364] "IPVS scheduler not specified, use rr by default" ipFamily="IPv6"</span>

<span class="c"># ê¸°ë³¸ ëª¨ë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system kube-proxy <span class="nt">-o</span> yaml | egrep <span class="s1">'mode|strictARP|scheduler'</span>
<span class="c"># =&gt;       scheduler: &amp;quot;&amp;quot;</span>
<span class="c">#          strictARP: true</span>
<span class="c">#        mode: ipvs</span>

<span class="c"># ipvsadm íˆ´ë¡œ ë¶€í•˜ë¶„ì‚° ë˜ëŠ” ì •ë³´ í™•ì¸ : RR ë¶€í•˜ë¶„ì‚° ìŠ¤ì¼€ì¤„ëŸ¬ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ipvsadm <span class="nt">-Ln</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    IP Virtual Server version 1.2.1 (size=4096)</span>
<span class="c">#    Prot LocalAddress:Port Scheduler Flags</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span>
<span class="c">#    TCP  10.200.1.1:443 rr</span>
<span class="c">#      -&amp;gt; 172.20.0.5:6443              Masq    1      3          0         </span>
<span class="c">#    ...</span>

<span class="c"># ì»¤ë„ íŒŒë¼ë¯¸í„° í™•ì¸</span>
<span class="c"># (ì‹¬í™” ì˜µì…˜) strictARP - ë§í¬ ì„¤ì •(ìœ ì‚¬í•œ)ì´ìœ </span>
<span class="c"># --ipvs-strict-arp : Enable strict ARP by setting arp_ignore to 1 and arp_announce to 2</span>
<span class="c"># arp_ignore : ARP request ë¥¼ ë°›ì•˜ì„ë•Œ ì‘ë‹µ ì—¬ë¶€ - 0(ARP ìš”ì²­ ë„ì°©ì‹œ, any Interface ìˆìœ¼ë©´ ì‘ë‹µ), 1(ARP ìš”ì²­ì„ ë°›ì€ Interface ê°€ í•´ë‹¹ IPì¼ë•Œë§Œ ì‘ë‹µ)</span>
<span class="c"># arp_announce : ARP request ë¥¼ ë³´ë‚¼ ë•Œ 'ARP Sender IP ì£¼ì†Œ'ì— ì§€ì • ê°’ - 0(sender IPë¡œ ì‹œìŠ¤í…œì˜ any IP ê°€ëŠ¥), 2(sender IPë¡œ ì‹¤ì œ ì „ì†¡í•˜ëŠ” Interface ì— IPë¥¼ ì‚¬ìš©)</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker tree /proc/sys/net/ipv4/conf/kube-ipvs0
<span class="c"># =&gt; /proc/sys/net/ipv4/conf/kube-ipvs0</span>
<span class="c">#    |-- ...</span>
<span class="c">#    |-- arp_accept</span>
<span class="c">#    |-- arp_announce</span>
<span class="c">#    `-- ...</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker <span class="nb">cat</span> /proc/sys/net/ipv4/conf/kube-ipvs0/arp_ignore
<span class="c"># =&gt; 0</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker <span class="nb">cat</span> /proc/sys/net/ipv4/conf/kube-ipvs0/arp_announce
<span class="c"># =&gt; 0</span>

<span class="c"># all ì€ ëª¨ë“  ì¸í„°í˜ì´ìŠ¤ì— ì˜í•­ì„ ì¤Œ, ë‹¨ all ê³¼ interface ê°’ì´ ë‹¤ë¥¼ë•Œ ìš°ì„ ìˆœìœ„ëŠ” ì»¤ë„ íŒŒë¼ë¯¸í„° ë³„ë¡œ ë‹¤ë¥´ë‹¤ - ë§í¬</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker sysctl net.ipv4.conf.all.arp_ignore
<span class="c"># =&gt; net.ipv4.conf.all.arp_ignore = 1</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker sysctl net.ipv4.conf.all.arp_announce
<span class="c"># =&gt; net.ipv4.conf.all.arp_announce = 2</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker sysctl net.ipv4.conf.kube-ipvs0.arp_ignore
<span class="c"># =&gt; net.ipv4.conf.kube-ipvs0.arp_ignore = 0</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker sysctl net.ipv4.conf.kube-ipvs0.arp_announce
<span class="c"># =&gt; net.ipv4.conf.kube-ipvs0.arp_announce = 0</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker sysctl <span class="nt">-a</span> | <span class="nb">grep </span>arp_ignore
<span class="c"># =&gt; net.ipv4.conf.all.arp_ignore = 1</span>
<span class="c">#    net.ipv4.conf.default.arp_ignore = 0</span>
<span class="c">#    net.ipv4.conf.eth0.arp_ignore = 0</span>
<span class="c">#    net.ipv4.conf.ip6tnl0.arp_ignore = 0</span>
<span class="c">#    net.ipv4.conf.kube-ipvs0.arp_ignore = 0</span>
<span class="c">#    net.ipv4.conf.lo.arp_ignore = 0</span>
<span class="c">#    net.ipv4.conf.tunl0.arp_ignore = 0</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker sysctl <span class="nt">-a</span> | <span class="nb">grep </span>arp_announce
<span class="c"># =&gt; net.ipv4.conf.all.arp_announce = 2</span>
<span class="c">#    net.ipv4.conf.default.arp_announce = 0</span>
<span class="c">#    net.ipv4.conf.eth0.arp_announce = 0</span>
<span class="c">#    net.ipv4.conf.ip6tnl0.arp_announce = 0</span>
<span class="c">#    net.ipv4.conf.kube-ipvs0.arp_announce = 0</span>
<span class="c">#    net.ipv4.conf.lo.arp_announce = 0</span>
<span class="c">#    net.ipv4.conf.tunl0.arp_announce = 0</span>

<span class="c"># IPSET í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker ipset <span class="nt">-h</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker ipset <span class="nt">-L</span>
</code></pre></div></div>

<h5 id="ëª©ì ì§€backend-íŒŒë“œpod-ìƒì„±--3podyaml">ëª©ì ì§€(backend) íŒŒë“œ(Pod) ìƒì„± : 3pod.yaml</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; 3pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: webpod1
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod2
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker2
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod3
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker3
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
</span><span class="no">EOT
</span></code></pre></div></div>

<h5 id="í´ë¼ì´ì–¸íŠ¸testpod-ìƒì„±--netpodyaml">í´ë¼ì´ì–¸íŠ¸(TestPod) ìƒì„± : netpod.yaml</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; netpod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: net-pod
spec:
  nodeName: myk8s-control-plane
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOT
</span></code></pre></div></div>

<h5 id="ì„œë¹„ìŠ¤clusterip-ìƒì„±--svc-clusteripyaml">ì„œë¹„ìŠ¤(ClusterIP) ìƒì„± : svc-clusterip.yaml</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; svc-clusterip.yaml
apiVersion: v1
kind: Service
metadata:
  name: svc-clusterip
spec:
  ports:
    - name: svc-webport
      port: 9000        # ì„œë¹„ìŠ¤ IP ì— ì ‘ì† ì‹œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ port ë¥¼ ì˜ë¯¸
      targetPort: 80    # íƒ€í‚· targetPort ëŠ” ì„œë¹„ìŠ¤ë¥¼ í†µí•´ì„œ ëª©ì ì§€ íŒŒë“œë¡œ ì ‘ì† ì‹œ í•´ë‹¹ íŒŒë“œë¡œ ì ‘ì†í•˜ëŠ” í¬íŠ¸ë¥¼ ì˜ë¯¸
  selector:
    app: webpod         # ì…€ë ‰í„° ì•„ë˜ app:webpod ë ˆì´ë¸”ì´ ì„¤ì •ë˜ì–´ ìˆëŠ” íŒŒë“œë“¤ì€ í•´ë‹¹ ì„œë¹„ìŠ¤ì— ì—°ë™ë¨
  type: ClusterIP       # ì„œë¹„ìŠ¤ íƒ€ì…
</span><span class="no">EOT
</span></code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_19.png" alt="img.png" /></p>

<h5 id="ìƒì„±-ë°-í™•ì¸--ipvs-proxy-ëª¨ë“œ">ìƒì„± ë° í™•ì¸ : IPVS Proxy ëª¨ë“œ</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒì„±</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> 3pod.yaml,netpod.yaml,svc-clusterip.yaml
<span class="c"># =&gt; pod/webpod1 created</span>
<span class="c">#    pod/webpod2 created</span>
<span class="c">#    pod/webpod3 created</span>
<span class="c">#    pod/net-pod created</span>
<span class="c">#    service/svc-clusterip created</span>

<span class="c"># íŒŒë“œì™€ ì„œë¹„ìŠ¤ ì‚¬ìš© ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ì •ë³´ í™•ì¸ </span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt;                             &amp;quot;--service-cluster-ip-range=10.200.1.0/24&amp;quot;,</span>
<span class="c">#                                &amp;quot;--cluster-cidr=10.10.0.0/16&amp;quot;,</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME      READY   STATUS    RESTARTS   AGE   IP          NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    net-pod   1/1     Running   0          36s   10.10.0.5   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    webpod1   1/1     Running   0          36s   10.10.3.2   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    webpod2   1/1     Running   0          36s   10.10.1.2   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    webpod3   1/1     Running   0          36s   10.10.2.2   myk8s-worker3         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="nv">$ </span>kubectl get svc svc-clusterip
<span class="c"># =&gt; NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    svc-clusterip   ClusterIP   10.200.1.17   &amp;lt;none&amp;gt;        9000/TCP   44s</span>
<span class="nv">$ </span>kubectl describe svc svc-clusterip
<span class="nv">$ </span>kubectl get endpoints svc-clusterip
<span class="c"># =&gt; NAME            ENDPOINTS                                AGE</span>
<span class="c">#    svc-clusterip   10.10.1.2:80,10.10.2.2:80,10.10.3.2:80   55s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> kubernetes.io/service-name<span class="o">=</span>svc-clusterip
<span class="c"># =&gt; NAME                  ADDRESSTYPE   PORTS   ENDPOINTS                       AGE</span>
<span class="c">#    svc-clusterip-scf9k   IPv4          80      10.10.2.2,10.10.1.2,10.10.3.2   63s</span>

<span class="c"># ë…¸ë“œ ë³„ ë„¤íŠ¸ì›ŒíŠ¸ ì •ë³´ í™•ì¸ : kube-ipvs0 ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ í™•ì¸</span>
<span class="c">## ClusterIP ìƒì„± ì‹œ kube-ipvs0 ì¸í„°í˜ì´ìŠ¤ì— ClusterIP ê°€ í• ë‹¹ë˜ëŠ” ê²ƒì„ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-br</span> <span class="nt">-c</span> addr show kube-ipvs0<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-d</span> <span class="nt">-c</span> addr show kube-ipvs0<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ CIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.clusterIP}"</span><span class="si">)</span>
<span class="nv">$ CPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.ports[0].port}"</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CIP</span> <span class="nv">$CPORT</span>
<span class="c"># =&gt; 10.200.1.17 9000</span>

<span class="c"># ipvsadm íˆ´ë¡œ ë¶€í•˜ë¶„ì‚° ë˜ëŠ” ì •ë³´ í™•ì¸</span>
<span class="c">## 10.200.1.216(TCP 9000) ì¸ì… ì‹œ 3ê³³ì˜ ëª©ì ì§€ë¡œ ë¼ìš´ë“œë¡œë¹ˆ(rr)ë¡œ ë¶€í•˜ë¶„ì‚°í•˜ì—¬ ì „ë‹¬ë¨ì„ í™•ì¸ : ëª¨ë“  ë…¸ë“œì—ì„œ ë™ì¼í•œ IPVS ë¶„ì‚° ì„¤ì • ì •ë³´ í™•ì¸</span>
<span class="c">## 3ê³³ì˜ ëª©ì ì§€ëŠ” ê°ê° ì„œë¹„ìŠ¤ì— ì—°ë™ëœ ëª©ì ì§€ íŒŒë“œ 3ê°œì´ë©°, ì „ë‹¬ ì‹œ ì¶œë°œì§€ IPëŠ” ë§ˆìŠ¤ì»¤ë ˆì´ë”© ë³€í™˜ ì²˜ë¦¬</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ipvsadm <span class="nt">-Ln</span> <span class="nt">-t</span> <span class="nv">$CIP</span>:<span class="nv">$CPORT</span>
<span class="c"># =&gt; Prot LocalAddress:Port Scheduler Flags</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span>
<span class="c">#    TCP  10.200.1.17:9000 rr</span>
<span class="c">#      -&amp;gt; 10.10.1.2:80                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.2.2:80                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.3.2:80                 Masq    1      0          0         </span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ipvsadm <span class="nt">-Ln</span> <span class="nt">-t</span> <span class="nv">$CIP</span>:<span class="nv">$CPORT</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    Prot LocalAddress:Port Scheduler Flags</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span>
<span class="c">#    TCP  10.200.1.17:9000 rr</span>
<span class="c">#      -&amp;gt; 10.10.1.2:80                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.2.2:80                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.3.2:80                 Masq    1      0          0         </span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    Prot LocalAddress:Port Scheduler Flags</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span>
<span class="c">#    TCP  10.200.1.17:9000 rr</span>
<span class="c">#      -&amp;gt; 10.10.1.2:80                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.2.2:80                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.3.2:80                 Masq    1      0          0         </span>
<span class="c">#    ...</span>

<span class="c"># ipvsadm íˆ´ë¡œ ë¶€í•˜ë¶„ì‚° ë˜ëŠ” í˜„ì¬ ì—°ê²° ì •ë³´ í™•ì¸ : ì¶”ê°€ë¡œ --rate ë„ ìˆìŒ</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ipvsadm <span class="nt">-Ln</span> <span class="nt">-t</span> <span class="nv">$CIP</span>:<span class="nv">$CPORT</span> <span class="nt">--stats</span>
<span class="c"># =&gt; Prot LocalAddress:Port               Conns   InPkts  OutPkts  InBytes OutBytes</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port</span>
<span class="c">#    TCP  10.200.1.17:9000                    0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.1.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.2.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.3.2:80                        0        0        0        0        0</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ipvsadm <span class="nt">-Ln</span> <span class="nt">-t</span> <span class="nv">$CIP</span>:<span class="nv">$CPORT</span> <span class="nt">--stats</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    Prot LocalAddress:Port               Conns   InPkts  OutPkts  InBytes OutBytes</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port</span>
<span class="c">#    TCP  10.200.1.17:9000                    0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.1.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.2.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.3.2:80                        0        0        0        0        0</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    Prot LocalAddress:Port               Conns   InPkts  OutPkts  InBytes OutBytes</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port</span>
<span class="c">#    TCP  10.200.1.17:9000                    0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.1.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.2.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.3.2:80                        0        0        0        0        0</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ipvsadm <span class="nt">-Ln</span> <span class="nt">-t</span> <span class="nv">$CIP</span>:<span class="nv">$CPORT</span> <span class="nt">--rate</span>
<span class="c"># =&gt; Prot LocalAddress:Port                 CPS    InPPS   OutPPS    InBPS   OutBPS</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port</span>
<span class="c">#    TCP  10.200.1.17:9000                    0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.1.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.2.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.3.2:80                        0        0        0        0        0</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ipvsadm <span class="nt">-Ln</span> <span class="nt">-t</span> <span class="nv">$CIP</span>:<span class="nv">$CPORT</span> <span class="nt">--rate</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    Prot LocalAddress:Port                 CPS    InPPS   OutPPS    InBPS   OutBPS</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port</span>
<span class="c">#    TCP  10.200.1.17:9000                    0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.1.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.2.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.3.2:80                        0        0        0        0        0</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    Prot LocalAddress:Port                 CPS    InPPS   OutPPS    InBPS   OutBPS</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port</span>
<span class="c">#    TCP  10.200.1.17:9000                    0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.1.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.2.2:80                        0        0        0        0        0</span>
<span class="c">#      -&amp;gt; 10.10.3.2:80                        0        0        0        0        0</span>
<span class="c">#    ...</span>

<span class="c"># iptables ê·œì¹™ í™•ì¸ : ipset list ë¥¼ í™œìš©</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>KUBE-CLUSTER-IP
<span class="c"># =&gt; -A KUBE-SERVICES ! -s 10.10.0.0/16 -m comment --comment &amp;quot;Kubernetes service cluster ip + port for masquerade purpose&amp;quot; -m set --match-set KUBE-CLUSTER-IP dst,dst -j KUBE-MARK-MASQ</span>
<span class="c">#    -A KUBE-SERVICES -m set --match-set KUBE-CLUSTER-IP dst,dst -j ACCEPT</span>

<span class="c"># ipset list ì •ë³´ë¥¼ í™•ì¸ : KUBE-CLUSTER-IP ì´ë¦„ì€ ì•„ë˜ 6ê°œì˜ IP:Port ì¡°í•©ì„ ì§€ì¹­</span>
<span class="c"># ì˜ˆë¥¼ ë“¤ë©´ ipset list ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì„ ê²½ìš° 6ê°œì˜ iptables ê·œì¹™ì´ í•„ìš”í•˜ì§€ë§Œ, ipset ì‚¬ìš© ì‹œ 1ê°œì˜ ê·œì¹™ìœ¼ë¡œ ê°€ëŠ¥</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ipset list KUBE-CLUSTER-IP
<span class="c"># =&gt; Name: KUBE-CLUSTER-IP</span>
<span class="c">#    Type: hash:ip,port</span>
<span class="c">#    Revision: 5</span>
<span class="c">#    Header: family inet hashsize 1024 maxelem 65536</span>
<span class="c">#    Size in memory: 512</span>
<span class="c">#    References: 3</span>
<span class="c">#    Number of entries: 5</span>
<span class="c">#    Members:</span>
<span class="c">#    10.200.1.1,tcp:443</span>
<span class="c">#    10.200.1.10,tcp:9153</span>
<span class="c">#    10.200.1.10,tcp:53</span>
<span class="c">#    10.200.1.17,tcp:9000</span>
<span class="c">#    10.200.1.10,udp:53</span>
</code></pre></div></div>

<h4 id="ipvs-ì •ë³´-í™•ì¸-ë°-ì„œë¹„ìŠ¤-ì ‘ì†-í™•ì¸">IPVS ì •ë³´ í™•ì¸ ë° ì„œë¹„ìŠ¤ ì ‘ì† í™•ì¸</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ipvsadm <span class="nt">-Ln</span> <span class="nt">-t</span> <span class="nv">$CIP</span>:<span class="nv">$CPORT</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node myk8s-control-plane &amp;lt;&amp;lt;</span>
<span class="c">#    Prot LocalAddress:Port Scheduler Flags</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span>
<span class="c">#    TCP  10.200.1.17:9000 rr</span>
<span class="c">#      -&amp;gt; 10.10.1.2:80                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.2.2:80                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.3.2:80                 Masq    1      0          0         </span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node myk8s-worker &amp;lt;&amp;lt;</span>
<span class="c">#    Prot LocalAddress:Port Scheduler Flags</span>
<span class="c">#      -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span>
<span class="c">#    TCP  10.200.1.17:9000 rr</span>
<span class="c">#      -&amp;gt; 10.10.1.2:80                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.2.2:80                 Masq    1      0          0         </span>
<span class="c">#      -&amp;gt; 10.10.3.2:80                 Masq    1      0          0         </span>
<span class="c">#    ...</span>

<span class="c"># ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ CIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.clusterIP}"</span><span class="si">)</span>
<span class="nv">$ CPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.ports[0].port}"</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CIP</span> <span class="nv">$CPORT</span>
<span class="c"># =&gt; 10.200.1.17 9000</span>

<span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œì—ì„œ ipvsadm ëª¨ë‹ˆí„°ë§ ì‹¤í–‰ : ClusterIP ì ‘ì† ì‹œ ì•„ë˜ ì²˜ëŸ¼ ì—°ê²° ì •ë³´ í™•ì¸ë¨</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"docker exec -it myk8s-control-plane ipvsadm -Ln -t </span><span class="nv">$CIP</span><span class="s2">:</span><span class="nv">$CPORT</span><span class="s2"> --stats; echo; docker exec -it myk8s-control-plane ipvsadm -Ln -t </span><span class="nv">$CIP</span><span class="s2">:</span><span class="nv">$CPORT</span><span class="s2"> --rate"</span>

<span class="c"># --------------------------</span>

<span class="c"># ì„œë¹„ìŠ¤ IP ë³€ìˆ˜ ì§€ì • : svc-clusterip ì˜ ClusterIPì£¼ì†Œ</span>
<span class="nv">$ SVC1</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$SVC1</span>
<span class="c"># =&gt; 10.200.1.17</span>

<span class="c"># TCP 80,9000 í¬íŠ¸ë³„ ì ‘ì† í™•ì¸ : ì¶œë ¥ ì •ë³´ ì˜ë¯¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$SVC1</span>:9000
<span class="c"># =&gt; Hostname: webpod2</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 10.10.1.2</span>
<span class="c">#    IP: fe80::3009:36ff:fe8f:d5a</span>
<span class="c">#    RemoteAddr: 10.10.0.5:58980</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 10.200.1.17:9000</span>
<span class="c">#    User-Agent: curl/8.7.1</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$SVC1</span>:9000 | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod3</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$SVC1</span>:9000 | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod1</span>

<span class="c"># ì„œë¹„ìŠ¤(ClusterIP) ë¶€í•˜ë¶„ì‚° ì ‘ì† í™•ì¸ : ë¶€í•˜ë¶„ì‚° ë¹„ë¥  í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..10};   do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
<span class="c"># =&gt;       4 Hostname: webpod3</span>
<span class="c">#          3 Hostname: webpod2</span>
<span class="c">#          3 Hostname: webpod1</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};  do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
<span class="c"># =&gt;      34 Hostname: webpod1</span>
<span class="c">#         33 Hostname: webpod3</span>
<span class="c">#         33 Hostname: webpod2</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..1000}; do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
<span class="c"># =&gt;     334 Hostname: webpod2</span>
<span class="c">#        333 Hostname: webpod3</span>
<span class="c">#        333 Hostname: webpod1</span>
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};   do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; sleep 1; done"</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};   do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; sleep 0.1; done"</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..10000}; do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; sleep 0.01; done"</span>

<span class="c"># ë°˜ë³µ ì ‘ì†</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$SVC1</span><span class="s2">:9000 | egrep 'Hostname|RemoteAddr|Host:'; date '+%Y-%m-%d %H:%M:%S' ; echo '--------------' ;  sleep 1; done"</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w5/20241005_kans_w5_20.png" alt="img.png" class="image-center" />
<em class="image-caption">IPVS Proxy ëª¨ë“œ : ë¶€í•˜ë¶„ì‚° í™•ì¸</em></p>

<ul>
  <li>IPVSëŠ” ê¸°ì¡´ì˜ iptablesì˜ ë¶€í•˜ë¶„ì‚°ë³´ë‹¤ ë” ê· ë“±í•˜ê²Œ ë¶€í•˜ë¶„ì‚°ì„ ìˆ˜í–‰í•¨ì„ í™•ì¸ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆ ì£¼ì—ëŠ” LoadBalancer, LoadBalancerë¥¼ ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ MetalLB, ClusterIP, IPVS Proxy ëª¨ë“œì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.
ì˜¨í”„ë ˆë¯¸ìŠ¤ K8Sì—ì„œ ì„œë¹„ìŠ¤ ìœ í˜•ì„ LoadBalancerë¡œ í–ˆì„ë•Œ ExternalIPê°€ í• ë‹¹ ë˜ì§€ ì•Šì€ ì´ìœ ë¥¼ ì´ì œì•¼ ì•Œì•˜ìŠµë‹ˆë‹¤. 
ë‹¨ìˆœíˆ ì“°ê¸°ë§Œ í•´ì™”ë˜ ê¸°ìˆ ì˜ ì›ë¦¬ì™€ ì´ìœ ë¥¼ ì•Œê²Œë˜ë‹ˆ ë¿Œë“¯í•©ë‹ˆë‹¤. 
ì•„ì§ ì•Œì•„ì•¼ í•  ê²ƒì´ ì‚°ë”ë¯¸ì´ê³  ì§€ê¸ˆ ì´ìˆœê°„ì—ë„ ìƒˆë¡œìš´ ê¸°ìˆ ë“¤ì´ ê°œë°œëœë‹¤ë‹ˆ ë˜ë‹¤ì‹œ ì²©ì²©ì‚°ì¤‘ì´ë¼ëŠ”ê²ƒì„ ëŠë‚ë‹ˆë‹¤.</p>

<p>IPVSëŠ” ì•„ì§ ëª¨ë¥´ëŠ” ë¶€ë¶„ì´ ë§ì§€ë§Œ, ì‹¤ë¬´ì— ì ìš©í•´ë³´ê³  ì‹¶ì€ ê¸°ìˆ ì…ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ë•Œë¬¸ì— CPUê°€ ë†’ì•„ì§€ëŠ” ê²½ìš°ê°€ ë§ì€ë°, 
ì´ë¥¼ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì¸ê²ƒ ê°™ì•„ ìœ ìš©í• ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<p>ì •ë§ ë§¤ìš´ë§›ì˜ ìŠ¤í„°ë””ì´ì§€ë§Œ ë§ì€ ê²ƒì„ ë°°ìš°ê³  ìˆìŠµë‹ˆë‹¤.
ë‹¤ìŒ ì£¼ì—ëŠ” ë“œë””ì–´ ê¸°ë‹¤ë¦¬ë˜ GatewayAPIë¥¼ ìŠ¤í„°ë”” í•©ë‹ˆë‹¤. ê¸°ëŒ€ê°€ ë©ë‹ˆë‹¤. :)</p>]]></content><author><name></name></author><category term="kans" /><category term="kubernetes," /><category term="network," /><category term="linux" /><summary type="html"><![CDATA[ì´ë²ˆ ì£¼ì—ëŠ” LoadBalancer ì„œë¹„ìŠ¤ì™€ MetalLB, ê·¸ë¦¬ê³  kube-proxyì˜ ëª¨ë“œì¤‘ í•˜ë‚˜ì¸ IPVSì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[KANS 3ê¸°] K8S Service : ClusterIP, NodePort</title><link href="https://sweetlittlebird.github.io/posts/2024-09-27-KANS-Study-Week4/" rel="alternate" type="text/html" title="[KANS 3ê¸°] K8S Service : ClusterIP, NodePort" /><published>2024-09-27T01:00:18+09:00</published><updated>2024-09-27T01:00:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/KANS%20Study%20-%20Week4</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2024-09-27-KANS-Study-Week4/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì§€ë‚œì£¼ì— ì´ì–´ ì´ë²ˆì£¼ì—ëŠ” Kubernetesì˜ Service, ê·¸ ì¤‘ì— ClusterIP, NodePortì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
KANS 3ê¸° 4ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="k8s-service">K8S Service</h2>

<p>Kubernetesì˜ ServiceëŠ” ê°œë³„ Podì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ì¶”ìƒí™”ëœ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.
PodëŠ” ìƒì„±ë  ë•Œë§ˆë‹¤ IPê°€ ë™ì ìœ¼ë¡œ í• ë‹¹ë˜ê¸° ë•Œë¬¸ì— Podì˜ IPë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ì¢‹ì€ ë°©ë²•ì´ ì•„ë‹™ë‹ˆë‹¤.
ServiceëŠ” Podì˜ IPë¥¼ ì¶”ìƒí™”í•˜ì—¬ Podì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•´ì¤ë‹ˆë‹¤.</p>

<h3 id="serviceì˜-íƒ„ìƒ-ë°°ê²½">Serviceì˜ íƒ„ìƒ ë°°ê²½</h3>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_4.png" alt="img.png" /></p>

<p>ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ í•˜ë‚˜ì˜ íŒŒë“œì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë‹¤ë¥¸ íŒŒë“œ (ë˜ëŠ” ì™¸ë¶€)ì—ì„œ ì‚¬ìš©í• ë•Œ, í•´ë‹¹ íŒŒë“œì˜ IPë¡œ ì§€ì •ì„ í•˜ë©´, íŒŒë“œê°€ ì¬ì‹¤í–‰ ë  ë•Œ IPê°€ ë³€ê²½ë˜ì–´ ì ‘ì†ì´ ì•ˆ ë˜ì„œ ì¥ì• ê°€ ë°œìƒí•˜ëŠ” í˜„ìƒì´ ìƒê¹ë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_5.png" alt="img.png" /></p>

<p>ê·¸ë˜ì„œ ê³ ì •ëœ IPì˜ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ê³  ì„œë¹„ìŠ¤ì˜ IPë¡œ ì ‘ì†ì‹œ íŒŒë“œê°€ ì¬ì‹¤í–‰ë˜ì–´ë„ ì•ˆì •ì ìœ¼ë¡œ ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ í•˜ê¸°ìœ„í•´ì„œ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_6.png" alt="img.png" /></p>

<p>ì„œë¹„ìŠ¤ëŠ” ë˜í•œ ë¶€í•˜ë¶„ì‚°ì˜ ê¸°ëŠ¥ë„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ íŒŒë“œê°€ ì—¬ëŸ¬ê°œì¼ë•Œ ì„œë¹„ìŠ¤ IPë¡œ ì ‘ì†ì‹œ ê° íŒŒë“œë“¤ì— ë¶€í•˜ë¥¼ ë¶„ì‚°ì‹œí‚¬ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.</p>

<h3 id="k8s-service-ì¢…ë¥˜">K8S Service ì¢…ë¥˜</h3>

<h4 id="clusterip">ClusterIP</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_1.png" alt="img.png" class="w-80 image-center" /></p>

<ul>
  <li>ë™ì¼í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ëŠ” ì—¬ëŸ¬ Podì— ì ‘ì†ì„ ìš©ì´í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>ClusterIPëŠ” Cluster ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©° ì™¸ë¶€ì—ì„œëŠ” ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>iptables ì˜ NAT ê¸°ëŠ¥ì„ ì´ìš©í•˜ì—¬ Podì— ì ‘ê·¼í•˜ë©°, ë™ì¼í•œ iptables ë¶„ì‚°ë£°ì„ ê° ë…¸ë“œì— ì ìš©í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="nodeport">NodePort</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_2.png" alt="img.png" class="w-80 image-center" /></p>

<ul>
  <li>NodePortëŠ” ClusterIPì™€ ê°™ì´ Cluster ë‚´ë¶€ì—ì„œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©°, ì™¸ë¶€ì—ì„œë„ ì ‘ê·¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>NodePortë„ ClusterIPì™€ ê°™ì´ iptablesì˜ NAT ê¸°ëŠ¥ì„ ì´ìš©í•˜ì—¬ Podì— ì ‘ê·¼í•˜ë©°, ê° ë…¸ë“œì— NodePortë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.</li>
  <li>ì™¸ë¶€ì—ì„œëŠ” NodePortë¥¼ í†µí•´ ê° ë…¸ë“œì— ì ‘ê·¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="loadbalancer">LoadBalancer</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_3.png" alt="img.png" class="w-80 image-center" /></p>

<ul>
  <li>LoadBalancerë„ ì™¸ë¶€ì—ì„œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©°, í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì—ì„œ ì œê³µí•˜ëŠ” LoadBalancerë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (AWSì˜ ê²½ìš° ELB(Elastic Load Balancer)ê°€ ì‚¬ìš©ë©ë‹ˆë‹¤.)</li>
  <li>ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œë„ MetalLBì™€ ê°™ì€ LoadBalancerë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ì„œë¹„ìŠ¤ì˜-êµ¬ì¡°">ì„œë¹„ìŠ¤ì˜ êµ¬ì¡°</h3>

<p>ì„œë¹„ìŠ¤ë¥¼ ì„ ì–¸ì‹œ <code class="language-plaintext highlighter-rouge">port</code>ì™€ <code class="language-plaintext highlighter-rouge">targetPort</code>, ê·¸ë¦¬ê³  <code class="language-plaintext highlighter-rouge">label</code> <code class="language-plaintext highlighter-rouge">selector</code> ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ê°ê°ì˜ ì—­í• ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">port</code> : ì„œë¹„ìŠ¤ê°€ listen í•  í¬íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">targetPort</code> : ëŒ€ìƒ íŒŒë“œì˜ portë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">label selector</code>  : ëŒ€ìƒ íŒŒë“œë¥¼ íŠ¹ì •í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_7.png" alt="img.png" /></p>

<h3 id="kube-proxy-ëª¨ë“œ">kube-proxy ëª¨ë“œ</h3>

<ul>
  <li>kube-proxyëŠ” ì„œë¹„ìŠ¤ í†µì‹  ë™ì‘ì— ëŒ€í•œ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. ë°ëª¬ì…‹ìœ¼ë¡œ ë°°í¬ë˜ì–´ ëª¨ë“  ë…¸ë“œì— íŒŒë“œê°€ ìƒì„±ë©ë‹ˆë‹¤.</li>
  <li>kube-proxy ëª¨ë“œì˜ ì¢…ë¥˜ëŠ” userspace proxy ëª¨ë“œ, iptables proxy ëª¨ë“œ, ipvs proxy ëª¨ë“œ, nftables proxy ëª¨ë“œ ë“±ì´ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="userspace-proxy-ëª¨ë“œ">userspace proxy ëª¨ë“œ</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_8.png" alt="img.png" /></p>

<ul>
  <li>ê¸°ì´ˆì ì¸ ëª¨ë“œì´ë©° ì‚¬ìš©ì ì˜ì—­ì˜ kube-proxyë¥¼ í†µí•´ NIC1ìœ¼ë¡œ ë“¤ì–´ì˜¨ íŒ¨í‚·ì„ NIC2ë¡œ ì „ë‹¬í•˜ì—¬ ëª©ì  íŒŒë“œë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
  <li>ì´ë ‡ê²Œ í•˜ëŠ” ê³¼ì •ì—ì„œ ì»¤ë„ì˜ì—­(netfilter)ê³¼ ì‚¬ìš©ìì˜ì—­(kube-proxy)ë¥¼ ì˜¤ê°€ëŠ” ê³¼ì •ì—ì„œ ìŠ¤ìœ„ì¹­ì— ì˜í•œ ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí•˜ëŠ” ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="iptables-proxy-ëª¨ë“œ">iptables proxy ëª¨ë“œ</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_9.png" alt="img.png" /></p>

<ul>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜ì‹œ ê¸°ë³¸ ëª¨ë“œì´ë©°, kube-proxyëŠ”  íŠ¸ë˜í”½ ì „ë‹¬ì— ì§ì ‘ ê´€ì—¬í•˜ì§€ëŠ” ì•Šê³ , iptables ê·œì¹™ì„ ê´€ë¦¬í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.</li>
  <li>iptables proxy ëª¨ë“œëŠ” íŠ¸ë˜í”½ ì „ë‹¬ ê³¼ì •ì—ì„œ kube-proxyë¥¼ ê²½ìœ í•˜ì§€ ì•Šê³ , ì»¤ë„ ì˜ì—­ê³¼ ì‚¬ìš©ì ì˜ì—­ ì „í™˜ì´ í•„ìš”í•˜ì§€ ì•Šì•„ì„œ, ìœ ì €ìŠ¤í˜ì´ìŠ¤ proxy ëª¨ë“œì— ë¹„í•´ ì˜¤ë²„í—¤ë“œê°€ ì¤„ì–´ë“­ë‹ˆë‹¤.</li>
  <li>ë‹¨ì ìœ¼ë¡œëŠ” iptables ê·œì¹™ì´ ë§ì•„ ì§ˆ ê²½ìš° ëª¨ë“  ê·œì¹™ í‰ê°€ í•˜ëŠ”ë° ì§€ì—°ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë˜í•œ ì¥ì• ì‹œ ëª¨ë“  ê·œì¹™ì„ í™•ì¸í•˜ê¸° ì–´ë ¤ì›Œ ì¥ì•  ì²˜ë¦¬ì— ë¶ˆë¦¬í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="ipvs-proxy-ëª¨ë“œ">ipvs proxy ëª¨ë“œ</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_10.png" alt="img.png" /></p>

<ul>
  <li>ipvs proxy ëª¨ë“œëŠ” ì§€ê¸ˆê¹Œì§€ì˜ ëª¨ë“œ ì¤‘ ê°€ì¥ íš¨ìœ¨ì ì¸ ëª¨ë“œì…ë‹ˆë‹¤. IPVS(IP Virtual Server)ëŠ” ë„·í•„í„°ì—ì„œ ë™ì‘í•˜ëŠ” Layer 4 ë¡œë“œë°¸ëŸ°ì„œì…ë‹ˆë‹¤. iptables ë³´ë‹¤ ë” ë†’ì€ ì„±ëŠ¥ ì²˜ë¦¬ë¥¼ ë³´ì—¬ì£¼ê³ , ê·œì¹™ ê°¯ìˆ˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ ë‹¤ì–‘í•œ ë¶€í•˜ë¶„ì‚° ì•Œê³ ë¦¬ì¦˜ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="nftables-proxy-ëª¨ë“œ">nftables proxy ëª¨ë“œ</h4>
<ul>
  <li>nftables ëŠ” iptablesë¥¼ ëŒ€ì²´í•˜ê¸° ìœ„í•´ ê°œë°œëœ íŒ¨í‚· í•„í„°ë§ í”„ë ˆì„ì›Œí¬ë¡œ, iptables ë³´ë‹¤ ë” ìœ ì—°í•˜ê³  ê°•ë ¥í•œ ê·œì¹™ ì„¤ì •ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>í•˜ì§€ë§Œ ì•„ì§  ì‹¤í—˜ì ìœ¼ë¡œ ê°œë°œì¤‘ì¸ ë‹¨ê³„ë¡œ ì‹¤ë¬´ì—ì„œëŠ” ipvs proxy ëª¨ë“œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="ebpf-ëª¨ë“œ--xdp">eBPF ëª¨ë“œ + XDP</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_11.png" alt="img.png" class="w-90 image-center" /></p>

<ul>
  <li>ì•ì—ì„œ ì•Œì•„ë³´ì•˜ë˜ ëª¨ë“  ëª¨ë“œë“¤ì´ netfilter ê¸°ë°˜ì¸ë° ë°˜í•´, eBPF ëª¨ë“œ +  XDP ëŠ” netfilter ì „ ë‹¨ê³„ì—ì„œ íŠ¸ë˜í”½ ë¼ìš°íŒ…ì„ ì²˜ë¦¬í•˜ì—¬ í›¨ì”¬ íš¨ìœ¨ ì ì…ë‹ˆë‹¤. calicoë‚˜ ciliumì„ ì‚¬ìš©í•˜ì—¬ì„œ eBPF ëª¨ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ì‹¤ìŠµ">ì‹¤ìŠµ</h3>

<h4 id="ì‹¤ìŠµí™˜ê²½-êµ¬ì¶•">ì‹¤ìŠµí™˜ê²½ êµ¬ì¶•</h4>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì€ ì‹¤ìŠµí™˜ê²½ êµ¬ì¶•ì˜ ìš©ì´ì„±ì„ ìœ„í•´ì„œ kindë¥¼ ì´ìš©í•˜ì—¬ ì‹¤ìŠµí•˜ì˜€ìŠµë‹ˆë‹¤.</li>
  <li>ì‹¤ìŠµ í™˜ê²½ êµ¬ì¶•ì€ ë‹¤ìŒê³¼ ê°™ì´ ì§„í–‰ í•˜ì˜€ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kind í´ëŸ¬ìŠ¤í„° ì •ì˜ íŒŒì¼ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; kind-svc-w3.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
featureGates:
  "InPlacePodVerticalScaling": true
  "MultiCIDRServiceAllocator": true
nodes:
- role: control-plane
  labels:
    mynode: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
      extraArgs:
        runtime-config: api/all=true
- role: worker
  labels:
    mynode: worker1
- role: worker
  labels:
    mynode: worker2
- role: worker
  labels:
    mynode: worker3
networking:
  podSubnet: 10.10.0.0/16
  serviceSubnet: 10.200.1.0/24
</span><span class="no">EOT

</span><span class="c"># k8s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-svc-w3.yaml <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.31.0
<span class="c"># =&gt; Creating cluster "myk8s" ...</span>
<span class="c">#     âœ“ Ensuring node image (kindest/node:v1.31.0) ğŸ–¼</span>
<span class="c">#     âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦ ğŸ“¦</span>
<span class="c">#     âœ“ Writing configuration ğŸ“œ</span>
<span class="c">#     âœ“ Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#     âœ“ Installing CNI ğŸ”Œ</span>
<span class="c">#     âœ“ Installing StorageClass ğŸ’¾</span>
<span class="c">#     âœ“ Joining worker nodes ğŸšœ</span>
<span class="c">#    Set kubectl context to "kind-myk8s"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-myk8s</span>

<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                                COMMAND                  CREATED          STATUS                 PORTS                                                            NAMES</span>
<span class="c">#    1b7e6b646e48   kindest/node:v1.31.0                 "/usr/local/bin/entrâ€¦"   18 minutes ago   Up 18 minutes                                                                           myk8s-worker</span>
<span class="c">#    5406c013a571   kindest/node:v1.31.0                 "/usr/local/bin/entrâ€¦"   18 minutes ago   Up 18 minutes          0.0.0.0:30000-30002-&gt;30000-30002/tcp, 127.0.0.1:43315-&gt;6443/tcp  myk8s-control-plane</span>
<span class="c">#    4134657c5a70   kindest/node:v1.31.0                 "/usr/local/bin/entrâ€¦"   18 minutes ago   Up 18 minutes                                                                           myk8s-worker3</span>
<span class="c">#    6caf2b177502   kindest/node:v1.31.0                 "/usr/local/bin/entrâ€¦"   18 minutes ago   Up 18 minutes                                                                           myk8s-worker2</span>

<span class="c"># ë…¸ë“œì— ê¸°ë³¸ íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget bridge-utils net-tools ipset ipvsadm nfacct tcpdump ngrep iputils-ping arping git vim arp-scan -y'</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget bridge-utils net-tools ipset ipvsadm nfacct tcpdump ngrep iputils-ping arping -y'</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># k8s v1.31.0 ë²„ì „ í™•ì¸</span>
<span class="nv">$ </span>kubectl get node
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE   VERSION</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   40m   v1.31.0</span>
<span class="c">#    myk8s-worker          Ready    &lt;none&gt;          40m   v1.31.0</span>
<span class="c">#    myk8s-worker2         Ready    &lt;none&gt;          40m   v1.31.0</span>
<span class="c">#    myk8s-worker3         Ready    &lt;none&gt;          40m   v1.31.0</span>

<span class="c"># ë…¸ë“œ labels í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].metadata.labels}"</span> | <span class="nb">grep </span>mynode
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].metadata.labels}"</span> | jq | <span class="nb">grep </span>mynode
<span class="c"># =&gt;   "mynode": "control-plane",</span>
<span class="c">#      "mynode": "worker1"</span>
<span class="c">#      "mynode": "worker2"</span>
<span class="c">#      "mynode": "worker3"</span>

<span class="c"># kind network ì¤‘ ì»¨í…Œì´ë„ˆ(ë…¸ë“œ) IP(ëŒ€ì—­) í™•ì¸ : 172.18.0.2~ ë¶€í„° í• ë‹¹ë˜ë©°, control-plane ì´ ê¼­ 172.18.0.2ê°€ ì•ˆë  ìˆ˜ ë„ ìˆìŒ</span>
<span class="nv">$ </span>docker ps <span class="nt">-q</span> | xargs docker inspect <span class="nt">--format</span> <span class="s1">' '</span>
<span class="c"># =&gt; /myk8s-control-plane 172.23.0.2</span>
<span class="c">#    /myk8s-worker 172.23.0.4</span>
<span class="c">#    /myk8s-worker2 172.23.0.5</span>
<span class="c">#    /myk8s-worker3 172.23.0.3</span>
    
<span class="c"># íŒŒë“œCIDR ê³¼ Service ëŒ€ì—­ í™•ì¸ : CNIëŠ” kindnet ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system kubeadm-config <span class="nt">-oyaml</span> | <span class="nb">grep</span> <span class="nt">-i</span> subnet
<span class="c"># =&gt;       podSubnet: 10.10.0.0/16</span>
<span class="c">#          serviceSubnet: 10.200.1.0/24</span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt;                             "--service-cluster-ip-range=10.200.1.0/24",</span>
<span class="c">#                                "--cluster-cidr=10.10.0.0/16",</span>

<span class="c"># feature-gates í™•ì¸ : https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system | <span class="nb">grep </span>feature-gates
<span class="c"># =&gt;       --feature-gates=InPlacePodVerticalScaling=true,MultiCIDRServiceAllocator=true</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system | <span class="nb">grep </span>runtime-config
<span class="c"># =&gt;       --runtime-config=api/all=true</span>

<span class="c"># MultiCIDRServiceAllocator : https://kubernetes.io/docs/tasks/network/extend-service-ip-ranges/</span>
<span class="nv">$ </span>kubectl get servicecidr
<span class="c"># =&gt; NAME         CIDRS           AGE</span>
<span class="c">#    kubernetes   10.200.1.0/24   62m</span>

<span class="c"># ë…¸ë“œë§ˆë‹¤ í• ë‹¹ëœ dedicated subnet (podCIDR) í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].spec.podCIDR}"</span>
<span class="c"># =&gt; 10.10.0.0/24 10.10.4.0/24 10.10.1.0/24 10.10.2.0/24</span>

<span class="c"># kube-proxy configmap í™•ì¸</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kube-proxy
<span class="c"># =&gt; ...</span>
<span class="c">#    iptables:</span>
<span class="c">#      localhostNodePorts: null</span>
<span class="c">#      masqueradeAll: false</span>
<span class="c">#      masqueradeBit: null</span>
<span class="c">#      minSyncPeriod: 1s</span>
<span class="c">#      syncPeriod: 0s</span>
<span class="c">#    mode: iptables</span>
<span class="c">#    ...</span>

<span class="c"># kube-proxyê°€ iptables ëª¨ë“œë¡œ ë™ì‘ì¤‘ì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>

<span class="c"># ë…¸ë“œ ë³„ ë„¤íŠ¸ì›ŒíŠ¸ ì •ë³´ í™•ì¸ : CNIëŠ” kindnet ì‚¬ìš©</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> <span class="nb">ls</span> /opt/cni/bin/<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> <span class="nb">cat</span> /etc/cni/net.d/10-kindnet.conflist<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth0<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># iptables ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker3 iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># ê° ë…¸ë“œ bash ì ‘ì†</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker3 bash
<span class="nt">----------------------------------------</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------------------</span>

<span class="c"># kind ì„¤ì¹˜ ì‹œ kind ì´ë¦„ì˜ ë„ì»¤ ë¸Œë¦¬ì§€ê°€ ìƒì„±ë©ë‹ˆë‹¤. : 172.18.0.0/16 ëŒ€ì—­</span>
<span class="nv">$ </span>docker network <span class="nb">ls</span>
<span class="c"># =&gt; NETWORK ID     NAME                           DRIVER    SCOPE</span>
<span class="c">#    ...</span>
<span class="c">#    1c5d73657215   kind                           bridge    local</span>

<span class="nv">$ </span>docker inspect kind
<span class="c"># =&gt; [</span>
<span class="c">#        {</span>
<span class="c">#            "Name": "kind",</span>
<span class="c">#            ...</span>
<span class="c">#            "IPAM": {</span>
<span class="c">#                ...</span>
<span class="c">#                "Config": [</span>
<span class="c">#                    {</span>
<span class="c">#                        "Subnet": "172.23.0.0/16",</span>
<span class="c">#                        "Gateway": "172.23.0.1"</span>
<span class="c">#                    }</span>
<span class="c">#                ]</span>
<span class="c">#            },</span>
<span class="c">#            ...</span>
<span class="c">#            "Containers": {</span>
<span class="c">#                "1b7e6b646e4867591b5dd2a3bb4fcd2223dfcfd36dc08d86c8efc8fdc2112462": {</span>
<span class="c">#                    "Name": "myk8s-worker",</span>
<span class="c">#                    "IPv4Address": "172.23.0.4/16",</span>
<span class="c">#                },</span>
<span class="c">#                "4134657c5a7049d20944c2f80d3a3183a91a70107a47be72888e5c5fa972312a": {</span>
<span class="c">#                    "Name": "myk8s-worker3",</span>
<span class="c">#                    "IPv4Address": "172.23.0.3/16",</span>
<span class="c">#                },</span>
<span class="c">#                "5406c013a57167caf9a94ee9e89e550899a6efed9386f35548f03d2f670e8196": {</span>
<span class="c">#                    "Name": "myk8s-control-plane",</span>
<span class="c">#                    "IPv4Address": "172.23.0.2/16",</span>
<span class="c">#                },</span>
<span class="c">#                "6caf2b177502b92eccd4353ae3f4b3ac2da2949fc840225a02c9e83e1d24b09a": {</span>
<span class="c">#                    "Name": "myk8s-worker2",</span>
<span class="c">#                    "IPv4Address": "172.23.0.5/16",</span>
<span class="c">#                }</span>
<span class="c">#            },</span>
<span class="c">#            ...</span>
<span class="c">#        }</span>
<span class="c">#    ]</span>

<span class="c"># arp scan í•´ë‘ê¸°</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane arp-scan <span class="nt">--interfac</span><span class="o">=</span>eth0 <span class="nt">--localnet</span>
<span class="c"># =&gt; Interface: eth0, type: EN10MB, MAC: 02:42:ac:17:00:02, IPv4: 172.23.0.2</span>
<span class="c">#    Starting arp-scan 1.10.0 with 65536 hosts (https://github.com/royhills/arp-scan)</span>
<span class="c">#    172.23.0.1	02:42:a4:3f:b3:d9	(Unknown: locally administered)</span>
<span class="c">#    172.23.0.3	02:42:ac:17:00:03	(Unknown: locally administered)</span>
<span class="c">#    172.23.0.4	02:42:ac:17:00:04	(Unknown: locally administered)</span>
<span class="c">#    172.23.0.5	02:42:ac:17:00:05	(Unknown: locally administered)</span>

<span class="c"># mypc ì»¨í…Œì´ë„ˆ ê¸°ë™ : kind ë„ì»¤ ë¸Œë¦¬ì§€ë¥¼ ì‚¬ìš©í•˜ê³ , ì»¨í…Œì´ë„ˆ IPë¥¼ ì§ì ‘ ì§€ì •</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">--rm</span> <span class="nt">--name</span> mypc <span class="nt">--network</span> kind <span class="nt">--ip</span> 172.23.0.100 nicolaka/netshoot <span class="nb">sleep </span>infinity
<span class="nv">$ </span>docker ps
<span class="c">## ë§Œì•½ kind ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì´ ë‹¤ë¥¼ ê²½ìš° ìœ„ IP ì§€ì •ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë‹ˆ, ê·¸ëƒ¥ IP ì§€ì • ì—†ì´ mypc ì»¨í…Œì´ë„ˆ ê¸°ë™ í•  ê²ƒ</span>
<span class="c">## docker run -d --rm --name mypc --network kind nicolaka/netshoot sleep infinity</span>

<span class="c"># í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ping <span class="nt">-c</span> 1 172.23.0.1
<span class="c"># =&gt; PING 172.23.0.1 (172.23.0.1) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.23.0.1: icmp_seq=1 ttl=64 time=0.154 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.23.0.1 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.154/0.154/0.154/0.000 ms</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..5<span class="o">}</span> <span class="p">;</span> <span class="k">do </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ping <span class="nt">-c</span> 1 172.23.0.<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh
<span class="nt">-------------</span>
<span class="nv">$ </span>ifconfig
<span class="c"># =&gt; eth0      Link encap:Ethernet  HWaddr 02:42:AC:17:00:06  </span>
<span class="c">#              inet addr:172.23.0.6  Bcast:172.23.255.255  Mask:255.255.0.0</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 172.23.0.2
<span class="c"># =&gt; PING 172.23.0.2 (172.23.0.2) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.23.0.2: icmp_seq=1 ttl=64 time=0.258 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.23.0.2 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.258/0.258/0.258/0.000 ms</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">-------------</span>

<span class="c"># kube-ops-view ì„¤ì¹˜</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="c"># =&gt; "geek-cookbook" has been added to your repositories</span>
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>NodePort,service.main.ports.http.nodePort<span class="o">=</span>30000 <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system
<span class="c"># =&gt; NAME: kube-ops-view</span>
<span class="c">#    ...</span>
<span class="c">#    1. Get the application URL by running these commands:</span>
<span class="c">#      export NODE_PORT=$(kubectl get --namespace kube-system -o jsonpath="{.spec.ports[0].nodePort}" services kube-ops-view)</span>
<span class="c">#      export NODE_IP=$(kubectl get nodes --namespace kube-system -o jsonpath="{.items[0].status.addresses[0].address}")</span>
<span class="c">#      echo http://$NODE_IP:$NODE_PORT</span>

<span class="c"># myk8s-control-plane ë°°ì¹˜</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system edit deploy kube-ops-view
<span class="nt">---</span>
spec:
  ...
  template:
    ...
    spec:
      nodeSelector:
        mynode: control-plane
      tolerations:
      - key: <span class="s2">"node-role.kubernetes.io/control-plane"</span>
        operator: <span class="s2">"Equal"</span>
        effect: <span class="s2">"NoSchedule"</span>
<span class="nt">---</span>

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get pod <span class="nt">-o</span> wide <span class="nt">-l</span> app.kubernetes.io/instance<span class="o">=</span>kube-ops-view
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE   IP          NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-ops-view-58f96c464d-t5t68   1/1     Running   0          30s   10.10.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 , 2 ë°°ìœ¨) : macOS ì‚¬ìš©ì</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:30000/#scale=1.5"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:30000/#scale=2"</span>

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 , 2 ë°°ìœ¨) : Windows ì‚¬ìš©ì</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://192.168.50.10:30000/#scale=1.5"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://192.168.50.10:30000/#scale=2"</span>

</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_12.png" alt="img.png" /></p>

<h4 id="clusterip-ì‹¤ìŠµ">ClusterIP ì‹¤ìŠµ</h4>

<ul>
  <li>ì•ì—ì„œ ì•Œì•„ë³¸ ClusterIP íƒ€ì…ì— ëŒ€í•´ ì‹¤ìŠµí•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ë‹¤ìŒì˜ ì‚¬í•­ë“¤ì„ ì‚´í´ë³¼ ê²ƒì…ë‹ˆë‹¤.
    <ul>
      <li>ClusterIPì˜ ì„œë¹„ìŠ¤ì˜ ê²½ìš° í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•œ íŠ¹ì„±ì´ ìˆìŠµë‹ˆë‹¤.</li>
      <li>IPë¡œë„ ì ‘ì†í•  ìˆ˜ ìˆì§€ë§Œ ë„ë©”ì¸ ëª…ìœ¼ë¡œë„ ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li>ì„œë¹„ìŠ¤ íƒ€ì…(ClusterIP)ì„ ìƒì„±í•˜ë©´ apiserver â‡’ (kubelet) â‡’ kube-proxy â‡’ iptables ì— rule ì´ ìƒì„± ë©ë‹ˆë‹¤.</li>
      <li>ëª¨ë“  ë…¸ë“œ(ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ í¬í•¨) ì— iptables ruleì´ ì„¤ì • ë˜ë¯€ë¡œ, íŒŒë“œì—ì„œ ì ‘ì† ì‹œ í•´ë‹¹ ë…¸ë“œì— ì¡´ì¬í•˜ëŠ” iptables rule ì— ì˜í•´ ë¶„ì‚° ì ‘ì†ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì‹¤ìŠµ êµ¬ì„±
    <ul>
      <li>
        <p>ëª©ì ì§€(backend) íŒŒë“œ (pod) ìƒì„± : 3pod.yml</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># 3pod.yml</span>
  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">webpod1</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">webpod</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">nodeName</span><span class="pi">:</span> <span class="s">myk8s-worker</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">container</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">traefik/whoami</span>
    <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
  <span class="s">---</span>
  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">webpod2</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">webpod</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">nodeName</span><span class="pi">:</span> <span class="s">myk8s-worker2</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">container</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">traefik/whoami</span>
    <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
  <span class="s">---</span>
  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">webpod3</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">webpod</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">nodeName</span><span class="pi">:</span> <span class="s">myk8s-worker3</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">container</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">traefik/whoami</span>
    <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>í´ë¼ì´ì–¸íŠ¸ ìƒì„± : netpod.yml</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># netpod.yml</span>
  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">net-pod</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">nodeName</span><span class="pi">:</span> <span class="s">myk8s-control-plane</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">netshoot-pod</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">nicolaka/netshoot</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">tail"</span><span class="pi">]</span>
      <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">-f"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/dev/null"</span><span class="pi">]</span>
    <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì„œë¹„ìŠ¤(ClusterIP) ìƒì„± : svc-clusterip.yml</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># svc-clusterip.yml</span>
  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">svc-clusterip</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">svc-webport</span>
        <span class="na">port</span><span class="pi">:</span> <span class="m">9000</span>        <span class="c1"># ì„œë¹„ìŠ¤ IP ì— ì ‘ì† ì‹œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ port ë¥¼ ì˜ë¯¸</span>
        <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>    <span class="c1"># íƒ€í‚· targetPort ëŠ” ì„œë¹„ìŠ¤ë¥¼ í†µí•´ì„œ ëª©ì ì§€ íŒŒë“œë¡œ ì ‘ì† ì‹œ í•´ë‹¹ íŒŒë“œë¡œ ì ‘ì†í•˜ëŠ” í¬íŠ¸ë¥¼ ì˜ë¯¸</span>
    <span class="na">selector</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">webpod</span>         <span class="c1"># ì…€ë ‰í„° ì•„ë˜ app:webpod ë ˆì´ë¸”ì´ ì„¤ì •ë˜ì–´ ìˆëŠ” íŒŒë“œë“¤ì€ í•´ë‹¹ ì„œë¹„ìŠ¤ì— ì—°ë™ë¨</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>       <span class="c1"># ì„œë¹„ìŠ¤ íƒ€ì…</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ìƒì„± ë° í™•ì¸</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># ëª¨ë‹ˆí„°ë§</span>
  <span class="nv">$ </span><span class="k">**</span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pod -owide ;echo; kubectl get svc,ep svc-clusterip'</span><span class="k">**</span>
      
  <span class="c"># ìƒì„±</span>
  <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> 3pod.yml,netpod.yml,svc-clusterip.yml
  <span class="c"># =&gt; pod/webpod1 created</span>
  <span class="c">#    pod/webpod2 created</span>
  <span class="c">#    pod/webpod3 created</span>
  <span class="c">#    pod/net-pod created</span>
  <span class="c">#    service/svc-clusterip created</span>
      
  <span class="c"># íŒŒë“œì™€ ì„œë¹„ìŠ¤ ì‚¬ìš© ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ì •ë³´ í™•ì¸ </span>
  <span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
  <span class="c"># =&gt; "--service-cluster-ip-range=10.200.1.0/24",</span>
  <span class="c">#    "--cluster-cidr=10.10.0.0/16",</span>
      
  <span class="c"># í™•ì¸</span>
  <span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
  <span class="c"># =&gt; NAME      READY   STATUS    RESTARTS   AGE    IP          NODE                  NOMINATED NODE   READINESS GATES</span>
  <span class="c">#    net-pod   1/1     Running   0          2m8s   10.10.0.7   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    webpod1   1/1     Running   0          2m8s   10.10.4.3   myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    webpod2   1/1     Running   0          2m8s   10.10.1.4   myk8s-worker2         &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    webpod3   1/1     Running   0          2m8s   10.10.2.3   myk8s-worker3         &lt;none&gt;           &lt;none&gt;</span>
  <span class="nv">$ </span>kubectl get svc svc-clusterip
  <span class="c"># =&gt; NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE</span>
  <span class="c">#    svc-clusterip   ClusterIP   10.200.1.96   &lt;none&gt;        9000/TCP   2m15s</span>
      
  <span class="c"># spec.ports.port ì™€ spec.ports.targetPort ê°€ ì–´ë–¤ ì˜ë¯¸ì¸ì§€ ê¼­ ì´í•´í•˜ì!</span>
  <span class="nv">$ </span>kubectl describe svc svc-clusterip
  <span class="c"># =&gt; Name:              svc-clusterip</span>
  <span class="c">#    Namespace:         default</span>
  <span class="c">#    Labels:            &lt;none&gt;</span>
  <span class="c">#    Annotations:       &lt;none&gt;</span>
  <span class="c">#    Selector:          app=webpod</span>
  <span class="c">#    Type:              ClusterIP</span>
  <span class="c">#    IP Family Policy:  SingleStack</span>
  <span class="c">#    IP Families:       IPv4</span>
  <span class="c">#    IP:                10.200.1.96</span>
  <span class="c">#    IPs:               10.200.1.96</span>
  <span class="c">#    Port:              svc-webport  9000/TCP                    # serviceì˜ listening port</span>
  <span class="c">#    TargetPort:        80/TCP                                   # podì˜ ì‹¤ì œ port</span>
  <span class="c">#    Endpoints:         10.10.1.4:80,10.10.2.3:80,10.10.4.3:80   # podì˜ ip:port ëª©ë¡</span>
  <span class="c">#    Session Affinity:  None</span>
  <span class="c">#    Events:            &lt;none&gt;</span>
      
  <span class="c"># ì„œë¹„ìŠ¤ ìƒì„± ì‹œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±, ë¬¼ë¡  ìˆ˜ë™ìœ¼ë¡œ ì„¤ì • ìƒì„±ë„ ê°€ëŠ¥</span>
  <span class="nv">$ </span>kubectl get endpoints svc-clusterip
  <span class="c"># =&gt; NAME            ENDPOINTS                                AGE</span>
  <span class="c">#    svc-clusterip   10.10.1.4:80,10.10.2.3:80,10.10.4.3:80   3m32s</span>
  <span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> kubernetes.io/service-name<span class="o">=</span>svc-clusterip
  <span class="c"># =&gt; NAME                  ADDRESSTYPE   PORTS   ENDPOINTS                       AGE</span>
  <span class="c">#    svc-clusterip-xxvws   IPv4          80      10.10.4.3,10.10.1.4,10.10.2.3   3m39s</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_13.png" alt="img.png" /></p>

<ul>
  <li>ì„œë¹„ìŠ¤ (ClusterIP) ì ‘ì† í™•ì¸
    <ul>
      <li>
        <p>í´ë¼ì´ì–¸íŠ¸ (TestPod)ì˜ Shell ì— ì ‘ì†í•˜ì—¬ ì„œë¹„ìŠ¤(ClusterIP) ë¶€í•˜ë¶„ì‚° ì ‘ì† í™•ì¸</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># webpod íŒŒë“œì˜ IP ë¥¼ ì¶œë ¥</span>
  <span class="nv">$ </span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].status.podIP}"</span>
  <span class="c"># =&gt; 10.10.4.3 10.10.1.4 10.10.2.3</span>
      
  <span class="c"># webpod íŒŒë“œì˜ IPë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
  <span class="nv">$ WEBPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get pod webpod1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.podIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ WEBPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get pod webpod2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.podIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ WEBPOD3</span><span class="o">=</span><span class="si">$(</span>kubectl get pod webpod3 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.podIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD1</span> <span class="nv">$WEBPOD2</span> <span class="nv">$WEBPOD3</span>
  <span class="c"># =&gt; 10.10.4.3 10.10.1.4 10.10.2.3</span>
      
  <span class="c"># net-pod íŒŒë“œì—ì„œ webpod íŒŒë“œì˜ IPë¡œ ì§ì ‘ curl ë¡œ ë°˜ë³µ ì ‘ì†</span>
  <span class="nv">$ </span><span class="k">for </span>pod <span class="k">in</span> <span class="nv">$WEBPOD1</span> <span class="nv">$WEBPOD2</span> <span class="nv">$WEBPOD3</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$pod</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; Hostname: webpod1</span>
  <span class="c">#    IP: 10.10.4.3</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:56374</span>
  <span class="c">#    GET / HTTP/1.1</span>
  <span class="c">#    Host: 10.10.4.3</span>
  <span class="c">#    User-Agent: curl/8.7.1</span>
  <span class="c">#    Accept: */*</span>
  <span class="c">#    </span>
  <span class="c">#    Hostname: webpod2</span>
  <span class="c">#    ...</span>
  <span class="c">#    Hostname: webpod3</span>
  <span class="c">#    ...</span>
  <span class="nv">$ </span><span class="k">for </span>pod <span class="k">in</span> <span class="nv">$WEBPOD1</span> <span class="nv">$WEBPOD2</span> <span class="nv">$WEBPOD3</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$pod</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; Hostname: webpod1</span>
  <span class="c">#    Hostname: webpod2</span>
  <span class="c">#    Hostname: webpod3</span>
  <span class="nv">$ </span><span class="k">for </span>pod <span class="k">in</span> <span class="nv">$WEBPOD1</span> <span class="nv">$WEBPOD2</span> <span class="nv">$WEBPOD3</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$pod</span> | <span class="nb">grep </span>Host<span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; Hostname: webpod1</span>
  <span class="c">#    Host: 10.10.4.3</span>
  <span class="c">#    Hostname: webpod2</span>
  <span class="c">#    Host: 10.10.1.4</span>
  <span class="c">#    Hostname: webpod3</span>
  <span class="c">#    Host: 10.10.2.3</span>
  <span class="nv">$ </span><span class="k">for </span>pod <span class="k">in</span> <span class="nv">$WEBPOD1</span> <span class="nv">$WEBPOD2</span> <span class="nv">$WEBPOD3</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$pod</span> | egrep <span class="s1">'Host|RemoteAddr'</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; Hostname: webpod1</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:36382</span>
  <span class="c">#    Host: 10.10.4.3</span>
  <span class="c">#    Hostname: webpod2</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:52122</span>
  <span class="c">#    Host: 10.10.1.4</span>
  <span class="c">#    Hostname: webpod3</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:55962</span>
  <span class="c">#    Host: 10.10.2.3</span>
      
  <span class="c"># ì„œë¹„ìŠ¤ IP ë³€ìˆ˜ ì§€ì • : svc-clusterip ì˜ ClusterIPì£¼ì†Œ</span>
  <span class="nv">$ SVC1</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$SVC1</span>
  <span class="c"># =&gt; 10.200.1.96</span>
      
  <span class="c"># ìœ„ ì„œë¹„ìŠ¤ ìƒì„± ì‹œ kube-proxy ì— ì˜í•´ì„œ iptables ê·œì¹™ì´ ëª¨ë“  ë…¸ë“œì— ì¶”ê°€ë¨ </span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nv">$SVC1</span>
  <span class="c"># =&gt; -A KUBE-SERVICES -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF</span>
  <span class="c">#    -A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ</span>
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nv">$SVC1</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
  <span class="c">#    -A KUBE-SERVICES -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF</span>
  <span class="c">#    -A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
  <span class="c">#    -A KUBE-SERVICES -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF</span>
  <span class="c">#    -A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
  <span class="c">#    -A KUBE-SERVICES -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF</span>
  <span class="c">#    -A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
  <span class="c">#    -A KUBE-SERVICES -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF</span>
  <span class="c">#    -A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ</span>
      
  <span class="c">## (ì°¸ê³ ) ss íˆ´ë¡œ tcp listen ì •ë³´ì—ëŠ” ì—†ìŒ , ë³„ë„ /32 host ë¼ìš°íŒ… ì¶”ê°€ ì—†ìŒ -&gt; ì¦‰, iptables rule ì— ì˜í•´ì„œ ì²˜ë¦¬ë¨ì„ í™•ì¸</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ss <span class="nt">-tnlp</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ip <span class="nt">-c</span> route
      
  <span class="c"># TCP 80,9000 í¬íŠ¸ë³„ ì ‘ì† í™•ì¸ : ì¶œë ¥ ì •ë³´ ì˜ë¯¸ í™•ì¸</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$SVC1</span>:80
  <span class="c"># =&gt; (ê³µë°±)</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$SVC1</span>:9000
  <span class="c"># =&gt; Hostname: webpod2</span>
  <span class="c">#    ...</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$SVC1</span>:9000 | <span class="nb">grep </span>Hostname
  <span class="c"># =&gt; Hostname: webpod3</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$SVC1</span>:9000 | <span class="nb">grep </span>Hostname
  <span class="c"># =&gt; Hostname: webpod1 </span>
      
  <span class="c"># curlë¡œ ì ‘ì†í–ˆì„ë•Œ ì»¨í…Œì´ë„ˆì˜ í¬íŠ¸ì¸ targetPort 80ìœ¼ë¡œëŠ” ì ‘ì†ì´ ì•ˆ ë˜ê³  port 9000ë¡œëŠ” ì ‘ì†ì´ ë©ë‹ˆë‹¤.</span>
  <span class="c"># ë˜í•œ ì ‘ì†ì‹œë§ˆë‹¤ ê° podì— ë¶€í•˜ê°€ ë¶„ì‚°ë˜ì–´ HostName: ì´ ë³€ê²½ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
      
  <span class="c"># ì„œë¹„ìŠ¤(ClusterIP) ë¶€í•˜ë¶„ì‚° ì ‘ì† í™•ì¸</span>
  <span class="c">## for ë¬¸ì„ ì´ìš©í•˜ì—¬ SVC1 IP ë¡œ 100ë²ˆ ì ‘ì†ì„ ì‹œë„ í›„ ì¶œë ¥ë˜ëŠ” ë‚´ìš© ì¤‘ ë°˜ë³µë˜ëŠ” ë‚´ìš©ì˜ ê°¯ìˆ˜ ì¶œë ¥</span>
  <span class="c">## ë°˜ë³µí•´ì„œ ì‹¤í–‰ì„ í•´ë³´ë©´, SVC1 IPë¡œ curl ì ‘ì† ì‹œ 3ê°œì˜ íŒŒë“œë¡œ ëŒ€ëµ 33% ì •ë„ë¡œ ë¶€í•˜ë¶„ì‚° ì ‘ì†ë¨ì„ í™•ì¸</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..10};   do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;       4 Hostname: webpod3</span>
  <span class="c">#          4 Hostname: webpod2</span>
  <span class="c">#          2 Hostname: webpod1</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};  do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;      38 Hostname: webpod3</span>
  <span class="c">#         35 Hostname: webpod1</span>
  <span class="c">#         27 Hostname: webpod2</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..1000}; do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     346 Hostname: webpod2</span>
  <span class="c">#        336 Hostname: webpod1</span>
  <span class="c">#        318 Hostname: webpod3</span>
  <span class="c"># í˜¹ì€</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};   do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; sleep 1; done"</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};   do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; sleep 0.1; done"</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..10000}; do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; sleep 0.01; done"</span>
      
  <span class="c"># conntrack í™•ì¸</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
  <span class="nt">----------------------------------------</span>
  <span class="nv">$ </span>conntrack <span class="nt">-h</span>
  <span class="nv">$ </span>conntrack <span class="nt">-E</span>
  <span class="c"># =&gt;     [NEW] tcp      6 120 SYN_SENT src=172.23.0.2 dst=172.23.0.2 sport=45466 dport=6443 [UNREPLIED] src=172.23.0.2 dst=172.23.0.2 sport=6443 dport=45466</span>
  <span class="c">#     [UPDATE] tcp      6 60 SYN_RECV src=172.23.0.2 dst=172.23.0.2 sport=45466 dport=6443 src=172.23.0.2 dst=172.23.0.2 sport=6443 dport=45466</span>
  <span class="nv">$ </span>conntrack <span class="nt">-C</span>
  <span class="c"># =&gt; 2763</span>
  <span class="nv">$ </span>conntrack <span class="nt">-S</span>
  <span class="c"># =&gt; cpu=0           found=0 invalid=0 insert=0 insert_failed=0 drop=0 early_drop=0 error=0 search_restart=3 clash_resolve=0 chaintoolong=0</span>
  <span class="c">#    cpu=1           found=0 invalid=0 insert=0 insert_failed=0 drop=0 early_drop=0 error=0 search_restart=0 clash_resolve=0 chaintoolong=0</span>
  <span class="nv">$ </span>conntrack <span class="nt">-L</span> <span class="nt">--src</span> 10.200.0.7 <span class="c"># net-pod IP</span>
  <span class="c"># =&gt; tcp      6 93 TIME_WAIT src=10.10.0.7 dst=10.200.1.96 sport=37008 dport=9000 src=10.10.2.3 dst=10.10.0.7 sport=80 dport=37008 [ASSURED] mark=0 use=1</span>
  <span class="c">#    tcp      6 93 TIME_WAIT src=10.10.0.7 dst=10.200.1.96 sport=36584 dport=9000 src=10.10.2.3 dst=10.10.0.7 sport=80 dport=36584 [ASSURED] mark=0 use=1</span>
  <span class="nv">$ SVC1</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ </span>conntrack <span class="nt">-L</span> <span class="nt">--dst</span> <span class="nv">$SVC1</span>     <span class="c"># service ClusterIP</span>
  <span class="c"># =&gt; tcp      6 31 TIME_WAIT src=10.10.0.7 dst=10.200.1.96 sport=37008 dport=9000 src=10.10.2.3 dst=10.10.0.7 sport=80 dport=37008 [ASSURED] mark=0 use=1</span>
  <span class="c">#    tcp      6 31 TIME_WAIT src=10.10.0.7 dst=10.200.1.96 sport=36584 dport=9000 src=10.10.2.3 dst=10.10.0.7 sport=80 dport=36584 [ASSURED] mark=0 use=1</span>
  <span class="nv">$ </span><span class="nb">exit</span>
  <span class="nt">----------------------------------------</span>
      
  <span class="c"># (ì°¸ê³ ) Link layer ì—ì„œ ë™ì‘í•˜ëŠ” ebtables</span>
  <span class="nv">$ </span>ebtables <span class="nt">-L</span>
  <span class="c"># =&gt; Bridge table: filter</span>
  <span class="c">#    Bridge chain: INPUT, entries: 0, policy: ACCEPT</span>
  <span class="c">#    Bridge chain: FORWARD, entries: 0, policy: ACCEPT</span>
  <span class="c">#    Bridge chain: OUTPUT, entries: 0, policy: ACCEPT</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ê° ì›Œì»¤ ë…¸ë“œì—ì„œ íŒ¨í‚·  ë¤í”„ í™•ì¸</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># ë°©ì•ˆ1 : 1ëŒ€ í˜¹ì€ 3ëŒ€ bash ì§„ì… í›„ tcpdump í•´ë‘˜ ê²ƒ</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker3 bash
  <span class="nt">----------------------------------</span>
  <span class="c"># nic ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span>
  <span class="c"># =&gt; &lt;&lt;myk8s-worker&gt;&gt;</span>
  <span class="c">#    3: veth9a888981@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether 26:a5:d2:44:f4:b4 brd ff:ff:ff:ff:ff:ff link-netns cni-0b7e59c3-3920-ce1f-874a-9e228adf3b72</span>
  <span class="c">#    134: eth0@if135: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:04 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
  <span class="c">#    </span>
  <span class="c">#    &lt;&lt;myk8s-worker2&gt;&gt;</span>
  <span class="c">#    4: veth570fce87@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether a6:8a:d8:a3:f4:ac brd ff:ff:ff:ff:ff:ff link-netns cni-8dcb2d16-f339-2571-03d2-d6b0f850878d</span>
  <span class="c">#    136: eth0@if137: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:05 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
  <span class="c">#    </span>
  <span class="c">#    &lt;&lt;myk8s-worker3&gt;&gt;</span>
  <span class="c">#    3: veth2e19df47@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether da:5e:a5:14:62:7b brd ff:ff:ff:ff:ff:ff link-netns cni-1f44bebd-9ebf-6af4-7888-945649a2b5c8</span>
  <span class="c">#    132: eth0@if133: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
      
  <span class="nv">$ </span>ip <span class="nt">-c</span> route
  <span class="c"># =&gt; &lt;&lt;myk8s-worker&gt;&gt;</span>
  <span class="c">#    default via 172.23.0.1 dev eth0</span>
  <span class="c">#    10.10.0.0/24 via 172.23.0.2 dev eth0</span>
  <span class="c">#    10.10.1.0/24 via 172.23.0.5 dev eth0</span>
  <span class="c">#    10.10.2.0/24 via 172.23.0.3 dev eth0</span>
  <span class="c">#    10.10.4.3 dev veth9a888981 scope host</span>
  <span class="c">#    172.23.0.0/16 dev eth0 proto kernel scope link src 172.23.0.4</span>
  <span class="c">#</span>
  <span class="c">#    &lt;&lt;myk8s-worker2&gt;&gt;</span>
  <span class="c">#    default via 172.23.0.1 dev eth0</span>
  <span class="c">#    10.10.0.0/24 via 172.23.0.2 dev eth0</span>
  <span class="c">#    10.10.1.4 dev veth570fce87 scope host</span>
  <span class="c">#    10.10.2.0/24 via 172.23.0.3 dev eth0</span>
  <span class="c">#    10.10.4.0/24 via 172.23.0.4 dev eth0</span>
  <span class="c">#    172.23.0.0/16 dev eth0 proto kernel scope link src 172.23.0.5</span>
  <span class="c">#    </span>
  <span class="c">#    &lt;&lt;myk8s-worker3&gt;&gt;</span>
  <span class="c">#    default via 172.23.0.1 dev eth0</span>
  <span class="c">#    10.10.0.0/24 via 172.23.0.2 dev eth0</span>
  <span class="c">#    10.10.1.0/24 via 172.23.0.5 dev eth0</span>
  <span class="c">#    10.10.2.3 dev veth2e19df47 scope host</span>
  <span class="c">#    10.10.4.0/24 via 172.23.0.4 dev eth0</span>
  <span class="c">#    172.23.0.0/16 dev eth0 proto kernel scope link src 172.23.0.3</span>
      
  <span class="nv">$ </span>ip <span class="nt">-c</span> addr
  <span class="c"># =&gt; &lt;&lt;myk8s-worker&gt;&gt;</span>
  <span class="c">#    3: veth9a888981@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether 26:a5:d2:44:f4:b4 brd ff:ff:ff:ff:ff:ff link-netns cni-0b7e59c3-3920-ce1f-874a-9e228adf3b72</span>
  <span class="c">#        inet 10.10.4.1/32 scope global veth9a888981</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
  <span class="c">#    134: eth0@if135: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:04 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
  <span class="c">#        inet 172.23.0.4/16 brd 172.23.255.255 scope global eth0</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
  <span class="c">#    </span>
  <span class="c">#    &lt;&lt;myk8s-worker2&gt;&gt;</span>
  <span class="c">#    4: veth570fce87@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether a6:8a:d8:a3:f4:ac brd ff:ff:ff:ff:ff:ff link-netns cni-8dcb2d16-f339-2571-03d2-d6b0f850878d</span>
  <span class="c">#        inet 10.10.1.1/32 scope global veth570fce87</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
  <span class="c">#    136: eth0@if137: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:05 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
  <span class="c">#        inet 172.23.0.5/16 brd 172.23.255.255 scope global eth0</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
  <span class="c">#    </span>
  <span class="c">#    &lt;&lt;myk8s-worker3&gt;&gt;</span>
  <span class="c">#    3: veth2e19df47@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether da:5e:a5:14:62:7b brd ff:ff:ff:ff:ff:ff link-netns cni-1f44bebd-9ebf-6af4-7888-945649a2b5c8</span>
  <span class="c">#        inet 10.10.2.1/32 scope global veth2e19df47</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
  <span class="c">#    132: eth0@if133: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
  <span class="c">#        inet 172.23.0.3/16 brd 172.23.255.255 scope global eth0</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
      
  <span class="c"># tcpdump/ngrep : eth0 &gt;&gt; tcp 9000 í¬íŠ¸ íŠ¸ë˜í”½ì€ ì™œ ì—†ì„ê¹Œ? iptables rule ë™ì‘ ê·¸ë¦¼ì„ í•œë²ˆ ë” í™•ì¸í•˜ê³  ì´í•´í•´ë³´ì</span>
  <span class="c">## ngrep ë„¤íŠ¸ì›Œí¬ íŒ¨í‚· ë¶„ì„ê¸° í™œìš©í•´ë³´ê¸° : íŠ¹ì • url í˜¸ì¶œì— ëŒ€í•´ì„œë§Œ í•„í„° ë“± ê¹”ë”í•˜ê²Œ ë³¼ ìˆ˜ ìˆìŒ - ë§í¬</span>
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 tcp port 80 <span class="nt">-nnq</span>
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 tcp port 80 <span class="nt">-w</span> /root/svc1-1.pcap
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 tcp port 9000 <span class="nt">-nnq</span>
  <span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> eth0 <span class="s1">''</span> <span class="s1">'tcp port 80'</span>
      
  <span class="c"># tcpdump/ngrep : vethX</span>
  <span class="c"># $ VETH1=&lt;ê°ì ìì‹ ì˜ veth ì´ë¦„&gt;</span>
  <span class="nv">$ VETH1</span><span class="o">=</span>veth9a888981
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> <span class="nv">$VETH1</span> tcp port 80 <span class="nt">-nn</span>
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> <span class="nv">$VETH1</span> tcp port 80 <span class="nt">-w</span> /root/svc1-2.pcap
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> <span class="nv">$VETH1</span> tcp port 9000 <span class="nt">-nn</span>
  <span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> <span class="nv">$VETH1</span> <span class="s1">''</span> <span class="s1">'tcp port 80'</span>
      
  <span class="nv">$ </span><span class="nb">exit</span>
  <span class="nt">----------------------------------</span>
      
  <span class="c"># ë°©ì•ˆ2 : kind ë…¸ë“œ ì»¨í…Œì´ë„ˆ bash ì§ì ‘ ì ‘ì†í•˜ì§€ ì•Šê³  í˜¸ìŠ¤íŠ¸ì—ì„œ tcpdump í•˜ê¸°</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker tcpdump <span class="nt">-i</span> eth0 tcp port 80 <span class="nt">-nnq</span>
  <span class="nv">$ VETH1</span><span class="o">=</span>&lt;ê°ì ìì‹ ì˜ veth ì´ë¦„&gt; docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker ip <span class="nt">-c</span> route
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker tcpdump <span class="nt">-i</span> <span class="nv">$VETH1</span> tcp port 80 <span class="nt">-nnq</span>
      
  <span class="c"># í˜¸ìŠ¤íŠ¸PCì— pcap íŒŒì¼ ë³µì‚¬ &gt;&gt; wireshark ì—ì„œ ë¶„ì„</span>
  <span class="nv">$ </span>docker <span class="nb">cp </span>myk8s-worker:/root/svc1-1.pcap <span class="nb">.</span>
  <span class="nv">$ </span>docker <span class="nb">cp </span>myk8s-worker:/root/svc1-2.pcap <span class="nb">.</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>net-pod í¬ë“œì— ì ‘ì† í›„ 10ê°œ curl ìš”ì²­</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh
<span class="nt">----------------------------------</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span>   <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$SVC1</span>:9000 | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;       4 Hostname: webpod3</span>
<span class="c">#          3 Hostname: webpod2</span>
<span class="c">#          3 Hostname: webpod1</span>
    
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------------</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ê°ê° net-podì™€ ì›Œì»¤ ë…¸ë“œë“¤ì˜ íŒ¨í‚·ìº¡ì³íŒŒì¼(*.pcap)ë¥¼ ë°›ì•„ì„œ ì™€ì´ì–´ìƒ¤í¬ë¡œ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>
        <ul>
          <li>
            <p>net-pod(10.10.0.7)ì—ì„œ ì„œë¹„ìŠ¤:9000 (IP:10.200.1.96)ìœ¼ë¡œ ìš”ì²­ëœ íŒ¨í‚·ì´ DNAT ë˜ì–´ k8s-workerì˜ webpod1:80 (IP:10.10.4.3)ìœ¼ë¡œ ì „ë‹¬ë˜ê³ , ì‘ë‹µì€ ê·¸ ë°˜ëŒ€ë¡œ ì „ë‹¬ ë˜ëŠ” ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_14.png" alt="img.png" /></p>
          </li>
          <li>
            <p>ë˜í•œ Stastics ë©”ë‰´ì˜â†’ Flow Graph ê¸°ëŠ¥ì„ í†µí•´ íŒ¨í‚·ì˜ íë¦„ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

            <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_15.png" alt="img.png" /></p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>iptables ì •ì±… í™•ì¸
    <ul>
      <li>kubernetesì—ì„œ serviceëŠ” ë‹¤ìŒì˜ iptables ê³¼ì •ì„ ê±°ì¹©ë‹ˆë‹¤.
        <ul>
          <li>(1) PREROUTING â‡’ (2) KUBE-SERVICES â‡’ (3) KUBE-SVC-YYY â‡’ (4) KUBE-SEP-#íŒŒë“œ1, KUBE-SEP-#íŒŒë“œ2, KUBE-SEP-#íŒŒë“œ3</li>
          <li>ê·¸ë¦¼ìœ¼ë¡œ ë‚˜íƒ€ë‚´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</li>
        </ul>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_16.png" alt="img.png" /></p>

        <ul>
          <li>
            <p>ê°ê°ì— ëŒ€í•˜ì—¬ iptables ë£°ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ í™•ì¸í•˜ê² ìŠµë‹ˆë‹¤.</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
  <span class="nt">----------------------------------------</span>
        
  <span class="c"># iptables í™•ì¸</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">wc</span> <span class="nt">-l</span>
  <span class="c"># =&gt; 97</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
        
  <span class="c"># iptables ìƒì„¸ í™•ì¸ - ë§¤ì¹­ íŒ¨í‚· ì¹´ìš´íŠ¸, ì¸í„°í˜ì´ìŠ¤ ì •ë³´ ë“± í¬í•¨</span>
  <span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> filter
  <span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> nat
  <span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> mangle
        
  <span class="c"># rule ê°¯ìˆ˜ í™•ì¸</span>
  <span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> filter | <span class="nb">wc</span> <span class="nt">-l</span>
  <span class="c"># =&gt; 47</span>
  <span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> nat | <span class="nb">wc</span> <span class="nt">-l</span>
  <span class="c"># =&gt; 158</span>
        
  <span class="c"># ê·œì¹™ íŒ¨í‚· ë°”ì´íŠ¸ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">--zero</span><span class="p">;</span> iptables <span class="nt">-t</span> nat <span class="nt">--zero</span><span class="p">;</span> iptables <span class="nt">-t</span> mangle <span class="nt">--zero</span>
        
  <span class="c"># ì •ì±… í™•ì¸ : ì•„ë˜ ì •ì±… ë‚´ìš©ì€ í•µì‹¬ì ì¸ ë£°(rule)ë§Œ í‘œì‹œí–ˆìŠµë‹ˆë‹¤!</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-nvL</span>
  <span class="c"># =&gt; Chain PREROUTING (policy ACCEPT 121 packets, 7260 bytes) &lt;&lt;1. PREROUTING&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#      121  7260 KUBE-SERVICES  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span>
  <span class="c">#    ...</span>
  <span class="c">#    </span>
  <span class="c">#    Chain INPUT (policy ACCEPT 121 packets, 7260 bytes)</span>
  <span class="c">#    </span>
  <span class="c">#    Chain OUTPUT (policy ACCEPT 392 packets, 23520 bytes)</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#      392 23520 KUBE-SERVICES  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span>
  <span class="c">#    ...</span>
  <span class="c">#    </span>
  <span class="c">#    Chain KUBE-MARK-MASQ (18 references)</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 MARK       0    --  *      *       0.0.0.0/0            0.0.0.0/0            MARK or 0x4000</span>
  <span class="c">#    </span>
  <span class="c">#    Chain KUBE-SERVICES (2 references) &lt;&lt;2. SERVICES&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 KUBE-SVC-KBDEBIL6IU6WL7RF  6    --  *      *       0.0.0.0/0            10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
  <span class="c">#    ...</span>
  <span class="c">#    </span>
  <span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references) &lt;&lt;3. KUBE-SVC-YYY&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
  <span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
  <span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
  <span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
  <span class="c">#    </span>
  <span class="c">#    Chain KUBE-SEP-X47GKN7LA32LZ4H7 (1 references) &lt;&lt;4. KUBE-SEP-#WEBPOD1&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 KUBE-MARK-MASQ  0    --  *      *       10.10.4.3            0.0.0.0/0            /* default/svc-clusterip:svc-webport */</span>
  <span class="c">#        0     0 DNAT       6    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport */ tcp to:10.10.4.3:80</span>
  <span class="c">#    </span>
  <span class="c">#    Chain KUBE-SEP-T7YVH2JOMUTQFUDU (1 references) &lt;&lt;4. KUBE-SEP-#WEBPOD2&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 KUBE-MARK-MASQ  0    --  *      *       10.10.1.4            0.0.0.0/0            /* default/svc-clusterip:svc-webport */</span>
  <span class="c">#        0     0 DNAT       6    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport */ tcp to:10.10.1.4:80</span>
  <span class="c">#</span>
  <span class="c">#    Chain KUBE-SEP-SZHENXPAXVOCHRDA (1 references) &lt;&lt;4. KUBE-SEP-#WEBPOD3&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 KUBE-MARK-MASQ  0    --  *      *       10.10.2.3            0.0.0.0/0            /* default/svc-clusterip:svc-webport */</span>
  <span class="c">#        0     0 DNAT       6    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport */ tcp to:10.10.2.3:80</span>
        
  <span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> PREROUTING | column <span class="nt">-t</span>
  <span class="c"># =&gt; Chain  PREROUTING  (policy        ACCEPT  777  packets,  46620  bytes)</span>
  <span class="c">#    pkts   bytes       target         prot    opt  in        out    source     destination</span>
  <span class="c">#    777    46620       KUBE-SERVICES  0       --   *         *      0.0.0.0/0  0.0.0.0/0    /*  kubernetes  service  portals  */</span>
  <span class="c">#    0      0           DOCKER_OUTPUT  0       --   *         *      0.0.0.0/0  172.23.0.1</span>
        
  <span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SERVICES | column
  <span class="c"># ë°”ë¡œ ì•„ë˜ ë£°(rule)ì— ì˜í•´ì„œ ì„œë¹„ìŠ¤(ClusterIP)ë¥¼ ì¸ì§€í•˜ê³  ì²˜ë¦¬ë¥¼ í•©ë‹ˆë‹¤</span>
  <span class="c"># =&gt; Chain  KUBE-SERVICES  (2                         references)</span>
  <span class="c">#    pkts   bytes          target                     prot         opt  in  out  source     destination</span>
  <span class="c">#    0      0              KUBE-SVC-KBDEBIL6IU6WL7RF  6            --   *   *    0.0.0.0/0  10.200.1.96   /*  default/svc-clusterip:svc-webport  cluster  IP          */     tcp   dpt:9000</span>
        
  <span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SVC-KBDEBIL6IU6WL7RF | column
  <span class="c"># =&gt; Chain  KUBE-SVC-KBDEBIL6IU6WL7RF  (1                         references)</span>
  <span class="c">#    pkts   bytes                      target                     prot         opt  in  out  source         destination</span>
  <span class="c">#    0      0                          KUBE-SEP-T7YVH2JOMUTQFUDU  0            --   *   *    0.0.0.0/0      0.0.0.0/0    /*  default/svc-clusterip:svc-webport  -&gt;       10.10.1.4:80  */  statistic  mode      random  probability  0.33333333349</span>
  <span class="c">#    0      0                          KUBE-SEP-SZHENXPAXVOCHRDA  0            --   *   *    0.0.0.0/0      0.0.0.0/0    /*  default/svc-clusterip:svc-webport  -&gt;       10.10.2.3:80  */  statistic  mode      random  probability  0.50000000000</span>
  <span class="c">#    0      0                          KUBE-SEP-X47GKN7LA32LZ4H7  0            --   *   *    0.0.0.0/0      0.0.0.0/0    /*  default/svc-clusterip:svc-webport  -&gt;       10.10.4.3:80  */</span>
        
  <span class="c"># íŒ¨í‚· ì „ë‹¬ ìˆ˜ë¥¼ í™•ì¸ í•˜ê¸° ìœ„í•´ watchë¥¼ ê²ë‹ˆë‹¤.</span>
  <span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF'</span>
        
  <span class="c"># control-plane ì—ì„œ í…ŒìŠ¤íŠ¸ íŒ¨í‚·ì„ ë³´ëƒ…ë‹ˆë‹¤.</span>
  <span class="nv">$ SVC1</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};   do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; sleep 1; done"</span>
</code></pre></div>            </div>

            <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_17.png" alt="img.png" /></p>
          </li>
          <li>
            <p>iptablesì—ì„œ  ì¹´ìš´íŠ¸ê°€ ì¦ê°€í•¨ì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># SVC-### ì—ì„œ ëœë¤ í™•ë¥ (ëŒ€ëµ 33%)ë¡œ SEP(Service EndPoint)ì¸ ê°ê° íŒŒë“œ IPë¡œ DNAT ë©ë‹ˆë‹¤!</span>
<span class="c">## ì²«ë²ˆì§¸ ë£°ì— ì¼ì¹˜ í™•ë¥ ì€ 33% ì´ê³ , ë§¤ì¹­ë˜ì§€ ì•Šì„ ê²½ìš° ì•„ë˜ 2ê°œ ë‚¨ì„ë•ŒëŠ” ë£° ì¼ì¹˜ í™•ë¥ ì€ 50%ê°€ ë©ë‹ˆë‹¤. ì´ê²ƒë„ ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ë§ˆì§€ë§‰ ë£°ë¡œ 100% ì¼ì¹˜ë©ë‹ˆë‹¤</span>
<span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination</span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#       41  2460 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#       47  2820 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#       45  2700 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
      
<span class="c"># $ iptables -v --numeric --table nat --list KUBE-SEP-&lt;ê°ì ê°’ ì…ë ¥&gt;</span>
<span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SEP-T7YVH2JOMUTQFUDU
<span class="c"># =&gt; Chain  KUBE-SEP-T7YVH2JOMUTQFUDU  (1              references)</span>
<span class="c">#    pkts   bytes                      target          prot         opt  in  out  source     destination</span>
<span class="c">#    49     2940                       DNAT            6            --   *   *    0.0.0.0/0  0.0.0.0/0    /*  default/svc-clusterip:svc-webport  */  tcp  to:10.10.1.4:80</span>
      
<span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SEP-SZHENXPAXVOCHRDA  | column <span class="nt">-t</span>
<span class="c"># =&gt; Chain  KUBE-SEP-SZHENXPAXVOCHRDA  (1              references)</span>
<span class="c">#    pkts   bytes                      target          prot         opt  in  out  source     destination</span>
<span class="c">#    0      0                          KUBE-MARK-MASQ  0            --   *   *    10.10.2.3  0.0.0.0/0    /*  default/svc-clusterip:svc-webport  */</span>
<span class="c">#    56     3360                       DNAT            6            --   *   *    0.0.0.0/0  0.0.0.0/0    /*  default/svc-clusterip:svc-webport  */  tcp  to:10.10.2.3:80</span>
      
<span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SEP-X47GKN7LA32LZ4H7  | column <span class="nt">-t</span>
<span class="c"># =&gt; Chain  KUBE-SEP-X47GKN7LA32LZ4H7  (1              references)</span>
<span class="c">#    pkts   bytes                      target          prot         opt  in  out  source     destination</span>
<span class="c">#    0      0                          KUBE-MARK-MASQ  0            --   *   *    10.10.4.3  0.0.0.0/0    /*  default/svc-clusterip:svc-webport  */</span>
<span class="c">#    48     2880                       DNAT            6            --   *   *    0.0.0.0/0  0.0.0.0/0    /*  default/svc-clusterip:svc-webport  */  tcp  to:10.10.4.3:80</span>
      
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">--zero</span>
<span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> POSTROUTING | column<span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-POSTROUTING | column
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -v --numeric --table nat --list POSTROUTING; echo ; iptables -v --numeric --table nat --list KUBE-POSTROUTING'</span>
<span class="c"># POSTROUTE(nat) : 0x4000 ë§ˆí‚¹ ë˜ì–´ ìˆì§€ ì•Šìœ¼ë‹ˆ RETURN ë˜ê³  ê·¸ëƒ¥ ë¹ ì ¸ë‚˜ê°€ì„œ SNAT ë˜ì§€ ì•ŠëŠ”ë‹¤!</span>
<span class="c"># =&gt; Chain  POSTROUTING  (policy             ACCEPT  0    packets,  0    bytes)</span>
<span class="c">#    pkts   bytes        target              prot    opt  in        out  source     destination</span>
<span class="c">#    0      0            KUBE-POSTROUTING    0       --   *         *    0.0.0.0/0  0.0.0.0/0    /*        kubernetes  postrouting  rules   */</span>
<span class="c">#    0      0            DOCKER_POSTROUTING  0       --   *         *    0.0.0.0/0  172.23.0.1</span>
<span class="c">#    0      0            KIND-MASQ-AGENT     0       --   *         *    0.0.0.0/0  0.0.0.0/0    ADDRTYPE  match       dst-type     !LOCAL  /*  kind-masq-agent:  ensure  nat  POSTROUTING  directs  all  non-LOCAL  destination  traffic  to  our  custom  KIND-MASQ-AGENT  chain  */</span>
<span class="c"># =&gt; Chain  KUBE-POSTROUTING  (1          references)</span>
<span class="c">#    pkts   bytes             target      prot         opt  in  out  source     destination</span>
<span class="c">#    0      0                 RETURN      0            --   *   *    0.0.0.0/0  0.0.0.0/0    mark  match       !        0x4000/0x4000</span>
<span class="c">#    0      0                 MARK        0            --   *   *    0.0.0.0/0  0.0.0.0/0    MARK  xor         0x4000</span>
<span class="c">#    0      0                 MASQUERADE  0            --   *   *    0.0.0.0/0  0.0.0.0/0    /*    kubernetes  service  traffic        requiring  SNAT  */  random-fully</span>
      
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>KUBE-POSTROUTING
<span class="c"># =&gt; -N KUBE-POSTROUTING</span>
<span class="c">#    -A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING</span>
<span class="c">#    -A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN</span>
<span class="c">#    -A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0</span>
<span class="c">#    -A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -j MASQUERADE --random-fully</span>
      
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------------------</span>
      
<span class="c"># ìœ„ ì„œë¹„ìŠ¤ ìƒì„± ì‹œ kube-proxy ì— ì˜í•´ì„œ iptables ê·œì¹™ì´ ëª¨ë“  ë…¸ë“œì— ì¶”ê°€ë¨ì„ í•œë²ˆ ë” í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SVC-KBDEBIL6IU6WL7RF
<span class="c"># =&gt; Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
      
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SVC-KBDEBIL6IU6WL7RF<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
<span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
<span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
<span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
<span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
</code></pre></div>            </div>
          </li>
          <li>
            <p>ë™ì¼í•œ iptables ë£°ì´ ê° ë…¸ë“œì— ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          </li>
        </ul>
      </li>
      <li>íŒŒë“œ 1ê°œì— ì¥ì• ë¥¼ ë°œìƒì‹œì¼œì„œ ì¥ì• ì‹œ ë™ì‘ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
        <ul>
          <li>
            <p>ë™ì‘ í™•ì¸ì„ ìœ„í•œ ëª¨ë‹ˆí„°ë§</p>

            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># í„°ë¯¸ë„1 &gt;&gt; ENDPOINTS ë³€í™”ë¥¼ ì˜ í™•ì¸í•´ë³´ì!</span>
  <span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pod -owide;echo; kubectl get svc,ep svc-clusterip;echo; kubectl get endpointslices -l kubernetes.io/service-name=svc-clusterip'</span>
        
  <span class="c"># í„°ë¯¸ë„2</span>
  <span class="nv">$ SVC1</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$SVC1</span><span class="s2">:9000 | egrep 'Hostname|IP: 10'; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>
  <span class="c"># í˜¹ì€</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};  do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
</code></pre></div>            </div>
          </li>
          <li>
            <p>íŒŒë“œ 1ê°œ ì‚­ì œ í›„ í™•ì¸</p>

            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># (ë°©ì•ˆ1) íŒŒë“œ3ë²ˆ ì‚­ì œ &gt;&gt; ì„œë¹„ìŠ¤ì˜ ì—”ë“œí¬ì¸íŠ¸ê°€ ì–´ë–»ê²Œ ë³€ê²½ë˜ëŠ”ì§€ í™•ì¸ í•˜ì!, ì§€ì†ì ì¸ curl ì ‘ì† ê²°ê³¼ í™•ì¸!, for ë¬¸ ì‹¤í–‰ ì‹œ ê²°ê³¼ í™•ì¸!, ì ˆì²´ ì‹œê°„(ìˆœë‹¨) í™•ì¸!</span>
  <span class="nv">$ </span>kubectl delete pod webpod3
        
  <span class="c"># (ë°©ì•ˆ1) ê²°ê³¼ í™•ì¸ í›„ ë‹¤ì‹œ íŒŒë“œ 3ë²ˆ ìƒì„± &gt;&gt; ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬!</span>
  <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> 3pod.yaml
        
  <span class="nt">---------------------------------</span>
  <span class="c"># (ë°©ì•ˆ2) íŒŒë“œ3ë²ˆì— ë ˆì´ë¸” ì‚­ì œ</span>
  <span class="nv">$ </span>kubectl get pod <span class="nt">--show-labels</span>
        
  <span class="c">## ë ˆì´ë¸”(ë¼ë²¨)ì˜ í‚¤ê°’ ë°”ë¡œ ë’¤ì— í•˜ì´í”ˆ(-) ì…ë ¥ ì‹œ í•´ë‹¹ ë ˆì´ë¸” ì‚­ì œë¨! &gt;&gt; ë ˆì´ë¸”ê³¼ ì…€ë ‰í„°ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì—ì„œ ë§¤ìš° ë§ì´ í™œìš©ëœë‹¤!</span>
  <span class="nv">$ </span>kubectl label pod webpod3 app-
  <span class="nv">$ </span>kubectl get pod <span class="nt">--show-labels</span>
        
  <span class="c"># (ë°©ì•ˆ2) ê²°ê³¼ í™•ì¸ í›„ íŒŒë“œ3ë²ˆì— ë‹¤ì‹œ ë ˆì´ë¸” ìƒì„±</span>
  <span class="nv">$ </span>kubectl label pod webpod3 <span class="nv">app</span><span class="o">=</span>webpod
</code></pre></div>            </div>

            <ul>
              <li>
                <p>íŒŒë“œ ì‚­ì œ ì „</p>

                <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_18.png" alt="img.png" /></p>
              </li>
              <li>
                <p>íŒŒë“œ ì‚­ì œ í›„</p>

                <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_19.png" alt="img.png" /></p>
              </li>
              <li>
                <p>íŒŒë“œ ë‹¤ì‹œ ìƒì„± í›„</p>

                <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_20.png" alt="img.png" /></p>
              </li>
              <li>
                <p>ë ˆì´ë¸” ì‚­ì œ í›„</p>

                <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_21.png" alt="img.png" /></p>
              </li>
              <li>
                <p>ë ˆì´ë¸” ë³µêµ¬ í›„</p>

                <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_22.png" alt="img.png" /></p>
              </li>
            </ul>
          </li>
          <li>
            <p>íŒŒë“œê°€ ì‚­ì œë˜ê³  ë³µêµ¬ ë¨ì— ë”°ë¼ ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì‚­ì œë˜ê³ , label selector ì— ë”°ë¼ì„œë„ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì‚­ì œë˜ê³  ë³µêµ¬ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>
          </li>
        </ul>
      </li>
      <li>sessionAffinity: ClientIP
        <ul>
          <li><code class="language-plaintext highlighter-rouge">sessionAffinity: ClientIP</code> : í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ì†í•œ ëª©ì ì§€(íŒŒë“œ)ì— ê³ ì •ì ì¸ ì ‘ì†ì„ ì§€ì›í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>
            <p>ê¸°ë³¸ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ëŠ” íŒŒë“œì— ëœë¤ìœ¼ë¡œ ë¶€í•˜ë¥¼ ë¶„ì‚°í•˜ì§€ë§Œ <code class="language-plaintext highlighter-rouge">sessionAffinity: ClientIP</code>ë¥¼ í†µí•´ ë™ì¼í•œ íŒŒë“œì— ì ‘ì†í•˜ë„ë¡ ê°•ì œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_23.png" alt="img.png" /></p>
          </li>
          <li>
            <p>ì„¤ì • ë° íŒŒë“œ ì ‘ì† í™•ì¸</p>

            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># ê¸°ë³¸ ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>kubectl get svc svc-clusterip <span class="nt">-o</span> yaml
  <span class="nv">$ </span>kubectl get svc svc-clusterip <span class="nt">-o</span> yaml | <span class="nb">grep </span>sessionAffinity
  <span class="c"># =&gt;   sessionAffinity: None</span>
        
  <span class="c"># ë°˜ë³µ ì ‘ì†</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$SVC1</span><span class="s2">:9000 | egrep 'Hostname|IP: 10|Remote'; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>
  <span class="c"># =&gt; Hostname: webpod2</span>
  <span class="c">#    IP: 10.10.1.4</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:57246</span>
  <span class="c">#    2024-09-01 12:25:49</span>
  <span class="c">#    </span>
  <span class="c">#    Hostname: webpod1</span>
  <span class="c">#    IP: 10.10.4.3</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:57250</span>
  <span class="c">#    2024-09-01 12:25:50</span>
  <span class="c">#    </span>
  <span class="c">#    Hostname: webpod3</span>
  <span class="c">#    IP: 10.10.2.6</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:57252</span>
  <span class="c">#    2024-09-01 12:25:51</span>
        
  <span class="c"># í˜„ì¬ëŠ” ëœë¤ìœ¼ë¡œ ì ‘ì† ë©ë‹ˆë‹¤.</span>
        
  <span class="c"># sessionAffinity: ClientIP ì„¤ì • ë³€ê²½</span>
  <span class="nv">$ </span>kubectl patch svc svc-clusterip <span class="nt">-p</span> <span class="s1">'{"spec":{"sessionAffinity":"ClientIP"}}'</span>
  <span class="c"># =&gt; service/svc-clusterip patched</span>
  <span class="c"># í˜¹ì€</span>
  <span class="c">## $ kubectl get svc svc-clusterip -o yaml | sed -e "s/sessionAffinity: None/sessionAffinity: ClientIP/" | kubectl apply -f -</span>
        
  <span class="c">#</span>
  <span class="nv">$ </span>kubectl get svc svc-clusterip <span class="nt">-o</span> yaml
  <span class="c"># =&gt; ...</span>
  <span class="c">#      sessionAffinity: ClientIP</span>
  <span class="c">#      sessionAffinityConfig:</span>
  <span class="c">#        clientIP:</span>
  <span class="c">#          timeoutSeconds: 10800</span>
  <span class="c">#    ...</span>
        
  <span class="c"># í´ë¼ì´ì–¸íŠ¸(TestPod) Shell ì‹¤í–‰</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};  do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt; 100 Hostname: webpod2</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..1000}; do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt; 1000 Hostname: webpod2</span>
</code></pre></div>            </div>

            <ul>
              <li>sessionAffinity: ClientIPë¥¼ í•˜ë©´ spec.sessionAffinityConfig.clientIP.timeoutSeconds ì‹œê°„ë™ì•ˆ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ì ‘ì† ë˜ëŠ” íŒŒë“œê°€ ê³ ì •ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ì´ìƒê³¼ ê°™ì´ ClusterIP íƒ€ì…ì˜ ì„œë¹„ìŠ¤ë¥¼ í™•ì¸í•´ë³´ì•˜ìŠµë‹ˆë‹¤.</li>
  <li>ClusterIP íƒ€ì…ì˜ ì„œë¹„ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ì ì´ ìˆë‹¤ê³  í•©ë‹ˆë‹¤.
    <ul>
      <li>í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œëŠ” ì„œë¹„ìŠ¤(ClusterIP)ë¡œ ì ‘ì†ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. â‡’ <strong>NodePort</strong> íƒ€ì…ìœ¼ë¡œ ì™¸ë¶€ì—ì„œ ì ‘ì† ê°€ëŠ¥</li>
      <li>IPtables ëŠ” íŒŒë“œì— ëŒ€í•œ í—¬ìŠ¤ì²´í¬ ê¸°ëŠ¥ì´ ì—†ì–´ì„œ ë¬¸ì œ ìˆëŠ” íŒŒë“œì— ì—°ê²°ì´ ë˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤. â‡’ ì„œë¹„ìŠ¤ ì‚¬ìš©, íŒŒë“œì— Readiness Probe ì„¤ì •ìœ¼ë¡œ íŒŒë“œ ë¬¸ì œ ì‹œ ì„œë¹„ìŠ¤ì˜ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì œê±°ë˜ê²Œ í•˜ì! â† ì´ ì •ë„ë©´ ì¶©ë¶„í•œê°€? í˜¹ì‹œ ë¶€ì¡±í•œ ì ì´ ì—†ì„ê¹Œ?</li>
      <li>ì„œë¹„ìŠ¤ì— ì—°ë™ëœ íŒŒë“œ ê°¯ìˆ˜ í¼ì„¼íŠ¸(%)ë¡œ <strong>ëœë¤ ë¶„ì‚°</strong> ë°©ì‹, <strong>ì„¸ì…˜ì–´í”¼ë‹ˆí‹°</strong> ì´ì™¸ì— <strong>ë‹¤ë¥¸ ë¶„ì‚° ë°©ì‹ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</strong> â‡’ <strong>IPVS</strong> ê²½ìš° ë‹¤ì–‘í•œ ë¶„ì‚° ë°©ì‹(ì•Œê³ ë¦¬ì¦˜) ê°€ëŠ¥
        <ul>
          <li>ëª©ì ì§€ íŒŒë“œ ë‹¤ìˆ˜ê°€ ìˆëŠ” í™˜ê²½ì—ì„œ, ì¶œë°œì§€ íŒŒë“œì™€ ëª©ì ì§€ íŒŒë“œê°€ ë™ì¼í•œ ë…¸ë“œì— ë°°ì¹˜ë˜ì–´ ìˆì–´ë„, ëœë¤ ë¶„ì‚°ìœ¼ë¡œ ë‹¤ë¥¸ ë…¸ë“œì— ëª©ì ì§€ íŒŒë“œë¡œ ì—°ê²° ê°€ëŠ¥</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="nodeport-ì‹¤ìŠµ">NodePort ì‹¤ìŠµ</h4>

<ul>
  <li>NodePortëŠ” ClusterIPì™€ ë‹¤ë¥´ê²Œ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œë„ ì ‘ì† í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì„ í¬í•¨í•œ ëª¨ë“  ë…¸ë“œì— iptables ruleì´ ì ìš©ë˜ë¯€ë¡œ, ëª¨ë“  ë…¸ë“œì— NodePortë¡œ ì ‘ì†ì‹œ iptables ruleì— ì˜í•´ì„œ ë¶„ì‚° ì ‘ì†ì´ ë©ë‹ˆë‹¤.</li>
  <li>Nodeì˜ ëª¨ë“  Local IP (loopbackì„ í¬í•¨í•œ ê° í˜¸ìŠ¤íŠ¸ì˜ interfaceì˜ IP) ì‚¬ìš© ê°€ëŠ¥í•˜ê³  Local IP ì§€ì •ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ NodePortëŠ” ê¸°ë³¸ 30000~32767 í¬íŠ¸ì—ì„œ ëœë¤ìœ¼ë¡œ ì§€ì •ë©ë‹ˆë‹¤.
    <ul>
      <li>
        <p>ëœë¤ í¬íŠ¸ ë²”ìœ„ë¥¼ ë°”ê¾¸ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´  <code class="language-plaintext highlighter-rouge">/etc/kubernetes/manifests/kube-apiserver.yaml</code> íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ kube-apiserver ì˜ íŒŒë¼ë©”í„°ì— <code class="language-plaintext highlighter-rouge">--service-node-port-range=ì‹œì‘í¬íŠ¸-ì¢…ë£Œí¬íŠ¸</code>ë¥¼ ë³€ê²½í•˜ë©´ë©ë‹ˆë‹¤. <a href="https://blog.frec.kr/cloud/modify_nodeport_range/">ì°¸ê³ </a></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># /etc/kubernetes/manifests/kube-apiserver.yaml</span>
      
  ...
  spec:
    containers:
    - <span class="nb">command</span>:
      - kube-apiserver
      - <span class="nt">--authorization-mode</span><span class="o">=</span>Node,RBAC
      ...
      - <span class="nt">--service-node-port-range</span><span class="o">=</span>30000-50000
  ...
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>ì‹¤ìŠµ êµ¬ì„±
    <ul>
      <li>
        <p>ëª©ì ì§€(backend) ë””í”Œë¡œì´ë¨¼íŠ¸ íŒŒì¼ ìƒì„± : echo-deploy.yml</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">deploy-echo</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
    <span class="na">selector</span><span class="pi">:</span>
      <span class="na">matchLabels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">deploy-websrv</span>
    <span class="na">template</span><span class="pi">:</span>
      <span class="na">metadata</span><span class="pi">:</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="na">app</span><span class="pi">:</span> <span class="s">deploy-websrv</span>
      <span class="na">spec</span><span class="pi">:</span>
        <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
        <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">kans-websrv</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">mendhak/http-https-echo</span>
          <span class="na">ports</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì„œë¹„ìŠ¤(NodePort) íŒŒì¼ ìƒì„± : svc-nodeport.yml</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="err">*</span><span class="nv">*Service</span><span class="err">**</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">svc-nodeport</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">svc-webport</span>
        <span class="na">port</span><span class="pi">:</span> <span class="m">9000</span>        <span class="c1"># ì„œë¹„ìŠ¤ ClusterIP ì— ì ‘ì† ì‹œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ port ë¥¼ ì˜ë¯¸</span>
        <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>  <span class="c1"># íƒ€í‚· targetPort ëŠ” ì„œë¹„ìŠ¤ë¥¼ í†µí•´ì„œ ëª©ì ì§€ íŒŒë“œë¡œ ì ‘ì† ì‹œ í•´ë‹¹ íŒŒë“œë¡œ ì ‘ì†í•˜ëŠ” í¬íŠ¸ë¥¼ ì˜ë¯¸</span>
    <span class="na">selector</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">deploy-websrv</span>
    <span class="na">**type</span><span class="pi">:</span> <span class="s">NodePort**</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ìƒì„± ë° í™•ì¸</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># ìƒì„±</span>
  <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> echo-deploy.yml,svc-nodeport.yml
  <span class="c"># =&gt; deployment.apps/deploy-echo created</span>
  <span class="c">#    service/svc-nodeport created</span>
      
  <span class="c"># ëª¨ë‹ˆí„°ë§</span>
  <span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pod -owide;echo; kubectl get svc,ep svc-nodeport'</span>
      
  <span class="c"># í™•ì¸</span>
  <span class="nv">$ </span>kubectl get deploy,pod <span class="nt">-o</span> wide
  <span class="c"># =&gt; NAME                          READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS    IMAGES                    SELECTOR</span>
  <span class="c">#    deployment.apps/deploy-echo   3/3     3            3           49s   kans-websrv   mendhak/http-https-echo   app=deploy-websrv</span>
  <span class="c">#    </span>
  <span class="c">#    NAME                               READY   STATUS    RESTARTS   AGE    IP          NODE                  NOMINATED NODE   READINESS GATES</span>
  <span class="c">#    pod/deploy-echo-5c689d5454-dxf2t   1/1     Running   0          49s    10.10.4.4   myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    pod/deploy-echo-5c689d5454-rbgcp   1/1     Running   0          49s    10.10.1.5   myk8s-worker2         &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    pod/deploy-echo-5c689d5454-wppr8   1/1     Running   0          49s    10.10.2.7   myk8s-worker3         &lt;none&gt;           &lt;none&gt;</span>
      
  <span class="c"># ì•„ë˜ 31791ì€ ì„œë¹„ìŠ¤(NodePort) ì •ë³´!</span>
  <span class="nv">$ </span>kubectl get svc svc-nodeport
  <span class="c"># =&gt; NAME           TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
  <span class="c">#    svc-nodeport   NodePort   10.200.1.169   &lt;none&gt;        9000:31791/TCP   69s</span>
      
  <span class="nv">$ </span>kubectl get endpoints svc-nodeport
  <span class="c"># =&gt; NAME           ENDPOINTS                                      AGE</span>
  <span class="c">#    svc-nodeport   10.10.1.5:8080,10.10.2.7:8080,10.10.4.4:8080   85s</span>
      
  <span class="c"># Port , TargetPort , NodePort ê°ê°ì˜ ì°¨ì´ì ì˜ ì˜ë¯¸ë¥¼ ì•Œì!</span>
  <span class="nv">$ </span>kubectl describe svc svc-nodeport
  <span class="c"># =&gt; Name:                     svc-nodeport</span>
  <span class="c">#    Namespace:                default</span>
  <span class="c">#    Labels:                   &lt;none&gt;</span>
  <span class="c">#    Annotations:              &lt;none&gt;</span>
  <span class="c">#    Selector:                 app=deploy-websrv</span>
  <span class="c">#    Type:                     NodePort</span>
  <span class="c">#    IP Family Policy:         SingleStack</span>
  <span class="c">#    IP Families:              IPv4</span>
  <span class="c">#    IP:                       10.200.1.169</span>
  <span class="c">#    IPs:                      10.200.1.169</span>
  <span class="c">#    Port:                     svc-webport  9000/TCP     &lt;&lt;ClusterIPì™€ ë™ì¼í•˜ê²Œ ë™ì‘í•˜ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸&gt;&gt;</span>
  <span class="c">#    TargetPort:               8080/TCP                  &lt;&lt;íŒŒë“œì˜ ì»¨í…Œì´ë„ˆì˜ í¬íŠ¸&gt;&gt;</span>
  <span class="c">#    NodePort:                 svc-webport  31791/TCP    &lt;&lt;ê° Nodeì—ì„œ Listening í•˜ëŠ” nodePort&gt;&gt;</span>
  <span class="c">#    Endpoints:                10.10.1.5:8080,10.10.2.7:8080,10.10.4.4:8080    &lt;&lt;Port Forwarding ëŒ€ìƒì´ ë˜ëŠ” íŒŒë“œì˜ ì—”ë“œí¬ì¸íŠ¸ íŒŒë“œIP:íŒŒë“œPort&gt;&gt;</span>
  <span class="c">#    Session Affinity:         None</span>
  <span class="c">#    External Traffic Policy:  Cluster &lt;&lt;ë¶€í•˜ ë¶„ì‚°ë°©ì‹&gt;&gt;</span>
  <span class="c">#    Events:                   &lt;none&gt;</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>2.3. ì„œë¹„ìŠ¤ ì ‘ì† í™•ì¸
    <ul>
      <li>
        <p>NodePortì˜ ì„œë¹„ìŠ¤ ì ‘ì†ì„ í†µí•œ í†µì‹ ì˜ íë¦„</p>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_24.png" alt="img.png" /></p>

        <ul>
          <li>Client ê°€ìƒ ë¨¸ì‹ (192.168.10.200)ì—ì„œ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ IP(192.168.10.10)ì˜ nodePort ì ‘ì†ì„ ì‹œë„í•©ë‹ˆë‹¤.</li>
          <li>nodePortëŠ” ì„œë¹„ìŠ¤(NodePort) ìƒì„±ì‹œì— í• ë‹¹ëœ ëœë¤í¬íŠ¸ê°€ ì‚¬ìš© ë©ë‹ˆë‹¤.</li>
          <li>ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì˜ iptablesì˜ NAT í…Œì´ë¸”ì˜ ê·œì¹™ê³¼ ë§¤ì¹­ë˜ì–´ ëª©ì ì§€ IPì™€ ëª©ì ì§€ PortëŠ” ë³€í™˜ ë©ë‹ˆë‹¤. ëª©ì ì§€ IPëŠ” app=deploy-websrv ë ˆì´ë¸”ì„ ê°€ì§€ê³  ìˆëŠ” íŒŒë“œ 3ê°œê°€ ëŒ€ìƒì´ ë˜ë©°, ëœë¤ ë¶€í•˜ë¶„ì‚°ì´ ì„ íƒë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>
        <p>ì‹¤ìŠµì„ í†µí•´ ìœ„ì˜ ê³¼ì •ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤. ë‹¨ í˜„ì¬ ì‹¤ìŠµí™˜ê²½ì—ì„œëŠ” ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ëŠ” íŒŒë“œê°€ ì—†ìœ¼ë¯€ë¡œ ìœ„ì˜ ì„¤ëª…ê³¼ëŠ” ë‹¤ë¥´ê²Œ ì›Œì»¤ë…¸ë“œì˜ íŒŒë“œë¥¼ ì ‘ì†í•˜ëŠ”ê²ƒìœ¼ë¡œ ì‹¤ìŠµí•˜ê² ìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># NodePort í™•ì¸ : ì•„ë˜ NodePort ëŠ” ë²”ìœ„ë‚´ ëœë¤ í• ë‹¹ìœ¼ë¡œ ì‹¤ìŠµ í™˜ê²½ë§ˆë‹¤ ë‹¤ë¦…ë‹ˆë‹¤</span>
  <span class="nv">$ </span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span>
  <span class="c"># =&gt; 31791</span>
      
  <span class="c"># NodePort ë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
  <span class="nv">$ NPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NPORT</span>
  <span class="c"># =&gt; 31791</span>
      
  <span class="c"># í˜„ì¬ k8s ë²„ì „ì—ì„œëŠ” í¬íŠ¸ Listen ë˜ì§€ ì•Šê³ , iptables rules ì²˜ë¦¬ë¨</span>
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ss <span class="nt">-tlnp</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
  <span class="c">#    State  Recv-Q Send-Q Local Address:Port  Peer Address:PortProcess                                  </span>
  <span class="c">#    LISTEN 0      4096       127.0.0.1:2381       0.0.0.0:*    users:(("etcd",pid=710,fd=15))          </span>
  <span class="c">#    ... nodePortì¸ 31791ë¥¼ LISTENí•˜ëŠ” ê±´ì´ ì—†ìŒ</span>
  <span class="c">#</span>
  <span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
  <span class="c">#    State  Recv-Q Send-Q Local Address:Port  Peer Address:PortProcess                              </span>
  <span class="c">#    LISTEN 0      4096      127.0.0.11:35033      0.0.0.0:*                                        </span>
  <span class="c">#    ... nodePortì¸ 31791ë¥¼ LISTENí•˜ëŠ” ê±´ì´ ì—†ìŒ</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
  <span class="c">#    State  Recv-Q Send-Q Local Address:Port  Peer Address:PortProcess                              </span>
  <span class="c">#    LISTEN 0      4096      127.0.0.11:45927      0.0.0.0:*                                        </span>
  <span class="c">#    ... nodePortì¸ 31791ë¥¼ LISTENí•˜ëŠ” ê±´ì´ ì—†ìŒ</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
  <span class="c">#    State  Recv-Q Send-Q Local Address:Port  Peer Address:PortProcess                              </span>
  <span class="c">#    LISTEN 0      4096       127.0.0.1:10248      0.0.0.0:*    users:(("kubelet",pid=262,fd=19))   </span>
  <span class="c">#    ... nodePortì¸ 31791ë¥¼ LISTENí•˜ëŠ” ê±´ì´ ì—†ìŒ</span>
      
  <span class="c">## (ì°¸ê³ ) ì•„ë˜ì²˜ëŸ¼ ì˜ˆì „ k8s í™˜ê²½ì—ì„œ Service(NodePort) ìƒì„± ì‹œ, TCP Port Listen ë˜ì—ˆì—ˆìŒ</span>
  <span class="c"># $ root@k8s-m:~# ss -4tlnp | egrep "(Process|$NPORT)"</span>
  <span class="c"># State     Recv-Q    Send-Q        Local Address:Port        Peer Address:Port   Process</span>
  <span class="c"># LISTEN    0         4096                0.0.0.0:30466            0.0.0.0:*       users:(("kube-proxy",pid=8661,fd=10))</span>
      
  <span class="c"># íŒŒë“œ ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸ (ì›¹ íŒŒë“œì— ì ‘ì†ìì˜ IPê°€ ì¶œë ¥)</span>
  <span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>deploy-websrv <span class="nt">-f</span>
  <span class="c"># =&gt; Listening on ports 8080 for http, and 8443 for https.</span>
  <span class="c">#    ...</span>
  <span class="c">#    ::ffff:172.23.0.2 - - [26/Sep/2024:04:35:00 +0000] "GET / HTTP/1.1" 200 396 "-" "curl/7.88.1"</span>
  <span class="c">#    ...</span>
      
  <span class="c"># ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸(mypc ì»¨í…Œì´ë„ˆ)ì—ì„œ ì ‘ì† ì‹œë„ë¥¼ í•´ë³´ì</span>
      
  <span class="c"># ë…¸ë“œì˜ IPì™€ NodePortë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
  <span class="c">## CNODE=&lt;ì»¨íŠ¸ë¡¤í”Œë ˆì¸ë…¸ë“œì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE1=&lt;ë…¸ë“œ1ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE2=&lt;ë…¸ë“œ2ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE3=&lt;ë…¸ë“œ3ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="nv">$ CNODE</span><span class="o">=</span>172.23.0.2
  <span class="nv">$ NODE1</span><span class="o">=</span>172.23.0.4
  <span class="nv">$ NODE2</span><span class="o">=</span>172.23.0.5
  <span class="nv">$ NODE3</span><span class="o">=</span>172.23.0.3
      
  <span class="nv">$ NPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NPORT</span>
      
  <span class="c"># ì„œë¹„ìŠ¤(NodePort) ë¶€í•˜ë¶„ì‚° ì ‘ì† í™•ì¸</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nv">$CNODE</span>:<span class="nv">$NPORT</span> | jq <span class="c"># headers.host ì£¼ì†ŒëŠ” ì™œ ê·¸ëŸ°ê±°ì£ ?</span>
  <span class="c"># =&gt; {</span>
  <span class="c">#      "path": "/",</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.2:31791",  &lt;&lt;ì—¬ê¸°ì˜ headers.hostëŠ” ìš”ì²­í•˜ëŠ” urlì˜ ì£¼ì†Œì¸ë°, ìš°ë¦¬ê°€ $CNODE(ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì˜ IP)ì˜ urlë¡œ ì ‘ì†í–ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.&gt;&gt;</span>
  <span class="c">#        "user-agent": "curl/8.7.1",</span>
  <span class="c">#        "accept": "*/*"</span>
  <span class="c">#      },</span>
  <span class="c">#      "method": "GET",</span>
  <span class="c">#      "body": "",</span>
  <span class="c">#      "fresh": false,</span>
  <span class="c">#      "hostname": "172.23.0.2",   &lt;&lt;ì´ hostnameê³¼&gt;&gt;</span>
  <span class="c">#      "ip": "::ffff:172.23.0.2",  &lt;&lt;ì´ ipëŠ” ì ‘ì†í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ipì¸ë° ë¶€í•˜ë¶„ì‚° ê³¼ì •ì—ì„œ ëª©ì ì§€ê°€ Local Podê°€ ì•„ë‹Œ ê²½ìš° Node IPë¡œ POSTROUTING(SNAT) ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.&gt;&gt;</span>
  <span class="c">#      "ips": [],</span>
  <span class="c">#      "protocol": "http",</span>
  <span class="c">#      "query": {},</span>
  <span class="c">#      "subdomains": [],</span>
  <span class="c">#      "xhr": false,</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#      },</span>
  <span class="c">#      "connection": {}</span>
  <span class="c">#    }</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$CNODE</span> <span class="nv">$NODE1</span> <span class="nv">$NODE2</span> <span class="nv">$NODE3</span> <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nv">$i</span>:<span class="nv">$NPORT</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node 172.23.0.2 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.2:31791",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
  <span class="c">#      ...</span>
  <span class="c">#      "hostname": "172.23.0.2",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.2",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-dxf2t" </span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.4 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.4:31791",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
  <span class="c">#      ...</span>
  <span class="c">#      "hostname": "172.23.0.4",</span>
  <span class="c">#      "ip": "::ffff:10.10.4.1",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.5 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.5:31791",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
  <span class="c">#      ...</span>
  <span class="c">#      "hostname": "172.23.0.5",</span>
  <span class="c">#      "ip": "::ffff:10.10.1.1",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.3 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.3:31791",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
  <span class="c">#      ...</span>
  <span class="c">#      "hostname": "172.23.0.3",</span>
  <span class="c">#      "ip": "::ffff:10.10.2.1",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
      
  <span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œì—ëŠ” ëª©ì ì§€ íŒŒë“œê°€ ì—†ëŠ”ë°ë„, ì ‘ì†ì„ ë°›ì•„ì¤ë‹ˆë‹¤! ì´ìœ ëŠ” ì„œë¹„ìŠ¤(nodePort)ì˜ endpointë¡œ ë¡œë“œë°¸ëŸ°ì‹± ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$CNODE</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.2",</span>
  <span class="c">#         37     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#         33     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c">#         30     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$NODE1</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.4",</span>
  <span class="c">#         40     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#         32     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#         28     "hostname": "deploy-echo-5c689d5454-rbgcp"$ docker exec -it mypc zsh -c "for i in {1..100}; do curl -s $NODE2:$NPORT | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$NODE3</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.3",</span>
  <span class="c">#         43     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#         34     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#         23     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c"># ì•„ë˜ ë°˜ë³µ ì ‘ì† ì‹¤í–‰ í•´ë‘ì</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$CNODE</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>
      
  <span class="c"># NodePort ì„œë¹„ìŠ¤ëŠ” ClusterIP ë¥¼ í¬í•¨</span>
  <span class="c"># CLUSTER-IP:PORT ë¡œ ì ‘ì† ê°€ëŠ¥! &lt;- ì»¨íŠ¸ë¡¤ë…¸ë“œì—ì„œ ì•„ë˜ ì‹¤í–‰ í•´ë³´ì</span>
  <span class="nv">$ </span>kubectl get svc svc-nodeport
  <span class="c"># =&gt; NAME           TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
  <span class="c">#    svc-nodeport   NodePort   10.200.1.169   &lt;none&gt;        9000:31791/TCP   51m</span>
      
  <span class="nv">$ CIP</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.clusterIP}"</span><span class="si">)</span>
  <span class="nv">$ CIPPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.ports[0].port}"</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CIP</span> <span class="nv">$CIPPORT</span>
  <span class="c"># =&gt; 10.200.1.169 9000</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane curl <span class="nt">-s</span> <span class="nv">$CIP</span>:<span class="nv">$CIPPORT</span> | jq
  <span class="c"># =&gt; {</span>
  <span class="c">#      "path": "/",</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "10.200.1.169:9000",</span>
  <span class="c">#        "user-agent": "curl/7.88.1",</span>
  <span class="c">#        "accept": "*/*"</span>
  <span class="c">#      },</span>
  <span class="c">#      "method": "GET",</span>
  <span class="c">#      "body": "",</span>
  <span class="c">#      "fresh": false,</span>
  <span class="c">#      "hostname": "10.200.1.169",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.2",</span>
  <span class="c">#      "ips": [],</span>
  <span class="c">#      "protocol": "http",</span>
  <span class="c">#      "query": {},</span>
  <span class="c">#      "subdomains": [],</span>
  <span class="c">#      "xhr": false,</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c">#      },</span>
  <span class="c">#      "connection": {}</span>
  <span class="c">#    }</span>
      
  <span class="c"># mypcì—ì„œ CLUSTER-IP:PORT ë¡œ ì ‘ì† ê°€ëŠ¥í• ê¹Œ?</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nv">$CIP</span>:<span class="nv">$CIPPORT</span>
  <span class="c"># =&gt; (ì—ëŸ¬)</span>
      
  <span class="c"># mypcì—ì„œ cluster ip portë¡œì˜ ì ‘ì†ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. mypcëŠ” kubernetes í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì— ìˆì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</span>
      
  <span class="c"># (ì˜µì…˜) ë…¸ë“œì—ì„œ Network Connection</span>
  <span class="nv">$ </span>conntrack <span class="nt">-E</span>
  <span class="c"># =&gt;     [NEW] tcp      6 120 SYN_SENT src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 [UNREPLIED] src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907</span>
  <span class="c">#     [UPDATE] tcp      6 60 SYN_RECV src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907</span>
  <span class="c">#     [UPDATE] tcp      6 86400 ESTABLISHED src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907 [ASSURED]</span>
  <span class="c">#     [UPDATE] tcp      6 120 FIN_WAIT src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907 [ASSURED]</span>
  <span class="c">#     [UPDATE] tcp      6 30 LAST_ACK src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907 [ASSURED]</span>
  <span class="c">#     [UPDATE] tcp      6 120 TIME_WAIT src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907 [ASSURED]</span>
  <span class="c">#      ...</span>
  <span class="c"># SNATë‚˜ ë¹ ë¥¸ iptables ë£° ì²˜ë¦¬ë“±ì„ ìœ„í•´ ì ‘ì† ì •ë³´ê°€ ì¶”ì ë¨ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
      
  <span class="nv">$ </span>conntrack <span class="nt">-L</span> <span class="nt">--any-nat</span>
</code></pre></div>        </div>
      </li>
      <li>íŒŒë“œì—ì„œ ë°”ë¼ë³¸ í´ë¼ì´ì–¸íŠ¸ì˜ ì£¼ì†Œê°€ ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ê°€ ì•„ë‹Œ nodeì˜ ipë¡œ í‘œì‹œë˜ëŠ”ë° ê·¸ ì´ìœ ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.
        <ul>
          <li>
            <p>ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ì„œ iptablesì˜ nat í…Œì´ë¸”ì˜ KUBE-POSTROUTING ë£°ì„ í™•ì¸í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> 
  <span class="c"># =&gt; Chain POSTROUTING (policy ACCEPT 5813 packets, 349K bytes)</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#    37925 2276K KUBE-POSTROUTING  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */</span>
  <span class="c">#    ...</span>
  <span class="c">#    Chain KUBE-POSTROUTING (1 references)</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination</span>
  <span class="c">#     5343  321K RETURN     0    --  *      *       0.0.0.0/0            0.0.0.0/0            mark match ! 0x4000/0x4000</span>
  <span class="c">#     1265 75900 MARK       0    --  *      *       0.0.0.0/0            0.0.0.0/0            MARK xor 0x4000</span>
  <span class="c">#     1265 75900 MASQUERADE  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service traffic requiring SNAT */ random-fully</span>
</code></pre></div>            </div>

            <p>í™•ì¸ ê²°ê³¼ POSTROUTINGì‹œ KUBE-POSTROUTINGì„ í†µí•´ SNAT ë˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          </li>
        </ul>
      </li>
      <li>
        <p>ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë¹„ìŠ¤(NodePort) ì ‘ì† ì‹œ : 3ê°œì˜ ëª©ì ì§€(backend) íŒŒë“œë¡œ <strong>ëœë¤ ë¶€í•˜ ë¶„ì‚°</strong> ì ‘ì†ë¨ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$CNODE</span>:<span class="nv">$NPORT</span> | <span class="nb">grep hostname</span><span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
  <span class="c"># =&gt;    100   "hostname": "172.23.0.2",</span>
  <span class="c">#        42     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#        31     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#        27     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$NODE1</span>:<span class="nv">$NPORT</span> | <span class="nb">grep hostname</span><span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.4",</span>
  <span class="c">#         37     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#         34     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c">#         29     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$NODE2</span>:<span class="nv">$NPORT</span> | <span class="nb">grep hostname</span><span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.5",</span>
  <span class="c">#         41     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#         32     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c">#         27     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$NODE3</span>:<span class="nv">$NPORT</span> | <span class="nb">grep hostname</span><span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.3",</span>
  <span class="c">#         39     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#         34     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#         27     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì›¹ íŒŒë“œì—ì„œ  logë¥¼ í†µí•´ ì ‘ì†ìì˜ IP í™•ì¸ì‹œ ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ IPê°€ ì•„ë‹Œ, ë…¸ë“œì˜ IPë¡œ SNAT ë˜ì–´ì„œ ì ‘ì†ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>kubectl logs <span class="nt">-f</span> deploy-echo-5c689d5454-dxf2t | <span class="nb">grep </span>HTTP
  <span class="c"># =&gt; ::ffff:172.23.0.3 - - [01/Sep/2024:05:28:36 +0000] "GET / HTTP/1.1" 200 398 "-" "curl/7.88.1"</span>
  <span class="c">#    ::ffff:172.23.0.3 - - [01/Sep/2024:05:28:36 +0000] "GET / HTTP/1.1" 200 398 "-" "curl/7.88.1"</span>
  <span class="c">#    ::ffff:172.23.0.3 - - [01/Sep/2024:05:28:36 +0000] "GET / HTTP/1.1" 200 398 "-" "curl/7.88.1"</span>
  <span class="c">#    ::ffff:172.23.0.3 - - [01/Sep/2024:05:28:36 +0000] "GET / HTTP/1.1" 200 398 "-" "curl/7.88.1"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>2.4.  IPTABLES ì •ì±… í™•ì¸
    <ul>
      <li>
        <p>iptables ì •ì±… ì ìš© ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_25.png" alt="img.png" /></p>

        <ul>
          <li>PREROUTING â†’ KUBE-SERVICES â†’ KUBE-NODEPORTS â†’ <strong>KUBE-EXT-#(MARK)</strong> â†’ KUBE-SVC-# â†’ KUBE-SEP-#  â‡’ KUBE-POSTROUTING (MASQUERADE) <strong>**</strong></li>
          <li><code class="language-plaintext highlighter-rouge">KUBE-EXT-#(MARK)</code> ê·œì¹™ ê³¼ì •ì´ ì¶”ê°€ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ê¸°ë³¸ ê·œì¹™ì€ ClusterIP ì„œë¹„ìŠ¤ ë™ì‘ ê·œì¹™ê³¼ ê±°ì˜ ê°™ìœ¼ë©° ì°¨ì´ì ì€ KUBE-NODEPORTS, KUBE-MARK-MASK, KUBE-POSTROUTING ì²´ì¸ì´  ë‹¤ë¦…ë‹ˆë‹¤. í•µì‹¬ ë‚´ìš©ì€ NodePortì— ë§¤ì¹­ì‹œ ë§ˆí‚¹ í›„ ì¶œë°œì§€ IPë¥¼ í•´ë‹¹ ë…¸ë“œì— ìˆëŠ” ë„¤íŠ¸ì›Œí¬ IPë¡œ ë³€í™˜(MASQUERADE : SNAT)í•˜ì—¬ ëª©ì ì§€ íŒŒë“œë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
      <li>
        <p>ì‹¤ìŠµì„ í†µí•´ iptables ì •ì±…ì— ëŒ€í•´ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.  ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ ì‹¤ìŠµì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
  <span class="nt">----------------------------------------</span>
      
  <span class="c"># íŒ¨í‚· ì¹´ìš´íŠ¸ ì´ˆê¸°í™”</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">--zero</span>
      
  <span class="c"># PREROUTING ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>PREROUTING
  <span class="c"># =&gt; -P PREROUTING ACCEPT</span>
  <span class="c">#    -A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES</span>
  <span class="c">#    -A PREROUTING -d 172.23.0.1/32 -j DOCKER_OUTPUT</span>
      
  <span class="c"># ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ê°€ ë…¸ë“œIP:NodePort ë¡œ ì ‘ì†í•˜ê¸° ë•Œë¬¸ì— --dst-type LOCAL ì— ë§¤ì¹­ë˜ì–´ì„œ -j KUBE-NODEPORTS ë¡œ ì í”„!</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>KUBE-SERVICES
  <span class="c"># =&gt; ...</span>
  <span class="c">#    -A KUBE-SERVICES -m comment --comment "kubernetes service nodeports; NOTE: this must be the last rule in this chain" -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS</span>
      
  <span class="c"># KUBE-NODEPORTS ì—ì„œ KUBE-EXT-# ë¡œ ì í”„!</span>
  <span class="c">## -m nfacct --nfacct-name localhost_nps_accepted_pkts ì¶”ê°€ë¨ : íŒ¨í‚· flow ì¹´ìš´íŒ… - ì¹´ìš´íŠ¸ ì´ë¦„ ì§€ì • </span>
  <span class="nv">$ NPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NPORT</span>
  <span class="c"># =&gt; 31791</span>
      
  <span class="c"># $ iptables -t nat -S | grep KUBE-NODEPORTS | grep &lt;NodePort&gt;</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>KUBE-NODEPORTS | <span class="nb">grep</span> <span class="nv">$NPORT</span>
  <span class="c"># =&gt; -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
      
  <span class="c"># (ì°¸ê³ ) nfacct í™•ì¸</span>
  <span class="nv">$ </span>nfacct list
  <span class="c">## nfacct flush # ì´ˆê¸°í™”</span>
      
  <span class="c">## KUBE-EXT-# ì—ì„œ 'KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000' ë§ˆí‚¹ ë° KUBE-SVC-# ë¡œ ì í”„!</span>
  <span class="c"># docker exec -it mypc zsh -c "while true; do curl -s --connect-timeout 1 $CNODE:$NPORT | grep hostname; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done" ë°˜ë³µ ì ‘ì† í›„ ì•„ë˜ í™•ì¸</span>
  <span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -v --numeric --table nat --list KUBE-EXT-VTR7MTHHNMFZ3OFS'</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s2">"A KUBE-EXT-VTR7MTHHNMFZ3OFS"</span>
  <span class="c"># =&gt; -A KUBE-EXT-VTR7MTHHNMFZ3OFS -m comment --comment "masquerade traffic for default/svc-nodeport:svc-webport external destinations" -j KUBE-MARK-MASQ</span>
  <span class="c">#    -A KUBE-EXT-VTR7MTHHNMFZ3OFS -j KUBE-SVC-VTR7MTHHNMFZ3OFS</span>
      
  <span class="c"># iptables -t nat -S | grep "A KUBE-MARK-MASQ" | sed -e 's/^/#    /' -e '1s/^#    /# =&gt; /'</span>
  <span class="c"># =&gt; -A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000        # 0x4000/0x4000ìœ¼ë¡œ ë§ˆí‚¹í•˜ëŠ” ë£°</span>
      
  <span class="c"># KUBE-SVC-# ì´í›„ ê³¼ì •ì€ Cluster-IP ì™€ ë™ì¼! : 3ê°œì˜ íŒŒë“œë¡œ DNAT ë˜ì–´ì„œ ì „ë‹¬</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s2">"A KUBE-SVC-VTR7MTHHNMFZ3OFS -"</span>
  <span class="c"># =&gt; -A KUBE-SVC-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.1.5:8080" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-SESYGQFRQSLJQZ6Q</span>
  <span class="c">#    -A KUBE-SVC-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.2.7:8080" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-FBJG45W6XHLV2NA6</span>
  <span class="c">#    -A KUBE-SVC-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.4.4:8080" -j KUBE-SEP-GEQNJ6BO5AOHB6LH</span>
      
  <span class="c"># POSTROUTING ì •ë³´ í™•ì¸</span>
  <span class="c"># ë§ˆí‚¹ë˜ì–´ ìˆì–´ì„œ ì¶œë°œì§€IPë¥¼ ì ‘ì†í•œ ë…¸ë“œì˜ IP ë¡œ SNAT(MASQUERADE) ì²˜ë¦¬í•¨! , ìµœì´ˆ ì¶œë°œì§€PortëŠ” ëœë¤Port ë¡œ ë³€ê²½</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s2">"A KUBE-POSTROUTING"</span>
  <span class="c"># =&gt; -A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN   # 0x4000/0x4000 ë˜ì–´ ìˆìœ¼ë‹ˆ ì—¬ê¸°ì— ë§¤ì¹­ë˜ì§€ ì•Šê³  ì•„ë˜ Ruleë¡œ ë‚´ë ¤ê°</span>
  <span class="c">#    -A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0</span>
  <span class="c">#    -A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -j MASQUERADE --random-fully</span>
      
  <span class="c"># docker exec -it mypc zsh -c "while true; do curl -s --connect-timeout 1 $CNODE:$NPORT | grep hostname; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done" ë°˜ë³µ ì ‘ì† í›„ ì•„ë˜ í™•ì¸</span>
  <span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -v --numeric --table nat --list KUBE-POSTROUTING;echo;iptables -v --numeric --table nat --list POSTROUTING'</span>
      
  <span class="nv">$ </span><span class="nb">exit</span>
  <span class="nt">----------------------------------------</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì„œë¹„ìŠ¤ (NodePort) ìƒì„± ì‹œ kube-proxyì— ì˜í•´ì„œ iptables ê·œì¹™ì´ ëª¨ë“  ë…¸ë“œì— ì¶”ê°€ë˜ëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c">#</span>
  <span class="nv">$ NPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NPORT</span> 
  <span class="c"># =&gt; 31791</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>KUBE-NODEPORTS | <span class="nb">grep</span> <span class="nv">$NPORT</span>
  <span class="c"># =&gt; -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>KUBE-NODEPORTS | <span class="nb">grep</span> <span class="nv">$NPORT</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
  <span class="c">#    -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
  <span class="c">#    -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
  <span class="c">#    -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
  <span class="c">#    -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
</code></pre></div>        </div>
      </li>
      <li>iptables ë£°ì´ ëª¨ë“  ë…¸ë“œì— ì¶”ê°€ë˜ì–´ìˆìŒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>2.5. externalTrafficPolicy  ì„¤ì •
    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> : ì•ì—ì„œ ì‹¤ìŠµí•œ ë°”ì™€ê°™ì´ ì„œë¹„ìŠ¤ê°€ ë°”ë¼ë³´ëŠ” íŒŒë“œì— ì ‘ì†ì‹œ í´ë¼ì´ì–¸íŠ¸ IPê°€ nodeì˜ IPë¡œ ì ‘ì†ë©ë‹ˆë‹¤. ì´ë•Œ <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> ë¥¼ í•˜ë©´ <strong>í•´ë‹¹ ë…¸ë“œì— ë°°ì¹˜ëœ íŒŒë“œë¡œë§Œ ì ‘ì†ë˜ë©´ì„œ</strong>, SNATê°€ ë˜ì§€ì•Šì•„ <strong>ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ IPê°€ ë³´ì¡´</strong>ë©ë‹ˆë‹¤.</p>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_26.png" alt="img.png" /></p>

        <ul>
          <li>ì´ì „ê¹Œì§€ëŠ” ê°™ì€ iptables ë£°ì´ ëª¨ë“  ë…¸ë“œì— ì ìš© ë˜ì—ˆì§€ë§Œ, ë…¸ë“œ ìì‹ ì˜ íŒŒë“œë¡œë§Œ ê°€ëŠ” ë£°ë§Œ ìˆì–´ì„œ ê°ê° ì¡°ê¸ˆì”© ë‹¤ë¥¸ ë£°ì´ ì ìš©ë˜ê²Œ ë©ë‹ˆë‹¤.</li>
        </ul>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_27.png" alt="img.png" /></p>

        <ul>
          <li>ë§Œì•½ ë…¸ë“œì— í•´ë‹¹í•˜ëŠ” íŒŒë“œê°€ ì—†ìœ¼ë©´ ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ ì—°ê²°ì´ ì‹¤íŒ¨í•˜ê²Œë˜ë‹ˆ ì‚¬ìš©ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> ì„¤ì • ì‹œì˜ í†µì‹  íë¦„ì„ ì¢€ ë” ìì„¸íˆ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_28.png" alt="img.png" /></p>

        <ul>
          <li>í´ë¼ì´ì–¸íŠ¸ì—ì„œ íŒŒë“œê°€ ë°°í¬ë˜ì–´ìˆëŠ” ì›Œì»¤ë…¸ë“œ1ì— NodePortë¡œ ì ‘ì†í•©ë‹ˆë‹¤.</li>
          <li>ì›Œì»¤ë…¸ë“œ1ì˜ IPTABLESì˜ nat í…Œì´ë¸” ê·œì¹™ê³¼ ë§¤ì¹­ë˜ì–´ ëª©ì ì§€ IPì™€ ëª©ì ì§€ PortëŠ” ë³€í™˜ ë˜ì§€ë§Œ, SNAT ë˜ì§€ ì•Šê³  ë°”ë¡œ íŒŒë“œë¡œ ì „ë‹¬ë˜ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ì˜ IPê°€ íŒŒë“œì— ê·¸ëŒ€ë¡œ ì „ë‹¬ ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>
        <p>ì„¤ì • ë° íŒŒë“œ ì ‘ì† í™•ì¸</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># ê¸°ë³¸ ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>kubectl get svc svc-nodeport <span class="nt">-o</span> json | <span class="nb">grep</span> <span class="s1">'TrafficPolicy"'</span>
  <span class="c"># =&gt;         "externalTrafficPolicy": "Cluster",</span>
  <span class="c">#            "internalTrafficPolicy": "Cluster",</span>
      
  <span class="c"># ê¸°ì¡´ í†µì‹  ì—°ê²° ì •ë³´(conntrack) ì œê±° í›„ ì•„ë˜ ì‹¤ìŠµ ì§„í–‰í•˜ì! : (ëª¨ë“  ë…¸ë“œì—ì„œ) conntrack -F</span>
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> conntrack <span class="nt">-F</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
  <span class="c">#    conntrack v1.4.7 (conntrack-tools): connection tracking table has been emptied.</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
  <span class="c">#    conntrack v1.4.7 (conntrack-tools): connection tracking table has been emptied.</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
  <span class="c">#    conntrack v1.4.7 (conntrack-tools): connection tracking table has been emptied.</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
  <span class="c">#    conntrack v1.4.7 (conntrack-tools): connection tracking table has been emptied.</span>
  <span class="c">#    </span>
  <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> svc-nodeport.yml
  <span class="c"># =&gt; service "svc-nodeport" deleted</span>
  <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> svc-nodeport.yml
  <span class="c"># =&gt; service/svc-nodeport created</span>
      
  <span class="c"># externalTrafficPolicy: local ì„¤ì • ë³€ê²½</span>
  <span class="nv">$ </span>kubectl patch svc svc-nodeport <span class="nt">-p</span> <span class="s1">'{"spec":{"externalTrafficPolicy": "Local"}}'</span>
  <span class="c"># =&gt; service/svc-nodeport patched</span>
  <span class="nv">$ </span>kubectl get svc svc-nodeport <span class="nt">-o</span> json | <span class="nb">grep</span> <span class="s1">'TrafficPolicy"'</span>
  <span class="c"># =&gt;         "externalTrafficPolicy": "Local",</span>
  <span class="c">#            "internalTrafficPolicy": "Cluster",</span>
      
  <span class="c"># íŒŒë“œ 3ê°œë¥¼ 2ê°œë¡œ ì¤„ì…ë‹ˆë‹¤.</span>
  <span class="nv">$ </span>kubectl scale deployment deploy-echo <span class="nt">--replicas</span><span class="o">=</span>2
  <span class="c"># =&gt; deployment.apps/deploy-echo scaled</span>
</code></pre></div>        </div>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_29.png" alt="img.png" /></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># íŒŒë“œ ì¡´ì¬í•˜ëŠ” ë…¸ë“œ ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
  <span class="c"># =&gt; NAME                           READY   STATUS    RESTARTS   AGE   IP          NODE                  NOMINATED NODE   READINESS GATES</span>
  <span class="c">#    deploy-echo-5c689d5454-24cql   1/1     Running   0          30s   10.10.4.5   myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    deploy-echo-5c689d5454-2kgfj   1/1     Running   0          30s   10.10.1.6   myk8s-worker2         &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    net-pod                        1/1     Running   0          46h   10.10.0.7   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
      
  <span class="c"># íŒŒë“œ ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸ (ì›¹ íŒŒë“œì— ì ‘ì†ìì˜ IPê°€ ì¶œë ¥)</span>
  <span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>deploy-websrv <span class="nt">-f</span>
      
  <span class="c"># ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸(mypc)ì—ì„œ ì ‘ì† ì‹œë„</span>
      
  <span class="c"># ë…¸ë“œì˜ IPì™€ NodePortë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
  <span class="c">## CNODE=&lt;ì»¨íŠ¸ë¡¤í”Œë ˆì¸ë…¸ë“œì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE1=&lt;ë…¸ë“œ1ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE2=&lt;ë…¸ë“œ2ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE3=&lt;ë…¸ë“œ3ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="nv">$ CNODE</span><span class="o">=</span>172.23.0.2
  <span class="nv">$ NODE1</span><span class="o">=</span>172.23.0.4
  <span class="nv">$ NODE2</span><span class="o">=</span>172.23.0.5
  <span class="nv">$ NODE3</span><span class="o">=</span>172.23.0.3
      
  <span class="c">## NodePort ë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
  <span class="nv">$ NPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NPORT</span>
  <span class="c"># =&gt; 31177</span>
      
  <span class="c"># ì„œë¹„ìŠ¤(NodePort) ë¶€í•˜ë¶„ì‚° ì ‘ì† í™•ì¸ : íŒŒë“œê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë…¸ë“œë¡œëŠ” ì ‘ì† ì‹¤íŒ¨!, íŒŒë“œê°€ ì¡´ì¬í•˜ëŠ” ë…¸ë“œëŠ” ì ‘ì† ì„±ê³µ ë° í´ë¼ì´ì–¸íŠ¸ IP í™•ì¸!</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$CNODE</span>:<span class="nv">$NPORT</span> | jq
  <span class="c"># =&gt; (ê³µë°±)</span>
  <span class="c"># ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ëŠ” íŒŒë“œê°€ ì—†ìœ¼ë¯€ë¡œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$CNODE</span> <span class="nv">$NODE1</span> <span class="nv">$NODE2</span> <span class="nv">$NODE3</span> <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$i</span>:<span class="nv">$NPORT</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node 172.23.0.2 &lt;&lt;</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node 172.23.0.4 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "path": "/",</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.4:31177",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
  <span class="c">#      ...</span>
  <span class="c">#      "hostname": "172.23.0.4",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.6",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-24cql"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.5 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.5:31177",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
      
  <span class="c">#      "hostname": "172.23.0.5",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.6",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-2kgfj"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.3 &lt;&lt;</span>
  <span class="c">#    </span>
      
  <span class="c"># ëª©ì ì§€ íŒŒë“œê°€ ë°°ì¹˜ë˜ì§€ ì•Šì€ ë…¸ë“œëŠ” ì ‘ì†ì´ ì–´ë–»ê²Œ? ì™œ ê·¸ëŸ°ê°€?</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$CNODE</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt; </span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$NODE1</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.4",</span>
  <span class="c">#        100     "hostname": "deploy-echo-5c689d5454-24cql"</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$NODE2</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.5",</span>
  <span class="c">#        100     "hostname": "deploy-echo-5c689d5454-2kgfj"</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$NODE3</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt; </span>
  <span class="c"># ëª©ì ì§€ íŒŒë“œê°€ ë°°ì¹˜ë˜ì§€ ì•Šì€ ë…¸ë“œëŠ” ì‘ë‹µì´ ì—†ì–´ íƒ€ì„ì•„ì›ƒì´ ë©ë‹ˆë‹¤. ê·¸ ì´ìœ ëŠ” externalTrafficPolicy: Localì—¬ì„œ ë…¸ë“œí¬íŠ¸ë¡œ ì˜¨ íŒ¨í‚·ì´, local podë¡œ ì „ë‹¬í•˜ë ¤ê³  í•˜ëŠ”ë°</span>
  <span class="c"># local podê°€ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</span>
      
  <span class="c"># ì•„ë˜ ë°˜ë³µ ì ‘ì† ì‹¤í–‰ í•´ë‘ì</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$NODE2</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>
      
  <span class="c"># (ì˜µì…˜) ë…¸ë“œì—ì„œ Network Connection</span>
  <span class="nv">$ </span>conntrack <span class="nt">-E</span>
  <span class="nv">$ </span>conntrack <span class="nt">-L</span> <span class="nt">--any-nat</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ â†’ ê°ê° ì›Œì»¤ ë…¸ë“œ 1,2 ì ‘ì†ì‹œ ê°ê° ë…¸ë“œì˜ íŒŒë“œë¡œë§Œ ì ‘ì† ë©ë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># í˜¸ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰</span>
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$CNODE</span> <span class="nv">$NODE1</span> <span class="nv">$NODE2</span> <span class="nv">$NODE3</span> <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$i</span>:<span class="nv">$NPORT</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node 172.23.0.2 &lt;&lt;</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node 172.23.0.4 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.4:31177",</span>
  <span class="c">#      },</span>
  <span class="c">#      "hostname": "172.23.0.4",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.1",</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-24cql"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.5 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.5:31177",</span>
  <span class="c">#      },</span>
  <span class="c">#      "hostname": "172.23.0.5",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.1",</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-2kgfj"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.3 &lt;&lt;    </span>
    
  <span class="c"># ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ë¡œê·¸ í‘œì‹œ</span>
  <span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>deploy-websrv <span class="nt">-f</span> | <span class="nb">grep </span>HTTP
  ::ffff:172.23.0.1 - - <span class="o">[</span>26/Sep/2024:07:33:09 +0000] <span class="s2">"GET / HTTP/1.1"</span> 200 397 <span class="s2">"-"</span> <span class="s2">"curl/8.7.1"</span>
  ::ffff:172.23.0.1 - - <span class="o">[</span>26/Sep/2024:07:33:10 +0000] <span class="s2">"GET / HTTP/1.1"</span> 200 397 <span class="s2">"-"</span> <span class="s2">"curl/8.7.1"</span>
  ::ffff:172.23.0.1 - - <span class="o">[</span>26/Sep/2024:07:33:26 +0000] <span class="s2">"GET / HTTP/1.1"</span> 200 397 <span class="s2">"-"</span> <span class="s2">"curl/8.7.1"</span>
  ::ffff:172.23.0.1 - - <span class="o">[</span>26/Sep/2024:07:33:26 +0000] <span class="s2">"GET / HTTP/1.1"</span> 200 397 <span class="s2">"-"</span> <span class="s2">"curl/8.7.1"</span>
</code></pre></div>        </div>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">kubectl logs -l app=deploy-websrv -f</code>ë¡œ í™•ì¸ì‹œ ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ì¸ 172.23.0.1ì´ ë³´ì¡´ë˜ëŠ” ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ì´ë ‡ê²Œ ë™ì‘í•˜ëŠ” ì´ìœ ë¥¼ iptables ë£°ì„ í†µí•´ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œ - iptables ë¶„ì„ &lt;&lt; ì •ì±… í™•ì¸ : ì•„ë˜ ì •ì±… ë‚´ìš©ì€ í•µì‹¬ì ì¸ ë£°(rule)ë§Œ í‘œì‹œí–ˆìŠµë‹ˆë‹¤!</span>
<span class="c"># (ì˜ˆì‹œ) íŒŒë“œê°€ ë°°í¬ë˜ì–´ ìˆëŠ” ë…¸ë“œ1ì—ì„œ í™•ì¸í–ˆìŠµë‹ˆë‹¤</span>
    
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="nt">---------------------------------------</span>
    
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="c"># $ iptables -t nat -S | grep &lt;NodePort&gt;</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>31177
<span class="c"># =&gt; -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31177 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
    
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A KUBE-EXT-VTR7MTHHNMFZ3OFS'</span>
<span class="c"># =&gt; -A KUBE-EXT-VTR7MTHHNMFZ3OFS -s 10.10.0.0/16 -m comment --comment "pod traffic for default/svc-nodeport:svc-webport external destinations" -j KUBE-SVC-VTR7MTHHNMFZ3OFS</span>
<span class="c">#    -A KUBE-EXT-VTR7MTHHNMFZ3OFS -m comment --comment "masquerade LOCAL traffic for default/svc-nodeport:svc-webport external destinations" -m addrtype --src-type LOCAL -j KUBE-MARK-MASQ</span>
<span class="c">#    -A KUBE-EXT-VTR7MTHHNMFZ3OFS -m comment --comment "route LOCAL traffic for default/svc-nodeport:svc-webport external destinations" -m addrtype --src-type LOCAL -j KUBE-SVC-VTR7MTHHNMFZ3OFS</span>
<span class="c">#    -A KUBE-EXT-VTR7MTHHNMFZ3OFS -j KUBE-SVL-VTR7MTHHNMFZ3OFS</span>
    
<span class="c"># ì‹¤ìŠµ í™˜ê²½ì—ì„œëŠ” ì•„ë˜ì²˜ëŸ¼ 2ê°œì˜ íŒŒë“œ ì¤‘ ìì‹ ì˜ ë…¸ë“œì— ìƒì„±ëœ íŒŒë“œ 1ê°œë§Œ DNAT ì—°ê²°ë¨</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A KUBE-SVL-VTR7MTHHNMFZ3OFS'</span>
<span class="c"># =&gt; -A KUBE-SVL-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.4.5:8080" -j KUBE-SEP-COBCKEECYTEF2ZXK</span>
    
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A KUBE-SEP-COBCKEECYTEF2ZXK'</span>
<span class="c"># =&gt; -A KUBE-SEP-COBCKEECYTEF2ZXK -s 10.10.4.5/32 -m comment --comment "default/svc-nodeport:svc-webport" -j KUBE-MARK-MASQ</span>
<span class="c">#    -A KUBE-SEP-COBCKEECYTEF2ZXK -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp -j DNAT --to-destination 10.10.4.5:8080</span>
    
<span class="nv">$ </span><span class="nb">exit</span>
<span class="c"># ---------------------------------------</span>
</code></pre></div>        </div>
        <ul>
          <li>ì •ì±…ì„ í™•ì¸í•´ë³´ë©´ <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> ì„¤ì • ì „ì—ëŠ” MASQUERADEë¡œ SNAT ë˜ì—ˆì§€ë§Œ, ì„¤ì • í›„ì—ëŠ” DNATìœ¼ë¡œ ë°”ë¡œ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>SNAT ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— í´ë¼ì´ì–¸íŠ¸ì˜ IPê°€ ê·¸ëŒ€ë¡œ ì „ë‹¬ë˜ì–´ íŒŒë“œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ì„œë¹„ìŠ¤(NodePort, externalTrafficPolicy: Local) ìƒì„± ì‹œ iptables ê·œì¹™(KUBE-SVL-#)ì´ ëª¨ë“  ë…¸ë“œì— ì¶”ê°€ë˜ëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ëŠ” íŒŒë“œê°€ ì—†ìœ¼ë¯€ë¡œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A KUBE-SVL-VTR7MTHHNMFZ3OFS'</span>
<span class="c"># =&gt; (ê³µë°±)</span>
    
<span class="c"># ê° ë…¸ë“œì— í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A KUBE-SVL-VTR7MTHHNMFZ3OFS'</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
<span class="c">#    -A KUBE-SVL-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.4.5:8080" -j KUBE-SEP-COBCKEECYTEF2ZXK</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
<span class="c">#    -A KUBE-SVL-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.1.6:8080" -j KUBE-SEP-ABUS75FNO53OAK6G</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
</code></pre></div>        </div>
        <ul>
          <li>íŒŒë“œê°€ ìˆëŠ” worker, worker2 ë…¸ë“œì—ë§Œ iptables ê·œì¹™ì´ ì¶”ê°€ë˜ì–´ ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>NodePortì˜ ë¶€ì¡±í•œ ì 
        <ul>
          <li>ì™¸ë¶€ì—ì„œ ë…¸ë“œì˜ IPì™€ í¬íŠ¸ë¡œ ì§ì ‘ ì ‘ì†ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
          <li>ë”°ë¼ì„œ ë‚´ë¶€ë§ì´ ì™¸ë¶€ì— ê³µê°œ(ë¼ìš°íŒ… ê°€ëŠ¥)ë˜ì–´ ë³´ì•ˆì— ì·¨ì•½í•©ë‹ˆë‹¤.
            <ul>
              <li>=&gt; <strong>LoadBalancer ì„œë¹„ìŠ¤</strong> íƒ€ì…ìœ¼ë¡œ ì™¸ë¶€ ê³µê°œ ìµœì†Œí™” ê°€ëŠ¥</li>
            </ul>
          </li>
          <li>í´ë¼ì´ì–¸íŠ¸ IP ë³´ì¡´ì„ ìœ„í•´ì„œ, <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: local</code>ë¥¼ ì‚¬ìš©í•˜ë©´ íŒŒë“œê°€ ì—†ëŠ” ë…¸ë“œ IPë¡œ NodePort ì ‘ì† ì‹œ ì‹¤íŒ¨í•˜ê²Œ ë©ë‹ˆë‹¤.
            <ul>
              <li>=&gt; <strong>LoadBalancer ì„œë¹„ìŠ¤</strong>ì—ì„œ í—¬ìŠ¤ì²´í¬(Probe) ë¡œ ëŒ€ì‘ ê°€ëŠ¥</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="íŒŒë“œê°„-ì†ë„-ì¸¡ì •">íŒŒë“œê°„ ì†ë„ ì¸¡ì •</h4>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” iperf3ë¥¼ ì‚¬ìš©í•´ì„œ íŒŒë“œê°„ ì†ë„ë¥¼ ì¸¡ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>iperf3ëŠ” ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ì„ ì¸¡ì •í•˜ëŠ” ë„êµ¬ë¡œ, ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ë¡œ ë‚˜ë‰˜ì–´ ì„œë²„ëŠ” ëŒ€ì—­í­ì„ ì œê³µí•˜ê³  í´ë¼ì´ì–¸íŠ¸ëŠ” ëŒ€ì—­í­ì„ ì¸¡ì •í•©ë‹ˆë‹¤. TCPì™€ UDP, SCTPë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
  <li>iperf3ì˜ ê¸°ë³¸ ì‚¬ìš©ë²•ì„ ì‚´í´ ë³´ê² ìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># iperf3 ì„¤ì¹˜ </span>
<span class="c"># macOS ì¸ ê²½ìš°</span>
<span class="nv">$ </span>brew <span class="nb">install </span>iperf3
<span class="c"># ubuntu ë“± debian ê³„ì—´ì¸ ê²½ìš° </span>
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>iperf3 <span class="nt">-y</span>
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 1 : TCP 5201, ì¸¡ì •ì‹œê°„ 10ì´ˆ</span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> <span class="c"># ì„œë²„ëª¨ë“œ ì‹¤í–‰</span>
<span class="c"># =&gt; -----------------------------------------------------------</span>
<span class="c">#    Server listening on 5201</span>
<span class="c">#    -----------------------------------------------------------</span>
<span class="c">#    Accepted connection from 127.0.0.1, port 40142</span>
<span class="c">#    [  5] local 127.0.0.1 port 5201 connected to 127.0.0.1 port 40154</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-1.00   sec  7.11 GBytes  61.1 Gbits/sec</span>
<span class="c">#    [  5]   1.00-2.00   sec  8.03 GBytes  68.9 Gbits/sec</span>
<span class="c">#    [  5]   2.00-3.00   sec  7.53 GBytes  64.7 Gbits/sec</span>
<span class="c">#    [  5]   3.00-4.00   sec  7.73 GBytes  66.4 Gbits/sec</span>
<span class="c">#    [  5]   4.00-5.00   sec  7.64 GBytes  65.6 Gbits/sec</span>
<span class="c">#    [  5]   5.00-6.00   sec  7.89 GBytes  67.8 Gbits/sec</span>
<span class="c">#    [  5]   6.00-7.00   sec  7.95 GBytes  68.3 Gbits/sec</span>
<span class="c">#    [  5]   7.00-8.00   sec  7.78 GBytes  66.9 Gbits/sec</span>
<span class="c">#    [  5]   8.00-9.00   sec  7.91 GBytes  67.9 Gbits/sec</span>
<span class="c">#    [  5]   9.00-10.00  sec  7.64 GBytes  65.6 Gbits/sec</span>
<span class="c">#    [  5]  10.00-10.05  sec   384 MBytes  66.0 Gbits/sec</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-10.05  sec  77.6 GBytes  66.3 Gbits/sec                  receiver</span>
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="c"># ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ëª¨ë“œ ì‹¤í–‰</span>
<span class="c"># =&gt; Connecting to host 127.0.0.1, port 5201</span>
<span class="c">#    [  5] local 127.0.0.1 port 40154 connected to 127.0.0.1 port 5201</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5]   0.00-1.00   sec  7.48 GBytes  64.2 Gbits/sec    8   2.69 MBytes</span>
<span class="c">#    ...</span>
<span class="c">#    [  5]   9.00-10.00  sec  7.72 GBytes  66.3 Gbits/sec    1   3.06 MBytes</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5]   0.00-10.00  sec  77.6 GBytes  66.6 Gbits/sec   53             sender</span>
<span class="c">#    [  5]   0.00-10.05  sec  77.6 GBytes  66.3 Gbits/sec                  receiver</span>
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 2 : TCP 80, ì¸¡ì •ì‹œê°„ 5ì´ˆ</span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> <span class="nt">-p</span> 80
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="nt">-p</span> 80 <span class="nt">-t</span> 5
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 3 : UDP ì‚¬ìš©, ì—­ë°©í–¥ ëª¨ë“œ(-R)</span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> 
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="nt">-u</span> <span class="nt">-b</span> 100G
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 4 : ì—­ë°©í–¥ ëª¨ë“œ(-R) =&gt; ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ì†¡í• ë•Œ ì†ë„ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.  </span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> 
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="nt">-R</span>
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 5 : ìŒë°©í–¥ ëª¨ë“œ(-R)</span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> 
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="nt">--bidir</span>
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 6 : TCP ë‹¤ì¤‘ ìŠ¤íŠ¸ë¦¼(30ê°œ), -P(number of parallel client streams to run)</span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> 
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="nt">-P</span> 2 <span class="nt">-t</span> 30
</code></pre></div>    </div>
  </li>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì—ì„œ ì†ë„ ì¸¡ì • í…ŒìŠ¤íŠ¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>í…ŒìŠ¤íŠ¸ í™˜ê²½ ë°°í¬
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/gasida/PKOS/main/aews/k8s-iperf3.yaml
    
<span class="c"># í™•ì¸ : ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°€ ë‹¤ë¥¸ ì›Œì»¤ë…¸ë“œì— ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS      IMAGES                    SELECTOR</span>
<span class="c">#    deployment.apps/iperf3-client   0/1     1            0           5s    iperf3-client   networkstatic/iperf3      app=iperf3-client</span>
<span class="c">#    deployment.apps/iperf3-server   0/1     1            0           5s    iperf3-server   networkstatic/iperf3      app=iperf3-server</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE    SELECTOR</span>
<span class="c">#    service/iperf3-server   ClusterIP   10.200.1.166   &lt;none&gt;        5201/TCP,5201/UDP   5s     app=iperf3-server</span>
<span class="c">#    </span>
<span class="c">#    NAME                                 READY   STATUS              RESTARTS   AGE    IP          NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/iperf3-client-598b85fd6b-tq5xg   0/1     ContainerCreating   0          5s     &lt;none&gt;      myk8s-worker3         &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    pod/iperf3-server-688df6d56f-hlhrm   0/1     ContainerCreating   0          5s     &lt;none&gt;      myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
    
<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
</code></pre></div>        </div>
      </li>
      <li>TCP 5201, ì¸¡ì •ì‹œê°„ 5ì´ˆ
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-t</span> 5
<span class="c"># =&gt; Connecting to host iperf3-server, port 5201</span>
<span class="c">#    [  5] local 10.10.2.9 port 54972 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5]   0.00-1.00   sec  4.68 GBytes  40.2 Gbits/sec  3333   1.07 MBytes</span>
<span class="c">#    [  5]   1.00-2.00   sec  4.87 GBytes  41.8 Gbits/sec  1293   1.09 MBytes</span>
<span class="c">#    [  5]   2.00-3.00   sec  4.86 GBytes  41.8 Gbits/sec  1020   1.11 MBytes</span>
<span class="c">#    [  5]   3.00-4.00   sec  4.85 GBytes  41.7 Gbits/sec  590   1.21 MBytes</span>
<span class="c">#    [  5]   4.00-5.00   sec  4.93 GBytes  42.4 Gbits/sec  988   1.27 MBytes</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5]   0.00-5.00   sec  24.2 GBytes  41.6 Gbits/sec  7224             sender</span>
<span class="c">#    [  5]   0.00-5.00   sec  24.2 GBytes  41.6 Gbits/sec                  receiver</span>
    
<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
<span class="c"># =&gt; -----------------------------------------------------------</span>
<span class="c">#    Server listening on 5201 (test #1)</span>
<span class="c">#    -----------------------------------------------------------</span>
<span class="c">#    Accepted connection from 10.10.2.9, port 54962</span>
<span class="c">#    [  5] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 54972</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-1.00   sec  4.67 GBytes  40.1 Gbits/sec</span>
<span class="c">#    [  5]   1.00-2.00   sec  4.87 GBytes  41.8 Gbits/sec</span>
<span class="c">#    [  5]   2.00-3.00   sec  4.86 GBytes  41.8 Gbits/sec</span>
<span class="c">#    [  5]   3.00-4.00   sec  4.85 GBytes  41.7 Gbits/sec</span>
<span class="c">#    [  5]   4.00-5.00   sec  4.93 GBytes  42.4 Gbits/sec</span>
<span class="c">#    [  5]   5.00-5.00   sec   384 KBytes  41.4 Gbits/sec</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-5.00   sec  24.2 GBytes  41.6 Gbits/sec                  receiver</span>
</code></pre></div>        </div>
      </li>
      <li>UDP ì‚¬ìš©, ì—­ë°©í–¥ ëª¨ë“œ(-R)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-u</span> <span class="nt">-b</span> 20G
<span class="c"># =&gt; Connecting to host iperf3-server, port 5201</span>
<span class="c">#    [  5] local 10.10.2.9 port 41928 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Total Datagrams</span>
<span class="c">#    [  5]   0.00-1.00   sec   161 MBytes  1.35 Gbits/sec  116453</span>
<span class="c">#    [  5]   1.00-2.00   sec   187 MBytes  1.57 Gbits/sec  135745</span>
<span class="c">#    [  5]   2.00-3.00   sec   163 MBytes  1.36 Gbits/sec  117693</span>
<span class="c">#    [  5]   3.00-4.00   sec   220 MBytes  1.84 Gbits/sec  159109</span>
<span class="c">#    [  5]   4.00-5.00   sec   168 MBytes  1.41 Gbits/sec  121705</span>
<span class="c">#    [  5]   5.00-6.00   sec   183 MBytes  1.54 Gbits/sec  132730</span>
<span class="c">#    [  5]   6.00-7.00   sec   184 MBytes  1.54 Gbits/sec  133267</span>
<span class="c">#    [  5]   7.00-8.00   sec   158 MBytes  1.32 Gbits/sec  114073</span>
<span class="c">#    [  5]   8.00-9.00   sec   171 MBytes  1.44 Gbits/sec  124005</span>
<span class="c">#    [  5]   9.00-10.00  sec   160 MBytes  1.35 Gbits/sec  116175</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams</span>
<span class="c">#    [  5]   0.00-10.00  sec  1.71 GBytes  1.47 Gbits/sec  0.000 ms  0/1270955 (0%)  sender</span>
<span class="c">#    [  5]   0.00-10.00  sec  1.68 GBytes  1.44 Gbits/sec  0.008 ms  28438/1270955 (2.2%)  receiver</span>
    
<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
<span class="c"># =&gt; -----------------------------------------------------------</span>
<span class="c">#    Server listening on 5201 (test #3)</span>
<span class="c">#    -----------------------------------------------------------</span>
<span class="c">#    Accepted connection from 10.10.2.9, port 48546</span>
<span class="c">#    [  5] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 41928</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams</span>
<span class="c">#    [  5]   0.00-1.00   sec   158 MBytes  1.33 Gbits/sec  0.011 ms  2000/116449 (1.7%)</span>
<span class="c">#    [  5]   1.00-2.00   sec   180 MBytes  1.51 Gbits/sec  0.009 ms  5401/135743 (4%)</span>
<span class="c">#    [  5]   2.00-3.00   sec   161 MBytes  1.35 Gbits/sec  0.011 ms  1241/117696 (1.1%)</span>
<span class="c">#    [  5]   3.00-4.00   sec   215 MBytes  1.81 Gbits/sec  0.009 ms  3132/159105 (2%)</span>
<span class="c">#    [  5]   4.00-5.00   sec   165 MBytes  1.39 Gbits/sec  0.007 ms  2073/121704 (1.7%)</span>
<span class="c">#    [  5]   5.00-6.00   sec   179 MBytes  1.51 Gbits/sec  0.008 ms  2758/132731 (2.1%)</span>
<span class="c">#    [  5]   6.00-7.00   sec   181 MBytes  1.52 Gbits/sec  0.009 ms  2397/133243 (1.8%)</span>
<span class="c">#    [  5]   7.00-8.00   sec   153 MBytes  1.28 Gbits/sec  0.007 ms  3612/114097 (3.2%)</span>
<span class="c">#    [  5]   8.00-9.00   sec   166 MBytes  1.39 Gbits/sec  0.009 ms  3707/124005 (3%)</span>
<span class="c">#    [  5]   9.00-10.00  sec   158 MBytes  1.32 Gbits/sec  0.009 ms  2117/116179 (1.8%)</span>
<span class="c">#    [  5]  10.00-10.00  sec  4.24 KBytes   656 Mbits/sec  0.008 ms  0/3 (0%)</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams</span>
<span class="c">#    [  5]   0.00-10.00  sec  1.68 GBytes  1.44 Gbits/sec  0.008 ms  28438/1270955 (2.2%)  receiver</span>
</code></pre></div>        </div>
      </li>
      <li>TCP, ìŒë°©í–¥ ëª¨ë“œ(-R)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-t</span> 5 <span class="nt">--bidir</span>
<span class="c"># =&gt; Connecting to host iperf3-server, port 5201</span>
<span class="c">#    [  5] local 10.10.2.9 port 59852 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [  7] local 10.10.2.9 port 59860 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [ ID][Role] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5][TX-C]   0.00-1.00   sec  3.85 GBytes  33.0 Gbits/sec  2249   1.55 MBytes</span>
<span class="c">#    [  7][RX-C]   0.00-1.00   sec   553 MBytes  4.64 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   1.00-2.00   sec  1.77 GBytes  15.2 Gbits/sec  3105   1.07 MBytes</span>
<span class="c">#    [  7][RX-C]   1.00-2.00   sec  2.73 GBytes  23.4 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   2.00-3.00   sec  1.64 GBytes  14.1 Gbits/sec  639    850 KBytes</span>
<span class="c">#    [  7][RX-C]   2.00-3.00   sec  2.93 GBytes  25.2 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   3.00-4.00   sec  2.07 GBytes  17.8 Gbits/sec    0    853 KBytes</span>
<span class="c">#    [  7][RX-C]   3.00-4.00   sec  2.48 GBytes  21.3 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   4.00-5.00   sec  1.22 GBytes  10.5 Gbits/sec    2    877 KBytes</span>
<span class="c">#    [  7][RX-C]   4.00-5.00   sec  3.25 GBytes  27.9 Gbits/sec</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID][Role] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5][TX-C]   0.00-5.00   sec  10.5 GBytes  18.1 Gbits/sec  5995             sender</span>
<span class="c">#    [  5][TX-C]   0.00-5.00   sec  10.5 GBytes  18.1 Gbits/sec                  receiver</span>
<span class="c">#    [  7][RX-C]   0.00-5.00   sec  11.9 GBytes  20.5 Gbits/sec  9201             sender</span>
<span class="c">#    [  7][RX-C]   0.00-5.00   sec  11.9 GBytes  20.5 Gbits/sec                  receiver</span>
    
<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
<span class="c"># =&gt; -----------------------------------------------------------</span>
<span class="c">#    Server listening on 5201 (test #2)</span>
<span class="c">#    -----------------------------------------------------------</span>
<span class="c">#    Accepted connection from 10.10.2.9, port 59836</span>
<span class="c">#    [  5] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 59852</span>
<span class="c">#    [  8] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 59860</span>
<span class="c">#    [ ID][Role] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5][RX-S]   0.00-1.00   sec  3.85 GBytes  33.0 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   0.00-1.00   sec   561 MBytes  4.70 Gbits/sec   59   1.02 MBytes</span>
<span class="c">#    [  5][RX-S]   1.00-2.00   sec  1.77 GBytes  15.2 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   1.00-2.00   sec  2.73 GBytes  23.5 Gbits/sec  2468   1.09 MBytes</span>
<span class="c">#    [  5][RX-S]   2.00-3.00   sec  1.63 GBytes  14.0 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   2.00-3.00   sec  2.92 GBytes  25.1 Gbits/sec  3327   1.10 MBytes</span>
<span class="c">#    [  5][RX-S]   3.00-4.00   sec  2.08 GBytes  17.9 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   3.00-4.00   sec  2.49 GBytes  21.4 Gbits/sec  2315   1.13 MBytes</span>
<span class="c">#    [  5][RX-S]   4.00-5.00   sec  1.22 GBytes  10.5 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   4.00-5.00   sec  3.25 GBytes  27.9 Gbits/sec  1032   1.16 MBytes</span>
<span class="c">#    [  5][RX-S]   5.00-5.00   sec   768 KBytes  27.6 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   5.00-5.00   sec  1.25 MBytes  41.3 Gbits/sec    0   1.16 MBytes</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID][Role] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5][RX-S]   0.00-5.00   sec  10.5 GBytes  18.1 Gbits/sec                  receiver</span>
<span class="c">#    [  8][TX-S]   0.00-5.00   sec  11.9 GBytes  20.5 Gbits/sec  9201             sender</span>
</code></pre></div>        </div>
      </li>
      <li>TCP ë‹¤ì¤‘ ìŠ¤íŠ¸ë¦¼(30ê°œ), -P(number of parallel client streams to run)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-t</span> 10 <span class="nt">-P</span> 2
<span class="c"># =&gt; [  5] local 10.10.2.9 port 41976 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [  7] local 10.10.2.9 port 41982 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5]   0.00-1.00   sec  2.87 GBytes  24.7 Gbits/sec  822    570 KBytes</span>
<span class="c">#    [  7]   0.00-1.00   sec  2.88 GBytes  24.7 Gbits/sec  159    576 KBytes</span>
<span class="c">#    [SUM]   0.00-1.00   sec  5.75 GBytes  49.4 Gbits/sec  981</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    ...</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5]   0.00-10.00  sec  29.2 GBytes  25.1 Gbits/sec  3825             sender</span>
<span class="c">#    [  5]   0.00-10.00  sec  29.2 GBytes  25.1 Gbits/sec                  receiver</span>
<span class="c">#    [  7]   0.00-10.00  sec  29.2 GBytes  25.1 Gbits/sec  2063             sender</span>
<span class="c">#    [  7]   0.00-10.00  sec  29.2 GBytes  25.0 Gbits/sec                  receiver</span>
<span class="c">#    [SUM]   0.00-10.00  sec  58.3 GBytes  50.1 Gbits/sec  5888             sender</span>
<span class="c">#    [SUM]   0.00-10.00  sec  58.3 GBytes  50.1 Gbits/sec                  receiver</span>
    
<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
<span class="c"># =&gt; -----------------------------------------------------------</span>
<span class="c">#    Server listening on 5201 (test #4)</span>
<span class="c">#    -----------------------------------------------------------</span>
<span class="c">#    Accepted connection from 10.10.2.9, port 41962</span>
<span class="c">#    [  5] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 41976</span>
<span class="c">#    [  8] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 41982</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-1.00   sec  2.87 GBytes  24.6 Gbits/sec</span>
<span class="c">#    [  8]   0.00-1.00   sec  2.87 GBytes  24.7 Gbits/sec</span>
<span class="c">#    [SUM]   0.00-1.00   sec  5.74 GBytes  49.3 Gbits/sec</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    ...</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-10.00  sec  29.2 GBytes  25.1 Gbits/sec                  receiver</span>
<span class="c">#    [  8]   0.00-10.00  sec  29.2 GBytes  25.0 Gbits/sec                  receiver</span>
<span class="c">#    [SUM]   0.00-10.00  sec  58.3 GBytes  50.1 Gbits/sec                  receiver</span>
</code></pre></div>        </div>
      </li>
      <li>ì‹¤ìŠµê²°ê³¼ <code class="language-plaintext highlighter-rouge">iperf3 -c 127.0.0.1 -t 5</code>ë¡œ ì¸¡ì •í•˜ì˜€ì„ë•ŒëŠ” í˜¸ìŠ¤íŠ¸ì—ì„œëŠ” 67.1 Gbits/sec ì˜€ë˜ê²ƒì— ë°˜í•´, ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ í†µí•˜ë©´ 41.6 Gbits/secë¡œ ì¸¡ì •ë©ë‹ˆë‹¤.
        <ul>
          <li>ì¿ ë²„ë„¤í‹°ìŠ¤ë„ ë¡œì»¬í˜¸ìŠ¤íŠ¸ì—ì„œ dockerë¡œ ì‹¤í–‰ë˜ëŠ”ë° kube-proxy, iptables í¬ì›Œë”© ë“±ì˜ ì˜¤ë²„í—¤ë“œë¡œ ì¸í•´ ë°œìƒí•˜ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>UDPì˜ ê²½ìš°ì—ë„ <code class="language-plaintext highlighter-rouge">iperf3 -c 127.0.0.1 -u -b 20G</code>ë¡œ ì¸¡ì •í–ˆì„ë•Œ í˜¸ìŠ¤íŠ¸ì—ì„œëŠ” 20.0 Gbits/secê°€ ë‚˜ì˜¤ëŠ”ë°, ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ í†µí•˜ë©´ 1.41 Gbits/secë¡œ ì¸¡ì •ë©ë‹ˆë‹¤.
        <ul>
          <li>UDPëŠ” ë” ì˜¤ë²„í—¤ë“œê°€ ì‹¬í•œë° ì›ì¸ì„ ì°¾ì•„ë´ì•¼ í• ê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ì´ë²ˆ ì‹¤ìŠµì„ í†µí•´ ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ CNI, ì„¤ì •ë“±ì„ ë³€ê²½í•´ê°€ë©° ìµœì ì˜ ì„¤ì •ì„ ì°¾ì•„ë³´ëŠ” ë°©ë²•ì„ ë°°ì›Œë³´ì•˜ìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì‹¤ìŠµì„ í• ìˆ˜ë¡ ì ì  ë” iptablesê³¼ ì¹œìˆ™í•´ì§€ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ëˆˆì— ìµì€ê²Œ ë§ì•„ì§€ê³ ëŠ” ìˆì§€ë§Œ, nftablesë¼ë˜ì§€ ipvsë¼ë˜ì§€, eBPFë¼ë˜ì§€ ì•„ì§ ê°ˆê¸¸ì´ ë©‰ë‹ˆë‹¤. ğŸ˜…</p>

<p>ìƒˆì‚¼ìŠ¤ë ˆ ìŠ¤í„°ë””ë¥¼ ì§„í–‰í•˜ì‹œëŠ” ê°€ì‹œë‹¤ë‹˜ì„ ë¹„ë¡¯í•´ì„œ ì¡°ë ¥ì ë¶„ë“¤ë„ ì •ë§ ëŒ€ë‹¨í•˜ë‹¤ëŠ” ìƒê°ì´ ë“­ë‹ˆë‹¤.
ê·¸ë¦¬ê³  ë‚´ìš©ë“¤ ë° ê·¸ë¦¼ë“¤ì´ ê°€ì‹œë‹¤ë‹˜ì´ ì§‘í•„í•˜ì‹  ì±…ì—ì„œ ë§ì´ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.
ì±…ì´ ì¶œíŒë˜ë©´ ê¼­ êµ¬ë§¤í•´ì„œ ì½ì–´ë³´ê² ìŠµë‹ˆë‹¤! 
ì´ì œ ìŠ¤í„°ë””ë„ ì¤‘ë°˜ì„ í–¥í•´ ë‹¬ë ¤ê°€ê³  ìˆìŠµë‹ˆë‹¤. ë‚¨ì€ ë‚ ë“¤ë„ ìŠ¤í„°ë””ì—ì„œ ìƒì¡´í•  ìˆ˜ ìˆê¸°ë¥¼ ë°”ëë‹ˆë‹¤. :pray:</p>]]></content><author><name></name></author><category term="kans" /><category term="kubernetes," /><category term="network," /><category term="linux" /><summary type="html"><![CDATA[ì§€ë‚œì£¼ì— ì´ì–´ ì´ë²ˆì£¼ì—ëŠ” Kubernetesì˜ Service, ê·¸ ì¤‘ì— ClusterIP, NodePortì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[KANS 3ê¸°] K8S Calico CNI</title><link href="https://sweetlittlebird.github.io/posts/2024-09-22-KANS-Study-Week3/" rel="alternate" type="text/html" title="[KANS 3ê¸°] K8S Calico CNI" /><published>2024-09-22T02:00:18+09:00</published><updated>2024-09-22T02:00:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/KANS%20Study%20-%20Week3</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2024-09-22-KANS-Study-Week3/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì§€ë‚œì£¼ì— ì´ì–´ ì´ë²ˆì£¼ì—ëŠ” Calico CNIì™€ Calico Network Modeì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
KANS 3ê¸° 3ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="calico-cni">Calico CNI</h2>

<h3 id="calico-ì†Œê°œ">Calico ì†Œê°œ</h3>

<h4 id="calicoë€">Calicoë€?</h4>

<p>Calico CNIëŠ” Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ ë„¤íŠ¸ì›Œí¬ë¥¼ ê´€ë¦¬í•˜ëŠ” CNI(Container Network Interface) í”ŒëŸ¬ê·¸ì¸ ì¤‘ í•˜ë‚˜ë¡œ
Kubernetesì™€ non-Kubernetes/legacy ë„¤íŠ¸ì›Œí¬ë¥¼ ì—°ê²°í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
íŠ¹ì§•ìœ¼ë¡œëŠ” L3/L4 ë„¤íŠ¸ì›Œí¬ë¥¼ ì œê³µí•˜ë©°, BGP í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì—¬ ë¼ìš°íŒ…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
(ëª¨ë“œì— ë”°ë¼ BGPë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.)</p>

<h3 id="calico-ì„¤ì¹˜">Calico ì„¤ì¹˜</h3>

<ul>
  <li>ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ <code class="language-plaintext highlighter-rouge">kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.1/manifests/calico.yaml</code> ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬
Calico CNIë¥¼ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë•Œ ì‹¤ìŠµí™˜ê²½ì— ë§ì¶”ê¸° ìœ„í•´ <code class="language-plaintext highlighter-rouge">CALICO_IPV4POOL_BLOCK_SIZE</code>ë¥¼ â€œ24â€ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>
    <p>í•´ë‹¹ ë¶€ë¶„ì´ ì ìš©ëœ yaml íŒŒì¼ì¸ <a href="https://raw.githubusercontent.com/gasida/KANS/main/kans3/calico-kans.yaml">calico-kans.yaml</a>ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì¹˜í•˜ì˜€ìŠµë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pod -A -owide'</span>
  
<span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸(k8s-m)ì—ì„œ calico cni ì„¤ì¹˜ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/projectcalico/calico/v3.28.1/manifests/calico.yaml
<span class="c"># ê¸°ë³¸ yaml ì— 4946ì¤„ ì´ë™ í›„ ì•„ë˜ ë‚´ìš© ì¶”ê°€ í•´ë‘ </span>
<span class="c">##            # Block size to use for the IPv4 POOL created at startup. Block size for IPv4 should be in the range 20-32. default 24</span>
<span class="c">##            - name: CALICO_IPV4POOL_BLOCK_SIZE</span>
<span class="c">##              value: "24"</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/gasida/KANS/main/kans3/calico-kans.yaml
<span class="c"># =&gt; poddisruptionbudget.policy/calico-kube-controllers created</span>
<span class="c">#    serviceaccount/calico-kube-controllers created</span>
<span class="c">#    serviceaccount/calico-node created</span>
<span class="c">#    serviceaccount/calico-cni-plugin created</span>
<span class="c">#    ...</span>
  
<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>tree /opt/cni/bin/
<span class="c"># =&gt; /opt/cni/bin/</span>
<span class="c">#    â”œâ”€â”€ bandwidth</span>
<span class="c">#    â”œâ”€â”€ bridge</span>
<span class="c">#    â”œâ”€â”€ calico</span>
<span class="c">#    â”œâ”€â”€ calico-ipam</span>
<span class="c">#    â”œâ”€â”€ dhcp</span>
<span class="c">#    â”œâ”€â”€ dummy</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /opt/cni/bin/
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    172.16.34.0/24 via 192.168.20.100 dev tunl0 proto bird onlink</span>
<span class="c">#    blackhole 172.16.116.0/24 proto bird</span>
<span class="c">#    172.16.158.0/24 via 192.168.10.101 dev tunl0 proto bird onlink</span>
<span class="c">#    172.16.184.0/24 via 192.168.10.102 dev tunl0 proto bird onlink</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-L</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-L</span> | <span class="nb">wc</span> <span class="nt">-l</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> | <span class="nb">wc</span> <span class="nt">-l</span>
  
<span class="c"># calicoctl ì„¤ì¹˜</span>
<span class="nv">$ </span>curl <span class="nt">-L</span> https://github.com/projectcalico/calico/releases/download/v3.28.1/calicoctl-linux-amd64 <span class="nt">-o</span> calicoctl
<span class="nv">$ </span><span class="nb">chmod</span> +x calicoctl <span class="o">&amp;&amp;</span> <span class="nb">mv </span>calicoctl /usr/bin
<span class="nv">$ </span>calicoctl version
  
<span class="c"># CNI ì„¤ì¹˜ í›„ íŒŒë“œ ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-o</span> wide
<span class="c"># =&gt; NAMESPACE     NAME                                       READY   STATUS    RESTARTS      AGE     IP               NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system   calico-kube-controllers-77d59654f4-wbzth   1/1     Running   0             4m22s   172.16.34.2      k8s-w0   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   calico-node-545hj                          1/1     Running   0             4m22s   192.168.20.100   k8s-w0   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   calico-node-p5xpt                          1/1     Running   0             4m22s   192.168.10.10    k8s-m    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   calico-node-rmzvb                          1/1     Running   0             4m22s   192.168.10.101   k8s-w1   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   calico-node-sd9x8                          1/1     Running   0             4m22s   192.168.10.102   k8s-w2   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    ...</span>
</code></pre></div>    </div>
  </li>
  <li>ì„¤ì¹˜ í™•ì¸ì„ í–ˆì„ë•Œ ìœ„ì™€ ê°™ì´ ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ê°€ ë˜ì—ˆë‹¤ë©´ Calico CNIê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ê³  ìˆëŠ” ê²ƒì…ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">ip -c route</code> ëª…ë ¹ì–´ë¥¼ í†µí•´ Bird ë¼ìš°íŒ… í…Œì´ë¸”ì— Calico CNIê°€ ì ìš©ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ê·¸ ì¤‘ì—ì„œ <code class="language-plaintext highlighter-rouge">blackhole</code>ì€ í•´ë‹¹ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ëŠ” ë…¸ë“œë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
  <li>ì‹¤ìŠµì„ ìœ„í•´ì„œ metrics-serverë¥¼ ì„¤ì¹˜í•˜ê³ , <code class="language-plaintext highlighter-rouge">kubectl top node</code> ëª…ë ¹ì–´ë¥¼ í†µí•´ ë…¸ë“œì˜ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># metrics-server ì„¤ì¹˜</span>
<span class="nv">$ </span>helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
<span class="c"># =&gt; "metrics-server" has been added to your repositories</span>
<span class="nv">$ </span>helm upgrade <span class="nt">--install</span> metrics-server metrics-server/metrics-server <span class="nt">--set</span> <span class="s1">'args[0]=--kubelet-insecure-tls'</span> <span class="nt">-n</span> kube-system
<span class="c"># =&gt; Release "metrics-server" does not exist. Installing it now.</span>
<span class="c">#    ...</span>
<span class="c">#      Chart version: 3.12.1</span>
<span class="c">#      App version:   0.7.1</span>
<span class="c">#      Image tag:     registry.k8s.io/metrics-server/metrics-server:v0.7.1</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> kube-system <span class="nt">-l</span> app.kubernetes.io/instance<span class="o">=</span>metrics-server
<span class="nv">$ </span>kubectl get apiservices |egrep <span class="s1">'(AVAILABLE|metrics)'</span>
<span class="c"># =&gt; NAME                                   SERVICE                      AVAILABLE                  AGE</span>
<span class="c">#    v1beta1.metrics.k8s.io                 kube-system/metrics-server   False (MissingEndpoints)   16s</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl top node  <span class="c"># ë…¸ë“œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ í™•ì¸</span>
<span class="c"># =&gt; NAME     CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span>
<span class="c">#    k8s-m    218m         5%     1131Mi          29%</span>
<span class="c">#    k8s-w0   95m          2%     807Mi           43%</span>
<span class="c">#    k8s-w1   77m          1%     768Mi           41%</span>
<span class="c">#    k8s-w2   62m          1%     806Mi           43%</span>
<span class="nv">$ </span>kubectl top pod <span class="nt">-A</span> <span class="nt">--sort-by</span><span class="o">=</span><span class="s1">'cpu'</span>    <span class="c"># íŒŒë“œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ì„ CPU ì‚¬ìš©ëŸ‰ ìˆœìœ¼ë¡œ ì •ë ¬í•´ì„œ í™•ì¸</span>
<span class="nv">$ </span>kubectl top pod <span class="nt">-A</span> <span class="nt">--sort-by</span><span class="o">=</span><span class="s1">'memory'</span> <span class="c"># íŒŒë“œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ì„ Memory ì‚¬ìš©ëŸ‰ ìˆœìœ¼ë¡œ ì •ë ¬í•´ì„œ í™•ì¸</span>

<span class="c"># (ì°¸ê³ ) ì‚­ì œ</span>
<span class="nv">$ </span>helm uninstall <span class="nt">-n</span> kube-system metrics-server
</code></pre></div></div>

<h3 id="calico-cni-êµ¬ì„±ìš”ì†Œ">Calico CNI êµ¬ì„±ìš”ì†Œ</h3>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_1.png" alt="img.png" class="image-center" />
<em class="image-caption">ì¶œì²˜: ì¶”ê°€ì˜ˆì •</em></p>
<ul>
  <li><strong>Calico Datastore</strong> : Calicoì˜ êµ¬ì„± ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì…ë‹ˆë‹¤. Kubernetes API ì„œë²„(ê¸°ë³¸ê°’) ë˜ëŠ” etcdì— ì €ì¥ë©ë‹ˆë‹¤.</li>
  <li><strong>Bird</strong> : ì˜¤í”ˆì†ŒìŠ¤ ë¼ìš°íŒ… ë°ëª¬ìœ¼ë¡œ, Calico CNIì—ì„œ ë¼ìš°íŒ…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
BirdëŠ” BGP í”„ë¡œí† ì½œì„ ì´ìš©í•œ ë¼ìš°íŒ… ë°ëª¬ìœ¼ë¡œ
Calicoë‚˜ Kubernetesì—ì„œë§Œ ì‚¬ìš©ë˜ëŠ”ê²ƒì´ ì•„ë‹Œ ì¼ë°˜ì ì¸ ë¼ìš°íŒ… ë°ëª¬ì…ë‹ˆë‹¤.
ë…¸ë“œì˜ íŒŒë“œ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì„ BGP ë¼ìš°íŒ… í”„ë¡œí† ì½œì„ í†µí•´ì„œ ê´‘ê³ (advertise)í•©ë‹ˆë‹¤.</li>
  <li><strong>Felix</strong> : Birdë¥¼ í†µí•´ ë°°í¬ëœ ë¼ìš°íŒ… ì •ë³´ë¥¼ ìˆ˜ì‹ í•˜ì—¬, ë…¸ë“œì˜ íŒŒë“œ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì„ í˜¸ìŠ¤íŠ¸ì˜ ë¼ìš°íŒ… í…Œì´ë¸”ì—
ì—…ë°ì´íŠ¸ í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. ë˜í•œ Iptables ë“± ë°©í™”ë²½ ê·œì¹™ ì„¤ì • ê´€ë¦¬ë¥¼ í•©ë‹ˆë‹¤.</li>
  <li><strong>Confd</strong> : Calico êµ¬ì„± ì •ë³´ë¥¼ ê´€ë¦¬í•˜ëŠ” ë°ëª¬ìœ¼ë¡œ, BGP ì„¤ì •ë“±ìœ¼ë¡œ Calico ë°ì´í„° ì €ì¥ì†Œì— ë³€ê²½ì´ ë°œìƒí•˜ë©´
Birdì˜ ì„¤ì • íŒŒì¼ì„ ë§Œë“¤ê³ , ë³€ê²½ëœ ì„¤ì • íŒŒì¼ì„ ë°˜ì˜í•˜ê²Œ í•©ë‹ˆë‹¤.</li>
  <li><strong>CNI IPAM Plugin</strong> : Calicoê°€ ì œê³µí•˜ëŠ” IPAM(IP Address Management) í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ
Calico CNIì—ì„œ IP ì£¼ì†Œë¥¼ í• ë‹¹í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. (Flannel CNIì˜ ê²½ìš° ê¸°ë³¸ IPAMì¸ host-local IPAMì„ ì‚¬ìš©í•©ë‹ˆë‹¤.)</li>
  <li><strong>calico-kube-controllers</strong> : Calicoì˜ ë™ì‘ì„ ê°ì‹œ ë° ì œì–´í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì…ë‹ˆë‹¤.</li>
  <li><strong>Typha</strong> : Calicoì˜ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•œ ì»´í¬ë„ŒíŠ¸ë¡œ, Calicoì˜ ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•œ ì½ê¸° ì „ìš© ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
ì›Œì»¤ë…¸ë“œ ìˆ˜ê°€ ë§ì§€ ì•Šì€ ê²½ìš° ìƒëµí•´ë„ ë¬´ë°©í•©ë‹ˆë‹¤.</li>
  <li><strong>calicoctl</strong> : Calicoë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ” CLI ì¸í„°í˜ì´ìŠ¤ë¡œ, datastoreì— ì ‘ê·¼í•˜ì—¬ Calicoì˜ êµ¬ì„± ì •ë³´ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="calico-êµ¬ì„±ìš”ì†Œ-í™•ì¸">Calico êµ¬ì„±ìš”ì†Œ í™•ì¸</h4>

<ul>
  <li>
    <p>ì„¤ì¹˜ëœ êµ¬ì„±ìš”ì†Œë¥¼ ëª…ë ¹ë“¤ì„ ì‚¬ìš©í•´ì„œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë²„ì „ í™•ì¸ - ë§í¬</span>
<span class="c">## kdd ì˜ë¯¸ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ API ë¥¼ ë°ì´í„°ì €ì¥ì†Œë¡œ ì‚¬ìš© : k8s API datastore(kdd)</span>
<span class="nv">$ </span>calicoctl version
<span class="c"># =&gt; Client Version:    v3.28.1</span>
<span class="c">#    ...</span>
  
<span class="c"># calico ê´€ë ¨ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get daemonset <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span>
<span class="c">#    calico-node   4         4         4       4            4           kubernetes.io/os=linux   26m</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>calico-node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    calico-node-545hj   1/1     Running   0          26m   192.168.20.100   k8s-w0   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    calico-node-p5xpt   1/1     Running   0          26m   192.168.10.10    k8s-m    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    calico-node-rmzvb   1/1     Running   0          26m   192.168.10.101   k8s-w1   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    calico-node-sd9x8   1/1     Running   0          26m   192.168.10.102   k8s-w2   &lt;none&gt;           &lt;none&gt;</span>
<span class="c"># calico-node ëŠ” ë°ëª¬ì…‹ìœ¼ë¡œ ëª¨ë“  ë…¸ë“œì— ë°°í¬ë˜ì–´ ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
  
<span class="c"># calico-kube-controllers ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy <span class="nt">-n</span> kube-system calico-kube-controllers
<span class="c"># =&gt; NAME                      READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    calico-kube-controllers   1/1     1            1           27m</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>calico-kube-controllers <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                                       READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    calico-kube-controllers-77d59654f4-wbzth   1/1     Running   0          28m   172.16.34.2   k8s-w0   &lt;none&gt;           &lt;none&gt;</span>
  
<span class="c"># ì¹¼ë¦¬ì½” IPAM ì •ë³´ í™•ì¸ : ì¹¼ë¦¬ì½” CNI ë¥¼ ì‚¬ìš©í•œ íŒŒë“œê°€ ìƒì„±ëœ ë…¸ë“œì— podCIDR ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ í™•ì¸ - ë§í¬</span>
<span class="nv">$ </span>calicoctl ipam show
<span class="c"># =&gt; +----------+---------------+-----------+------------+--------------+</span>
<span class="c">#    | GROUPING |     CIDR      | IPS TOTAL | IPS IN USE |   IPS FREE   |</span>
<span class="c">#    +----------+---------------+-----------+------------+--------------+</span>
<span class="c">#    | IP Pool  | 172.16.0.0/16 |     65536 | 8 (0%)     | 65528 (100%) |</span>
<span class="c">#    +----------+---------------+-----------+------------+--------------+</span>
  
<span class="c"># Block ëŠ” ê° ë…¸ë“œì— í• ë‹¹ëœ podCIDR ì •ë³´</span>
<span class="nv">$ </span>calicoctl ipam show <span class="nt">--show-blocks</span>
<span class="c"># =&gt; +----------+-----------------+-----------+------------+--------------+</span>
<span class="c">#    | GROUPING |      CIDR       | IPS TOTAL | IPS IN USE |   IPS FREE   |</span>
<span class="c">#    +----------+-----------------+-----------+------------+--------------+</span>
<span class="c">#    | IP Pool  | 172.16.0.0/16   |     65536 | 8 (0%)     | 65528 (100%) |</span>
<span class="c">#    | Block    | 172.16.116.0/24 |       256 | 1 (0%)     | 255 (100%)   |</span>
<span class="c">#    | Block    | 172.16.158.0/24 |       256 | 2 (1%)     | 254 (99%)    |</span>
<span class="c">#    | Block    | 172.16.184.0/24 |       256 | 1 (0%)     | 255 (100%)   |</span>
<span class="c">#    | Block    | 172.16.34.0/24  |       256 | 4 (2%)     | 252 (98%)    |</span>
<span class="c">#    +----------+-----------------+-----------+------------+--------------+</span>
<span class="nv">$ </span>calicoctl ipam show <span class="nt">--show-borrowed</span>
<span class="nv">$ </span>calicoctl ipam show <span class="nt">--show-configuration</span>
  
<span class="c"># host-local IPAM ì •ë³´ í™•ì¸ : k8s-m ë…¸ë“œì˜ podCIDR ì€ host-local ëŒ€ì‹  ì¹¼ë¦¬ì½” IPAM ë¥¼ ì‚¬ìš©í•¨</span>
  
<span class="c"># ì›Œì»¤ ë…¸ë“œë§ˆë‹¤ í• ë‹¹ëœ dedicated subnet (podCIDR) í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].spec.podCIDR}'</span> <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; 172.16.0.0/24 172.16.1.0/24 172.16.2.0/24 172.16.4.0/24</span>
  
<span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì˜ podì— í• ë‹¹ë˜ëŠ” podCIDR í™•ì¸</span>
<span class="nv">$ </span>kubectl get node k8s-m <span class="nt">-o</span> json | jq <span class="s1">'.spec.podCIDR'</span>
<span class="c"># =&gt; "172.16.0.0/24"</span>
  
<span class="c"># CNI Plugin ì •ë³´ í™•ì¸ - ë§í¬</span>
<span class="nv">$ </span>tree /etc/cni/net.d/
<span class="c"># =&gt; /etc/cni/net.d/</span>
<span class="c">#    â”œâ”€â”€ 10-calico.conflist</span>
<span class="c">#    â””â”€â”€ calico-kubeconfig</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/cni/net.d/10-calico.conflist | jq
<span class="c"># =&gt; ...</span>
<span class="c">#    "datastore_type": "kubernetes", # ì¹¼ë¦¬ì½” ë°ì´í„°ì €ì¥ì†ŒëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ API ë¥¼ ì‚¬ìš©</span>
<span class="c">#    "ipam": { </span>
<span class="c">#      "type": "calico-ipam" # IPAM ì€ ì¹¼ë¦¬ì½” ìì²´ IPAM ì„ ì‚¬ìš©</span>
<span class="c">#    },</span>
<span class="c">#    ...</span>
  
<span class="c"># calicoctl node ì •ë³´ í™•ì¸ : Bird ë°ëª¬(BGP)ì„ í†µí•œ BGP ë„¤ì´ë²„ ì—°ê²° ì •ë³´(bgp peer ëŠ” ë…¸ë“œì˜ IPë¡œ ì—°ê²°) - ë§í¬</span>
<span class="nv">$ </span>calicoctl node status
<span class="c"># =&gt; Calico process is running.</span>
<span class="c">#    </span>
<span class="c">#    IPv4 BGP status</span>
<span class="c">#    +----------------+-------------------+-------+----------+-------------+</span>
<span class="c">#    |  PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |</span>
<span class="c">#    +----------------+-------------------+-------+----------+-------------+</span>
<span class="c">#    | 192.168.20.100 | node-to-node mesh | up    | 14:13:02 | Established |</span>
<span class="c">#    | 192.168.10.101 | node-to-node mesh | up    | 14:13:31 | Established |</span>
<span class="c">#    | 192.168.10.102 | node-to-node mesh | up    | 14:12:44 | Established |</span>
<span class="c">#    +----------------+-------------------+-------+----------+-------------+</span>
<span class="nv">$ </span>calicoctl node checksystem
<span class="c"># =&gt; Checking kernel version...</span>
<span class="c">#       5.15.0-119-generic  					OK</span>
<span class="c">#    Checking kernel modules...</span>
<span class="c">#       xt_mark             					OK</span>
  
<span class="c"># ippool ì •ë³´ í™•ì¸ : í´ëŸ¬ìŠ¤í„°ê°€ ì‚¬ìš©í•˜ëŠ” IP ëŒ€ì—­ ì •ë³´ì™€ ì¹¼ë¦¬ì½” ëª¨ë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>calicoctl get ippool <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   DISABLEBGPEXPORT   SELECTOR</span>
<span class="c">#    default-ipv4-ippool   172.16.0.0/16   true   Always     Never       false      false              all()</span>
  
<span class="c"># íŒŒë“œì™€ ì„œë¹„ìŠ¤ ì‚¬ìš© ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ì •ë³´ í™•ì¸ </span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>  
<span class="c"># =&gt; "--service-cluster-ip-range=10.200.1.0/24",</span>
<span class="c">#    "--cluster-cidr=172.16.0.0/16",</span>
                              
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system kubeadm-config <span class="nt">-oyaml</span> | <span class="nb">grep</span> <span class="nt">-i</span> subnet
<span class="c"># =&gt; podSubnet: 172.16.0.0/16</span>
<span class="c">#    serviceSubnet: 10.200.1.0/24</span>
   
<span class="c"># calico endpoint (íŒŒë“œ)ì˜ ì •ë³´ í™•ì¸ : WORKLOAD ëŠ” íŒŒë“œ ì´ë¦„ì´ë©°, ì–´ë–¤ ë…¸ë“œì— ë°°í¬ë˜ì—ˆê³  IP ì™€ cali ì¸í„°í˜ì´ìŠ¤ì™€ ì—°ê²°ë¨ì„ í™•ì¸</span>
<span class="nv">$ </span>calicoctl get workloadEndpoint
<span class="nv">$ </span>calicoctl get workloadEndpoint <span class="nt">-A</span>
<span class="nv">$ </span>calicoctl get workloadEndpoint <span class="nt">-o</span> wide <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE     NAME                                                            WORKLOAD                                   NODE     NETWORKS          INTERFACE         PROFILES                                                  NATS</span>
<span class="c">#    kube-system   k8s--w0-k8s-calico--kube--controllers--77d59654f4--wbzth-eth0   calico-kube-controllers-77d59654f4-wbzth   k8s-w0   172.16.34.5/32    cali544ab3155a5   kns.kube-system,ksa.kube-system.calico-kube-controllers</span>
<span class="c">#    kube-system   k8s--w0-k8s-coredns--55cb58b774--7qvtv-eth0                     coredns-55cb58b774-7qvtv                   k8s-w0   172.16.34.6/32    cali6be4c908feb   kns.kube-system,ksa.kube-system.coredns</span>
<span class="c">#    kube-system   k8s--w0-k8s-coredns--55cb58b774--8q4f6-eth0                     coredns-55cb58b774-8q4f6                   k8s-w0   172.16.34.4/32    cali23a9e6edc85   kns.kube-system,ksa.kube-system.coredns</span>
<span class="c">#    kube-system   k8s--w1-k8s-metrics--server--68cfccbdf6--wjjs2-eth0             metrics-server-68cfccbdf6-wjjs2            k8s-w1   172.16.158.2/32   cali2789c1b51d6   kns.kube-system,ksa.kube-system.metrics-server</span>
  
<span class="c"># ë…¸ë“œì—ì„œ ì»¨í…Œì´ë„ˆ(í”„ë¡œì„¸ìŠ¤) í™•ì¸</span>
<span class="nv">$ </span>ps axf 
<span class="c"># =&gt;    1325 ?        Sl     0:02 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id 4b2a9892a9147b1a3b73b4864bec5270f18da7d8393b82f8863dc8a6cee8ac0c -address /run/containerd/conta</span>
<span class="c">#       1352 ?        Ss     0:00  \_ /pause</span>
<span class="c">#       1762 ?        Ss     0:00  \_ /usr/local/bin/runsvdir -P /etc/service/enabled</span>
<span class="c">#       1838 ?        Ss     0:00      \_ runsv confd</span>
<span class="c">#       1853 ?        Sl     0:00      |   \_ calico-node -confd</span>
<span class="c">#       1839 ?        Ss     0:00      \_ runsv bird</span>
<span class="c">#       2032 ?        S      0:00      |   \_ bird -R -s /var/run/calico/bird.ctl -d -c /etc/calico/confd/config/bird.cfg</span>
<span class="c">#       1840 ?        Ss     0:00      \_ runsv node-status-reporter</span>
<span class="c">#       1847 ?        Sl     0:00      |   \_ calico-node -status-reporter</span>
<span class="c">#       1841 ?        Ss     0:00      \_ runsv monitor-addresses</span>
<span class="c">#       1851 ?        Sl     0:00      |   \_ calico-node -monitor-addresses</span>
<span class="c">#       1842 ?        Ss     0:00      \_ runsv felix</span>
<span class="c">#       1849 ?        Sl     0:27      |   \_ calico-node -felix</span>
<span class="c">#       1843 ?        Ss     0:00      \_ runsv allocate-tunnel-addrs</span>
<span class="c">#       1846 ?        Sl     0:00      |   \_ calico-node -allocate-tunnel-addrs</span>
<span class="c">#       1844 ?        Ss     0:00      \_ runsv cni</span>
<span class="c">#       1848 ?        Sl     0:00      |   \_ calico-node -monitor-token</span>
<span class="c">#       1845 ?        Ss     0:00      \_ runsv bird6</span>
<span class="c">#       2033 ?        S      0:00          \_ bird6 -R -s /var/run/calico/bird6.ctl -d -c /etc/calico/confd/config/bird6.cfg</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>felix</strong> : Hostì˜ Network Interface, Routing Table, Iptablesë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Calicoì˜ Felixë¥¼ í†µí•´ ì„¤ì •ëœ iptables ê·œì¹™ ì„¤ì • í™•ì¸</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span> | <span class="nb">grep </span>cali
<span class="c"># =&gt; -N cali-FORWARD</span>
<span class="c">#    -N cali-INPUT</span>
<span class="c">#    -N cali-OUTPUT</span>
<span class="c">#    -N cali-cidr-block</span>
<span class="c">#    -N cali-from-hep-forward</span>
<span class="c">#    -N cali-from-host-endpoint</span>
<span class="c">#    -N cali-from-wl-dispatch</span>
<span class="c">#    -N cali-to-hep-forward</span>
<span class="c">#    -N cali-to-host-endpoint</span>
<span class="c">#    -N cali-to-wl-dispatch</span>
<span class="c">#    -N cali-wl-to-host</span>
<span class="c">#    -A INPUT -m comment --comment "cali:Cz_u1IQiXIMmKD4c" -j cali-INPUT</span>
<span class="c">#    -A FORWARD -m comment --comment "cali:wUHhoiAYhphO9Mso" -j cali-FORWARD</span>
<span class="c">#    -A FORWARD -m comment --comment "cali:S93hcgKJrXEqnTfs" -m comment --comment "Policy explicitly accepted packet." -j ACCEPT</span>
<span class="c">#    -A FORWARD -m comment --comment "cali:mp77cMpurHhyjLrM" -j MARK --set-xmark 0x10000/0x10000</span>
<span class="c">#    -A OUTPUT -m comment --comment "cali:tVnHkvAo15HuiPy0" -j cali-OUTPUT</span>
<span class="c">#    -A cali-FORWARD -m comment --comment "cali:vjrMJCRpqwy5oRoX" -j MARK --set-xmark 0x0/0xe0000</span>
<span class="c">#    -A cali-FORWARD -m comment --comment "cali:A_sPAO0mcxbT9mOV" -j cali-from-hep-forward</span>
<span class="c">#    -A cali-FORWARD -i cali+ -m comment --comment "cali:8ZoYfO5HKXWbB3pk" -j cali-from-wl-dispatch</span>
<span class="c">#    -A cali-FORWARD -o cali+ -m comment --comment "cali:jdEuaPBe14V2hutn" -j cali-to-wl-dispatch</span>
<span class="c">#    -A cali-FORWARD -m comment --comment "cali:12bc6HljsMKsmfr-" -j cali-to-hep-forward</span>
<span class="c">#    -A cali-FORWARD -m comment --comment "cali:NOSxoaGx8OIstr1z" -j cali-cidr-block</span>
<span class="c">#    -A cali-INPUT -p ipencap -m comment --comment "cali:PajejrV4aFdkZojI" -m comment --comment "Allow IPIP packets from Calico hosts" -m set --match-set cali40all-hosts-net src -m addrtype --dst-type LOCAL -j ACCEPT</span>
<span class="c">#    -A cali-INPUT -p ipencap -m comment --comment "cali:_wjq-Yrma8Ly1Svo" -m comment --comment "Drop IPIP packets from non-Calico hosts" -j DROP</span>
<span class="c">#    -A cali-INPUT -i cali+ -m comment --comment "cali:8TZGxLWh_Eiz66wc" -g cali-wl-to-host</span>
<span class="c">#    -A cali-INPUT -m comment --comment "cali:6McIeIDvPdL6PE1T" -j ACCEPT</span>
<span class="c">#    -A cali-INPUT -m comment --comment "cali:YGPbrUms7NId8xVa" -j MARK --set-xmark 0x0/0xf0000</span>
<span class="c">#    -A cali-INPUT -m comment --comment "cali:2gmY7Bg2i0i84Wk_" -j cali-from-host-endpoint</span>
<span class="c">#    -A cali-INPUT -m comment --comment "cali:q-Vz2ZT9iGE331LL" -m comment --comment "Host endpoint policy accepted packet." -j ACCEPT</span>
<span class="c">#    -A cali-OUTPUT -m comment --comment "cali:Mq1_rAdXXH3YkrzW" -j ACCEPT</span>
<span class="c">#    -A cali-OUTPUT -o cali+ -m comment --comment "cali:69FkRTJDvD5Vu6Vl" -j RETURN</span>
<span class="c">#    -A cali-OUTPUT -p ipencap -m comment --comment "cali:AnEsmO6bDZbQntWW" -m comment --comment "Allow IPIP packets to other Calico hosts" -m set --match-set cali40all-hosts-net dst -m addrtype --src-type LOCAL -j ACCEPT</span>
<span class="c">#    -A cali-OUTPUT -m comment --comment "cali:9e9Uf3GU5tX--Lxy" -j MARK --set-xmark 0x0/0xf0000</span>
<span class="c">#    -A cali-OUTPUT -m comment --comment "cali:0f3LDz_VKuHFaA2K" -m conntrack ! --ctstate DNAT -j cali-to-host-endpoint</span>
<span class="c">#    -A cali-OUTPUT -m comment --comment "cali:OgU2f8BVEAZ_fwkq" -m comment --comment "Host endpoint policy accepted packet." -j ACCEPT</span>
<span class="c">#    -A cali-from-wl-dispatch -m comment --comment "cali:zTj6P0TIgYvgz-md" -m comment --comment "Unknown interface" -j DROP</span>
<span class="c">#    -A cali-to-wl-dispatch -m comment --comment "cali:7KNphB1nNHw80nIO" -m comment --comment "Unknown interface" -j DROP</span>
<span class="c">#    -A cali-wl-to-host -m comment --comment "cali:Ee9Sbo10IpVujdIY" -j cali-from-wl-dispatch</span>
<span class="c">#    -A cali-wl-to-host -m comment --comment "cali:nSZbcOoG1xPONxb8" -m comment --comment "Configured DefaultEndpointToHostAction" -j ACCEPT</span>
  
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>cali
<span class="c"># =&gt; -N cali-OUTPUT</span>
<span class="c">#    -N cali-POSTROUTING</span>
<span class="c">#    -N cali-PREROUTING</span>
<span class="c">#    -N cali-fip-dnat</span>
<span class="c">#    -N cali-fip-snat</span>
<span class="c">#    -N cali-nat-outgoing</span>
<span class="c">#    -A PREROUTING -m comment --comment "cali:6gwbT8clXdHdC1b1" -j cali-PREROUTING</span>
<span class="c">#    -A OUTPUT -m comment --comment "cali:tVnHkvAo15HuiPy0" -j cali-OUTPUT</span>
<span class="c">#    -A POSTROUTING -m comment --comment "cali:O3lYWMrLQYEMJtB5" -j cali-POSTROUTING</span>
<span class="c">#    -A cali-OUTPUT -m comment --comment "cali:GBTAv2p5CwevEyJm" -j cali-fip-dnat</span>
<span class="c">#    -A cali-POSTROUTING -m comment --comment "cali:Z-c7XtVd2Bq7s_hA" -j cali-fip-snat</span>
<span class="c">#    -A cali-POSTROUTING -m comment --comment "cali:nYKhEzDlr11Jccal" -j cali-nat-outgoing</span>
<span class="c">#    -A cali-POSTROUTING -o tunl0 -m comment --comment "cali:SXWvdsbh4Mw7wOln" -m addrtype ! --src-type LOCAL --limit-iface-out -m addrtype --src-type LOCAL -j MASQUERADE --random-fully</span>
<span class="c">#    -A cali-PREROUTING -m comment --comment "cali:r6XmIziWUJsdOK6Z" -j cali-fip-dnat</span>
<span class="c">#    -A cali-nat-outgoing -m comment --comment "cali:flqWnvo8yq4ULQLa" -m set --match-set cali40masq-ipam-pools src -m set ! --match-set cali40all-ipam-pools dst -j MASQUERADE --random-fully</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>bird</strong> : BGP ë¼ìš°íŒ… ë°ëª¬ìœ¼ë¡œ, Calico CNIì—ì„œ ë¼ìš°íŒ…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>calico-node <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                READY   STATUS    RESTARTS      AGE   IP               NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    calico-node-p5xpt   1/1     Running   1 (42m ago)   24h   192.168.10.10    k8s-m    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    calico-node-545hj   1/1     Running   1 (42m ago)   24h   192.168.20.100   k8s-w0   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    calico-node-rmzvb   1/1     Running   1 (42m ago)   24h   192.168.10.101   k8s-w1   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    calico-node-sd9x8   1/1     Running   1 (42m ago)   24h   192.168.10.102   k8s-w2   &lt;none&gt;           &lt;none&gt;</span>
  
<span class="c"># Bird ë¼ìš°íŒ… í…Œì´ë¸” í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec</span> <span class="nt">-it</span> calico-node-545hj <span class="nt">--</span> birdcl show route
<span class="c"># =&gt; BIRD v0.3.3+birdv1.6.8 ready.</span>
<span class="c">#    0.0.0.0/0          via 10.0.2.2 on enp0s3 [kernel1 14:13:00] * (10)</span>
<span class="c">#    10.0.2.2/32        dev enp0s3 [kernel1 14:13:00] * (10)</span>
<span class="c">#    10.0.2.3/32        dev enp0s3 [kernel1 14:13:00] * (10)</span>
<span class="c">#    10.0.2.0/24        dev enp0s3 [direct1 14:12:59] * (240)</span>
<span class="c">#    172.16.184.0/24    via 192.168.20.254 on enp0s8 [Mesh_192_168_10_102 14:13:01 from 192.168.10.102] * (100/?) [i]</span>
<span class="c">#    192.168.10.0/24    via 192.168.20.254 on enp0s8 [kernel1 14:13:00] * (10)</span>
<span class="c">#    172.16.158.0/24    via 192.168.20.254 on enp0s8 [Mesh_192_168_10_101 14:13:30 from 192.168.10.101] * (100/?) [i]</span>
<span class="c">#    192.168.20.0/24    dev enp0s8 [direct1 14:12:59] * (240)</span>
<span class="c">#    172.16.116.0/24    via 192.168.20.254 on enp0s8 [Mesh_192_168_10_10 14:13:01 from 192.168.10.10] * (100/?) [i]</span>
<span class="c">#    172.16.34.0/24     blackhole [static1 14:12:59] * (200)</span>
<span class="c">#    172.16.34.0/32     dev tunl0 [direct1 14:12:59] * (240)</span>
<span class="c">#    172.16.34.6/32     dev cali6be4c908feb [kernel1 14:13:09] * (10)</span>
<span class="c">#    172.16.34.5/32     dev cali544ab3155a5 [kernel1 14:13:08] * (10)</span>
<span class="c">#    172.16.34.4/32     dev cali23a9e6edc85 [kernel1 14:13:08] * (10)</span>
  
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec</span> <span class="nt">-it</span> calico-node-545hj <span class="nt">--</span> birdcl show protocol
<span class="c"># =&gt; BIRD v0.3.3+birdv1.6.8 ready.</span>
<span class="c">#    name     proto    table    state  since       info</span>
<span class="c">#    static1  Static   master   up     14:13:00</span>
<span class="c">#    kernel1  Kernel   master   up     14:13:00</span>
<span class="c">#    device1  Device   master   up     14:13:00</span>
<span class="c">#    direct1  Direct   master   up     14:13:00</span>
<span class="c">#    Mesh_192_168_10_10 BGP      master   up     14:13:02    Established</span>
<span class="c">#    Mesh_192_168_10_101 BGP      master   up     14:13:31    Established</span>
<span class="c">#    Mesh_192_168_10_102 BGP      master   up     14:13:02    Established</span>
  
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec</span> <span class="nt">-it</span> calico-node-545hj <span class="nt">--</span> birdcl show status
<span class="c"># =&gt; BIRD v0.3.3+birdv1.6.8 ready.</span>
<span class="c">#    BIRD v0.3.3+birdv1.6.8</span>
<span class="c">#    Router ID is 192.168.20.100</span>
<span class="c">#    Current server time is 2024-09-19 14:57:39</span>
<span class="c">#    Last reboot on 2024-09-19 14:13:00</span>
<span class="c">#    Last reconfiguration on 2024-09-19 14:13:00</span>
<span class="c">#    Daemon is up and running</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="ë…¸ë“œê°„ì˜-bgp-ì „ë‹¬ê³¼ì •-í™•ì¸">ë…¸ë“œê°„ì˜ BGP ì „ë‹¬ê³¼ì • í™•ì¸</h4>

<ul>
  <li>Calico CNIì—ì„œëŠ” BGP í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œê°„ì˜ ë¼ìš°íŒ… ì •ë³´ë¥¼ êµí™˜í•©ë‹ˆë‹¤.
í•´ë‹¹ ì—­í• ì„ BIRDê°€ ìˆ˜í–‰í•˜ëŠ”ë° ê·¸ë¦¼ìœ¼ë¡œ ì‚´í´ë³´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_3.png" alt="img.png" class="image-center" />
<em class="image-caption">Birdì™€ Felixì˜ ì—­í•  ëª¨ì‹ë„ (ì¶œì²˜: ì¶”ê°€ì˜ˆì •)</em></p>

<ul>
  <li>ë…¸ë“œê°„ì˜ BGP ì „ë‹¬ì„ íŒ¨í‚·ì„ ìº¡ì³í•´ì„œ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì›Œì»¤ ë…¸ë“œë¥¼ ì¢…ë£Œí•œ ìƒíƒœì—ì„œ ì•„ë˜ì˜ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.</span>

<span class="c"># ë…¸ë“œì—ì„œ íŒ¨í‚· ìº¡ì³</span>
<span class="nv">$ </span>vagrant ssh k8s-m

<span class="c"># BGPëŠ” TCP 179 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ í•´ë‹¹ í¬íŠ¸ë¡œ íŒ¨í‚·ì„ ìº¡ì³í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> enp0s8 tcp port 179 <span class="nt">-w</span> bgp.cap

<span class="c"># ì¢…ë£Œëœ ì›Œì»¤ ë…¸ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</span>
<span class="c"># ì›Œì»¤ ë…¸ë“œê°€ ì‹œì‘ë˜ë©´ BGP ì—°ê²°ì´ ì¬ì„¤ì •ë˜ê³  íŒ¨í‚·ì´ ì „ì†¡ë©ë‹ˆë‹¤.</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ìº¡ì³ëœ íŒ¨í‚·ì´ bgp.cap íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìœ¼ë©´, Wiresharkë¥¼ ì‚¬ìš©í•˜ì—¬ íŒ¨í‚·ì„ í™•ì¸í•©ë‹ˆë‹¤.</p>

    <p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_4.png" alt="20240921_kans_w3_4.png" /></p>
  </li>
  <li>
    <p>ì›Œì»¤ ë…¸ë“œì— ì ‘ì†í•´ì„œ ë…¸ë“œ ipì™€ ipip tunneling ipë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì›Œì»¤ë…¸ë“œ k8s-w2 ì ‘ì†</span>
<span class="nv">$ </span>vagrant ssh k8s-w2
  
<span class="nv">$ </span>ip addr
<span class="c"># =&gt; ...</span>
<span class="c">#    3: enp0s8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        link/ether 08:00:27:af:2e:7a brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet &lt;span style="color: red;"&gt;192.168.10.102&lt;/span&gt;/24 brd 192.168.10.255 scope global enp0s8  &lt;span style="color: red;"&gt;# node ip&lt;/span&gt;   </span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    4: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group default qlen 1000</span>
<span class="c">#        link/ipip 0.0.0.0 brd 0.0.0.0                                  </span>
<span class="c">#        inet &lt;span style="color: red;"&gt;172.16.184.0&lt;/span&gt;/32 scope global tunl0                        &lt;span style="color: red;"&gt;# ipip tunneling ip&lt;/span&gt;</span>
<span class="c">#           valid_lft forever preferred_lft forever </span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œì— ì ‘ì†í•´ì„œ ë¼ìš°íŒ… í…Œì´ë¸”ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œ k8s-m ì ‘ì†</span>
<span class="nv">$ </span>vagrant ssh k8s-m
  
<span class="c"># ë¼ìš°íŒ… í…Œì´ë¸” í™•ì¸</span>
<span class="nv">$ </span>ip route show 172.16.184.0/24
<span class="c"># =&gt; &lt;span style="color: red;"&gt;172.16.184.0&lt;/span&gt;/24 via &lt;span style="color: red;"&gt;192.168.10.102&lt;/span&gt; dev tunl0 proto bird onlink</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ìœ„ì™€ ê°™ì´ BGPë¥¼ í†µí•´ ë…¸ë“œê°„ ë¼ìš°íŒ… ì •ë³´ë¥¼ êµí™˜í•˜ê³ , ë¼ìš°íŒ… í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<h3 id="calico-í†µì‹ -íë¦„-í™•ì¸">Calico í†µì‹  íë¦„ í™•ì¸</h3>

<ul>
  <li>Calico CNIë¥¼ ì‚¬ìš©í•œ í†µì‹ ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="ë™ì¼-ë…¸ë“œì—ì„œ-íŒŒë“œpod-ê°„-í†µì‹ ">ë™ì¼ ë…¸ë“œì—ì„œ íŒŒë“œ(Pod) ê°„ í†µì‹ </h4>

<ul>
  <li>ë™ì¼ ë…¸ë“œì—ì„œ íŒŒë“œê°„ í†µì‹ ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì§ì ‘ í†µì‹ í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_5.png" alt="img.png" class="w-80 image-center" /></p>

<ul>
  <li>iptables FORWARD Rule ì •ì±…ì—ì„œ íŒŒë“œê°„ í¬ì›Œë”© ì •ì±…ì„ í—ˆìš©í•©ë‹ˆë‹¤.</li>
  <li>calice# ì¸í„°í˜ì´ìŠ¤ì— proxy arp ì„¤ì •ì„ í†µí•´ ê²Œì´íŠ¸ì›¨ì´ì˜ MAC ì£¼ì†Œë¥¼ íŒŒë“œê°€ ì „ë‹¬ ë°›ì•„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>ë™ì¼ ë…¸ë“œ ë‚´ì˜ íŒŒë“œ ê°„ í†µì‹ ì—ì„œëŠ” tunnel interfaceë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="íŒŒë“œ-ë°°í¬-ì „-ê¸°ë³¸-ìƒíƒœ-í™•ì¸">íŒŒë“œ ë°°í¬ ì „ ê¸°ë³¸ ìƒíƒœ í™•ì¸</h5>

<ul>
  <li>íŒŒë“œ ë°°í¬ ì „ì—ëŠ” ì•„ë˜ì™€ ê°™ì´ íŒŒë“œê°€ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_6.png" alt="img.png" class="w-70 image-center" />
<em class="image-caption">íŒŒë“œ ë°°í¬ ì „ ìƒíƒœ (ì¶œì²˜: ì¶”ê°€ì˜ˆì •)</em></p>

<ul>
  <li>
    <p>íŒŒë“œ ìƒì„± ì „ ë…¸ë“œ(k8s-w1) Shell ì—ì„œ ê¸°ë³¸ ì •ë³´ í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸ : í„°ë„(ipip) ì¸í„°í˜ì´ìŠ¤ê°€ ì¡´ì¬</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-d</span> addr show tunl0
<span class="c"># =&gt; 4: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group default qlen 1000</span>
<span class="c">#        link/ipip 0.0.0.0 brd 0.0.0.0 promiscuity 0 minmtu 0 maxmtu 0</span>
<span class="c">#        &lt;span style="color: red;"&gt;ipip&lt;/span&gt; any remote any local any ttl inherit nopmtudisc numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535</span>
<span class="c">#        inet &lt;span style="color: red;"&gt;172.16.158.0/32&lt;/span&gt; scope global tunl0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
  
<span class="c"># ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>lsns <span class="nt">-t</span> net
<span class="c"># =&gt;         NS TYPE NPROCS   PID USER     NETNSID NSFS                                                COMMAND</span>
<span class="c">#    4026531840 net     145     1 root  unassigned                                                     /sbin/i</span>
<span class="c">#    4026532204 net       2  2009 65535          0 /run/netns/cni-6923c332-7c35-669a-8787-232597fa3fa8 /pause</span>
  
<span class="c"># ë„¤íŠ¸ì›Œí¬ ë¼ìš°íŒ… ê²½ë¡œ ì •ë³´ í™•ì¸</span>
<span class="c"># ì´ì¤‘ bird ëŠ” bird ë°ëª¬ì´ BGP ë¼ìš°íŒ… í”„ë¡œí† ì½œì— ì˜í•´ íŒŒë“œ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì„ ì „ë‹¬ë°›ê±°ë‚˜ ì „ë‹¬í•˜ëŠ” ê²½ë¡œ â†’ ê°ê° ë…¸ë“œì˜ íŒŒë“œ ëŒ€ì—­ì…ë‹ˆë‹¤</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>bird
<span class="c"># =&gt; blackhole 172.16.158.0/24 proto bird</span>
<span class="c"># =&gt; 172.16.34.0/24 via 192.168.20.100 dev tunl0 proto bird onlink</span>
<span class="c"># =&gt; 172.16.116.0/24 via 192.168.10.10 dev tunl0 proto bird onlink</span>
<span class="c"># =&gt; 172.16.184.0/24 via 192.168.10.102 dev tunl0 proto bird onlink</span>
  
<span class="c"># ì•„ë˜ tunl0 Iface ì— ëª©ì ì§€ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì€ ipip ì¸ìº¡ìŠë ˆì´ì…˜ì— ì˜í•´ì„œ ê° ë…¸ë“œì— ì „ë‹¬ë©ë‹ˆë‹¤ â†’ ê°ê° ë…¸ë“œì˜ íŒŒë“œ ëŒ€ì—­ì…ë‹ˆë‹¤</span>
<span class="nv">$ </span>route <span class="nt">-n</span>
<span class="c"># =&gt; Kernel IP routing table</span>
<span class="c">#    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span>
<span class="c">#    172.16.34.0     192.168.20.100  255.255.255.0   UG    0      0        0 tunl0</span>
<span class="c">#    172.16.116.0    192.168.10.10   255.255.255.0   UG    0      0        0 tunl0</span>
<span class="c">#    172.16.158.0    0.0.0.0         255.255.255.0   U     0      0        0 *</span>
<span class="c">#    172.16.184.0    192.168.10.102  255.255.255.0   UG    0      0        0 tunl0</span>
<span class="c">#    ...</span>
  
<span class="c"># (ì˜µì…˜) iptables rule ê°¯ìˆ˜ í™•ì¸</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span> | <span class="nb">grep </span>cali | <span class="nb">wc</span> <span class="nt">-l</span>
<span class="c"># =&gt; 69</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>cali | <span class="nb">wc</span> <span class="nt">-l</span>
<span class="c"># =&gt; 15</span>
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="íŒŒë“œ-ë°°í¬-í›„-ìƒíƒœ-í™•ì¸">íŒŒë“œ ë°°í¬ í›„ ìƒíƒœ í™•ì¸</h5>

<ul>
  <li>ë…¸ë“œ(k8s-w1)ì— íŒŒë“œê°€ ë°°í¬ë˜ë©´ ì•„ë˜ì™€ ê°™ì´ íŒŒë“œê°€ ìƒì„±ë˜ê³ , í†µì‹ ì´ ê°€ëŠ¥í•œ ìƒíƒœì…ë‹ˆë‹¤.</li>
  <li>
    <p>node1-pod2.yaml íŒŒì¼ ì‘ì„±</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># node1-pod2.yaml </span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">nodeName</span><span class="pi">:</span> <span class="s">k8s-w1</span>  
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pod1</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nicolaka/netshoot</span>  
    <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">tail"</span><span class="pi">]</span>
    <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">-f"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/dev/null"</span><span class="pi">]</span>
  <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">nodeName</span><span class="pi">:</span> <span class="s">k8s-w1</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pod2</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nicolaka/netshoot</span>
    <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">tail"</span><span class="pi">]</span>
    <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">-f"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/dev/null"</span><span class="pi">]</span>
  <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
</code></pre></div>    </div>
  </li>
  <li>íŒŒë“œ ìƒì„±
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> node1-pod2.yaml
<span class="c"># =&gt; pod/pod1 created</span>
<span class="c">#    pod/pod2 created</span>
</code></pre></div>    </div>
  </li>
  <li>ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ì„œ íŒŒë“œ ìƒì„± í›„ í™•ì¸</li>
</ul>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_7.png" alt="img.png" class="w-80 image-center" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vagrant ssh k8s-m 

<span class="c"># [í„°ë¯¸ë„1] k8s-m ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> calicoctl get workloadEndpoint

<span class="c"># ìƒì„±ëœ íŒŒë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME   READY   STATUS    RESTARTS        AGE   IP             NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod1   1/1     Running   1 (6m56s ago)   16h   172.16.158.9   k8s-w1   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    pod2   1/1     Running   1 (6m56s ago)   16h   172.16.158.8   k8s-w1   &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># calicoctl ì´ìš©í•œ endpoint í™•ì¸</span>
<span class="nv">$ </span>calicoctl get workloadendpoints
<span class="c"># =&gt; WORKLOAD   NODE     NETWORKS          INTERFACE</span>
<span class="c">#    pod1       k8s-w1   172.16.158.9/32   calice0906292e2</span>
<span class="c">#    pod2       k8s-w1   172.16.158.8/32   calibd2348b4f67</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ì›Œì»¤ë…¸ë“œì—ì„œ íŒŒë“œ ìƒì„± í›„ í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vagrant ssh k8s-w1 
  
<span class="c"># ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸ : calice#~ 2ê°œ ì¶”ê°€ë¨!, ê°ê° net ns(ë„¤ì„ìŠ¤í˜ì´ìŠ¤) 0, 1ë¡œ í˜¸ìŠ¤íŠ¸ì™€ êµ¬ë³„ë¨</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    4: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ipip 0.0.0.0 brd 0.0.0.0</span>
<span class="c">#    &lt;span style="color: #393;"&gt;7: cali2789c1b51d6@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP mode DEFAULT group default qlen 1000&lt;/span&gt;</span>
<span class="c">#        &lt;span style="color: #393;"&gt;link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-a67773eb-f809-7ce1-72f5-e16e93cbe4c4&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: #393;"&gt;8: calibd2348b4f67@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP mode DEFAULT group default qlen 1000&lt;/span&gt;</span>
<span class="c">#        &lt;span style="color: #393;"&gt;link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-511c24a7-0a0a-0c9a-29c2-345cfcc0dd21&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: #393;"&gt;9: calice0906292e2@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP mode DEFAULT group default qlen 1000&lt;/span&gt;</span>
<span class="c">#        &lt;span style="color: #393;"&gt;link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-47754704-48d2-04a9-28fe-e8bff1be17ba&lt;/span&gt;</span>
  
<span class="c"># ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸ : ì•„ë˜ 2ê°œ pause(infra ì»¨í…Œì´ë„ˆ)ê°€ ê°ê° íŒŒë“œë³„ë¡œ ìƒì„±ë¨ - ìœ„ link-netnsid 0, link-netnsid 1 ë§¤ì¹­ë¨</span>
<span class="nv">$ </span>lsns <span class="nt">-t</span> net
<span class="c"># =&gt;         NS TYPE NPROCS   PID USER     NETNSID NSFS                                                COMMAND</span>
<span class="c">#    4026531840 net     146     1 root  unassigned                                                     /sbin/init</span>
<span class="c">#    4026532205 net       2  2092 65535          0 /run/netns/cni-a67773eb-f809-7ce1-72f5-e16e93cbe4c4 /pause</span>
<span class="c">#    4026532282 net       2  2317 65535          1 /run/netns/cni-511c24a7-0a0a-0c9a-29c2-345cfcc0dd21 /pause</span>
<span class="c">#    4026532343 net       2  2431 65535          2 /run/netns/cni-47754704-48d2-04a9-28fe-e8bff1be17ba /pause</span>
  
<span class="c"># íŒŒë“œì˜ IP/32bit í˜¸ìŠ¤íŠ¸ ë¼ìš°íŒ… ëŒ€ì—­ì´ ë¼ìš°íŒ… í…Œì´ë¸”ì— ì¶”ê°€ë¨</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    blackhole 172.16.158.0/24 proto bird</span>
<span class="c">#    &lt;span style="color: #393;"&gt;172.16.158.7 dev cali2789c1b51d6 scope link&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: #393;"&gt;172.16.158.8 dev calibd2348b4f67 scope link&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: #393;"&gt;172.16.158.9 dev calice0906292e2 scope link&lt;/span&gt;</span>
<span class="c">#    ...</span>
  
<span class="c"># (ì˜µì…˜) iptables rule ê°¯ìˆ˜ í™•ì¸</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span> | <span class="nb">grep </span>cali | <span class="nb">wc</span> <span class="nt">-l</span>
<span class="c"># =&gt; 121</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>cali | <span class="nb">wc</span> <span class="nt">-l</span>
<span class="c"># =&gt; 15</span>
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="íŒŒë“œê°„-í†µì‹ -ì‹¤í–‰-ë°-í™•ì¸">íŒŒë“œê°„ í†µì‹  ì‹¤í–‰ ë° í™•ì¸</h5>

<ul>
  <li>
    <p>íŒŒë“œê°„ í†µì‹  ì‹¤í–‰ ì´í•´ë¥¼ ìœ„í•œ ì¤€ë¹„
<img src="/assets/2024/kans-3th/w3/20240921_kans_w3_8.png" alt="img.png" class="w-80 image-center" /></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># iptables í•„í„° í…Œì´ë¸”ì— FORWARD ë¦¬ìŠ¤íŠ¸ ì¤‘ cali-FORWARD ë£° ì •ë³´ë¥¼ í•„í„°ë§í•´ì„œ watch ë¡œ í™•ì¸</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="nt">-n</span> 1 <span class="s2">"iptables -v --numeric --table filter --list FORWARD | egrep '(cali-FORWARD|pkts)'"</span> 
  
<span class="c"># (ì»¨íŠ¸ë¡¤í”Œë ˆì¸) íŒŒë“œ ì—°ê²°ëœ veth ë¥¼ ë³€ìˆ˜ë¥¼ í™•ì¸</span>
<span class="nv">$ VETH1</span><span class="o">=</span><span class="si">$(</span>calicoctl get workloadEndpoint | <span class="nb">grep </span>pod1 | <span class="nb">awk</span> <span class="s1">'{print $4}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$VETH1</span>
<span class="c"># =&gt; calice0906292e2</span>
<span class="nv">$ VETH2</span><span class="o">=</span><span class="si">$(</span>calicoctl get workloadEndpoint | <span class="nb">grep </span>pod2 | <span class="nb">awk</span> <span class="s1">'{print $4}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$VETH2</span>
<span class="c"># =&gt; calibd2348b4f67</span>
  
<span class="c"># (ì›Œì»¤ë…¸ë“œ1) ìœ„ì—ì„œ í™•ì¸í•œ íŒŒë“œ ì—°ê²°ëœ veth ë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
<span class="nv">$ VETH1</span><span class="o">=</span>calice0906292e2
<span class="nv">$ VETH2</span><span class="o">=</span>calibd2348b4f67
  
<span class="c"># ë…¸ë“œ1 calice# ì¸í„°í˜ì´ìŠ¤ì˜ proxy arp ì„¤ì • í™•ì¸</span>
<span class="c"># cat /proc/sys/net/ipv4/conf/&lt;ìì‹ ì˜ pod1ì— ì—°ê²°ëœ calice# ì´ë¦„&gt;/proxy_arp</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/net/ipv4/conf/<span class="nv">$VETH1</span>/proxy_arp
<span class="c"># =&gt; 1</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/net/ipv4/conf/<span class="nv">$VETH2</span>/proxy_arp
<span class="c"># =&gt; 1</span>
  
<span class="c"># íŒŒë“œ1 í˜¹ì€ íŒŒë“œ2ì— veth ë¡œ ì—°ê²°ëœ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ calice# ì¤‘ 1ê°œ ì„ íƒí•´ì„œ tcpdump</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> <span class="nv">$VETH1</span> <span class="nt">-nn</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> <span class="nv">$VETH2</span> <span class="nt">-nn</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>íŒŒë“œ1 -&gt; íŒŒë“œ2 ping í†µì‹ ì„ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_9.png" alt="img.png" class="w-80 image-center" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë“œ1 Shell ì—ì„œ ì‹¤í–‰ : ì •ìƒ í†µì‹ !</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>pod1 <span class="nt">-it</span> <span class="nt">--</span> zsh
<span class="c"># --------------------</span>
<span class="c"># ping -c 10 &lt;íŒŒë“œ2 IP&gt;</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 10 172.16.158.8

<span class="c"># ê²Œì´íŠ¸ì›¨ì´ 169.254.1.1 ì˜ MAC ì£¼ì†Œë¥¼ ARP ì— ì˜í•´ì„œ í•™ìŠµë˜ì—ˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-s</span> neigh
<span class="c"># =&gt; 10.0.2.15 dev eth0 lladdr ee:ee:ee:ee:ee:ee  used 675/735/675probes 0 STALE</span>
<span class="c">#    &lt;span style="color: #900;"&gt;169.254.1.1&lt;/span&gt; dev eth0 lladdr &lt;span style="color: #900;"&gt;ee:ee:ee:ee:ee:ee&lt;/span&gt;  ref 1 used 3/3/3probes 1 REACHABLE</span>

<span class="c"># ë…¸ë“œì—ì„œ í™•ì¸</span>
<span class="c"># iptables ì— ê¸°ë³¸ FORWARD ëŠ” DROP ì´ì§€ë§Œ, ì•„ë˜ cali-FORWARD Ruleì— ì˜í•´ í—ˆìš©ë˜ë©°, pkts ì¹´ìš´íŠ¸ê°€ ì¦ê°€í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> filter <span class="nt">--list</span> FORWARD | egrep <span class="s1">'(cali-FORWARD|pkts)'</span>
<span class="c"># =&gt; pkts bytes target     prot opt in     out     source               destination</span>
<span class="c">#    29375 6505K cali-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:wUHhoiAYhphO9Mso */</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"iptables -v --numeric --table filter --list FORWARD | egrep '(cali-FORWARD|pkts)'"</span>

<span class="c"># íŒŒë“œ1ì—ì„œ ê²Œì´íŠ¸ì›¨ì´ì˜ IPì¸ 169.254.1.1 ì˜ MAC ì£¼ì†Œë¥¼ ì•Œê¸° ìœ„í•´ì„œ ARP Request ë¥¼ ë³´ë‚¸ë‹¤</span>
<span class="c"># ì´ë•Œ veth ì—°ê²°ëœ calice#~ ì— proxy arp ì„¤ì •ì´ ë˜ì–´ ìˆê³ , ìì‹ ì˜ mac ì£¼ì†Œ(ee:ee:ee:ee:ee:ee)ë¥¼ ì•Œë ¤ì£¼ê³ , ì´í›„ ì •ìƒ í†µì‹ ë¨</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> <span class="nv">$VETH1</span> <span class="nt">-nn</span>
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="c">#    listening on calice0906292e2, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="c">#    11:27:01.638238 IP 172.16.158.9 &gt; 172.16.158.8: ICMP echo request, id 134, seq 1, length 64</span>
<span class="c">#    11:27:01.638430 IP 172.16.158.8 &gt; 172.16.158.9: ICMP echo reply, id 134, seq 1, length 64</span>
<span class="c">#    ...</span>
<span class="c">#    11:27:06.675426 &lt;span style="color: #900;"&gt;ARP, Request who-has 169.254.1.1&lt;/span&gt; tell 172.16.158.9, length 28</span>
<span class="c">#    11:27:06.675498 &lt;span style="color: #900;"&gt;ARP, Reply 169.254.1.1 is-at ee:ee:ee:ee:ee:ee&lt;/span&gt;, length 28</span>

<span class="nv">$ </span>tcpdump <span class="nt">-i</span> <span class="nv">$VETH2</span> <span class="nt">-nn</span>
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="c">#    listening on calibd2348b4f67, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="c">#    11:27:01.638389 IP 172.16.158.9 &gt; 172.16.158.8: ICMP echo request, id 134, seq 1, length 64</span>
<span class="c">#    11:27:01.638409 IP 172.16.158.8 &gt; 172.16.158.9: ICMP echo reply, id 134, seq 1, length 64</span>
<span class="c">#    ...</span>
<span class="c">#    11:27:16.151004 &lt;span style="color: #900;"&gt;ARP, Request who-has 169.254.1.1&lt;/span&gt; tell 172.16.158.8, length 28</span>
<span class="c">#    11:27:16.151780 &lt;span style="color: #900;"&gt;ARP, Reply 169.254.1.1 is-at ee:ee:ee:ee:ee:ee&lt;/span&gt;, length 28</span>

<span class="c"># í˜¸ìŠ¤íŠ¸ì—ì„œ calice0906292e2 ì˜ MAC ì£¼ì†Œ ë‹¤ì‹œ í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-d</span> <span class="nb">link</span>
<span class="c"># =&gt; ... </span>
<span class="c">#    9: &lt;span style="color: #900;"&gt;calice0906292e2&lt;/span&gt;@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color: #900;"&gt;ee:ee:ee:ee:ee:ee&lt;/span&gt; brd ff:ff:ff:ff:ff:ff link-netns cni-47754704-48d2-04a9-28fe-e8bff1be17ba promiscuity 1 minmtu 68 maxmtu 65535</span>
<span class="c">#        veth addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_10.png" alt="img.png" class="image-center mb-0" />
<em class="image-caption">íŒŒë“œê°„ í†µì‹  í™•ì¸ ì‹¤ìŠµ</em></p>

<ul>
  <li>ì‹¤ìŠµê²°ê³¼ calice# ì¸í„°í˜ì´ìŠ¤ì— proxy arp ì„¤ì •ì„ í†µí•´ ê²Œì´íŠ¸ì›¨ì´ì˜ MAC ì£¼ì†Œë¥¼ íŒŒë“œê°€ ì „ë‹¬ ë°›ì•„ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
  <li>169.254.1.1ì€ Calico CNIì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²Œì´íŠ¸ì›¨ì´ ì£¼ì†Œë¡œ, ê°™ì€ ë…¸ë“œì˜ íŒŒë“œë¼ë¦¬ í†µì‹ ì‹œ ì‚¬ìš©ë˜ëŠ” ê²ƒì„ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="íŒŒë“œ---ì™¸ë¶€ì¸í„°ë„·-í†µì‹ ">íŒŒë“œ -&gt; ì™¸ë¶€(ì¸í„°ë„·) í†µì‹ </h4>

<ul>
  <li>ì´ë²ˆì—ëŠ” íŒŒë“œì—ì„œ ì™¸ë¶€(ì¸í„°ë„·)ë¡œ í†µì‹ í•˜ëŠ” ê³¼ì •ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_11.png" alt="img.png" class="w-80 image-center" /></p>

<ul>
  <li>calicoëŠ” ê¸°ë³¸ ì„¤ì •ì— <code class="language-plaintext highlighter-rouge">natOutgoing: true</code>ì—¬ì„œ íŒŒë“œì—ì„œ ì™¸ë¶€ë¡œ í†µì‹ í•  ë•ŒëŠ” ë…¸ë“œì˜ IP ì£¼ì†Œë¡œ MASQUERADE(Source NAT)ì„ ìˆ˜í–‰í•˜ì—¬ ì™¸ë¶€ë¡œ í†µì‹ í•©ë‹ˆë‹¤.</li>
  <li>calice# ì¸í„°í˜ì´ìŠ¤ì— proxy arp ì„¤ì •ì„ í†µí•´ ê²Œì´íŠ¸ì›¨ì´ì˜ MAC ì£¼ì†Œë¥¼ íŒŒë“œê°€ ì „ë‹¬ ë°›ì•„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>ì™¸ë¶€ë¡œ í†µì‹ í•  ë•ŒëŠ” tunnel interfaceë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="íŒŒë“œ-ë°°í¬-ì „-ê¸°ë³¸-ìƒíƒœ-í™•ì¸-1">íŒŒë“œ ë°°í¬ ì „ ê¸°ë³¸ ìƒíƒœ í™•ì¸</h5>

<ul>
  <li>calico ì„¤ì • ë° ë…¸ë“œì˜ iptables ì„¤ì •ì„ í™•ì¸í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ í™•ì¸ : natOutgoing ì˜ ê¸°ë³¸ê°’ì€ true ì´ë‹¤</span>
<span class="nv">$ </span>calicoctl get ippool <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   DISABLEBGPEXPORT   SELECTOR</span>
<span class="c">#    default-ipv4-ippool   172.16.0.0/16   true   Always     Never       false      false              all()</span>

<span class="c"># ë…¸ë“œì—ì„œ í™•ì¸ : ë…¸ë“œì—ì„œ ì™¸ë¶€ë¡œ í†µì‹  ì‹œ MASQUERADE ë™ì‘ Rule í™•ì¸</span>
<span class="nv">$ </span>iptables <span class="nt">-n</span> <span class="nt">-t</span> nat <span class="nt">--list</span> cali-nat-outgoing
<span class="c"># =&gt; Chain cali-nat-outgoing (1 references)</span>
<span class="c">#    target     prot opt source               destination</span>
<span class="c">#    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            /* cali:flqWnvo8yq4ULQLa */ match-set cali40masq-ipam-pools src ! match-set cali40all-ipam-pools dst random-fully</span>

<span class="nv">$ </span>ipset list
<span class="nv">$ </span>ipset list cali40masq-ipam-pools
<span class="c"># =&gt; Name: cali40masq-ipam-pools</span>
<span class="c">#    Type: hash:net</span>
<span class="c">#    Revision: 7</span>
<span class="c">#    Header: family inet hashsize 1024 maxelem 1048576 bucketsize 12 initval 0xe6c37fa0</span>
<span class="c">#    Size in memory: 504</span>
<span class="c">#    References: 1</span>
<span class="c">#    Number of entries: 1</span>
<span class="c">#    Members:</span>
<span class="c">#    172.16.0.0/16</span>
</code></pre></div></div>

<h5 id="íŒŒë“œ-ë°°í¬-ë°-ì™¸ë¶€-í†µì‹ -í™•ì¸">íŒŒë“œ ë°°í¬ ë° ì™¸ë¶€ í†µì‹  í™•ì¸</h5>

<ul>
  <li>
    <p>node1-pod1.yaml íŒŒì¼ ì‘ì„±</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">nodeName</span><span class="pi">:</span> <span class="s">k8s-w1</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pod1</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">nicolaka/netshoot</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">tail"</span><span class="pi">]</span>
      <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">-f"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/dev/null"</span><span class="pi">]</span>
  <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>íŒŒë“œ ìƒì„± í›„ í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë“œ ìƒì„±</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> node1-pod1.yaml
  
<span class="c"># ìƒì„±ëœ íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME   READY   STATUS    RESTARTS   AGE   IP              NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod1   1/1     Running   0          25s   172.16.158.10   k8s-w1   &lt;none&gt;           &lt;none&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>íŒŒë“œê°„ í†µì‹  ì‹¤í–‰ ì´í•´ë¥¼ ìœ„í•œ ì¤€ë¹„</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë…¸ë“œì—ì„œ ì‹¤í–‰</span>
<span class="c"># iptables NAT MASQUERADE ëª¨ë‹ˆí„°ë§ : pkts ì¦ê°€ í™•ì¸</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -n -v -t nat --list cali-nat-outgoing'</span>
  
<span class="c"># (ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œ) íŒŒë“œ ì—°ê²°ëœ veth ë¥¼ ë³€ìˆ˜ë¥¼ í™•ì¸</span>
<span class="nv">$ VETH1</span><span class="o">=</span><span class="si">$(</span>calicoctl get workloadEndpoint | <span class="nb">grep </span>pod1 | <span class="nb">awk</span> <span class="s1">'{print $4}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$VETH1</span>
<span class="c"># =&gt; calice0906292e2</span>
  
<span class="c"># (ì›Œì»¤ë…¸ë“œ1) ìœ„ì—ì„œ í™•ì¸í•œ íŒŒë“œ ì—°ê²°ëœ veth ë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
<span class="nv">$ VETH1</span><span class="o">=</span>calice0906292e2
  
<span class="c"># íŒ¨í‚· ë¤í”„ ì‹¤í–‰</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any <span class="nt">-nn</span> icmp
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> <span class="nv">$VETH1</span> <span class="nt">-nn</span> icmp
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> tunl0 <span class="nt">-nn</span> icmp
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> ens5 <span class="nt">-nn</span> icmp    <span class="c"># [ì‹¤ìŠµí™˜ê²½ A Type]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> enp0s8 <span class="nt">-nn</span> icmp  <span class="c"># [ì‹¤ìŠµí™˜ê²½ B Type]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> enp0s3 <span class="nt">-nn</span> icmp  <span class="c"># [ì‹¤ìŠµí™˜ê²½ B Type]</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ì™¸ë¶€ í†µì‹  ì‹¤í–‰ ë° í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë“œì—ì„œ ì™¸ë¶€ ì •ìƒ í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>pod1 <span class="nt">-it</span> <span class="nt">--</span> zsh
<span class="nt">----------------------------</span>
  
<span class="c"># í˜¹ì€ í†µì‹  í™•ì¸ </span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 10 8.8.8.8
  
<span class="c"># The right way to check the weather - ë§í¬</span>
<span class="nv">$ </span>curl wttr.in/seoul
<span class="nv">$ </span>curl <span class="s1">'wttr.in/seoul?format=3'</span>
<span class="nv">$ </span>curl <span class="s1">'wttr.in/busan?format=3'</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s1">'wttr.in/{London,Busan}'</span>
<span class="nv">$ </span>curl v3.wttr.in/Seoul.sxl
<span class="nv">$ </span>curl wttr.in/Moon
<span class="nv">$ </span>curl wttr.in/:help
  
<span class="c"># íŒ¨í‚· ë¤í”„ ë‚´ìš© í™•ì¸</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> calice0906292e2 <span class="nt">-nn</span> icmp
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="c">#    listening on calice0906292e2, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="c">#    12:23:43.792218 IP 172.16.158.10 &gt; 8.8.8.8: ICMP echo request, id 124, seq 1, length 64</span>
<span class="c">#    12:23:43.831040 IP 8.8.8.8 &gt; 172.16.158.10: ICMP echo reply, id 124, seq 1, length 64</span>
<span class="c">#    12:23:44.797713 IP 172.16.158.10 &gt; 8.8.8.8: ICMP echo request, id 124, seq 2, length 64</span>
<span class="c">#    12:23:44.836854 IP 8.8.8.8 &gt; 172.16.158.10: ICMP echo reply, id 124, seq 2, length 64</span>
<span class="c">#    ...</span>
  
<span class="c"># ì•„ë˜ 10.0.2.15ëŠ” VMì˜ 1ë²ˆ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ì˜ IPì´ë©°, ì¶œë°œì§€ IPê°€ ë³€ê²½ë˜ì–´ì„œ ì™¸ë¶€ë¡œ ë‚˜ê°</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> enp0s3 <span class="nt">-nn</span> icmp
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="c">#    listening on enp0s3, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="c">#    12:23:43.792299 IP 10.0.2.15 &gt; 8.8.8.8: ICMP echo request, id 25687, seq 1, length 64</span>
<span class="c">#    12:23:43.830978 IP 8.8.8.8 &gt; 10.0.2.15: ICMP echo reply, id 25687, seq 1, length 64</span>
<span class="c">#    12:23:44.797877 IP 10.0.2.15 &gt; 8.8.8.8: ICMP echo request, id 25687, seq 2, length 64</span>
<span class="c">#    12:23:44.836812 IP 8.8.8.8 &gt; 10.0.2.15: ICMP echo reply, id 25687, seq 2, length 64</span>
  
<span class="c"># nat MASQUERADE rule ì¹´ìš´íŠ¸(pkts)ê°€ ì¦ê°€!</span>
<span class="c">## ì¶œë°œì§€ ë§¤ì¹­ì€ cali40masq-ipam-pools ì„ ì‚¬ìš©</span>
<span class="c"># watch -d 'iptables -n -v -t nat --list cali-nat-outgoing'</span>
<span class="nv">$ </span>iptables <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-t</span> nat <span class="nt">--list</span> cali-nat-outgoing
<span class="c"># =&gt; Chain cali-nat-outgoing (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination</span>
<span class="c">#        9   636 MASQUERADE  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:flqWnvo8yq4ULQLa */ match-set cali40masq-ipam-pools src ! match-set cali40all-ipa</span>
<span class="c">#    m-pools dst random-fully</span>
  
<span class="c"># IPSET ìœ¼ë¡œ ì˜ cali40masq-ipam-pools IP ëŒ€ì—­ ì •ë³´ í™•ì¸ : 172.16.0.0/16 ëŒ€ì—­ì„ì„ í™•ì¸</span>
<span class="nv">$ </span>ipset list cali40masq-ipam-pools
<span class="c"># =&gt; Name: cali40masq-ipam-pools</span>
<span class="c">#    Type: hash:net</span>
<span class="c">#    Revision: 7</span>
<span class="c">#    Header: family inet hashsize 1024 maxelem 1048576 bucketsize 12 initval 0x59a55159</span>
<span class="c">#    Size in memory: 504</span>
<span class="c">#    References: 1</span>
<span class="c">#    Number of entries: 1</span>
<span class="c">#    Members:</span>
<span class="c">#    172.16.0.0/16</span>
</code></pre></div>    </div>

    <p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_12.png" alt="20240921_kans_w3_12.png" /></p>
  </li>
  <li>ì´ë ‡ê²Œ ì™¸ë¶€ì™€ì˜ í†µì‹ ì‹œ í„°ë„ë§(tunl0)ì€ í†µí•˜ì§€ ì•Šê³  calice# ì¸í„°í˜ì´ìŠ¤ì™€ enp0s3 ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ì™¸ë¶€ë¡œ í†µì‹ í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
  <li>enp0s8 ì¸í„°í˜ì´ìŠ¤ëŠ” virtualboxìƒì˜ host only ì¸í„°í˜ì´ìŠ¤ì—¬ì„œ íŒ¨í‚·ì´ ì „ë‹¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="ë‹¤ë¥¸-ë…¸ë“œì˜-íŒŒë“œ--íŒŒë“œê°„-í†µì‹ ">ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œ &lt;=&gt; íŒŒë“œê°„ í†µì‹ </h4>

<ul>
  <li>ì´ë²ˆì—ëŠ” ì„œë¡œ ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œê°„ì˜ í†µì‹ ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œì™€ì˜ í†µì‹ ì€ <strong>IPIP</strong>(IP in IP) í„°ë„ë§ì„ í†µí•´ í†µì‹ í•©ë‹ˆë‹¤.</li>
  <li>ê° ë…¸ë“œì—ì„œ íŒŒë“œ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì€ Birdì— ì˜í•´ì„œ BGPë¡œ ì „íŒŒë˜ë©°, Felixì— ì˜í•´ ë…¸ë“œì˜ ë¼ìš°íŒ… í…Œì´ë¸”ì— ìë™ìœ¼ë¡œ ì¶”ê°€/ì‚­ì œ ë©ë‹ˆë‹¤.</li>
  <li>ë‹¤ë¥¸ ë…¸ë“œê°„ì˜ í†µì‹ ì€ tunl0 ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ IP í—¤ë”ì— IPIP í—¤ë”ë¥¼ ì¶”ê°€í•˜ì—¬, ìƒëŒ€ë°© ë…¸ë“œë¡œ ë„ì°© í›„ tunl0 ì¸í„°í˜ì´ìŠ¤ì—ì„œ IPIP í—¤ë”ë¥¼ ì œê±°í•˜ê³ , ìµœì¢…ì ìœ¼ë¡œ ìƒëŒ€ë°© íŒŒë“œë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w3/20240921_kans_w3_14.png" alt="img.png" class="w-80 image-center" />
<em class="image-caption">IPIP ë™ì‘ë°©ì‹ <a href="https://en.wikipedia.org/wiki/IP_in_IP">ì¶œì²˜</a></em></li>
  <li>ê·¸ë¦¼ìœ¼ë¡œ ë‚˜íƒ€ë‚´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_13.png" alt="img.png" /></p>

<h5 id="íŒŒë“œ-ë°°í¬-ì „-ê¸°ë³¸-ìƒíƒœ-í™•ì¸-2">íŒŒë“œ ë°°í¬ ì „ ê¸°ë³¸ ìƒíƒœ í™•ì¸</h5>

<ul>
  <li>ë…¸ë“œì—ì„œ Bird ë¼ìš°íŒ… ì •ë³´ì™€ Felix ë¼ìš°íŒ… í…Œì´ë¸” ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸</span>
<span class="nv">$ </span>route | <span class="nb">head</span> <span class="nt">-2</span> <span class="p">;</span> route <span class="nt">-n</span> | <span class="nb">grep </span>tunl0
<span class="c"># =&gt; Kernel IP routing table</span>
<span class="c">#    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span>
<span class="c">#    172.16.34.0     192.168.20.100  255.255.255.0   UG    0      0        0 tunl0</span>
<span class="c">#    172.16.158.0    192.168.10.101  255.255.255.0   UG    0      0        0 tunl0</span>
<span class="c">#    172.16.184.0    192.168.10.102  255.255.255.0   UG    0      0        0 tunl0</span>

<span class="c"># ë…¸ë“œ1</span>
<span class="nv">$ </span>route | <span class="nb">head</span> <span class="nt">-2</span> <span class="p">;</span> route <span class="nt">-n</span> | <span class="nb">grep </span>tunl0
<span class="c"># =&gt; Kernel IP routing table</span>
<span class="c">#    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span>
<span class="c">#    172.16.34.0     192.168.20.100  255.255.255.0   UG    0      0        0 tunl0</span>
<span class="c">#    172.16.116.0    192.168.10.10   255.255.255.0   UG    0      0        0 tunl0</span>
<span class="c">#    172.16.184.0    192.168.10.102  255.255.255.0   UG    0      0        0 tunl0</span>
</code></pre></div></div>

<ul>
  <li>ë…¸ë“œì˜ tunl0 ì •ë³´ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë…¸ë“œ1</span>
<span class="nv">$ </span>ifconfig enp0s3
<span class="c"># =&gt; enp0s3: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  &lt;span style="color: red;"&gt;mtu 1500&lt;/span&gt;</span>
<span class="c">#             inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255</span>

<span class="nv">$ </span>ifconfig tunl0
<span class="c"># =&gt; tunl0: flags=193&lt;UP,RUNNING,NOARP&gt;  &lt;span style="color: red;"&gt;mtu 1480&lt;/span&gt;</span>
<span class="c">#            inet 172.16.158.0  netmask 255.255.255.255</span>
<span class="c">#            tunnel   txqueuelen 1000  (IPIP Tunnel)</span>
<span class="c">#            RX packets 11581  bytes 917302 (917.3 KB)</span>
<span class="c">#            RX errors 0  dropped 0  overruns 0  frame 0</span>
<span class="c">#            TX packets 12036  bytes 2774296 (2.7 MB)</span>
<span class="c">#            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span>

<span class="c"># ë…¸ë“œ2</span>
<span class="nv">$ </span>ifconfig tunl0
<span class="c"># =&gt; tunl0: flags=193&lt;UP,RUNNING,NOARP&gt;  &lt;span style="color: red;"&gt;mtu 1480&lt;/span&gt;</span>
<span class="c">#            inet 172.16.184.0  netmask 255.255.255.255</span>
<span class="c">#            tunnel   txqueuelen 1000  (IPIP Tunnel)</span>
<span class="c">#            RX packets 0  bytes 0 (0.0 B)</span>
<span class="c">#            RX errors 0  dropped 0  overruns 0  frame 0</span>
<span class="c">#            TX packets 0  bytes 0 (0.0 B)</span>
<span class="c">#            TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span>
</code></pre></div></div>

<ul>
  <li>í„°ë„ ì¸í„°í˜ì´ìŠ¤ì¸ tunl0ì— IPê°€ í• ë‹¹ë˜ì–´ìˆê³ , MTUëŠ” 1480ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. enp0s3 ì¸í„°í˜ì´ìŠ¤ëŠ” mtuê°€ 1500ì¸ë° tunl0 ì¸í„°í˜ì´ìŠ¤ëŠ” mtuê°€ 1480ìœ¼ë¡œ ì„¤ì •ëœ ì´ìœ ëŠ”, IPIPì˜ 20ë°”ì´íŠ¸ í—¤ë”ë¥¼ ì¶”ê°€í•˜ê¸° ìœ„í•´ì„œì…ë‹ˆë‹¤.</li>
</ul>

<h5 id="íŒŒë“œ-ë°°í¬">íŒŒë“œ ë°°í¬</h5>

<ul>
  <li>í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë…¸ë“œ1ê³¼ ë…¸ë“œ2ì— ê°ê° íŒŒë“œ 1ê°œì”© ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤.</li>
  <li>node2-pod2.yaml ìƒì„±
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># node2-pod2.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">nodeName</span><span class="pi">:</span> <span class="s">k8s-w1</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pod1</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">nicolaka/netshoot</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">tail"</span><span class="pi">]</span>
      <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">-f"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/dev/null"</span><span class="pi">]</span>
  <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">nodeName</span><span class="pi">:</span> <span class="s">k8s-w2</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pod2</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">nicolaka/netshoot</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">tail"</span><span class="pi">]</span>
      <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">-f"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/dev/null"</span><span class="pi">]</span>
  <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>íŒŒë“œ ìƒì„± í›„ í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> node2-pod2.yaml
<span class="c"># =&gt; pod/pod1 created</span>
<span class="c">#    pod/pod2 created</span>
  
<span class="c"># calicoctl ì´ìš©í•œ endpoint í™•ì¸</span>
<span class="nv">$ </span>calicoctl get workloadendpoints
<span class="c"># =&gt; WORKLOAD   NODE     NETWORKS           INTERFACE</span>
<span class="c">#    pod1       k8s-w1   172.16.158.11/32   calice0906292e2</span>
<span class="c">#    pod2       k8s-w2   172.16.184.16/32   calibd2348b4f67</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>pod1ì´ node1ì—, pod2ê°€ node2ì— ìƒì„±ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŒŒë“œ ìƒì„± í›„ ìƒíƒœëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>

    <p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_15.png" alt="img.png" /></p>
  </li>
</ul>

<h5 id="íŒŒë“œê°„-í†µì‹ -ì‹¤í–‰-ë°-í™•ì¸-1">íŒŒë“œê°„ í†µì‹  ì‹¤í–‰ ë° í™•ì¸</h5>

<ul>
  <li>Calico CNIëŠ” ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œê°„ í†µì‹ ì„ ìœ„í•´ IPIP í„°ë„ë§ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>IPIPë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ <strong>í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì—ì„œ IPIP í„°ë„ë§ì„ í—ˆìš©í•´ì•¼</strong> í•©ë‹ˆë‹¤. í˜„ì¬ <strong>AzureëŠ” IPIP íŒ¨í‚·ì„ í—ˆìš©í•˜ì§€ ì•Šê³ </strong> ìˆìœ¼ë©°, ì´ëŸ¬í•œ ê²½ìš° <strong>Flannelì„ ì‚¬ìš©í•˜ê±°ë‚˜</strong>, <strong>Calicoì˜ VXLANì„ ì‚¬ìš©</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë‹¤ìŒ ê·¸ë¦¼ê³¼ ê°™ì´ tunl0ì™€ eth0 ì¸í„°í˜ì´ìŠ¤ì— tcpdumpë¥¼ ì‚¬ìš©í•˜ì—¬ íŒ¨í‚·ì„ ìº¡ì³í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_16.png" alt="img.png" /></p>

<ul>
  <li>ë…¸ë“œ1ê³¼ ë…¸ë“œ2ì—ì„œ ê°ê° ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># tunl0 ì¸í„°í˜ì´ìŠ¤ TX/RX íŒ¨í‚· ì¹´ìš´íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'ifconfig tunl0 | head -2 ; ifconfig tunl0 | grep bytes'</span>

<span class="c"># íŒ¨í‚· ë¤í”„ tunl0</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> tunl0 <span class="nt">-nn</span>

<span class="c"># íŒ¨í‚· ë¤í”„ : IP í—¤ë”ì˜ ìƒìœ„ í”„ë¡œí† ì½œì„ IPIP(4)ì¸ íŒ¨í‚·ë§Œ í•„í„°ë§</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> enp0s8 <span class="nt">-nn</span> ip proto 4
</code></pre></div></div>

<ul>
  <li>íŒŒë“œ1ì—ì„œ íŒŒë“œ2ë¡œ ping í†µì‹ ì„ ì‹¤í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_17.png" alt="img.png" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ pod1 Shell ì ‘ì†</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>pod1 <span class="nt">-it</span> <span class="nt">--</span> zsh

<span class="c"># pod1 ì—ì„œ pod2 ë¡œ í•‘ í†µì‹  : ì •ìƒ í†µì‹ !</span>
<span class="c"># ping -c 10 &lt;pod2 IP&gt;</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 10 172.16.184.16
<span class="c"># =&gt; PING 172.16.184.16 (172.16.184.16) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.16.184.16: icmp_seq=1 ttl=62 time=1.42 ms</span>
<span class="c">#    64 bytes from 172.16.184.16: icmp_seq=2 ttl=62 time=2.32 ms</span>
<span class="c">#    ...</span>

<span class="c"># tunl0 ì¸í„°í˜ì´ìŠ¤ TX/RX íŒ¨í‚· ì¹´ìš´íŠ¸ ëª¨ë‹ˆí„°ë§ í™•ì¸ : TX/RX íŒ¨í‚· ì¹´ìš´íŠ¸ê°€ ê°ê° 10ê°œë¡œ ì¦ê°€í–ˆë‹¤</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'ifconfig tunl0 | head -2 ; ifconfig tunl0 | grep bytes'</span>
<span class="c"># =&gt; tunl0: flags=193&lt;UP,RUNNING,NOARP&gt;  mtu 1480</span>
<span class="c">#            inet 172.16.184.0  netmask 255.255.255.255</span>
<span class="c">#            RX packets 10  bytes 840 (840.0 B)</span>
<span class="c">#            TX packets 10  bytes 840 (840.0 B)</span>

<span class="c"># íŒ¨í‚· ë¤í”„ : tunl0 - í„°ë„ ì¸í„°í˜ì´ìŠ¤ì— íŒŒë“œê°„ IP íŒ¨í‚· ì •ë³´ í™•ì¸!</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> tunl0 <span class="nt">-nn</span>
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span>
<span class="c">#    listening on tunl0, link-type RAW (Raw IP), capture size 262144 bytes</span>
<span class="c">#    15:42:06.220413 IP 172.16.158.11 &gt; 172.16.184.16: ICMP echo request, id 259, seq 1, length 64</span>
<span class="c">#    15:42:06.220720 IP 172.16.184.16 &gt; 172.16.158.11: ICMP echo reply, id 259, seq 1, length 64</span>
<span class="c">#    15:42:07.250941 IP 172.16.158.11 &gt; 172.16.184.16: ICMP echo request, id 259, seq 2, length 64</span>
<span class="c">#    15:42:07.252035 IP 172.16.184.16 &gt; 172.16.158.11: ICMP echo reply, id 259, seq 2, length 64</span>
<span class="c">#    ...</span>
...

<span class="c"># íŒ¨í‚· ë¤í”„ : eth0(enp#~) - IP Outer í—¤ë” ì•ˆìª½ì— IP í—¤ë” 1ê°œê°€ ë” ìˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> enp0s8 <span class="nt">-nn</span> proto 4 
<span class="c"># =&gt; 15:42:06.220427 &lt;span style="color: red;"&gt;IP&lt;/span&gt; 192.168.10.101 &gt; 192.168.10.102: &lt;span style="color: red;"&gt;IP&lt;/span&gt; 172.16.158.11 &gt; 172.16.184.16: &lt;span style="color: red;"&gt;ICMP echo&lt;/span&gt; request, id 259, seq 1, length 64</span>
<span class="c">#    15:42:06.220720 &lt;span style="color: red;"&gt;IP&lt;/span&gt; 192.168.10.102 &gt; 192.168.10.101: &lt;span style="color: red;"&gt;IP&lt;/span&gt; 172.16.184.16 &gt; 172.16.158.11: &lt;span style="color: red;"&gt;ICMP echo&lt;/span&gt; reply, id 259, seq 1, length 64</span>
<span class="c">#    15:42:07.250959 &lt;span style="color: red;"&gt;IP&lt;/span&gt; 192.168.10.101 &gt; 192.168.10.102: &lt;span style="color: red;"&gt;IP&lt;/span&gt; 172.16.158.11 &gt; 172.16.184.16: &lt;span style="color: red;"&gt;ICMP echo&lt;/span&gt; request, id 259, seq 2, length 64</span>
<span class="c">#    15:42:07.252035 &lt;span style="color: red;"&gt;IP&lt;/span&gt; 192.168.10.102 &gt; 192.168.10.101: &lt;span style="color: red;"&gt;IP&lt;/span&gt; 172.16.184.16 &gt; 172.16.158.11: &lt;span style="color: red;"&gt;ICMP echo&lt;/span&gt; reply, id 259, seq 2, length 64</span>
</code></pre></div></div>

<ul>
  <li>ì‹¤ìŠµ ê²°ê³¼ tunl0 ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•œ íŒ¨í‚·ì´ IP í—¤ë”ì— IPIP í—¤ë”ê°€ ì¶”ê°€ë˜ì–´ ë…¸ë“œì˜ enp0s8 ì¸í„°í˜ì´ìŠ¤ë¡œ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
  <li>enp0s8 ì¸í„°í˜ì´ìŠ¤ì—ëŠ” íŒŒë“œì˜ IPì¸ 172.16.x.x ëŒ€ì—­ì˜ IP íŒ¨í‚·ì´ ë…¸ë“œì˜ IP ëŒ€ì—­ì¸ 192.168.x.x ëŒ€ì—­ìœ¼ë¡œ ê°ì‹¸ì ¸ì„œ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
  <li>ìº¡ì³ëœ íŒ¨í‚·ì„ wiresharkë¡œ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_18.png" alt="img.png" /></p>

<ul>
  <li>ì‹¤ì œ ICMP í”„ë¡œí† ì½œì˜ ìƒìœ„ì— íŒŒë“œì˜ IP í”„ë¡œí† ì½œì´ ìˆê³ , ê·¸ ìœ„ì— ë…¸ë“œì˜ IP í”„ë¡œí† ì½œì´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h3 id="calico-ë„¤íŠ¸ì›Œí¬-ëª¨ë“œ">Calico ë„¤íŠ¸ì›Œí¬ ëª¨ë“œ</h3>

<ul>
  <li>CalicoëŠ” ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œë¥¼ ì§€ì›í•©ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ëª¨ë“œëŠ” Calicoì˜ CNI ì„¤ì •ì„ í†µí•´ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>
    <p>Calicoì˜ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

    <table>
      <thead>
        <tr>
          <th style="text-align: center">ë„¤íŠ¸ì›Œí¬ ëª¨ë“œ</th>
          <th style="text-align: left">ì„¤ëª…</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: center">IPIP</td>
          <td style="text-align: left">IPIP í„°ë„ë§ì„ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ ê°„ í†µì‹ ì„ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œì…ë‹ˆë‹¤.</td>
        </tr>
        <tr>
          <td style="text-align: center">Direct</td>
          <td style="text-align: left">í˜¸ìŠ¤íŠ¸ì˜ ë¬¼ë¦¬ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ ê°„ í†µì‹ ì„ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œì…ë‹ˆë‹¤.</td>
        </tr>
        <tr>
          <td style="text-align: center">VXLAN</td>
          <td style="text-align: left">Flannelì—ì„œ ì‚¬ìš©í–ˆë˜ VXLANì„ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ ê°„ í†µì‹ ì„ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œì…ë‹ˆë‹¤.</td>
        </tr>
        <tr>
          <td style="text-align: center">Pod íŒ¨í‚· ì•”í˜¸í™”</td>
          <td style="text-align: left">WireGuardë¥¼ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ ê°„ í†µì‹ ì„ ì•”í˜¸í™” í•˜ê¸° ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œì…ë‹ˆë‹¤.</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>ì„±ëŠ¥ì€ Direct &gt; IPIP &gt; VXLAN ìˆœìœ¼ë¡œ ë†’ì§€ë§Œ, IPIPëŠ” í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì—ì„œ IPIP í„°ë„ë§ì„ í—ˆìš©í•´ì•¼ í•˜ê³ ,
DirectëŠ” ë¬¼ë¦¬ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì§ì ‘ í†µì‹ í•˜ë¯€ë¡œ íŒŒë“œì˜ ë¼ìš°íŒ…ì´ë‚˜ ë°©í™”ë²½ ì •ì±…ì„ ì ìš©í•˜ëŠ”ê²ƒì´ ê¹Œë‹¤ë¡œìš´ ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Pod íŒ¨í‚· ì•”í˜¸í™”ëŠ” WireGuardë¥¼ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ ê°„ í†µì‹ ì„ ì•”í˜¸í™”í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ, ê°€ì¥ ì•ˆì „í•˜ì§€ë§Œ ì•”í˜¸í™”ì— ë”°ë¥¸ 
ë¶€í•˜ì™€ ì§€ì—°ì´ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.</li>
  <li>ì´ëŸ¬í•œ íŠ¹ì„±ë“¤ì„ ì˜ ì´í•´í•˜ì—¬ ì ì ˆí•œ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œë¥¼ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>ê°ê°ì˜ modeì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="ipip-ëª¨ë“œ">IPIP ëª¨ë“œ</h4>

<ul>
  <li>IPIP ëª¨ë“œëŠ” ë…¸ë“œ ê°„ í†µì‹ ì„ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œë¡œ, IPIP í„°ë„ë§ì„ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ ê°„ í†µì‹ ì„ í•©ë‹ˆë‹¤.</li>
  <li>ì•ì„  ì‹¤ìŠµë“¤ì´ ëª¨ë‘ IPIP ëª¨ë“œë¡œ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. Calicoì˜ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œì´ë©°, ì ì ˆí•œ ì†ë„ì™€ ì¢‹ì€ ì‚¬ìš©ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>ë‹¨ì ìœ¼ë¡œëŠ” í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì—ì„œ IPIP í„°ë„ë§ì„ í—ˆìš©í•´ì•¼ í•˜ë©°, IPIP í„°ë„ë§ìœ¼ë¡œ ì¸í•œ ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="ipip-ëª¨ë“œ-ì„¤ì •">IPIP ëª¨ë“œ ì„¤ì •</h5>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">projectcalico.org/v3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IPPool</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default-ipv4-ippool</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">allowedUses</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Workload</span>
  <span class="pi">-</span> <span class="s">Tunnel</span>
  <span class="na">blockSize</span><span class="pi">:</span> <span class="m">24</span>
  <span class="na">cidr</span><span class="pi">:</span> <span class="s">172.16.0.0/16</span>
  <span class="na">natOutgoing</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">ipipMode</span><span class="pi">:</span> <span class="s">Always</span>  <span class="c1"># IPIP ëª¨ë“œ ì„¤ì •</span>
  <span class="na">vxlanMode</span><span class="pi">:</span> <span class="s">Never</span>
</code></pre></div></div>

<h5 id="í†µì‹ -íë¦„">í†µì‹  íë¦„</h5>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_19.png" alt="img.png" class="w-80 image-center" /></p>

<ul>
  <li>ë‹¤ë¥¸ ë…¸ë“œì™€ì˜ íŒŒë“œê°„ì˜ í†µì‹ ì€ tunl0 ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ IP í—¤ë”ì— IP í—¤ë”ë¥¼ ê°ì‹¸ì„œ(IP-in-IP) ìƒëŒ€ ë…¸ë“œì— ë„ë‹¬í›„ IPIP í—¤ë”ë¥¼ ì œê±°í•˜ê³  ìµœì¢…ì ìœ¼ë¡œ ìƒëŒ€ë°© íŒŒë“œë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</li>
  <li>ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œ ëŒ€ì—­ì€ BGPë¡œ ì „íŒŒë˜ë©°, Felixì— ì˜í•´ ë…¸ë“œì˜ ë¼ìš°íŒ… í…Œì´ë¸”ì— ìë™ìœ¼ë¡œ ì¶”ê°€/ì‚­ì œ ë©ë‹ˆë‹¤.</li>
</ul>

<h4 id="direct-ëª¨ë“œ">Direct ëª¨ë“œ</h4>

<ul>
  <li>Direct ëª¨ë“œëŠ” ë…¸ë“œ ê°„ í†µì‹ ì„ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œë¡œ, í˜¸ìŠ¤íŠ¸ì˜ ë¬¼ë¦¬ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ ê°„ í†µì‹ ì„ í•©ë‹ˆë‹¤.</li>
  <li>í´ë¼ìš°ë“œ ì‚¬ì—…ì ë„¤íŠ¸ì›Œí¬ì—ì„œëŠ” NICì— ë§¤ì¹­ë˜ì§€ ì•Šì€ IP íŒ¨í‚·ì´ ì°¨ë‹¨ë˜ê¸° ë•Œë¬¸ì—, NICì—ì„œ Source/Destination Check ê¸°ëŠ¥ì„ í•´ì œí•´ì•¼ í•©ë‹ˆë‹¤. <a href="https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/VPC_NAT_Instance.html#EIP_Disable_SrcDestCheck">ë§í¬</a>
    <ul>
      <li>AWSì—ì„œëŠ” ë‹¤ìŒì˜ AWS CLI ëª…ë ¹ìœ¼ë¡œ NICì˜ Source/Destination Check ê¸°ëŠ¥ì„ í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws ec2 modify-instance-attribute <span class="nt">--instance-id</span> &lt;INSTANCE_ID&gt; <span class="nt">--source-dest-check</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">Value</span><span class="se">\"</span><span class="s2">: false}"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Virtual boxì—ì„œëŠ” NICì˜ promiscuous modeë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="direct-ëª¨ë“œ-ì„¤ì •">Direct ëª¨ë“œ ì„¤ì •</h5>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">projectcalico.org/v3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IPPool</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default-ipv4-ippool</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">allowedUses</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Workload</span>
  <span class="pi">-</span> <span class="s">Tunnel</span>
  <span class="na">blockSize</span><span class="pi">:</span> <span class="m">24</span>
  <span class="na">cidr</span><span class="pi">:</span> <span class="s">172.16.0.0/16</span>
  <span class="na">natOutgoing</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">ipipMode</span><span class="pi">:</span> <span class="s">Never</span>   <span class="c1"># IPIP ëª¨ë“œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ</span>
  <span class="na">vxlanMode</span><span class="pi">:</span> <span class="s">Never</span>
</code></pre></div></div>

<h5 id="í†µì‹ -íë¦„-1">í†µì‹  íë¦„</h5>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_20.png" alt="img.png" class="w-80 image-center" /></p>

<h5 id="cross-subnet-ëª¨ë“œ">Cross Subnet ëª¨ë“œ</h5>

<ul>
  <li>Direct ëª¨ë“œëŠ” Cross Subnet ëª¨ë“œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>
    <p>Cross Subnet ëª¨ë“œëŠ” ë…¸ë“œê°„ì˜ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì´ ë‹¤ë¥¼ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©°, <strong>ë…¸ë“œê°„ ê°™ì€ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì´ë©´ Direct ëª¨ë“œ</strong>ë¡œ ë™ì‘í•˜ê³ ,
<strong>ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì´ë©´ IPIP/VXLAN ëª¨ë“œ</strong>ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>IPIPë¥¼ ì´ìš©í•œ Cross Subnet ëª¨ë“œ ì„¤ì •</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">projectcalico.org/v3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IPPool</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default-ipv4-ippool</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">allowedUses</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Workload</span>
  <span class="pi">-</span> <span class="s">Tunnel</span>
  <span class="na">blockSize</span><span class="pi">:</span> <span class="m">24</span>
  <span class="na">cidr</span><span class="pi">:</span> <span class="s">172.16.0.0/16</span>
  <span class="na">natOutgoing</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">ipipMode</span><span class="pi">:</span> <span class="s">CrossSubnet</span>   <span class="c1"># IPIP ëª¨ë“œë¥¼ Subnetì´ ë‹¤ë¥¼ë•Œë§Œ ì‚¬ìš©</span>
  <span class="na">vxlanMode</span><span class="pi">:</span> <span class="s">Never</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>VXLANë¥¼ ì´ìš©í•œ Cross Subnet ëª¨ë“œ ì„¤ì •</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">projectcalico.org/v3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IPPool</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default-ipv4-ippool</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">allowedUses</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Workload</span>
  <span class="pi">-</span> <span class="s">Tunnel</span>
  <span class="na">blockSize</span><span class="pi">:</span> <span class="m">24</span>
  <span class="na">cidr</span><span class="pi">:</span> <span class="s">172.16.0.0/16</span>
  <span class="na">natOutgoing</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">ipipMode</span><span class="pi">:</span> <span class="s">Never</span>   
  <span class="na">vxlanMode</span><span class="pi">:</span> <span class="s">CrossSubnet</span>      <span class="c1"># VXLAN ëª¨ë“œë¥¼ Subnetì´ ë‹¤ë¥¼ë•Œë§Œ ì‚¬ìš©</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="vxlan-ëª¨ë“œ">VXLAN ëª¨ë“œ</h4>

<ul>
  <li>VXLAN ëª¨ë“œëŠ” Flannelì—ì„œ ì‚¬ìš©í–ˆë˜ VXLANì„ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ ê°„ í†µì‹ ì„ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œì…ë‹ˆë‹¤.</li>
  <li>IPIP ëª¨ë“œì™€ ë¹„ìŠ·í•˜ì§€ë§Œ, VXLANì€ IPIPë³´ë‹¤ ì†ë„ê°€ ëŠë¦¬ì§€ë§Œ, í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì—ì„œ IPIP í„°ë„ë§ì„ í—ˆìš©í•˜ì§€ ì•Šì„ ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="vxlan-ëª¨ë“œ-ì„¤ì •">VXLAN ëª¨ë“œ ì„¤ì •</h5>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">projectcalico.org/v3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IPPool</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default-ipv4-ippool</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">allowedUses</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">Workload</span>
  <span class="pi">-</span> <span class="s">Tunnel</span>
  <span class="na">blockSize</span><span class="pi">:</span> <span class="m">24</span>
  <span class="na">cidr</span><span class="pi">:</span> <span class="s">172.16.0.0/16</span>
  <span class="na">natOutgoing</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">ipipMode</span><span class="pi">:</span> <span class="s">Never</span>  
  <span class="na">vxlanMode</span><span class="pi">:</span> <span class="s">Always</span> <span class="c1"># VXLAN ëª¨ë“œ ì„¤ì •</span>
</code></pre></div></div>

<h5 id="í†µì‹ -íë¦„-2">í†µì‹  íë¦„</h5>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_21.png" alt="img.png" class="w-80 image-center" /></p>

<ul>
  <li>VXLANì€ vxlan ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ L2 íŒ¨í‚·ì„ UDP - VXLANìœ¼ë¡œ ê°ì‹¸ì„œ ìƒëŒ€ì¸¡ ë…¸ë“œë¡œ ì „ë‹¬ í›„ vxlan ì¸í„°í˜ì´ìŠ¤ì—ì„œ VXLANì—ì„œ ì‹¤ì œ L2 í”„ë ˆì„ì„ ì¶”ì¶œí•˜ì—¬ ìµœì¢…ì ìœ¼ë¡œ ìƒëŒ€ë°© íŒŒë“œë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</li>
  <li>ì´ë•Œ BGP ëŠ” ë¯¸ì‚¬ìš©ë˜ë©°, VXLAN L3 ë¼ìš°íŒ…ì„ í†µí•´ì„œ ë™ì‘í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="íŒŒë“œ-íŒ¨í‚·-ì•”í˜¸í™”-ë„¤íŠ¸ì›Œí¬-ë ˆë²¨">íŒŒë“œ íŒ¨í‚· ì•”í˜¸í™” (ë„¤íŠ¸ì›Œí¬ ë ˆë²¨)</h4>

<ul>
  <li>WireGuardë¥¼ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ ê°„ í†µì‹ ì„ ì•”í˜¸í™”í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ, ê°€ì¥ ì•ˆì „í•˜ì§€ë§Œ ì•”í˜¸í™”ì— ë”°ë¥¸ ë¶€í•˜ì™€ ì§€ì—°ì´ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.</li>
  <li>ìµœê·¼ ëŒ€ë‘ë˜ê³  ìˆëŠ” ì œë¡œ íŠ¸ëŸ¬ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì‚¬ìš©ë˜ëŠ” WireGuardëŠ” IPSecì´ë‚˜ OpenVPNê³¼ ê°™ì€ VPN í”„ë¡œí† ì½œì´ë©°, ê¸°ì¡´ì˜ VPNë“¤ ë³´ë‹¤ ë¹ ë¥´ê³  ê°„ë‹¨í•˜ë©°, ì ì€ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="wireguard-ëª¨ë“œ-ì„¤ì •">WireGuard ëª¨ë“œ ì„¤ì •</h5>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">projectcalico.org/v3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">FelixConfiguration</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">bpfConnectTimeLoadBalancing</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">bpfHostNetworkedNATWithoutCTLB</span><span class="pi">:</span> <span class="s">Enabled</span>
  <span class="na">bpfLogLevel</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">floatingIPs</span><span class="pi">:</span> <span class="s">Disabled</span>
  <span class="na">logSeverityScreen</span><span class="pi">:</span> <span class="s">Info</span>
  <span class="na">reportingInterval</span><span class="pi">:</span> <span class="s">0s</span>
  <span class="na">wireguardEnabled</span><span class="pi">:</span> <span class="kc">true</span>    <span class="c1"># wireguard ì‚¬ìš© ì„¤ì •</span>
</code></pre></div></div>

<h5 id="í†µì‹ -íë¦„-3">í†µì‹  íë¦„</h5>

<p><img src="/assets/2024/kans-3th/w3/20240921_kans_w3_22.png" alt="img_1.png" class="w-80 image-center" /></p>

<ul>
  <li>ì›ë³¸ íŒ¨í‚·ì´ wireg ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ WireGuardë¡œ ì•”í˜¸í™”ë˜ì–´ ìƒëŒ€ë°© ë…¸ë“œë¡œ ì „ë‹¬ë˜ë©°, ìƒëŒ€ë°© ë…¸ë“œì—ì„œëŠ” wireg ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ë³µí˜¸í™”í•˜ì—¬ ìµœì¢…ì ìœ¼ë¡œ ìƒëŒ€ë°© íŒŒë“œë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì§€ê¸ˆê¹Œì§€ Calicoì˜ ê¸°ë³¸ì ì¸ êµ¬ì„±ê³¼ ë™ì‘ ë°©ì‹ì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.
Flannelì— ë¹„í•´ ë§ì€ ê¸°ëŠ¥ì„ ì œê³µí•˜ê³ , ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì¢€ ë” ì•ˆì „í•˜ê³  ë¹ ë¥¸ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì„ ì œê³µí•˜ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.
IP-in-IP ê°œë…ì€ ì²˜ìŒ ë³´ëŠ” ë‚´ìš©ì´ë¼ ì‹ ì„ í•˜ì˜€ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ IPIPì˜ ê²½ìš° í´ë¼ìš°ë“œ í™˜ê²½ì— ë”°ë¼ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ìš¸ ìˆ˜ë„ ìˆê³ ,
Direct ëª¨ë“œëŠ” promiscuous modeë¡œ ì¸í•´ ë¶ˆí•„ìš”í•œ ì˜¤ë²„í—¤ë“œì™€ ë³´ì•ˆ ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
VXLANì„ ì‚¬ìš©í•˜ìë‹ˆ Flannelì— ë¹„í•´ ìš°ìœ„ê°€ í¬ê²Œ ì—†ì–´ ë³´ì´ê³ , ì œë¡œíŠ¸ëŸ¬ìŠ¤íŠ¸ê°€ í•„ìš”í•œ í™˜ê²½ì—ì„œ íŒŒë“œ íŒ¨í‚· ì•”í˜¸í™”ë¥¼ 
ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ì¢‹ì•„ë³´ì…ë‹ˆë‹¤.</p>

<p>ê¸°ì¡´ì— ë§ì´ë“¤ ì“´ë‹¤ê³  í•´ì„œ Calicoë¥¼ ì‚¬ìš©í–ˆì—ˆëŠ”ë° ì´ë ‡ê²Œ ì‹¬ì˜¤í•œ ì„¸ê³„ê°€ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œê²Œ ë˜ì–´ì„œ ê¸°ì©ë‹ˆë‹¤.
ì•ìœ¼ë¡œ ë°°ìš°ê²Œë  Cilium CNIê°€ ë” ê¸°ëŒ€ê°€ ë©ë‹ˆë‹¤.</p>]]></content><author><name></name></author><category term="kans" /><category term="kubernetes," /><category term="network," /><category term="linux" /><summary type="html"><![CDATA[ì§€ë‚œì£¼ì— ì´ì–´ ì´ë²ˆì£¼ì—ëŠ” Calico CNIì™€ Calico Network Modeì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[KANS 3ê¸°] K8S Flannel CNI &amp;amp; PAUSE</title><link href="https://sweetlittlebird.github.io/posts/2024-09-07-KANS-Study-Week2/" rel="alternate" type="text/html" title="[KANS 3ê¸°] K8S Flannel CNI &amp;amp; PAUSE" /><published>2024-09-07T17:40:18+09:00</published><updated>2024-09-07T17:40:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/KANS%20Study%20-%20Week2</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2024-09-07-KANS-Study-Week2/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì§€ë‚œì£¼ì— ì´ì–´ ì´ë²ˆì£¼ì—ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì—ëŒ€í•´ ê°„ëµí•˜ê²Œ ì•Œì•„ë³´ê³  KIND, PAUSE ì»¨í…Œì´ë„ˆì™€ Flannel CNIì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
KANS 3ê¸° 2ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h2 id="ì¿ ë²„ë„¤í‹°ìŠ¤-ì†Œê°œ">ì¿ ë²„ë„¤í‹°ìŠ¤ ì†Œê°œ</h2>

<ul>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” êµ¬ê¸€ì—ì„œ ì˜¤í”ˆì†ŒìŠ¤ë¡œ ê³µê°œí•œ ì»¨í…Œì´ë„ˆí™”ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìë™ìœ¼ë¡œ ë°°í¬, ìŠ¤ì¼€ì¼ë§ ë° ê´€ë¦¬í•˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”Œë«í¼ì…ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_1.gif" alt="20240907_kans_w2_1.gif" class="image-center" />
<em class="image-caption">ì¶œì²˜: <a href="https://blog.naver.com/love_tolty/222167051615">https://blog.naver.com/love_tolty/222167051615</a></em></p>

<ul>
  <li>
    <p>ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ ë‹¤ì–‘í•œ ì»´í¬ë„ŒíŠ¸ë¡œ ì´ë£¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤. ê° ìš”ì†Œë¥¼ ì‚´í´ë³´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>
  </li>
  <li><strong>Control Plane(ë§ˆìŠ¤í„° ë…¸ë“œ)</strong> : ë§ˆìŠ¤í„°ëŠ” ë‹¨ì¼ ì„œë²„ í˜¹ì€ ê³ ê°€ìš©ì„±ì„ ìœ„í•œ í´ëŸ¬ìŠ¤í„° ë§ˆìŠ¤í„°ë¡œ êµ¬ì¶•
    <ul>
      <li>kube-<strong>apiserver</strong> : <strong>ëª¨ë“  ìš”ì²­</strong>ì„ ë°›ì•„ ë“œë¦¬ëŠ” <strong>API ì„œë²„</strong></li>
      <li>etcd : í´ëŸ¬ìŠ¤í„°ë‚´ ëª¨ë“  ë©”íƒ€ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” key/value DB ì„œë¹„ìŠ¤</li>
      <li>kube-scheduler : ì»¨í…Œì´ë„ˆë¥¼ ì›Œì»¤ ë…¸ë“œì— ë°°ì¹˜í•˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬</li>
      <li>kube-controller-manager : í˜„ì¬ ìƒíƒœì™€ ë°”ë¼ëŠ” ìƒíƒœë¥¼ ì§€ì†ì ìœ¼ë¡œ í™•ì¸í•˜ë©° íŠ¹ì • ì´ë²¤íŠ¸ì— ë”°ë¼ íŠ¹ì • ë™ì‘ì„ ìˆ˜í–‰í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ - <a href="https://kubernetes.io/docs/concepts/architecture/controller/">ë§í¬</a></li>
      <li>cloud-controller-manager : (AWS, GCP, Azure ë“± í´ë¼ìš°ë“œ í”Œë«í¼ì— íŠ¹í™”ëœ ë¦¬ì†ŒìŠ¤ë¥¼ ì œì–´í•˜ëŠ” í´ë¼ìš°ë“œ ì»¨íŠ¸ë¡¤ëŸ¬ - <a href="https://kubernetes.io/docs/concepts/architecture/cloud-controller/">ë§í¬</a></li>
    </ul>
  </li>
  <li><strong>Worker Node(ì›Œì»¤ ë…¸ë“œ)</strong> - <a href="https://kubernetes.io/docs/concepts/architecture/nodes/">ë§í¬</a>
    <ul>
      <li>kubelet : ë§ˆìŠ¤í„°ì˜ ëª…ë ¹ì— ë”°ë¼ ì»¨í…Œì´ë„ˆì˜ ë¼ì´í”„ ì‚¬ì´í´ì„ ê´€ë¦¬í•˜ëŠ” ë…¸ë“œ ê´€ë¦¬ì</li>
      <li>kube-proxy : ì»¨í…Œì´ë„ˆì˜ ë„¤íŠ¸ì›Œí‚¹ì„ ì±…ì„ì§€ëŠ” í”„ë¡ì‹œ, ë„¤íŠ¸ì›Œí¬ ê·œì¹™ì„ ìœ ì§€ ê´€ë¦¬</li>
      <li>Container Runtime : ì‹¤ì œ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ëŠ” ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í™˜ê²½, (ContainerD, CRI-O, â€¦) - <a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">ë§í¬</a></li>
    </ul>
  </li>
  <li><strong>Addon(ì• ë“œì˜¨)</strong>
    <ul>
      <li>CNI : Container Network Interface ëŠ” k8s ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì„ êµ¬ì„±í•´ì¤ë‹ˆë‹¤.
        <ul>
          <li>ì˜ˆ) Flannel, Calico, Weave Net, Cilium, â€¦</li>
        </ul>
      </li>
      <li>DNS : í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ DNS ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
        <ul>
          <li>ì˜ˆ) CoreDNS, Kube-DNS, â€¦</li>
        </ul>
      </li>
      <li>ê¸°íƒ€ : ëª¨ë‹ˆí„°ë§, ëŒ€ì‹œë³´ë“œ, ë¡œê¹… ë“±ë“±</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="kind-ì†Œê°œ-ë°-ì„¤ì¹˜">kind ì†Œê°œ ë° ì„¤ì¹˜</h2>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_2.png" alt="img.png" class="w-30 image-center" /></p>

<p>kindëŠ” <strong>K</strong>ubernetes <strong>IN</strong> <strong>D</strong>ockerì˜ ì•½ìë¡œ, ë¡œì»¬ í™˜ê²½ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ë¥¼ ì‰½ê²Œ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤. ì´ë¦„ì—ì„œ ì•Œ ìˆ˜ ìˆë“¯ì´ Kubernetesë¥¼ Docker ì•ˆì—ì„œ DIND(Docker in Docker) ë°©ì‹ìœ¼ë¡œ êµ¬ë™ì‹œì¼œì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.
minikubeë‚˜ k3s ë“±ê³¼ ë‹¬ë¦¬ <strong>Dockerë§Œ ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ë©´ ì†ì‰½ê²Œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>kindì˜ êµ¬ì¡°ë¥¼ ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•˜ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w2/20240907_kans_w2_3.png" alt="img.png" class="image-center" />
<em class="image-caption">ì¶œì²˜ : <a href="[https://kind.sigs.k8s.io/docs/design/initial/">https://kind.sigs.k8s.io/docs/design/initial/</a></em></li>
</ul>

<h3 id="ì„¤ì¹˜">ì„¤ì¹˜</h3>

<p>ì œê°€ ì‚¬ìš©ì¤‘ì¸ macOSë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. macOSì—ì„œ í…Œë¼í¼ì„ ì„¤ì¹˜í•˜ë ¤ë©´ Homebrewë¥¼ ì´ìš©í•˜ì—¬ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
(í™ˆë¸Œë£¨ ì„¤ì¹˜ ë°©ë²•ì€ <a href="https://whalec.io/homebrew-ì„¤ì¹˜-ë°-ì‚¬ìš©-ë°©ë²•">https://whalec.io/homebrew-ì„¤ì¹˜-ë°-ì‚¬ìš©-ë°©ë²•</a> ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.)</p>

<ul>
  <li>kind ì„¤ì¹˜ ë° í•„ìˆ˜ íˆ´ ì„¤ì¹˜</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install Kind</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kind
<span class="nv">$ </span>kind <span class="nt">--version</span>
<span class="c"># =&gt; kind version 0.24.0</span>

<span class="c"># Install kubectl</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubernetes-cli
<span class="nv">$ </span>kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Client Version: v1.31.0</span>
<span class="c">#    Kustomize Version: v5.4.2</span>

<span class="c"># Install Helm</span>
<span class="nv">$ </span>brew <span class="nb">install </span>helm
<span class="nv">$ </span>helm version
<span class="c"># =&gt; version.BuildInfo{Version:&amp;quot;v3.15.4&amp;quot;, GitCommit:&amp;quot;fa9efb07d9d8debbb4306d72af76a383895aa8c4&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;, GoVersion:&amp;quot;go1.22.6&amp;quot;}</span>

<span class="c"># Install Wireshark : ìº¡ì²˜ëœ íŒ¨í‚· í™•ì¸</span>
<span class="nv">$ </span>brew <span class="nb">install</span> <span class="nt">--cask</span> wireshark

<span class="c"># (ì„ íƒ) kubectl ì¶œë ¥ ì‹œ í•˜ì´ë¼ì´íŠ¸ ì²˜ë¦¬</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubecolor
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"alias kubectl=kubecolor"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"compdef kubecolor=kubectl"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
</code></pre></div></div>

<h3 id="1-node-í´ëŸ¬ìŠ¤í„°-êµ¬ì„±-í…ŒìŠ¤íŠ¸">1-Node í´ëŸ¬ìŠ¤í„° êµ¬ì„± í…ŒìŠ¤íŠ¸</h3>

<ul>
  <li>ê°„ë‹¨í•œ í´ëŸ¬ìŠ¤í„°ë¥¼ ë§Œë“¤ê³  í…ŒìŠ¤íŠ¸ í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ë°°í¬ ì „ í™•ì¸</span>
<span class="nv">$ </span>docker ps

<span class="c"># Create a cluster with kind</span>
<span class="nv">$ </span>kind create cluster
<span class="c"># =&gt; Creating cluster &amp;quot;kind&amp;quot; ...</span>
<span class="c">#    &lt;span style="color:green;"&gt;âœ“&lt;/span&gt; Ensuring node image (kindest/node:v1.31.0) ğŸ–¼</span>
<span class="c">#    &lt;span style="color:green;"&gt;âœ“&lt;/span&gt; Preparing nodes ğŸ“¦ </span>
<span class="c">#    &lt;span style="color:green;"&gt;âœ“&lt;/span&gt; Writing configuration ğŸ“œ</span>
<span class="c">#    &lt;span style="color:green;"&gt;âœ“&lt;/span&gt; Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#    &lt;span style="color:green;"&gt;âœ“&lt;/span&gt; Installing CNI ğŸ”Œ</span>
<span class="c">#    &lt;span style="color:green;"&gt;âœ“&lt;/span&gt; Installing StorageClass ğŸ’¾</span>
<span class="c">#    Set kubectl context to &amp;quot;kind-kind&amp;quot;</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-kind </span>
<span class="c">#    </span>
<span class="c">#    Not sure what to do next? ğŸ˜…  Check out https://kind.sigs.k8s.io/docs/user/quick-start/</span>

<span class="c"># í´ëŸ¬ìŠ¤í„° ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kind get clusters
<span class="nv">$ </span>kind get nodes
<span class="nv">$ </span>kubectl cluster-info

<span class="c"># ë…¸ë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide

<span class="c"># íŒŒë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
<span class="nv">$ </span>kubectl get componentstatuses

<span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ (ì»¨í…Œì´ë„ˆ) ë…¸ë“œ 1ëŒ€ê°€ ì‹¤í–‰</span>
<span class="nv">$ </span>docker ps
<span class="nv">$ </span>docker images

<span class="c"># kube config íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config

<span class="c"># nginx íŒŒë“œ ë°°í¬ ë° í™•ì¸ : ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œì¸ë° íŒŒë“œê°€ ë°°í¬ ë ê¹Œìš”?</span>
<span class="nv">$ </span>kubectl run nginx <span class="nt">--image</span><span class="o">=</span>nginx:alpine
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>

<span class="c"># ë…¸ë“œì— Taints ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe node | <span class="nb">grep </span>Taints
<span class="c"># =&gt; Taints:             &lt;none&gt;</span>

<span class="c"># í´ëŸ¬ìŠ¤í„° ì‚­ì œ</span>
<span class="nv">$ </span>kind delete cluster

<span class="c"># kube config ì‚­ì œ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
</code></pre></div></div>

<ul>
  <li>í…ŒìŠ¤íŠ¸ ì¤‘ì— ë…¸ë“œê°€ ì»¤íŠ¸ë¡¤ í”Œë ˆì¸ í•˜ë‚˜ ë¿ì¸ë°ë„ íŒŒë“œê°€ ë°°í¬ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">kubectl describe node | grep Taints</code>ë¥¼ í†µí•´ í™•ì¸í•´ë³¸ ê²°ê³¼ <code class="language-plaintext highlighter-rouge">=&gt; Taints: &lt;none&gt;</code>ë¡œ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì— ë³´í†µ ê±¸ë ¤ìˆëŠ” taintê°€ ì—†ì–´ì„œ íŒŒë“œê°€ ë°°í¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_4.png" alt="img.png" /></p>

<h3 id="2-node-í´ëŸ¬ìŠ¤í„°-êµ¬ì„±-í…ŒìŠ¤íŠ¸">2-Node í´ëŸ¬ìŠ¤í„° êµ¬ì„± í…ŒìŠ¤íŠ¸</h3>

<ul>
  <li>ì´ë²ˆì—ëŠ” ì¢€ ë” ë‚˜ì•„ê°€ì„œ control-planeê³¼ workerì˜ 2ê°œì˜ ë…¸ë“œë¡œ êµ¬ì„±ëœ KIND í´ëŸ¬ìŠ¤í„°ë¥¼ ë§Œë“¤ê³ , í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ë°°í¬ ì „ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span>

<span class="c"># kind ëŠ” ë³„ë„ ë„ì»¤ ë„¤íŠ¸ì›Œí¬ ìƒì„± í›„ ì‚¬ìš© : ê¸°ë³¸ê°’ 172.18.0.0/16</span>
<span class="nv">$ </span>docker network <span class="nb">ls</span>
<span class="c"># =&gt; NETWORK ID     NAME                     DRIVER    SCOPE</span>
<span class="c">#    ...</span>
<span class="c">#    3bbcc6aa8f38   kind                     bridge    local</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>docker inspect kind | jq
<span class="c"># =&gt; [</span>
<span class="c">#      {</span>
<span class="c">#        &amp;quot;Name&amp;quot;: &amp;quot;kind&amp;quot;,</span>
<span class="c">#        &amp;quot;Driver&amp;quot;: &amp;quot;bridge&amp;quot;,</span>
<span class="c">#        ...</span>
<span class="c">#        &amp;quot;IPAM&amp;quot;: {</span>
<span class="c">#          &amp;quot;Driver&amp;quot;: &amp;quot;default&amp;quot;,</span>
<span class="c">#          &amp;quot;Options&amp;quot;: {},</span>
<span class="c">#          &amp;quot;Config&amp;quot;: [</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;Subnet&amp;quot;: &amp;quot;172.20.0.0/16&amp;quot;,</span>
<span class="c">#              &amp;quot;Gateway&amp;quot;: &amp;quot;172.20.0.1&amp;quot;</span>
<span class="c">#            }</span>
<span class="c">#          ]</span>
<span class="c">#        },</span>
<span class="c">#       ...</span>
<span class="c">#      }</span>
<span class="c">#    ]</span>

<span class="c"># KINDë¡œ control-plane, workerë¼ëŠ” 2ê°œì˜ ë…¸ë“œë¥¼ ê°€ì§„ í´ëŸ¬ìŠ¤í„° ë§Œë“¤ê¸°</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOT</span><span class="sh"> &gt; kind-2node.yaml 
# two node (one workers) cluster config
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
</span><span class="no">EOT
</span><span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-2node.yaml <span class="nt">--name</span> myk8s

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kind get nodes <span class="nt">--name</span> myk8s
<span class="c"># =&gt; myk8s-worker</span>
<span class="c">#    myk8s-control-plane</span>

<span class="c"># k8s api ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; &lt;span style="color:green;"&gt;Kubernetes control plane&lt;/span&gt; is running at &lt;span style="color:olive;"&gt;https://127.0.0.1:58638&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:green;"&gt;CoreDNS&lt;/span&gt; is running at &lt;span style="color:olive;"&gt;https://127.0.0.1:58638/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>

<span class="c"># í˜¸ìŠ¤íŠ¸ì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸ </span>
<span class="nv">$ </span>curl <span class="nt">-k</span> https://localhost:58638
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;kind&amp;quot;: &amp;quot;Status&amp;quot;,</span>
<span class="c">#      &amp;quot;apiVersion&amp;quot;: &amp;quot;v1&amp;quot;,</span>
<span class="c">#      &amp;quot;metadata&amp;quot;: {},</span>
<span class="c">#      &amp;quot;status&amp;quot;: &amp;quot;Failure&amp;quot;,</span>
<span class="c">#      &amp;quot;message&amp;quot;: &amp;quot;forbidden: User \&amp;quot;system:anonymous\&amp;quot; cannot get path \&amp;quot;/\&amp;quot;&amp;quot;,</span>
<span class="c">#      &amp;quot;reason&amp;quot;: &amp;quot;Forbidden&amp;quot;,</span>
<span class="c">#      &amp;quot;details&amp;quot;: {},</span>
<span class="c">#      &amp;quot;code&amp;quot;: 403</span>
<span class="c">#    } # í˜¸ìŠ¤íŠ¸ì—ì„œ ì ‘ì†ì´ ë©ë‹ˆë‹¤! ì™œ ê·¸ëŸ´ê¹Œìš”?</span>

<span class="nv">$ </span>docker ps <span class="c"># í¬íŠ¸ í¬ì›Œë”© ì •ë³´ í™•ì¸</span>
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS         PORTS                                  NAMES</span>
<span class="c">#    6228f280b992   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   3 minutes ago   Up 3 minutes   0.0.0.0:30000-30001-&amp;gt;30000-30001/tcp   myk8s-worker</span>
<span class="c">#    219113c36204   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   3 minutes ago   Up 3 minutes   127.0.0.1:58638-&amp;gt;6443/tcp              myk8s-control-plane</span>

<span class="c"># ë„ì»¤ì—ì„œ 127.0.0.1:58638-&amp;gt;6443/tcp ë¡œ í¬íŠ¸í¬ì›Œë”©ì„ í•˜ê¸° ë•Œë¬¸ì¸ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. </span>

<span class="c"># apiserver í”„ë¡œì„¸ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ss <span class="nt">-tnlp</span> | <span class="nb">grep </span>6443
<span class="c"># =&gt; LISTEN 0      4096               *:6443             *:*    users:((&amp;quot;kube-apiserver&amp;quot;,pid=584,fd=3)) </span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>kube-apiserver <span class="nt">-owide</span> <span class="c"># íŒŒë“œ IP í™•ì¸</span>
<span class="c"># =&gt; NAME                                 READY   STATUS    RESTARTS   AGE     IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-apiserver-myk8s-control-plane   1/1     Running   0          5m39s   172.20.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c"># kube-apiserver íŒŒë“œ ìƒì„¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe  pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>kube-apiserver

<span class="c"># health check ì£¼ì†Œ ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane curl <span class="nt">-k</span> https://localhost:6443/livez <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; ok</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane curl <span class="nt">-k</span> https://localhost:6443/readyz <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; ok</span>

<span class="c"># ë…¸ë“œ ì •ë³´ í™•ì¸ : CRI ëŠ” containerd ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   7m15s   v1.31.0   172.20.0.2    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker          Ready    &amp;lt;none&amp;gt;          7m1s    v1.31.0   172.20.0.3    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>

<span class="c"># íŒŒë“œ ì •ë³´ í™•ì¸ : CNI ëŠ” kindnet ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE   IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system          coredns-6f6b679f8f-9gxnw                      1/1     Running   0          10m   10.244.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          etcd-myk8s-control-plane                      1/1     Running   0          10m   172.20.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kindnet-b5brb                                 1/1     Running   0          10m   172.20.0.3   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-apiserver-myk8s-control-plane            1/1     Running   0          10m   172.20.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-controller-manager-myk8s-control-plane   1/1     Running   0          10m   172.20.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-proxy-tbh7b                              1/1     Running   0          10m   172.20.0.3   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-scheduler-myk8s-control-plane            1/1     Running   0          10m   172.20.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    local-path-storage   local-path-provisioner-57c5987fd4-nfcv8       1/1     Running   0          10m   10.244.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    ...</span>

<span class="c"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸ </span>
<span class="nv">$ </span>kubectl get namespaces
<span class="c"># =&gt; NAME                 STATUS   AGE</span>
<span class="c">#    default              Active   11m</span>
<span class="c">#    kube-node-lease      Active   11m</span>
<span class="c">#    kube-public          Active   11m</span>
<span class="c">#    kube-system          Active   11m</span>
<span class="c">#    local-path-storage   Active   10m</span>

<span class="c"># ë””ë²„ê·¸ìš© ë‚´ìš© ì¶œë ¥ì— ~/.kube/config ê¶Œí•œ ì¸ì¦ ë¡œë“œ</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-v6</span>
<span class="c"># =&gt; I0907 21:08:08.698472   40997 loader.go:395] Config loaded from file:  /Users/psyche/.kube/config</span>
<span class="c">#    I0907 21:08:08.709347   40997 round_trippers.go:553] GET https://127.0.0.1:58638/api/v1/namespaces/default/pods?limit=500 200 OK in 8 milliseconds</span>
<span class="c">#    No resources found in default namespace.</span>

<span class="c"># kube config íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config

<span class="c"># local-path ë¼ëŠ” StorageClass ê°€ ì„¤ì¹˜, local-path ëŠ” ë…¸ë“œì˜ ë¡œì»¬ ì €ì¥ì†Œë¥¼ í™œìš©í•¨</span>
<span class="c"># ë¡œì»¬ í˜¸ìŠ¤íŠ¸ì˜ path ë¥¼ ì§€ì •í•  í•„ìš” ì—†ì´ local-path provisioner ì´ ë³¼ë¥¨ì„ ê´€ë¦¬</span>
<span class="nv">$ </span>kubectl get sc
<span class="c"># =&gt; NAME                 PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span>
<span class="c">#    standard (default)   rancher.io/local-path   Delete          WaitForFirstConsumer   false                  12m</span>
<span class="nv">$ </span>kubectl get deploy <span class="nt">-n</span> local-path-storage
</code></pre></div></div>

<h3 id="ì¿ ë²„ë„¤í‹°ìŠ¤-ê´€ë ¨-ì •ë³´-ì¡°ì‚¬">ì¿ ë²„ë„¤í‹°ìŠ¤ ê´€ë ¨ ì •ë³´ ì¡°ì‚¬</h3>

<p>ì´ë²ˆì—ëŠ” KIND ë‚´ë¶€ì˜ ì¿ ë²„ë„¤í‹°ìŠ¤ ê´€ë ¨ ì •ë³´ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.
ì›í™œí•œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ í•„ìš”í•œ íˆ´ì„ ì„¤ì¹˜í•˜ê³ , KIND ë‚´ë¶€ì˜ ì¿ ë²„ë„¤í‹°ìŠ¤ ê´€ë ¨ ì •ë³´ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop git nano -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop git nano -y'</span>

<span class="c"># static pod manifest ìœ„ì¹˜ ì°¾ê¸°</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane <span class="nb">grep </span>staticPodPath /var/lib/kubelet/config.yaml
<span class="c"># =&gt; staticPodPath: /etc/kubernetes/manifests</span>

<span class="c"># static pod ì •ë³´ í™•ì¸ : kubectl ë° control plane ì—ì„œ ê´€ë¦¬ë˜ì§€ ì•Šê³  kubelet ì„ í†µí•´ ì§€ì •í•œ ì»¨í…Œì´ë„ˆë¥¼ ë°°í¬</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane tree /etc/kubernetes/manifests/
<span class="c"># =&gt; /etc/kubernetes/manifests/</span>
<span class="c">#    |-- etcd.yaml</span>
<span class="c">#    |-- kube-apiserver.yaml</span>
<span class="c">#    |-- kube-controller-manager.yaml</span>
<span class="c">#    `-- kube-scheduler.yaml</span>

<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker tree /etc/kubernetes/manifests/
<span class="c"># =&gt; /etc/kubernetes/manifests/</span>

<span class="c"># ì›Œì»¤ ë…¸ë“œ(ì»¨í…Œì´ë„ˆ) bash ì§„ì…</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="c"># ---------------------------------</span>
<span class="nv">$ </span><span class="nb">whoami</span>
<span class="c"># =&gt; root</span>

<span class="c"># kubelet ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>systemctl status kubelet
<span class="c"># =&gt; â— kubelet.service - kubelet: The Kubernetes Node Agent</span>
<span class="c">#         Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; preset: enabled)</span>
<span class="c">#        Drop-In: /etc/systemd/system/kubelet.service.d</span>
<span class="c">#                 â””â”€10-kubeadm.conf, 11-kind.conf</span>
<span class="c">#         Active: active (running) since Sat 2024-09-07 11:56:44 UTC; 48min ago</span>
<span class="c">#           Docs: http://kubernetes.io/docs/</span>
<span class="c">#       Main PID: 236 (kubelet)</span>
<span class="c">#          Tasks: 15 (limit: 2254)</span>
<span class="c">#         Memory: 32.9M</span>
<span class="c">#            CPU: 1min 7.074s</span>
<span class="c">#         CGroup: /kubelet.slice/kubelet.service</span>
<span class="c">#                 â””â”€236 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/conf&gt;</span>
<span class="c">#    ...</span>

<span class="c"># ì»¨í…Œì´ë„ˆ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; bash: docker: command not found</span>
<span class="nv">$ </span>crictl ps
<span class="c"># =&gt; CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD</span>
<span class="c">#    dd7ff0509e335       6a23fa8fd2b78       49 minutes ago      Running             kindnet-cni         0                   99f981aced025       kindnet-b5brb</span>
<span class="c">#    41b224e66bc3c       c573e1357a14e       49 minutes ago      Running             kube-proxy          0                   8880634c13ba5       kube-proxy-tbh7b</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">docker ps</code>í–ˆì„ë•ŒëŠ” <code class="language-plaintext highlighter-rouge">command not found</code>ê°€ ë‚˜ì˜¤ê³  <code class="language-plaintext highlighter-rouge">crictl ps</code>ë¡œ í–ˆì„ë•Œ ì»¨í…Œì´ë„ˆ ì •ë³´ê°€ ë‚˜ì˜¤ëŠ” ê²ƒì„ ë³´ë©´, KINDëŠ” ì´ë¦„ê³¼ëŠ” ë‹¤ë¥´ê²Œ Docker ëŒ€ì‹  CRI(Container Runtime Interface)ë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— <code class="language-plaintext highlighter-rouge">docker</code> ëª…ë ¹ì–´ ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">crictl</code> ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kube-proxy í™•ì¸</span>
<span class="nv">$ </span>pstree
<span class="c"># =&gt; systemd-+-containerd---15*[{containerd}]</span>
<span class="c">#            |-containerd-shim-+-kube-proxy---8*[{kube-proxy}]</span>
<span class="c">#            |                 |-pause</span>
<span class="c">#            |                 `-12*[{containerd-shim}]</span>
<span class="c">#            |-containerd-shim-+-kindnetd---11*[{kindnetd}]</span>
<span class="c">#            |                 |-pause</span>
<span class="c">#            |                 `-12*[{containerd-shim}]</span>
<span class="c">#            |-kubelet---14*[{kubelet}]</span>
<span class="c">#            `-systemd-journal</span>
<span class="nv">$ </span>pstree <span class="nt">-p</span>
<span class="c"># kube-proxy í”„ë¡œì„¸ìŠ¤ ì •ë³´</span>
<span class="nv">$ </span>ps afxuwww |grep proxy 
<span class="c"># =&gt; root         387  0.0  1.1 1290144 24112 ?       Ssl  11:56   0:02  \_ /usr/local/bin/kube-proxy --config=/var/lib/kube-proxy/config.conf --hostname-override=myk8s-worker</span>
<span class="c"># ë°©í™”ë²½ ì„¤ì • í™•ì¸</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> security <span class="nt">-S</span>

<span class="c"># tcp listen í¬íŠ¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span>

<span class="c"># ë¹ ì ¸ë‚˜ì˜¤ê¸°</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="c"># ---------------------------------</span>
</code></pre></div></div>

<h3 id="íŒŒë“œ-ìƒì„±-ë°-í™•ì¸">íŒŒë“œ ìƒì„± ë° í™•ì¸</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë“œ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: netpod
spec:
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx-pod
    image: nginx:alpine
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/netpod created</span>
<span class="c">#    pod/nginx created</span>

<span class="c"># íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME     READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES</span>
<span class="c">#    netpod   1/1     Running   0          52s   10.244.1.3   myk8s-worker   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    nginx    1/1     Running   0          52s   10.244.1.2   myk8s-worker   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># netpod íŒŒë“œì—ì„œ nginx ì›¹ ì ‘ì†</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> netpod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="si">$(</span>kubectl get pod nginx <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.podIP<span class="o">}</span><span class="si">)</span> | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
<span class="c"># =&gt; &lt;title&gt;Welcome to nginx!&lt;/title&gt;</span>
</code></pre></div></div>

<h3 id="ì»¨íŠ¸ë¡¤-í”Œë ˆì¸-ì»¨í…Œì´ë„ˆ-ì •ë³´-í™•ì¸">ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ì»¨í…Œì´ë„ˆ ì •ë³´ í™•ì¸</h3>

<p>ì´ë²ˆì—ëŠ” ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ì»¨í…Œì´ë„ˆì˜ ì •ë³´ë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤. kindëŠ” Docker IN Docker ë°©ì‹ìœ¼ë¡œ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì„ êµ¬ì„±í•˜ê¸° ë•Œë¬¸ì—
ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ì„œ ì •ë³´ë¥¼ í™•ì¸í•  ë•Œì™€ í˜¸ìŠ¤íŠ¸ì—ì„œ docker ì •ë³´ë¥¼ í™•ì¸í• ë•Œì™€ ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë„ì»¤ ì»¨í…Œì´ë„ˆ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED       STATUS       PORTS                                  NAMES</span>
<span class="c">#    6228f280b992   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   2 hours ago   Up 2 hours   0.0.0.0:30000-30001-&amp;gt;30000-30001/tcp   myk8s-worker</span>
<span class="c">#    219113c36204   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   2 hours ago   Up 2 hours   127.0.0.1:58638-&amp;gt;6443/tcp              myk8s-control-plane</span>

<span class="nv">$ </span>docker inspect myk8s-control-plane | jq
...
      <span class="s2">"Entrypoint"</span>: <span class="o">[</span>
        <span class="s2">"/usr/local/bin/entrypoint"</span>,
        <span class="s2">"/sbin/init"</span>
      <span class="o">]</span>,
...

<span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ì»¨í…Œì´ë„ˆ bash ì ‘ì† í›„ í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nt">-------------------------------------------</span>
<span class="c"># CPU ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">arch</span>
<span class="c"># =&gt; aarch64      # intel í˜¸í™˜ CPUì¸ ê²½ìš° x86_64ê°€ í‘œì‹œë©ë‹ˆë‹¤.</span>

<span class="c"># ê¸°ë³¸ ì‚¬ìš©ì í™•ì¸</span>
<span class="nv">$ </span><span class="nb">whoami</span>
<span class="c"># =&gt; root</span>

<span class="c"># ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8</span>
<span class="c">#    vethfbd4a037@if4 UP             10.244.0.1/32</span>
<span class="c">#    veth50a51781@if4 UP             10.244.0.1/32</span>
<span class="c">#    veth1822edcc@if4 UP             10.244.0.1/32</span>
<span class="c">#    eth0@if17        UP             172.20.0.2/16</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; 10.244.0.2 dev vethfbd4a037 scope host</span>
<span class="c">#    10.244.0.3 dev veth50a51781 scope host</span>
<span class="c">#    10.244.0.4 dev veth1822edcc scope host</span>
<span class="c">#    10.244.1.0/24 via 172.20.0.3 dev eth0</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.2</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/resolv.conf
<span class="c"># =&gt; nameserver 192.168.65.2</span>
<span class="c">#    options ndots:0</span>

<span class="c"># Entrypoint ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> /usr/local/bin/entrypoint

<span class="c"># í”„ë¡œì„¸ìŠ¤ í™•ì¸ : PID 1 ì€ /sbin/init</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span>
<span class="c"># =&gt; UID          PID    PPID  C STIME TTY          TIME CMD</span>
<span class="c">#    root           1       0  0 11:56 ?        00:00:01 /sbin/init</span>
<span class="c">#    ...</span>

<span class="c"># kindëŠ” docker ì•ˆì—ì„œ dockerë¥¼ ìš´ì˜í•˜ê¸° ìœ„í•´ OSë¥¼ í‰ë‚´ë‚´ê¸° ìœ„í•´ ìì²´ì ìœ¼ë¡œ systemdë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—</span>
<span class="c"># ìœ„ì™€ ê°™ì´ PID 1ì´ /sbin/init ê°€ ë˜ê³ , systemctl ëª…ë ¹ë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
 
<span class="c"># ì»¨í…Œì´í„° ëŸ°íƒ€ì„ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>systemctl status containerd

<span class="c"># DinD ì»¨í…Œì´ë„ˆ í™•ì¸ : crictl ì‚¬ìš©</span>
<span class="nv">$ </span>crictl version
<span class="c"># =&gt; Version:  0.1.0</span>
<span class="c">#    RuntimeName:  containerd</span>
<span class="c">#    RuntimeVersion:  v1.7.18</span>
<span class="c">#    RuntimeApiVersion:  v1</span>
<span class="nv">$ </span>crictl info
<span class="nv">$ </span>crictl ps <span class="nt">-o</span> json | jq <span class="nt">-r</span> <span class="s1">'.containers[] | {NAME: .metadata.name, POD: .labels["io.kubernetes.pod.name"]}'</span>
<span class="nv">$ </span>crictl ps
<span class="c"># =&gt; CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID              POD</span>
<span class="c">#    075e7a9f5f7a3       2437cf7621777       2 hours ago         Running             coredns                   0                   5e7c18501fc65       coredns-6f6b679f8f-9gxnw</span>
<span class="c">#    6f61738127a55       2437cf7621777       2 hours ago         Running             coredns                   0                   3b69c8d195b5d       coredns-6f6b679f8f-fk27q</span>
<span class="c">#    ...</span>

<span class="c"># íŒŒë“œ ì´ë¯¸ì§€ í™•ì¸</span>
<span class="nv">$ </span>crictl images
<span class="c"># =&gt; IMAGE                                           TAG                  IMAGE ID            SIZE</span>
<span class="c">#    docker.io/library/nginx                         alpine               9d6767b714bf1       20.2MB</span>
<span class="c">#    docker.io/nicolaka/netshoot                     latest               eead9e442471d       178MB</span>
<span class="c">#    ...</span>

<span class="c"># kubectl í™•ì¸</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-v6</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/kubernetes/admin.conf

<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">-------------------------------------------</span>

<span class="c"># ë„ì»¤ ì»¨í…Œì´ë„ˆ í™•ì¸ : ë‹¤ì‹œ í•œë²ˆ ìì‹ ì˜ í˜¸ìŠ¤íŠ¸PCì—ì„œ ë„ì»¤ ì»¨í…Œì´ë„ˆ í™•ì¸, DinD ì»¨í…Œì´ë„ˆê°€ í˜¸ìŠ¤íŠ¸ì—ì„œ ë³´ì´ëŠ”ì§€ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED       STATUS       PORTS                                  NAMES</span>
<span class="c">#    6228f280b992   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   2 hours ago   Up 2 hours   0.0.0.0:30000-30001-&gt;30000-30001/tcp   myk8s-worker</span>
<span class="c">#    219113c36204   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   2 hours ago   Up 2 hours   127.0.0.1:58638-&gt;6443/tcp              myk8s-control-plane</span>
<span class="nv">$ </span>docker port myk8s-control-plane

<span class="c"># kubectl í™•ì¸ : k8s api í˜¸ì¶œ ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-v6</span> 
</code></pre></div></div>

<ul>
  <li>KINDì˜ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ì„œ <code class="language-plaintext highlighter-rouge">crictl ps</code>ë¡œ ì»¨í…Œì´ë„ˆë¥¼ í™•ì¸í• ë•Œì™€ í˜¸ìŠ¤íŠ¸ì—ì„œ <code class="language-plaintext highlighter-rouge">docker ps</code>ë¡œ í™•ì¸í• ë•Œì˜ ì°¨ì´ê°€ ë‚˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>
    <p>ì´ê²ƒì€ ì•ì—ì„œë„ docker ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ docker (ì •í™•íˆëŠ” containerd)ë¥¼ ë³„ë„ë¡œ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” í˜„ìƒì…ë‹ˆë‹¤. ì´ê²ƒì´ DIND(Docker IN Docker)ì…ë‹ˆë‹¤.
â€”ë§Œì•½ ê°™ì€ ì»¨í…Œì´ë„ˆê°€ ë‚˜ì˜¨ë‹¤ë©´ Docker OUT Dockerë¡œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì¼ê²ƒì…ë‹ˆë‹¤â€”</p>
  </li>
  <li>í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚­ì œí•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ì‚­ì œ</span>
<span class="nv">$ </span>kind delete cluster <span class="nt">--name</span> myk8s
<span class="c"># =&gt; Deleting cluster "myk8s" ...</span>
<span class="c">#    Deleted nodes: ["myk8s-worker" "myk8s-control-plane"]</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span>
</code></pre></div></div>

<h3 id="multi-node-í´ëŸ¬ìŠ¤í„°-with-kube-ops-view--mapping-ports">Multi-Node í´ëŸ¬ìŠ¤í„° with kube-ops-view &amp; mapping ports</h3>

<p>ì´ë²ˆì—ëŠ” KINDë¡œ Multi-Node í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ê³ , kube-ops-viewë¥¼ ì„¤ì¹˜í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ì •ë³´ë¥¼ ì‹œê°í™”í•˜ê³ , í¬íŠ¸ ë§¤í•‘ì„ í†µí•´ í˜¸ìŠ¤íŠ¸ì—ì„œ ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>í´ëŸ¬ìŠ¤í„° êµ¬ì„± ë° ë…¸ë“œ ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 'ì»¨íŠ¸ë¡¤í”Œë ˆì¸, ì›Œì»¤ ë…¸ë“œ 1ëŒ€' í´ëŸ¬ìŠ¤í„° ë°°í¬ : íŒŒë“œì— ì ‘ì†í•˜ê¸° ìœ„í•œ í¬íŠ¸ ë§µí•‘ ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; kind-2node.yaml
# two node (one workers) cluster config
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
  extraPortMappings:
  - containerPort: 31000
    hostPort: 31000
    listenAddress: "0.0.0.0" # Optional, defaults to "0.0.0.0"
    protocol: tcp # Optional, defaults to tcp
  - containerPort: 31001
    hostPort: 31001
</span><span class="no">EOT

</span><span class="nv">$ CLUSTERNAME</span><span class="o">=</span>myk8s
<span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-2node.yaml <span class="nt">--name</span> <span class="nv">$CLUSTERNAME</span>
<span class="c"># =&gt; Creating cluster "myk8s" ...</span>
<span class="c">#     âœ“ Ensuring node image (kindest/node:v1.31.0) ğŸ–¼</span>
<span class="c">#     âœ“ Preparing nodes ğŸ“¦ ğŸ“¦</span>
<span class="c">#     âœ“ Writing configuration ğŸ“œ</span>
<span class="c">#     âœ“ Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#     âœ“ Installing CNI ğŸ”Œ</span>
<span class="c">#     âœ“ Installing StorageClass ğŸ’¾</span>
<span class="c">#     âœ“ Joining worker nodes ğŸšœ</span>
<span class="c">#    Set kubectl context to "kind-myk8s"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-myk8s</span>
<span class="c">#    </span>
<span class="c">#    Have a nice day! ğŸ‘‹</span>

<span class="c"># ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kind get clusters
<span class="c"># =&gt; myk8s</span>
<span class="nv">$ </span>kind get nodes <span class="nt">--name</span> <span class="nv">$CLUSTERNAME</span>
<span class="c"># =&gt; myk8s-control-plane</span>
<span class="c">#    myk8s-worker</span>

<span class="c"># ë…¸ë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   2m12s   v1.31.0   172.20.0.2    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker          Ready    &amp;lt;none&amp;gt;          119s    v1.31.0   172.20.0.3    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>

<span class="c"># ë…¸ë“œì— Taints ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe node <span class="nv">$CLUSTERNAME</span><span class="nt">-control-plane</span> | <span class="nb">grep </span>Taints
<span class="c"># =&gt; Taints:             node-role.kubernetes.io/control-plane:NoSchedule</span>

<span class="nv">$ </span>kubectl describe node <span class="nv">$CLUSTERNAME</span><span class="nt">-worker</span> | <span class="nb">grep </span>Taints
<span class="c"># =&gt; Taints:             &amp;lt;none&amp;gt;</span>

<span class="c"># control-plane ë…¸ë“œì—ëŠ” taintsê°€ ê±¸ë ¤ìˆì–´ì„œ ìŠ¤ì¼€ì¥´ë§ì´ ë˜ì§€ ì•Šê³  </span>
<span class="c"># worker ë…¸ë“œì—ëŠ” taintsê°€ ì—†ì–´ì„œ ìŠ¤ì¼€ì¥´ë§ì´ ë  ê²ƒì„ ì˜ˆìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>

<span class="c"># ì»¨í…Œì´ë„ˆ í™•ì¸ : ì»¨í…Œì´ë„ˆ ê°¯ìˆ˜, ì»¨í…Œì´ë„ˆ ì´ë¦„ í™•ì¸</span>
<span class="c"># kind yaml ì— í¬íŠ¸ ë§µí•‘ ì •ë³´ ì²˜ëŸ¼, ìì‹ ì˜ PC í˜¸ìŠ¤íŠ¸ì— 31000 í¬íŠ¸ ì ‘ì† ì‹œ, ì›Œì»¤ë…¸ë“œ(ì‹¤ì œë¡œëŠ” ì»¨í…Œì´ë„ˆ)ì— TCP 31000 í¬íŠ¸ë¡œ ì—°ê²°</span>
<span class="c"># ì¦‰, ì›Œì»¤ë…¸ë“œì— NodePort TCP 31000 ì„¤ì • ì‹œ ìì‹ ì˜ PC í˜¸ìŠ¤íŠ¸ì—ì„œ ì ‘ì† ê°€ëŠ¥!</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS         PORTS                                  NAMES</span>
<span class="c">#    7724a7ff92bb   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   6 minutes ago   Up 6 minutes   127.0.0.1:58498-&amp;gt;6443/tcp              myk8s-control-plane</span>
<span class="c">#    5b7fa2f98703   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   6 minutes ago   Up 6 minutes   0.0.0.0:31000-31001-&amp;gt;31000-31001/tcp   myk8s-worker</span>
<span class="nv">$ </span>docker port <span class="nv">$CLUSTERNAME</span><span class="nt">-worker</span>
<span class="c"># =&gt; 31000/tcp -&amp;gt; 0.0.0.0:31000</span>
<span class="c">#    31001/tcp -&amp;gt; 0.0.0.0:31001</span>

<span class="c"># ê° ë…¸ë“œë“¤ì˜ ì •ë³´ í™•ì¸ì„ dockerë¥¼ í†µí•´ì„œ í™•ì¸í•´ ë³¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLUSTERNAME</span><span class="nt">-control-plane</span> ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLUSTERNAME</span><span class="nt">-worker</span>  ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
</code></pre></div></div>

<ul>
  <li>
    <p>ì´ë²ˆì— KINDë¥¼ í†µí•´ ë§Œë“  í´ëŸ¬ìŠ¤í„°ëŠ” í˜¸ìŠ¤íŠ¸ì—ì„œ 31000, 31001 í¬íŠ¸ë¡œ ì ‘ì†ì‹œ ì›Œì»¤ë…¸ë“œ(ì»¨í…Œì´ë„ˆ)ì˜ 31000, 31001 í¬íŠ¸ë¡œ 
ì—°ê²°ë˜ë„ë¡ ì„¤ì •ë˜ëŠ”ë°, ê·¸ ì´ìœ ëŠ” KIND í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í• ë•Œ ì•„ë˜ì™€ ê°™ì´ í¬íŠ¸ë¥¼ ì—´ê²ƒì„ ì§€ì •í–ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>

    <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
<span class="pi">-</span> <span class="na">role</span><span class="pi">:</span> <span class="s">worker</span>
  <span class="na">extraPortMappings</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">31000</span>
    <span class="na">hostPort</span><span class="pi">:</span> <span class="m">31000</span>
    <span class="na">listenAddress</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0.0.0.0"</span> <span class="c1"># Optional, defaults to "0.0.0.0"</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">tcp</span> <span class="c1"># Optional, defaults to tcp</span>
  <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">31001</span>
    <span class="na">hostPort</span><span class="pi">:</span> <span class="m">31001</span>
<span class="nn">...</span>
</code></pre></div>    </div>
    <p>ì¶”ê°€ì ì¸ í¬íŠ¸ ë§¤í•‘ì´ í•„ìš”í•œ ê²½ìš° ìœ„ì™€ ê°™ì´ <code class="language-plaintext highlighter-rouge">extraPortMappings</code>ì— ì¶”ê°€í•˜ì—¬ í¬íŠ¸ë¥¼ ë§¤í•‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Kube-ops-view ì„¤ì¹˜ : Node port 31000</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kube-ops-view</span>
<span class="c"># helm show values geek-cookbook/kube-ops-view</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>NodePort,service.main.ports.http.nodePort<span class="o">=</span>31000 <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep <span class="nt">-n</span> kube-system <span class="nt">-l</span> app.kubernetes.io/instance<span class="o">=</span>kube-ops-view
<span class="c"># =&gt; NAME                            READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/kube-ops-view   0/1     1            0           18s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                 READY   STATUS              RESTARTS   AGE</span>
<span class="c">#    pod/kube-ops-view-657dbc6cd8-tmkl5   0/1     ContainerCreating   0          18s</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/kube-ops-view   NodePort   10.96.212.51   &amp;lt;none&amp;gt;        8080:31000/TCP   18s</span>
<span class="c">#    </span>
<span class="c">#    NAME                      ENDPOINTS   AGE</span>
<span class="c">#    endpoints/kube-ops-view   &amp;lt;none&amp;gt;      18s</span>

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 , 2 ë°°ìœ¨)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:31000/#scale=1.5"</span>
<span class="c"># =&gt; KUBE-OPS-VIEW URL = http://localhost:31000/#scale=1.5</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:31000/#scale=2"</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_5.png" alt="img.png" /></p>

<p>í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì‹œ ë…¸ë“œì˜ 31000í¬íŠ¸ë¥¼ í˜¸ìŠ¤íŠ¸ì˜ 31000ì— ë§¤í•‘ì‹œì¼œì„œ í˜¸ìŠ¤íŠ¸ì—ì„œ ìœ„ì™€ ê°™ì´ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>nginx ì„¤ì¹˜ : NodePort 31001</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë””í”Œë¡œì´ë¨¼íŠ¸ì™€ ì„œë¹„ìŠ¤ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-websrv
spec:
  replicas: 2
  selector:
    matchLabels:
      app: deploy-websrv
  template:
    metadata:
      labels:
        app: deploy-websrv
    spec:
      terminationGracePeriodSeconds: 0
      containers:
      - name: deploy-websrv
        image: nginx:alpine
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: deploy-websrv
spec:
  ports:
    - name: svc-webport
      port: 80
      targetPort: 80
      nodePort: 31001
  selector:
    app: deploy-websrv
  type: NodePort
</span><span class="no">EOF

</span><span class="c"># í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                  NAMES</span>
<span class="c">#    5b7fa2f98703   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   15 minutes ago   Up 15 minutes   0.0.0.0:31000-31001-&amp;gt;31000-31001/tcp   myk8s-worker</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl get deploy,svc,ep deploy-websrv
<span class="c"># =&gt; ...</span>
<span class="c">#    NAME                    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/deploy-websrv   NodePort   10.96.115.233   &amp;lt;none&amp;gt;        80:31001/TCP   47s</span>
<span class="c">#    ...</span>

<span class="c"># ìì‹ ì˜ PCì— í˜¸ìŠ¤íŠ¸ í¬íŠ¸ 31001 ì ‘ì† ì‹œ ì¿ ë²„ë„¤í‹°ìŠ¤ ì„œë¹„ìŠ¤ì— ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span>open http://localhost:31001
<span class="nv">$ </span>curl <span class="nt">-s</span> localhost:31001 | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
<span class="c"># =&gt; &lt;title&gt;Welcome to nginx!&lt;/title&gt;</span>

<span class="c"># ë””í”Œë¡œì´ë¨¼íŠ¸ì™€ ì„œë¹„ìŠ¤ ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete deploy,svc deploy-websrv
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_6.png" alt="img.png" class="image-center" />
<em class="image-caption">31001 í¬íŠ¸ë¡œ ì ‘ì†ì‹œ nginx í˜ì´ì§€ê°€ ë‚˜ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</em></p>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_7.png" alt="img_1.png" />
<em class="image-caption">kube-ops-viewì—ì„œ deployëœ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</em></p>

<hr />

<h2 id="íŒŒë“œ--pause-ì»¨í…Œì´ë„ˆ">íŒŒë“œ &amp; PAUSE ì»¨í…Œì´ë„ˆ</h2>

<p><strong>íŒŒë“œ(pod)</strong>ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ <strong>ë°°í¬í•˜ëŠ” ìµœì†Œ ë‹¨ìœ„</strong>ì´ë©°, íŒŒë“œ ë‚´ë¶€ì—ëŠ” <strong>ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆê°€ í¬í•¨ë  ìˆ˜</strong> ìˆìŠµë‹ˆë‹¤. 
íŒŒë“œ ë‚´ë¶€ì—ëŠ” PAUSE ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ë©°, <strong>PAUSE ì»¨í…Œì´ë„ˆ</strong>ëŠ” <strong>Network/IPC/UTS ë„¤ì„ìŠ¤í˜ì´ìŠ¤</strong>ë¥¼ <strong>ìƒì„±</strong>í•˜ê³  <strong>ìœ ì§€</strong>/<strong>ê³µìœ </strong>í•˜ëŠ” ì—­í• ìš¸ í•©ë‹ˆë‹¤. 
ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ ë„¤íŠ¸ì›Œí¬ ë“±ì— ëŒ€í•´ì„œëŠ” 1ì£¼ì°¨ì—ì„œ í•™ìŠµí•œ ë‚´ìš©ì´ ë§ì´ ë„ì›€ë˜ì—ˆìŠµë‹ˆë‹¤. <a href="https://sweetlittlebird.github.io/posts/2024-08-27-KANS-Study-Week1/">1ì£¼ì°¨ ë§í¬</a></p>

<h3 id="k8s-cri-container-runtime-interface">K8S CRI (Container Runtime Interface)</h3>

<p>ë¨¼ì € íŒŒë“œì™€ PAUSE ì»¨í…Œì´ë„ˆì— ëŒ€í•´ ì•Œì•„ë³´ê¸°ì „ì— ì•ì„  ì‹¤ìŠµì—ì„œ ë³´ì•˜ë˜ CRI(Container Runtime Interface)ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ì»¨í…Œì´ë„ˆë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ <strong>CRI(Container Runtime Interface)</strong>ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<p>CRIì˜ íƒ„ìƒ ë°°ê²½ì€ ë¨¼ì € Dockerì—ì„œ ë¶€í„° ì°¾ì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
Dockerê°€ ëŒ€ì„±ê³µí•˜ê³  ì»¨í…Œì´ë„ˆ ê¸°ìˆ ì´ í™•ì‚°ë˜ë©´ì„œ, ì¿ ë²„ë„¤í‹°ìŠ¤ë„ Dockerë¥¼ ê¸°ë³¸ ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ìœ¼ë¡œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.
í•˜ì§€ë§Œ Docker Incë¼ëŠ” íšŒì‚¬ì— ì¢…ì†ë˜ëŠ”ê²ƒì„ ìš°ë ¤í•˜ì—¬, í‘œì¤€í™”ëœ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ ë‹¤ì–‘í•œ ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ì„ ì§€ì›í•˜ê³ ì í–ˆìŠµë‹ˆë‹¤.
ê·¸ë˜ì„œ CRIê°€ íƒ„ìƒí•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. CRIë¼ëŠ” í‘œì¤€ ì¸í„°í˜ì´ìŠ¤ë§Œ ì§€í‚¤ë©´ ì–´ë–¤ ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ì´ë¼ë„ ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
ì´ ê³¼ì •ì—ì„œ ì•„ì‰¬ìš´ê±´ DockerëŠ” CRIë¥¼ ì§€ì›í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì—, Dockerë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì—ëŠ” Docker shimì´ë¼ëŠ” í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•´ì•¼ í–ˆì—ˆìŠµë‹ˆë‹¤.</p>

<h3 id="íŒŒë“œ-pod">íŒŒë“œ (Pod)</h3>

<p>ì»¨í…Œì´ë„ˆ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ë³¸ ë‹¨ìœ„ë¥¼ íŒŒë“œ(Pod)ë¼ê³  ë¶€ë¥´ë©°, íŒŒë“œëŠ” 1ê°œ ì´ìƒì˜ ì»¨í…Œì´ë„ˆë¡œ êµ¬ì„±ëœ ì»¨í…Œì´ë„ˆì˜ ì§‘í•©ì…ë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_8.png" alt="img.png" /></p>

<ul>
  <li>PodëŠ” 1ê°œ ì´ìƒì˜ ì»¨í…Œì´ë„ˆë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Podë‚´ì— ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆë“¤ì€ ë™ì¼í•œ ë…¸ë“œì— í• ë‹¹ë˜ë©° ë™ì¼í•œ ìƒëª… ì£¼ê¸°(Life-cycle)ë¥¼ ê°–ìŠµë‹ˆë‹¤.</li>
  <li>PodëŠ” ë…¸ë“œ IP ì™€ ë³„ê°œë¡œ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ IPë¥¼ í• ë‹¹ ë°›ìœ¼ë©°, ë‹¤ë¥¸ ë…¸ë“œì— ìœ„ì¹˜í•œ Pod ë„ <strong>CNIë¥¼ í†µí•´</strong> NAT ì—†ì´ Pod IPë¡œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>Podë‚´ì— ìˆëŠ” ì»¨í…Œì´ë„ˆë“¤ì€ ì„œë¡œ IPë¥¼ ê³µìœ í•©ë‹ˆë‹¤. ê°™ì€ Podë‚´ì˜ ì»¨í…Œì´ë„ˆë¼ë¦¬ëŠ” localhost í†µí•´ ì„œë¡œ ì ‘ê·¼ê°€ëŠ¥ í•©ë‹ˆë‹¤.
    <ul>
      <li><strong>pause</strong> ì»¨í…Œì´ë„ˆê°€ network ns ë¥¼ ë§Œë“¤ì–´ ì£¼ê³ , ë‚´ë¶€ì˜ ì»¨í…Œì´ë„ˆë“¤ì€ í•´ë‹¹ net ns ë¥¼ ê³µìœ í•˜ê¸° ë•Œë¬¸ì— IPë¥¼ ê³µìœ í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Pod ì•ˆì˜ ì»¨í…Œì´ë„ˆë“¤ì€ ë™ì¼í•œ ë³¼ë¥¨ê³¼ ì—°ê²°ì´ ê°€ëŠ¥í•˜ì—¬ íŒŒì¼ ì‹œìŠ¤í…œì„ ê¸°ë°˜ìœ¼ë¡œ ì„œë¡œ íŒŒì¼ì„ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>PodëŠ” ë¦¬ì†ŒìŠ¤ ì œì•½ì´ ìˆëŠ” ê²©ë¦¬ëœ í™˜ê²½ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ ê·¸ë£¹ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.</li>
  <li>í¬ë“œë¥¼ ì‹œì‘í•˜ê¸° ì „ì— kubeletì€ RuntimeService.RunPodSandboxë¥¼ í˜¸ì¶œí•˜ì—¬ í™˜ê²½ì„ ë§Œë“­ë‹ˆë‹¤.</li>
  <li>Kubeletì€ RPCë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆì˜ ìˆ˜ëª… ì£¼ê¸°ë¥¼ ê´€ë¦¬í•˜ê³ , ì»¨í…Œì´ë„ˆ ìˆ˜ëª… ì£¼ê¸° í›„í¬ì™€ í™œì„±/ì¤€ë¹„ í™•ì¸ì„ ì‹¤í–‰í•˜ë©°, Podì˜ ì¬ì‹œì‘ ì •ì±…ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤</li>
</ul>

<h3 id="pause-ì»¨í…Œì´ë„ˆ">PAUSE ì»¨í…Œì´ë„ˆ</h3>

<ul>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ <strong>pause</strong> ì»¨í…Œì´ë„ˆëŠ” í¬ë“œì˜ ëª¨ë“  ì»¨í…Œì´ë„ˆì— ëŒ€í•œ â€œ<strong>ë¶€ëª¨ ì»¨í…Œì´ë„ˆ</strong>â€ ì—­í• ì„ í•©ë‹ˆë‹¤. - <a href="https://sklar.rocks/what-is-a-pod-sandbox/">Link</a></li>
  <li><strong>pause</strong> ì»¨í…Œì´ë„ˆì—ëŠ” ë‘ ê°€ì§€ í•µì‹¬ ì±…ì„ì´ ìˆìŠµë‹ˆë‹¤.
    <ol>
      <li>íŒŒë“œì—ì„œ Linux <strong>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³µìœ ì˜ ê¸°ë°˜</strong> ì—­í• ì„ í•©ë‹ˆë‹¤. (Network, IPC, UTS ë„¤ì„ìŠ¤í˜ì´ìŠ¤)</li>
      <li>PID(í”„ë¡œì„¸ìŠ¤ ID) ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³µìœ ê°€ í™œì„±í™”ë˜ë©´ ê° í¬ë“œì— ëŒ€í•œ <strong>PID 1 ì—­í• </strong>ì„ í•˜ë©° <strong>ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ë¥¼ ê±°ë‘¡</strong>ë‹ˆë‹¤.</li>
    </ol>
  </li>
  <li>pauseì˜ í•µì‹¬ ì†ŒìŠ¤ì½”ë“œëŠ” <a href="https://github.com/kubernetes/kubernetes/blob/master/build/pause/linux/pause.c">ì—¬ê¸°</a>ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
ë§¤ìš° ì§§ì§€ë§Œ ì¤‘ìš”í•œ ì½”ë“œì…ë‹ˆë‹¤. ìƒì„¸í•˜ê²Œ ì½”ë“œë¶„ì„í•œ ë¶„ì´ ìˆì–´ì„œ ìì„¸íˆ ì•Œê³  ì‹¶ìœ¼ì‹  ë¶„ì€ ë‹¤ìŒ ë§í¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
<a href="https://mateon.tistory.com/127">í•œê¸€ ë§í¬</a>
<a href="https://www.ianlewis.org/en/almighty-pause-container">ì˜ë¬¸ ë§í¬</a></li>
</ul>

<h4 id="pause-ì»¨í…Œì´ë„ˆ-ì‹¤ìŠµ">Pause ì»¨í…Œì´ë„ˆ ì‹¤ìŠµ</h4>

<ul>
  <li>Pause ì»¨í…Œì´ë„ˆì˜ ë™ì‘ì— ëŒ€í•´ ì‹¤ìŠµí•˜ê¸° ìœ„í•œ í™˜ê²½ì„ êµ¬ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 'ì»¨íŠ¸ë¡¤í”Œë ˆì¸, ì›Œì»¤ ë…¸ë“œ 1ëŒ€' í´ëŸ¬ìŠ¤í„° ë°°í¬ : íŒŒë“œì— ì ‘ì†í•˜ê¸° ìœ„í•œ í¬íŠ¸ ë§µí•‘ ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; kind-2node.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
</span><span class="no">EOT
</span><span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-2node.yaml <span class="nt">--name</span> myk8s

<span class="c"># íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop git nano -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker        sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop -y'</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> wide
<span class="nv">$ </span>docker ps
<span class="nv">$ </span>docker port myk8s-worker
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr

<span class="c"># kube-ops-view</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>NodePort,service.main.ports.http.nodePort<span class="o">=</span>30000 <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep <span class="nt">-n</span> kube-system <span class="nt">-l</span> app.kubernetes.io/instance<span class="o">=</span>kube-ops-view

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 , 2 ë°°ìœ¨)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:30000/#scale=1.5"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:30000/#scale=2"</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_9.png" alt="img.png" /></p>

<ul>
  <li>worker ë…¸ë“œì— ì§„ì… í›„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²©ë¦¬ë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [í„°ë¯¸ë„1] myk8s-worker bash ì§„ì… í›„ ì‹¤í–‰ ë° í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="nt">----------------------------------</span>
<span class="nv">$ </span>systemctl list-unit-files | <span class="nb">grep</span> <span class="s1">'enabled         enabled'</span>
<span class="c"># =&gt; containerd.service                                                                    enabled         enabled</span>
<span class="c">#    kubelet.service                                                                       enabled         enabled</span>
<span class="c">#    ...</span>

<span class="c"># í™•ì¸ : kubeletì— --container-runtime-endpoint=unix:///run/containerd/containerd.sock</span>
<span class="nv">$ </span>pstree <span class="nt">-aln</span>
<span class="c"># =&gt; systemd</span>
<span class="c">#      |-systemd-journal</span>
<span class="c">#      |-containerd</span>
<span class="c">#      |   `-15*[{containerd}]</span>
<span class="c">#      |-kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --container-runtime-endpoint=unix:///run/containerd/containerd.sock --node-ip=172.20.0.3 --node-labels= --pod-infra-container-image=registry.k8s.io/pause:3.10 --provider-id=kind://docker/myk8s/myk8s-worker --runtime-cgroups=/system.slice/containerd.service</span>
<span class="c">#      |   `-13*[{kubelet}]</span>
<span class="c">#      |-containerd-shim -namespace k8s.io -id 3368a087d8af3e241201257993e178d6a7d8ea23d3148cdf2ec5392f9db49832 -address /run/containerd/containerd.sock</span>
<span class="c">#      |   |-11*[{containerd-shim}]</span>
<span class="c">#      |   |-pause</span>
<span class="c">#      |   `-kindnetd</span>
<span class="c">#      |       `-11*[{kindnetd}]</span>
<span class="c">#      |-containerd-shim -namespace k8s.io -id e983e9fcff0162dec6128e014ae9092454fe0fd748ba237320aec17fa85fb17b -address /run/containerd/containerd.sock</span>
<span class="c">#      |   |-11*[{containerd-shim}]</span>
<span class="c">#      |   |-pause</span>
<span class="c">#      |   `-kube-proxy --config=/var/lib/kube-proxy/config.conf --hostname-override=myk8s-worker</span>
<span class="c">#      |       `-8*[{kube-proxy}]</span>
<span class="c">#      `-containerd-shim -namespace k8s.io -id 9cdabafac520e373ff0efdbbbe8b87bdfd7a0d02bd897863b609eefc4ae21b36 -address /run/containerd/containerd.sock</span>
<span class="c">#          |-12*[{containerd-shim}]</span>
<span class="c">#          |-pause</span>
<span class="c">#          `-python3 /usr/local/bin/python3 -m kube_ops_view</span>
<span class="c">#              `-2*[{python3}]</span>
          
<span class="c"># í™•ì¸ : íŒŒë“œë‚´ì— pause ì»¨í…Œì´ë„ˆì™€ kube_ops_view ì»¨í…Œì´ë„ˆ, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì •ë³´</span>
<span class="nv">$ </span>pstree <span class="nt">-aclnpsS</span>
<span class="c"># =&gt; ...</span>
<span class="c">#      `-containerd-shim,1089 -namespace k8s.io -id 9cdabafac520e373ff0efdbbbe8b87bdfd7a0d02bd897863b609eefc4ae21b36 -address /run/containerd/contai</span>
<span class="c">#    nerd.sock</span>
<span class="c">#          |-{containerd-shim},1090</span>
<span class="c">#          ...</span>
<span class="c">#          |-pause,1110,ipc,mnt,net,pid,uts</span>
<span class="c">#          |-python3,1173,cgroup,ipc,mnt,net,pid,uts /usr/local/bin/python3 -m kube_ops_view</span>
<span class="c">#          ...</span>
<span class="c">#    ...</span>
      
<span class="c"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸ : lsns - List system namespaces</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> 1
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="nv">$$</span>
<span class="c"># =&gt;         NS TYPE   NPROCS PID USER COMMAND</span>
<span class="c">#    4026531834 time       15   1 root /sbin/init</span>
<span class="c">#    4026531837 user       15   1 root /sbin/init</span>
<span class="c">#    4026532329 mnt         9   1 root /sbin/init</span>
<span class="c">#    4026532330 uts        13   1 root /sbin/init</span>
<span class="c">#    4026532338 ipc         9   1 root /sbin/init</span>
<span class="c">#    4026532339 pid         9   1 root /sbin/init</span>
<span class="c">#    4026532341 net        13   1 root /sbin/init</span>
<span class="c">#    4026532417 cgroup     13   1 root /sbin/init</span>

<span class="c"># íŒŒë“œì˜ pause ì»¨í…Œì´ë„ˆëŠ” ë…¸ë“œì˜ NSì™€ ë‹¤ë¥¸ 5ê°œì˜ NSë¥¼ ê°€ì§ : mnt/pid ëŠ” pasue ìì‹ ë§Œ ì‚¬ìš©, net/uts/ipcëŠ” app ì»¨í…Œì´ë„ˆë¥¼ ìœ„í•´ì„œ ë¨¼ì € ìƒì„±í•´ë‘ </span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> 1797  <span class="c"># kube_ops_view íŒŒë“œì˜ pause ì»¨í…Œì´ë„ˆ</span>
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    4026531834 time       15     1 root  /sbin/init</span>
<span class="c">#    4026531837 user       15     1 root  /sbin/init</span>
<span class="c">#    4026532417 cgroup     13     1 root  /sbin/init </span>
<span class="c">#    4026532805 net         2  1110 65535 /pause      # Node NSì™€ ë‹¤ë¦„  </span>
<span class="c">#    4026532883 mnt         1  1110 65535 /pause      # Node NSì™€ ë‹¤ë¦„</span>
<span class="c">#    4026532884 uts         2  1110 65535 /pause      # Node NSì™€ ë‹¤ë¦„</span>
<span class="c">#    4026532885 ipc         2  1110 65535 /pause      # Node NSì™€ ë‹¤ë¦„</span>
<span class="c">#    4026532886 pid         1  1110 65535 /pause      # Node NSì™€ ë‹¤ë¦„</span>

<span class="c"># app ì»¨í…Œì´ë„ˆ(kube_ops_view)ëŠ” í˜¸ìŠ¤íŠ¸NSì™€ ë‹¤ë¥¸ 6ê°œì˜ NSë¥¼ ê°€ì§ : mnt/pid/cgroup ëŠ” ìì‹ ë§Œ ì‚¬ìš©, net/uts/ipcëŠ” pause ì»¨í…Œì´ë„ˆê°€ ìƒì„±í•œ ê²ƒì„ ê³µìœ  ì‚¬ìš©í•¨</span>
<span class="nv">$ </span>pgrep <span class="nt">-f</span> kube_ops_view
<span class="c"># =&gt; 1173</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="si">$(</span>pgrep <span class="nt">-f</span> kube_ops_view<span class="si">)</span>
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    4026531834 time       15     1 root  /sbin/init</span>
<span class="c">#    4026531837 user       15     1 root  /sbin/init</span>
<span class="c">#    4026532805 net         2  1110 65535 /pause      # pause ì»¨í…Œì´ë„ˆì™€ ê³µìœ </span>
<span class="c">#    4026532884 uts         2  1110 65535 /pause      # pause ì»¨í…Œì´ë„ˆì™€ ê³µìœ </span>
<span class="c">#    4026532885 ipc         2  1110 65535 /pause      # pause ì»¨í…Œì´ë„ˆì™€ ê³µìœ </span>
<span class="c">#    4026532887 mnt         1  1173 1000  /usr/bin/qemu-x86_64 /usr/local/bin/python3 -m kube_ops_view  # ìì‹ ë§Œ ì‚¬ìš©</span>
<span class="c">#    4026532888 pid         1  1173 1000  /usr/bin/qemu-x86_64 /usr/local/bin/python3 -m kube_ops_view  # ìì‹ ë§Œ ì‚¬ìš©</span>
<span class="c">#    4026532889 cgroup      1  1173 1000  /usr/bin/qemu-x86_64 /usr/local/bin/python3 -m kube_ops_view  # ìì‹ ë§Œ ì‚¬ìš©</span>
</code></pre></div></div>

<ul>
  <li>ìœ„ì™€ ê°™ì´ íŒŒë“œ ë‚´ë¶€ì˜ pause ì»¨í…Œì´ë„ˆì™€ kube_ops_view ì»¨í…Œì´ë„ˆëŠ” net, uts, ipc ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê³µìœ í•˜ê³ , mnt, pid, cgroup ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ê°ê°ì˜ ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ë ‡ê²Œ pause ì»¨í…Œì´ë„ˆê°€ íŒŒë“œ ë‚´ë¶€ì˜ ì»¨í…Œì´ë„ˆë“¤ì´ ê³µìœ í•˜ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ìœ ì§€í•˜ëŠ” ì—­í• ì„ í•˜ëŠ”ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
  <li>ë§ˆì§€ë§‰ìœ¼ë¡œ DINDë¥¼ ìœ„í•œ containerd.sock ê³¼ cgroup2fs, sys, proc ë“±ì˜ ì •ë³´ë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># containerd.sock ì •ë³´ í™•ì¸ (docker.sockê³¼ ë¹„ìŠ·í•œ ì—­í• )</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /run/containerd/containerd.sock
<span class="c"># =&gt; srw-rw---- 1 root root 0 Sep  7 15:20 /run/containerd/containerd.sock</span>

<span class="c"># íŠ¹ì • ì†Œì¼“ íŒŒì¼ì„ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>lsof /run/containerd/containerd.sock
<span class="c"># =&gt; COMMAND   PID USER   FD   TYPE             DEVICE SIZE/OFF   NODE NAME</span>
<span class="c">#    container 106 root    9u  unix 0x0000000000000000      0t0 726698 /run/containerd/containerd.sock type=STREAM (LISTEN)</span>
<span class="c">#    container 106 root   11u  unix 0x0000000000000000      0t0 734691 /run/containerd/containerd.sock type=STREAM (CONNECTED)</span>
<span class="c">#    container 106 root   12u  unix 0x0000000000000000      0t0 738482 /run/containerd/containerd.sock type=STREAM (CONNECTED)</span>
<span class="c">#    container 106 root   14u  unix 0x0000000000000000      0t0 736712 /run/containerd/containerd.sock type=STREAM (CONNECTED)</span>

<span class="c"># /sys ë””ë ‰í„°ë¦¬ í™•ì¸</span>
<span class="nv">$ </span>findmnt <span class="nt">-A</span>
<span class="c"># =&gt; TARGET                                                  SOURCE                 FSTYPE    OPTIONS</span>
<span class="c">#    /                                                       overlay                overlay   rw,relatime,lowerdir=/var/lib/docker/overlay2/l/5UMBJJ</span>
<span class="c">#    ...</span>
<span class="c">#    |-/sys                                                  sysfs                  sysfs     ro,nosuid,nodev,noexec,relatime</span>
<span class="c">#    | |-/sys/kernel/tracing                                 tracefs                tracefs   rw,nosuid,nodev,noexec,relatime</span>
<span class="c">#    | |-/sys/kernel/debug                                   debugfs                debugfs   rw,nosuid,nodev,noexec,relatime</span>
<span class="c">#    | |-/sys/fs/fuse/connections                            fusectl                fusectl   rw,nosuid,nodev,noexec,relatime</span>
<span class="c">#    | |-/sys/kernel/config                                  configfs               configfs  rw,nosuid,nodev,noexec,relatime</span>
<span class="c">#    | `-/sys/fs/cgroup                                      cgroup                 cgroup2   rw,nosuid,nodev,noexec,relatime</span>
<span class="c">#    ...</span>

<span class="c"># cgroup ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>findmnt <span class="nt">-t</span> cgroup2
<span class="c"># =&gt; TARGET         SOURCE FSTYPE  OPTIONS</span>
<span class="c">#    /sys/fs/cgroup cgroup cgroup2 rw,nosuid,nodev,noexec,relatime</span>
<span class="nv">$ </span><span class="nb">grep </span>cgroup /proc/filesystems
<span class="c"># =&gt; nodev	cgroup</span>
<span class="c">#    nodev	cgroup2</span>
<span class="nv">$ </span><span class="nb">stat</span> <span class="nt">-fc</span> %T /sys/fs/cgroup/
<span class="c"># =&gt; cgroup2fs</span>

<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------------</span>
</code></pre></div></div>

<ul>
  <li>ì‹ ê·œíŒŒë“œë¥¼ ë°°í¬í•˜ê³  í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [í„°ë¯¸ë„2] kubectl ëª…ë ¹ ì‹¤í–‰ ë° í™•ì¸</span>

<span class="c"># Pod ìƒì„± : YAML íŒŒì¼ì— ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•  í¬íŠ¸(TCP 80)ì„ ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: myweb
spec:
  containers:
  - image: nginx:alpine
    name: myweb-container
    ports:
    - containerPort: 80
      protocol: TCP
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF

</span><span class="c"># Pod ì •ë³´ í™•ì¸ : pause ì»¨í…Œì´ë„ˆ ì •ë³´ê°€ ë³´ì´ëŠ”ì§€ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME    READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES</span>
<span class="c">#    myweb   1/1     Running   0          15s   10.244.1.3   myk8s-worker   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="nv">$ </span>kubectl describe pod myweb | <span class="nb">grep</span> <span class="nt">-i</span> pause
<span class="nv">$ </span>kubectl get pod myweb <span class="nt">-o</span> json | <span class="nb">grep</span> <span class="nt">-i</span> pause

<span class="nt">---</span>

<span class="c"># [í„°ë¯¸ë„1] myk8s-worker bash ì§„ì… í›„ ì‹¤í–‰ ë° í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="nt">----------------------------------</span>
<span class="nv">$ </span>crictl ps
<span class="nv">$ </span>pstree <span class="nt">-aln</span>
<span class="nv">$ </span>pstree <span class="nt">-aclnpsS</span> <span class="c"># íŒŒë“œë‚´ì— pause ì»¨í…Œì´ë„ˆì™€ app ì»¨í…Œì´ë„ˆ, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì •ë³´</span>
<span class="c"># =&gt;   `-containerd-shim,1673 -namespace k8s.io -id 482ba93ecf76d46938d60e58f363e63e681d8a779439f270ff9c8417ad25a641 -address /run/containerd/containerd.sock</span>
<span class="c">#          |-{containerd-shim},1674</span>
<span class="c">#          ...</span>
<span class="c">#          |-pause,1693,ipc,mnt,net,pid,uts</span>
<span class="c">#          |-nginx,1754,cgroup,ipc,mnt,net,pid,uts</span>

<span class="c"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸ : lsns - List system namespaces</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> 1
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="nv">$$</span>
<span class="c"># =&gt;         NS TYPE   NPROCS PID USER COMMAND</span>
<span class="c">#    4026531834 time       25   1 root /sbin/init</span>
<span class="c">#    4026531837 user       25   1 root /sbin/init</span>
<span class="c">#    4026532329 mnt        10   1 root /sbin/init</span>
<span class="c">#    4026532330 uts        14   1 root /sbin/init</span>
<span class="c">#    4026532338 ipc        10   1 root /sbin/init</span>
<span class="c">#    4026532339 pid        10   1 root /sbin/init</span>
<span class="c">#    4026532341 net        14   1 root /sbin/init</span>
<span class="c">#    4026532417 cgroup     15   1 root /sbin/init</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> 1693 
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    4026531834 time       25     1 root  /sbin/init</span>
<span class="c">#    4026531837 user       25     1 root  /sbin/init</span>
<span class="c">#    4026532417 cgroup     15     1 root  /sbin/init</span>
<span class="c">#    4026532891 net         9  1693 65535 /pause</span>
<span class="c">#    4026532969 mnt         1  1693 65535 /pause</span>
<span class="c">#    4026532970 uts         9  1693 65535 /pause</span>
<span class="c">#    4026532971 ipc         9  1693 65535 /pause</span>
<span class="c">#    4026532972 pid         1  1693 65535 /pause</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="si">$(</span>pgrep <span class="nt">-n</span> nginx<span class="si">)</span> <span class="c"># app ì»¨í…Œì´ë„ˆ(nginx)</span>
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    4026531834 time       25     1 root  /sbin/init</span>
<span class="c">#    4026531837 user       25     1 root  /sbin/init</span>
<span class="c">#    4026532891 net         9  1693 65535 /pause</span>
<span class="c">#    4026532970 uts         9  1693 65535 /pause</span>
<span class="c">#    4026532971 ipc         9  1693 65535 /pause</span>
<span class="c">#    4026532973 mnt         8  1754 root  nginx: master process nginx -g daemon off;</span>
<span class="c">#    4026532974 pid         8  1754 root  nginx: master process nginx -g daemon off;</span>
<span class="c">#    4026532975 cgroup      8  1754 root  nginx: master process nginx -g daemon off;</span>
<span class="nt">----------------------------------</span>
<span class="c"># [í„°ë¯¸ë„2] kubectl ëª…ë ¹ ì‹¤í–‰ ë° í™•ì¸</span>
<span class="nv">$ </span>kubectl delete pod myweb
</code></pre></div></div>

<ul>
  <li>ìœ„ì™€ ê°™ì´ <code class="language-plaintext highlighter-rouge">kubectl</code>ê³¼ ê°™ì€ high-levelì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">pause</code> ì»¨í…Œì´ë„ˆê°€ ë³´ì´ì§€ ì•Šì§€ë§Œ, <code class="language-plaintext highlighter-rouge">ps</code>ë‚˜ <code class="language-plaintext highlighter-rouge">lsns</code>ì™€ ê°™ì€ OSì— ì ‘ê·¼ ê°€ëŠ¥í•œ ëª…ë ¹ìœ¼ë¡œëŠ” 
<code class="language-plaintext highlighter-rouge">pause</code> ì»¨í…Œì´ë„ˆê°€ í™•ì¸ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ëŠ” pause ì»¨í…Œì´ë„ˆëŠ” ê³µê¸°ì™€ ê°™ì´ í•­ìƒ íŒŒë“œì— ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì— êµ³ì´ ë³´ì—¬ì¤˜ì„œ í™”ë©´ë§Œ ë³µì¡í•˜ê²Œ í•  ë¿ ë³´ì—¬ì¤„ í•„ìš”ê°€ ì—†ë‹¤ íŒë‹¨í•œê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
  <li>PAUSE Containerê°€ nsë¥¼ ê³µìœ í•˜ëŠ” íŠ¹ì„±ì„ ì´ìš©í•˜ì—¬,
ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ëŸ°íƒ€ì„ ì˜ì¡´ì„±ë§Œ í¬í•¨í•˜ëŠ” ìµœì†Œí™”ëœ ì´ë¯¸ì§€ê¸°ë°˜ ì»¨í…Œì´ë„ˆì¸ Distroless Containerë¥¼ ëŒ€ìƒìœ¼ë¡œ
Ephemeral Containersì™€ ê°™ì€ í˜•íƒœë¡œ ë””ë²„ê¹…ì— í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/">Link</a></li>
</ul>

<h2 id="cni-container-network-interface">CNI (Container Network Interface)</h2>

<ul>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” CNI(Container Network Interface)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. 
CNIëŠ” ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ê³¼ ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸ì„ ì—°ê²°í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ë¡œ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê³ , IP ì£¼ì†Œë¥¼ í• ë‹¹í•˜ë©°,
ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ì ìš©í•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
  <li>CNIì˜ ì£¼ìš” ê¸°ëŠ¥
    <ul>
      <li><strong>ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ìƒì„±</strong>: CNI í”ŒëŸ¬ê·¸ì¸ì€ ì»¨í…Œì´ë„ˆì— ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤(ì˜ˆ: ê°€ìƒ ì´ë”ë„· ì¥ì¹˜)ë¥¼ ìƒì„±í•˜ê³  ì»¨í…Œì´ë„ˆ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì´ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.</li>
      <li><strong>IP ì£¼ì†Œ í• ë‹¹</strong>: í”ŒëŸ¬ê·¸ì¸ì€ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ì— IP ì£¼ì†Œë¥¼ í• ë‹¹í•˜ê³ , í•„ìš”ì— ë”°ë¼ IP ì£¼ì†Œ ê´€ë¦¬ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.</li>
      <li><strong>ë„¤íŠ¸ì›Œí¬ ì •ì±… ì ìš©</strong>: ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ í†µí•´ íŠ¸ë˜í”½ì„ ì œì–´í•  ìˆ˜ ìˆìœ¼ë©°, CNI í”ŒëŸ¬ê·¸ì¸ì€ ì´ë¥¼ êµ¬í˜„í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.</li>
      <li><strong>ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œ ì§€ì›</strong>: ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ í† í´ë¡œì§€ì™€ ìš”êµ¬ ì‚¬í•­ì„ ì§€ì›í•˜ê¸° ìœ„í•´ ì—¬ëŸ¬ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œ(ì˜ˆ: ë¸Œë¦¬ì§€, VLAN, ì˜¤ë²„ë ˆì´ ë„¤íŠ¸ì›Œí¬ ë“±)ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>CNIì˜ ì‘ë™ ë°©ì‹
    <ul>
      <li>CNIëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í”ŒëŸ¬ê·¸ì¸ ê¸°ë°˜ êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ë„êµ¬ëŠ” íŠ¹ì • ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œ CNI í”ŒëŸ¬ê·¸ì¸ì„ í˜¸ì¶œí•˜ì—¬ í•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ê° CNI í”ŒëŸ¬ê·¸ì¸ì€ JSON í˜•ì‹ì˜ êµ¬ì„± íŒŒì¼ë¡œ ì •ì˜ë˜ë©°, ì´ë¥¼ í†µí•´ í”ŒëŸ¬ê·¸ì¸ì˜ ë™ì‘ì„ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>CNI í”ŒëŸ¬ê·¸ì¸ì˜ ì¢…ë¥˜ : CNI í”ŒëŸ¬ê·¸ì¸ì€ ë‹¤ì–‘í•œ ì¢…ë¥˜ê°€ ìˆìœ¼ë©°, ê°ê¸° ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí‚¹ ìš”êµ¬ ì‚¬í•­ì„ ì¶©ì¡±ì‹œí‚µë‹ˆë‹¤. ëŒ€í‘œì ì¸ CNI í”ŒëŸ¬ê·¸ì¸ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    <ul>
      <li><strong>Flannel</strong>: ê°„ë‹¨í•˜ê³  ì‚¬ìš©í•˜ê¸° ì‰¬ìš´ ì˜¤ë²„ë ˆì´ ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</li>
      <li><strong>Calico</strong>: ë„¤íŠ¸ì›Œí¬ ì •ì±…ê³¼ ë³´ì•ˆì„ ê°•ì¡°í•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ, ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ ë° ì •ì±… ì ìš©ì— ê°•ì ì´ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>Weave</strong>: ìë™ ë©”ì‰¬ ë„¤íŠ¸ì›Œí¬ì™€ ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ë¥¼ ì œê³µí•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</li>
      <li><strong>Cilium</strong>: ê³ ì„±ëŠ¥ BPF ê¸°ë°˜ ë„¤íŠ¸ì›Œí‚¹ ë° ë³´ì•ˆì„ ì œê³µí•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</li>
      <li><strong>Multus</strong>: ì—¬ëŸ¬ CNI í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆì— ì—¬ëŸ¬ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì§€ì›í•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="4ê°€ì§€-ìš”êµ¬ì‚¬í•­ê³¼-4ê°€ì§€-ë¬¸ì œ">4ê°€ì§€ ìš”êµ¬ì‚¬í•­ê³¼ 4ê°€ì§€ ë¬¸ì œ</h3>

<p>ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ë„¤íŠ¸ì›Œí¬ ëª¨ë¸ì€ 4ê°€ì§€ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•´ì•„í•˜ë©° 4ê°€ì§€ ë¬¸ì œë¥¼ í•´ê²°í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<ul>
  <li>4ê°€ì§€ ìš”êµ¬ì‚¬í•­
    <ol>
      <li>íŒŒë“œì™€ íŒŒë“œ ê°„ í†µì‹  ì‹œ NAT(Network Address Translation) ì—†ì´ í†µì‹ ì´ ê°€ëŠ¥í•´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>ë…¸ë“œì˜ ì—ì´ì „íŠ¸(ì˜ˆ) kubelet, ì‹œìŠ¤í…œ ë°ëª¬)ëŠ” Podì™€ í†µì‹ ì´ ê°€ëŠ¥í•´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ëŠ” íŒŒë“œëŠ” NAT ì—†ì´ íŒŒë“œì™€ í†µì‹ ì´ ê°€ëŠ¥í•´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>ì„œë¹„ìŠ¤ í´ëŸ¬ìŠ¤í„° IP ëŒ€ì—­ê³¼ íŒŒë“œê°€ ì‚¬ìš©í•˜ëŠ” IP ëŒ€ì—­ì€ ì¤‘ë³µë˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.</li>
    </ol>
  </li>
  <li>í•´ê²°í•´ì•¼ í•˜ëŠ” ë¬¸ì œ
    <ol>
      <li>íŒŒë“œ ë‚´ ì»¨í…Œì´ë„ˆëŠ” Loopbackì„ í†µí•œ í†µì‹ ì„ í•  ìˆ˜ ìˆë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>íŒŒë“œ ê°„ í†µì‹ ì„ í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ Serviceë¥¼ í†µí•œ í†µì‹ ì„ í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ Serviceë¥¼ í†µí•œ í†µì‹ ì„ í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
    </ol>
  </li>
</ul>

<p>ìœ„ì™€ ê°™ì€ ìš”êµ¬ì‚¬í•­ê³¼ ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ì›í™œí•œ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì„ ìœ„í•´ CNI(Container Network Interface)ë¥¼ ì •ì˜í–ˆìŠµë‹ˆë‹¤.
CNI í”ŒëŸ¬ê·¸ì¸ë“¤ì€ ì´ëŸ¬í•œ ìš”êµ¬ì‚¬í•­ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_10.png" alt="img.png" class="image-center" />
<em class="image-caption">CNI í”ŒëŸ¬ê·¸ì¸ ë™ì‘ (ì¶œì²˜: ì¶”ê°€ì˜ˆì •)</em></p>

<p>Kubeletì„ í†µí•´ íŒŒë“œê°€ ì‹ ê·œ ìƒì„±ë  ë•Œ ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ ì„¤ì • ì¶”ê°€ í•„ìš”í•©ë‹ˆë‹¤. 
CNI í”ŒëŸ¬ê·¸ì¸ì€ ì „ë‹¬ë˜ëŠ” ì„¤ì • ì •ì˜ì„œë¥¼ ë³´ê³  ì‹¤ì œ íŒŒë“œê°€ í†µì‹ í•˜ê¸° ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ì„¤ì •ë“¤ì„ ì‹¤í–‰í•˜ê²Œ ë©ë‹ˆë‹¤.
ë˜í•œ CNI í”ŒëŸ¬ê·¸ì¸ì€ IPAM(IP Address Management), 
ì¦‰ IP í• ë‹¹ ê´€ë¦¬ë¥¼ ìˆ˜í–‰í•´ì•¼ í•˜ë©°, íŒŒë“œ ê°„ í†µì‹ ì„ ìœ„í•œ ë¼ìš°íŒ… ì„¤ì •ì„ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<h2 id="flannel">Flannel</h2>

<ul>
  <li>Flannelì€ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ë„¤íŠ¸ì›Œí¬ ìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±í•˜ëŠ” ê°€ì¥ ê°„ë‹¨í•˜ê³  ì‚¬ìš©í•˜ê¸° ì‰¬ìš´ ì˜¤ë²„ë ˆì´ ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</li>
  <li>Flannelì€ ê°€ìƒ ë„¤íŠ¸ì›Œí¬ë¥¼ ìƒì„±í•˜ì—¬ íŒŒë“œ ê°„ í†µì‹ ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ë©°, VXLAN, UDP, Host-GW ë“±ì˜ ë°±ì—”ë“œë¥¼ ì§€ì›í•©ë‹ˆë‹¤.
í•˜ì§€ë§Œ VXLAN ì‚¬ìš©ì´ ê¶Œì¥ë©ë‹ˆë‹¤.</li>
  <li>VXLANì€ Virtual eXtensible Local Area Networkì˜ ì•½ìë¡œ, ë¬¼ë¦¬ì ì¸ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ  ë…¼ë¦¬ì ì¸ ê°€ìƒì˜ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì„ ë§Œë“¤ì–´ ì£¼ëŠ” ê²ƒìœ¼ë¡œ, UDP 8472Â  í¬íŠ¸ë¥¼ í†µí•´ ë…¸ë“œ ê°„ í„°ë„ë§ ê¸°ë²•ìœ¼ë¡œ í†µì‹ í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.Â </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_11.png" alt="img.png" class="image-center" />
<em class="image-caption">Flannel êµ¬ì¡° (ì¶œì²˜: ì¶”ê°€ì˜ˆì •)</em></p>

<ul>
  <li>ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ íŒŒë“œì˜ eth0 ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ëŠ” í˜¸ìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ veth ì¸í„°í˜ì´ìŠ¤ì™€ ì—°ê²°ë˜ê³ ,
vethëŠ” cni0ì™€ ì—°ê²°ë©ë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ í†µí•´ ê°™ì€ ë…¸ë“œì—ì„œ í†µì‹ ì‹œ cni0 ë¸Œë¦¿ì§€ë¥¼ í†µí•´ì„œ í†µì‹ í•˜ê³ , ë‹¤ë¥¸ ë…¸ë“œì™€ í†µì‹ ì‹œ VXLANì„ í†µí•´ í†µì‹ í•©ë‹ˆë‹¤.</li>
  <li>VXLANìœ¼ë¡œ ê°€ëŠ” ê³¼ì •ì€ cni0 ë¸Œë¦¿ì§€ë¥¼ í†µí•´ flannel.1 ì¸í„°í˜ì´ìŠ¤ë¡œ ê°€ê³ , flannel.1ì€ í˜¸ìŠ¤íŠ¸ì˜ eth0ì„ í†µí•´ ë‹¤ë¥¸ ë…¸ë“œì— ì „ì†¡ì„ í•©ë‹ˆë‹¤.
ì´ë•Œ <strong>flannel.1ì€ VTEP(Vxlan Tunnel End Point)</strong>ë¼ê³  í•˜ë©° íŒ¨í‚·ì„ ê°ì‹¸ì„œ ëª©í‘œ nodeì˜ IPë¡œ ì „ì†¡í•˜ë©´, ëª©í‘œ nodeì—ì„œ ê°ì‹¼ íŒ¨í‚·ì„ í’€ì–´ì„œ 
í•´ë‹¹ íŒŒë“œì˜ IPë¡œ ë‹¤ì‹œ ë³´ë‚´ëŠ” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
  <li>ê° ë…¸ë“œë§ˆë‹¤ íŒŒë“œì— í• ë‹¹í•  ìˆ˜ ìˆëŠ” IP ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì´ ìˆê³ , flannelì„ í†µí•˜ì—¬ ETCDë‚˜ Kubernetes APIì— ì „ë‹¬ë˜ì–´, ëª¨ë“  ë…¸ë“œëŠ” í•´ë‹¹ ì •ë³´ë¥¼ ìì‹ ì˜ ë¼ìš°íŒ… í…Œì´ë¸”ì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
ì´ë¥¼ í†µí•´ ê°ê° ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œë¼ë¦¬ë„ ë‚´ë¶€ IP ì£¼ì†Œë¥¼ í†µí•´ í†µì‹ ì´ ê°€ëŠ¥í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
</ul>

<h3 id="kind-ì™€-flannel-ì„¤ì¹˜">Kind ì™€ Flannel ì„¤ì¹˜</h3>

<ul>
  <li>Kind í´ëŸ¬ìŠ¤í„°ì— Flannelì„ ì„¤ì¹˜í•´ë³´ê² ìŠµë‹ˆë‹¤. kindëŠ” ê¸°ë³¸ CNIë¡œ kindnetì„ ì‚¬ìš©í•˜ëŠ”ë° ì‹¤ìŠµì„ ìœ„í•´ kindnetì„ ë„ê³  í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">&gt; kind-cni.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  labels:
    mynode: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    controllerManager:
      extraArgs:
        bind-address: 0.0.0.0
    etcd:
      local:
        extraArgs:
          listen-metrics-urls: http://0.0.0.0:2381
    scheduler:
      extraArgs:
        bind-address: 0.0.0.0
  - |
    kind: KubeProxyConfiguration
    metricsBindAddress: 0.0.0.0
- role: worker
  labels:
    mynode: worker
- role: worker
  labels:
    mynode: worker2
networking:
  disableDefaultCNI: true
</span><span class="no">EOF
</span><span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-cni.yaml <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.30.4

<span class="c"># ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kind get clusters
<span class="nv">$ </span>kind get nodes <span class="nt">--name</span> myk8s
<span class="nv">$ </span>kubectl cluster-info

<span class="c"># ë„¤íŠ¸ì›Œí¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>

<span class="c"># ë…¸ë“œ í™•ì¸ : CRI</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> wide

<span class="c"># ë…¸ë“œ ë¼ë²¨ í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes myk8s-control-plane <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.metadata.labels<span class="o">}</span> | jq
...
<span class="s2">"mynode"</span>: <span class="s2">"control-plane"</span>,
...

<span class="nv">$ </span>kubectl get nodes myk8s-worker <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.metadata.labels<span class="o">}</span> | jq
<span class="nv">$ </span>kubectl get nodes myk8s-worker2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.metadata.labels<span class="o">}</span> | jq

<span class="c"># ì»¨í…Œì´ë„ˆ í™•ì¸ : ì»¨í…Œì´ë„ˆ ê°¯ìˆ˜, ì»¨í…Œì´ë„ˆ ì´ë¦„ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="nv">$ </span>docker port myk8s-control-plane
<span class="nv">$ </span>docker port myk8s-worker
<span class="nv">$ </span>docker port myk8s-worker2

<span class="c"># ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2  ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr

<span class="c">#</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping htop git nano -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping -y'</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_12.png" alt="img.png" /></p>

<ul>
  <li>ë‹¤ìŒ ëª…ë ¹ì„ í†µí•´ bridge ì‹¤í–‰íŒŒì¼ì„ ìƒì„±í•´ì„œ ê° ì¸ìŠ¤í„´ìŠ¤ë§ˆë‹¤ ë°°í¬í•´ì•¼í•©ë‹ˆë‹¤. ë¨¼ì € ë‹¤ìŒê³¼ ê°™ì´ bridge íŒŒì¼ì„ ìƒí— í›„ ë¡œì»¬ì— ë³µì‚¬í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nt">---------------------------------------</span>
<span class="c"># ë¹Œë“œí™˜ê²½ êµ¬ì„±</span>
<span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt <span class="nb">install </span>golang git <span class="nt">-y</span>
<span class="nv">$ </span>git clone https://github.com/containernetworking/plugins
<span class="nv">$ </span><span class="nb">cd </span>plugins
<span class="nv">$ </span><span class="nb">chmod</span> +x build_linux.sh

<span class="c"># ë¹Œë“œ</span>
<span class="nv">$ </span>./build_linux.sh

<span class="c"># íŒŒì¼ ê¶Œí•œ í™•ì¸ 755</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> bin
<span class="c"># =&gt; -rwxr-xr-x 1 root root  4471145 Sep  7 16:53 bridge</span>
<span class="c">#    ...</span>

<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">---------------------------------------</span>

<span class="c"># ìì‹ ì˜ PCì— ë³µì‚¬ : -a ê¶Œí•œ ë³´ì¡´í•˜ì—¬ ë³µì‚¬(755)</span>
<span class="nv">$ </span>docker <span class="nb">cp</span> <span class="nt">-a</span> myk8s-control-plane:/plugins/bin/bridge <span class="nb">.</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> bridge
<span class="c"># =&gt; .rwxr-xr-x root staff 4.3 MB Sun Sep  0 00:00:00 2024 bridge</span>
</code></pre></div></div>

<ul>
  <li>ì´ì œ Flannelì„ ì„¤ì¹˜í•˜ê² ìŠµë‹ˆë‹¤. í˜„ì¬ ê¸°ë³¸ CNI ì¸ kindnet ì—†ì´ ì„¤ì¹˜í–ˆê¸° ë•Œë¬¸ì— nodeê°€ not ready ìƒíƒœì—¬ì„œ ìŠ¤ì¼€ì¥´ë§ì´ ì•ˆ ë˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns | <span class="nb">grep </span>Events: <span class="nt">-A</span> 6
<span class="c"># =&gt; Events:</span>
<span class="c">#      Type     Reason            Age                  From               Message</span>
<span class="c">#      ----     ------            ----                 ----               -------</span>
<span class="c">#      Warning  FailedScheduling  19m                  default-scheduler  0/1 nodes are available: 1 node(s) had untolerated taint {node.kubernetes.io/not-ready: }. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling.</span>

<span class="c"># ê¸°ë³¸ CNI ì¸ kindnet ì—†ì´ ì„¤ì¹˜í–ˆê¸° ë•Œë¬¸ì— nodeê°€ not ready ìƒíƒœì—¬ì„œ ìŠ¤ì¼€ì¥´ë§ì´ ì•ˆ ë˜ê³  ìˆìŠµë‹ˆë‹¤.</span>

<span class="c"># Flannel cni ì„¤ì¹˜</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
<span class="c"># =&gt; namespace/kube-flannel created</span>
<span class="c">#    clusterrole.rbac.authorization.k8s.io/flannel created</span>
<span class="c">#    clusterrolebinding.rbac.authorization.k8s.io/flannel created</span>
<span class="c">#    serviceaccount/flannel created</span>
<span class="c">#    configmap/kube-flannel-cfg created</span>
<span class="c">#    daemonset.apps/kube-flannel-ds created</span>

<span class="c"># namespace ì— pod-security.kubernetes.io/enforce=privileged Label í™•ì¸ </span>
<span class="nv">$ </span>kubectl get ns <span class="nt">--show-labels</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    kube-flannel         Active   60s   k8s-app=flannel,kubernetes.io/metadata.name=kube-flannel,pod-security.kubernetes.io/enforce=privileged</span>
<span class="nv">$ </span>kubectl get ds,pod,cm <span class="nt">-n</span> kube-flannel <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE    CONTAINERS     IMAGES                              SELECTOR</span>
<span class="c">#    daemonset.apps/kube-flannel-ds   3         3         3       3            3           &amp;lt;none&amp;gt;          100s   kube-flannel   docker.io/flannel/flannel:v0.25.6   app=flannel</span>
<span class="c">#    </span>
<span class="c">#    NAME                        READY   STATUS    RESTARTS   AGE    IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/kube-flannel-ds-2l9p6   1/1     Running   0          100s   172.20.0.2   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/kube-flannel-ds-67ftf   1/1     Running   0          100s   172.20.0.3   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/kube-flannel-ds-87wv8   1/1     Running   0          100s   172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                         DATA   AGE</span>
<span class="c">#    configmap/kube-flannel-cfg   2      100s</span>
<span class="c">#    configmap/kube-root-ca.crt   1      100s</span>

<span class="c"># kube-flannel-dsê°€ daemonsetìœ¼ë¡œ ë…¸ë“œë§ˆë‹¤ ì‹¤í–‰ì¤‘ì¸ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-flannel kube-flannel-cfg

<span class="nv">$ </span>kubectl describe ds <span class="nt">-n</span> kube-flannel kube-flannel-ds

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> ds/kube-flannel-ds <span class="nt">-n</span> kube-flannel <span class="nt">-c</span> kube-flannel <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /etc/kube-flannel


<span class="c"># failed to find plugin "bridge" in path [/opt/cni/bin]</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns
<span class="c"># =&gt; Warning  FailedCreatePodSandBox  2m16s                   kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox "b0023dea7d730b58cfea0163318641ff1d000d368f8ad3b552c53040b371388c": plugin type="flannel" failed (add): failed to delegate add: failed to find plugin "bridge" in path [/opt/cni/bin]</span>
<span class="c">#    Warning  FailedCreatePodSandBox  2m15s                   kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox "0454cbf9ae3c434f163865f6cd261ef2fa298a2de107471600195ebffa0b44cc": plugin type="flannel" failed (add): failed to delegate add: failed to find plugin "bridge" in path [/opt/cni/bin]</span>
</code></pre></div></div>

<ul>
  <li>í˜„ì¬ /opt/cni/bin/bridge íŒŒì¼ì´ ì—†ì–´ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ bridge íŒŒì¼ì„ ë³µì‚¬í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># bridge íŒŒì¼ ë³µì‚¬</span>
<span class="nv">$ </span>docker <span class="nb">cp </span>bridge myk8s-control-plane:/opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">cp </span>bridge myk8s-worker:/opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">cp </span>bridge myk8s-worker2:/opt/cni/bin/bridge

<span class="c"># ê¶Œí•œ ë¶€ì—¬</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  <span class="nb">chmod </span>755 /opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker         <span class="nb">chmod </span>755 /opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2        <span class="nb">chmod </span>755 /opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  <span class="nb">chown </span>root:root /opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker         <span class="nb">chown </span>root:root /opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2        <span class="nb">chown </span>root:root /opt/cni/bin/bridge

<span class="c"># bridge íŒŒì¼ì´ ì˜ ë³µì‚¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  <span class="nb">ls</span> <span class="nt">-l</span> /opt/cni/bin/
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  <span class="nb">ls</span> <span class="nt">-l</span> /opt/cni/bin/
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 <span class="nb">ls</span> <span class="nt">-l</span> /opt/cni/bin/
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>myk8s-control-plane myk8s-worker myk8s-worker2<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$i</span> <span class="nb">ls</span> /opt/cni/bin/<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done
</span>bridge	flannel  host-local  loopback  portmap	ptp

<span class="c">#</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE     IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    ...</span>
<span class="c">#    kube-system          coredns-7db6d8ff4d-hjmjf                      1/1     Running   0          29m     10.244.1.4   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          coredns-7db6d8ff4d-lfmzj                      1/1     Running   0          29m     10.244.1.3   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h3 id="flannel-ì„¤ì¹˜-í™•ì¸">Flannel ì„¤ì¹˜ í™•ì¸</h3>

<ul>
  <li>Flannel ì„¤ì¹˜ í›„ corednsê°€ ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ Flannelì´ ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get ds,pod,cm <span class="nt">-n</span> kube-flannel <span class="nt">-owide</span>
<span class="c"># =&gt; &lt;span style="font-weight:bold;"&gt;NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE   CONTAINERS     IMAGES                              SELECTOR&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;daemonset.apps/kube-flannel-ds&lt;/span&gt;   &lt;span style="color:teal;"&gt;3&lt;/span&gt;         &lt;span style="color:gray;"&gt;3&lt;/span&gt;         &lt;span style="color:teal;"&gt;3&lt;/span&gt;       &lt;span style="color:gray;"&gt;3&lt;/span&gt;            &lt;span style="color:teal;"&gt;3&lt;/span&gt;           &lt;span style="color:gray;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;          &lt;span style="color:teal;"&gt;13m&lt;/span&gt;   &lt;span style="color:gray;"&gt;kube-flannel&lt;/span&gt;   &lt;span style="color:teal;"&gt;docker.io/flannel/flannel:v0.25.6&lt;/span&gt;   &lt;span style="color:gray;"&gt;app=flannel&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &lt;span style="font-weight:bold;"&gt;NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE                  NOMINATED NODE   READINESS GATES&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;pod/kube-flannel-ds-2l9p6&lt;/span&gt;   &lt;span style="color:teal;"&gt;1/1&lt;/span&gt;     &lt;span style="color:green;"&gt;Running&lt;/span&gt;   &lt;span style="color:teal;"&gt;0&lt;/span&gt;          &lt;span style="color:gray;"&gt;13m&lt;/span&gt;   &lt;span style="color:teal;"&gt;172.20.0.2&lt;/span&gt;   &lt;span style="color:gray;"&gt;myk8s-worker2&lt;/span&gt;         &lt;span style="color:teal;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;           &lt;span style="color:gray;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;pod/kube-flannel-ds-67ftf&lt;/span&gt;   &lt;span style="color:teal;"&gt;1/1&lt;/span&gt;     &lt;span style="color:green;"&gt;Running&lt;/span&gt;   &lt;span style="color:teal;"&gt;0&lt;/span&gt;          &lt;span style="color:gray;"&gt;13m&lt;/span&gt;   &lt;span style="color:teal;"&gt;172.20.0.3&lt;/span&gt;   &lt;span style="color:gray;"&gt;myk8s-worker&lt;/span&gt;          &lt;span style="color:teal;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;           &lt;span style="color:gray;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;pod/kube-flannel-ds-87wv8&lt;/span&gt;   &lt;span style="color:teal;"&gt;1/1&lt;/span&gt;     &lt;span style="color:green;"&gt;Running&lt;/span&gt;   &lt;span style="color:teal;"&gt;0&lt;/span&gt;          &lt;span style="color:gray;"&gt;13m&lt;/span&gt;   &lt;span style="color:teal;"&gt;172.20.0.4&lt;/span&gt;   &lt;span style="color:gray;"&gt;myk8s-control-plane&lt;/span&gt;   &lt;span style="color:teal;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;           &lt;span style="color:gray;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &lt;span style="font-weight:bold;"&gt;NAME                         DATA   AGE&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;configmap/kube-flannel-cfg&lt;/span&gt;   &lt;span style="color:teal;"&gt;2&lt;/span&gt;      &lt;span style="color:gray;"&gt;13m&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;configmap/kube-root-ca.crt&lt;/span&gt;   &lt;span style="color:teal;"&gt;1&lt;/span&gt;      &lt;span style="color:gray;"&gt;13m&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-flannel kube-flannel-cfg

<span class="c"># iptables ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># flannel ì •ë³´ í™•ì¸ : ëŒ€ì—­, MTU</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>myk8s-control-plane myk8s-worker myk8s-worker2<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$i</span> <span class="nb">cat</span> /run/flannel/subnet.env <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
<span class="c">#    FLANNEL_NETWORK=10.244.0.0/16</span>
<span class="c">#    FLANNEL_SUBNET=10.244.0.1/24</span>
<span class="c">#    FLANNEL_MTU=1450</span>
<span class="c">#    FLANNEL_IPMASQ=true</span>
<span class="c">#    ...</span>

<span class="c"># ë…¸ë“œë§ˆë‹¤ í• ë‹¹ëœ dedicated subnet (podCIDR) í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].spec.podCIDR}'</span> <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; 10.244.0.0/24 10.244.2.0/24 10.244.1.0/24</span>

<span class="c"># ë…¸ë“œ ì •ë³´ ì¤‘ flannel ê´€ë ¨ ì •ë³´ í™•ì¸ : VXLAN ëª¨ë“œ ì •ë³´ì™€, VTEP ì •ë³´(ë…¸ë“œ IP, VtepMac) ë¥¼ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe node | <span class="nb">grep</span> <span class="nt">-A3</span> Annotations
<span class="c"># =&gt; Annotations:        flannel.alpha.coreos.com/backend-data: {&amp;quot;VNI&amp;quot;:1,&amp;quot;VtepMAC&amp;quot;:&amp;quot;6e:0e:72:1e:72:1d&amp;quot;}</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-type: vxlan</span>
<span class="c">#                        flannel.alpha.coreos.com/kube-subnet-manager: true</span>
<span class="c">#                        flannel.alpha.coreos.com/public-ip: 172.20.0.4</span>
<span class="c">#    --</span>
<span class="c">#    Annotations:        flannel.alpha.coreos.com/backend-data: {&amp;quot;VNI&amp;quot;:1,&amp;quot;VtepMAC&amp;quot;:&amp;quot;ca:de:a3:b8:65:d8&amp;quot;}</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-type: vxlan</span>
<span class="c">#                        flannel.alpha.coreos.com/kube-subnet-manager: true</span>
<span class="c">#                        flannel.alpha.coreos.com/public-ip: 172.20.0.3</span>
<span class="c">#    --</span>
<span class="c">#    Annotations:        flannel.alpha.coreos.com/backend-data: {&amp;quot;VNI&amp;quot;:1,&amp;quot;VtepMAC&amp;quot;:&amp;quot;1e:1e:b1:15:9e:d3&amp;quot;}</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-type: vxlan</span>
<span class="c">#                        flannel.alpha.coreos.com/kube-subnet-manager: true</span>
<span class="c">#                        flannel.alpha.coreos.com/public-ip: 172.20.0.2</span>

<span class="c"># ê° ë…¸ë“œ(?) ë§ˆë‹¤ bash ì§„ì… í›„ ì•„ë˜ ê¸°ë³¸ ì •ë³´ í™•ì¸ : ë¨¼ì € worker ë¶€í„° bash ì§„ì… í›„ í™•ì¸í•˜ì</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker        bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2       bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nt">----------------------------------------</span>
<span class="c"># í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ NSì™€ flannel, kube-proxy ì»¨í…Œì´ë„ˆì˜ ë„¤íŠ¸ì›Œí¬ NS ë¹„êµ =&gt; ëª¨ë‘ ë™ì¼í•œ NSë¥¼ ê°€ì§‘ë‹ˆë‹¤. </span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> 1
<span class="c"># =&gt;         NS TYPE   NPROCS PID USER COMMAND</span>
<span class="c">#    ...</span>
<span class="c">#    4026532344 net        12   1 root /sbin/init</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="si">$(</span>pgrep flanneld<span class="si">)</span>
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    ...</span>
<span class="c">#    4026532344 net        12     1 root  /sbin/init</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="si">$(</span>pgrep kube-proxy<span class="si">)</span>
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    ...</span>
<span class="c">#    4026532344 net        12     1 root  /sbin/init</span>

<span class="c"># ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-br</span> addr
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8 ::1/128</span>
<span class="c">#    flannel.1        UNKNOWN        10.244.2.0/32</span>
<span class="c">#    eth0@if37        UP             172.20.0.3/16 fc00:f853:ccd:e793::3/64 fe80::42:acff:fe14:3/64</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'flannel|cni|veth'</span> <span class="nt">-A1</span>
<span class="c"># =&gt; 4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default</span>
<span class="c">#       link/ether ca:de:a3:b8:65:d8 brd ff:ff:ff:ff:ff:ff</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-d</span> addr show cni0     <span class="c"># ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²©ë¦¬ íŒŒë“œê°€ 1ê°œ ì´ìƒ ë°°ì¹˜ ì‹œ í™•ì¸ë¨</span>
<span class="c"># =&gt; (ê³µë°±)</span>

<span class="c"># í˜„ì¬ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ê²©ë¦¬ëœ íŒŒë“œê°€ ì—†ì–´ì„œ cni0 ì¸í„°í˜ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</span>

<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-d</span> addr show flannel.1
<span class="c"># =&gt; 4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether ca:de:a3:b8:65:d8 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 65535</span>
<span class="c">#        vxlan id 1 local 172.20.0.3 dev eth0 srcport 0 0 dstport 8472 nolearning ttl auto ageing 300 udpcsum noudp6zerocsumtx noudp6zerocsumrx numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535</span>
<span class="c">#        inet 10.244.2.0/32 scope global flannel.1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
    
<span class="nv">$ </span>brctl show
<span class="c"># =&gt; (ê³µë°±)</span>

<span class="c"># ë¼ìš°íŒ… ì •ë³´ í™•ì¸ : ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œ ëŒ€ì—­(podCIDR)ì˜ ë¼ìš°íŒ… ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì–´ ìˆìŒì„ í™•ì¸		</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.244.0.0/24 via 10.244.0.0 dev flannel.1 onlink</span>
<span class="c">#    10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.3</span>

<span class="c"># flannel.1 ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•œ ARP í…Œì´ë¸” ì •ë³´ í™•ì¸ : ë‹¤ë¥¸ ë…¸ë“œì˜ flannel.1 IPì™€ MAC ì •ë³´ë¥¼ í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> neigh show dev flannel.1
<span class="c"># =&gt; 10.244.1.0 lladdr 1e:1e:b1:15:9e:d3 PERMANENT</span>
<span class="c">#    10.244.0.0 lladdr 6e:0e:72:1e:72:1d PERMANENT</span>

<span class="c"># ë¸Œë¦¬ì§€ fdb ì •ë³´ì—ì„œ í•´ë‹¹ MAC ì£¼ì†Œì™€ í†µì‹  ì‹œ ê° ë…¸ë“œì˜ enp0s8 </span>
<span class="nv">$ </span>bridge fdb show dev flannel.1
<span class="c"># =&gt; 6e:0e:72:1e:72:1d dst 172.20.0.4 self permanent</span>
<span class="c">#    1e:1e:b1:15:9e:d3 dst 172.20.0.2 self permanent</span>

<span class="c"># ë‹¤ë¥¸ ë…¸ë“œì˜ flannel.1 ì¸í„°í˜ì´ìŠ¤ë¡œ ping í†µì‹  : VXLAN ì˜¤ë²„ë ˆì´ë¥¼ í†µí•´ì„œ í†µì‹ </span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 10.244.0.0
<span class="c"># =&gt; ...</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 10.244.1.0
<span class="c"># =&gt; ...</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 10.244.2.0
<span class="c"># =&gt; ...</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>

<span class="c"># ë‹¤ë¥¸ ë…¸ë“œì™€ VXLANì„ í†µí•´ì„œ ì˜ í†µì‹  ë©ë‹ˆë‹¤.</span>

<span class="c"># iptables í•„í„° í…Œì´ë¸” ì •ë³´ í™•ì¸ : íŒŒë“œì˜ 10.244.0.0/16 ëŒ€ì—­ ë¼ë¦¬ëŠ” ëª¨ë“  ë…¸ë“œì—ì„œ ì „ë‹¬ì´ ê°€ëŠ¥</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span> | <span class="nb">grep </span>10.244.0.0
<span class="c"># =&gt; -A FLANNEL-FWD -s 10.244.0.0/16 -m comment --comment "flanneld forward" -j ACCEPT</span>
<span class="c">#    -A FLANNEL-FWD -d 10.244.0.0/16 -m comment --comment "flanneld forward" -j ACCEPT</span>

<span class="c"># iptables NAT í…Œì´ë¸” ì •ë³´ í™•ì¸ : 10.244.0.0/16 ëŒ€ì—­ ë¼ë¦¬ í†µì‹ ì€ ë§ˆìŠ¤ì»¤ë ˆì´ë”© ì—†ì´ í†µì‹ ì„ í•˜ë©°,</span>
<span class="c"># 10.244.0.0/16 ëŒ€ì—­ì—ì„œ ë™ì¼ ëŒ€ì—­(10.244.0.0/16)ê³¼ ë©€í‹°ìºìŠ¤íŠ¸ ëŒ€ì—­(224.0.0.0/4) ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ (ì™¸ë¶€) í†µì‹  ì‹œì—ëŠ” ë§ˆìŠ¤ì»¤ë ˆì´ë”©ì„ ìˆ˜í–‰</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'flanneld masq'</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'! -s'</span>
<span class="c"># =&gt; -A POSTROUTING -m comment --comment "flanneld masq" -j FLANNEL-POSTRTG</span>
<span class="c">#    -A FLANNEL-POSTRTG -m mark --mark 0x4000/0x4000 -m comment --comment "flanneld masq" -j RETURN</span>
<span class="c">#    -A FLANNEL-POSTRTG -s 10.244.2.0/24 -d 10.244.0.0/16 -m comment --comment "flanneld masq" -j RETURN</span>
<span class="c">#    -A FLANNEL-POSTRTG -s 10.244.0.0/16 -d 10.244.2.0/24 -m comment --comment "flanneld masq" -j RETURN</span>
<span class="c">#    -A FLANNEL-POSTRTG -s 10.244.0.0/16 ! -d 224.0.0.0/4 -m comment --comment "flanneld masq" -j MASQUERADE --random-fully</span>

<span class="nt">----------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>íŒŒë“œ 2ê°œë¥¼ ìƒì„±í•´ì„œ CNI ë„¤íŠ¸ì›Œí¬ ë¸Œë¦¬ì§€ì˜ ì •ë³´ë¥¼  í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [í„°ë¯¸ë„1,2] ì›Œì»¤ ë…¸ë“œ1,2 - ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
<span class="nt">-----------------------------</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"ip link | egrep 'cni|veth' ;echo; brctl show cni0"</span>
<span class="nt">-----------------------------</span>

<span class="c"># [í„°ë¯¸ë„3] cat &amp; here document ëª…ë ¹ ì¡°í•©ìœ¼ë¡œ ì¦‰ì„(?) ë¦¬ì†ŒìŠ¤ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: pod-1
  labels:
    app: pod
spec:
  nodeSelector:
    kubernetes.io/hostname: myk8s-worker
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-2
  labels:
    app: pod
spec:
  nodeSelector:
    kubernetes.io/hostname: myk8s-worker2
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF

</span><span class="c"># íŒŒë“œ í™•ì¸ : IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_13.png" alt="img.png" /></p>

<ul>
  <li>CNI ê°€ ì—†ì—ˆëŠ”ë° íŒŒë“œ íŒ¨í¬í›„ CNI ë„¤íŠ¸ì›Œí¬ ë¸Œë¦¬ì§€ê°€ ìƒì„±ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì •ë³´ë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
<span class="nt">-----------------------------</span>
<span class="c"># ë¸Œë¦¬ì§€ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>brctl show cni0

<span class="c"># ë¸Œë¦¬ì§€ ì—°ê²° ë§í¬(veth) í™•ì¸</span>
<span class="nv">$ </span>bridge <span class="nb">link</span>

<span class="c"># ë¸Œë¦¬ì§€ VLAN ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>bridge vlan

<span class="c"># cbr(custom bridge) ì •ë³´ : kubenet CNIì˜ bridge - ë§í¬</span>
<span class="nv">$ </span>tree /var/lib/cni/networks/cbr0

<span class="c"># ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ ì •ë³´ë“¤ í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr | <span class="nb">grep </span>veth <span class="nt">-A3</span>
<span class="nt">-----------------------------</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_14.png" alt="img.png" /></p>

<h3 id="í†µì‹ -íë¦„-ì´í•´">í†µì‹  íë¦„ ì´í•´</h3>

<ul>
  <li>Flannel ê¸°ë°˜ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ë¥¼ êµ¬ì¶•í•  ë•ŒëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì„¸ê°€ì§€ì˜ í†µì‹  ì‹œë‚˜ë¦¬ì˜¤ê°€ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ol>
      <li>ë™ì¼ ë…¸ë“œì—ì„œ íŒŒë“œê°„ í†µì‹ í•˜ëŠ” ê²½ìš°
  <img src="/assets/2024/kans-3th/w2/20240907_kans_w2_15.png" alt="img.png" class="image-center" /></li>
      <li>íŒŒë“œì—ì„œ ì™¸ë¶€ì™€ í†µì‹ í•˜ëŠ” ê²½ìš°
  <img src="/assets/2024/kans-3th/w2/20240907_kans_w2_16.png" alt="img_1.png" class="image-center" /></li>
      <li>ì„œë¡œë‹¤ë¥¸ ë…¸ë“œì—ì„œ íŒŒë“œê°„ í†µì‹ í•˜ëŠ” ê²½ìš°
  <img src="/assets/2024/kans-3th/w2/20240907_kans_w2_17.png" alt="img_2.png" class="image-center" /></li>
    </ol>
  </li>
</ul>

<p>íŒŒë“œ ê°„ í†µì‹ , ì„œë¡œë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œê°„ í†µì‹ , ì™¸ë¶€ í†µì‹  ì—¬ë¶€ì— ëŒ€í•´ ì‚´í´ë³´ê³ , í†µì‹ ì´ ì¼ì–´ë‚˜ëŠ” ìƒí™©ì˜ íŒ¨í‚·ì„ ìº¡ì²˜í•˜ë©´ì„œ Flannel networkì— ëŒ€í•´ ì´í•´í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> pod-1 <span class="nt">--</span> zsh
<span class="nt">-----------------------------</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr show eth0

<span class="c"># GW IPëŠ” ì–´ë–¤ ì¸í„°í˜ì´ìŠ¤ì¸ê°€? =&gt; cni0</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="nv">$ </span>route <span class="nt">-n</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 &lt;GW IP&gt;
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 &lt;pod-2 IP&gt;  <span class="c"># ë‹¤ë¥¸ ë…¸ë“œì— ë°°í¬ëœ íŒŒë“œ í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 8.8.8.8     <span class="c"># ì™¸ë¶€ ì¸í„°ë„· IP   ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> wttr.in/Seoul <span class="c"># ì™¸ë¶€ ì¸í„°ë„· ë„ë©”ì¸ ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> neigh
<span class="nv">$ </span><span class="nb">exit</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_18.png" alt="img.png" /></p>

<ul>
  <li>ì„œë¡œë‹¤ë¥¸ ë…¸ë“œê°„ íŒŒë“œì˜ í†µì‹ , ì™¸ë¶€ì™€ì˜ í†µì‹  ë“±ì´ ëª¨ë‘ ì˜ í†µì‹  ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ë²ˆì—ëŠ” ê° ë…¸ë“œì˜ cni0ì—ì„œ íŒ¨í‚· ìº¡ì³ë¥¼ ì§„í–‰í•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [í„°ë¯¸ë„1,2] ì›Œì»¤ ë…¸ë“œ1,2</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
<span class="nt">-----------------------------</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> cni0 <span class="nt">-nn</span> icmp
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> flannel.1 <span class="nt">-nn</span> icmp
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> icmp
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> udp port 8472 <span class="nt">-w</span> /root/vxlan.pcap 
<span class="c"># CTRL+C ì·¨ì†Œ í›„ í™•ì¸ : ls -l /root/vxlan.pcap</span>

<span class="nv">$ </span>conntrack <span class="nt">-L</span> | <span class="nb">grep</span> <span class="nt">-i</span> icmp
<span class="nt">-----------------------------</span>

<span class="c"># [í„°ë¯¸ë„3]</span>
<span class="nv">$ </span>docker <span class="nb">cp </span>myk8s-worker:/root/vxlan.pcap <span class="nb">.</span>
<span class="nv">$ </span>wireshark vxlan.pcap
</code></pre></div></div>

<ul>
  <li>Pod-1 =&gt; Pod-2 (cni0 ê´€ì )
    <ul>
      <li>ë¸Œë¦¿ì§€ë¥¼ í†µí•´ ê°ê° ì˜¤ê°€ëŠ” íŒ¨í‚·ì´ ì˜ ë³´ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_19.png" alt="img.png" /></p>

<ul>
  <li>Pod-1 =&gt; ì™¸ë¶€ (cni0 ê´€ì )
    <ul>
      <li>ê°™ì€ ë…¸ë“œì—ì„œëŠ” íŒ¨í‚·ì´ ì™¸ë¶€ë¡œ ë‚˜ê°”ë‹¤ ì˜¤ëŠ”ê²ƒì´ ì˜ ë³´ì…ë‹ˆë‹¤.</li>
      <li>í•˜ì§€ë§Œ ë‹¤ë¥¸ ë…¸ë“œ (worker2)ì—ì„œëŠ” ì™¸ë¶€ì™€ ì˜¤ê°€ëŠ” íŒ¨í‚·ì´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_20.png" alt="img.png" /></p>

<ul>
  <li>Pod-1 =&gt; Pod-2 (flannel.1 ê´€ì )
    <ul>
      <li>flannel.1ì„ í†µí•´ ê°ê° ì˜¤ê°€ëŠ” íŒ¨í‚·ì´ ì˜ ë³´ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_21.png" alt="img.png" /></p>

<ul>
  <li>Pod-1 -&gt; ì™¸ë¶€ (flannel.1 ê´€ì )
    <ul>
      <li>ì•ì„  ê·¸ë¦¼ì—ì„œ ë³´ì•˜ë“¯ ì™¸ë¶€ì™€ í†µì‹ ì‹œ VTEPì¸ flannel.1ì„ ê±°ì¹˜ì§€ ì•Šê³  cni0ì—ì„œ í˜¸ìŠ¤íŠ¸ì˜ eth0ë¡œ ë°”ë¡œ ë‚˜ê°€ê¸° ë•Œë¬¸ì— íŒ¨í‚·ì´ ìº¡ì³ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_22.png" alt="img.png" /></p>

<ul>
  <li>Pod 1 -&gt; Pod 2 (eth0 ê´€ì )
    <ul>
      <li>eth0ì—ì„œ ë´¤ì„ë•ŒëŠ” ìº¡ì³ê°€ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ìœ ëŠ” flannel.1ì„ í†µí•´ tcp íŒ¨í‚·ì´ ìº¡ìŠí™” ë˜ì–´ udp 8472ë¡œ eth0ë¥¼ í†µí•´ ì „ë‹¬ë˜ê¸° ë•Œë¬¸ì—
<code class="language-plaintext highlighter-rouge">-nn icmp</code> ì˜µì…˜ìœ¼ë¡œ icmp íŒ¨í‚· (ping)ë§Œ ìº¡ì³í• ë•ŒëŠ” ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_23.png" alt="img.png" /></p>

<ul>
  <li>Pod 1 -&gt; Pod 2 (eth0 ê´€ì , udp port 8472 ë¤í”„)
    <ul>
      <li>udp íŒ¨í‚·ì„ ìº¡ì³í•˜ì—¬ wiresharkë¡œ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_25.png" alt="img.png" /></p>

<ul>
  <li>udp 8472 í¬íŠ¸ë¥¼ í†µí•´ icmp (ping)ì´ ì˜¤ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (8472ëŠ” VXLAN í¬íŠ¸ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ì˜µì…˜ì—ì„œ VXLANì„ ì§€ì •í•´ì•¼ ë³´ì…ë‹ˆë‹¤.)</li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_26.png" alt="img_1.png" /></p>

<ul>
  <li>Pod 1 -&gt; 8.8.8.8(ì™¸ë¶€) (eth0 ê´€ì )
    <ul>
      <li>eth0ì—ì„œ ì™¸ë¶€ì™€ í†µì‹ í•˜ëŠ” íŒ¨í‚·ì´ ê°™ì€ ë…¸ë“œì—ì„œëŠ” ë³´ì´ê³ , ë‹¤ë¥¸ ë…¸ë“œì—ì„œëŠ” ì•ˆ ë³´ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_24.png" alt="img.png" /></p>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆì£¼ì—ë„ ë§ì€ ë‚´ìš©ë“¤ì„ ìŠ¤í„°ë””í•´ë³´ì•˜ìŠµë‹ˆë‹¤. 
KINDë¥¼ ì•Œê²Œë˜ì–´ì„œ ì°¸ ì¢‹ì•˜ë˜ê²ƒ ê°™ìŠµë‹ˆë‹¤. 
ê¸°ì¡´ì— ì‚¬ë‚´ êµìœ¡ì„ ìœ„í•´ì„œ kubernetesë¥¼ ì„¤ì¹˜í•˜ë ¤ë©´ ê°–ì€ ì–´ë ¤ì›€ì´ ìˆì—ˆëŠ”ë°
dockerë§Œ ìˆìœ¼ë©´ ê°„ë‹¨í•˜ê²Œ ì„¤ì¹˜ê°€ ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì´ ì°¸ ì¢‹ì€ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<p>ë§‰ì—°í•˜ê²Œ ì•Œê³  ìˆì—ˆë˜ ë…¸ë“œê°„ì˜ íŒŒë“œì˜ í†µì‹ ì— ëŒ€í•´ì„œ ì•Œê²Œë˜ì—ˆê³ ,
ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ìš´ì˜ì¤‘ ë„¤íŠ¸ì›Œí¬ ì¥ì• ì— ëŒ€í•´ 1ì£¼ì°¨ ìŠ¤í„°ë””ì™€ ì´ë²ˆ ìŠ¤í„°ë””ë¥¼ í†µí•´
ìì‹ ê°ì´ ì¡°ê¸ˆ ìƒê²¼ìŠµë‹ˆë‹¤.
ë‚¨ì€ ìŠ¤í„°ë””ë„ ì—´ì‹¬íˆí•´ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ë„¤íŠ¸ì›Œí¬ì— ëŒ€í•´ ì¡°ê¸ˆ ì•„ëŠ” ì‚¬ëŒì´ ë˜ì–´ë³´ê² ìŠµë‹ˆë‹¤.</p>]]></content><author><name></name></author><category term="kans" /><category term="kubernetes," /><category term="network," /><category term="linux" /><summary type="html"><![CDATA[ì§€ë‚œì£¼ì— ì´ì–´ ì´ë²ˆì£¼ì—ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì—ëŒ€í•´ ê°„ëµí•˜ê²Œ ì•Œì•„ë³´ê³  KIND, PAUSE ì»¨í…Œì´ë„ˆì™€ Flannel CNIì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[KANS 3ê¸°] ì»¨í…Œì´ë„ˆ ê²©ë¦¬</title><link href="https://sweetlittlebird.github.io/posts/2024-08-27-KANS-Study-Week1/" rel="alternate" type="text/html" title="[KANS 3ê¸°] ì»¨í…Œì´ë„ˆ ê²©ë¦¬" /><published>2024-08-27T22:50:18+09:00</published><updated>2024-08-27T22:50:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/KANS%20Study%20-%20Week1</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2024-08-27-KANS-Study-Week1/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì§€ë‚œ í…Œë¼í¼ ìŠ¤í„°ë””ì— ì´ì–´ ì´ë²ˆ ì£¼ ë¶€í„° KANS ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤!
KANSëŠ” <strong>K</strong>ubernetes <strong>A</strong>dvanced <strong>N</strong>etworking <strong>S</strong>tudyì˜ ì¤„ì„ë§ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ì— ëŒ€í•œ ì‹¬ë„ìˆê²Œ ê³µë¶€í•˜ëŠ” ìŠ¤í„°ë””ì…ë‹ˆë‹¤.
ì´ë²ˆ ìŠ¤í„°ë””ë„ ê³¼ì œí•  ê±±ì •ë„ :sweat: ë˜ì§€ë§Œ ì¬ë¯¸ìˆì„ê²ƒ ê°™ì•„ ê¸°ëŒ€ë©ë‹ˆë‹¤. :smile:</p>

<p>ì²« ì£¼ ìŠ¤í„°ë””ë„ ì»¨í…Œì´ë„ˆ ê²©ë¦¬ì™€ ë¦¬ëˆ…ìŠ¤ ë„¤íŠ¸ì›Œí¬ì— ëŒ€í•´ ë§ì€ê²ƒì„ ë°°ì› ê³  ì´ ìë¦¬ì— ì •ë¦¬í•´ë³´ë ¤ê³  í•©ë‹ˆë‹¤. 
ì´ë²ˆ ìŠ¤í„°ë””ë„ ë‹¤ë“¤ ì™„ì£¼í•˜ê¸°ë¥¼ ê¸°ë„í•˜ë©° ìŠ¤í„°ë”” ì •ë¦¬ë¥¼ ì‹œì‘í•´ ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h2 id="ë„ì»¤-ì†Œê°œ">ë„ì»¤ ì†Œê°œ</h2>

<h3 id="ë„ì»¤ë€-ë¬´ì—‡ì¸ê°€">ë„ì»¤ë€ ë¬´ì—‡ì¸ê°€?</h3>

<ul>
  <li>
    <p>ë„ì»¤(Docker)ëŠ” ì»¨í…Œì´ë„ˆ(Container)ë¼ê³  ë¶ˆë¦¬ëŠ” ê°€ìƒì‹¤í–‰ í™˜ê²½ì„ ì œê³µí•˜ê³ , 
ê·¸ ê°€ìƒí™˜ê²½ì—ì„œ ìœ ìš©í•œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”Œë«í¼ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì»¨í…Œì´ë„ˆë¼ëŠ” ì´ë¦„ì˜ ê¸°ì›
ì»¨í…Œì´ë„ˆë¼ëŠ” ì´ë¦„ì€ ë°°ì— í™”ë¬¼ì„ ì‹¤ì„ë•Œ ì‚¬ìš©í•˜ëŠ” ê·¸ ì»¨í…Œì´ë„ˆì—ì„œ ì™”ìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w1/20240831_kans_w1_1.png" alt="ì»¨í…Œì´ë„ˆì„ " />
ê³¼ê±°ì— ì»¨í…Œì´ë„ˆê°€ ë°œëª…ë˜ê¸° ì´ì „ì—ëŠ” ì§ì˜ ë¶€í”¼ì™€ ëª¨ì–‘ì´ ì œê°ê°ì´ë¼ì„œ, í™”ë¬¼ì„ ì ì¬í•˜ê¸°ë„ ì–´ë µê³  
íŒŒë„ê°€ ì³ì„œ ë°°ê°€ í”ë“¤ë¦´ë•Œ ì§ì´ ì´ë¦¬ ì €ë¦¬ ì›€ì§ì—¬ì„œ íŒŒì†ë˜ëŠ” ê²½ìš°ê°€ ë§ì•˜ìŠµë‹ˆë‹¤.</p>

    <p>ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Malcom McLeanì´ë¼ëŠ” ë¶„ì´ ë°œëª…í•œê²ƒì´ ì§ìœ¡ë©´ì²´ì˜ ë°”ë¡œ ì»¨í…Œì´ë„ˆì…ë‹ˆë‹¤.<br />
<img src="/assets/2024/kans-3th/w1/20240831_kans_w1_2.png" alt="Shipping Container" />
ì§ìœ¡ë©´ì²´ì´ê¸° ë•Œë¬¸ì— ì ì¬ê°€ ì‰½ê³ , íŒŒë„ê°€ ì¹˜ë”ë¼ë„ ì•ˆì •ì ìœ¼ë¡œ í™”ë¬¼ì„ ìš´ë°˜í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. 
ë˜í•œ í¬ê³  ì‘ì€ ë¬¼ê±´ë„ ì»¨í…Œì´ë„ˆ ì•ˆì— ë„£ì–´ì„œ ìš´ë°˜í•  ìˆ˜ ìˆì–´ì„œ í™”ë¬¼ì˜ ì¢…ë¥˜ì— ìƒê´€ì—†ì´ íš¨ìœ¨ì ìœ¼ë¡œ ìš´ë°˜í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

    <p>ì´ ê°œë…ì„ ì»´í“¨íŒ…ì— ë„ì…í•œê²ƒì´ ì»¨í…Œì´ë„ˆì…ë‹ˆë‹¤. 
ê¸°ì¡´ì—ëŠ” ê° ë¦¬ëˆ…ìŠ¤ ë²„ì „ë§ˆë‹¤, glibcëƒ muslì´ëƒ, debian ê¸°ë°˜ì´ëƒ redhat ê¸°ë°˜ì´ëƒ ë“±ë“± 
í”„ë¡œê·¸ë¨ì„ ë°°í¬í• ë•Œ í™˜ê²½ì„ ë§ì¶°ì•¼ í•˜ëŠ”ê²ƒì´ ë§ì•˜ìŠµë‹ˆë‹¤. ê·¸ ë¿ë§Œì•„ë‹ˆë¼ ê°ì¢… ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ë„ ì„¤ì¹˜í•´ì•¼ í•˜ê³ 
ì‹¬ì§€ì–´ í”„ë¡œê·¸ë¨ ë§ˆë‹¤ í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ì´ ë‹¤ë¥¼ë•Œë„ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

    <p>ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸°ìœ„í•´ ë„ì»¤ë¼ëŠ” ì»¨í…Œì´ë„ˆë¥¼ ì´ìš©í•œ ê°€ìƒí™” ê¸°ìˆ ì´ ë“±ì¥í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
ë„ì»¤ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì—ëŠ” í”„ë¡œê·¸ë¨ ì‹¤í–‰ì— í•„ìš”í•œ ëª¨ë“ ê²ƒì´ í¬í•¨ë˜ì–´ ìˆê¸° ë•Œë¬¸ì—
ë§ˆì¹˜ ì»¨í…Œì´ë„ˆì— í™”ë¬¼ì„ ì‹£ë“¯ì´ í”„ë¡œê·¸ë¨ì„ ë°°í¬í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. 
ë„ì»¤ì˜ ë¡œê³ ê°€ ì»¨í…Œì´ë„ˆë¥¼ ì‹£ê³  ìˆëŠ” ë°°ë¥¼ í˜•ìƒí™”í•œê²ƒë„ ì´ëŸ¬í•œ ì˜ë¯¸ì—ì„œ ë‚˜ì˜¨ê²ƒì…ë‹ˆë‹¤.</p>

    <p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_3.png" alt="Docker Logo" class="image-center" /></p>
  </li>
  <li>
    <p>ì»¨í…Œì´ë„ˆ ì´ì™¸ì—ë„ ê°€ìƒ ë¨¸ì‹ (Virtual Machine)ì´ë¼ëŠ” ê¸°ìˆ ì´ ìˆìŠµë‹ˆë‹¤. 
ê°€ìƒ ë¨¸ì‹ ì€ í•˜ì´í¼ë°”ì´ì €(Hypervisor)ë¥¼ ì´ìš©í•˜ì—¬ í˜¸ìŠ¤íŠ¸ OS ìœ„ì— ê²ŒìŠ¤íŠ¸ OSë¥¼ ì˜¬ë¦¬ëŠ” ë°©ì‹ìœ¼ë¡œ ê°€ìƒí™”ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
ê°€ìƒ ë¨¸ì‹ ì€ ê²ŒìŠ¤íŠ¸ OSë¥¼ ì˜¬ë¦¬ê¸° ë•Œë¬¸ì— ë¬´ê²ìŠµë‹ˆë‹¤. 
ë°˜ë©´ ì»¨í…Œì´ë„ˆëŠ” í˜¸ìŠ¤íŠ¸ OSì˜ ì»¤ë„ì„ ê³µìœ í•˜ê¸° ë•Œë¬¸ì— ê°€ë³ìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w1/20240831_kans_w1_4.png" alt="img.png" /></p>
  </li>
</ul>

<h3 id="ì»¨í…Œì´ë„ˆì™€-ê°€ìƒ-ë¨¸ì‹ ">ì»¨í…Œì´ë„ˆì™€ ê°€ìƒ ë¨¸ì‹ </h3>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_5.png" alt="ê°€ìƒë¨¸ì‹ ê³¼ ì»¨í…Œì´ë„ˆ ë¹„êµ" /></p>

<ul>
  <li>ê°€ìƒë¨¸ì‹ ì€ í˜¸ìŠ¤íŠ¸ OS ìœ„ì— í•˜ì´í¼ë°”ì´ì €ë¥¼ ë‘ê³  í•˜ë“œì›¨ì–´ ì¼ë¶€(ë˜ëŠ” ì „ë¶€)ë¥¼ ê°€ìƒí™”í•˜ê³ , ê·¸ ìœ„ì— ê²ŒìŠ¤íŠ¸ OSë¥¼ ì˜¬ë¦½ë‹ˆë‹¤. ì¦‰, <strong>í•˜ë“œì›¨ì–´ ë ˆë²¨ì˜ ê°€ìƒí™”</strong>ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
  <li>ì»¨í…Œì´ë„ˆëŠ” í•˜ë“œì›¨ì–´ ê°€ìƒí™”ì™€ ê²ŒìŠ¤íŠ¸ OS ì—†ì´, í˜¸ìŠ¤íŠ¸ì˜ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì„ ê³µìœ í•˜ì—¬ ë°”ë¡œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ë‹¨, ê°ì¢… ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ì‚¬ìš©ì í™˜ê²½(User Land)ëŠ” ì»¨í…Œì´ë„ˆ ë‹¨ìœ„ë¡œ íŒ¨í‚¤ì§•ë˜ì–´ <strong>OS ë ˆë²¨ì˜ ê°€ìƒí™”</strong>ë¥¼ ì§€ì›í•œë‹¤ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë”°ë¼ì„œ ì»¨í…Œì´ë„ˆëŠ” ê°€ìƒë¨¸ì‹ ë³´ë‹¤ ê°€ë³ê³  ë¹ ë¥´ë©°, ë‚®ì€ ê²©ë¦¬(Weak Isolation) ìˆ˜ì¤€ì„ ê°€ì§‘ë‹ˆë‹¤.</li>
  <li>ê°€ìƒë¨¸ì‹ ì€ ê²ŒìŠ¤íŠ¸ OSë¥¼ ì˜¬ë¦¬ê¸° ë•Œë¬¸ì— ë¬´ê²ê³  ëŠë¦¬ì§€ë§Œ, ë†’ì€ ê²©ë¦¬(Strong Isolation) ìˆ˜ì¤€ì„ ê°€ì§‘ë‹ˆë‹¤.
    <ul>
      <li>ë‚®ì€ ê²©ë¦¬ ìˆ˜ì¤€ì„ ë³´ì™„í•˜ê¸° ìœ„í•´ ë¦¬ëˆ…ìŠ¤ì˜ pivot-root, namespace, cgroup ë“±ì˜ ê¸°ëŠ¥ë“¤ì„ í™œìš©í•¨ìœ¼ë¡œì¨ í”„ë¡œì„¸ìŠ¤ ë‹¨ìœ„ì˜ ê²©ë¦¬ í™˜ê²½ê³¼ ë¦¬ì†ŒìŠ¤ ì œì–´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w1/20240831_kans_w1_6.png" alt="img.png" class="image-center" /></li>
    </ul>
  </li>
</ul>

<h3 id="ë„ì»¤-ì•„í‚¤í…ì³">ë„ì»¤ ì•„í‚¤í…ì³</h3>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_7.png" alt="ë„ì»¤ ì•„í‚¤í…ì³" />
<a href="https://docs.docker.com/get-started/overview/#docker-architecture">https://docs.docker.com/get-started/overview/#docker-architecture</a></p>

<hr />

<h2 id="ë„ì»¤-ê¸°ë³¸-ì‚¬ìš©">ë„ì»¤ ê¸°ë³¸ ì‚¬ìš©</h2>

<h3 id="ë„ì»¤-ì„¤ì¹˜-ë°-í™•ì¸">ë„ì»¤ ì„¤ì¹˜ ë° í™•ì¸</h3>

<ul>
  <li>ë„ì»¤ ì„¤ì¹˜
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°©ë²•1. debian ê³„ì—´ ë¦¬ëˆ…ìŠ¤ì—ì„œ íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €ë¡œ ì„¤ì¹˜</span>
<span class="nv">$ </span><span class="nb">sudo </span>apt-get update
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> docker.io
  
<span class="c"># ë°©ë²•2. ê³µì‹ ì‚¬ì´íŠ¸ì—ì„œ ì„¤ì¹˜</span>
<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-i</span>
<span class="nv">$ </span>curl <span class="nt">-fsSL</span> https://get.docker.com | sh
</code></pre></div>    </div>
  </li>
  <li>ê¸°ë³¸ì •ë³´ í™•ì¸
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë„ì»¤ ì •ë³´ í™•ì¸ : Client ì™€ Server , Storage Driver(overlay2), Cgroup Version(2), Default Runtime(runc)</span>
<span class="nv">$ </span><span class="nb">sudo </span>docker info
<span class="c">#    Client:</span>
<span class="c">#     Context:    default</span>
<span class="c">#     Debug Mode: false</span>
<span class="c">#    </span>
<span class="c">#    Server:</span>
<span class="c">#     Containers: 0</span>
<span class="c">#     ...</span>
<span class="c">#     Server Version: 20.10.25+dfsg1</span>
<span class="c">#     Storage Driver: overlay2</span>
<span class="c">#     ...</span>
<span class="c">#     Cgroup Driver: systemd</span>
<span class="c">#     Cgroup Version: 2</span>
<span class="c">#     ...</span>
<span class="c">#     containerd version: 1.6.24~ds1-2</span>
<span class="c">#     runc version: 1.1.12+ds1-5</span>
<span class="c">#     ...</span>
  
<span class="nv">$ </span><span class="nb">sudo </span>docker version
<span class="c"># =&gt; Client:</span>
<span class="c">#     Version:           20.10.25+dfsg1</span>
<span class="c">#     API version:       1.41</span>
<span class="c">#     Go version:        go1.22.3</span>
<span class="c">#     Git commit:        b82b9f3</span>
<span class="c">#     Built:             Tue May  7 10:33:18 2024</span>
<span class="c">#     OS/Arch:           linux/amd64</span>
<span class="c">#     Context:           default</span>
<span class="c">#     Experimental:      true</span>
<span class="c">#    </span>
<span class="c">#    Server:</span>
<span class="c">#     Engine:</span>
<span class="c">#      Version:          20.10.25+dfsg1</span>
<span class="c">#      API version:      1.41 (minimum version 1.12)</span>
<span class="c">#      Go version:       go1.22.3</span>
<span class="c">#      Git commit:       5df983c</span>
<span class="c">#      Built:            Tue May  7 10:33:18 2024</span>
<span class="c">#      OS/Arch:          linux/amd64</span>
<span class="c">#      Experimental:     false</span>
<span class="c">#    ...  </span>
  
<span class="c"># ë„ì»¤ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">sudo </span>systemctl status docker <span class="nt">-l</span> <span class="nt">--no-pager</span>
  
<span class="c"># ëª¨ë“  ì„œë¹„ìŠ¤ì˜ ìƒíƒœ í‘œì‹œ</span>
<span class="nv">$ </span>systemctl list-units <span class="nt">--type</span><span class="o">=</span>service
  
<span class="c"># ë„ì»¤ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ í™•ì¸ : Docker Root Dir(/var/lib/docker)</span>
<span class="nv">$ </span><span class="nb">sudo </span>tree <span class="nt">-L</span> 3 /var/lib/docker
<span class="c"># =&gt; /var/lib/docker</span>
<span class="c">#    |-- buildkit</span>
<span class="c">#    |   ...</span>
<span class="c">#    |-- containers</span>
<span class="c">#    |-- image</span>
<span class="c">#    |   `-- overlay2</span>
<span class="c">#    |       |-- distribution</span>
<span class="c">#    |       |-- imagedb</span>
<span class="c">#    |       |-- layerdb</span>
<span class="c">#    |       `-- repositories.json</span>
<span class="c">#    |-- network</span>
<span class="c">#    |   `-- files</span>
<span class="c">#    |       `-- local-kv.db</span>
<span class="c">#    |-- overlay2</span>
<span class="c">#    |   ...</span>
<span class="c">#    `-- volumes</span>
<span class="c">#        |-- backingFsBlockDev</span>
<span class="c">#        `-- metadata.db</span>
<span class="c">#    </span>
<span class="c">#    24 directories, 8 files</span>
</code></pre></div>    </div>
  </li>
  <li>ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í”„ë¡œì„¸ìŠ¤ í™•ì¸ - ì…¸ë³€ìˆ˜</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span>      <span class="c"># í”„ë¡œì„¸ìŠ¤ ëª©ë¡ ë³´ê¸°</span>
<span class="nv">$ </span>pstree <span class="nt">-p</span>   <span class="c"># í”„ë¡œì„¸ìŠ¤ íŠ¸ë¦¬ë¡œ ë³´ê¸°</span>
  
<span class="nv">$ </span><span class="nb">df</span> <span class="nt">-hT</span>    <span class="c"># ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸</span>

<span class="c"># ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸. ë„ì»¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” docker0 ë„¤íŠ¸ì›Œí¬ê°€ ì¶”ê°€ë˜ì–´ìˆê³  í˜„ì¬ DOWN ìƒíƒœì…ë‹ˆë‹¤.</span>
<span class="c"># ì»¨í…Œì´ë„ˆê°€ ìˆìœ¼ë©´ UP ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤.  </span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> addr
<span class="c"># =&gt; &lt;span style="color:teal;"&gt;lo               &lt;/span&gt;UNKNOWN        &lt;span style="color:purple;"&gt;127.0.0.1&lt;/span&gt;/8 &lt;span style="color:blue;"&gt;::1&lt;/span&gt;/128 </span>
<span class="c">#    &lt;span style="color:teal;"&gt;eth0             &lt;/span&gt;&lt;span style="color:green;"&gt;UP             &lt;/span&gt;&lt;span style="color:purple;"&gt;10.10.10.109&lt;/span&gt;/24 &lt;span style="color:purple;"&gt;10.10.10.51&lt;/span&gt;/24 &lt;span style="color:blue;"&gt;fe80::a70d:8639:be6:671e&lt;/span&gt;/64</span>
<span class="c">#    &lt;span style="color:teal;"&gt;docker0          &lt;/span&gt;&lt;span style="color:red;"&gt;DOWN           &lt;/span&gt;&lt;span style="color:purple;"&gt;172.17.0.1&lt;/span&gt;/16 &lt;span style="color:blue;"&gt;fe80::42:57ff:fe56:997c&lt;/span&gt;/64</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nb">link</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
  
<span class="c"># ì´ë”ë„· ë¸Œë¦¿ì§€ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>brctl show
<span class="c"># =&gt; bridge name	bridge id		STP enabled	interfaces</span>
<span class="c">#    docker0		8000.02425756997c	no</span>
  
<span class="c"># iptables ì •ì±… í™•ì¸</span>
<span class="c"># FORWARD ì •ì±…ì´ DROPìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆê³ , </span>
<span class="c"># docker0ì—ì„œ docker0 í˜¹ì€ ì™¸ë¶€ë¡œ ì „ë‹¬ë˜ëŠ” íŒ¨í‚·ì€ í—ˆìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="c"># =&gt; -P INPUT ACCEPT</span>
<span class="c">#    &lt;span style="color: red;"&gt;-P FORWARD DROP&lt;/span&gt;</span>
<span class="c">#    -P OUTPUT ACCEPT</span>
<span class="c">#    -N DOCKER</span>
<span class="c">#    -N DOCKER-ISOLATION-STAGE-1</span>
<span class="c">#    -N DOCKER-ISOLATION-STAGE-2</span>
<span class="c">#    -N DOCKER-USER</span>
<span class="c">#    -A FORWARD -j DOCKER-USER</span>
<span class="c">#    -A FORWARD -j DOCKER-ISOLATION-STAGE-1</span>
<span class="c">#    -A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span>
<span class="c">#    -A FORWARD -o docker0 -j DOCKER</span>
<span class="c">#    &lt;span style="color: red;"&gt;-A FORWARD -i docker0 ! -o docker0 -j ACCEPT&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: red;"&gt;-A FORWARD -i docker0 -o docker0 -j ACCEPT&lt;/span&gt;</span>
<span class="c">#    -A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2</span>
<span class="c">#    -A DOCKER-ISOLATION-STAGE-1 -j RETURN</span>
<span class="c">#    -A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP</span>
<span class="c">#    -A DOCKER-ISOLATION-STAGE-2 -j RETURN</span>
<span class="c">#    -A DOCKER-USER -j RETURN</span>

<span class="c"># NAT POSTROUTINGì— 172.17.0.0/16ì—ì„œ ì™¸ë¶€ë¡œ ì „ë‹¬ì‹œ MASQUERADE (SNAT) ì •ì±…ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="c"># =&gt; -P PREROUTING ACCEPT</span>
<span class="c">#    -P INPUT ACCEPT</span>
<span class="c">#    -P OUTPUT ACCEPT</span>
<span class="c">#    -P POSTROUTING ACCEPT</span>
<span class="c">#    -N DOCKER</span>
<span class="c">#    -A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER</span>
<span class="c">#    -A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER</span>
<span class="c">#    &lt;span style="color: red;"&gt;-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE&lt;/span&gt;</span>
<span class="c">#    -A DOCKER -i docker0 -j RETURN</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="ë„ì»¤ë¥¼-ë¹„-root-ìœ ì €ë¡œ-ê´€ë¦¬í•˜ê¸°">ë„ì»¤ë¥¼ ë¹„ root ìœ ì €ë¡œ ê´€ë¦¬í•˜ê¸°</h3>

<p>ë„ì»¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ rootë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
rootê°€ ì•„ë‹Œ ìœ ì €ë¡œ docker ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">whoami</span>
<span class="c"># =&gt; kali</span>

<span class="nv">$ </span>docker info
<span class="c"># =&gt; ...</span>
<span class="c">#    Server:</span>
<span class="c">#    ERROR: permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get &amp;quot;http://%2Fvar%2Frun%2Fdocker.sock/v1.24/info&amp;quot;: dial unix /var/run/docker.sock: connect: permission denied</span>
</code></pre></div></div>

<p>í•˜ì§€ë§Œ, ë‹¤ìŒì˜ ë°©ë²• ì²˜ëŸ¼ í˜„ì¬ ì‚¬ìš©ìë¥¼ docker ê·¸ë£¹ì— ì¶”ê°€í•˜ë©´, rootê°€ ì•„ë‹Œ ì¼ë°˜ ìœ ì €ë¡œë„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">whoami</span> 
<span class="c"># =&gt; kali</span>

<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$USER</span>
<span class="c"># =&gt; kali</span>

<span class="c"># ë„ì»¤ ê·¸ë£¹ ì¶”ê°€</span>
<span class="nv">$ </span><span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$USER</span>

<span class="c"># ê·¸ë£¹ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">groups</span> 
<span class="c"># =&gt; adm ... kaboxer</span>

<span class="c"># ë¡œê·¸ì•„ì›ƒ</span>
<span class="nb">exit</span> 

<span class="c"># ssh ì¬ì ‘ì† í›„ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">groups</span> 
<span class="c"># =&gt; adm ... kaboxer docker</span>

<span class="nv">$ </span>docker info
<span class="c"># =&gt; Client:</span>
<span class="c">#     Context:    default</span>
<span class="c">#     Debug Mode: false</span>
<span class="c">#    </span>
<span class="c">#    Server:</span>
<span class="c">#     Containers: 0</span>
<span class="c">#     ...</span>
<span class="c">#     Cgroup Version: 2</span>
<span class="c">#     ...</span>
<span class="c">#     Default Runtime: runc</span>
<span class="c">#     Init Binary: docker-init</span>
<span class="c">#     containerd version: 1.6.24~ds1-2</span>
<span class="c">#     runc version: 1.1.12+ds1-5</span>
<span class="c">#     ...    </span>

<span class="c"># ì»¨í…Œì´ë„ˆ í™•ì¸</span>
<span class="nv">$ </span>docker run <span class="nt">--rm</span> hello-world
<span class="c"># =&gt; Hello from Docker!</span>
<span class="c">#    This message shows that your installation appears to be working correctly.</span>
<span class="c">#    ...</span>

<span class="c"># ì‹¤í–‰ì¤‘ì¸ ë„ì»¤ ì»¨í…Œì´ë„ˆ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># ì „ì²´ ë„ì»¤ ì»¨í…Œì´ë„ˆ í™•ì¸</span>
<span class="nv">$ </span>docker ps <span class="nt">-a</span>
<span class="c"># ì´ë¯¸ì§€ ëª©ë¡ í™•ì¸</span>
<span class="nv">$ </span>docker images
<span class="c"># =&gt; REPOSITORY    TAG       IMAGE ID       CREATED         SIZE</span>
<span class="c">#    hello-world   latest    d2c94e258dcb   16 months ago   13.3kB</span>

<span class="c"># ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‚­ì œ</span>
<span class="nv">$ </span>docker ps <span class="nt">-aq</span>
<span class="nv">$ </span>docker <span class="nb">rm</span> <span class="nt">-f</span> <span class="si">$(</span>docker ps <span class="nt">-aq</span><span class="si">)</span>
<span class="nv">$ </span>docker ps <span class="nt">-a</span>
</code></pre></div></div>

<h3 id="ì»¨í…Œì´ë„ˆê°€-hostì˜-docker-socket-file-ê³µìœ ë¡œ-ë„ì»¤-ì‹¤í–‰">ì»¨í…Œì´ë„ˆê°€ hostì˜ docker socket file ê³µìœ ë¡œ ë„ì»¤ ì‹¤í–‰</h3>

<ul>
  <li>
    <p>ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ GUIë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” íˆ´ì¸ <a href="https://www.portainer.io/">portainer</a>ì²˜ëŸ¼ ë„ì»¤ ì»¨í…Œì´ë„ˆê°€ í˜¸ìŠ¤íŠ¸ì˜ ë„ì»¤ ì†Œì¼“ íŒŒì¼ì„ ê³µìœ í•˜ì—¬ ë„ì»¤ë¥¼ ê´€ë¦¬í•˜ëŠ”ë° ì‚¬ìš© í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 9000:9000 <span class="nt">-v</span> /var/run/docker.sock:/var/run/docker.sock portainer/portainer-ce
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                    COMMAND        CREATED         STATUS         PORTS                                                           NAMES</span>
<span class="c">#    1495728fd014   portainer/portainer-ce   &amp;quot;/portainer&amp;quot;   2 minutes ago   Up 2 minutes   8000/tcp, 9443/tcp, 0.0.0.0:9000-&amp;gt;9000/tcp, :::9000-&amp;gt;9000/tcp   wizardly_ride</span>
  
</code></pre></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">-v</code> ì˜µì…˜ìœ¼ë¡œ í˜¸ìŠ¤íŠ¸ì˜ ë„ì»¤ ì†Œì¼“ íŒŒì¼ì„ ì»¨í…Œì´ë„ˆì˜ ë„ì»¤ ì†Œì¼“ íŒŒì¼ë¡œ ê³µìœ í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ë„ì»¤ ì»¨í…Œì´ë„ˆì—ì„œ í˜¸ìŠ¤íŠ¸ì˜ ë„ì»¤ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_8.png" alt="ì†Œì¼“ ê³µìœ ë¥¼ í†µí•´ portainer ì‚¬ìš©" /></p>
  </li>
  <li>
    <p>ë˜í•œ Jenkins ê°™ì€ CI/CD íˆ´ì„ ì‚¬ìš©í• ë•Œë„ ë„ì»¤ ì†Œì¼“ íŒŒì¼ì„ ê³µìœ í•˜ì—¬ ë„ì»¤ ê¸°ë°˜ ì›Œì»¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<h3 id="cpu-ì•„í‚¤í…ì³">CPU ì•„í‚¤í…ì³</h3>

<ul>
  <li>ë„ì»¤ í—ˆë¸Œì— ë“±ë¡ëœ ì´ë¯¸ì§€ë“¤ì€ CPU ì•„í‚¤í…ì³ë³„ë¡œ ì´ë¯¸ì§€ë¥¼ ì œê³µí•˜ëŠ”ë°, <strong>í˜¸ìŠ¤íŠ¸ì˜ CPU ì•„í‚¤í…ì³ì™€ ë‹¤ë¥¸ ì´ë¯¸ì§€ëŠ” ë™ì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong></li>
  <li>ì•„ë˜ì™€ ê°™ì´ docker hubì—ì„œëŠ” ì§€ì› CPU ì•„í‚¤í…ì³ë³„ë¡œ í•„í„°ë§í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ë‹ˆ, íŠ¹ì • ì•„í‚¤í…ì³ì˜ ì´ë¯¸ì§€ê°€ í•„ìš”í•œ ê²½ìš° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w1/20240831_kans_w1_9.png" alt="img.png" /></li>
  <li>ë˜í•œ ë„ì»¤ì´ë¯¸ì§€ í˜ì´ì§€ì˜ Tags íƒ­ì—ì„œ íƒœê·¸ì˜ ì§€ì›í•˜ëŠ” ì•„í‚¤í…ì³ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="../../../assets/2024/kans-3th/w1/20240831_kans_w1_10.png" alt="20240831_kans_w1_10.png" /></li>
  <li>í˜„ì¬ ë¦¬ëˆ…ìŠ¤ì˜ CPU ì•„í‚¤í…ì³ë¥¼ í™•ì¸ í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lscpu
<span class="c"># =&gt; Architecture:                       x86_64</span>
<span class="c">#    CPU op-mode(s):                     32-bit, 64-bit</span>
<span class="c">#    ...</span>
</code></pre></div>    </div>
    <p>ì‚¬ìš©ì¤‘ì¸ CPU ì•„í‚¤í…ì³ëŠ” x86_64 ì…ë‹ˆë‹¤.</p>
  </li>
  <li>í˜„ì¬ CPU ì•„í‚¤í…ì³ì™€ëŠ” ë‹¤ë¥¸ ì•„í‚¤í…ì³ì˜ ì´ë¯¸ì§€ë¥¼ ì„¤ì¹˜í•´ì„œ ì‹¤íŒ¨í•˜ëŠ”ê²ƒì„ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># arm64 ì‹¤í–‰ ì‹¤íŒ¨</span>
<span class="nv">$ </span>docker run <span class="nt">--rm</span> <span class="nt">-it</span> arm64v8/ubuntu bash
<span class="c"># =&gt; WARNING: The requested image's platform (linux/arm64/v8) does not match the detected host platform (linux/amd64) and no specific platform was requested</span>
<span class="c">#    exec /usr/bin/bash: exec format error</span>
  
<span class="c"># riscv64 ì‹¤í–‰ ì‹¤íŒ¨</span>
<span class="nv">$ </span>docker run <span class="nt">--rm</span> <span class="nt">-it</span> riscv64/ubuntu bash
<span class="c"># =&gt; WARNING: The requested image's platform (linux/riscv64) does not match the detected host platform (linux/amd64) and no specific platform was requested</span>
<span class="c">#    exec /usr/bin/bash: exec format error</span>
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="ì»¨í…Œì´ë„ˆ-ê²©ë¦¬">ì»¨í…Œì´ë„ˆ ê²©ë¦¬</h2>

<ul>
  <li>dockerëŠ” ë¦¬ëˆ…ìŠ¤ì˜ í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬ ê¸°ìˆ ì„ í™œìš©í•˜ëŠ”ë°, í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬ ê¸°ìˆ ì€ chrootì—ì„œ ë¶€í„° cgroup, namespace ë“±ì„ ê±°ì³ ë°œì „í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì£¼ìš” ê²©ë¦¬ ê¸°ìˆ ë“¤ì„ ì‹¤ìŠµí•´ë³´ë©° ì´í•´í•´ë³´ê² ìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w1/20240831_kans_w1_11.png" alt="img.png" />
<a href="https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=200">https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=200</a></li>
</ul>

<h3 id="chroot">chroot</h3>

<ul>
  <li>chrootëŠ” ë¦¬ëˆ…ìŠ¤ì˜ í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬ ê¸°ìˆ  ì¤‘ í•˜ë‚˜ë¡œ, í”„ë¡œì„¸ìŠ¤ê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” íŒŒì¼ ì‹œìŠ¤í…œì˜ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ ë³€ê²½í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.</li>
  <li>1979ë…„ì— ì²˜ìŒ ë“±ì¥í–ˆìœ¼ë©°, í•œê³„ê°€ ëšœë ·í•˜ì§€ë§Œ ë‹¤ì–‘í•œ ëª©ì ìœ¼ë¡œ í˜„ì¬ë„ í˜„ì—­ìœ¼ë¡œ ì‚¬ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ê´€ë¦¬ì ì „í™˜</span>
<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-i</span>
<span class="nv">$ </span><span class="nb">whoami</span>
<span class="c"># =&gt; root</span>

<span class="nv">$ </span><span class="nb">cd</span> /tmp
<span class="nv">$ </span><span class="nb">mkdir </span>myroot

<span class="c"># chroot ì‹¤í–‰ (chroot [ìƒˆ ë£¨íŠ¸] [ëª…ë ¹])</span>
<span class="nv">$ </span><span class="nb">chroot </span>myroot /bin/bash
<span class="c"># =&gt; chroot: failed to run command â€˜/bin/bashâ€™: No such file or directory</span>
</code></pre></div></div>

<ul>
  <li>/tmp/myroot ë¡œ chrootí•˜ë ¤ë‹ˆ bashê°€ ì—†ì–´ì„œ ì‹¤í–‰ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. bashë¥¼ ë³µì‚¬í•´ ë„£ì–´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># bashë¥¼ ì‹¤í–‰í•˜ëŠ”ë° í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™•ì¸í•˜ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>ldd /bin/bash
<span class="c"># =&gt; linux-vdso.so.1 (0x00007fffecfa8000)</span>
<span class="c">#    libtinfo.so.6 =&gt; /lib/x86_64-linux-gnu/libtinfo.so.6 (0x00007fbfe6a4f000)</span>
<span class="c">#    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fbfe686a000)</span>
<span class="c">#    /lib64/ld-linux-x86-64.so.2 (0x00007fbfe6be0000)</span>

<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> myroot/bin
<span class="nv">$ </span><span class="nb">cp</span> /bin/bash myroot/bin
<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> myroot/<span class="o">{</span>lib64,lib/x86_64-linux-gnu<span class="o">}</span>
<span class="nv">$ </span><span class="nb">cp</span> /lib/x86_64-linux-gnu/libtinfo.so.6 myroot/lib/x86_64-linux-gnu
<span class="nv">$ </span><span class="nb">cp</span> /lib/x86_64-linux-gnu/libc.so.6 myroot/lib/x86_64-linux-gnu
<span class="nv">$ </span><span class="nb">cp</span> /lib64/ld-linux-x86-64.so.2 myroot/lib64
<span class="nv">$ </span>tree myroot
<span class="c"># =&gt; myroot</span>
<span class="c">#    |-- bin</span>
<span class="c">#    |   `-- bash</span>
<span class="c">#    |-- lib</span>
<span class="c">#    |   `-- x86_64-linux-gnu</span>
<span class="c">#    |       |-- libc.so.6</span>
<span class="c">#    |       `-- libtinfo.so.6</span>
<span class="c">#    `-- lib64</span>
<span class="c">#        `-- ld-linux-x86-64.so.2</span>
<span class="c">#    </span>
<span class="c">#    5 directories, 4 files</span>

<span class="nv">$ </span><span class="nb">chroot </span>myroot /bin/bash
<span class="c"># =&gt; bash-5.2# </span>
<span class="c"># bashì™€ bashì— í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë„£ì–´ì£¼ë‹ˆ chrootë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
<span class="c"># lsë¥¼ ì‹¤í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">ls</span>
<span class="c"># =&gt; bash: ls: command not found</span>
<span class="c"># lsê°€ ì—†ì–´ì„œ ì‹¤í–‰ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. lsë¥¼ ë„£ê¸°ìœ„í•´ chrootì—ì„œ ë‚˜ì˜¤ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">exit</span>

<span class="c"># ls ìœ„ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>whereis <span class="nb">ls</span>
<span class="c"># =&gt; ls: /usr/bin/ls /usr/share/man/man1/ls.1.gz</span>
<span class="nv">$ </span>ldd /usr/bin/ls
<span class="c"># lddë¡œ í™•ì¸ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í¬í•¨í•´ lsë¥¼ myrootì— ë„£ì–´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">cp</span> /usr/bin/ls myroot/bin
<span class="nv">$ </span><span class="nb">cp</span> /lib/x86_64-linux-gnu/libselinux.so.1 myroot/lib/x86_64-linux-gnu
<span class="nv">$ </span><span class="nb">cp</span> /lib/x86_64-linux-gnu/libpcre2-8.so.0 myroot/lib/x86_64-linux-gnu

<span class="nv">$ </span><span class="nb">chroot </span>myroot /bin/bash
<span class="c"># lsì‹œ /tmp/myrootì— ìˆëŠ” íŒŒì¼ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">ls</span>
<span class="c"># =&gt; bin  lib  lib64</span>
<span class="c"># í˜„ì¬ ë””ë ‰í„°ë¦¬ í™•ì¸ì‹œ / ë¡œ ë˜ì–´ìˆìŠµë‹ˆë‹¤. ì´ ì²˜ëŸ¼ chrootë¡œ ì¸í•´ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. </span>
<span class="nv">$ </span><span class="nb">pwd</span>
<span class="c"># =&gt; /</span>
<span class="nv">$ </span><span class="nb">cd</span> ../../..
<span class="nv">$ </span><span class="nb">ls</span>
<span class="c"># =&gt; bin lib lib64</span>

<span class="c"># chrootë¥¼ ì¢…ë£Œ í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">exit</span>
</code></pre></div></div>

<ul>
  <li>ì´ ì‘ì—…ì„ ë°˜ë³µí•˜ë©´ ê±°ì˜ ëª¨ë“  í”„ë¡œê·¸ë¨ì„ chrootë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ /proc, /dev ë“±ì˜ ê°€ìƒ ë””ë ‰í„°ë¦¬ëŠ” ë‹¤ìŒì˜ ë°©ë²•ìœ¼ë¡œ ë„£ì–´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë‹¤ìŒ ë™ì‘ì€ chroot ë°–ì˜ í˜¸ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.</span>
<span class="c"># mount í•  ë””ë ‰í„°ë¦¬ ë§Œë“¤ì–´ì£¼ê¸°</span>
<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> myroot/<span class="o">{</span>proc,dev<span class="o">}</span>

<span class="c"># /proc, /dev ë§ˆìš´íŠ¸</span>
<span class="nv">$ </span>mount <span class="nt">-t</span> proc none myroot/proc
<span class="nv">$ </span>mount <span class="nt">-o</span> <span class="nb">bind</span> /dev myroot/dev

<span class="c"># /proc í™•ì¸ì„ ìœ„í•´ psë„ chroot í™˜ê²½ì— ë„£ì–´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">cp</span> /usr/bin/ps myroot/bin
<span class="nv">$ </span><span class="nb">cp</span> /lib/x86_64-linux-gnu/<span class="o">{</span>libproc2.so.0,libc.so.6,libsystemd.so.0,libcap.so.2,libgcrypt.so.20,liblz4.so.1,liblzma.so.5,libzstd.so.1,libgpg-error.so.0<span class="o">}</span> myroot/lib/x86_64-linux-gnu/ 
<span class="nv">$ </span><span class="nb">cp</span> /lib64/ld-linux-x86-64.so.2 myroot/lib64/ 

<span class="nv">$ </span><span class="nb">chroot </span>myroot /bin/bash
<span class="nv">$ </span><span class="nb">ls</span> /proc
<span class="nv">$ </span>ps
<span class="c"># =&gt;    PID TTY          TIME CMD</span>
<span class="c">#    729517 ?        00:00:00 sudo</span>
<span class="c">#    741301 ?        00:00:00 bash</span>
<span class="c">#    741310 ?        00:00:00 ps</span>

<span class="c"># chroot ì¢…ë£Œ</span>
<span class="nv">$ </span><span class="nb">exit</span>

<span class="c"># ë§ˆìš´íŠ¸ í•´ì œ</span>
<span class="nv">$ </span>mount <span class="nt">-t</span> proc
<span class="c"># =&gt; proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)</span>
<span class="c">#    none on /tmp/myroot/proc type proc (rw,relatime)</span>
<span class="nv">$ </span>umount myroot/proc
<span class="nv">$ </span>umount myroot/dev
<span class="nv">$ </span>mount <span class="nt">-t</span> proc
<span class="c"># =&gt; proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)</span>
</code></pre></div></div>

<ul>
  <li>ë„ì»¤ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ì¶”ì¶œí•˜ì—¬ chrootë¡œ ì‹¤í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir </span>nginx-root

<span class="c"># nginx ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì—ì„œ íŒŒì¼ë“¤ì„ ì¶”ì¶œí•˜ì—¬ nginx-rootì— ë„£ì–´ì¤ë‹ˆë‹¤.</span>
<span class="nv">$ </span>docker <span class="nb">export</span> <span class="si">$(</span>docker create nginx<span class="si">)</span> | <span class="nb">tar</span> <span class="nt">-C</span> nginx-root <span class="nt">-xvf</span> -
<span class="nv">$ </span>docker images

<span class="nv">$ </span>tree <span class="nt">-L</span> 2 nginx-root

<span class="c"># chrootë¡œ nginx-rootë¥¼ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">chroot </span>nginx-root /bin/bash
<span class="c"># nginxë¥¼ ì‹¤í–‰í•´ë´…ë‹ˆë‹¤.</span>
<span class="nv">$ </span>nginx <span class="nt">-g</span> <span class="s1">'daemon off;'</span>

<span class="c"># [í„°ë¯¸ë„2] í„°ë¯¸ë„ì„ í•˜ë‚˜ë” ì—´ê³  nginx ë™ì‘ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>ps <span class="nt">-f</span> <span class="nt">-C</span> nginx
<span class="nv">$ </span>curl localhost
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_12.png" alt="img.png" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒì„±ëœ docker ì»¨í…Œì´ë„ˆë¥¼ í™•ì¸í•©ë‹ˆë‹¤. docker create nginxë¡œ ì¸í•´ ì»¨í…Œì´ë„ˆê°€ ìƒê²¨ì ¸ìˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>docker ps <span class="nt">-a</span>
<span class="c"># =&gt; CONTAINER ID   IMAGE     COMMAND                  CREATED              STATUS    PORTS     NAMES</span>
<span class="c">#    0b506af00006   nginx     "/docker-entrypoint.â€¦"   About a minute ago   Created             gifted_rosalind</span>

<span class="c"># ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„ì»¤ì´ë¯¸ì§€ë¥¼ ì§€ì›Œì¤ë‹ˆë‹¤.</span>
<span class="nv">$ </span>docker <span class="nb">rm </span>0b5
</code></pre></div></div>

<ul>
  <li>ì•„ì‰½ê²Œë„ chrootëŠ” íƒˆì˜¥ì´ ê°€ëŠ¥í•˜ë‹¤ê³  í•©ë‹ˆë‹¤. ë‹¤ìŒ ì½”ë“œë¥¼ ì»´íŒŒì¼í•˜ì—¬ íƒˆì˜¥ì„ ì‹œë„í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">mkdir</span><span class="p">(</span><span class="s">".out"</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
  <span class="n">chroot</span><span class="p">(</span><span class="s">".out"</span><span class="p">);</span>
  <span class="n">chdir</span><span class="p">(</span><span class="s">"../../../../../"</span><span class="p">);</span>
  <span class="n">chroot</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">execl</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="s">"-i"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì»´íŒŒì¼</span>
<span class="nv">$ </span>gcc <span class="nt">-o</span> myroot/escape_chroot escape_chroot.c
<span class="nv">$ </span>file myroot/escape_chroot
<span class="c"># =&gt; myroot/escape_chroot: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=5a40e26463d1015f870c7f1b9db9be159727c250, for GNU/Linux 3.2.0, not stripped</span>

<span class="c"># chroot ì‹¤í–‰</span>
<span class="nv">$ </span><span class="nb">chroot </span>myroot /bin/bash
<span class="nv">$ </span><span class="nb">ls</span>
<span class="nv">$ </span><span class="nb">cd</span> ../../
<span class="nv">$ </span><span class="nb">cd</span> ../../
<span class="nv">$ </span><span class="nb">ls</span>
<span class="c"># ì¼ë°˜ì ì¸ ë°©ë²•ìœ¼ë¡œëŠ” myrootì—ì„œ ë²—ì–´ë‚  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.</span>

<span class="c"># escape_chroot ì‹¤í–‰í•´ì„œ íƒˆì˜¥í•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>./escape_chroot
<span class="nv">$ </span><span class="nb">ls</span> /
<span class="c"># íƒˆì˜¥ì´ ì˜ ë˜ì—ˆìŠµë‹ˆë‹¤.</span>

<span class="c"># ì¢…ë£Œ</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nv">$ </span><span class="nb">exit</span>
</code></pre></div></div>

<h3 id="ë§ˆìš´íŠ¸-ë„¤ì„ìŠ¤í˜ì´ìŠ¤--pivot_root">ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ + pivot_root</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pivot_root</code>ëŠ” ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì„ ë³€ê²½í•˜ëŠ” ì‹œìŠ¤í…œ ì½œë¡œ, ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ ë³€ê²½í•˜ëŠ” chrootì™€ ë‹¬ë¦¬ ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì„ ë³„ë„ì˜ ë””ë ‰í„°ë¦¬ë¡œ ì´ë™ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì•„ë˜ì˜ ê·¸ë¦¼ì—ì„œ ì²˜ëŸ¼ /tmp/new_rootê°€ ìˆê³  /tmp/new_root/put_old ë””ë ‰í„°ë¦¬ê°€ ìˆëŠ” ê²½ìš°, <code class="language-plaintext highlighter-rouge">pivot_root /tmp/new_root /tmp_new_root/put_old</code>ë¥¼ í•˜ë©´ 
/tmp/new_rootê°€ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¡œ ë³€ê²½ë˜ê³ , ì›ë˜ì˜ ë£¨íŠ¸ /ëŠ” /tmp/new_root/put_oldë¡œ ì´ë™ë©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_13.png" alt="img.png" />
<a href="https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=80">https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=80</a></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pivot_root</code>ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ <code class="language-plaintext highlighter-rouge">unshare</code> ëª…ë ¹ì„ í†µí•´ ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤. ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ, í”„ë¡œì„¸ìŠ¤ê°€ ë§ˆìš´íŠ¸ ì •ë³´ë¥¼ ë…ë¦½ì ìœ¼ë¡œ ê°€ì§ˆ ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.</li>
  <li>ë˜í•œ ë‹¤ìŒê³¼ ê°™ì€ ì œì•½ì‚¬í•­ì´ ì ìš© ë©ë‹ˆë‹¤.
    <ul>
      <li>new_rootì™€ put_oldê°€ ë””ë ‰í„°ë¦¬ì—¬ì•¼ í•œë‹¤.</li>
      <li>new_rootì™€ put_oldê°€ í˜„ì¬ ë£¨íŠ¸ì™€ ê°™ì€ ë§ˆìš´íŠ¸ ìƒì— ìˆì–´ì„  ì•ˆ ëœë‹¤.</li>
      <li>put_oldê°€ new_rootì™€ ê°™ê±°ë‚˜ ê·¸ ì•„ë˜ì— ìˆì–´ì•¼ í•œë‹¤. ì¦‰, put_oldê°€ ê°€ë¦¬í‚¤ëŠ” ê²½ë¡œëª… ì•ì— â€œ/..â€ë¥¼ 0ê°œ ì´ìƒ ë¶™ì—¬ì„œ new_rootì™€ ê°™ì€ ë””ë ‰í„°ë¦¬ê°€ ë‚˜ì™€ì•¼ í•œë‹¤.</li>
      <li>new_rootê°€ ë§ˆìš´íŠ¸ ì§€ì ì˜ ê²½ë¡œì—¬ì•¼ í•˜ë˜, â€œ/â€ì¼ ìˆ˜ ì—†ë‹¤. ë§ˆìš´íŠ¸ ì§€ì ì´ ì•„ë‹Œ ê²½ìš°ì—ëŠ” ê·¸ ê²½ë¡œë¥¼ ìŠ¤ìŠ¤ë¡œì—ê²Œ ë°”ì¸ë“œ ë§ˆìš´íŠ¸ í•´ì„œ ë§ˆìš´íŠ¸ ì§€ì ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆë‹¤.</li>
      <li>new_rootì˜ ë¶€ëª¨ ë§ˆìš´íŠ¸ ë° í˜„ì¬ ì‘ì—… ë””ë ‰í„°ë¦¬ì˜ ë¶€ëª¨ ë§ˆìš´íŠ¸ì˜ ì „íŒŒ ìœ í˜•ì´ MS_SHAREDì—¬ì„  ì•ˆ ëœë‹¤. ë§ˆì°¬ê°€ì§€ë¡œ put_oldê°€ ê¸°ì¡´ ë§ˆìš´íŠ¸ ì§€ì ì¸ ê²½ìš° ê·¸ ì „íŒŒ ìœ í˜•ì´ MS_SHAREDì—¬ì„  ì•ˆ ëœë‹¤. ì´ ì œì•½ì€ pivot_root()ë¡œ ì¸í•´ ë‹¤ë¥¸ ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì–´ë–¤ ë³€í™”ë„ ì „íŒŒë˜ì§€ ì•Šê²Œ í•œë‹¤.</li>
      <li>í˜„ì¬ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ê°€ ë§ˆìš´íŠ¸ ì§€ì ì´ì–´ì•¼ í•œë‹¤.</li>
    </ul>
  </li>
  <li>ì‹¤ìŠµì„ í†µí•´ ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ pivot_rootë¥¼ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="ì‹¤ìŠµ">ì‹¤ìŠµ</h4>

<ul>
  <li>ë¨¼ì € pivot_rootë¡œ root ë””ë ‰í„°ë¦¬ë¡œ ë§Œë“¤ /tmp/new_rootë¥¼ ë§Œë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ìœ„ì˜ ì œì•½ì‚¬í•­ ì¤‘ new_rootì™€ put_oldê°€ í˜„ì¬ ë£¨íŠ¸ì™€ ê°™ì€ ë§ˆìš´íŠ¸ ìƒì— ìˆì–´ì„œëŠ” ì•ˆ ë˜ê¸° ë•Œë¬¸ì— new_rootë¥¼ tmpfs ë¡œ ë§ˆìš´íŠ¸ í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir</span> /tmp/new_root
<span class="c"># ë§ˆìš´íŠ¸</span>
<span class="nv">$ </span>mount <span class="nt">-t</span> tmpfs tmpfs /tmp/new_root 
<span class="c"># ê¸°ì¡´ ë£¨íŠ¸ë¥¼ ì´ë™ì‹œí‚¬ /tmp/new_root/put_old ë””ë ‰í„°ë¦¬ë¥¼ ë§Œë“¤ê¸°</span>
<span class="nv">$ </span><span class="nb">mkdir</span> /tmp/new_root/put_old
<span class="c"># /bin, /lib, /lib64 ë“± chroot ì‹¤ìŠµë•Œ ì‚¬ìš©í–ˆë˜ /tmp/myrootë¥¼ /tmp/new_root ë¡œ ë³µì‚¬í•´ì„œ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">cp</span> <span class="nt">-rv</span> /tmp/myroot/<span class="k">*</span> /tmp/new_root 

<span class="nv">$ </span>mount <span class="nt">-t</span> proc proc /tmp/new_root/proc

<span class="c"># unshare í•´ì„œ ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.</span>
<span class="nv">$ </span>unshare <span class="nt">--mount</span> /bin/bash 

<span class="nv">$ </span><span class="nb">cd</span> /tmp/new_root

<span class="c"># pivot_rootë¥¼ ì‹¤í–‰</span>
<span class="nv">$ </span>pivot_root <span class="nb">.</span> put_old

<span class="c"># ìƒˆë¡œìš´ ë£¨íŠ¸ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.</span>

<span class="c"># ìƒˆ ë£¨íŠ¸ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">ls</span> / 
<span class="c"># =&gt; bin  dev  escape_chroot  lib  lib64  proc  put_old</span>

<span class="c"># ê¸°ì¡´ ë£¨íŠ¸ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">ls</span> /put_old
<span class="c"># =&gt; bin   dev  home        lib32  lost+found   mnt     proc  run   srv	  sys       usr  vmlinuz</span>
<span class="c">#    boot  etc  initrd.img  lib	   lib64        media   opt   root  sbin  swapfile  tmp  var  </span>
</code></pre></div></div>

<ul>
  <li>ìƒˆë¡œìš´ ë£¨íŠ¸ë¡œ ì´ë™ë˜ì—ˆì§€ë§Œ, ê¸°ì¡´ ë£¨íŠ¸ì— ìˆëŠ” íŒŒì¼ë“¤ì„ ì‚­ì œí•˜ê±°ë‚˜ ì´ë™í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— /put_oldë¡œ ê¸°ì¡´ ë£¨íŠ¸ì— ìˆëŠ” íŒŒì¼ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>í•˜ì§€ë§Œ umountë¥¼ ì‚¬ìš©í•˜ë©´ /put_oldì™€ ê¸°ì¡´ ë£¨íŠ¸ì˜ ì—°ê²°ì„ ëŠì–´ì„œ ê¸°ì¡´ ë£¨íŠ¸ë¥¼ ìˆ¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>umount <span class="nt">-l</span> /put_old

<span class="nv">$ </span><span class="nb">ls</span> /put_old
<span class="c"># =&gt; (ê³µë°±)</span>
</code></pre></div></div>

<ul>
  <li>escape_rootë¥¼ í†µí•´ íƒˆì˜¥ì„ ì‹œë„í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íƒˆì˜¥ ì‹œë„</span>
<span class="nv">$ </span>/escape_chroot
<span class="nv">$ </span><span class="nb">ls</span> /
<span class="c"># =&gt; bin  dev  escape_chroot  lib  lib64  proc  put_old</span>
<span class="nv">$ </span><span class="nb">cd</span> ../../..
<span class="nv">$ </span>/escape_chroot
<span class="nv">$ </span><span class="nb">ls</span> /
<span class="c"># =&gt; bin  dev  escape_chroot  lib  lib64  proc  put_old</span>
</code></pre></div></div>

<ul>
  <li>chrootì™€ ë‹¬ë¦¬ pivot_rootëŠ” íƒˆì˜¥ì´ ë¶ˆê°€ëŠ¥í•˜ê³  í›¨ì”¬ ì•ˆì „í•œê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_14.png" alt="img.png" /></p>

<h3 id="ë„¤ì„ìŠ¤í˜ì´ìŠ¤-namespace">ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (namespace)</h3>

<ul>
  <li>ì—¬ê¸°ì—ì„œì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ë“±ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ëŠ” ë‹¤ë¥¸,
ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ ì œê³µí•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬ ê¸°ìˆ ë¡œ, í”„ë¡œì„¸ìŠ¤ê°€ ê°ì¢… ìì›ì„ ê²©ë¦¬í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.</li>
  <li>ì£¼ìš” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ìœ í˜•ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.
    <ul>
      <li>Mount Namespace (2002ë…„ ë„ì…)
        <ul>
          <li>pivot_root ì˜ˆì œì—ì„œ ì²˜ëŸ¼ ë§ˆìš´íŠ¸ ì •ë³´ë¥¼ ê²©ë¦¬í•©ë‹ˆë‹¤.</li>
          <li>ì¦‰, ì„œë¡œ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ë…ë¦½ì ìœ¼ë¡œ íŒŒì¼ ì‹œìŠ¤í…œì„ ë§ˆìš´íŠ¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>UTS Namespace (2006ë…„ ë„ì…)
        <ul>
          <li>í˜¸ìŠ¤íŠ¸ ì´ë¦„ê³¼ NIS ë„ë©”ì¸ ì´ë¦„ì„ ê²©ë¦¬í•©ë‹ˆë‹¤. ê° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ìì²´ í˜¸ìŠ¤íŠ¸ ì´ë¦„ê³¼ NIS ë„ë©”ì¸ ì´ë¦„ì„ ê°€ì§ˆ ìˆ˜ ìˆê³ ,
ì´ë¥¼ í†µí•´ í˜¸ìŠ¤íŠ¸ ì´ë¦„ì„ ë³€ê²½í•˜ë”ë¼ë„ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>IPC Namespace (2006ë…„ ë„ì…)
        <ul>
          <li>POSIX ë©”ì‹œì§€ í, ì„¸ë§ˆí¬ì–´, ê³µìœ  ë©”ëª¨ë¦¬ ê°™ì€ IPC ë¦¬ì†ŒìŠ¤ë¥¼ ê²©ë¦¬í•©ë‹ˆë‹¤.</li>
          <li>ì´ë¥¼ í†µí•´ ì„œë¡œ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ë…ë¦½ì ìœ¼ë¡œ System V IPC ê°ì²´ì™€ POSIX ë©”ì‹œì§€ íë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>PID Namespace (2008ë…„ ë„ì…)
        <ul>
          <li>í”„ë¡œì„¸ìŠ¤ IDë¥¼ ê²©ë¦¬í•©ë‹ˆë‹¤. ê° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ìì²´ PIDë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìœ¼ë©° ìì²´ì ì¸ PID 1ì„ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>í”„ë¡œì„¸ìŠ¤ IDê°€ 1ì¸ê²ƒì€ ì‹œìŠ¤í…œ ì‹œì‘ì‹œì— ìµœì´ˆë¡œ ì‹¤í–‰ëœ ê²ƒì´ë©° ì´ë¥¼ init í”„ë¡œì„¸ìŠ¤ë¼ê³  í•©ë‹ˆë‹¤. ì´ í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ë©´ 
ì‹œìŠ¤í…œì´ ì¢…ë£Œë˜ê±°ë‚˜ ë‹¤ì‹œ ë¶€íŒ…ë©ë‹ˆë‹¤. ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ì‹œ ì‹¤í–‰ë˜ëŠ” í”„ë¡œê·¸ë¨ì´ PIDê°€ 1ì´ê³ , í•´ë‹¹ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë˜ë©° 
ì»¨í…Œì´ë„ˆë„ ì¢…ë£Œë˜ëŠ”ê²Œ ì´ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>Network Namespace (2009ë…„ ë„ì…)
        <ul>
          <li>ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤, IP ì£¼ì†Œ, ë¼ìš°íŒ… í…Œì´ë¸”, ë°©í™”ë²½ ê·œì¹™ ë“± ë„¤íŠ¸ì›Œí¬ ë¦¬ì†ŒìŠ¤ë¥¼ ê²©ë¦¬í•©ë‹ˆë‹¤.</li>
          <li>ê° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ìì²´ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤, IP ì£¼ì†Œ, ë¼ìš°íŒ… í…Œì´ë¸”, ë°©í™”ë²½ ê·œì¹™ì„ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>USER Namespace (2012ë…„ ë„ì…)
        <ul>
          <li>ì‚¬ìš©ì IDì™€ ê·¸ë£¹ IDë¥¼ ê²©ë¦¬í•©ë‹ˆë‹¤. ê° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ìì²´ ì‚¬ìš©ì IDì™€ ê·¸ë£¹ IDë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ì´ë¥¼ í†µí•´ root ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìë„ ì¼ë°˜ ì‚¬ìš©ìë¡œ ê²©ë¦¬í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆê³ , ì¼ë°˜ ì‚¬ìš©ìë„ root ì¸ê²ƒ ì²˜ëŸ¼ ë³´ì´ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ì‹¤í–‰ ì¤‘ì¸ ë„ì»¤ì»¨í…Œì´ë„ˆì—ì„œëŠ” psë¡œ í™•ì¸ì‹œ rootë¡œ ì‹¤í–‰ ì¤‘ì¸ë°, í˜¸ìŠ¤íŠ¸ì—ì„œ psë¡œ í™•ì¸ì‹œ ì¼ë°˜ ì‚¬ìš©ìë¡œ ì‹¤í–‰ ì¤‘ì¸ê²ƒ ì²˜ëŸ¼ ë³´ì´ëŠ”ê²ƒë„ ì´ê²ƒ ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>CGROUP Namespace (2016ë…„ ë„ì…)
        <ul>
          <li>CGROUPì€ í”„ë¡œì„¸ìŠ¤ì˜ ê·¸ë£¹ìœ¼ë¡œ CPU, ë©”ëª¨ë¦¬, ë””ìŠ¤í¬ I/O, ë„¤íŠ¸ì›Œí¬ ë“±ì˜ ìì›ì„ ì œí•œí•˜ê±°ë‚˜ í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>CGROUP NamespaceëŠ” CPU, ë©”ëª¨ë¦¬ ë“±ì˜ ìì›ì„ ì œí•œí•˜ê±°ë‚˜ í• ë‹¹í•  ìˆ˜ ìˆëŠ” CGROUPì„ ê²©ë¦¬í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="cgroup-ë¥¼-ì´ìš©í•œ-ìì›ê´€ë¦¬">cgroup ë¥¼ ì´ìš©í•œ ìì›ê´€ë¦¬</h3>

<ul>
  <li>cgroupsëŠ” control groupsì˜ ì¤„ì¼ë§ë¡œ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ ì œê³µí•˜ëŠ” ìì› ì œí•œ ë° í• ë‹¹ ê¸°ëŠ¥ìœ¼ë¡œ, CPU, ë©”ëª¨ë¦¬, ë””ìŠ¤í¬ I/O, ë„¤íŠ¸ì›Œí¬ ë“±ì˜ ìì›ì„ ì œí•œí•˜ê±°ë‚˜ í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>í”„ë¡œì„¸ìŠ¤ëŠ” ì‹¤í–‰ì¤‘ì¸ í”„ë¡œê·¸ë¨ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì˜ë¯¸í•˜ë©°, OSì—ì„œëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ í”„ë¡œì„¸ìŠ¤ ID(PID)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>cgroupsëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ì–´ì„œ ìì›ì„ ì œí•œí•˜ê±°ë‚˜ í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>cgroupsëŠ” /sys/fs/cgroup ë””ë ‰í„°ë¦¬ì— ë§ˆìš´íŠ¸ë˜ì–´ ìˆìœ¼ë©°, cgroup v1ê³¼ cgroup v2ê°€ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cgroup ë²„ì „ í™•ì¸</span>
<span class="nv">$ </span>mount | <span class="nb">grep </span>cgroup
<span class="c"># =&gt; cgroup2 on /sys/fs/cgroup type cgroup2 (rw,nosuid,nodev,noexec,relatime,nsdelegate,memory_recursiveprot)</span>
</code></pre></div></div>

<ul>
  <li>í˜„ì¬ í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œì—ëŠ” cgroup v2ê°€ ì‚¬ìš©ë˜ê³  ìˆëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>cgroup v2ëŠ” v1ì— ë¹„í•´ ìì› ê³„ì¸µêµ¬ì¡°ì˜ ê°€ì‹œì„±ì´ í–¥ìƒ ë˜ì—ˆê³ , memoryQoS ë¼ëŠ” ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì–´ ì»¨í…Œì´ë„ˆì—ì„œ OOM(Out Of Memory)ì´
ë°œìƒê°€ëŠ¥ì„±ì„ ì¤„ì˜€ìŠµë‹ˆë‹¤. ìµœì‹  ë¦¬ëˆ…ìŠ¤ ë°°í¬íŒì€ ë³´í†µ cgroup v2ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì–´ì„œ cgroup v2ë¡œ ì‹¤ìŠµì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.</li>
  <li>cgroupì˜ ê³„ì¸µ êµ¬ì¡°ëŠ” /sys/fs/cgroup ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>/procëŠ” ë³´ì•˜ì§€ë§Œ /sysëŠ” ëˆˆì— ìµì§€ ì•ŠìŠµë‹ˆë‹¤. ë¦¬ëˆ…ìŠ¤ ì»¤ë„ 3.x ë²„ì „ì—ì„œ ìƒê¸´ê²ƒìœ¼ë¡œ USER SPACE ìª½ì€ /procì— KERNEL SPACE ìª½ ì •ë³´ëŠ” /sysì— ë“¤ì–´ê°„ë‹¤ê³  í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_23.png" alt="img.png" class="image-center" />
<em class="image-caption">ì¶œì²˜ : <a href="https://blog.naver.com/yu3papa/223562337709">https://blog.naver.com/yu3papa/223562337709</a></em></p>

<ul>
  <li>ì‹¤ìŠµì„ í†µí•´ cgroupì˜ ì •ë³´ë¥¼ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mount <span class="nt">-t</span> cgroup
<span class="nv">$ </span>mount <span class="nt">-t</span> cgroup2
<span class="c"># =&gt; cgroup2 on /sys/fs/cgroup type cgroup2 (rw,nosuid,nodev,noexec,relatime,nsdelegate,memory_recursiveprot)</span>

<span class="nv">$ </span>findmnt <span class="nt">-t</span> cgroup2
<span class="c"># =&gt; TARGET         SOURCE  FSTYPE  OPTIONS</span>
<span class="c">#    /sys/fs/cgroup cgroup2 cgroup2 rw,nosuid,nodev,noexec,relatime,nsdelegate,memory_recursiveprot</span>

<span class="c"># cgroupv1 ë§Œ ì§€ì› ì‹œ, cgroup2 ì¶œë ¥ë˜ì§€ ì•ŠìŒ</span>
<span class="nv">$ </span><span class="nb">grep </span>cgroup /proc/filesystems
<span class="c"># =&gt; nodev   cgroup</span>
<span class="c">#    nodev   cgroup2</span>

<span class="nv">$ </span><span class="nb">stat</span> <span class="nt">-fc</span> %T /sys/fs/cgroup/
<span class="c"># =&gt; cgroup2fs</span>

<span class="c"># í„°ë¯¸ë„2</span>
<span class="nv">$ </span><span class="nb">sleep </span>100000

<span class="c"># í„°ë¯¸ë„1</span>
<span class="c"># /proc ì— cgroup ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/cgroups
<span class="nv">$ </span><span class="nb">cat</span> /proc/<span class="si">$(</span>pgrep <span class="nb">sleep</span><span class="si">)</span>/cgroup
<span class="c"># =&gt; 0::/user.slice/user-1000.slice/session-713.scope</span>

<span class="nv">$ </span>tree /proc/<span class="si">$(</span>pgrep <span class="nb">sleep</span><span class="si">)</span> <span class="nt">-L</span> 2
<span class="c"># =&gt; ...</span>
<span class="c">#    |-- &lt;span style="font-weight:bold;color:blue;"&gt;ns&lt;/span&gt;</span>
<span class="c">#    |   |-- &lt;span style="font-weight:bold;color:teal;"&gt;cgroup&lt;/span&gt; -&amp;gt; cgroup:[4026531835]</span>
<span class="c">#    |   |-- &lt;span style="font-weight:bold;color:teal;"&gt;ipc&lt;/span&gt; -&amp;gt; ipc:[4026531839]</span>
<span class="c">#    |   |-- &lt;span style="font-weight:bold;color:teal;"&gt;mnt&lt;/span&gt; -&amp;gt; mnt:[4026531841]</span>
<span class="c">#    |   |-- &lt;span style="font-weight:bold;color:teal;"&gt;net&lt;/span&gt; -&amp;gt; net:[4026531840]</span>
<span class="c">#    ...</span>

<span class="c"># cgroup ëª©ë¡ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">ls</span> /sys/fs/cgroup
<span class="nv">$ </span><span class="nb">cat</span> /sys/fs/cgroup/cgroup.controllers
<span class="c"># =&gt; cpuset cpu io memory hugetlb pids rdma misc</span>
<span class="nv">$ </span>tree /sys/fs/cgroup/ <span class="nt">-L</span> 1
<span class="nv">$ </span>tree /sys/fs/cgroup/ <span class="nt">-L</span> 2
<span class="nv">$ </span>tree /sys/fs/cgroup/user.slice <span class="nt">-L</span> 1
<span class="nv">$ </span>tree /sys/fs/cgroup/user.slice/user-1000.slice <span class="nt">-L</span> 1
</code></pre></div></div>

<ul>
  <li>ì´ë²ˆì—ëŠ” cgroupì„ ì´ìš©í•˜ì—¬ ìì›ì„ ì œí•œí•˜ëŠ” ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„ 2ê°œë¥¼ ì—´ì–´ì„œ root ë¡œ ì‹¤ìŠµ í•˜ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-i</span>
<span class="nv">$ </span><span class="nb">whoami</span>
<span class="c"># =&gt; root</span>

<span class="c"># íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>apt <span class="nb">install</span> <span class="nt">-y</span> cgroup-tools stress htop

<span class="c"># í„°ë¯¸ë„2</span>
<span class="c"># CPU ì‚¬ìš©ë¥  í™•ì¸ì„ ìœ„í•´ htopì„ ì‹¤í–‰í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>htop

<span class="c"># í„°ë¯¸ë„1ì—ì„œ ì‹¤ìŠµ ì§„í–‰</span>

<span class="c"># 1ê°œ CPU ì½”ì–´ì— ë¶€í•˜ ë°œìƒì„ ìœ„í•´ stressë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>stress <span class="nt">--cpu</span> 1
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_25.png" alt="img.png" /></p>

<ul>
  <li>CPU 0ë§Œ 100% ì‚¬ìš©ì¤‘ì¸ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /sys/fs/cgroup
<span class="nv">$ </span><span class="nb">mkdir </span>test_cgroup_parent <span class="o">&amp;&amp;</span> <span class="nb">cd </span>test_cgroup_parent
<span class="nv">$ </span>tree

<span class="c"># ì œì–´ê°€ëŠ¥í•œ í•­ëª© í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat </span>cgroup.controllers
<span class="c"># =&gt; cpuset cpu io memory hugetlb pids rdma misc</span>

<span class="c"># cpuë¥¼ subtreeì´ ì¶”ê°€í•˜ì—¬ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ìˆë„ë¡ ì„¤ì • : +/-(ì¶”ê°€/ì‚­ì œ) </span>
<span class="nv">$ </span><span class="nb">cat </span>cgroup.subtree_control
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"+cpu"</span> <span class="o">&gt;&gt;</span> /sys/fs/cgroup/test_cgroup_parent/cgroup.subtree_control

<span class="c"># cpu.max ì œí•œ ì„¤ì • : ì²« ë²ˆì¨° ê°’ì€ í—ˆìš©ëœ ì‹œê°„(ë§ˆì´í¬ë¡œì´ˆ) ë‘ ë²ˆì§¸ ê°’ì€ ì´ ê¸°ê°„ ê¸¸ì´ &gt; 1/10 ì‹¤í–‰ ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">echo </span>100000 1000000 <span class="o">&gt;</span> /sys/fs/cgroup/test_cgroup_parent/cpu.max

<span class="c"># testìš© ìì‹ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•˜ê³ , pidë¥¼ ì¶”ê°€í•˜ì—¬ ì œí•œì„ ê±¸ì–´</span>
<span class="nv">$ </span><span class="nb">mkdir </span>test_cgroup_child <span class="o">&amp;&amp;</span> <span class="nb">cd </span>test_cgroup_child
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$$</span> <span class="o">&gt;</span> /sys/fs/cgroup/test_cgroup_parent/test_cgroup_child/cgroup.procs
<span class="nv">$ </span><span class="nb">cat</span> /sys/fs/cgroup/test_cgroup_parent/test_cgroup_child/cgroup.procs
<span class="c"># =&gt; 1947587</span>
<span class="c">#    2194781</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/<span class="nv">$$</span>/cgroup
<span class="c"># =&gt; 0::/test_cgroup_parent/test_cgroup_child</span>

<span class="c"># ë¶€í•˜ ë°œìƒ í™•ì¸ : í„°ë¯¸ë„2ì— htop í™•ì¸</span>
<span class="nv">$ </span>stress <span class="nt">--cpu</span> 1
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_26.png" alt="img.png" /></p>

<ul>
  <li>cpu.max ì œí•œ ì„¤ì •ì—ì„œ ì„¤ì •í•œ ëŒ€ë¡œ (100000/1000000 =&gt; 10%) CPU ì‚¬ìš©ëŸ‰ì´ 10%ë¡œ ì œí•œëœê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê°’ ìˆ˜ì •ì„ í•´ì„œ 100%ë¡œ ë³€ê²½í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ê°’ ìˆ˜ì •</span>
<span class="nv">$ </span><span class="nb">echo </span>1000000 1000000 <span class="o">&gt;</span> /sys/fs/cgroup/test_cgroup_parent/cpu.max

<span class="c"># ë¶€í•˜ ë°œìƒ í™•ì¸ : í„°ë¯¸ë„2ì— htop í™•ì¸</span>
<span class="nv">$ </span>stress <span class="nt">--cpu</span> 1
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_27.png" alt="img.png" /></p>

<ul>
  <li>í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í•œ cgroup ì„ ì‚­ì œí•˜ê³  ì‹¤ìŠµì„ ë§ˆë¬´ë¦¬í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">exit</span>
<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-i</span>
<span class="nv">$ </span><span class="nb">rmdir</span> /sys/fs/cgroup/test_cgroup_parent/test_cgroup_child
<span class="nv">$ </span><span class="nb">rmdir</span> /sys/fs/cgroup/test_cgroup_parent
</code></pre></div></div>

<ul>
  <li>ì´ìƒê³¼ ê°™ì´ cgroupì„ ì‚¬ìš©í•˜ì—¬ cpu ìì›ì„ ì œí•œí•˜ëŠ”ê²ƒì„ ì‹¤ìŠµí•´ ë³´ì•˜ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_24.png" alt="img.png" class="image-center" /></p>

<hr />

<h2 id="ì»¨í…Œì´ë„ˆ-ë„¤íŠ¸ì›Œí¬--iptables">ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ &amp; Iptables</h2>

<ul>
  <li>ë„ì»¤ëŠ” í˜¸ìŠ¤íŠ¸ì™€ ì»¨í…Œì´ë„ˆê°„, ì»¨í…Œì´ë„ˆ ê°„ì˜ ë„¤íŠ¸ì›Œí¬ë¥¼ ì•ì—ì„œ ì‚´í´ë³¸ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í†µí•´ ê²©ë¦¬í•©ë‹ˆë‹¤.</li>
  <li>ë˜í•œ iptablesë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ì œì–´í•˜ê³ , ì»¨í…Œì´ë„ˆ ê°„ì˜ í†µì‹ ì„ ì œì–´í•©ë‹ˆë‹¤.</li>
  <li>ì‹¤ìŠµì„ í†µí•´ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í†µí•œ ê²©ë¦¬ì™€ iptablesì˜ ì‚¬ìš©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="red--blue-ë„¤íŠ¸ì›Œí¬-ë„¤ì„ìŠ¤í˜ì´ìŠ¤-ê°„-í†µì‹ ">Red &lt;=&gt; Blue ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°„ í†µì‹ </h3>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_17.png" alt="img.png" />
<a href="https://www.slideshare.net/slideshow/make-container-withoutdocker6overlaynetwork1/248297122">ì¶œì²˜ : ë„ì»¤ì—†ì´ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸°</a></p>

<ul>
  <li>ë¨¼ì € í„°ë¯¸ë„ 3ê°œë¥¼ ì—´ê³  ëª¨ë‘ ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸ í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-i</span>
<span class="nv">$ </span><span class="nb">whoami</span>
<span class="c"># =&gt; root</span>
</code></pre></div></div>

<ul>
  <li>veth (Virtual Ethernet)ë¥¼ ì‚¬ìš©í•˜ì—¬ Redì™€ Blue ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë§Œë“­ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip <span class="nb">link </span>add veth0 <span class="nb">type </span>veth peer name veth1

<span class="c"># veth ìƒì„± í™•ì¸ (ìƒíƒœ DOWN)</span>
<span class="nv">$ </span>ip <span class="nb">link</span>
<span class="c"># =&gt; 22: &lt;span style="color:teal;"&gt;veth1@veth0: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,M-DOWN&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;9e:74:34:5c:70:ef&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt;</span>
<span class="c">#    23: &lt;span style="color:teal;"&gt;veth0@veth1: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,M-DOWN&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;72:c0:05:36:cd:1b&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt;</span>
<span class="nv">$ </span>ip addr | <span class="nb">grep </span>veth
<span class="c"># =&gt; 22: &lt;span style="color:teal;"&gt;veth1@veth0: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,M-DOWN&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;9e:74:34:5c:70:ef&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt;</span>
<span class="c">#    23: &lt;span style="color:teal;"&gt;veth0@veth1: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,M-DOWN&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;72:c0:05:36:cd:1b&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt;</span>

<span class="c"># ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±</span>
<span class="nv">$ </span>ip netns add RED
<span class="nv">$ </span>ip netns add BLUE

<span class="c"># ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>ip netns
<span class="c"># =&gt; RED</span>
<span class="c">#    BLUE</span>

<span class="c"># veth0ì™€ veth1ì„ ê°ê° REDì™€ BLUE ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.</span>
<span class="nv">$ </span>ip <span class="nb">link set </span>veth0 netns RED  
<span class="nv">$ </span>ip <span class="nb">link set </span>veth1 netns BLUE

<span class="c"># ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸. id ë¼ëŠ”ê²ƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>ip netns list
<span class="c"># =&gt; RED (id: 0)</span>
<span class="c">#    BLUE (id: 1)</span>

<span class="c"># ip ë§í¬ë¥¼ í™•ì¸í•˜ë©´ veth0ì™€ veth1ì´ ê°ê° REDì™€ BLUE ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì´ë™ë˜ì–´ ê¸°ë³¸ ëª…ë ¹ì—ì„œëŠ” ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>ip <span class="nb">link</span> | <span class="nb">grep</span> <span class="s2">"veth."</span>
<span class="c"># =&gt; (ê³µë°±)</span>

<span class="c"># ip netns exec [ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëª…] [ëª…ë ¹] ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>RED ip <span class="nb">link</span>
<span class="c"># =&gt; 1: &lt;span style="color:teal;"&gt;lo: &lt;/span&gt;&amp;lt;LOOPBACK&amp;gt; mtu 65536 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/loopback &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt; brd &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt;</span>
<span class="c">#    23: &lt;span style="color:teal;"&gt;veth0@if22: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;72:c0:05:36:cd:1b&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns BLUE</span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>BLUE ip <span class="nb">link</span>
<span class="c"># =&gt; 1: &lt;span style="color:teal;"&gt;lo: &lt;/span&gt;&amp;lt;LOOPBACK&amp;gt; mtu 65536 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/loopback &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt; brd &lt;span style="color:olive;"&gt;00:00:00:00:00:00&lt;/span&gt;</span>
<span class="c">#    22: &lt;span style="color:teal;"&gt;veth1@if23: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;9e:74:34:5c:70:ef&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns RED</span>

<span class="c"># veth0ê³¼ veth1ì„ í™œì„±í™” (UP) ì‹œí‚¤ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>RED ip <span class="nb">link set </span>veth0 up
<span class="c"># veth0ì˜ IP í™•ì¸</span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>RED ip addr
<span class="c"># =&gt; ...</span>
<span class="c">#    23: &lt;span style="color:teal;"&gt;veth0@if22: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;72:c0:05:36:cd:1b&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns BLUE</span>
<span class="c">#        inet6 &lt;span style="color:blue;"&gt;fe80::70c0:5ff:fe36:cd1b&lt;/span&gt;/64 scope link proto kernel_ll </span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>BLUE ip <span class="nb">link set </span>veth1 up
<span class="nv">$ </span>ip netns <span class="nb">exec </span>BLUE ip addr
<span class="c"># =&gt; ...</span>
<span class="c">#    22: &lt;span style="color:teal;"&gt;veth1@if23: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;9e:74:34:5c:70:ef&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns RED</span>
<span class="c">#        inet6 &lt;span style="color:blue;"&gt;fe80::9c74:34ff:fe5c:70ef&lt;/span&gt;/64 scope link proto kernel_ll </span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># UP ìƒíƒœë¡œ ë˜ì—ˆìœ¼ë‚˜ IPê°€ ì—†ìŠµë‹ˆë‹¤. IPë¥¼ í• ë‹¹í•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>RED ip addr add 11.11.11.2/24 dev veth0
<span class="nv">$ </span>ip netns <span class="nb">exec </span>BLUE ip addr add 11.11.11.3/24 dev veth1

<span class="c"># IP ë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>RED ip addr
<span class="c"># =&gt; ...</span>
<span class="c">#    23: &lt;span style="color:teal;"&gt;veth0@if22: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;72:c0:05:36:cd:1b&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns BLUE</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;11.11.11.2&lt;/span&gt;/24 scope global veth0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 &lt;span style="color:blue;"&gt;fe80::70c0:5ff:fe36:cd1b&lt;/span&gt;/64 scope link proto kernel_ll </span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>BLUE ip addr
<span class="c"># =&gt; ...</span>
<span class="c">#    22: &lt;span style="color:teal;"&gt;veth1@if23: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;9e:74:34:5c:70:ef&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns RED</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;11.11.11.3&lt;/span&gt;/24 scope global veth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 &lt;span style="color:blue;"&gt;fe80::9c74:34ff:fe5c:70ef&lt;/span&gt;/64 scope link proto kernel_ll </span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
</code></pre></div></div>

<ul>
  <li>ì´ì œ Redì™€ Blue ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°„ì˜ í†µì‹ ì„ í…ŒìŠ¤íŠ¸ í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">nsenter</code> ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ì— attach í•˜ê³ , <code class="language-plaintext highlighter-rouge">tcpdump</code>ì™€ <code class="language-plaintext highlighter-rouge">ping</code>ì„ ì‚¬ìš©í•˜ì—¬ í†µì‹ ì„ í™•ì¸í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">tcpdump</code>ëŠ” ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ìº¡ì²˜í•˜ëŠ” ëª…ë ¹ì–´ë¡œ, íŒ¨í‚·ì„ ìº¡ì²˜í•˜ì—¬ í™•ì¸í•  ìˆ˜ ìˆê³ , <code class="language-plaintext highlighter-rouge">ping</code>ì€ ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree /var/run/netns
<span class="c"># =&gt; &lt;span style="font-weight:bold;color:blue;"&gt;/var/run/netns&lt;/span&gt;</span>
<span class="c">#    |-- BLUE</span>
<span class="c">#    `-- RED</span>
<span class="c">#    </span>
<span class="c">#    1 directory, 2 files</span>

<span class="c"># í„°ë¯¸ë„ 1 (RED 11.11.11.2)</span>
<span class="c"># ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— attach. </span>
<span class="c"># ì´ë•Œ --net ì˜µì…˜ì„ ì‚¬ìš©í•´ ì•ì—ì„œ í™•ì¸í•œ /var/run/netns/REDë¥¼ ì‚¬ìš©í•´ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— attach í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>nsenter <span class="nt">--net</span><span class="o">=</span>/var/run/netns/RED
<span class="c"># ì´ì›ƒí•˜ëŠ” IP/ARP ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ip neigh
<span class="c"># =&gt; (ê³µë°±)</span>
<span class="c"># ë¼ìš°íŒ… ì •ë³´, iptables ì •ë³´</span>
<span class="nv">$ </span>ip route
<span class="c"># =&gt; &lt;span style="color:purple;"&gt;11.11.11.0/24 &lt;/span&gt;dev &lt;span style="color:teal;"&gt;veth0 &lt;/span&gt;proto kernel scope link src &lt;span style="color:purple;"&gt;11.11.11.2 &lt;/span&gt;</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> 

<span class="c"># í„°ë¯¸ë„ 2 (í˜¸ìŠ¤íŠ¸)</span>
<span class="c"># ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>lsns <span class="nt">-t</span> net
<span class="c"># =&gt;         NS TYPE NPROCS     PID USER     NETNSID NSFS            COMMAND</span>
<span class="c">#    ...</span>
<span class="c">#    4026532444 net       1 1940569 root           0 /run/netns/RED  -zsh</span>
<span class="c">#    4026532527 net       0         root             /run/netns/BLUE</span>
<span class="c"># ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ip addr 
<span class="nv">$ </span>ip neigh
<span class="nv">$ </span>ip route
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> 

<span class="c"># í„°ë¯¸ë„ 3 (BLUE 11.11.11.3)</span>
<span class="nv">$ </span>nsenter <span class="nt">--net</span><span class="o">=</span>/var/run/netns/BLUE
<span class="nv">$ </span>ip neigh
<span class="nv">$ </span>ip route
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> 

<span class="c"># ping í†µì‹  í™•ì¸</span>

<span class="c"># í„°ë¯¸ë„3 (BLUE)</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> veth1
<span class="nv">$ </span>ip <span class="nt">-c</span> neigh
<span class="nv">$ </span><span class="nb">exit</span>

<span class="c"># í„°ë¯¸ë„1 (RED)</span>
<span class="nv">$ </span>ping 11.11.11.3 <span class="nt">-c</span> 1 
<span class="nv">$ </span>ip <span class="nt">-c</span> neigh
<span class="nv">$ </span><span class="nb">exit</span>

<span class="c"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ</span>
<span class="nv">$ </span>ip netns del RED
<span class="nv">$ </span>ip netns del BLUE 
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_15.png" alt="img.png" /></p>

<ul>
  <li>ìœ„ì˜ ìº¡ì³ì™€ ê°™ì´ í†µì‹ ì´ ë˜ì–´ì„œ tcpdumpì— ARP, ICMP íŒ¨í‚·ì´ ì¡íˆëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë˜í•œ <code class="language-plaintext highlighter-rouge">ip neigh</code> ëª…ë ¹ì„ í™•ì¸í–ˆì„ë•Œ ARP í…Œì´ë¸”ì— ìƒëŒ€ë°©ì˜ IPì™€ MAC ì£¼ì†Œê°€ ë“±ë¡ë˜ì–´ ìˆëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="red---bridge-br0---blue-ë„¤íŠ¸ì›Œí¬-ë„¤ì„ìŠ¤í˜ì´ìŠ¤-ê°„-í†µì‹ ">Red &lt;- Bridge (br0) -&gt; Blue ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°„ í†µì‹ </h3>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_16.png" alt="img.png" />
<a href="https://www.slideshare.net/slideshow/make-container-withoutdocker6overlaynetwork1/248297122">ì¶œì²˜ : ë„ì»¤ì—†ì´ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸°</a></p>

<ul>
  <li>ì´ì „ ì‹¤ìŠµì—ì„œëŠ” Redì™€ Blueë¥¼ ì—°ê²°í•˜ì—¬ peer ë„¤íŠ¸ì›Œí¬ë¡œ êµ¬ì„±í•˜ì˜€ëŠ”ë°, 
ì´ë²ˆì—ëŠ” ê°ê° ë…ë¦½ì ì¸ ë„¤íŠ¸ì›Œí¬ë¡œ êµ¬ì„±í•˜ì—¬ Bridgeë¥¼ ì‚¬ìš©í•˜ì—¬ Redì™€ Blue ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°„ì˜ í†µì‹ ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ì™œ Bridgeë¥¼ ë‘ëŠ”ê°€ í•˜ë©´, peer ë„¤íŠ¸ì›Œí¬ë¥¼ êµ¬ì„±í•  ê²½ìš° êµ¬ì„±ì›ë“¤ ê°„ì˜ í†µì‹ ì„ ìœ„í•´ì„œëŠ” ëª¨ë“  ë…¸ë“œê°€ ì„œë¡œì„œë¡œ ì—°ê²°ë˜ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w1/20240831_kans_w1_18.png" alt="img.png" class="image-center" /></li>
  <li>Bridgeë¥¼ ë‘ë©´ ê° ë…¸ë“œëŠ” Bridgeì™€ë§Œ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ í†µì‹ ì´ ê°€ëŠ¥í•˜ë¯€ë¡œ íš¨ìœ¨ì ì…ë‹ˆë‹¤.</li>
  <li>ì‹¤ìŠµì„ í†µí•´ ì•„ë˜ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ ê²©ë¦¬ëœ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ê³  ë¸Œë¦¿ì§€ë¥¼ í†µí•´ í†µì‹ í•´ë³´ê² ìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w1/20240831_kans_w1_19.png" alt="img.png" /></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„ 3ê°œë¥¼ root ë¡œ ì—½ë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-i</span>
<span class="nv">$ </span><span class="nb">whoami</span>
<span class="c"># =&gt; root</span>

<span class="c"># ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë° veth ìƒì„±</span>
<span class="nv">$ </span>ip netns add RED
<span class="nv">$ </span>ip <span class="nb">link </span>add reth0 <span class="nb">type </span>veth peer name reth1
<span class="nv">$ </span>ip <span class="nb">link set </span>reth0 netns RED
<span class="nv">$ </span>ip netns add BLUE
<span class="nv">$ </span>ip <span class="nb">link </span>add beth0 <span class="nb">type </span>veth peer name beth1
<span class="nv">$ </span>ip <span class="nb">link set </span>beth0 netns BLUE

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>ip netns list
<span class="nv">$ </span>ip <span class="nb">link</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    26: &lt;span style="color:teal;"&gt;reth1@if27: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;9a:1f:bf:6f:fe:64&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns RED</span>
<span class="c">#    28: &lt;span style="color:teal;"&gt;beth1@if29: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;7e:31:cf:5f:00:8f&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netns BLUE</span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>RED ip addr
<span class="c"># =&gt; ...</span>
<span class="c">#    27: &lt;span style="color:teal;"&gt;reth0@if26: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;ea:7f:a0:1f:00:3d&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netnsid 0</span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>BLUE ip addr
<span class="c"># =&gt; ...</span>
<span class="c">#    29: &lt;span style="color:teal;"&gt;beth0@if28: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST&amp;gt; mtu 1500 qdisc noop state &lt;span style="color:red;"&gt;DOWN &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;66:23:89:a6:f7:70&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt; link-netnsid 0</span>

<span class="c"># ë¸Œë¦¿ì§€ ì •ë³´ í™•ì¸ </span>
<span class="nv">$ </span>brctl show
<span class="c"># =&gt; bridge name	bridge id		STP enabled	interfaces</span>
<span class="c">#    docker0		8000.02425756997c	no		</span>

<span class="c"># br0 ë¸Œë¦¿ì§€ ìƒì„±</span>
<span class="nv">$ </span>ip <span class="nb">link </span>add br0 <span class="nb">type </span>bridge

<span class="c"># br0 ë¸Œë¦¿ì§€ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>brctl show br0
<span class="c"># =&gt; bridge name	bridge id		STP enabled	interfaces</span>
<span class="c">#    br0		8000.000000000000	no		</span>
<span class="nv">$ </span>brctl showmacs br0
<span class="nv">$ </span>brctl showstp br0

<span class="c"># reth1ê³¼ beth1ì„ br0 ë¸Œë¦¿ì§€ì— ì—°ê²°</span>
<span class="nv">$ </span>ip <span class="nb">link set </span>reth1 master br0
<span class="nv">$ </span>ip <span class="nb">link set </span>beth1 master br0
<span class="nv">$ </span>brctl show br0
<span class="c"># =&gt; bridge name     bridge id               STP enabled     interfaces</span>
<span class="c">#    br0             8000.7e31cf5f008f       no              beth1</span>
<span class="c">#                                                            reth1</span>
<span class="nv">$ </span>brctl showmacs br0
<span class="c"># =&gt; port no mac addr                is local?       ageing timer</span>
<span class="c">#      2     7e:31:cf:5f:00:8f       yes                0.00</span>
<span class="c">#      2     7e:31:cf:5f:00:8f       yes                0.00</span>
<span class="c">#      1     9a:1f:bf:6f:fe:64       yes                0.00</span>
<span class="c">#      1     9a:1f:bf:6f:fe:64       yes                0.00</span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nb">link</span>
<span class="c"># =&gt; ... </span>
<span class="c">#    &lt;span style="color:teal;"&gt;reth1@if27       &lt;/span&gt;&lt;span style="color:red;"&gt;DOWN           &lt;/span&gt;&lt;span style="color:olive;"&gt;9a:1f:bf:6f:fe:64 &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST&amp;gt; </span>
<span class="c">#    &lt;span style="color:teal;"&gt;beth1@if29       &lt;/span&gt;&lt;span style="color:red;"&gt;DOWN           &lt;/span&gt;&lt;span style="color:olive;"&gt;7e:31:cf:5f:00:8f &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST&amp;gt; </span>
<span class="c">#    &lt;span style="color:teal;"&gt;br0              &lt;/span&gt;&lt;span style="color:red;"&gt;DOWN           &lt;/span&gt;&lt;span style="color:olive;"&gt;7e:31:cf:5f:00:8f &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST&amp;gt; </span>

<span class="c"># reth0ê³¼ beth0ì— IP ì„¤ì • ë° í™œì„±í™”(UP) ì‹œí‚¤ê³ , reth1, beth1, br0ë¥¼ í™œì„±í™”(UP) í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>RED  ip addr add 11.11.11.2/24 dev reth0
<span class="nv">$ </span>ip netns <span class="nb">exec </span>BLUE ip addr add 11.11.11.3/24 dev beth0
<span class="nv">$ </span>ip netns <span class="nb">exec </span>RED  ip <span class="nb">link set </span>reth0 up
<span class="nv">$ </span>ip <span class="nb">link set </span>reth1 up
<span class="nv">$ </span>ip netns <span class="nb">exec </span>BLUE ip <span class="nb">link set </span>beth0 up
<span class="nv">$ </span>ip <span class="nb">link set </span>beth1 up
<span class="nv">$ </span>ip <span class="nb">link set </span>br0 up
<span class="nv">$ </span>ip <span class="nt">-br</span> addr
<span class="c"># =&gt; ... </span>
<span class="c">#    &lt;span style="color:teal;"&gt;reth1@if27       &lt;/span&gt;&lt;span style="color:green;"&gt;UP             &lt;/span&gt;&lt;span style="color:blue;"&gt;fe80::981f:bfff:fe6f:fe64&lt;/span&gt;/64 </span>
<span class="c">#    &lt;span style="color:teal;"&gt;beth1@if29       &lt;/span&gt;&lt;span style="color:green;"&gt;UP             &lt;/span&gt;&lt;span style="color:blue;"&gt;fe80::7c31:cfff:fe5f:8f&lt;/span&gt;/64 </span>
<span class="c">#    &lt;span style="color:teal;"&gt;br0              &lt;/span&gt;&lt;span style="color:green;"&gt;UP             &lt;/span&gt;&lt;span style="color:blue;"&gt;fe80::7c31:cfff:fe5f:8f&lt;/span&gt;/64 </span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>RED ip <span class="nt">-br</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    &lt;span style="color:teal;"&gt;reth0@if26       &lt;/span&gt;&lt;span style="color:green;"&gt;UP             &lt;/span&gt;&lt;span style="color:purple;"&gt;11.11.11.2&lt;/span&gt;/24 &lt;span style="color:blue;"&gt;fe80::e87f:a0ff:fe1f:3d&lt;/span&gt;/64 </span>
<span class="nv">$ </span>ip netns <span class="nb">exec </span>BLUE ip <span class="nt">-br</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    &lt;span style="color:teal;"&gt;beth0@if28       &lt;/span&gt;&lt;span style="color:green;"&gt;UP             &lt;/span&gt;&lt;span style="color:purple;"&gt;11.11.11.3&lt;/span&gt;/24 &lt;span style="color:blue;"&gt;fe80::6423:89ff:fea6:f770&lt;/span&gt;/64 </span>

<span class="c"># í„°ë¯¸ë„1 (RED 11.11.11.2)</span>
<span class="nv">$ </span>nsenter <span class="nt">--net</span><span class="o">=</span>/var/run/netns/RED
<span class="nv">$ </span>ip <span class="nt">-c</span> a<span class="p">;</span><span class="nb">echo</span><span class="p">;</span> ip <span class="nt">-c</span> route<span class="p">;</span><span class="nb">echo</span><span class="p">;</span> ip <span class="nt">-c</span> neigh
<span class="c"># í˜„ì¬ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>ip netns identify <span class="nv">$$</span>
<span class="c"># =&gt; RED</span>

<span class="c"># í„°ë¯¸ë„2 (í˜¸ìŠ¤íŠ¸)</span>
<span class="nv">$ </span>brctl showmacs br0
<span class="nv">$ </span>bridge fdb show
<span class="nv">$ </span>bridge fdb show dev br0

<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-L</span> <span class="nt">-n</span> <span class="nt">-v</span>

<span class="c"># í„°ë¯¸ë„3 (BLUE 11.11.11.3)</span>
<span class="nv">$ </span>nsenter <span class="nt">--net</span><span class="o">=</span>/var/run/netns/BLUE
<span class="nv">$ </span>ip <span class="nt">-c</span> a<span class="p">;</span><span class="nb">echo</span><span class="p">;</span> ip <span class="nt">-c</span> route<span class="p">;</span><span class="nb">echo</span><span class="p">;</span> ip <span class="nt">-c</span> neigh
<span class="c"># í˜„ì¬ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>ip netns identify <span class="nv">$$</span>
<span class="c"># =&gt; BLUE</span>

<span class="c"># í„°ë¯¸ë„2 (í˜¸ìŠ¤íŠ¸)</span>
<span class="c"># ping í†µì‹  ì „ ì‚¬ì „ ì„¤ì •</span>
<span class="c">## iptables ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'\-P'</span>
<span class="c"># =&gt; -P INPUT ACCEPT</span>
<span class="c">#    -P FORWARD DROP</span>
<span class="c">#    -P OUTPUT ACCEPT</span>
<span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> filter

<span class="c"># í˜¸ìŠ¤íŠ¸ì—ì„œ íŒ¨í‚· ë¼ìš°íŒ… ì„¤ì • í™•ì¸ - 0(off), 1(on)</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/net/ipv4/ip_forward
<span class="c"># =&gt; 1</span>
<span class="c"># ìœ„ì˜ ê²°ê³¼ê°€ 0ì¸ ê²½ìš° ì•„ë˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰</span>
<span class="c"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span>

<span class="c"># ping í†µì‹  í™•ì¸</span>
<span class="c"># í„°ë¯¸ë„2 (í˜¸ìŠ¤íŠ¸)</span>
<span class="nv">$ </span>tcpdump <span class="nt">-l</span> <span class="nt">-i</span> br0
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="c">#    listening on br0, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="c">#    (í„°ë¯¸ë„1ì—ì„œ ping ì‹¤í–‰ì‹œ)</span>
<span class="c">#    08:40:00.413198 IP 11.11.11.2 &gt; 11.11.11.3: ICMP echo request, id 41028, seq 1, length 64</span>
<span class="c">#    08:40:05.455528 ARP, Request who-has 11.11.11.3 tell 11.11.11.2, length 28</span>
<span class="c">#    08:40:05.455556 ARP, Reply 11.11.11.3 is-at 66:23:89:a6:f7:70 (oui Unknown), length 28</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -v --numeric --table filter --list FORWARD'</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -v --numeric --table filter --list FORWARD;echo;iptables -v --numeric --table filter --list DOCKER-USER;echo;iptables -v --numeric --table filter --list DOCKER-ISOLATION-STAGE-1'</span>

<span class="c"># í„°ë¯¸ë„3 (BLUE 11.11.11.3)</span>
<span class="nv">$ </span>tcpdump <span class="nt">-l</span> <span class="nt">-i</span> beth0

<span class="c"># í„°ë¯¸ë„1 (RED 11.11.11.2)</span>
<span class="nv">$ </span>ping 11.11.11.3 <span class="nt">-c</span> 1
<span class="c"># =&gt; ì‹¤íŒ¨</span>
</code></pre></div></div>

<p>ìœ„ì˜ ìº¡ì³ì™€ ê°™ì´ ë¸Œë¦¿ì§€ì—ì„œëŠ” íŒ¨í‚·ì´ ì¡íˆì§€ë§Œ, ë¸Œë¦¿ì§€ë¥¼ í†µí•´ Blueë¡œ íŒ¨í‚·ì´ ì „ë‹¬ë˜ì§€ ì•ŠëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ê·¸ë ‡ë‹¤ë©´ ì™œ íŒ¨í‚·ì´ ì „ë‹¬ë˜ì§€ ì•Šì„ê¹Œìš”? ê·¸ê²ƒì€ <code class="language-plaintext highlighter-rouge">iptables -t filter -S | grep '\-P'</code> ëª…ë ¹ì„ í†µí•´ í™•ì¸í–ˆì„ë•Œ FORWARD ì²´ì¸ì´ DROPìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
íŒ¨í‚·ì´ ë¸Œë¦¿ì§€ë¥¼ í†µí•´ ì „ë‹¬ë˜ë ¤ë©´ FORWARD ì²´ì¸ì„ í†µí•´ì•¼ í•˜ëŠ”ë° DROPì´ë©´ íŒ¨í‚·ì´ ì „ë‹¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_20.png" alt="img.png" class="image-center" />
<em class="image-caption">Iptables ì²˜ë¦¬ íë¦„ë„ (<a href="https://natnat1.medium.com/iptables-b9ce0602253f">https://natnat1.medium.com/iptables-b9ce0602253f</a>)</em></p>

<ul>
  <li>ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ iptablesëŠ” íŒ¨í‚·ì´ ë“¤ì–´ì˜¤ë©´ PREROUTING ì²´ì¸ì„ í†µí•´ íŒ¨í‚·ì„ ì²˜ë¦¬í•˜ê³ , FORWARD ì²´ì¸ì„ í†µí•´ íŒ¨í‚·ì„ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_21.png" alt="img.png" /></p>

<ul>
  <li>br0 ì…ì¥ì—ì„œ ì‚´í´ë³´ë©´ ìœ„ì™€ ê°™ìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ 11.11.11.2 &lt;=&gt; 11.11.11.3ìœ¼ë¡œ FORWARDë¥¼ í—ˆìš©í•˜ë©´ ë˜ëŠ”ë° ë°©ë²•ì„ ì‚´í´ë³´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.
    <ul>
      <li>ì¶œë°œì§€ 11.11.11.2ì™€ 11.11.11.3 í—ˆìš©</li>
      <li>ë„ì°©ì§€ 11.11.11.0/24 ëŒ€ì—­ ì¶œë°œì§€ í—ˆìš©</li>
      <li>FORWARD ê¸°ë³¸ ì •ì±…ì„ ACCEPTë¡œ ë³€ê²½</li>
      <li>ë“±ë“± ê¸°íƒ€ ì–´ë–¤ ë°©ë²•ìœ¼ë¡œë“  11.11.11.2ì™€ 11.11.11.3ì´ FORWARD ì²´ì¸ì„ í†µí•´ íŒ¨í‚·ì´ ì „ë‹¬ë˜ë„ë¡ ì„¤ì •í•˜ë©´ ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì‹¤ìŠµì„ í†µí•´ iptablesë¥¼ í†µí•´ íŒ¨í‚·ì´ ì „ë‹¬ë˜ë„ë¡ ì„¤ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ë°©ë²•1. 11.11.11.2ì™€ 11.11.11.3 í—ˆìš©í•˜ê¸°
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„2 (í˜¸ìŠ¤íŠ¸)</span>
<span class="c"># ì¶œë°œì§€ 11.11.11.2 í—ˆìš©í•˜ê¸°</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-A</span> FORWARD <span class="nt">-s</span> 11.11.11.2/32 <span class="nt">-j</span> ACCEPT
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-A</span> FORWARD <span class="nt">-s</span> 11.11.11.3/32 <span class="nt">-j</span> ACCEPT
<span class="nv">$ </span>tcpdump <span class="nt">-l</span> <span class="nt">-i</span> br0
  
<span class="c"># í„°ë¯¸ë„3 (BLUE 11.11.11.3)</span>
<span class="nv">$ </span>tcpdump <span class="nt">-l</span> <span class="nt">-i</span> beth0
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="c">#    listening on beth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="c">#    10:39:20.225225 IP 11.11.11.2 &gt; 11.11.11.3: ICMP echo request, id 33335, seq 1, length 64</span>
<span class="c">#    10:39:20.225233 IP 11.11.11.3 &gt; 11.11.11.2: ICMP echo reply, id 33335, seq 1, length 64</span>
  
<span class="c"># í„°ë¯¸ë„1 (RED 11.11.11.2)</span>
<span class="nv">$ </span>ping 11.11.11.3
<span class="c"># =&gt; PING 11.11.11.3 (11.11.11.3) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 11.11.11.3: icmp_seq=1 ttl=64 time=0.055 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 11.11.11.3 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.055/0.055/0.055/0.000 ms</span>
  
<span class="c"># í„°ë¯¸ë„2 (í˜¸ìŠ¤íŠ¸)</span>
<span class="c"># í—ˆìš© ë£° ì œê±°</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-D</span> FORWARD <span class="nt">-s</span> 11.11.11.2/32 <span class="nt">-j</span> ACCEPT
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-D</span> FORWARD <span class="nt">-s</span> 11.11.11.3/32 <span class="nt">-j</span> ACCEPT
</code></pre></div>    </div>

    <p><img src="/assets/2024/kans-3th/w1/20240831_kans_w1_22.png" alt="img.png" /></p>
  </li>
  <li>ë°©ë²•2. ë„ì°©ì§€ 11.11.11.0/24 ëŒ€ì—­ í—ˆìš©í•˜ê¸°
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„2 (í˜¸ìŠ¤íŠ¸)</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-A</span> FORWARD <span class="nt">-d</span> 11.11.11.0/24 <span class="nt">-j</span> ACCEPT
<span class="c"># í…ŒìŠ¤íŠ¸ í›„ í—ˆìš© ë£° ì œê±°</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-D</span> FORWARD <span class="nt">-d</span> 11.11.11.0/24 <span class="nt">-j</span> ACCEPT
</code></pre></div>    </div>
  </li>
  <li>ë°©ë²•3. FORWARD ê¸°ë³¸ ì •ì±…ì„ ACCEPTë¡œ ë³€ê²½í•˜ê¸°
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„2 (í˜¸ìŠ¤íŠ¸)</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-P</span> FORWARD ACCEPT
<span class="c"># í…ŒìŠ¤íŠ¸ í›„ í—ˆìš© ë£° ì œê±°</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-P</span> FORWARD DROP
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="í˜¸ìŠ¤íŠ¸--redblue-ë„¤íŠ¸ì›Œí¬-ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ-ì ‘ê·¼í•˜ê¸°">í˜¸ìŠ¤íŠ¸ &lt;=&gt; RED/BLUE ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì ‘ê·¼í•˜ê¸°</h3>

<ul>
  <li>â€œRed &lt;- Bridge (br0) -&gt; Blue ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°„ í†µì‹ â€ì„ ì‹¤ìŠµí•œ í™˜ê²½ì— ì´ì–´ì„œ ì‹¤ìŠµí•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„1 (RED 11.11.11.2)</span>
<span class="nv">$ </span>nsenter <span class="nt">--net</span><span class="o">=</span>/var/run/netns/RED
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any

<span class="c"># í„°ë¯¸ë„3ë¥¼ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nv">$ </span>ip netns identify <span class="nv">$$</span>
<span class="c"># =&gt; (ê³µë°±)</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> br0 <span class="nt">-n</span>

<span class="c"># í„°ë¯¸ë„2 (í˜¸ìŠ¤íŠ¸)</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 11.11.11.2
<span class="c"># =&gt; 1 packets transmitted, 0 received, 100% packet loss, time 0ms</span>
<span class="c"># (ping ì´ ì‹¤íŒ¨í•©ë‹ˆë‹¤.)</span>
</code></pre></div></div>

<ul>
  <li>í˜¸ìŠ¤íŠ¸ì—ì„œ RED (11.11.11.2) ë¡œ pingì‹œ íŒ¨í‚·ì´ ì „ë‹¬ë˜ì§€ ì•ŠëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê·¸ ì´ìœ ëŠ” RED ë„¤íŠ¸ì›Œí¬ë¡œ ì ‘ê·¼í•˜ê¸° ìœ„í•´ì„œëŠ” br0ë¥¼ ê±°ì³ì„œ ì ‘ê·¼í•´ì•¼í•˜ëŠ”ë°, br0ëŠ” ipê°€ ì—†ê¸° ë•Œë¬¸ì— íŒ¨í‚·ì´ ì „ë‹¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
  <li>br0ì— ipë¥¼ í• ë‹¹í•˜ê³ , REDì™€ BLUE ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì ‘ê·¼í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„2 (í˜¸ìŠ¤íŠ¸)</span>
<span class="nv">$ </span>ip addr add 11.11.11.1/24 dev br0
<span class="nv">$ </span>ip addr
<span class="c"># =&gt; ...</span>
<span class="c">#    30: &lt;span style="color:teal;"&gt;br0: &lt;/span&gt;&amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state &lt;span style="color:green;"&gt;UP &lt;/span&gt;group default qlen 1000</span>
<span class="c">#        link/ether &lt;span style="color:olive;"&gt;7e:31:cf:5f:00:8f&lt;/span&gt; brd &lt;span style="color:olive;"&gt;ff:ff:ff:ff:ff:ff&lt;/span&gt;</span>
<span class="c">#        inet &lt;span style="color:purple;"&gt;11.11.11.1&lt;/span&gt;/24 scope global br0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>ping 11.11.11.2 <span class="nt">-c</span> 1
<span class="c"># =&gt; PING 11.11.11.2 (11.11.11.2) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 11.11.11.2: icmp_seq=1 ttl=64 time=0.044 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 11.11.11.2 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.044/0.044/0.044/0.000 ms</span>
<span class="nv">$ </span>ping 11.11.11.3 <span class="nt">-c</span> 1
<span class="c"># =&gt; PING 11.11.11.3 (11.11.11.3) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 11.11.11.3: icmp_seq=1 ttl=64 time=0.052 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 11.11.11.3 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.052/0.052/0.052/0.000 ms</span>
</code></pre></div></div>

<ul>
  <li>ì´ë²ˆì—ëŠ” REDì—ì„œ í˜¸ìŠ¤íŠ¸ë¡œ pingì´ ë˜ëŠ”ê²ƒì„ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„1 (RED 11.11.11.2)</span>
<span class="c"># br0 ì— ping í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>ping 11.11.11.1 <span class="nt">-c</span> 1
<span class="c"># =&gt; PING 11.11.11.1 (11.11.11.1) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 11.11.11.1: icmp_seq=1 ttl=64 time=0.041 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 11.11.11.1 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.041/0.041/0.041/0.000 ms</span>

<span class="c"># í˜¸ìŠ¤íŠ¸ë¡œ ping í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>ping 10.10.10.51 <span class="nt">-c</span> 1
<span class="c"># =&gt; ping: connect: Network is unreachable</span>
</code></pre></div></div>

<ul>
  <li>br0ì—ëŠ” ping ì´ ì„±ê³µí•˜ëŠ”ë° í˜¸ìŠ¤íŠ¸ë¡œëŠ” Network is unreachable ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê·¸ ì´ìœ ëŠ” 11.11.11.0/24ì—ì„œ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ì¸ 10.10.10.0/24ë¡œ íŒ¨í‚·ì„ ë¼ìš°íŒ…í•˜ëŠ” ì •ë³´ê°€ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
  <li>REDë‚˜ BLUEì—ì„œ í˜¸ìŠ¤íŠ¸ë¡œ íŒ¨í‚·ì„ ì „ë‹¬í•˜ê¸° ìœ„í•´ì„œëŠ” br0ë¥¼ í†µí•´ì•¼ í•˜ëŠ”ë°, REDì™€ BLUEì— ê¸°ë³¸ ê²Œì´íŠ¸ì›¨ì´ë¥¼ br0ë¡œ ì„¤ì •í•˜ì—¬ í…ŒìŠ¤íŠ¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„1 (RED 11.11.11.2)</span>
<span class="nv">$ </span>ip route add default via 11.11.11.1
<span class="nv">$ </span>ip route
<span class="c"># =&gt; default via 11.11.11.1 dev reth0</span>
<span class="c">#    11.11.11.0/24 dev reth0 proto kernel scope link src 11.11.11.2</span>
<span class="nv">$ </span>ping 10.10.10.51 <span class="nt">-c</span> 1
<span class="c"># =&gt; PING 10.10.10.51 (10.10.10.51) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 10.10.10.51: icmp_seq=1 ttl=64 time=0.041 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 10.10.10.51 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="nv">$ </span><span class="nb">exit</span>

<span class="c"># BLUEì—ì„œë„ ë™ì¼í•˜ê²Œ í…ŒìŠ¤íŠ¸í•´ë³´ê² ìŠµë‹ˆë‹¤</span>

<span class="c"># í„°ë¯¸ë„1 (BLUE 11.11.11.3)</span>
<span class="nv">$ </span>nsenter <span class="nt">--net</span><span class="o">=</span>/var/run/netns/BLUE
<span class="nv">$ </span>ip netns identify <span class="nv">$$</span>
<span class="c"># =&gt; BLUE</span>
<span class="nv">$ </span>ping 10.10.10.51 <span class="nt">-c</span> 1
<span class="c"># =&gt; ping: connect: Network is unreachable</span>
<span class="nv">$ </span>ip route add default via 11.11.11.1
<span class="nv">$ </span>ip route
<span class="c"># =&gt; default via 11.11.11.1 dev beth0</span>
<span class="c">#    11.11.11.0/24 dev beth0 proto kernel scope link src 11.11.11.3</span>
<span class="nv">$ </span>ping 10.10.10.51 <span class="nt">-c</span> 1
<span class="c"># =&gt; PING 10.10.10.51 (10.10.10.51) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 10.10.10.51: icmp_seq=1 ttl=64 time=0.049 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 10.10.10.51 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.049/0.049/0.049/0.000 ms</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ip route add default via 11.11.11.1</code> ë¡œ ê¸°ë³¸ ê²Œì´íŠ¸ì›¨ì´ë¥¼ br0ë¡œ ì„¤ì •í•˜ê³ , í˜¸ìŠ¤íŠ¸ë¡œ pingì´ ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="redblueì—ì„œ-ì™¸ë¶€-ì¸í„°ë„·-í†µì‹ ">RED/BLUEì—ì„œ ì™¸ë¶€ ì¸í„°ë„· í†µì‹ </h3>

<ul>
  <li>ì´ë²ˆì—ëŠ” REDì™€ BLUE ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì™¸ë¶€ ì¸í„°ë„·ìœ¼ë¡œ í†µì‹ í•˜ëŠ” ë°©ë²•ì„ ì‹¤ìŠµí•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„1 (RED 11.11.11.2)</span>
<span class="nv">$ </span>nsenter <span class="nt">--net</span><span class="o">=</span>/var/run/netns/RED
<span class="nv">$ </span>ping 8.8.8.8 <span class="nt">-c</span> 1
<span class="c"># =&gt; PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span>
<span class="c">#    </span>
<span class="c">#    --- 8.8.8.8 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 0 received, 100% packet loss, time 0ms</span>
</code></pre></div></div>

<ul>
  <li>REDì—ì„œ ì™¸ë¶€ ì¸í„°ë„·ìœ¼ë¡œ pingì´ ë˜ì§€ ì•ŠëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>RED/BLUEì™€ ê°™ì´ í˜¸ìŠ¤íŠ¸ ì•„ë˜ì˜ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì™¸ë¶€ ì¸í„°ë„·ìœ¼ë¡œ íŒ¨í‚·ì„ ì „ë‹¬í•˜ê¸° ìœ„í•´ì„œëŠ”
í˜¸ìŠ¤íŠ¸ì˜ IPë¡œ íŒ¨í‚·ì„ ì „ë‹¬í•˜ê³ , ì‘ë‹µì„ í˜¸ìŠ¤íŠ¸ IPë¡œ ë°›ì•„ì„œ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬(RED/BLUE)ë¡œ ì „ë‹¬í•´ì•¼í•˜ëŠ”ë°, 
ì´ëŸ¬í•œ ê³¼ì •ì„ SNAT (Source Network Address Translation) ë˜ëŠ” MASQUERADEë¼ê³  í•©ë‹ˆë‹¤.</li>
  <li>nat í…Œì´ë¸”ì˜ POSTROUTING ì²´ì¸ì— MASQUERADE ë£°ì„ ì¶”ê°€í•˜ë©´ SNATì´ ì ìš©ë˜ì–´ì„œ ì™¸ë¶€ ì¸í„°ë„·ìœ¼ë¡œ íŒ¨í‚·ì„ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„2 (í˜¸ìŠ¤íŠ¸)</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 11.11.11.0/24 <span class="nt">-j</span> MASQUERADE
<span class="c"># SNAT í†µê³„ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -v --numeric --table nat --list POSTROUTING'</span>
<span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> nat
<span class="nv">$ </span>conntrack <span class="nt">-L</span> <span class="nt">--src-nat</span>
<span class="c"># =&gt; icmp     1 29 src=11.11.11.2 dst=8.8.8.8 type=8 code=0 id=62779 src=8.8.8.8 dst=10.10.10.109 type=0 code=0 id=62779 mark=0 use=1</span>
<span class="c">#    conntrack v1.4.8 (conntrack-tools): 1 flow entries have been shown.</span>

<span class="c"># í„°ë¯¸ë„1 (RED 11.11.11.2)</span>
<span class="nv">$ </span>ping 8.8.8.8 <span class="nt">-c</span> 1
<span class="c"># =&gt; PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=26.3 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 8.8.8.8 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 26.277/26.277/26.277/0.000 ms</span>
<span class="nv">$ </span><span class="nb">exit</span>

<span class="c"># í„°ë¯¸ë„1 (BLUE 11.11.11.3)</span>
<span class="nv">$ </span>nsenter <span class="nt">--net</span><span class="o">=</span>/var/run/netns/BLUE
<span class="nv">$ </span>ip route add default via 11.11.11.1
<span class="nv">$ </span>ping 8.8.8.8 <span class="nt">-c</span> 1
<span class="nv">$ </span><span class="nb">exit</span>

<span class="c"># ì‚­ì œ</span>
<span class="nv">$ </span>ip netns delete RED
<span class="nv">$ </span>ip netns delete BLUE
<span class="nv">$ </span>ip <span class="nb">link </span>delete br0

<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-D</span> POSTROUTING <span class="nt">-s</span> 11.11.11.0/24 <span class="nt">-j</span> MASQUERADE
</code></pre></div></div>

<ul>
  <li>SNAT ì¶”ê°€í•œ ì´í›„ pingì´ ì˜ ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì²«ì£¼ë¶€í„° ì´ë¡ ê³¼ ì‹¤ìŠµí• ê²ƒì´ êµ‰ì¥íˆ ë§ì•˜ìŠµë‹ˆë‹¤. í…Œë¼í¼ ìŠ¤í„°ë””ê°€ ìˆœí•œë§›ìœ¼ë¡œ ë³´ì¼ ì •ë„ì…ë‹ˆë‹¤. ğŸ˜…
í•˜ì§€ë§Œ ê·¸ë™ì•ˆ ë§‰ì—°í•˜ê²Œ ì•Œê³  ìˆì—ˆë˜ ë„ì»¤ ì»¨í…Œì´ë„ˆì˜ ê²©ë¦¬ ì›ë¦¬ì™€ ë¦¬ëˆ…ìŠ¤ ë„¤íŠ¸ì›Œí¬ì™€ iptablesì— 
ëŒ€í•´ ë” ê¹Šê²Œ ì´í•´í•  ìˆ˜ ìˆì–´ì„œ ì¢‹ì•˜ìŠµë‹ˆë‹¤.</p>

<p><del>ê°œì¸ì ìœ¼ë¡œ *BSDë¥¼ ì¢‹ì•„í•˜ëŠ”ë° ì´ ì •ë„ë©´ FreeBSDì—ì„œë„ BSDë§Œì˜ docker ê°™ì€ ì—ì½”ì‹œìŠ¤í…œ êµ¬ì¶•ì´ ê°€ëŠ¥í• ê²ƒ ê°™ì€ë°
ì™œ ëª»í•˜ê³  ìˆëŠ”ì§€ ì˜ë¬¸ì…ë‹ˆë‹¤. ë¹„ìŠ·í•˜ê²Œ ëŒë¦´ ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ ì‹œë„ë“¤ì€ ë§ì€ë° íì§€ë¶€ì§€ ë˜ëŠ” ì´ìœ ëŠ” ëŒ€ì²´ ë¬´ì—‡ì¸ì§€..</del></p>

<p>í•­ìƒ ë¬´ì–¸ê°€ë¥¼ ë°°ìš°ëŠ”ê²ƒì€ ì¦ê²ìŠµë‹ˆë‹¤. ë‹¤ìŒ ìŠ¤í„°ë””ë„ ê¸°ëŒ€ë©ë‹ˆë‹¤! :smile:</p>]]></content><author><name></name></author><category term="kans" /><category term="kubernetes," /><category term="network," /><category term="linux" /><summary type="html"><![CDATA[ì§€ë‚œ í…Œë¼í¼ ìŠ¤í„°ë””ì— ì´ì–´ ì´ë²ˆ ì£¼ ë¶€í„° KANS ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤! KANSëŠ” Kubernetes Advanced Networking Studyì˜ ì¤„ì„ë§ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ì— ëŒ€í•œ ì‹¬ë„ìˆê²Œ ê³µë¶€í•˜ëŠ” ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì´ë²ˆ ìŠ¤í„°ë””ë„ ê³¼ì œí•  ê±±ì •ë„ ë˜ì§€ë§Œ ì¬ë¯¸ìˆì„ê²ƒ ê°™ì•„ ê¸°ëŒ€ë©ë‹ˆë‹¤.]]></summary></entry></feed>