<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="ko"><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://sweetlittlebird.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://sweetlittlebird.github.io/" rel="alternate" type="text/html" hreflang="ko" /><updated>2025-09-07T00:24:24+09:00</updated><id>https://sweetlittlebird.github.io/feed.xml</id><title type="html">Sweet Little Bird</title><subtitle>ê³µë¶€ ê¸°ë¡ê³¼ ê°œë°œ ì´ì•¼ê¸°ë¥¼ ë‹´ì€ ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.</subtitle><entry><title type="html">[Cilium] Cilium Security &amp;amp; Tetragon</title><link href="https://sweetlittlebird.github.io/posts/2025-09-07-Cilium-Week8/" rel="alternate" type="text/html" title="[Cilium] Cilium Security &amp;amp; Tetragon" /><published>2025-09-07T00:10:18+09:00</published><updated>2025-09-07T00:10:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/Cilium%20-%20Week8</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2025-09-07-Cilium-Week8/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Ciliumì˜ Securityì™€ eBPF ê¸°ë°˜ì˜ ëŸ°íƒ€ì„ ë³´ì•ˆ ë° ê´€ì°° ë„êµ¬ì¸ Tetragon ëŒ€í•´ ì‹¤ìŠµì„ í†µí•˜ì—¬ ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬">ì‹¤ìŠµí™˜ê²½ ë°°í¬</h2>

<ul>
  <li>ì‹¤ìŠµ í™˜ê²½ ì†Œê°œ
    <ul>
      <li>ì‹¤ìŠµ í™˜ê²½ : k8s(1.33.4), cilium(1.18.1) - ê¸°ë³¸ ë°°í¬ ê°€ìƒ ë¨¸ì‹  : k8s-ctr, k8s-w1, k8s-w2</li>
      <li>ì´ë²ˆ ì‹¤ìŠµì—ëŠ” ì›Œì»¤ ë…¸ë“œê°„ ë³´ì•ˆ ì •ì±…ì„ ì ìš©í•˜ê³  í†µì‹  ì•”í˜¸í™” ë“±ì„ ì‚´í´ë³´ê¸° ìœ„í•´ì„œ ì›Œì»¤ë…¸ë“œë¥¼ 2ê°œ ë‘ëŠ” êµ¬ì„±ì„ í•˜ì˜€ìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì‹¤ìŠµ í™˜ê²½ ë°°í¬</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir </span>cilium-lab <span class="o">&amp;&amp;</span> <span class="nb">cd </span>cilium-lab
<span class="nv">$ </span>curl <span class="nt">-O</span> https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/8w/Vagrantfile
<span class="nv">$ </span>vagrant up
<span class="c"># =&gt; ...</span>
<span class="c">#    ==&gt; k8s-w2: Running provisioner: shell...</span>
<span class="c">#        k8s-w2: Running: /var/folders/7k/qy6rsdds57z3tmyn9_7hhd8r0000gn/T/vagrant-shell20250905-16290-5f5n6v.sh</span>
<span class="c">#        k8s-w2: &gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;</span>
<span class="c">#        k8s-w2: [TASK 1] K8S Controlplane Join</span>
<span class="c">#        k8s-w2: &gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;</span>
<span class="nv">$ </span>vagrant ssh k8s-ctr
</code></pre></div></div>

<hr />

<h2 id="cilium-security-ê³µì‹ë¬¸ì„œ">Cilium Security ê³µì‹ë¬¸ì„œ</h2>

<h3 id="ciliumì´-ì œê³µí•˜ëŠ”-ë³´ì•ˆ-ê°œìš”">Ciliumì´ ì œê³µí•˜ëŠ” ë³´ì•ˆ ê°œìš”</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/security/network/intro/">ê´€ë ¨ë¬¸ì„œ</a></li>
  <li>Ciliumì€ í¬ê²Œ ë‹¤ìŒì˜ ë³´ì•ˆ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
    <ul>
      <li>Identity-Based (Layer3)</li>
      <li>Port Level (Layer4)</li>
      <li>Application protocol Level (Layer7)</li>
    </ul>
  </li>
  <li><strong>Cilium ë³´ì•ˆ ì •ì±…ì˜ íŠ¹ì§•</strong>
    <ul>
      <li><strong>ì •ì±…ì´ ì—†ëŠ” ê²½ìš°</strong>, ê¸°ë³¸ì ìœ¼ë¡œ <strong>ëª¨ë“  íŠ¸ë˜í”½ì´ í—ˆìš©</strong>ë©ë‹ˆë‹¤.</li>
      <li>ì²«ë²ˆì§¸ ì •ì±… <strong>ê·œì¹™ì´ ì ìš©ë˜ë©´</strong>, <strong>í—ˆìš©ëœ íŠ¸ë˜í”½ì„ ì œì™¸í•œ ëª¨ë“  íŠ¸ë˜í”½ì´ ì°¨ë‹¨</strong>ë©ë‹ˆë‹¤.</li>
      <li>ì„¸ì…˜ ê¸°ë°˜ í”„ë¡œí† ì½œì— ëŒ€í•´ <strong>ìƒíƒœì €ì¥ ì •ì±…ì´ ì ìš©</strong>ë˜ë©°, <strong>ì‘ë‹µ íŒ¨í‚·ì€ ìë™ìœ¼ë¡œ í—ˆìš©</strong>ë©ë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/security/network/policyenforcement/#policy-enforcement">ê´€ë ¨ë¬¸ì„œ</a></li>
    </ul>
  </li>
  <li><strong>Envoy Proxy í†µí•©</strong> - <a href="https://docs.cilium.io/en/stable/security/network/proxy/envoy/">Docs</a>
<img src="/assets/2025/cilium/w8/20250907_cilium_w8_2.png" alt="img.png" class="image-center" />
<em class="image-caption"><a href="https://docs.cilium.io/en/stable/security/network/proxy/envoy/">https://docs.cilium.io/en/stable/security/network/proxy/envoy/</a></em>
    <ul>
      <li>Ciliumì€ Envoy Proxyì™€ í†µí•©ë˜ì–´ Layer7 ë³´ì•ˆ ì •ì±…ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>Envoy ProxyëŠ” L7 í”„ë¡ì‹œë¡œì„œ HTTP, gRPC, Kafka ë“±ì˜ í”„ë¡œí† ì½œì„ ì§€ì›í•©ë‹ˆë‹¤.</li>
      <li>Envoy Proxyë¥¼ í†µí•´ ì„¸ë°€í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì˜ ë³´ì•ˆ ì •ì±…ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li><strong>íˆ¬ëª…í•œ ì•”í˜¸í™”</strong> :
IPSec or WireGuard ë¡œ Cilium ê´€ë¦¬í•˜ëŠ” í˜¸ìŠ¤íŠ¸ íŠ¸ë˜í”½ê³¼ ì—”ë“œí¬ì¸íŠ¸ ê°„ íŠ¸ë˜í”½ì˜ íˆ¬ëª…í•œ ì•”í˜¸í™” ì§€ì›í•©ë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/security/network/encryption/">Docs</a> , <a href="https://www.youtube.com/watch?v=vj7M-t9MK6s">Youtube</a>
<img src="/assets/2025/cilium/w8/20250907_cilium_w8_4.png" alt="img.png" />
    <ul>
      <li>ê° ëª¨ë“œì˜ ë‹¨ì 
        <ul>
          <li>IPSec : BPF í˜¸ìŠ¤íŠ¸ ë¼ìš°íŒ…ì—ì„œëŠ” ë¯¸ë™ì‘í•˜ë©°, IPsec í„°ë„ë‹¹ ë‹¨ì¼ CPU ì½”ì–´ë¡œ ì œí•œë©ë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/security/network/encryption-ipsec/">Docs</a></li>
          <li>WireGuard : í„°ë„ ëª¨ë“œ(VXLAN, GENEVE)ì—ì„œëŠ” ë‘ ë²ˆ ìº¡ìŠí™”ë©ë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/security/network/encryption-wireguard/">Docs</a> , <a href="https://www.youtube.com/watch?v=-awkPi3D60E">Youtube</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="identity-ê¸°ë°˜-ë³´ì•ˆ-ì •ì±…---docs">Identity ê¸°ë°˜ ë³´ì•ˆ ì •ì±… - <a href="https://docs.cilium.io/en/stable/gettingstarted/terminology/#identity">Docs</a></h5>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_1.png" alt="img.png" class="image-center w-60" />
<em class="image-caption">Identity <a href="https://docs.cilium.io/en/stable/security/network/identity/">https://docs.cilium.io/en/stable/security/network/identity/</a></em></p>
<ul>
  <li>Ciliumì€ Podì— IPì£¼ì†Œê°€ ì•„ë‹Œ Identityë¥¼ ë¶€ì—¬í•˜ê³  Identityë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë³´ì•ˆ ì •ì±…ì„ ì ìš©í•©ë‹ˆë‹¤.</li>
  <li>IdentityëŠ” Namespace, Labels, ServiceAccount ë“±ì„ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</li>
  <li>Podì˜ IPì£¼ì†ŒëŠ” ë³€ê²½ë  ìˆ˜ ìˆì§€ë§Œ, IdentityëŠ” ë³€ê²½ë˜ê¸° ë•Œë¬¸ì— ë³´ì•ˆ ì •ì±…ì´ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë˜í•œ ë™ì¼í•œ Security Relevant Labelsë¥¼ ê°€ì§„ Podë“¤ì€ ë™ì¼í•œ Identityë¥¼ ê³µìœ í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get ciliumendpoints.cilium.io <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME                              SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    coredns-674b8bbfcf-2njqx          &lt;span style="color: green;"&gt;15719&lt;/span&gt;               ready            172.20.0.37</span>
<span class="c">#    coredns-674b8bbfcf-gwsh5          &lt;span style="color: green;"&gt;15719&lt;/span&gt;               ready            172.20.0.1</span>
<span class="c">#    hubble-relay-fdd49b976-t5sms      64548               ready            172.20.0.102</span>
<span class="c">#    hubble-ui-655f947f96-vjkrg        3186                ready            172.20.0.197</span>
<span class="c">#    metrics-server-5dd7b49d79-rbbwk   883                 ready            172.20.0.166 </span>

<span class="nv">$ </span>kubectl get ciliumidentities.cilium.io 
<span class="c"># =&gt; NAME    NAMESPACE            AGE</span>
<span class="c">#    &lt;span style="color: green;"&gt;15719&lt;/span&gt;   kube-system          57m</span>
<span class="c">#    2887    cilium-monitoring    57m</span>
<span class="c">#    3186    kube-system          57m</span>
<span class="c">#    38953   local-path-storage   57m</span>
<span class="c">#    61576   cilium-monitoring    57m</span>
<span class="c">#    64548   kube-system          57m</span>
<span class="c">#    883     kube-system          57m</span>
</code></pre></div></div>

<ul>
  <li>identity ë¶€ì—¬ ê³¼ì •
    <ul>
      <li>Pod ë˜ëŠ” Containerê°€ ìƒì„±ë˜ë©´, Ciliumì€ ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ë°ˆì—ì„œ ìˆ˜ì§‘í•œ ì´ë²¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ì—ì„œ Pod ë˜ëŠ” Containerë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì—”ë“œí¬ì¸íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
      <li>ì—”ë“œí¬ì¸íŠ¸ì˜ IDëŠ” ì—”ë“œí¬ì¸íŠ¸ì—ì„œ íŒŒìƒëœ Pod ë˜ëŠ” Containerì™€ ì—°ê´€ëœ ë ˆì´ë¸”ì„ ê¸°ë°˜ìœ¼ë¡œ ê²°ì •ë©ë‹ˆë‹¤.</li>
      <li>ë‹¤ìŒ ë‹¨ê³„ë¡œ Ciliumì€ ìƒì„±ëœ ì—”ë“œí¬ì¸íŠ¸ì˜ IDë¥¼ í™•ì¸í•˜ë©°, Pod ë˜ëŠ” Containerì˜ ë ˆì´ë¸”ì´ ë³€ê²½ë˜ë©´ ì—”ë“œí¬ì¸íŠ¸ IDê°€ ì¬í™•ì¸ ë˜ë©° í•„ìš”ì—ë”°ë¼ ë³€ê²½ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h5 id="cilium-identity-ì •ë³´-í™•ì¸-ë°-ë³€ê²½-ì‹¤ìŠµ">Cilium Identity ì •ë³´ í™•ì¸ ë° ë³€ê²½ ì‹¤ìŠµ</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get ciliumidentities.cilium.io 15719 <span class="nt">-o</span> yaml | yq
<span class="c"># =&gt; {</span>
<span class="c">#      "apiVersion": "cilium.io/v2",</span>
<span class="c">#      "kind": "CiliumIdentity",</span>
<span class="c">#      "metadata": {</span>
<span class="c">#        "creationTimestamp": "2025-09-05T14:14:26Z",</span>
<span class="c">#        "generation": 1,</span>
<span class="c">#        "labels": {</span>
<span class="c">#          "io.kubernetes.pod.namespace": "kube-system"</span>
<span class="c">#        },</span>
<span class="c">#        "name": "15719",</span>
<span class="c">#        "resourceVersion": "796",</span>
<span class="c">#        "uid": "e3b7045e-5a91-47fc-abff-0d8f86330dbf"</span>
<span class="c">#      },</span>
<span class="c">#      "security-labels": {</span>
<span class="c">#        "k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name": "kube-system",</span>
<span class="c">#        "k8s:io.cilium.k8s.policy.cluster": "default",</span>
<span class="c">#        "k8s:io.cilium.k8s.policy.serviceaccount": "coredns",</span>
<span class="c">#        "k8s:io.kubernetes.pod.namespace": "kube-system",</span>
<span class="c">#        "k8s:k8s-app": "kube-dns"</span>
<span class="c">#      }</span>
<span class="c">#    }</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium identity list
<span class="c"># =&gt; ...</span>
<span class="c">#    15719   k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system</span>
<span class="c">#            k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#            k8s:io.cilium.k8s.policy.serviceaccount=coredns</span>
<span class="c">#            k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#            k8s:k8s-app=kube-dns</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">--show-labels</span>
<span class="c"># =&gt; NAME                       READY   STATUS    RESTARTS   AGE   LABELS</span>
<span class="c">#    coredns-674b8bbfcf-2njqx   1/1     Running   0          65m   k8s-app=kube-dns,pod-template-hash=674b8bbfcf</span>
<span class="c">#    coredns-674b8bbfcf-gwsh5   1/1     Running   0          65m   k8s-app=kube-dns,pod-template-hash=674b8bbfcf</span>

<span class="c"># ê¸°ë™ ì¤‘ì¸ íŒŒë“œì— label ì¶”ê°€ í›„ cilium id(ë³´ì•ˆ label)ì— ë°˜ì˜ ë ì§€? : ë°˜ì˜ë˜ëŠ”ê°€? ì–¼ë§ˆë‚˜ ì‹œê°„ì´ ê±¸ë¦¬ëŠ”ê°€? IDê°€ ë³€ê²½ë˜ì§€ëŠ” ì•ŠëŠ”ê°€?</span>
<span class="nv">$ </span>kubectl label pods <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nv">study</span><span class="o">=</span>8w
<span class="c"># =&gt; pod/coredns-674b8bbfcf-2njqx labeled</span>
<span class="c">#    pod/coredns-674b8bbfcf-gwsh5 labeled</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium identity list
<span class="c"># =&gt; ...</span>
<span class="c">#    15719   k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system</span>
<span class="c">#            k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#            k8s:io.cilium.k8s.policy.serviceaccount=coredns</span>
<span class="c">#            k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#            k8s:k8s-app=kube-dns</span>
<span class="c">#    &lt;span style="color: green;"&gt;38787   k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.cilium.k8s.policy.cluster=default&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.cilium.k8s.policy.serviceaccount=coredns&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.kubernetes.pod.namespace=kube-system&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:k8s-app=kube-dns&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:study=8w&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ study=8w ë¼ë²¨ì— ëŒ€í•œ ìƒˆë¡œìš´ ID(38787)ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤..&lt;/span&gt;</span>

<span class="c"># (ìœ„ ë‚´ìš© í™•ì¸ í›„ ì•„ë˜ ì§„í–‰) coredns deployment ì— spec.template.metadata.labelsì— ì•„ë˜ ì¶”ê°€ ì‹œ ë°˜ì˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl edit deploy <span class="nt">-n</span> kube-system coredns
<span class="nt">---</span>
...
  template:
    metadata:
      labels:
        app: testing
        k8s-app: kube-dns
...
<span class="nt">---</span>
<span class="c"># =&gt; deployment.apps/coredns edited</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium identity list
<span class="c"># =&gt; ...</span>
<span class="c">#    &lt;span style="color: green;"&gt;30461   k8s:app=testing&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.cilium.k8s.policy.cluster=default&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.cilium.k8s.policy.serviceaccount=coredns&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.kubernetes.pod.namespace=kube-system&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:k8s-app=kube-dns&lt;/span&gt;</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>Ciliumì€ pod update ì´ë²¤íŠ¸ë¥¼ watchí•˜ë¯€ë¡œ, labels ë³€ê²½ ì‹œ endpointê°€ waiting-for-identity ìƒíƒœë¡œ ì „í™˜ë˜ì–´ ìƒˆë¡œìš´ identityë¥¼ í• ë‹¹ë°›ìŠµë‹ˆë‹¤.
ì´ë¡œ ì¸í•´ security labelsì™€ ê´€ë ¨ëœ ë„¤íŠ¸ì›Œí¬ ì •ì±…ë„ ìë™ìœ¼ë¡œ ì¬ì ìš©ë©ë‹ˆë‹¤.</li>
  <li>ì˜ˆì‹œ:
    <ul>
      <li>ê°„ë‹¨í•œ pod(simple-pod)ë¥¼ ìƒì„±í•˜ë©´ ì´ˆê¸° security identity(ì˜ˆ: 26830)ê°€ í• ë‹¹ë©ë‹ˆë‹¤.</li>
      <li>ì´í›„ <code class="language-plaintext highlighter-rouge">kubectl label pod/simple-pod run=not-simple-pod --overwrite</code>ë¡œ labelsë¥¼ ë³€ê²½í•˜ë©´, <code class="language-plaintext highlighter-rouge">kubectl get ciliumendpoints</code> ëª…ë ¹ì—ì„œ identityê°€ ìƒˆ ê°’(ì˜ˆ: 8710)ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” policy enforcementì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ë‹¨, ëŒ€ê·œëª¨ í´ëŸ¬ìŠ¤í„°ì—ì„œ ìì£¼ labelsë¥¼ ë³€ê²½í•˜ë©´ identity í• ë‹¹ì´ ë¹ˆë²ˆí•´ì ¸ ì„±ëŠ¥ ì €í•˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, identity-relevant labelsë¥¼ ì œí•œí•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤</li>
</ul>

<h5 id="special-identities">Special Identities</h5>

<ul>
  <li>Ciliumì—ì„œ ê´€ë¦¬í•˜ëŠ” ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ëŠ” IDê°€ í• ë‹¹ ë©ë‹ˆë‹¤.</li>
  <li>Ciliumì—ì„œ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ì—”ë“œí¬ì¸íŠ¸ì˜ í†µì‹ ì„ í—ˆìš©í•˜ê¸° ìœ„í•´ì„œ íŠ¹ìˆ˜ IDë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>ì˜ˆì•½ëœ íŠ¹ìˆ˜ IDì—ëŠ” <code class="language-plaintext highlighter-rouge">reserved</code>ë¼ëŠ” ì ‘ë‘ì‚¬ê°€ ë¶™ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì˜ˆì•½ëœ íŠ¹ìˆ˜ ID í™•ì¸ </span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium identity list
<span class="c"># =&gt; ID      LABELS</span>
<span class="c">#    1       reserved:host</span>
<span class="c">#            reserved:kube-apiserver</span>
<span class="c">#    2       reserved:world</span>
<span class="c">#    3       reserved:unmanaged</span>
<span class="c">#    4       reserved:health</span>
<span class="c">#    5       reserved:init</span>
<span class="c">#    6       reserved:remote-node</span>
<span class="c">#    7       reserved:kube-apiserver</span>
<span class="c">#            reserved:remote-node</span>
<span class="c">#    8       reserved:ingress</span>
<span class="c">#    9       reserved:world-ipv4</span>
<span class="c">#    10      reserved:world-ipv6</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th><strong>Identity</strong></th>
      <th><strong>ìˆ«ìID</strong></th>
      <th><strong>ì„¤ëª…</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:unknown</code></td>
      <td>0</td>
      <td>IDì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:host</code></td>
      <td>1</td>
      <td>ë¡œì»¬ í˜¸ìŠ¤íŠ¸. ë¡œì»¬ í˜¸ìŠ¤íŠ¸ IP ì¤‘ í•˜ë‚˜ì—ì„œ ì‹œì‘ë˜ê±°ë‚˜ ì§€ì •ëœ ëª¨ë“  íŠ¸ë˜í”½ì…ë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:world</code></td>
      <td>2</td>
      <td>í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì˜ ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ì—”ë“œí¬ì¸íŠ¸</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:unmanaged</code></td>
      <td>3</td>
      <td>Ciliumì—ì„œ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ì—”ë“œí¬ì¸íŠ¸, ì˜ˆë¥¼ ë“¤ì–´ Ciliumì´ ì„¤ì¹˜ë˜ê¸° ì „ì— ì‹œì‘ëœ Kubernetes Podì…ë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:health</code></td>
      <td>4</td>
      <td>Cilium ì—ì´ì „íŠ¸ê°€ ìƒì„±í•œ ìƒíƒœ í™•ì¸ íŠ¸ë˜í”½ì…ë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:init</code></td>
      <td>5</td>
      <td>IDê°€ ì•„ì§ í™•ì¸ë˜ì§€ ì•Šì€ ì—”ë“œí¬ì¸íŠ¸ì—ëŠ” init IDê°€ í• ë‹¹ë©ë‹ˆë‹¤. ì´ëŠ” ë³´ì•ˆ IDë¥¼ ë„ì¶œí•˜ëŠ” ë° í•„ìš”í•œ ì¼ë¶€ ë©”íƒ€ë°ì´í„°ê°€ ì•„ì§ ì—†ëŠ” ì—”ë“œí¬ì¸íŠ¸ ë‹¨ê³„ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì´ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë¶€íŠ¸ìŠ¤íŠ¸ë˜í•‘ ë‹¨ê³„ì—ì„œ ë°œìƒí•©ë‹ˆë‹¤. init IDëŠ” ì—”ë“œí¬ì¸íŠ¸ ìƒì„± ì‹œì ì— ë ˆì´ë¸”ì„ ì•Œ ìˆ˜ ì—†ëŠ” ê²½ìš°ì—ë§Œ í• ë‹¹ë©ë‹ˆë‹¤. Docker í”ŒëŸ¬ê·¸ì¸ì˜ ê²½ìš°ê°€ ì—¬ê¸°ì— í•´ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:remote-node</code></td>
      <td>6</td>
      <td>ëª¨ë“  ì›ê²© í´ëŸ¬ìŠ¤í„° í˜¸ìŠ¤íŠ¸ì˜ ì§‘í•©ì…ë‹ˆë‹¤. ë¡œì»¬ ë…¸ë“œë¥¼ ì œì™¸í•œ ì—°ê²°ëœ í´ëŸ¬ìŠ¤í„° ë‚´ ëª¨ë“  í˜¸ìŠ¤íŠ¸ì˜ IP ì¤‘ í•˜ë‚˜ì—ì„œ ì‹œì‘ë˜ê±°ë‚˜ í•´ë‹¹ IPë¡œ ì§€ì •ëœ ëª¨ë“  íŠ¸ë˜í”½ì…ë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:kube-apiserver</code></td>
      <td>7</td>
      <td>kube-apiserverë¥¼ ì‹¤í–‰í•˜ëŠ” ë°±ì—”ë“œê°€ ìˆëŠ” ì›ê²© ë…¸ë“œì…ë‹ˆë‹¤.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:ingress</code></td>
      <td>8</td>
      <td>Ingress í”„ë¡ì‹œ ì—°ê²°ì— ëŒ€í•œ ì†ŒìŠ¤ ì£¼ì†Œë¡œ ì‚¬ìš©ë˜ëŠ” IPì— ì œê³µë©ë‹ˆë‹¤.</td>
    </tr>
  </tbody>
</table>

<h5 id="í´ëŸ¬ìŠ¤í„°ì—ì„œì˜-identity-ê´€ë¦¬">í´ëŸ¬ìŠ¤í„°ì—ì„œì˜ Identity ê´€ë¦¬</h5>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_5.png" alt="img.png" /></p>

<ul>
  <li>IDëŠ” ì „ì²´ í´ëŸ¬ìŠ¤í„°ì—ì„œ ìœ íš¨í•©ë‹ˆë‹¤.
    <ul>
      <li>ì¦‰, ì—¬ëŸ¬ í´ëŸ¬ìŠ¤í„° ë…¸ë“œì—ì„œ ì—¬ëŸ¬ ê°œì˜ í¬ë“œ ë˜ëŠ” ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë˜ë”ë¼ë„ ID ê´€ë ¨ ë ˆì´ë¸”ì„ ê³µìœ í•˜ëŠ” ê²½ìš° ëª¨ë“  í¬ë“œ ë˜ëŠ” ì»¨í…Œì´ë„ˆê°€ ë‹¨ì¼ IDë¥¼ ê³µìœ í•©ë‹ˆë‹¤.</li>
      <li>ì´ë¥¼ ìœ„í•´ì„œëŠ” í´ëŸ¬ìŠ¤í„° ë…¸ë“œ ê°„ì˜ ì¡°ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì—”ë“œí¬ì¸íŠ¸ IDë¥¼ í™•ì¸í•˜ëŠ” ì‘ì—…ì€ <strong>ë¶„ì‚° í‚¤-ê°’ ì €ì¥ì†Œ</strong>ë¥¼ í†µí•´ ìˆ˜í–‰ë©ë‹ˆë‹¤.</li>
  <li>ë¶„ì‚° í‚¤-ê°’ ì €ì¥ì†ŒëŠ” <em>ë‹¤ìŒ ê°’ì´ ì´ì „ì— í™•ì¸ë˜ì§€ ì•Šì€ ê²½ìš° ìƒˆë¡œìš´ ê³ ìœ  ì‹ë³„ìë¥¼ ìƒì„±í•˜ëŠ”</em> í˜•íƒœì˜ ì›ìì  ì—°ì‚°ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ í†µí•´ ê° í´ëŸ¬ìŠ¤í„° ë…¸ë“œëŠ” ID ê´€ë ¨ ë ˆì´ë¸” í•˜ìœ„ ì§‘í•©ì„ ìƒì„±í•œ ë‹¤ìŒ í‚¤-ê°’ ì €ì¥ì†Œë¥¼ ì¿¼ë¦¬í•˜ì—¬ IDë¥¼ ë„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë ˆì´ë¸” ì§‘í•©ì´ ì´ì „ì— ì¿¼ë¦¬ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ì— ë”°ë¼ ìƒˆ IDê°€ ìƒì„±ë˜ê±°ë‚˜ ì´ˆê¸° ì¿¼ë¦¬ì˜ IDê°€ ë°˜í™˜ë©ë‹ˆë‹¤.</li>
</ul>

<h5 id="networkpolicy--3ê°€ì§€-í˜•ì‹-ì œê³µ---docs">NetworkPolicy : 3ê°€ì§€ í˜•ì‹ ì œê³µ - <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/">Docs</a></h5>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_6.png" alt="img.png" class="image-center" />
<em class="image-caption"><a href="https://isovalent.com/blog/post/intro-to-cilium-network-policies/">https://isovalent.com/blog/post/intro-to-cilium-network-policies/</a></em></p>

<ul>
  <li><strong>í‘œì¤€ Network Policy</strong> : Podì˜ ingress ë˜ëŠ” egress ì‹œ L3 ë° L4 ì •ì±…ì„ ì§€ì›í•˜ëŠ” <strong>í‘œì¤€</strong> <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#networkpolicy">NetworkPolicy ë¦¬ì†ŒìŠ¤ì…ë‹ˆë‹¤.</a></li>
  <li><strong>í™•ì¥ CiliumNetworkPolicy</strong> : <strong>3~7 ê³„ì¸µ</strong>ì—ì„œ <strong>ìˆ˜ì‹ </strong> ë° <strong>ì†¡ì‹ </strong> ëª¨ë‘ì— ëŒ€í•œ ì •ì±… ì§€ì •ì„ ì§€ì›í•˜ëŠ” <a href="https://docs.cilium.io/en/stable/glossary/#term-CustomResourceDefinition">CustomResourceDefinition</a> ìœ¼ë¡œ ì œê³µë˜ëŠ” í™•ì¥ëœ <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#ciliumnetworkpolicy">CiliumNetworkPolicy í˜•ì‹ì…ë‹ˆë‹¤.</a></li>
  <li><strong>CiliumClusterwideNetworkPolicy</strong> : <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#ciliumclusterwidenetworkpolicy">CiliumClusterwideNetworkPolicy</a> í˜•ì‹ ì€ Ciliumì—ì„œ ì ìš©í•  <strong>í´ëŸ¬ìŠ¤í„° ì „ì²´ ì •ì±…ì„ ì§€ì •</strong>í•˜ëŠ” í´ëŸ¬ìŠ¤í„° ë²”ìœ„ <a href="https://docs.cilium.io/en/stable/glossary/#term-CustomResourceDefinition">CustomResourceDefinition</a> ì…ë‹ˆë‹¤. ì´ ì‚¬ì–‘ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì§€ì •ë˜ì§€ ì•Šì€ <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#ciliumnetworkpolicy">CiliumNetworkPolicy</a> ì™€ ë™ì¼í•©ë‹ˆë‹¤ .</li>
</ul>

<h5 id="policy-enforcement-modes-by-cilium-network-policy---docs">Policy Enforcement Modes by Cilium Network Policy - <a href="https://docs.cilium.io/en/stable/security/policy/intro/">Docs</a></h5>

<ul>
  <li><strong>Policy Enforcement Modes</strong>
    <ul>
      <li><strong>default</strong> : ì •ì±…ì´ ì—†ëŠ” ê²½ìš° ëª¨ë“  íŠ¸ë˜í”½ì´ í—ˆìš©ë©ë‹ˆë‹¤. ì •ì±…ì´ ì ìš©ë˜ë©´ í—ˆìš©ëœ íŠ¸ë˜í”½ì„ ì œì™¸í•œ ëª¨ë“  íŠ¸ë˜í”½ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.</li>
      <li><strong>always</strong> : ì •ì±…ì´ ì—†ëŠ” ê²½ìš° ëª¨ë“  íŠ¸ë˜í”½ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤. ì •ì±…ì´ ì ìš©ë˜ë©´ í—ˆìš©ëœ íŠ¸ë˜í”½ì„ ì œì™¸í•œ ëª¨ë“  íŠ¸ë˜í”½ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.</li>
      <li><strong>never</strong> : ì •ì±…ì´ ì—†ëŠ” ê²½ìš° ëª¨ë“  íŠ¸ë˜í”½ì´ í—ˆìš©ë©ë‹ˆë‹¤. ì •ì±…ì´ ì ìš©ë˜ë”ë¼ë„ ëª¨ë“  íŠ¸ë˜í”½ì´ í—ˆìš©ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li><strong>Endpoint default policy</strong>
    <ul>
      <li><strong>ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•´ ëª¨ë“  ì†¡ì‹  ë° ìˆ˜ì‹  íŠ¸ë˜í”½ì´ í—ˆìš©ë©ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì •ì±…ì— ë”°ë¼ ì—”ë“œí¬ì¸íŠ¸ê°€ ì„ íƒë˜ë©´ ëª…ì‹œì ìœ¼ë¡œ í—ˆìš©ëœ</strong> íŠ¸ë˜í”½ ë§Œ í—ˆìš©ë˜ëŠ” ê¸°ë³¸ ê±°ë¶€ ìƒíƒœë¡œ ì „í™˜ë©ë‹ˆë‹¤ . ì´ ìƒíƒœëŠ” ë°©í–¥ë³„ë¡œ ì ìš©ë©ë‹ˆë‹¤.
        <ul>
          <li>ê·œì¹™ì´ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì„ íƒ í•˜ê³  í•´ë‹¹ ê·œì¹™ì— ìˆ˜ì‹  ì„¹ì…˜ì´ ìˆëŠ” ê²½ìš°, ì—”ë“œí¬ì¸íŠ¸ëŠ” ìˆ˜ì‹ ì— ëŒ€í•´ ê¸°ë³¸ ê±°ë¶€ ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.</li>
          <li>ê·œì¹™ì´ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì„ íƒ í•˜ê³  ê·œì¹™ì— ì†¡ì‹  ì„¹ì…˜ì´ ìˆëŠ” ê²½ìš°, ì—”ë“œí¬ì¸íŠ¸ëŠ” ì†¡ì‹ ì— ëŒ€í•´ ê¸°ë³¸ ê±°ë¶€ ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">EnableDefaultDeny</code> <a href="https://docs.cilium.io/en/stable/security/policy/language/#l7-policy">7ê³„ì¸µ ì •ì±…</a> ì—ëŠ” ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        <ul>
          <li>7ê³„ì¸µ ëª¨ë‘ í—ˆìš©ì´ í¬í•¨ë˜ì§€ ì•Šì€ 7ê³„ì¸µ ê·œì¹™ì„ ì¶”ê°€í•˜ë©´ default-denyê°€ ëª…ì‹œì ìœ¼ë¡œ ë¹„í™œì„±í™”ëœ ê²½ìš°ì—ë„ ì‚­ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Rule Basics</strong>
    <ul>
      <li><strong>endpointSelector / nodeSelector</strong> : 
ì •ì±… ê·œì¹™ì´ ì ìš©ë  ì—”ë“œí¬ì¸íŠ¸ ë˜ëŠ” ë…¸ë“œë¥¼ ì„ íƒí•©ë‹ˆë‹¤. ì •ì±… ê·œì¹™ì€ ì„ íƒê¸°ì— ì§€ì •ëœ ë ˆì´ë¸”ê³¼ ì¼ì¹˜í•˜ëŠ” ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— ì ìš©ë©ë‹ˆë‹¤.</li>
      <li><strong>ingress</strong> : 
ì—”ë“œí¬ì¸íŠ¸ì˜ ìœ ì… ì‹œ, ì¦‰ ì—”ë“œí¬ì¸íŠ¸ì— ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì— ì ìš©í•´ì•¼ í•˜ëŠ” ê·œì¹™ ëª©ë¡ì…ë‹ˆë‹¤.</li>
      <li><strong>egress</strong> : 
ì—”ë“œí¬ì¸íŠ¸ì˜ ì¶œêµ¬ì—ì„œ ì ìš©ë˜ì–´ì•¼ í•˜ëŠ” ê·œì¹™ ëª©ë¡, ì¦‰ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë– ë‚˜ëŠ” ëª¨ë“  ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì— ì ìš©ë˜ì–´ì•¼ í•˜ëŠ” ê·œì¹™ ëª©ë¡ì…ë‹ˆë‹¤.</li>
      <li><strong>labels</strong> :
ë ˆì´ë¸”ì€ ê·œì¹™ì„ ì‹ë³„í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ë ˆì´ë¸”ì„ ì‚¬ìš©í•˜ì—¬ ê·œì¹™ì„ ë‚˜ì—´í•˜ê³  ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Kubernetesë¥¼
í†µí•´ ê°€ì ¸ì˜¨ ì •ì±… ê·œì¹™ì—ëŠ” <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#networkpolicy">NetworkPolicy</a> 
ë˜ëŠ” <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#ciliumnetworkpolicy">CiliumNetworkPolicy</a> ë¦¬ì†ŒìŠ¤ì— 
ì§€ì •ëœ ì´ë¦„ì— í•´ë‹¹í•˜ëŠ” ë ˆì´ë¸”ì´ ìë™ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">io.cilium.k8s.policy.name=NAME</code>ì§€ì •ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h5 id="cilium-endpoint-lifecycle---docs">Cilium Endpoint Lifecycle - <a href="https://docs.cilium.io/en/stable/security/policy/lifecycle/">Docs</a></h5>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_7.png" alt="img.png" class="image-center" />
  <em class="image-caption"><a href="https://docs.cilium.io/en/stable/security/policy/lifecycle/">https://docs.cilium.io/en/stable/security/policy/lifecycle/</a></em></p>

<ul>
  <li><strong>restoring</strong> : Ciliumì´ ì‹œì‘ë˜ê¸° ì „ì— ì—”ë“œí¬ì¸íŠ¸ê°€ ì‹œì‘ë˜ì—ˆìœ¼ë©° Ciliumì´ ë„¤íŠ¸ì›Œí‚¹ êµ¬ì„±ì„ ë³µì›í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>waiting-for-identity</strong> : Ciliumì´ ì—”ë“œí¬ì¸íŠ¸ì— ê³ ìœ í•œ IDë¥¼ í• ë‹¹í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>waiting-to-regenerate</strong> : ì—”ë“œí¬ì¸íŠ¸ê°€ IDë¥¼ ìˆ˜ì‹ í–ˆìœ¼ë©° ë„¤íŠ¸ì›Œí‚¹ êµ¬ì„±ì´ ë‹¤ì‹œ ìƒì„±ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>regenerating</strong> : ì—”ë“œí¬ì¸íŠ¸ì˜ ë„¤íŠ¸ì›Œí‚¹ êµ¬ì„±ì´ ì¬ìƒì„±ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì—ëŠ” í•´ë‹¹ ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ eBPF í”„ë¡œê·¸ë˜ë°ì´ í¬í•¨ë©ë‹ˆë‹¤.</li>
  <li><strong>ready</strong> : ì—”ë“œí¬ì¸íŠ¸ì˜ ë„¤íŠ¸ì›Œí‚¹ êµ¬ì„±ì´ ì„±ê³µì ìœ¼ë¡œ ë‹¤ì‹œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li><strong>disconnecting</strong> : ì—”ë“œí¬ì¸íŠ¸ê°€ ì‚­ì œë˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>disconnected</strong> : ì—”ë“œí¬ì¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="ê¸°íƒ€-ì •ë³´">ê¸°íƒ€ ì •ë³´</h5>

<ul>
  <li><strong>ì •ì±… ì—ë””í„° ì˜¨ë¼ì¸ ì‚¬ì´íŠ¸</strong> : <a href="https://editor.networkpolicy.io/">https://editor.networkpolicy.io/</a>, 
<a href="https://isovalent.com/blog/post/tutorial-network-policy-editor/">https://isovalent.com/blog/post/tutorial-network-policy-editor/</a></li>
  <li><strong>Identity Management Mode</strong> : <a href="https://docs.cilium.io/en/stable/network/kubernetes/identity-management-mode/">Docs</a></li>
  <li><strong>Using Kubernetes Constructs In Policy</strong> : ì •ì±…ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ í™œìš© - <a href="https://docs.cilium.io/en/stable/security/policy/kubernetes/">Docs</a></li>
  <li><strong>Network Policy Troubleshooting</strong> - <a href="https://docs.cilium.io/en/stable/security/policy/troubleshooting/">Docs</a> &amp; <strong>Caveats</strong> - <a href="https://docs.cilium.io/en/stable/security/policy/caveats/">Docs</a></li>
  <li><strong>Threat Model</strong> : <a href="https://docs.cilium.io/en/stable/security/threat-model/">Docs</a></li>
  <li><strong>Tutorial: Cilium Network Policy in Practice (Part 2)</strong> : <a href="https://isovalent.com/blog/post/tutorial-cilium-network-policy/">Blog</a></li>
</ul>

<hr />

<h2 id="cilium-security-ì‹¤ìŠµ">Cilium Security ì‹¤ìŠµ</h2>

<h3 id="-lab1-locking-down-external-access-with-dns-based-policies">ğŸ”¬ Lab1. Locking Down External Access with DNS-Based Policies</h3>

<ul>
  <li>DNS ê¸°ë°˜ ë³´ì•ˆ ì •ì±… - <a href="https://docs.cilium.io/en/stable/security/dns/">Docs</a>
    <ul>
      <li>CIDR ë˜ëŠ” IP ê¸°ë°˜ ì •ì±…ì€ ì™¸ë¶€ ì„œë¹„ìŠ¤ì™€ ì—°ê²°ëœ IPê°€ ìì£¼ ë³€ê²½ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê´€ë¦¬ê°€ ì–´ë µê³  ë²ˆê±°ë¡­ìŠµë‹ˆë‹¤.</li>
      <li>Ciliumì˜ DNS ê¸°ë°˜ ì •ì±…ì€ DNS-IP ë§¤í•‘ ì¶”ì ê³¼ ê°™ì€ ë³µì¡í•œ ì¸¡ë©´ì„ ê´€ë¦¬í•˜ëŠ” ë™ì‹œì— ì•¡ì„¸ìŠ¤ ì œì–´ë¥¼ ì‰½ê²Œ ì§€ì •í•  ìˆ˜ ìˆëŠ” ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
      <li>ì´ ê°€ì´ë“œì—ì„œëŠ” ë‹¤ìŒ ì‚¬í•­ì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤.
        <ul>
          <li>DNS ê¸°ë°˜ ì •ì±…ì„ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì´íƒˆ ì•¡ì„¸ìŠ¤ ì œì–´</li>
          <li>íŒ¨í„´(ë˜ëŠ” ì™€ì¼ë“œì¹´ë“œ)ì„ ì‚¬ìš©í•˜ì—¬ DNS ë„ë©”ì¸ í•˜ìœ„ ì§‘í•©ì„ í—ˆìš© ëª©ë¡ì— ì¶”ê°€</li>
          <li>ì™¸ë¶€ ì„œë¹„ìŠ¤ ì ‘ê·¼ ì œí•œì„ ìœ„í•œ DNS, í¬íŠ¸ ë° L7 ê·œì¹™ ê²°í•©</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="ë°ëª¨-ì• í”Œë¦¬ì¼€ì´ì…˜-ë°°í¬">ë°ëª¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</h5>

<ul>
  <li>Empireì˜ mediabot podê°€ Empireì˜ git ì €ì¥ì†Œ ê´€ë¦¬ë¥¼ ìœ„í•´ GitHubì— ì ‘ê·¼í•´ì•¼ í•˜ëŠ” ê°„ë‹¨í•œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.</li>
  <li>podëŠ” ë‹¤ë¥¸ ì™¸ë¶€ ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ì—†ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># hubble ui ì— pod name í‘œê¸°ë¥¼ ìœ„í•´ app labels ì¶”ê°€ &gt;&gt; ë¹¼ê³  ë°°í¬í•´ë³´ê³  ì°¨ì´ì ì„ í™•ì¸í•´ë³´ì.</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; dns-sw-app.yaml
apiVersion: v1
kind: Pod
metadata:
  name: mediabot
  labels:
    org: empire
    class: mediabot
    app: mediabot
spec:
  containers:
  - name: mediabot
    image: quay.io/cilium/json-mock:v1.3.8@sha256:5aad04835eda9025fe4561ad31be77fd55309af8158ca8663a72f6abb78c2603
</span><span class="no">EOF
  
</span><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> dns-sw-app.yaml
<span class="c"># =&gt; pod/mediabot created</span>
<span class="nv">$ </span>kubectl <span class="nb">wait </span>pod/mediabot <span class="nt">--for</span><span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready
<span class="c"># =&gt; pod/mediabot condition met</span>
  
<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium identity list
<span class="c"># =&gt; ...</span>
<span class="c">#    23762   k8s:app=mediabot</span>
<span class="c">#            k8s:class=mediabot</span>
<span class="c">#            k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default</span>
<span class="c">#            k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#            k8s:io.cilium.k8s.policy.serviceaccount=default</span>
<span class="c">#            k8s:io.kubernetes.pod.namespace=default</span>
<span class="c">#            k8s:org=empire</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get pods
<span class="c"># =&gt; NAME       READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    mediabot   1/1     Running   0          86s</span>
  
<span class="c"># ì™¸ë¶€ í†µì‹  í™•ì¸ : hubble ui ì—ì„œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://api.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 https://support.github.com | <span class="nb">head</span> <span class="nt">-1</span> 
<span class="c"># =&gt; HTTP/2 302</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_8.png" alt="img.png" class="image-center w-80" /></p>

<h5 id="dns-egress-ì •ì±…-ì ìš©--1--mediabotí¬ë“œê°€-apigithubcomì—ë§Œ-ì•¡ì„¸ìŠ¤í•˜ë„ë¡-í—ˆìš©">DNS Egress ì •ì±… ì ìš©  1 : <code class="language-plaintext highlighter-rouge">mediabot</code>í¬ë“œê°€ <code class="language-plaintext highlighter-rouge">api.github.com</code>ì—ë§Œ ì•¡ì„¸ìŠ¤í•˜ë„ë¡ í—ˆìš©</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "fqdn"
spec:
  endpointSelector:
    matchLabels:
      org: empire
      class: mediabot
  egress:
  - toFQDNs:
    - matchName: "api.github.com"
  - toEndpoints:
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": kube-system
        "k8s:k8s-app": kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: ANY
      rules:
        dns:
        - matchPattern: "*"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/fqdn created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME   AGE   VALID</span>
<span class="c">#    fqdn   11s   True</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium policy selectors 
<span class="c"># =&gt; SELECTOR                                                                                                                                                                      LABELS         USERS   IDENTITIES</span>
<span class="c">#    &amp;LabelSelector{MatchLabels:map[string]string{any.class: mediabot,any.org: empire,k8s.io.kubernetes.pod.namespace: default,},MatchExpressions:[]LabelSelectorRequirement{},}   default/fqdn   1       23762 </span>

<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> dns
<span class="c"># =&gt; dnsproxy-enable-transparent-mode                  true</span>
<span class="c">#    dnsproxy-socket-linger-timeout                    10</span>
<span class="c">#    hubble-metrics                                    dns drop tcp flow port-distribution icmp httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction</span>
<span class="c">#    tofqdns-dns-reject-response-code                  refused</span>
<span class="c">#    tofqdns-enable-dns-compression                    true</span>
<span class="c">#    tofqdns-endpoint-max-ip-per-hostname              1000</span>
<span class="c">#    tofqdns-idle-connection-grace-period              0s</span>
<span class="c">#    tofqdns-max-deferred-connection-deletes           10000</span>
<span class="c">#    tofqdns-preallocate-identities                    true</span>
<span class="c">#    tofqdns-proxy-response-max-delay                  100ms</span>

<span class="c"># ì™¸ë¶€ í†µì‹  í™•ì¸ : hubble ui ì—ì„œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://api.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 https://support.github.com | <span class="nb">head</span> <span class="nt">-1</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_9.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">api.github.comìœ¼ë¡œë§Œ ì ‘ì†ì´ í—ˆìš©ëœ ìƒíƒœ</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c"># cilium-agent ë‚´ì— go ë¡œ êµ¬í˜„ëœ lightweight proxy ê°€ DNS ì¿¼ë¦¬/ì‘ë‹µ ê°ì‹œì™€ ~~ìºì‹± ì²˜ë¦¬~~ : ê¸°ë³¸ 30ì´ˆ?</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; â„¹ï¸   Hubble Relay is available at 127.0.0.1:4245</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> mediabot
<span class="c"># =&gt; ...</span>
<span class="c">#    Sep  6 07:57:02.807: default/mediabot:59702 (ID:23762) &lt;- kube-system/coredns-674b8bbfcf-hcdsq:53 (ID:41039) dns-response proxy FORWARDED (DNS Answer "20.200.245.245" TTL: 30 (Proxy api.github.com. A))</span>
<span class="c">#    ...</span>
<span class="c">#    Sep  6 07:57:02.809: default/mediabot:59458 (ID:23762) -&gt; api.github.com:443 (ID:16777217) policy-verdict:L3-Only EGRESS ALLOWED (TCP Flags: SYN)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ api.github.com ìœ¼ë¡œì˜ ì ‘ì†ì€ í—ˆìš©ë¨&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c">#    Sep  6 07:48:26.004: default/mediabot:43181 (ID:23762) &lt;- kube-system/coredns-674b8bbfcf-nxkpb:53 (ID:41039) dns-response proxy FORWARDED (DNS Answer  TTL: 4294967295 (Proxy support.github.com. AAAA))</span>
<span class="c">#    ...</span>
<span class="c">#    Sep  6 07:48:26.025: default/mediabot:34138 (ID:23762) &lt;&gt; support.github.com:443 (world) policy-verdict:none EGRESS DENIED (TCP Flags: SYN)</span>
<span class="c"># &lt;span style="color: red;"&gt;ğŸ‘‰ support.github.com ìœ¼ë¡œì˜ ì ‘ì†ì€ ì°¨ë‹¨ë¨&lt;/span&gt;</span>
<span class="c">#    ...</span>

<span class="c"># (ì˜µì…˜) coredns ë¡œê·¸ë¡œ ì§ì ‘ í™•ì¸í•´ë³´ê¸°</span>
<span class="c"># k9s -&gt; configmap (coredns) : log ì¶”ê°€</span>

<span class="c">## ë¡œê¹… í™œì„±í™”</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">-f</span>
<span class="c"># =&gt; [INFO] 172.20.1.42:46910 - 17176 "A IN api.github.com.default.svc.cluster.local. udp 58 false 512" NXDOMAIN qr,aa,rd 151 0.001380815s</span>
<span class="c">#    [INFO] 172.20.1.42:46910 - 10271 "AAAA IN api.github.com.default.svc.cluster.local. udp 58 false 512" NXDOMAIN qr,aa,rd 151 0.000691012s</span>
<span class="c">#    [INFO] 172.20.1.42:59040 - 34206 "A IN api.github.com.svc.cluster.local. udp 50 false 512" NXDOMAIN qr,aa,rd 143 0.001186301s</span>
<span class="c">#    [INFO] 172.20.1.42:59040 - 38304 "AAAA IN api.github.com.svc.cluster.local. udp 50 false 512" NXDOMAIN qr,aa,rd 143 0.001266842s</span>
<span class="c">#    [INFO] 172.20.1.42:47633 - 16595 "AAAA IN api.github.com.cluster.local. udp 46 false 512" NXDOMAIN qr,aa,rd 139 0.007288392s</span>
<span class="c">#    [INFO] 172.20.1.42:47633 - 42706 "A IN api.github.com.cluster.local. udp 46 false 512" NXDOMAIN qr,aa,rd 139 0.032957929s</span>
<span class="c">#    [INFO] 172.20.1.42:48160 - 48028 "AAAA IN api.github.com. udp 32 false 512" NOERROR qr,rd,ra 116 0.046812603s</span>
<span class="c">#    [INFO] 172.20.1.42:48160 - 49818 "A IN api.github.com. udp 32 false 512" NOERROR qr,rd,ra 62 0.043482105s</span>
<span class="c">#    ...</span>

<span class="c">## í˜¸ì¶œ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://api.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://api.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> mediabot
<span class="c"># =&gt; Sep  6 08:01:46.195: default/mediabot:39968 (ID:23762) -&gt; kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) to-endpoint FORWARDED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.197: default/mediabot:39968 (ID:23762) &lt;&gt; kube-system/coredns-6c95f59f49-fgbmq (ID:41039) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.198: default/mediabot:39968 (ID:23762) &lt;- kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) to-network FORWARDED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.198: default/mediabot:39968 (ID:23762) &lt;&gt; kube-system/coredns-6c95f59f49-fgbmq (ID:41039) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.228: default/mediabot:49139 (ID:23762) -&gt; kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) to-endpoint FORWARDED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.230: default/mediabot:49139 (ID:23762) &lt;&gt; kube-system/coredns-6c95f59f49-fgbmq (ID:41039) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.238: default/mediabot:49139 (ID:23762) &lt;&gt; kube-system/coredns-6c95f59f49-fgbmq (ID:41039) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.238: default/mediabot:49139 (ID:23762) &lt;- kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) to-network FORWARDED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.409: default/mediabot:49139 (ID:23762) &lt;- kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) dns-response proxy FORWARDED (DNS Answer  TTL: 4294967295 (Proxy api.github.com. AAAA))</span>
<span class="c">#    Sep  6 08:01:46.410: default/mediabot:49139 (ID:23762) &lt;- kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) dns-response proxy FORWARDED (DNS Answer "20.200.245.245" TTL: 1 (Proxy api.github.com. A))</span>
<span class="c">#    Sep  6 08:01:46.410: kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) &lt;&gt; default/mediabot (ID:23762) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.410: kube-system/kube-dns:53 (world) &lt;&gt; default/mediabot (ID:23762) post-xlate-rev TRANSLATED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.410: kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) &lt;&gt; default/mediabot (ID:23762) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.410: kube-system/kube-dns:53 (world) &lt;&gt; default/mediabot (ID:23762) post-xlate-rev TRANSLATED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.412: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) policy-verdict:L3-Only EGRESS ALLOWED (TCP Flags: SYN)</span>
<span class="c">#    Sep  6 08:01:46.412: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Sep  6 08:01:46.421: default/mediabot:46244 (ID:23762) &lt;- api.github.com:443 (ID:16777217) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Sep  6 08:01:46.422: api.github.com:443 (ID:16777217) &lt;&gt; default/mediabot (ID:23762) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Sep  6 08:01:46.422: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Sep  6 08:01:46.424: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Sep  6 08:01:46.433: default/mediabot:46244 (ID:23762) &lt;- api.github.com:443 (ID:16777217) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Sep  6 08:01:46.464: api.github.com:443 (ID:16777217) &lt;&gt; default/mediabot (ID:23762) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Sep  6 08:01:46.465: api.github.com:443 (ID:16777217) &lt;&gt; default/mediabot (ID:23762) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Sep  6 08:01:46.685: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Sep  6 08:01:46.703: default/mediabot:46244 (ID:23762) &lt;- api.github.com:443 (ID:16777217) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Sep  6 08:01:46.703: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: RST)</span>
<span class="c">#    Sep  6 08:01:46.703: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: RST)</span>
<span class="c">#    Sep  6 08:01:46.705: default/mediabot:46244 (ID:23762) &lt;- api.github.com:443 (ID:16777217) to-endpoint FORWARDED (TCP Flags: ACK, RST)</span>

<span class="c">## cilium íŒŒë“œ ì´ë¦„</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-ctr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w2  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CILIUMPOD0</span> <span class="nv">$CILIUMPOD1</span> <span class="nv">$CILIUMPOD2</span>
<span class="c"># =&gt; cilium-p8r4t cilium-vrh7l cilium-rmd6z</span>

<span class="c">## ë‹¨ì¶•í‚¤(alias) ì§€ì •</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>

<span class="c">##</span>
<span class="nv">$ </span>c0 fqdn cache list
<span class="c"># =&gt; Endpoint   Source   FQDN   TTL   ExpirationTime   IPs</span>
<span class="nv">$ </span>c1 fqdn cache list
<span class="c"># =&gt; Endpoint   Source       FQDN                  TTL   ExpirationTime             IPs</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.108.133</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.110.133</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.109.133</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.111.133</span>
<span class="c">#    1039       connection   api.github.com.       0     2025-09-06T08:26:39.259Z   20.200.245.245</span>
<span class="nv">$ </span>c2 fqdn cache list
<span class="c"># =&gt; Endpoint   Source   FQDN   TTL   ExpirationTime   IPs</span>

<span class="nv">$ </span>c0 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": []</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c1 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": [</span>
<span class="c">#        {</span>
<span class="c">#          "regexString": "^api[.]github[.]com[.]$",</span>
<span class="c">#          "selectorString": "MatchName: api.github.com, MatchPattern: "</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c2 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": []</span>
<span class="c">#    }</span>
</code></pre></div></div>

<ul>
  <li>cilium-agent ë‚´ì— go ë¡œ êµ¬í˜„ëœ lightweight proxy ê°€ DNS ì¿¼ë¦¬/ì‘ë‹µ ê°ì‹œì™€ <del>ìºì‹± ì²˜ë¦¬</del> - <a href="https://github.com/cilium/cilium/blob/main/pkg/fqdn/dnsproxy/proxy.go">Code</a></li>
</ul>

<h5 id="dns-egress-ì •ì±…-ì ìš©--2--ëª¨ë“ -github-í•˜ìœ„-ë„ë©”ì¸ì˜ˆ-íŒ¨í„´ì—-ì•¡ì„¸ìŠ¤">DNS Egress ì •ì±… ì ìš©  2 : ëª¨ë“  GitHub í•˜ìœ„ ë„ë©”ì¸(ì˜ˆ: íŒ¨í„´)ì— ì•¡ì„¸ìŠ¤.</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># fqdn ìºì‹œ ì´ˆê¸°í™” ë° ì •ì±… ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete cnp fqdn
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io "fqdn" deleted</span>
<span class="nv">$ </span>c1 fqdn cache clean <span class="nt">-f</span>
<span class="c"># =&gt; FQDN proxy cache cleared</span>
<span class="nv">$ </span>c2 fqdn cache clean <span class="nt">-f</span>
<span class="c"># =&gt; FQDN proxy cache cleared</span>

<span class="c"># dns-pattern.yaml ë‚´ìš©</span>
apiVersion: <span class="s2">"cilium.io/v2"</span>
kind: CiliumNetworkPolicy
metadata:
  name: <span class="s2">"fqdn"</span>
spec:
  endpointSelector:
    matchLabels:
      org: empire
      class: mediabot
  egress:
  - toFQDNs:
    - matchName: <span class="s2">"*.github.com"</span>
  - toEndpoints:
    - matchLabels:
        <span class="s2">"k8s:io.kubernetes.pod.namespace"</span>: kube-system
        <span class="s2">"k8s:k8s-app"</span>: kube-dns
    toPorts:
    - ports:
      - port: <span class="s2">"53"</span>
        protocol: ANY
      rules:
        dns:
        - matchPattern: <span class="s2">"*"</span>

<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes-dns/dns-pattern.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/fqdn created</span>
<span class="nv">$ </span>c1 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": [</span>
<span class="c">#        {</span>
<span class="c">#          "regexString": "^[-a-zA-Z0-9_]*[.]github[.]com[.]$",</span>
<span class="c">#          "selectorString": "MatchName: , MatchPattern: *.github.com"</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c2 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": []</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c1 fqdn cache list
<span class="c"># =&gt; Endpoint   Source   FQDN   TTL   ExpirationTime   IPs</span>
<span class="nv">$ </span>c2 fqdn cache list
<span class="c"># =&gt; Endpoint   Source   FQDN   TTL   ExpirationTime   IPs</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME   AGE   VALID</span>
<span class="c">#    fqdn   59s   True</span>

<span class="c"># ì™¸ë¶€ í†µì‹  í™•ì¸ : hubble ui ì—ì„œ í™•ì¸ &gt;&gt; github.com ì€ ê³µì‹ ë¬¸ì„œ ì„¤ëª…ëŒ€ë¡œë¼ë©´ ì•ˆë˜ì•¼ë¨..</span>
<span class="c">##  It is important to note and test that this doesnâ€™t allow access to github.com because the *. </span>
<span class="c">## in the pattern requires one subdomain to be present in the DNS name</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://support.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 302</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://gist.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 302</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 https://github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 https://cilium.io| <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; command terminated with exit code 28</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ *.github.com ìœ¼ë¡œì˜ ì ‘ì†ë§Œ í—ˆìš©ë˜ê¸° ë•Œë¬¸ì— cilium.io ì ‘ì†ì€ ì°¨ë‹¨ë¨&lt;/span&gt;</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_10.png" alt="img.png" class="image-center" /></p>

<h5 id="dns-egress-ì •ì±…-ì ìš©--3--dns-port-ì¡°í•©-ì ìš©">DNS Egress ì •ì±… ì ìš©  3 : DNS, Port ì¡°í•© ì ìš©</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># dns-port.yaml ë‚´ìš©</span>
apiVersion: <span class="s2">"cilium.io/v2"</span>
kind: CiliumNetworkPolicy
metadata:
  name: <span class="s2">"fqdn"</span>
spec:
  endpointSelector:
    matchLabels:
      org: empire
      class: mediabot
  egress:
  - toFQDNs:
    - matchPattern: <span class="s2">"*.github.com"</span>
    toPorts:
    - ports:
      - port: <span class="s2">"443"</span>
        protocol: TCP
  - toEndpoints:
    - matchLabels:
        <span class="s2">"k8s:io.kubernetes.pod.namespace"</span>: kube-system
        <span class="s2">"k8s:k8s-app"</span>: kube-dns
    toPorts:
    - ports:
      - port: <span class="s2">"53"</span>
        protocol: ANY
      rules:
        dns:
        - matchPattern: <span class="s2">"*"</span>

<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes-dns/dns-port.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/fqdn configured</span>
<span class="nv">$ </span>c1 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": [</span>
<span class="c">#        {</span>
<span class="c">#          "regexString": "^[-a-zA-Z0-9_]*[.]github[.]com[.]$",</span>
<span class="c">#          "selectorString": "MatchName: , MatchPattern: *.github.com"</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c2 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": []</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c1 fqdn cache list
<span class="c"># =&gt; Endpoint   Source       FQDN                  TTL   ExpirationTime             IPs</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.110.133</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.109.133</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.111.133</span>
<span class="c">#    1039       connection   gist.github.com.      0     2025-09-06T08:26:39.259Z   20.200.245.247</span>
<span class="c">#    1039       connection   github.com.           0     2025-09-06T08:26:39.259Z   20.200.245.247</span>
<span class="c">#    1039       connection   cilium.io.            0     2025-09-06T08:26:39.259Z   104.198.14.52</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.108.133</span>
<span class="nv">$ </span>c2 fqdn cache list
<span class="c"># =&gt; Endpoint   Source   FQDN   TTL   ExpirationTime   IPs</span>
<span class="nv">$ </span>c1 fqdn cache clean <span class="nt">-f</span>
<span class="c"># =&gt; FQDN proxy cache cleared</span>
<span class="nv">$ </span>c2 fqdn cache clean <span class="nt">-f</span>
<span class="c"># =&gt; FQDN proxy cache cleared</span>

<span class="c"># ì™¸ë¶€ í†µì‹  í™•ì¸ : hubble ui ì—ì„œ í™•ì¸ </span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://support.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 302</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 http://support.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; command terminated with exit code 28</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_11.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">*.github.comì˜ 443 í¬íŠ¸ë§Œ í—ˆìš©ë˜ëŠ” ìƒíƒœ</em></p>

<h5 id="ì‹¤ìŠµ-ë¦¬ì†ŒìŠ¤-ì‚­ì œ">ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes-dns/dns-sw-app.yaml
<span class="c"># =&gt; pod "mediabot" deleted</span>
<span class="nv">$ </span>kubectl delete cnp fqdn
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io "fqdn" deleted</span>
</code></pre></div></div>

<h5 id="ìƒ˜í”Œ-ì• í”Œë¦¬ì¼€ì´ì…˜-ë°°í¬-ë°-í†µì‹ -ë¬¸ì œ-í™•ì¸">ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° í†µì‹  ë¬¸ì œ í™•ì¸</h5>

<ul>
  <li>ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># k8s-ctr ë…¸ë“œì— curl-pod íŒŒë“œ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>
</code></pre></div></div>

<ul>
  <li>í†µì‹  í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   2/2     2            2           47s   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.194.188   &lt;none&gt;        80/TCP    47s   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/webpod   172.20.1.252:80,172.20.2.124:80   47s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="c"># =&gt; NAME           ADDRESSTYPE   PORTS   ENDPOINTS                   AGE</span>
<span class="c">#    webpod-mr2xg   IPv4          80      172.20.1.252,172.20.2.124   59s</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="c"># IP í™•ì¸</span>
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  1846                ready            172.20.0.190</span>
<span class="c">#    webpod-697b545f57-p9hhs   4449                ready            172.20.2.124</span>
<span class="c">#    webpod-697b545f57-rcgf8   4449                ready            172.20.1.252</span>

<span class="c"># í†µì‹  ë¬¸ì œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-rcgf8</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-rcgf8</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-rcgf8</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-rcgf8</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-p9hhs</span>
<span class="c">#    ...</span>

<span class="c"># cilium-dbg, map</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg ip list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg endpoint list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg service list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf lb list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf nat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map list | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'0             0'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_services_v2
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_backends_v3
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_reverse_nat
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_ipcache_v2
</code></pre></div></div>

<h3 id="transparent-encryption-with-wireguard">Transparent Encryption with WireGuard</h3>

<ul>
  <li>ê° ë…¸ë“œëŠ” ìì²´ ì•”í˜¸í™” í‚¤ ìŒì„ ìë™ìœ¼ë¡œ ìƒì„±í•˜ê³  Kubernetes CiliumNode ì»¤ìŠ¤í…€ ë¦¬ì†ŒìŠ¤ ê°ì²´ì˜ <code class="language-plaintext highlighter-rouge">io.cilium.network.wg-pub-key</code> ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ ê³µê°œ í‚¤ë¥¼ ë°°í¬í•©ë‹ˆë‹¤.</li>
  <li>ê° ë…¸ë“œì˜ <strong>ê³µê°œí‚¤</strong>ëŠ” í•´ë‹¹ ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ Cilium ê´€ë¦¬ ì—”ë“œí¬ì¸íŠ¸ì˜ íŠ¸ë˜í”½ì„ ì•”í˜¸í™” ë° ì•”í˜¸ í•´ë…í•˜ëŠ” ë° ë‹¤ë¥¸ ë…¸ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.</li>
  <li>í•œ ë…¸ë“œ ë‚´ì—ì„œ íŒŒë“œ(ì—”ë“œí¬ì¸íŠ¸)ê°„ í†µì‹  ì‹œì—ëŠ” ì•”í˜¸í™” ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
  <li>WireGuard í„°ë„ ì—”ë“œí¬ì¸íŠ¸ëŠ” ê° ë…¸ë“œì˜ UDP í¬íŠ¸ 51871ì—ì„œ ë…¸ì¶œë©ë‹ˆë‹¤.</li>
  <li>ì œí•œ ì‚¬í•­ : L7 ì •ì±… ì‹œí–‰ ë° ê°€ì‹œì„±, eBPF ê¸°ë°˜ í˜¸ìŠ¤íŠ¸ ë¼ìš°íŒ…</li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_12.png" alt="img.png" class="image-center w-80" /></p>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_14.gif" alt="20250907_cilium_w8_14.gif" class="image-center" />
<em class="image-caption">Wireguardë¥¼ ì´ìš©í•œ ì•”í˜¸í™”</em></p>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_15.svg" alt="20250907_cilium_w8_15.svg" class="image-center" /></p>

<h3 id="-lab2-wireguard-ì„¤ì •-ë°-ì‹¤ìŠµ">ğŸ”¬ Lab2. WireGuard ì„¤ì • ë° ì‹¤ìŠµ</h3>

<ul>
  <li>í„°ë„ëª¨ë“œëŠ” ë‘ ë²ˆ ìº¡ìŠí™” ë©ë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/security/network/encryption-wireguard/">Docs</a>, <a href="https://www.youtube.com/watch?v=-awkPi3D60E">Youtube</a></li>
  <li>WireGuard í„°ë„ ì—”ë“œí¬ì¸íŠ¸ëŠ” 51871ê° ë…¸ë“œì˜ UDP í¬íŠ¸ì— ë…¸ì¶œë©ë‹ˆë‹¤.</li>
  <li>WireGuard ì„¤ì •</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [ì»¤ë„ êµ¬ì„± ì˜µì…˜] CONFIG_WIREGUARD=m on Linux 5.6 and newe </span>
<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-ar</span>
<span class="c"># =&gt; Linux k8s-ctr 6.8.0-71-generic #71-Ubuntu SMP PREEMPT_DYNAMIC Tue Jul 22 16:44:45 UTC 2025 aarch64 aarch64 aarch64 GNU/Linux</span>
<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'CONFIG_WIREGUARD=m'</span> /boot/config-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>
<span class="c"># =&gt; CONFIG_WIREGUARD=m</span>

<span class="c"># ì„¤ì • ì „ ê¸°ë³¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="nv">$ </span>ip rule show

<span class="c"># ì„¤ì •</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> encryption.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> encryption.type<span class="o">=</span>wireguard
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> wireguard
<span class="c"># =&gt; enable-wireguard                                  true</span>
<span class="c">#    wireguard-persistent-keepalive                    0s</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium encrypt status
<span class="c"># =&gt; Encryption: Wireguard</span>
<span class="c">#    Interface: cilium_wg0</span>
<span class="c">#            Public key: chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=</span>
<span class="c">#            Number of peers: 2</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status | <span class="nb">grep </span>Encryption
<span class="c"># =&gt; Encryption:              Wireguard   [NodeEncryption: Disabled, cilium_wg0 (Pubkey: chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=, Port: 51871, Peers: 2)]   </span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium debuginfo <span class="nt">--output</span> json
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium debuginfo <span class="nt">--output</span> json | jq .encryption
<span class="c"># =&gt; {</span>
<span class="c">#      "wireguard": {</span>
<span class="c">#        "interfaces": [</span>
<span class="c">#          {</span>
<span class="c">#            "listen-port": 51871,</span>
<span class="c">#            "name": "cilium_wg0",</span>
<span class="c">#            "peer-count": 2,</span>
<span class="c">#            "peers": [</span>
<span class="c">#              {</span>
<span class="c">#                "allowed-ips": [</span>
<span class="c">#                  "172.20.0.0/24",</span>
<span class="c">#                  "192.168.10.100/32",</span>
<span class="c">#                  "172.20.0.103/32",</span>
<span class="c">#                  "172.20.0.93/32",</span>
<span class="c">#                  "172.20.0.36/32",</span>
<span class="c">#                  "172.20.0.5/32",</span>
<span class="c">#                  "172.20.0.168/32",</span>
<span class="c">#                  "172.20.0.27/32",</span>
<span class="c">#                  "172.20.0.190/32"</span>
<span class="c">#                ],</span>
<span class="c">#                "endpoint": "192.168.10.100:51871",</span>
<span class="c">#                "last-handshake-time": "0001-01-01T00:00:00.000Z",</span>
<span class="c">#                "public-key": "9Pva2PmR3ETq7N/GVRHD4IsmmSYEoJTEFzXg7Qe/FGo="</span>
<span class="c">#              },</span>
<span class="c">#              {</span>
<span class="c">#                "allowed-ips": [</span>
<span class="c">#                  "192.168.10.101/32",</span>
<span class="c">#                  "172.20.1.93/32",</span>
<span class="c">#                  "172.20.1.252/32",</span>
<span class="c">#                  "172.20.1.0/24",</span>
<span class="c">#                  "172.20.1.105/32",</span>
<span class="c">#                  "172.20.1.6/32"</span>
<span class="c">#                ],</span>
<span class="c">#                "endpoint": "192.168.10.101:51871",</span>
<span class="c">#                "last-handshake-time": "0001-01-01T00:00:00.000Z",</span>
<span class="c">#                "public-key": "ZkvKJ95K9Bo6xE6DnkFfRPUHNCsuRAnIejCP7OqObB8="</span>
<span class="c">#              }</span>
<span class="c">#            ],</span>
<span class="c">#            "public-key": "chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw="</span>
<span class="c">#          }</span>
<span class="c">#        ],</span>
<span class="c">#        "node-encryption": "Disabled"</span>
<span class="c">#      }</span>
<span class="c">#    }</span>

<span class="nv">$ </span>ip <span class="nt">-d</span> <span class="nt">-c</span> addr show cilium_wg0
<span class="c"># =&gt; 24: cilium_wg0: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu 1420 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/none  promiscuity 0  allmulti 0 minmtu 0 maxmtu 2147483552</span>
<span class="c">#        wireguard numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 tso_max_size 65536 tso_max_segs 65535 gro_max_size 65536</span>
<span class="nv">$ </span>ip rule show
<span class="c"># =&gt; 9:      from all fwmark 0x200/0xf00 lookup 2004</span>
<span class="c">#    10:     from all fwmark 0xa00/0xf00 lookup 2005</span>
<span class="c">#    100:    from all lookup local</span>
<span class="c">#    32766:  from all lookup main</span>
<span class="c">#    32767:  from all lookup default </span>

<span class="c"># wg ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>wg <span class="nt">-h</span>
<span class="nv">$ </span>wg show
<span class="c"># =&gt; interface: cilium_wg0</span>
<span class="c">#      public key: 9Pva2PmR3ETq7N/GVRHD4IsmmSYEoJTEFzXg7Qe/FGo=</span>
<span class="c">#      private key: (hidden)</span>
<span class="c">#      listening port: 51871</span>
<span class="c">#      fwmark: 0xe00</span>
<span class="c">#    </span>
<span class="c">#    peer: chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=</span>
<span class="c">#      endpoint: 192.168.10.102:51871</span>
<span class="c">#      allowed ips: 192.168.10.102/32, 172.20.2.243/32, 172.20.2.226/32, 172.20.2.125/32, 172.20.2.124/32, 172.20.2.140/32, 172.20.2.0/24, 172.20.2.171/32</span>
<span class="c">#    </span>
<span class="c">#    peer: ZkvKJ95K9Bo6xE6DnkFfRPUHNCsuRAnIejCP7OqObB8=</span>
<span class="c">#      endpoint: 192.168.10.101:51871</span>
<span class="c">#      allowed ips: 172.20.1.0/24, 172.20.1.105/32, 172.20.1.93/32, 172.20.1.6/32, 192.168.10.101/32, 172.20.1.252/32</span>

<span class="nv">$ </span>wg show all public-key
<span class="c"># =&gt; cilium_wg0      9Pva2PmR3ETq7N/GVRHD4IsmmSYEoJTEFzXg7Qe/FGo=</span>
<span class="nv">$ </span>wg show all private-key
<span class="nv">$ </span>wg show all preshared-keys
<span class="nv">$ </span>wg show all endpoints
<span class="c"># =&gt; cilium_wg0      chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=    192.168.10.102:51871</span>
<span class="c">#    ZkvKJ95K9Bo6xE6DnkFfRPUHNCsuRAnIejCP7OqObB8=    192.168.10.101:51871</span>
<span class="nv">$ </span>wg show all transfer
<span class="c"># =&gt; cilium_wg0      chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=    0       0</span>
<span class="c">#    cilium_wg0      ZkvKJ95K9Bo6xE6DnkFfRPUHNCsuRAnIejCP7OqObB8=    0       0</span>

<span class="c"># í¼ë¸”ë¦­ í‚¤ í™•ì¸</span>
<span class="nv">$ </span>kubectl get cn <span class="nt">-o</span> yaml | <span class="nb">grep </span>annotations <span class="nt">-A1</span>
<span class="c"># =&gt;     annotations:</span>
<span class="c">#          network.cilium.io/wg-pub-key: 9Pva2PmR3ETq7N/GVRHD4IsmmSYEoJTEFzXg7Qe/FGo=</span>
<span class="c">#    --</span>
<span class="c">#        annotations:</span>
<span class="c">#          network.cilium.io/wg-pub-key: ZkvKJ95K9Bo6xE6DnkFfRPUHNCsuRAnIejCP7OqObB8=</span>
<span class="c">#    --</span>
<span class="c">#        annotations:</span>
<span class="c">#          network.cilium.io/wg-pub-key: chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=</span>
</code></pre></div></div>

<ul>
  <li>í†µì‹  í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># curl í˜¸ì¶œ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod
<span class="c"># =&gt; Hostname: webpod-697b545f57-rcgf8</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod
<span class="c"># =&gt; Hostname: webpod-697b545f57-p9hhs</span>
<span class="c">#    ...</span>

<span class="c"># tcpdump</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> cilium_wg0 <span class="nt">-n</span>
<span class="nv">$ </span>tcpdump <span class="nt">-eni</span> any udp port 51871
<span class="nv">$ </span>tcpdump <span class="nt">-eni</span> any udp port 51871 <span class="nt">-w</span> /tmp/wg.pcap  <span class="c"># vagrant scp k8s-ctr:/tmp/wg.pcap . &gt; wireshark ë¡œ í™•ì¸</span>

<span class="nv">$ </span>termshark /tmp/wg.pcap
<span class="c"># =&gt; termshark 2.4.0  |  wg.pcap                                                                                                                                      Analysis    Misc</span>
<span class="c">#    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“</span>
<span class="c">#    â”ƒFilter:                                                                                                                                                         &lt;Apply&gt; &lt;Recent&gt; â”ƒ</span>
<span class="c">#    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›</span>
<span class="c">#     No. -   Time -       Source -              Dest -                Proto -        Length -    Info -                                                                               â–²</span>
<span class="c">#     &lt;span style="background-color: #2080fd; color: #fff;"&gt;1       0.000000     192.168.10.100        192.168.10.102        WireGuard      192         Transport Data, receiver=0x12FBD5BA, counter=28, datalen=112                         â–ˆ&lt;/span&gt;</span>
<span class="c">#     2       0.001455     192.168.10.100        192.168.10.102        WireGuard      192         Transport Data, receiver=0x12FBD5BA, counter=29, datalen=112</span>
<span class="c">#     3       0.026152     192.168.10.102        192.168.10.100        WireGuard      240         Transport Data, receiver=0xF6874881, counter=22, datalen=160</span>
<span class="c">#     4       0.026152     192.168.10.102        192.168.10.100        WireGuard      288         Transport Data, receiver=0xF6874881, counter=23, datalen=208</span>
<span class="c">#    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>
<span class="c">#    [+] Frame 1: 192 bytes on wire (1536 bits), 192 bytes captured (1536 bits)</span>
<span class="c">#    [+] Linux cooked capture v2</span>
<span class="c">#    [+] Internet Protocol Version 4, Src: 192.168.10.100, Dst: 192.168.10.102</span>
<span class="c">#    [+] User Datagram Protocol, Src Port: 51871, Dst Port: 51871</span>
<span class="c">#    [-] WireGuard Protocol</span>
<span class="c">#          Type: Transport Data (4)</span>
<span class="c">#          Reserved: 000000</span>
<span class="c">#          Receiver: 0x12fbd5ba</span>
<span class="c">#          Counter: 28</span>
<span class="c">#    &lt;span style="background-color: #2080fd; color: #fff;"&gt;      Encrypted Packet [=]          &lt;/span&gt;</span>
<span class="c">#    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>
<span class="c">#     0000   08 00 00 00 00 00 00 03  00 01 04 06 08 00 27 5d   ........ ......']</span>
<span class="c">#     0010   09 97 00 00 45 00 00 ac  70 7e 00 00 40 11 73 a8   ....E... p~..@.s.</span>
<span class="c">#     0020   c0 a8 0a 64 c0 a8 0a 66  ca 9f ca 9f 00 98 96 c4   ...d...f ........</span>
<span class="c">#     0030   04 00 00 00 ba d5 fb 12  1c 00 00 00 00 00 00 00   ........ ........</span>
<span class="c">#     0040   e6 &lt;span style="background-color: #2080fd; color: #fff;"&gt;08 0f da 17 ab 05 18  ad a8 92 a6 53 17 5e 27&lt;/span&gt;   ........ ....S.^'</span>
<span class="c">#     0050   &lt;span style="background-color: #2080fd; color: #fff;"&gt;79 e8 ce 06 41 63 c2 9b  e1 51 3b b7 a1 a9 82 09&lt;/span&gt;   y...Ac.. .Q;.....</span>
<span class="c">#     0060   &lt;span style="background-color: #2080fd; color: #fff;"&gt;f5 71 8a f3 f9 ad aa 78  40 01 cd e6 22 43 cb 6d&lt;/span&gt;   .q.....x @..."C.m</span>
<span class="c">#     0070   &lt;span style="background-color: #2080fd; color: #fff;"&gt;3e 06 60 40 67 27 5e 96  8b 6f 43 87 32 89 bb 54&lt;/span&gt;   &gt;.`@g'^. .oC.2..T</span>
<span class="c">#     0080   &lt;span style="background-color: #2080fd; color: #fff;"&gt;cc dd 61 ff 0b 52 32 31  7a e0 9f 1f de 50 6e d5&lt;/span&gt;   ..a..R21 z....Pn.</span>
<span class="c">#     0090   &lt;span style="background-color: #2080fd; color: #fff;"&gt;0a 69 d4 d3 9c 73 8d a3  60 ff 34 2b 51 40 65 48&lt;/span&gt;   .i...s.. `.4+Q@eH</span>
<span class="c">#     00a0   &lt;span style="background-color: #2080fd; color: #fff;"&gt;19 8d 8c fb e3 41 40 13  63 06 b8 1a 96 64 10 58&lt;/span&gt;   .....A@. c....d.X</span>
<span class="c">#     00b0   &lt;span style="background-color: #2080fd; color: #fff;"&gt;44 3b fa 0c 7d f8 09 98  f3 50 98 7c 64 04 cd 59&lt;/span&gt;   D;..}... .P.|d..Y</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ íŒ¨í‚·ì´ ì•”í˜¸í™” ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># query the flow API and look for flows</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> curl-pod
</code></pre></div></div>

<ul>
  <li><strong>Node-to-Node Encryption (beta)</strong> : ì•„ì§ ë² íƒ€ ê¸°ëŠ¥ì´ì§€ë§Œ <code class="language-plaintext highlighter-rouge">--set encryption.nodeEncryption=true</code> ì˜µì…˜ì„ í†µí•´ ë…¸ë“œ - ë…¸ë“œ , ë…¸ë“œ - íŒŒë“œ ê°„ íŠ¸ë˜í”½ë„ ì•”í˜¸í™” í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì„¤ì • ì›ë³µ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> encryption.enabled<span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> wireguard
<span class="c"># =&gt; (ì—†ìŒ)</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium encrypt status
<span class="c"># =&gt; Encryption: Disabled</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status | <span class="nb">grep </span>Encryption
<span class="c"># =&gt; Encryption:              Disabled</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ WireGuard ì¸í„°í˜ì´ìŠ¤ ë° ì„¤ì •ì´ ì œê±°ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="inspecting-tls-encrypted-connections">Inspecting TLS Encrypted Connections</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/security/tls-visibility/">ê´€ë ¨ë¬¸ì„œ</a></li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_16.png" alt="img.png" class="image-center" />
<em class="image-caption"><a href="https://docs.cilium.io/en/stable/security/tls-visibility/">https://docs.cilium.io/en/stable/security/tls-visibility/</a></em></p>

<ul>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì—ì„œ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì€ ë³´ì•ˆì„ ìœ„í•´ TLS(Transport Layer Security)ë¡œ ì•”í˜¸í™”ë˜ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤.</li>
  <li>ê·¸ëŸ¬ë‚˜ ì•”í˜¸í™”ëœ ì—°ê²°ì€ ì •ì±… ì ìš©ì´ë‚˜ ê°€ì‹œì„± í™•ë³´ ì¸¡ë©´ì—ì„œ ì œì•½ì´ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Ciliumì€ ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ <strong>TLS ì•”í˜¸í™”ëœ ì—°ê²°ë„ íˆ¬ëª…í•˜ê²Œ ê²€ì‚¬í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥</strong>ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="ì†Œê°œ">ì†Œê°œ</h5>

<ul>
  <li>Ciliumì€ <strong>HTTPSì™€ ê°™ì€ TLS ë³´í˜¸ ì—°ê²°ì—ì„œë„ API ì¸ì‹ ê°€ì‹œì„±ê³¼ ì •ì±… ì ìš©</strong>ì„ ì§€ì›í•©ë‹ˆë‹¤.</li>
  <li>ê¸°ì¡´ í•˜ë“œì›¨ì–´ ë°©í™”ë²½ê³¼ ìœ ì‚¬í•˜ì§€ë§Œ, ì „ì ìœ¼ë¡œ <strong>ì¿ ë²„ë„¤í‹°ìŠ¤ ì›Œì»¤ ë…¸ë“œì˜ ì†Œí”„íŠ¸ì›¨ì–´ ë°©ì‹</strong>ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</li>
  <li>ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆíŒ€ì€ <strong>ë‚´ë¶€ ì¸ì¦ ê¸°ê´€(CA)</strong>ì„ ìƒì„±í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ê°€ ì´ë¥¼ ì‹ ë¢°í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.</li>
  <li>Ciliumì€ TLS ì—°ê²°ì„ ì¤‘ê°„ì—ì„œ ì¢…ë£Œí•˜ê³  ë‚´ë¶€ CA ì„œëª… ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ€ìƒ ì„œë¹„ìŠ¤ì™€ <strong>ìƒˆë¡œìš´ TLS ì—°ê²°</strong>ì„ ë§ºìŠµë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ í†µí•´ <strong>ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ ë°ì´í„° ê²€ì‚¬</strong>ì™€ <strong>ì •ì±… ì ìš©</strong>ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.</li>
</ul>

<h5 id="tls-ê²€ì‚¬-êµ¬ì„±-ë‹¨ê³„">TLS ê²€ì‚¬ êµ¬ì„± ë‹¨ê³„</h5>

<p>TLS ê²€ì‚¬ë¥¼ êµ¬í˜„í•˜ë ¤ë©´ CA ê¸°ë°˜ ëª¨ë¸ì„ ë”°ë¼ì•¼ í•˜ë©°, ê¸°ë³¸ ì ˆì°¨ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>

<ol>
  <li><strong>ë‚´ë¶€ CA ìƒì„±</strong>: CA ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ì—¬ <strong>ë‚´ë¶€ì¸ì¦ê¸°ê´€</strong>ì„ ë§Œë“­ë‹ˆë‹¤.</li>
  <li><strong>ëŒ€ìƒ ì„œë¹„ìŠ¤ ì¸ì¦ì„œ ìš”ì²­</strong>: DNS ì´ë¦„ê³¼ ì¼ì¹˜í•˜ëŠ” ì„œëª… ìš”ì²­(CSR: Certificate Signing Request)ì„ ìƒì„±í•©ë‹ˆë‹¤.</li>
  <li><strong>CA ì„œëª… ì¸ì¦ì„œ ë°œê¸‰</strong>: ë‚´ë¶€ CAë¡œ ì„œëª…ëœ ì¸ì¦ì„œë¥¼ ë§Œë“­ë‹ˆë‹¤.</li>
  <li><strong>í´ë¼ì´ì–¸íŠ¸ ì‹ ë¢° ì²´ì¸ êµ¬ì„±</strong>: í´ë¼ì´ì–¸íŠ¸ì— CA ì¸ì¦ì„œë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.</li>
  <li><strong>Cilium êµ¬ì„±</strong>: ìƒˆë¡œìš´ TLS ì—°ê²°ì„ ìƒì„±í•  ë•Œ ì‚¬ìš©í•  ì‹ ë¢°í•  CA ì§‘í•©ì„ ì§€ì •í•©ë‹ˆë‹¤.</li>
</ol>

<blockquote>
  <p>âš ï¸ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” <strong>CA ê°œì¸ í‚¤ ë³´ê´€ì´ ë§¤ìš° ì¤‘ìš”</strong>í•©ë‹ˆë‹¤.<br />
ê°œì¸ í‚¤ê°€ ìœ ì¶œë˜ë©´ TLS íŠ¸ë˜í”½ì„ ëˆ„êµ¬ë‚˜ ê°€ë¡œì±„ì–´ ê²€ì‚¬í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.<br />
ë°˜ëŒ€ë¡œ ì¸ì¦ì„œëŠ” ê³µê°œ ì •ë³´ì´ë¯€ë¡œ ë¯¼ê°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
</blockquote>

<h5 id="tls-ê²€ì‚¬-ë™ì‘-ë°©ì‹">TLS ê²€ì‚¬ ë™ì‘ ë°©ì‹</h5>

<ul>
  <li>Ciliumì€ í´ë¼ì´ì–¸íŠ¸ì™€ì˜ ì›ë˜ TLS ì—°ê²°ì„ ì¢…ë£Œí•˜ê³ , Envoyë¥¼ í†µí•´ ëŒ€ìƒ ì„œë¹„ìŠ¤ì™€ ìƒˆë¡œìš´ TLS ì—°ê²°ì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤.</li>
  <li>ë„¤íŠ¸ì›Œí¬ ì •ì±…ì—ëŠ” <code class="language-plaintext highlighter-rouge">terminatingTLS</code> ë° <code class="language-plaintext highlighter-rouge">originatingTLS</code> ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
  <li>ì´ ê³¼ì •ì—ì„œ í•µì‹¬ì€ <strong>Envoyì— ì¸ì¦ì„œë¥¼ ì „ë‹¬í•˜ëŠ” ë°©ì‹</strong>ì…ë‹ˆë‹¤.</li>
  <li>
    <p><strong>NPDS</strong>(ì›ë˜ì˜ ë²„ì „)ì™€ <strong>SDS</strong>(ìƒˆë¡­ê³  í–¥ìƒëœ ë²„ì „) ë‘ ê°€ì§€ ë°©ì‹ì„ ì œê³µí•˜ê³  ìˆìœ¼ë©° ê°ê° ì¥ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li><strong>NPDS (Network Policy Discovery Service)</strong>
    <ul>
      <li>ì¸ì¦ì„œì™€ í‚¤ë¥¼ Base64 í…ìŠ¤íŠ¸ë¡œ ì¸ë¼ì¸ ì „ì†¡í•©ë‹ˆë‹¤.</li>
      <li>ë‹¨ìˆœí•˜ì§€ë§Œ ë™ì¼ ì¸ì¦ì„œë¥¼ ì—¬ëŸ¬ ì •ì±…ì—ì„œ ì‚¬ìš©í•  ê²½ìš° <strong>Envoy ë©”ëª¨ë¦¬ì— ì¤‘ë³µ ì €ì¥</strong>ë©ë‹ˆë‹¤.</li>
      <li>ëŒ€ê·œëª¨ í™˜ê²½ì—ì„œëŠ” ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ê¸‰ì¦í•  ìˆ˜ ìˆëŠ” ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li><strong>SDS (Secret Discovery Service)</strong>
    <ul>
      <li>Cilium 1.17ë¶€í„° ë„ì…ëœ ê°œì„ ëœ ë°©ì‹ì…ë‹ˆë‹¤.</li>
      <li>Kubernetes ì‹œí¬ë¦¿ì„ ì°¸ì¡°í•˜ì—¬ Envoy SDS APIë¥¼ í†µí•´ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
      <li>ì¸ì¦ì„œê°€ <strong>ì°¸ì¡° ê¸°ë°˜ìœ¼ë¡œ ì „ë‹¬</strong>ë˜ë¯€ë¡œ ì¤‘ë³µ ì €ì¥ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</li>
      <li>ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±ê³¼ ë³´ì•ˆì´ ë›°ì–´ë‚˜ë©°, <strong>Cilium 1.17 ì´í›„ ê¸°ë³¸ê°’</strong>ìœ¼ë¡œ ê¶Œì¥ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h5 id="tls-interception-êµ¬ì„±-cilium-117">TLS Interception êµ¬ì„± (Cilium 1.17+)</h5>

<ul>
  <li>Ciliumì€ ì„¸ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ TLS Interceptionì„ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</li>
</ul>

<ol>
  <li><strong>SDS (ê¶Œì¥ ë°©ì‹)</strong>
    <ul>
      <li>ì •ì±…ì—ì„œ ì°¸ì¡°í•œ ì‹œí¬ë¦¿ì„ <code class="language-plaintext highlighter-rouge">cilium-secrets</code> ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë³µì‚¬ í›„ SDSë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.</li>
      <li>ê¸°ë³¸ê°’ì´ì ê°€ì¥ ì•ˆì „í•˜ê³  íš¨ìœ¨ì ì¸ ë°©ì‹ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tls</span><span class="pi">:</span>
  <span class="na">readSecretsOnlyFromSecretsNamespace</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">secretsNamespace</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">cilium-secrets</span> <span class="c1"># This setting is optional, as it is the default</span>
  <span class="na">secretSync</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre></div></div>

<ol>
  <li><strong>NPDS ì¸ë¼ì¸ ë°©ì‹</strong> (ë¹„ê¶Œì¥)
    <ul>
      <li>í´ëŸ¬ìŠ¤í„° ë‚´ ì–´ëŠ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë“  ì‹œí¬ë¦¿ì„ ì €ì¥í•  ìˆ˜ ìˆê³ , Ciliumì´ ì§ì ‘ ì½ì–´ Envoyì— ì „ë‹¬í•©ë‹ˆë‹¤.</li>
      <li>ë³´ì•ˆ ë²”ìœ„ê°€ í¬ê²Œ í™•ì¥ë˜ë¯€ë¡œ ê¶Œì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tls:
  readSecretsOnlyFromSecretsNamespace: <span class="nb">false
  </span>secretSync:
    enabled: <span class="nb">false</span>
</code></pre></div></div>

<ol>
  <li><strong>í•˜ìœ„ í˜¸í™˜ ëª¨ë“œ</strong>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">cilium-secrets</code> ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì§ì ‘ ì°¸ì¡°í•©ë‹ˆë‹¤.</li>
      <li>ì—…ê·¸ë ˆì´ë“œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€ë˜ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tls</span><span class="pi">:</span>
  <span class="na">readSecretsOnlyFromSecretsNamespace</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">secretsNamespace</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">cilium-secrets</span> <span class="c1"># This setting is optional, as it is the default</span>
  <span class="na">secretSync</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="kc">false</span>
</code></pre></div></div>

<ul>
  <li>Helm ì„¤ì • ì£¼ìš” í•­ëª©
    <ul>
      <li><code class="language-plaintext highlighter-rouge">tls.secretsNamespace.name</code> : ì •ì±… ë¹„ë°€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (ê¸°ë³¸ê°’: <code class="language-plaintext highlighter-rouge">cilium-secrets</code>)</li>
      <li><code class="language-plaintext highlighter-rouge">tls.readSecretsOnlyFromSecretsNamespace</code> : ì§€ì • ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œë§Œ ë¹„ë°€ ì½ê¸° (ê¸°ë³¸ê°’: <code class="language-plaintext highlighter-rouge">true</code>)</li>
      <li><code class="language-plaintext highlighter-rouge">tls.secretSync.enabled</code> : sSDS ì‚¬ìš©ì„ ìœ„í•œ ë¹„ë°€ ë™ê¸°í™” í™œì„±í™” (ê¸°ë³¸ê°’: <code class="language-plaintext highlighter-rouge">true</code>)</li>
    </ul>
  </li>
</ul>

<h5 id="cilium-tls-interception-ì„¤ì •-sds-mode">Cilium TLS Interception ì„¤ì • (SDS Mode)</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get all,secret,cm <span class="nt">-n</span> cilium-secrets
<span class="c"># =&gt; NAME                         DATA   AGE</span>
<span class="c">#    configmap/kube-root-ca.crt   1      3h33m</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; tls-config.yaml
tls:
  readSecretsOnlyFromSecretsNamespace: true
  secretsNamespace:
    name: cilium-secrets # This setting is optional, as it is the default
  secretSync:
    enabled: true
</span><span class="no">EOF

</span><span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">-f</span> tls-config.yaml
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart deploy/cilium-operator
<span class="c"># =&gt; deployment.apps/cilium-operator restarted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> secret
<span class="c"># =&gt; enable-ingress-secrets-sync                       true</span>
<span class="c">#    enable-policy-secrets-sync                        true</span>
<span class="c">#    ingress-secrets-namespace                         cilium-secrets</span>
<span class="c">#    policy-secrets-namespace                          cilium-secrets</span>
<span class="c">#    policy-secrets-only-from-secrets-namespace        true</span>
</code></pre></div></div>

<h3 id="-lab3-tls-interception-ì‹¤ìŠµ">ğŸ”¬ Lab3. TLS Interception ì‹¤ìŠµ</h3>

<ul>
  <li>
    <p><a href="https://docs.cilium.io/en/stable/security/tls-visibility/#deploy-the-demo-application">ê´€ë ¨ë¬¸ì„œ</a></p>
  </li>
  <li>TLS ê°€ë¡œì±„ê¸°ë¥¼ ì‹œì—°í•˜ê¸° ìœ„í•´ DNS ì¸ì‹ ì •ì±… ì˜ˆì œì— ì‚¬ìš©í•œ ê²ƒê³¼ ë™ì¼í•œ <code class="language-plaintext highlighter-rouge">mediabot</code>ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤. ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ HTTPSë¥¼ ì‚¬ìš©í•˜ì—¬ Star Wars API ì„œë¹„ìŠ¤ì— ì•¡ì„¸ìŠ¤í•©ë‹ˆë‹¤. ì´ëŠ” ì¼ë°˜ì ìœ¼ë¡œ Ciliumê³¼ ê°™ì€ ë„¤íŠ¸ì›Œí¬ ê³„ì¸µ ë©”ì»¤ë‹ˆì¦˜ì´ í†µì‹ ì˜ HTTP ê³„ì¸µ ì„¸ë¶€ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ì—†ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ëª¨ë“  ì• í”Œë¦¬ì¼€ì´ì…˜ ë°ì´í„°ëŠ” ë„¤íŠ¸ì›Œí¬ë¡œ ì „ì†¡ë˜ê¸° ì „ì— TLSë¥¼ ì‚¬ìš©í•˜ì—¬ ì•”í˜¸í™”ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
  <li>ë‹¤ìŒì˜ í•­ëª©ì„ ì‹¤ìŠµí•˜ë©´ì„œ TLS ê°€ë¡œì±„ê¸° ê¸°ëŠ¥ì„ ì´í•´í•´ ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li><strong>TLS ê°€ë¡œì±„ê¸°ë¥¼ í™œì„±í™”</strong>í•˜ê¸° ìœ„í•´ <strong>ë‚´ë¶€ ì¸ì¦ ê¸°ê´€(CA)ê³¼ í•´ë‹¹ CAê°€ ì„œëª…í•œ ê´€ë ¨ ì¸ì¦ì„œ</strong> ìƒì„±</li>
      <li><strong>DNS ê¸°ë°˜ ì •ì±… ê·œì¹™</strong>ì„ ì‚¬ìš©í•˜ì—¬ <strong>ê°€ë¡œì±Œ íŠ¸ë˜í”½ì„ ì„ íƒ</strong>í•˜ë ¤ë©´ <strong>Cilium ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„</strong> ì‚¬ìš©</li>
      <li>cilium monitorë¥¼ ì‚¬ìš©í•˜ì—¬ <strong>HTTP ìš”ì²­ì˜ ì„¸ë¶€ ì‚¬í•­ì„ ê²€ì‚¬</strong></li>
    </ul>
  </li>
</ul>

<h5 id="ë‹¨ì¼-í¬ë“œ-mediabot-ì• í”Œë¦¬ì¼€ì´ì…˜ì„-ìƒì„±">ë‹¨ì¼ í¬ë“œ mediabot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìƒì„±</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># </span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; dns-sw-app.yaml
apiVersion: v1
kind: Pod
metadata:
  name: mediabot
  labels:
    org: empire
    class: mediabot
    app: mediabot
spec:
  containers:
  - name: mediabot
    image: quay.io/cilium/json-mock:v1.3.8@sha256:5aad04835eda9025fe4561ad31be77fd55309af8158ca8663a72f6abb78c2603
</span><span class="no">EOF

</span><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> dns-sw-app.yaml
<span class="c"># =&gt; pod/mediabot created</span>
<span class="nv">$ </span>kubectl <span class="nb">wait </span>pod/mediabot <span class="nt">--for</span><span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready
<span class="c"># =&gt; pod/mediabot condition met</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get pods
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    mediabot                  1/1     Running   0          16s</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://api.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 https://support.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 302</span>
</code></pre></div></div>

<h5 id="tls-í‚¤-ë°-ì¸ì¦ì„œ-ìƒì„±-ë°-ì„¤ì¹˜">TLS í‚¤ ë° ì¸ì¦ì„œ ìƒì„± ë° ì„¤ì¹˜</h5>

<ul>
  <li>ì•„ë˜ì˜ ì´ë¯¸ì§€ëŠ” ìƒì„±ë˜ê±°ë‚˜ ë³µì‚¬ë˜ëŠ” ì•”í˜¸í™” ë°ì´í„°ê°€ í¬í•¨ëœ ë‹¤ì–‘í•œ íŒŒì¼ê³¼ ì‹œìŠ¤í…œì˜ ì–´ë–¤ êµ¬ì„± ìš”ì†Œê°€ í•´ë‹¹ íŒŒì¼ì— ì•¡ì„¸ìŠ¤í•´ì•¼ í•˜ëŠ”ì§€ ì„¤ëª…í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_17.png" alt="img.png" class="image-center" />
<em class="image-caption">ì•”í˜¸í™” ë°ì´í„°ì™€ ì‹œìŠ¤í…œì˜ êµ¬ì„±ìš”ì†Œê°„ì˜ ì•¡ì„¸ìŠ¤ ê´€ê³„ë„</em></p>

<ul>
  <li>ë¡œì»¬ ì‹œìŠ¤í…œì— opensslì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ë©´ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ, ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš° ê°„ë‹¨í•œ ë‹¨ì¶•í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ cilium í¬ë“œ ë‚´ì—ì„œ ì‹¤í–‰í•œ í›„ ê²°ê³¼ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Kubernetes ì‹œí¬ë¦¿ì„ ìƒì„±í•˜ê±°ë‚˜ í¬ë“œì— ë³µì‚¬í•  ë•Œ cilium í¬ë“œì—ì„œ ê²°ê³¼ íŒŒì¼ì„ ë³µì‚¬í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ .</li>
</ul>

<h5 id="ë‚´ë¶€-ì¸ì¦-ê¸°ê´€ca-ë§Œë“¤ê¸°">ë‚´ë¶€ ì¸ì¦ ê¸°ê´€(CA) ë§Œë“¤ê¸°</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 'myCA.key'ë¼ëŠ” ì´ë¦„ì˜ CA ê°œì¸ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>openssl genrsa <span class="nt">-des3</span> <span class="nt">-out</span> myCA.key 2048
<span class="c"># =&gt; Enter PEM pass phrase: qwe123          # &lt;span style="color: green;"&gt;CA ì¸ì¦ì„œì—ì„œ ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸ ì…ë ¥&lt;/span&gt;</span>
<span class="c">#    Verifying - Enter PEM pass phrase: qwe123</span>

<span class="nv">$ </span><span class="nb">ls</span> <span class="k">*</span>.key
<span class="c"># =&gt; myCA.key</span>

<span class="c"># ê°œì¸ í‚¤ì—ì„œ CA ì¸ì¦ì„œë¥¼ ìƒì„±</span>
<span class="nv">$ </span>openssl req <span class="nt">-x509</span> <span class="nt">-new</span> <span class="nt">-nodes</span> <span class="nt">-key</span> myCA.key <span class="nt">-sha256</span> <span class="nt">-days</span> 1825 <span class="nt">-out</span> myCA.crt
<span class="c"># =&gt; Enter pass phrase for myCA.key: qwe123   # &lt;span style="color: green;"&gt;ê°œì¸ í‚¤ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥&lt;/span&gt;</span>
<span class="c">#    You are about to be asked to enter information that will be incorporated</span>
<span class="c">#    into your certificate request.</span>
<span class="c">#    What you are about to enter is what is called a Distinguished Name or a DN.</span>
<span class="c">#    There are quite a few fields but you can leave some blank</span>
<span class="c">#    For some fields there will be a default value,</span>
<span class="c">#    If you enter '.', the field will be left blank.</span>
<span class="c">#    -----</span>
<span class="c">#    Country Name (2 letter code) [AU]:KR</span>
<span class="c">#    State or Province Name (full name) [Some-State]:Seoul</span>
<span class="c">#    Locality Name (eg, city) []:Seoul</span>
<span class="c">#    Organization Name (eg, company) [Internet Widgits Pty Ltd]:cloudneta</span>
<span class="c">#    Organizational Unit Name (eg, section) []:study</span>
<span class="c">#    Common Name (e.g. server FQDN or YOUR name) []:cloudneta.net</span>
<span class="c">#    Email Address []:</span>

<span class="nv">$ </span><span class="nb">ls</span> <span class="k">*</span>.crt
<span class="c"># =&gt; myCA.crt</span>

<span class="nv">$ </span>openssl x509 <span class="nt">-in</span> myCA.crt <span class="nt">-noout</span> <span class="nt">-text</span>
<span class="c"># =&gt; ...</span>
<span class="c">#            Issuer: C = KR, ST = Seoul, L = Seoul, O = cloudneta, OU = study, CN = cloudneta.net</span>
<span class="c">#            Validity</span>
<span class="c">#                Not Before: Sep  6 10:55:56 2025 GMT</span>
<span class="c">#                Not After : Sep  5 10:55:56 2030 GMT</span>
<span class="c">#            Subject: C = KR, ST = Seoul, L = Seoul, O = cloudneta, OU = study, CN = cloudneta.net</span>
<span class="c">#    ...</span>
<span class="c">#                X509v3 Basic Constraints: critical</span>
<span class="c">#                    CA:TRUE</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h5 id="ì§€ì •ëœ-dns-ì´ë¦„ì—-ëŒ€í•œ-ê°œì¸-í‚¤-ë°-ì¸ì¦ì„œ-ì„œëª…-ìš”ì²­-ìƒì„±">ì§€ì •ëœ DNS ì´ë¦„ì— ëŒ€í•œ ê°œì¸ í‚¤ ë° ì¸ì¦ì„œ ì„œëª… ìš”ì²­ ìƒì„±</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ê²€ì‚¬ë¥¼ ìœ„í•´ ê°€ë¡œì±„ë ¤ëŠ” ëŒ€ìƒ ì„œë¹„ìŠ¤ì˜ DNS ì´ë¦„ê³¼ ì¼ì¹˜í•˜ëŠ” ì¼ë°˜ ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ ë‚´ë¶€ ê°œì¸ í‚¤ì™€ ì¸ì¦ì„œ ì„œëª…ì„ ìƒì„±í•©ë‹ˆë‹¤</span>
<span class="c">## ì´ ì˜ˆì—ì„œëŠ” httpbin.org</span>

<span class="c"># ë¨¼ì € ê°œì¸ í‚¤ë¥¼ ë§Œë“­ë‹ˆë‹¤.</span>
<span class="nv">$ </span>openssl genrsa <span class="nt">-out</span> internal-httpbin.key 2048
<span class="nv">$ </span><span class="nb">ls </span>internal-httpbin.key
<span class="c"># =&gt; internal-httpbin.key</span>

<span class="c"># ë‹¤ìŒìœ¼ë¡œ, ì¸ì¦ì„œ ì„œëª… ìš”ì²­ì„ ìƒì„±í•˜ê³ , ë©”ì‹œì§€ê°€ í‘œì‹œë˜ë©´ ì¼ë°˜ ì´ë¦„ í•„ë“œì— ëŒ€ìƒ ì„œë¹„ìŠ¤ì˜ DNS ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤. </span>
<span class="c"># ë‹¤ë¥¸ ëª¨ë“  ë©”ì‹œì§€ì—ëŠ” ì›í•˜ëŠ” ê°’ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
<span class="c"># íŠ¹ì • ê°’ì´ì–´ì•¼ í•˜ëŠ” ìœ ì¼í•œ í•„ë“œëŠ” í´ë¼ì´ì–¸íŠ¸ì— ì œê³µë  ì •í™•í•œ DNS ëŒ€ìƒì„ ë³´ì¥í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. Common Name: httpbin.org</span>
<span class="c"># ì´ ì˜ˆì œ ì›Œí¬í”Œë¡œëŠ” ì •ì±… YAML(ì•„ë˜)ì˜ toFQDNs ê·œì¹™ë„ ì¸ì¦ì„œì˜ DNS ì´ë¦„ê³¼ ì¼ì¹˜í•˜ë„ë¡ ì—…ë°ì´íŠ¸ë˜ëŠ” í•œ ëª¨ë“  DNS ì´ë¦„ì— ì ìš©ë©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>openssl req <span class="nt">-new</span> <span class="nt">-key</span> internal-httpbin.key <span class="nt">-out</span> internal-httpbin.csr
<span class="c"># =&gt; ...</span>
<span class="c">#    Common Name (e.g. server FQDN or YOUR name) []:httpbin.org</span>
<span class="c">#    ...</span>

<span class="nv">$ </span><span class="nb">ls </span>internal-httpbin.csr
<span class="c"># =&gt; internal-httpbin.csr</span>
</code></pre></div></div>

<h5 id="caë¥¼-ì‚¬ìš©í•˜ì—¬-dns-ì´ë¦„ì—-ëŒ€í•œ-ì„œëª…ëœ-ì¸ì¦ì„œ-ìƒì„±">CAë¥¼ ì‚¬ìš©í•˜ì—¬ DNS ì´ë¦„ì— ëŒ€í•œ ì„œëª…ëœ ì¸ì¦ì„œ ìƒì„±</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë‚´ë¶€ CA ê°œì¸ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ httpbin.orgì— ëŒ€í•œ ì„œëª…ëœ ì¸ì¦ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤ internal-httpbin.crt</span>
<span class="nv">$ </span>openssl x509 <span class="nt">-req</span> <span class="nt">-days</span> 360 <span class="nt">-in</span> internal-httpbin.csr <span class="nt">-CA</span> myCA.crt <span class="nt">-CAkey</span> myCA.key <span class="nt">-CAcreateserial</span> <span class="nt">-out</span> internal-httpbin.crt <span class="nt">-sha256</span>
<span class="c"># =&gt; Certificate request self-signature ok</span>
<span class="c">#    subject=C = KR, ST = Seoul, L = Seoul, O = cloudneta, OU = study, CN = httpbin.org</span>
<span class="c">#    Enter pass phrase for myCA.key: qwe123     &lt;span style="color: green;"&gt;CA ê°œì¸ í‚¤ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥&lt;/span&gt;</span>
  
<span class="nv">$ </span><span class="nb">ls </span>internal-httpbin.crt
<span class="c"># =&gt; internal-httpbin.crt</span>
<span class="nv">$ </span>openssl x509 <span class="nt">-in</span> internal-httpbin.crt <span class="nt">-noout</span> <span class="nt">-text</span>
<span class="c"># =&gt; ...</span>
<span class="c">#            Issuer: C = KR, ST = Seoul, L = Seoul, O = cloudneta, OU = study, CN = cloudneta.net   # &lt;span style="color: green;"&gt;ë‚´ë¶€ CA ì¸ì¦ì„œ ì •ë³´&lt;/span&gt;</span>
<span class="c">#            Validity</span>
<span class="c">#                Not Before: Sep  6 11:00:18 2025 GMT</span>
<span class="c">#                Not After : Sep  1 11:00:18 2026 GMT</span>
<span class="c">#            Subject: C = KR, ST = Seoul, L = Seoul, O = cloudneta, OU = study, CN = httpbin.org    # &lt;span style="color: green;"&gt;ëŒ€ìƒ ì„œë¹„ìŠ¤ ì¸ì¦ì„œ ì •ë³´&lt;/span&gt;</span>
  
<span class="c"># ë‹¤ìŒìœ¼ë¡œ ëŒ€ìƒ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ê°œì¸ í‚¤ì™€ ì„œëª…ëœ ì¸ì¦ì„œë¥¼ ëª¨ë‘ í¬í•¨í•˜ëŠ” Kubernetes ë¹„ë°€ì„ ìƒì„±í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl create secret tls httpbin-tls-data <span class="nt">-n</span> kube-system <span class="nt">--cert</span><span class="o">=</span>internal-httpbin.crt <span class="nt">--key</span><span class="o">=</span>internal-httpbin.key
<span class="c"># =&gt; secret/httpbin-tls-data created</span>
<span class="nv">$ </span>kubectl get secret <span class="nt">-n</span> kube-system  httpbin-tls-data
<span class="c"># =&gt; NAME               TYPE                DATA   AGE</span>
<span class="c">#    httpbin-tls-data   kubernetes.io/tls   2      10s  </span>
</code></pre></div></div>

<h5 id="í´ë¼ì´ì–¸íŠ¸-í¬ë“œ-ë‚´ì—ì„œ-ì‹ ë¢°í• -ìˆ˜-ìˆëŠ”-caë¡œ-ë‚´ë¶€-ca-ì¶”ê°€">í´ë¼ì´ì–¸íŠ¸ í¬ë“œ ë‚´ì—ì„œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” CAë¡œ ë‚´ë¶€ CA ì¶”ê°€</h5>

<ul>
  <li>CA ì¸ì¦ì„œê°€ í´ë¼ì´ì–¸íŠ¸ í¬ë“œì— ì €ì¥ëœ í›„ì—ë„ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•˜ëŠ” TLS ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ CA íŒŒì¼ì„ ì¸ì‹í•˜ëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
    <ul>
      <li>ëŒ€ë¶€ë¶„ì˜ Linux ì• í”Œë¦¬ì¼€ì´ì…˜ì€ Linux ë°°í¬íŒê³¼ í•¨ê»˜ ì œê³µë˜ëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” CA ì¸ì¦ì„œ ì„¸íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        <ul>
          <li>ì´ ê°€ì´ë“œì—ì„œëŠ” Ubuntu ì»¨í…Œì´ë„ˆë¥¼ í´ë¼ì´ì–¸íŠ¸ë¡œ ì‚¬ìš©í•˜ë¯€ë¡œ Ubuntuë³„ ì§€ì¹¨ì— ë”°ë¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. ë‹¤ë¥¸ Linux ë°°í¬íŒì€ ë‹¤ë¥¸ ë©”ì»¤ë‹ˆì¦˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ê°œë³„ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ OS ì¸ì¦ì„œ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•˜ëŠ” ëŒ€ì‹  ìì²´ ì¸ì¦ì„œ ì €ì¥ì†Œë¥¼ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ëŸ°íƒ€ì„ ì„¤ëª…ì„œë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /usr/local/share/ca-certificates/
<span class="c"># =&gt; total 0</span>
  
<span class="c"># Ubuntuì˜ ê²½ìš° ë¨¼ì € ì¶”ê°€ CA ì¸ì¦ì„œë¥¼ í´ë¼ì´ì–¸íŠ¸ Pod íŒŒì¼ ì‹œìŠ¤í…œì— ë³µì‚¬í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl <span class="nb">cp </span>myCA.crt default/mediabot:/usr/local/share/ca-certificates/myCA.crt
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /usr/local/share/ca-certificates/
<span class="c"># =&gt; total 4</span>
<span class="c">#    -rw-r--r-- 1 root root 1342 Sep  6 11:03 myCA.crt</span>
  
<span class="c"># /etc/ssl/certs/ca-certificates.crtì— ìˆëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì¸ì¦ ê¸°ê´€ì˜ ê¸€ë¡œë²Œ ì„¸íŠ¸ì— ì´ ì¸ì¦ì„œë¥¼ ì¶”ê°€í•˜ëŠ” Ubuntu ì „ìš© ìœ í‹¸ë¦¬í‹° ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /etc/ssl/certs/ca-certificates.crt <span class="c"># ì‚¬ì´ì¦ˆ, ìƒì„±/ìˆ˜ì • ë‚ ì§œ í™•ì¸</span>
<span class="c"># =&gt; -rw-r--r-- 1 root root 213777 Jan  9  2024 /etc/ssl/certs/ca-certificates.crt</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> update-ca-certificates
<span class="c"># =&gt; Updating certificates in /etc/ssl/certs...</span>
<span class="c">#    rehash: warning: skipping ca-certificates.crt,it does not contain exactly one certificate or CRL</span>
<span class="c">#    1 added, 0 removed; done.</span>
<span class="c">#    Running hooks in /etc/ca-certificates/update.d...</span>
<span class="c">#    done.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /etc/ssl/certs/ca-certificates.crt <span class="c"># ì‚¬ì´ì¦ˆ, ìƒì„±/ìˆ˜ì • ë‚ ì§œ í™•ì¸</span>
<span class="c"># =&gt; -rw-r--r-- 1 root root 215119 Sep  6 11:04 /etc/ssl/certs/ca-certificates.crt</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì‹ ê·œ CA ì¸ì¦ì„œê°€ ì¶”ê°€ë˜ì–´ íŒŒì¼ í¬ê¸°ì™€ ìˆ˜ì • ë‚ ì§œê°€ ë³€ê²½ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="ciliumì—-ì‹ ë¢°í• -ìˆ˜-ìˆëŠ”-ca-ëª©ë¡-ì œê³µ">Ciliumì— ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” CA ëª©ë¡ ì œê³µ</h5>

<ul>
  <li>ë‹¤ìŒìœ¼ë¡œ, Ciliumì´ <strong>ë³´ì¡° TLS ì—°ê²°ì„ ì‹œì‘í• </strong> ë•Œ <strong>ì‹ ë¢°í•´ì•¼ í•˜ëŠ” CA ì„¸íŠ¸ë¥¼ ì œê³µ</strong>í•©ë‹ˆë‹¤. ì´ ëª©ë¡ì€ ì¡°ì§ì—ì„œ ì‹ ë¢°í•˜ëŠ” <strong>í‘œì¤€ ê¸€ë¡œë²Œ CA ì„¸íŠ¸ì™€</strong> ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ë…¼ë¦¬ì ì¸ ì˜µì…˜ ì¤‘ í•˜ë‚˜ëŠ” ìš´ì˜ ì²´ì œì—ì„œ ì‹ ë¢°í•˜ëŠ” í‘œì¤€ CA ì„¸íŠ¸ì…ë‹ˆë‹¤. ì´ëŠ” TLS ê²€ì‚¬ ë„ì… ì´ì „ì— ì‚¬ìš©ë˜ë˜ CA ì„¸íŠ¸ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
  <li>ê°„ë‹¨í•˜ê²Œ ì„¤ëª…í•˜ê¸° ìœ„í•´ ì´ ì˜ˆì—ì„œ ìš°ë¦¬ëŠ” m<strong>ediabot í¬ë“œì˜ Ubuntu íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ì´ ëª©ë¡ì„ ë³µì‚¬</strong>í•  ê²ƒì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” CA ëª©ë¡ì€ íŠ¹ì • TLS í´ë¼ì´ì–¸íŠ¸ë‚˜ ì„œë²„ì—ë§Œ êµ­í•œë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì ì„ ì´í•´í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ë”°ë¼ì„œ TLS ê²€ì‚¬ì— ì°¸ì—¬í•˜ëŠ” TLS í´ë¼ì´ì–¸íŠ¸ë‚˜ ì„œë²„ì˜ ìˆ˜ì— ê´€ê³„ì—†ì´ ì´ ë‹¨ê³„ëŠ” í•œ ë²ˆë§Œ ìˆ˜í–‰í•˜ë©´ ë©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">cp </span>default/mediabot:/etc/ssl/certs/ca-certificates.crt ca-certificates.crt
  
<span class="c">#  ì´ ì¸ì¦ì„œ ë²ˆë“¤ì„ ì‚¬ìš©í•˜ì—¬ Kubernetes ë¹„ë°€ì„ ìƒì„±í•˜ì—¬ Ciliumì´ ì¸ì¦ì„œ ë²ˆë“¤ì„ ì½ê³  ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚˜ê°€ëŠ” TLS ì—°ê²°ì„ ê²€ì¦í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl create secret generic tls-orig-data <span class="nt">-n</span> kube-system <span class="nt">--from-file</span><span class="o">=</span>ca.crt<span class="o">=</span>./ca-certificates.crt
<span class="c"># =&gt; secret/tls-orig-data created</span>
<span class="nv">$ </span>kubectl get secret <span class="nt">-n</span> kube-system tls-orig-data
<span class="c"># =&gt; NAME            TYPE     DATA   AGE</span>
<span class="c">#    tls-orig-data   Opaque   1      7s  </span>
</code></pre></div></div>

<h5 id="apply-dns-and-tls-aware-egress-policy">Apply DNS and TLS-aware Egress Policy</h5>

<ul>
  <li>ì§€ê¸ˆê¹Œì§€ TLS ê²€ì‚¬ë¥¼ í™œì„±í™”í•˜ê¸° ìœ„í•œ í‚¤ì™€ ì¸ì¦ì„œë¥¼ ìƒì„±í–ˆì§€ë§Œ, Ciliumì— ì–´ë–¤ íŠ¸ë˜í”½ì„ ê°€ë¡œì±„ì„œ ê²€ì‚¬í• ì§€ ì•Œë ¤ì£¼ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë‹¤ë¥¸ Cilium ë„¤íŠ¸ì›Œí¬ ì •ì±…ì— ì‚¬ìš©ë˜ëŠ” ê²ƒê³¼ ë™ì¼í•œ Cilium ë„¤íŠ¸ì›Œí¬ ì •ì±… êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜í–‰ë©ë‹ˆë‹¤.</li>
  <li>ë‹¤ìŒ Cilium ë„¤íŠ¸ì›Œí¬ ì •ì±…ì€ Ciliumì´ <code class="language-plaintext highlighter-rouge">mediabot</code>í¬ë“œì™€ . ì‚¬ì´ì˜ í†µì‹ ì— ëŒ€í•´ HTTP ì¸ì‹ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•´ì•¼ í•¨ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤ <code class="language-plaintext highlighter-rouge">httpbin.org</code>.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cilium.io/v2"</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CiliumNetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">l7-visibility-tls"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s">L7 policy with TLS</span>
  <span class="na">endpointSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">org</span><span class="pi">:</span> <span class="s">empire</span>
      <span class="na">class</span><span class="pi">:</span> <span class="s">mediabot</span>
  <span class="na">egress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">toFQDNs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">matchName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">httpbin.org"</span>
    <span class="na">toPorts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">443"</span>
        <span class="na">protocol</span><span class="pi">:</span> <span class="s2">"</span><span class="s">TCP"</span>
      <span class="na">terminatingTLS</span><span class="pi">:</span>
        <span class="na">secret</span><span class="pi">:</span>
          <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kube-system"</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">httpbin-tls-data"</span>
      <span class="na">originatingTLS</span><span class="pi">:</span>
        <span class="na">secret</span><span class="pi">:</span>
          <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kube-system"</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">tls-orig-data"</span>
      <span class="na">rules</span><span class="pi">:</span>
        <span class="na">http</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="pi">{}</span>
  <span class="pi">-</span> <span class="na">toPorts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">53"</span>
        <span class="na">protocol</span><span class="pi">:</span> <span class="s">ANY</span>
      <span class="na">rules</span><span class="pi">:</span>
        <span class="na">dns</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">matchPattern</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>
</code></pre></div></div>

<ul>
  <li>ì¦‰ , ì´ ì •ì±…ì€ ì¶œêµ¬ ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” <code class="language-plaintext highlighter-rouge">endpointSelector</code>ë¼ë²¨ì´ ìˆëŠ” í¬ë“œì—ë§Œ ì ìš©ë©ë‹ˆë‹¤ .<code class="language-plaintext highlighter-rouge">class: mediabot, org:empire</code></li>
  <li>ì²« ë²ˆì§¸ ì¶œêµ¬ ì„¹ì…˜ì—ì„œëŠ” ì‚¬ì–‘ì„ ì‚¬ìš©í•˜ì—¬ TCP í¬íŠ¸ 443 ì¶œêµ¬ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤ .<code class="language-plaintext highlighter-rouge">toFQDNs: matchNamehttpbin.org</code></li>
  <li><code class="language-plaintext highlighter-rouge">http</code>toFQDNs ê·œì¹™ ì•„ë˜ì˜ ì„¹ì…˜ì€ ì´ëŸ¬í•œ ì—°ê²°ì´ ëª¨ë“  ìš”ì²­ì„ í—ˆìš©í•˜ëŠ” ì •ì±…ì— ë”°ë¼ HTTPë¡œ êµ¬ë¬¸ ë¶„ì„ë˜ì–´ì•¼ í•¨ì„ ë‚˜íƒ€ ëƒ…ë‹ˆë‹¤ <code class="language-plaintext highlighter-rouge">{}</code>.</li>
  <li>ë° ì„¹ì…˜ì€ <strong>TLS ê°€ë¡œì±„ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ mediabotì—ì„œì˜ ì´ˆê¸° TLS ì—°ê²°ì„ ì¢…ë£Œ</strong>í•˜ê³  .ì— ëŒ€í•œ <strong>ìƒˆë¡œìš´ ì•„ì›ƒë°”ìš´ë“œ TLS ì—°ê²°ì„ ì‹œì‘</strong>í•´ì•¼ í•¨ì„ ë‚˜íƒ€ <code class="language-plaintext highlighter-rouge">terminatingTLS</code>ëƒ…ë‹ˆë‹¤ .<code class="language-plaintext highlighter-rouge">originatingTLShttpbin.org</code></li>
  <li>ë‘ ë²ˆì§¸ ì¶œêµ¬ ì„¹ì…˜ì€ <code class="language-plaintext highlighter-rouge">mediabot</code>í¬ë“œê°€ <code class="language-plaintext highlighter-rouge">kube-dns</code>ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. Ciliumì´ ì§€ì •ëœ íŒ¨í„´ê³¼ ì¼ì¹˜í•˜ëŠ” DNS ì¡°íšŒë¥¼ ê²€ì‚¬í•˜ê³  í—ˆìš©í•˜ë„ë¡ ì§€ì‹œí•©ë‹ˆë‹¤. ì´ ê²½ìš° ëª¨ë“  DNS ì¿¼ë¦¬ë¥¼ ê²€ì‚¬í•˜ê³  í—ˆìš©í•©ë‹ˆë‹¤.<code class="language-plaintext highlighter-rouge">rules: dns</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§ : hubble cli ë‚˜ ui ì—ì„œ https ì´ë‹ˆ L7 ì •ë³´ í™•ì¸ ë¶ˆê°€ëŠ¥</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> mediabot <span class="nt">-f</span>
  
<span class="c"># </span>
<span class="nv">$ </span>kubectl get pods
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    mediabot                  1/1     Running   0          19m</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> curl <span class="nt">-sL</span> <span class="s1">'https://httpbin.org/anything'</span>
<span class="c"># =&gt; {</span>
<span class="c">#      "args": {},</span>
<span class="c">#      "data": "",</span>
<span class="c">#      "files": {},</span>
<span class="c">#      "form": {},</span>
<span class="c">#      "headers": {</span>
<span class="c">#        "Accept": "*/*",</span>
<span class="c">#        "Host": "httpbin.org",</span>
<span class="c">#        "User-Agent": "curl/7.88.1",</span>
<span class="c">#        "X-Amzn-Trace-Id": "Root=1-68bc1691-6a809d304ab6834b5a89a5ca"</span>
<span class="c">#      },</span>
<span class="c">#      "json": null,</span>
<span class="c">#      "method": "GET",</span>
<span class="c">#      "origin": "211.229.62.113",</span>
<span class="c">#      "url": "https://httpbin.org/anything"</span>
<span class="c">#    }</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> curl <span class="nt">-sL</span> <span class="s1">'https://httpbin.org/headers'</span> <span class="nt">-v</span> <span class="c"># ì„œë²„ ì¸ì¦ì„œ í™•ì¸</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    * Server certificate:</span>
<span class="c">#    *  subject: CN=httpbin.org</span>
<span class="c">#    *  start date: Jul 20 00:00:00 2025 GMT</span>
<span class="c">#    *  expire date: Aug 17 23:59:59 2026 GMT</span>
<span class="c">#    *  subjectAltName: host "httpbin.org" matched cert's "httpbin.org"</span>
<span class="c">#    *  issuer: &lt;span style="color: green;"&gt;C=US; O=Amazon; CN=Amazon RSA 2048 M03&lt;/span&gt; # &lt;span style="color: green;"&gt;ğŸ‘‰ ì›ë˜ì˜ ì¸ì¦ê¸°ê´€(CA)ì—ì„œ ë°œê¸‰í•œ ì¸ì¦ì„œ&lt;/span&gt;</span>
<span class="c">#    *  SSL certificate verify ok.</span>
  
<span class="c"># ì •ì±… ì ìš©</span>
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes-tls-inspection/l7-visibility-tls.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/l7-visibility-tls created</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME                AGE   VALID</span>
<span class="c">#    l7-visibility-tls   7s    True  </span>
</code></pre></div></div>

<h5 id="demonstrating-tls-inspection">Demonstrating TLS Inspection</h5>

<ul>
  <li>ìš°ë¦¬ê°€ í‘¸ì‹œí•œ ì •ì±…ì€ ì—ì„œ <code class="language-plaintext highlighter-rouge">mediabot</code>ë¡œì˜ ëª¨ë“  HTTPS ìš”ì²­ì„ í—ˆìš© <code class="language-plaintext highlighter-rouge">httpbin.org</code>í•˜ì§€ë§Œ ëª¨ë“  ë°ì´í„°ëŠ” HTTP ê³„ì¸µì—ì„œ êµ¬ë¬¸ ë¶„ì„í•œë‹¤ëŠ” ì ì„ ê¸°ì–µí•˜ì„¸ìš”. ì¦‰, cilium monitorëŠ” ëª¨ë“  HTTP ìš”ì²­ê³¼ ì‘ë‹µì„ ë³´ê³ í•©ë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ í™•ì¸í•˜ë ¤ë©´ ìƒˆ ì°½ì„ ì—´ê³  ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ <code class="language-plaintext highlighter-rouge">mediabot</code>í¬ë“œì™€ ë™ì¼í•œ Kubernetes ì›Œì»¤ ë…¸ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì¸ cilium í¬ë“œì˜ ì´ë¦„(ì˜ˆ: cilium-97s78)ì„ ì‹ë³„í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§ : hubble cli ë‚˜ ui ì—ì„œ https ì´ë‹ˆ L7 ì •ë³´ í™•ì¸ ë¶ˆê°€ëŠ¥</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> mediabot <span class="nt">-f</span>
  
<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> curl <span class="nt">-sL</span> <span class="s1">'https://httpbin.org/anything'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> curl <span class="nt">-sL</span> <span class="s1">'https://httpbin.org/headers'</span> <span class="nt">-v</span> <span class="c"># ì„œë²„ ì¸ì¦ì„œ í™•ì¸</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    * Server certificate:</span>
<span class="c">#    *  subject: C=KR; ST=Seoul; L=Seoul; O=cloudneta; OU=study; CN=httpbin.org</span>
<span class="c">#    *  start date: Sep  6 11:00:18 2025 GMT</span>
<span class="c">#    *  expire date: Sep  1 11:00:18 2026 GMT</span>
<span class="c">#    *  common name: httpbin.org (matched)</span>
<span class="c">#    *  issuer: &lt;span style="color: green;"&gt;C=KR; ST=Seoul; L=Seoul; O=cloudneta; OU=study; CN=cloudneta.net&lt;/span&gt; </span>
<span class="c">#  &lt;span style="color: green;"&gt;ğŸ‘‰ ë‚´ë¶€ ì¸ì¦ê¸°ê´€(CA)ì—ì„œ ë°œê¸‰í•œ ì¸ì¦ì„œë¡œ êµì²´ë˜ì–´ ìˆìŠµë‹ˆë‹¤!&lt;/span&gt;</span>
<span class="c">#  &lt;span style="color: green;"&gt;    ì¦‰, ìš°ë¦¬ê°€ ë§Œë“  CAì—ì„œ ë°œê¸‰í•œ ì¸ì¦ì„œë¡œ TLS ì—°ê²°ì´ ë§ºì–´ì§„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°&lt;/span&gt;</span>
<span class="c">#  &lt;span style="color: green;"&gt;    TLS ê°€ë¡œì±„ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ì´ë£¨ì–´ì§„ ê²ƒì…ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#    *  SSL certificate verify ok.</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_18.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>ì›ë˜ëŠ” ì•Œ ìˆ˜ ì—†ì—ˆë˜ L7 ì •ë³´ê°€ ì¸ì¦ì„œ êµì²´í›„ â€œGET /anythingâ€ ìœ¼ë¡œ í™•ì¸ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="ì‹¤ìŠµ-ë¦¬ì†ŒìŠ¤-ì‚­ì œ-1">ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes-dns/dns-sw-app.yaml
<span class="c"># =&gt; pod "mediabot" deleted</span>
<span class="nv">$ </span>kubectl delete cnp l7-visibility-tls
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io "l7-visibility-tls" deleted</span>
<span class="nv">$ </span>kubectl delete secret <span class="nt">-n</span> kube-system tls-orig-data
<span class="c"># =&gt; secret "tls-orig-data" deleted</span>
<span class="nv">$ </span>kubectl delete secret <span class="nt">-n</span> kube-system httpbin-tls-data
<span class="c"># =&gt; secret "httpbin-tls-data" deleted</span>
</code></pre></div></div>

<hr />

<h2 id="tetragon">Tetragon</h2>

<ul>
  <li><strong>Tetragon ì†Œê°œ Youtube ì˜ìƒ</strong> : eCHO Episode 194: Tetragon Everywhere
    <iframe width="560" height="315" src="https://www.youtube.com/embed/JDvmlECqYg4?si=uimpIPgm5g-OeRAJ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
  </li>
  <li>Tetragon Resources - <a href="https://tetragon.io/docs/resources/">Link</a></li>
</ul>

<h3 id="tetragon-ì†Œê°œ">Tetragon ì†Œê°œ</h3>

<ul>
  <li><strong>Tetragon</strong>ì€ <strong>eBPF ê¸°ë°˜ì˜ ëŸ°íƒ€ì„ ë³´ì•ˆ ë° ê´€ì°° ë„êµ¬</strong>ì…ë‹ˆë‹¤. - <a href="https://tetragon.io/docs/overview/">Docs</a></li>
  <li><strong>Linux ì»¤ë„ì˜ ëª¨ë“  í•¨ìˆ˜ì— ì—°ê²°</strong>í•˜ì—¬ ì¸ìˆ˜, ë°˜í™˜ ê°’, Tetragonì´ <strong>í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•´ ìˆ˜ì§‘í•˜ëŠ” ê´€ë ¨ ë©”íƒ€ë°ì´í„°</strong>(ì˜ˆ: ì‹¤í–‰ íŒŒì¼ ì´ë¦„), <strong>íŒŒì¼</strong> ë° ê¸°íƒ€ ì†ì„±ì„ <strong>í•„í„°ë§í• </strong> ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>Kubernetes í™˜ê²½ì„ ì¸ì‹</strong>í•˜ë©°, ë„¤ì„ìŠ¤í˜ì´ìŠ¤, í¬ë“œ ë“±ì˜ Kubernetes IDë¥¼ ì´í•´í•˜ë¯€ë¡œ ê°œë³„ ì‘ì—… ë¶€í•˜ì™€ ê´€ë ¨í•˜ì—¬ ë³´ì•ˆ ì´ë²¤íŠ¸ ê°ì§€ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_19.png" alt="img.png" /></p>

<ul>
  <li><strong>Tetragon</strong>ì€ ë‹¤ìŒê³¼ ê°™ì€ ë³´ì•ˆì— ì¤‘ìš”í•œ ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•˜ê³  ëŒ€ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li><strong>Process</strong> ì‹¤í–‰ ë° ì¢…ë£Œ events</li>
      <li><strong>System</strong> ì½œ í˜¸ì¶œ ë° ë°˜í™˜</li>
      <li>ë„¤íŠ¸ì›Œí¬ì™€ íŒŒì¼ ì•¡ì„¸ìŠ¤ë¥¼ í¬í•¨í•œ <strong>I/O</strong> í™œë™</li>
    </ul>
  </li>
  <li>Kubernetes í™˜ê²½ì—ì„œ Tetragonì„ ì‚¬ìš©í•˜ë©´ Kubernetesë¥¼ ì¸ì‹í•©ë‹ˆë‹¤.
    <ul>
      <li>ì¦‰, ë„¤ì„ìŠ¤í˜ì´ìŠ¤, í¬ë“œ ë“±ì˜ Kubernetes IDë¥¼ ì´í•´í•˜ë¯€ë¡œ ê°œë³„ ì‘ì—… ë¶€í•˜ì™€ ê´€ë ¨í•˜ì—¬ ë³´ì•ˆ ì´ë²¤íŠ¸ ê°ì§€ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h5 id="ê¸°ëŠ¥-ê°œìš”">ê¸°ëŠ¥ ê°œìš”</h5>

<ul>
  <li><strong>eBPF ì‹¤ì‹œê°„ ì²˜ë¦¬</strong>
    <ul>
      <li>ëª¨ë“  ì •ì±…ê³¼ í•„í„°ë§ì„ <strong>ì»¤ë„ ë‚´ë¶€ eBPF</strong>ì—ì„œ ì§ì ‘ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        <ul>
          <li>ì´ë²¤íŠ¸ë¥¼ ìœ ì € ê³µê°„ìœ¼ë¡œ ë³´ë‚´ì§€ ì•Šê³  ì»¤ë„ì—ì„œ ì°¨ë‹¨/ë°˜ì‘ ì²˜ë¦¬ â†’ ì„±ëŠ¥ í–¥ìƒ.</li>
        </ul>
      </li>
      <li>ê³ ë¹ˆë„ ì´ë²¤íŠ¸(send, read, write ë“±)ë„ ì»¤ë„ì—ì„œ ë°”ë¡œ í•„í„°ë§í•˜ë¯€ë¡œ <strong>ê´€ì¸¡ ì˜¤ë²„í—¤ë“œê°€ ê°ì†Œ</strong>ë©ë‹ˆë‹¤.</li>
      <li>íŒŒì¼, ì†Œì¼“, ë°”ì´ë„ˆë¦¬ ì´ë¦„, ë„¤ì„ìŠ¤í˜ì´ìŠ¤, ê¶Œí•œ(capabilities) ë“± <strong>ì„¸ë¶€ í•„í„°ë§ì„ ì§€ì›</strong>í•©ë‹ˆë‹¤.</li>
      <li>ì´ë ‡ê²Œ ì§€ì •ëœ ì´ë²¤íŠ¸ë§Œ ìœ ì € ê³µê°„ìœ¼ë¡œ ì „ë‹¬í•˜ë¯€ë¡œ ìì› ì‚¬ìš© íš¨ìœ¨ì ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li><strong>eBPF ìœ ì—°í•œ ì¶”ì </strong>
    <ul>
      <li>Tetragonì€ <strong>ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì˜ ëª¨ë“  í•¨ìˆ˜ì— ì—°ê²°(hook)ì´ ê°€ëŠ¥</strong>í•˜ê³ , ì´ë¥¼ í†µí•´
í•¨ìˆ˜ì˜ ì¸ì, ë°˜í™˜ê°’, í”„ë¡œì„¸ìŠ¤/íŒŒì¼ ë©”íƒ€ë°ì´í„° ë“± ë‹¤ì–‘í•œ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§í•©ë‹ˆë‹¤.</li>
      <li>ì‚¬ìš©ìê°€ ì§ì ‘ <strong>íŠ¸ë ˆì´ì‹± ì •ì±…(tracing policy)</strong>ì„ ì‘ì„±í•´ ë³´ì•ˆ/ê´€ì¸¡ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ í•´ê²° ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li>ì €ì¥ì†Œì—ëŠ” ì—¬ëŸ¬ ì˜ˆì‹œê°€ ì œê³µë˜ë©°, ì‚¬ìš©ìëŠ” ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ <strong>ìì‹ ë§Œì˜ ì •ì±…</strong>ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>íŠ¹ì • ì»¤ë„ í•¨ìˆ˜ ì¶”ì ë„ ê°€ëŠ¥í•˜ë©°, <strong>ì—”ì§„ì— í•˜ë“œì½”ë”©ëœ ì œí•œ ì—†ìŠµë‹ˆë‹¤.</strong></li>
      <li>ì‹œìŠ¤í…œì½œ íŠ¸ë ˆì´ì‹±ì—ì„œ í”íˆ ë°œìƒí•˜ëŠ” ë¬¸ì œ(ì˜ëª»ëœ ë°ì´í„° ì½ê¸°, ì•…ì˜ì  ì¡°ì‘, í˜ì´ì§€ í´íŠ¸ ëˆ„ë½ ë“±)ë¥¼ <strong>ì»¤ë„ ê¹Šìˆ™í•œ ê³³ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ í›…í‚¹</strong>í•˜ì—¬ íšŒí”¼í•©ë‹ˆë‹¤.</li>
      <li>ê°œë°œì ë‹¤ìˆ˜ê°€ ì»¤ë„ ê°œë°œ ê²½í—˜ì„ ê°–ê³  ìˆì–´, ë‹¤ì–‘í•œ <strong>ë³´ì•ˆ ë° ê´€ì¸¡ ìœ ìŠ¤ì¼€ì´ìŠ¤ë¥¼ ì§€ì›í•˜ëŠ” ì •ì±… ì„¸íŠ¸</strong>ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li><strong>eBPFì„ í†µí•œ ì»¤ë„ ì¸ì‹</strong>
    <ul>
      <li>eBPFë¥¼ í†µí•´ Tetragonì€ <strong>ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ìƒíƒœì— ì§ì ‘ ì ‘ê·¼</strong>í•©ë‹ˆë‹¤.</li>
      <li>ì´ë¥¼ ì¿ ë²„ë„¤í‹°ìŠ¤ ì •ë³´ë‚˜ ì‚¬ìš©ì ì •ì±…ê³¼ ê²°í•©í•´ <strong>ì‹¤ì‹œê°„ ì»¤ë„ ë ˆë²¨ ê·œì¹™ ì ìš©</strong>ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li>ì˜ˆë¥¼ ë“¤ì–´, <strong>ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ê¶Œí•œì„ ë³€ê²½</strong>í•  ë•Œ, í•´ë‹¹ <strong>í”„ë¡œì„¸ìŠ¤ê°€ ì‹œìŠ¤í…œ í˜¸ì¶œì„ ì™„ë£Œ</strong>í•˜ê³  ì¶”ê°€ ì‹œìŠ¤í…œ í˜¸ì¶œì„ ì‹¤í–‰í•˜ê¸° ì „ì— <strong>ê²½ê³ ë¥¼ ë°œìƒ</strong>ì‹œí‚¤ê±°ë‚˜ <strong>í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œí•˜ëŠ” ì •ì±…ì„ ìƒì„±</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="tetragon-ì„¤ì¹˜">Tetragon ì„¤ì¹˜</h3>

<ul>
  <li><a href="https://tetragon.io/docs/getting-started/">ê´€ë ¨ë¬¸ì„œ</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /proc íŒŒì¼ ì‹œìŠ¤í…œ ì•¡ì„¸ìŠ¤ í•„ìš”.</span>
<span class="c"># ê¸°ë³¸ì ìœ¼ë¡œ Tetragonì€ ì´ë²¤íŠ¸ ë¡œê·¸ì˜ ë…¸ì´ì¦ˆë¥¼ ì¤„ì´ê¸° ìœ„í•´ kube-system ì´ë²¤íŠ¸ë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤. </span>
<span class="nv">$ </span>helm repo add cilium https://helm.cilium.io
<span class="nv">$ </span>helm repo update
<span class="c"># =&gt; ...Successfully got an update from the "cilium" chart repository</span>
<span class="c">#    Update Complete. âˆHappy Helming!âˆ</span>
<span class="nv">$ </span>helm <span class="nb">install </span>tetragon cilium/tetragon <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME: tetragon</span>
<span class="c">#    LAST DEPLOYED: Sat Sep  6 21:14:53 2025</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="nv">$ </span>kubectl rollout status <span class="nt">-n</span> kube-system ds/tetragon <span class="nt">-w</span>
<span class="c"># =&gt; daemon set "tetragon" successfully rolled out</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get deploy tetragon-operator <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS          IMAGES                                    SELECTOR</span>
<span class="c">#    tetragon-operator   1/1     1            1           37s   tetragon-operator   quay.io/cilium/tetragon-operator:v1.5.0   app.kubernetes.io/instance=tetragon,app.kubernetes.io/name=tetragon-operator</span>
<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get cm tetragon-operator-config tetragon-config
<span class="c"># =&gt; NAME                       DATA   AGE</span>
<span class="c">#    tetragon-operator-config   9      45s</span>
<span class="c">#    tetragon-config            33     45s</span>

<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get ds tetragon <span class="nt">-owide</span>
<span class="c"># =&gt; NAME       DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE   CONTAINERS               IMAGES                                                                      SELECTOR</span>
<span class="c">#    tetragon   3         3         3       3            3           &lt;none&gt;          54s   export-stdout,tetragon   quay.io/cilium/hubble-export-stdout:v1.1.0,quay.io/cilium/tetragon:v1.5.0   app.kubernetes.io/instance=tetragon,app.kubernetes.io/name=tetragon</span>
<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get svc,ep tetragon
<span class="c"># =&gt; NAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/tetragon   ClusterIP   10.96.248.15   &lt;none&gt;        2112/TCP   75s</span>
<span class="c">#    </span>
<span class="c">#    NAME                 ENDPOINTS                                                     AGE</span>
<span class="c">#    endpoints/tetragon   192.168.10.100:2112,192.168.10.101:2112,192.168.10.102:2112   75s</span>
<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get svc,ep tetragon-operator-metrics
<span class="c"># =&gt; NAME                                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/tetragon-operator-metrics   ClusterIP   10.96.105.200   &lt;none&gt;        2113/TCP   83s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                  ENDPOINTS          AGE</span>
<span class="c">#    endpoints/tetragon-operator-metrics   172.20.1.32:2113   83s</span>

<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get pod <span class="nt">-l</span> app.kubernetes.io/part-of<span class="o">=</span>tetragon <span class="nt">-owide</span>
<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get pod <span class="nt">-l</span> app.kubernetes.io/name<span class="o">=</span>tetragon
<span class="nv">$ </span>kc <span class="nt">-n</span> kube-system describe pod <span class="nt">-l</span> app.kubernetes.io/name<span class="o">=</span>tetragon
<span class="c"># =&gt; ...</span>
<span class="c">#    Containers:</span>
<span class="c">#      export-stdout:</span>
<span class="c">#        Container ID:  containerd://eb8abd117200c08e26b7efc02ae15ff14a618d1fa282b30530db973468ad1dcf</span>
<span class="c">#        Image:         quay.io/cilium/hubble-export-stdout:v1.1.0</span>
<span class="c">#    ...</span>
<span class="c">#      tetragon:</span>
<span class="c">#        Container ID:  containerd://7b283b22db614b6288a01c09e302349720d85e64ab85d449173abec9597ddce8</span>
<span class="c">#        Image:         quay.io/cilium/tetragon:v1.5.0</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>ë°ëª¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/v1.18.1/examples/minikube/http-sw-app.yaml
<span class="c"># =&gt; service/deathstar created</span>
<span class="c">#    deployment.apps/deathstar created</span>
<span class="c">#    pod/tiefighter created</span>
<span class="c">#    pod/xwing created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get pods
<span class="c"># =&gt; NAME                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    deathstar-86f85ffb4d-2z9dv   1/1     Running   0          23s</span>
<span class="c">#    deathstar-86f85ffb4d-djnhm   1/1     Running   0          23s</span>
<span class="c">#    tiefighter                   1/1     Running   0          23s</span>
<span class="c">#    xwing                        1/1     Running   0          23s</span>
</code></pre></div></div>

<h3 id="ì‹¤í–‰-ëª¨ë‹ˆí„°ë§">ì‹¤í–‰ ëª¨ë‹ˆí„°ë§</h3>

<ul>
  <li>ì‹œìŠ¤í…œì˜ ëª¨ë“  ì‹¤í–‰ì„ ì¶”ì í•©ë‹ˆë‹¤. - <a href="https://tetragon.io/docs/getting-started/execution/">Docs</a>, <a href="https://yuki-nakamura.com/2024/05/23/tetragon-process-lifecycle-observation-tetragon-agent-part/">Blog</a></li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_20.png" alt="img.png" class="image-center" />
<em class="image-caption"><a href="https://isovalent.com/blog/post/top-tetragon-use-cases/">https://isovalent.com/blog/post/top-tetragon-use-cases/</a></em></p>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_21.png" alt="img_1.png" class="image-center" />
<em class="image-caption"><a href="https://yuki-nakamura.com/2024/05/23/tetragon-process-lifecycle-observation-tetragon-agent-part/">https://yuki-nakamura.com/2024/05/23/tetragon-process-lifecycle-observation-tetragon-agent-part/</a></em></p>

<ul>
  <li>Tetragonì€ ì‹¤í–‰ ì´ë²¤íŠ¸ë¥¼ JSON ë¡œê·¸ì™€ GRPC ìŠ¤íŠ¸ë¦¼ì„ í†µí•´ ê³µê°œí•©ë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ì´ë¥¼ í†µí•´ ì‹œìŠ¤í…œì˜ ëª¨ë“  ì‹¤í–‰ ê³¼ì •ì„ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì—¬ëŸ¬ ë…¸ë“œê°€ ìˆëŠ” í´ëŸ¬ìŠ¤í„°ì—ì„œëŠ” ì‚¬ìš©í•˜ëŠ” Tetragon Podê°€ "xwing" Podì™€ ë™ì¼í•œ ë…¸ë“œì— ìˆì–´ì•¼ ì‹¤í–‰ ì´ë²¤íŠ¸ë¥¼ ìº¡ì²˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
<span class="c"># ì´ ëª…ë ¹ì„ ì‚¬ìš©í•˜ë©´ "**xwing**" Podì™€ ë™ì¼í•œ Kubernetes **ë…¸ë“œ**ì— ìˆëŠ” **Tetragon Podì˜ ì´ë¦„ì„** ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ POD</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> kube-system get pods <span class="nt">-l</span> <span class="s1">'app.kubernetes.io/name=tetragon'</span> <span class="nt">-o</span> name <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span><span class="si">$(</span>kubectl get pod xwing <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.nodeName}'</span><span class="si">))</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$POD</span>
<span class="c"># =&gt; pod/tetragon-fwccq</span>
  
<span class="c"># í„°ë¯¸ë„1</span>
<span class="c"># ì¼ì¹˜í•˜ëŠ” Podë¥¼ ì‹ë³„í•œ í›„ í•´ë‹¹ Podë¥¼ ëŒ€ìƒìœ¼ë¡œ ì§€ì •í•˜ì—¬ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤ : Tetragonì—ì„œ ìº¡ì²˜í•œ ì‹¤í–‰ ì´ë²¤íŠ¸ë¥¼ ë°˜í™˜</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra <span class="nt">-h</span>
<span class="c"># ì••ì¶• ì‹¤í–‰ ì´ë²¤íŠ¸ì—ëŠ” ì´ë²¤íŠ¸ ìœ í˜•, í¬ë“œ ì´ë¦„, ë°”ì´ë„ˆë¦¬, ì¸ìˆ˜ê°€ í¬í•¨ë©ë‹ˆë‹¤. ì¢…ë£Œ ì´ë²¤íŠ¸ì—ëŠ” ë°˜í™˜ ì½”ë“œê°€ í¬í•¨ë©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
  
<span class="c">## JSON í˜•ì‹ìœ¼ë¡œ ì „ì²´ ì‹¤í–‰ ì´ë²¤íŠ¸ë¥¼ ë³´ë ¤ë©´ ëª…ë ¹ -o compactì—ì„œ ì˜µì…˜ì„ ì œê±°</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">--pods</span> xwing
  
<span class="c"># í„°ë¯¸ë„2</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'curl https://ebpf.io/applications/#tetragon'</span>

<span class="c"># í„°ë¯¸í„¸ 1</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; ğŸš€ process default/xwing /usr/bin/bash -c "curl https://ebpf.io/applications/#tetragon"</span>
<span class="c">#    ğŸš€ process default/xwing /usr/bin/curl https://ebpf.io/applications/#tetragon</span>
<span class="c">#    ğŸ’¥ exit    default/xwing /usr/bin/curl https://ebpf.io/applications/#tetragon 0 </span>

<span class="c"># í„°ë¯¸ë„2</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'curl https://httpbin.org'</span>

<span class="c"># í„°ë¯¸í„¸ 1</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; ğŸš€ process default/xwing /usr/bin/bash -c "curl https://httpbin.org"</span>
<span class="c">#    ğŸš€ process default/xwing /usr/bin/curl https://httpbin.org</span>
<span class="c">#    ğŸ’¥ exit    default/xwing /usr/bin/curl https://httpbin.org 0</span>

<span class="c"># í„°ë¯¸ë„2</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'cat /etc/passwd'</span>

<span class="c"># í„°ë¯¸í„¸ 1</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; ğŸš€ process default/xwing /usr/bin/bash -c "cat /etc/passwd"</span>
<span class="c">#    ğŸš€ process default/xwing /usr/bin/cat /etc/passwd</span>
<span class="c">#    ğŸ’¥ exit    default/xwing /usr/bin/cat /etc/passwd 0</span>
</code></pre></div></div>

<h3 id="íŒŒì¼-ì ‘ì†-ëª¨ë‹ˆí„°ë§">íŒŒì¼ ì ‘ì† ëª¨ë‹ˆí„°ë§</h3>

<ul>
  <li>ì¶”ì  ì •ì±…ìœ¼ë¡œ ë¯¼ê° íŒŒì¼ ëª¨ë‹ˆí„°ë§ - <a href="https://tetragon.io/docs/getting-started/file-events/">Docs</a>, <a href="https://isovalent.com/blog/post/file-monitoring-with-ebpf-and-tetragon-part-1/">Blog</a></li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_22.png" alt="img.png" class="image-center" />
<em class="image-caption"><a href="https://isovalent.com/blog/post/file-monitoring-with-ebpf-and-tetragon-part-1/">https://isovalent.com/blog/post/file-monitoring-with-ebpf-and-tetragon-part-1/</a></em></p>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_23.png" alt="img_1.png" class="image-center" />
<em class="image-caption">Figure 3: In-kernel vs user-space filtering</em></p>

<ul>
  <li>YAML êµ¬ì„± íŒŒì¼ì„ í†µí•´ Tetragonì— <strong>ì¶”ì  ì •ì±…</strong>ì„ ì¶”ê°€í•˜ë©´ Tetragonì˜ ê¸°ë³¸ ì‹¤í–‰ ì¶”ì  ê¸°ëŠ¥ì„ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ëŸ¬í•œ ì •ì±…ì€ <strong>ì»¤ë„ì—ì„œ í•„í„°ë§ì„ ìˆ˜í–‰</strong>í•˜ì—¬ ì»¤ë„ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ BPF í”„ë¡œê·¸ë¨ì—ì„œ <strong>ê´€ì‹¬ ìˆëŠ” ì´ë²¤íŠ¸</strong>ë§Œ <strong>ì‚¬ìš©ì ê³µê°„ì— ê²Œì‹œ</strong>ë˜ë„ë¡ í•©ë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ í†µí•´ ì‚¬ìš©ëŸ‰ì´ ë§ì€ ì‹œìŠ¤í…œì—ì„œë„ <strong>ì˜¤ë²„í—¤ë“œë¥¼ ë‚®ê²Œ ìœ ì§€</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì•„ë˜ì˜ ManifestëŠ” <a href="https://tetragon.io/docs/getting-started/execution/">ì‹¤í–‰ ëª¨ë‹ˆí„°ë§</a> ì˜ ì˜ˆì‹œë¥¼ í™•ì¥í•˜ì—¬ Linuxì—ì„œ <strong>ë¯¼ê°í•œ íŒŒì¼ì„ ëª¨ë‹ˆí„°ë§</strong>í•˜ëŠ” ì •ì±…ì„ ì ìš©í•©ë‹ˆë‹¤.</li>
  <li>ë¯¼ê° íŒŒì¼ ëª¨ë‹ˆí„°ë§ ì •ì±… ì ìš©</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># file_monitoring.yaml</span>
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: <span class="s2">"file-monitoring-filtered"</span>
spec:
  kprobes:
  - call: <span class="s2">"security_file_permission"</span>
    syscall: <span class="nb">false
    </span><span class="k">return</span>: <span class="nb">true
    </span>args:
    - index: 0
      <span class="nb">type</span>: <span class="s2">"file"</span> <span class="c"># (struct file *) used for getting the path</span>
    - index: 1
      <span class="nb">type</span>: <span class="s2">"int"</span> <span class="c"># 0x04 is MAY_READ, 0x02 is MAY_WRITE</span>
    returnArg:
      index: 0
      <span class="nb">type</span>: <span class="s2">"int"</span>
    returnArgAction: <span class="s2">"Post"</span>
    selectors:
    - matchArgs:      
      - index: 0
        operator: <span class="s2">"Prefix"</span>
        values:
        - <span class="s2">"/boot"</span>           <span class="c"># Reads to sensitive directories</span>
        - <span class="s2">"/root/.ssh"</span>      <span class="c"># Reads to sensitive files we want to know about</span>
        - <span class="s2">"/etc/shadow"</span>
        - <span class="s2">"/etc/profile"</span>
        - <span class="s2">"/etc/sudoers"</span>
        - <span class="s2">"/etc/pam.conf"</span>   <span class="c"># Reads global shell configs bash/csh supported</span>
        - <span class="s2">"/etc/bashrc"</span>
        - <span class="s2">"/etc/csh.cshrc"</span>
        - <span class="s2">"/etc/csh.login"</span>  <span class="c"># Add additional sensitive files here</span>
      - index: 1
        operator: <span class="s2">"Equal"</span>
        values:
        - <span class="s2">"4"</span> <span class="c"># MAY_READ</span>

<span class="c"># Manifest ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/tetragon/main/examples/quickstart/file_monitoring.yaml
<span class="c"># =&gt; tracingpolicy.cilium.io/file-monitoring-filtered created</span>
<span class="nv">$ </span>kubectl get tracingpolicy
<span class="c"># =&gt; NAME                       AGE</span>
<span class="c">#    file-monitoring-filtered   55s</span>
</code></pre></div></div>

<ul>
  <li><strong>Tetragon íŒŒì¼ ì•¡ì„¸ìŠ¤ ì´ë²¤íŠ¸ ê´€ì°°</strong></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„2 : ì´ë²¤íŠ¸ë¥¼ ìƒì„±í•˜ê¸°ìœ„ì•  ì •ì±…ì— ì°¸ì¡°ëœ ì¤‘ìš”í•œ(ë¯¼ê°í•œ) íŒŒì¼ì„ ì½ì–´ë³´ì„¸ìš”</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'cat /etc/shadow'</span>

<span class="c"># í„°ë¯¸ë„1</span>
<span class="nv">$ POD</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> kube-system get pods <span class="nt">-l</span> <span class="s1">'app.kubernetes.io/name=tetragon'</span> <span class="nt">-o</span> name <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span><span class="si">$(</span>kubectl get pod xwing <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.nodeName}'</span><span class="si">))</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; ğŸš€ process default/xwing /usr/bin/bash -c "cat /etc/shadow"</span>
<span class="c">#    ğŸš€ process default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    ğŸ“š read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    ğŸ“š read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    ğŸ“š read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    ğŸ“š read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    ğŸ’¥ exit    default/xwing /usr/bin/cat /etc/shadow 0  </span>

<span class="c"># í„°ë¯¸ë„2 : ì¶”ì  ì •ì±…ì— ë”°ë¼ Tetragonì€ ë¯¼ê°í•œ ë””ë ‰í† ë¦¬ì— ì“°ê¸°ë¥¼ ì‹œë„í•˜ëŠ” ê²½ìš°(ì˜ˆ: /etcë””ë ‰í† ë¦¬ì— ì“°ê¸°ë¥¼ ì‹œë„í•˜ëŠ” ê²½ìš°)ì— ëŒ€í•œ ì‘ë‹µìœ¼ë¡œ ì“°ê¸° ì´ë²¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'echo foo &gt;&gt; /etc/bar'</span>

<span class="c"># í„°ë¯¸ë„1</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; ğŸš€ process default/xwing /usr/bin/bash -c "echo foo &gt;&gt; /etc/bar"</span>
<span class="c">#    ğŸ“ write   default/xwing /usr/bin/bash /etc/bar</span>
<span class="c">#    ğŸ“ write   default/xwing /usr/bin/bash /etc/bar</span>
<span class="c">#    ğŸ’¥ exit    default/xwing /usr/bin/bash -c "echo foo &gt;&gt; /etc/bar" 0 </span>

<span class="c"># ì •ì±… ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/tetragon/main/examples/quickstart/file_monitoring.yaml
<span class="c"># =&gt; tracingpolicy.cilium.io "file-monitoring-filtered" deleted</span>
</code></pre></div></div>

<h3 id="policy-enforcement">Policy Enforcement</h3>

<ul>
  <li>ì»¤ë„ ìˆ˜ì¤€ì—ì„œ ì •ì±… ì œí•œì„ ì ìš©ê´€ë ¨ ë‚´ìš©ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. - <a href="https://tetragon.io/docs/getting-started/enforcement/">Docs</a></li>
  <li>Tetragonì˜ ì¶”ì  ì •ì±…ì€ íŒŒì¼ ì•¡ì„¸ìŠ¤ ì´ë²¤íŠ¸ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì´ë²¤íŠ¸ì™€ ê°™ì€ ì´ë²¤íŠ¸ë¥¼ ë³´ê³ í•˜ê¸° ìœ„í•´ ì»¤ë„ í•¨ìˆ˜ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ê³ , í•´ë‹¹ ì»¤ë„ í•¨ìˆ˜ì— ì œí•œì„ ì ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•©ë‹ˆë‹¤.</li>
  <li>Tetragonì—ì„œ ì»¤ë„ ë‚´ í•„í„°ë§ì„ ì‚¬ìš©í•˜ë©´ ì»¤ë„ì—ì„œ ì‚¬ìš©ì ê³µê°„ìœ¼ë¡œ ì „ì†¡ë˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ì œí•œí•˜ì—¬ ì„±ëŠ¥ì„ í¬ê²Œ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë˜í•œ, ì»¤ë„ ë‚´ í•„í„°ë§ì„ í†µí•´ Tetragonì€ ì»¤ë„ ìˆ˜ì¤€ì—ì„œ ì •ì±… ì œí•œì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì˜ˆë¥¼ ë“¤ì–´, <code class="language-plaintext highlighter-rouge">SIGKILL</code>ì •ì±… ìœ„ë°˜ì´ ê°ì§€ë˜ì—ˆì„ ë•Œ í”„ë¡œì„¸ìŠ¤ì— ë¥¼ ì‹¤í–‰í•˜ë©´ í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ëŠ” ë” ì´ìƒ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
  <li>ì •ì±… ì ìš©ì´ ì‹œìŠ¤í…œ í˜¸ì¶œì„ í†µí•´ íŠ¸ë¦¬ê±°ë˜ëŠ” ê²½ìš°, ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ì‹œìŠ¤í…œ í˜¸ì¶œì—ì„œ ë°˜í™˜ë˜ì§€ ì•Šê³  ì¢…ë£Œë©ë‹ˆë‹¤.</li>
  <li>ì´ ì„¹ì…˜ì—ì„œëŠ” ì´ ì‹œì‘ ê°€ì´ë“œì—ì„œ ì´ë¯¸ ë°°í¬í•œ Tetragon ê¸°ëŠ¥(ì‹¤í–‰, íŒŒì¼ ì¶”ì  ë° ë„¤íŠ¸ì›Œí¬ ì¶”ì  ì •ì±…)ì— ì•„ë˜ì˜ ë„¤íŠ¸ì›Œí¬ ë° íŒŒì¼ ì •ì±… ì ìš©ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
    <ul>
      <li>Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ ë‚˜ê°€ëŠ” <strong>ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ì œí•œ</strong>í•˜ëŠ” ì •ì±… ì ìš©</li>
      <li><strong>ë¯¼ê°í•œ íŒŒì¼ì— ë¸”ë¡ ì“°ê¸° ë° ì½ê¸° ì‘ì—…</strong> ì ìš©</li>
    </ul>
  </li>
  <li>êµ¬ì²´ì ì¸ êµ¬í˜„ ì„¸ë¶€ ì‚¬í•­ì€ <a href="https://tetragon.io/docs/concepts/enforcement/">ì‹œí–‰</a> ê°œë… ì„¹ì…˜ì„ ì°¸ì¡°í•˜ì„¸ìš”.</li>
</ul>

<h5 id="íŒŒì¼-ì•¡ì„¸ìŠ¤-ì œí•œ-ì ìš©">íŒŒì¼ ì•¡ì„¸ìŠ¤ ì œí•œ ì ìš©</h5>

<ul>
  <li><a href="https://tetragon.io/docs/getting-started/file-events/">ë‹¤ìŒì€ íŒŒì¼ ì•¡ì„¸ìŠ¤ ëª¨ë‹ˆí„°ë§</a> ì˜ ì˜ˆì‹œë¥¼ ì ìš©í•˜ì—¬ ë¯¼ê°í•œ íŒŒì¼ì´ ì½íˆì§€ ì•Šë„ë¡ í™•ì¥í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.</li>
  <li>ì‚¬ìš©ë˜ëŠ” ì •ì±…ì€ ì´ë©° <a href="https://github.com/cilium/tetragon/blob/main/examples/quickstart/file_monitoring_enforce.yaml"><code class="language-plaintext highlighter-rouge">file_monitoring_enforce.yaml</code></a>, í•„ìš”ì— ë”°ë¼ ê²€í† í•˜ê³  í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê´€ì°° ì •ì±…ê³¼ ì ìš© ì •ì±…ì˜ ìœ ì¼í•œ ì°¨ì´ì ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì‘ì—… ë¸”ë¡ì„ ì¶”ê°€ <code class="language-plaintext highlighter-rouge">SIGKILL</code>í•˜ê³  ì‘ì—… ì‹œ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># file_monitoring_enforce.yaml : matchaction í™•ì¸</span>
apiVersion: cilium.io/v1alpha1
kind: TracingPolicyNamespaced
metadata:
  name: <span class="s2">"file-monitoring-filtered"</span>
spec:
  kprobes:
  - call: <span class="s2">"security_file_permission"</span>
    syscall: <span class="nb">false
    </span><span class="k">return</span>: <span class="nb">true
    </span>args:
    - index: 0
      <span class="nb">type</span>: <span class="s2">"file"</span> <span class="c"># (struct file *) used for getting the path</span>
    - index: 1
      <span class="nb">type</span>: <span class="s2">"int"</span> <span class="c"># 0x04 is MAY_READ, 0x02 is MAY_WRITE</span>
    returnArg:
      index: 0
      <span class="nb">type</span>: <span class="s2">"int"</span>
    returnArgAction: <span class="s2">"Post"</span>
    selectors:
    - matchArgs:
      - index: 0
        operator: <span class="s2">"Prefix"</span>
        values:
        - <span class="s2">"/boot"</span>           <span class="c"># Reads to sensitive directories</span>
        - <span class="s2">"/root/.ssh"</span>      <span class="c"># Reads to sensitive files we want to know about</span>
        - <span class="s2">"/etc/shadow"</span>
        - <span class="s2">"/etc/profile"</span>
        - <span class="s2">"/etc/sudoers"</span>
        - <span class="s2">"/etc/pam.conf"</span>   <span class="c"># Reads global shell configs bash/csh supported</span>
        - <span class="s2">"/etc/bashrc"</span>
        - <span class="s2">"/etc/csh.cshrc"</span>
        - <span class="s2">"/etc/csh.login"</span>  <span class="c"># Add additional sensitive files here</span>
      - index: 1
        operator: <span class="s2">"Equal"</span>
        values:
        - <span class="s2">"4"</span> <span class="c"># MAY_READ</span>
      matchActions:
      - action: Sigkill
...
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/tetragon/main/examples/quickstart/file_monitoring_enforce.yaml
<span class="c"># =&gt; tracingpolicynamespaced.cilium.io/file-monitoring-filtered created</span>
<span class="nv">$ </span>kubectl get tracingpolicynamespaced
<span class="c"># =&gt; NAME                       AGE</span>
<span class="c">#    file-monitoring-filtered   11s</span>
  
<span class="c"># í„°ë¯¸ë„1</span>
<span class="nv">$ POD</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> kube-system get pods <span class="nt">-l</span> <span class="s1">'app.kubernetes.io/name=tetragon'</span> <span class="nt">-o</span> name <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span><span class="si">$(</span>kubectl get pod xwing <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.nodeName}'</span><span class="si">))</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; ğŸš€ process default/xwing /usr/bin/bash -c "cat /etc/shadow"</span>
<span class="c">#    ğŸš€ process default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    ğŸ“š read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    ğŸ“š read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    ğŸ’¥ exit    default/xwing /usr/bin/cat /etc/shadow &lt;span style="color: green;"&gt;SIGKILL&lt;/span&gt;</span>
  
<span class="c"># í„°ë¯¸ë„2 : ì •ì˜ëœ ì •ì±…ì— í¬í•¨ëœ íŒŒì¼ ì¤‘ í•˜ë‚˜ì¸ ë¯¼ê°í•œ íŒŒì¼ì„ ì½ì–´ë³´ì„¸ìš”</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'cat /etc/shadow'</span>
<span class="c"># =&gt; command terminated with exit code 137</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì´ë²ˆì—ëŠ” "cat /etc/shadow" ëª…ë ¹ì´ SIGKILLë¡œ ì¸í•´ ì¢…ë£Œëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
  
<span class="c"># ì‹œí–‰ëœ íŒŒì¼ ì •ì±…ì— í¬í•¨ë˜ì§€ ì•Šì€ íŒŒì¼ì„ ì½ê±°ë‚˜ ì“°ë ¤ëŠ” ì‹œë„ëŠ” ì˜í–¥ì„ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'echo foo &gt; /tmp/test.txt'</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; ğŸš€ process default/xwing /usr/bin/bash -c "echo foo &gt; /tmp/test.txt"</span>
<span class="c">#    ğŸ’¥ exit    default/xwing /usr/bin/bash -c "echo foo &gt; /tmp/test.txt" 0  </span>
</code></pre></div></div>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>Cilium Securityì™€ Tetragonì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.
Cilium ìì²´ë„ ë‹¤ì–‘í•œ ë³´ì•ˆ ê¸°ëŠ¥ì„ ì œê³µí•˜ê³  ìˆëŠ”ë° Tetragonê¹Œì§€ ë”í•´ì§€ë‹ˆ
ë‹¤ì–‘í•œ ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±ì‹œí‚¬ ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
TLS Interception ê¸°ëŠ¥ë„ í¥ë¯¸ë¡œì› ëŠ”ë° ì™„ì „ MITM ê³µê²©ì¸ê²ƒ ê°™ìœ¼ë©´ì„œë„
íŠ¸ëŸ¬ë¸” ìŠˆíŒ…ì— í° ë„ì›€ì´ ë  ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<p>ë²Œì¨ Cilium ìŠ¤í„°ë””ê°€ ëë‚¬ìŠµë‹ˆë‹¤.
Cilium ì„¤ì¹˜ì™€ ê¸°ë³¸ ì„¤ì •ì—ì„œ ë¶€í„°, Hubbleì„ ë¹„ë¡¯í•œ ê´€ì¸¡ì„±ê³¼ íŒŒë“œ ë„¤íŠ¸ì›Œí¬ ìƒì„¸, BGP ë¼ìš°íŒ…, ì„œë¹„ìŠ¤ë©”ì‹œ, Performance, Securityì™€ Tetragon ë“±ë“±
ë”°ë¼ê°€ê¸°ë„ ë²…ì°¼ì§€ë§Œ ë§ì€ ê²ƒì„ ë°°ìš¸ ìˆ˜ ìˆì—ˆë˜ ì‹œê°„ì´ì—ˆìŠµë‹ˆë‹¤.
ë§¤ì£¼ ìŠ¤í„°ë”” ë§ˆë‹¤ ëŠë‚€ ì ì€ Ciliumì˜ ìƒíƒœê³„ëŠ” ì •ë§ ë„“ê³  ê¹Šë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
ì•ìœ¼ë¡œë„ ê¾¸ì¤€íˆ ê³µë¶€í•˜ê³  ì‹¤ìŠµí•˜ë©´ì„œ ìµí˜€ë‚˜ê°€ì•¼ í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<p>ì‹¤ìŠµí• ë•Œ ë³µì¡í•œ Kubernetes êµ¬ì„±ì´ í•„ìš”í•œ ê²½ìš°ë„ ë§ì•˜ëŠ”ë°
ë§¤ë²ˆ í¸ë¦¬í•˜ê²Œ í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ì…”ì„œ í™˜ê²½ êµ¬ì„±ì—ëŠ” ì–´ë ¤ì›€ì—†ì´ ì§„í–‰í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
ë§¤ì£¼ ì‹¤ìŠµìë£Œ ì¤€ë¹„ì™€ ì§„í–‰ì— ì• ì¨ì£¼ì‹  ê°€ì‹œë‹¤ ë‹˜ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤. :bow:</p>]]></content><author><name></name></author><category term="cilium" /><category term="kubernetes," /><category term="network," /><category term="linux," /><category term="cilium," /><category term="security," /><category term="tetragon" /><summary type="html"><![CDATA[ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Ciliumì˜ Securityì™€ eBPF ê¸°ë°˜ì˜ ëŸ°íƒ€ì„ ë³´ì•ˆ ë° ê´€ì°° ë„êµ¬ì¸ Tetragon ëŒ€í•´ ì‹¤ìŠµì„ í†µí•˜ì—¬ ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[Cilium] K8S/Cilium Performance</title><link href="https://sweetlittlebird.github.io/posts/2025-08-31-Cilium-Week7/" rel="alternate" type="text/html" title="[Cilium] K8S/Cilium Performance" /><published>2025-08-31T00:10:18+09:00</published><updated>2025-08-31T00:10:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/Cilium%20-%20Week7</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2025-08-31-Cilium-Week7/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Ciliumì˜ performanceì™€ ê·¸ì˜ ê¸°ë°˜ì´ ë˜ëŠ” K8Sì˜ performanceì— ëŒ€í•´ ì‹¤ìŠµì„ í†µí•˜ì—¬ ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="k8s-performance">K8S Performance</h2>

<h3 id="ì‹¤ìŠµ-í™˜ê²½-êµ¬ì„±">ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±</h3>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” kindë¥¼ ì‚¬ìš©í•´ì„œ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ê³  ì„±ëŠ¥ í‰ê°€ë¥¼ ìœ„í•´ ë‹¤ìŒì˜ ìš”ì†Œë“¤ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">kube-ops-view</code> : í´ëŸ¬ìŠ¤í„° ìƒíƒœ ì‹œê°í™” ë„êµ¬
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_1.png" alt="img.png" /></li>
      <li><code class="language-plaintext highlighter-rouge">metrics-server</code> : í´ëŸ¬ìŠ¤í„° ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ìˆ˜ì§‘</li>
      <li><code class="language-plaintext highlighter-rouge">kube-prometheus-stack</code> : Prometheusì™€ Grafanaë¥¼ í¬í•¨í•œ ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ</li>
    </ul>
  </li>
</ul>

<h3 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬">ì‹¤ìŠµí™˜ê²½ ë°°í¬</h3>

<ul>
  <li>Kindë¥¼ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ë¥¼ ì„¤ì¹˜í•˜ê³  metrics-serverë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Prometheus Target connection refused bind-address ì„¤ì • : kube-controller-manager , kube-scheduler , etcd , kube-proxy</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.33.2 <span class="nt">--config</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  - containerPort: 30003
    hostPort: 30003
  kubeadmConfigPatches: # Prometheus Target connection refused bind-address ì„¤ì •
  - |
    kind: ClusterConfiguration
    controllerManager:
      extraArgs:
        bind-address: 0.0.0.0
    etcd:
      local:
        extraArgs:
          listen-metrics-urls: http://0.0.0.0:2381
    scheduler:
      extraArgs:
        bind-address: 0.0.0.0
  - |
    kind: KubeProxyConfiguration
    metricsBindAddress: 0.0.0.0
</span><span class="no">EOF
</span><span class="c"># =&gt; Creating cluster "myk8s" ...</span>
<span class="c">#     âœ“ Ensuring node image (kindest/node:v1.33.2) ğŸ–¼</span>
<span class="c">#     âœ“ Preparing nodes ğŸ“¦</span>
<span class="c">#     âœ“ Writing configuration ğŸ“œ</span>
<span class="c">#     âœ“ Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#     âœ“ Installing CNI ğŸ”Œ</span>
<span class="c">#     âœ“ Installing StorageClass ğŸ’¾</span>
<span class="c">#    Set kubectl context to "kind-myk8s"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-myk8s</span>
<span class="c">#    </span>
<span class="c">#    Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community ğŸ™‚</span>

<span class="c"># kube-ops-view ì„¤ì¹˜</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>NodePort,service.main.ports.http.nodePort<span class="o">=</span>30003 <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system
<span class="c"># =&gt; NAME: kube-ops-view</span>
<span class="c">#    LAST DEPLOYED: Sat Aug 30 00:04:30 2025</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    1. Get the application URL by running these commands:</span>
<span class="c">#      export NODE_PORT=$(kubectl get --namespace kube-system -o jsonpath="{.spec.ports[0].nodePort}" services kube-ops-view)</span>
<span class="c">#      export NODE_IP=$(kubectl get nodes --namespace kube-system -o jsonpath="{.items[0].status.addresses[0].address}")</span>
<span class="c">#      echo http://$NODE_IP:$NODE_PORT</span>
<span class="nv">$ </span>open <span class="s2">"http://localhost:30003/#scale=1.5"</span>
<span class="nv">$ </span>open <span class="s2">"http://localhost:30003/#scale=2"</span>

<span class="c"># metrics-server</span>
<span class="nv">$ </span>helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
<span class="nv">$ </span>helm upgrade <span class="nt">--install</span> metrics-server metrics-server/metrics-server <span class="nt">--set</span> <span class="s1">'args[0]=--kubelet-insecure-tls'</span> <span class="nt">-n</span> kube-system
<span class="c"># =&gt; Release "metrics-server" does not exist. Installing it now.</span>
<span class="c">#    NAME: metrics-server</span>
<span class="c">#    ...</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl top node
<span class="c"># =&gt; NAME                  CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)</span>
<span class="c">#    myk8s-control-plane   328m         4%       913Mi           18%</span>
<span class="nv">$ </span>kubectl top pod <span class="nt">-A</span> <span class="nt">--sort-by</span><span class="o">=</span><span class="s1">'cpu'</span>
<span class="c"># =&gt; NAMESPACE            NAME                                          CPU(cores)   MEMORY(bytes)</span>
<span class="c">#    kube-system          kube-apiserver-myk8s-control-plane            78m          194Mi</span>
<span class="c">#    kube-system          etcd-myk8s-control-plane                      45m          28Mi</span>
<span class="c">#    kube-system          kube-ops-view-6658c477d4-vntvq                36m          83Mi</span>
<span class="c">#    kube-system          kube-controller-manager-myk8s-control-plane   33m          48Mi</span>
<span class="c">#    kube-system          kube-scheduler-myk8s-control-plane            16m          20Mi</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl top pod <span class="nt">-A</span> <span class="nt">--sort-by</span><span class="o">=</span><span class="s1">'memory'</span>
<span class="c"># =&gt; NAMESPACE            NAME                                          CPU(cores)   MEMORY(bytes)</span>
<span class="c">#    kube-system          kube-apiserver-myk8s-control-plane            72m          197Mi</span>
<span class="c">#    kube-system          kube-ops-view-6658c477d4-vntvq                35m          83Mi</span>
<span class="c">#    kube-system          kube-controller-manager-myk8s-control-plane   33m          48Mi</span>
<span class="c">#    kube-system          etcd-myk8s-control-plane                      43m          28Mi</span>
<span class="c">#    kube-system          kube-scheduler-myk8s-control-plane            16m          21Mi</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>ì´ì–´ì„œ kube-prometheus-stackë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤. - <a href="https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack">Link</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë¼ë¯¸í„° íŒŒì¼ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; monitor-values.yaml
prometheus:
  prometheusSpec:
    scrapeInterval: "15s"
    evaluationInterval: "15s"
  service:
    type: NodePort
    nodePort: 30001

grafana:
  defaultDashboardsTimezone: Asia/Seoul
  adminPassword: prom-operator
  service:
    type: NodePort
    nodePort: 30002

alertmanager:
  enabled: false
defaultRules:
  create: false
prometheus-windows-exporter:
  prometheus:
    monitor:
      enabled: false
</span><span class="no">EOT
</span><span class="nv">$ </span><span class="nb">cat </span>monitor-values.yaml

<span class="nv">$ </span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
<span class="nv">$ </span>helm repo update

<span class="c"># ë°°í¬</span>
<span class="nv">$ </span>helm <span class="nb">install </span>kube-prometheus-stack prometheus-community/kube-prometheus-stack <span class="nt">--version</span> 75.15.1 <span class="se">\</span>
  <span class="nt">-f</span> monitor-values.yaml <span class="nt">--create-namespace</span> <span class="nt">--namespace</span> monitoring
<span class="c"># =&gt; NAME: kube-prometheus-stack</span>
<span class="c">#    ...</span>
<span class="c">#    kube-prometheus-stack has been installed. Check its status by running:</span>
<span class="c">#      kubectl --namespace monitoring get pods -l "release=kube-prometheus-stack"</span>
<span class="c">#    </span>
<span class="c">#    Get Grafana 'admin' user password by running:</span>
<span class="c">#    </span>
<span class="c">#      kubectl --namespace monitoring get secrets kube-prometheus-stack-grafana -o jsonpath="{.data.admin-password}" | base64 -d ; echo</span>
<span class="c">#    </span>
<span class="c">#    Access Grafana local instance:</span>
<span class="c">#    </span>
<span class="c">#      export POD_NAME=$(kubectl --namespace monitoring get pod -l "app.kubernetes.io/name=grafana,app.kubernetes.io/instance=kube-prometheus-stack" -oname)</span>
<span class="c">#      kubectl --namespace monitoring port-forward $POD_NAME 3000</span>

<span class="c"># ì›¹ ì ‘ì† ì‹¤í–‰</span>
<span class="nv">$ </span>open http://127.0.0.1:30001 <span class="c"># macOS prometheus ì›¹ ì ‘ì†</span>
<span class="nv">$ </span>open http://127.0.0.1:30002 <span class="c"># macOS grafana ì›¹ ì ‘ì† ( admin , prom-operator )</span>
</code></pre></div></div>

<ul>
  <li>grafanaì— ì ‘ì† í›„ ëŒ€ì‹œë³´ë“œë¥¼ ì¶”ê°€ í•©ë‹ˆë‹¤.
    <ul>
      <li>K8S new <strong>15661</strong> : JSON ë‹¤ìš´ë¡œë“œ í›„ ì—…ë¡œë“œ - <a href="https://grafana.com/grafana/dashboards/15661-k8s-dashboard-en-20250125/">Link</a>
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_3.png" alt="img.png" /></li>
      <li>K8S API old <strong>12006</strong> - <a href="https://grafana.com/grafana/dashboards/12006-kubernetes-apiserver/">Link</a>
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_4.png" alt="img_1.png" /></li>
      <li>ëŒ€ì‹œë³´ë“œ ì¶”ê°€ ë°©ë²•
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_2.png" alt="img.png" />
        <ul>
          <li>(1) ìš°ì¸¡ ìƒë‹¨ì˜ <code class="language-plaintext highlighter-rouge">+</code> í´ë¦­</li>
          <li>(2) Import dashboard í´ë¦­</li>
          <li>ì•„ë˜ì˜ ë°©ë²• ì¤‘ í•˜ë‚˜ë¡œ ëŒ€ì‹œë³´ë“œ ì¶”ê°€
            <ul>
              <li>(3) ë‹¤ìš´ë¡œë“œí•œ json íŒŒì¼ì„ ì—…ë¡œë“œ í•˜ê±°ë‚˜</li>
              <li>(4) ëŒ€ì‹œë³´ë“œ ID (15661 ë˜ëŠ” 12006) ì…ë ¥ í›„ Load í´ë¦­ í•˜ê±°ë‚˜</li>
              <li>(5) json íŒŒì¼ ë‚´ìš© ë¶™ì—¬ë„£ê¸°</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="kube-burner">Kube-burner</h3>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” Kube-burner(v1.17.3)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶€í•˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. - <a href="https://github.com/kube-burner/kube-burner">Github</a> , <a href="https://kube-burner.github.io/kube-burner/v1.17.1/">Home</a> , <a href="https://github.com/kube-burner/kube-burner/tree/main/examples">examples</a>
    <ul>
      <li>Kube-burnerëŠ” ê³µì‹ ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ <a href="https://github.com/kubernetes/client-go">client-go</a>ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±ëœ Golang ê¸°ë°˜ì˜ ë°”ì´ë„ˆë¦¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤.</li>
      <li>Kube-burnerëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
        <ul>
          <li>ëŒ€ëŸ‰ì˜ Kubernetes ë¦¬ì†ŒìŠ¤ ìƒì„± ë° ì‚­ì œ, ì½ê¸°, íŒ¨ì¹˜</li>
          <li>Prometheus ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ì¸ë±ì‹±</li>
          <li>ì„±ëŠ¥ ì¸¡ì •</li>
          <li>ê²½ê³  ì•Œë¦¼</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="kube-burner-ì„¤ì¹˜">Kube-burner ì„¤ì¹˜</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>git clone https://github.com/kube-burner/kube-burner.git
<span class="nv">$ </span><span class="nb">cd </span>kube-burner

<span class="c"># ë°”ì´ë„ˆë¦¬ ì„¤ì¹˜(ì¶”ì²œ) : mac M1</span>
<span class="nv">$ </span>curl <span class="nt">-LO</span> https://github.com/kube-burner/kube-burner/releases/download/v1.17.3/kube-burner-V1.17.3-darwin-arm64.tar.gz <span class="c"># mac M</span>
<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xvf</span> kube-burner-V1.17.3-darwin-arm64.tar.gz

<span class="nv">$ </span>curl <span class="nt">-LO</span> https://github.com/kube-burner/kube-burner/releases/download/v1.17.3/kube-burner-V1.17.3-linux-x86_64.tar.gz <span class="c"># Windows</span>
<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xvf</span> kube-burner-V1.17.3-linux-x86_64.tar.gz

<span class="nv">$ </span><span class="nb">sudo cp </span>kube-burner /usr/local/bin

<span class="nv">$ </span>kube-burner <span class="nt">-h</span>
<span class="c"># =&gt; Kube-burner ğŸ”¥</span>
<span class="c">#    </span>
<span class="c">#    Tool aimed at stressing a kubernetes cluster by creating or deleting lots of objects.</span>
<span class="c">#    </span>
<span class="c">#    Usage:</span>
<span class="c">#      kube-burner [command]</span>
<span class="c">#    </span>
<span class="c">#    Available Commands:</span>
<span class="c">#      check-alerts Evaluate alerts for the given time range</span>
<span class="c">#      completion   Generates completion scripts for bash shell</span>
<span class="c">#      destroy      Destroy old namespaces labeled with the given UUID.</span>
<span class="c">#      health-check Check for Health Status of the cluster</span>
<span class="c">#      help         Help about any command</span>
<span class="c">#      import       Import metrics tarball</span>
<span class="c">#      index        Index kube-burner metrics</span>
<span class="c">#      init         Launch benchmark</span>
<span class="c">#      measure      Take measurements for a given set of resources without running workload</span>
<span class="c">#      version      Print the version number of kube-burner</span>
<span class="c">#    </span>
<span class="c">#    Flags:</span>
<span class="c">#      -h, --help               help for kube-burner</span>
<span class="c">#          --log-level string   Allowed values: debug, info, warn, error, fatal (default &amp;quot;info&amp;quot;)</span>
<span class="c">#    </span>
<span class="c">#    Use &amp;quot;kube-burner [command] --help&amp;quot; for more information about a command.</span>

<span class="c"># ë²„ì „ í™•ì¸ : í˜¹ì€ go run cmd/kube-burner/kube-burner.go -h</span>
<span class="nv">$ </span>kube-burner version
<span class="c"># =&gt; Version: 1.17.3</span>
</code></pre></div></div>

<h4 id="ì‹œë‚˜ë¦¬ì˜¤-1--ë””í”Œë¡œì´ë¨¼íŠ¸-1ê°œíŒŒë“œ-1ê°œ-ìƒì„±--ì‚­ì œ-jobiterations-qps-burst-ì˜ë¯¸-í™•ì¸">ì‹œë‚˜ë¦¬ì˜¤ 1 : ë””í”Œë¡œì´ë¨¼íŠ¸ 1ê°œ(íŒŒë“œ 1ê°œ) ìƒì„± â†’ ì‚­ì œ, jobIterations qps burst ì˜ë¯¸ í™•ì¸</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; s1-config.yaml
global:
  measurements:
    - name: none

jobs:
  - name: create-deployments
    jobType: create
    jobIterations: 1  # How many times to execute the job , í•´ë‹¹ jobì„ 5ë²ˆ ë°˜ë³µ ì‹¤í–‰
    qps: 1            # Limit object creation queries per second , 	ì´ˆë‹¹ ìµœëŒ€ ìš”ì²­ ìˆ˜ (í‰ê·  ì†ë„ ì œí•œ) - qps: 10ì´ë©´ ì´ˆë‹¹ 10ê°œ ìš”ì²­
    burst: 1          # Maximum burst for throttle , ìˆœê°„ì ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥í•œ ìš”ì²­ ìµœëŒ€ì¹˜ (ë²„í¼) - burst: 20ì´ë©´ í•œìˆœê°„ì— ìµœëŒ€ 20ê°œê¹Œì§€ ì²˜ë¦¬ ê°€ëŠ¥
    namespace: kube-burner-test
    namespaceLabels: {kube-burner-job: delete-me}
    waitWhenFinished: true # false
    verifyObjects: false
    preLoadImages: true # false
    preLoadPeriod: 30s # default 1m
    objects:
      - objectTemplate: s1-deployment.yaml
        replicas: 1
</span><span class="no">EOF

</span><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; s1-deployment.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-{{ .Iteration}}-{{.Replica}}
  labels:
    app: test-{{ .Iteration }}-{{.Replica}}
    kube-burner-job: delete-me
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test-{{ .Iteration}}-{{.Replica}}
  template:
    metadata:
      labels:
        app: test-{{ .Iteration}}-{{.Replica}}
    spec:
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
</span><span class="no">EOF


</span><span class="c"># ëª¨ë‹ˆí„°ë§ : í„°ë¯¸ë„, kube-ops-view</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get ns,pod <span class="nt">-A</span>


<span class="c"># ë¶€í•˜ ë°œìƒ ì‹¤í–‰ Launch benchmark</span>
<span class="nv">$ </span>kube-burner init <span class="nt">-h</span>
<span class="nv">$ </span>kube-burner init <span class="nt">-c</span> s1-config.yaml <span class="nt">--log-level</span> debug
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ s1-deployment.yamlì„ 1ê°œ ë°°í¬í•˜ì—¬ ì´ˆë‹¹ 1ë²ˆ í˜¸ì¶œí•©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># =&gt; time="2025-08-30 10:35:54" level=info msg="ğŸ”¥ Starting kube-burner (1.17.3@917540ff45a89386bb25de45af9b96c9fc360e93) with UUID 8c6382d0-f8b2-4a9d-834b-878f9524a05d" file="job.go:91"</span>
<span class="c">#    time="2025-08-30 10:35:54" level=warning msg="Measurement [none] is not supported" file="factory.go:101"</span>
<span class="c">#    time="2025-08-30 10:35:54" level=debug msg="job.MaxWaitTimeout is zero in create-deployments, override by timeout: 4h0m0s" file="job.go:361"</span>
<span class="c">#    time="2025-08-30 10:35:54" level=info msg="QPS: 1" file="job.go:371"</span>
<span class="c">#    time="2025-08-30 10:35:54" level=info msg="Burst: 1" file="job.go:378"</span>
<span class="c">#    time="2025-08-30 10:35:54" level=debug msg="Preparing create job: create-deployments" file="create.go:46"</span>
<span class="c">#    time="2025-08-30 10:35:54" level=debug msg="Rendering template: s1-deployment.yaml" file="create.go:52"</span>
<span class="c">#    time="2025-08-30 10:35:54" level=info msg="Job create-deployments: 1 iterations with 1 Deployment replicas" file="create.go:84"</span>
<span class="c">#    time="2025-08-30 10:35:54" level=info msg="Pre-load: images from job create-deployments" file="pre_load.go:73"</span>
<span class="c">#    time="2025-08-30 10:35:54" level=debug msg="Created namespace: preload-kube-burner" file="namespaces.go:55"</span>
<span class="c">#    time="2025-08-30 10:35:54" level=info msg="Pre-load: Creating DaemonSet using images [nginx:alpine] in namespace preload-kube-burner" file="pre_load.go:195"</span>
<span class="c">#    time="2025-08-30 10:35:54" level=info msg="Pre-load: Sleeping for 30s" file="pre_load.go:86"</span>
<span class="c">#    time="2025-08-30 10:36:24" level=info msg="Deleting 1 namespaces with label: kube-burner-preload=true" file="namespaces.go:67"</span>
<span class="c">#    time="2025-08-30 10:36:24" level=debug msg="Waiting for 1 namespaces labeled with kube-burner-preload=true to be deleted" file="namespaces.go:90"</span>
<span class="c">#    time="2025-08-30 10:36:25" level=debug msg="Waiting for 1 namespaces labeled with kube-burner-preload=true to be deleted" file="namespaces.go:90"</span>
<span class="c">#    time="2025-08-30 10:36:26" level=debug msg="Waiting for 1 namespaces labeled with kube-burner-preload=true to be deleted" file="namespaces.go:90"</span>
<span class="c">#    time="2025-08-30 10:36:27" level=debug msg="Waiting for 1 namespaces labeled with kube-burner-preload=true to be deleted" file="namespaces.go:90"</span>
<span class="c">#    time="2025-08-30 10:36:28" level=debug msg="Waiting for 1 namespaces labeled with kube-burner-preload=true to be deleted" file="namespaces.go:90"</span>
<span class="c">#    time="2025-08-30 10:36:29" level=debug msg="Waiting for 1 namespaces labeled with kube-burner-preload=true to be deleted" file="namespaces.go:90"</span>
<span class="c">#    time="2025-08-30 10:36:30" level=info msg="Triggering job: create-deployments" file="job.go:122"</span>
<span class="c">#    time="2025-08-30 10:36:30" level=info msg="0/1 iterations completed" file="create.go:119"</span>
<span class="c">#    time="2025-08-30 10:36:30" level=debug msg="Creating object replicas from iteration 0" file="create.go:122"</span>
<span class="c">#    time="2025-08-30 10:36:31" level=info msg="Namespace kube-burner-test-0 already exists" file="namespaces.go:44"</span>
<span class="c">#    time="2025-08-30 10:36:32" level=error msg="Deployment/deployment-0-1 in namespace kube-burner-test-0 already exists" file="create.go:269"</span>
<span class="c">#    time="2025-08-30 10:36:32" level=info msg="Waiting up to 4h0m0s for actions to be completed" file="create.go:169"</span>
<span class="c">#    time="2025-08-30 10:36:33" level=info msg="Actions in namespace kube-burner-test-0 completed" file="waiters.go:74"</span>
<span class="c">#    time="2025-08-30 10:36:33" level=info msg="Job create-deployments took 3s" file="job.go:191"</span>
<span class="c">#    time="2025-08-30 10:36:33" level=info msg="Finished execution with UUID: 8c6382d0-f8b2-4a9d-834b-878f9524a05d" file="job.go:264"</span>
<span class="c">#    time="2025-08-30 10:36:33" level=info msg="ğŸ‘‹ Exiting kube-burner 8c6382d0-f8b2-4a9d-834b-878f9524a05d" file="kube-burner.go:90"</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get deploy <span class="nt">-A</span> <span class="nt">-l</span> kube-burner-job<span class="o">=</span>delete-me
<span class="c"># =&gt; NAMESPACE            NAME             READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    kube-burner-test-0   deployment-0-1   1/1     1            1           4m16s</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-l</span> kube-burner-job<span class="o">=</span>delete-me
<span class="c"># =&gt; NAMESPACE            NAME                              READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-burner-test-0   deployment-0-1-5f748ffd78-mlf64   1/1     Running   0          4m22s</span>
<span class="nv">$ </span>kubectl get ns <span class="nt">-l</span> kube-burner-job<span class="o">=</span>delete-me
<span class="c"># =&gt; NAME                 STATUS   AGE</span>
<span class="c">#    kube-burner-test-0   Active   4m46s</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">ls </span>kube-burner-<span class="k">*</span>.log
<span class="c"># =&gt; kube-burner-8c6382d0-f8b2-4a9d-834b-878f9524a05d.log</span>
<span class="nv">$ </span><span class="nb">cat </span>kube-burner-<span class="k">*</span>.log
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ìœ„ì˜ ì‹¤í–‰ì‹œì˜ ë¡œê·¸ê°€ ë˜‘ê°™ì´ ë‚˜ì˜´&lt;/span&gt;</span>

<span class="c"># ì‚­ì œ!</span>
<span class="c">## deployment ëŠ” s1-deployment.yaml ì— metadata.labels ì— ì¶”ê°€í•œ labels ë¡œ ì§€ì •</span>
<span class="c">## namespace ëŠ” config.yaml ì— job.name ê°’ì„ labels ë¡œ ì§€ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; s1-config-delete.yaml
# global:
#   measurements:
#     - name: none

jobs:
  - name: delete-deployments-namespace
    qps: 500
    burst: 500
    namespace: kube-burner-test
    jobType: delete
    waitWhenFinished: true
    objects:
    - kind: Deployment
      labelSelector: {kube-burner-job: delete-me}
      apiVersion: apps/v1
    - kind: Namespace
      labelSelector: {kube-burner-job: delete-me}
</span><span class="no">EOF

</span><span class="c">#</span>
<span class="nv">$ </span>kube-burner init <span class="nt">-c</span> s1-config-delete.yaml <span class="nt">--log-level</span> debug
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ kube-burner ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ê´€ë ¨ namespace, deployment ë“±ì´ ì‚­ì œë©ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">kube-burner init -c s1-config.yaml --log-level debug</code></li>
  <li><code class="language-plaintext highlighter-rouge">kube-burner init -c s1-config-delete.yaml --log-level debug</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">preLoadImages: false</code> ë³€ê²½ í›„ ì‹¤í–‰ â†’ ì°¨ì´ì  í™•ì¸ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ, ì„¤ì •ê°’ì€ ìœ ì§€
        <ul>
          <li><strong>ê²°ê³¼ :</strong> ì´ë¯¸ì§€ë¥¼ ë¡œë”©í•˜ëŠ” ì‹œê°„ì„ 30ì´ˆ ê°€ì§€ê³  ìˆì–´ì„œ ëŒ€ê¸°ê°€ ê±¸ë ¸ì—ˆëŠ”ë°, ë°”ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">waitWhenFinished: false</code> ë³€ê²½ í›„ ì‹¤í–‰ â†’ ì°¨ì´ì  í™•ì¸ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ, ì„¤ì •ê°’ì€ ìœ ì§€
        <ul>
          <li><strong>ê²°ê³¼ :</strong> í…ŒìŠ¤íŠ¸ íŒŒë“œê°€ ì˜ ë°°í¬ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì§€ ì•Šê³  ë°”ë¡œ ì¢…ë£Œë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">jobIterations: 5</code> ë³€ê²½ í›„ ì‹¤í–‰ â†’ ì°¨ì´ì  í™•ì¸ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ, ì„¤ì •ê°’ì€ ìœ ì§€ <em>â‡’ s1-deployment.yaml íŒŒì¼ í™•ì¸</em>
        <ul>
          <li><strong>ê²°ê³¼ :</strong> í…ŒìŠ¤íŠ¸ íŒŒë“œë¥¼ 5ê°œ ë°°í¬í•©ë‹ˆë‹¤. ì´ë•Œ objects.replicasê°€ 1ì´ë¯€ë¡œ replicasëŠ” 1ê°œë¡œ ê³ ì •ë˜ê³ , deploymentê°€ 5ê°œ ìƒì„±ë©ë‹ˆë‹¤.
            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get deploy <span class="nt">-A</span> <span class="nt">-l</span> kube-burner-job<span class="o">=</span>delete-me
<span class="c"># =&gt; NAMESPACE            NAME             READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    kube-burner-test-0   deployment-0-1   1/1     1            1           36s</span>
<span class="c">#    kube-burner-test-1   deployment-1-1   1/1     1            1           35s</span>
<span class="c">#    kube-burner-test-2   deployment-2-1   1/1     1            1           34s</span>
<span class="c">#    kube-burner-test-3   deployment-3-1   1/1     1            1           33s</span>
<span class="c">#    kube-burner-test-4   deployment-4-1   1/1     1            1           32s</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">objects.replicas: 2</code> ë³€ê²½ í›„ ì‹¤í–‰ â†’ ì°¨ì´ì  í™•ì¸ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ, ì„¤ì •ê°’ì€ ìœ ì§€ <em>â‡’ s1-deployment.yaml íŒŒì¼ í™•ì¸</em>
        <ul>
          <li><strong>ê²°ê³¼ :</strong> í…ŒìŠ¤íŠ¸ íŒŒë“œë¥¼ 5 x 2 = 10ê°œ ë°°í¬í•©ë‹ˆë‹¤. ì´ë•Œ objects.replicasê°€ 2ì´ì§€ë§Œ s1-deployment.yamlì— replicasê°€ 1ë¡œ ê³ ì •ë˜ì–´ ìˆì–´ì„œ replicasëŠ” 1ê°œë¡œ ê³ ì •ë˜ê³ , deploymentê°€ 10ê°œ ìƒì„±ë©ë‹ˆë‹¤.
            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get deploy <span class="nt">-A</span> <span class="nt">-l</span> kube-burner-job<span class="o">=</span>delete-me
<span class="c"># =&gt; NAMESPACE            NAME             READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    kube-burner-test-0   deployment-0-1   1/1     1            1           45s</span>
<span class="c">#    kube-burner-test-0   deployment-0-2   1/1     1            1           46s</span>
<span class="c">#    kube-burner-test-1   deployment-1-1   1/1     1            1           43s</span>
<span class="c">#    kube-burner-test-1   deployment-1-2   1/1     1            1           44s</span>
<span class="c">#    kube-burner-test-2   deployment-2-1   1/1     1            1           41s</span>
<span class="c">#    kube-burner-test-2   deployment-2-2   1/1     1            1           42s</span>
<span class="c">#    kube-burner-test-3   deployment-3-1   1/1     1            1           39s</span>
<span class="c">#    kube-burner-test-3   deployment-3-2   1/1     1            1           40s</span>
<span class="c">#    kube-burner-test-4   deployment-4-1   1/1     1            1           37s</span>
<span class="c">#    kube-burner-test-4   deployment-4-2   1/1     1            1           38s</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">jobIterations: 10</code> ë³€ê²½ í›„ ì‹¤í–‰ â†’ ì°¨ì´ì  í™•ì¸ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ, ì„¤ì •ê°’ì€ ìœ ì§€ <em>â‡’ qps: 1 ì˜ë¯¸ íŒŒì•… í•´ë³´ê¸°</em>
        <ul>
          <li><strong>ê²°ê³¼ :</strong> í…ŒìŠ¤íŠ¸ íŒŒë“œë¥¼ 10 x 2 = 20ê°œ ë°°í¬í•©ë‹ˆë‹¤. QPSê°€ 1ì´ë¯€ë¡œ ì´ˆë‹¹ 1ê°œì”© ë°°í¬ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">qps: 10, burst:10</code> ë³€ê²½ í›„ ì‹¤í–‰ â†’ ì°¨ì´ì  í™•ì¸ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ, ì„¤ì •ê°’ì€ ìœ ì§€ <em>â‡’ qps: 10 ì˜ë¯¸ íŒŒì•… í•´ë³´ê¸°</em>
        <ul>
          <li><strong>ê²°ê³¼ :</strong> í…ŒìŠ¤íŠ¸ íŒŒë“œë¥¼ 10 x 2 = 20ê°œ ë°°í¬í•©ë‹ˆë‹¤. QPSê°€ 10ì´ë¯€ë¡œ ì´ˆë‹¹ 10ê°œì”© ë°°í¬ë©ë‹ˆë‹¤.</li>
          <li><strong>ê²°ê³¼ :</strong> QPSëŠ” ì´ˆë‹¹ (ìƒì„±) ì¿¼ë¦¬ë¡œ 10ì´ë©´ ì´ˆë‹¹ 10ê°œì˜ ìƒì„± ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆëŠ”ê²ƒì…ë‹ˆë‹¤. 20ê°œì´ë©´ 2ì´ˆë§Œì— ë°°í¬ê°€ ì™„ë£Œë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>qps ì™€ burst ë™ì‘ íŒŒì•…í•´ë³´ê¸°
    <ul>
      <li><code class="language-plaintext highlighter-rouge">jobIterations: 10, qps: 1, burst:10</code> <code class="language-plaintext highlighter-rouge">objects.replicas: 1</code> ë³€ê²½ í›„ ì‹¤í–‰ â†’ ë™ì‘ í™•ì¸ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ
        <ul>
          <li><strong>ê²°ê³¼ :</strong> í…ŒìŠ¤íŠ¸ íŒŒë“œë¥¼ 10ê°œ ë°°í¬í•©ë‹ˆë‹¤. QPSê°€ 1ì´ì§€ë§Œ burstê°€ 10ì´ë¯€ë¡œ ìˆœê°„ì ìœ¼ë¡œ 10ê°œê¹Œì§€ ë°°í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">jobIterations: 100, qps: 1, burst:100</code> <code class="language-plaintext highlighter-rouge">objects.replicas: 1</code> ë³€ê²½ í›„ ì‹¤í–‰ â†’ ë™ì‘ í™•ì¸ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ
        <ul>
          <li><strong>ê²°ê³¼ :</strong> í…ŒìŠ¤íŠ¸ íŒŒë“œë¥¼ 100ê°œ ë°°í¬í•©ë‹ˆë‹¤. QPSê°€ 1ì´ì§€ë§Œ burstê°€ 100ì´ë¯€ë¡œ ìˆœê°„ì ìœ¼ë¡œ 100ê°œê¹Œì§€ ë°°í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">jobIterations: 10, qps: 1, burst:20</code> <code class="language-plaintext highlighter-rouge">objects.replicas: 2</code> ë³€ê²½ í›„ ì‹¤í–‰ â†’ ë™ì‘ í™•ì¸ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ</li>
      <li><code class="language-plaintext highlighter-rouge">jobIterations: 10, qps: 1, burst:10</code> <code class="language-plaintext highlighter-rouge">objects.replicas: 2</code> ë³€ê²½ í›„ ì‹¤í–‰ â†’ ì°¨ì´ì  í™•ì¸ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ
        <ul>
          <li><strong>ê²°ê³¼ :</strong> í…ŒìŠ¤íŠ¸ íŒŒë“œë¥¼ 20ê°œ ë°°í¬í•©ë‹ˆë‹¤. QPSê°€ 1ì´ì§€ë§Œ burstê°€ 10ì´ë¯€ë¡œ ìˆœê°„ì ìœ¼ë¡œ 10ê°œê¹Œì§€ ë°°í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. 10ê°œê¹Œì§€ëŠ” ë°”ë¡œ ë°°í¬ë˜ì§€ë§Œ 11ê°œ ë¶€í„°ëŠ” ì´ˆë‹¹ 1ê°œì”© ë°°í¬ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">jobIterations: 20, qps: 2, burst:20</code> <code class="language-plaintext highlighter-rouge">objects.replicas: 2</code> ë³€ê²½ í›„ ì‹¤í–‰ â†’ ì°¨ì´ì  í™•ì¸ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ
        <ul>
          <li><strong>ê²°ê³¼ :</strong> í…ŒìŠ¤íŠ¸ íŒŒë“œë¥¼ 40ê°œ ë°°í¬í•©ë‹ˆë‹¤. QPSê°€ 2ì´ì§€ë§Œ burstê°€ 20ì´ë¯€ë¡œ ìˆœê°„ì ìœ¼ë¡œ 20ê°œê¹Œì§€ ë°°í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. 20ê°œê¹Œì§€ëŠ” ë°”ë¡œ ë°°í¬ë˜ì§€ë§Œ 21ê°œ ë¶€í„°ëŠ” ì´ˆë‹¹ 2ê°œì”© ë°°í¬ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ğŸ‘‰ ì¦‰, qpsëŠ” ì´ˆë‹¹ ëª‡ íšŒì˜ ì¿¼ë¦¬ë¥¼ ë³´ë‚´ëŠëƒ, burstëŠ” ìˆœê°„ì ìœ¼ë¡œ ëª‡ íšŒì˜ ì¿¼ë¦¬ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆëŠëƒ ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2025/cilium/w7/20250831_cilium_w7_5.png" alt="img.png" class="image-center" />
<em class="image-caption">kube-burnerë¡œ pod ê°€ ë°°í¬ë˜ëŠ” í™”ë©´</em></p>

<h4 id="ì‹œë‚˜ë¦¬ì˜¤-2--ë…¸ë“œ-1ëŒ€ì—-ìµœëŒ€-íŒŒë“œ150ê°œ-ë°°í¬-ì‹œë„-1">ì‹œë‚˜ë¦¬ì˜¤ 2 : ë…¸ë“œ 1ëŒ€ì— ìµœëŒ€ íŒŒë“œ(150ê°œ) ë°°í¬ ì‹œë„ 1</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">kube-burner init -c s1-config.yaml --log-level debug</code></li>
  <li><code class="language-plaintext highlighter-rouge">jobIterations: 100, qps: 300, burst: 300</code> <code class="language-plaintext highlighter-rouge">objects.replicas: 1</code> ë³€ê²½ í›„ ì‹¤í–‰ <em>â†’ ëª¨ë“  íŒŒë“œê°€ ë°°í¬ ë˜ëŠ”ì§€ í™•ì¸</em>
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_6.png" alt="img.png" class="image-center" />
<em class="image-caption">6ê°œì˜ íŒŒë“œê°€ Pending ìƒíƒœë¡œ ë‚¨ì•„ìˆëŠ” í™”ë©´</em></li>
  <li>
    <p><strong>ë¬¸ì œ ì›ì¸ íŒŒì•…</strong>
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_7.png" alt="img.png" class="image-center" />
<em class="image-caption">K8S NEW ëŒ€ì‹œë³´ë“œ : Nodes with Pod íŒ¨ë„</em></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c">#</span>
  <span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'1/1     Running'</span>
  <span class="c"># =&gt; NAMESPACE             NAME                                                        READY   STATUS    RESTARTS       AGE</span>
  <span class="c">#    kube-burner-test-94   deployment-94-1-66c9bd7f46-llbsr                            0/1     Pending   0              3m46s</span>
  <span class="c">#    kube-burner-test-95   deployment-95-1-6877f5c69b-kzdwj                            0/1     Pending   0              3m46s</span>
  <span class="c">#    kube-burner-test-96   deployment-96-1-65468866f4-2lpcw                            0/1     Pending   0              3m46s</span>
  <span class="c">#    kube-burner-test-97   deployment-97-1-58646bddc6-d5shq                            0/1     Pending   0              3m46s</span>
  <span class="c">#    kube-burner-test-98   deployment-98-1-5c4c86c794-25fzm                            0/1     Pending   0              3m46s</span>
  <span class="c">#    kube-burner-test-99   deployment-99-1-567ddbffb4-6qqwc                            0/1     Pending   0              3m45s</span>
  <span class="c">#    monitoring            kube-prometheus-stack-grafana-7d9c86798d-wcp44              3/3     Running   3 (121m ago)   11h</span>
  <span class="c">#    monitoring            prometheus-kube-prometheus-stack-prometheus-0               2/2     Running   2 (121m ago)   11h</span>
      
  <span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-burner-test-99 | <span class="nb">grep </span>Events: <span class="nt">-A5</span>
  <span class="c"># =&gt; Events:</span>
  <span class="c">#      Type     Reason            Age    From               Message</span>
  <span class="c">#      ----     ------            ----   ----               -------</span>
  <span class="c">#      Warning  FailedScheduling  4m23s  default-scheduler  0/1 nodes are available: 1 &lt;span style="color: green;"&gt;Too many pods&lt;/span&gt;. preemption: 0/1 nodes are available: 1 No preemption victims found for incoming pod.</span>
  <span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ íŒŒë“œê°€ ë„ˆë¬´ ë§ì•„ì„œ ìŠ¤ì¼€ì¤„ë§ì´ ì•ˆëœë‹¤ëŠ” ë©”ì‹œì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
      
  <span class="c">#</span>
  <span class="nv">$ </span>kubectl describe node
  <span class="c"># =&gt; ...</span>
  <span class="c">#    Capacity:</span>
  <span class="c">#      cpu:                7</span>
  <span class="c">#      ephemeral-storage:  61255492Ki</span>
  <span class="c">#      hugepages-1Gi:      0</span>
  <span class="c">#      hugepages-2Mi:      0</span>
  <span class="c">#      hugepages-32Mi:     0</span>
  <span class="c">#      hugepages-64Ki:     0</span>
  <span class="c">#      memory:             5035968Ki</span>
  <span class="c">#      pods:               &lt;span style="color: green;"&gt;110&lt;/span&gt;</span>
  <span class="c">#    Allocatable:</span>
  <span class="c">#      cpu:                7</span>
  <span class="c">#      ephemeral-storage:  61255492Ki</span>
  <span class="c">#      hugepages-1Gi:      0</span>
  <span class="c">#      hugepages-2Mi:      0</span>
  <span class="c">#      hugepages-32Mi:     0</span>
  <span class="c">#      hugepages-64Ki:     0</span>
  <span class="c">#      memory:             5035968Ki</span>
  <span class="c">#      pods:               &lt;span style="color: green;"&gt;110&lt;/span&gt;</span>
  <span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í• ë‹¹í•  ìˆ˜ ìˆëŠ” íŒŒë“œ ìˆ˜ê°€ 110ê°œ ê¹Œì§€ì¸ë° í˜„ì¬ íŒŒë“œìˆ˜ê°€ 116ê°œë¡œ ì´ˆê³¼ë˜ì–´ ì´ˆê³¼ëœ 6ê°œ ë§Œí¼ì˜ íŒŒë“œê°€ Pending ìƒíƒœê°€ ë˜ì—ˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>í•´ê²°</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># maxPods í•­ëª© ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 110ê°œ</span>
  <span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system kubelet-config <span class="nt">-o</span> yaml | <span class="nb">grep </span>maxPods
  <span class="c"># =&gt; (ì—†ìŒ)</span>
      
  <span class="c">#</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
  <span class="nt">----------------------------------------</span>
  <span class="nv">$ </span><span class="nb">cat</span> /var/lib/kubelet/config.yaml
      
  <span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt <span class="nb">install </span>vim <span class="nt">-y</span>
  <span class="nv">$ </span>vim /var/lib/kubelet/config.yaml
  <span class="c"># maxPods: 150 ì¶”ê°€</span>
      
  <span class="nv">$ </span>systemctl restart kubelet
  <span class="nv">$ </span>systemctl status kubelet
  <span class="c"># =&gt; â— kubelet.service - kubelet: The Kubernetes Node Agent                                                                                                                                  Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; preset: enabled)</span>
  <span class="c">#        Drop-In: /etc/systemd/system/kubelet.service.d                                                                                                                                              â””â”€10-kubeadm.conf, 11-kind.conf</span>
  <span class="c">#         Active: active (running) since Sat 2025-08-30 02:28:12 UTC; 7s ago                                                                                                                   Docs: http://kubernetes.io/docs/    </span>
  <span class="nv">$ </span><span class="nb">exit</span>
  <span class="nt">----------------------------------------</span>
      
  <span class="c">#</span>
  <span class="nv">$ </span>kubectl describe node
  <span class="c"># =&gt; ...</span>
  <span class="c">#    Capacity:</span>
  <span class="c">#      cpu:                7</span>
  <span class="c">#      ephemeral-storage:  61255492Ki</span>
  <span class="c">#      hugepages-1Gi:      0</span>
  <span class="c">#      hugepages-2Mi:      0</span>
  <span class="c">#      hugepages-32Mi:     0</span>
  <span class="c">#      hugepages-64Ki:     0</span>
  <span class="c">#      memory:             5035968Ki</span>
  <span class="c">#      pods:               &lt;span style="color: green;"&gt;150&lt;/span&gt;</span>
  <span class="c">#    Allocatable:</span>
  <span class="c">#      cpu:                7</span>
  <span class="c">#      ephemeral-storage:  61255492Ki</span>
  <span class="c">#      hugepages-1Gi:      0</span>
  <span class="c">#      hugepages-2Mi:      0</span>
  <span class="c">#      hugepages-32Mi:     0</span>
  <span class="c">#      hugepages-64Ki:     0</span>
  <span class="c">#      memory:             5035968Ki</span>
  <span class="c">#      pods:               &lt;span style="color: green;"&gt;150&lt;/span&gt;</span>
</code></pre></div>    </div>
    <p><img src="/assets/2025/cilium/w7/20250831_cilium_w7_8.png" alt="img.png" /></p>
    <ul>
      <li>íŒŒë“œ í•œë„ê°€ 150ê°œë¡œ ëŠ˜ì—ˆê³  ëª¨ë“  íŒŒë“œê°€ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">kube-burner init -c s1-config-delete.yaml --log-level debug</code>ë¡œ ë¦¬ì†ŒìŠ¤ ì‚­ì œ</li>
    </ul>
  </li>
</ul>

<h4 id="ì‹œë‚˜ë¦¬ì˜¤-3--ë…¸ë“œ-1ëŒ€ì—-ìµœëŒ€-íŒŒë“œ300ê°œ-ë°°í¬-ì‹œë„-2">ì‹œë‚˜ë¦¬ì˜¤ 3 : ë…¸ë“œ 1ëŒ€ì— ìµœëŒ€ íŒŒë“œ(300ê°œ) ë°°í¬ ì‹œë„ 2</h4>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">kube-burner init -c s1-config.yaml --log-level debug</code></strong></li>
  <li><code class="language-plaintext highlighter-rouge">jobIterations: **300**, qps: 300, burst: 300</code> <code class="language-plaintext highlighter-rouge">objects.replicas: 1</code> ë³€ê²½ í›„ ì‹¤í–‰ <em>â†’ ëª¨ë“  íŒŒë“œê°€ ë°°í¬ ë˜ëŠ”ì§€ í™•ì¸</em></li>
  <li>
    <p><strong>ë¬¸ì œ ì›ì¸ íŒŒì•…</strong></p>

    <p><img src="/assets/2025/cilium/w7/20250831_cilium_w7_9.png" alt="img.png" class="image-center" />
<em class="image-caption">K8S NEW ëŒ€ì‹œë³´ë“œ : Pod Number and nodes íŒ¨ë„</em></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'1/1     Running'</span>
<span class="c"># =&gt; NAMESPACE              NAME                                                        READY   STATUS    RESTARTS       AGE</span>
<span class="c">#    kube-burner-test-134   deployment-134-1-7b94c5f676-z8ptw                           0/1     Pending   0              4m53s</span>
<span class="c">#    kube-burner-test-135   deployment-135-1-57d5cd6644-xlt7r                           0/1     Pending   0              4m53s</span>
<span class="c">#    kube-burner-test-136   deployment-136-1-7bd85d5684-vhdl6                           0/1     Pending   0              4m53s</span>
<span class="c">#    kube-burner-test-137   deployment-137-1-5f5b964756-jc8tk                           0/1     Pending   0              4m53s</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 167ê°œ ê°€ëŸ‰ì˜ íŒŒë“œê°€ pending ìƒíƒœì…ë‹ˆë‹¤.&lt;/span&gt;</span>
    
<span class="c"># maxPods: 400 ìƒí–¥</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nt">----------------------------------------</span>
<span class="nv">$ </span><span class="nb">cat</span> /var/lib/kubelet/config.yaml
    
<span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt <span class="nb">install </span>vim <span class="nt">-y</span>
<span class="nv">$ </span>vim /var/lib/kubelet/config.yaml
<span class="c"># maxPods: 400 ì¶”ê°€</span>
    
<span class="nv">$ </span>systemctl restart kubelet
<span class="nv">$ </span>systemctl status kubelet
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------------------</span>
    
<span class="c"># </span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-burner-test-250 | <span class="nb">grep </span>Events: <span class="nt">-A5</span>
<span class="c"># =&gt; Events:</span>
<span class="c">#      Type     Reason            Age    From               Message</span>
<span class="c">#      ----     ------            ----   ----               -------</span>
<span class="c">#      Warning  FailedScheduling  6m33s  default-scheduler  0/1 nodes are available: 1 Too many pods. preemption: 0/1 nodes are available: 1 No preemption victims found for incoming pod.</span>
<span class="c">#      Warning  FailedScheduling  72s    default-scheduler  0/1 nodes are available: 1 Too many pods. preemption: 0/1 nodes are available: 1 No preemption victims found for incoming pod.</span>
<span class="c">#      Normal   Scheduled         15s    default-scheduler  Successfully assigned kube-burner-test-250/deployment-250-1-6789d5b4bd-hmhjh to myk8s-control-plane</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë°°í¬ê°€ ì˜ ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
    
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-burner-test-299 | <span class="nb">grep </span>Events: <span class="nt">-A5</span>
<span class="c"># =&gt; Events:</span>
<span class="c">#      Type     Reason            Age   From               Message</span>
<span class="c">#      ----     ------            ----  ----               -------</span>
<span class="c">#      Warning  FailedScheduling  7m1s  default-scheduler  0/1 nodes are available: 1 Too many pods. preemption: 0/1 nodes are available: 1 No preemption victims found for incoming pod.</span>
<span class="c">#      Warning  FailedScheduling  108s  default-scheduler  0/1 nodes are available: 1 Too many pods. preemption: 0/1 nodes are available: 1 No preemption victims found for incoming pod.</span>
<span class="c">#      Normal   Scheduled         52s   default-scheduler  Successfully assigned kube-burner-test-299/deployment-299-1-b7c8c4d9b-g7gwc to myk8s-control-plane</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ëª¨ë“  íŒŒë“œê°€ ë°°í¬ê°€ ì˜ ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt; </span>
</code></pre></div>    </div>

    <ul>
      <li><strong><code class="language-plaintext highlighter-rouge">kube-burner init -c s1-config-delete.yaml --log-level debug</code></strong></li>
    </ul>
  </li>
</ul>

<h3 id="k8s-performance--tuning">K8S Performance &amp; Tuning</h3>

<h4 id="ëŒ€ê·œëª¨-í´ëŸ¬ìŠ¤í„°-ê³ ë ¤ì‚¬í•­">ëŒ€ê·œëª¨ í´ëŸ¬ìŠ¤í„° ê³ ë ¤ì‚¬í•­</h4>

<h5 id="ê°œìš”-k8s-ê³µì‹-ë¬¸ì„œ">ê°œìš” (<a href="https://kubernetes.io/docs/setup/best-practices/cluster-large/">K8S ê³µì‹ ë¬¸ì„œ</a>)</h5>
<ul>
  <li><strong>ìµœëŒ€ ê·œëª¨ (v1.33 ê¸°ì¤€)</strong>
    <ul>
      <li>ë…¸ë“œ: ìµœëŒ€ 5,000ê°œ</li>
      <li>ë…¸ë“œë‹¹ íŒŒë“œ: 110ê°œ ì´í•˜</li>
      <li>íŒŒë“œ: ìµœëŒ€ 150,000ê°œ</li>
      <li>ì»¨í…Œì´ë„ˆ: ìµœëŒ€ 300,000ê°œ</li>
    </ul>
  </li>
  <li><strong>ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ì„¤ê³„</strong>
    <ul>
      <li>ì¥ì•  ì˜ì—­(failure zone)ë§ˆë‹¤ ë¶„ì‚° ë°°ì¹˜</li>
      <li>ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•´ ì¼ë¶€ ì¥ì• ì—ë„ API í˜¸ì¶œ ì •ìƒ ìœ ì§€
<img src="../../../assets/2025/cilium/w7/20250831_cilium_w7_10.svg" alt="20250831_cilium_w7_10.svg" class="image-center" />
<em class="image-caption"><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/ha-topology/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/ha-topology/</a></em></li>
    </ul>
  </li>
  <li><strong>etcd ìŠ¤í† ë¦¬ì§€ ë¶„ë¦¬</strong>
    <ul>
      <li>ì´ë²¤íŠ¸ ê°ì²´ ì „ìš© etcd ì‚¬ìš© ê¶Œì¥</li>
      <li>ë©”ì¸ etcd ë¶€í•˜ ì™„í™” ë° ì„±ëŠ¥ í–¥ìƒ
<img src="../../../assets/2025/cilium/w7/20250831_cilium_w7_11.svg" alt="20250831_cilium_w7_11.svg" class="image-center" /></li>
    </ul>
  </li>
</ul>

<h5 id="control-plane-êµ¬ì„±-ìš”ì†Œì™€-íŠ¹ì§•">Control Plane êµ¬ì„± ìš”ì†Œì™€ íŠ¹ì§•</h5>
<ul>
  <li>ì°¸ê³  : ì“°ê¸°ë§Œ í–ˆë˜ ê°œë°œìê°€ ê¶ê¸ˆí•´ì„œ ì°¾ì•„ë³¸ ì¿ ë²„ë„¤í‹°ìŠ¤ ë‚´ë¶€ 1í¸ - <a href="https://tech.kakaopay.com/post/jack-k8s-internals-part-1/">Link</a>, 2í¸* - <a href="https://tech.kakaopay.com/post/jack-k8s-internals-part-2/">Link</a>
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_12.png" alt="img.png" class="image-center" />
<em class="image-caption">ì¶œì²˜ : <a href="https://tech.kakaopay.com/post/jack-k8s-internals-part-2/">ì“°ê¸°ë§Œ í–ˆë˜ ê°œë°œìê°€ ê¶ê¸ˆí•´ì„œ ì°¾ì•„ë³¸ ì¿ ë²„ë„¤í‹°ìŠ¤ ë‚´ë¶€</a></em></li>
  <li>ì°¸ê³  : K8S Controlplane ì£½ì´ê¸° ğŸ‘ğŸ» - <a href="https://iwanhae.tistory.com/m/2">Blog</a></li>
  <li>K8S í•µì‹¬ êµ¬ì„±ìš”ì†Œ
    <ul>
      <li><strong>kube-apiserver</strong>
        <ul>
          <li>RESTful API ì„œë²„</li>
          <li>í´ë¼ì´ì–¸íŠ¸ì™€ í†µì‹  (<code class="language-plaintext highlighter-rouge">kubectl</code>, <code class="language-plaintext highlighter-rouge">kubelet</code> ë“±)</li>
        </ul>
      </li>
      <li><strong>etcd</strong>
        <ul>
          <li>ë¶„ì‚° Key-Value DB</li>
          <li>RAFT í•©ì˜ ê¸°ë°˜ìœ¼ë¡œ ì•ˆì •ì  ë™ì‘</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>ì¥ì </strong>
    <ul>
      <li>ë°ì´í„° ì†ìƒ/ì¼ê´€ì„± ë¬¸ì œ ê±°ì˜ ì—†ìŒ</li>
      <li>ì•ˆì •ì„± ìš°ì„  ì„¤ê³„</li>
    </ul>
  </li>
  <li><strong>ë‹¨ì </strong>
    <ul>
      <li>ëŒ€ê·œëª¨ í™˜ê²½ì—ì„œ ì„±ëŠ¥ ì €í•˜
        <ul>
          <li>íŒŒë“œê°€ 100ê°œì¼ë•Œ íŒŒë“œ ì¡°íšŒì‹œ 0.031ì´ˆ, íŒŒë“œê°€ 10000ê°œì¼ë•Œ 2ì´ˆ ì†Œìš”ë¡œ íŒŒë“œê°€ ë§ì•„ì§ˆ ìˆ˜ë¡ ê¸‰ê²©íˆ ì„±ëŠ¥ì´ ì €í•˜ë©ë‹ˆë‹¤.</li>
          <li>ìš”ì²­ì‹œ ë°›ì•„ì§€ëŠ” ìš©ëŸ‰ë„ 100ê°œì¼ë•Œ 0.45MB, 10000ê°œì¼ë•Œ 44.4MBë¡œ ê¸‰ê²©íˆ ì¦ê°€í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ìš”ì²­ë‹¹ ë©”ëª¨ë¦¬ ì†Œë¹„ëŸ‰ì´ í¼</li>
      <li>íŒŒë“œ ìˆ˜ê°€ ë§ì„ìˆ˜ë¡ ì‘ë‹µ ì§€ì—°, ì‘ë‹µ í¬ê¸° í­ì¦</li>
    </ul>
  </li>
</ul>

<h5 id="ë¬¸ì œ-ë°œìƒ-ì˜ˆì‹œ">ë¬¸ì œ ë°œìƒ ì˜ˆì‹œ</h5>
<ul>
  <li><strong>ë¦¬ì†ŒìŠ¤ ê³¼ë‹¤ì‚¬ìš© ì‚¬ë¡€</strong>
    <ul>
      <li>Airflow, Kubeflow ë“± â†’ Podê°€ ìë™ ì‚­ì œë˜ì§€ ì•Šê³  ëˆ„ì </li>
      <li>ìˆ˜ì²œ ê°œ ì´ìƒ ìŒ“ì´ë©´ ì¡°íšŒ ìš”ì²­ ì‹œ ë¶€í•˜ ê¸‰ì¦</li>
    </ul>
  </li>
  <li><strong>ë™ì‹œ ìš”ì²­ ê³¼ë‹¤</strong>
    <ul>
      <li>kubelet, kube-proxy, CNI ì—ì´ì „íŠ¸ ë“± ë…¸ë“œ ê¸°ë°˜ ì»¨íŠ¸ë¡¤ëŸ¬</li>
      <li>ë„¤íŠ¸ì›Œí¬ ëŠê¹€/ì¬ì—°ê²° ì‹œ ëŒ€ëŸ‰ì˜ List ìš”ì²­ ë°œìƒ</li>
      <li><code class="language-plaintext highlighter-rouge">spec.nodeName</code> ë“±ì— ì¸ë±ìŠ¤ ë¶€ì¬ â†’ etcd ì „ì²´ ìŠ¤ìº” ë°œìƒ</li>
    </ul>
  </li>
</ul>

<h5 id="í•´ê²°-ë°©ë²•">í•´ê²° ë°©ë²•</h5>
<ul>
  <li><strong>API ê´€ì </strong>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">limit</code> / <code class="language-plaintext highlighter-rouge">continue</code> í™œìš© â†’ í•œë²ˆì— ìµœëŒ€ 500ê°œì”© ì¡°íšŒ</li>
      <li><code class="language-plaintext highlighter-rouge">resourceVersion=0</code> í™œìš© â†’ apiserver ìºì‹œ í™œìš©, etcd ë¶€í•˜ ì™„í™”</li>
      <li>API Priority and Fairness(APF) â†’ íŠ¹ì • ìš”ì²­ë§Œ Rate Limit ì ìš©</li>
    </ul>
  </li>
  <li><strong>ìš´ì˜ ê´€ì </strong>
    <ul>
      <li>ë¶ˆí•„ìš”í•œ Pod, ì´ë²¤íŠ¸ ë¦¬ì†ŒìŠ¤ ì£¼ê¸°ì  ì •ë¦¬</li>
      <li>CronJob, Job ë“± ë‹¨ë°œì„± ì›Œí¬ë¡œë“œ Pod ìë™ ì‚­ì œ ì„¤ì •</li>
      <li>ì´ë²¤íŠ¸ ì „ìš© etcd ì‚¬ìš©í•˜ì—¬ ë©”ì¸ í´ëŸ¬ìŠ¤í„° ë¶€í•˜ ë¶„ì‚°</li>
    </ul>
  </li>
</ul>

<h5 id="openai-ì‚¬ë¡€">OpenAI ì‚¬ë¡€</h5>
<ul>
  <li><strong>2500 ë…¸ë“œ (2018)</strong>
    <ul>
      <li>500ë…¸ë“œ ì´í›„ kubectl timeout ë°œìƒ</li>
      <li>etcd ë„¤íŠ¸ì›Œí¬ ìŠ¤í† ë¦¬ì§€ â†’ ë¡œì»¬ SSDë¡œ ë³€ê²½ â†’ ì§€ì—° 200Âµs ê°ì†Œ</li>
      <li>Fluentd, Datadog ê¸°ë³¸ ì„¤ì • â†’ ê³¼ë„í•œ API í˜¸ì¶œ ì›ì¸ â†’ ìˆ˜ì • í›„ ì•ˆì •í™”</li>
      <li>ì´ë²¤íŠ¸ ì €ì¥ì†Œë¥¼ ë©”ì¸ etcdì™€ ë¶„ë¦¬ â†’ ì„±ëŠ¥ ê°œì„ </li>
    </ul>
  </li>
  <li><strong>7500 ë…¸ë“œ (2021)</strong>
    <ul>
      <li>API ì„œë²„, etcd ê°ê° ì „ìš© ì„œë²„(dedicated)ì—ì„œ ì‹¤í–‰</li>
      <li>API ì„œë²„ 5ëŒ€, etcd 5ëŒ€ â†’ ë¶€í•˜ ë¶„ì‚° ë° ì¥ì•  ëŒ€ë¹„</li>
      <li>ë…¸ë“œ ë³€ê²½ ì‹œ Endpoints Watch íŠ¸ë˜í”½ 1GB/s ë°œìƒ</li>
      <li><code class="language-plaintext highlighter-rouge">EndpointSlice</code> ê¸°ëŠ¥ìœ¼ë¡œ ë¶€í•˜ 1/1000 ìˆ˜ì¤€ìœ¼ë¡œ ê°ì†Œ</li>
      <li>API ì„œë²„ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ì„œë²„ë‹¹ 70GB ì´ìƒ í™ ë©”ëª¨ë¦¬</li>
    </ul>
  </li>
</ul>

<h4 id="ì‹œë‚˜ë¦¬ì˜¤-4-api-intensive---íŒŒë“œë¥¼-ìƒì„±configmap-secret-í›„-ì‚­ì œ">ì‹œë‚˜ë¦¬ì˜¤ 4. api-intensive - íŒŒë“œë¥¼ ìƒì„±(configmap, secret) í›„ ì‚­ì œ</h4>

<ul>
  <li>ì´ë²ˆì—ëŠ” kube-apiserverê°€ íŒŒë“œë¥¼ ìƒì„±í• ë•Œ secretê³¼ configmapì„ ë§ˆìš´íŠ¸í•˜ê³ , ì‚­ì œí•˜ëŠ” ë™ì‘ì˜ ë¶€í•˜ë¥¼ ë°œìƒì‹œì¼œë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>QPS/Burstë¥¼ í´ëŸ¬ìŠ¤í„° í¬ê¸°ì— ë§ê²Œ ì¡°ì ˆí•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>tree examples/workloads/api-intensive
<span class="c"># =&gt; examples/workloads/api-intensive</span>
<span class="c">#    â”œâ”€â”€ api-intensive.yml</span>
<span class="c">#    â””â”€â”€ templates</span>
<span class="c">#        â”œâ”€â”€ configmap.yaml</span>
<span class="c">#        â”œâ”€â”€ deployment_patch_add_label.json</span>
<span class="c">#        â”œâ”€â”€ deployment_patch_add_label.yaml</span>
<span class="c">#        â”œâ”€â”€ deployment_patch_add_pod_2.yaml</span>
<span class="c">#        â”œâ”€â”€ deployment.yaml</span>
<span class="c">#        â”œâ”€â”€ secret.yaml</span>
<span class="c">#        â””â”€â”€ service.yaml</span>

<span class="nv">$ </span><span class="nb">cd </span>examples/workloads/api-intensive

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; api-intensive-100.yml
jobs:
  - name: api-intensive
    jobIterations: 100
    qps: 100
    burst: 100
    namespacedIterations: true
    namespace: api-intensive
    podWait: false
    cleanup: true
    waitWhenFinished: true
    preLoadImages: false # true
    objects:
      - objectTemplate: templates/deployment.yaml
        replicas: 1
      - objectTemplate: templates/configmap.yaml
        replicas: 1
      - objectTemplate: templates/secret.yaml
        replicas: 1
      - objectTemplate: templates/service.yaml
        replicas: 1

  - name: api-intensive-patch
    jobType: patch
    jobIterations: 10
    qps: 100
    burst: 100
    objects:
      - kind: Deployment
        objectTemplate: templates/deployment_patch_add_label.json
        labelSelector: {kube-burner-job: api-intensive}
        patchType: "application/json-patch+json"
        apiVersion: apps/v1
      - kind: Deployment
        objectTemplate: templates/deployment_patch_add_pod_2.yaml
        labelSelector: {kube-burner-job: api-intensive}
        patchType: "application/apply-patch+yaml"
        apiVersion: apps/v1
      - kind: Deployment
        objectTemplate: templates/deployment_patch_add_label.yaml
        labelSelector: {kube-burner-job: api-intensive}
        patchType: "application/strategic-merge-patch+json"
        apiVersion: apps/v1

  - name: api-intensive-remove
    qps: 500
    burst: 500
    jobType: delete
    waitForDeletion: true
    objects:
      - kind: Deployment
        labelSelector: {kube-burner-job: api-intensive}
        apiVersion: apps/v1

  - name: ensure-pods-removal
    qps: 100
    burst: 100
    jobType: delete
    waitForDeletion: true
    objects:
      - kind: Pod
        labelSelector: {kube-burner-job: api-intensive}

  - name: remove-services
    qps: 100
    burst: 100
    jobType: delete
    waitForDeletion: true
    objects:
      - kind: Service
        labelSelector: {kube-burner-job: api-intensive}

  - name: remove-configmaps-secrets
    qps: 100
    burst: 100
    jobType: delete
    objects:
      - kind: ConfigMap
        labelSelector: {kube-burner-job: api-intensive}
      - kind: Secret
        labelSelector: {kube-burner-job: api-intensive}

  - name: remove-namespace
    qps: 100
    burst: 100
    jobType: delete
    waitForDeletion: true
    objects:
      - kind: Namespace
        labelSelector: {kube-burner-job: api-intensive}
</span><span class="no">EOF

</span><span class="c"># ìˆ˜í–‰</span>
<span class="nv">$ </span>kube-burner init <span class="nt">-c</span> api-intensive-100.yml <span class="nt">--log-level</span> debug
<span class="c"># =&gt; ...</span>
<span class="c">#    time="2025-08-30 12:29:33" level=debug msg="Removing Pod/api-intensive-1-7f8b8bf658-kbtsg from namespace api-intensive-76" file="delete.go:55"</span>
<span class="c">#    time="2025-08-30 12:29:33" level=debug msg="Removing Pod/api-intensive-1-85bd5f8658-sfvmt from namespace api-intensive-76" file="delete.go:55"</span>
<span class="c">#    time="2025-08-30 12:29:33" level=debug msg="Removing Pod/api-intensive-1-68c7855c5-b7qx9 from namespace api-intensive-66" file="delete.go:55"</span>
<span class="c">#    time="2025-08-30 12:29:34" level=debug msg="Waiting for 206 pods labeled with kube-burner-job=api-intensive to be deleted" file="delete.go:79"</span>
<span class="c">#    time="2025-08-30 12:29:36" level=debug msg="Waiting for 219 pods labeled with kube-burner-job=api-intensive to be deleted" file="delete.go:79"</span>
<span class="c">#    time="2025-08-30 12:29:38" level=debug msg="Waiting for 233 pods labeled with kube-burner-job=api-intensive to be deleted" file="delete.go:79"</span>
<span class="c">#    time="2025-08-30 12:29:40" level=debug msg="Waiting for 251 pods labeled with kube-burner-job=api-intensive to be deleted" file="delete.go:79"</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ kube-apiserverì— ìš”ì²­ì´ ìŒ“ì´ë©´ì„œ êµ‰ì¥íˆ ëŠë ¤ì§‘ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì›¨ì´íŒ…ë„ ê±¸ë¦½ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w7/20250831_cilium_w7_15.png" alt="img_1.png" class="image-center" />
<em class="image-caption">kube-burnerë¡œ apiserver ìš”ì²­ì´ ê¸‰ì¦í•˜ë©´ì„œ apiserverì™€ etcd ì§€ì—° ê¸‰ê²©íˆ ì¦ê°€</em></p>

<ul>
  <li>ì´ë²ˆì—ëŠ” QPS/Burstë¥¼ 500ìœ¼ë¡œ ëŠ˜ë ¤ì„œ ë‹¤ì‹œ ìˆ˜í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; api-intensive-500.yml
jobs:
  - name: api-intensive
    jobIterations: 100
    qps: 500
    burst: 500
    namespacedIterations: true
    namespace: api-intensive
    podWait: false
    cleanup: true
    waitWhenFinished: true
    preLoadImages: false # true
    objects:
      - objectTemplate: templates/deployment.yaml
        replicas: 1
      - objectTemplate: templates/configmap.yaml
        replicas: 1
      - objectTemplate: templates/secret.yaml
        replicas: 1
      - objectTemplate: templates/service.yaml
        replicas: 1

  - name: api-intensive-patch
    jobType: patch
    jobIterations: 10
    qps: 500
    burst: 500
    objects:
      - kind: Deployment
        objectTemplate: templates/deployment_patch_add_label.json
        labelSelector: {kube-burner-job: api-intensive}
        patchType: "application/json-patch+json"
        apiVersion: apps/v1
      - kind: Deployment
        objectTemplate: templates/deployment_patch_add_pod_2.yaml
        labelSelector: {kube-burner-job: api-intensive}
        patchType: "application/apply-patch+yaml"
        apiVersion: apps/v1
      - kind: Deployment
        objectTemplate: templates/deployment_patch_add_label.yaml
        labelSelector: {kube-burner-job: api-intensive}
        patchType: "application/strategic-merge-patch+json"
        apiVersion: apps/v1

  - name: api-intensive-remove
    qps: 500
    burst: 500
    jobType: delete
    waitForDeletion: true
    objects:
      - kind: Deployment
        labelSelector: {kube-burner-job: api-intensive}
        apiVersion: apps/v1

  - name: ensure-pods-removal
    qps: 500
    burst: 500
    jobType: delete
    waitForDeletion: true
    objects:
      - kind: Pod
        labelSelector: {kube-burner-job: api-intensive}

  - name: remove-services
    qps: 500
    burst: 500
    jobType: delete
    waitForDeletion: true
    objects:
      - kind: Service
        labelSelector: {kube-burner-job: api-intensive}

  - name: remove-configmaps-secrets
    qps: 500
    burst: 500
    jobType: delete
    objects:
      - kind: ConfigMap
        labelSelector: {kube-burner-job: api-intensive}
      - kind: Secret
        labelSelector: {kube-burner-job: api-intensive}

  - name: remove-namespace
    qps: 500
    burst: 500
    jobType: delete
    waitForDeletion: true
    objects:
      - kind: Namespace
        labelSelector: {kube-burner-job: api-intensive}
</span><span class="no">EOF

</span><span class="c"># ìˆ˜í–‰</span>
<span class="nv">$ </span>kube-burner init <span class="nt">-c</span> api-intensive-500.yml <span class="nt">--log-level</span> debug
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w7/20250831_cilium_w7_16.png" alt="img.png" /></p>

<h4 id="kubernetes-api-ì„±ëŠ¥-ë©”íŠ¸ë¦­--ì˜ˆì œì™€-best-practice---blog">Kubernetes API ì„±ëŠ¥ ë©”íŠ¸ë¦­ : ì˜ˆì œì™€ Best Practice - <a href="https://www.redhat.com/en/blog/kubernetes-api-performance-metrics-examples-and-best-practices">Blog</a></h4>

<ul>
  <li>Kubernetesì—ì„œ ì¼ë°˜ì ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì›Œí¬ë¡œë“œ ë°°í¬ ê³¼ì •
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_14.png" alt="img.png" class="image-center" />
    <ul>
      <li>ì‚¬ìš©ìëŠ” REST APIë‚˜ ëª…ë ¹ì¤„ì„ ì‚¬ìš©í•˜ì—¬ ë°°í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
      <li>API Server (<a href="https://kubernetes.io/docs/reference/generated/kube-apiserver/">kube-apiserver</a>)ê°€ Deployment ëª…ì„¸ì„œë¥¼ etcdì— ê¸°ë¡í•©ë‹ˆë‹¤.</li>
      <li>DeploymentControllerëŠ” ìƒˆë¡œìš´ Deploymentsë¥¼ watchesí•˜ì—¬ ì´ë²¤íŠ¸ë¥¼ ìƒì„±í•˜ê³  Deployment Specì— ë§ì¶° ì¡°ì •í•˜ê³  ReplicaSet ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ìƒì„±í•œ ë‹¤ìŒ ì´ë¥¼ API ì„œë²„ì— ê²Œì‹œí•˜ê³  ReplicaSet ì‚¬ì–‘ì„ etcdì— ê¸°ë¡í•©ë‹ˆë‹¤.</li>
      <li>ReplicaSet ì»¨íŠ¸ë¡¤ëŸ¬ëŠ”Â ReplicaSet ìƒì„±Â ì´ë²¤íŠ¸ë¥¼ ê°ì‹œí•˜ê³  ìƒˆ Pod ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ API ì„œë²„ì— ê²Œì‹œí•˜ê³  Pod ì‚¬ì–‘ì„ etcdì— ê¸°ë¡í•©ë‹ˆë‹¤.</li>
      <li>ìŠ¤ì¼€ì¥´ëŸ¬ëŠ” íŒŒë“œ ìƒì„± ì´ë²¤íŠ¸ë¥¼ ê°ì‹œí•˜ê³  ë°”ì¸ë”©ë˜ì§€ ì•Šì€ íŒŒë“œë¥¼ ê°ì§€í•©ë‹ˆë‹¤. íŒŒë“œë¥¼ ìŠ¤ì¼€ì¤„ë§í•˜ê³  íŒŒë“œì˜ ë…¸ë“œ ë°”ì¸ë”©ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.</li>
      <li>ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” Kubeletì€ ìƒˆë¡œìš´ Pod ìŠ¤ì¼€ì¤„ë§ì„ ê°ì§€í•˜ê³  ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„(ì˜ˆ: cri-o)ì„ ì‚¬ìš©í•˜ì—¬ ì´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.</li>
      <li>Kubeletì€ ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ì„ í†µí•´ Pod ìƒíƒœë¥¼ ê²€ìƒ‰í•˜ì—¬ API ì„œë²„ì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>API ì„±ëŠ¥ ê´€ë ¨ ì£¼ìš” ë©”íŠ¸ë¦­
    <ul>
      <li><code class="language-plaintext highlighter-rouge">apiserver_request_total</code> : API ì„œë²„ì— ëŒ€í•œ ì´ ìš”ì²­ ìˆ˜</li>
      <li><code class="language-plaintext highlighter-rouge">rate(apiserver_request_total{job="apiserver"}[5m])</code> : ì§€ë‚œ 5ë¶„ ë™ì•ˆì˜ API ì„œë²„ ìš”ì²­ ì´ˆë‹¹ í‰ê·  ì¦ê°€ìœ¨</li>
      <li><code class="language-plaintext highlighter-rouge">irate(apiserver_request_total{job="apiserver"}[5m])</code> : ì§€ë‚œ 5ë¶„ ë™ì•ˆì˜ API ì„œë²„ ìš”ì²­ ì´ˆë‹¹ ìˆœê°„ ì¦ê°€ìœ¨</li>
      <li>ì‹¤ìŠµ (Prometheusì—ì„œ ì‹¤ìŠµ)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì—°ìŠµ1 : ë¼ë²¨(label) ê³¼ ê°’(value) í™•ì¸</span>
apiserver_request_total
rate<span class="o">(</span>apiserver_request_total<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">"apiserver"</span><span class="o">}[</span>5m]<span class="o">)</span>
irate<span class="o">(</span>apiserver_request_total<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">"apiserver"</span><span class="o">}[</span>5m]<span class="o">)</span>
    
<span class="c"># ì—°ìŠµ2</span>
<span class="nb">sum </span>by<span class="o">(</span>code<span class="o">)</span> <span class="o">(</span>irate<span class="o">(</span>apiserver_request_total<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">"apiserver"</span><span class="o">}[</span>5m]<span class="o">))</span> <span class="c"># codeë¡œ grouping</span>
<span class="nb">sum </span>by<span class="o">(</span>verb<span class="o">)</span> <span class="o">(</span>irate<span class="o">(</span>apiserver_request_total<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">"apiserver"</span><span class="o">}[</span>5m]<span class="o">))</span> <span class="c"># verbë¡œ grouping</span>
<span class="nb">sum </span>by<span class="o">(</span>resource<span class="o">)</span> <span class="o">(</span>irate<span class="o">(</span>apiserver_request_total<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">"apiserver"</span><span class="o">}[</span>5m]<span class="o">))</span> <span class="c"># resourceë¡œ grouping</span>
<span class="nb">sum </span>by<span class="o">(</span>resource, code, verb<span class="o">)</span> <span class="o">(</span>irate<span class="o">(</span>apiserver_request_total<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">"apiserver"</span><span class="o">}[</span>5m]<span class="o">))</span> <span class="c"># resource, code, verbë¡œ grouping</span>
    
<span class="c"># ì—°ìŠµ3 : resource ê°’ ì—†ëŠ” ê²ƒ ì œì™¸</span>
topk<span class="o">(</span>3, <span class="nb">sum </span>by<span class="o">(</span>resource<span class="o">)</span> <span class="o">(</span>irate<span class="o">(</span>apiserver_request_total<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">"apiserver"</span><span class="o">}[</span>5m]<span class="o">)))</span>
topk<span class="o">(</span>3, <span class="nb">sum </span>by<span class="o">(</span>resource<span class="o">)</span> <span class="o">(</span>irate<span class="o">(</span>apiserver_request_total<span class="o">{</span><span class="nv">resource</span><span class="o">=</span>~<span class="s2">".+"</span><span class="o">}[</span>5m]<span class="o">)))</span>
    
<span class="c"># ì—°ìŠµ3 : 4xx, 5xx ì‘ë‹µ ì½”ë“œë§Œ í•„í„°ë§</span>
<span class="nb">sum </span>by<span class="o">(</span>code<span class="o">)</span> <span class="o">(</span>rate<span class="o">(</span>apiserver_request_total<span class="o">{</span><span class="nv">code</span><span class="o">=</span>~<span class="s2">"[45].."</span><span class="o">}[</span>1m]<span class="o">))</span>
    
<span class="c"># ìµœì¢…</span>
<span class="nb">sum </span>by<span class="o">(</span>resource, code, verb<span class="o">)</span> <span class="o">(</span>rate<span class="o">(</span>apiserver_request_total<span class="o">{</span><span class="nv">resource</span><span class="o">=</span>~<span class="s2">".+"</span><span class="o">}[</span>5m]<span class="o">))</span>
or
<span class="nb">sum </span>by<span class="o">(</span>resource, code, verb<span class="o">)</span> <span class="o">(</span>irate<span class="o">(</span>apiserver_request_total<span class="o">{</span><span class="nv">resource</span><span class="o">=</span>~<span class="s2">".+"</span><span class="o">}[</span>5m]<span class="o">))</span>
</code></pre></div>        </div>
        <p><img src="/assets/2025/cilium/w7/20250831_cilium_w7_17.png" alt="img.png" /></p>
      </li>
    </ul>
  </li>
  <li><strong>[Tuning] API ì„œë²„ flag</strong> : max-requests-inflight (ê¸°ë³¸ê°’ 400) , max-mutating-requests-inflight (ê¸°ë³¸ê°’ 200) - <a href="https://aws.github.io/aws-eks-best-practices/ko/scalability/docs/control-plane/">Docs</a>, <a href="https://docs.ocha.ng/kubernetes/apf">APF</a>
    <ul>
      <li>API ì„œë²„ëŠ”Â <code class="language-plaintext highlighter-rouge">--max-requests-inflight</code>Â query-type(get,list,watchâ€¦)ë°Â <code class="language-plaintext highlighter-rouge">--max-mutating-requests-inflight</code>Â mutating-type(create,update,deleteâ€¦) í”Œë˜ê·¸ë¡œ ì§€ì •ëœ ê°’ì„ í•©ì‚°í•˜ì—¬ í—ˆìš©í•  ìˆ˜ ìˆëŠ” ì´ ì§„í–‰ ì¤‘ì¸ ìš”ì²­ ìˆ˜ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.</li>
      <li>AWS EKSëŠ” ì´ëŸ¬í•œ í”Œë˜ê·¸ì— ëŒ€í•´ ê¸°ë³¸ê°’ì¸ 400ê°œ ë° 200ê°œ ìš”ì²­ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì£¼ì–´ì§„ ì‹œê°„ì— ì´ 600ê°œì˜ ìš”ì²­ì„ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>APFëŠ” ì´ëŸ¬í•œ 600ê°œì˜ ìš”ì²­ì„ ë‹¤ì–‘í•œ ìš”ì²­ ìœ í˜•ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ë°©ë²•ì„ ì§€ì •í•©ë‹ˆë‹¤.</li>
      <li>AWS EKS ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì€ ê° í´ëŸ¬ìŠ¤í„°ì— ìµœì†Œ 2ê°œì˜ API ì„œë²„ê°€ ë“±ë¡ë˜ì–´ ìˆì–´ ê°€ìš©ì„±ì´ ë†’ìŠµë‹ˆë‹¤.</li>
      <li>
        <p>ì´ë ‡ê²Œ í•˜ë©´ í´ëŸ¬ìŠ¤í„° ì „ì²´ì˜ ì´ ì§„í–‰ ì¤‘ì¸ ìš”ì²­ ìˆ˜ê°€ 1200ê°œë¡œ ëŠ˜ì–´ë‚©ë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system kube-apiserver-myk8s-control-plane <span class="nt">--</span> kube-apiserver <span class="nt">-h</span>
<span class="c"># =&gt; ...</span>
<span class="c">#          --max-mutating-requests-inflight int                                                                </span>
<span class="c">#                    This and --max-requests-inflight are summed to determine the server's total concurrency limit (which</span>
<span class="c">#                    must be positive) if --enable-priority-and-fairness is true. Otherwise, this flag limits the maximum</span>
<span class="c">#                    number of mutating requests in flight, or a zero value disables the limit completely. (default 200)</span>
<span class="c">#          --max-requests-inflight int                                                                                </span>
<span class="c">#                    This and --max-mutating-requests-inflight are summed to determine the server's total concurrency</span>
<span class="c">#                    limit (which must be positive) if --enable-priority-and-fairness is true. Otherwise, this flag</span>
<span class="c">#                    limits the maximum number of non-mutating requests in flight, or a zero value disables the limit</span>
<span class="c">#                    completely. (default 400)</span>
<span class="c">#          --min-request-timeout int                                                                                  </span>
<span class="c">#                    An optional field indicating the minimum number of seconds a handler must keep a request open before</span>
<span class="c">#                    timing it out. Currently only honored by the watch request handler, which picks a randomized value</span>
<span class="c">#                    above this number as the connection timeout, to spread out load. (default 1800)</span>
<span class="c">#          --request-timeout duration                                                                                 </span>
<span class="c">#                    An optional field indicating the duration a handler must keep a request open before timing it out.</span>
<span class="c">#                    This is the default request timeout for requests but may be overridden by flags such as</span>
<span class="c">#                    --min-request-timeout for specific types of requests. (default 1m0s)</span>
</code></pre></div>        </div>
      </li>
      <li><code class="language-plaintext highlighter-rouge">--max-requests-inflight</code>Â <strong>í´ëŸ¬ìŠ¤í„° ìƒíƒœ ì¡°íšŒ</strong>
        <ul>
          <li>ì„¤ëª… : API ì„œë²„ê°€ ë™ì‹œì— ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” non-mutating ìš”ì²­(GET, LIST, WATCH ë“±)ì˜ ìµœëŒ€ ìˆ˜ë¥¼ ì œí•œí•©ë‹ˆë‹¤.</li>
          <li>ë™ì‘ : ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ íì— ë„£ê³ , í˜„ì¬ inflight ìˆ˜ê°€ ìµœëŒ€ê°’ì„ ë„˜ìœ¼ë©´ 429 Too Many Requestsë¥¼ ë°˜í™˜í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">--max-mutating-requests-inflight</code>Â <strong>í´ëŸ¬ìŠ¤í„° ìƒíƒœ ë³€ê²½</strong>
        <ul>
          <li>ì„¤ëª… : API ì„œë²„ê°€ ë™ì‹œì— ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” mutating ìš”ì²­(POST, PUT, PATCH, DELETE)ì˜ ìµœëŒ€ ìˆ˜ë¥¼ ì œí•œí•©ë‹ˆë‹¤.</li>
          <li>ë™ì‘ : Mutating ìš”ì²­ì€ í´ëŸ¬ìŠ¤í„° ìƒíƒœë¥¼ ë³€ê²½í•˜ê¸° ë•Œë¬¸ì—, ë„ˆë¬´ ë§ìœ¼ë©´ <strong>etcd I/Oì™€ API ì„œë²„ ë‚´ë¶€ lock</strong>ì— ë¶€í•˜ â†’ ì„œë²„ ì „ì²´ ì„±ëŠ¥ ì €í•˜ â‡’ ìš”ì²­ì´ ìµœëŒ€ê°’ì„ ë„˜ì–´ê°€ë©´ ì—­ì‹œ 429 ë°˜í™˜í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">PriorityAndFairness(P&amp;F)</code> : API ì„œë²„ê°€ ìš”ì²­ì„ PriorityLevelì— ë”°ë¼ íì‰í•˜ë©°, ê° PriorityLevelë³„ í• ë‹¹ í ì¡´ì¬í•©ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_18.png" alt="img.png" /></li>
    </ul>
  </li>
  <li><strong>[Tuning] CoreDNS :</strong> Multi Socket Plugin ì†Œê°œ - <a href="https://www.youtube.com/watch?v=W3f5Ks0j2Q8">Youtube</a>
    <ul>
      <li><strong>CoreDNS</strong> : DNSì™€ Service Discoveryë¥¼ ë‹´ë‹¹ - <a href="https://coredns.io/">Docs</a>
        <ul>
          <li>Go ì–¸ì–´ë¡œ ì‘ì„±ëœ ìœ ì—°í•œ DNS ì„œë²„ì…ë‹ˆë‹¤.</li>
          <li>ê²½ëŸ‰í™”, ë¹ ë¦„, í™•ì¥ì„± ì¢‹ìœ¼ë©° ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ì— ì¤‘ì ë‘ê³  ê°œë°œë˜ì—ˆìŠµë‹ˆë‹¤.</li>
          <li>í”ŒëŸ¬ê·¸ì¸ ê¸°ë°˜ì˜ ì•„í‚¤í…ì²˜ë¡œ ì‰½ê²Œ í™•ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
          <li>Kubernetesì˜ ê¸°ë³¸ DNS ì„œë²„ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</li>
          <li>DNS, DNS over TLS, DNS over gRPCë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><strong>MultiSocket</strong> ğŸ‘ğŸ» : ìˆ˜ì§ í™•ì¥ì„±ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤. - <a href="https://coredns.io/plugins/multisocket/">Docs</a>
        <ul>
          <li>MultiSocketì„ ì‚¬ìš©í•˜ë©´ í•˜ë‚˜ì˜ í¬íŠ¸ì—ì„œ ì—¬ëŸ¬ ì„œë²„ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>SO_REUSEPORT ì†Œì¼“ ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ ë™ì¼í•œ ì£¼ì†Œì™€ í¬íŠ¸ì—ì„œ ì—¬ëŸ¬ ì²­ì·¨ ì†Œì¼“ì„ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° ì»¤ë„ì€ ì†Œì¼“ ê°„ì— ë“¤ì–´ì˜¤ëŠ” ì—°ê²°ì„ ë¶„ì‚°í•©ë‹ˆë‹¤.</li>
          <li>ê¸°ì¡´ CoreDNS ê¸°ë³¸ ì„¤ì • í™˜ê²½ì—ì„œ CPUê°€ ë§ì•„ì ¸ë„ QPSê°€ ëŠ˜ì–´ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.. â†’ <strong>2 CPU ê²½ìš° 40k qps</strong></li>
          <li>ì´ ì˜µì…˜ì„ í™œì„±í™”í•˜ë©´ ì—¬ëŸ¬ ì„œë²„ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆì–´ CPU ì½”ì–´ê°€ ë§ì€ í™˜ê²½ì—ì„œ CoreDNSì˜ ì²˜ë¦¬ëŸ‰ì´ ì¦ê°€í•©ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_19.png" alt="img.png" class="image-center" />
<em class="image-caption">ê¸°ì¡´ì˜ CoreDNS ì²˜ë¦¬ êµ¬ì¡°</em>
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_20.png" alt="img_1.png" class="image-center" />
<em class="image-caption">Multi Socketì´ ì ìš©ë˜ì–´ ì—¬ëŸ¬ ì„œë²„ê°€ ì‘ë™ ì¤‘ì¸ CoreDNS</em>
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_21.png" alt="img_2.png" class="image-center" />
<em class="image-caption">Multi Socket ì ìš© ì „í›„ ë¹„êµ (1 Socketì´ ì ìš©ì „ì„)</em></li>
          <li>ìœ„ì˜ ê·¸ë˜í”„ì—ì„œ ë³´ë“¯ì´ Multi Socketì„ CPU ì½”ì–´ìˆ˜ì— ë§ê²Œ ì„¤ì •í•˜ë©´ CPU ì½”ì–´ê°€ ë§ì•„ì§ˆìˆ˜ë¡ QPSê°€ ì¦ê°€í•˜ëŠ” ìˆ˜ì§ í™•ì¥ì„±ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>ETCD ì¬ì‹œì‘ìœ¼ë¡œ ì¸í•œ ì¥ì•  ë¶„ì„ Case</strong> : net.ipv4.tcp_timestamps , net.ipv4.tcp_wan_timestamps  - <a href="https://segmentfault.com/a/1190000043406041">Link</a>
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_22.png" alt="img.png" />
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_23.png" alt="img_1.png" />
    <ul>
      <li>í•´ë‹¹ ë¸”ë¡œê·¸ëŠ” ETCD ì¬ì‹œì‘ìœ¼ë¡œ ì¸í•´ K8S í´ëŸ¬ìŠ¤í„°ê°€ ë¶ˆì•ˆì •í•´ì§„ ì›ì¸ì„ ë¶„ì„í•œ ê¸€ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ëŒ€ê·œëª¨ í´ëŸ¬ìŠ¤í„° ìš´ì˜ ê´€ë ¨ ìœ íŠœë¸Œ ë§í¬ ëª¨ìŒì…ë‹ˆë‹¤. ìƒë‹¹í•œ ì–‘ìœ¼ë¡œ ë‚˜ì¤‘ì— í•˜ë‚˜ì”© ì‚´í´ë´ì•¼ í• ê²ƒ ê°™ìŠµë‹ˆë‹¤.
    <ul>
      <li><strong>Building Armada â€“ Running Batch Jobs at Massive Scale on Kubernetes - Jamie Poole, G-Research - <a href="https://www.youtube.com/watch?v=B3WPxw3OUl4">Youtube</a></strong></li>
      <li><strong>Automated Multi-Cloud Large Scale K8s Cluster Lifecycle Management - Sourav Khandelwal, Databricks - <a href="https://www.youtube.com/watch?v=9E7lenP6pFc">Youtube</a></strong></li>
      <li><strong>An Alternative Metadata System for Large Kubernetes Clusters - Yingcai Xue &amp; Yixiang Chen, ByteDance - <a href="https://www.youtube.com/watch?v=MGOa8Nn8_S0">Youtube</a></strong></li>
      <li>Large Scale Automated Storage with Kubernetes - Celina Ward, Software Engineer &amp; Matt Schallert, Site Reliability Engineer, Uber - <a href="https://www.youtube.com/watch?v=aDFm5KaTaOk">Youtube</a></li>
      <li><strong>Large-Scale Practice of Persistent Memory in Alibaba Cloud - Junbao Kan &amp; Qingcan Wang, Alibaba - <a href="https://www.youtube.com/watch?v=3MKbk7AS8Jw">Youtube</a></strong></li>
      <li>Managing Large-Scale Kubernetes Clusters Effectively and Reliably - Yong Zhang &amp; Zhixian Lin - <a href="https://www.youtube.com/watch?v=yUL7NKt2hAY">Youtube</a></li>
      <li><strong>How to Stabilize a GenAI-First, Modern Data LakeHouse: Provision 20,000 Ephemeral Data Lakes/Year - <a href="https://www.youtube.com/watch?v=L02zdTo7HT0">Youtube</a></strong></li>
      <li><strong>Scaling Kubernetes Networking to 1k, 5k, â€¦ 100k Nodes!? - Marcel ZiÄ™ba, Isovalent &amp; Dorde Lapcevic, Google - <a href="https://www.youtube.com/watch?v=VWGB-NW800Y">Youtube</a></strong></li>
      <li>Collecting Operational Metrics for a Cluster with 5,000 Namespaces - Rob Szumski &amp; Chance Zibolski, Red Hat - <a href="https://www.youtube.com/watch?v=JHmWRBWPKog">Youtube</a></li>
      <li>Scaling Kubernetes Networking Beyond 100k Endpoints - Rob Scott &amp; Minhan Xia, Google - <a href="https://www.youtube.com/watch?v=a6SfbeM06Qo">Youtube</a></li>
      <li>Per-Node Api-Server Proxy: Expand the Clusterâ€™s Scale and Stability - Weizhou Lan &amp; Iceber Gu - <a href="https://www.youtube.com/watch?v=O7w7e2iA7lA">Youtube</a></li>
      <li>Build a High Performance Remote Storage for Prometheus with Unlimited Time Series - Yang Xiang - <a href="https://www.youtube.com/watch?v=7pQZyYEz1l4">Youtube</a></li>
      <li><strong>BGP Peering Patterns for Kubernetes Networking at Preferred Networks - Sho Shimizu &amp; Yutaro Hayakawa - <a href="https://www.youtube.com/watch?v=n7_I4zu6f_M">Youtube</a></strong></li>
      <li>Kubernetes Performance Tuning Workshop - Anton Weiss - <a href="https://www.youtube.com/watch?v=7CObA_qY6vo">Youtube</a></li>
    </ul>
  </li>
</ul>

<h5 id="kind-í´ëŸ¬ìŠ¤í„°-ì‚­ì œ">Kind í´ëŸ¬ìŠ¤í„° ì‚­ì œ</h5>

<ul>
  <li>ë‹¤ìŒ ì‹¤ìŠµì„ ìœ„í•´ í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kind delete cluster <span class="nt">--name</span> myk8s
</code></pre></div></div>

<hr />

<h2 id="cilium-performance">Cilium Performance</h2>

<h3 id="ì‹¤ìŠµí™˜ê²½-ì¤€ë¹„">ì‹¤ìŠµí™˜ê²½ ì¤€ë¹„</h3>

<ul>
  <li>Kindì™€ Cilium CNIë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ìŠµí™˜ê²½ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Prometheus Target connection refused bind-address ì„¤ì • : kube-controller-manager , kube-scheduler , etcd , kube-proxy</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.33.2 <span class="nt">--config</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  - containerPort: 30003
    hostPort: 30003
  kubeadmConfigPatches: # Prometheus Target connection refused bind-address ì„¤ì •
  - |
    kind: ClusterConfiguration
    controllerManager:
      extraArgs:
        bind-address: 0.0.0.0
    etcd:
      local:
        extraArgs:
          listen-metrics-urls: http://0.0.0.0:2381
    scheduler:
      extraArgs:
        bind-address: 0.0.0.0
  - |
    kind: KubeProxyConfiguration
    metricsBindAddress: 0.0.0.0
networking:
  disableDefaultCNI: true
  kubeProxyMode: none
  podSubnet: "10.244.0.0/16"   # cluster-cidr
kubeadmConfigPatches:
- |
  kind: ClusterConfiguration
  controllerManager:
    extraArgs:
      allocate-node-cidrs: "true"
      cluster-cidr: "10.244.0.0/16"
      node-cidr-mask-size: "22"
</span><span class="no">EOF
</span><span class="c"># =&gt; Creating cluster "myk8s" ...</span>
<span class="c">#     âœ“ Ensuring node image (kindest/node:v1.33.2) ğŸ–¼</span>
<span class="c">#     âœ“ Preparing nodes ğŸ“¦</span>
<span class="c">#     âœ“ Writing configuration ğŸ“œ</span>
<span class="c">#     âœ“ Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#     âœ“ Installing StorageClass ğŸ’¾</span>
<span class="c">#    Set kubectl context to "kind-myk8s"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-myk8s</span>

<span class="c"># node ë³„ PodCIDR í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].spec.podCIDR}'</span>
<span class="c"># =&gt; 10.244.0.0/22</span>

<span class="c"># cilium cni ì„¤ì¹˜</span>
<span class="nv">$ </span>cilium <span class="nb">install</span> <span class="nt">--version</span> 1.18.1 <span class="nt">--set</span> ipam.mode<span class="o">=</span>kubernetes <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>172.20.0.0/16 <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> endpointRoutes.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">directRoutingSkipUnreachable</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>30003 <span class="se">\</span>
  <span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> envoy.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span> <span class="se">\</span>
  <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span>  <span class="c"># --dry-run-helm-values</span>
<span class="c"># =&gt; ğŸ”® Auto-detected Kubernetes kind: kind</span>
<span class="c">#    â„¹ï¸   Using Cilium version 1.18.1</span>
<span class="c">#    ğŸ”® Auto-detected cluster name: kind-myk8s</span>
<span class="c">#    â„¹ï¸   Detecting real Kubernetes API server addr and port on Kind</span>
<span class="c">#    ğŸ”® Auto-detected kube-proxy has not been installed</span>
<span class="c">#    â„¹ï¸   Cilium will fully replace all functionalities of kube-proxy</span>

<span class="c"># hubble ui</span>
<span class="nv">$ </span>open http://127.0.0.1:30003

<span class="c"># metrics-server</span>
<span class="nv">$ </span>helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
<span class="nv">$ </span>helm upgrade <span class="nt">--install</span> metrics-server metrics-server/metrics-server <span class="nt">--set</span> <span class="s1">'args[0]=--kubelet-insecure-tls'</span> <span class="nt">-n</span> kube-system
<span class="c"># =&gt; Release "metrics-server" does not exist. Installing it now.</span>
<span class="c">#    NAME: metrics-server</span>
<span class="c">#    LAST DEPLOYED: Sat Aug 30 17:13:42 2025</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    ***********************************************************************</span>
<span class="c">#    * Metrics Server                                                      *</span>
<span class="c">#    ***********************************************************************</span>
<span class="c">#      Chart version: 3.13.0</span>
<span class="c">#      App version:   0.8.0</span>
<span class="c">#      Image tag:     registry.k8s.io/metrics-server/metrics-server:v0.8.0</span>
<span class="c">#    ***********************************************************************</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl top node
<span class="c"># =&gt; NAME                  CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)</span>
<span class="c">#    myk8s-control-plane   496m         7%       1132Mi          23%</span>
<span class="nv">$ </span>kubectl top pod <span class="nt">-A</span> <span class="nt">--sort-by</span><span class="o">=</span><span class="s1">'cpu'</span>
<span class="nv">$ </span>kubectl top pod <span class="nt">-A</span> <span class="nt">--sort-by</span><span class="o">=</span><span class="s1">'memory'</span>
</code></pre></div></div>

<h5 id="prometheus--grafana-ì„¤ì¹˜---docs">Prometheus &amp; Grafana ì„¤ì¹˜ - <a href="https://docs.cilium.io/en/stable/observability/grafana/">Docs</a></h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml

<span class="c">#</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep <span class="nt">-n</span> cilium-monitoring
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> cilium-monitoring
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring prometheus
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring grafana-config
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> cilium-monitoring

<span class="c"># NodePort ì„¤ì •</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> cilium-monitoring prometheus <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 9090, "targetPort": 9090, "nodePort": 30001}]}}'</span>
<span class="c"># =&gt; service/prometheus patched</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> cilium-monitoring grafana <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 3000, "targetPort": 3000, "nodePort": 30002}]}}'</span>
<span class="c"># =&gt; service/grafana patched</span>

<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME         TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    grafana      NodePort   10.96.85.141   &lt;none&gt;        3000:30002/TCP   37s</span>
<span class="c">#    prometheus   NodePort   10.96.59.105   &lt;none&gt;        9090:30001/TCP   37s</span>

<span class="c"># ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:30001"</span>  <span class="c"># prometheus</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:30002"</span>  <span class="c"># grafana</span>
</code></pre></div></div>

<h3 id="ì¿ ë²„ë„¤í‹°ìŠ¤-í™˜ê²½ì—ì„œ-ì†ë„-ì¸¡ì •-í…ŒìŠ¤íŠ¸">ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì—ì„œ ì†ë„ ì¸¡ì • í…ŒìŠ¤íŠ¸</h3>

<ul>
  <li>ì¼ë°˜ì ìœ¼ë¡œ ì„±ëŠ¥ ì¸¡ì •ì‹œ ë§ì´ ì“°ì´ëŠ” <code class="language-plaintext highlighter-rouge">iperf3</code>ë¥¼ ì‚¬ìš©í•˜ì—¬ TCP/UDP ì†ë„ë¥¼ ì¸¡ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ë°°í¬ ë° í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: iperf3-server
spec:
  selector:
    matchLabels:
      app: iperf3-server
  replicas: 1
  template:
    metadata:
      labels:
        app: iperf3-server
    spec:
      containers:
      - name: iperf3-server
        image: networkstatic/iperf3
        args: ["-s"]
        ports:
        - containerPort: 5201
---
apiVersion: v1
kind: Service
metadata:
  name: iperf3-server
spec:
  selector:
    app: iperf3-server
  ports:
    - name: tcp-service
      protocol: TCP
      port: 5201
      targetPort: 5201
    - name: udp-service
      protocol: UDP
      port: 5201
      targetPort: 5201
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: iperf3-client
spec:
  selector:
    matchLabels:
      app: iperf3-client
  replicas: 1
  template:
    metadata:
      labels:
        app: iperf3-client
    spec:
      containers:
      - name: iperf3-client
        image: networkstatic/iperf3
        command: ["sleep"]
        args: ["infinity"]
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/iperf3-server created</span>
<span class="c">#    service/iperf3-server created</span>
<span class="c">#    deployment.apps/iperf3-client created</span>

<span class="c"># í™•ì¸ : ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°€ ì–´ë–¤ ë…¸ë“œì— ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS      IMAGES                 SELECTOR</span>
<span class="c">#    deployment.apps/iperf3-client   1/1     1            1           28s   iperf3-client   networkstatic/iperf3   app=iperf3-client</span>
<span class="c">#    deployment.apps/iperf3-server   1/1     1            1           28s   iperf3-server   networkstatic/iperf3   app=iperf3-server</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)             AGE   SELECTOR</span>
<span class="c">#    service/iperf3-server   ClusterIP   10.96.7.124   &lt;none&gt;        5201/TCP,5201/UDP   28s   app=iperf3-server</span>
<span class="c">#    service/kubernetes      ClusterIP   10.96.0.1     &lt;none&gt;        443/TCP             14m   &lt;none&gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                                 READY   STATUS    RESTARTS   AGE   IP             NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/iperf3-client-688ff6565d-267sh   1/1     Running   0          28s   10.244.2.248   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    pod/iperf3-server-5d54b669cc-k8gzf   1/1     Running   0          28s   10.244.2.101   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
</code></pre></div></div>

<ul>
  <li>ì‹¤ìŠµ 1. TCP 5201, ì¸¡ì •ì‹œê°„ 5ì´ˆ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-t</span> 5
<span class="c"># =&gt; Connecting to host iperf3-server, port 5201</span>
<span class="c">#    [  5] local 10.244.2.248 port 42338 connected to 10.96.7.124 port 5201</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5]   0.00-1.00   sec  8.86 GBytes  76.1 Gbits/sec  2581    346 KBytes</span>
<span class="c">#    [  5]   1.00-2.00   sec  8.38 GBytes  72.0 Gbits/sec  264    380 KBytes</span>
<span class="c">#    [  5]   2.00-3.00   sec  9.39 GBytes  80.7 Gbits/sec  1054    461 KBytes</span>
<span class="c">#    [  5]   3.00-4.00   sec  8.82 GBytes  75.7 Gbits/sec  533    769 KBytes</span>
<span class="c">#    [  5]   4.00-5.00   sec  8.80 GBytes  75.6 Gbits/sec  199    827 KBytes</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5]   0.00-5.00   sec  44.2 GBytes  76.0 Gbits/sec  4631             sender</span>
<span class="c">#    [  5]   0.00-5.00   sec  44.2 GBytes  76.0 Gbits/sec                  receiver</span>

<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
<span class="c"># =&gt; -----------------------------------------------------------</span>
<span class="c">#    Server listening on 5201 (test #1)</span>
<span class="c">#    -----------------------------------------------------------</span>
<span class="c">#    Accepted connection from 10.244.2.248, port 42336</span>
<span class="c">#    [  5] local 10.244.2.101 port 5201 connected to 10.244.2.248 port 42338</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-1.00   sec  8.86 GBytes  76.1 Gbits/sec</span>
<span class="c">#    [  5]   1.00-2.00   sec  8.37 GBytes  71.9 Gbits/sec</span>
<span class="c">#    [  5]   2.00-3.00   sec  9.40 GBytes  80.8 Gbits/sec</span>
<span class="c">#    [  5]   3.00-4.00   sec  8.81 GBytes  75.7 Gbits/sec</span>
<span class="c">#    [  5]   4.00-5.00   sec  8.81 GBytes  75.6 Gbits/sec</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-5.00   sec  44.2 GBytes  76.0 Gbits/sec                  receiver</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê¸°ë³¸ì ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì¸¡ ë¡œê·¸ì™€ ì„œë²„ì¸¡ ë¡œê·¸ê°€ ë™ì¼í•˜ê²Œ ë‚˜ì˜µë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>ì‹¤ìŠµ 2. UDP ì‚¬ìš© (-u)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-u</span> <span class="nt">-b</span> 20G
<span class="c"># =&gt; Connecting to host iperf3-server, port 5201</span>
<span class="c">#    [  5] local 10.244.2.248 port 39637 connected to 10.96.7.124 port 5201</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Total Datagrams</span>
<span class="c">#    [  5]   0.00-1.00   sec   335 MBytes  2.81 Gbits/sec  242388</span>
<span class="c">#    [  5]   1.00-2.00   sec   338 MBytes  2.83 Gbits/sec  244711</span>
<span class="c">#    [  5]   2.00-3.00   sec   325 MBytes  2.73 Gbits/sec  235629</span>
<span class="c">#    [  5]   3.00-4.00   sec   327 MBytes  2.74 Gbits/sec  236618</span>
<span class="c">#    [  5]   4.00-5.00   sec   317 MBytes  2.66 Gbits/sec  229570</span>
<span class="c">#    [  5]   5.00-6.00   sec   330 MBytes  2.77 Gbits/sec  238981</span>
<span class="c">#    [  5]   6.00-7.00   sec   337 MBytes  2.83 Gbits/sec  244238</span>
<span class="c">#    [  5]   7.00-8.00   sec   334 MBytes  2.80 Gbits/sec  241738</span>
<span class="c">#    [  5]   8.00-9.00   sec   336 MBytes  2.82 Gbits/sec  243323</span>
<span class="c">#    [  5]   9.00-10.00  sec   331 MBytes  2.78 Gbits/sec  239984</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams</span>
<span class="c">#    [  5]   0.00-10.00  sec  3.23 GBytes  2.78 Gbits/sec  0.000 ms  0/2397180 (0%)  sender</span>
<span class="c">#    [  5]   0.00-10.00  sec  3.22 GBytes  2.77 Gbits/sec  0.003 ms  6167/2397180 (0.26%)  receiver</span>

<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
</code></pre></div></div>

<ul>
  <li>ì‹¤ìŠµ 3. TCP, ìŒë°©í–¥ ëª¨ë“œ(-bidir)
    <ul>
      <li>ì†¡ì‹ (TX), ìˆ˜ì‹ (RX) ëª¨ë‘ ì¸¡ì •í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-t</span> 5 <span class="nt">--bidir</span>
<span class="c"># =&gt; Connecting to host iperf3-server, port 5201</span>
<span class="c">#    [  5] local 10.244.2.248 port 49212 connected to 10.96.7.124 port 5201</span>
<span class="c">#    [  7] local 10.244.2.248 port 49214 connected to 10.96.7.124 port 5201</span>
<span class="c">#    [ ID][Role] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5][TX-C]   0.00-1.00   sec  8.04 GBytes  69.0 Gbits/sec    1   1.25 MBytes</span>
<span class="c">#    [  7][RX-C]   0.00-1.00   sec  1.69 GBytes  14.5 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   1.00-2.00   sec  4.76 GBytes  40.9 Gbits/sec    0   1.25 MBytes</span>
<span class="c">#    [  7][RX-C]   1.00-2.00   sec  5.13 GBytes  44.1 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   2.00-3.00   sec  4.73 GBytes  40.6 Gbits/sec    0   1.25 MBytes</span>
<span class="c">#    [  7][RX-C]   2.00-3.00   sec  4.95 GBytes  42.5 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   3.00-4.00   sec  4.77 GBytes  41.0 Gbits/sec    0   1.25 MBytes</span>
<span class="c">#    [  7][RX-C]   3.00-4.00   sec  5.04 GBytes  43.3 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   4.00-5.00   sec  4.73 GBytes  40.6 Gbits/sec    0   1.25 MBytes</span>
<span class="c">#    [  7][RX-C]   4.00-5.00   sec  4.97 GBytes  42.7 Gbits/sec</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID][Role] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5][TX-C]   0.00-5.00   sec  27.0 GBytes  46.4 Gbits/sec    1             sender</span>
<span class="c">#    [  5][TX-C]   0.00-5.00   sec  27.0 GBytes  46.4 Gbits/sec                  receiver</span>
<span class="c">#    [  7][RX-C]   0.00-5.00   sec  21.8 GBytes  37.4 Gbits/sec    0             sender</span>
<span class="c">#    [  7][RX-C]   0.00-5.00   sec  21.8 GBytes  37.4 Gbits/sec                  receiver</span>
<span class="c"># &gt;&gt; Clientâ†’Server (TX): 46.4 Gbps</span>
<span class="c"># &gt;&gt; Serverâ†’Client (RX): 37.4 Gbps</span>
<span class="c"># &gt;&gt; Retransmit : TX=1, RX=0 â†’ ì¼ë¶€ íŒ¨í‚· ì†ì‹¤ë¡œ ì¸í•œ ì¬ì „ì†¡ì´ ìˆì—ˆìŒ</span>
<span class="c"># &gt;&gt; ì „ì²´ì ìœ¼ë¡œëŠ” 37~46Gbps ìˆ˜ì¤€ì˜ ëŒ€ì—­í­ì´ ì¸¡ì •ë¨</span>

<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
</code></pre></div></div>

<ul>
  <li>ì‹¤ìŠµ 4. TCP ë‹¤ì¤‘ ìŠ¤íŠ¸ë¦¼(30ê°œ), -P(number of parallel client streams to run)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-t</span> 10 <span class="nt">-P</span> 2
<span class="c"># =&gt; ...</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5]   0.00-10.00  sec  58.8 GBytes  50.5 Gbits/sec  444             sender</span>
<span class="c">#    [  5]   0.00-10.00  sec  58.8 GBytes  50.5 Gbits/sec                  receiver</span>
<span class="c">#    [  7]   0.00-10.00  sec  58.8 GBytes  50.5 Gbits/sec  1039             sender</span>
<span class="c">#    [  7]   0.00-10.00  sec  58.8 GBytes  50.5 Gbits/sec                  receiver</span>
<span class="c">#    [SUM]   0.00-10.00  sec   118 GBytes   101 Gbits/sec  1483             sender</span>
<span class="c">#    [SUM]   0.00-10.00  sec   118 GBytes   101 Gbits/sec                  receiver</span>

<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
</code></pre></div></div>

<ul>
  <li>ì‚­ì œ:  <code class="language-plaintext highlighter-rouge">kubectl delete deploy iperf3-server iperf3-client &amp;&amp; kubectl delete svc iperf3-server</code></li>
</ul>

<h3 id="cilium-ì ‘ì†-ë°-ì„±ëŠ¥-í…ŒìŠ¤íŠ¸">Cilium ì ‘ì† ë° ì„±ëŠ¥ í…ŒìŠ¤íŠ¸</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/contributing/testing/e2e/">ê´€ë ¨ë¬¸ì„œ</a></li>
  <li>Ciliumì€ <a href="https://github.com/cilium/cilium-cli/#connectivity-check">cilium-cli connectivity tests</a>ë¥¼ í†µí•´ API ë ˆë²¨ì—ì„œ ë°ì´í„° ê²½ë¡œ ê¹Œì§€ 
end-to-end í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">cilium connectivity test</code> - ê¸°ëŠ¥ ê²€ì¦ ë° ê¸°ëŠ¥ë³„ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ (Pass, Fail)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>cilium connectivity <span class="nt">-h</span>
<span class="c"># =&gt; Connectivity troubleshooting</span>
<span class="c">#    </span>
<span class="c">#    Usage:</span>
<span class="c">#      cilium connectivity [command]</span>
<span class="c">#    </span>
<span class="c">#    Available Commands:</span>
<span class="c">#      perf        Test network performance</span>
<span class="c">#      test        Validate connectivity in cluster</span>

<span class="c"># ì•„ë˜ test ì‹¤í–‰ í›„ cilium-test-1 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì ‘ì†</span>
<span class="nv">$ </span>open http://127.0.0.1:30003/?namespace<span class="o">=</span>cilium-test-1

<span class="c"># test : í…ŒìŠ¤íŠ¸ í•­ëª© 122ê°œ 2:59~</span>
<span class="nv">$ </span>cilium connectivity <span class="nb">test</span> <span class="nt">--debug</span>  
<span class="c"># =&gt; âœ¨ [kind-myk8s] Creating namespace cilium-test-1 for connectivity check...</span>
<span class="c">#    âœ¨ [kind-myk8s] Deploying echo-same-node service...</span>
<span class="c">#    âœ¨ [kind-myk8s] Deploying DNS test server configmap...</span>
<span class="c">#    âœ¨ [kind-myk8s] Deploying same-node deployment...</span>
<span class="c">#    ...í…ŒìŠ¤íŠ¸ í™˜ê²½ ë°°í¬ (ìƒëµ)...</span>
<span class="c">#    ğŸ› [cilium-test-1] Registered connectivity tests</span>
<span class="c">#    ğŸ›   &lt;Test no-policies, 8 scenarios, 0 resources, expectFunc &lt;nil&gt;&gt;</span>
<span class="c">#    ğŸ›   &lt;Test no-policies-from-outside, 1 scenarios, 0 resources, expectFunc &lt;nil&gt;&gt;</span>
<span class="c">#    ğŸ›   &lt;Test no-policies-extra, 2 scenarios, 0 resources, expectFunc &lt;nil&gt;&gt;</span>
<span class="c">#    ğŸ›   &lt;Test allow-all-except-world, 4 scenarios, 1 resources, expectFunc &lt;nil&gt;&gt;</span>
<span class="c">#    ğŸ›   &lt;Test client-ingress, 1 scenarios, 1 resources, expectFunc 0x104e81740&gt;</span>
<span class="c">#    ...</span>

<span class="c"># ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete ns cilium-test-1
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">cilium connectivity perf</code> : ì„±ëŠ¥ ì¸¡ì •(Gbsp, Latency) - Throughput, Retransmit, Latency
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cilium connectivity perf <span class="nt">-h</span>
<span class="c"># =&gt; Usage:</span>
<span class="c">#      cilium connectivity perf [flags]</span>
<span class="c">#    </span>
<span class="c">#    Flags:</span>
<span class="c">#          --bandwidth                        Test pod network bandwidth manage</span>
<span class="c">#          --crr                              Run CRR test</span>
<span class="c">#      -d, --debug                            Show debug messages</span>
<span class="c">#          --duration duration                Duration for the Performance test to run (default 10s)</span>
<span class="c">#      -h, --help                             help for perf</span>
<span class="c">#          --host-net                         Test host network (default true)</span>
<span class="c">#          --host-to-pod                      Test host-to-pod traffic</span>
<span class="c">#          --msg-size int                     Size of message to use in UDP test (default 1024)</span>
<span class="c">#          --namespace-labels map             Add labels to the connectivity test namespace</span>
<span class="c">#          --net-qos                          Test pod network Quality of Service</span>
<span class="c">#          --node-selector-client map         Node selector for the other-node client pod</span>
<span class="c">#          --node-selector-server map         Node selector for the server pod (and client same-node)</span>
<span class="c">#          --other-node                       Run tests in which the client and the server are hosted on difference nodes (default true)</span>
<span class="c">#          --performance-image string         Image path to use for performance (default "quay.io/cilium/network-perf:1751527436-c2462ae@sha256:0c491ed7ca63e6c526593b3a2d478f856410a50fbbce7fe2b64283c3015d752f")</span>
<span class="c">#          --pod-net                          Test pod network (default true)</span>
<span class="c">#          --pod-to-host                      Test pod-to-host traffic</span>
<span class="c">#          --print-image-artifacts            Prints the used image artifacts</span>
<span class="c">#          --report-dir string                Directory to save perf results in json format</span>
<span class="c">#          --rr                               Run RR test (default true)</span>
<span class="c">#          --same-node                        Run tests in which the client and the server are hosted on the same node (default true)</span>
<span class="c">#          --samples int                      Number of Performance samples to capture (how many times to run each test) (default 1)</span>
<span class="c">#          --setup-delay duration             Extra delay before starting the performance tests</span>
<span class="c">#          --streams uint                     The parallelism of tests with multiple streams (default 4)</span>
<span class="c">#          --test-namespace string            Namespace to perform the connectivity in (always suffixed with a sequence number to be compliant with test-concurrency param, e.g.: cilium-test-1) (default "cilium-test")</span>
<span class="c">#          --throughput                       Run throughput test (default true)</span>
<span class="c">#          --throughput-multi                 Run throughput test with multiple streams (default true)</span>
<span class="c">#          --tolerations strings              Extra NoSchedule tolerations added to test pods</span>
<span class="c">#          --udp                              Run UDP tests</span>
<span class="c">#          --unsafe-capture-kernel-profiles   Capture kernel profiles during test execution. Warning: run on disposable nodes only, as it installs additional software and modifies their configuration</span>
<span class="c">#    </span>
<span class="c">#    Global Flags:</span>
<span class="c">#          --as string                  Username to impersonate for the operation. User could be a regular user or a service account in a namespace.</span>
<span class="c">#          --as-group stringArray       Group to impersonate for the operation, this flag can be repeated to specify multiple groups.</span>
<span class="c">#          --context string             Kubernetes configuration context</span>
<span class="c">#          --helm-release-name string   Helm release name (default "cilium")</span>
<span class="c">#          --kubeconfig string          Path to the kubeconfig file</span>
<span class="c">#      -n, --namespace string           Namespace Cilium is running in (default "kube-system")</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="cilium-performance--tuning">Cilium Performance &amp; Tuning</h3>

<ul>
  <li>ë‹¤ìŒì˜ Youtube ì˜ìƒì„ ì°¸ê³ í•˜ì—¬ Ciliumì˜ ì„±ëŠ¥ê³¼ íŠœë‹ì— ëŒ€í•´ì„œ ì•Œì•„ë´…ë‹ˆë‹¤.
    <ul>
      <li>Deep Dive Into Cilium Resilient Architecture : Map Size - Jussi MÃ¤ki &amp; Martynas Pumputis, Isovalent - <a href="https://www.youtube.com/watch?v=YX0sql_3dt8">Youtube</a></li>
    </ul>
  </li>
  <li>ì–´ëŠë‚  íŒ¨í‚· Dropì´ ë°œìƒí•˜ë©° Service Backendê°€ ì•ˆ ë³´ì´ëŠ” í˜„ìƒì´ ë°œê²¬ ë˜ì—ˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_24.png" alt="img.png" class="image-center" />
<em class="image-caption">Egress Packetì´ Dropë˜ëŠ” í˜„ìƒ ë°œìƒì‹œì˜ Cilium Drop Metric</em></li>
  <li>ë˜í•œ ì¼ë¶€ Cilium-agentê°€ ìƒíƒœì €í•˜ (Degraded) ìƒíƒœê°€ ë˜ëŠ” í˜„ìƒë„ ë°œê²¬ ë˜ì—ˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_25.png" alt="img_1.png" class="image-center" />
<em class="image-caption">ìƒíƒœ ì €í•˜ëœ Cilium Agent</em></li>
  <li>BPF Map Pressure ë©”íŠ¸ë¦­ì„ í™•ì¸í•´ë³´ë‹ˆ ì›ì¸ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. BPF Map Pressureê°€ 144%ë‚˜ ëœ ê²ƒì…ë‹ˆë‹¤!
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_26.png" alt="img_2.png" /></li>
  <li>ë˜í•œ ì•„ë˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ë‹ˆ lb4_service_v2 Map ì—…ë°ì´íŠ¸ë¥¼ ë‹´ë‹¹í•˜ëŠ” ì¡°ì •ì(reconciler)ê°€ ì‹¤íŒ¨í•˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status <span class="nt">--verbose</span> 
</code></pre></div>    </div>
    <p><img src="/assets/2025/cilium/w7/20250831_cilium_w7_27.png" alt="img.png" /></p>
  </li>
  <li>Service Map ìƒíƒœì •ë³´ë¥¼ í™•ì¸í•˜ë‹ˆ <code class="language-plaintext highlighter-rouge">Error: map is full</code> ì—ëŸ¬ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í˜„ì¬ëŠ” ëª…ë ¹ ì…ë ¥ ë°©ì‹ì´ ë³€ê²½ë¨</span>
<span class="c"># $ k exec -it -n kube-system ds/cilium -- cilium statedb service4</span>
  
<span class="c"># í˜„ì¬ëŠ” ì•„ë˜ì˜ ëª…ë ¹ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤ê³  í•˜ëŠ”ë° í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg service list
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    1    10.96.88.253:443/TCP    ClusterIP      1 =&gt; 172.20.0.2:4244/TCP (active)</span>
<span class="c">#    2    10.96.205.94:80/TCP     ClusterIP      1 =&gt; 10.244.1.194:4245/TCP (active)</span>
<span class="c">#    3    0.0.0.0:30003/TCP       NodePort       1 =&gt; 10.244.1.179:8081/TCP (active)</span>
<span class="c">#    5    10.96.167.52:80/TCP     ClusterIP      1 =&gt; 10.244.1.179:8081/TCP (active)</span>
<span class="c">#    6    10.96.0.10:53/TCP       ClusterIP      1 =&gt; 10.244.1.48:53/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.244.2.250:53/TCP (active)</span>
<span class="c">#    7    10.96.0.10:53/UDP       ClusterIP      1 =&gt; 10.244.1.48:53/UDP (active)</span>
<span class="c">#                                                2 =&gt; 10.244.2.250:53/UDP (active)</span>
<span class="c">#    8    10.96.0.10:9153/TCP     ClusterIP      1 =&gt; 10.244.1.48:9153/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.244.2.250:9153/TCP (active)</span>
<span class="c">#    9    10.96.0.1:443/TCP       ClusterIP      1 =&gt; 172.20.0.2:6443/TCP (active)</span>
<span class="c">#    10   10.96.193.155:443/TCP   ClusterIP      1 =&gt; 10.244.3.24:10250/TCP (active)</span>
<span class="c">#    11   10.96.85.141:3000/TCP   ClusterIP      1 =&gt; 10.244.2.71:3000/TCP (active)</span>
<span class="c">#    12   10.96.59.105:9090/TCP   ClusterIP      1 =&gt; 10.244.1.36:9090/TCP (active)</span>
<span class="c">#    13   0.0.0.0:30001/TCP       NodePort       1 =&gt; 10.244.1.36:9090/TCP (active)</span>
<span class="c">#    15   0.0.0.0:30002/TCP       NodePort       1 =&gt; 10.244.2.71:3000/TCP (active) </span>
</code></pre></div>    </div>
    <p><img src="/assets/2025/cilium/w7/20250831_cilium_w7_28.png" alt="img.png" /></p>
  </li>
  <li>í•´ê²° ë°©ì•ˆì€ serivce mapì˜ í¬ê¸°ë¥¼ ëŠ˜ë¦¬ê±°ë‚˜ ë¬¸ì œê°€ ë˜ëŠ” ê¸°ì¡´ serviceë¥¼ ì‚­ì œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</li>
  <li>í•´ë‹¹ ì˜ìƒì—ì„œëŠ” serviceë¥¼ ì‚­ì œí•´ì„œ ë¬¸ì œë¥¼ í•´ê²° í•˜ì˜€ìŠµë‹ˆë‹¤.</li>
  <li>ì´ë ‡ë“¯ ë©”íŠ¸ë¦­ì„ ì˜ ëª¨ë‹ˆí„°ë§í•˜ê³  ìˆë‹¤ë©´ ë¬¸ì œë¥¼ ë¹ ë¥´ê²Œ ë°œê²¬í•˜ê³  í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="deep-dive-into-cilium-resilient-architecture--apievent-ì™€-cilium-agentstatedb-ì™€-bpf-ë™ì‘">Deep Dive Into Cilium Resilient Architecture : API(Event) ì™€ Cilium-Agent(StateDB) ì™€ BPF ë™ì‘</h4>

<ul>
  <li>Ciliumì˜ ì¥ì• ë‚˜ ì„±ëŠ¥ ì €í•˜ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” Ciliumì˜ ì•„í‚¤í…ì²˜ë¥¼ ì´í•´í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_29.png" alt="img.png" /></li>
  <li>Ciliumì€ ì¿ ë²„ë„¤í‹°ìŠ¤ API ì„œë²„ë¡œë¶€í„° Service Endpointì— ëŒ€í•œ ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ì„œ Cilium-Agentê°€ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê³ , ì´ë¥¼ BPFë¡œ ë°˜ì˜í•˜ëŠ” êµ¬ì¡°ë¡œ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ service mapìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ”ë° service mapì˜ í¬ê¸°ê°€ ë¶€ì¡±í•˜ë©´ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì €ì¥ì†Œ(StateDB)ì™€ BPF Mapì˜ í¬ê¸°ë¥¼ ì ì ˆíˆ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</li>
  <li><strong>StateDB</strong>ë€?
    <ul>
      <li>In-memory Transactional ë°ì´í„° ë² ì´ìŠ¤ë¡œ, ë¶ˆê°€ë³€ì˜ ë°ì´í„° êµ¬ì¡°(Immutable Data Structure)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.</li>
      <li>ì±„ë„ ê¸°ë°˜ ë³€ê²½ ì•Œë¦¼ ë©”ì»¤ë‹ˆì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.</li>
      <li>Cilium-AgentëŠ” StateDBë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿ ë²„ë„¤í‹°ìŠ¤ API ì„œë²„ë¡œ ë¶€í„° ë°›ì€ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê³ , ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_30.png" alt="img.png" class="image-center w-60" />
<em class="image-caption">StateDBì˜ ìë£Œ êµ¬ì¡°</em></li>
    </ul>
  </li>
  <li><strong>eBPF Maps</strong> ì†Œê°œ - mapDynamicSizeRatio - <a href="https://docs.cilium.io/en/stable/operations/performance/tuning/#ebpf-map-sizing">Docs</a>, <a href="https://docs.cilium.io/en/stable/network/ebpf/maps/#bpf-map-limitations">Maps-Limits</a>
    <ul>
      <li>ëª¨ë“  eBPF Mapë“¤ì€ ìµœëŒ€ í¬ê¸°ê°€ ì •í•´ì ¸ ìˆìŠµë‹ˆë‹¤. ìµœëŒ€ í¬ê¸° ì´ìƒì˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ë ¤ê³  í•˜ë©´ <code class="language-plaintext highlighter-rouge">map is full</code> ì—ëŸ¬ê°€ ë°œìƒí•˜ê±°ë‚˜ datapathì˜ ì„±ëŠ¥ ì €í•˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>Ciliumì€ ì‹œìŠ¤í…œ ì „ì²´ ë©”ëª¨ë¦¬ì˜ ì¼ì • ë¹„ìœ¨ì„ eBPF Mapì— í• ë‹¹í•©ë‹ˆë‹¤.</li>
      <li>í•˜ì§€ë§Œ Cilium agentì— ì˜í•´ ì‚¬ìš©ë˜ëŠ” ìµœëŒ€ ìš©ëŸ‰ì€ ê³ ê¸‰ ì„¤ì •ì„ í†µí•´ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/network/ebpf/maps/#bpf-map-limitations">eBPF Maps Guide</a> ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í˜„ì¬ BPF Maps í¬ê¸° í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status <span class="nt">--verbose</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    BPF Maps:   dynamic sizing: on (ratio: 0.002500)</span>
<span class="c">#      Name                          Size</span>
<span class="c">#      Auth                          524288</span>
<span class="c">#      Non-TCP connection tracking   65536</span>
<span class="c">#      TCP connection tracking       131072</span>
<span class="c">#      Endpoints                     65535</span>
<span class="c">#      IP cache                      512000</span>
<span class="c">#      IPv4 masquerading agent       16384</span>
<span class="c">#      IPv6 masquerading agent       16384</span>
<span class="c">#      IPv4 fragmentation            8192</span>
<span class="c">#      IPv4 service                  65536</span>
<span class="c">#      IPv6 service                  65536</span>
<span class="c">#      IPv4 service backend          65536</span>
<span class="c">#      IPv6 service backend          65536</span>
<span class="c">#      IPv4 service reverse NAT      65536</span>
<span class="c">#      IPv6 service reverse NAT      65536</span>
<span class="c">#      Metrics                       1024</span>
<span class="c">#      Ratelimit metrics             64</span>
<span class="c">#      NAT                           131072</span>
<span class="c">#      Neighbor table                131072</span>
<span class="c">#      Endpoint policy               16384</span>
<span class="c">#      Policy stats                  65534</span>
<span class="c">#      Session affinity              65536</span>
<span class="c">#      Sock reverse NAT              65536</span>
  
<span class="c"># BPF Maps í¬ê¸°ì˜ ë¹„ì¤‘ ì¡°ì • (0.0025 -&gt; 0.01)</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> bpf.distributedLRU.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.mapDynamicSizeRatio<span class="o">=</span>0.01

<span class="c"># Cilium DaemonSet ì¬ì‹œì‘</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium

<span class="c"># BPF Maps ì— ë§ì€ ê°’ë“¤ì´ ë…¸ë“œ ì´ ë©”ëª¨ë¦¬ ë¹„ì¤‘ë³„ë¡œ ë°˜ì˜</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status <span class="nt">--verbose</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    BPF Maps:   dynamic sizing: on (ratio: &lt;span style="color: green;"&gt;0.010000)&lt;/span&gt;</span>
<span class="c">#      Name                          Size</span>
<span class="c">#      Auth                          524288</span>
<span class="c">#      Non-TCP connection tracking   &lt;span style="color: green;"&gt;90475&lt;/span&gt;</span>
<span class="c">#      TCP connection tracking       &lt;span style="color: green;"&gt;180943&lt;/span&gt;</span>
<span class="c">#      Endpoints                     65535</span>
<span class="c">#      ...</span>
<span class="c">#      Ratelimit metrics             64</span>
<span class="c">#      NAT                           &lt;span style="color: green;"&gt;180943&lt;/span&gt;</span>
<span class="c">#      Neighbor table                &lt;span style="color: green;"&gt;180943&lt;/span&gt;</span>
<span class="c">#      Endpoint policy               16384</span>
<span class="c">#      Policy stats                  65534</span>
<span class="c">#      Session affinity              65536</span>
<span class="c">#      Sock reverse NAT              &lt;span style="color: green;"&gt;90475&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="kubernetes-api-server-improvements--v118-ë¶€í„°-cilium_client-ê°€-k8s-api-ì„œë²„-ë¶€í•˜ë¶„ì‚°ha-ì—°ê²°-ê°€ëŠ¥---blog">Kubernetes API server improvements : v1.18 ë¶€í„° Cilium_client ê°€ K8S API ì„œë²„ ë¶€í•˜ë¶„ì‚°/HA ì—°ê²° ê°€ëŠ¥ - <a href="https://isovalent.com/blog/post/cilium-1-18/#operations">Blog</a></h5>

<ul>
  <li>Cilium v1.18 ë¶€í„°ëŠ” Cilium-agentê°€ ì¿ ë²„ë„¤í‹°ìŠ¤ API ì„œë²„ì— HAë¡œ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (<code class="language-plaintext highlighter-rouge">--set k8s.apiServerURLs="https://172.21.0.4:6443 https://172.21.0.5:6443 https://172.21.0.6:6443"</code> ë¥¼ í†µí•´ ì§€ì •ê°€ëŠ¥í•©ë‹ˆë‹¤.)</li>
  <li>v1.18 ì´ì „ì—ëŠ” ë‹¨ì¼ API ì„œë²„ì—ë§Œ ì—°ê²°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
  <li>Ciliumì€ ë™ì‘ ì¤‘ì¸ API ì„œë²„ì˜ ëª©ë¡ì„ ì´ˆê¸°í™” ì‹œì ì— ê°€ì ¸ì˜¤ê³ , ì´í›„ì—ëŠ” ì£¼ê¸°ì ìœ¼ë¡œ API ì„œë²„ì˜ ìƒíƒœë¥¼ í™•ì¸í•˜ì—¬, Heartbeatë¥¼ í†µí•´ ì—°ê²° ìƒíƒœë¥¼ ì²´í¬í•˜ê³ , ì²´í¬ê°€ ì‹¤íŒ¨í•  ê²½ìš° ë‹¤ë¥¸ API ì„œë²„ë¡œ ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.</li>
  <li>ì¼ë¶€ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” Kubernetes API ì„œë²„ì—ì„œ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ë©´ ê³¼ë¶€í•˜ê°€ ê±¸ë¦¬ê±°ë‚˜ API ì„œë²„ì˜ ê°€ìš©ì„±ì— í•´ë¡œìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤(íŠ¹íˆ LIST ìš”ì²­).</li>
  <li>API ì„œë²„ì— ìš”ì²­ ì‹œ exponential back-off ì„¤ì • ê°€ëŠ¥.
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">k8sClientExponentialBackoff</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">backoffBaseSeconds</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">backoffMaxDurationSeconds</span><span class="pi">:</span> <span class="m">120</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="kubernetes-perf-tests">Kubernetes perf-tests</h3>

<ul>
  <li>ì´ë²ˆì—ëŠ” perf-testsë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì˜ ì„±ëŠ¥ì„ ì¸¡ì •í•´ë´…ë‹ˆë‹¤.</li>
  <li>Kube-burnerì™€ ê±°ì˜ ë¹„ìŠ·í•©ë‹ˆë‹¤. ì°¨ì´ì ì€ perf-testsëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ê³µì‹ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë„êµ¬ë¼ëŠ” ê²ƒì…ë‹ˆë‹¤. <a href="https://github.com/kubernetes/perf-tests">GitHub</a></li>
  <li>perf-testsì—ëŠ” CL2, DNS ë“± ë‹¤ì–‘í•œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>ClusterLoader2</strong> (CL2) : Kubernetes ë¶€í•˜ í…ŒìŠ¤íŠ¸ ë„êµ¬ì´ì ê³µì‹ K8s í™•ì¥ì„± ë° ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤. - <a href="https://github.com/kubernetes/perf-tests/tree/master/clusterloader2">Link</a>
    <ul>
      <li>í…ŒìŠ¤íŠ¸ëŠ” í´ëŸ¬ìŠ¤í„°ì˜ ì›í•˜ëŠ” ìƒíƒœ ì§‘í•©(ì˜ˆ: 10,000ê°œì˜ í¬ë“œ, 2,000ê°œì˜ í´ëŸ¬ìŠ¤í„° IP ì„œë¹„ìŠ¤ ë˜ëŠ” 5ê°œì˜ ë°ëª¬ ì„¸íŠ¸ë¥¼ ì‹¤í–‰)ì„ ì •ì˜í•˜ê³  ê° ìƒíƒœì— ë„ë‹¬í•˜ëŠ” ì†ë„(í¬ë“œ ì²˜ë¦¬ëŸ‰)ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</li>
      <li>CL2ëŠ” ë˜í•œ ì¸¡ì •í•  ì„±ëŠ¥ íŠ¹ì„±ì„ ì •ì˜í•©ë‹ˆë‹¤. ( ìì„¸í•œ ë‚´ìš©ì€Â <a href="https://github.com/kubernetes/perf-tests/tree/master/clusterloader2#Measurement">ì¸¡ì • ëª©ë¡</a>Â ì°¸ì¡° ).</li>
      <li>CL2ëŠ”Â <a href="https://github.com/kubernetes/perf-tests/tree/master/clusterloader2#prometheus-metrics">Prometheusë¥¼</a>Â ì‚¬ìš©í•œ í…ŒìŠ¤íŠ¸ ì¤‘ì— í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ì¶”ê°€ì ì¸ ê´€ì¸¡ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
      <li>
        <p>ì‚¬ìš© ê°€ëŠ¥í•œ ì¸¡ì •ê°’</p>

        <table>
          <thead>
            <tr>
              <th>ì¸¡ì • í•­ëª©</th>
              <th>ì„¤ëª…</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>APIAvailabilityMeasurement</td>
              <td><code class="language-plaintext highlighter-rouge">/readyz</code> API í˜¸ì¶œë¡œ í´ëŸ¬ìŠ¤í„°/í˜¸ìŠ¤íŠ¸ ê°€ìš©ì„± ì¸¡ì •, exec ì„œë¹„ìŠ¤ í•„ìš”</td>
            </tr>
            <tr>
              <td>APIResponsivenessPrometheusSimple</td>
              <td>Prometheus ê¸°ë°˜, API í˜¸ì¶œ ì§€ì—°/íšŸìˆ˜ ë°±ë¶„ìœ„ìˆ˜, SLO ì¶©ì¡± ì—¬ë¶€ í™•ì¸, Prometheus ì—†ìœ¼ë©´ ìƒëµ</td>
            </tr>
            <tr>
              <td>APIResponsivenessPrometheus</td>
              <td>Prometheus ê¸°ë°˜, API í˜¸ì¶œ ì§€ì—°/ê°œìˆ˜ ìš”ì•½, SLO ì¶©ì¡± ì—¬ë¶€ í™•ì¸, Prometheus ì—†ìœ¼ë©´ ìƒëµ</td>
            </tr>
            <tr>
              <td>CPUProfile</td>
              <td>pprofë¡œ íŠ¹ì • ì»´í¬ë„ŒíŠ¸ì˜ CPU ì‚¬ìš© í”„ë¡œí•„ ìˆ˜ì§‘</td>
            </tr>
            <tr>
              <td>EtcdMetrics</td>
              <td>etcd ë©”íŠ¸ë¦­ ë° DB í¬ê¸° ìˆ˜ì§‘</td>
            </tr>
            <tr>
              <td>MemoryProfile</td>
              <td>pprofë¡œ íŠ¹ì • ì»´í¬ë„ŒíŠ¸ì˜ ë©”ëª¨ë¦¬ í”„ë¡œí•„ ìˆ˜ì§‘</td>
            </tr>
            <tr>
              <td>MetricsForE2E</td>
              <td>kube-apiserver, ì»¨íŠ¸ë¡¤ëŸ¬, ìŠ¤ì¼€ì¤„ëŸ¬, kubelet ë©”íŠ¸ë¦­ ìˆ˜ì§‘</td>
            </tr>
            <tr>
              <td>PodPeriodicCommand</td>
              <td>ì§€ì • í¬ë“œì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ ëª…ë ¹ ì‹¤í–‰, ì¶œë ¥ ìˆ˜ì§‘</td>
            </tr>
            <tr>
              <td>PodStartupLatency</td>
              <td>Pod ì‹œì‘ SLO ì¶©ì¡± ì—¬ë¶€ í™•ì¸</td>
            </tr>
            <tr>
              <td>ResourceUsageSummary</td>
              <td>ì»´í¬ë„ŒíŠ¸ë³„ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ìš”ì•½, ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì‹œ ì˜¤ë¥˜</td>
            </tr>
            <tr>
              <td>SchedulingMetrics</td>
              <td>ìŠ¤ì¼€ì¤„ëŸ¬ ë©”íŠ¸ë¦­ ì„¸íŠ¸ ìˆ˜ì§‘</td>
            </tr>
            <tr>
              <td>SchedulingThroughput</td>
              <td>ìŠ¤ì¼€ì¤„ë§ ì²˜ë¦¬ëŸ‰ ìˆ˜ì§‘</td>
            </tr>
            <tr>
              <td>Timer</td>
              <td>í…ŒìŠ¤íŠ¸ íŠ¹ì • ë¶€ë¶„ ëŒ€ê¸° ì‹œê°„ ì¸¡ì •</td>
            </tr>
            <tr>
              <td>WaitForControlledPodsRunning</td>
              <td>ì œì–´ ê°ì²´ì˜ ëª¨ë“  í¬ë“œ ì‹¤í–‰ê¹Œì§€ ëŒ€ê¸°, ì‹œê°„ ì´ˆê³¼ ì‹œ ì˜¤ë¥˜ ê¸°ë¡</td>
            </tr>
            <tr>
              <td>WaitForRunningPods</td>
              <td>í•„ìš”í•œ ìˆ˜ì˜ Pod ì‹¤í–‰ê¹Œì§€ ëŒ€ê¸°, ì‹œê°„ ì´ˆê³¼ ì‹œ ì˜¤ë¥˜ ê¸°ë¡</td>
            </tr>
            <tr>
              <td>Sleep</td>
              <td>ì§€ì • ì‹œê°„ë§Œí¼ ëŒ€ê¸°</td>
            </tr>
            <tr>
              <td>WaitForGenericK8sObjects</td>
              <td>K8s ê°ì²´ê°€ ì¡°ê±´ ì¶©ì¡±í•  ë•Œê¹Œì§€ ëŒ€ê¸°, ì‹œê°„ ì´ˆê³¼ ì‹œ ì˜¤ë¥˜ ê¸°ë¡</td>
            </tr>
          </tbody>
        </table>
      </li>
      <li>kind ì—ì„œ 1ëŒ€ ë…¸ë“œì—ì„œ ê°„ë‹¨ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ ì†Œê°œ - <a href="https://github.com/kubernetes/perf-tests/blob/master/clusterloader2/docs/GETTING_STARTED.md">Guide</a></li>
      <li>100ë…¸ë“œ ê·œëª¨ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ - <a href="https://github.com/kubernetes/perf-tests/blob/master/clusterloader2/docs/GETTING_STARTED.md">Guide</a> , <a href="https://github.com/kubernetes/perf-tests/tree/master/clusterloader2/testing/load">LoadCode</a>
        <ul>
          <li>í…ŒìŠ¤íŠ¸ ë‹¨ê³„ : ê°ì²´ ìƒì„± â†’ ì›ë˜ í¬ê¸°ì˜ 50%, 150% ì‚¬ì´ë¡œ ê°œì²´ í¬ê¸° ì¡°ì • â†’ ê°ì²´ ì‚­ì œ</li>
          <li><strong>100ê°œ ë…¸ë“œ</strong>ë¶€í„° <strong>ìµœëŒ€ 5,000ê°œ ë…¸ë“œ</strong>ê¹Œì§€ <strong>í´ëŸ¬ìŠ¤í„°ë¥¼ í…ŒìŠ¤íŠ¸</strong>í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ë¶€í•˜ í…ŒìŠ¤íŠ¸ëŠ” ì•½ <strong>30ê°œì˜ ë…¸ë“œë¡œ êµ¬ì„±ëœ í¬ë“œ ê°ì²´ë¥¼ ìƒì„±í•©</strong>ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ê°ì²´ê°€ ìƒì„±ë©ë‹ˆë‹¤.
            <ul>
              <li>deployments</li>
              <li>jobs</li>
              <li>statefulsets</li>
              <li>services</li>
              <li>secrets</li>
              <li>configmaps</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>í”„ë¡œë©”í…Œìš°ìŠ¤ ì¸¡ì • ê¸°ì¤€ì— ë”°ë¼ ë‹¤ì–‘í•œ ì¸¡ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´,
        <ul>
          <li>API ì‘ë‹µì„± - kube-apiserverì— ëŒ€í•œ ìš”ì²­ ì§€ì—° ì‹œê°„ì„ ì¸¡ì •í•©ë‹ˆë‹¤.</li>
          <li>ìŠ¤ì¼€ì¤„ë§ ì²˜ë¦¬ëŸ‰</li>
          <li>NodeLocalDNS ëŒ€ê¸° ì‹œê°„</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>DNS (CoreDNS, nodeLocal DNSCache)</strong> : DNS ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ - <a href="https://github.com/kubernetes/perf-tests/tree/master/dns">Link</a>
    <ul>
      <li>ë‹¨ì¼ DNS ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ì˜ ì„±ëŠ¥ì„ ì§€ì •ëœ ì¿¼ë¦¬ ì›Œí¬ë¡œë“œë¡œ ë²¤ì¹˜ë§ˆí‚¹í•©ë‹ˆë‹¤.</li>
      <li>Benchmarking the cluster DNS : coredns ì„±ëŠ¥ ì¸¡ì • - <a href="https://perf-dash.k8s.io/#/?jobname=kube-dns%20benchmark&amp;metriccategoryname=dns&amp;metricname=Latency&amp;query_file=all-queries.txt&amp;run_length_seconds=600">ê²°ê³¼</a></li>
      <li>Comparing cluster DNS and NodeLocal DNSCache : NodeLocal DNSCache í™œì„±í™” ì‹œ ì„±ëŠ¥ ë¹„êµ - <a href="https://perf-dash.k8s.io/#/?jobname=node-local-dns%20benchmark&amp;metriccategoryname=dns&amp;metricname=Latency&amp;query_file=all-queries.txt&amp;run_length_seconds=600">ê²°ê³¼</a></li>
      <li>CoreDNS and kube-dns v1.5+ (imageÂ <code class="language-plaintext highlighter-rouge">registry.k8s.io/kubedns-amd64:1.9</code>) can exportÂ <a href="http://prometheus.io/">Prometheus</a>Â metrics.</li>
    </ul>
  </li>
  <li><strong>Benchmarking Kubernetes Networking Performance</strong> : Kubernetes ë„¤íŠ¸ì›Œí‚¹ ì„±ëŠ¥ì„ ì¸¡ì •í•˜ëŠ” í‘œì¤€í™”ëœ ë²¤ì¹˜ë§ˆí¬ - <a href="https://github.com/kubernetes/perf-tests/tree/master/network/benchmarks/netperf">Link</a>
    <ul>
      <li>ë²¤ì¹˜ë§ˆí¬ëŠ” ë‹¨ì¼ Go ë°”ì´ë„ˆë¦¬ í˜¸ì¶œì„ í†µí•´ ì‹¤í–‰í•  ìˆ˜ ìˆìœ¼ë©°, ì•„ë˜ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ë° ì›Œì»¤ í¬ë“œì— ìˆëŠ” ëª¨ë“  ìë™í™” í…ŒìŠ¤íŠ¸ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.</li>
      <li>í…ŒìŠ¤íŠ¸ëŠ” go ë°”ì´ë„ˆë¦¬ì™€ iperf3 ë° ê¸°íƒ€ ë„êµ¬ê°€ ë‚´ì¥ëœ ì‚¬ìš©ì ì§€ì • ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
      <li>ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° í¬ë“œëŠ” ì•„ë˜ ì„¤ëª…ëœ 5ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•´ MTU(TCPì˜ ê²½ìš° MSS íŠœë‹, UDPì˜ ê²½ìš° ì§ì ‘ íŒ¨í‚· í¬ê¸° íŠœë‹)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ë ¬ ìˆœì„œë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë„ë¡ ì›Œì»¤ í¬ë“œë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.</li>
      <li>ë…¸ë“œ ë ˆì´ë¸”ì„ ì‚¬ìš©í•˜ì—¬ ì›Œì»¤ í¬ë“œ 1ê³¼ 2ëŠ” ë™ì¼í•œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë…¸ë“œì— ë°°ì¹˜ë˜ê³ , ì›Œì»¤ í¬ë“œ 3ì€ ë‹¤ë¥¸ ë…¸ë“œì— ë°°ì¹˜ë©ë‹ˆë‹¤.</li>
      <li>ëª¨ë“  ë…¸ë“œëŠ” ê°„ë‹¨í•œ golang rpcsë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° í¬ë“œ ì„œë¹„ìŠ¤ì™€ í†µì‹ í•˜ê³  ì‘ì—… í•­ëª©ì„ ìš”ì²­í•©ë‹ˆë‹¤.</li>
      <li>ì´ í…ŒìŠ¤íŠ¸ì—ëŠ” ìµœì†Œ ë‘ ê°œì˜ ì¿ ë²„ë„¤í‹°ìŠ¤ ì›Œì»¤ ë…¸ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
      <li>ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ì™€ ì›Œì»¤ íŒŒë“œëŠ” ì´ë‹ˆì‹œì—ì´í„° ìŠ¤í¬ë¦½íŠ¸ì™€ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©°, ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° íŒŒë“œëŠ” í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¼ì •ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì›Œì»¤ë“¤ì—ê²Œ ì‘ì—… í•­ëª©ì„ ì „ì†¡í•©ë‹ˆë‹¤.</li>
      <li>ëª¨ë“  ì›Œì»¤ ë…¸ë“œì˜ <strong>iperf</strong> ì¶œë ¥(TCP ë° UDP ëª¨ë“œ ëª¨ë‘)ê³¼ <strong>netperf TCP</strong> ì¶œë ¥ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° íŒŒë“œì— ì—…ë¡œë“œë˜ì–´ í•„í„°ë§ë˜ê³  ê·¸ ê²°ê³¼ëŠ” netperf.csvì— ê¸°ë¡ë©ë‹ˆë‹¤.</li>
      <li>ê·¸ëŸ° ë‹¤ìŒ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ëŠ” netperf.csv íŒŒì¼ì„ ì¶”ì¶œí•˜ì—¬ ë¡œì»¬ ë””ìŠ¤í¬ì— ê¸°ë¡í•©ë‹ˆë‹¤. csv íŒŒì¼ì˜ ëª¨ë“  ë‹¨ìœ„ëŠ” Mbit/ì´ˆì…ë‹ˆë‹¤.</li>
      <li>ëª¨ë“  ì¿ ë²„ë„¤í‹°ìŠ¤ ì—”í‹°í‹°ëŠ” â€œnetperfâ€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•„ë˜ì— ìƒì„±ë©ë‹ˆë‹¤.</li>
      <li>
        <p>CSV ë°ì´í„° ì¶œë ¥</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  MSS                                          , Maximum, 96, 352, 608, 864, 1120, 1376,
  1 iperf TCP. Same VM using Pod IP            ,35507.000000,33835,33430,35372,35220,35373,35507,
  2 iperf TCP. Same VM using Virtual IP        ,32997.000000,32689,32997,32256,31995,31904,31830,
  3 iperf TCP. Remote VM using Pod IP          ,10652.000000,8793,9836,10602,9959,9941,10652,
  4 iperf TCP. Remote VM using Virtual IP      ,11046.000000,10429,11046,10064,10622,10528,10246,
  5 iperf TCP. Hairpin Pod to own Virtual IP   ,32400.000000,31473,30253,32075,32058,32400,31734,
  6 iperf UDP. Same VM using Pod IP            ,10642.000000,10642,
  7 iperf UDP. Same VM using Virtual IP        ,8983.000000,8983,
  8 iperf UDP. Remote VM using Pod IP          ,11143.000000,11143,
  9 iperf UDP. Remote VM using Virtual IP      ,10836.000000,10836,
  10 netperf. Same VM using Pod IP             ,11675.380000,11675.38,
  11 netperf. Same VM using Virtual IP         ,0.000000,0.00,
  12 netperf. Remote VM using Pod IP           ,6646.820000,6646.82,
  13 netperf. Remote VM using Virtual IP       ,0.000000,0.00,
</code></pre></div>        </div>
      </li>
      <li>CSV ë°ì´í„° ê·¸ë˜í”„í™”
        <ul>
          <li><strong>matplotlib</strong>ì„ ì‚¬ìš©í•˜ì—¬ csv ë°ì´í„°(ë° í˜¸í™˜ì„±ì„ ìœ„í•´ PNG ë° JPG íŒŒì¼)ì—ì„œ ê·¸ë˜í”„ SVG íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
            <ul>
              <li>íŒŒì´ì¬ Matplotlib ë¼ì¸ ì°¨íŠ¸</li>
              <li>ë§‰ëŒ€ ì°¨íŠ¸</li>
            </ul>
          </li>
          <li>MSSë¥¼ ë¬´ì‹œí•˜ê³  ìµœëŒ€ ëŒ€ì—­í­ ìˆ˜ì¹˜ë¥¼ ì‚¬ìš©í•˜ë©´ ë§‰ëŒ€í˜• ì°¨íŠ¸ê°€ ì„±ëŠ¥ì„ ë¹„êµí•˜ëŠ” ë° ë” ë‚˜ì€ ë„êµ¬ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>CSV ë°ì´í„°ë¥¼ <strong>Google ì‹œíŠ¸</strong>ë¡œ ê°€ì ¸ì™€ì„œ <strong>ê·¸ë˜í”„</strong>ë¡œ í‘œí˜„í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Network policy enforcement latency</strong> : Pod ë° ë„¤íŠ¸ì›Œí¬ ì •ì±… ë³€ê²½ì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ì •ì±… ì ìš© ì§€ì—° ì‹œê°„ì„ ì¸¡ì • - <a href="https://github.com/kubernetes/perf-tests/tree/master/network/tools/network-policy-enforcement-latency">Link</a></li>
  <li><strong>Kubernetes Perfdash</strong> : ì„±ëŠ¥ ì§€í‘œë¥¼ ìˆ˜ì§‘í•˜ê³  í‘œì‹œí•˜ëŠ” ì›¹ UI - <a href="https://github.com/kubernetes/perf-tests/tree/master/perfdash">Link</a> , <a href="https://perf-dash.k8s.io/#/?jobname=aws-100Nodes&amp;metriccategoryname=APIServer&amp;metricname=LoadInitEventsCount&amp;resource=configmaps&amp;group=">Demo</a>
    <ul>
      <li>ì„±ëŠ¥ ì§€í‘œëŠ” ë‹¤ì–‘í•œ ë…¸ë“œ ìˆ˜, í”Œë«í¼ ìœ í˜• ë° í”Œë«í¼ ë²„ì „ì— ëŒ€í•œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</li>
      <li>ì§€ì›ë˜ëŠ” ë©”íŠ¸ë¦­
        <ul>
          <li>Responsiveness</li>
          <li>Resources</li>
          <li>PodStartup</li>
          <li>TestPhaseTimer</li>
          <li>RequestCount</li>
          <li>RequestCountByClient</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Kubernetes Performance SLO monitor</strong> : api ì„œë²„ë¡œ ìˆ˜ì§‘í•  ìˆ˜ ì—†ëŠ” ì„±ëŠ¥ SLO()sÂ ë¥¼ ëª¨ë‹ˆí„°ë§ ë° ë©”íŠ¸ë¦­ ë…¸ì¶œ - <a href="https://github.com/kubernetes/perf-tests/tree/master/slo-monitor">Link</a>
    <ul>
      <li>SLO ëª¨ë‹ˆí„°ëŠ” ê°„ë‹¨í•œ Podë¡œ, Podë“¤ ë° ì´ë²¤íŠ¸ë¥¼ ì½ì„ ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>SLO ëª¨ë‹ˆí„°ëŠ” ë‹¤ìŒê³¼ ê°™ì€ SLOë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.
        <ul>
          <li>Pod startup latency</li>
          <li>Pod scheduling latency</li>
          <li>API server availability</li>
          <li>Event processing latency</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>:bulb: <strong>SLO(ì„œë¹„ìŠ¤ ìˆ˜ì¤€ ëª©í‘œ, Service Level Objectives)</strong>ëŠ” ê³ ê°ì—ê°€ ê°€ìš©ì„±ì„ ë³´ì¥í•˜ëŠ” SLAë¥¼ ë§Œì¡±í•˜ê¸° ìœ„í•´ ë‚´ë¶€ì ìœ¼ë¡œ ì„¤ì •í•˜ëŠ” ëª©í‘œì¹˜ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
</blockquote>

<h3 id="cilium-tuning-guide">Cilium Tuning Guide</h3>

<h5 id="cilium-endpoint-slices-ces-beta---youtube">Cilium Endpoint Slices (CES) beta - <a href="https://www.youtube.com/watch?v=yKPNmhckJHY">Youtube</a></h5>

<ul>
  <li>Ciliumì´ Endpointê°€ ë§ì€ ê²½ìš° watch updateë¥¼ í•˜ë©´ ì—„ì²­ë‚˜ê²Œ ë§ì€ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ ì €í•˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>CESëŠ” K8Sì˜ EndpointSlice ì²˜ëŸ¼ Endpointë“¤ì„ Slice ë‹¨ìœ„ë¡œ ë¬¶ì–´ì„œ ê´€ë¦¬í•˜ì—¬, Slice ë‹¨ìœ„ë¡œ watch updateë¥¼ í•  ìˆ˜ ìˆë„ë¡ í•˜ì—¬ ì„±ëŠ¥ì„ ê°œì„ í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2025/cilium/w7/20250831_cilium_w7_31.png" alt="img.png" class="image-center" />
<em class="image-caption">ì´ì „ ë°©ì‹ê³¼ Cilium Endpoint Slice ë„ì… í›„ ë¹„êµ</em></p>

<ul>
  <li>ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ ì´ì „ì—ëŠ” ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ê°€ í•œêº¼ë²ˆì— ê´€ë¦¬ë˜ê³  ì—…ë°ì´íŠ¸ ë˜ì—ˆì§€ë§Œ, CESë¥¼ ì‚¬ìš©í•˜ë©´ ì—”ë“œí¬ì¸íŠ¸ê°€ ì—¬ëŸ¬ ìŠ¬ë¼ì´ìŠ¤ë¡œ ë‚˜ëˆ„ì–´ì ¸ ê° ìŠ¬ë¼ì´ìŠ¤ê°€ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬ë˜ê³  ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</li>
  <li><strong>ì‚¬ì „ì¡°ê±´</strong>
    <ul>
      <li>CEPê°€ í™œì„±í™” ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. (<code class="language-plaintext highlighter-rouge">-disable-endpoint-crd</code>ê°€ <code class="language-plaintext highlighter-rouge">true</code>ê°€ ì•„ë‹ˆì–´ì•¼ í•©ë‹ˆë‹¤.)</li>
      <li>Egress GatewayëŠ” CESì™€ í˜¸í™˜ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì‚¬ìš©ë˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li><strong>CES ì„¤ì •</strong></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># CiliumEndpoint (CEP) per pod : All agents watch for all CEPs, Maps IP to Identity for policy.</span>
<span class="nv">$ </span>kubectl get ciliumendpoints.cilium.io <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    cilium-monitoring    grafana-5c69859d9-x2r9v                   48524               ready            10.244.2.71</span>
<span class="c">#    cilium-monitoring    prometheus-6fc896bc5d-zwlkf               46171               ready            10.244.1.36</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-dt7dv                  32751               ready            10.244.2.250</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-khb4w                  32751               ready            10.244.1.48</span>
<span class="c">#    kube-system          hubble-relay-fdd49b976-8mcq9              32342               ready            10.244.1.194</span>
<span class="c">#    kube-system          hubble-ui-655f947f96-ccbxk                7784                ready            10.244.1.179</span>
<span class="c">#    kube-system          metrics-server-5dd7b49d79-gx8jd           24994               ready            10.244.3.24</span>
<span class="c">#    local-path-storage   local-path-provisioner-7dc846544d-phnjz   31623               ready            10.244.2.23</span>
<span class="nv">$ </span>kubectl get ciliumendpoints.cilium.io <span class="nt">-A</span> | <span class="nb">wc</span> <span class="nt">-l</span>
<span class="c"># =&gt;        9</span>
<span class="nv">$ </span>kubectl get crd
<span class="c"># =&gt; ciliumcidrgroups.cilium.io                   2025-08-30T08:12:26Z</span>
<span class="c">#    ciliumclusterwidenetworkpolicies.cilium.io   2025-08-30T08:12:25Z</span>
<span class="c">#    ciliumendpoints.cilium.io                    2025-08-30T08:12:22Z</span>
<span class="c">#    ciliumidentities.cilium.io                   2025-08-30T08:12:20Z</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> ciliumEndpointSlice.enabled<span class="o">=</span><span class="nb">true</span>

<span class="nv">$ </span>kubectl rollout restart <span class="nt">-n</span> kube-system deployment cilium-operator
<span class="c"># =&gt; deployment.apps/cilium-operator restarted</span>
<span class="nv">$ </span>kubectl rollout restart <span class="nt">-n</span> kube-system ds/cilium 
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># Bactches CEPs into CiliumEndpointSlice CRDs : Significantly fewer watch events.</span>
<span class="nv">$ </span>kubectl get crd
<span class="c"># =&gt; NAME                                         CREATED AT</span>
<span class="c">#    ciliumcidrgroups.cilium.io                   2025-08-30T08:12:26Z</span>
<span class="c">#    ciliumclusterwidenetworkpolicies.cilium.io   2025-08-30T08:12:25Z</span>
<span class="c">#    ciliumendpoints.cilium.io                    2025-08-30T08:12:22Z</span>
<span class="c">#    &lt;span style="color: green;"&gt;ciliumendpointslices.cilium.io               2025-08-30T15:03:31Z&lt;/span&gt; # ì¶”ê°€ë¨</span>
<span class="c">#    ciliumidentities.cilium.io                   2025-08-30T08:12:20Z</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get ciliumendpointslices.cilium.io <span class="nt">-A</span> | <span class="nb">wc</span> <span class="nt">-l</span>
<span class="c"># =&gt; 4</span>
<span class="nv">$ </span>kubectl get ciliumendpointslices.cilium.io <span class="nt">-A</span>
<span class="c"># =&gt; NAME                  AGE</span>
<span class="c">#    ces-5vfjvlfnz-kt5mm   70s</span>
<span class="c">#    ces-ltcdg4zdx-zmfrl   70s</span>
<span class="c">#    ces-nzbjpdccd-bryjt   70s</span>
</code></pre></div></div>

<ul>
  <li>ì ìš© í›„ íš¨ê³¼ : 1000ê°œ ë…¸ë“œ ë“±ì´ ìˆì„ë•Œ API Latencyê°€ 87% ê°ì†Œí•˜ì˜€ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2025/cilium/w7/20250831_cilium_w7_32.png" alt="img.png" /></p>

<h5 id="ebpf-host-routing--netkit---youtube--youtube2">eBPF Host Routing , Netkit - <a href="https://www.youtube.com/watch?v=yKPNmhckJHY">Youtube</a> , <a href="https://www.youtube.com/watch?v=cKPW67D7X10">Youtube</a>2</h5>

<ul>
  <li>ê¸°ì¡´ì— ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì´ íŒŒë“œì˜ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì´ë™í•  ë•Œ IP, netfilter, routing ë“±ì˜ IP ìŠ¤íƒì„ ê±¸ì³ì„œ veth í˜ì–´ë¥¼ í†µí•´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ingressì™€ egress íì— íŒ¨í‚·ì´ ëŒ€ê¸°í•˜ê²Œ ë˜ì–´ ì§€ì—°ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>eBPF Host Routing</strong> : bpf_redirect_peer í•¨ìˆ˜ë¥¼ í†µí•´ í˜¸ìŠ¤íŠ¸ NET NS ë„ì°© ì‹œ â†’ ë°”ë¡œ íŒŒë“œì˜ NET NS ë¡œ ì „ë‹¬í•˜ì—¬ ë¶ˆí•„ìš”í•œ IP ìŠ¤íƒì„ ê±°ì¹˜ì§€ ì•Šë„ë¡ í•˜ê³  ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤. ë˜í•œ CPU íì‰ ê³¼ì •ì„ ê±°ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_33.png" alt="img.png" class="image-center" />
<em class="image-caption">ê¸°ì¡´ íŒŒë“œ ë„¤íŠ¸ì›Œí¬ vs veth + BPF host routing vs host (base)</em>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status | <span class="nb">grep </span>Routing
<span class="c"># =&gt; KubeProxyReplacement:    True   [eth0    172.20.0.2 fc00:f853:ccd:e793::2 fe80::42:acff:fe14:2 (Direct Routing)]</span>
<span class="c">#    Routing:                 Network: Native   Host: BPF</span>
</code></pre></div>    </div>
    <ul>
      <li>eBPF Host Routing ë§Œìœ¼ë¡œëŠ” egressì‹œ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ ê±°ì¹˜ê¸° ë•Œë¬¸ì— ì™„ì „í•œ ì„±ëŠ¥ í–¥ìƒì„ ê¸°ëŒ€í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì•„ë˜ì˜ Netkit ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ ë” ì¢‹ì€ ì„±ëŠ¥ì„ ê¸°ëŒ€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li><strong>Netkit devices</strong> : veth ì™€ ìœ ì‚¬(ìŒ), ingress + egress í(CPU) ëŒ€ê¸° ì—†ì´ ëª¨ë‘ ë¹ ë¥´ê²Œ ì „ë‹¬ ê°€ëŠ¥.
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_34.png" alt="img.png" class="image-center" />
<em class="image-caption">eBPF Host Routingì— Netkitê¹Œì§€ ì‚¬ìš©í•˜ë©´ hostì™€ ê±°ì˜ ë™ì¼í•œ ì„±ëŠ¥ì„ ë°œíœ˜</em>
    <ul>
      <li>netkit ì„¤ì • ì‹œë„ : ì»¤ë„ 6.8 ì´ìƒ , eBPF host-routingì´ í•„ìš”í•©ë‹ˆë‹¤.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c">#</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane <span class="nb">uname</span> <span class="nt">-r</span>
  <span class="c"># =&gt; 6.10.14-linuxkit</span>
      
  <span class="c">#</span>
  <span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
    <span class="nt">--set</span> bpf.datapathMode<span class="o">=</span>netkit
      
  <span class="nv">$ </span>kubectl rollout restart <span class="nt">-n</span> kube-system deployment cilium-operator
  <span class="nv">$ </span>kubectl rollout restart <span class="nt">-n</span> kube-system ds/cilium 
      
  <span class="c">#</span>
  <span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system cilium-k84hl
  <span class="c"># =&gt; time=2025-08-24T09:33:36.486143842Z level=fatal source=/go/src/github.com/cilium/cilium/pkg/logging/slog.go:159 </span>
  <span class="c">#    .. msg="netkit devices need kernel 6.7.0 or newer and CONFIG_NETKIT"</span>
      
  <span class="c">#</span>
  <span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
    <span class="nt">--set</span> bpf.datapathMode<span class="o">=</span>veth
      
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status | <span class="nb">grep</span> <span class="s1">'Device Mode'</span>
  <span class="c"># =&gt; Device Mode:             veth      </span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="kubeshark">Kubeshark</h3>

<ul>
  <li>Kubernetes ë‚´ë¶€/ì™¸ë¶€ì˜ API í˜¸ì¶œ, ì´ë™ì¤‘ì¸ ë°ì´í„° ë“± ëª¨ë“  í†µì‹ ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ë¶„ì„í•  ìˆ˜ ìˆëŠ” ë„êµ¬ì…ë‹ˆë‹¤. - <a href="https://www.kubeshark.co/">Home</a>, <a href="https://docs.kubeshark.co/en/introduction">Docs</a>, <a href="https://www.kubeshark.co/blog">Blog</a>, <a href="https://demo.kubeshark.co/">demo</a>
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_35.png" alt="img.png" />
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_36.png" alt="img_1.png" /></li>
  <li>ì„¤ì¹˜ - <a href="https://docs.kubeshark.co/en/install">Docs</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># mac</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubeshark
<span class="c"># =&gt; ==&gt; Fetching downloads for: kubeshark</span>
<span class="c">#    ==&gt; Downloading https://ghcr.io/v2/homebrew/core/kubeshark/manifests/52.8.1</span>
<span class="c">#    ############################################################################################################################################################################ 100.0%</span>
<span class="c">#    ==&gt; Fetching kubeshark</span>
<span class="c">#    ==&gt; Downloading https://ghcr.io/v2/homebrew/core/kubeshark/blobs/sha256:d65e38045ff18f7fc6fc83df77cc9da945ec7e99033d43f91994f0768c2c2e99</span>
<span class="c">#    ############################################################################################################################################################################ 100.0%</span>
<span class="c">#    ==&gt; Pouring kubeshark--52.8.1.arm64_sequoia.bottle.tar.gz</span>
<span class="c">#    ğŸº  /opt/homebrew/Cellar/kubeshark/52.8.1: 9 files, 65MB</span>
<span class="c">#    ==&gt; Running `brew cleanup kubeshark`...</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubeshark version
<span class="c"># =&gt; v52.8.1</span>

<span class="nv">$ </span>kubeshark <span class="nt">-h</span>
<span class="c"># =&gt; Available Commands:</span>
<span class="c">#      clean       Removes all Kubeshark resources</span>
<span class="c">#      completion  Generate the autocompletion script for the specified shell</span>
<span class="c">#      config      Generate Kubeshark config with default values</span>
<span class="c">#      console     Stream the scripting console logs into shell</span>
<span class="c">#      help        Help about any command</span>
<span class="c">#      license     Print the license loaded string</span>
<span class="c">#      logs        Create a ZIP file with logs for GitHub issues or troubleshooting</span>
<span class="c">#      pcapdump    Store all captured traffic (including decrypted TLS) in a PCAP file.</span>
<span class="c">#      pprof       Select a Kubeshark container and open the pprof web UI in the browser</span>
<span class="c">#      proxy       Open the web UI (front-end) in the browser via proxy/port-forward</span>
<span class="c">#      scripts     Watch the `scripting.source` and/or `scripting.sources` folders for changes and update the scripts</span>
<span class="c">#      tap         Capture the network traffic in your Kubernetes cluster</span>
<span class="c">#      version     Print version info</span>
 
<span class="c"># Capture the network traffic in your Kubernetes cluster</span>
<span class="nv">$ </span>kubeshark tap
<span class="c"># =&gt; 2025-08-31T00:37:22+09:00 INF tapRunner.go:47 &gt; Using Docker: registry=docker.io/kubeshark tag=</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:51 &gt; Kubeshark will store the traffic up to a limit (per node). Oldest TCP/UDP streams will be removed once the limit is reached. limit=5Gi</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF versionCheck.go:23 &gt; Checking for a newer version...</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF common.go:69 &gt; Using kubeconfig: path=/Users/anonym/.kube/config</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:67 &gt; Telemetry enabled=true notice="Telemetry can be disabled by setting the flag: --telemetry-enabled=false"</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:69 &gt; Targeting pods in: namespaces=["cilium-monitoring","cilium-secrets","default","kube-node-lease","kube-public","kube-system","local-path-storage"]</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: grafana-5c69859d9-x2r9v</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: prometheus-6fc896bc5d-zwlkf</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: cilium-9qfx8</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: cilium-envoy-bwd6b</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: cilium-operator-6d667fff-krg69</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: coredns-674b8bbfcf-dt7dv</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: coredns-674b8bbfcf-khb4w</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: etcd-myk8s-control-plane</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: hubble-relay-fdd49b976-8mcq9</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: hubble-ui-655f947f96-ccbxk</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: kube-apiserver-myk8s-control-plane</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: kube-controller-manager-myk8s-control-plane</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: kube-scheduler-myk8s-control-plane</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: metrics-server-5dd7b49d79-gx8jd</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:136 &gt; Targeted pod: local-path-provisioner-7dc846544d-phnjz</span>
<span class="c">#    2025-08-31T00:37:22+09:00 INF tapRunner.go:79 &gt; Waiting for the creation of Kubeshark resources...</span>
<span class="c">#    2025-08-31T00:37:24+09:00 INF helm.go:128 &gt; Downloading Helm chart: repo-path=/Users/anonym/Library/Caches/helm/repository url=https://github.com/kubeshark/kubeshark.github.io/releases/download/kubeshark-52.8.1/kubeshark-52.8.1.tgz</span>
<span class="c">#    2025-08-31T00:37:25+09:00 INF helm.go:147 &gt; Installing using Helm: kube-version="&gt;= 1.16.0-0" release=kubeshark source=["https://github.com/kubeshark/kubeshark/tree/master/helm-chart"] version=52.8.1</span>
<span class="c">#    2025-08-31T00:37:25+09:00 INF helm.go:61 &gt; creating 21 resource(s)</span>
<span class="c">#    2025-08-31T00:37:26+09:00 INF tapRunner.go:96 &gt; Installed the Helm release: kubeshark</span>
<span class="c">#    2025-08-31T00:37:26+09:00 INF tapRunner.go:258 &gt; Added: pod=kubeshark-front</span>
<span class="c">#    2025-08-31T00:37:26+09:00 INF tapRunner.go:167 &gt; Added: pod=kubeshark-hub</span>
<span class="c">#    2025-08-31T00:37:52+09:00 INF tapRunner.go:192 &gt; Ready. pod=kubeshark-hub</span>
<span class="c">#    2025-08-31T00:38:08+09:00 INF tapRunner.go:282 &gt; Ready. pod=kubeshark-front</span>
<span class="c">#    2025-08-31T00:38:08+09:00 INF proxy.go:31 &gt; Starting proxy... namespace=default proxy-host=127.0.0.1 service=kubeshark-front src-port=8899</span>
<span class="c">#    2025-08-31T00:38:13+09:00 INF tapRunner.go:417 &gt; Kubeshark is available at: url=&lt;span style="color: green;"&gt;http://127.0.0.1:8899&lt;/span&gt; # ğŸ‘ˆ Web UI </span>
<span class="c">#    2025-08-31T00:38:13+09:00 INF console.go:45 &gt; Starting scripting console ...</span>
<span class="c">#    E0831 00:38:15.481130    2419 proxy_server.go:147] Error while proxying request: error dialing backend: context canceled</span>
<span class="c">#    2025-08-31T00:38:18+09:00 INF console.go:61 &gt; Connecting to: host=127.0.0.1 url=http://127.0.0.1:8899/api</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w7/20250831_cilium_w7_37.png" alt="img.png" class="image-center" />
<em class="image-caption">API Flow ë·°</em>
<img src="/assets/2025/cilium/w7/20250831_cilium_w7_38.png" alt="img.png" class="image-center" />
<em class="image-caption">Service Map ë·°</em></p>

<ul>
  <li>ë¬´ë£Œ ë²„ì „ì—ì„œëŠ” 3ê°œ ë…¸ë“œ, 60ê°œ íŒŒë“œì˜ ì œí•œì´ ìˆì–´ì„œ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>(ì˜µì…˜) íì‡„ë§ Air-Gapped í™˜ê²½ : Enterprise Tier(Plan)ì—ì„œë§Œ ê°€ëŠ¥ - <a href="https://www.kubeshark.co/pricing">Docs</a>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Make sure to disable internet connectivity:</span>
<span class="nv">$ </span>internetConnectivity: <span class="nb">false</span>
</code></pre></div>    </div>
  </li>
  <li>(ì°¸ê³ ) ì‚­ì œ
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cleanup  </span>
<span class="nv">$ </span>kubeshark clean  
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Kubernetesì˜ ì„±ëŠ¥ ì¸¡ì • ë° ëª¨ë‹ˆí„°ë§ ë°©ë²•ê³¼ íŠœë‹ë°©ë²•, Ciliumì˜ ì„±ëŠ¥ ì¸¡ì • ë° íŠœë‹ ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤. 
ì‘ì€ ê·œëª¨ì˜ í´ëŸ¬ìŠ¤í„°ë§Œ ì‚¬ìš©í•´ì„œ ê°„ê³¼í•˜ê³  ìˆì—ˆëŠ”ë°, ê·œëª¨ê°€ ì»¤ì§€ë©´ ë‹¤ì–‘í•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŒì„ ì•Œê²Œ ë˜ì–´ ìœ ìµí•œ ì‹œê°„ì´ì—ˆìŠµë‹ˆë‹¤.
ì •ë§ ë°°ìš°ê³  ìµí˜€ì•¼ í•˜ëŠ”ê²ƒì´ ëì´ ì—†ë‹¤ëŠ” ìƒê°ì´ ë“­ë‹ˆë‹¤. :sweat_smile:</p>

<p>ëª¨ë“ ê²ƒì„ ë‹¤ ì•Œ ìˆ˜ëŠ” ì—†ì§€ë§Œ, ìŠ¤í„°ë””ë¥¼ í†µí•´ ë§ì€ ê²ƒì„ ì•Œê²Œë˜ê³  ê²½í—˜í•˜ê²Œ ë˜ì–´ ë„ˆë¬´ ì¢‹ìŠµë‹ˆë‹¤.
ê¸°ì¡´ ìŠ¤í„°ë””ë„ ë¸”ë¡œê·¸ë¡œ ì •ë¦¬í•œ ê¸€ì„ ì‹¤ë¬´ì—ì„œ ì˜ í™œìš©í•˜ê³  ìˆëŠ”ë°,
ì´ë²ˆ ìŠ¤í„°ë””ë„ í° ë„ì›€ì´ ë ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ìŠ¤í„°ë””ë¥¼ ì§„í–‰í•´ì£¼ì‹œëŠ” ê°€ì‹œë‹¤ ë‹˜ê»˜ ë‹¤ì‹œ í•œë²ˆ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤. :bow:</p>]]></content><author><name></name></author><category term="cilium" /><category term="kubernetes," /><category term="network," /><category term="linux," /><category term="cilium," /><category term="performance" /><summary type="html"><![CDATA[ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Ciliumì˜ performanceì™€ ê·¸ì˜ ê¸°ë°˜ì´ ë˜ëŠ” K8Sì˜ performanceì— ëŒ€í•´ ì‹¤ìŠµì„ í†µí•˜ì—¬ ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[Cilium] Cilium ServiceMesh</title><link href="https://sweetlittlebird.github.io/posts/2025-08-24-Cilium-Week6/" rel="alternate" type="text/html" title="[Cilium] Cilium ServiceMesh" /><published>2025-08-24T00:10:18+09:00</published><updated>2025-08-24T00:10:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/Cilium%20-%20Week6</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2025-08-24-Cilium-Week6/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ServiceMeshì´ë€ ë¬´ì—‡ì¸ê°€ì™€ ë“±ì¥ë°°ê²½ì„ ì•Œì•„ë³´ê³ ,
Ciliumì—ì„œ ì œê³µí•˜ëŠ” ServiceMeshì˜ ê° ê¸°ëŠ¥ë“¤ì— ëŒ€í•´ ì‹¤ìŠµì„ í†µí•˜ì—¬ ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="ì‹¤ìŠµ-í™˜ê²½-êµ¬ì„±">ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±</h2>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” ë‹¤ìŒì˜ êµ¬ì„±ìœ¼ë¡œ ì‹¤ìŠµ í™˜ê²½ì„ êµ¬ì„±í•©ë‹ˆë‹¤.
    <ul>
      <li><strong>ë²„ì „</strong> : Kubernetes 1.33.4, Cilium 1.18.1, pwru</li>
      <li><strong>ê¸°ë³¸ ë°°í¬ ê°€ìƒ ë¨¸ì‹ </strong> : k8s-ctr, k8s-w1, router
        <ul>
          <li>k8s-ctr spec : vCPU 4, Mem 2560</li>
          <li>k8s-w1 spec : vCPU 4, Mem 2560</li>
        </ul>
      </li>
      <li><strong>router</strong> : router : 192.168.<strong>10</strong>.0/24 â†” 192.168.<strong>20</strong>.0/24 ëŒ€ì—­ ë¼ìš°íŒ… ì—­í• , k8s ì— join ë˜ì§€ ì•Šì€ ì„œë²„ì…ë‹ˆë‹¤.</li>
      <li>ì‹¤ìŠµ ë™ì‘ì— í•„ìš”í•œ static routingì´ ì„¤ì €ëœ ìƒíƒœë¡œ ë°°í¬ ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬-íŒŒì¼">ì‹¤ìŠµí™˜ê²½ ë°°í¬ íŒŒì¼</h3>

<ul>
  <li>
    <p><strong>Vagrantfile</strong> : ê°€ìƒë¨¸ì‹  ì •ì˜, ë¶€íŒ… ì‹œ ì´ˆê¸° í”„ë¡œë¹„ì €ë‹ ì„¤ì •ì„ í¬í•¨í•˜ëŠ” Vagrantfileì…ë‹ˆë‹¤.</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Variables</span>
<span class="no">K8SV</span> <span class="o">=</span> <span class="s1">'1.33.4-1.1'</span> <span class="c1"># Kubernetes Version : apt list -a kubelet , ex) 1.32.5-1.1</span>
<span class="no">CONTAINERDV</span> <span class="o">=</span> <span class="s1">'1.7.27-1'</span> <span class="c1"># Containerd Version : apt list -a containerd.io , ex) 1.6.33-1</span>
<span class="no">CILIUMV</span> <span class="o">=</span> <span class="s1">'1.18.1'</span> <span class="c1"># Cilium CNI Version : https://github.com/cilium/cilium/tags</span>
<span class="no">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># max number of worker nodes</span>
  
<span class="c1"># Base Image  https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-24.04</span>
<span class="no">BOX_IMAGE</span> <span class="o">=</span> <span class="s2">"bento/ubuntu-24.04"</span>
<span class="no">BOX_VERSION</span> <span class="o">=</span> <span class="s2">"202508.03.0"</span>
  
<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1">#-ControlPlane Node</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-ctr"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
  
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">2560</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.100"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60000</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span> <span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-ctr.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">N</span><span class="p">,</span> <span class="no">CILIUMV</span><span class="p">,</span> <span class="no">K8SV</span> <span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"route-add1.sh"</span>
  <span class="k">end</span>
  
  <span class="c1">#-Worker Nodes Subnet1</span>
  <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="no">N</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.10</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="s2">"6000</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-w.sh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"route-add1.sh"</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="c1">#-Router Node</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"router"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"router"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">768</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"router"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.200"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60009</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.20.200"</span><span class="p">,</span> <span class="ss">auto_config: </span><span class="kp">false</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"router.sh"</span>
  <span class="k">end</span>
  
<span class="k">end</span>

</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>init_cfg.sh</strong> : args ì°¸ê³ í•˜ì—¬ ì´ˆê¸° ì„¤ì •ì„ ìˆ˜í–‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. <strong>pwru</strong>ë„ ì„¤ì¹˜í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime <span class="c"># Change Timezone</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Disable and turn off SWAP"</span>
swapoff <span class="nt">-a</span> <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'/swap/s/^/#/'</span> /etc/fstab
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Install Packages"</span>
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>apt-transport-https ca-certificates curl gpg <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># Download the public signing key for the Kubernetes package repositories.</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nt">-m</span> 755 /etc/apt/keyrings
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$1</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+)\..*/\1/p'</span><span class="si">)</span>
curl <span class="nt">-fsSL</span> https://pkgs.k8s.io/core:/stable:/v<span class="nv">$K8SMMV</span>/deb/Release.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/kubernetes-apt-keyring.gpg
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v</span><span class="nv">$K8SMMV</span><span class="s2">/deb/ /"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list.d/kubernetes.list
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
  
<span class="c"># packets traversing the bridge are processed by iptables for filtering</span>
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
<span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> <span class="o">&gt;&gt;</span> /etc/sysctl.d/k8s.conf
  
<span class="c"># enable br_netfilter for iptables </span>
modprobe br_netfilter
modprobe overlay
<span class="nb">echo</span> <span class="s2">"br_netfilter"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
<span class="nb">echo</span> <span class="s2">"overlay"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)"</span>
<span class="c"># Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version</span>
apt update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># apt list -a kubelet ; apt list -a containerd.io</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubectl</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubeadm</span><span class="o">=</span><span class="nv">$1</span> containerd.io<span class="o">=</span><span class="nv">$2</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-mark hold kubelet kubeadm kubectl <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># containerd configure to default and cgroup managed by systemd</span>
containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SystemdCgroup = false/SystemdCgroup = true/g'</span> /etc/containerd/config.toml
  
<span class="c"># avoid WARN&amp;ERRO(default endpoints) when crictl run  </span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
</span><span class="no">EOF
  
</span><span class="c"># ready to install for k8s </span>
systemctl restart containerd <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable </span>containerd
systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Packages &amp; Helm"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get <span class="nb">install</span> <span class="nt">-y</span> bridge-utils sshpass net-tools conntrack ngrep tcpdump ipset arping wireguard jq yq tree bash-completion unzip kubecolor termshark <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
curl <span class="nt">-s</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 7] Install pwru"</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>wget https://github.com/cilium/pwru/releases/download/v1.0.10/pwru-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar</span> <span class="nt">-xvzf</span> pwru-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">mv </span>pwru /usr/local/bin/pwru <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="c"># echo "[TASK 8] Change MTU for eth1"</span>
<span class="c"># ip link set dev eth1 mtu 9000</span>
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>  
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>k8s-ctr.sh</strong> : kubeadm initë¥¼ í†µí•˜ì—¬ kubernetes controlplane ë…¸ë“œë¥¼ ì„¤ì •í•˜ê³  Cilium CNI ì„¤ì¹˜, í¸ë¦¬ì„± ì„¤ì •(k, kc, k9s)í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. local-path-storageclassì™€ metrics-serverë„ ì„¤ì¹˜í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Initial Kubernetes"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-init-ctr-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/kubeadm-init-ctr-config.yaml
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$3</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/p'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/K8S_VERSION_PLACEHOLDER/v</span><span class="k">${</span><span class="nv">K8SMMV</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-init-ctr-config.yaml
kubeadm init <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-init-ctr-config.yaml"</span>  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Setting kube config file"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /root/.kube
<span class="nb">cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf /root/.kube/config
<span class="nb">chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> /root/.kube/config
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Source the completion"</span>
<span class="nb">echo</span> <span class="s1">'source &lt;(kubectl completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'source &lt;(kubeadm completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Alias kubectl to k"</span>
<span class="nb">echo</span> <span class="s1">'alias k=kubectl'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'alias kc=kubecolor'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'complete -F __start_kubectl k'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubectx &amp; Kubens"</span>
git clone https://github.com/ahmetb/kubectx /opt/kubectx <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubens /usr/local/bin/kubens
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubectx /usr/local/bin/kubectx
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Kubeps &amp; Setting PS1"</span>
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1 <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">"</span><span class="no">EOT</span><span class="sh">" &gt;&gt; /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
function get_cluster_short() {
  echo "</span><span class="nv">$1</span><span class="sh">" | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=') '
PS1='</span><span class="si">$(</span>kube_ps1<span class="si">)</span><span class="sh">'</span><span class="nv">$PS1</span><span class="sh">
</span><span class="no">EOT
</span>kubectl config rename-context <span class="s2">"kubernetes-admin@kubernetes"</span> <span class="s2">"HomeLab"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 7] Install Cilium CNI"</span>
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
helm repo add cilium https://helm.cilium.io/ <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm repo update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> <span class="nv">$2</span> <span class="nt">--namespace</span> kube-system <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.100 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="se">\</span>
<span class="nt">--set</span> ipam.mode<span class="o">=</span><span class="s2">"cluster-pool"</span> <span class="nt">--set</span> ipam.operator.clusterPoolIPv4PodCIDRList<span class="o">={</span><span class="s2">"172.20.0.0/16"</span><span class="o">}</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>172.20.0.0/16 <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> endpointRoutes.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">directRoutingSkipUnreachable</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>30003 <span class="se">\</span>
<span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span> <span class="se">\</span>
<span class="nt">--set</span> ingressController.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> ingressController.loadbalancerMode<span class="o">=</span>shared <span class="nt">--set</span> loadBalancer.l7.backend<span class="o">=</span>envoy <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">localRedirectPolicy</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> l2announcements.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 8] Install Cilium / Hubble CLI"</span>
<span class="nv">CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz
  
<span class="nv">HUBBLE_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="si">)</span>
<span class="nv">HUBBLE_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">HUBBLE_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/hubble/releases/download/<span class="nv">$HUBBLE_VERSION</span>/hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 9] Remove node taint"</span>
kubectl taint nodes k8s-ctr node-role.kubernetes.io/control-plane-
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 10] local DNS with hosts file"</span>
<span class="nb">echo</span> <span class="s2">"192.168.10.100 k8s-ctr"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.10.200 router"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.20.100 k8s-w0"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;<span class="o">=</span><span class="nv">$1</span><span class="p">;</span> i++  <span class="o">))</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"192.168.10.10</span><span class="nv">$i</span><span class="s2"> k8s-w</span><span class="nv">$i</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts<span class="p">;</span> <span class="k">done
  
  
</span><span class="nb">echo</span> <span class="s2">"[TASK 11] Dynamically provisioning persistent local storage with Kubernetes"</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.31/deploy/local-path-storage.yaml <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch storageclass local-path <span class="nt">-p</span> <span class="s1">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="c"># echo "[TASK 12] Install Prometheus &amp; Grafana"</span>
<span class="c"># kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.18.0/examples/kubernetes/addons/prometheus/monitoring-example.yaml &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># kubectl patch svc -n cilium-monitoring prometheus -p '{"spec": {"type": "NodePort", "ports": [{"port": 9090, "targetPort": 9090, "nodePort": 30001}]}}' &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># kubectl patch svc -n cilium-monitoring grafana -p '{"spec": {"type": "NodePort", "ports": [{"port": 3000, "targetPort": 3000, "nodePort": 30002}]}}' &gt;/dev/null 2&gt;&amp;1</span>
  
<span class="c"># echo "[TASK 12] Install Prometheus Stack"</span>
<span class="c"># helm repo add prometheus-community https://prometheus-community.github.io/helm-charts  &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># cat &lt;&lt;EOT &gt; monitor-values.yaml</span>
<span class="c"># prometheus:</span>
<span class="c">#   prometheusSpec:</span>
<span class="c">#     scrapeInterval: "15s"</span>
<span class="c">#     evaluationInterval: "15s"</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30001</span>
  
<span class="c"># grafana:</span>
<span class="c">#   defaultDashboardsTimezone: Asia/Seoul</span>
<span class="c">#   adminPassword: prom-operator</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30002</span>
  
<span class="c"># alertmanager:</span>
<span class="c">#   enabled: false</span>
<span class="c"># defaultRules:</span>
<span class="c">#   create: false</span>
<span class="c"># prometheus-windows-exporter:</span>
<span class="c">#   prometheus:</span>
<span class="c">#     monitor:</span>
<span class="c">#       enabled: false</span>
<span class="c"># EOT</span>
<span class="c"># helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack --version 75.15.1 \</span>
<span class="c">#   -f monitor-values.yaml --create-namespace --namespace monitoring  &gt;/dev/null 2&gt;&amp;1</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 13] Install Metrics-server"</span>
helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm upgrade <span class="nt">--install</span> metrics-server metrics-server/metrics-server <span class="nt">--set</span> <span class="s1">'args[0]=--kubelet-insecure-tls'</span> <span class="nt">-n</span> kube-system  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 14] Install k9s"</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>wget https://github.com/derailed/k9s/releases/latest/download/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb <span class="nt">-O</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt <span class="nb">install</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p><strong>kubeadm-init-ctr-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration
bootstrapTokens:
- token: <span class="s2">"123456.1234567890123456"</span>
  ttl: <span class="s2">"0s"</span>
  usages:
  - signing
  - authentication
localAPIEndpoint:
  advertiseAddress: <span class="s2">"192.168.10.100"</span>
nodeRegistration:
  kubeletExtraArgs:
    - name: node-ip
      value: <span class="s2">"192.168.10.100"</span>
  criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
<span class="nt">---</span>
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
kubernetesVersion: <span class="s2">"K8S_VERSION_PLACEHOLDER"</span>
networking:
  podSubnet: <span class="s2">"10.244.0.0/16"</span>
  serviceSubnet: <span class="s2">"10.96.0.0/16"</span>
proxy:
  disabled: <span class="nb">true</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li><strong>k8s-w.sh</strong> : kubernetes worker ë…¸ë“œ ì„¤ì •, kubeadm join ë“±ì„ ìˆ˜í–‰í•˜ëŠ”  ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] K8S Controlplane Join"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-join-worker-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-join-worker-config.yaml
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/NODE_IP_PLACEHOLDER/</span><span class="k">${</span><span class="nv">NODEIP</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-join-worker-config.yaml
kubeadm <span class="nb">join</span> <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-join-worker-config.yaml"</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1
    
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
    <ul>
      <li>
        <p><strong>kubeadm-join-worker-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: kubeadm.k8s.io/v1beta4
kind: JoinConfiguration
discovery:
  bootstrapToken:
    token: <span class="s2">"123456.1234567890123456"</span>
    apiServerEndpoint: <span class="s2">"192.168.10.100:6443"</span>
    unsafeSkipCAVerification: <span class="nb">true
</span>nodeRegistration:
  criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
  kubeletExtraArgs:
    - name: node-ip
      value: <span class="s2">"NODE_IP_PLACEHOLDER"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>route-add1.sh</strong> : k8s node ë“¤ì´ ë‚´ë¶€ë§ê³¼ í†µì‹ ì„ ìœ„í•œ route ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt;&gt; /etc/netplan/50-vagrant.yaml
      routes:
      - to: 192.168.20.0/24
        via: 192.168.10.200
</span><span class="no">EOT
  
</span>netplan apply
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>router.sh</strong> : router ì—­í• , ê°„ë‹¨ ì›¹ ì„œë²„ ì—­í• </p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 0] Setting eth2"</span>
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOT</span><span class="sh"> &gt;&gt; /etc/netplan/50-vagrant.yaml
    eth2:
      addresses:
      - 192.168.20.200/24
</span><span class="no">EOT
  
</span>netplan apply
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Add Kernel setting - IP Forwarding"</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g'</span> /etc/sysctl.conf
sysctl <span class="nt">-p</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Packages"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>net-tools jq yq tree ngrep tcpdump arping termshark <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Apache"</span>
apt <span class="nb">install </span>apache2 <span class="nt">-y</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"&lt;h1&gt;Web Server : </span><span class="si">$(</span><span class="nb">hostname</span><span class="si">)</span><span class="s2">&lt;/h1&gt;"</span> <span class="o">&gt;</span> /var/www/html/index.html
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬">ì‹¤ìŠµí™˜ê²½ ë°°í¬</h3>

<h5 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬-1">ì‹¤ìŠµí™˜ê²½ ë°°í¬</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>vagrant up
</code></pre></div></div>

<h5 id="ê¸°ë³¸ì •ë³´-í™•ì¸">ê¸°ë³¸ì •ë³´ í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
<span class="c"># =&gt; ...</span>
<span class="c">#    127.0.2.1 k8s-ctr k8s-ctr</span>
<span class="c">#    192.168.10.100 k8s-ctr</span>
<span class="c">#    192.168.10.200 router</span>
<span class="c">#    192.168.20.100 k8s-w0</span>
<span class="c">#    192.168.10.101 k8s-w1</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>k8s-w1 router <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@<span class="nv">$i</span> <span class="nb">hostname</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    k8s-w1</span>
<span class="c">#    &gt;&gt; node : router &lt;&lt;</span>
<span class="c">#    router</span>

<span class="c"># í´ëŸ¬ìŠ¤í„° ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://192.168.10.100:6443</span>
<span class="c">#    CoreDNS is running at https://192.168.10.100:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt;                             "--service-cluster-ip-range=10.96.0.0/16",</span>
<span class="c">#                                "--cluster-cidr=10.244.0.0/16",</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubeadm-config
<span class="c"># =&gt; ...</span>
<span class="c">#    networking:</span>
<span class="c">#      dnsDomain: cluster.local</span>
<span class="c">#      podSubnet: 10.244.0.0/16</span>
<span class="c">#      serviceSubnet: 10.96.0.0/16</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubelet-config

<span class="c"># ë…¸ë“œ ì •ë³´ : ìƒíƒœ, INTERNAL-IP í™•ì¸</span>
<span class="nv">$ </span>ifconfig | <span class="nb">grep</span> <span class="nt">-iEA1</span> <span class="s1">'eth[0-9]:'</span>
<span class="c"># =&gt; eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255</span>
<span class="c">#    --</span>
<span class="c">#    eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 192.168.10.100  netmask 255.255.255.0  broadcast 192.168.10.255</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME      STATUS   ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    k8s-ctr   Ready    control-plane   15m   v1.33.4   192.168.10.100   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-71-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w1    Ready    &lt;none&gt;          12m   v1.33.4   192.168.10.101   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-71-generic   containerd://1.7.27</span>

<span class="c"># íŒŒë“œ ì •ë³´ : ìƒíƒœ, íŒŒë“œ IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'</span>
<span class="c"># =&gt; k8s-ctr 10.244.0.0/24</span>
<span class="c">#    k8s-w1  10.244.1.0/24</span>
<span class="nv">$ </span>kubectl get ciliumnode <span class="nt">-o</span> json | <span class="nb">grep </span>podCIDRs <span class="nt">-A2</span>
<span class="c"># =&gt;                     "podCIDRs": [</span>
<span class="c">#                            "172.20.0.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "172.20.1.0/24"</span>
<span class="c">#                        ],</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      READY   STATUS    RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system          cilium-2zkt5                              1/1     Running   0          12m   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-8gt4t                              1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-envoy-jhcs2                        1/1     Running   0          12m   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-envoy-txqxb                        1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-operator-7b4884dcdd-j5hnz          1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          hubble-relay-fdd49b976-wdn8n              1/1     Running   0          15m   172.20.0.78      k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          hubble-ui-655f947f96-gv9rw                2/2     Running   0          15m   172.20.0.220     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-c944v   1/1     Running   0          14m   172.20.0.176     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-2qlch                  24463               ready            172.20.0.158</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-ltzx4                  24463               ready            172.20.0.157</span>
<span class="c">#    kube-system          hubble-relay-fdd49b976-wdn8n              16977               ready            172.20.0.78</span>
<span class="c">#    kube-system          hubble-ui-655f947f96-gv9rw                40085               ready            172.20.0.220</span>
<span class="c">#    kube-system          metrics-server-5dd7b49d79-9rlxq           931                 ready            172.20.0.4</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-c944v   9074                ready            172.20.0.176</span>

<span class="c"># ipam ëª¨ë“œ í™•ì¸</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> ^ipam
<span class="c"># =&gt; ipam                                              cluster-pool</span>
<span class="c">#    ipam-cilium-node-update-rate                      15s</span>

<span class="c"># iptables í™•ì¸ : TPROXY ê´€ë ¨ ê·œì¹™ ì°¾ì•„ë³´ì!</span>
<span class="nv">$ </span>iptables-save
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span>

<span class="c"># ì•„ë˜ iptables ë£°ë“¤ì€ Pod â†” Proxy â†” ì™¸ë¶€/ë‚´ë¶€ ì„œë¹„ìŠ¤ íŠ¸ë˜í”½ì´ ì˜¬ë°”ë¥´ê²Œ í”„ë¡ì‹œë¥¼ ê±°ì¹˜ë˜, ì»¤ë„ conntrackì— ì˜í•´ ë°©í•´ë°›ì§€ ì•Šë„ë¡ ì œì–´ by ChatGPT</span>

<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nt">-i</span> proxy
<span class="c"># =&gt; # "Podë¡œ ê°€ëŠ” íŠ¸ë˜í”½ ì¤‘ proxyë¥¼ ê±°ì³ì•¼ í•˜ëŠ” ê²½ìš°" íŒ¨í‚·ì„ ì‹ë³„í•˜ê¸° ìœ„í•´ ë§ˆí‚¹. ì´í›„ TPROXY ë£°ì—ì„œ ì´ ë§ˆí¬(0x200)ë¥¼ ë³´ê³  í”„ë¡ì‹œë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜.</span>
<span class="c">#    -A CILIUM_PRE_mangle ! -o lo -m socket --transparent -m mark ! --mark 0xe00/0xf00 -m mark ! --mark 0x800/0xf00 -m comment --comment "cilium: any-&gt;pod redirect proxied traffic to host proxy" -j MARK --set-xmark 0x200/0xffffffff</span>
<span class="c">#    # Podì—ì„œ ë‚˜ê°€ëŠ” DNS ìš”ì²­(UDP/TCP 53) ì„ Cilium host proxy(Envoy ê¸°ë°˜)ë¡œ ê°•ì œë¡œ ë³´ë‚´ì–´[TPROXYë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜ â†’ 127.0.0.1:38715 (Cilium DNS egress proxy í¬íŠ¸)] L7 ì •ì±… ì ìš© ê°€ëŠ¥í•˜ê²Œ ë§Œë“¦.</span>
<span class="c">#    -A CILIUM_PRE_mangle -p tcp -m mark --mark 0xd9800200 -m comment --comment "cilium: TPROXY to host cilium-dns-egress proxy" -j TPROXY --on-port 32985 --on-ip 127.0.0.1 --tproxy-mark 0x200/0xffffffff</span>
<span class="c">#    -A CILIUM_PRE_mangle -p udp -m mark --mark 0xd9800200 -m comment --comment "cilium: TPROXY to host cilium-dns-egress proxy" -j TPROXY --on-port 32985 --on-ip 127.0.0.1 --tproxy-mark 0x200/0xffffffff</span>

<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nt">-i</span> proxy
<span class="c"># =&gt; # í”„ë¡ì‹œì—ì„œ ë‚˜ê°€ëŠ” ë¦¬í„´ íŠ¸ë˜í”½ì€ NAT/conntrackì´ ê¼¬ì´ì§€ ì•Šê²Œ conntrackì—ì„œ ì œì™¸. ì¦‰, proxy â†” pod ê°„ íŠ¸ë˜í”½ì€ BPFê°€ ì§ì ‘ ìƒíƒœ ê´€ë¦¬.</span>
<span class="c">#    -A CILIUM_OUTPUT_raw -o lxc+ -m mark --mark 0xa00/0xfffffeff -m comment --comment "cilium: NOTRACK for proxy return traffic" -j CT --notrack</span>
<span class="c">#    -A CILIUM_OUTPUT_raw -o cilium_host -m mark --mark 0xa00/0xfffffeff -m comment --comment "cilium: NOTRACK for proxy return traffic" -j CT --notrack</span>
<span class="c">#    # L7 proxy(Envoy) â†’ upstream(ì›ë˜ ëª©ì ì§€) íŠ¸ë˜í”½ë„ conntrackì—ì„œ ì œì™¸.</span>
<span class="c">#    # ì´ìœ : ProxyëŠ” ìì²´ì ìœ¼ë¡œ ì—°ê²° ì¶”ì ì„ ìˆ˜í–‰í•˜ë¯€ë¡œ ì»¤ë„ conntrackê³¼ ì´ì¤‘ ê´€ë¦¬ë˜ë©´ ì¶©ëŒ/ì„±ëŠ¥ ì €í•˜ ë°œìƒ.</span>
<span class="c">#    -A CILIUM_OUTPUT_raw -o lxc+ -m mark --mark 0x800/0xe00 -m comment --comment "cilium: NOTRACK for L7 proxy upstream traffic" -j CT --notrack</span>
<span class="c">#    -A CILIUM_OUTPUT_raw -o cilium_host -m mark --mark 0x800/0xe00 -m comment --comment "cilium: NOTRACK for L7 proxy upstream traffic" -j CT --notrack</span>
<span class="c">#    # ì•ì—ì„œ ì„¤ëª…í•œ "proxyë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜ëœ íŠ¸ë˜í”½" ìì²´ë„ conntrackì—ì„œ ì œì™¸. </span>
<span class="c">#    # Proxy ì•ë’¤ íŠ¸ë˜í”½ ëª¨ë‘ ì»¤ë„ conntrack ëŒ€ì‹  Cilium/BPF/Envoyê°€ ê´€ë¦¬.</span>
<span class="c">#    -A CILIUM_PRE_raw -m mark --mark 0x200/0xf00 -m comment --comment "cilium: NOTRACK for proxy traffic" -j CT --notrack</span>
</code></pre></div></div>

<h5 id="k8s-ctr-cilium-ì„¤ì¹˜-ì •ë³´-í™•ì¸">[k8s-ctr] Cilium ì„¤ì¹˜ ì •ë³´ í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq
<span class="nv">$ </span>cilium status
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'^loadbalancer|l7'</span>
<span class="c"># =&gt; enable-l7-proxy                                   true</span>
<span class="c">#    loadbalancer-l7                                   envoy</span>
<span class="c">#    loadbalancer-l7-algorithm                         round_robin</span>
<span class="c">#    loadbalancer-l7-ports </span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg status <span class="nt">--verbose</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg metrics list
</code></pre></div></div>

<h3 id="ìƒ˜í”Œ-ì• í”Œë¦¬ì¼€ì´ì…˜-ë°°í¬-ë°-í†µì‹ -ë¬¸ì œ-í™•ì¸">ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° í†µì‹  ë¬¸ì œ í™•ì¸</h3>

<h5 id="ìƒ˜í”Œ-ì• í”Œë¦¬ì¼€ì´ì…˜-ë°°í¬">ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># k8s-ctr ë…¸ë“œì— curl-pod íŒŒë“œ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>
</code></pre></div></div>

<h5 id="í†µì‹ -í™•ì¸">í†µì‹  í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   2/2     2            2           27s   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.234.83   &lt;none&gt;        80/TCP    27s   app=webpod</span>
<span class="c">#    NAME               ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/webpod   172.20.0.111:80,172.20.1.212:80   27s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="c"># IP í™•ì¸</span>
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  10893               ready            172.20.0.209</span>
<span class="c">#    webpod-697b545f57-gsp8r   11530               ready            172.20.1.212</span>
<span class="c">#    webpod-697b545f57-pwvhp   11530               ready            172.20.0.111</span>

<span class="c"># í†µì‹  ë¬¸ì œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 webpod | <span class="nb">grep </span>Hostname
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-gsp8r</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-pwvhp</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-pwvhp</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í†µì‹  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!&lt;/span&gt;</span>

<span class="c"># cilium-dbg, map</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg ip list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg endpoint list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg service list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf lb list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf nat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map list | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'0             0'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_services_v2
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_backends_v3
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_reverse_nat
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_ipcache_v2
</code></pre></div></div>

<h5 id="pwru-ê°„ë‹¨-ì‹¤ìŠµ">pwru ê°„ë‹¨ ì‹¤ìŠµ</h5>

<ul>
  <li>ë¡œìš°ë ˆë²¨ì˜ ì •ë³´ê¹Œì§€ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥í•œ pwru(Packet, Where Are You)ë¥¼ í†µí•´ ì°¨ë‹¨ ì´ìœ ë¥¼ í™•ì¸í•´ ë³´ëŠ” ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë‹¤ìš´ë¡œë“œ https://github.com/cilium/pwru/releases : script ë¡œ ë‹¤ìš´ë¡œë“œ ë˜ì–´ ìˆìŒ.</span>
<span class="nv">$ </span>wget https://github.com/cilium/pwru/releases/download/v1.0.10/pwru-linux-arm64.tar.gz
<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xvzf</span> pwru-linux-arm64.tar.gz
<span class="nv">$ </span><span class="nb">mv </span>pwru /usr/bin
<span class="nv">$ </span>pwru <span class="nt">-h</span>

<span class="c"># 1.1.1.1 ëª©ì ì§€ ì°¨ë‹¨ ì„¤ì •</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-I</span> OUTPUT 1 <span class="nt">-m</span> tcp <span class="nt">--proto</span> tcp <span class="nt">--dst</span> 1.1.1.1/32 <span class="nt">-j</span> DROP

<span class="c"># curl í˜¸ì¶œ : ì•„ë˜ ëª¨ë‹ˆí„°ë§ í›„ í˜¸ì¶œ</span>
<span class="nv">$ </span>curl 1.1.1.1 <span class="nt">-v</span>

<span class="c"># pwru ëª¨ë‹ˆí„°ë§ : ì°¨ë‹¨ ì´ìœ  í™•ì¸! SKB_DROP_REASON_NETFILTER_DROP </span>
<span class="nv">$ </span>pwru <span class="s1">'dst host 1.1.1.1 and tcp and dst port 80'</span>
<span class="c"># =&gt; 2025/08/21 23:45:36 Attaching kprobes (via kprobe)...</span>
<span class="c">#    1667 / 1667 [----------------------------------------------------------] 100.00% 1270 p/s</span>
<span class="c">#    2025/08/21 23:45:38 Attached (ignored 5)</span>
<span class="c">#    2025/08/21 23:45:38 Listening for events..</span>
<span class="c">#    SKB                CPU PROCESS          NETNS      MARK/x        IFACE       PROTO  MTU   LEN   TUPLE FUNC</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0000 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __ip_local_out</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) nf_hook_slow</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) </span>
<span class="c">#       kfree_skb_reason(&lt;span style="color: green;"&gt;SKB_DROP_REASON_NETFILTER_DROP&lt;/span&gt;)</span>
<span class="c">#       &lt;span style="color: green;"&gt;ğŸ‘‰ NETFILERì— ì˜í•´ ì°¨ë‹¨(DROP)ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) skb_release_head_state</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) tcp_wfree</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) skb_release_data</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) kfree_skbmem</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __skb_clone</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        0          0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __copy_skb_header</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0000 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __ip_local_out</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) nf_hook_slow</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) </span>
<span class="c">#       kfree_skb_reason(&lt;span style="color: green;"&gt;SKB_DROP_REASON_NETFILTER_DROP&lt;/span&gt;)</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) skb_release_head_state</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) tcp_wfree</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) skb_release_data</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) kfree_skbmem</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __skb_clone</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        0          0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __copy_skb_header</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0000 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __ip_local_out</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) nf_hook_slow</span>
<span class="c">#    ^C2025/08/21 23:46:14 Received signal, exiting program..</span>
<span class="c">#    2025/08/21 23:46:14 Detaching kprobes...</span>
<span class="c">#    1662 / 1662 [------------------------------------------------------------------------------------------------------------------------------------------------------] 100.00% 33 p/s</span>
</code></pre></div></div>

<ul>
  <li>í†µì‹ ì´ ì˜ ë˜ëŠ”ê²ƒì„ í™•ì¸í•˜ì˜€ê³ , ê¸°ë³¸ì ì¸ ì ê²€ì„ ë§ˆì³¤ìœ¼ë‹ˆ ë³¸ê²©ì ìœ¼ë¡œ Ciliumì˜ ê¸°ëŠ¥ì„ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="cilium-service-mesh">Cilium Service Mesh</h2>

<h3 id="service-mesh-ì†Œê°œ">Service Mesh ì†Œê°œ</h3>

<ul>
  <li>Service MeshëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹ ì„ ê´€ë¦¬í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ê¸° ìœ„í•œ ì¸í”„ë¼ ê³„ì¸µì…ë‹ˆë‹¤. ì£¼ë¡œ L7 íŠ¸ë˜í”½ ê´€ë¦¬, ë³´ì•ˆ, ëª¨ë‹ˆí„°ë§, ë¡œê¹… ë“±ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>ë“±ì¥ ë°°ê²½
    <ul>
      <li>ê¸°ì¡´ì— í•˜ë‚˜ì˜ ëª¨ë†€ë¦¬ì‹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë‚˜ ì†Œìˆ˜ì˜ í° ì„œë¹„ìŠ¤ë¡œ êµ¬ì„±ëœ ì‹œìŠ¤í…œì—ì„œëŠ” ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹ ì„ ê´€ë¦¬í•˜ê¸°ê°€ ìƒëŒ€ì ìœ¼ë¡œ ì‰¬ì› ìŠµë‹ˆë‹¤.</li>
      <li>í•˜ì§€ë§Œ ì ê²ŒëŠ” ìˆ˜ì‹­ê°œ, ë§ê²ŒëŠ” ìˆ˜ì²œê°œì˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ” Micro Service Architecture í™˜ê²½ì—ì„œëŠ” ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹ ì„ ê´€ë¦¬í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ê¸°ê°€ ë§¤ìš° ë³µì¡í•´ì§‘ë‹ˆë‹¤.</li>
      <li>MSAê°€ ì ì  ë³´í¸í™” ë¨ì— ë”°ë¼ ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹ ì„ ê´€ë¦¬í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ê¸°ëŠ¥ì´ í•„ìš”í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
        <ul>
          <li><strong>ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬</strong> : ì„œë¹„ìŠ¤ê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë˜ê³  ì‚­ì œë˜ê¸° ë•Œë¬¸ì—, ì„œë¹„ìŠ¤ì˜ IP ì£¼ì†Œë‚˜ í¬íŠ¸ë“±ì„ ìë™ìœ¼ë¡œ ì°¾ì•„ì£¼ëŠ” ê¸°ëŠ¥</li>
          <li><strong>ëª¨ë‹ˆí„°ë§</strong> : ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹ ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ì„±ëŠ¥ì„ ì¸¡ì •í•˜ëŠ” ê¸°ëŠ¥</li>
          <li><strong>ë¡œê¹…</strong> : ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹ ì„ ë¡œê¹…í•˜ê³  ë¶„ì„</li>
          <li><strong>íŠ¸ë˜í”½ ê´€ë¦¬</strong> : ì„œë¹„ìŠ¤ ê°„ì˜ íŠ¸ë˜í”½ì„ ì œì–´í•˜ê³  ê´€ë¦¬í•˜ëŠ” ê¸°ëŠ¥. Traffic Shifting, Circuit Breaker, Rate Limiting, Fault Injection ë“±ì˜ ê¸°ëŠ¥ì„ í¬í•¨</li>
          <li><strong>ë³´ì•ˆ</strong> : ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹ ì„ ì•”í˜¸í™”í•˜ê³  ì¸ì¦í•˜ëŠ” ê¸°ëŠ¥</li>
          <li><strong>ì •ì±… ê´€ë¦¬</strong> : ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹ ì„ ì œì–´í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ê¸° ìœ„í•œ ì •ì±…ì„ ê´€ë¦¬í•˜ëŠ” ê¸°ëŠ¥</li>
        </ul>
      </li>
      <li>ì´ëŸ¬í•œ ê¸°ëŠ¥ë“¤ì„ ì„œë¹„ìŠ¤ ë‹¨ìœ„ë¡œ ì–¸ì–´ë³„ë¡œ êµ¬í˜„í•´ì•¼ í–ˆê¸°ì— ë³µì¡ë„ê°€ ì¦ê°€í•˜ê³ , ì½”ë“œ ì¤‘ë³µì´ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.</li>
      <li>Service MeshëŠ” ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹ ì„ ê´€ë¦¬í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ê¸° ìœ„í•œ ì¸í”„ë¼ ê³„ì¸µì„ ì œê³µí•©ë‹ˆë‹¤. 
ì´ë¥¼ í†µí•´ ê°œë°œìëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì§‘ì¤‘í•  ìˆ˜ ìˆê³ , ìš´ì˜ìëŠ” ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹ ì„ ê´€ë¦¬í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ê¸°ê°€ ì‰¬ì›Œì§‘ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ëŒ€í‘œì ì¸ Service Meshì—ëŠ” <strong>Istio</strong>, <strong>Linkerd</strong>, <strong>Consul</strong> ë“±ì´ ìˆê³ , Ciliumì—ì„œë„ <strong>Cilium Service Mesh</strong>ë¡œ Service Mesh ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="ê¸°ë³¸-ë™ì‘">ê¸°ë³¸ ë™ì‘</h5>

<ul>
  <li>íŒŒë“œê°„ í†µì‹  ê²½ë¡œì— í”„ë¡ì‹œë¥¼ ë‘ê³ , íŠ¸ë˜í”½ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ì œì–´í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤. ë”°ë¼ì„œ <strong>ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³€ê²½ ì—†ì´</strong>ë„ Service Mesh ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ol>
      <li>ê¸°ì¡´ í†µì‹  í™˜ê²½
  <img src="/assets/2025/cilium/w6/20250824_cilium_w6_1.png" alt="img.png" class="image-center w-70 image-bg" /></li>
      <li>Proxyë¥¼ ë„ì…í•˜ì—¬, ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì •ì—†ì´ ëª¨ë“  ì• í”Œë¦¬ì¼€ì´ì…˜ í†µì‹ ì„ í”„ë¡ì‹œë¥¼ ê±°ì¹˜ë„ë¡ í•©ë‹ˆë‹¤.
  <img src="/assets/2025/cilium/w6/20250824_cilium_w6_2.png" alt="img_1.png" class="image-center w-70 image-bg" />
        <ul>
          <li>íŒŒë“œ ë‚´ì— ì‚¬ì´ë“œì¹´ ì»¨í…Œì´ë„ˆë¡œ ì£¼ì…ë˜ì–´ì„œ ë™ì‘í•©ë‹ˆë‹¤.</li>
          <li>Proxy ì»¨í…Œì´ë„ˆê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ íŠ¸ë˜í”½ì„ ê°€ë¡œì±„ê³ , ì´ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ProxyëŠ” DataPlane ì—­í• ì„ í•˜ë©°, ì´ë¥¼ ì¤‘ì•™ì—ì„œ ê´€ë¦¬í•˜ëŠ” ControlPlaneì„ ë‘ê³  ì¤‘ì•™ì—ì„œ ì •ì±…ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
  <img src="/assets/2025/cilium/w6/20250824_cilium_w6_3.png" alt="img_2.png" class="image-center w-70 image-bg" />
        <ul>
          <li>ProxyëŠ” ControlPlaneì—ì„œ ì„¤ì •ì„ ê´€ë¦¬í•˜ë©°, ì„¤ì •ê´€ë¦¬ê°€ ìœ ì—°í•˜ê³  í’ë¶€í•œ APIë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
          <li>ëŒ€í‘œì ì¸ Service Meshì˜ Proxyë¡œëŠ” Google, Ibm, Lyftê°€ ì¤‘ì‹¬ì´ ë˜ì–´ ê°œë°œí•˜ê³ ìˆëŠ” Envoyê°€ ìˆìŠµë‹ˆë‹¤.
            <ul>
              <li>ë„¤íŠ¸ì›Œí¬ íˆ¬ëª…ì„±ì„ ëª©í‘œë¡œ í•˜ë©°, ë‹¤ì–‘í•œ í•„í„°ì²´ì¸ (L3/L4, HTTP L7)ì„ ì§€ì›í•˜ë©°, ë™ì  êµ¬ì„± API, API ê¸°ë°˜ hot reloadë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
            </ul>
          </li>
        </ul>
      </li>
    </ol>
  </li>
  <li><strong>íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§</strong> : ìš”ì²­ì˜ ì—ëŸ¬ìœ¨, ì§€ì—°(latency), ì»¨ë„¥ì…˜ ê°œìˆ˜, ìš”ì²­ ê°œìˆ˜ ë“±ì˜ ë©”íŠ¸ë¦­ì„ ëª¨ë‹ˆí„°ë§í•˜ë©°, íŠ¹ì • ì„œë¹„ìŠ¤ê°„ í˜¹ì€ íŠ¹ì • ìš”ì²­ ê²½ë¡œë¥¼ í•„í„°ë§í•´ì„œ ëª¨ë‹ˆí„°ë§ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>íŠ¸ë˜í”½ ì»¨íŠ¸ë¡¤</strong>
    <ul>
      <li>íŠ¸ë˜í”½ ì‹œí”„íŒ…(Traffic shifting) : ì˜ˆì‹œ) 99% ê¸°ì¡´ì•± + 1% ì‹ ê·œì•±, íŠ¹ì • ë‹¨ë§/ì‚¬ìš©ìëŠ” ì‹ ê·œì•±ì— ì „ë‹¬í•˜ì—¬ ë‹¨ê³„ì ìœ¼ë¡œ ì ìš©í•˜ëŠ” ì¹´ë‚˜ë¦¬ ë°°í¬ ê¸°ëŠ¥</li>
      <li>ì„œí‚· ë¸Œë ˆì´ì»¤(Circuit Breaker) : ëª©ì ì§€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ìˆì„ ì‹œ ì ‘ì†ì„ ì°¨ë‹¨í•˜ê³  ì¶œë°œì§€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì— ìš”ì²­ ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ì—¬ ì—°ì‡„ ì¥ì• , ì‹œìŠ¤í…œ ì „ì œ ì¥ì•  ì˜ˆë°©í•©ë‹ˆë‹¤.</li>
      <li>í´íŠ¸ ì¸ì ì…˜(Fault Injection) : ì˜ë„ì ìœ¼ë¡œ ìš”ì²­ì„ ì§€ì—° í˜¹ì€ ì‹¤íŒ¨ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.</li>
      <li>ì†ë„ ì œí•œ(Rate Limit) : ìš”ì²­ ê°œìˆ˜ë¥¼ ì œí•œí•˜ì—¬ ì„œë¹„ìŠ¤ê°€ ê³¼ë¶€í•˜ì™€ ë¦¬ì†ŒìŠ¤ ê³ ê°ˆì„ ë°©ì§€í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="cilium-service-mesh-ì†Œê°œ">Cilium Service Mesh ì†Œê°œ</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/">Docs</a>, <a href="https://www.youtube.com/watch?v=lZskwr3uXn8">Youtube</a>
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_4.png" alt="img.png" /></li>
  <li>Cilium Service MeshëŠ” Ciliumì˜ eBPF ê¸°ë°˜ ë„¤íŠ¸ì›Œí‚¹(L3/L4 ë‹´ë‹¹)ê³¼ Envoy Proxy(L7 ë‹´ë‹¹)ë¥¼ ê²°í•©í•˜ì—¬ ê°•ë ¥í•˜ê³  ìœ ì—°í•œ Service Mesh ì†”ë£¨ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li><strong>L3/L4 ìˆ˜ì¤€ í”„ë¡œí† ì½œ</strong> : eBPFê°€ ìˆ˜í–‰
    <ul>
      <li>IP, TCP, UDP ë“± L3/L4 í”„ë¡œí† ì½œì„ ì§€ì›í•˜ë©°, Ciliumì˜ eBPF ê¸°ë°˜ ë„¤íŠ¸ì›Œí‚¹ ê¸°ëŠ¥ì„ í™œìš©í•˜ì—¬ ê³ ì„±ëŠ¥ íŠ¸ë˜í”½ ì²˜ë¦¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
      <li>ìœ„ì˜ ê·¸ë¦¼ì—ì„œ ë³´ë“¯ì´, ê¸°ì¡´ì˜ Service MeshëŠ” L3/L4 íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ iptablesë¥¼ ì‚¬ìš©í•˜ê³ , ì‚¬ì´ë“œì¹´ì™€ VETHë¥¼ í†µí•´ì„œ 
íŠ¸ë˜í”½ì„ ê°€ë¡œì±„ê³  ì²˜ë¦¬í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ ë˜ë©´ TCP/IP ìŠ¤íƒì„ íŒŒë“œë¥¼ ë– ë‚˜ê¸° ì „ê¹Œì§€ë§Œë„ 3ë²ˆì´ë‚˜ íƒìƒ‰í•´ì•¼ í–ˆìŠµë‹ˆë‹¤.</li>
      <li>Cilium Service MeshëŠ” eBPFë¥¼ í†µí•´ Proxyë¥¼ Hostì™€ Kernelë¡œ ì´ë™í•˜ê³  ì‚¬ì´ë“œì¹´ë¥¼ ì œê±°í•˜ì—¬, 
íŠ¸ë˜í”½ì„ ê°€ë¡œì±„ê³  ì²˜ë¦¬í•˜ëŠ”ë° í•„ìš”í•œ ì˜¤ë²„í—¤ë“œë¥¼ ìµœì†Œí™”í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li><strong>L7 ìˆ˜ì¤€ í”„ë¡œí† ì½œ</strong> : Envoy Proxyê°€ ìˆ˜í–‰
    <ul>
      <li>HTTP, Kafka, gRPC, DNSì™€ ê°™ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ í”„ë¡œí† ì½œì€ Envoy Proxyë¥¼ í†µí•´ ì²˜ë¦¬ë©ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_5.png" alt="img.png" /></li>
      <li>Ciliumì€ ì´ë¯¸ íƒ€ Service Meshì—ì„œ ì‚¬ì´ë“œì¹´ í˜•íƒœë¡œ ì‚¬ìš©í•˜ëŠ” Envoyë¥¼ L7 ì •ì±…ì´ë‚˜ ê´€ì¸¡ì„±(Observability) ê¸°ëŠ¥ì„ ìœ„í•´ ì‚¬ìš©í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.</li>
      <li>ì´ë¯¸ Ciliumì´ Envoyë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ìì—°ìŠ¤ëŸ½ê²Œ Service Mesh ê¸°ëŠ¥ì„ ì¶”ê°€í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
      <li>íŠ¹íˆ ë‹¤ë¥¸ Service Meshì™€ ë‹¬ë¦¬ Cilium Service MeshëŠ” Nodeë‹¹ í•˜ë‚˜ì˜ Envoy Proxyë§Œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        <ul>
          <li>istiodì˜ Ambient ëª¨ë“œì™€ ìœ ì‚¬í•˜ì§€ë§Œ, Ciliumì˜ CNI ê¸°ëŠ¥ì„ í™œìš©í•˜ì—¬ ë” íš¨ìœ¨ì ì´ê³  í†µí•©ëœ êµ¬ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>ì œê³µ ê¸°ëŠ¥</strong>
    <ul>
      <li><strong>íƒ„ë ¥ì ì¸ ì—°ê²°ì„±(Resilient Connectivity)</strong>: ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì€ í´ë¼ìš°ë“œ, í´ëŸ¬ìŠ¤í„°, ì˜¨í”„ë ˆë¯¸ìŠ¤ ë“± ê²½ê³„ë¥¼ ë„˜ì–´ ê°€ëŠ¥í•´ì•¼ í•˜ë©°, í†µì‹ ì€ <strong>íƒ„ë ¥ì </strong>ì´ê³  <strong>ì¥ì•  í—ˆìš©</strong>ì´ ê°€ëŠ¥í•´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li><strong>L7 íŠ¸ë˜í”½ ê´€ë¦¬(L7 Traffic Management)</strong>: ë¡œë“œ ë°¸ëŸ°ì‹±, ì†ë„ ì œí•œ, ì¥ì•  ë³µì›ë ¥ ë“±ì€ L7(HTTP, REST, gRPC, WebSocket ë“±)ì„ ì¸ì‹í•´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li><strong>ID ê¸°ë°˜ ë³´ì•ˆ(Identity-based Security)</strong>: ë„¤íŠ¸ì›Œí¬ ì‹ë³„ìì—ë§Œ ì˜ì¡´í•˜ëŠ” ë³´ì•ˆì€ ë” ì´ìƒ ì¶©ë¶„í•˜ì§€ ì•Šìœ¼ë©°, ì†¡ì‹  ë° ìˆ˜ì‹  ì„œë¹„ìŠ¤ ëª¨ë‘ ë„¤íŠ¸ì›Œí¬ ì‹ë³„ìê°€ ì•„ë‹Œ ID ê¸°ë°˜ìœ¼ë¡œ ìƒí˜¸ ì¸ì¦í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li><strong>ê´€ì¸¡ì„± ë° íŠ¸ë ˆì´ì‹±(Observability &amp; Tracing)</strong>: íŠ¸ë ˆì´ì‹±ê³¼ ë©”íŠ¸ë¦­ í˜•íƒœì˜ ê´€ì¸¡ì„±ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì•ˆì •ì„±, ì„±ëŠ¥, ê°€ìš©ì„±ì„ ì´í•´í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ë©° ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë° ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤.</li>
      <li><strong>íˆ¬ëª…ì„±(Transparency)</strong>: ì´ ê¸°ëŠ¥ë“¤ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œë¥¼ ë³€ê²½í•˜ì§€ ì•Šê³ ë„ íˆ¬ëª…í•˜ê²Œ ì œê³µë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="k8s-ingress-support">K8S Ingress Support</h2>

<h3 id="cilium-k8s-ingress-support-ì†Œê°œ">Cilium K8S Ingress Support ì†Œê°œ</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress/">ê´€ë ¨ë¬¸ì„œ</a></li>
  <li>Ciliumì€ Kubernetes Ingress resource definitionì„ ì§€ì›í•˜ë©° <code class="language-plaintext highlighter-rouge">ingressClassName</code>ì„ ciliumìœ¼ë¡œ ì§€ì •í•¨ìœ¼ë¡œì¨ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê²½ë¡œ ê¸°ë°˜ ë¼ìš°íŒ…ê³¼ TLS terminationì„ ì§€ì›í•©ë‹ˆë‹¤. í•˜ìœ„ í˜¸í™˜ì„ ìœ„í•´ì„œ <code class="language-plaintext highlighter-rouge">kubernetes.io/ingress.class</code>ì„ ciliumìœ¼ë¡œ ì„¤ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Cilium Ingress ControllerëŠ” LoadBalancer Typeì˜ Serviceë¡œ ë°°í¬ë˜ê¸° ë•Œë¬¸ì—, LoadBalancerë¥¼ ì§€ì›í•˜ëŠ” í™˜ê²½ì„ í•„ìš”ë¡œ í•©ë‹ˆë‹¤.</li>
  <li>Ciliumì€ ë¡œë“œë°¸ëŸ°ì„œ ëª¨ë“œë¥¼ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê° ëª¨ë“œëŠ” ì¥ë‹¨ì ì´ ìˆê¸° ë•Œë¬¸ì— ì‚¬ìš© í™˜ê²½ì— ë”°ë¼ ì ì ˆí•œ ëª¨ë“œë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">dedicated</code> : í•´ë‹¹ ingressë¥¼ ìœ„í•´ì„œ ë‹¨ë… ë¡œë“œë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ê° ingressë§ˆë‹¤ ë³„ë„ì˜ ë¡œë“œë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, ì¶©ëŒì´ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ìì› ë‚­ë¹„ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">shared</code> : ëª¨ë“  ingressë“¤ì´ í•˜ë‚˜ì˜ ê³µí†µ ë¡œë“œë°¸ëŸ°ì„œë¥¼ ê³µìœ í•©ë‹ˆë‹¤. ìì›ì€ ì ˆì•½í•˜ì§€ë§Œ path prefix ì¶©ëŒì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ë¡œë“œë°¸ëŸ°ì„œ ëª¨ë“œëŠ” ë³€ê²½ì´ ê°€ëŠ¥í•˜ì§€ë§Œ, ë³€ê²½ì„ ìœ„í•´ì„œëŠ” LB IP ì£¼ì†Œê°€ ë³€ê²½ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ, ë³€ê²½ì‹œ ì—°ê²°ì´ ì¢…ë£Œë˜ë©°, ë‹¤ìš´íƒ€ì„ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="í•„ìˆ˜-ì¡°ê±´">í•„ìˆ˜ ì¡°ê±´</h5>

<ul>
  <li>Ciliumì€ <code class="language-plaintext highlighter-rouge">nodePort.enabled=true</code>ë¡œ ì„¤ì •ë˜ì–´ NodePortê°€ í™œì„±í™”ë˜ì–´ ìˆê±°ë‚˜ <code class="language-plaintext highlighter-rouge">kubeProxyReplacement=true</code>ë¥¼ í†µí•´ kube-proxyë¥¼ ëŒ€ì²´í•˜ëŠ” ê²½ìš°ì—ë§Œ Ingressë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">l7Proxy=true</code>ë¡œ ì„¤ì •í•´ì„œ L7 Proxyë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤. (ê¸°ë³¸ê°’)</li>
  <li>ê¸°ë³¸ì ìœ¼ë¡œ LoadBalancer íƒ€ì…ì˜ Serviceë¡œ ë°°í¬ë˜ê¸° ë•Œë¬¸ì—, LoadBalancerë¥¼ ì§€ì›í•˜ëŠ” í™˜ê²½ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œëŠ” NodePortë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, Cilium 1.16 ì´ìƒ ë²„ì „ì—ì„œëŠ” <a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress/#gs-ingress-host-network-mode">host network</a>ì— L7 Proxyë¥¼ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="cilium-ingressì™€-cilium-gateway-apiì˜-ë‹¤ë¥¸-ingress-controllerì™€ì˜-ì°¨ì´ì ">Cilium Ingressì™€ Cilium Gateway APIì˜ ë‹¤ë¥¸ Ingress Controllerì™€ì˜ ì°¨ì´ì </h5>

<ul>
  <li><strong>CNIì™€ì˜ ë°€ì ‘í•œ ì—°ê²°</strong> : ë‹¤ë¥¸ Ingress ControllerëŠ” CNIì™€ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘í•˜ì§€ë§Œ, Cilium IngressëŠ” Cilium CNIì™€ ë°€ì ‘í•˜ê²Œ í†µí•©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>eBPFì™€ TPROXYë¥¼ ì‚¬ìš©í•˜ì—¬ íˆ¬ëª…í•˜ê²Œ Envoyì— ì „ë‹¬</strong> : ë‹¤ë¥¸ Ingress ControllerëŠ” iptablesë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¨ìˆœ í¬íŠ¸í¬ì›Œë”©ì„ í†µí•´ íŠ¸ë˜í”½ì„ ê°€ë¡œì±„ì§€ë§Œ, Cilium IngressëŠ” eBPFì™€ TPROXYë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¸ë˜í”½ì„ Envoyì— íˆ¬ëª…í•˜ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì„±ëŠ¥ê³¼ í™•ì¥ì„±ì´ í–¥ìƒë©ë‹ˆë‹¤.
    <ul>
      <li>ì´ë¥¼ í†µí•´ Client IP Visibility ê°™ì€ ë¬¸ì œë¥¼ í•´ê²° í•  ìˆ˜ ìˆìœ¼ë©°, Ciliumì˜ ë„¤íŠ¸ì›Œí¬ ì •ì±… ì—”ì§„ì´ Ingressë¥¼ í†µí•´ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì— Cilium Network Policyë¥¼ ì ìš©í•  ìˆ˜ ìˆë„ë¡ í•´ì¤ë‹ˆë‹¤.</li>
      <li>ë™ì‘ ê²½ë¡œ : - [Client] â†’ [K8s Node:Ingress/Gateway Service Port] â†’ (eBPF Service LB) â†’ (TPROXY) â†’ [Envoy Proxy (Pod)]
â†’ (L7 ë¼ìš°íŒ…/ì •ì±… ì²˜ë¦¬) â†’ (eBPF) â†’ [Backend Pod]</li>
    </ul>
  </li>
</ul>

<h5 id="cilium-ingress-êµ¬ì„±-ë°-cilium-network-policy">Cilium Ingress êµ¬ì„± ë° Cilium Network Policy</h5>

<ul>
  <li>ë…¸ë“œë³„ Envoy Proxyì— NetworkPolicyë¥¼ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Ciliumì„ í†µí•´ ê° ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë¡œ ì „ì†¡ë˜ëŠ” Ingressì™€ Gateway API íŠ¸ë˜í”½ì€ ê° ë…¸ë“œë³„ Envoy Proxyë¥¼ í†µí•´ ì²˜ë¦¬ë©ë‹ˆë‹¤.</li>
  <li>ë…¸ë“œë³„ Envoy ProxyëŠ” eBPF ì •ì±… ì—”ì§„ê³¼ ìƒí˜¸ì‘ìš©í•  ìˆ˜ ìˆëŠ” íŠ¹ìˆ˜í•œ ì½”ë“œë¥¼ ê°–ê³  ìˆìœ¼ë©°, íŠ¸ë˜í”½ì— ëŒ€í•´ ì •ì±…ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ë¥¼ í†µí•´ EnvoyëŠ” Ingressì™€ Gateway API íŠ¸ë˜í”½, east-west íŠ¸ë˜í”½ì— ëŒ€í•´ì„œ Network Policy Enforcement Pointë¡œ ì‘ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Envoyì— ë„ì°©í•œ íŠ¸ë˜í”½ì€ Ciliumì˜ ì •ì±… ì—”ì§„ì´ ë¶€ì—¬í•œ íŠ¹ìˆ˜ ingress IDë¥¼ í• ë‹¹ ë°›ìŠµë‹ˆë‹¤.</li>
  <li>í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì€ ì¼ë°˜ì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ì— (IP CIDR ì •ì±…ì´ ì—†ëŠ” í•œ) world identityê°€ í• ë‹¹ ë©ë‹ˆë‹¤.</li>
  <li>ì´ëŠ” ì‹¤ì œë¡œ Cilium Ingressì— ë‘ê°œì˜ ë…¼ë¦¬ì  ì •ì±… ì§‘í–‰ ì§€ì ì´ ìˆë‹¤ëŠ”ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
  <li>ì¦‰, ingress identityì— íŠ¸ë˜í”½ì´ ë„ì°©í•˜ê¸° ì „ê³¼ ë…¸ë“œë³„ Envoyë¥¼ í†µí•´ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬ë˜ê¸° ì „ì…ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_6.png" alt="img.png" /></li>
  <li>ì´ëŠ” ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ í´ëŸ¬ìŠ¤í„°ì— ì ìš©í• ë•Œ worldì—ì„œ ingressë¡œ ë“¤ì–´ê°ˆë•Œë„ í—ˆìš©(allow)í•˜ê³ , ingressì—ì„œ í´ëŸ¬ìŠ¤í„°ì˜ identities (ìœ„ì˜ ê·¸ë¦¼ì—ì„œëŠ” productpage identity)ë¡œ ì „ë‹¬ë ë•Œë„ ë™ì‹œì— í—ˆìš©(allow)í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
Gateway APIì—ì„œë„ ë™ì¼í•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="source-ip-visibility">Source IP Visibility</h5>

<ul>
  <li>ê¸°ë³¸ê°’ìœ¼ë¡œ Ciliumì˜ EnvoyëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ IP ì£¼ì†Œë¥¼ <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code> í—¤ë”ì— ì¶”ê°€í•˜ì—¬ 
ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ì‹¤ì œ IP ì£¼ì†Œë¥¼ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">trusted hops</code>ë¥¼ <code class="language-plaintext highlighter-rouge">0</code>ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •í•˜ì—¬, Envoyê°€ <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code>í—¤ë”ì˜ ê°’ì„ ë³´ëŠ” ëŒ€ì‹ , ì—°ê²°ì´ ì‹œì‘ëœ ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ IPë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>ì¦‰, <code class="language-plaintext highlighter-rouge">trusted hops</code>ë¥¼ ì¦ê°€ ì‹œí‚´ìœ¼ë¡œì¨ Envoyê°€ <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code>ì˜ ì˜¤ë¥¸ìª½ ë¶€í„° ìˆ˜ë¥¼ ì„¸ëŠ” në²ˆì§¸ í•­ëª©ì„ ì‚¬ìš©í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>EnvoyëŠ” ë˜í•œ <code class="language-plaintext highlighter-rouge">X-Envoy-External-Address</code> í—¤ë”ë¥¼ ì‚¬ìš©í•˜ì—¬ <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code>ë¥¼ ê¸°ë°˜ìœ¼ë¡œí•œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ì£¼ì†Œë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="tls-passthroughì™€-source-ip-visibility">TLS Passthroughì™€ Source IP Visibility</h5>

<ul>
  <li>Ingressì™€ Gateway APIëŠ” ëª¨ë‘ TLS Passthrough êµ¬ì„±ì„ ì§€ì›í•©ë‹ˆë‹¤. (IngressëŠ” annotationì„ í†µí•´, Gateway APIëŠ” <code class="language-plaintext highlighter-rouge">TLSRoute</code> ë¦¬ì†ŒìŠ¤ë¥¼ í†µí•´ ì§€ì›í•©ë‹ˆë‹¤.)</li>
  <li>ì´ êµ¬ì„±ì„ í†µí•´ ì—¬ëŸ¬ TLS Passthrough ë°±ì—”ë“œê°€ Load Balancerì—ì„œ ë™ì¼í•œ TLS í¬íŠ¸ë¥¼ ê³µìœ  í•  ìˆ˜ ìˆìœ¼ë©°, EnvoyëŠ” TLS í•¸ë“œì…°ì´í¬ì˜
ì„œë²„ ì´ë¦„ í‘œì‹œê¸°(SNI)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë°±ì—”ë“œë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</li>
  <li>ë™ì‘ë°©ì‹ : TLS íŠ¸ë˜í”½ -&gt; Envoyì— ë„ì°© -&gt; TCP ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ -&gt; Envoyê°€ í´ë¼ì´ì–¸íŠ¸ helloë¥¼ ê²€ì‚¬í•˜ì—¬ SNIë¥¼ ì°¾ê³  ë°±ì—”ë“œ ì„ íƒ -&gt; <strong>âœ¨ìƒˆë¡œìš´ TCP ìŠ¤íŠ¸ë¦¼ ì‹œì‘</strong> 
-&gt; ë‹¤ìš´ìŠ¤íŠ¸ë¦¼(ì™¸ë¶€) íŒ¨í‚· ë‚´ë¶€ì˜ TLS íŠ¸ë˜í”½ì„ ì—…ìŠ¤íŠ¸ë¦¼(ë°±ì—”ë“œ)ë¡œ ì „ë‹¬</li>
  <li>í•˜ì§€ë§Œ ì´ëŸ¬í•œ ë™ì‘ì€ Source IP Visibility ë¬¸ì œë¥¼ ë°œìƒì‹œí‚¬ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì™œëƒí•˜ë©´ Envoyê°€ TLS ìŠ¤íŠ¸ë¦¼ì˜ TCP í”„ë¡ì‹œë¥¼ ìˆ˜í–‰í•˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
  <li>ìƒˆë¡œìš´ TCP ìŠ¤íŠ¸ë¦¼ì´ ìƒê¸°ê¸° ë•Œë¬¸ì— ë°±ì—”ë“œì—ì„œ ë°”ë¼ë³¸ ì†ŒìŠ¤ IPëŠ” Envoy(Cilium êµ¬ì„±ì— ë”°ë¼ Node IPì¸ ê²½ìš°ê°€ ë§ìŒ)ì…ë‹ˆë‹¤.</li>
  <li>ì¦‰, TLS Passthroughë¥¼ ì‚¬ìš©í•˜ë©´ ë°±ì—”ë“œëŠ” Envoyì˜ IP ì£¼ì†Œë¥¼ ì†ŒìŠ¤ IPë¡œ ë°›ê²Œë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="ingress-path-typeê³¼-ìš°ì„ ìˆœìœ„">Ingress Path Typeê³¼ ìš°ì„ ìˆœìœ„</h5>

<ul>
  <li>Ingress ê·œê²©ì€ ë‹¤ìŒì˜ ì„¸ê°€ì§€ íƒ€ì…ì˜ ê²½ë¡œë¥¼ ì§€ì›í•©ë‹ˆë‹¤.
    <ul>
      <li>ì •í™•í•œ ê°’ (<code class="language-plaintext highlighter-rouge">Exact</code>) : ê²½ë¡œê°€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>ì ‘ë‘ì‚¬ (<code class="language-plaintext highlighter-rouge">Prefix</code>) : ê²½ë¡œê°€ <code class="language-plaintext highlighter-rouge">/</code>ë¡œ êµ¬ë¶„ë˜ëŠ” ì§€ì •ëœ ì ‘ë‘ì‚¬ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.
        <ul>
          <li>ë§ˆì§€ë§‰ ë¶€ë¶„ì€ ì˜¨ì „íˆ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ë“¤ì–´ì„œ prefixê°€ <code class="language-plaintext highlighter-rouge">/foo/bar</code>ì¸ ê²½ìš° <code class="language-plaintext highlighter-rouge">/foo/bar/baz</code>ëŠ” ì¼ì¹˜í•˜ì§€ë§Œ <code class="language-plaintext highlighter-rouge">/foo/barbaz</code>ëŠ” ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>êµ¬í˜„ ì¢…ì† (<code class="language-plaintext highlighter-rouge">ImplementationSpecific</code>) : Ingress Controllerì— ë”°ë¼ ë‹¤ë¥´ê²Œ ë™ì‘í•©ë‹ˆë‹¤.
        <ul>
          <li>Cilium Ingressì˜ ê²½ìš°ì—ëŠ” <code class="language-plaintext highlighter-rouge">Regex</code>, ì¦‰, ì •ê·œí‘œí˜„ì‹ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ingressì— ëŒ€í•´ì„œ ì—¬ëŸ¬ ê²½ë¡œê°€ êµ¬ì„±ë˜ì–´ìˆìœ¼ë©´ ë‹¤ìŒì˜ ìˆœì„œë¡œ ë§¤ì¹­í•©ë‹ˆë‹¤
    <ol>
      <li>ì •í™•í•œ ê°’ (<code class="language-plaintext highlighter-rouge">Exact</code>)</li>
      <li>êµ¬í˜„ ì¢…ì† (<code class="language-plaintext highlighter-rouge">ImplementationSpecific</code>)</li>
      <li>ì ‘ë‘ì‚¬ (<code class="language-plaintext highlighter-rouge">Prefix</code>)</li>
      <li><code class="language-plaintext highlighter-rouge">/</code> ì ‘ë‘ì‚¬ ì²˜ë¦¬</li>
    </ol>
  </li>
  <li>ë˜í•œ ë™ì¼í•œ ê²½ë¡œ íƒ€ì…ì¸ ê²½ìš° ê²½ë¡œì˜ ê¸¸ì´ê°€ ê¸´ ê²½ë¡œê°€ ìš°ì„ ìˆœìœ„ê°€ ë†’ìŠµë‹ˆë‹¤. ì˜ˆë¥¼ë“¤ì–´ì„œ <code class="language-plaintext highlighter-rouge">/foo/bar</code>ì™€ <code class="language-plaintext highlighter-rouge">/foo</code>ê°€ ìˆì„ë•Œ <code class="language-plaintext highlighter-rouge">/foo/bar</code>ê°€ ìš°ì„ ìˆœìœ„ê°€ ë†’ìŠµë‹ˆë‹¤.</li>
  <li>ë§Œì•½ êµ¬í˜„ ì¢…ì† ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤ë©´ <code class="language-plaintext highlighter-rouge">*</code>ì„ ì‚¬ìš©í• ë•Œ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">*</code>ë¬¸ìë¡œ ì¸í•´ì„œ ê¸¸ì´ê°€ ê¸¸ì–´ì§€ì§€ë§Œ, ì‹¤ì œ ë§¤ì¹­ë˜ëŠ” ê²½ë¡œëŠ” ë” ì§§ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>ì˜ˆë¥¼ë“¤ì–´ì„œ <code class="language-plaintext highlighter-rouge">/foo/bar/</code>ì™€ <code class="language-plaintext highlighter-rouge">/foo/bar/*</code>ê°€ ìˆì„ë•Œ, <code class="language-plaintext highlighter-rouge">/foo/bar/*</code>ëŠ” <code class="language-plaintext highlighter-rouge">/foo/bar/</code>ì—ë„ ë§¤ì¹­ì´ ë˜ì§€ë§Œ, ê¸¸ì´ê°€ ê¸¸ì–´ì„œ 
<code class="language-plaintext highlighter-rouge">/foo/bar/</code>ë³´ë‹¤ ìš°ì„ ìˆœìœ„ê°€ ë†’ìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ê²½ìš° ì—‰ëš±í•œ ë°±ì—”ë“œë¡œ íŠ¸ë˜í”½ì´ ì „ë‹¬ë  ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì¶”ê°€ì ì¸ ì‚¬í•­ì€ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/network/servicemesh/path-types/#gs-ingress-path-types">Docs</a></li>
</ul>

<h5 id="ebpf-datapath--ingress-to-endpoint">eBPF Datapath : Ingress to Endpoint</h5>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_7.png" alt="img.png" class="image-center image-bg" />
<em class="image-caption"><a href="https://docs.cilium.io/en/stable/network/ebpf/lifeofapacket/#ingress-to-endpoint">https://docs.cilium.io/en/stable/network/ebpf/lifeofapacket/#ingress-to-endpoint</a></em></p>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/ebpf/">ì°¸ê³  ë¬¸ì„œ</a>, <a href="https://www.youtube.com/watch?v=0BKU6avwS98">Youtube</a></li>
</ul>

<h5 id="cilium-k8s-ingress-support-ê´€ë ¨-ì •ë³´-í™•ì¸">Cilium K8S Ingress Support ê´€ë ¨ ì •ë³´ í™•ì¸</h5>

<ul>
  <li>Cilium Ingressì™€  Cilium Gateway APIëŠ” ë™ì‹œ í™œì„±í™”ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¨, ë‹¤ë¥¸ Ingress Controllerì™€ Cilium Gateway APIëŠ” í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium ì„¤ì¹˜ ì‹œ ì•„ë˜ íŒŒë¼ë¯¸í„° ì ìš©ë˜ì–´ ìˆìŒ</span>
<span class="c">## --set ingressController.enabled=true</span>
<span class="c">## --set ingressController.loadbalancerMode=shared</span>
<span class="c">## --set loadBalancer.l7.backend=envoy \</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'^loadbalancer|l7'</span>
<span class="c"># =&gt; enable-l7-proxy                                   true</span>
<span class="c">#    loadbalancer-l7                                   envoy</span>
<span class="c">#    loadbalancer-l7-algorithm                         round_robin</span>
<span class="c">#    loadbalancer-l7-ports</span>

<span class="c"># ingress ì— ì˜ˆì•½ëœ ë‚´ë¶€ IP í™•ì¸ : node(cilium-envoy) ë³„ë¡œ ì¡´ì¬</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium ip list | <span class="nb">grep </span>ingress
<span class="c"># =&gt; 172.20.0.16/32      reserved:ingress</span>
<span class="c">#    172.20.1.60/32      reserved:ingress</span>

<span class="c"># cilium-envoy í™•ì¸</span>
<span class="nv">$ </span>kubectl get ds <span class="nt">-n</span> kube-system cilium-envoy <span class="nt">-owide</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium-envoy <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 READY   STATUS    RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    cilium-envoy-b25zf   1/1     Running   0          2m50s   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    cilium-envoy-hpsbc   1/1     Running   0          4m37s   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>

<span class="nv">$ </span>kc describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium-envoy
<span class="c"># =&gt; ...</span>
<span class="c">#    Containers:</span>
<span class="c">#      cilium-envoy:</span>
<span class="c">#        Container ID:  containerd://db82015552f31d7a16d8cada0883cdc7a4f75d39f36e76e0c582b10b1f3988e4</span>
<span class="c">#        Image:         quay.io/cilium/cilium-envoy:v1.34.4-1754895458-68cffdfa568b6b226d70a7ef81fc65dda3b890bf@sha256:247e908700012f7ef56f75908f8c965215c26a27762f296068645eb55450bda2</span>
<span class="c">#        Image ID:      quay.io/cilium/cilium-envoy@sha256:247e908700012f7ef56f75908f8c965215c26a27762f296068645eb55450bda2</span>
<span class="c">#        Port:          9964/TCP</span>
<span class="c">#        Host Port:     9964/TCP</span>
<span class="c">#        Command:</span>
<span class="c">#          /usr/bin/cilium-envoy-starter</span>
<span class="c">#        Args:</span>
<span class="c">#          --</span>
<span class="c">#          -c /var/run/cilium/envoy/bootstrap-config.json</span>
<span class="c">#          --base-id 0</span>
<span class="c">#        ...</span>
<span class="c">#        Mounts:</span>
<span class="c">#          /sys/fs/bpf from bpf-maps (rw)</span>
<span class="c">#          /var/run/cilium/envoy/ from envoy-config (ro)</span>
<span class="c">#          /var/run/cilium/envoy/artifacts from envoy-artifacts (ro)</span>
<span class="c">#          /var/run/cilium/envoy/sockets from envoy-sockets (rw)</span>
<span class="c">#          /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-jxsqh (ro)</span>
<span class="c">#    ...</span>
<span class="c">#    Volumes:</span>
<span class="c">#      envoy-sockets:</span>
<span class="c">#        Type:          HostPath (bare host directory volume)</span>
<span class="c">#        Path:          /var/run/cilium/envoy/sockets</span>
<span class="c">#        HostPathType:  DirectoryOrCreate</span>
<span class="c">#      envoy-artifacts:</span>
<span class="c">#        Type:          HostPath (bare host directory volume)</span>
<span class="c">#        Path:          /var/run/cilium/envoy/artifacts</span>
<span class="c">#        HostPathType:  DirectoryOrCreate</span>
<span class="c">#      envoy-config:</span>
<span class="c">#        Type:      ConfigMap (a volume populated by a ConfigMap)</span>
<span class="c">#        Name:      cilium-envoy-config</span>
<span class="c">#        Optional:  false</span>
<span class="c">#      bpf-maps:</span>
<span class="c">#        Type:          HostPath (bare host directory volume)</span>
<span class="c">#        Path:          /sys/fs/bpf</span>
<span class="c">#        HostPathType:  DirectoryOrCreate</span>
<span class="c">#      kube-api-access-jxsqh:</span>
<span class="c">#        Type:                    Projected (a volume that contains injected data from multiple sources)</span>
<span class="c">#        TokenExpirationSeconds:  3607</span>
<span class="c">#        ConfigMapName:           kube-root-ca.crt</span>
<span class="c">#        Optional:                false</span>
<span class="c">#        DownwardAPI:             true</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /var/run/cilium/envoy/sockets
<span class="c"># =&gt; ...</span>
<span class="c">#    srw-rw---- 1 root 1337   0 Aug 23 14:20 access_log.sock</span>
<span class="c">#    srwxr-xr-x 1 root root   0 Aug 23 14:19 admin.sock</span>
<span class="c">#    drwxr-xr-x 3 root root  60 Aug 23 14:20 envoy</span>
<span class="c">#    srw-rw---- 1 root 1337   0 Aug 23 14:20 xds.sock</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium-envoy <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-al</span> /var/run/cilium/envoy
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium-envoy <span class="nt">--</span> <span class="nb">cat</span> /var/run/cilium/envoy/bootstrap-config.json
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium-envoy <span class="nt">--</span> <span class="nb">cat</span> /var/run/cilium/envoy/bootstrap-config.json <span class="o">&gt;</span> envoy.json
<span class="nv">$ </span><span class="nb">cat </span>envoy.json | jq

<span class="c"># envoy configmap ì„¤ì • ë‚´ìš© í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get configmap cilium-envoy-config
<span class="c"># =&gt; NAME                  DATA   AGE</span>
<span class="c">#    cilium-envoy-config   1      7m54s</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get configmap cilium-envoy-config <span class="nt">-o</span> json <span class="se">\</span>
  | jq <span class="nt">-r</span> <span class="s1">'.data["bootstrap-config.json"]'</span> <span class="se">\</span>
  | jq <span class="nb">.</span>
<span class="c"># =&gt; ...</span>
<span class="c">#      "admin": {</span>
<span class="c">#        "address": {</span>
<span class="c">#          "pipe": {</span>
<span class="c">#            "path": "/var/run/cilium/envoy/sockets/admin.sock"</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      },</span>
<span class="c">#    ...</span>
<span class="c">#        "listeners": [</span>
<span class="c">#          {</span>
<span class="c">#            "address": {</span>
<span class="c">#              "socketAddress": {</span>
<span class="c">#                "address": "0.0.0.0",</span>
<span class="c">#                "portValue": 9964  </span>
<span class="c">#    ...</span>

<span class="nv">$ </span>tree /sys/fs/bpf
<span class="c"># =&gt; /sys/fs/bpf</span>
<span class="c">#    â”œâ”€â”€ cilium</span>
<span class="c">#    â”‚   â”œâ”€â”€ devices</span>
<span class="c">#    â”‚   â”‚   â”œâ”€â”€ cilium_host</span>
<span class="c">#    â”‚   â”‚   â”‚   â””â”€â”€ links</span>
<span class="c">#    â”‚   â”‚   â”‚       â”œâ”€â”€ cil_from_host</span>
<span class="c">#    â”‚   â”‚   â”‚       â””â”€â”€ cil_to_host</span>
<span class="c">#    â”‚   â”‚   â”œâ”€â”€ cilium_net</span>
<span class="c">#    â”‚   â”‚   â”‚   â””â”€â”€ links</span>
<span class="c">#    â”‚   â”‚   â”‚       â””â”€â”€ cil_to_host</span>
<span class="c">#    â”‚   â”‚   â”œâ”€â”€ eth0</span>
<span class="c">#    â”‚   â”‚   â”‚   â””â”€â”€ links</span>
<span class="c">#    â”‚   â”‚   â”‚       â”œâ”€â”€ cil_from_netdev</span>
<span class="c">#    â”‚   â”‚   â”‚       â””â”€â”€ cil_to_netdev</span>
<span class="c">#    â”‚   â”‚   â””â”€â”€ eth1</span>
<span class="c">#    â”‚   â”‚       â””â”€â”€ links</span>
<span class="c">#    â”‚   â”‚           â”œâ”€â”€ cil_from_netdev</span>
<span class="c">#    â”‚   â”‚           â””â”€â”€ cil_to_netdev</span>
<span class="c">#    â”‚   â”œâ”€â”€ endpoints</span>
<span class="c">#    â”‚   â”‚   â”œâ”€â”€ 1019</span>
<span class="c">#    â”‚   â”‚   â”‚   â””â”€â”€ links</span>
<span class="c">#    â”‚   â”‚   â”‚       â”œâ”€â”€ cil_from_container</span>
<span class="c">#    â”‚   â”‚   â”‚       â””â”€â”€ cil_to_container</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> kube-system cilium-envoy
<span class="c"># =&gt; NAME                   TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/cilium-envoy   ClusterIP   None         &lt;none&gt;        9964/TCP   9m24s</span>
<span class="c">#    </span>
<span class="c">#    NAME                     ENDPOINTS                                 AGE</span>
<span class="c">#    endpoints/cilium-envoy   192.168.10.100:9964,192.168.10.101:9964   9m22s</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> kube-system cilium-ingress
<span class="c"># =&gt; NAME                     TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE</span>
<span class="c">#    service/cilium-ingress   LoadBalancer   10.96.58.190   &lt;pending&gt;     80:32243/TCP,443:30329/TCP   9m35s</span>
<span class="c">#    </span>
<span class="c">#    NAME                       ENDPOINTS              AGE</span>
<span class="c">#    endpoints/cilium-ingress   192.192.192.192:9999   9m35s  # Cilium â†’ Envoy ê°„ì˜ ì œì–´ ì±„ë„(Control Plane), ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ê·¼í•˜ëŠ” ë°ì´í„° ì±„ë„ì´ ì•„ë‹˜ </span>
</code></pre></div></div>

<h5 id="lb-ipam-ì„¤ì •-í›„-í™•ì¸--ciliuml2announcementpolicy">LB-IPAM ì„¤ì • í›„ í™•ì¸ : CiliumL2AnnouncementPolicy</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í˜„ì¬ L2 Announcement í™œì„±í™” ìƒíƒœ</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>l2
<span class="c"># =&gt; enable-l2-announcements                           true</span>
<span class="c">#    enable-l2-neigh-discovery                         false</span>

<span class="c"># ì¶©ëŒë‚˜ì§€ ì•ŠëŠ”ì§€ ëŒ€ì—­ í™•ì¸ í•  ê²ƒ!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2" 
kind: CiliumLoadBalancerIPPool
metadata:
  name: "cilium-lb-ippool"
spec:
  blocks:
  - start: "192.168.10.211"
    stop:  "192.168.10.215"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumloadbalancerippool.cilium.io/cilium-lb-ippool created</span>
<span class="nv">$ </span>kubectl get ippool
<span class="c"># =&gt; NAME               DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-lb-ippool   false      False         4               7s</span>
<span class="nv">$ </span>kubectl get ippools <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].status.conditions[?(@.type!="cilium.io/PoolConflict")]}'</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "lastTransitionTime": "2025-08-23T06:40:43Z",</span>
<span class="c">#      "message": "5",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsTotal"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "lastTransitionTime": "2025-08-23T06:40:43Z",</span>
<span class="c">#      "message": "4",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsAvailable"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "lastTransitionTime": "2025-08-23T06:40:43Z",</span>
<span class="c">#      "message": "1",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsUsed"</span>
<span class="c">#    }</span>

<span class="c"># L2 Announcement ì •ì±… ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2alpha1"
kind: CiliumL2AnnouncementPolicy
metadata:
  name: policy1
spec:
  interfaces:
  - eth1
  externalIPs: true
  loadBalancerIPs: true
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliuml2announcementpolicy.cilium.io/policy1 created</span>

<span class="c"># í˜„ì¬ ë¦¬ë” ì—­í•  ë…¸ë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; cilium-l2announce-kube-system-cilium-ingress  k8s-w1  16s</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease/cilium-l2announce-kube-system-cilium-ingress <span class="nt">-o</span> yaml | yq

<span class="c"># K8S í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ LB EX-IPë¡œ í˜¸ì¶œ ê°€ëŠ¥</span>
<span class="nv">$ LBIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> kube-system cilium-ingress <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$LBIP</span>
<span class="c"># =&gt; 192.168.10.211</span>
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 2
<span class="c"># =&gt; ARPING 192.168.10.211</span>
<span class="c">#    60 bytes from 08:00:27:12:18:4f (192.168.10.211): index=0 time=3.241 msec</span>
<span class="c">#    60 bytes from 08:00:27:12:18:4f (192.168.10.211): index=1 time=184.759 usec</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.10.211 statistics ---</span>
<span class="c">#    2 packets transmitted, 2 packets received,   0% unanswered (0 extra)</span>
<span class="c">#    rtt min/avg/max/std-dev = 0.185/1.713/3.241/1.528 ms</span>

<span class="c"># k8s ì™¸ë¶€ ë…¸ë“œ(router)ì—ì„œ LB EX-IPë¡œ í˜¸ì¶œ ê°€ëŠ¥ í™•ì¸</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="nb">sudo </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 2
<span class="c"># =&gt; ARPING 192.168.10.211</span>
<span class="c">#    60 bytes from 08:00:27:12:18:4f (192.168.10.211): index=0 time=385.109 usec</span>
<span class="c">#    60 bytes from 08:00:27:12:18:4f (192.168.10.211): index=1 time=384.192 usec</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.10.211 statistics ---</span>
<span class="c">#    2 packets transmitted, 2 packets received,   0% unanswered (0 extra)</span>
<span class="c">#    rtt min/avg/max/std-dev = 0.384/0.385/0.385/0.000 ms</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s ì™¸ë¶€ ë…¸ë“œì—ì„œ LB EX-IPë¡œ í˜¸ì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="ingress-http-example--xff-í™•ì¸">Ingress HTTP Example : XFF í™•ì¸</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/http/">ê´€ë ¨ë¬¸ì„œ</a></li>
  <li>ì´ë²ˆ ì˜ˆì œì—ì„œëŠ” ingressë¥¼ í†µí•´ íŠ¸ë˜í”½ì„ Istio í”„ë¡œì íŠ¸ì—ì„œ ì œê³µí•˜ëŠ” <a href="https://istio.io/latest/docs/examples/bookinfo/">Bookinfo</a> ë°±ì—”ë“œë¡œ ë¼ìš°íŒ…í•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Deploy the Demo App : ê³µì‹ ë¬¸ì„œëŠ” release-1.11 ë¡œ ARM CPU ì—ì„œ ì‹¤íŒ¨í•œë‹¤. 1.26 ë²„ì „ì„ ë†’ì—¬ì„œ ìƒ˜í”Œ ë°°í¬ í•  ê²ƒ!</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/istio/istio/release-1.26/samples/bookinfo/platform/kube/bookinfo.yaml
<span class="c"># =&gt; ...</span>
<span class="c">#    service/productpage created</span>
<span class="c">#    serviceaccount/bookinfo-productpage created</span>
<span class="c">#    deployment.apps/productpage-v1 created</span>

<span class="nv">$ </span>kubectl get pod,svc,ep
<span class="c"># =&gt; NAME                                  READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/details-v1-766844796b-fwxlh       &lt;span style="color: green;"&gt;1/1&lt;/span&gt;     Running   0          81s</span>
<span class="c">#    pod/productpage-v1-54bb874995-5zh9b   &lt;span style="color: green;"&gt;1/1&lt;/span&gt;     Running   0          81s</span>
<span class="c">#    pod/ratings-v1-5dc79b6bcd-l4fw4       &lt;span style="color: green;"&gt;1/1&lt;/span&gt;     Running   0          81s</span>
<span class="c">#    pod/reviews-v1-598b896c9d-wxrrw       &lt;span style="color: green;"&gt;1/1&lt;/span&gt;     Running   0          81s</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAME                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/details       &lt;span style="color: green;"&gt;ClusterIP&lt;/span&gt;   10.96.68.221    &lt;none&gt;        9080/TCP   81s</span>
<span class="c">#    service/kubernetes    &lt;span style="color: green;"&gt;ClusterIP&lt;/span&gt;   10.96.0.1       &lt;none&gt;        443/TCP    92m</span>
<span class="c">#    service/productpage   &lt;span style="color: green;"&gt;ClusterIP&lt;/span&gt;   10.96.86.254    &lt;none&gt;        9080/TCP   81s</span>
<span class="c">#    service/ratings       &lt;span style="color: green;"&gt;ClusterIP&lt;/span&gt;   10.96.108.142   &lt;none&gt;        9080/TCP   81s</span>
<span class="c">#    service/reviews       &lt;span style="color: green;"&gt;ClusterIP&lt;/span&gt;   10.96.47.199    &lt;none&gt;        9080/TCP   81s</span>
<span class="c">#    </span>
<span class="c">#    NAME                    ENDPOINTS                                               AGE</span>
<span class="c">#    endpoints/details       172.20.1.185:9080                                       81s</span>
<span class="c">#    endpoints/kubernetes    192.168.10.100:6443                                     92m</span>
<span class="c">#    endpoints/productpage   172.20.1.100:9080                                       81s</span>
<span class="c">#    endpoints/ratings       172.20.1.247:9080                                       81s</span>
<span class="c">#    endpoints/reviews       172.20.1.114:9080,172.20.1.186:9080,172.20.1.232:9080   81s</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ istio ì™€ ë‹¤ë¥´ê²Œ ì‚¬ì´ë“œì¹´ ì»¨í…Œì´ë„ˆê°€ ì—†ì–´ì„œ íŒŒë“œê°€ 1ê°œì˜ (1/1) ì»¨í…Œì´ë„ˆë¡œ ë™ì‘í•©ë‹ˆë‹¤. NodePortì™€ LoadBalancer ì„œë¹„ìŠ¤ë„ ì—†ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># </span>
<span class="nv">$ </span>kc describe ingressclasses.networking.k8s.io
<span class="c"># =&gt; Name:         cilium</span>
<span class="c">#    Labels:       app.kubernetes.io/managed-by=Helm</span>
<span class="c">#    Annotations:  meta.helm.sh/release-name: cilium</span>
<span class="c">#                  meta.helm.sh/release-namespace: kube-system</span>
<span class="c">#    Controller:   cilium.io/ingress-controller</span>
<span class="c">#    Events:       &lt;none&gt;</span>
<span class="nv">$ </span>kubectl get ingressclasses.networking.k8s.io
<span class="c"># =&gt; NAME     CONTROLLER                     PARAMETERS   AGE</span>
<span class="c">#    cilium   cilium.io/ingress-controller   &lt;none&gt;       94m</span>


<span class="c"># Basic ingress for istio bookinfo demo application, which can be found in below</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: basic-ingress
  namespace: default
spec:
  ingressClassName: cilium
  rules:
  - http:
      paths:
      - backend:
          service:
            name: details
            port:
              number: 9080
        path: /details
        pathType: Prefix
      - backend:
          service:
            name: productpage
            port:
              number: 9080
        path: /
        pathType: Prefix
</span><span class="no">EOF
</span><span class="c"># =&gt; ingress.networking.k8s.io/basic-ingress created</span>

<span class="c"># Adress ëŠ” cilium-ingress LoadBalancer ì˜ EX-IP</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> kube-system cilium-ingress
<span class="c"># =&gt; NAME             TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                      AGE</span>
<span class="c">#    cilium-ingress   LoadBalancer   10.96.58.190   192.168.10.211   80:32243/TCP,443:30329/TCP   95m</span>

<span class="nv">$ </span>kubectl get ingress
<span class="c"># =&gt; NAME            CLASS    HOSTS   ADDRESS          PORTS   AGE</span>
<span class="c">#    basic-ingress   cilium   *       192.168.10.211   80      34s</span>

<span class="nv">$ </span>kc describe ingress
<span class="c"># =&gt; ...</span>
<span class="c">#    Rules:</span>
<span class="c">#      Host        Path  Backends</span>
<span class="c">#      ----        ----  --------</span>
<span class="c">#      *</span>
<span class="c">#                  /details   details:9080 (172.20.1.185:9080)</span>
<span class="c">#                  /          productpage:9080 (172.20.1.100:9080)</span>

<span class="c"># í˜¸ì¶œ í™•ì¸</span>
<span class="nv">$ LBIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> kube-system cilium-ingress <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$LBIP</span>
<span class="c"># =&gt; 192.168.10.211</span>

<span class="c"># ì‹¤íŒ¨í•˜ëŠ” í˜¸ì¶œì´ ìˆëŠ”ê°€?</span>
<span class="nv">$ </span>curl <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> http://<span class="nv">$LBIP</span>/
<span class="c"># =&gt; 200</span>
<span class="nv">$ </span>curl <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> http://<span class="nv">$LBIP</span>/details/1
<span class="c"># =&gt; 200</span>
<span class="nv">$ </span>curl <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> http://<span class="nv">$LBIP</span>/ratings
<span class="c"># =&gt; 404</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì•ì„œ ì‚´í´ë³¸ ingress ë£°ì—ëŠ” /ratingsê°€ ì—†ê³ , `/`ë¥¼ ë‹´ë‹¹í•˜ëŠ” productpageì—ì„œë„ ì²˜ë¦¬í•˜ì§€ ì•ŠëŠ” URLì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># Access the Bookinfo application</span>
<span class="nv">$ </span>curl <span class="s2">"http://</span><span class="nv">$LBIP</span><span class="s2">/productpage?u=normal"</span>

<span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; â„¹ï¸   Hubble Relay is available at 127.0.0.1:4245</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">-t</span> l7
<span class="c"># or </span>
<span class="c"># $ hubble observe -f --identity ingress</span>
<span class="c"># =&gt; ...</span>

<span class="c"># routerì—ì„œ í˜¸ì¶œ</span>
<span class="nv">$ </span>curl <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> http://<span class="nv">$LBIP</span>/
<span class="c"># =&gt; 200</span>
<span class="nv">$ </span>curl <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> http://<span class="nv">$LBIP</span>/details/1
<span class="c"># =&gt; 200</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LBIP</span>/
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LBIP</span>/details/1 <span class="nt">-v</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    &lt; server: envoy</span>
<span class="c">#    &lt; date: Sat, 23 Aug 2025 07:06:51 GMT</span>
<span class="c">#    &lt; content-length: 178</span>
<span class="c">#    &lt; x-envoy-upstream-service-time: 18</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LBIP</span>/ratings
<span class="c"># =&gt; &lt;!doctype html&gt;</span>
<span class="c">#    &lt;html lang=en&gt;</span>
<span class="c">#    &lt;title&gt;404 Not Found&lt;/title&gt;</span>
<span class="c">#    &lt;h1&gt;Not Found&lt;/h1&gt;</span>
<span class="c">#    &lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;</span>

<span class="c"># productpage-v1 íŒŒë“œê°€ ë°°í¬ëœ ë…¸ë“œ í™•ì¸ </span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>productpage <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                              READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    productpage-v1-54bb874995-5zh9b   1/1     Running   0          17m   172.20.1.100   k8s-w1   &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># í•´ë‹¹ ë…¸ë“œ(k8s-w1)ì—ì„œ veth ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1
<span class="nt">---</span>
<span class="nv">$ PROID</span><span class="o">=</span>172.20.1.100

<span class="nv">$ </span>ip route |grep <span class="nv">$PROID</span>
<span class="c"># =&gt; 172.20.1.100 dev &lt;span style="color: green;"&gt;lxcdd0576ed651e&lt;/span&gt; proto kernel scope link</span>

<span class="nv">$ PROVETH</span><span class="o">=</span>lxcdd0576ed651e

<span class="c"># ngrep ë¡œ veth íŠ¸ë˜í”½ ìº¡ì³ : productpage ëŠ” 9080 TCP Port ì‚¬ìš©</span>
<span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> <span class="nv">$PROVETH</span> <span class="s1">''</span> <span class="s1">'tcp port 9080'</span>

<span class="c"># ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ì‹œë„</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LBIP</span>

<span class="c"># ngrep ë¡œ veth íŠ¸ë˜í”½ ìº¡ì³ : productpage ëŠ” 9080 TCP Port ì‚¬ìš©</span>
<span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> <span class="nv">$PROVETH</span> <span class="s1">''</span> <span class="s1">'tcp port 9080'</span>
<span class="c"># =&gt; &lt;span style="color: green;"&gt;## igress(envoy) ê°€ XFFì— client-ip ë‹´ê³ , ëª©ì ì§€ íŒŒë“œë¡œ ìš”ì²­&lt;/span&gt;</span>
<span class="c">#    T 2025/08/23 16:10:12.309006 10.0.2.15:32780 -&gt; 172.20.1.100:9080 [AP] #4</span>
<span class="c">#    GET / HTTP/1.1.</span>
<span class="c">#    host: 192.168.10.211.</span>
<span class="c">#    user-agent: curl/8.5.0.</span>
<span class="c">#    accept: */*.</span>
<span class="c">#    &lt;span style="color: green;"&gt;x-forwarded-for: 192.168.10.200.&lt;/span&gt;</span>
<span class="c">#    x-forwarded-proto: http.</span>
<span class="c">#    x-envoy-internal: true.</span>
<span class="c">#    x-request-id: 6d2bda20-5f73-41d3-ac90-159cd56a2386.</span>
<span class="c">#    .</span>
<span class="c">#    </span>
<span class="c">#    &lt;span style="color: green;"&gt;## igress(envoy)ë¡œ ë¦¬í„´í•˜ëŠ” íŠ¸ë˜í”½&lt;/span&gt;</span>
<span class="c">#    T 2025/08/23 16:10:12.325238 172.20.1.100:9080 -&gt; 10.0.2.15:32780 [AP] #6</span>
<span class="c">#    HTTP/1.1 200 OK.</span>
<span class="c">#    Server: gunicorn.</span>
<span class="c">#    Date: Sat, 23 Aug 2025 07:10:12 GMT.</span>
<span class="c">#    Connection: keep-alive.</span>
<span class="c">#    Content-Type: text/html; charset=utf-8.</span>
<span class="c">#    Content-Length: 2080.</span>
</code></pre></div></div>

<h3 id="ingress-nginx-ì„¤ì¹˜í•˜ì—¬-cilium-ingressì™€-ê³µì¡´-ê°€ëŠ¥ì—¬ë¶€-í™•ì¸">Ingress-Nginx ì„¤ì¹˜í•˜ì—¬ Cilium Ingressì™€ ê³µì¡´ ê°€ëŠ¥ì—¬ë¶€ í™•ì¸</h3>

<ul>
  <li>ì´ë²ˆì—ëŠ” Cilium ingressì™€ Ingress-Nginxê°€ ë™ì‹œì— í™œì„±í™” ë  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Ingress-Nginx ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì¹˜</span>
<span class="nv">$ </span>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
<span class="c"># =&gt; "ingress-nginx" has been added to your repositories</span>
<span class="nv">$ </span>helm <span class="nb">install </span>ingress-nginx ingress-nginx/ingress-nginx <span class="nt">--create-namespace</span> <span class="nt">-n</span> ingress-nginx
<span class="c"># =&gt; NAME: ingress-nginx</span>
<span class="c">#    LAST DEPLOYED: Sat Aug 23 16:18:18 2025</span>
<span class="c">#    NAMESPACE: ingress-nginx</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    The ingress-nginx controller has been installed.</span>
<span class="c">#    It may take a few minutes for the load balancer IP to be available.</span>
<span class="c">#    ...</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> ingress-nginx
<span class="c"># =&gt; NAME                                            READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/ingress-nginx-controller-67bbdf7d8d-qmtp2   1/1     Running   0          34s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                         TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                      AGE</span>
<span class="c">#    service/ingress-nginx-controller             LoadBalancer   10.96.45.145   192.168.10.212   80:32426/TCP,443:30289/TCP   35s</span>
<span class="c">#    service/ingress-nginx-controller-admission   ClusterIP      10.96.79.200   &lt;none&gt;           443/TCP                      35s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/ingress-nginx-controller   1/1     1            1           35s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                  DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/ingress-nginx-controller-67bbdf7d8d   1         1         1       34s</span>
<span class="nv">$ </span>kc describe svc <span class="nt">-n</span> ingress-nginx ingress-nginx-controller
<span class="c"># =&gt; Name:                     ingress-nginx-controller</span>
<span class="c">#    Namespace:                ingress-nginx</span>
<span class="c">#    ...</span>
<span class="c">#    LoadBalancer Ingress:     192.168.10.212 (VIP)</span>
<span class="c">#    Port:                     http  80/TCP</span>
<span class="c">#    TargetPort:               http/TCP</span>
<span class="c">#    NodePort:                 http  32426/TCP</span>
<span class="c">#    Endpoints:                172.20.1.154:80</span>
<span class="c">#    Port:                     https  443/TCP</span>
<span class="c">#    TargetPort:               https/TCP</span>
<span class="c">#    NodePort:                 https  30289/TCP</span>
<span class="c">#    Endpoints:                172.20.1.154:443</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> ingress-nginx
<span class="c"># =&gt; NAME                                 TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                      AGE</span>
<span class="c">#    ingress-nginx-controller             LoadBalancer   10.96.45.145   192.168.10.212   80:32426/TCP,443:30289/TCP   2m</span>
<span class="c">#    ingress-nginx-controller-admission   ClusterIP      10.96.79.200   &lt;none&gt;           443/TCP                      2m</span>
<span class="nv">$ </span>kubectl get ingressclasses.networking.k8s.io
<span class="c"># =&gt; NAME     CONTROLLER                     PARAMETERS   AGE</span>
<span class="c">#    cilium   cilium.io/ingress-controller   &lt;none&gt;       121m</span>
<span class="c">#    nginx    k8s.io/ingress-nginx           &lt;none&gt;       2m6s</span>

<span class="c"># ingress ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webpod-ingress-nginx
  namespace: default
spec:
  ingressClassName: nginx
  rules:
  - host: nginx.webpod.local
    http:
      paths:
      - backend:
          service:
            name: webpod
            port:
              number: 80
        path: /
        pathType: Prefix
</span><span class="no">EOF
</span><span class="c"># =&gt; ingress.networking.k8s.io/webpod-ingress-nginx created</span>

<span class="c"># ingress LB EX-IP í• ë‹¹ ê¹Œì§€ ë‹¤ì†Œ ì‹œê°„ ì†Œìš”..</span>
<span class="nv">$ </span>kubectl get ingress <span class="nt">-w</span>
<span class="c"># =&gt; NAME                   CLASS    HOSTS                ADDRESS          PORTS   AGE</span>
<span class="c">#    basic-ingress          cilium   *                    192.168.10.211   80      29m</span>
<span class="c">#    webpod-ingress-nginx   nginx    nginx.webpod.local   &lt;span style="color: green;"&gt;192.168.10.212&lt;/span&gt;   80      32s</span>

<span class="c">#</span>
<span class="nv">$ LB2IP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> ingress-nginx ingress-nginx-controller <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; 192.168.10.211</span>

<span class="nv">$ </span>curl <span class="nv">$LB2IP</span>
<span class="c"># =&gt; &lt;html&gt;</span>
<span class="c">#    &lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ nginx.webpod.local í˜¸ìŠ¤íŠ¸ëª…ì´ ì—†ì–´ì„œ 404 ì—ëŸ¬ ë°œìƒ&lt;/span&gt;</span>
<span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"Host: nginx.webpod.local"</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b5vtj</span>
<span class="c">#    IP: 172.20.0.70</span>
<span class="c">#    RemoteAddr: 172.20.1.154:40984</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: nginx.webpod.local</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    X-Forwarded-For: &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"Host: nginx.webpod.local"</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-jp4wc</span>
<span class="c">#    IP: 172.20.1.206</span>
<span class="c">#    RemoteAddr: 172.20.1.154:48320</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: nginx.webpod.local</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    X-Forwarded-For: 192.168.10.100</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s -H 'Host: nginx.webpod.local' </span><span class="nv">$LB2IP</span><span class="s2">"</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-jp4wc</span>
<span class="c">#    ...</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s -H 'Host: nginx.webpod.local' </span><span class="nv">$LB2IP</span><span class="s2">"</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b5vtj</span>
<span class="c">#    ...</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>Cilium Ingressì™€ Nginx ingressëŠ” ë™ì‹œ í™œì„±í™”ê°€ ê°€ëŠ¥í•˜ë©°, ê°ê°ì˜ EX-IPë¡œ ì •ìƒ í˜¸ì¶œì´ ê°€ëŠ¥í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="dedicated-mode">Dedicated Mode</h3>

<ul>
  <li>Cilium IngressëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Shared Modeë¡œ ë™ì‘í•©ë‹ˆë‹¤. Dedicated Modeë¡œ ë³€ê²½í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Basic ingress for istio bookinfo demo application, which can be found in below</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webpod-ingress
  namespace: default
  annotations:
    ingress.cilium.io/loadbalancer-mode: dedicated
spec:
  ingressClassName: cilium
  rules:
  - http:
      paths:
      - backend:
          service:
            name: webpod
            port:
              number: 80
        path: /
        pathType: Prefix
</span><span class="no">EOF
</span><span class="c"># =&gt; ingress.networking.k8s.io/webpod-ingress created</span>

<span class="c">#</span>
<span class="nv">$ </span>kc describe ingress webpod-ingress
<span class="c"># =&gt; Name:             webpod-ingress</span>
<span class="c">#    Labels:           &lt;none&gt;</span>
<span class="c">#    Namespace:        default</span>
<span class="c">#    Address:          192.168.10.213</span>
<span class="c">#    Ingress Class:    cilium</span>
<span class="c">#    Default backend:  &lt;default&gt;</span>
<span class="c">#    Rules:</span>
<span class="c">#      Host        Path  Backends</span>
<span class="c">#      ----        ----  --------</span>
<span class="c">#      *</span>
<span class="c">#                  /   webpod:80 (172.20.1.206:80,172.20.0.70:80)</span>
<span class="c">#    Annotations:  ingress.cilium.io/loadbalancer-mode: &lt;span style="color: green;"&gt;dedicated&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get ingress
<span class="c"># =&gt; NAME                   CLASS    HOSTS                ADDRESS          PORTS   AGE</span>
<span class="c">#    basic-ingress          cilium   *                    192.168.10.211   80      45m</span>
<span class="c">#    &lt;span style="color: green;"&gt;webpod-ingress&lt;/span&gt;         cilium   *                    192.168.10.213   80      29s</span>
<span class="c">#    webpod-ingress-nginx   nginx    nginx.webpod.local   192.168.10.212   80      16m</span>

<span class="nv">$ </span>kubectl get svc,ep cilium-ingress-webpod-ingress
<span class="c"># =&gt; NAME                                    TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                      AGE</span>
<span class="c">#    service/cilium-ingress-webpod-ingress   LoadBalancer   10.96.153.108   192.168.10.213   80:30159/TCP,443:30408/TCP   50s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                      ENDPOINTS              AGE</span>
<span class="c">#    endpoints/cilium-ingress-webpod-ingress   192.192.192.192:9999   50s</span>

<span class="c"># LB EX-IPì— ëŒ€í•œ L2 Announcement ì˜ Leader ë…¸ë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get lease <span class="nt">-n</span> kube-system | <span class="nb">grep </span>ingress
<span class="c"># =&gt; cilium-l2announce-default-cilium-ingress-webpod-ingress   k8s-w1  80s</span>
<span class="c">#    cilium-l2announce-ingress-nginx-ingress-nginx-controller  k8s-w1  21m</span>
<span class="c">#    cilium-l2announce-kube-system-cilium-ingress              k8s-w1  58m</span>

<span class="c"># webpod íŒŒë“œ IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE   IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    webpod-697b545f57-b5vtj   1/1     Running   0          12m   172.20.0.70    k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-jp4wc   1/1     Running   0          12m   172.20.1.206   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># k8c-ctr, k8s-w1 ë…¸ë“œì—ì„œ íŒŒë“œ IPì— veth ì°¾ê¸°(ip -c route) ì´í›„ ngrep ë¡œ ê°ê° íŠ¸ë˜í”½ ìº¡ì³</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-ctr
<span class="nt">---</span> 
<span class="nv">$ </span>ip route | <span class="nb">grep </span>172.20.0.70
<span class="c"># =&gt; 172.20.0.70 dev lxc148c311965e6 proto kernel scope link</span>
<span class="nv">$ WPODVETHCTR</span><span class="o">=</span>lxc148c311965e6
<span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> <span class="nv">$WPODVETHCTR</span> <span class="s1">''</span> <span class="s1">'tcp port 80'</span>
<span class="c"># =&gt; lxc148c311965e6: no IPv4 address assigned: Cannot assign requested address</span>
<span class="c">#    interface: lxc148c311965e6</span>
<span class="c">#    filter: ( tcp port 80 ) and ((ip || ip6) || (vlan &amp;&amp; (ip || ip6)))</span>
<span class="c">#    ###</span>
<span class="c">#    T 2025/08/23 16:48:28.123959 172.20.0.70:80 -&gt; 172.20.1.60:40517 [AP] #3</span>
<span class="c">#    HTTP/1.1 200 OK.</span>
<span class="c">#    Date: Sat, 23 Aug 2025 07:48:28 GMT.</span>
<span class="c">#    Content-Length: 343.</span>
<span class="c">#    Content-Type: text/plain; charset=utf-8.</span>
<span class="c">#    .</span>
<span class="c">#    Hostname: webpod-697b545f57-b5vtj</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.0.70</span>
<span class="c">#    IP: fe80::d46d:b0ff:fe0d:619a</span>
<span class="c">#    RemoteAddr: 172.20.1.60:40517</span>
<span class="c">#    GET / HTTP/1.1.</span>
<span class="c">#    Host: 192.168.10.213.</span>
<span class="c">#    User-Agent: curl/8.5.0.</span>
<span class="c">#    Accept: */*.</span>
<span class="c">#    X-Envoy-Internal: true.</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200.</span>
<span class="c">#    X-Forwarded-Proto: http.</span>
<span class="c">#    X-Request-Id: 01bd1da4-e1f1-47e7-958d-1032c55ec11b.</span>
<span class="c">#    ...</span>
<span class="nt">---</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1
<span class="nt">---</span> 
<span class="nv">$ </span>ip route | <span class="nb">grep </span>172.20.1.206
<span class="c"># =&gt; 172.20.1.206 dev lxc9e0d1071b53f proto kernel scope link</span>
<span class="nv">$ WPODVETHW1</span><span class="o">=</span>lxc9e0d1071b53f
<span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> <span class="nv">$WPODVETHW1</span> <span class="s1">''</span> <span class="s1">'tcp port 80'</span>
<span class="c"># =&gt; lxc9e0d1071b53f: no IPv4 address assigned: Cannot assign requested address</span>
<span class="c">#    interface: lxc9e0d1071b53f</span>
<span class="c">#    filter: ( tcp port 80 ) and ((ip || ip6) || (vlan &amp;&amp; (ip || ip6)))</span>
<span class="c">#    ####</span>
<span class="c">#    T 2025/08/23 16:48:29.296230 10.0.2.15:34958 -&gt; 172.20.1.206:80 [AP] #4</span>
<span class="c">#    GET / HTTP/1.1.</span>
<span class="c">#    host: 192.168.10.213.</span>
<span class="c">#    user-agent: curl/8.5.0.</span>
<span class="c">#    accept: */*.</span>
<span class="c">#    x-forwarded-for: 192.168.10.200.</span>
<span class="c">#    x-forwarded-proto: http.</span>
<span class="c">#    x-envoy-internal: true.</span>
<span class="c">#    x-request-id: 80e8099d-b64b-4f05-805e-72a4d670024f.</span>
<span class="c">#    .</span>
<span class="c">#    </span>
<span class="c">#    ##</span>
<span class="c">#    T 2025/08/23 16:48:29.300200 172.20.1.206:80 -&gt; 10.0.2.15:34958 [AP] #6</span>
<span class="c">#    HTTP/1.1 200 OK.</span>
<span class="c">#    Date: Sat, 23 Aug 2025 07:48:29 GMT.</span>
<span class="c">#    Content-Length: 342.</span>
<span class="c">#    Content-Type: text/plain; charset=utf-8.</span>
<span class="c">#    .</span>
<span class="c">#    Hostname: webpod-697b545f57-jp4wc</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.1.206</span>
<span class="c">#    IP: fe80::a4ee:c1ff:fed4:b3c3</span>
<span class="c">#    RemoteAddr: 10.0.2.15:34958</span>
<span class="c">#    GET / HTTP/1.1.</span>
<span class="c">#    Host: 192.168.10.213.</span>
<span class="c">#    User-Agent: curl/8.5.0.</span>
<span class="c">#    Accept: */*.</span>
<span class="c">#    X-Envoy-Internal: true.</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200.</span>
<span class="c">#    X-Forwarded-Proto: http.</span>
<span class="c">#    X-Request-Id: 80e8099d-b64b-4f05-805e-72a4d670024f.</span>
<span class="c">#    ...</span>
<span class="nt">---</span>

<span class="c"># router ì—ì„œ í˜¸ì¶œ í™•ì¸</span>
<span class="nv">$ LB2IP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc cilium-ingress-webpod-ingress <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LB2IP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-jp4wc</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.1.206</span>
<span class="c">#    IP: fe80::a4ee:c1ff:fed4:b3c3</span>
<span class="c">#    RemoteAddr: 10.0.2.15:34958  # webpod ì¸ì… ì‹œ S.IP : ë§ˆì¹˜ L2 Leader ë…¸ë“œì— webpodë¡œ ì „ë‹¬ë˜ì–´, ì†ŒìŠ¤IPê°€ í•´ë‹¹ ë…¸ë“œì˜ ì²« ë²ˆì§¸ NIC IP,</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 192.168.10.213</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    X-Envoy-Internal: true</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200</span>
<span class="c">#    X-Forwarded-Proto: http</span>
<span class="c">#    X-Request-Id: 80e8099d-b64b-4f05-805e-72a4d670024f</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LB2IP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b5vtj</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.0.70</span>
<span class="c">#    IP: fe80::d46d:b0ff:fe0d:619a</span>
<span class="c">#    RemoteAddr: 172.20.1.60:40517  # webpod ì¸ì… ì‹œ S.IP : L2 Leader ë…¸ë“œ(k8s-w1)ì—ì„œ ë‹¤ë¥¸ ë…¸ë“œì— íŒŒë“œë¡œ ì „ë‹¬ë˜ì–´, ingress ì˜ˆì•½IPë¡œ SNAT</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 192.168.10.213</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    X-Envoy-Internal: true</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200</span>
<span class="c">#    X-Forwarded-Proto: http</span>
<span class="c">#    X-Request-Id: 01bd1da4-e1f1-47e7-958d-1032c55ec11b</span>
</code></pre></div></div>

<h3 id="ingress-and-network-policies-example">Ingress and Network Policies Example</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress-and-network-policy/">ê´€ë ¨ ë¬¸ì„œ</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ì „ì²´(ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤)ì— ì ìš©ë˜ëŠ” ì •ì±… : ì°¸ê³ ë¡œ ì•„ë˜ ì •ì±… ì ìš© í›„ Hubble-ui ë¡œ ì ‘ì† ë¶ˆê°€!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: "external-lockdown"
spec:
  description: "Block all the traffic originating from outside of the cluster"
  endpointSelector: {}
  ingress:
  - fromEntities:
    - cluster
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumclusterwidenetworkpolicy.cilium.io/external-lockdown created</span>
<span class="nv">$ </span>kubectl get ciliumclusterwidenetworkpolicy
<span class="c"># =&gt; NAME                VALID</span>
<span class="c">#    external-lockdown   True</span>

<span class="c">#</span>
<span class="nv">$ </span>curl <span class="nt">--fail</span> <span class="nt">-v</span> http://<span class="s2">"</span><span class="nv">$LBIP</span><span class="s2">"</span>/details/1
<span class="c"># =&gt; &lt; HTTP/1.1 403 Forbidden</span>

<span class="c"># </span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--identity</span> ingress
<span class="c">## k8s-ctr ì—ì„œ curl ì‹¤í–‰ ì‹œ</span>
<span class="c"># =&gt; Aug 23 08:10:11.770: 127.0.0.1:36726 (ingress) -&gt; 127.0.0.1:15778 (world) http-request DROPPED (HTTP/1.1 GET http://192.168.10.211/details/1)</span>
<span class="c">#    Aug 23 08:10:11.770: 127.0.0.1:36726 (ingress) &lt;- 127.0.0.1:15778 (world) http-response FORWARDED (HTTP/1.1 403 1ms (GET http://192.168.10.211/details/1))</span>
<span class="c">## router ì—ì„œ curl ì‹¤í–‰ ì‹œ</span>
<span class="c"># =&gt; Aug 23 08:10:20.475: 192.168.10.200:43490 (ingress) -&gt; kube-system/cilium-ingress:80 (world) http-request DROPPED (HTTP/1.1 GET http://192.168.10.211/details/1)</span>
<span class="c">#    Aug 23 08:10:20.475: 192.168.10.200:43490 (ingress) &lt;- kube-system/cilium-ingress:80 (world) http-response FORWARDED (HTTP/1.1 403 0ms (GET http://192.168.10.211/details/1))</span>

<span class="c"># routerì™€ k8s-ctrì˜ ìš”ì²­ì€ í—ˆìš©í•˜ëŠ” ì •ì±… ì ìš© </span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: "allow-cidr"
spec:
  description: "Allow all the traffic originating from a specific CIDR"
  endpointSelector:
    matchExpressions:
    - key: reserved:ingress
      operator: Exists
  ingress:
  - fromCIDRSet:
    # Please update the CIDR to match your environment
    - cidr: 192.168.10.200/32
    - cidr: 127.0.0.1/32
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumclusterwidenetworkpolicy.cilium.io/allow-cidr created</span>

<span class="c"># ìš”ì²­ ì„±ê³µ! : k8s-ctr , router ëª¨ë‘ ê°€ëŠ¥</span>
<span class="nv">$ </span>curl <span class="nt">--fail</span> <span class="nt">-v</span> http://<span class="s2">"</span><span class="nv">$LBIP</span><span class="s2">"</span>/details/1
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s --fail -v http://"</span><span class="nv">$LBIP</span><span class="s2">"/details/1"</span>
<span class="c"># =&gt; *   Trying 192.168.10.211:80...</span>
<span class="c">#    * Connected to 192.168.10.211 (192.168.10.211) port 80</span>
<span class="c">#    &gt; GET /details/1 HTTP/1.1</span>
<span class="c">#    &gt; Host: 192.168.10.211</span>
<span class="c">#    &gt; User-Agent: curl/8.5.0</span>
<span class="c">#    &gt; Accept: */*</span>
<span class="c">#    &gt;</span>
<span class="c">#    {"id":1,"author":"William Shakespeare","year":1595,"type":"paperback","pages":200,"publisher":"PublisherA","language":"English","ISBN-10":"1234567890","ISBN-13":"123-1234567890"}&lt; HTTP/1.1 200 OK</span>
<span class="c">#    &lt; content-type: application/json</span>
<span class="c">#    &lt; server: envoy</span>
<span class="c">#    &lt; date: Sat, 23 Aug 2025 08:11:39 GMT</span>
<span class="c">#    &lt; content-length: 178</span>
<span class="c">#    &lt; x-envoy-upstream-service-time: 16</span>
<span class="c">#    &lt;</span>
<span class="c">#    { [178 bytes data]</span>
<span class="c">#    * Connection #0 to host 192.168.10.211 left intact</span>

<span class="c"># Default Deny Ingress Policy : DNSì¿¼ë¦¬ì™€ kube-systemë‚´ì˜ íŒŒë“œ ì œì™¸ to deny all traffic by default</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: "default-deny"
spec:
  description: "Block all the traffic (except DNS) by default"
  egress:
  - toEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: kube-system
        k8s-app: kube-dns
    toPorts:
    - ports:
      - port: '53'
        protocol: UDP
      rules:
        dns:
        - matchPattern: '*'
  endpointSelector:
    matchExpressions:
    - key: io.kubernetes.pod.namespace
      operator: NotIn
      values:
      - kube-system
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumclusterwidenetworkpolicy.cilium.io/default-deny created</span>
<span class="nv">$ </span>kubectl get ciliumclusterwidenetworkpolicy
<span class="c"># =&gt; NAME                VALID</span>
<span class="c">#    allow-cidr          True</span>
<span class="c">#    default-deny        True</span>
<span class="c">#    external-lockdown   True</span>

<span class="c"># ìš”ì²­ </span>
<span class="nv">$ </span>curl <span class="nt">--fail</span> <span class="nt">-v</span> http://<span class="s2">"</span><span class="nv">$LBIP</span><span class="s2">"</span>/details/1
<span class="c"># =&gt; &lt; HTTP/1.1 403 Forbidden</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s --fail -v http://"</span><span class="nv">$LBIP</span><span class="s2">"/details/1"</span>
<span class="c"># =&gt; &lt; HTTP/1.1 403 Forbidden</span>

<span class="c"># ingress ë¥¼ í†µí•´ì„œ ì¸ì… ì‹œ í—ˆìš©</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: allow-ingress-egress
spec:
  description: "Allow all the egress traffic from reserved ingress identity to any endpoints in the cluster"
  endpointSelector:
    matchExpressions:
    - key: reserved:ingress
      operator: Exists
  egress:
  - toEntities:
    - cluster
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumclusterwidenetworkpolicy.cilium.io/allow-ingress-egress created</span>
<span class="nv">$ </span>kubectl get ciliumclusterwidenetworkpolicy
<span class="c"># =&gt; NAME                   VALID</span>
<span class="c">#    allow-cidr             True</span>
<span class="c">#    allow-ingress-egress   True</span>
<span class="c">#    default-deny           True</span>
<span class="c">#    external-lockdown      True</span>

<span class="c">#</span>
<span class="nv">$ </span>curl <span class="nt">--fail</span> <span class="nt">-v</span> http://<span class="s2">"</span><span class="nv">$LBIP</span><span class="s2">"</span>/details/1
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s --fail -v http://"</span><span class="nv">$LBIP</span><span class="s2">"/details/1"</span>
<span class="c"># =&gt; *   Trying 192.168.10.211:80...</span>
<span class="c">#    * Connected to 192.168.10.211 (192.168.10.211) port 80</span>
<span class="c">#    &gt; GET /details/1 HTTP/1.1</span>
<span class="c">#    &gt; Host: 192.168.10.211</span>
<span class="c">#    &gt; User-Agent: curl/8.5.0</span>
<span class="c">#    &gt; Accept: */*</span>
<span class="c">#    &gt;</span>
<span class="c">#    {"id":1,"author":"William Shakespeare","year":1595,"type":"paperback","pages":200,"publisher":"PublisherA","language":"English","ISBN-10":"1234567890","ISBN-13":"123-1234567890"}&lt; HTTP/1.1 200 OK</span>
<span class="c">#    &lt; content-type: application/json</span>
<span class="c">#    &lt; server: envoy</span>
<span class="c">#    &lt; date: Sat, 23 Aug 2025 08:13:20 GMT</span>
<span class="c">#    &lt; content-length: 178</span>
<span class="c">#    &lt; x-envoy-upstream-service-time: 8</span>
<span class="c">#    &lt;</span>
<span class="c">#    { [178 bytes data]</span>
<span class="c">#    * Connection #0 to host 192.168.10.211 left intact</span>

<span class="c"># ì •ì±… ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete CiliumClusterwideNetworkPolicy <span class="nt">--all</span>
<span class="c"># =&gt; ciliumclusterwidenetworkpolicy.cilium.io "allow-cidr" deleted</span>
<span class="c">#    ciliumclusterwidenetworkpolicy.cilium.io "allow-ingress-egress" deleted</span>
<span class="c">#    ciliumclusterwidenetworkpolicy.cilium.io "default-deny" deleted</span>
<span class="c">#    ciliumclusterwidenetworkpolicy.cilium.io "external-lockdown" deleted</span>
</code></pre></div></div>

<h3 id="ingress-path-type-example">Ingress Path Type Example</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/path-types/">ê´€ë ¨ ë¬¸ì„œ</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Apply the base definitions</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/main/examples/kubernetes/servicemesh/ingress-path-types.yaml
<span class="c"># =&gt; ...</span>
<span class="c">#    deployment.apps/implpath2 created</span>
<span class="c">#    ...</span>
<span class="c">#    service/implpath2 created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/main/examples/kubernetes/servicemesh/ingress-path-types.yaml
<span class="c"># =&gt; NAME                          READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/exactpath     1/1     1            1           18s</span>
<span class="c">#    deployment.apps/prefixpath    1/1     1            1           18s</span>
<span class="c">#    deployment.apps/prefixpath2   1/1     1            1           18s</span>
<span class="c">#    deployment.apps/implpath      1/1     1            1           18s</span>
<span class="c">#    deployment.apps/implpath2     1/1     1            1           18s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/prefixpath    ClusterIP   10.96.11.159   &lt;none&gt;        80/TCP    18s</span>
<span class="c">#    service/prefixpath2   ClusterIP   10.96.158.98   &lt;none&gt;        80/TCP    18s</span>
<span class="c">#    service/exactpath     ClusterIP   10.96.46.141   &lt;none&gt;        80/TCP    18s</span>
<span class="c">#    service/implpath      ClusterIP   10.96.88.45    &lt;none&gt;        80/TCP    18s</span>
<span class="c">#    service/implpath2     ClusterIP   10.96.18.242   &lt;none&gt;        80/TCP    18s</span>

<span class="c"># Apply the Ingress</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/main/examples/kubernetes/servicemesh/ingress-path-types-ingress.yaml
<span class="c"># =&gt; ingress.networking.k8s.io/multiple-path-types created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kc describe ingress multiple-path-types
<span class="c"># =&gt; Rules:</span>
<span class="c">#      Host                   Path  Backends</span>
<span class="c">#      ----                   ----  --------</span>
<span class="c">#      pathtypes.example.com</span>
<span class="c">#                             /exact    exactpath:80 (172.20.1.238:3000)</span>
<span class="c">#                             /         prefixpath:80 (172.20.1.72:3000)</span>
<span class="c">#                             /prefix   prefixpath2:80 (172.20.1.176:3000)</span>
<span class="c">#                             /impl     implpath:80 (172.20.1.210:3000)</span>
<span class="c">#                             /impl.+   implpath2:80 (172.20.1.223:3000)</span>
<span class="nv">$ </span>kc get ingress multiple-path-types <span class="nt">-o</span> yaml
<span class="c"># =&gt; ...</span>
<span class="c">#    spec:</span>
<span class="c">#      ingressClassName: cilium</span>
<span class="c">#      rules:</span>
<span class="c">#      - host: pathtypes.example.com</span>
<span class="c">#        http:</span>
<span class="c">#          paths:</span>
<span class="c">#          - backend:</span>
<span class="c">#              service:</span>
<span class="c">#                name: exactpath</span>
<span class="c">#                port:</span>
<span class="c">#                  number: 80</span>
<span class="c">#            path: /exact</span>
<span class="c">#            pathType: Exact</span>
<span class="c">#          - backend:</span>
<span class="c">#              service:</span>
<span class="c">#                name: prefixpath</span>
<span class="c">#                port:</span>
<span class="c">#                  number: 80</span>
<span class="c">#            path: /</span>
<span class="c">#            pathType: Prefix</span>
<span class="c">#          - backend:</span>
<span class="c">#              service:</span>
<span class="c">#                name: prefixpath2</span>
<span class="c">#                port:</span>
<span class="c">#                  number: 80</span>
<span class="c">#            path: /prefix</span>
<span class="c">#            pathType: Prefix</span>
<span class="c">#          - backend:</span>
<span class="c">#              service:</span>
<span class="c">#                name: implpath</span>
<span class="c">#                port:</span>
<span class="c">#                  number: 80</span>
<span class="c">#            path: /impl</span>
<span class="c">#            pathType: ImplementationSpecific</span>
<span class="c">#          - backend:</span>
<span class="c">#              service:</span>
<span class="c">#                name: implpath2</span>
<span class="c">#                port:</span>
<span class="c">#                  number: 80</span>
<span class="c">#            path: /impl.+</span>
<span class="c">#            pathType: ImplementationSpecific</span>

<span class="c"># í˜¸ì¶œ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATHTYPE_IP</span><span class="o">=</span><span class="sb">`</span>k get ing multiple-path-types <span class="nt">-o</span> json | jq <span class="nt">-r</span> <span class="s1">'.status.loadBalancer.ingress[0].ip'</span><span class="sb">`</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/ | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "path": "/",</span>
<span class="c">#      "host": "pathtypes.example.com",</span>
<span class="c">#      "method": "GET",</span>
<span class="c">#      ...</span>
<span class="c">#        "X-Envoy-Internal": [</span>
<span class="c">#          "true"</span>
<span class="c">#        ],</span>
<span class="c">#        "X-Forwarded-For": [</span>
<span class="c">#          "10.0.2.15"</span>
<span class="c">#        ],</span>
<span class="c">#    ...</span>

<span class="c"># íŒŒë“œëª… ì´ë¦„ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod | <span class="nb">grep </span>path
<span class="c"># =&gt; exactpath-7488f8c6c6-4w7rx        1/1     Running   0          2m7s</span>
<span class="c">#    implpath-7d8bf85676-qz6t6         1/1     Running   0          2m7s</span>
<span class="c">#    implpath2-56c97c8556-mv66q        1/1     Running   0          2m7s</span>
<span class="c">#    prefixpath-5d6b989d4-kwvv6        1/1     Running   0          2m7s</span>
<span class="c">#    prefixpath2-b7c7c9568-br2nl       1/1     Running   0          2m7s</span>

<span class="c"># Should show prefixpath</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/ | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'path|pod'</span>
<span class="c"># =&gt;  "path": "/",</span>
<span class="c">#     "host": "pathtypes.example.com",</span>
<span class="c">#     "pod": "prefixpath-5d6b989d4-kwvv6"</span>

<span class="c"># Should show exactpath</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/exact | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'path|pod'</span>
<span class="c"># =&gt;  "path": "/exact",</span>
<span class="c">#     "host": "pathtypes.example.com",</span>
<span class="c">#     "pod": "exactpath-7488f8c6c6-4w7rx"</span>

<span class="c"># Should show prefixpath2</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/prefix | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'path|pod'</span>
<span class="c"># =&gt;  "path": "/prefix",</span>
<span class="c">#     "host": "pathtypes.example.com",</span>
<span class="c">#     "pod": "prefixpath2-b7c7c9568-br2nl"</span>

<span class="c"># Should show implpath</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/impl | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'path|pod'</span>
<span class="c"># =&gt;  "path": "/impl",</span>
<span class="c">#     "host": "pathtypes.example.com",</span>
<span class="c">#     "pod": "implpath-7d8bf85676-qz6t6"</span>

<span class="c"># Should show implpath2</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/implementation | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'path|pod'</span>
<span class="c"># =&gt;  "path": "/implementation",</span>
<span class="c">#     "host": "pathtypes.example.com",</span>
<span class="c">#     "pod": "implpath2-56c97c8556-mv66q"</span>

<span class="c"># ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/main/examples/kubernetes/servicemesh/ingress-path-types.yaml
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/main/examples/kubernetes/servicemesh/ingress-path-types-ingress.yaml
</code></pre></div></div>

<h3 id="ingress-example-with-tls-termination">Ingress Example with TLS Termination</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/tls-termination/">ê´€ë ¨ ë¬¸ì„œ</a></li>
</ul>

<h5 id="tls-ì¸ì¦ì„œì™€-ê°œì¸í‚¤-ìƒì„±--mkcert---github">TLS ì¸ì¦ì„œì™€ ê°œì¸í‚¤ ìƒì„± : mkcert - <a href="https://github.com/FiloSottile/mkcert">Github</a></h5>

<ul>
  <li><code class="language-plaintext highlighter-rouge">mkcert</code>ëŠ” ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” SSL ì¸ì¦ì„œë¥¼ ì‰½ê²Œ ìƒì„±í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># For demonstration purposes we will use a TLS certificate signed by a made-up, self-signed certificate authority (CA). </span>
<span class="c"># One easy way to do this is with mkcert. We want a certificate that will validate bookinfo.cilium.rocks and hipstershop.cilium.rocks, as these are the host names used in this example.</span>
<span class="nv">$ </span>apt <span class="nb">install </span>mkcert <span class="nt">-y</span>
<span class="nv">$ </span>mkcert <span class="nt">-h</span>
<span class="c"># =&gt; Usage of mkcert:</span>
<span class="c">#    </span>
<span class="c">#            $ mkcert -install</span>
<span class="c">#            Install the local CA in the system trust store.</span>
<span class="c">#    </span>
<span class="c">#            $ mkcert example.org</span>
<span class="c">#            Generate "example.org.pem" and "example.org-key.pem".</span>
<span class="c">#    </span>
<span class="c">#            $ mkcert example.com myapp.dev localhost 127.0.0.1 ::1</span>
<span class="c">#            Generate "example.com+4.pem" and "example.com+4-key.pem".</span>
<span class="c">#    </span>
<span class="c">#            $ mkcert "*.example.it"</span>
<span class="c">#            Generate "_wildcard.example.it.pem" and "_wildcard.example.it-key.pem".</span>
<span class="c">#    </span>
<span class="c">#            $ mkcert -uninstall</span>
<span class="c">#            Uninstall the local CA (but do not delete it).</span>
<span class="c">#    </span>
<span class="c">#    For more options, run "mkcert -help".</span>

<span class="c">#</span>
<span class="nv">$ </span>mkcert <span class="s1">'*.cilium.rocks'</span>
<span class="c"># =&gt; Created a new local CA ğŸ’¥</span>
<span class="c">#    Note: the local CA is not installed in the system trust store.</span>
<span class="c">#    Run "mkcert -install" for certificates to be trusted automatically âš ï¸</span>
<span class="c">#    </span>
<span class="c">#    Created a new certificate valid for the following names ğŸ“œ</span>
<span class="c">#     - "*.cilium.rocks"</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> <span class="k">*</span>.pem
<span class="c"># =&gt; -rw------- 1 root root 1704 Aug 23 17:27 _wildcard.cilium.rocks-key.pem</span>
<span class="c">#    -rw-r--r-- 1 root root 1452 Aug 23 17:27 _wildcard.cilium.rocks.pem</span>

<span class="c">#</span>
<span class="nv">$ </span>openssl x509 <span class="nt">-in</span> _wildcard.cilium.rocks.pem <span class="nt">-text</span> <span class="nt">-noout</span>
<span class="c"># =&gt;         Issuer: O = mkcert development CA, OU = root@k8s-ctr, CN = mkcert root@k8s-ctr</span>
<span class="c">#            Validity</span>
<span class="c">#                Not Before: Aug 23 08:27:20 2025 GMT</span>
<span class="c">#                Not After : Oct 01 08:27:20 2027 GMT</span>
<span class="c">#            Subject: O = mkcert development certificate, OU = root@k8s-ctr</span>
<span class="c">#            ...</span>
<span class="c">#            X509v3 extensions:</span>
<span class="c">#                X509v3 Key Usage: critical</span>
<span class="c">#                    Digital Signature, Key Encipherment</span>
<span class="c">#                X509v3 Extended Key Usage:</span>
<span class="c">#                    TLS Web Server Authentication</span>
<span class="c">#                X509v3 Authority Key Identifier:</span>
<span class="c">#                    4E:3C:EA:36:AE:39:1C:4C:16:E0:55:3A:B8:B3:E3:D6:10:5B:31:FC</span>
<span class="c">#                X509v3 Subject Alternative Name:</span>
<span class="c">#                    &lt;span style="color: green;"&gt;DNS:*.cilium.rocks&lt;/span&gt;</span>

<span class="nv">$ </span>openssl rsa <span class="nt">-in</span> _wildcard.cilium.rocks-key.pem <span class="nt">-text</span> <span class="nt">-noout</span>
<span class="c"># =&gt; Private-Key: (2048 bit, 2 primes)</span>
<span class="c">#    modulus:</span>
<span class="c">#        00:95:4a:de:e4:5c:7a:b6:7e:6c:8a:65:fe:8d:9c:</span>
<span class="c">#    ...</span>

<span class="c"># Mkcert created a key (_wildcard.cilium.rocks-key.pem) and a certificate (_wildcard.cilium.rocks.pem) that we will use for the Gateway service.</span>
<span class="c"># Create a Kubernetes TLS secret with this key and certificate:</span>
<span class="nv">$ </span>kubectl create secret tls demo-cert <span class="nt">--key</span><span class="o">=</span>_wildcard.cilium.rocks-key.pem <span class="nt">--cert</span><span class="o">=</span>_wildcard.cilium.rocks.pem
<span class="c"># =&gt; secret/demo-cert created</span>
<span class="nv">$ </span>kubectl get secret demo-cert <span class="nt">-o</span> json | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "apiVersion": "v1",</span>
<span class="c">#      "data": {</span>
<span class="c">#        "tls.crt": "LS0tLS1CRUdJT...VRFLS0tLS0K",</span>
<span class="c">#        "tls.key": "LS0tLS1CRUdJT...gS0VZLS0tLS0K"</span>
<span class="c">#      },</span>
<span class="c">#      ...</span>
<span class="c">#      "type": "kubernetes.io/tls"</span>
<span class="c">#    }</span>
</code></pre></div></div>

<h5 id="ingress-ë°°í¬">Ingress ë°°í¬</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tls-ingress
  namespace: default
spec:
  ingressClassName: cilium
  rules:
  - host: webpod.cilium.rocks
    http:
      paths:
      - backend:
          service:
            name: webpod
            port:
              number: 80
        path: /
        pathType: Prefix
  - host: bookinfo.cilium.rocks
    http:
      paths:
      - backend:
          service:
            name: details
            port:
              number: 9080
        path: /details
        pathType: Prefix
      - backend:
          service:
            name: productpage
            port:
              number: 9080
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - webpod.cilium.rocks
    - bookinfo.cilium.rocks
    secretName: demo-cert
</span><span class="no">EOF
</span><span class="c"># =&gt; ingress.networking.k8s.io/tls-ingress created</span>

<span class="c">#    </span>
<span class="nv">$ </span>kubectl get ingress tls-ingress
<span class="c"># =&gt; NAME          CLASS    HOSTS                                       ADDRESS          PORTS     AGE</span>
<span class="c">#    tls-ingress   cilium   webpod.cilium.rocks,bookinfo.cilium.rocks   192.168.10.211   80, 443   22s</span>
</code></pre></div></div>

<h5 id="ìš”ì²­í•˜ê¸°">ìš”ì²­í•˜ê¸°</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì‹œìŠ¤í…œ(OS) ì‹ ë¢° ì €ì¥ì†Œì— CA ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/ssl/certs/ca-certificates.crt
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /etc/ssl/certs/ca-certificates.crt
<span class="c"># =&gt; -rw-r--r-- 1 root root 219342 Feb 17  2025 /etc/ssl/certs/ca-certificates.crt</span>

<span class="c"># Install the Mkcert CA into your system so cURL can trust it:</span>
<span class="c"># mkcert -installì€ â€œë‚´ ë¡œì»¬ì—ì„œ ë§Œë“  ì¸ì¦ì„œë¥¼ ì‹œìŠ¤í…œì´ ë¯¿ë„ë¡â€ í™˜ê²½ì„ ê¾¸ë©°ì£¼ëŠ” ëª…ë ¹.</span>
<span class="nv">$ </span>mkcert <span class="nt">-install</span>
<span class="c"># =&gt; The local CA is now installed in the system trust store! âš¡ï¸</span>

<span class="c"># 1. ë¡œì»¬ CA(ìì²´ ë£¨íŠ¸ ì¸ì¦ê¸°ê´€) ìƒì„±</span>
<span class="c"># ì•„ì§ ì—†ìœ¼ë©´ ë¡œì»¬ CA ì¸ì¦ì„œì™€ ê°œì¸í‚¤ë¥¼ ë§Œë“­ë‹ˆë‹¤.</span>
<span class="c"># íŒŒì¼ì€ $(mkcert -CAROOT)ê°€ ê°€ë¦¬í‚¤ëŠ” ì‚¬ìš©ì ë°ì´í„° ë””ë ‰í„°ë¦¬ì— ì €ì¥ë¼ìš”(ì˜ˆ: rootCA.pem, rootCA-key.pem). ì´ ìœ„ì¹˜ëŠ” mkcert -CAROOTë¡œ í™•ì¸í•©ë‹ˆë‹¤. </span>
<span class="c">## CA ì €ì¥ ìœ„ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>mkcert <span class="nt">-CAROOT</span>
<span class="c"># =&gt; /root/.local/share/mkcert</span>

<span class="nv">$ </span><span class="nb">ls</span> <span class="s2">"</span><span class="si">$(</span>mkcert <span class="nt">-CAROOT</span><span class="si">)</span><span class="s2">"</span>
<span class="c"># =&gt; rootCA-key.pem  rootCA.pem</span>

<span class="c"># 2. ì‹œìŠ¤í…œ(OS) ì‹ ë¢° ì €ì¥ì†Œì— CAë¥¼ ë“±ë¡</span>
<span class="c"># ë°°í¬íŒì— ë§ëŠ” ë„êµ¬(ì˜ˆ: Debian/Ubuntuì˜ update-ca-certificates, RHEL/Fedoraì˜ update-ca-trust, Archì˜ trust)ë¥¼ ì‚¬ìš©í•´ ë£¨íŠ¸ CA ì¸ì¦ì„œë¥¼ ì‹œìŠ¤í…œ ì‹ ë¢° ì €ì¥ì†Œì— ë„£ìŠµë‹ˆë‹¤.</span>
<span class="c"># ì´ë ‡ê²Œ í•˜ë©´ OpenSSL/GnuTLSë¥¼ ì“°ëŠ” ëŒ€ë¶€ë¶„ì˜ CLIê°€ ì´ CAë¡œ ì„œëª…ëœ ì„œë²„ ì¸ì¦ì„œë¥¼ ì‹ ë¢°í•©ë‹ˆë‹¤. (curlë„ í¬í•¨)</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /etc/ssl/certs/ca-certificates.crt
<span class="c"># =&gt; -rw-r--r-- 1 root root 220952 Aug 23 17:31 /etc/ssl/certs/ca-certificates.crt</span>

<span class="c">## ë§¨ í•˜ë‹¨ì— ì¸ì¦ì„œë§Œ íŒŒì¼ë¡œ ë§Œë“¤ì–´ì„œ ë””ì½”ë”©!</span>
<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-n</span> 50 /etc/ssl/certs/ca-certificates.crt
<span class="c"># =&gt; ...</span>
<span class="c">#    -----END CERTIFICATE-----</span>
<span class="c">#    -----BEGIN CERTIFICATE-----</span>
<span class="c">#    MIIEeTCCAuGgAwIBAgIQHQmaPLojsfEios2wRChKPTANBgkqhkiG9w0BAQsFADBV</span>
<span class="c">#    ...</span>
<span class="c">#    zLFNEfhNUdhcRarky3dp/Jbp16t2QJRYh39gFskAJ1+02uQrsFq14pPnOO1d</span>
<span class="c">#    -----END CERTIFICATE-----</span>
<span class="nv">$ </span>vi 1.pem
<span class="nt">---</span>
<span class="nt">-----BEGIN</span> CERTIFICATE-----
MIIEeTCCAuGgAwIBAgIQHQmaPLojsfEios2wRChKPTANBgkqhkiG9w0BAQsFADBV
...
zLFNEfhNUdhcRarky3dp/Jbp16t2QJRYh39gFskAJ1+02uQrsFq14pPnOO1d
<span class="nt">-----END</span> CERTIFICATE-----
<span class="nt">---</span>
<span class="nv">$ </span>openssl x509 <span class="nt">-in</span> 1.pem <span class="nt">-text</span> <span class="nt">-noout</span>
<span class="c"># =&gt;         Issuer: O = mkcert development CA, OU = root@k8s-ctr, CN = mkcert root@k8s-ctr</span>
<span class="c">#            Validity</span>
<span class="c">#                Not Before: Aug 23 08:27:20 2025 GMT</span>
<span class="c">#                Not After : Aug 23 08:27:20 2035 GMT</span>
<span class="c">#            Subject: O = mkcert development CA, OU = root@k8s-ctr, CN = mkcert root@k8s-ctr</span>
<span class="c">#            Subject Public Key Info:</span>
<span class="c">#    ...</span>
<span class="c">#            X509v3 extensions:</span>
<span class="c">#                X509v3 Key Usage: critical</span>
<span class="c">#                    Certificate Sign</span>
<span class="c">#                X509v3 Basic Constraints: critical</span>
<span class="c">#                    CA:TRUE, pathlen:0</span>
<span class="c">#    ...</span>

<span class="c"># 3. NSS(ë¸Œë¼ìš°ì €) ì‹ ë¢° ì €ì¥ì†Œì— ë“±ë¡</span>
<span class="c"># Linuxì—ì„œëŠ” Firefox/Chromiumì´ ì“°ëŠ” NSS ë°ì´í„°ë² ì´ìŠ¤ì—ë„ CAë¥¼ ë„£ìŠµë‹ˆë‹¤(ì‚¬ì „ì— certutil ì„¤ì¹˜ í•„ìš”). FirefoxëŠ” ë¸Œë¼ìš°ì € ì¬ì‹œì‘ì´ í•„ìš”í•©ë‹ˆë‹¤</span>

<span class="c"># Now let's make a request to the Gateway:</span>
<span class="c"># The data should be properly retrieved, using HTTPS (and thus, the TLS handshake was properly achieved).</span>
<span class="c"># In the next challenge, we will see how to use Gateway API for general TLS traffic.</span>
<span class="nv">$ </span>kubectl get ingress tls-ingress <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span>
<span class="c"># =&gt; 192.168.10.211</span>
<span class="nv">$ LBIP</span><span class="o">=</span><span class="si">$(</span>kubectl get ingress tls-ingress <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">--resolve</span> bookinfo.cilium.rocks:443:<span class="k">${</span><span class="nv">LBIP</span><span class="k">}</span> https://bookinfo.cilium.rocks/details/1 | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "id": 1,</span>
<span class="c">#      "author": "William Shakespeare",</span>
<span class="c">#      "year": 1595,</span>
<span class="c">#      "type": "paperback",</span>
<span class="c">#      "pages": 200,</span>
<span class="c">#      "publisher": "PublisherA",</span>
<span class="c">#      "language": "English",</span>
<span class="c">#      "ISBN-10": "1234567890",</span>
<span class="c">#      "ISBN-13": "123-1234567890"</span>
<span class="c">#    }</span>
  
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">--resolve</span> webpod.cilium.rocks:443:<span class="k">${</span><span class="nv">LBIP</span><span class="k">}</span>   https://webpod.cilium.rocks/ <span class="nt">-v</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    *  CAfile: /etc/ssl/certs/ca-certificates.crt</span>
<span class="c">#    *  CApath: /etc/ssl/certs</span>
<span class="c">#    ...</span>
<span class="c">#    * Server certificate:</span>
<span class="c">#    *  subject: O=mkcert development certificate; OU=root@k8s-ctr</span>
<span class="c">#    *  start date: Aug 23 08:27:20 2025 GMT</span>
<span class="c">#    *  expire date: Oct 01 08:27:20 2027 GMT</span>
<span class="c">#    *  subjectAltName: host "webpod.cilium.rocks" matched cert's "*.cilium.rocks"</span>
<span class="c">#    *  issuer: O=mkcert development CA; OU=root@k8s-ctr; CN=mkcert root@k8s-ctr</span>
<span class="c">#    ...</span>
<span class="c">#    Hostname: webpod-697b545f57-b5vtj</span>
<span class="c">#    ...</span>
<span class="c">#    IP: 172.20.0.70</span>
<span class="c">#    RemoteAddr: 10.0.2.15:51328</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: webpod.cilium.rocks</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    X-Envoy-Internal: true</span>
<span class="c">#    X-Forwarded-For: 10.0.2.15</span>
<span class="c">#    X-Forwarded-Proto: https</span>
<span class="c">#    X-Request-Id: da68b521-852e-4678-92ed-37f72101d75d</span>
</code></pre></div></div>

<ul>
  <li>TLS Terminationì´ ì˜ ë˜ì–´ì„œ httpsë¡œ ìš”ì²­ì‹œ ì¸ì¦ì„œê°€ ìœ íš¨í•˜ê³ , ì„œë¹„ìŠ¤ë¡œ ìš”ì²­ì´ ì˜ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="ingress-ì‚­ì œ">ingress ì‚­ì œ</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete ingress basic-ingress tls-ingress webpod-ingress
<span class="c"># =&gt; ingress.networking.k8s.io "basic-ingress" deleted</span>
<span class="c">#    ingress.networking.k8s.io "tls-ingress" deleted</span>
<span class="c">#    ingress.networking.k8s.io "webpod-ingress" deleted</span>
</code></pre></div></div>

<hr />

<h2 id="gateway-api-support">Gateway API Support</h2>

<h3 id="gateway-api-ì†Œê°œ">Gateway API ì†Œê°œ</h3>

<ul>
  <li>Gateway APIëŠ” ê¸°ì¡´ì˜ Ingress APIì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ê³  ëŒ€ì²´í•˜ê¸° ìœ„í•œ ì°¨ì„¸ëŒ€ APIë¡œ, ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ê³ , ì—­í• ì„ ë¶„ë¦¬í•˜ê³ , ë” ìœ ì—°í•˜ê³  í™•ì¥ ê°€ëŠ¥í•œ ë°©ì‹ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ë‚´ë¶€ë¡œì˜ íŠ¸ë˜í”½ì„ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
<a href="https://kubernetes.io/docs/concepts/services-networking/gateway/">Docs</a>, <a href="https://www.youtube.com/watch?v=kbTVzAhtHKs">Youtube</a></li>
  <li>ê¸°ì¡´ Ingressì˜ í•œê³„
    <ul>
      <li><strong>ê³ ê¸‰ ë¼ìš°íŒ… ì§€ì› ë¶€ì¡± (URL rewriting ë“±)</strong> : Ingress Controller ë§ˆë‹¤ ì§€ì›í•˜ëŠ” ê¸°ëŠ¥ì´ ë‹¤ë¥´ê³ , íŠ¹ìˆ˜í•œ Annotationì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ë“± ì¼ê´€ì„±ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.</li>
      <li><strong>ì—­í•  ë¶„ë¦¬ ë¶€ì¡±</strong> : Ingress ë¦¬ì†ŒìŠ¤ëŠ” í´ëŸ¬ìŠ¤í„° ìš´ì˜ìì™€ ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œì ê°„ì˜ ì—­í•  ë¶„ë¦¬ê°€ ëª…í™•í•˜ì§€ ì•Šì•„, ìš´ì˜ìê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¼ìš°íŒ… ì •ì±…ì„ ì™„ì „íˆ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
      <li><strong>í”„ë¡œí† ì½œ ì œí•œ</strong> : IngressëŠ” ì£¼ë¡œ HTTP/HTTPS íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ë„ë¡ ì„¤ê³„ë˜ì–´ ìˆì–´, TCP, UDP ë“± ë‹¤ë¥¸ í”„ë¡œí† ì½œì— ëŒ€í•œ ì§€ì›ì´ ì œí•œì ì…ë‹ˆë‹¤.</li>
      <li><strong>ìš´ì˜ ì œí•œ</strong> : Ingressì˜ APIëŠ” ìœ ì—°í•˜ì§€ ëª»í•˜ì—¬ ë¡œë“œë°¸ëŸ°ì‹±ì„ ê³µìœ í•˜ëŠ” ì¸í”„ë¼ë¥¼ ì—¬ëŸ¬ íŒ€ì´ ê´€ë¦¬í•˜ëŠ” í´ëŸ¬ìŠ¤í„°ì— ì í•©í•˜ì§€ ì•ŠëŠ”ë“± ìš´ì˜ìƒì˜ ì œì•½ì´ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì„œë¹„ìŠ¤ ë©”ì‹œ(istiod ë“±)ì—ì„œ ì œê³µí•˜ëŠ” í’ë¶€í•œ ê¸°ëŠ¥ ì¤‘ ì¼ë¶€ ê¸°ëŠ¥ë“¤ê³¼ ìš´ì˜ê´€ë¦¬ ê¸°ëŠ¥ë“¤ì„ Gateway APIë¥¼ í†µí•´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì£¼ìš” ê¸°ëŠ¥
    <ul>
      <li><strong>ê°œì„ ëœ ë¦¬ì†ŒìŠ¤ ëª¨ë¸</strong> : Gateway APIëŠ” GatewayClass, Gateway ë° Route(HTTPRoute, TCPRoute ë“±)ì™€ ê°™ì€ ìƒˆë¡œìš´ ì‚¬ìš©ì ì •ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ë„ì…í•˜ì—¬ ë¼ìš°íŒ… ê·œì¹™ì„ ì •ì˜í•˜ëŠ” ë³´ë‹¤ ì„¸ë¶€ì ì´ê³  í‘œí˜„ë ¥ ìˆëŠ” ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
      <li><strong>í”„ë¡œí† ì½œ ë…ë¦½ì </strong> : ì£¼ë¡œ HTTPìš©ìœ¼ë¡œ ì„¤ê³„ëœ Ingressì™€ ë‹¬ë¦¬ Gateway APIëŠ” TCP, UDP, TLSë¥¼ í¬í•¨í•œ ì—¬ëŸ¬ í”„ë¡œí† ì½œì„ ì§€ì›í•©ë‹ˆë‹¤.</li>
      <li><strong>ê°•í™”ëœ ë³´ì•ˆ</strong> : TLS êµ¬ì„± ë° ë³´ë‹¤ ì„¸ë¶€ì ì¸ ì•¡ì„¸ìŠ¤ ì œì–´ì— ëŒ€í•œ ê¸°ë³¸ ì œê³µ ì§€ì›.</li>
      <li><strong>êµì°¨ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§€ì›</strong> : ì„œë¡œ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ì„œë¹„ìŠ¤ë¡œ íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…í•˜ì—¬ ë³´ë‹¤ ìœ ì—°í•œ ì•„í‚¤í…ì²˜ë¥¼ êµ¬ì¶•í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
      <li><strong>í™•ì¥ì„±</strong> : APIëŠ” ì‚¬ìš©ì ì •ì˜ ë¦¬ì†ŒìŠ¤ ë° ì •ì±…ìœ¼ë¡œ ì‰½ê²Œ í™•ì¥í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
      <li><strong>ì—­í•  ì§€í–¥</strong> : í´ëŸ¬ìŠ¤í„° ìš´ì˜ì, ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œì, ë³´ì•ˆ íŒ€ ê°„ì˜ ê´€ì‹¬ì‚¬ë¥¼ ëª…í™•í•˜ê²Œ ë¶„ë¦¬í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Gateway APIì˜ êµ¬ì„±ìš”ì†Œ (Resource)
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_8.png" alt="img.png" />
    <ul>
      <li>GatewayClass : í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ Gatewayì˜ ìœ í˜•ì„ ì •ì˜í•©ë‹ˆë‹¤. í´ë˜ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì—ì˜í•´ ê´€ë¦¬ ë©ë‹ˆë‹¤.</li>
      <li>Gateway : ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì³ êµ¬ì„±ìš”ì†Œë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. (ì˜ˆ) í´ë¼ìš°ë“œ ë¡œë“œ ë°¸ëŸ°ì„œ, í”„ë¡ì‹œ ì„œë²„ ë“±)</li>
      <li>HTTPRoute : HTTP íŠ¸ë˜í”½ì— íŠ¹í™”ëœ ë¼ìš°íŒ… ê·œì¹™ì„ ì •ì˜í•©ë‹ˆë‹¤.</li>
      <li>TCPRoute : TCP íŠ¸ë˜í”½ì— íŠ¹í™”ëœ ë¼ìš°íŒ… ê·œì¹™ì„ ì •ì˜í•©ë‹ˆë‹¤.</li>
      <li>Service : Kubernetes ì„œë¹„ìŠ¤ ë¦¬ì†ŒìŠ¤ì™€ ìœ ì‚¬í•˜ê²Œ,íŠ¸ë˜í”½ì´ ë¼ìš°íŒ…ë  ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì—­í•  ì§€í–¥ì— ì˜í•œ ê´€ì‹¬ì‚¬ ë¶„ë¦¬
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_9.png" alt="img.png" class="image-center w-80" />
    <ul>
      <li>Ingressì˜ ê²½ìš° Ingress ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìê°€ Ingress ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ë™ì‘ì„ ì™„ì „íˆ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>í•˜ì§€ë§Œ Gateway APIì—ì„œëŠ” GatewayClass, Gateway ë° Route ë¦¬ì†ŒìŠ¤ë¥¼ í†µí•´ ì—­í• ì„ ë¶„ë¦¬í•˜ì—¬ ê° ì—­í• ì— ëŒ€í•œ ê¶Œí•œì„ ì„¸ë¶„í™”í•˜ì—¬
í•„ìš”í•œ ìµœì†Œí•œì˜ ê¶Œí•œë§Œ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ì—­í•  ì§€í–¥ì— ì˜í•œ ê¶Œí•œ ë¶€ì—¬ ì˜ˆì‹œ - <a href="https://www.anyflow.net/sw-engineer/kubernetes-gateway-api-1">Blog1</a>, <a href="https://www.anyflow.net/sw-engineer/kubernetes-gateway-api-2">Blog2</a>
        <ul>
          <li>ì•„ë˜ì˜ ê·¸ë¦¼ ì²˜ëŸ¼ â€œStore ê°œë°œìâ€ëŠ” Store namespaceì—ì„œ í•´ë‹¹ store PATH ë¼ìš°íŒ… ì •ì±…ì„ ìŠ¤ìŠ¤ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_10.png" alt="img.png" class="image-center" />
<em class="image-caption"><a href="https://gateway-api.sigs.k8s.io/">https://gateway-api.sigs.k8s.io/</a></em></li>
          <li><strong>Infrastructure ì œê³µì</strong> : ì—¬ëŸ¬ í…Œë„ŒíŠ¸ë¥¼ ì§€ì›í•˜ê¸°ìœ„í•´ ì—¬ëŸ¬ ê²©ë¦¬ëœ í´ëŸ¬ìŠ¤í„°ë¥¼ ìš´ì˜í•˜ëŠ” ì¸í”„ë¼ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
          <li><strong>Cluster ìš´ì˜ì</strong> : ì •ì±…, ë„¤íŠ¸ì›Œí¬ ì œì–´, ì• í”Œë¦¬ì¼€ì´ì…˜ ê¶Œí•œ ë“±ì˜ í´ëŸ¬ìŠ¤í„°ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. ìœ„ì˜ ê·¸ë¦¼ì—ì„œëŠ” ë„ë©”ì¸, ì¸ì¦ì„œ, ì „ì²´ì ì¸ ì •ì±… ë“±ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
          <li><strong>Application ê°œë°œì</strong> : í´ëŸ¬ìŠ¤í„°ì—ì„œ ë™ì‘í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°œë°œí•˜ê³  ë°°í¬, ê´€ë¦¬í•©ë‹ˆë‹¤. ìœ„ì˜ ê·¸ë¦¼ì—ì„œëŠ” ê°œë³„ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•œ ë¼ìš°íŒ… ì •ì±…ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="cilium-gateway-api-ì§€ì›">Cilium Gateway API ì§€ì›</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api/">ê´€ë ¨ ë¬¸ì„œ</a></li>
  <li>Ciliumì€ Gateway APIë¥¼ ì§€ì›í•˜ë©°, Ciliumì˜ ì„œë¹„ìŠ¤ ë©”ì‹œ ê¸°ëŠ¥ê³¼ í†µí•©í•˜ì—¬ ê³ ê¸‰ íŠ¸ë˜í”½ ê´€ë¦¬ ë° ë³´ì•ˆ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>Ciliumì€ ì•„ë˜ì˜ resourceì— ëŒ€í•´ Gateway API v1.2.0ì„ ì§€ì›í•˜ê³ , ëª¨ë“  ì¤‘ìš”í•œ ê¸°ëŠ¥ì— ëŒ€í•œ ë§Œì¡±í†  í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•˜ì˜€ìŠµë‹ˆë‹¤. (v1.3ì€ ì•„ì§ ì¼ë¶€í•­ëª©ì´ ë§Œì¡±ë˜ì§€ ì•Šì€ ìƒíƒœì…ë‹ˆë‹¤. - <a href="https://gateway-api.sigs.k8s.io/implementations/v1.3/">https://gateway-api.sigs.k8s.io/implementations/v1.3/</a>)
    <ul>
      <li><a href="https://gateway-api.sigs.k8s.io/api-types/gatewayclass/">GatewayClass</a></li>
      <li><a href="https://gateway-api.sigs.k8s.io/api-types/gateway/">Gateway</a></li>
      <li><a href="https://gateway-api.sigs.k8s.io/api-types/httproute/">HTTPRoute</a></li>
      <li><a href="https://gateway-api.sigs.k8s.io/api-types/grpcroute/">GRPCRoute</a></li>
      <li><a href="https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.TLSRoute">TLSRoute (experimental)</a></li>
      <li><a href="https://gateway-api.sigs.k8s.io/api-types/referencegrant/">ReferenceGrant</a>
        <ul>
          <li>ì¶”ê°€ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">CiliumGatewayClassConfig</code> CRDë¥¼ ì œê³µí•˜ë©°, <a href="https://gateway-api.sigs.k8s.io/api-types/gatewayclass/#gatewayclass-parameters">GatewayClass.parametersRef</a>ì—ì„œ ì°¸ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ì‚¬ì „ ì¤€ë¹„
    <ul>
      <li>Ciliumì€ NodePort ì§€ì›ì´ í™œì„±í™”(<code class="language-plaintext highlighter-rouge">nodePort.enabled=true</code>) ë˜ì–´ ìˆì–´ìˆê±°ë‚˜ Kube-Proxy ëŒ€ì²´ ëª¨ë“œ(<code class="language-plaintext highlighter-rouge">kubeProxyReplacement=true</code>)ë¡œ ë™ì‘í•˜ê³  ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>Ciliumì€ L7 í”„ë¡ì‹œ ê¸°ëŠ¥ì´ í™œì„±í™”(<code class="language-plaintext highlighter-rouge">l7Proxy=true</code>) ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. (ê¸°ë³¸ê°’ì€ true)</li>
      <li>ì•„ë˜ì˜ Gateway API 1.2.0 CRDê°€ í´ëŸ¬ìŠ¤í„°ì— ì ìš©ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. (ì„¤ì¹˜ê³¼ì •ì€ <a href="https://gateway-api.sigs.k8s.io/guides/?h=crds#getting-started-with-gateway-api">ë¬¸ì„œ</a>ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># CRD ì„¤ì¹˜</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_gatewayclasses.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_gateways.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_httproutes.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_referencegrants.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_grpcroutes.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml
    
<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get crd | <span class="nb">grep </span>gateway.networking.k8s.io
<span class="c"># =&gt; gatewayclasses.gateway.networking.k8s.io     2025-08-23T10:48:59Z</span>
<span class="c">#    gateways.gateway.networking.k8s.io           2025-08-23T10:48:59Z</span>
<span class="c">#    grpcroutes.gateway.networking.k8s.io         2025-08-23T10:49:01Z</span>
<span class="c">#    httproutes.gateway.networking.k8s.io         2025-08-23T10:49:00Z</span>
<span class="c">#    referencegrants.gateway.networking.k8s.io    2025-08-23T10:49:01Z</span>
<span class="c">#    tlsroutes.gateway.networking.k8s.io          2025-08-23T10:49:02Z</span>
</code></pre></div>        </div>
      </li>
      <li>ê¸°ë³¸ì ìœ¼ë¡œ Gateway API ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” LoadBalancer íƒ€ì…ì˜ Serviceë¥¼ ìƒì„±í•˜ì—¬ ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ëŒ€ì•ˆìœ¼ë¡œ Cilium 1.16 ì´ìƒì—ì„œëŠ” Cilium L7 Proxyë¥¼ <a href="https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api/#gs-gateway-host-network-mode">í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬</a>ì— ë…¸ì¶œ ì‹œí‚¬ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì „ë°˜ì ì¸ ë™ì‘ ë©”ì»¤ë‹ˆì¦˜
    <ul>
      <li>Ciliumì€ í¬ê²Œ Cilium Agentì™€ Cilium Operatorì˜ ë‘ ì»´í¬ë„ŒíŠ¸ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.</li>
      <li>Cilium OperatorëŠ” ëª¨ë“  Gateway API ë¦¬ì†ŒìŠ¤ë¥¼ ê°ì‹œí•˜ê³ , ë¦¬ì†ŒìŠ¤ê°€ ì í•©í•œì§€ ê²€ì¦í•©ë‹ˆë‹¤. ë§Œì•½ ë¦¬ì†ŒìŠ¤ê°€ ì í•©í•˜ë‹¤ë©´ êµ¬ì„±ì„ ìˆ˜ìš©í•´ì„œ Cilium Envoy êµ¬ì„±ì— ë°˜ì˜í•©ë‹ˆë‹¤.</li>
      <li>Cilium AgentëŠ” ê° ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ë©°, Cilium Operatorê°€ ì œê³µí•˜ëŠ” êµ¬ì„±ì„ ì‚¬ìš©í•˜ì—¬ Envoyë‚˜ Envoy DaemonSetì„ ì„¤ì •í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤. EnvoyëŠ” íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ê³  ë¼ìš°íŒ…í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="cilium-gateway-api-ì„¤ì •-ë°-ë°°í¬">Cilium Gateway API ì„¤ì • ë° ë°°í¬</h3>

<h5 id="cilium-gateway-api-í™œì„±í™”">Cilium Gateway API í™œì„±í™”</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ingressì™€ Gateway APIëŠ” ë™ì‹œì— ì‚¬ìš©í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ingressControllerë¥¼ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> ingressController.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> gatewayAPI.enabled<span class="o">=</span><span class="nb">true</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart deployment/cilium-operator
<span class="c"># =&gt; deployment.apps/cilium-operator restarted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c">#</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>gateway-api
<span class="c"># =&gt; enable-gateway-api                                true</span>
<span class="c">#    enable-gateway-api-alpn                           false</span>
<span class="c">#    enable-gateway-api-app-protocol                   false</span>
<span class="c">#    enable-gateway-api-proxy-protocol                 false</span>
<span class="c">#    enable-gateway-api-secrets-sync                   true</span>
<span class="c">#    gateway-api-hostnetwork-enabled                   false</span>
<span class="c">#    gateway-api-hostnetwork-nodelabelselector</span>
<span class="c">#    gateway-api-secrets-namespace                     cilium-secrets</span>
<span class="c">#    gateway-api-service-externaltrafficpolicy         Cluster</span>
<span class="c">#    gateway-api-xff-num-trusted-hops                  0</span>

<span class="c"># cilium-ingress ì œê±° í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc,pod <span class="nt">-n</span> kube-system

<span class="nv">$ </span>kubectl get GatewayClass
<span class="c"># =&gt; NAME     CONTROLLER                     ACCEPTED   AGE</span>
<span class="c">#    cilium   io.cilium/gateway-controller   True       64s</span>

<span class="nv">$ </span>kubectl get gateway <span class="nt">-A</span>
<span class="c"># =&gt; No resources found</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì•„ì§ ë°°í¬ëœ Gatewayê°€ ì—†ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="cilium-gateway-ë°°í¬">Cilium Gateway ë°°í¬</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: my-gateway
spec:
  gatewayClassName: cilium
  listeners:
  - protocol: HTTP
    port: 80
    name: web-gw
    allowedRoutes:
      namespaces:
        from: Same
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: http-app-1
spec:
  parentRefs:
  - name: my-gateway
    namespace: default
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /details
    backendRefs:
    - name: details
      port: 9080
  - matches:
    - headers:
      - type: Exact
        name: magic
        value: foo
      queryParams:
      - type: Exact
        name: great
        value: example
      path:
        type: PathPrefix
        value: /
      method: GET
    backendRefs:
    - name: productpage
      port: 9080
</span><span class="no">EOF
</span><span class="c"># =&gt; gateway.gateway.networking.k8s.io/my-gateway created</span>
<span class="c">#    httproute.gateway.networking.k8s.io/http-app-1 created</span>

<span class="nv">$ </span>kubectl get svc,ep cilium-gateway-my-gateway
<span class="c"># =&gt; NAME                                TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)        AGE</span>
<span class="c">#    service/cilium-gateway-my-gateway   LoadBalancer   10.96.119.37   192.168.10.211   80:30910/TCP   17s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                  ENDPOINTS              AGE</span>
<span class="c">#    endpoints/cilium-gateway-my-gateway   192.192.192.192:9999   17s</span>

<span class="nv">$ </span>kubectl get gateway
<span class="c"># =&gt; NAME         CLASS    ADDRESS          PROGRAMMED   AGE</span>
<span class="c">#    my-gateway   cilium   192.168.10.211   True         32s</span>

<span class="c">## Accepted: Gateway êµ¬ì„±ì´ ì˜¬ë°”ë¥´ê³  ìˆ˜ìš©ë˜ì—ˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</span>
<span class="c">## Programmed: Gateway êµ¬ì„±ì´ Envoyì— ì„±ê³µì ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</span>
<span class="c">## ResolvedRefs: ëª¨ë“  ì°¸ì¡°ëœ ì‹œí¬ë¦¿ì´ ë°œê²¬ë˜ê³  ì‚¬ìš© ê¶Œí•œì´ ìˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kc describe gateway
<span class="c"># =&gt; ...</span>
<span class="c">#      Conditions:</span>
<span class="c">#        Last Transition Time:  2025-08-23T11:11:49Z</span>
<span class="c">#        Message:               Gateway successfully scheduled</span>
<span class="c">#        Observed Generation:   1</span>
<span class="c">#        Reason:                Accepted</span>
<span class="c">#        Status:                True</span>
<span class="c">#        Type:                  Accepted</span>
<span class="c">#        Last Transition Time:  2025-08-23T11:11:49Z</span>
<span class="c">#        Message:               Gateway successfully reconciled</span>
<span class="c">#        Observed Generation:   1</span>
<span class="c">#        Reason:                Programmed</span>
<span class="c">#        Status:                True</span>
<span class="c">#        Type:                  Programmed</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get httproutes <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE   NAME         HOSTNAMES   AGE</span>
<span class="c">#    default     http-app-1               2m53s</span>

<span class="c"># Accepted: HTTPRouteê°€ ì˜¬ë°”ë¥´ê²Œ ìˆ˜ìš©ë˜ì—ˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</span>
<span class="c"># ResolvedRefs: ì°¸ì¡°ëœ ì„œë¹„ìŠ¤ê°€ ë°œê²¬ë˜ê³  ìœ íš¨í•œ ì°¸ì¡°ì„ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kc describe httproutes
<span class="c"># =&gt; ...</span>
<span class="c">#        Conditions:</span>
<span class="c">#          Last Transition Time:  2025-08-23T11:11:49Z</span>
<span class="c">#          Message:               Accepted HTTPRoute</span>
<span class="c">#          Observed Generation:   1</span>
<span class="c">#          Reason:                Accepted</span>
<span class="c">#          Status:                True</span>
<span class="c">#          Type:                  Accepted</span>
<span class="c">#          Last Transition Time:  2025-08-23T11:11:49Z</span>
<span class="c">#          Message:               Service reference is valid</span>
<span class="c">#          Observed Generation:   1</span>
<span class="c">#          Reason:                ResolvedRefs</span>
<span class="c">#          Status:                True</span>
<span class="c">#          Type:                  ResolvedRefs</span>
<span class="c">#    ...</span>

<span class="c"># Cilium Operator ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system deployments/cilium-operator | <span class="nb">grep </span>gateway
</code></pre></div></div>

<h5 id="ìš”ì²­-í•˜ê¸°">ìš”ì²­ í•˜ê¸°</h5>

<ul>
  <li>HTTP ê²½ë¡œ ë§¤ì¹­ê³¼ HTTP í—¤ë” ë§¤ì¹­</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ GATEWAY</span><span class="o">=</span><span class="si">$(</span>kubectl get gateway my-gateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.addresses[0].value}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$GATEWAY</span>
<span class="c"># =&gt; 192.168.10.211</span>

<span class="c"># HTTP ê²½ë¡œ ë§¤ì¹­</span>
<span class="nv">$ </span>curl <span class="nt">--fail</span> <span class="nt">-s</span> http://<span class="s2">"</span><span class="nv">$GATEWAY</span><span class="s2">"</span>/details/1 | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "id": 1,</span>
<span class="c">#      "author": "William Shakespeare",</span>
<span class="c">#      "year": 1595,</span>
<span class="c">#      "type": "paperback",</span>
<span class="c">#      "pages": 200,</span>
<span class="c">#      "publisher": "PublisherA",</span>
<span class="c">#      "language": "English",</span>
<span class="c">#      "ISBN-10": "1234567890",</span>
<span class="c">#      "ISBN-13": "123-1234567890"</span>
<span class="c">#    }</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s --fail -v http://"</span><span class="nv">$GATEWAY</span><span class="s2">"/details/1"</span>
<span class="c"># =&gt; {"id":1,"author":"William Shakespeare","year":1595,"type":"paperback","pages":200,"publisher":"PublisherA","language":"English","ISBN-10":"1234567890","ISBN-13":"123-1234567890"}</span>
<span class="c">#    &lt; HTTP/1.1 200 OK</span>

<span class="c"># HTTP í—¤ë” ë§¤ì¹­</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-H</span> <span class="s1">'magic: foo'</span> http://<span class="s2">"</span><span class="nv">$GATEWAY</span><span class="s2">"</span><span class="se">\?</span>great<span class="se">\=</span>example
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s -v -H 'magic: foo' http://"</span><span class="nv">$GATEWAY</span><span class="s2">"</span><span class="se">\?</span><span class="s2">great</span><span class="se">\=</span><span class="s2">example"</span>
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
</code></pre></div></div>

<h5 id="https-ì˜ˆì œ">HTTPS ì˜ˆì œ</h5>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/https/">ê´€ë ¨ ë¬¸ì„œ</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: tls-gateway
spec:
  gatewayClassName: cilium
  listeners:
  - name: https-1
    protocol: HTTPS
    port: 443
    hostname: "bookinfo.cilium.rocks"
    tls:
      certificateRefs:
      - kind: Secret
        name: demo-cert
  - name: https-2
    protocol: HTTPS
    port: 443
    hostname: "webpod.cilium.rocks"
    tls:
      certificateRefs:
      - kind: Secret
        name: demo-cert
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: https-app-route-1
spec:
  parentRefs:
  - name: tls-gateway
  hostnames:
  - "bookinfo.cilium.rocks"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /details
    backendRefs:
    - name: details
      port: 9080
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: https-app-route-2
spec:
  parentRefs:
  - name: tls-gateway
  hostnames:
  - "webpod.cilium.rocks"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: webpod
      port: 80
</span><span class="no">EOF
</span><span class="c"># =&gt; gateway.gateway.networking.k8s.io/tls-gateway created</span>
<span class="c">#    httproute.gateway.networking.k8s.io/https-app-route-1 created</span>
<span class="c">#    httproute.gateway.networking.k8s.io/https-app-route-2 created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get gateway tls-gateway
<span class="c"># =&gt; NAME          CLASS    ADDRESS          PROGRAMMED   AGE</span>
<span class="c">#    tls-gateway   cilium   192.168.10.213   True         24s</span>

<span class="nv">$ </span>kubectl get httproutes https-app-route-1 https-app-route-2
<span class="c"># =&gt; NAME                HOSTNAMES                   AGE</span>
<span class="c">#    https-app-route-1   ["bookinfo.cilium.rocks"]   36s</span>
<span class="c">#    https-app-route-2   ["webpod.cilium.rocks"]     36s</span>

<span class="c">#</span>
<span class="nv">$ GATEWAY2</span><span class="o">=</span><span class="si">$(</span>kubectl get gateway tls-gateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.addresses[0].value}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$GATEWAY2</span>
<span class="c"># =&gt; 192.168.10.213</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">--resolve</span> bookinfo.cilium.rocks:443:<span class="k">${</span><span class="nv">GATEWAY2</span><span class="k">}</span> https://bookinfo.cilium.rocks/details/1 | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "id": 1,</span>
<span class="c">#      "author": "William Shakespeare",</span>
<span class="c">#      "year": 1595,</span>
<span class="c">#      "type": "paperback",</span>
<span class="c">#      "pages": 200,</span>
<span class="c">#      "publisher": "PublisherA",</span>
<span class="c">#      "language": "English",</span>
<span class="c">#      "ISBN-10": "1234567890",</span>
<span class="c">#      "ISBN-13": "123-1234567890"</span>
<span class="c">#    }</span>
  
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">--resolve</span> webpod.cilium.rocks:443:<span class="k">${</span><span class="nv">GATEWAY2</span><span class="k">}</span>   https://webpod.cilium.rocks/ <span class="nt">-v</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    * TLSv1.3 (OUT), TLS handshake, Client hello (1):</span>
<span class="c">#    *  CAfile: /etc/ssl/certs/ca-certificates.crt</span>
<span class="c">#    *  CApath: /etc/ssl/certs</span>
<span class="c">#    ...</span>
<span class="c">#    *  subjectAltName: host "webpod.cilium.rocks" matched cert's "*.cilium.rocks"</span>
<span class="c">#    *  issuer: O=mkcert development CA; OU=root@k8s-ctr; CN=mkcert root@k8s-ctr</span>
<span class="c">#    *  SSL certificate verify ok.</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>TLS Terminationì´ ì˜ ë˜ì–´ì„œ httpsë¡œ ìš”ì²­ì‹œ ì¸ì¦ì„œê°€ ìœ íš¨í•˜ê³ , ì„œë¹„ìŠ¤ë¡œ ìš”ì²­ì´ ì˜ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="tls-route">TLS Route</h5>

<ul>
  <li>TLS RouteëŠ” ì•ì—ì„œ ì‚´í´ë³¸ TLS Terminationê³¼ëŠ” ë‹¤ë¥´ê²Œ TLS Passthroughë¥¼ ì§€ì›í•©ë‹ˆë‹¤.
    <ul>
      <li><strong>TLS Termination</strong> : Gatewayê°€ TLS ì—°ê²°ì„ ì¢…ë£Œí•˜ê³ , ë‚´ë¶€ ì„œë¹„ìŠ¤ë¡œëŠ” í‰ë¬¸ HTTP íŠ¸ë˜í”½ì„ ì „ë‹¬í•©ë‹ˆë‹¤. (ì¦‰, Gatewayê°€ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ì˜ TLS ì„¸ì…˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.)</li>
      <li>
        <p><strong>TLS Passthrough</strong> : Gatewayê°€ TLS ì—°ê²°ì„ ì¢…ë£Œí•˜ì§€ ì•Šê³ , í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ì˜ TLS íŠ¸ë˜í”½ì„ ê·¸ëŒ€ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.</p>

        <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
        <div class="mermaid">
graph TD
  A[Client] --&gt;|TLS Handshake| B["Gateway (TLS Termination)"]
  B --&gt;|HTTP Traffic| C[Backend Service]
  A2[Client] --&gt;|TLS Handshake| B2["Gateway (TLS Passthrough)"]
  B2 --&gt;|TLS Traffic| C2[Backend Service]
</div>
      </li>
    </ul>
  </li>
  <li>ìƒ˜í”Œì•± ë°°í¬</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Deploy the Demo app : HTTPS ì›¹ì„œë²„</span>
<span class="c"># We will be using a NGINX web server. Review the NGINX configuration.</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">EOF</span><span class="sh">' &gt; nginx.conf
events {
}

http {
  log_format main '</span><span class="nv">$remote_addr</span><span class="sh"> - </span><span class="nv">$remote_user</span><span class="sh"> [</span><span class="nv">$time_local</span><span class="sh">]  </span><span class="nv">$status</span><span class="sh"> '
  '"</span><span class="nv">$request</span><span class="sh">" </span><span class="nv">$body_bytes_sent</span><span class="sh"> "</span><span class="nv">$http_referer</span><span class="sh">" '
  '"</span><span class="nv">$http_user_agent</span><span class="sh">" "</span><span class="nv">$http_x_forwarded_for</span><span class="sh">"';
  access_log /var/log/nginx/access.log main;
  error_log  /var/log/nginx/error.log;

  server {
    listen 443 ssl;

    root /usr/share/nginx/html;
    index index.html;

    server_name nginx.cilium.rocks;
    ssl_certificate /etc/nginx-server-certs/tls.crt;
    ssl_certificate_key /etc/nginx-server-certs/tls.key;
  }
}
</span><span class="no">EOF

</span><span class="c"># As you can see, it listens on port 443 for SSL traffic. Notice it specifies the certificate and key previously created.</span>
<span class="c"># We will need to mount the files to the right path (/etc/nginx-server-certs) when we deploy the server.</span>
<span class="c"># The NGINX server configuration is held in a Kubernetes ConfigMap. Let's create it.</span>
<span class="nv">$ </span>kubectl create configmap nginx-configmap <span class="nt">--from-file</span><span class="o">=</span>nginx.conf<span class="o">=</span>./nginx.conf
<span class="c"># =&gt; configmap/nginx-configmap created</span>

<span class="c"># Review the NGINX server Deployment and the Service fronting it:</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: my-nginx
  labels:
    run: my-nginx
spec:
  ports:
    - port: 443
      protocol: TCP
  selector:
    run: my-nginx
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-nginx
spec:
  selector:
    matchLabels:
      run: my-nginx
  replicas: 1
  template:
    metadata:
      labels:
        run: my-nginx
    spec:
      containers:
        - name: my-nginx
          image: nginx
          ports:
            - containerPort: 443
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx
              readOnly: true
            - name: nginx-server-certs
              mountPath: /etc/nginx-server-certs
              readOnly: true
      volumes:
        - name: nginx-config
          configMap:
            name: nginx-configmap
        - name: nginx-server-certs
          secret:
            secretName: demo-cert
</span><span class="no">EOF
</span><span class="c"># =&gt; service/my-nginx created</span>
<span class="c">#    deployment.apps/my-nginx created</span>

<span class="c"># Verify the Service and Deployment have been deployed successfully:</span>
<span class="nv">$ </span>kubectl get deployment,svc,ep my-nginx
<span class="c"># =&gt; NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/my-nginx   1/1     1            1           17s</span>
<span class="c">#    </span>
<span class="c">#    NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/my-nginx   ClusterIP   10.96.141.153   &lt;none&gt;        443/TCP   17s</span>
<span class="c">#    </span>
<span class="c">#    NAME                 ENDPOINTS          AGE</span>
<span class="c">#    endpoints/my-nginx   172.20.1.187:443   17s</span>
</code></pre></div></div>

<ul>
  <li>Gateway ë°°í¬</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># </span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: cilium-tls-gateway
spec:
  gatewayClassName: cilium
  listeners:
    - name: https
      hostname: "nginx.cilium.rocks"
      port: 443
      protocol: TLS
      tls:
        mode: Passthrough
      allowedRoutes:
        namespaces:
          from: All
---
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TLSRoute
metadata:
  name: nginx
spec:
  parentRefs:
    - name: cilium-tls-gateway
  hostnames:
    - "nginx.cilium.rocks"
  rules:
    - backendRefs:
        - name: my-nginx
          port: 443
</span><span class="no">EOF
</span><span class="c"># =&gt; gateway.gateway.networking.k8s.io/cilium-tls-gateway created</span>
<span class="c">#    tlsroute.gateway.networking.k8s.io/nginx created</span>

<span class="c"># The Gateway does not actually inspect the traffic aside from using the SNI header for routing. Indeed the hostnames field defines a set of SNI names that should match against the SNI attribute of TLS ClientHello message in TLS handshake.</span>
<span class="c"># Let's now deploy the Gateway and the TLSRoute to the cluste</span>
<span class="nv">$ </span>kubectl get gateway cilium-tls-gateway
<span class="c"># =&gt; NAME                 CLASS    ADDRESS          PROGRAMMED   AGE</span>
<span class="c">#    cilium-tls-gateway   cilium   192.168.10.214   True         10s</span>

<span class="nv">$ GATEWAY</span><span class="o">=</span><span class="si">$(</span>kubectl get gateway cilium-tls-gateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.addresses[0].value}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$GATEWAY</span>
<span class="c"># =&gt; 192.168.10.214</span>

<span class="c"># Let's also double check the TLSRoute has been provisioned successfully and has been attached to the Gateway.</span>
<span class="nv">$ </span>kubectl get tlsroutes.gateway.networking.k8s.io <span class="nt">-o</span> json | jq <span class="s1">'.items[0].status.parents[0]'</span>
<span class="c"># =&gt; {</span>
<span class="c">#      "conditions": [</span>
<span class="c">#        {</span>
<span class="c">#          "lastTransitionTime": "2025-08-23T11:34:35Z",</span>
<span class="c">#          "message": "Accepted TLSRoute",</span>
<span class="c">#          "observedGeneration": 1,</span>
<span class="c">#          "reason": "Accepted",</span>
<span class="c">#          "status": "True",</span>
<span class="c">#          "type": "Accepted"</span>
<span class="c">#        },</span>
<span class="c">#        {</span>
<span class="c">#          "lastTransitionTime": "2025-08-23T11:34:35Z",</span>
<span class="c">#          "message": "Service reference is valid",</span>
<span class="c">#          "observedGeneration": 1,</span>
<span class="c">#          "reason": "ResolvedRefs",</span>
<span class="c">#          "status": "True",</span>
<span class="c">#          "type": "ResolvedRefs"</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>TLS ìš”ì²­ ë³´ë‚´ê¸°</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># nginx íŒŒë“œì—ì„œ tcpdump ì‹¤í–‰</span>

<span class="c"># nginx íŒŒë“œë¡œ ì§„ì…</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> my-nginx-d65548cd4-nn5b4 <span class="nt">--</span> bash
<span class="nt">---</span>
<span class="c"># tcpdump ì„¤ì¹˜</span>
<span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt <span class="nb">install</span> <span class="nt">-y</span> tcpdump
<span class="c"># tcpdump ì‹¤í–‰ (ëª¨ë“  tcp íŒ¨í‚· ìº¡ì²˜)</span>
<span class="nv">$ </span>tcpdump tcp
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="c">#    listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="c">#    11:41:57.543620 IP 172.20.0.16.37591 &gt; my-nginx-d65548cd4-nn5b4.&lt;span style="color: green;"&gt;443&lt;/span&gt;: Flags [S], seq 2314011092, win 64240, options [mss 1460,sackOK,TS val 363195874 ecr 0,nop,wscale 7], length 0</span>
<span class="c">#    11:41:57.544029 IP my-nginx-d65548cd4-nn5b4.&lt;span style="color: green;"&gt;443&lt;/span&gt; &gt; 172.20.0.16.37591: Flags [S.], seq 3765696136, ack 2314011093, win 65160, options [mss 1460,sackOK,TS val 3668269186 ecr 363195874,nop,wscale 7], length 0</span>
<span class="c">#    11:41:57.546319 IP 172.20.0.16.37591 &gt; my-nginx-d65548cd4-nn5b4.443: Flags [.], ack 1, win 502, options [nop,nop,TS val 363195876 ecr 3668269186], length 0</span>
<span class="c">#    11:41:57.546319 IP 172.20.0.16.37591 &gt; my-nginx-d65548cd4-nn5b4.443: Flags [P.], seq 1:518, ack 1, win 502, options [nop,nop,TS val 363195876 ecr 3668269186], length 517    </span>
<span class="c">#    ...</span>
<span class="nt">---</span>

<span class="c"># k8s-ctrì—ì„œ TLS ìš”ì²­ ë³´ë‚´ê¸°</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">--resolve</span> <span class="s2">"nginx.cilium.rocks:443:</span><span class="nv">$GATEWAY</span><span class="s2">"</span> <span class="s2">"https://nginx.cilium.rocks:443"</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    * Server certificate:</span>
<span class="c">#    *  subject: O=mkcert development certificate; OU=root@k8s-ctr</span>
<span class="c">#    *  start date: Aug 23 08:27:20 2025 GMT</span>
<span class="c">#    *  expire date: Oct 01 08:27:20 2027 GMT</span>
<span class="c">#    *  subjectAltName: host "nginx.cilium.rocks" matched cert's "*.cilium.rocks"</span>
<span class="c">#    *  issuer: O=mkcert development CA; OU=root@k8s-ctr; CN=mkcert root@k8s-ctr</span>
<span class="c">#    *  SSL certificate verify ok.</span>
<span class="c">#    ...</span>
<span class="c">#    &lt; HTTP/1.1 200 OK</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>nginx íŒŒë“œì—ì„œ tcpdump ê²°ê³¼ nginxì˜ https(443) í¬íŠ¸ë¡œ ì¸ì…ë˜ì–´ https(443) í¬íŠ¸ë¥¼ í†µí•´ ì‘ë‹µì´ ë‚˜ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì¦‰, TLS Terminationê³¼ëŠ” ë‹¬ë¦¬ ì „ì²´ TLS íŠ¸ë˜í”½ì´ nginx íŒŒë“œê¹Œì§€ ì „ë‹¬ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="gateway-api-ì£¼ì†Œ-ì§€ì •">Gateway API ì£¼ì†Œ ì§€ì •</h5>

<ul>
  <li>Gatewayì˜ External IPë¥¼ ì§ì ‘ ì§€ì • ê°€ëŠ¥í•©ë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api/#gateway-api-addresses-support">ê´€ë ¨ ë¬¸ì„œ</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl edit gateway tls-gateway
<span class="c"># specì— addresses ì¶”ê°€</span>
<span class="nt">---</span>
...
spec:
  addresses:                <span class="c"># ì¶”ê°€ë¨</span>
  - <span class="nb">type</span>: IPAddress         <span class="c">#     </span>
    value: 192.168.10.219   <span class="c"># </span>
  gatewayClassName: cilium
...
<span class="nt">---</span>
<span class="c"># =&gt; gateway.gateway.networking.k8s.io/tls-gateway edited</span>
</code></pre></div></div>

<ul>
  <li>í˜¸ì¶œ í…ŒìŠ¤íŠ¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ GATEWAY</span><span class="o">=</span><span class="si">$(</span>kubectl get gateway tls-gateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.addresses[0].value}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$GATEWAY</span>
<span class="c"># =&gt; 192.168.10.219</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì§€ì •í•œ IP(192.168.10.219)ë¡œ External IPê°€ ë³€ê²½ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">--resolve</span> <span class="s2">"nginx.cilium.rocks:443:</span><span class="nv">$GATEWAY</span><span class="s2">"</span> <span class="s2">"https://nginx.cilium.rocks:443"</span> 
</code></pre></div></div>

<h5 id="ingressì—ì„œ-gateway-apië¡œ-ë§ˆì´ê·¸ë ˆì´ì…˜">Ingressì—ì„œ Gateway APIë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜</h5>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress-to-gateway/ingress-to-gateway/">ê´€ë ¨ ë¬¸ì„œ</a></li>
  <li><strong>ìˆ˜ë™ ì „í™˜</strong> : ê¸°ì¡´ì˜ Ingress API ë¦¬ì†ŒìŠ¤ë¥¼ ì°¸ê³ í•˜ì—¬ ë™ì¼í•œ êµ¬ì„±ì„ ê°€ì§„ Gateway API ë¦¬ì†ŒìŠ¤ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.</li>
  <li><strong>ìë™ ì „í™˜</strong> : <a href="https://github.com/kubernetes-sigs/ingress2gateway">ingress2gateway</a> íˆ´ê³¼ ê°™ì€ ìë™í™” ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ Ingress ë¦¬ì†ŒìŠ¤ë¥¼ Gateway API ë¦¬ì†ŒìŠ¤ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.</li>
  <li>ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì œ
    <ul>
      <li>HTTP Migration ì˜ˆì œ - <a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress-to-gateway/http-migration/">Docs</a></li>
      <li>TLS Migration ì˜ˆì œ - <a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress-to-gateway/tls-migration/">Docs</a></li>
    </ul>
  </li>
</ul>

<h6 id="ì‹¤ìŠµ-ë¦¬ì†ŒìŠ¤-ì‚­ì œ">ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Gateway ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete gateway my-gateway tls-gateway cilium-tls-gateway

<span class="c"># Bookinfo ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/istio/istio/release-1.26/samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></div></div>

<hr />

<h2 id="mutual-authentication-beta">Mutual Authentication (Beta)</h2>

<ul>
  <li>Ciliumë„ istioì™€ ë§ˆì°¬ê°€ì§€ë¡œ SPIFFE(â€œìŠ¤í”¼í˜â€ë¼ê³  ë°œìŒí•˜ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.) í†µí•œ ìƒí˜¸ ì¸ì¦ì„ ì§€ì›í•©ë‹ˆë‹¤.</li>
  <li>ì•„ì§ì€ Beta ë‹¨ê³„ì´ê¸° ë•Œë¬¸ì— í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ê¸°ì—ëŠ” ë¬´ë¦¬ê°€ ìˆì–´ë³´ì…ë‹ˆë‹¤.</li>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/mutual-authentication/mutual-authentication/">ê´€ë ¨ ë¬¸ì„œ</a></li>
</ul>

<h3 id="ì£¼ìš”-ê°œë…">ì£¼ìš” ê°œë…</h3>

<ul>
  <li>SPIFFE
    <ul>
      <li>Secure Production Identity Framework For Everyoneì˜ ì•½ìë¡œ
í´ë¼ìš°ë“œ ë„¤ì´í‹°ë¸Œ í™˜ê²½ì—ì„œ ì„œë¹„ìŠ¤ ê°„ì˜ ì‹ ë¢°ë¥¼ êµ¬ì¶•í•˜ê¸° ìœ„í•œ ì˜¤í”ˆ ì†ŒìŠ¤ í‘œì¤€ì…ë‹ˆë‹¤.</li>
      <li>ì„œë¹„ìŠ¤ê°€ ì„œë¡œë¥¼ ì‹ ë¢°í•  ìˆ˜ ìˆë„ë¡ ê³ ìœ í•œ ì‹ë³„ì(SPIFFE ID)ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
      <li>IDë¥¼ ë°œê¸‰í•˜ê³  ë¶€íŠ¸ìŠ¤íŠ¸ë©í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì‚¬ì–‘ì„ ì •ì˜ í•©ë‹ˆë‹¤.
        <ul>
          <li>SPIFFE ID : ì‹ ë¢° ë„ë©”ì¸ ë‚´ì˜ ì„œë¹„ìŠ¤ ê³ ìœ  ID</li>
          <li>Workload Endpoint : ì›Œí¬ë¡œë“œì˜ IDë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì—”ë“œí¬ì¸íŠ¸</li>
          <li>Workload API : SPIFFE IDê°€ í¬í•¨ëœ ì¸ì¦ì„œë¥¼ ì„œëª…í•˜ê³  ë°œê¸‰í•˜ëŠ” API</li>
          <li>SVID (SPIFFE Verifiable Identity Document) : Workload APIê°€ ë°œê¸‰í•˜ëŠ” ì¸ì¦ì„œ</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>TLSì™€ mTLS - <a href="https://www.jacobbaek.com/1040">ê´€ë ¨ ë¸”ë¡œê·¸</a>
    <ul>
      <li>TLS (Transport Layer Security) : ë„¤íŠ¸ì›Œí¬ í†µì‹ ì„ ì•”í˜¸í™”í•˜ì—¬ ë°ì´í„°ì˜ ê¸°ë°€ì„±ê³¼ ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ëŠ” í”„ë¡œí† ì½œì…ë‹ˆë‹¤.</li>
      <li>mTLS (Mutual TLS) : TLSì˜ í™•ì¥ìœ¼ë¡œ, í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°€ ì„œë¡œë¥¼ ì¸ì¦í•˜ëŠ” ì–‘ë°©í–¥ ì¸ì¦ì„ ì œê³µí•©ë‹ˆë‹¤.
        <ul>
          <li>ê¸°ë³¸ TLSê°€ ì„œë²„ì¸¡ì˜ ì¸ì¦ì„œë¥¼ í™œìš©í•˜ì—¬, ì í•©í•œ ì„œë²„ì„ì„ ì¦ëª…í•˜ëŠ”ê²ƒ ê³¼ëŠ” ë‹¬ë¦¬ mTLSëŠ” í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ëª¨ë‘ê°€ ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¡œì˜ ì‹ ì›ì„ í™•ì¸í•©ë‹ˆë‹¤.</li>
          <li>mTLSëŠ” ì„œë¹„ìŠ¤ ê°„ì˜ ì‹ ë¢°ë¥¼ êµ¬ì¶•í•˜ê³ , ì¤‘ê°„ì ê³µê²©ê³¼ ê°™ì€ ë³´ì•ˆ ìœ„í˜‘ì„ ë°©ì§€í•˜ëŠ” ë° íš¨ê³¼ì ì…ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="ciliumì—ì„œì˜-ìƒí˜¸-ì¸ì¦">Ciliumì—ì„œì˜ ìƒí˜¸ ì¸ì¦</h3>

<ul>
  <li>Ciliumì€ SPIFFE í‘œì¤€ì„ ì¤€ìˆ˜í•˜ëŠ” êµ¬í˜„ì²´ì¸ <a href="https://spiffe.io/spire/">spire ì„œë²„</a>ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒí˜¸ì¸ì¦ì„ êµ¬í˜„í•©ë‹ˆë‹¤.</li>
  <li>Ciliumì€ spire ì„œë²„ì™€ í†µì‹ í•˜ì—¬ ê° ì›Œí¬ë¡œë“œì— ëŒ€í•œ SPIFFE IDë¥¼ ë°œê¸‰ë°›ê³ , ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê° ë…¸ë“œì—ì„œ ì‹¤í–‰ì¤‘ì¸ ì›Œí¬ë¡œë“œì˜ ID ìš”ì²­ì„ ê²€ì¦í•©ë‹ˆë‹¤.</li>
  <li>Spire ì„œë²„ëŠ” Kubernetesì—ì„œ ì‹¤í–‰ë˜ëŠ” Spire ì—ì´ì „íŠ¸ì˜ ê²€ì¦ì„ ìœ„í•´ PSAT(Kubernetes Projected Service Account Token)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_11.png" alt="img.png" class="image-center" />
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_13.png" alt="img_2.png" class="image-center" />
<em class="image-caption">Ciliumì˜ ìƒí˜¸ì¸ì¦ êµ¬ì¡°</em></p>

<h5 id="ciliumì˜-ìƒí˜¸-ì¸ì¦-ì•„í‚¤í…ì³">Ciliumì˜ ìƒí˜¸ ì¸ì¦ ì•„í‚¤í…ì³</h5>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_14.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>Ciliumì˜ ìƒí˜¸ ì¸ì¦ì€ ë‹¤ìŒê³¼ ê°™ì€ ì£¼ìš” êµ¬ì„± ìš”ì†Œë¡œ ì´ë£¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li><strong>Spire ì„œë²„</strong> : SPIFFE IDë¥¼ ë°œê¸‰í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì¤‘ì•™ ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤. Cilium Operatorì™€ í†µì‹ í•˜ì—¬ ì›Œí¬ë¡œë“œì˜ ID ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.</li>
      <li><strong>Spire ì—ì´ì „íŠ¸</strong> : ê° ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ë©°, Spire ì„œë²„ì™€ í†µì‹ í•˜ì—¬ ì›Œí¬ë¡œë“œì— ëŒ€í•œ SPIFFE IDë¥¼ ìš”ì²­í•˜ê³  ê°±ì‹ í•©ë‹ˆë‹¤.</li>
      <li><strong>Cilium Agent</strong> : ê° ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ë©°, Spire ì—ì´ì „íŠ¸ì™€ í†µì‹ í•˜ì—¬ ì›Œí¬ë¡œë“œì˜ IDë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="l7-aware-traffic-management">L7-Aware Traffic Management</h2>

<h3 id="l7-aware-traffic-management-ì†Œê°œ">L7-Aware Traffic Management ì†Œê°œ</h3>

<ul>
  <li>L7-Aware Traffic ManagementëŠ” HTTP, gRPCì™€ ê°™ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ(Layer 7) í”„ë¡œí† ì½œì˜ íŠ¹ì„±ì„ ì´í•´í•˜ê³  ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ íŠ¸ë˜í”½ì„ ì„¸ë°€í•˜ê²Œ ì œì–´í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</li>
  <li>Ciliumì€ eBPFì™€ Envoy í”„ë¡ì‹œë¥¼ í†µí•´ ê°•ë ¥í•œ L7 íŠ¸ë˜í”½ ê´€ë¦¬ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="ì£¼ìš”-ê¸°ëŠ¥">ì£¼ìš” ê¸°ëŠ¥</h5>

<ul>
  <li><strong>L7 í”„ë¡œí† ì½œ ì¸ì‹</strong>: HTTP, gRPC, Kafka ë“± ë‹¤ì–‘í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ í”„ë¡œí† ì½œì„ ì¸ì‹í•˜ê³  ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>ê³ ê¸‰ ë¡œë“œ ë°¸ëŸ°ì‹±</strong>: ìš”ì²­ í—¤ë”, ê²½ë¡œ, ë©”ì†Œë“œ ë“±ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì§€ëŠ¥ì ì¸ ë¡œë“œ ë°¸ëŸ°ì‹±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li><strong>íŠ¸ë˜í”½ ë¶„í• </strong>: ë™ì¼í•œ ì„œë¹„ìŠ¤ì˜ ì—¬ëŸ¬ ë²„ì „ ê°„ì— íŠ¸ë˜í”½ì„ ë¹„ìœ¨ì— ë”°ë¼ ë¶„ë°°í•  ìˆ˜ ìˆì–´ ì¹´ë‚˜ë¦¬ ë°°í¬ ë° A/B í…ŒìŠ¤íŠ¸ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
  <li><strong>ìë™ ì¬ì‹œë„</strong>: ì¼ì‹œì ì¸ ì˜¤ë¥˜ ë°œìƒ ì‹œ ìš”ì²­ì„ ìë™ìœ¼ë¡œ ì¬ì‹œë„í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë³µì›ë ¥ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>íƒ€ì„ì•„ì›ƒ ë° ì„œí‚· ë¸Œë ˆì´í‚¹</strong>: ì¥ì•  í™•ì‚°ì„ ë°©ì§€í•˜ê¸° ìœ„í•œ íƒ€ì„ì•„ì›ƒ ì„¤ì • ë° ì„œí‚· ë¸Œë ˆì´ì»¤ íŒ¨í„´ì„ ì§€ì›í•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="êµ¬í˜„-ë°©ì‹">êµ¬í˜„ ë°©ì‹</h5>

<ul>
  <li>Ciliumì€ eBPFë¥¼ ì‚¬ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ê°€ë¡œì±„ê³ , L7 ì²˜ë¦¬ê°€ í•„ìš”í•œ ê²½ìš° Envoy í”„ë¡ì‹œë¡œ íŠ¸ë˜í”½ì„ ë¦¬ë””ë ‰ì…˜í•©ë‹ˆë‹¤.</li>
  <li>ì´ëŸ¬í•œ ì•„í‚¤í…ì²˜ëŠ” ê¸°ì¡´ ì„œë¹„ìŠ¤ ë©”ì‹œ ì†”ë£¨ì…˜ì— ë¹„í•´ ë” ì ì€ ì˜¤ë²„í—¤ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="istioì™€ì˜-ë¹„êµ">Istioì™€ì˜ ë¹„êµ</h5>

<ul>
  <li>Ciliumì˜ L7 íŠ¸ë˜í”½ ê´€ë¦¬ëŠ” Istioì™€ ê°™ì€ ê¸°ì¡´ Service Mesh ë³´ë‹¤ ì„±ëŠ¥ ì˜¤ë²„í—¤ë“œê°€ ì ìŠµë‹ˆë‹¤.</li>
  <li>kubeproxy ëŒ€ì‹  eBPFë¥¼ ì‚¬ìš©í•˜ì—¬ í•„ìš”í•œ íŠ¸ë˜í”½ë§Œ ì„ íƒì ìœ¼ë¡œ Envoy í”„ë¡ì‹œë¡œ ë¦¬ë””ë ‰ì…˜í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
  <li>ê·¸ëŸ¬ë‚˜ ê¸°ëŠ¥ ì¸¡ë©´ì—ì„œëŠ” Istioê°€ ë” í’ë¶€í•œ ì˜µì…˜ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ì‹¤ìŠµ-l7-íŠ¸ë˜í”½-ê´€ë¦¬">ì‹¤ìŠµ: L7 íŠ¸ë˜í”½ ê´€ë¦¬</h3>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì—ëŠ” isovalentì—ì„œ ì œê³µí•˜ëŠ” ì˜¨ë¼ì¸ Lab í™˜ê²½ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. <a href="https://isovalent.com/labs/cilium-envoy-l7-proxy/">https://isovalent.com/labs/cilium-envoy-l7-proxy/</a></li>
</ul>

<h5 id="ì‹¤ìŠµí™˜ê²½-ì„¤ì •">ì‹¤ìŠµí™˜ê²½ ì„¤ì •</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°ëª¨ ì•± ì„¤ì¹˜</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> sw-pods.yaml
<span class="c"># =&gt; service/deathstar created</span>
<span class="c">#    deployment.apps/deathstar created</span>
<span class="c">#    pod/tiefighter created</span>
<span class="c">#    pod/xwing created</span>

<span class="c"># ì•± ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl rollout status deployment/deathstar
<span class="c"># =&gt; deployment "deathstar" successfully rolled out</span>

<span class="nv">$ </span>kubectl get pod xwing
<span class="c"># =&gt; NAME    READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    xwing   1/1     Running   0          2m22s</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">--max-time</span> 1 <span class="nt">-s</span> <span class="nt">-X</span> POST deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>

<span class="nv">$ </span>hubble observe <span class="nt">--to-pod</span> default/deathstar
<span class="c"># =&gt; Aug 23 14:05:42.357: default/xwing (ID:57137) &lt;&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) post-xlate-fwd TRANSLATED (TCP)</span>
<span class="c">#    Aug 23 14:05:42.357: default/xwing:54550 (ID:57137) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-endpoint FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Aug 23 14:05:42.357: default/xwing:54550 (ID:57137) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-endpoint FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Aug 23 14:05:42.357: default/xwing:54550 (ID:57137) &lt;&gt; default/deathstar-67c5c5c88-d9xct (ID:3549) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Aug 23 14:05:42.357: default/xwing:54550 (ID:57137) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Aug 23 14:05:42.358: default/xwing:54550 (ID:57137) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Aug 23 14:05:42.358: default/xwing:54550 (ID:57137) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-endpoint FORWARDED (TCP Flags: ACK)</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_16.png" alt="img.png" /></p>

<h5 id="http-íŠ¸ë˜í”½-ê´€ì¸¡í•˜ê¸°">HTTP íŠ¸ë˜í”½ ê´€ì¸¡í•˜ê¸°</h5>

<ul>
  <li>L7 Cilium Network Policyë¥¼ ì‚¬ìš©í•˜ì—¬ HTTP íŠ¸ë˜í”½ì„ ê´€ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># The trace:to-proxy filter will show all flows that go through a proxy. In general, this could be either Envoy or the Cilium DNS proxy. </span>
<span class="c"># However, since we have not yet deployed a DNS Network Policy, you will only see flows related to Envoy at the moment.</span>
<span class="nv">$ </span>hubble observe <span class="nt">--type</span> trace:to-proxy
<span class="c"># =&gt; Aug 23 14:10:33.004: default/tiefighter:53502 (ID:13923) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-proxy FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Aug 23 14:10:33.004: default/tiefighter:53502 (ID:13923) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-proxy FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Aug 23 14:10:33.004: default/tiefighter:53502 (ID:13923) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-proxy FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Aug 23 14:10:33.006: default/tiefighter:53502 (ID:13923) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-proxy FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    ...</span>

<span class="c"># Let's extract all the flow information based on the protocol (e.g. HTTP) and source pod (e.g. the Tie Fighter), then export the result with the JSON output option, and finally filter with jq to only see the .flow.l7 field. This will show us the specific details parsed from the L7 traffic, such as the method and headers:</span>
<span class="c"># Observe the details of the flow, in particular the envoy-specific headers added to the request:</span>
<span class="c">## X-Envoy-Internal</span>
<span class="c">## X-Request-Id</span>
<span class="nv">$ </span>hubble observe <span class="nt">--protocol</span> http <span class="nt">--from-pod</span> default/tiefighter <span class="nt">-o</span> jsonpb | <span class="se">\</span>
  <span class="nb">head</span> <span class="nt">-n</span> 1 | jq <span class="s1">'.flow.l7'</span>
<span class="c"># =&gt; {</span>
<span class="c">#      "type": "REQUEST",</span>
<span class="c">#      "http": {</span>
<span class="c">#        "method": "POST",</span>
<span class="c">#        "url": "http://deathstar.default.svc.cluster.local/v1/request-landing",</span>
<span class="c">#        "protocol": "HTTP/1.1",</span>
<span class="c">#        "headers": [</span>
<span class="c">#          {</span>
<span class="c">#            "key": ":scheme",</span>
<span class="c">#            "value": "http"</span>
<span class="c">#          },</span>
<span class="c">#          {</span>
<span class="c">#            "key": "Accept",</span>
<span class="c">#            "value": "*/*"</span>
<span class="c">#          },</span>
<span class="c">#          {</span>
<span class="c">#            "key": "User-Agent",</span>
<span class="c">#            "value": "curl/7.88.1"</span>
<span class="c">#          },</span>
<span class="c">#          {</span>
<span class="c">#            "key": "X-Envoy-Internal",</span>
<span class="c">#            "value": "true"</span>
<span class="c">#          },</span>
<span class="c">#          {</span>
<span class="c">#            "key": "X-Request-Id",</span>
<span class="c">#            "value": "45ee8e37-6ae0-48bf-925d-13c98532b113"</span>
<span class="c">#          }</span>
<span class="c">#        ]</span>
<span class="c">#      }</span>
<span class="c">#    }</span>

<span class="c"># Let's use the X-Request-Id to match a request and its response.</span>
<span class="c"># First, we'll need to make sure egress traffic from the Tie Fighter is captured by Envoy, so we'll need a L7 CNP for that.</span>
<span class="c"># If we apply an egress CNP though, this will disrupt DNS requests, which are also egress traffic, so we need to add a DNS policy as well:</span>
<span class="nv">$ </span><span class="nb">cat </span>policies/tiefighter.yaml
<span class="c"># =&gt; apiVersion: cilium.io/v2</span>
<span class="c">#    kind: CiliumNetworkPolicy</span>
<span class="c">#    metadata:</span>
<span class="c">#      name: tiefighter</span>
<span class="c">#      namespace: default</span>
<span class="c">#    spec:</span>
<span class="c">#      endpointSelector:</span>
<span class="c">#        matchLabels:</span>
<span class="c">#          org: empire</span>
<span class="c">#          class: tiefighter</span>
<span class="c">#      egress:</span>
<span class="c">#        - toEndpoints:</span>
<span class="c">#            - matchLabels:</span>
<span class="c">#                class: deathstar</span>
<span class="c">#                org: empire</span>
<span class="c">#          toPorts:</span>
<span class="c">#            - ports:</span>
<span class="c">#                - port: "80"</span>
<span class="c">#                  protocol: TCP</span>
<span class="c">#              rules:</span>
<span class="c">#                http:</span>
<span class="c">#                - method: POST</span>
<span class="c">#                  path: /v1/request-landing</span>
              
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> policies/dns.yaml <span class="nt">-f</span> policies/tiefighter.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/dns created</span>
<span class="c">#    ciliumnetworkpolicy.cilium.io/tiefighter created</span>

<span class="c"># All these flows are ingress flows, as you can see by filtering for HTTP flows in the egress direction, which should return nothing:</span>
<span class="c"># You can now see egress requests from the Tie Fighter being forwarded to the Death Star, as well as the responses from the Death Star:</span>
<span class="c"># When using Kubernetes Network Policies, responses are automatically allowed and do not require an explicit rule.</span>
<span class="c"># This is why egress traffic corresponding to the response from the Death Star to the Tie Fighter is allowed, even though there is not egress policy for it.</span>
<span class="nv">$ </span>hubble observe <span class="nt">--protocol</span> http <span class="nt">--traffic-direction</span> egress
<span class="c"># =&gt; Aug 23 14:12:40.875: default/tiefighter:57526 (ID:13923) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) http-request FORWARDED (HTTP/1.1 POST http://deathstar.default.svc.cluster.local/v1/request-landing)</span>
<span class="c">#    Aug 23 14:12:40.876: default/tiefighter:57526 (ID:13923) &lt;- default/deathstar-67c5c5c88-d9xct:80 (ID:3549) http-response FORWARDED (HTTP/1.1 200 0ms (POST http://deathstar.default.svc.cluster.local/v1/request-landing))</span>
<span class="c">#    ...</span>

<span class="c"># Now, let's match request IDs! Run the following command to record some Hubble HTTP flows and save them to a file:</span>
<span class="nv">$ </span>hubble observe <span class="nt">--namespace</span> default <span class="nt">--protocol</span> http <span class="nt">-o</span> jsonpb <span class="o">&gt;</span> flows.json

<span class="c"># Find the first EGRESS flow in the file and get its ID:</span>
<span class="nv">$ REQUEST_ID</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat </span>flows.json | jq <span class="nt">-r</span> <span class="s1">'.flow | select(.source.labels[0]=="k8s:app.kubernetes.io/name=tiefighter" and .traffic_direction=="EGRESS") .l7.http.headers[] | select(.key=="X-Request-Id") .value'</span> | <span class="nb">head</span> <span class="nt">-n1</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$REQUEST_ID</span>
<span class="c"># =&gt; 91e9eb02-b1a7-4379-9825-8c6f72124d04</span>

<span class="c"># Then find all flows with this request ID in the file and display their source identities:</span>
<span class="c">## an egress flow from the tiefighter to the deathstar, corresponding to the original request</span>
<span class="c">## the ingress flow for the same request, being forwarded from the proxy to the Death Star</span>
<span class="c">## another egress flow for the response, from the deathstar to the tiefighter</span>
<span class="c">## the corresponding ingress flow from the deathstar pod to the tiefighter</span>

<span class="nv">$ </span><span class="nb">cat </span>flows.json | <span class="se">\</span>
  jq <span class="s1">'select(.flow.l7.http.headers[] | .value == "'</span><span class="nv">$REQUEST_ID</span><span class="s1">'") .flow | {src_label: .source.labels[0], dst_label: .destination.labels[0], traffic_direction, type: .l7.type, time}'</span>
<span class="c"># =&gt; {</span>
<span class="c">#      "src_label": "k8s:app.kubernetes.io/name=tiefighter",</span>
<span class="c">#      "dst_label": "k8s:app.kubernetes.io/name=deathstar",</span>
<span class="c">#      "traffic_direction": "EGRESS",</span>
<span class="c">#      "type": "REQUEST",</span>
<span class="c">#      "time": "2025-08-23T14:13:38.661418360Z"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "src_label": "k8s:app.kubernetes.io/name=tiefighter",</span>
<span class="c">#      "dst_label": "k8s:app.kubernetes.io/name=deathstar",</span>
<span class="c">#      "traffic_direction": "INGRESS",</span>
<span class="c">#      "type": "REQUEST",</span>
<span class="c">#      "time": "2025-08-23T14:13:38.661841958Z"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "src_label": "k8s:app.kubernetes.io/name=deathstar",</span>
<span class="c">#      "dst_label": "k8s:app.kubernetes.io/name=tiefighter",</span>
<span class="c">#      "traffic_direction": "INGRESS",</span>
<span class="c">#      "type": "RESPONSE",</span>
<span class="c">#      "time": "2025-08-23T14:13:38.662308747Z"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "src_label": "k8s:app.kubernetes.io/name=deathstar",</span>
<span class="c">#      "dst_label": "k8s:app.kubernetes.io/name=tiefighter",</span>
<span class="c">#      "traffic_direction": "EGRESS",</span>
<span class="c">#      "type": "RESPONSE",</span>
<span class="c">#      "time": "2025-08-23T14:13:38.662497732Z"</span>
<span class="c">#    }</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_17.png" alt="img.png" /></p>

<h5 id="l7-ë©”íŠ¸ë¦­">L7 ë©”íŠ¸ë¦­</h5>

<ul>
  <li>Envoyë¥¼ í†µí•´ Hubbleì—ì„œ L7 ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•  ìˆ˜ ìˆê³ , Prometheusë¡œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_15.png" alt="img.png" class="image-center image-bg" />
<em class="image-caption">Ciliumì˜ L7 ë©”íŠ¸ë¦­ ìˆ˜ì§‘</em></p>

<h5 id="envoyë¥¼-í†µí•œ-l7-ë„¤íŠ¸ì›Œí¬-ì •ì±…-ì ìš©">Envoyë¥¼ í†µí•œ L7 ë„¤íŠ¸ì›Œí¬ ì •ì±… ì ìš©</h5>

<ul>
  <li><strong>HTTP</strong> : ì§€ë‚œ í¬ìŠ¤íŠ¸ì—ì„œ <a href="https://sweetlittlebird.github.io/posts/2025-07-27-Cilium-Week2/#http-aware-l7-%EC%A0%95%EC%B1%85-%EC%A0%81%EC%9A%A9-%EB%B0%8F-%ED%85%8C%EC%8A%A4%ED%8A%B8">[Cilium] (Observability) Hubble, Prometheus, Grafana</a>
Http-aware L7 ì •ì±… ì ìš© ë° í…ŒìŠ¤íŠ¸ë¥¼ ë‹¤ë¤˜ìŠµë‹ˆë‹¤. í•´ë‹¹ í¬ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.</li>
</ul>

<h3 id="l7-aware-traffic-management-í™œì„±í™”">L7-Aware Traffic Management í™œì„±í™”</h3>

<ul>
  <li>CiliumEnvoyConfig , CiliumClusterwideEnvoyConfig - <a href="https://docs.cilium.io/en/stable/network/servicemesh/l7-traffic-management/">Docs</a>
    <ul>
      <li>ì£¼ì˜ì‚¬í•­ :
        <ul>
          <li>CiliumEnvoyConfig ë¦¬ì†ŒìŠ¤ëŠ” ìµœì†Œí•œì˜ ê²€ì¦ë§Œ ìˆ˜í–‰ë˜ë©° ì •ì˜ëœ ì¶©ëŒ í•´ê²° ë™ì‘ì´ ì—†ìŠµë‹ˆë‹¤. ì¦‰, EnvoyConfigì˜ ë™ì¼í•œ êµ¬ì„± ë¶€ë¶„ì„ ìˆ˜ì •í•˜ëŠ” CECë¥¼ ì—¬ëŸ¬ ê°œ ë§Œë“¤ë©´ ê²°ê³¼ë¥¼ ì˜ˆì¸¡í•  ìˆ˜ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ì´ ìµœì†Œí•œì˜ ê²€ì¦ ì™¸ì—ë„, CiliumEnvoyConfigëŠ” ì‚¬ìš©ìì—ê²Œ êµ¬ì„±ì˜ ì •í™•ì„±ì— ëŒ€í•œ í”¼ë“œë°±ì„ ìµœì†Œí•œìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤. ë”°ë¼ì„œ CECê°€ ë°”ëŒì§í•˜ì§€ ì•Šì€ ê²°ê³¼ë¥¼ ì´ˆë˜í•  ê²½ìš°, ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ì„œëŠ” ë¬¸ì œì˜ CiliumEnvoyConfigë¥¼ í™•ì¸í•  ìˆ˜ ìˆëŠ” ëŒ€ì‹  EnvoyConfigë¥¼ ê²€í† í•´ì•¼ í•©ë‹ˆë‹¤.</li>
          <li>CiliumEnvoyConfigëŠ” Ciliumì˜ Ingress ë° Gateway API ì§€ì›ì„ í†µí•´ ë…¸ë“œë³„ Envoy í”„ë¡ì‹œë¥¼ í†µí•´ íŠ¸ë˜í”½ì„ ìœ ë„í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ìë™ ìƒì„±ëœ êµ¬ì„±ê³¼ ì¶©ëŒí•˜ê±°ë‚˜ ìˆ˜ì •í•˜ëŠ” CECë¥¼ ë§Œë“¤ë©´ ê²°ê³¼ë¥¼ ì˜ˆì¸¡í•  ìˆ˜ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì‚¬ìš© ì‚¬ë¡€ì—ì„œëŠ” CECë¥¼ ì‚¬ìš©í•˜ëŠ” ë° ë§¤ìš° ì£¼ì˜í•˜ì„¸ìš”. ìœ„ì˜ ìœ„í—˜ì€ Ciliumì—ì„œ ìƒì„±ëœ ëª¨ë“  êµ¬ì„±ì´ ê°€ëŠ¥í•œ í•œ ì˜ë¯¸ì ìœ¼ë¡œ ìœ íš¨í•œì§€ í™•ì¸í•¨ìœ¼ë¡œì¨ ê´€ë¦¬ë©ë‹ˆë‹¤.</li>
          <li>CiliumEnvoyConfig ë¦¬ì†ŒìŠ¤ë¥¼ ì§ì ‘ ìƒì„±í•˜ëŠ” ê²½ìš°(ì¦‰, Cilium Ingress ë˜ëŠ” Gateway API ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í†µí•´ ìƒì„±í•˜ì§€ ì•Šê³ ), CECê°€ E/W íŠ¸ë˜í”½ì„ ê´€ë¦¬í•˜ë ¤ëŠ” ê²½ìš° ë ˆì´ë¸” cilium.io/use-original-source-address : â€œfalseâ€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´, EnvoyConfigëŠ” ì—…ìŠ¤íŠ¸ë¦¼ ì—°ê²° í’€ì˜ ì†Œì¼“ì„ ì›ë˜ ì†ŒìŠ¤ ì£¼ì†Œ/í¬íŠ¸ì— ë°”ì¸ë”©í•©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ í¬ë“œê°€ ë™ì¼í•œ íŒŒì´í”„ë¼ì¸ HTTP/1.1 ë˜ëŠ” HTTP/2 ì—°ê²°ì„ í†µí•´ ì—¬ëŸ¬ ìš”ì²­ì„ ë³´ë‚¼ ë•Œ 5-tup ì¶©ëŒì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Cilium ì—ì´ì „íŠ¸ëŠ” ë¶€ëª¨ Refê°€ Cilium Ingress ë˜ëŠ” Gateway API ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ê°€ë¦¬í‚¤ëŠ” ëª¨ë“  CECê°€ cilium.io/use-original-source-address ì„ â€œfalseâ€ë¡œ ì„¤ì •í•œ ê²ƒìœ¼ë¡œ ê°€ì •í•˜ì§€ë§Œ, ë‹¤ë¥¸ ëª¨ë“  CECëŠ” ì´ ë ˆì´ë¸”ì„ â€œtrueâ€ë¡œ ì„¤ì •í•œ ê²ƒìœ¼ë¡œ ê°€ì •í•©ë‹ˆë‹¤.)</li>
          <li>í˜„ì¬ëŠ” Envoy API v3ë§Œ ì§€ì›í•©ë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/network/servicemesh/l7-traffic-management/#supported-envoy-api-versions">Docs</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ì„¤ì •
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> ingressController.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> gatewayAPI.enabled<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> envoyConfig.enabled<span class="o">=</span><span class="nb">true</span>  <span class="nt">--set</span> loadBalancer.l7.backend<span class="o">=</span>envoy
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
  
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart deployment/cilium-operator
<span class="c"># =&gt; deployment.apps/cilium-operator restarted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium-envoy
<span class="c"># =&gt; daemonset.apps/cilium-envoy restarted</span>
  
<span class="c">#</span>
<span class="nv">$ </span>cilium config view |grep <span class="nt">-i</span> envoy
<span class="c"># =&gt; enable-envoy-config                               true</span>
<span class="c">#    envoy-access-log-buffer-size                      4096</span>
<span class="c">#    envoy-base-id                                     0</span>
<span class="c">#    envoy-config-retry-interval                       15s</span>
<span class="c">#    envoy-keep-cap-netbindservice                     false</span>
<span class="c">#    envoy-secrets-namespace                           cilium-secrets</span>
<span class="c">#    external-envoy-proxy                              true</span>
<span class="c">#    loadbalancer-l7                                   envoy</span>
<span class="nv">$ </span>cilium status <span class="nt">--wait</span>
</code></pre></div>    </div>
  </li>
  <li>ì§€ì›í•˜ëŠ” Envoy í™•ì¥ ë¦¬ì†ŒìŠ¤ ìœ í˜•
    <ul>
      <li>í™•ì¥ì€ Envoy ë¹Œë“œì— ì„ íƒì ìœ¼ë¡œ í¬í•¨ë  ìˆ˜ ìˆëŠ” ë¦¬ì†ŒìŠ¤ ìœ í˜•ì…ë‹ˆë‹¤. Envoy ë¬¸ì„œì—ì„œ ì–¸ê¸‰ë˜ëŠ” í‘œì¤€ ìœ í˜•ë“¤, 
ì˜ˆë¥¼ ë“¤ì–´ <code class="language-plaintext highlighter-rouge">type.googleapis.com/envoy.config.listener.v3.Listener</code>ì™€ 
<code class="language-plaintext highlighter-rouge">type.googleapis.com/envoy.config.route.v3.RouteConfiguration</code>ì€ í•­ìƒ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>Cilium ë…¸ë“œëŠ” Cilium HTTP ì •ì±… ì ìš© ë° ê´€ì¸¡ ê°€ëŠ¥ì„±ì„ ì§€ì›í•˜ê¸° ìœ„í•´ Envoy ì´ë¯¸ì§€ë¥¼ ë°°í¬í•©ë‹ˆë‹¤.
ì´ Envoy ë¹Œë“œëŠ” Cilium Agentì˜ ìš”êµ¬ì‚¬í•­ì— ìµœì í™”ë˜ì–´ ìˆìœ¼ë©° 
Envoy ì½”ë“œë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë§ì€ Envoy í™•ì¥ë“¤ì„ í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
      <li>ì‚¬ìš© ê°€ëŠ¥í•œ Envoy í™•ì¥ì„ í™•ì¸í•˜ë ¤ë©´ <a href="https://github.com/cilium/proxy/blob/main/envoy_build_config/extensions_build_config.bzl">Envoy í™•ì¥ êµ¬ì„± íŒŒì¼</a>ì„ ì°¸ì¡°í•˜ì„¸ìš”. 
<code class="language-plaintext highlighter-rouge">#</code>ìœ¼ë¡œ ì£¼ì„ ì²˜ë¦¬ë˜ì§€ ì•Šì€ í™•ì¥ë§Œì´ Cilium Envoy ì´ë¯¸ì§€ì— ë¹Œë“œë©ë‹ˆë‹¤. 
ì‚¬ìš©ì í”¼ë“œë°±ì— ë”°ë¼ ë‚´ì¥ í™•ì¥ ëª©ë¡ì„ ë°œì „í•´ ë‚˜ê°ˆ ê²ƒì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="l7-load-balancingê³¼-url-rewriting">L7 Load Balancingê³¼ URL Rewriting</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/envoy-traffic-management/">ê´€ë ¨ ë¬¸ì„œ</a></li>
  <li>ë‘ ë°±ì—”ë“œ ì„œë¹„ìŠ¤(echo-service-1/2) ê°„ì˜ ìš”ì²­ ë¶€í•˜ë¥¼ ë¶„ì‚°í•˜ê³ , URLì„ Rewriteí•˜ëŠ” Envoy êµ¬ì„±ì„ ìƒì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="ì‹¤ìŠµ-í™˜ê²½-êµ¬ì„±-1">ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes/servicemesh/envoy/test-application.yaml
<span class="c"># =&gt; configmap/coredns-configmap created</span>
<span class="c">#    deployment.apps/client created</span>
<span class="c">#    deployment.apps/client2 created</span>
<span class="c">#    deployment.apps/echo-service-1 created</span>
<span class="c">#    deployment.apps/echo-service-2 created</span>
<span class="c">#    service/echo-service-1 created</span>
<span class="c">#    service/echo-service-2 created</span>

<span class="c"># í™•ì¸</span>
<span class="c">## ë‘ ê°œì˜ í´ë¼ì´ì–¸íŠ¸ ë°°í¬ client , client2</span>
<span class="c">## ë‘ ê°€ì§€ ì„œë¹„ìŠ¤, echo-service-1, echo-service-2</span>
<span class="nv">$ </span>kubectl get <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes/servicemesh/envoy/test-application.yaml
<span class="c"># =&gt; NAME                          DATA   AGE</span>
<span class="c">#    configmap/coredns-configmap   1      30s</span>
<span class="c">#    </span>
<span class="c">#    NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/client           1/1     1            1           30s</span>
<span class="c">#    deployment.apps/client2          1/1     1            1           30s</span>
<span class="c">#    deployment.apps/echo-service-1   1/1     1            1           30s</span>
<span class="c">#    deployment.apps/echo-service-2   1/1     1            1           30s</span>
<span class="c">#    </span>
<span class="c">#    NAME                     TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/echo-service-1   NodePort   10.96.162.98   &lt;none&gt;        8080:30749/TCP   30s</span>
<span class="c">#    service/echo-service-2   NodePort   10.96.78.11    &lt;none&gt;        8080:31200/TCP   30s</span>

<span class="c"># client2 ì— ëŒ€í•œ Pod IDë¡œ í™˜ê²½ ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CLIENT2</span><span class="o">=</span><span class="si">$(</span>kubectl get pods <span class="nt">-l</span> <span class="nv">name</span><span class="o">=</span>client2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CLIENT2</span>
<span class="c"># =&gt; client2-c97ddf6cf-2gm94</span>

<span class="c"># Start Observing Traffic with Hubble</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; â„¹ï¸   Hubble Relay is available at 127.0.0.1:4245</span>
<span class="nv">$ </span>hubble observe <span class="nt">--from-pod</span> <span class="nv">$CLIENT2</span> <span class="nt">-f</span>


<span class="c"># You should be able to get a response from both of the backend services individually from client2:</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-2:8080/
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>

<span class="c"># Verify that you get a 404 error response if you curl to the non-existent URL /foo on these services:</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/foo
<span class="c"># =&gt; &lt; HTTP/1.1 404 Not Found</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-2:8080/foo 
<span class="c"># =&gt; &lt; HTTP/1.1 404 Not Found</span>
</code></pre></div></div>

<h5 id="l7-ì •ì±…-ì¶”ê°€">L7 ì •ì±… ì¶”ê°€</h5>

<ul>
  <li><code class="language-plaintext highlighter-rouge">one.one.one.one</code> ë„ë©”ì¸ì— ëŒ€í•œ HTTP GET ìš”ì²­ì„ í—ˆìš©í•˜ëŠ” ì •ì±…ê³¼ echo ì„œë¹„ìŠ¤ì˜ <code class="language-plaintext highlighter-rouge">/</code> ê²½ë¡œì— ëŒ€í•œ HTTP GET ìš”ì²­ì„ í—ˆìš©í•˜ëŠ” ì •ì±…ì„ ì¶”ê°€í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Adding a Layer 7 policy introduces the Envoy proxy into the path for this traffic</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes/servicemesh/envoy/client-egress-l7-http.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/client-egress-l7-http created</span>

<span class="c"># client2 is allowed to contact one.one.one.one/ on port 80 and the echo Pod</span>
<span class="c"># on port 8080. HTTP introspection is enabled for client2.</span>
<span class="c"># The toFQDNs section relies on DNS introspection being performed by</span>
<span class="c"># the client-egress-only-dns policy.</span>
apiVersion: <span class="s2">"cilium.io/v2"</span>
kind: CiliumNetworkPolicy
metadata:
  name: client-egress-l7-http
spec:
  description: <span class="s2">"Allow GET one.one.one.one:80/ and GET &lt;echo&gt;:8080/ from client2"</span>
  endpointSelector:
    matchLabels:
      other: client
  egress:
    <span class="c"># Allow GET / requests towards echo pods.</span>
    - toEndpoints:
        - matchLabels:
            k8s:kind: <span class="nb">echo
      </span>toPorts:
        - ports:
            - port: <span class="s2">"8080"</span>
              protocol: TCP
          rules:
            http:
              - method: <span class="s2">"GET"</span>
                path: <span class="s2">"/"</span>
    <span class="c"># Allow GET / requests, only towards one.one.one.one.</span>
    - toFQDNs:
        - matchName: <span class="s2">"one.one.one.one"</span>
      toPorts:
        - ports:
            - port: <span class="s2">"80"</span>
              protocol: TCP
          rules:
            http:
              - method: <span class="s2">"GET"</span>
                path: <span class="s2">"/"</span>
                
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes/servicemesh/envoy/client-egress-only-dns.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/client-egress-only-dns created</span>

apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: client-egress-only-dns
spec:
  endpointSelector:
    matchLabels:
      kind: client
  egress:
    - toPorts:
        - ports:
            - port: <span class="s2">"53"</span>
              protocol: ANY
          rules:
            dns:
              - matchPattern: <span class="s2">"*"</span>
      toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s:k8s-app: kube-dns
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s:k8s-app: coredns

<span class="c"># Make a request to a backend service (either will do):</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ echo ì„œë¹„ìŠ¤ì˜ / ê²½ë¡œì— ëŒ€í•´ì„œëŠ” ìŠ¹ì¸ ì •ì±…ì´ ì ìš©ë˜ì—ˆê¸° ë•Œë¬¸ì— 200 OK ì‘ë‹µì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-2:8080/foo
<span class="c"># =&gt; &lt; HTTP/1.1 403 Forbidden</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ /fooëŠ” ìŠ¹ì¸ ì •ì±…ì— í¬í•¨ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— 403 Forbidden ì‘ë‹µì„ ë°›ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>hubble observe <span class="nt">--from-pod</span> <span class="nv">$CLIENT2</span> <span class="nt">-f</span>
<span class="c"># =&gt; Aug 23 15:01:32.615: default/client2-c97ddf6cf-2gm94:35118 (ID:30927) -&gt; default/echo-service-2-5df858689b-lbtff:8080 (ID:15303) http-request DROPPED (HTTP/1.1 GET http://echo-service-2:8080/foo)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ Hubbleì—ì„œ íŠ¸ë˜í”½ì„ ê´€ì°°í•´ë³´ë©´, echo-service-2ë¡œì˜ ìš”ì²­ì´ DROPPEDëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="l7-load-balancingê³¼-url-rewriting-ì ìš©">L7 Load Balancingê³¼ URL Rewriting ì ìš©</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Envoy ë¡œë“œ ë°¸ëŸ°ì‹± ë° URL ì¬ì‘ì„± ì¶”ê°€ : ë‘ ë°±ì—”ë“œ echo-ì„œë¹„ìŠ¤ ê°„ì— 50/50ì˜ ë¶€í•˜ ë¶„ì‚° , ê²½ë¡œ /fooë¥¼ ë‹¤ì‹œ ì‘ì„±í•©ë‹ˆë‹¤/</span>
<span class="c"># Apply the envoy-traffic-management-test.yaml file, which defines a CiliumClusterwideEnvoyConfig</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes/servicemesh/envoy/envoy-traffic-management-test.yaml
<span class="c"># =&gt; ciliumclusterwideenvoyconfig.cilium.io/envoy-lb-listener created</span>

apiVersion: cilium.io/v2
kind: CiliumClusterwideEnvoyConfig
metadata:
  name: envoy-lb-listener
spec:
  services:
    - name: echo-service-1
      namespace: default
    - name: echo-service-2
      namespace: default
  resources:
    - <span class="s2">"@type"</span>: type.googleapis.com/envoy.config.listener.v3.Listener
      name: envoy-lb-listener
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                <span class="s2">"@type"</span>: type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: envoy-lb-listener
                rds:
                  route_config_name: lb_route
                use_remote_address: <span class="nb">true
                </span>skip_xff_append: <span class="nb">true
                </span>http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      <span class="s2">"@type"</span>: type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
    - <span class="s2">"@type"</span>: type.googleapis.com/envoy.config.route.v3.RouteConfiguration
      name: lb_route
      virtual_hosts:
        - name: <span class="s2">"lb_route"</span>
          domains: <span class="o">[</span> <span class="s2">"*"</span> <span class="o">]</span>
          routes:
            - match:
                prefix: <span class="s2">"/"</span>
              route:
                weighted_clusters:
                  clusters:
                    - name: <span class="s2">"default/echo-service-1"</span>
                      weight: 50
                    - name: <span class="s2">"default/echo-service-2"</span>
                      weight: 50
                retry_policy:
                  retry_on: 5xx
                  num_retries: 3
                  per_try_timeout: 1s
                regex_rewrite:
                  pattern:
                    google_re2: <span class="o">{</span> <span class="o">}</span>
                    regex: <span class="s2">"^/foo.*$"</span>
                  substitution: <span class="s2">"/"</span>
    - <span class="s2">"@type"</span>: type.googleapis.com/envoy.config.cluster.v3.Cluster
      name: <span class="s2">"default/echo-service-1"</span>
      connect_timeout: 5s
      lb_policy: ROUND_ROBIN
      <span class="nb">type</span>: EDS
      outlier_detection:
        split_external_local_origin_errors: <span class="nb">true
        </span>consecutive_local_origin_failure: 2
    - <span class="s2">"@type"</span>: type.googleapis.com/envoy.config.cluster.v3.Cluster
      name: <span class="s2">"default/echo-service-2"</span>
      connect_timeout: 3s
      lb_policy: ROUND_ROBIN
      <span class="nb">type</span>: EDS
      outlier_detection:
        split_external_local_origin_errors: <span class="nb">true
        </span>consecutive_local_origin_failure: 2

<span class="c"># CiliumClusterwideEnvoyConfig ì•½ì ccec</span>
<span class="nv">$ </span>kubectl get ccec <span class="nt">-o</span> yaml | yq
<span class="nv">$ </span>kubectl get ccec 
<span class="c"># =&gt; NAME                AGE</span>
<span class="c">#    envoy-lb-listener   21s</span>

<span class="c"># 50:50 LB ë¶„ì‚° í˜¸ì¶œë¨</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/foo

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/foo
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ URL Rewritingì´ ì ìš©ë˜ì–´ /foo ê²½ë¡œì— ëŒ€í•œ ìš”ì²­ì´ /ë¡œ ë‹¤ì‹œ ì‘ì„±ë˜ì–´ 200 OK ì‘ë‹µì„ ë°›ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># í•˜ì§€ë§Œ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì€ ì—¬ì „íˆ /ë¡œ ë‹¤ì‹œ ì‘ì„±ë˜ì§€ ì•Šì€ ê²½ë¡œì— ëŒ€í•œ ìš”ì²­ì„ ë°©ì§€í•©ë‹ˆë‹¤. </span>
<span class="c"># ì˜ˆë¥¼ ë“¤ì–´, ì´ ìš”ì²­ì€ íŒ¨í‚·ì´ ì‚­ì œë˜ê³  403 ê¸ˆì§€ ì‘ë‹µ ì½”ë“œê°€ ìƒì„±</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/bar
<span class="c"># =&gt; &lt; HTTP/1.1 403 Forbidden</span>

<span class="c">## rewrite ë˜ì§€ ì•Šì€ /bar ê²½ë¡œì— ëŒ€í•œ ìš”ì²­ì— ëŒ€í•œ hubble ì¶œë ¥</span>
<span class="c"># =&gt; Aug 23 15:26:06.041: default/client2-c97ddf6cf-2gm94:50256 (ID:30927) -&gt; default/echo-service-2-5df858689b-lbtff:8080 (ID:15303) http-request DROPPED (HTTP/1.1 GET http://echo-service-1:8080/bar)</span>

<span class="c"># ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs daemonsets/cilium-envoy
</code></pre></div></div>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œë„ Cilium Service Meshì—ì„œ ì œê³µí•˜ëŠ” ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.
íŠ¹íˆ ê¸°ì¡´ì— Nginx Ingressë¥¼ ì‚¬ìš©í•˜ë©´ì„œ ì„¸ë¶€ì ì¸ ì„¤ì •ì„ í•˜ë ¤ë©´ annotationë„ ì°¾ì•„ë³´ê³ , í•´ë‹¹ annotationì˜ ë™ì‘ì„ ì´í•´í•˜ê¸° ìœ„í•´ì„œ
nginx ë¬¸ì„œë„ ë´ì•¼í–ˆëŠ”ë°, Gateway APIê°€ ì´ë¥¼ í•´ê²° í•  ê²ƒ ê°™ì•„ì„œ ê¸°ëŒ€ë©ë‹ˆë‹¤.</p>

<p>ìƒí˜¸ ì¸ì¦ë§Œ Betaë¥¼ ë²—ì–´ë‚˜ë©´ istioê°™ì€ ê¸°ì¡´ ì„œë¹„ìŠ¤ ë©”ì‹œ ì†”ë£¨ì…˜ì„ ëŒ€ì²´í•  ìˆ˜ ìˆì„ê²ƒ ê°™ë‹¤ëŠ” ìƒê°ì´ ë“­ë‹ˆë‹¤.
eBPFì™€ Envoyë¼ëŠ” íŠ¼íŠ¼í•œ ê¸°ì´ˆê°€ ìˆìœ¼ë‹ˆ ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì„ í™•ì¥í•´ ë‚˜ê°€ëŠ”ê²ƒ ê°™ì•„ì„œ
ì´ˆê¸° ì„¤ê³„ì™€ ì² í•™ì´ ì–¼ë§ˆë‚˜ ì¤‘ìš”í•œì§€ ë‹¤ì‹œ í•œë²ˆ ëŠë¼ê²Œ ë©ë‹ˆë‹¤.</p>]]></content><author><name></name></author><category term="cilium" /><category term="kubernetes," /><category term="network," /><category term="linux," /><category term="cilium," /><category term="servicemesh" /><summary type="html"><![CDATA[ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ServiceMeshì´ë€ ë¬´ì—‡ì¸ê°€ì™€ ë“±ì¥ë°°ê²½ì„ ì•Œì•„ë³´ê³ , Ciliumì—ì„œ ì œê³µí•˜ëŠ” ServiceMeshì˜ ê° ê¸°ëŠ¥ë“¤ì— ëŒ€í•´ ì‹¤ìŠµì„ í†µí•˜ì—¬ ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[Cilium] BGP Control Plane &amp;amp; ClusterMesh</title><link href="https://sweetlittlebird.github.io/posts/2025-08-17-Cilium-Week5/" rel="alternate" type="text/html" title="[Cilium] BGP Control Plane &amp;amp; ClusterMesh" /><published>2025-08-17T00:10:18+09:00</published><updated>2025-08-17T00:10:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/Cilium%20-%20Week5</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2025-08-17-Cilium-Week5/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” BGPë¥¼ í†µí•œ ë¼ìš°íŒ…ê³¼ kind, cluster-meshë¥¼ í†µí•œ ë©€í‹° í´ëŸ¬ìŠ¤í„° í™˜ê²½ì—ì„œì˜ Cilium ë™ì‘ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="ì‹¤ìŠµ-í™˜ê²½-êµ¬ì„±">ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±</h2>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” ì§€ë‚œ ì‹¤ìŠµê³¼ ë§ˆì°¬ê°€ì§€ë¡œ k8s-w0ë¥¼ ë³„ë„ì˜ ë„¤íŠ¸ì›Œí¬ì— ë°°ì¹˜í•˜ê³  routerë¥¼ í†µí•´ k8s-w0ì™€ k8s-ctr/w1 ë…¸ë“œê°„ í†µì‹ ì„ í™•ì¸í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” frrì„ ì„¤ì¹˜í•˜ì—¬ BGP ë¼ìš°íŒ…ì„ í†µí•´ í†µì‹ ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w5/20250817_cilium_w5_1.png" alt="20250817_cilium_w5_1.png" class="image-center image-bg" />
    <ul>
      <li>ê¸°ë³¸ ë°°í¬ ê°€ìƒ ë¨¸ì‹  : k8s-ctr, k8s-w1, k8s-w0, router (<strong>frr ë¼ìš°íŒ…</strong>)</li>
      <li><strong>router</strong> : router : 192.168.<strong>10</strong>.0/24 â†” 192.168.<strong>20</strong>.0/24 ëŒ€ì—­ ë¼ìš°íŒ… ì—­í• , k8s ì— join ë˜ì§€ ì•Šì€ ì„œë²„ì´ë©°, BGP ë™ì‘ì„ ìœ„í•´ <a href="https://docs.frrouting.org/en/stable-10.4/about.html">frr</a> íˆ´ì´ ì„¤ì¹˜ë˜ì–´ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>k8s-w0</strong> : k8s-ctr/w1 ë…¸ë“œì™€ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì— ë°°ì¹˜ë©ë‹ˆë‹¤.</li>
      <li>ì‹¤ìŠµ ë™ì‘ì— í•„ìš”í•œ static routingì´ ì„¤ì €ëœ ìƒíƒœë¡œ ë°°í¬ ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬-íŒŒì¼">ì‹¤ìŠµí™˜ê²½ ë°°í¬ íŒŒì¼</h3>

<ul>
  <li>
    <p><strong>Vagrantfile</strong> : ê°€ìƒë¨¸ì‹  ì •ì˜, ë¶€íŒ… ì‹œ ì´ˆê¸° í”„ë¡œë¹„ì €ë‹ ì„¤ì •ì„ í¬í•¨í•˜ëŠ” Vagrantfileì…ë‹ˆë‹¤.</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Variables</span>
<span class="no">K8SV</span> <span class="o">=</span> <span class="s1">'1.33.2-1.1'</span> <span class="c1"># Kubernetes Version : apt list -a kubelet , ex) 1.32.5-1.1</span>
<span class="no">CONTAINERDV</span> <span class="o">=</span> <span class="s1">'1.7.27-1'</span> <span class="c1"># Containerd Version : apt list -a containerd.io , ex) 1.6.33-1</span>
<span class="no">CILIUMV</span> <span class="o">=</span> <span class="s1">'1.18.0'</span> <span class="c1"># Cilium CNI Version : https://github.com/cilium/cilium/tags</span>
<span class="no">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># max number of worker nodes</span>
  
<span class="c1"># Base Image  https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-24.04</span>
<span class="no">BOX_IMAGE</span> <span class="o">=</span> <span class="s2">"bento/ubuntu-24.04"</span>
<span class="no">BOX_VERSION</span> <span class="o">=</span> <span class="s2">"202508.03.0"</span>
  
<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1">#-ControlPlane Node</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-ctr"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
  
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">2560</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.100"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60000</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span> <span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/k8s-ctr.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">N</span><span class="p">,</span> <span class="no">CILIUMV</span><span class="p">,</span> <span class="no">K8SV</span> <span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/route-add1.sh"</span>
  <span class="k">end</span>
  
  <span class="c1">#-Worker Nodes Subnet1</span>
  <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="no">N</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.10</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="s2">"6000</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/k8s-w.sh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/route-add1.sh"</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="c1">#-Router Node</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"router"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"router"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">768</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"router"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.200"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60009</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.20.200"</span><span class="p">,</span> <span class="ss">auto_config: </span><span class="kp">false</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/router.sh"</span>
  <span class="k">end</span>
  
  <span class="c1">#-Worker Nodes Subnet2</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w0"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w0"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w0"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.20.100"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60010</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/k8s-w.sh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/route-add2.sh"</span>
  <span class="k">end</span>
  
<span class="k">end</span>

</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>init_cfg.sh</strong> : args ì°¸ê³ í•˜ì—¬ ì´ˆê¸° ì„¤ì •ì„ ìˆ˜í–‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime <span class="c"># Change Timezone</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Disable and turn off SWAP"</span>
swapoff <span class="nt">-a</span> <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'/swap/s/^/#/'</span> /etc/fstab
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Install Packages"</span>
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>apt-transport-https ca-certificates curl gpg <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># Download the public signing key for the Kubernetes package repositories.</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nt">-m</span> 755 /etc/apt/keyrings
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$1</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+)\..*/\1/p'</span><span class="si">)</span>
curl <span class="nt">-fsSL</span> https://pkgs.k8s.io/core:/stable:/v<span class="nv">$K8SMMV</span>/deb/Release.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/kubernetes-apt-keyring.gpg
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v</span><span class="nv">$K8SMMV</span><span class="s2">/deb/ /"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list.d/kubernetes.list
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
  
<span class="c"># packets traversing the bridge are processed by iptables for filtering</span>
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
<span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> <span class="o">&gt;&gt;</span> /etc/sysctl.d/k8s.conf
  
<span class="c"># enable br_netfilter for iptables </span>
modprobe br_netfilter
modprobe overlay
<span class="nb">echo</span> <span class="s2">"br_netfilter"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
<span class="nb">echo</span> <span class="s2">"overlay"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)"</span>
<span class="c"># Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version</span>
apt update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># apt list -a kubelet ; apt list -a containerd.io</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubectl</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubeadm</span><span class="o">=</span><span class="nv">$1</span> containerd.io<span class="o">=</span><span class="nv">$2</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-mark hold kubelet kubeadm kubectl <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># containerd configure to default and cgroup managed by systemd</span>
containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SystemdCgroup = false/SystemdCgroup = true/g'</span> /etc/containerd/config.toml
  
<span class="c"># avoid WARN&amp;ERRO(default endpoints) when crictl run  </span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
</span><span class="no">EOF
  
</span><span class="c"># ready to install for k8s </span>
systemctl restart containerd <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable </span>containerd
systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Packages &amp; Helm"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get <span class="nb">install</span> <span class="nt">-y</span> bridge-utils sshpass net-tools conntrack ngrep tcpdump ipset arping wireguard jq yq tree bash-completion unzip kubecolor termshark <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
curl <span class="nt">-s</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>k8s-ctr.sh</strong> : kubeadm initë¥¼ í†µí•˜ì—¬ kubernetes controlplane ë…¸ë“œë¥¼ ì„¤ì •í•˜ê³  Cilium CNI ì„¤ì¹˜, í¸ë¦¬ì„± ì„¤ì •(k, kc)í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. local-path-storageclassì™€ metrics-serverë„ ì„¤ì¹˜í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Initial Kubernetes"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-init-ctr-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/kubeadm-init-ctr-config.yaml
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$3</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/p'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/K8S_VERSION_PLACEHOLDER/v</span><span class="k">${</span><span class="nv">K8SMMV</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-init-ctr-config.yaml
kubeadm init <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-init-ctr-config.yaml"</span>  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Setting kube config file"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /root/.kube
<span class="nb">cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf /root/.kube/config
<span class="nb">chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> /root/.kube/config
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Source the completion"</span>
<span class="nb">echo</span> <span class="s1">'source &lt;(kubectl completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'source &lt;(kubeadm completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Alias kubectl to k"</span>
<span class="nb">echo</span> <span class="s1">'alias k=kubectl'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'alias kc=kubecolor'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'complete -F __start_kubectl k'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubectx &amp; Kubens"</span>
git clone https://github.com/ahmetb/kubectx /opt/kubectx <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubens /usr/local/bin/kubens
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubectx /usr/local/bin/kubectx
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Kubeps &amp; Setting PS1"</span>
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1 <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">"</span><span class="no">EOT</span><span class="sh">" &gt;&gt; /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
function get_cluster_short() {
  echo "</span><span class="nv">$1</span><span class="sh">" | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=') '
PS1='</span><span class="si">$(</span>kube_ps1<span class="si">)</span><span class="sh">'</span><span class="nv">$PS1</span><span class="sh">
</span><span class="no">EOT
</span>kubectl config rename-context <span class="s2">"kubernetes-admin@kubernetes"</span> <span class="s2">"HomeLab"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 7] Install Cilium CNI"</span>
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
helm repo add cilium https://helm.cilium.io/ <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm repo update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> <span class="nv">$2</span> <span class="nt">--namespace</span> kube-system <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.100 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="se">\</span>
<span class="nt">--set</span> ipam.mode<span class="o">=</span><span class="s2">"cluster-pool"</span> <span class="nt">--set</span> ipam.operator.clusterPoolIPv4PodCIDRList<span class="o">={</span><span class="s2">"172.20.0.0/16"</span><span class="o">}</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>172.20.0.0/16 <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> bgpControlPlane.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>30003 <span class="se">\</span>
<span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span> <span class="se">\</span>
<span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 8] Install Cilium / Hubble CLI"</span>
<span class="nv">CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz
  
<span class="nv">HUBBLE_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="si">)</span>
<span class="nv">HUBBLE_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">HUBBLE_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/hubble/releases/download/<span class="nv">$HUBBLE_VERSION</span>/hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 9] Remove node taint"</span>
kubectl taint nodes k8s-ctr node-role.kubernetes.io/control-plane-
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 10] local DNS with hosts file"</span>
<span class="nb">echo</span> <span class="s2">"192.168.10.100 k8s-ctr"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.10.200 router"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.20.100 k8s-w0"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;<span class="o">=</span><span class="nv">$1</span><span class="p">;</span> i++  <span class="o">))</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"192.168.10.10</span><span class="nv">$i</span><span class="s2"> k8s-w</span><span class="nv">$i</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts<span class="p">;</span> <span class="k">done
  
  
</span><span class="nb">echo</span> <span class="s2">"[TASK 11] Dynamically provisioning persistent local storage with Kubernetes"</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.31/deploy/local-path-storage.yaml <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch storageclass local-path <span class="nt">-p</span> <span class="s1">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="c"># echo "[TASK 12] Install Prometheus &amp; Grafana"</span>
<span class="c"># kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.18.0/examples/kubernetes/addons/prometheus/monitoring-example.yaml &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># kubectl patch svc -n cilium-monitoring prometheus -p '{"spec": {"type": "NodePort", "ports": [{"port": 9090, "targetPort": 9090, "nodePort": 30001}]}}' &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># kubectl patch svc -n cilium-monitoring grafana -p '{"spec": {"type": "NodePort", "ports": [{"port": 3000, "targetPort": 3000, "nodePort": 30002}]}}' &gt;/dev/null 2&gt;&amp;1</span>
  
<span class="c"># echo "[TASK 12] Install Prometheus Stack"</span>
<span class="c"># helm repo add prometheus-community https://prometheus-community.github.io/helm-charts  &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># cat &lt;&lt;EOT &gt; monitor-values.yaml</span>
<span class="c"># prometheus:</span>
<span class="c">#   prometheusSpec:</span>
<span class="c">#     scrapeInterval: "15s"</span>
<span class="c">#     evaluationInterval: "15s"</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30001</span>
  
<span class="c"># grafana:</span>
<span class="c">#   defaultDashboardsTimezone: Asia/Seoul</span>
<span class="c">#   adminPassword: prom-operator</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30002</span>
  
<span class="c"># alertmanager:</span>
<span class="c">#   enabled: false</span>
<span class="c"># defaultRules:</span>
<span class="c">#   create: false</span>
<span class="c"># prometheus-windows-exporter:</span>
<span class="c">#   prometheus:</span>
<span class="c">#     monitor:</span>
<span class="c">#       enabled: false</span>
<span class="c"># EOT</span>
<span class="c"># helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack --version 75.15.1 \</span>
<span class="c">#   -f monitor-values.yaml --create-namespace --namespace monitoring  &gt;/dev/null 2&gt;&amp;1</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 13] Install Metrics-server"</span>
helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm upgrade <span class="nt">--install</span> metrics-server metrics-server/metrics-server <span class="nt">--set</span> <span class="s1">'args[0]=--kubelet-insecure-tls'</span> <span class="nt">-n</span> kube-system  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 14] Install k9s"</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>wget https://github.com/derailed/k9s/releases/latest/download/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb <span class="nt">-O</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt <span class="nb">install</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p><strong>kubeadm-init-ctr-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration
bootstrapTokens:
- token: <span class="s2">"123456.1234567890123456"</span>
  ttl: <span class="s2">"0s"</span>
  usages:
  - signing
  - authentication
localAPIEndpoint:
  advertiseAddress: <span class="s2">"192.168.10.100"</span>
nodeRegistration:
  kubeletExtraArgs:
    - name: node-ip
      value: <span class="s2">"192.168.10.100"</span>
  criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
<span class="nt">---</span>
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
kubernetesVersion: <span class="s2">"K8S_VERSION_PLACEHOLDER"</span>
networking:
  podSubnet: <span class="s2">"10.244.0.0/16"</span>
  serviceSubnet: <span class="s2">"10.96.0.0/16"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li><strong>k8s-w.sh</strong> : kubernetes worker ë…¸ë“œ ì„¤ì •, kubeadm join ë“±ì„ ìˆ˜í–‰í•˜ëŠ”  ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;"</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] K8S Controlplane Join"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-join-worker-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-join-worker-config.yaml
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/NODE_IP_PLACEHOLDER/</span><span class="k">${</span><span class="nv">NODEIP</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-join-worker-config.yaml
kubeadm <span class="nb">join</span> <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-join-worker-config.yaml"</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
    <ul>
      <li>
        <p><strong>kubeadm-join-worker-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: kubeadm.k8s.io/v1beta4
kind: JoinConfiguration
discovery:
  bootstrapToken:
    token: <span class="s2">"123456.1234567890123456"</span>
    apiServerEndpoint: <span class="s2">"192.168.10.100:6443"</span>
    unsafeSkipCAVerification: <span class="nb">true
</span>nodeRegistration:
  criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
  kubeletExtraArgs:
    - name: node-ip
      value: <span class="s2">"NODE_IP_PLACEHOLDER"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>route-add1.sh</strong> : k8s node ë“¤ì´ ë‚´ë¶€ë§ê³¼ í†µì‹ ì„ ìœ„í•œ route ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt;&gt; /etc/netplan/50-vagrant.yaml
      routes:
      - to: 192.168.20.0/24
        via: 192.168.10.200
      # - to: 172.20.0.0/16
      #   via: 192.168.10.200
</span><span class="no">EOT
  
</span>netplan apply
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>route-add2.sh</strong> : k8s node ë“¤ì´ ë‚´ë¶€ë§ê³¼ í†µì‹ ì„ ìœ„í•œ route ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt;&gt; /etc/netplan/50-vagrant.yaml
      routes:
      - to: 192.168.10.0/24
        via: 192.168.20.200
      # - to: 172.20.0.0/16
      #   via: 192.168.20.200
</span><span class="no">EOT
  
</span>netplan apply
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>router.sh</strong> : router(<strong>frr - BGP</strong>) ì—­í• , ê°„ë‹¨ ì›¹ ì„œë²„ ì—­í• </p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 0] Setting eth2"</span>
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOT</span><span class="sh"> &gt;&gt; /etc/netplan/50-vagrant.yaml
    eth2:
      addresses:
      - 192.168.20.200/24
</span><span class="no">EOT
  
</span>netplan apply
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Add Kernel setting - IP Forwarding"</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g'</span> /etc/sysctl.conf
sysctl <span class="nt">-p</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Setting Dummy Interface"</span>
modprobe dummy
ip <span class="nb">link </span>add loop1 <span class="nb">type </span>dummy
ip <span class="nb">link set </span>loop1 up
ip addr add 10.10.1.200/24 dev loop1
  
ip <span class="nb">link </span>add loop2 <span class="nb">type </span>dummy
ip <span class="nb">link set </span>loop2 up
ip addr add 10.10.2.200/24 dev loop2
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Packages"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>net-tools jq yq tree ngrep tcpdump arping termshark <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Apache"</span>
apt <span class="nb">install </span>apache2 <span class="nt">-y</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"&lt;h1&gt;Web Server : </span><span class="si">$(</span><span class="nb">hostname</span><span class="si">)</span><span class="s2">&lt;/h1&gt;"</span> <span class="o">&gt;</span> /var/www/html/index.html
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 7] Configure FRR"</span>
apt <span class="nb">install </span>frr <span class="nt">-y</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/^bgpd=no/bgpd=yes/g"</span> /etc/frr/daemons
  
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt;&gt; /etc/frr/frr.conf
!
router bgp 65000
  bgp router-id </span><span class="nv">$NODEIP</span><span class="sh">
  bgp graceful-restart
  no bgp ebgp-requires-policy
  bgp bestpath as-path multipath-relax
  maximum-paths 4
  network 10.10.1.0/24
</span><span class="no">EOF
  
  
</span>systemctl daemon-reexec <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl restart frr <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl <span class="nb">enable </span>frr <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬">ì‹¤ìŠµí™˜ê²½ ë°°í¬</h3>

<h5 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬-1">ì‹¤ìŠµí™˜ê²½ ë°°í¬</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>vagrant up
  <span class="c"># =&gt;     k8s-w0: &gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;</span>
  <span class="c">#    ==&gt; k8s-w0: Running provisioner: shell...</span>
  <span class="c">#        k8s-w0: Running: /var/folders/7k/qy6rsdds57z3tmyn9_7hhd8r0000gn/T/vagrant-shell20250815-16129-ssrxpm.sh</span>
  <span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;</span>
  <span class="c">#        k8s-w0: [TASK 1] K8S Controlplane Join</span>
  <span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;</span>
  <span class="c">#    ==&gt; k8s-w0: Running provisioner: shell...</span>
  <span class="c">#        k8s-w0: Running: /var/folders/7k/qy6rsdds57z3tmyn9_7hhd8r0000gn/T/vagrant-shell20250815-16129-iotl22.sh</span>
  <span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;</span>
  <span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;</span>
</code></pre></div></div>

<h5 id="ê¸°ë³¸ì •ë³´-í™•ì¸">ê¸°ë³¸ì •ë³´ í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium ìƒíƒœ í™•ì¸ : bgp-control-plane ë¯¸ë¦¬ í™œì„±í™”.</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq
<span class="nv">$ </span>cilium status 
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> bgp
<span class="c"># =&gt; bgp-router-id-allocation-ip-pool</span>
<span class="c">#    bgp-router-id-allocation-mode                     default</span>
<span class="c">#    bgp-secrets-namespace                             kube-system</span>
<span class="c">#    enable-bgp-control-plane                          true</span>
<span class="c">#    enable-bgp-control-plane-status-report            true</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg status <span class="nt">--verbose</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg metrics list 

<span class="c"># monitor</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">-v</span>
...
</code></pre></div></div>

<h5 id="ë„¤íŠ¸ì›Œí¬-ì •ë³´-í™•ì¸--autodirectnoderoutesfalse">ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸ : <code class="language-plaintext highlighter-rouge">autoDirectNodeRoutes=false</code></h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># router ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr

<span class="c"># k8s node ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth1
<span class="c"># =&gt; 3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet &lt;span style="color: green;"&gt;192.168.10.100/24&lt;/span&gt; brd 192.168.10.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth1<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; 3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet &lt;span style="color: green;"&gt;192.168.10.101/24&lt;/span&gt; brd 192.168.10.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet &lt;span style="color: green;"&gt;192.168.20.100/24&lt;/span&gt; brd 192.168.20.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># ë¼ìš°íŒ… ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.200</span>
<span class="c">#    192.168.20.0/24 dev eth2 proto kernel scope link src 192.168.20.200</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>static
<span class="c"># =&gt; 192.168.20.0/24 via 192.168.10.200 dev eth1 proto static</span>

<span class="c">## ë…¸ë“œë³„ PodCIDR ë¼ìš°íŒ…ì´ ì—†ìŠµë‹ˆë‹¤!</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    172.20.0.0/24 via 172.20.0.222 dev cilium_host proto kernel src 172.20.0.222</span>
<span class="c">#    172.20.0.222 dev cilium_host proto kernel scope link</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100</span>
<span class="c">#    192.168.20.0/24 via 192.168.10.200 dev eth1 proto static</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    172.20.1.0/24 via 172.20.1.44 dev cilium_host proto kernel src 172.20.1.44</span>
<span class="c">#    172.20.1.44 dev cilium_host proto kernel scope link</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.101</span>
<span class="c">#    192.168.20.0/24 via 192.168.10.200 dev eth1 proto static</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    172.20.2.0/24 via 172.20.2.246 dev cilium_host proto kernel src 172.20.2.246</span>
<span class="c">#    172.20.2.246 dev cilium_host proto kernel scope link</span>
<span class="c">#    192.168.10.0/24 via 192.168.20.200 dev eth1 proto static</span>
<span class="c">#    192.168.20.0/24 dev eth1 proto kernel scope link src 192.168.20.100</span>

<span class="c"># í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 192.168.20.100  <span class="c"># k8s-w0 eth1</span>
<span class="c"># =&gt; PING 192.168.20.100 (192.168.20.100) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.20.100: icmp_seq=1 ttl=63 time=2.46 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.20.100 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 2.461/2.461/2.461/0.000 ms</span>
</code></pre></div></div>

<ul>
  <li>í˜„ì¬ë…¸ë“œê°„ í†µì‹ ì€ ê°€ëŠ¥í•˜ì§€ë§Œ pod ê°„ í†µì‹ ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">autoDirectNodeRoutes=false</code>ì„ í†µí•´ ìë™ìœ¼ë¡œ ê°™ì€ L2 ë„¤íŠ¸ì›Œí¬ì— ìˆëŠ” ë…¸ë“œë“¤ê°„ì˜ PodCIDR ë¼ìš°íŒ…í•˜ëŠ” ê¸°ëŠ¥ì´ êº¼ì ¸ìˆì–´ì„œ ë¼ìš°íŒ… ë£°ì´ ì—†ê¸°ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
</ul>

<h3 id="ìƒ˜í”Œ-ì• í”Œë¦¬ì¼€ì´ì…˜-ë°°í¬-ë°-í†µì‹ -ë¬¸ì œ-í™•ì¸">ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° í†µì‹  ë¬¸ì œ í™•ì¸</h3>

<ul>
  <li>ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># k8s-ctr ë…¸ë“œì— curl-pod íŒŒë“œ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>
</code></pre></div></div>

<ul>
  <li>í†µì‹  ë¬¸ì œ í™•ì¸ : ë…¸ë“œ ë‚´ì˜ íŒŒë“œê°„ì—ë§Œ í†µì‹ ì´ ë˜ëŠ” ì¤‘ì…ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   3/3     3            3           102s   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE    SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.28.4   &lt;none&gt;        80/TCP    102s   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                                      AGE</span>
<span class="c">#    endpoints/webpod   172.20.0.72:80,172.20.1.7:80,172.20.2.190:80   102s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="c"># =&gt; NAME           ADDRESSTYPE   PORTS   ENDPOINTS                             AGE</span>
<span class="c">#    webpod-4pxps   IPv4          80      172.20.0.72,172.20.1.7,172.20.2.190   2m23s</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="c"># IP í™•ì¸</span>
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  47416               ready            172.20.0.187</span>
<span class="c">#    &lt;span style="color: green;"&gt;webpod-697b545f57-j6b7t&lt;/span&gt;   9975                ready            &lt;span style="color: green;"&gt;172.20.0.72&lt;/span&gt;</span>
<span class="c">#    webpod-697b545f57-n7fk7   9975                ready            172.20.2.190</span>
<span class="c">#    webpod-697b545f57-rl4d2   9975                ready            172.20.1.7</span>

<span class="c"># í†µì‹  ë¬¸ì œ í™•ì¸ : ë…¸ë“œ ë‚´ì˜ íŒŒë“œë“¤ ë¼ë¦¬ë§Œ í†µì‹ ë˜ëŠ” ì¤‘!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-j6b7t</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-ctrì—ì„œ ì‹¤í–‰ì¤‘ì´ì–´ì„œ ê°™ì€ k8s-ctrì— ìˆëŠ” íŒŒë“œì™€ëŠ” í†µì‹ ì´ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 webpod | <span class="nb">grep </span>Hostname
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë‹¤ì‹œ ì‹¤í–‰í–ˆì„ë•ŒëŠ” Kubernetes Serviceì— ì˜í•´ ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œë¡œ ë¡œë“œë°¸ëŸ°ì‹±ë˜ì–´ í†µì‹ ì´ ì‹¤íŒ¨í•©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># =&gt; command terminated with exit code 28</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ---</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ---</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì—¬ëŸ¬ë²ˆ ì‹¤í–‰í•´ë„ k8s-ctr ë…¸ë“œì— ìˆëŠ” íŒŒë“œë§Œ í†µì‹ ì´ ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># cilium-dbg, map</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg ip list
<span class="c"># =&gt; IP                  IDENTITY                                                                            SOURCE</span>
<span class="c">#    ...</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.1.7/32&lt;/span&gt;       k8s:app=webpod                                                                      custom-resource</span>
<span class="c">#    ...</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.2.190/32&lt;/span&gt;     k8s:app=webpod                                                                      custom-resource</span>
<span class="c">#    ...</span>
<span class="c">#    192.168.10.101/32   reserved:remote-node</span>
<span class="c">#    192.168.20.100/32   reserved:remote-node</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ciliumë„ ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œ IPë¥¼ ì•Œê³  ìˆì§€ë§Œ, ë¼ìš°íŒ…ì´ ë˜ì§€ ì•Šì•„ì„œ í†µì‹ ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg endpoint list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg service list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf lb list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf nat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map list | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'0             0'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_services_v2
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_backends_v3
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_reverse_nat
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_ipcache_v2
</code></pre></div></div>

<hr />

<h2 id="cilium-bgp-control-plane">Cilium BGP Control Plane</h2>

<ul>
  <li>Cilium BGP Control Plane (BGPv2) : Cilium Custom Resources ë¥¼ í†µí•´ BGPÂ ì„¤ì •ì´ ê´€ë¦¬ ê°€ëŠ¥í•©ë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-v2/">Docs</a>, <a href="https://github.com/cilium/cilium/tree/main/operator/pkg/bgpv2">Code</a>
<img src="/assets/2025/cilium/w5/20250817_cilium_w5_2.png" alt="img.png" class="image-center image-bg" />
<em class="image-caption"><a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-v2/">https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-v2/</a></em>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">CiliumBGPClusterConfig</code>: BGP ì¸ìŠ¤í„´ìŠ¤ì™€ ì—¬ëŸ¬ ë…¸ë“œì— ì ìš©ë˜ëŠ” í”¼ì–´ êµ¬ì„±ì„ ì •ì˜í•©ë‹ˆë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">CiliumBGPPeerConfig</code>: ê³µí†µ BGP í”¼ì–´ë§ ì„¤ì •ì„ ì •ì˜í•©ë‹ˆë‹¤. ì—¬ëŸ¬ í”¼ì–´ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">CiliumBGPAdvertisement</code>: BGP ë¼ìš°íŒ… í…Œì´ë¸”ì— ì‚½ì…ë˜ëŠ” ì ‘ë‘ì‚¬ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">CiliumBGPNodeConfigOverride</code>: ì„¸ë°€í•œ ì œì–´ë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ íŠ¹ì • ë…¸ë“œì— ëŒ€í•œ BGP ì„¤ì • ì˜¤ë²„ë¼ì´ë“œì„ ì •ì˜í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h4 id="bgpì„¤ì •-í›„-í†µì‹ -í™•ì¸">BGPÂ ì„¤ì • í›„ í†µì‹  í™•ì¸</h4>

<blockquote>
  <p>Ciliumì˜ BGPëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì™¸ë¶€ ê²½ë¡œë¥¼ ì»¤ë„ ë¼ìš°íŒ… í…Œì´ë¸”ì— ì£¼ì…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
</blockquote>

<ul>
  <li>[router] router ì ‘ì† í›„ ì„¤ì • : <code class="language-plaintext highlighter-rouge">sshpass -p 'vagrant' ssh vagrant@router</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s-ctr ì—ì„œ router ë¡œ ssh ì ‘ì†</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router

<span class="c"># BGP ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'zebra|bgpd'</span>
<span class="c"># =&gt; LISTEN 0      3          127.0.0.1:2601      0.0.0.0:*    users:(("zebra",pid=4144,fd=23))</span>
<span class="c">#    LISTEN 0      3          127.0.0.1:2605      0.0.0.0:*    users:(("bgpd",pid=4149,fd=18))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:179       0.0.0.0:*    users:(("bgpd",pid=4149,fd=22))</span>
<span class="c">#    LISTEN 0      4096            [::]:179          [::]:*    users:(("bgpd",pid=4149,fd=23))</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span> |grep frr
<span class="c"># =&gt; root        4131       1  0 16:49 ?        00:00:03 /usr/lib/frr/watchfrr -d -F traditional zebra bgpd staticd</span>
<span class="c">#    frr         4144       1  0 16:49 ?        00:00:01 /usr/lib/frr/zebra -d -F traditional -A 127.0.0.1 -s 90000000</span>
<span class="c">#    frr         4149       1  0 16:49 ?        00:00:00 /usr/lib/frr/bgpd -d -F traditional -A 127.0.0.1</span>
<span class="c">#    frr         4156       1  0 16:49 ?        00:00:00 /usr/lib/frr/staticd -d -F traditional -A 127.0.0.1</span>

<span class="c"># frr ì„¤ì •ì„ í™•ì¸í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show running'</span>   <span class="c"># ëª…ë ¹ì„ í†µí•´ í˜„ì¬ ì„¤ì •ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
<span class="c"># =&gt; uilding configuration...</span>
<span class="c">#    </span>
<span class="c">#    Current configuration:</span>
<span class="c">#    !</span>
<span class="c">#    frr version 8.4.4</span>
<span class="c">#    frr defaults traditional</span>
<span class="c">#    hostname router</span>
<span class="c">#    log syslog informational</span>
<span class="c">#    no ipv6 forwarding</span>
<span class="c">#    service integrated-vtysh-config</span>
<span class="c">#    !</span>
<span class="c">#    router bgp 65000</span>
<span class="c">#     bgp router-id 192.168.10.200</span>
<span class="c">#     no bgp ebgp-requires-policy</span>
<span class="c">#     bgp graceful-restart</span>
<span class="c">#     bgp bestpath as-path multipath-relax</span>
<span class="c">#     !</span>
<span class="c">#     address-family ipv4 unicast</span>
<span class="c">#      network 10.10.1.0/24</span>
<span class="c">#      maximum-paths 4</span>
<span class="c">#     exit-address-family</span>
<span class="c">#    exit</span>
<span class="c">#    !</span>
<span class="c">#    end</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/frr/frr.conf
<span class="c"># =&gt; ... </span>
<span class="c">#    log syslog informational</span>
<span class="c">#    !</span>
<span class="c">#    router bgp 65000</span>
<span class="c">#      bgp router-id 192.168.10.200</span>
<span class="c">#      bgp graceful-restart</span>
<span class="c">#      no bgp ebgp-requires-policy</span>
<span class="c">#      bgp bestpath as-path multipath-relax</span>
<span class="c">#      maximum-paths 4</span>
<span class="c">#      network 10.10.1.0/24</span>

<span class="c">#</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show running'</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp summary'</span>
<span class="c"># =&gt; % No BGP neighbors found in VRF default</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp'</span>
<span class="c"># =&gt; BGP table version is 1, local router ID is 192.168.10.200, vrf id 0</span>
<span class="c">#    Default local pref 100, local AS 65000</span>
<span class="c">#    Status codes:  s suppressed, d damped, h history, * valid, &gt; best, = multipath,</span>
<span class="c">#                   i internal, r RIB-failure, S Stale, R Removed</span>
<span class="c">#    Nexthop codes: @NNN nexthop's vrf id, &lt; announce-nh-self</span>
<span class="c">#    Origin codes:  i - IGP, e - EGP, ? - incomplete</span>
<span class="c">#    RPKI validation codes: V valid, I invalid, N Not found</span>
<span class="c">#    </span>
<span class="c">#       Network          Next Hop            Metric LocPrf Weight Path</span>
<span class="c">#    *&gt; 10.10.1.0/24     0.0.0.0                  0         32768 i</span>

<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.10.1.0/24 dev loop1 proto kernel scope link src 10.10.1.200</span>
<span class="c">#    10.10.2.0/24 dev loop2 proto kernel scope link src 10.10.2.200</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.200</span>
<span class="c">#    192.168.20.0/24 dev eth2 proto kernel scope link src 192.168.20.200</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip route'</span>
...
K&gt;<span class="k">*</span> 0.0.0.0/0 <span class="o">[</span>0/100] via 10.0.2.2, eth0, src 10.0.2.15, 00:34:45
...
C&gt;<span class="k">*</span> 192.168.10.0/24 is directly connected, eth1, 00:34:45
C&gt;<span class="k">*</span> 192.168.20.0/24 is directly connected, eth2, 00:34:45
<span class="c"># =&gt; ...    </span>
<span class="c">#    K&gt;* 0.0.0.0/0 [0/100] via 10.0.2.2, eth0, src 10.0.2.15, 06:52:38</span>
<span class="c">#    ...</span>
<span class="c">#    C&gt;* 192.168.10.0/24 is directly connected, eth1, 06:52:38</span>
<span class="c">#    C&gt;* 192.168.20.0/24 is directly connected, eth2, 06:52:38</span>

<span class="c"># Cilium node ì—°ë™ ì„¤ì • ë°©ì•ˆ 1</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì„¤ì • íŒŒì¼ì„ ì§ì ‘ ìˆ˜ì •í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt;&gt; /etc/frr/frr.conf
  neighbor CILIUM peer-group
  neighbor CILIUM remote-as external
  neighbor 192.168.10.100 peer-group CILIUM
  neighbor 192.168.10.101 peer-group CILIUM
  neighbor 192.168.20.100 peer-group CILIUM 
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> /etc/frr/frr.conf
<span class="c"># =&gt; log syslog informational</span>
<span class="c">#    !</span>
<span class="c">#    router bgp 65000</span>
<span class="c">#      bgp router-id 192.168.10.200</span>
<span class="c">#      bgp graceful-restart</span>
<span class="c">#      no bgp ebgp-requires-policy</span>
<span class="c">#      bgp bestpath as-path multipath-relax</span>
<span class="c">#      maximum-paths 4</span>
<span class="c">#      network 10.10.1.0/24</span>
<span class="c">#      neighbor CILIUM peer-group</span>
<span class="c">#      neighbor CILIUM remote-as external</span>
<span class="c">#      neighbor 192.168.10.100 peer-group CILIUM</span>
<span class="c">#      neighbor 192.168.10.101 peer-group CILIUM</span>
<span class="c">#      neighbor 192.168.20.100 peer-group CILIUM</span>

<span class="nv">$ </span>systemctl daemon-reexec <span class="o">&amp;&amp;</span> systemctl restart frr
<span class="nv">$ </span>systemctl status frr <span class="nt">--no-pager</span> <span class="nt">--full</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Aug 15 23:43:00 router zebra[5215]: [VTVCM-Y2NW3] Configuration Read in Took: 00:00:00</span>
<span class="c">#    Aug 15 23:43:00 router staticd[5227]: [VTVCM-Y2NW3] Configuration Read in Took: 00:00:00</span>
<span class="c">#    Aug 15 23:43:00 router bgpd[5220]: [VTVCM-Y2NW3] Configuration Read in Took: 00:00:00</span>
<span class="c">#    Aug 15 23:43:00 router watchfrr[5201]: [QDG3Y-BY5TN] zebra state -&gt; up : connect succeeded</span>
<span class="c">#    Aug 15 23:43:00 router watchfrr[5201]: [QDG3Y-BY5TN] bgpd state -&gt; up : connect succeeded</span>
<span class="c">#    Aug 15 23:43:00 router watchfrr[5201]: [QDG3Y-BY5TN] staticd state -&gt; up : connect succeeded</span>
<span class="c">#    Aug 15 23:43:00 router watchfrr[5201]: [KWE5Q-QNGFC] all daemons up, doing startup-complete notify</span>
<span class="c">#    Aug 15 23:43:00 router frrinit.sh[5190]:  * Started watchfrr</span>
<span class="c">#    Aug 15 23:43:00 router systemd[1]: Started frr.service - FRRouting.</span>

<span class="c"># ëª¨ë‹ˆí„°ë§ ê±¸ì–´ë‘ê¸°!</span>
<span class="nv">$ </span>journalctl <span class="nt">-u</span> frr <span class="nt">-f</span>

<span class="c"># Cilium node ì—°ë™ ì„¤ì • ë°©ì•ˆ 2</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ frrì—ì„œ ì œê³µí•˜ëŠ” vtysh ëª…ë ¹ì–´ë¥¼ í†µí•´ ì„¤ì •í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>vtysh
<span class="nt">---------------------------</span>
?
show ?
show running
show ip route

<span class="c"># config ëª¨ë“œ ì§„ì…</span>
conf
?

<span class="c">## bgp 65000 ì„¤ì • ì§„ì…</span>
router bgp 65000
?
neighbor CILIUM peer-group
neighbor CILIUM remote-as external
neighbor 192.168.10.100 peer-group CILIUM
neighbor 192.168.10.101 peer-group CILIUM
neighbor 192.168.20.100 peer-group CILIUM 
end

<span class="c"># Write configuration to the file (same as write file)</span>
write memory
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì‹¤ì œë¡œ frr.conf íŒŒì¼ì— ì„¤ì •ì´ ì¶”ê°€ë©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nb">exit</span>
<span class="nt">---------------------------</span>

<span class="nv">$ </span><span class="nb">cat</span> /etc/frr/frr.conf
</code></pre></div></div>

<ul>
  <li>ciliumì— bgp ì„¤ì •</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì‹ ê·œ í„°ë¯¸ë„ 1 (router) : ëª¨ë‹ˆí„°ë§ ê±¸ì–´ë‘ê¸°!</span>
<span class="nv">$ </span>journalctl <span class="nt">-u</span> frr <span class="nt">-f</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ 2 (k8s-ctr) : ë°˜ë³µ í˜¸ì¶œ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>


<span class="c"># BGP ë™ì‘í•  ë…¸ë“œë¥¼ ìœ„í•œ label ì„¤ì •</span>
<span class="nv">$ </span>kubectl label nodes k8s-ctr k8s-w0 k8s-w1 enable-bgp<span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; node/k8s-w0 labeled</span>
<span class="c">#    node/k8s-w1 labeled</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-l</span> enable-bgp<span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; NAME      STATUS   ROLES           AGE     VERSION</span>
<span class="c">#    k8s-ctr   Ready    control-plane   7h35m   v1.33.2</span>
<span class="c">#    k8s-w0    Ready    &lt;none&gt;          7h30m   v1.33.2</span>
<span class="c">#    k8s-w1    Ready    &lt;none&gt;          7h33m   v1.33.2</span>

<span class="c"># Config Cilium BGP</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: cilium.io/v2
kind: CiliumBGPAdvertisement
metadata:
  name: bgp-advertisements
  labels:
    advertise: bgp
spec:
  advertisements:
    - advertisementType: "PodCIDR"
---
apiVersion: cilium.io/v2
kind: CiliumBGPPeerConfig
metadata:
  name: cilium-peer
spec:
  timers:
    holdTimeSeconds: 9
    keepAliveTimeSeconds: 3
  ebgpMultihop: 2
  gracefulRestart:
    enabled: true
    restartTimeSeconds: 15
  families:
    - afi: ipv4
      safi: unicast
      advertisements:
        matchLabels:
          advertise: "bgp"
---
apiVersion: cilium.io/v2
kind: CiliumBGPClusterConfig
metadata:
  name: cilium-bgp
spec:
  nodeSelector:
    matchLabels:
      "enable-bgp": "true"
  bgpInstances:
  - name: "instance-65001"
    localASN: 65001
    peers:
    - name: "tor-switch"
      peerASN: 65000
      peerAddress: 192.168.10.200  # router ip address
      peerConfigRef:
        name: "cilium-peer"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumbgpadvertisement.cilium.io/bgp-advertisements created</span>
<span class="c">#    ciliumbgppeerconfig.cilium.io/cilium-peer created</span>
<span class="c">#    ciliumbgpclusterconfig.cilium.io/cilium-bgp created</span>
</code></pre></div></div>

<ul>
  <li>í†µì‹ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [k8s-ctr]ì—ì„œ í™•ì¸</span>

<span class="c"># BGP ì—°ê²° í™•ì¸</span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep </span>179
<span class="c"># =&gt; (ì—†ìŒ)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-ctr ë…¸ë“œì—ëŠ” BGP ë°ëª¬ì´ ì‹¤í–‰ë˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>ss <span class="nt">-tnp</span> | <span class="nb">grep </span>179
<span class="c"># =&gt; ESTAB 0      0               192.168.10.100:46459          192.168.10.200:179   users:(("cilium-agent",pid=5674,fd=193))</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ cilium-agentê°€ BGP ì—°ê²°ì„ ìœ„í•´ routerì™€ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># cilium bgp ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>cilium bgp peers
<span class="c"># =&gt; Node      Local AS   Peer AS   Peer Address     Session State   Uptime   Family         Received   Advertised</span>
<span class="c">#    k8s-ctr   65001      65000     192.168.10.200   established     2m20s    ipv4/unicast   4          2</span>
<span class="c">#    k8s-w0    65001      65000     192.168.10.200   established     2m20s    ipv4/unicast   4          2</span>
<span class="c">#    k8s-w1    65001      65000     192.168.10.200   established     2m19s    ipv4/unicast   4          2</span>
<span class="nv">$ </span>cilium bgp routes available ipv4 unicast
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age     Attrs</span>
<span class="c">#    k8s-ctr   65001     172.20.0.0/24   0.0.0.0   2m30s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w0    65001     172.20.2.0/24   0.0.0.0   2m30s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w1    65001     172.20.1.0/24   0.0.0.0   2m30s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>

<span class="nv">$ </span>kubectl get ciliumbgpadvertisements,ciliumbgppeerconfigs,ciliumbgpclusterconfigs
<span class="c"># =&gt; NAME                                                  AGE</span>
<span class="c">#    ciliumbgpadvertisement.cilium.io/bgp-advertisements   2m40s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                        AGE</span>
<span class="c">#    ciliumbgppeerconfig.cilium.io/cilium-peer   2m40s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                          AGE</span>
<span class="c">#    ciliumbgpclusterconfig.cilium.io/cilium-bgp   2m40s</span>
<span class="nv">$ </span>kubectl get ciliumbgpnodeconfigs <span class="nt">-o</span> yaml | yq
<span class="c"># =&gt; ...</span>
<span class="c">#                    "peeringState": "established",</span>
<span class="c">#                    "routeCount": [</span>
<span class="c">#                      {</span>
<span class="c">#                        "advertised": 2,</span>
<span class="c">#                        "afi": "ipv4",</span>
<span class="c">#                        "received": 1,</span>
<span class="c">#                        "safi": "unicast"</span>
<span class="c">#                      }</span>
<span class="c">#                    ],</span>
<span class="c">#    ...</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ 1 (router) : ëª¨ë‹ˆí„°ë§ ê±¸ì–´ë‘ê¸°!</span>
<span class="nv">$ </span>journalctl <span class="nt">-u</span> frr <span class="nt">-f</span>
<span class="c"># =&gt; Aug 16 00:21:44 router bgpd[5422]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.10.101 in vrf default</span>
<span class="c">#    Aug 16 00:21:44 router bgpd[5422]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.20.100 in vrf default</span>
<span class="c">#    Aug 16 00:21:44 router bgpd[5422]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.10.100 in vrf default</span>

<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>bgp
<span class="c"># =&gt; 172.20.0.0/24 nhid 32 via 192.168.10.100 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.1.0/24 nhid 30 via 192.168.10.101 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.2.0/24 nhid 31 via 192.168.20.100 dev eth2 proto bgp metric 20</span>

<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp summary'</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span>
<span class="c">#    192.168.10.100  4      65001        88        91        0    0    0 00:04:12            1        4 N/A</span>
<span class="c">#    192.168.10.101  4      65001        88        91        0    0    0 00:04:12            1        4 N/A</span>
<span class="c">#    192.168.20.100  4      65001        88        91        0    0    0 00:04:12            1        4 N/A</span>

<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp'</span>
<span class="c"># =&gt; ...</span>
<span class="c">#       Network          Next Hop            Metric LocPrf Weight Path</span>
<span class="c">#    *&gt; 10.10.1.0/24     0.0.0.0                  0         32768 i</span>
<span class="c">#    *&gt; 172.20.0.0/24    192.168.10.100                         0 65001 i</span>
<span class="c">#    *&gt; 172.20.1.0/24    192.168.10.101                         0 65001 i</span>
<span class="c">#    *&gt; 172.20.2.0/24    192.168.20.100                         0 65001 i</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ 2 (k8s-ctr) : ë°˜ë³µ í˜¸ì¶œ???</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ---</span>
<span class="c">#    ---</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì—¬ì „íˆ k8s-ctr ë…¸ë“œì— ìˆëŠ” íŒŒë“œë§Œ í†µì‹ ì´ ë˜ê³ , ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œì™€ëŠ” í†µì‹ ì´ ì•ˆ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>BGP ì •ë³´ ì „ë‹¬ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s-ctr tcpdump í•´ë‘ê¸°</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 tcp port 179 <span class="nt">-w</span> /tmp/bgp.pcap

<span class="c"># router : frr ì¬ì‹œì‘</span>
<span class="nv">$ </span>systemctl restart frr <span class="o">&amp;&amp;</span> journalctl <span class="nt">-u</span> frr <span class="nt">-f</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Aug 16 00:28:35 router watchfrr[5625]: [KWE5Q-QNGFC] all daemons up, doing startup-complete notify</span>
<span class="c">#    Aug 16 00:28:41 router bgpd[5643]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.20.100 in vrf default</span>
<span class="c">#    Aug 16 00:28:41 router bgpd[5643]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.10.100 in vrf default</span>
<span class="c">#    Aug 16 00:28:41 router bgpd[5643]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.10.101 in vrf default</span>

<span class="c"># termshark ì‹¤í–‰í›„ filterì— `bgp.type == 2` ì…ë ¥í•´ì„œ bgp update íŒ¨í‚·ì„ í™•ì¸í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>termshark <span class="nt">-r</span> /tmp/bgp.pcap
 
<span class="c"># ë¶„ëª… Router ì¥ë¹„ë¥¼ í†µí•´ BGP UPDATEë¡œ ë°›ìŒì„ í™•ì¸.</span>
<span class="nv">$ </span>cilium bgp routes
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age      Attrs</span>
<span class="c">#    k8s-ctr   65001     172.20.0.0/24   0.0.0.0   15m44s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w0    65001     172.20.2.0/24   0.0.0.0   15m44s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w1    65001     172.20.1.0/24   0.0.0.0   15m44s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ cilium ë¼ìš°íŒ… ì •ë³´ì—ëŠ” BGP UPDATEë¡œ ë°›ì€ ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    172.20.0.0/24 via 172.20.0.222 dev cilium_host proto kernel src 172.20.0.222</span>
<span class="c">#    172.20.0.222 dev cilium_host proto kernel scope link</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100</span>
<span class="c">#    192.168.20.0/24 via 192.168.10.200 dev eth1 proto static</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-ctr ë…¸ë“œì˜ ì»¤ë„ ë¼ìš°íŒ… í…Œì´ë¸”ì—ëŠ” ì¶”ê°€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_3.png" alt="img.png" class="image-center image-bg" />
<em class="image-caption">termsharkì—ì„œ BGP UPDATE íŒ¨í‚· í™•ì¸</em></p>

<ul>
  <li>ciliumì— BGP ì„¤ì •ì´ë˜ì–´ ì´ì œ ë¼ìš°íŒ…ì´ ê°€ëŠ¥í•´ì§ˆê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
  <li>í•˜ì§€ë§Œ ì»¤ë„ ë¼ìš°íŒ… í…Œì´ë¸”ì—ëŠ” ì¶”ê°€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    <ul>
      <li>Cilium BGPëŠ” eBPFë¥¼ í†µí•´ ë¼ìš°íŒ…í•˜ê¸° ë•Œë¬¸ì— ì»¤ë„ ë¼ìš°íŒ… í…Œì´ë¸”ì— ì¶”ê°€í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
      <li>Cilium BGP Speakerê°€ ê¸°ë°˜í•˜ëŠ” GoBGP ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” <code class="language-plaintext highlighter-rouge">disable-fib</code> ìƒíƒœë¡œ ë¹Œë“œë˜ì–´ Linux ì»¤ë„(FIB)ì— ì£¼ì…ë˜ë„ë¡ ì„¤ì • ë˜ì–´ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="ë¬¸ì œ-í•´ê²°-í›„-í†µì‹ ">ë¬¸ì œ í•´ê²° í›„ í†µì‹ </h3>

<ul>
  <li>í˜„ì¬ ì‹¤ìŠµ í™˜ê²½ì€ 2ê°œì˜ NIC(eth0, eth1)ì„ ì‚¬ìš©í•˜ê³  ìˆëŠ” ìƒí™©ìœ¼ë¡œ, default GWê°€ eth0 ê²½ë¡œë¡œ ì„¤ì • ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
  <li>eth1ì€ k8s í†µì‹  ìš©ë„ë¡œ ì‚¬ìš© ì¤‘ì´ë©°, í˜„ì¬ k8s íŒŒë“œ ì‚¬ìš© ëŒ€ì—­ í†µì‹  ì „ì²´ëŠ” eth1ì„ í†µí•´ì„œ ë¼ìš°íŒ… ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>í•´ë‹¹ ë¼ìš°íŒ…ì„ ìƒë‹¨ì— ë„¤íŠ¸ì›Œí¬ ì¥ë¹„ê°€ ë°›ê²Œ ë˜ê³ , í•´ë‹¹ ì¥ë¹„ëŠ” Cilium Nodeë¥¼ í†µí•´ ëª¨ë“  PodCIDR ì •ë³´ë¥¼ ì•Œê³  ìˆê¸°ì—, ëª©ì ì§€ë¡œ ì „ë‹¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>ê²°ë¡ ì€ Cilium ìœ¼ë¡œ BGP ì‚¬ìš© ì‹œ, 2ê°œ ì´ìƒì˜ NIC ì‚¬ìš©í•  ê²½ìš°ì—ëŠ” Nodeì— ì§ì ‘ ë¼ìš°íŒ… ì„¤ì • ë° ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s íŒŒë“œ ì‚¬ìš© ëŒ€ì—­ í†µì‹  ì „ì²´ëŠ” eth1ì„ í†µí•´ì„œ ë¼ìš°íŒ… ì„¤ì •</span>
<span class="nv">$ </span>ip route add 172.20.0.0/16 via 192.168.10.200
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 <span class="nb">sudo </span>ip route add 172.20.0.0/16 via 192.168.10.200
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w0 <span class="nb">sudo </span>ip route add 172.20.0.0/16 via 192.168.20.200

<span class="c"># router ê°€ bgpë¡œ í•™ìŠµí•œ ë¼ìš°íŒ… ì •ë³´ í•œë²ˆ ë” í™•ì¸ : </span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route | <span class="nb">grep </span>bgp
<span class="c"># =&gt; 172.20.0.0/24 nhid 63 via 192.168.10.100 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.1.0/24 nhid 64 via 192.168.10.101 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.2.0/24 nhid 60 via 192.168.20.100 dev eth2 proto bgp metric 20 </span>

<span class="c"># ì •ìƒ í†µì‹  í™•ì¸!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-rl4d2</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-n7fk7</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê° ë…¸ë“œì˜ íŒŒë“œì™€ ì˜ í†µì‹ ì´ ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># hubble relay í¬íŠ¸ í¬ì›Œë”© ì‹¤í–‰</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="nv">$ </span>hubble status
<span class="c"># =&gt; hubble status</span>
<span class="c">#    Healthcheck (via localhost:4245): Ok</span>
<span class="c">#    Current/Max Flows: 12,285/12,285 (100.00%)</span>
<span class="c">#    Flows/s: 65.38</span>
<span class="c">#    Connected Nodes: 3/3</span>

<span class="c"># flow logÂ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--pod</span> curl-pod
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_4.png" alt="img.png" class="image-center image-bg" />
<em class="image-caption">curl-podì—ì„œ webpodë¡œ í†µì‹ í•˜ëŠ” íë¦„ í™•ì¸</em></p>

<h3 id="ë…¸ë“œ-ìœ ì§€ë³´ìˆ˜-k8s-w0-ì‹¤ìŠµ">ë…¸ë“œ ìœ ì§€ë³´ìˆ˜ (k8s-w0) ì‹¤ìŠµ</h3>

<ul>
  <li>ë…¸ë“œë¥¼ ìœ ì§€ë³´ìˆ˜ í•˜ê¸° ìœ„í•´ì„œ ë¼ìš°íŒ…ì„ í•´ì œì‹œí‚¤ê³ , ë‹¤ì‹œ ë³µêµ¬í•˜ëŠ” ì‹¤ìŠµì„ ì§„í–‰í•´ ë³´ê² ìŠµë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-operation/#shutting-down-a-node">Docs</a></li>
</ul>

<h5 id="ë…¸ë“œ-ìœ ì§€ë³´ìˆ˜ë¥¼-ìœ„í•œ-ì„¤ì •">ë…¸ë“œ ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•œ ì„¤ì •</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§ : ë°˜ë³µ í˜¸ì¶œ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>

<span class="c"># (ì°¸ê³ ) BGP Control Plane logs</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system <span class="nt">-l</span> <span class="nv">name</span><span class="o">=</span>cilium-operator <span class="nt">-f</span> | <span class="nb">grep</span> <span class="s2">"subsys=bgp-cp-operator"</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium <span class="nt">-f</span> | <span class="nb">grep</span> <span class="s2">"subsys=bgp-control-plane"</span>

<span class="c"># ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•œ ì„¤ì •</span>
<span class="nv">$ </span>kubectl drain k8s-w0 <span class="nt">--ignore-daemonsets</span>
<span class="c"># =&gt; evicting pod default/webpod-697b545f57-n7fk7</span>
<span class="c">#    pod/webpod-697b545f57-n7fk7 evicted</span>
<span class="c">#    node/k8s-w0 drained</span>
<span class="nv">$ </span>kubectl label nodes k8s-w0 enable-bgp<span class="o">=</span><span class="nb">false</span> <span class="nt">--overwrite</span>
<span class="c"># =&gt; node/k8s-w0 labeled</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get node
<span class="c"># =&gt; NAME      STATUS                     ROLES           AGE   VERSION</span>
<span class="c">#    k8s-ctr   Ready                      control-plane   8h    v1.33.2</span>
<span class="c">#    k8s-w0    Ready&lt;span style="color: green;"&gt;,SchedulingDisabled&lt;/span&gt;   &lt;none&gt;          8h    v1.33.2</span>
<span class="c">#    k8s-w1    Ready                      &lt;none&gt;          8h    v1.33.2</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ drainì„ í†µí•´ k8s-w0ì— pod ìŠ¤ì¼€ì¤„ë§ì´ ë˜ì§€ ì•Šë„ë¡ ì„¤ì • ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get ciliumbgpnodeconfigs
<span class="c"># =&gt; NAME      AGE</span>
<span class="c">#    k8s-ctr   50m</span>
<span class="c">#    k8s-w1    50m</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ enable-bgp=falseë¡œ ë¼ë²¨ì„ ìˆ˜ì •í•´ì„œ cilium bgp nodeì—ì„œ k8s-w0 ë…¸ë“œê°€ ì œì™¸ ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>cilium bgp routes
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age      Attrs</span>
<span class="c">#    k8s-ctr   65001     172.20.0.0/24   0.0.0.0   52m12s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w1    65001     172.20.1.0/24   0.0.0.0   52m12s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="nv">$ </span>cilium bgp peers
<span class="c"># =&gt; Node      Local AS   Peer AS   Peer Address     Session State   Uptime   Family         Received   Advertised</span>
<span class="c">#    k8s-ctr   65001      65000     192.168.10.200   established     45m21s   ipv4/unicast   3          2</span>
<span class="c">#    k8s-w1    65001      65000     192.168.10.200   established     45m21s   ipv4/unicast   3          2   </span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp'"</span>
<span class="c"># =&gt;    Network          Next Hop            Metric LocPrf Weight Path</span>
<span class="c">#    *&gt; 10.10.1.0/24     0.0.0.0                  0         32768 i</span>
<span class="c">#    *&gt; 172.20.0.0/24    192.168.10.100                         0 65001 i</span>
<span class="c">#    *&gt; 172.20.1.0/24    192.168.10.101                         0 65001 i</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip route bgp'"</span>
<span class="c"># =&gt; B&gt;* 172.20.0.0/24 [20/0] via 192.168.10.100, eth1, weight 1, 00:46:08</span>
<span class="c">#    B&gt;* 172.20.1.0/24 [20/0] via 192.168.10.101, eth1, weight 1, 00:46:08</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route | <span class="nb">grep </span>bgp
<span class="c"># =&gt; 172.20.0.0/24 nhid 63 via 192.168.10.100 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.1.0/24 nhid 64 via 192.168.10.101 dev eth1 proto bgp metric 20</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp summary'"</span>
<span class="c"># =&gt; Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span>
<span class="c">#    192.168.10.100  4      65001       915       919        0    0    0 00:45:35            1        3 N/A</span>
<span class="c">#    192.168.10.101  4      65001       915       919        0    0    0 00:45:35            1        3 N/A</span>
<span class="c">#    &lt;span style="color: green;"&gt;192.168.20.100&lt;/span&gt;  4      65001       856       857        0    0    0 00:03:03       Active        0 N/A</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ëˆ„ì ëœ í†µê³„ë¥¼ ì œì™¸í•˜ë©´ routerì˜ BGP ì •ë³´ì—ëŠ” k8s-w0 ë…¸ë“œê°€ ì œì™¸ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="ìœ ì§€ë³´ìˆ˜-ì™„ë£Œ-í›„-ë¼ìš°íŒ…-ë³µì›">ìœ ì§€ë³´ìˆ˜ ì™„ë£Œ í›„ ë¼ìš°íŒ… ë³µì›</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì›ë³µ ì„¤ì •</span>
<span class="nv">$ </span>kubectl label nodes k8s-w0 enable-bgp<span class="o">=</span><span class="nb">true</span> <span class="nt">--overwrite</span>
<span class="c"># =&gt; node/k8s-w0 labeled</span>
<span class="nv">$ </span>kubectl uncordon k8s-w0
<span class="c"># =&gt; node/k8s-w0 uncordoned</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ nodeë¥¼ ë‹¤ì‹œ ìŠ¤ì¼€ì¥´ë§ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get node
<span class="c"># =&gt; NAME      STATUS   ROLES           AGE   VERSION</span>
<span class="c">#    k8s-ctr   Ready    control-plane   8h    v1.33.2</span>
<span class="c">#    k8s-w0    &lt;span style="color: green;"&gt;Ready&lt;/span&gt;    &lt;none&gt;          8h    v1.33.2</span>
<span class="c">#    k8s-w1    Ready    &lt;none&gt;          8h    v1.33.2</span>
<span class="nv">$ </span>kubectl get ciliumbgpnodeconfigs
<span class="c"># =&gt; NAME      AGE</span>
<span class="c">#    k8s-ctr   57m</span>
<span class="c">#    &lt;span style="color: green;"&gt;k8s-w0    65s&lt;/span&gt;</span>
<span class="c">#    k8s-w1    57m</span>
<span class="nv">$ </span>cilium bgp routes
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age      Attrs</span>
<span class="c">#    k8s-ctr   65001     172.20.0.0/24   0.0.0.0   57m48s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    &lt;span style="color: green;"&gt;k8s-w0    65001     172.20.2.0/24   0.0.0.0   1m25s    [{Origin: i} {Nexthop: 0.0.0.0}]&lt;/span&gt;</span>
<span class="c">#    k8s-w1    65001     172.20.1.0/24   0.0.0.0   57m48s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="nv">$ </span>cilium bgp peers
<span class="c"># =&gt; Node      Local AS   Peer AS   Peer Address     Session State   Uptime   Family         Received   Advertised</span>
<span class="c">#    k8s-ctr   65001      65000     192.168.10.200   established     51m18s   ipv4/unicast   4          2</span>
<span class="c">#    &lt;span style="color: green;"&gt;k8s-w0    65001      65000     192.168.10.200   established     1m52s    ipv4/unicast   4          2&lt;/span&gt;</span>
<span class="c">#    k8s-w1    65001      65000     192.168.10.200   established     51m18s   ipv4/unicast   4          2</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp'"</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip route bgp'"</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route | <span class="nb">grep </span>bgp
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp summary'"</span>

<span class="c"># ë…¸ë“œë³„ íŒŒë“œ ë¶„ë°° ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE     IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                  1/1     Running   0          138m    172.20.0.187   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-d7dn8   1/1     Running   0          9m33s   172.20.1.197   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-j6b7t   1/1     Running   0          138m    172.20.0.72    k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-rl4d2   1/1     Running   0          138m    172.20.1.7     k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="nv">$ </span>kubectl scale deployment webpod <span class="nt">--replicas</span> 0
<span class="nv">$ </span>kubectl scale deployment webpod <span class="nt">--replicas</span> 3
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE    IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                  1/1     Running   0          138m   172.20.0.187   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-h4lmx   1/1     Running   0          9s     172.20.1.12    k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-q8bzk   1/1     Running   0          9s     172.20.0.161   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-ssc5l   1/1     Running   0          9s     172.20.2.143   &lt;span style="color: green;"&gt;k8s-w0&lt;/span&gt;    &lt;none&gt;           &lt;none&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ webpodì˜ replica ìˆ˜ë¥¼ 0ìœ¼ë¡œ ì¤„ì˜€ë‹¤ê°€ 3ìœ¼ë¡œ ëŠ˜ë ¤ì„œ ë…¸ë“œë³„ë¡œ íŒŒë“œê°€ ë¶„ë°°ë˜ëŠ” ê²ƒì„ í™•ì¸í•©ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="crd-status-report-ë„ê¸°">CRD Status Report ë„ê¸°</h5>

<ul>
  <li>ë…¸ë“œê°€ ë§ì€ ëŒ€ê·œëª¨ í´ëŸ¬ìŠ¤í„°ì˜ ê²½ìš°, api ì„œë²„ì˜ ë¶€í•˜ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆì–´ì„œ <code class="language-plaintext highlighter-rouge">bgp status reporting off</code>ì´ ê¶Œì¥ ë©ë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-operation/#disabling-crd-status-report">Docs</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get ciliumbgpnodeconfigs <span class="nt">-o</span> yaml | yq
<span class="c"># =&gt; ...</span>
<span class="c">#      status:</span>
<span class="c">#        bgpInstances:</span>
<span class="c">#        - localASN: 65001</span>
<span class="c">#          name: instance-65001</span>
<span class="c">#          peers:</span>
<span class="c">#    ...</span>

<span class="c"># ì„¤ì •</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.0 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> bgpControlPlane.statusReport.enabled<span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># í™•ì¸ : CiliumBGPNodeConfig Status ì •ë³´ê°€ ì—†ë‹¤!</span>
<span class="nv">$ </span>kubectl get ciliumbgpnodeconfigs <span class="nt">-o</span> yaml | yq
<span class="c"># =&gt; ...</span>
<span class="c">#     "status": {}</span>
<span class="c">#    ...       </span>
</code></pre></div></div>

<h5 id="serviceloadbalancer---externalip-ipsë¥¼-bgpë¡œ-ê´‘ê³ ">Service(LoadBalancer - ExternalIP) IPsë¥¼ BGPë¡œ ê´‘ê³ </h5>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_5.png" alt="img.png" class="image-center image-bg" />
<em class="image-caption"><a href="https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/#l3-announcement-over-bgp">Service(LoadBalancer - ExternalIP) IPsë¥¼ BGPë¡œ ê´‘ê³ </a></em></p>

<ul>
  <li>Cilium BGPëŠ” Service(LoadBalancer - ExternalIP) IPsë¥¼ BGPë¡œ ê´‘ê³ í•  ìˆ˜ ìˆê³ , MetalLBë¥¼ ëŒ€ì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># LB IPAM Announcement over BGP ì„¤ì • ì˜ˆì •ìœ¼ë¡œ, ë…¸ë“œì˜ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì´ ì•„ë‹ˆì—¬ë„ ê°€ëŠ¥!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumLoadBalancerIPPool
metadata:
  name: "cilium-pool"
spec:
  allowFirstLastIPs: "No"
  blocks:
  - cidr: "172.16.1.0/24"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumloadbalancerippool.cilium.io/cilium-pool created</span>

<span class="nv">$ </span>kubectl get ippool
<span class="c"># =&gt; NAME          DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-pool   false      False         254             16s</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl patch svc webpod <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "LoadBalancer"}}'</span>
<span class="nv">$ </span>kubectl get svc webpod 
NAME     TYPE           CLUSTER-IP    EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
<span class="c"># =&gt; NAME     TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    webpod   LoadBalancer   10.96.134.232   172.16.1.1    80:31973/TCP   7m5s</span>

<span class="nv">$ </span>kubectl get ippool
<span class="c"># =&gt; NAME          DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-pool   false      False         &lt;span style="color: green;"&gt;253&lt;/span&gt;             8m25s</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ External IPê°€ í• ë‹¹ë˜ì–´ì„œ, ë‚¨ì€ IPìˆ˜ê°€ í•˜ë‚˜ ì¤„ì–´ì„œ 253ê°œì˜ IPê°€ ë‚¨ì•˜ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl describe svc webpod | <span class="nb">grep</span> <span class="s1">'Traffic Policy'</span>
<span class="c"># =&gt; External Traffic Policy:  Cluster</span>
<span class="c">#    Internal Traffic Policy:  Cluster</span>

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg service list
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    16   &lt;span style="color: green;"&gt;172.16.1.1:80/TCP&lt;/span&gt;      LoadBalancer   1 =&gt; 172.20.0.123:80/TCP (active)</span>
<span class="c">#                                               2 =&gt; 172.20.1.72:80/TCP (active)</span>
<span class="c">#                                               3 =&gt; 172.20.2.138:80/TCP (active)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ExternalIPì™€ ê° íŒŒë“œì˜ IPê°€ ë§¤í•‘ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># LBIPë¡œ curl ìš”ì²­ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span>
<span class="c"># =&gt; 172.16.1.1</span>
<span class="nv">$ LBIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-2kvd9</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr
<span class="c"># =&gt; RemoteAddr: 192.168.10.100:60634</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr
<span class="c"># =&gt; RemoteAddr: 172.20.0.201:60184</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê°™ì€ ë…¸ë“œì˜ íŒŒë“œë¡œ í†µì‹  ë  ë•ŒëŠ” cilium_host IPê°€, ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œë¡œ í†µì‹  ë  ë•ŒëŠ” nodeì˜ IPê°€ RemoteAddrë¡œ ë³´ì…ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="s2">"sshpass -p 'vagrant' ssh vagrant@router ip -c route"</span>
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.10.1.0/24 dev loop1 proto kernel scope link src 10.10.1.200</span>
<span class="c">#    10.10.2.0/24 dev loop2 proto kernel scope link src 10.10.2.200</span>
<span class="c">#    172.20.0.0/24 nhid 60 via 192.168.10.100 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.1.0/24 nhid 64 via 192.168.10.101 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.2.0/24 nhid 62 via 192.168.20.100 dev eth2 proto bgp metric 20</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.200</span>
<span class="c">#    192.168.20.0/24 dev eth2 proto kernel scope link src 192.168.20.200</span>

<span class="c"># LB EX-IPë¥¼ BGPë¡œ ê´‘ê³  ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: cilium.io/v2
kind: CiliumBGPAdvertisement
metadata:
  name: bgp-advertisements-lb-exip-webpod
  labels:
    advertise: bgp
spec:
  advertisements:
    - advertisementType: "Service"
      service:
        addresses:
          - LoadBalancerIP
      selector:             
        matchExpressions:
          - { key: app, operator: In, values: [ webpod ] }
</span><span class="no">EOF

</span><span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    172.16.1.1 nhid 70 proto bgp metric 20</span>
<span class="c">#            &lt;span style="color: green;"&gt;nexthop via 192.168.10.100 dev eth1 weight 1&lt;/span&gt; # &lt;span style="color: green;"&gt;ğŸ‘‰ BGP ê´‘ê³  í›„ 3ì¤„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;nexthop via 192.168.20.100 dev eth2 weight 1&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;nexthop via 192.168.10.101 dev eth1 weight 1&lt;/span&gt;</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl get CiliumBGPAdvertisement
<span class="c"># =&gt; NAME                                AGE</span>
<span class="c">#    bgp-advertisements                  16m</span>
<span class="c">#    bgp-advertisements-lb-exip-webpod   3m</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bgp route-policies
<span class="c"># =&gt; VRouter   Policy Name                                             Type     Match Peers         Match Families   Match Prefixes (Min..Max Len)   RIB Action   Path Actions</span>
<span class="c">#    65001     allow-local                                             import                                                                        accept</span>
<span class="c">#    65001     tor-switch-ipv4-PodCIDR                                 export   192.168.10.200/32                    172.20.1.0/24 (24..24)          accept</span>
<span class="c">#    65001     tor-switch-ipv4-Service-webpod-default-LoadBalancerIP   export   192.168.10.200/32                    172.16.1.1/32 (32..32)          accept</span>

<span class="nv">$ </span>cilium bgp routes available ipv4 unicast
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age      Attrs</span>
<span class="c">#    k8s-ctr   65001     172.16.1.1/32   0.0.0.0   3m36s    [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.0.0/24   0.0.0.0   12m38s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w0    65001     172.16.1.1/32   0.0.0.0   3m35s    [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.2.0/24   0.0.0.0   12m25s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w1    65001     172.16.1.1/32   0.0.0.0   3m35s    [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.1.0/24   0.0.0.0   12m40s   [{Origin: i} {Nexthop: 0.0.0.0}]  </span>

<span class="c"># í˜„ì¬ BGPê°€ ë™ì‘í•˜ëŠ” ëª¨ë“  ë…¸ë“œë¡œ ì „ë‹¬ ê°€ëŠ¥!</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    172.16.1.1 nhid 70 proto bgp metric 20</span>
<span class="c">#            nexthop via 192.168.10.100 dev eth1 weight 1</span>
<span class="c">#            nexthop via 192.168.20.100 dev eth2 weight 1</span>
<span class="c">#            nexthop via 192.168.10.101 dev eth1 weight 1</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip route bgp'"</span>
<span class="c"># =&gt; B&gt;* 172.16.1.1/32 [20/0] via 192.168.10.100, eth1, weight 1, 00:04:10  </span>
<span class="c">#      *                      via 192.168.10.101, eth1, weight 1, 00:04:10</span>
<span class="c">#      *                      via 192.168.20.100, eth2, weight 1, 00:04:10</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ `B&gt;`ë¡œ ì‹œì‘í•˜ëŠ” ë¼ìš°íŒ… ì •ë³´ê°€ BGPë¡œ ê´‘ê³ ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp summary'"</span>
<span class="c"># =&gt; Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span>
<span class="c">#    192.168.10.100  4      65001       332       335        0    0    0 00:14:00            2        5 N/A</span>
<span class="c">#    192.168.10.101  4      65001       331       334        0    0    0 00:14:02            2        5 N/A</span>
<span class="c">#    192.168.20.100  4      65001       333       337        0    0    0 00:13:47            2        5 N/A</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp'"</span>
<span class="c"># =&gt;    Network          Next Hop            Metric LocPrf Weight Path</span>
<span class="c">#    ...</span>
<span class="c">#    *= 172.16.1.1/32    192.168.20.100                         0 65001 i   # * valid, &gt; best, = multipath</span>
<span class="c">#    *&gt;                  192.168.10.100                         0 65001 i</span>
<span class="c">#    *=                  192.168.10.101                         0 65001 i</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ BGP ë¼ìš°íŒ… í…Œì´ë¸”ì— Multipathë¡œ ë“±ë¡ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp 172.16.1.1/32'"</span>
<span class="c"># =&gt; BGP routing table entry for 172.16.1.1/32, version 7</span>
<span class="c">#    Paths: (&lt;span style="color: green;"&gt;3 available&lt;/span&gt;, best #2, table default)</span>
<span class="c">#      Advertised to non peer-group peers:</span>
<span class="c">#      192.168.10.100 192.168.10.101 192.168.20.100</span>
<span class="c">#      65001</span>
<span class="c">#        192.168.20.100 from 192.168.20.100 (192.168.20.100)</span>
<span class="c">#          Origin IGP, valid, external, multipath</span>
<span class="c">#          Last update: Sat Aug 16 16:19:43 2025</span>
<span class="c">#      65001</span>
<span class="c">#        192.168.10.100 from 192.168.10.100 (192.168.10.100)</span>
<span class="c">#          Origin IGP, valid, external, multipath, best (Router ID)</span>
<span class="c">#          Last update: Sat Aug 16 16:19:43 2025</span>
<span class="c">#      65001</span>
<span class="c">#        192.168.10.101 from 192.168.10.101 (192.168.10.101)</span>
<span class="c">#          Origin IGP, valid, external, multipath</span>
<span class="c">#          Last update: Sat Aug 16 16:19:43 2025</span>
</code></pre></div></div>

<h5 id="routerì—ì„œ-ll-external-ip-í˜¸ì¶œ-í™•ì¸">routerì—ì„œ LL External IP í˜¸ì¶œ í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ LBIP</span><span class="o">=</span>172.16.1.1
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-2kvd9</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr
<span class="c"># =&gt; RemoteAddr: 192.168.10.100:35378</span>

<span class="c"># ë°˜ë³µ ì ‘ì†</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      34 Hostname: webpod-697b545f57-lz8mc</span>
<span class="c">#         33 Hostname: webpod-697b545f57-gzzdb</span>
<span class="c">#         33 Hostname: webpod-697b545f57-2kvd9</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | egrep <span class="s1">'Hostname|RemoteAddr'</span> <span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-2kvd9</span>
<span class="c">#    RemoteAddr: 192.168.10.100:46014</span>
<span class="c">#    Hostname: webpod-697b545f57-lz8mc</span>
<span class="c">#    RemoteAddr: 192.168.10.100:38402</span>
<span class="c">#    Hostname: webpod-697b545f57-gzzdb</span>
<span class="c">#    RemoteAddr: 172.20.0.201:44744</span>
<span class="c">#    ...</span>

<span class="c"># í˜¸ì¶œ í™•ì¸ì„ ì‰½ê²Œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆê²Œ k8s-ctr ì—ì„œ replicas=2 ë¡œ ì¤„ì—¬ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl scale deployment webpod <span class="nt">--replicas</span> 2
<span class="c"># =&gt; deployment.apps/webpod scaled</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE   IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c"># =&gt; webpod-697b545f57-nhdcd   1/1     Running   0          3s    172.20.1.130   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-t7wb4   1/1     Running   0          3s    172.20.2.198   k8s-w0    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>cilium bgp routes
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age      Attrs</span>
<span class="c">#    k8s-ctr   65001     172.16.1.1/32   0.0.0.0   10m58s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.0.0/24   0.0.0.0   20m0s    [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w0    65001     172.16.1.1/32   0.0.0.0   10m58s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.2.0/24   0.0.0.0   19m48s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w1    65001     172.16.1.1/32   0.0.0.0   10m57s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.1.0/24   0.0.0.0   20m2s    [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ íŒŒë“œë¥¼ 2ê°œë¡œ ì¤„ì—¬ì„œ k8s-w0ê³¼ k8s-w1ì—ë§Œ íŒŒë“œê°€ ìˆì§€ë§Œ, k8s-ctrì—ë„ íŒŒë“œ ë° LB ExtIPì˜ ë¼ìš°íŒ… ì •ë³´ê°€ ë‚¨ì•„ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ì´ë ‡ê²Œ ë˜ë©´ LB ExtIP ì‚¬ìš©ì‹œ k8s-ctrë¡œë„ ì ‘ì†ì´ ë˜ì–´ì„œ k8s-w0ì´ë‚˜ k8s-w1ì˜ webpodì—ì„œ ì²˜ë¦¬ë˜ì–´ì„œ k8s-ctrìœ¼ë¡œ ë‹¤ì‹œ ì‘ë‹µì´ ë¦¬í„´ë˜ëŠ”&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ì˜¤ë²„í—¤ë“œê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ì— ëŒ€í•œ í•´ê²° ë°©ë²•ì€ ì´í›„ì— ì•Œì•„ ë³´ê² ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># router ì—ì„œ ì •ë³´ í™•ì¸ : k8s-ctr ë…¸ë“œì— ëŒ€ìƒ íŒŒë“œê°€ ë°°ì¹˜ë˜ì§€ ì•Šì•˜ì§€ë§Œ, ë¼ìš°íŒ… ê²½ë¡œ ì„¤ì •ì´ ë˜ì–´ ìˆë‹¤.</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp summary'</span>
<span class="c"># =&gt; Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span>
<span class="c">#    192.168.10.100  4      65001       548       552        0    0    0 00:24:49            2        5 N/A</span>
<span class="c">#    192.168.10.101  4      65001       547       550        0    0    0 00:24:51            2        5 N/A</span>
<span class="c">#    192.168.20.100  4      65001       550       553        0    0    0 00:24:36            2        5 N/A</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp'</span>
<span class="c"># =&gt;    Network          Next Hop            Metric LocPrf Weight Path</span>
<span class="c">#    ...</span>
<span class="c">#    *= 172.16.1.1/32    192.168.20.100                         0 65001 i</span>
<span class="c">#    *&gt;                  &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt;                         0 65001 i</span>
<span class="c">#    *=                  192.168.10.101                         0 65001 i</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp 172.16.1.1/32'</span>
<span class="c"># =&gt; BGP routing table entry for 172.16.1.1/32, version 7</span>
<span class="c">#    Paths: (3 available, best #2, table default)</span>
<span class="c">#      Advertised to non peer-group peers:</span>
<span class="c">#      &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt; 192.168.10.101 192.168.20.100</span>
<span class="c">#      65001</span>
<span class="c">#        192.168.20.100 from 192.168.20.100 (192.168.20.100)</span>
<span class="c">#          Origin IGP, valid, external, multipath</span>
<span class="c">#          Last update: Sat Aug 16 16:19:42 2025</span>
<span class="c">#      65001</span>
<span class="c">#        &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt; from 192.168.10.100 (192.168.10.100)</span>
<span class="c">#          Origin IGP, valid, external, multipath, best (Router ID)</span>
<span class="c">#          Last update: Sat Aug 16 16:19:42 2025</span>
<span class="c">#      65001</span>
<span class="c">#        192.168.10.101 from 192.168.10.101 (192.168.10.101)</span>
<span class="c">#          Origin IGP, valid, external, multipath</span>
<span class="c">#          Last update: Sat Aug 16 16:19:42 2025</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip route bgp'</span>
<span class="c"># =&gt; B&gt;* 172.16.1.1/32 [20/0] via &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt;, eth1, weight 1, 00:17:01</span>
<span class="c">#      *                      via 192.168.10.101, eth1, weight 1, 00:17:01</span>
<span class="c">#      *                      via 192.168.20.100, eth2, weight 1, 00:17:01</span>
<span class="c">#    ...</span>

<span class="c"># [k8s-ctr] ë°˜ë³µ ì ‘ì†</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      52 Hostname: webpod-697b545f57-t7wb4</span>
<span class="c">#         48 Hostname: webpod-697b545f57-nhdcd</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ replicasê°€ 2ì´ê¸° ë•Œë¬¸ì—, webpodì˜ íŒŒë“œê°€ k8s-w0, k8s-w1ì˜ 2ê°œë¡œ ë¶„ë°°ë˜ì–´ì„œ Hostnameì´ 2ê°œê°€ ì¶œë ¥ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | egrep <span class="s1">'Hostname|RemoteAddr'</span> <span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-t7wb4</span>
<span class="c">#    RemoteAddr: 192.168.10.100:43914</span>
<span class="c">#    Hostname: webpod-697b545f57-t7wb4</span>
<span class="c">#    RemoteAddr: 192.168.10.100:43920</span>
<span class="c">#    Hostname: webpod-697b545f57-nhdcd</span>
<span class="c">#    RemoteAddr: 192.168.10.100:53840</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë‹¤ë¥¸ ë…¸ë“œì— ìˆëŠ” webpod íŒŒë“œì™€ ì ‘ì†ì´ ë˜ì–´ì„œ k8s-ctrì˜ NodeIPê°€ ì¶œë ¥ë©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì‹ ê·œí„°ë¯¸ë„ (3ê°œ) : k8s-w1, k8s-w2, k8s-w0</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 <span class="nt">-A</span> <span class="nt">-s</span> 0 <span class="nt">-nn</span> <span class="s1">'tcp port 80'</span>

<span class="c"># k8s-ctrÂ ë¥¼ ê²½ìœ í•˜ê±°ë‚˜ ë“± í™•ì¸ : ExternalTrafficPolicy ì„¤ì • í™•ì¸</span>
<span class="nv">$ LBIP</span><span class="o">=</span>172.16.1.1
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-w0 ì´ë‚˜ k8s-w1ê³¼ í†µì‹ ì´ ë˜ë©° k8s-ctrì˜ eth1ì„ ê²½ìœ í•´ì„œ íŒ¨í‚·ì´ ì „ì†¡ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<hr />

<h2 id="kind">Kind</h2>

<h3 id="kind-ì†Œê°œ">Kind ì†Œê°œ</h3>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_8.png" alt="img.png" class="w-20 image-center" /></p>

<ul>
  <li>KindëŠ” <strong>K</strong>ubernetes <strong>in</strong> <strong>D</strong>ockerì˜ ì¤„ì„ë§ë¡œ, ë¡œì»¬ í™˜ê²½ì—ì„œ ì‰½ê²Œ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.</li>
  <li>ì´ë¦„ì²˜ëŸ¼ Dockerë¥¼ ì´ìš©í•˜ì—¬ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ë©°, Dockerë¥¼ ì´ìš©í•˜ê¸° ë•Œë¬¸ì— ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>KindëŠ” HAë¥¼ í¬í•¨í•œ ë©€í‹°ë…¸ë“œë¥¼ ì§€ì›í•˜ì§€ë§Œ, í…ŒìŠ¤íŠ¸ì™€ ì‹¤í—˜ì ì¸ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ê¸°ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.</li>
  <li>KindëŠ” í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ê¸° ìœ„í•´ kubeadmì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li><a href="https://sweetlittlebird.github.io/posts/2024-09-07-KANS-Study-Week2/#kind-%EC%86%8C%EA%B0%9C-%EB%B0%8F-%EC%84%A4%EC%B9%98">Kind ì†Œê°œ ë° ì„¤ì¹˜</a>, <a href="https://kind.sigs.k8s.io/docs/user/quick-start/">Kind ê³µì‹ë¬¸ì„œ</a></li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_9.png" alt="img.png" class="image-center" />
<em class="image-caption"><a href="https://kind.sigs.k8s.io/">Kind êµ¬ì„±ë„</a></em></p>

<h3 id="kind-ì„¤ì¹˜">Kind ì„¤ì¹˜</h3>

<ul>
  <li>Apple Silicon ê¸°ë°˜ Mac ê¸°ì¤€ìœ¼ë¡œ ì„¤ì¹˜ë¥¼ ì§„í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="docker-desktop-ë°-í•„ìˆ˜-íˆ´-ì„¤ì¹˜">Docker Desktop ë° í•„ìˆ˜ íˆ´ ì„¤ì¹˜</h4>

<ul>
  <li>Docker Desktop ì„¤ì¹˜ - <a href="https://docs.docker.com/desktop/install/mac-install/">Link</a>
    <ul>
      <li>ì‹¤ìŠµ í™˜ê²½ : Kind ì‚¬ìš©í•˜ëŠ” ë„ì»¤ ì—”ì§„ ë¦¬ì†ŒìŠ¤ì— ìµœì†Œ <strong>vCPU 4</strong>, <strong>Memory 8GB</strong> í• ë‹¹ì„ ê¶Œê³ í•©ë‹ˆë‹¤. - <a href="https://kind.sigs.k8s.io/docs/user/quick-start/#settings-for-docker-desktop">ë§í¬</a></li>
    </ul>
  </li>
  <li>í•„ìˆ˜ íˆ´ ì„¤ì¹˜
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install Kind</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kind
<span class="nv">$ </span>kind <span class="nt">--version</span>
<span class="c"># =&gt; kind version 0.29.0</span>
  
<span class="c"># Install kubectl</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubernetes-cli
<span class="nv">$ </span>kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Client Version: v1.33.1</span>
  
<span class="c">## kubectl -&gt; k ë‹¨ì¶•í‚¤ ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"alias kubectl=kubecolor"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
  
<span class="c"># Install Helm</span>
<span class="nv">$ </span>brew <span class="nb">install </span>helm
<span class="nv">$ </span>helm version
<span class="c"># =&gt; version.BuildInfo{Version:"v3.18.2", GitCommit:"04cad4610054e5d546aa5c5d9c1b1d5cf68ec1f8", GitTreeState:"clean", GoVersion:"go1.24.3"}</span>
</code></pre></div>    </div>
  </li>
  <li>(ì„ íƒ) ìœ ìš©í•œ íˆ´ ì„¤ì¹˜
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>brew <span class="nb">install </span>krew
<span class="nv">$ </span>brew <span class="nb">install </span>kube-ps1
<span class="nv">$ </span>brew <span class="nb">install </span>kubectx
  
<span class="c"># kubectl ì¶œë ¥ ì‹œ í•˜ì´ë¼ì´íŠ¸ ì²˜ë¦¬</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubecolor
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"alias kubectl=kubecolor"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"compdef kubecolor=kubectl"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
</code></pre></div>    </div>
    <h3 id="kind-ê¸°ë³¸-ì‚¬ìš©---í´ëŸ¬ìŠ¤í„°-ë°°í¬-ë°-í™•ì¸">kind ê¸°ë³¸ ì‚¬ìš© - í´ëŸ¬ìŠ¤í„° ë°°í¬ ë° í™•ì¸</h3>
  </li>
</ul>

<blockquote>
  <p>ì´ë¯¸ kubeconfigê°€ ìˆë‹¤ë©´, ë¯¸ë¦¬ kubeconfigë¥¼ ë°±ì—… í›„ kindë¥¼ ì‹¤ìŠµí•˜ê±°ë‚˜, ì•„ë˜ ì²˜ëŸ¼ kubeconfig ë³€ìˆ˜ë¥¼ ì§€ì •í•˜ì—¬ ì‚¬ìš©í•˜ê¸°ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
</blockquote>

<ul>
  <li>(ì˜µì…˜) ë³„ë„ kubeconfig ì§€ì • í›„ ì‚¬ìš©
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°©ì•ˆ1 : í™˜ê²½ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/Users/&lt;Username&gt;/Downloads/kind/config
  
<span class="c"># ë°©ì•ˆ2 : í˜¹ì€ --kubeconfig ./config ì§€ì • ê°€ëŠ¥</span>
  
<span class="c"># í´ëŸ¬ìŠ¤í„° ìƒì„±</span>
<span class="nv">$ </span>kind create cluster
  
<span class="c"># kubeconfig íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /Users/&lt;Username&gt;/Downloads/kind/config
<span class="c"># =&gt; -rw-------  1 &lt;Username&gt;  staff  5608  4 24 09:05 /Users/&lt;Username&gt;/Downloads/kind/config</span>
  
<span class="c"># íŒŒë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
  
<span class="c"># í´ëŸ¬ìŠ¤í„° ì‚­ì œ</span>
<span class="nv">$ </span>kind delete cluster
<span class="nv">$ </span><span class="nb">unset </span>KUBECONFIG
</code></pre></div>    </div>
  </li>
  <li>Kind í´ëŸ¬ìŠ¤í„° ë°°í¬ ë° í™•ì¸
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ë°°í¬ ì „ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span>
  
<span class="c"># Create a cluster with kind</span>
<span class="nv">$ </span>kind create cluster
<span class="c"># =&gt; Creating cluster "kind" ...</span>
<span class="c">#     âœ“ Ensuring node image (kindest/node:v1.33.1) ğŸ–¼</span>
<span class="c">#     âœ“ Preparing nodes ğŸ“¦</span>
<span class="c">#     âœ“ Writing configuration ğŸ“œ</span>
<span class="c">#     âœ“ Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#     âœ“ Installing CNI ğŸ”Œ</span>
<span class="c">#     âœ“ Installing StorageClass ğŸ’¾</span>
<span class="c">#    Set kubectl context to "kind-kind"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-kind</span>
  
<span class="c"># í´ëŸ¬ìŠ¤í„° ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kind get clusters
<span class="c"># =&gt; kind</span>
<span class="nv">$ </span>kind get nodes
<span class="c"># =&gt; kind-control-plane</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://127.0.0.1:56460</span>
<span class="c">#    CoreDNS is running at https://127.0.0.1:56460/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="c">#    </span>
<span class="c">#    To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>
  
<span class="c"># ë…¸ë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                 STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    kind-control-plane   Ready    control-plane   48s   v1.33.1   172.20.0.2    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.1.1</span>
  
<span class="c"># íŒŒë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-922ww                     1/1     Running   0          49s</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-mm68k                     1/1     Running   0          49s</span>
<span class="c">#    kube-system          etcd-kind-control-plane                      1/1     Running   0          55s</span>
<span class="c">#    kube-system          kindnet-cvgzn                                1/1     Running   0          49s</span>
<span class="c">#    kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          55s</span>
<span class="c">#    kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          55s</span>
<span class="c">#    kube-system          kube-proxy-xkczv                             1/1     Running   0          49s</span>
<span class="c">#    kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          55s</span>
<span class="c">#    local-path-storage   local-path-provisioner-7dc846544d-th5jx      1/1     Running   0          49s</span>
<span class="nv">$ </span>kubectl get componentstatuses
<span class="c"># =&gt; NAME                 STATUS    MESSAGE   ERROR</span>
<span class="c">#    scheduler            Healthy   ok</span>
<span class="c">#    controller-manager   Healthy   ok</span>
<span class="c">#    etcd-0               Healthy   ok</span>
  
<span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ (ì»¨í…Œì´ë„ˆ) ë…¸ë“œ 1ëŒ€ê°€ ì‹¤í–‰</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS              PORTS                       NAMES</span>
<span class="c">#    d2b1bc35791a   kindest/node:v1.33.1   "/usr/local/bin/entrâ€¦"   About a minute ago   Up About a minute   127.0.0.1:56460-&gt;6443/tcp   kind-control-plane</span>
<span class="nv">$ </span>docker images
<span class="c"># =&gt; REPOSITORY                                        TAG                                        IMAGE ID       CREATED         SIZE</span>
<span class="c">#    kindest/node                                      &lt;none&gt;                                     071dd73121e8   2 months ago    1.09GB</span>
  
<span class="c"># kube config íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$KUBECONFIG</span> <span class="c"># KUBECONFIG ë³€ìˆ˜ ì§€ì • ì‚¬ìš© ì‹œ</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê¸°ì¡´ kube configì— ì¶”ê°€ì ìœ¼ë¡œ kind í´ëŸ¬ìŠ¤í„° ê´€ë ¨ í•­ëª©ì´ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ë˜í•œ current-context: kind-kindì—¬ì„œ kubectl ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ kind í´ëŸ¬ìŠ¤í„°ì— ì—°ê²°ë˜ì–´ ì‹¤í–‰ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
  
<span class="c"># nginx íŒŒë“œ ë°°í¬ ë° í™•ì¸ : ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œì¸ë° íŒŒë“œê°€ ë°°í¬ ë ê¹Œìš”?</span>
<span class="nv">$ </span>kubectl run nginx <span class="nt">--image</span><span class="o">=</span>nginx:alpine
<span class="c"># =&gt; pod/nginx created</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME    READY   STATUS    RESTARTS   AGE   IP           NODE                 NOMINATED NODE   READINESS GATES</span>
<span class="c">#    nginx   1/1     Running   0          11s   10.244.0.5   kind-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ íŒŒë“œê°€ ë°°í¬ ë©ë‹ˆë‹¤!&lt;/span&gt;</span>
  
<span class="c"># ë…¸ë“œì— Taints ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe node | <span class="nb">grep </span>Taints
<span class="c"># =&gt; Taints:             &lt;none&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì´ì§€ë§Œ Taintsê°€ ì—†ì–´ì„œ íŒŒë“œê°€ ë°°í¬ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
  
<span class="c"># í´ëŸ¬ìŠ¤í„° ì‚­ì œ</span>
<span class="nv">$ </span>kind delete cluster
<span class="c"># =&gt; Deleting cluster "kind" ...</span>
  
<span class="c"># kube config ì‚­ì œ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$KUBECONFIG</span> <span class="c"># KUBECONFIG ë³€ìˆ˜ ì§€ì • ì‚¬ìš© ì‹œ</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ kind í´ëŸ¬ìŠ¤í„° ê´€ë ¨ í•­ëª©ì´ ì‚­ì œëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>kindë¡œ worker nodeê°€ 3ê°œì¸ í´ëŸ¬ìŠ¤í„° ë°°í¬ í›„ ê¸°ë³¸ ì •ë³´ë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ë°°í¬ ì „ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span>
  
<span class="c"># Create a cluster with kind</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.32.2 <span class="nt">--config</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  - containerPort: 30003
    hostPort: 30003
- role: worker
- role: worker
- role: worker
</span><span class="no">EOF
</span><span class="c"># =&gt; Creating cluster "myk8s" ...</span>
<span class="c">#     âœ“ Ensuring node image (kindest/node:v1.32.2) ğŸ–¼</span>
<span class="c">#     âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦ ğŸ“¦</span>
<span class="c">#     âœ“ Writing configuration ğŸ“œ</span>
<span class="c">#     âœ“ Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#     âœ“ Installing CNI ğŸ”Œ</span>
<span class="c">#     âœ“ Installing StorageClass ğŸ’¾</span>
<span class="c">#     âœ“ Joining worker nodes ğŸšœ</span>
<span class="c">#    Set kubectl context to "kind-myk8s"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-myk8s</span>
<span class="c">#    Have a nice day! ğŸ‘‹</span>
  
<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kind get nodes <span class="nt">--name</span> myk8s
<span class="c"># =&gt; myk8s-worker3</span>
<span class="c">#    myk8s-worker2</span>
<span class="c">#    myk8s-control-plane</span>
<span class="c">#    myk8s-worker</span>
<span class="nv">$ </span>kubens default
<span class="c"># =&gt; Context "kind-myk8s" modified.</span>
<span class="c">#    Active namespace is "default".</span>
  
<span class="c"># kind ëŠ” ë³„ë„ ë„ì»¤ ë„¤íŠ¸ì›Œí¬ ìƒì„± í›„ ì‚¬ìš© : ê¸°ë³¸ê°’ 172.20.0.0/16</span>
<span class="nv">$ </span>docker network <span class="nb">ls</span>
<span class="c"># =&gt; NETWORK ID     NAME                         DRIVER    SCOPE</span>
<span class="c">#    db5d49a84cd0   bridge                       bridge    local</span>
<span class="c">#    8204a0851463   host                         host      local</span>
<span class="c">#    &lt;span style="color: green;"&gt;3bbcc6aa8f38   kind&lt;/span&gt;                         bridge    local</span>
<span class="nv">$ </span>docker inspect kind | jq
<span class="c"># =&gt; ...</span>
<span class="c">#        "IPAM": {</span>
<span class="c">#          "Config": [</span>
<span class="c">#            {</span>
<span class="c">#              "Subnet": "172.20.0.0/16",</span>
<span class="c">#              "Gateway": "172.20.0.1"</span>
<span class="c">#    ...</span>
<span class="c"># k8s api ì£¼ì†Œ í™•ì¸ : ì–´ë–»ê²Œ ë¡œì»¬ì—ì„œ ì ‘ì†ì´ ë˜ëŠ” ê±¸ê¹Œìš”?</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at &lt;span style="color: green;"&gt;https://127.0.0.1:57349&lt;/span&gt;</span>
<span class="c">#    CoreDNS is running at https://127.0.0.1:57349/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="c">#    </span>
<span class="c">#    To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>
  
<span class="c"># ë…¸ë“œ ì •ë³´ í™•ì¸ : CRI ëŠ” containerd ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   3m36s   v1.32.2   172.20.0.5    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.0.3</span>
<span class="c">#    myk8s-worker          Ready    &lt;none&gt;          3m26s   v1.32.2   172.20.0.2    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.0.3</span>
<span class="c">#    myk8s-worker2         Ready    &lt;none&gt;          3m26s   v1.32.2   172.20.0.3    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.0.3</span>
<span class="c">#    myk8s-worker3         Ready    &lt;none&gt;          3m26s   v1.32.2   172.20.0.4    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.0.3</span>
  
<span class="c"># íŒŒë“œ ì •ë³´ í™•ì¸ : CNI ëŠ” kindnet ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-o</span> wide
<span class="c"># =&gt; NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE     IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system          coredns-668d6bf9bc-2d5fq                      1/1     Running   0          3m37s   10.244.0.3   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          coredns-668d6bf9bc-f8vg2                      1/1     Running   0          3m37s   10.244.0.4   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          etcd-myk8s-control-plane                      1/1     Running   0          3m45s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          &lt;span style="color: green;"&gt;kindnet-b47qh&lt;/span&gt;                                 1/1     Running   0          3m36s   172.20.0.2   myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          &lt;span style="color: green;"&gt;kindnet-fx7pl&lt;/span&gt;                                 1/1     Running   0          3m38s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          &lt;span style="color: green;"&gt;kindnet-jr9g8&lt;/span&gt;                                 1/1     Running   0          3m36s   172.20.0.4   myk8s-worker3         &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          &lt;span style="color: green;"&gt;kindnet-sck5c&lt;/span&gt;                                 1/1     Running   0          3m36s   172.20.0.3   myk8s-worker2         &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-apiserver-myk8s-control-plane            1/1     Running   0          3m45s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-controller-manager-myk8s-control-plane   1/1     Running   0          3m45s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-5vlx4                              1/1     Running   0          3m36s   172.20.0.4   myk8s-worker3         &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-8kz4j                              1/1     Running   0          3m36s   172.20.0.3   myk8s-worker2         &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-rlnwn                              1/1     Running   0          3m37s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-znszc                              1/1     Running   0          3m36s   172.20.0.2   myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-scheduler-myk8s-control-plane            1/1     Running   0          3m45s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    local-path-storage   local-path-provisioner-7dc846544d-h5xp6       1/1     Running   0          3m37s   10.244.0.2   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
  
<span class="c"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸ &gt;&gt; ë„ì»¤ ì»¨í…Œì´ë„ˆì—ì„œ ë°°ìš´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ ë‹¤ë¦…ë‹ˆë‹¤!</span>
<span class="nv">$ </span>kubectl get namespaces
<span class="c"># =&gt; NAME                 STATUS   AGE</span>
<span class="c">#    default              Active   5m31s</span>
<span class="c">#    kube-node-lease      Active   5m31s</span>
<span class="c">#    kube-public          Active   5m31s</span>
<span class="c">#    kube-system          Active   5m31s</span>
<span class="c">#    local-path-storage   Active   5m23s</span>
  
<span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸/ì›Œì»¤ ë…¸ë“œ(ì»¨í…Œì´ë„ˆ) í™•ì¸ : ë„ì»¤ ì»¨í…Œì´ë„ˆ ì´ë¦„ì€ myk8s-control-plane , myk8s-worker/2/3 ì„ì„ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS         PORTS                                                             NAMES</span>
<span class="c">#    98bc90974283   kindest/node:v1.32.2   "/usr/local/bin/entrâ€¦"   6 minutes ago   Up 5 minutes                                                                     myk8s-worker3</span>
<span class="c">#    4bf34678cbed   kindest/node:v1.32.2   "/usr/local/bin/entrâ€¦"   6 minutes ago   Up 5 minutes                                                                     myk8s-worker2</span>
<span class="c">#    f85eef8fcd53   kindest/node:v1.32.2   "/usr/local/bin/entrâ€¦"   6 minutes ago   Up 5 minutes   0.0.0.0:30000-30003-&gt;30000-30003/tcp, 127.0.0.1:57349-&gt;6443/tcp   myk8s-control-plane</span>
<span class="c">#    1f27bfafc1ac   kindest/node:v1.32.2   "/usr/local/bin/entrâ€¦"   6 minutes ago   Up 5 minutes                                                                     myk8s-worker</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ controlplaneì˜ API ì„œë²„(6443/tcp)ë¥¼ hostì˜ 57349í¬íŠ¸ë¡œ í¬íŠ¸í¬ì›Œë”© í•˜ê³  &lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   kubectl cluster-infoì—ì„œ í™•ì¸í•œê²ƒ ì²˜ëŸ¼ kubectl ì‚¬ìš©ì‹œ 127.0.0.1:57349ë¡œ ì ‘ì†ì´ ë˜ê¸° ë•Œë¬¸ì—&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   hostì—ì„œ kubectlë¡œ ì ‘ì†ì´ ê°€ëŠ¥í•˜ê²Œ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>docker images
<span class="c"># =&gt; REPOSITORY                                        TAG                                        IMAGE ID       CREATED         SIZE</span>
<span class="c">#    kindest/node                                      &lt;none&gt;                                     071dd73121e8   2 months ago    1.09GB</span>
<span class="c">#    kindest/node                                      &lt;span style="color: green;"&gt;v1.32.2&lt;/span&gt;                                    b5193db9db63   5 months ago    1.06GB</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜ì‹œ ë²„ì „ì„ 1.32.2ë¡œ ì§€ì •í–ˆê¸° ë•Œë¬¸ì— kindest/node:v1.32.2 ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ss <span class="nt">-tnlp</span>
<span class="c"># =&gt; State              Recv-Q             Send-Q                           Local Address:Port                            Peer Address:Port             Process</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:10257                                0.0.0.0:*                 users:(("kube-controller",pid=584,fd=3))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:10259                                0.0.0.0:*                 users:(("kube-scheduler",pid=522,fd=3))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:34873                                0.0.0.0:*                 users:(("containerd",pid=105,fd=11))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:10248                                0.0.0.0:*                 users:(("kubelet",pid=705,fd=17))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:10249                                0.0.0.0:*                 users:(("kube-proxy",pid=890,fd=12))</span>
<span class="c">#    LISTEN             0                  4096                                172.20.0.5:2379                                 0.0.0.0:*                 users:(("etcd",pid=646,fd=9))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:2379                                 0.0.0.0:*                 users:(("etcd",pid=646,fd=8))</span>
<span class="c">#    LISTEN             0                  4096                                172.20.0.5:2380                                 0.0.0.0:*                 users:(("etcd",pid=646,fd=7))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:2381                                 0.0.0.0:*                 users:(("etcd",pid=646,fd=13))</span>
<span class="c">#    LISTEN             0                  1024                                127.0.0.11:38253                                0.0.0.0:*</span>
<span class="c">#    LISTEN             0                  4096                                         *:10250                                      *:*                 users:(("kubelet",pid=705,fd=11))</span>
<span class="c">#    LISTEN             0                  4096                                         &lt;span style="color: green;"&gt;*:6443&lt;/span&gt;                                       *:*                 users:(("kube-apiserver",pid=562,fd=3))</span>
<span class="c">#    LISTEN             0                  4096                                         *:10256                                      *:*                 users:(("kube-proxy",pid=890,fd=10))</span>
  
<span class="c"># ë””ë²„ê·¸ìš© ë‚´ìš© ì¶œë ¥ì— ~/.kube/config ê¶Œí•œ ì¸ì¦ ë¡œë“œ</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-v6</span>
<span class="c"># =&gt; I0816 17:31:00.340008   21457 loader.go:402] &lt;span style="color: green;"&gt;Config loaded from file:  /Users/anonym/.kube/config&lt;/span&gt;</span>
<span class="c">#    I0816 17:31:00.342176   21457 envvar.go:172] "Feature gate default state" feature="ClientsAllowCBOR" enabled=false</span>
<span class="c">#    I0816 17:31:00.342185   21457 envvar.go:172] "Feature gate default state" feature="ClientsPreferCBOR" enabled=false</span>
<span class="c">#    I0816 17:31:00.342188   21457 envvar.go:172] "Feature gate default state" feature="InformerResourceVersion" enabled=false</span>
<span class="c">#    I0816 17:31:00.342190   21457 envvar.go:172] "Feature gate default state" feature="InOrderInformers" enabled=true</span>
<span class="c">#    I0816 17:31:00.342212   21457 envvar.go:172] "Feature gate default state" feature="WatchListClient" enabled=false</span>
<span class="c">#    I0816 17:31:00.378209   21457 round_trippers.go:632] "Response" verb="GET" url="https://127.0.0.1:57349/api/v1/namespaces/default/pods?limit=500" status="200 OK" milliseconds=29</span>
<span class="c">#    No resources found in default namespace.</span>
  
<span class="c"># kube config íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$KUBECONFIG</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ kind-myk8s í´ëŸ¬ìŠ¤í„° ê´€ë ¨ í•­ëª©ì´ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ë˜í•œ current-context: kind-myk8sì—¬ì„œ kubectl ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ kind-myk8s í´ëŸ¬ìŠ¤í„°ì— ì—°ê²°ë˜ì–´ ì‹¤í–‰ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>Kind í´ëŸ¬ìŠ¤í„° ì‚­ì œ
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ì‚­ì œ</span>
<span class="nv">$ </span>kind delete cluster <span class="nt">--name</span> myk8s
<span class="c"># =&gt; Deleting cluster "myk8s" ...</span>
<span class="c">#    Deleted nodes: ["myk8s-worker3" "myk8s-worker2" "myk8s-control-plane" "myk8s-worker"]</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="cluster-mesh">Cluster Mesh</h2>

<blockquote>
  <p>í˜„ì¬ 1.18 ë²„ì „ì˜ ClusterMesh ë¶„ì‚° ë™ì‘ì— ì´ìƒì´ ìˆëŠ”ê²ƒ ê°™ì•„ì„œ, 1.17.6 ë²„ì „ìœ¼ë¡œ ì‹¤ìŠµì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.</p>
</blockquote>

<ul>
  <li>Cluster MeshëŠ” Ciliumì˜ ê¸°ëŠ¥ ì¤‘ í•˜ë‚˜ë¡œ, ì—¬ëŸ¬ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ì—°ê²°í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¥í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</li>
</ul>

<h4 id="kind-k8s-í´ëŸ¬ìŠ¤í„°-west-east-ë°°í¬">kind k8s í´ëŸ¬ìŠ¤í„° west, east ë°°í¬</h4>

<ul>
  <li><a href="https://docs.cilium.io/en/latest/installation/kind/">ê´€ë ¨ ë¬¸ì„œ</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># west í´ëŸ¬ìŠ¤í„°ë¥¼ ë¨¼ì € ë°°í¬í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--name</span> west <span class="nt">--image</span> kindest/node:v1.33.2 <span class="nt">--config</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000 # sample apps
    hostPort: 30000
  - containerPort: 30001 # hubble ui
    hostPort: 30001
- role: worker
  extraPortMappings:
  - containerPort: 30002 # sample apps
    hostPort: 30002
networking:
  podSubnet: "10.0.0.0/16"
  serviceSubnet: "10.2.0.0/16"
  disableDefaultCNI: true
  kubeProxyMode: none
</span><span class="no">EOF
</span><span class="c"># =&gt; Creating cluster "west" ...</span>
<span class="c">#     âœ“ Ensuring node image (kindest/node:v1.33.2) ğŸ–¼</span>
<span class="c">#     âœ“ Preparing nodes ğŸ“¦ ğŸ“¦</span>
<span class="c">#     âœ“ Writing configuration ğŸ“œ</span>
<span class="c">#     âœ“ Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#     âœ“ Installing StorageClass ğŸ’¾</span>
<span class="c">#     âœ“ Joining worker nodes ğŸšœ</span>
<span class="c">#    Set kubectl context to "kind-west"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-west</span>
<span class="c">#    </span>
<span class="c">#    Have a nice day! ğŸ‘‹</span>

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl ctx
<span class="c"># =&gt;   kind-west</span>
<span class="nv">$ </span>kubectl get node 
<span class="c"># =&gt; NAME                 STATUS     ROLES           AGE   VERSION</span>
<span class="c">#    west-control-plane   NotReady   control-plane   75s   v1.33.2</span>
<span class="c">#    west-worker          NotReady   &lt;none&gt;          64s   v1.33.2</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-5zmlc                     &lt;span style="color: green;"&gt;0/1&lt;/span&gt;     Pending   0          86s</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-b72sk                     &lt;span style="color: green;"&gt;0/1&lt;/span&gt;     Pending   0          86s</span>
<span class="c">#    kube-system          etcd-west-control-plane                      1/1     Running   0          93s</span>
<span class="c">#    kube-system          kube-apiserver-west-control-plane            1/1     Running   0          93s</span>
<span class="c">#    kube-system          kube-controller-manager-west-control-plane   1/1     Running   0          93s</span>
<span class="c">#    kube-system          kube-scheduler-west-control-plane            1/1     Running   0          93s</span>
<span class="c">#    local-path-storage   local-path-provisioner-7dc846544d-vlh7b      &lt;span style="color: green;"&gt;0/1&lt;/span&gt;     Pending   0          86s</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ Cilium ì„¤ì¹˜ë¥¼ ìœ„í•´ disableDefaultCNI: trueë¥¼ ì§€ì •í–ˆê¸° ë•Œë¬¸ì—, CNIê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ê³  ì¼ë¶€ íŒŒë“œê°€ Pending ìƒíƒœì…ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë…¸ë“œì— ê¸°ë³¸ íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget net-tools dnsutils tcpdump ngrep iputils-ping git -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-worker sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget net-tools dnsutils tcpdump ngrep iputils-ping git -y'</span>

<span class="c"># ì´ì–´ì„œ east í´ëŸ¬ìŠ¤í„°ë¥¼ ë°°í¬í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--name</span> east <span class="nt">--image</span> kindest/node:v1.33.2 <span class="nt">--config</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 31000 # sample apps
    hostPort: 31000
  - containerPort: 31001 # hubble ui
    hostPort: 31001
- role: worker
  extraPortMappings:
  - containerPort: 31002 # sample apps
    hostPort: 31002
networking:
  podSubnet: "10.1.0.0/16"
  serviceSubnet: "10.3.0.0/16"
  disableDefaultCNI: true
  kubeProxyMode: none
</span><span class="no">EOF
</span><span class="c"># =&gt; Creating cluster "east" ...</span>
<span class="c">#     âœ“ Ensuring node image (kindest/node:v1.33.2) ğŸ–¼</span>
<span class="c">#     âœ“ Preparing nodes ğŸ“¦ ğŸ“¦</span>
<span class="c">#     âœ“ Writing configuration ğŸ“œ</span>
<span class="c">#     âœ“ Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#     âœ“ Installing StorageClass ğŸ’¾</span>
<span class="c">#     âœ“ Joining worker nodes ğŸšœ</span>
<span class="c">#    Set kubectl context to "kind-east"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-east</span>
<span class="c">#    </span>
<span class="c">#    Have a nice day! ğŸ‘‹</span>

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl config get-contexts 
<span class="c"># =&gt; CURRENT   NAME         CLUSTER     AUTHINFO    NAMESPACE</span>
<span class="c">#    *         kind-east    kind-east   kind-east</span>
<span class="c">#              kind-west    kind-west   kind-west</span>

<span class="c"># ê¸°ë³¸ contextë¥¼ kind-eastë¡œ ë³€ê²½</span>
<span class="nv">$ </span>kubectl config set-context kind-east
<span class="c"># =&gt; Context "kind-east" modified.</span>

<span class="nv">$ </span>kubectl get node <span class="nt">-v</span><span class="o">=</span>6 <span class="nt">--context</span> kind-east
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ kind-east í´ëŸ¬ìŠ¤í„°ì˜ ë…¸ë“œ ì •ë³´ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-v</span><span class="o">=</span>6
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê¸°ë³¸ ì»¨í…ìŠ¤íŠ¸ê°€ kind-eastì´ê¸° ë•Œë¬¸ì— kind-east í´ëŸ¬ìŠ¤í„°ì˜ ë…¸ë“œ ì •ë³´ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-v</span><span class="o">=</span>6 <span class="nt">--context</span> kind-west
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ëª…ì‹œì ìœ¼ë¡œ kind-west ì»¨í…ìŠ¤ë¥´í‹€ ì§€ì •í•˜ì—¬ west í´ëŸ¬ìŠ¤í„°ì˜ ë…¸ë“œ ì •ë³´ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config

<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ kind-east í´ëŸ¬ìŠ¤í„°ì˜ íŒŒë“œ ì •ë³´ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">--context</span> kind-west
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ëª…ì‹œì ìœ¼ë¡œ kind-west ì»¨í…ìŠ¤íŠ¸ë¥¼ ì§€ì •í•˜ì—¬ west í´ëŸ¬ìŠ¤í„°ì˜ íŒŒë“œ ì •ë³´ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë…¸ë“œì— ê¸°ë³¸ íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget net-tools dnsutils tcpdump ngrep iputils-ping git -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget net-tools dnsutils tcpdump ngrep iputils-ping git -y'</span>
</code></pre></div></div>

<ul>
  <li>alias ì„¤ì •</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># alias ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">kwest</span><span class="o">=</span><span class="s1">'kubectl --context kind-west'</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">keast</span><span class="o">=</span><span class="s1">'kubectl --context kind-east'</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kwest get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 STATUS     ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    west-control-plane   NotReady   control-plane   2m57s   v1.33.2   172.20.0.4    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.1.3</span>
<span class="c">#    west-worker          NotReady   &lt;none&gt;          2m45s   v1.33.2   172.20.0.2    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.1.3</span>
<span class="nv">$ </span>keast get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 STATUS     ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    east-control-plane   NotReady   control-plane   9m45s   v1.33.2   172.20.0.5    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.1.3</span>
<span class="c">#    east-worker          NotReady   &lt;none&gt;          9m32s   v1.33.2   172.20.0.3    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.1.3</span>
</code></pre></div></div>

<h3 id="cilium-cni-ë°°í¬">Cilium CNI ë°°í¬</h3>

<ul>
  <li>Cilium CNIì˜ ClusterMesh ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë¨¼ì € Cilium CNIë¥¼ ë°°í¬í•©ë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/network/clustermesh/clustermesh/">Docs</a>, <a href="https://nomadxd.github.io/blog/multi-cluster-networking-with-cilium-cluster-mesh">Blog</a></li>
  <li>ì´ë²ˆì—ëŠ” Cilium CLIë¥¼ ì‚¬ìš©í•˜ì—¬ Cilium CNIë¥¼ ë°°í¬í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium cli ì„¤ì¹˜</span>
<span class="nv">$ </span>brew <span class="nb">install </span>cilium-cli <span class="c"># macOS</span>

<span class="c">## https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/#install-the-cilium-cli # Windwos WSL2 , ì•„ë˜ ëª…ë ¹ì–´ë¡œ ì„¤ì¹˜</span>
<span class="c">#$ CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)</span>
<span class="c">#$ CLI_ARCH=amd64</span>
<span class="c">#$ if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi</span>
<span class="c">#$ curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}</span>
<span class="c">#$ sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum</span>
<span class="c">#$ sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin</span>
<span class="c">#$ rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}</span>

<span class="c"># cilium cli ë¡œ cilium cni ì„¤ì¹˜í•´ë³´ê¸° : dry-run</span>
<span class="nv">$ </span>cilium <span class="nb">install</span> <span class="nt">--version</span> 1.17.6 <span class="nt">--set</span> ipam.mode<span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>10.0.0.0/16 <span class="se">\</span>
  <span class="nt">--set</span> ipMasqAgent.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> ipMasqAgent.config.nonMasqueradeCIDRs<span class="o">=</span><span class="s1">'{10.1.0.0/16}'</span> <span class="se">\</span>
  <span class="nt">--set</span> cluster.name<span class="o">=</span>west <span class="nt">--set</span> cluster.id<span class="o">=</span>1 <span class="se">\</span>
  <span class="nt">--context</span> kind-west <span class="nt">--dry-run-helm-values</span>
<span class="c"># =&gt; autoDirectNodeRoutes: true</span>
<span class="c">#    bpf:</span>
<span class="c">#      masquerade: true</span>
<span class="c">#    cluster:</span>
<span class="c">#      id: 1</span>
<span class="c">#      name: west</span>
<span class="c">#    debug:</span>
<span class="c">#      enabled: true</span>
<span class="c">#    endpointHealthChecking:</span>
<span class="c">#      enabled: false</span>
<span class="c">#    healthChecking: false</span>
<span class="c">#    ipMasqAgent:</span>
<span class="c">#      config:</span>
<span class="c">#        nonMasqueradeCIDRs:</span>
<span class="c">#        - 10.1.0.0/16</span>
<span class="c">#      enabled: true</span>
<span class="c">#    ipam:</span>
<span class="c">#      mode: kubernetes</span>
<span class="c">#    ipv4NativeRoutingCIDR: 10.0.0.0/16</span>
<span class="c">#    k8sServiceHost: 172.20.0.4</span>
<span class="c">#    k8sServicePort: 6443</span>
<span class="c">#    kubeProxyReplacement: true</span>
<span class="c">#    operator:</span>
<span class="c">#      replicas: 1</span>
<span class="c">#    routingMode: native  </span>

<span class="c"># cilium cli ë¡œ cilium cni ì„¤ì¹˜</span>
<span class="nv">$ </span>cilium <span class="nb">install</span> <span class="nt">--version</span> 1.17.6 <span class="nt">--set</span> ipam.mode<span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>10.0.0.0/16 <span class="se">\</span>
  <span class="nt">--set</span> ipMasqAgent.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> ipMasqAgent.config.nonMasqueradeCIDRs<span class="o">=</span><span class="s1">'{10.1.0.0/16}'</span> <span class="se">\</span>
  <span class="nt">--set</span> cluster.name<span class="o">=</span>west <span class="nt">--set</span> cluster.id<span class="o">=</span>1 <span class="se">\</span>
  <span class="nt">--context</span> kind-west
<span class="c"># =&gt; ğŸ”® Auto-detected Kubernetes kind: kind</span>
<span class="c">#    â„¹ï¸   Using Cilium version 1.17.6</span>
<span class="c">#    â„¹ï¸   Using cluster name "west"</span>
<span class="c">#    â„¹ï¸   Detecting real Kubernetes API server addr and port on Kind</span>
<span class="c">#    ğŸ”® Auto-detected kube-proxy has not been installed</span>
<span class="c">#    â„¹ï¸   Cilium will fully replace all functionalities of kube-proxy  </span>

<span class="nv">$ </span>watch kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">--context</span> kind-west


<span class="c"># dry-run</span>
<span class="nv">$ </span>cilium <span class="nb">install</span> <span class="nt">--version</span> 1.17.6 <span class="nt">--set</span> ipam.mode<span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>10.1.0.0/16 <span class="se">\</span>
  <span class="nt">--set</span> ipMasqAgent.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> ipMasqAgent.config.nonMasqueradeCIDRs<span class="o">=</span><span class="s1">'{10.0.0.0/16}'</span> <span class="se">\</span>
  <span class="nt">--set</span> cluster.name<span class="o">=</span>east <span class="nt">--set</span> cluster.id<span class="o">=</span>2 <span class="se">\</span>
  <span class="nt">--context</span> kind-east <span class="nt">--dry-run-helm-values</span>

<span class="nv">$ </span>cilium <span class="nb">install</span> <span class="nt">--version</span> 1.17.6 <span class="nt">--set</span> ipam.mode<span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>10.1.0.0/16 <span class="se">\</span>
  <span class="nt">--set</span> ipMasqAgent.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> ipMasqAgent.config.nonMasqueradeCIDRs<span class="o">=</span><span class="s1">'{10.0.0.0/16}'</span> <span class="se">\</span>
  <span class="nt">--set</span> cluster.name<span class="o">=</span>east <span class="nt">--set</span> cluster.id<span class="o">=</span>2 <span class="se">\</span>
  <span class="nt">--context</span> kind-east
<span class="c"># =&gt; ğŸ”® Auto-detected Kubernetes kind: kind</span>
<span class="c">#    â„¹ï¸  Using Cilium version 1.17.6</span>
<span class="c">#    â„¹ï¸  Using cluster name "east"</span>
<span class="c">#    â„¹ï¸  Detecting real Kubernetes API server addr and port on Kind</span>
<span class="c">#    ğŸ”® Auto-detected kube-proxy has not been installed</span>
<span class="c">#    â„¹ï¸  Cilium will fully replace all functionalities of kube-proxy</span>

<span class="nv">$ </span>watch kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">--context</span> kind-east

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kwest get pod <span class="nt">-A</span> <span class="o">&amp;&amp;</span> keast get pod <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-system          cilium-8tblx                                 1/1     Running   0          4m55s</span>
<span class="c">#    kube-system          cilium-envoy-f9wd9                           1/1     Running   0          4m55s</span>
<span class="c">#    kube-system          cilium-envoy-fvthm                           1/1     Running   0          4m55s</span>
<span class="c">#    kube-system          cilium-fsnxx                                 1/1     Running   0          4m55s</span>
<span class="c">#    kube-system          cilium-operator-7d99d97595-wdt52             1/1     Running   0          4m55s</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-85kzg                     1/1     Running   0          3h2m</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-cf7xm                     1/1     Running   0          3h2m</span>
<span class="c">#    kube-system          etcd-west-control-plane                      1/1     Running   0          3h2m</span>
<span class="c">#    kube-system          kube-apiserver-west-control-plane            1/1     Running   0          3h2m</span>
<span class="c">#    kube-system          kube-controller-manager-west-control-plane   1/1     Running   0          3h2m</span>
<span class="c">#    kube-system          kube-scheduler-west-control-plane            1/1     Running   0          3h2m</span>
<span class="c">#    local-path-storage   local-path-provisioner-7dc846544d-t968t      1/1     Running   0          3h2m</span>
<span class="c">#    NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-system          cilium-envoy-25kb6                           1/1     Running   0          4m7s</span>
<span class="c">#    kube-system          cilium-envoy-xmxkx                           1/1     Running   0          4m7s</span>
<span class="c">#    kube-system          cilium-gvcf9                                 1/1     Running   0          4m7s</span>
<span class="c">#    kube-system          cilium-operator-6d9fc44d58-8xmkb             1/1     Running   0          4m7s</span>
<span class="c">#    kube-system          cilium-w547m                                 1/1     Running   0          4m7s</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-s6bdx                     1/1     Running   0          3h9m</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-sb52k                     1/1     Running   0          3h9m</span>
<span class="c">#    kube-system          etcd-east-control-plane                      1/1     Running   0          3h9m</span>
<span class="c">#    kube-system          kube-apiserver-east-control-plane            1/1     Running   0          3h9m</span>
<span class="c">#    kube-system          kube-controller-manager-east-control-plane   1/1     Running   0          3h9m</span>
<span class="c">#    kube-system          kube-scheduler-east-control-plane            1/1     Running   0          3h9m</span>
<span class="c">#    local-path-storage   local-path-provisioner-7dc846544d-m7trp      1/1     Running   0          3h9m</span>
<span class="nv">$ </span>cilium status <span class="nt">--context</span> kind-west
<span class="nv">$ </span>cilium status <span class="nt">--context</span> kind-east
<span class="nv">$ </span>cilium config view <span class="nt">--context</span> kind-west
<span class="nv">$ </span>cilium config view <span class="nt">--context</span> kind-east
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status <span class="nt">--verbose</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status <span class="nt">--verbose</span>

<span class="nv">$ </span>kwest <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg bpf ipmasq list
<span class="c"># =&gt; IP PREFIX/ADDRESS</span>
<span class="c">#    169.254.0.0/16</span>
<span class="c">#    10.1.0.0/16</span>
<span class="nv">$ </span>keast <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg bpf ipmasq list
<span class="c"># =&gt; IP PREFIX/ADDRESS</span>
<span class="c">#    169.254.0.0/16</span>
<span class="c">#    10.0.0.0/16</span>

<span class="c"># coredns í™•ì¸ : ë‘˜ ë‹¤, cluster.local ê¸°ë³¸ ë„ë©”ì¸ ë„¤ì„ ì‚¬ìš© ì¤‘</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system coredns <span class="nt">--context</span> kind-west | <span class="nb">grep </span>kubernetes
<span class="c"># =&gt;     kubernetes cluster.local in-addr.arpa ip6.arpa {</span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system coredns <span class="nt">--context</span> kind-west | <span class="nb">grep </span>kubernetes
<span class="c"># =&gt;     kubernetes cluster.local in-addr.arpa ip6.arpa {</span>

<span class="c"># k9s ì‚¬ìš© ì‹œ</span>
<span class="nv">$ </span>k9s <span class="nt">--context</span> kind-west
<span class="nv">$ </span>k9s <span class="nt">--context</span> kind-east

<span class="c"># ì‚­ì œ ì‹œ</span>
<span class="c"># cilium uninstall --context kind-west</span>
<span class="c"># cilium uninstall --context kind-east</span>
</code></pre></div></div>

<h3 id="clustermesh-ë°°í¬">ClusterMesh ë°°í¬</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/clustermesh/clustermesh/">ê´€ë ¨ë¬¸ì„œ</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë¼ìš°íŒ… ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-control-plane ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.0.0.0/24 via 10.0.0.175 dev cilium_host proto kernel src 10.0.0.175</span>
<span class="c">#    10.0.0.175 dev cilium_host proto kernel scope link</span>
<span class="c">#    10.0.1.0/24 via 172.20.0.2 dev eth0 proto kernel</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.4</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-worker ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.0.0.0/24 via 172.20.0.4 dev eth0 proto kernel</span>
<span class="c">#    10.0.1.0/24 via 10.0.1.10 dev cilium_host proto kernel src 10.0.1.10</span>
<span class="c">#    10.0.1.10 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.2</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.1.0.0/24 via 10.1.0.80 dev cilium_host proto kernel src 10.1.0.80</span>
<span class="c">#    10.1.0.80 dev cilium_host proto kernel scope link</span>
<span class="c">#    10.1.1.0/24 via 172.20.0.3 dev eth0 proto kernel</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.5</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.1.0.0/24 via 172.20.0.5 dev eth0 proto kernel</span>
<span class="c">#    10.1.1.0/24 via 10.1.1.94 dev cilium_host proto kernel src 10.1.1.94</span>
<span class="c">#    10.1.1.94 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.3</span>

<span class="c"># Specify the Cluster Name and ID : ì´ë¯¸ ì„¤ì • ë˜ì–´ ìˆìŒ</span>

<span class="c"># Certificate Authorityë¥¼ ê³µìœ í•˜ê¸° ìœ„í•´ì„œ east í´ëŸ¬ìŠ¤í„°ì˜ cilium-ca ì‹œí¬ë¦¿ì„ ì‚­ì œí•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>keast get secret <span class="nt">-n</span> kube-system cilium-ca
<span class="nv">$ </span>keast delete secret <span class="nt">-n</span> kube-system cilium-ca

<span class="c"># west í´ëŸ¬ìŠ¤í„°ì˜ cilium-ca ì‹œí¬ë¦¿ì„ east í´ëŸ¬ìŠ¤í„°ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl <span class="nt">--context</span> kind-west get secret <span class="nt">-n</span> kube-system cilium-ca <span class="nt">-o</span> yaml | <span class="se">\</span>
  kubectl <span class="nt">--context</span> kind-east create <span class="nt">-f</span> -
  <span class="c"># =&gt; secret/cilium-ca created</span>

<span class="nv">$ </span>keast get secret <span class="nt">-n</span> kube-system cilium-ca
<span class="c"># =&gt; NAME        TYPE     DATA   AGE</span>
<span class="c">#    cilium-ca   Opaque   2      12s</span>

<span class="c"># ëª¨ë‹ˆí„°ë§ : ì‹ ê·œ í„°ë¯¸ë„ 2ê°œ</span>
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-west <span class="nt">--wait</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    âš ï¸  Service type NodePort detected! Service may fail when nodes are removed from the cluster!</span>
<span class="c">#    âœ… Service "clustermesh-apiserver" of type "NodePort" found</span>
<span class="c">#    âœ… Cluster access information is available:</span>
<span class="c">#      - 172.20.0.4:32379</span>
<span class="c">#    âœ… Deployment clustermesh-apiserver is ready</span>
<span class="c">#    â„¹ï¸  KVStoreMesh is disabled</span>
<span class="c">#    </span>
<span class="c">#    </span>
<span class="c">#    ğŸ”Œ No cluster connected</span>
<span class="c">#    </span>
<span class="c">#    ğŸ”€ Global services: [ min:0 / avg:0.0 / max:0 ]  </span>
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-east <span class="nt">--wait</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    âš ï¸  Service type NodePort detected! Service may fail when nodes are removed from the cluster!</span>
<span class="c">#    âœ… Service "clustermesh-apiserver" of type "NodePort" found</span>
<span class="c">#    âœ… Cluster access information is available:</span>
<span class="c">#      - 172.20.0.5:32379</span>
<span class="c">#    âœ… Deployment clustermesh-apiserver is ready</span>
<span class="c">#    â„¹ï¸  KVStoreMesh is disabled</span>
<span class="c">#    </span>
<span class="c">#    </span>
<span class="c">#    ğŸ”Œ No cluster connected</span>
<span class="c">#    </span>
<span class="c">#    ğŸ”€ Global services: [ min:0 / avg:0.0 / max:0 ]</span>


<span class="c"># Enable Cluster Mesh : ê°„ë‹¨í•œ ì‹¤ìŠµ í™˜ê²½ìœ¼ë¡œ NodePort ë¡œ ì§„í–‰</span>
<span class="nv">$ </span>cilium clustermesh <span class="nb">enable</span> <span class="nt">--service-type</span> NodePort <span class="nt">--enable-kvstoremesh</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--context</span> kind-west
<span class="c"># =&gt; âš ï¸  Using service type NodePort may fail when nodes are removed from the cluster!</span>
<span class="nv">$ </span>cilium clustermesh <span class="nb">enable</span> <span class="nt">--service-type</span> NodePort <span class="nt">--enable-kvstoremesh</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--context</span> kind-east
<span class="c"># =&gt; âš ï¸  Using service type NodePort may fail when nodes are removed from the cluster! </span>

<span class="c"># 32379 NodePort ì •ë³´ : clustermesh-apiserver ì„œë¹„ìŠ¤ ì •ë³´</span>
<span class="nv">$ </span>kwest get svc,ep <span class="nt">-n</span> kube-system clustermesh-apiserver <span class="nt">--context</span> kind-west
<span class="c"># =&gt; NAME                            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/clustermesh-apiserver   NodePort   10.2.173.178   &lt;none&gt;        2379:32379/TCP   2m55s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              ENDPOINTS         AGE</span>
<span class="c">#    endpoints/clustermesh-apiserver   10.0.1.223:2379   2m55s       # ëŒ€ìƒ íŒŒë“œëŠ” clustermesh-apiserver íŒŒë“œ IP</span>

<span class="nv">$ </span>kwest get pod <span class="nt">-n</span> kube-system <span class="nt">-owide</span> | <span class="nb">grep </span>clustermesh
<span class="c"># =&gt; clustermesh-apiserver-5cf45db9cc-r26tw       2/2     Running     0          3m21s   10.0.1.223   west-worker          &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    clustermesh-apiserver-generate-certs-788q6   0/1     Completed   0          3m21s   172.20.0.2   west-worker          &lt;none&gt;           &lt;none&gt;</span>

<span class="nv">$ </span>keast get svc,ep <span class="nt">-n</span> kube-system clustermesh-apiserver <span class="nt">--context</span> kind-east
<span class="c"># =&gt; NAME                            TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/clustermesh-apiserver   NodePort   10.3.201.32   &lt;none&gt;        2379:32379/TCP   2m40s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              ENDPOINTS         AGE</span>
<span class="c">#    endpoints/clustermesh-apiserver   10.1.1.225:2379   2m40s       # ëŒ€ìƒ íŒŒë“œëŠ” clustermesh-apiserver íŒŒë“œ IP</span>

<span class="nv">$ </span>keast get pod <span class="nt">-n</span> kube-system <span class="nt">-owide</span> | <span class="nb">grep </span>clustermesh
<span class="c"># =&gt; clustermesh-apiserver-5cf45db9cc-r4wgj       2/2     Running     0          2m56s   10.1.1.225   east-worker          &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    clustermesh-apiserver-generate-certs-89vnn   0/1     Completed   0          2m56s   172.20.0.3   east-worker          &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># ëª¨ë‹ˆí„°ë§ : ì‹ ê·œ í„°ë¯¸ë„ 2ê°œ</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"cilium clustermesh status --context kind-west --wait"</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"cilium clustermesh status --context kind-east --wait"</span>

<span class="c"># Connect Clusters</span>
<span class="nv">$ </span>cilium clustermesh connect <span class="nt">--context</span> kind-west <span class="nt">--destination-context</span> kind-east
<span class="c"># =&gt; âœ¨ Extracting access information of cluster west...</span>
<span class="c">#    ğŸ”‘ Extracting secrets from cluster west...</span>
<span class="c">#    âš ï¸  Service type NodePort detected! Service may fail when nodes are removed from the cluster!</span>
<span class="c">#    â„¹ï¸  Found ClusterMesh service IPs: [172.20.0.4]</span>
<span class="c">#    âœ¨ Extracting access information of cluster east...</span>
<span class="c">#    ğŸ”‘ Extracting secrets from cluster east...</span>
<span class="c">#    âš ï¸  Service type NodePort detected! Service may fail when nodes are removed from the cluster!</span>
<span class="c">#    â„¹ï¸  Found ClusterMesh service IPs: [172.20.0.5]</span>
<span class="c">#    â„¹ï¸ Configuring Cilium in cluster kind-west to connect to cluster kind-east</span>
<span class="c">#    â„¹ï¸ Configuring Cilium in cluster kind-east to connect to cluster kind-west</span>
<span class="c">#    âœ… Connected cluster kind-west &lt;=&gt; kind-east!</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-west <span class="nt">--wait</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    âœ… All 2 nodes are connected to all clusters [min:1 / avg:1.0 / max:1]</span>
<span class="c">#    </span>
<span class="c">#    ğŸ”Œ Cluster Connections:</span>
<span class="c">#      - east: 2/2 configured, 2/2 connected</span>
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-east <span class="nt">--wait</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    âœ… All 2 nodes are connected to all clusters [min:1 / avg:1.0 / max:1]</span>
<span class="c">#    </span>
<span class="c">#    ğŸ”Œ Cluster Connections:</span>
<span class="c">#      - west: 2/2 configured, 2/2 connected</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ClusterMesh ì—°ê²°ì´ ì˜ ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># </span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--context</span> kind-west <span class="nt">--</span> cilium-dbg troubleshoot clustermesh
<span class="c"># =&gt; ...</span>
<span class="c">#    Cluster "east":</span>
<span class="c">#    ğŸ“„ Configuration path: /var/lib/cilium/clustermesh/east</span>
<span class="c">#    </span>
<span class="c">#    ğŸ”Œ Endpoints:</span>
<span class="c">#       - https://east.mesh.cilium.io:32379</span>
<span class="c">#         âœ… Hostname resolved to: 172.20.0.5</span>
<span class="c">#         âœ… TCP connection successfully established to 172.20.0.5:32379</span>
<span class="c">#         âœ… TLS connection successfully established to 172.20.0.5:32379</span>
<span class="c">#    ...</span>
<span class="c">#    ğŸ”‘ Digital certificates:</span>
<span class="c">#       âœ… TLS Root CA certificates:</span>
<span class="c">#          - Serial number:       &lt;span style="color: green;"&gt;84:08:1a:87:5e:23:5b:d9:0b:ca:62:3a:46:9b:13:9&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c">#       âœ… TLS client certificates:</span>
<span class="c">#          - Serial number:       65:79:dd:0b:b6:6d:92:6a:59:ce:40:d2:7b:dc:0c:67:ef:c9:96:06</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--context</span> kind-east <span class="nt">--</span> cilium-dbg troubleshoot clustermesh
<span class="c"># =&gt; ...</span>
<span class="c">#    Cluster "west":</span>
<span class="c">#    ğŸ“„ Configuration path: /var/lib/cilium/clustermesh/west</span>
<span class="c">#    </span>
<span class="c">#    ğŸ”Œ Endpoints:</span>
<span class="c">#       - https://west.mesh.cilium.io:32379</span>
<span class="c">#         âœ… Hostname resolved to: 172.20.0.4</span>
<span class="c">#         âœ… TCP connection successfully established to 172.20.0.4:32379</span>
<span class="c">#         âœ… TLS connection successfully established to 172.20.0.4:32379</span>
<span class="c">#    ...</span>
<span class="c">#    ğŸ”‘ Digital certificates:</span>
<span class="c">#       âœ… TLS Root CA certificates:</span>
<span class="c">#          - Serial number:       &lt;span style="color: green;"&gt;84:08:1a:87:5e:23:5b:d9:0b:ca:62:3a:46:9b:13:9&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c">#       âœ… TLS client certificates:</span>
<span class="c">#          - Serial number:       29:14:65:5d:5d:ff:bf:80:24:ba:16:88:a4:55:d3:e0:ba:a3:9d:14</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì„œë¡œ ë‹¤ë¥¸ í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•´ì„œ êµ¬ì„±ì„ ê°–ê³  ìˆê³ , ì•ì„œ Cilium CAë¥¼ ë³µì‚¬í–ˆê¸° ë•Œë¬¸ì—, ê°™ì€ Root CAë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kwest get pod <span class="nt">-A</span> <span class="o">&amp;&amp;</span> keast get pod <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                         READY   STATUS      RESTARTS   AGE</span>
<span class="c">#    ...</span>
<span class="c">#    kube-system          clustermesh-apiserver-5cf45db9cc-r26tw       2/2     Running     0          12m</span>
<span class="c">#    kube-system          clustermesh-apiserver-generate-certs-2xlxh   0/1     Completed   0          8m4s</span>
<span class="c">#    ...</span>
<span class="c">#    NAMESPACE            NAME                                         READY   STATUS      RESTARTS   AGE</span>
<span class="c">#    ...</span>
<span class="c">#    kube-system          clustermesh-apiserver-5cf45db9cc-r4wgj       2/2     Running     0          11m</span>
<span class="c">#    kube-system          clustermesh-apiserver-generate-certs-fr5cz   0/1     Completed   0          7m58s</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>cilium status <span class="nt">--context</span> kind-west
<span class="nv">$ </span>cilium status <span class="nt">--context</span> kind-east
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-west
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-east
<span class="nv">$ </span>cilium config view <span class="nt">--context</span> kind-west
<span class="nv">$ </span>cilium config view <span class="nt">--context</span> kind-east
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status <span class="nt">--verbose</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status <span class="nt">--verbose</span>
<span class="c"># =&gt; ClusterMesh:   1/1 remote clusters ready, 0 global-services</span>
<span class="c">#       west: ready, 2 nodes, 4 endpoints, 3 identities, 0 services, 0 MCS-API service exports, 0 reconnections (last: never)</span>
<span class="c">#       â””  etcd: 1/1 connected, leases=0, lock leases=0, has-quorum=true: endpoint status checks are disabled, ID: ea025158a8e3c0a3</span>
<span class="c">#       â””  remote configuration: expected=true, retrieved=true, cluster-id=1, kvstoremesh=false, sync-canaries=true, service-exports=disabled</span>
<span class="c">#       â””  synchronization status: nodes=true, endpoints=true, identities=true, services=true</span>

<span class="c">#</span>
<span class="nv">$ </span>helm get values <span class="nt">-n</span> kube-system cilium <span class="nt">--kube-context</span> kind-west 
<span class="c"># =&gt; ...</span>
<span class="c">#    cluster:</span>
<span class="c">#      id: 1</span>
<span class="c">#      name: west</span>
<span class="c">#    clustermesh:</span>
<span class="c">#      apiserver:</span>
<span class="c">#        kvstoremesh:</span>
<span class="c">#          enabled: false</span>
<span class="c">#        service:</span>
<span class="c">#          type: NodePort</span>
<span class="c">#        tls:</span>
<span class="c">#          auto:</span>
<span class="c">#            enabled: true</span>
<span class="c">#            method: cronJob</span>
<span class="c">#            schedule: 0 0 1 */4 *</span>
<span class="c">#      config:</span>
<span class="c">#        clusters:</span>
<span class="c">#        - ips:</span>
<span class="c">#          - 172.20.0.5</span>
<span class="c">#          name: east</span>
<span class="c">#          port: 32379</span>
<span class="c">#        enabled: true</span>
<span class="c">#      useAPIServer: true</span>

<span class="nv">$ </span>helm get values <span class="nt">-n</span> kube-system cilium <span class="nt">--kube-context</span> kind-east 
<span class="c"># =&gt; ...</span>
<span class="c">#    cluster:</span>
<span class="c">#      id: 2</span>
<span class="c">#      name: east</span>
<span class="c">#    clustermesh:</span>
<span class="c">#      apiserver:</span>
<span class="c">#        kvstoremesh:</span>
<span class="c">#          enabled: false</span>
<span class="c">#        service:</span>
<span class="c">#          type: NodePort</span>
<span class="c">#        tls:</span>
<span class="c">#          auto:</span>
<span class="c">#            enabled: true</span>
<span class="c">#            method: cronJob</span>
<span class="c">#            schedule: 0 0 1 */4 *</span>
<span class="c">#      config:</span>
<span class="c">#        clusters:</span>
<span class="c">#        - ips:</span>
<span class="c">#          - 172.20.0.4</span>
<span class="c">#          name: west</span>
<span class="c">#          port: 32379</span>
<span class="c">#        enabled: true</span>
<span class="c">#      useAPIServer: true</span>

<span class="c"># ë¼ìš°íŒ… ì •ë³´ í™•ì¸ : í´ëŸ¬ìŠ¤í„°ê°„ PodCIDR ë¼ìš°íŒ… ì£¼ì… í™•ì¸!</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-control-plane ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.0.0.0/24 via 10.0.0.175 dev cilium_host proto kernel src 10.0.0.175</span>
<span class="c">#    10.0.0.175 dev cilium_host proto kernel scope link</span>
<span class="c">#    10.0.1.0/24 via 172.20.0.2 dev eth0 proto kernel</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.1.0.0/24 via 172.20.0.5 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.1.1.0/24 via 172.20.0.3 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.4</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-worker ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.0.0.0/24 via 172.20.0.4 dev eth0 proto kernel</span>
<span class="c">#    10.0.1.0/24 via 10.0.1.10 dev cilium_host proto kernel src 10.0.1.10</span>
<span class="c">#    10.0.1.10 dev cilium_host proto kernel scope link</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.1.0.0/24 via 172.20.0.5 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.1.1.0/24 via 172.20.0.3 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.2</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.0.0.0/24 via 172.20.0.4 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.0.1.0/24 via 172.20.0.2 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    10.1.0.0/24 via 10.1.0.80 dev cilium_host proto kernel src 10.1.0.80</span>
<span class="c">#    10.1.0.80 dev cilium_host proto kernel scope link</span>
<span class="c">#    10.1.1.0/24 via 172.20.0.3 dev eth0 proto kernel</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.5</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.0.0.0/24 via 172.20.0.4 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.0.1.0/24 via 172.20.0.2 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    10.1.0.0/24 via 172.20.0.5 dev eth0 proto kernel</span>
<span class="c">#    10.1.1.0/24 via 10.1.1.94 dev cilium_host proto kernel src 10.1.1.94</span>
<span class="c">#    10.1.1.94 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.3</span>
</code></pre></div></div>

<ul>
  <li>Hubble enable</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium helm repo ë“±ë¡</span>
<span class="nv">$ </span>helm repo add cilium https://helm.cilium.io/
<span class="nv">$ </span>helm repo update

<span class="c"># ì„¤ì •</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.17.6 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>30001 <span class="nt">--kube-context</span> kind-west
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    NAME: cilium</span>
<span class="c">#    LAST DEPLOYED: Sat Aug 16 21:31:07 2025</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 4</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    You have successfully installed Cilium with Hubble Relay and Hubble UI.</span>
<span class="c">#    </span>
<span class="c">#    Your release version is 1.17.6.  </span>
<span class="nv">$ </span>kwest <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c">## í˜¹ì€ cilium hubble enable --ui --relay --context kind-west</span>
<span class="c">## kubectl --context kind-west patch svc -n kube-system hubble-ui -p '{"spec": {"type": "NodePort", "ports": [{"port": 80, "targetPort": 8081, "nodePort": 30001}]}}'</span>

<span class="c"># ì„¤ì •</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.17.6 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>31001 <span class="nt">--kube-context</span> kind-east
<span class="nv">$ </span>kwest <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c">## í˜¹ì€ cilium hubble enable --ui --relay --context kind-east</span>
<span class="c">## kubectl --context kind-east patch svc -n kube-system hubble-ui -p '{"spec": {"type": "NodePort", "ports": [{"port": 80, "targetPort": 8081, "nodePort": 31001}]}}'</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kwest get svc,ep <span class="nt">-n</span> kube-system hubble-ui <span class="nt">--context</span> kind-west
<span class="c"># =&gt; NAME                TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/hubble-ui   NodePort   10.2.253.104   &lt;none&gt;        80:30001/TCP   51s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS         AGE</span>
<span class="c">#    endpoints/hubble-ui   10.0.1.192:8081   51s</span>
<span class="nv">$ </span>keast get svc,ep <span class="nt">-n</span> kube-system hubble-ui <span class="nt">--context</span> kind-east
<span class="c"># =&gt; NAME                TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/hubble-ui   NodePort   10.3.93.132   &lt;none&gt;        80:31001/TCP   26s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS   AGE</span>
<span class="c">#    endpoints/hubble-ui   &lt;none&gt;      25s</span>

<span class="c"># hubble-ui ì ‘ì† ì‹œ</span>
<span class="nv">$ </span>open http://localhost:30001
<span class="nv">$ </span>open http://localhost:31001
</code></pre></div></div>

<h3 id="west-íŒŒë“œ---east-íŒŒë“œ-ê°„-ì§ì ‘-í†µì‹ -í™•ì¸-with-static-routing">west íŒŒë“œ &lt;-&gt; east íŒŒë“œ ê°„ ì§ì ‘ í†µì‹  í™•ì¸ with static routing</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply --context kind-west -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply --context kind-east -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kwest get pod <span class="nt">-A</span> <span class="o">&amp;&amp;</span> keast get pod <span class="nt">-A</span>
<span class="nv">$ </span>kwest get pod <span class="nt">-owide</span> <span class="o">&amp;&amp;</span> keast get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME       READY   STATUS    RESTARTS   AGE   IP           NODE          NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod   1/1     Running   0          20m   10.0.1.101   west-worker   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    NAME       READY   STATUS    RESTARTS   AGE   IP           NODE          NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod   1/1     Running   0          20m   10.1.1.146   east-worker   &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># west íŒŒë“œì—ì„œ east íŒŒë“œë¡œ ì§ì ‘ ë¼ìš°íŒ… í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> ping <span class="nt">-c</span> 1 10.1.1.146
<span class="c"># =&gt; 64 bytes from 10.1.1.146: icmp_seq=1 ttl=62 time=1.80 ms</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> ping 10.1.1.146

<span class="c"># ëª©ì ì§€ íŒŒë“œì—ì„œ tcpdump ë¡œ í™•ì¸ : NATÂ ì—†ì´ ì§ì ‘ ë¼ìš°íŒ….</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span>
<span class="c"># =&gt; 14:30:09.035714 IP 10.1.1.146 &gt; 10.0.1.101: ICMP echo request, id 15, seq 1, length 64</span>
<span class="c">#    14:30:09.036120 IP 10.0.1.101 &gt; 10.1.1.146: ICMP echo reply, id 15, seq 1, length 64</span>

<span class="c"># ëª©ì ì§€ k8s ë…¸ë“œ?ì—ì„œ icmp tcpdump ë¡œ í™•ì¸ : ë‹¤ë¥¸ê³³ ê²½ìœ í•˜ì§€ ì•Šê³  ì§ì ‘ ë…¸ë“œì—ì„œ íŒŒë“œë¡œ ì¸ì… í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>
<span class="c"># =&gt; (ìº¡ì³ëœ íŒ¨í‚· ì—†ìŒ)</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>
<span class="c"># =&gt; 14:30:09.035725 lxce19e07e06482 In  IP 10.1.1.146 &gt; 10.0.1.101: ICMP echo request, id 15, seq 1, length 64</span>
<span class="c">#    14:30:09.035904 eth0  Out IP 10.1.1.146 &gt; 10.0.1.101: ICMP echo request, id 15, seq 1, length 64</span>
<span class="c">#    14:30:09.036120 eth0  In  IP 10.0.1.101 &gt; 10.1.1.146: ICMP echo reply, id 15, seq 1, length 64</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ east-control-planeì—ëŠ” íŒ¨í‚· ìº¡ì³ê°€ ì—†ê³ , tcp dump ìƒì—ë„ east &lt;-&gt; west íŒŒë“œ IPê°„ì˜ ì§ì ‘ í†µì‹ ìœ¼ë¡œ&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ìº¡ì³ë˜ëŠ”ê²ƒìœ¼ë¡œ ë³´ì•„ ë‹¤ë¥¸ê³³ì„ ê²½ìœ í•˜ì§€ ì•Šê³  ì§ì ‘ íŒŒë“œë¡œ ì¸ì…ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> ping <span class="nt">-c</span> 1 10.0.1.101
<span class="c"># =&gt; 64 bytes from 10.0.1.101: icmp_seq=1 ttl=62 time=0.291 ms</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_6.png" alt="img.png" class="image-center" /></p>

<h3 id="load-balancing--service-discovery">Load-Balancing &amp; Service Discovery</h3>

<ul>
  <li>ClusterMeshë¥¼ í†µí•œ Load-Balacing ë° Service Discoveryë¥¼ ì‹¤ìŠµì„ í†µí•´ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li><a href="https://docs.cilium.io/en/stable/network/clustermesh/services/">ê´€ë ¨ë¬¸ì„œ</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply --context kind-west -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
  annotations:
    service.cilium.io/global: "true"
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply --context kind-east -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
  annotations:
    service.cilium.io/global: "true"
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kwest get svc,ep webpod <span class="o">&amp;&amp;</span> keast get svc,ep webpod
<span class="c"># =&gt; NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/webpod   ClusterIP   10.2.184.162   &lt;none&gt;        80/TCP    43s</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                   AGE</span>
<span class="c">#    endpoints/webpod   10.0.1.70:80,10.0.1.77:80   43s</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/webpod   ClusterIP   10.3.136.103   &lt;none&gt;        80/TCP    8s</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS       AGE</span>
<span class="c">#    endpoints/webpod   10.1.1.217:80   8s</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.70:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.0.1.77:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                4 =&gt; 10.1.1.207:80/TCP (active) </span>
                                            
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.0.1.77:80/TCP (active)</span>
<span class="c">#                                               2 =&gt; 10.0.1.70:80/TCP (active)</span>
<span class="c">#                                               3 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                               4 =&gt; 10.1.1.207:80/TCP (active)</span>
 
<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> ping <span class="nt">-c</span> 1 10.1.1.146
<span class="c"># =&gt; 64 bytes from 10.1.1.146: icmp_seq=1 ttl=62 time=1.35 ms</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> ping <span class="nt">-c</span> 1 10.0.1.101
<span class="c"># =&gt; 64 bytes from 10.0.1.101: icmp_seq=1 ttl=62 time=0.889 ms</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="c"># =&gt; ---</span>
<span class="c">#    Hostname: webpod-697b545f57-twg87</span>
<span class="c">#    IP: 10.0.1.77</span>
<span class="c">#    RemoteAddr: 10.0.1.101:36858</span>
<span class="c">#    ...</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-9ndvj</span>
<span class="c">#    IP: 10.0.1.70</span>
<span class="c">#    RemoteAddr: 10.0.1.101:58324</span>
<span class="c">#    ...</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-9ndvj</span>
<span class="c">#    IP: 10.0.1.70</span>
<span class="c">#    RemoteAddr: 10.0.1.101:58354</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-k6wdn</span>
<span class="c">#    IP: 10.1.1.217</span>
<span class="c">#    RemoteAddr: 10.0.1.101:56788</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-k6wdn</span>
<span class="c">#    IP: 10.1.1.217</span>
<span class="c">#    RemoteAddr: 10.1.1.146:41276</span>
<span class="c">#    ...</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-9ndvj</span>
<span class="c">#    IP: 10.0.1.70</span>
<span class="c">#    RemoteAddr: 10.1.1.146:56488</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-924nf</span>
<span class="c">#    IP: 10.1.1.207</span>
<span class="c">#    RemoteAddr: 10.1.1.146:34020</span>
<span class="c">#    ...</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-twg87</span>
<span class="c">#    IP: 10.0.1.77</span>
<span class="c">#    RemoteAddr: 10.1.1.146:44744</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ curl-podì˜ í´ëŸ¬ìŠ¤í„°ì™€ ê´€ê³„ ì—†ì´ westì™€ eastì˜ webpodê°€ ê³¨ê³ ë£¨ ì‚¬ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># í˜„ì¬ Service Annotations ì„¤ì •</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A1</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>

<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A1</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>

<span class="c"># ëª¨ë‹ˆí„°ë§ : ë°˜ë³µ ì ‘ì†í•´ë‘ê¸°</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>

<span class="c">#</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 1
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.77:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.0.1.77:80/TCP (active)</span>
<span class="c">#                                               2 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                               3 =&gt; 10.1.1.207:80/TCP (active)</span>

<span class="c"># ë¡œì»¬ k8s ì— ëª©ì ì§€ê°€ ì—†ì„ ê²½ìš° ì–´ë–»ê²Œ ë˜ë‚˜ìš”?</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 0
<span class="c"># =&gt; deployment.apps/webpod scaled</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ westì— webpodê°€ ì—†ìœ¼ë¯€ë¡œ, eastì˜ webpodë¡œë§Œ ì ‘ì†ì´ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>

<span class="c">#</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 2
<span class="c"># =&gt; deployment.apps/webpod scaled</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; &lt;span style="color: green;"&gt;10.0.1.210:80/TCP&lt;/span&gt; (active)</span>
<span class="c">#                                                4 =&gt; &lt;span style="color: green;"&gt;10.0.1.140:80/TCP&lt;/span&gt; (active)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ westì˜ webpodê°€ ë³µêµ¬ë˜ë©´ Service Discoveryê°€ ë˜ë©´ì„œ, westì˜ webpodë¡œë„ ì ‘ì†ì´ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>

<span class="c"># tcpdump í™•ì¸ : dataplane flow í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-control-plane tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span> 
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-worker tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span> 
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_8.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>westì™€ eastì˜ ê° í´ëŸ¬ìŠ¤í„°ì— webpodê°€ ìˆìŒì—ë„ í´ëŸ¬ìŠ¤í„° ìì‹ ì˜ webpod ë¿ë§Œ ì•„ë‹ˆë¼ ìƒëŒ€ë°©ì˜ webpodë¡œë„ ì ‘ì†ì´ ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ëŠ” ì‹œìŠ¤í…œ ì•ˆì •ì„± ë©´ì—ì„œëŠ” ì¢‹ì„ì§€ ëª°ë¼ë„, ì˜¤ë²„í—¤ë“œë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒì˜ Service Affinity ì„¤ì •ì„ í†µí•´ ì´ë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="service-affinity">Service Affinity</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/clustermesh/affinity/">ê´€ë ¨ ë¬¸ì„œ</a>
<img src="/assets/2025/cilium/w5/20250817_cilium_w5_9.svg" alt="20250817_cilium_w5_9.svg" class="image-center w-100p" /></li>
</ul>

<h5 id="serviceciliumioaffinitylocal">service.cilium.io/affinity=local</h5>

<ul>
  <li><code class="language-plaintext highlighter-rouge">service.cilium.io/affinity=local</code> ì„¤ì •ì„ í†µí•´, ê° í´ëŸ¬ìŠ¤í„°ì˜ íŒŒë“œê°€ ìê¸°ìì‹ ì˜ í´ëŸ¬ìŠ¤í„°ì˜ íŒŒë“œë¥¼ ìš°ì„ í•˜ì—¬ ì ‘ì†í•˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§ : ë°˜ë³µ ì ‘ì†í•´ë‘ê¸°</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>

<span class="c"># í˜„ì¬ Service Annotations ì„¤ì •</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A1</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A1</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>

<span class="c"># Session Affinity Local ì„¤ì •</span>
<span class="nv">$ </span>kwest annotate service webpod service.cilium.io/affinity<span class="o">=</span><span class="nb">local</span> <span class="nt">--overwrite</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: local</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>

<span class="nv">$ </span>keast annotate service webpod service.cilium.io/affinity<span class="o">=</span><span class="nb">local</span> <span class="nt">--overwrite</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: local</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; 13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; 10.0.1.210:80/TCP (active) &lt;span style="color: green;"&gt;(preferred)&lt;/span&gt;</span>
<span class="c">#                                                4 =&gt; 10.0.1.140:80/TCP (active) &lt;span style="color: green;"&gt;(preferred)&lt;/span&gt;</span>

<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; 13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active) &lt;span style="color: green;"&gt;(preferred)&lt;/span&gt;</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active) &lt;span style="color: green;"&gt;(preferred)&lt;/span&gt;</span>
<span class="c">#                                               3 =&gt; 10.0.1.210:80/TCP (active)</span>
<span class="c">#                                               4 =&gt; 10.0.1.140:80/TCP (active) </span>

<span class="c"># í˜¸ì¶œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-mm9g7</span>
<span class="c">#    IP: 10.0.1.210</span>
<span class="c">#    RemoteAddr: 10.0.1.101:52556</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-rspmq</span>
<span class="c">#    IP: 10.0.1.140</span>
<span class="c">#    RemoteAddr: 10.0.1.101:59782</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-rspmq</span>
<span class="c">#    IP: 10.0.1.140</span>
<span class="c">#    RemoteAddr: 10.0.1.101:59782</span>
<span class="c">#    ...    </span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-924nf</span>
<span class="c">#    IP: 10.1.1.207</span>
<span class="c">#    RemoteAddr: 10.1.1.146:42244</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-k6wdn</span>
<span class="c">#    IP: 10.1.1.217</span>
<span class="c">#    RemoteAddr: 10.1.1.146:49716</span>
<span class="c">#    ...    </span>
<span class="c">#    ---    </span>
<span class="c">#    Hostname: webpod-697b545f57-924nf</span>
<span class="c">#    IP: 10.1.1.207</span>
<span class="c">#    RemoteAddr: 10.1.1.146:42244</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-k6wdn</span>
<span class="c">#    IP: 10.1.1.217</span>
<span class="c">#    RemoteAddr: 10.1.1.146:49716</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ Service Affinity ì„¤ì • í›„ ê° í´ëŸ¬ìŠ¤í„°ëŠ” ìê¸°ìì‹ ì˜ í´ëŸ¬ìŠ¤í„°ì˜ webpodë¥¼ í†µí•´ í†µì‹ ì´ ì§„í–‰ë©ë‹ˆë‹¤.&lt;/span&gt;    </span>

<span class="c"># í˜„ì¬ ìƒíƒœì—ì„œ replicas ë³€ê²½ í›„ í™•ì¸ : preferred ë™ì‘ ì´í•´í•˜ê¸°!</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 0
<span class="c"># =&gt; deployment.apps/webpod scaled</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; 13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="c"># =&gt; ---</span>
<span class="c">#    Hostname: webpod-697b545f57-k6wdn</span>
<span class="c">#    IP: 10.1.1.217</span>
<span class="c">#    RemoteAddr: 10.0.1.101:47912</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-924nf</span>
<span class="c">#    IP: 10.1.1.207</span>
<span class="c">#    RemoteAddr: 10.0.1.101:58092</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ west í´ëŸ¬ìŠ¤í„°ì—ëŠ” webpodê°€ ì—†ì§€ë§Œ, east í´ëŸ¬ìŠ¤í„°ì˜ webpodë¡œ ì ‘ì†ì´ ì§„í–‰ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ì´ëŠ” preferred ì„¤ì •ìœ¼ë¡œ, west í´ëŸ¬ìŠ¤í„°ì˜ webpodë¥¼ ì„ í˜¸í•˜ì§€ë§Œ ì—†ì„ ê²½ìš° east í´ëŸ¬ìŠ¤í„°ì˜ webpodë¡œ ì ‘ì†ì´ ì§„í–‰ë©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë‹¤ì‹œ ê¸°ë³¸ ì„¤ì •ê°’ ì ìš©</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 2

<span class="c"># tcpdump í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-control-plane tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span> 
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-worker tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span> 
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_10.png" alt="img.png" class="image-center" />
<em class="image-caption">ê° í´ëŸ¬ìŠ¤í„°ì˜ webpodë¡œ ì ‘ì†ì´ ì§„í–‰ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</em></p>

<h5 id="serviceciliumioaffinityremote">service.cilium.io/affinity=remote</h5>

<ul>
  <li><code class="language-plaintext highlighter-rouge">service.cilium.io/affinity=remote</code>ë¡œ ì„¤ì •ì‹œ ìê¸° ìì‹ ì˜ í´ëŸ¬ìŠ¤í„°ê°€ ì•„ë‹Œ ë‹¤ë¥¸ ì›ê²©(remote) í´ëŸ¬ìŠ¤í„°ì˜ íŒŒë“œë¥¼ ìš°ì„  ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í˜„ì¬ ì„¤ì • ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.94:80/TCP (active) (preferred)</span>
<span class="c">#                                                2 =&gt; 10.0.1.172:80/TCP (active) (preferred)</span>
<span class="c">#                                                3 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                                4 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active) (preferred)</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active) (preferred)</span>
<span class="c">#                                               3 =&gt; 10.0.1.172:80/TCP (active)</span>
<span class="c">#                                               4 =&gt; 10.0.1.94:80/TCP (active)</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: local</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: local</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>

<span class="c"># remote</span>
<span class="nv">$ </span>kwest annotate service webpod service.cilium.io/affinity<span class="o">=</span>remote <span class="nt">--overwrite</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>keast annotate service webpod service.cilium.io/affinity<span class="o">=</span>remote <span class="nt">--overwrite</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: remote</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: remote</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.94:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.0.1.172:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; 10.1.1.207:80/TCP (active) (preferred)</span>
<span class="c">#                                                4 =&gt; 10.1.1.217:80/TCP (active) (preferred)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                               3 =&gt; 10.0.1.172:80/TCP (active) (preferred)</span>
<span class="c">#                                               4 =&gt; 10.0.1.94:80/TCP (active) (preferred)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ affinityë¥¼ remoteë¡œ í•˜ë©´ ë‹¤ë¥¸ í´ëŸ¬ìŠ¤í„°ì˜ podë¥¼ ìš°ì„  ì‚¬ìš©í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># í˜¸ì¶œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>

<span class="c">#</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 0
<span class="c"># =&gt; deployment.apps/webpod scaled</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.1.1.207:80/TCP (active) (preferred)</span>
<span class="c">#                                                2 =&gt; 10.1.1.217:80/TCP (active) (preferred)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ westì˜ webpodë¥¼ ë‹¤ ë‚´ë¦¬ë©´, eastì—ì„œë„ eastì˜ webpodë¡œë§Œ ì ‘ì†ì´ ì§„í–‰ë©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë‹¤ì‹œ ì„¤ì • ì›ë³µ</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 2
</code></pre></div></div>

<h5 id="serviceciliumioshared">service.cilium.io/shared</h5>

<ul>
  <li><code class="language-plaintext highlighter-rouge">service.cilium.io/shared=false</code>ë¡œ í•˜ë©´ í•´ë‹¹ í´ëŸ¬ìŠ¤í„°ì˜ webpodëŠ” ë‹¤ë¥¸ ClusterMesh í´ëŸ¬ìŠ¤í„°ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.</li>
  <li>ì¦‰, west í´ëŸ¬ìŠ¤í„°ì— <code class="language-plaintext highlighter-rouge">shared=false</code>ë¡œ ì„¤ì •í•˜ë©´, east í´ëŸ¬ìŠ¤í„°ì—ì„œëŠ” west í´ëŸ¬ìŠ¤í„°ì˜ webpodì— ì ‘ê·¼í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í˜„ì¬ ì„¤ì • ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>

<span class="c"># localë¡œ ë‹¤ì‹œ ë³€ê²½</span>
<span class="nv">$ </span>kwest annotate service webpod service.cilium.io/affinity<span class="o">=</span><span class="nb">local</span> <span class="nt">--overwrite</span>
<span class="nv">$ </span>keast annotate service webpod service.cilium.io/affinity<span class="o">=</span><span class="nb">local</span> <span class="nt">--overwrite</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>

<span class="c"># shared=false : ì ìš© ì‹œ, ë‹¤ë¥¸ k8s í´ëŸ¬ìŠ¤í„°ê°€ ì˜í–¥ì„ ë°›ëŠ”ë‹¤!</span>
<span class="nv">$ </span>kwest annotate service webpod service.cilium.io/shared<span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: local</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#                              &lt;span style="color: green;"&gt;service.cilium.io/shared: false&lt;/span&gt;</span>
<span class="c">#    Selector:                 app=webpod</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.171:80/TCP (active) (preferred)</span>
<span class="c">#                                                2 =&gt; 10.0.1.92:80/TCP (active) (preferred)</span>
<span class="c">#                                                3 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                                4 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active) (preferred)</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active) (preferred)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ east í´ëŸ¬ìŠ¤í„°ì—ì„œëŠ” west í´ëŸ¬ìŠ¤í„°ì˜ webpodë¥¼ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>

<span class="c"># í˜¸ì¶œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>

<span class="c"># ë‹¤ì‹œ ì„¤ì • ì›ë³µ</span>
<span class="nv">$ </span>kwest annotate service webpod service.cilium.io/shared<span class="o">=</span><span class="nb">true</span> <span class="nt">--overwrite</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; ...</span>
<span class="c">#                              service.cilium.io/shared: &lt;span style="color: green;"&gt;true&lt;/span&gt;</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; ...</span>
<span class="c">#                              service.cilium.io/shared: &lt;span style="color: green;"&gt;true&lt;/span&gt;</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.171:80/TCP (active) (preferred)</span>
<span class="c">#                                                2 =&gt; 10.0.1.92:80/TCP (active) (preferred)</span>
<span class="c">#                                                3 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                                4 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active) (preferred)</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active) (preferred)</span>
<span class="c">#                                               3 =&gt; 10.0.1.171:80/TCP (active)</span>
<span class="c">#                                               4 =&gt; 10.0.1.92:80/TCP (active)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë‹¤ì‹œ shared=trueë¡œ ì„¤ì •í•˜ë©´, east í´ëŸ¬ìŠ¤í„°ì—ì„œë„ west í´ëŸ¬ìŠ¤í„°ì˜ webpodë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="clustermesh-apiserver-íŒŒë“œ-ì •ë³´-í™•ì¸">clustermesh-apiserver íŒŒë“œ ì •ë³´ í™•ì¸</h3>
<ul>
  <li>krew pexec í”ŒëŸ¬ê·¸ì¸ í™œìš© - <a href="https://github.com/ssup2/kpexec">Github</a></li>
  <li><a href="https://docs.cilium.io/en/stable/operations/troubleshooting/#state-propagation">ê´€ë ¨ë¬¸ì„œ</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium node list 
<span class="c"># =&gt; Name                      IPv4 Address   Endpoint CIDR   IPv6 Address   Endpoint CIDR   Source</span>
<span class="c">#    east/east-control-plane   172.20.0.5     10.1.0.0/24                                    clustermesh</span>
<span class="c">#    east/east-worker          172.20.0.3     10.1.1.0/24                                    clustermesh</span>
<span class="c">#    west/west-control-plane   172.20.0.4     10.0.0.0/24                                    local</span>
<span class="c">#    west/west-worker          172.20.0.2     10.0.1.0/24                                    custom-resource</span>

<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium node list            
<span class="c"># =&gt; Name                      IPv4 Address   Endpoint CIDR   IPv6 Address   Endpoint CIDR   Source</span>
<span class="c">#    east/east-control-plane   172.20.0.5     10.1.0.0/24                                    custom-resource</span>
<span class="c">#    east/east-worker          172.20.0.3     10.1.1.0/24                                    local</span>
<span class="c">#    west/west-control-plane   172.20.0.4     10.0.0.0/24                                    clustermesh</span>
<span class="c">#    west/west-worker          172.20.0.2     10.0.1.0/24                                    clustermesh</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium identity list
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium identity list

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium bpf ipcache list
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium bpf ipcache list
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium map get cilium_ipcache
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium map get cilium_ipcache


<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium bpf lb list                      
<span class="c"># =&gt; ...</span>
<span class="c">#    10.2.140.84:443/TCP (0)     0.0.0.0:0 (2) (0) [ClusterIP, InternalLocal, non-routable]</span>

<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium bpf lb list                      
<span class="c"># =&gt; ...</span>
<span class="c">#    10.3.70.57:443/TCP (0)     0.0.0.0:0 (2) (0) [ClusterIP, InternalLocal, non-routable]</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>clustermesh-apiserver
<span class="c"># =&gt; ...</span>
<span class="c">#    Containers:</span>
<span class="c">#      etcd:</span>
<span class="c">#        Container ID:  containerd://924c44c01307d2812baa1c15f53b008720f878fedb45c29b8ec35c641d71b0ae</span>
<span class="c">#        Image:         quay.io/cilium/clustermesh-apiserver:v1.17.6@sha256:f619e97432db427e1511bf91af3be8ded418c53a353a09629e04c5880659d1df</span>
<span class="c">#        Image ID:      quay.io/cilium/clustermesh-apiserver@sha256:f619e97432db427e1511bf91af3be8ded418c53a353a09629e04c5880659d1df</span>
<span class="c">#        Ports:         2379/TCP, 9963/TCP</span>
<span class="c">#        Host Ports:    0/TCP, 0/TCP</span>
<span class="c">#        Command:</span>
<span class="c">#          /usr/bin/etcd</span>
<span class="c">#        Args:</span>
<span class="c">#          --data-dir=/var/run/etcd</span>
<span class="c">#          --name=clustermesh-apiserver</span>
<span class="c">#          --client-cert-auth</span>
<span class="c">#          --trusted-ca-file=/var/lib/etcd-secrets/ca.crt</span>
<span class="c">#          --cert-file=/var/lib/etcd-secrets/tls.crt</span>
<span class="c">#          --key-file=/var/lib/etcd-secrets/tls.key</span>
<span class="c">#          --listen-client-urls=https://127.0.0.1:2379,https://[$(HOSTNAME_IP)]:2379</span>
<span class="c">#          --advertise-client-urls=https://[$(HOSTNAME_IP)]:2379</span>
<span class="c">#          --initial-cluster-token=$(INITIAL_CLUSTER_TOKEN)</span>
<span class="c">#          --auto-compaction-retention=1</span>
<span class="c">#          --listen-metrics-urls=http://[$(HOSTNAME_IP)]:9963</span>
<span class="c">#          --metrics=basic</span>
<span class="c">#    ...</span>
<span class="c">#      apiserver:</span>
<span class="c">#        Container ID:  containerd://eecfbc62afc019580ff533a9a4d57b4e2c193ec48a2e15f9875e3866bfdc86dd</span>
<span class="c">#        Image:         quay.io/cilium/clustermesh-apiserver:v1.17.6@sha256:f619e97432db427e1511bf91af3be8ded418c53a353a09629e04c5880659d1df</span>
<span class="c">#        Image ID:      quay.io/cilium/clustermesh-apiserver@sha256:f619e97432db427e1511bf91af3be8ded418c53a353a09629e04c5880659d1df</span>
<span class="c">#        Ports:         9880/TCP, 9962/TCP</span>
<span class="c">#        Host Ports:    0/TCP, 0/TCP</span>
<span class="c">#        Command:</span>
<span class="c">#          /usr/bin/clustermesh-apiserver</span>
<span class="c">#        Args:</span>
<span class="c">#          clustermesh</span>
<span class="c">#          --debug</span>
<span class="c">#          --cluster-name=$(CLUSTER_NAME)</span>
<span class="c">#          --cluster-id=$(CLUSTER_ID)</span>
<span class="c">#          --kvstore-opt=etcd.config=/var/lib/cilium/etcd-config.yaml</span>
<span class="c">#          --kvstore-opt=etcd.qps=20</span>
<span class="c">#          --kvstore-opt=etcd.bootstrapQps=10000</span>
<span class="c">#          --max-connected-clusters=255</span>
<span class="c">#          --health-port=9880</span>
<span class="c">#          --enable-external-workloads=false</span>
<span class="c">#          --prometheus-serve-addr=:9962</span>
<span class="c">#          --controller-group-metrics=all</span>
<span class="c">#    ...</span>

<span class="c"># etcd ì»¨í„°ì´ë„ˆ ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system deployment/clustermesh-apiserver <span class="nt">-c</span> etcd

<span class="c"># apiserver ì»¨í„°ì´ë„ˆ ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system deployment/clustermesh-apiserver <span class="nt">-c</span> apiserver


<span class="c">#</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium status <span class="nt">--all-clusters</span>
<span class="c"># =&gt; ClusterMesh:            1/1 remote clusters ready, 1 global-services</span>
<span class="c">#       east: ready, 2 nodes, 9 endpoints, 7 identities, 1 services, 0 MCS-API service exports, 0 reconnections (last: never)</span>
<span class="c">#       â””  etcd: 1/1 connected, leases=0, lock leases=0, has-quorum=true: endpoint status checks are disabled, ID: b4f3f4384ecc342c</span>
<span class="c">#       â””  remote configuration: expected=true, retrieved=true, cluster-id=2, kvstoremesh=false, sync-canaries=true, service-exports=disabled</span>
<span class="c">#       â””  synchronization status: nodes=true, endpoints=true, identities=true, services=true</span>

<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium status <span class="nt">--all-clusters</span>
<span class="c"># =&gt; ClusterMesh:            1/1 remote clusters ready, 1 global-services</span>
<span class="c">#       west: ready, 2 nodes, 9 endpoints, 7 identities, 1 services, 0 MCS-API service exports, 0 reconnections (last: never)</span>
<span class="c">#       â””  etcd: 1/1 connected, leases=0, lock leases=0, has-quorum=true: endpoint status checks are disabled, ID: ea025158a8e3c0a3</span>
<span class="c">#       â””  remote configuration: expected=true, retrieved=true, cluster-id=1, kvstoremesh=false, sync-canaries=true, service-exports=disabled</span>
<span class="c">#       â””  synchronization status: nodes=true, endpoints=true, identities=true, services=true</span>

<span class="c"># etcd ì»¨í…Œì´ë„ˆ bash ì§„ì… í›„ í™•ì¸</span>
<span class="c"># krew pexec í”ŒëŸ¬ê·¸ì¸ í™œìš© https://github.com/ssup2/kpexec</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>clustermesh-apiserver
<span class="c"># =&gt; NAME                                     READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    clustermesh-apiserver-5cf45db9cc-r26tw   2/2     Running   0          4h1m</span>
<span class="nv">$ DPOD</span><span class="o">=</span>clustermesh-apiserver-5cf45db9cc-r26tw

<span class="nv">$ </span>kubectl pexec <span class="nv">$DPOD</span> <span class="nt">-it</span> <span class="nt">-T</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> etcd <span class="nt">--</span> bash
<span class="c"># =&gt; Create cnsenter pod (cnsenter-ehk0cx7v3a)</span>
<span class="c">#    Wait to run cnsenter pod (cnsenter-ehk0cx7v3a)</span>
<span class="c">#    </span>
<span class="c">#    If you don't see a command prompt, try pressing enter.</span>
<span class="nt">------------------------------------------------</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span> <span class="nt">-T</span> <span class="nt">-o</span> pid,ppid,comm,args
<span class="nv">$ </span>ps <span class="nt">-ef</span> <span class="nt">-T</span> <span class="nt">-o</span> args
<span class="c"># =&gt; COMMAND</span>
<span class="c">#    /usr/bin/etcd --data-dir=/var/run/etcd --name=clustermesh-apiserver --client-cert-auth --trusted-ca-file=/var/lib/etcd-secrets/ca.crt --cert-file=/var/lib/etcd-secrets/tls.crt --</span>

<span class="nv">$ </span><span class="nb">cat</span> /proc/1/cmdline <span class="p">;</span> <span class="nb">echo</span>
<span class="c"># =&gt; /usr/bin/etcd--data-dir=/var/run/etcd--name=clustermesh-apiserver--client-cert-auth--trusted-ca-file=/var/lib/etcd-secrets/ca.crt--cert-file=/var/lib/etcd-secrets/tls.crt--key-file=/var/lib/etcd-secrets/tls.key--listen-client-urls=https://127.0.0.1:2379,https://[10.0.1.223]:2379--advertise-client-urls=https://[10.0.1.223]:2379--initial-cluster-token=7a3aaa07-ca4f-4627-a84b-d7cb8aff8987--auto-compaction-retention=1--listen-metrics-urls=http://[10.0.1.223]:9963--metrics=basic</span>

<span class="nv">$ </span>ss <span class="nt">-tnlp</span>
<span class="c"># =&gt; LISTEN    0       4096     10.0.1.223:2379     0.0.0.0:*           users:(("etcd",pid=1,fd=8))</span>
<span class="nv">$ </span>ss <span class="nt">-tnp</span>
<span class="c"># =&gt; ESTAB     0       0        10.0.1.223:2379     172.20.0.4:43498    users:(("etcd",pid=1,fd=14))</span>
<span class="c">#    ESTAB     0       0        10.0.1.223:2379     172.20.0.4:39300    users:(("etcd",pid=1,fd=15))</span>

<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">------------------------------------------------</span>

<span class="nv">$ </span>kubectl pexec <span class="nv">$DPOD</span> <span class="nt">-it</span> <span class="nt">-T</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> apiserver <span class="nt">--</span> bash
<span class="nt">------------------------------------------------</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span> <span class="nt">-T</span> <span class="nt">-o</span> pid,ppid,comm,args
<span class="nv">$ </span>ps <span class="nt">-ef</span> <span class="nt">-T</span> <span class="nt">-o</span> args
<span class="c"># =&gt; COMMAND</span>
<span class="c">#    /usr/bin/clustermesh-apiserver clustermesh --debug --cluster-name=west --cluster-id=1 --kvstore-opt=etcd.config=/var/lib/cilium/etcd-config.yaml --kvstore-opt=etcd.qps=20 --kvsto</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/1/cmdline <span class="p">;</span> <span class="nb">echo</span>
<span class="c"># =&gt; /usr/bin/clustermesh-apiserverclustermesh--debug--cluster-name=west--cluster-id=1--kvstore-opt=etcd.config=/var/lib/cilium/etcd-config.yaml--kvstore-opt=etcd.qps=20--kvstore-opt=etcd.bootstrapQps=10000--max-connected-clusters=255--health-port=9880--enable-external-workloads=false--prometheus-serve-addr=:9962--controller-group-metrics=all</span>

<span class="nv">$ </span>ss <span class="nt">-tnlp</span>
<span class="c"># =&gt; LISTEN           0                4096                          10.0.1.223:2379                           0.0.0.0:*</span>
<span class="c">#    LISTEN           0                4096                           127.0.0.1:2379                           0.0.0.0:*</span>
<span class="nv">$ </span>ss <span class="nt">-tnp</span>
<span class="c"># =&gt; State           Recv-Q           Send-Q                     Local Address:Port                      Peer Address:Port            Process</span>
<span class="c">#    ESTAB           0                0                             10.0.1.223:60950                       172.20.0.4:6443             users:(("clustermesh-api",pid=1,fd=6))</span>
<span class="c">#    ESTAB           0                0                              127.0.0.1:33160                        127.0.0.1:2379             users:(("clustermesh-api",pid=1,fd=7))</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">------------------------------------------------</span>
</code></pre></div></div>

<h3 id="kind-í´ëŸ¬ìŠ¤í„°-ì‚­ì œ">kind í´ëŸ¬ìŠ¤í„° ì‚­ì œ</h3>

<ul>
  <li>ì‹¤ìŠµ ì™„ë£Œ í›„ kind í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kind delete cluster <span class="nt">--name</span> west <span class="o">&amp;&amp;</span> kind delete cluster <span class="nt">--name</span> east <span class="o">&amp;&amp;</span> kind delete cluster <span class="nt">--name</span> center
</code></pre></div></div>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” BGPë¥¼ í†µí•œ ë¼ìš°íŒ… ë° BGPë¥¼ í†µí•œ LoadBalancer - ExternalIP ê´‘ê³ ,
ClusterMeshë¥¼ í†µí•œ í´ëŸ¬ìŠ¤í„° ê°„ í†µì‹ ì„ ì„¤ì •í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.
ë‹¤ì–‘í•œ ìœ ìŠ¤ì¼€ì´ìŠ¤ì— ëŒ€í•œ ê¸°ëŠ¥ì´ ì¤€ë¹„ë˜ì–´ìˆìŒì— ê°íƒ„í–ˆìŠµë‹ˆë‹¤.</p>

<p>íŠ¹íˆ ClusterMeshëŠ” ë‹¨ì¼ CSPì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ, ë©€í‹° í´ë¼ìš°ë“œ í™˜ê²½ì´ë‚˜ í•˜ì´ë¸Œë¦¬ë“œ í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œë„
ìœ ìš©í• ê²ƒ ê°™ì•„ì„œ ì •ë§ ì¢‹ì€ ê¸°ëŠ¥ì¸ê²ƒ ê°™ìŠµë‹ˆë‹¤.
BGPì˜ ë™ì‘ì— ëŒ€í•´ì„œë„ ì¡°ê¸ˆì´ë‚˜ë§ˆ ì´í•´ë¥¼ ê°–ê²Œ ë˜ì—ˆê³ , ìŠ¤í„°ë””ë¥¼ í†µí•´ì„œ ì •ë§ ë§ì€ ê²ƒì„ ë°°ì›Œê°€ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>]]></content><author><name></name></author><category term="cilium" /><category term="kubernetes," /><category term="network," /><category term="linux," /><category term="cilium," /><category term="bgp," /><category term="kind," /><category term="cluster-mesh" /><summary type="html"><![CDATA[ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” BGPë¥¼ í†µí•œ ë¼ìš°íŒ…ê³¼ kind, cluster-meshë¥¼ í†µí•œ ë©€í‹° í´ëŸ¬ìŠ¤í„° í™˜ê²½ì—ì„œì˜ Cilium ë™ì‘ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[Cilium] Networking - ë…¸ë“œì˜ íŒŒë“œë“¤ê°„ í†µì‹  ìƒì„¸ part 2</title><link href="https://sweetlittlebird.github.io/posts/2025-08-10-Cilium-Week4/" rel="alternate" type="text/html" title="[Cilium] Networking - ë…¸ë“œì˜ íŒŒë“œë“¤ê°„ í†µì‹  ìƒì„¸ part 2" /><published>2025-08-10T00:10:18+09:00</published><updated>2025-08-10T00:10:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/Cilium%20-%20Week4</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2025-08-10-Cilium-Week4/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Overlay Networkì¸ VXLANì„ í†µí•œ íŒŒë“œê°„ í†µì‹ ê³¼ Kubernetes ì„œë¹„ìŠ¤ì˜ ì™¸ë¶€ ë…¸ì¶œ, LB-IPAM ë“±ì„ í†µí•œ í†µì‹ ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="ì‹¤ìŠµ-í™˜ê²½-êµ¬ì„±">ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±</h2>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” ë‹¤ìŒ ê·¸ë¦¼ê³¼ ê°™ì´ k8s-w0ë¥¼ ë³„ë„ì˜ ë„¤íŠ¸ì›Œí¬ì— ë°°ì¹˜í•˜ê³  routerë¥¼ í†µí•´ k8s-w0ì™€ k8s-ctr/w1 ë…¸ë“œê°„ í†µì‹ ì„ í™•ì¸í•©ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_2.png" alt="img.png" class="image-center" />
    <ul>
      <li>ê¸°ë³¸ ë°°í¬ ê°€ìƒ ë¨¸ì‹  : k8s-ctr, k8s-w1, k8s-w0, router</li>
      <li><strong>router</strong> : router : 192.168.10.0/24 â†” 192.168.20.0/24 ëŒ€ì—­ ë¼ìš°íŒ… ì—­í• , k8s ì— join ë˜ì§€ ì•Šì€ ì„œë²„, loop1/loop2 dump ì¸í„°í˜ì´ìŠ¤ ë°°ì¹˜</li>
      <li><strong>k8s-w0</strong> : k8s-ctr/w1 ë…¸ë“œì™€ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì— ë°°ì¹˜ë©ë‹ˆë‹¤.</li>
      <li>ì‹¤ìŠµ ë™ì‘ì— í•„ìš”í•œ static routingì´ ì„¤ì €ëœ ìƒíƒœë¡œ ë°°í¬ ë©ë‹ˆë‹¤.</li>
      <li>Cilium CNI v1.18ì´ ì„¤ì¹˜ëœ ìƒíƒœë¡œ ë°°í¬ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬-íŒŒì¼">ì‹¤ìŠµí™˜ê²½ ë°°í¬ íŒŒì¼</h3>

<ul>
  <li>
    <p><strong>Vagrantfile</strong> : ê°€ìƒë¨¸ì‹  ì •ì˜, ë¶€íŒ… ì‹œ ì´ˆê¸° í”„ë¡œë¹„ì €ë‹ ì„¤ì •ì„ í¬í•¨í•˜ëŠ” Vagrantfileì…ë‹ˆë‹¤.</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Variables</span>
<span class="no">K8SV</span> <span class="o">=</span> <span class="s1">'1.33.2-1.1'</span> <span class="c1"># Kubernetes Version : apt list -a kubelet , ex) 1.32.5-1.1</span>
<span class="no">CONTAINERDV</span> <span class="o">=</span> <span class="s1">'1.7.27-1'</span> <span class="c1"># Containerd Version : apt list -a containerd.io , ex) 1.6.33-1</span>
<span class="no">CILIUMV</span> <span class="o">=</span> <span class="s1">'1.18.0'</span> <span class="c1"># Cilium CNI Version : https://github.com/cilium/cilium/tags</span>
<span class="no">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># max number of worker nodes</span>
  
<span class="c1"># Base Image  https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-24.04</span>
<span class="no">BOX_IMAGE</span> <span class="o">=</span> <span class="s2">"bento/ubuntu-24.04"</span>
<span class="no">BOX_VERSION</span> <span class="o">=</span> <span class="s2">"202502.21.0"</span>
  
<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
<span class="c1">#-ControlPlane Node</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-ctr"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
        
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">2560</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.100"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60000</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span> <span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/k8s-ctr.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">N</span><span class="p">,</span> <span class="no">CILIUMV</span><span class="p">,</span> <span class="no">K8SV</span> <span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/route-add1.sh"</span>
    <span class="k">end</span>
  
<span class="c1">#-Worker Nodes Subnet1</span>
  <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="no">N</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.10</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="s2">"6000</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/k8s-w.sh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/route-add1.sh"</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
<span class="c1">#-Router Node</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"router"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"router"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">768</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"router"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.200"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60009</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.20.200"</span><span class="p">,</span> <span class="ss">auto_config: </span><span class="kp">false</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/router.sh"</span>
    <span class="k">end</span>
  
<span class="c1">#-Worker Nodes Subnet2</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w0"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w0"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w0"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.20.100"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60010</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/k8s-w.sh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/route-add2.sh"</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>init_cfg.sh</strong> : args ì°¸ê³ í•˜ì—¬ ì´ˆê¸° ì„¤ì •ì„ ìˆ˜í–‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime <span class="c"># Change Timezone</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Disable and turn off SWAP"</span>
swapoff <span class="nt">-a</span> <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'/swap/s/^/#/'</span> /etc/fstab
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Install Packages"</span>
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>apt-transport-https ca-certificates curl gpg <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># Download the public signing key for the Kubernetes package repositories.</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nt">-m</span> 755 /etc/apt/keyrings
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$1</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+)\..*/\1/p'</span><span class="si">)</span>
curl <span class="nt">-fsSL</span> https://pkgs.k8s.io/core:/stable:/v<span class="nv">$K8SMMV</span>/deb/Release.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/kubernetes-apt-keyring.gpg
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v</span><span class="nv">$K8SMMV</span><span class="s2">/deb/ /"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list.d/kubernetes.list
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
  
<span class="c"># packets traversing the bridge are processed by iptables for filtering</span>
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
<span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> <span class="o">&gt;&gt;</span> /etc/sysctl.d/k8s.conf
  
<span class="c"># enable br_netfilter for iptables </span>
modprobe br_netfilter
modprobe overlay
<span class="nb">echo</span> <span class="s2">"br_netfilter"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
<span class="nb">echo</span> <span class="s2">"overlay"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)"</span>
<span class="c"># Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version</span>
apt update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># apt list -a kubelet ; apt list -a containerd.io</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubectl</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubeadm</span><span class="o">=</span><span class="nv">$1</span> containerd.io<span class="o">=</span><span class="nv">$2</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-mark hold kubelet kubeadm kubectl <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># containerd configure to default and cgroup managed by systemd</span>
containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SystemdCgroup = false/SystemdCgroup = true/g'</span> /etc/containerd/config.toml
  
<span class="c"># avoid WARN&amp;ERRO(default endpoints) when crictl run  </span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
</span><span class="no">EOF
  
</span><span class="c"># ready to install for k8s </span>
systemctl restart containerd <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable </span>containerd
systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Packages &amp; Helm"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get <span class="nb">install</span> <span class="nt">-y</span> bridge-utils sshpass net-tools conntrack ngrep tcpdump ipset arping wireguard jq yq tree bash-completion unzip kubecolor termshark <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
curl <span class="nt">-s</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>k8s-ctr.sh</strong> : kubeadm initë¥¼ í†µí•˜ì—¬ kubernetes controlplane ë…¸ë“œë¥¼ ì„¤ì •í•˜ê³  Cilium CNI ì„¤ì¹˜, í¸ë¦¬ì„± ì„¤ì •(k, kc)í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. local-path-storageclassì™€ metrics-serverë„ ì„¤ì¹˜í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Initial Kubernetes"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-init-ctr-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/kubeadm-init-ctr-config.yaml
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$3</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/p'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/K8S_VERSION_PLACEHOLDER/v</span><span class="k">${</span><span class="nv">K8SMMV</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-init-ctr-config.yaml
kubeadm init <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-init-ctr-config.yaml"</span>  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Setting kube config file"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /root/.kube
<span class="nb">cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf /root/.kube/config
<span class="nb">chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> /root/.kube/config
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Source the completion"</span>
<span class="nb">echo</span> <span class="s1">'source &lt;(kubectl completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'source &lt;(kubeadm completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Alias kubectl to k"</span>
<span class="nb">echo</span> <span class="s1">'alias k=kubectl'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'alias kc=kubecolor'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'complete -F __start_kubectl k'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubectx &amp; Kubens"</span>
git clone https://github.com/ahmetb/kubectx /opt/kubectx <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubens /usr/local/bin/kubens
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubectx /usr/local/bin/kubectx
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Kubeps &amp; Setting PS1"</span>
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1 <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">"</span><span class="no">EOT</span><span class="sh">" &gt;&gt; /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
function get_cluster_short() {
  echo "</span><span class="nv">$1</span><span class="sh">" | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=') '
PS1='</span><span class="si">$(</span>kube_ps1<span class="si">)</span><span class="sh">'</span><span class="nv">$PS1</span><span class="sh">
</span><span class="no">EOT
</span>kubectl config rename-context <span class="s2">"kubernetes-admin@kubernetes"</span> <span class="s2">"HomeLab"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 7] Install Cilium CNI"</span>
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
helm repo add cilium https://helm.cilium.io/ <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm repo update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> <span class="nv">$2</span> <span class="nt">--namespace</span> kube-system <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.100 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="se">\</span>
<span class="nt">--set</span> ipam.mode<span class="o">=</span><span class="s2">"cluster-pool"</span> <span class="nt">--set</span> ipam.operator.clusterPoolIPv4PodCIDRList<span class="o">={</span><span class="s2">"172.20.0.0/16"</span><span class="o">}</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>172.20.0.0/16 <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>30003 <span class="se">\</span>
<span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span> <span class="se">\</span>
<span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 8] Install Cilium / Hubble CLI"</span>
<span class="nv">CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz
  
<span class="nv">HUBBLE_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="si">)</span>
<span class="nv">HUBBLE_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">HUBBLE_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/hubble/releases/download/<span class="nv">$HUBBLE_VERSION</span>/hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 9] Remove node taint"</span>
kubectl taint nodes k8s-ctr node-role.kubernetes.io/control-plane-
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 10] local DNS with hosts file"</span>
<span class="nb">echo</span> <span class="s2">"192.168.10.100 k8s-ctr"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.10.200 router"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.20.100 k8s-w0"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;<span class="o">=</span><span class="nv">$1</span><span class="p">;</span> i++  <span class="o">))</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"192.168.10.10</span><span class="nv">$i</span><span class="s2"> k8s-w</span><span class="nv">$i</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts<span class="p">;</span> <span class="k">done
  
  
</span><span class="nb">echo</span> <span class="s2">"[TASK 11] Dynamically provisioning persistent local storage with Kubernetes"</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.31/deploy/local-path-storage.yaml <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch storageclass local-path <span class="nt">-p</span> <span class="s1">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 12] Install Prometheus &amp; Grafana"</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.0/examples/kubernetes/addons/prometheus/monitoring-example.yaml <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch svc <span class="nt">-n</span> cilium-monitoring prometheus <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 9090, "targetPort": 9090, "nodePort": 30001}]}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch svc <span class="nt">-n</span> cilium-monitoring grafana <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 3000, "targetPort": 3000, "nodePort": 30002}]}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># echo "[TASK 12] Install Prometheus Stack"</span>
<span class="c"># helm repo add prometheus-community https://prometheus-community.github.io/helm-charts  &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># cat &lt;&lt;EOT &gt; monitor-values.yaml</span>
<span class="c"># prometheus:</span>
<span class="c">#   prometheusSpec:</span>
<span class="c">#     scrapeInterval: "15s"</span>
<span class="c">#     evaluationInterval: "15s"</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30001</span>
  
<span class="c"># grafana:</span>
<span class="c">#   defaultDashboardsTimezone: Asia/Seoul</span>
<span class="c">#   adminPassword: prom-operator</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30002</span>
  
<span class="c"># alertmanager:</span>
<span class="c">#   enabled: false</span>
<span class="c"># defaultRules:</span>
<span class="c">#   create: false</span>
<span class="c"># prometheus-windows-exporter:</span>
<span class="c">#   prometheus:</span>
<span class="c">#     monitor:</span>
<span class="c">#       enabled: false</span>
<span class="c"># EOT</span>
<span class="c"># helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack --version 75.15.1 \</span>
<span class="c">#   -f monitor-values.yaml --create-namespace --namespace monitoring  &gt;/dev/null 2&gt;&amp;1</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 13] Install Metrics-server"</span>
helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm upgrade <span class="nt">--install</span> metrics-server metrics-server/metrics-server <span class="nt">--set</span> <span class="s1">'args[0]=--kubelet-insecure-tls'</span> <span class="nt">-n</span> kube-system  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 14] Install k9s"</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>wget https://github.com/derailed/k9s/releases/latest/download/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb <span class="nt">-O</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt <span class="nb">install</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p><strong>kubeadm-init-ctr-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  apiVersion: kubeadm.k8s.io/v1beta4
  kind: InitConfiguration
  bootstrapTokens:
  - token: <span class="s2">"123456.1234567890123456"</span>
    ttl: <span class="s2">"0s"</span>
    usages:
    - signing
    - authentication
  localAPIEndpoint:
    advertiseAddress: <span class="s2">"192.168.10.100"</span>
  nodeRegistration:
    kubeletExtraArgs:
      - name: node-ip
        value: <span class="s2">"192.168.10.100"</span>
    criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
  <span class="nt">---</span>
  apiVersion: kubeadm.k8s.io/v1beta4
  kind: ClusterConfiguration
  kubernetesVersion: <span class="s2">"K8S_VERSION_PLACEHOLDER"</span>
  networking:
    podSubnet: <span class="s2">"10.244.0.0/16"</span>
    serviceSubnet: <span class="s2">"10.96.0.0/16"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li><strong>k8s-w.sh</strong> : kubernetes worker ë…¸ë“œ ì„¤ì •, kubeadm join ë“±ì„ ìˆ˜í–‰í•˜ëŠ”  ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;"</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] K8S Controlplane Join"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-join-worker-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-join-worker-config.yaml
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/NODE_IP_PLACEHOLDER/</span><span class="k">${</span><span class="nv">NODEIP</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-join-worker-config.yaml
kubeadm <span class="nb">join</span> <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-join-worker-config.yaml"</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
    <ul>
      <li>
        <p><strong>kubeadm-join-worker-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: kubeadm.k8s.io/v1beta4
kind: JoinConfiguration
discovery:
  bootstrapToken:
    token: <span class="s2">"123456.1234567890123456"</span>
    apiServerEndpoint: <span class="s2">"192.168.10.100:6443"</span>
    unsafeSkipCAVerification: <span class="nb">true
</span>nodeRegistration:
  criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
  kubeletExtraArgs:
    - name: node-ip
      value: <span class="s2">"NODE_IP_PLACEHOLDER"</span>    
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>route-add1.sh</strong> : k8s node ë“¤ì´ ë‚´ë¶€ë§ê³¼ í†µì‹ ì„ ìœ„í•œ route ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt;&gt; /etc/netplan/50-vagrant.yaml
      routes:
      - to: 192.168.20.0/24
        via: 192.168.10.200
      - to: 172.20.0.0/16
        via: 192.168.10.200
      - to: 10.10.0.0/16
        via: 192.168.10.200
</span><span class="no">EOT
  
</span>netplan apply
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>route-add2.sh</strong> : k8s node ë“¤ì´ ë‚´ë¶€ë§ê³¼ í†µì‹ ì„ ìœ„í•œ route ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt;&gt; /etc/netplan/50-vagrant.yaml
      routes:
      - to: 192.168.10.0/24
        via: 192.168.20.200
      - to: 172.20.0.0/16
        via: 192.168.20.200
      - to: 10.10.0.0/16
        via: 192.168.20.200
</span><span class="no">EOT
  
</span>netplan apply
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>router.sh</strong> : router ì—­í• ê³¼ ì¶”ê°€ì ìœ¼ë¡œ ì›¹ì„œë²„ ì—­í• ì„ í•˜ëŠ” ì„œë²„ì˜ ì´ˆê¸° ì„¤ì •ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 0] Setting eth2"</span>
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOT</span><span class="sh"> &gt;&gt; /etc/netplan/50-vagrant.yaml
    eth2:
      addresses:
      - 192.168.20.200/24
</span><span class="no">EOT
  
</span>netplan apply
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Add Kernel setting - IP Forwarding"</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g'</span> /etc/sysctl.conf
sysctl <span class="nt">-p</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Setting Dummy Interface"</span>
modprobe dummy
ip <span class="nb">link </span>add loop1 <span class="nb">type </span>dummy
ip <span class="nb">link set </span>loop1 up
ip addr add 10.10.1.200/24 dev loop1
  
ip <span class="nb">link </span>add loop2 <span class="nb">type </span>dummy
ip <span class="nb">link set </span>loop2 up
ip addr add 10.10.2.200/24 dev loop2
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Packages"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>net-tools jq yq tree ngrep tcpdump arping termshark <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Apache"</span>
apt <span class="nb">install </span>apache2 <span class="nt">-y</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"&lt;h1&gt;Web Server : </span><span class="si">$(</span><span class="nb">hostname</span><span class="si">)</span><span class="s2">&lt;/h1&gt;"</span> <span class="o">&gt;</span> /var/www/html/index.html
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬-ë°-ë¶„ì„-íˆ´-ì„¤ì¹˜">ì‹¤ìŠµí™˜ê²½ ë°°í¬ ë° ë¶„ì„ íˆ´ ì„¤ì¹˜</h3>

<ul>
  <li>
    <p>ì‹¤ìŠµí™˜ê²½ ë°°í¬</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vagrant up
<span class="c"># =&gt; ...    </span>
<span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;</span>
<span class="c">#    ==&gt; k8s-w0: Running provisioner: shell...</span>
<span class="c">#        k8s-w0: Running: /var/folders/7k/qy6rsdds57z3tmyn9_7hhd8r0000gn/T/vagrant-shell20250807-27868-fg24bd.sh</span>
<span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;</span>
<span class="c">#        k8s-w0: [TASK 1] K8S Controlplane Join</span>
<span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;</span>
<span class="c">#    ==&gt; k8s-w0: Running provisioner: shell...</span>
<span class="c">#        k8s-w0: Running: /var/folders/7k/qy6rsdds57z3tmyn9_7hhd8r0000gn/T/vagrant-shell20250807-27868-fzndov.sh</span>
<span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;</span>
<span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ê¸°ë³¸ì •ë³´ í™•ì¸</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s-ctr ë…¸ë“œì— ì ‘ì†</span>
<span class="nv">$ </span>vagrant ssh k8s-ctr

<span class="nt">---------------------------------</span>

<span class="c"># k9s ì„¤ì¹˜</span>
<span class="nv">$ CLI_ARCH</span><span class="o">=</span>amd64
<span class="nv">$ </span><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi</span>
<span class="nv">$ </span>wget https://github.com/derailed/k9s/releases/latest/download/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb <span class="nt">-O</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb
<span class="nv">$ </span>apt <span class="nb">install</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb
<span class="nv">$ </span>k9s <span class="c"># node/pod ì •ë³´ í™•ì¸ - metrics-server ì„¤ì¹˜ë˜ì–´ ìˆì–´ì„œ, cpu/mem í™•ì¸ ê°€ëŠ¥</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
<span class="c"># =&gt; 127.0.2.1 k8s-ctr k8s-ctr</span>
<span class="c">#    192.168.10.100 k8s-ctr</span>
<span class="c">#    192.168.20.100 k8s-w0</span>
<span class="c">#    192.168.10.101 k8s-w1</span>
<span class="c">#    192.168.10.200 router</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-w0 <span class="nb">hostname</span>
<span class="c"># =&gt; k8s-w0</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-w0ëŠ” k8s-ctrê³¼ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ì— ìˆì§€ë§Œ ì •ì  route ì„¤ì •ì´ ë˜ì–´ ìˆì–´ì„œ ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-w1 <span class="nb">hostname</span>
<span class="c"># =&gt; k8s-w1</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@router <span class="nb">hostname</span>
<span class="c"># =&gt; router</span>

<span class="c"># í´ëŸ¬ìŠ¤í„° ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://192.168.10.100:6443</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt;                             "--service-cluster-ip-range=10.96.0.0/16",</span>
<span class="c">#                                "--cluster-cidr=10.244.0.0/16",                           </span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubeadm-config
<span class="c"># =&gt; ...</span>
<span class="c">#      podSubnet: 10.244.0.0/16</span>
<span class="c">#      serviceSubnet: 10.96.0.0/16</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubelet-config

<span class="c"># ë…¸ë“œ ì •ë³´ : ìƒíƒœ, INTERNAL-IP í™•ì¸</span>
<span class="nv">$ </span>ifconfig | <span class="nb">grep</span> <span class="nt">-iEA1</span> <span class="s1">'eth[0-9]:'</span>
<span class="c"># =&gt; eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255</span>
<span class="c">#    --</span>
<span class="c">#    eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 192.168.10.100  netmask 255.255.255.0  broadcast 192.168.10.255</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME      STATUS   ROLES           AGE     VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    k8s-ctr   Ready    control-plane   9m41s   v1.33.2   192.168.10.100   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w0    Ready    &lt;none&gt;          4m37s   v1.33.2   192.168.20.100   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w1    Ready    &lt;none&gt;          7m13s   v1.33.2   192.168.10.101   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>

<span class="c"># íŒŒë“œ ì •ë³´ : ìƒíƒœ, íŒŒë“œ IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'</span>
<span class="c"># =&gt; k8s-ctr 10.244.0.0/24</span>
<span class="c">#    k8s-w0  10.244.3.0/24</span>
<span class="c">#    k8s-w1  10.244.1.0/24</span>
<span class="nv">$ </span>kubectl get ciliumnode <span class="nt">-o</span> json | <span class="nb">grep </span>podCIDRs <span class="nt">-A2</span>
<span class="c"># =&gt;                     "podCIDRs": [</span>
<span class="c">#                            "172.20.0.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "172.20.2.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "172.20.1.0/24"</span>
<span class="c">#                        ],</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      READY   STATUS    RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    cilium-monitoring    grafana-5c69859d9-n82rg                   1/1     Running   0          10m     172.20.0.209     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    cilium-monitoring    prometheus-6fc896bc5d-m82wl               1/1     Running   0          10m     172.20.0.230     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-c8265                              1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-envoy-2x4fb                        1/1     Running   0          7m54s   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-envoy-fktjl                        1/1     Running   0          5m18s   192.168.20.100   k8s-w0    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-envoy-gw7cw                        1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-h5k5g                              1/1     Running   0          5m18s   192.168.20.100   k8s-w0    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-operator-76788cffb7-8nhzr          1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-tzlkp                              1/1     Running   0          7m54s   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-bkc4b                  1/1     Running   0          10m     172.20.0.42      k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-jdxtw                  1/1     Running   0          10m     172.20.0.185     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          etcd-k8s-ctr                              1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          hubble-relay-5b48c999f9-vh8jq             1/1     Running   0          10m     172.20.0.156     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          hubble-ui-655f947f96-vv266                2/2     Running   0          10m     172.20.0.147     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-apiserver-k8s-ctr                    1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-controller-manager-k8s-ctr           1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-5qw8d                          1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-7z4ds                          1/1     Running   0          7m54s   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-twtfn                          1/1     Running   0          5m18s   192.168.20.100   k8s-w0    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-scheduler-k8s-ctr                    1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          metrics-server-5dd7b49d79-25cdj           1/1     Running   0          9m59s   172.20.0.253     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-rxvrq   1/1     Running   0          10m     172.20.0.103     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    cilium-monitoring    grafana-5c69859d9-n82rg                   9513                ready            172.20.0.209</span>
<span class="c">#    cilium-monitoring    prometheus-6fc896bc5d-m82wl               47077               ready            172.20.0.230</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-bkc4b                  2750                ready            172.20.0.42</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-jdxtw                  2750                ready            172.20.0.185</span>
<span class="c">#    kube-system          hubble-relay-5b48c999f9-vh8jq             17251               ready            172.20.0.156</span>
<span class="c">#    kube-system          hubble-ui-655f947f96-vv266                10805               ready            172.20.0.147</span>
<span class="c">#    kube-system          metrics-server-5dd7b49d79-25cdj           14866               ready            172.20.0.253</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-rxvrq   11456               ready            172.20.0.103</span>

<span class="c"># ipam ëª¨ë“œ í™•ì¸</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> ^ipam
<span class="c"># =&gt; ipam                                              cluster-pool</span>

<span class="c"># iptables í™•ì¸</span>
<span class="nv">$ </span>iptables-save
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span>
</code></pre></div></div>

<ul>
  <li>[k8s-ctr] cilium ì„¤ì¹˜ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq
<span class="nv">$ </span>cilium status
<span class="nv">$ </span>cilium config view
<span class="c"># =&gt; ...</span>
<span class="c">#    auto-direct-node-routes                           true</span>
<span class="c">#    ...</span>
<span class="c">#    routing-mode                                      native</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg status <span class="nt">--verbose</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg metrics list

<span class="c"># monitor</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">-v</span>

<span class="c">## Filter for only the events related to endpoint</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">--related-to</span><span class="o">=</span>&lt;<span class="nb">id</span><span class="o">&gt;</span>

<span class="c">## Show notifications only for dropped packet events</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">--type</span> drop

<span class="c">## Donâ€™t dissect packet payload, display payload in hex information</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">-v</span> <span class="nt">--hex</span>

<span class="c">## Layer7</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
</code></pre></div></div>

<ul>
  <li>ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸ : <code class="language-plaintext highlighter-rouge">autoDirectNodeRoutes=true</code> ë™ì‘ ì´í•´</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># router ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8</span>
<span class="c">#    eth0             UP             10.0.2.15/24 metric 100</span>
<span class="c">#    eth1             UP             192.168.10.200/24</span>
<span class="c">#    eth2             UP             192.168.20.200/24</span>
<span class="c">#    loop1            UNKNOWN        10.10.1.200/24</span>
<span class="c">#    loop2            UNKNOWN        10.10.2.200/24</span>

<span class="c"># k8s node ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth1
<span class="c"># =&gt; 3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet 192.168.10.100/24 brd 192.168.10.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth1
<span class="c"># =&gt; 3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet 192.168.10.101/24 brd 192.168.10.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w0 ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth1
<span class="c"># =&gt; 3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet 192.168.20.100/24 brd 192.168.20.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># ë¼ìš°íŒ… ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.10.1.0/24 dev loop1 proto kernel scope link src 10.10.1.200</span>
<span class="c">#    10.10.2.0/24 dev loop2 proto kernel scope link src 10.10.2.200</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.200</span>
<span class="c">#    192.168.20.0/24 dev eth2 proto kernel scope link src 192.168.20.200</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>static
<span class="c"># =&gt; 10.10.0.0/16 via 192.168.10.200 dev eth1 proto static</span>
<span class="c">#    172.20.0.0/16 via 192.168.10.200 dev eth1 proto static</span>
<span class="c">#    192.168.20.0/24 via 192.168.10.200 dev eth1 proto static</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 192.168.10.0/24ì™€ 192.168.20.0/24 ë„¤íŠ¸ì›Œí¬ì˜ routing ë“±ì„ ìœ„í•´ì„œ routerì— static route ì„¤ì •ì´ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c">## --set routingMode=native --set autoDirectNodeRoutes=true ë™ì‘ì„ ì •í™•íˆ ì´í•´í•´ë³´ì!</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; 10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.10.0.0/16 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    172.20.0.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.0.0/16 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    172.20.0.201 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.1.0/24 via 192.168.10.101 dev eth1 proto kernel</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100</span>
<span class="c">#    &lt;span style="color: green;"&gt;192.168.20.0/24 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.10.0.0/16 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    172.20.0.0/24 via 192.168.10.100 dev eth1 proto kernel</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.0.0/16 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    172.20.1.0/24 via 172.20.1.197 dev cilium_host proto kernel src 172.20.1.197</span>
<span class="c">#    172.20.1.197 dev cilium_host proto kernel scope link</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.101</span>
<span class="c">#    &lt;span style="color: green;"&gt;192.168.20.0/24 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w0 ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.10.0.0/16 via 192.168.20.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.0.0/16 via 192.168.20.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    172.20.2.0/24 via 172.20.2.25 dev cilium_host proto kernel src 172.20.2.25</span>
<span class="c">#    172.20.2.25 dev cilium_host proto kernel scope link</span>
<span class="c">#    &lt;span style="color: green;"&gt;192.168.10.0/24 via 192.168.20.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    192.168.20.0/24 dev eth1 proto kernel scope link src 192.168.20.100</span>

<span class="c"># í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 10.10.1.200     <span class="c"># router loop1 </span>
<span class="c"># =&gt; PING 10.10.1.200 (10.10.1.200) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 10.10.1.200: icmp_seq=1 ttl=64 time=0.780 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 10.10.1.200 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.780/0.780/0.780/0.000 ms</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 192.168.20.100  <span class="c"># k8s-w0 eth1</span>
<span class="c"># =&gt; PING 192.168.20.100 (192.168.20.100) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.20.100: icmp_seq=1 ttl=63 time=1.82 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.20.100 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.821/1.821/1.821/0.000 ms</span>

<span class="c"># ëª©ì ì§€ê¹Œì§€ ê²½ìš°í•˜ëŠ” ë¼ìš°íŒ… ì •ë³´ ì œê³µ</span>
<span class="c">## Path MTU (pmtu): ì¶œë°œì§€ì—ì„œ ëª©ì ì§€ê¹Œì§€ ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ ìƒì—ì„œ í†µê³¼í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ íŒ¨í‚· í¬ê¸°(Byte), IP fragmentation ì—†ì´ ì „ì†¡ ê°€ëŠ¥í•œ ê°€ì¥ í° íŒ¨í‚· í¬ê¸°ë¥¼ ì˜ë¯¸.</span>
<span class="c">## pmtu 1500: ì „ì²´ ê²½ë¡œì˜ ìµœì†Œ MTUëŠ” 1500 , hops 2: ì´ 2ë‹¨ê³„ ë¼ìš°í„°/ë…¸ë“œë¥¼ ê±°ì³ì„œ ë„ë‹¬ , back 2: ì‘ë‹µë„ ë™ì¼í•œ hop ìˆ˜ë¡œ ëŒì•„ì˜´ </span>
<span class="nv">$ </span>tracepath <span class="nt">-n</span> 192.168.20.100
<span class="c"># =&gt;  1?: [LOCALHOST]                      pmtu 1500</span>
<span class="c">#     1:  192.168.10.200                                        2.759ms</span>
<span class="c">#     1:  192.168.10.200                                        0.994ms</span>
<span class="c">#     2:  192.168.20.100                                        1.461ms reached</span>
<span class="c">#         Resume: pmtu 1500 hops 2 back 2</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-ctr(192.168.10.100)ì—ì„œ k8s-w0(192.168.20.100)ì€ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ì´ê¸° ë•Œë¬¸ì—&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ì§ì ‘ì ìœ¼ë¡œ í†µì‹ í•  ìˆ˜ ì—†ê³ , router(192.168.10.200)ë¥¼ ê±°ì³ì„œ routingë˜ì–´ í†µì‹ ì´ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<hr />

<h2 id="native-routing-mode">Native Routing Mode</h2>

<h3 id="ìƒ˜í”Œ-ì• í”Œë¦¬ì¼€ì´ì…˜-ë°°í¬-ë°-í™•ì¸">ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° í™•ì¸</h3>

<ul>
  <li>ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ : <code class="language-plaintext highlighter-rouge">cilium-dbg</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># k8s-ctr ë…¸ë“œì— curl-pod íŒŒë“œ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>
</code></pre></div></div>

<ul>
  <li>í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   3/3     3            3           53s   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.129.95   &lt;none&gt;        80/TCP    53s   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                                        AGE</span>
<span class="c">#    endpoints/webpod   172.20.0.131:80,172.20.1.217:80,172.20.2.73:80   53s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="c"># =&gt; NAME           ADDRESSTYPE   PORTS   ENDPOINTS                               AGE</span>
<span class="c">#    webpod-njp7j   IPv4          80      172.20.0.131,172.20.2.73,172.20.1.217   65s</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="c"># IP í™•ì¸</span>
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  21500               ready            172.20.0.89</span>
<span class="c">#    webpod-697b545f57-b46tz   17081               ready            172.20.0.131          # &lt;span style="color: green;"&gt;k8s-wctr&lt;/span&gt;</span>
<span class="c">#    webpod-697b545f57-66grn   17081               ready            172.20.1.217          # &lt;span style="color: green;"&gt;k8s-w1&lt;/span&gt;</span>
<span class="c">#    webpod-697b545f57-24ck5   17081               ready            172.20.2.73           # &lt;span style="color: green;"&gt;k8s-w0&lt;/span&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg ip list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg endpoint list

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg service list
<span class="c"># =&gt; ...</span>
<span class="c">#    20   10.96.129.95:80/TCP     ClusterIP      1 =&gt; 172.20.0.131:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 172.20.1.217:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; 172.20.2.73:80/TCP (active)</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf lb list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf lb list | <span class="nb">grep </span>10.96.129.95
<span class="c"># =&gt; 10.96.129.95:80/TCP (3)        172.20.2.73:80/TCP (20) (3)</span>
<span class="c">#    10.96.129.95:80/TCP (0)        0.0.0.0:0 (20) (0) [ClusterIP, non-routable]</span>
<span class="c">#    10.96.129.95:80/TCP (1)        172.20.0.131:80/TCP (20) (1)</span>
<span class="c">#    10.96.129.95:80/TCP (2)        172.20.1.217:80/TCP (20) (2)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ciliumì˜ load balancerê°€ ê° íŒŒë“œì˜ IPì„ í™•ì¸í•˜ê³ , í•´ë‹¹ IPë¡œ ìš”ì²­ì„ ì „ë‹¬í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf nat list

<span class="c"># map</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map list | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'0             0'</span>
<span class="c"># =&gt; Name                           Num entries   Num errors   Cache enabled</span>
<span class="c">#    cilium_policy_v2_03166         3             0            true</span>
<span class="c">#    cilium_policy_v2_01270         3             0            true</span>
<span class="c">#    cilium_policy_v2_01641         3             0            true</span>
<span class="c">#    cilium_policy_v2_01688         3             0            true</span>
<span class="c">#    cilium_lb4_reverse_nat         20            0            true</span>
<span class="c">#    cilium_lxc                     13            0            true</span>
<span class="c">#    cilium_policy_v2_02965         3             0            true</span>
<span class="c">#    cilium_runtime_config          256           0            true</span>
<span class="c">#    cilium_ipcache_v2              22            0            true</span>
<span class="c">#    cilium_policy_v2_00459         2             0            true</span>
<span class="c">#    cilium_policy_v2_00222         3             0            true</span>
<span class="c">#    cilium_policy_v2_03535         3             0            true</span>
<span class="c">#    cilium_policy_v2_02230         3             0            true</span>
<span class="c">#    cilium_lb4_services_v2         45            0            true</span>
<span class="c">#    cilium_lb4_backends_v3         16            0            true</span>
<span class="c">#    cilium_lb4_reverse_sk          9             0            true</span>
<span class="c">#    cilium_policy_v2_00745         3             0            true</span>
<span class="c">#    cilium_policy_v2_01678         3             0            true</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_services_v2
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_services_v2 | <span class="nb">grep </span>10.96.129.95
<span class="c"># =&gt; Key                            Value                     State   Error</span>
<span class="c">#    10.96.129.95:80/TCP (3)        15 0[0] (20) [0x0 0x0]</span>
<span class="c">#    10.96.129.95:80/TCP (2)        16 0[0] (20) [0x0 0x0]</span>
<span class="c">#    10.96.129.95:80/TCP (0)        0 3[0] (20) [0x0 0x0]</span>
<span class="c">#    10.96.129.95:80/TCP (1)        14 0[0] (20) [0x0 0x0]   </span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_backends_v3
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_reverse_nat
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_ipcache_v2
</code></pre></div></div>

<h3 id="í†µì‹ -í™•ì¸-ë°-hubbleë¡œ-ëª¨ë‹ˆí„°ë§">í†µì‹  í™•ì¸ ë° hubbleë¡œ ëª¨ë‹ˆí„°ë§</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í†µì‹  í™•ì¸ : ë¬¸ì œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-66grn</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; ---</span>
<span class="c">#    Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-66grn</span>
<span class="c">#    ---  # &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-w0 ë…¸ë“œì— ë°°í¬ëœ webpod íŒŒë“œì— ëŒ€í•´ì„œëŠ” í†µì‹ ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-ctr ë…¸ë“œì™€ k8s-w1 ë…¸ë“œì— ë°°í¬ëœ webpod íŒŒë“œì— ëŒ€í•´ì„œëŠ” í†µì‹ ì´ ë˜ì§€ë§Œ,&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   k8s-w0 ë…¸ë“œì— ë°°í¬ëœ webpod íŒŒë“œì— ëŒ€í•´ì„œëŠ” í†µì‹ ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ì™œëƒí•˜ë©´, ë…¸ë“œê°„ì˜ í†µì‹ ì€ routerì—ì„œ ì •ì  ë¼ìš°íŒ…ì„ í†µí•´ í†µì‹ ì´ ê°€ëŠ¥í•˜ì§€ë§Œ,&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   íŒŒë“œ ê°„ì˜ í†µì‹ ì— ëŒ€í•´ì„œëŠ” routing ì²˜ë¦¬ê°€ ë˜ì–´ìˆì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Encapsulation Modeë¥¼ í†µí•´ ì´ ë¬¸ì œë¥¼ í•´ê²°í•´ë³´ê³ &lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œ Native Routing Modeë¥¼ í†µí•´ ì´ ë¬¸ì œë¥¼ í•´ê²°í•´ë³´ê² ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># k8s-w0 ë…¸ë“œì— ë°°í¬ëœ webpod íŒŒë“œ IP ì§€ì •</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPOD</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w0 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; 172.20.2.73</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>

<span class="c"># </span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$WEBPOD</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [router] : ë¼ìš°íŒ…ì´ ì–´ë–»ê²Œ ë˜ëŠ”ê°€?</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>
<span class="c"># =&gt; 14:29:00.156370 eth1  In  IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 35, seq 1, length 64</span>
<span class="c">#    14:29:00.156388 eth0  Out IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 35, seq 1, length 64</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-ctr ë…¸ë“œì˜ íŒŒë“œ(172.20.0.89)ì—ì„œ k8s-w0 ë…¸ë“œì˜ íŒŒë“œ(172.20.2.73)ë¡œ pingì„ ë³´ë‚´ë©´,&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ì„œë¡œê°„ì˜ ë¼ìš°íŒ…ì´ ë˜ì–´ìˆì§€ ì•Šê¸° ë•Œë¬¸ì— pingì´ ì‹¤íŒ¨í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [router]</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="nv">$ </span>ip route get 172.20.2.36   <span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 172.20.2.36ìœ¼ë¡œ í†µì‹ í• ë•Œ ì‚¬ìš©ë˜ëŠ” ë¼ìš°íŒ… ì •ë³´ í™•ì¸í•˜ëŠ” ëª…ë ¹ì–´&lt;/span&gt;</span>
<span class="c"># =&gt; 172.20.2.36 via 10.0.2.2 dev eth0 src 10.0.2.15 uid 0</span>

<span class="c"># [k8s-ctr]ì—ì„œ ë°˜ë³µ í˜¸ì¶œ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nn</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-w0ë…¸ë“œì˜ íŒŒë“œë¡œ í†µì‹ ì„ ì‹œë„í•˜ì—¬ í†µì‹ ì´ ì•ˆ ë  ë•Œ ë§ˆë‹¤ routerì˜ tcpdumpì— í†µì‹ ì´ ì•ˆ ë˜ëŠ” ë¡œê·¸ê°€ ì°í™ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># hubble í™•ì¸</span>
<span class="c"># hubble ui ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸ : default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸</span>
<span class="nv">$ NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"http://</span><span class="nv">$NODEIP</span><span class="s2">:30003"</span>
<span class="c"># =&gt; http://192.168.10.100:30003</span>

<span class="c"># hubble relay í¬íŠ¸ í¬ì›Œë”© ì‹¤í–‰</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; â„¹ï¸  Hubble Relay is available at 127.0.0.1:4245</span>
<span class="nv">$ </span>hubble status
<span class="c"># =&gt; Healthcheck (via localhost:4245): Ok</span>

<span class="c"># flow log ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--pod</span> curl-pod
<span class="c"># =&gt; ...</span>
<span class="c">#    Aug  9 05:38:54.615: default/curl-pod:46490 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Aug  9 05:38:54.618: default/curl-pod:46490 (ID:21500) &lt;- default/webpod-697b545f57-66grn:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Aug  9 05:38:54.618: default/curl-pod:46490 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Aug  9 05:38:55.627: default/curl-pod (ID:21500) &lt;&gt; 10.96.129.95:80 (world) pre-xlate-fwd TRACED (TCP)</span>
<span class="c">#    Aug  9 05:38:55.627: default/curl-pod (ID:21500) &lt;&gt; &lt;span style="color: green;"&gt;default/webpod-697b545f57-24ck5:80&lt;/span&gt; (ID:17081) post-xlate-fwd TRANSLATED (TCP)</span>
<span class="c">#    Aug  9 05:38:55.628: default/curl-pod:37198 (ID:21500) -&gt; &lt;span style="color: green;"&gt;default/webpod-697b545f57-24ck5:80&lt;/span&gt; (ID:17081) to-network FORWARDED &lt;span style="color: green;"&gt;(TCP Flags: SYN)&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-w0 ë…¸ë“œì— ë°°í¬ëœ webpod íŒŒë“œ(default/webpod-697b545f57-24ck5)ë¡œ í†µì‹ ì„ ì‹œë„í•  ë•Œ,&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;    ë¼ìš°íŒ…ì´ ë˜ì§€ ì•Šì•„ SYN íŒ¨í‚·ì— ëŒ€í•œ ACK íŒ¨í‚·ì´ ì˜¤ì§€ ì•Šê¸° ë•Œë¬¸ì—, í†µì‹ ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#    Aug  9 05:38:57.528: default/curl-pod:46498 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Aug  9 05:38:57.528: default/curl-pod:46498 (ID:21500) &lt;- default/webpod-697b545f57-66grn:80 (ID:17081) to-network FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Aug  9 05:38:57.528: default/curl-pod:46498 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Aug  9 05:38:57.529: default/curl-pod:46498 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
</code></pre></div></div>

<hr />

<h2 id="overlay-network-encapsulated-mode">Overlay Network (Encapsulated) Mode</h2>

<ul>
  <li>ì•ì—ì„œ ì‚´í´ë³¸ ê²ƒê³¼ ê°™ì´ k8s-ctr ë…¸ë“œì™€ k8s-w0 ë…¸ë“œê°€ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ì— ìˆëŠ” ê²½ìš°,
ë¼ìš°íŒ… ì¥ë¹„ì—ì„œ ë¼ìš°íŒ… ë£°ì„ ì¶”ê°€í•´ì„œ ë…¸ë“œê°„ì—ëŠ” í†µì‹ ì´ ê°€ëŠ¥í•˜ì§€ë§Œ,
íŒŒë“œ ê°„ì˜ í†µì‹ ì€ ë¼ìš°íŒ… ë£°ì´ ì—†ê¸° ë•Œë¬¸ì— í†µì‹ ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
  <li>ì´ëŸ¬í•œ ê²½ìš°ì—ë„ íŒŒë“œ ê°„ì˜ í†µì‹ ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ê¸° ìœ„í•´ì„œ Ciliumì—ì„œëŠ” Overlay Network(Encapsulated) Modeë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>VXLANê³¼ GENEVE ë“±ì„ ì§€ì›í•˜ëŠ”ë°, ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” VXLANì„ í†µí•´ í†µì‹ ì´ ë˜ë„ë¡ í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="vxlan-ì„¤ì •">VXLAN ì„¤ì •</h3>

<p><a href="https://docs.cilium.io/en/stable/network/concepts/routing/">Docs</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [ì»¤ë„ êµ¬ì„± ì˜µì…˜] Requirements for Tunneling and Routing</span>
<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'CONFIG_VXLAN=y|CONFIG_VXLAN=m|CONFIG_GENEVE=y|CONFIG_GENEVE=m|CONFIG_FIB_RULES=y'</span> /boot/config-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>
<span class="nv">CONFIG_FIB_RULES</span><span class="o">=</span>y <span class="c"># ì»¤ë„ì— ë‚´ì¥ë¨</span>
<span class="nv">CONFIG_VXLAN</span><span class="o">=</span>m <span class="c"># ëª¨ë“ˆë¡œ ì»´íŒŒì¼ë¨ â†’ ì»¤ë„ì— ë¡œë“œí•´ì„œ ì‚¬ìš©</span>
<span class="nv">CONFIG_GENEVE</span><span class="o">=</span>m <span class="c"># ëª¨ë“ˆë¡œ ì»´íŒŒì¼ë¨ â†’ ì»¤ë„ì— ë¡œë“œí•´ì„œ ì‚¬ìš©</span>

<span class="c">#  ì»¤ë„ ë¡œë“œ</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span>
<span class="nv">$ </span>modprobe vxlan <span class="c"># modprobe geneve</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span>
<span class="c"># =&gt; vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  1 vxlan</span>
<span class="c">#    udp_tunnel             36864  1 vxlan</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ modprobe ëª…ë ¹ì–´ë¡œ ì»¤ë„ ëª¨ë“ˆì´ ë¡œë”© ë˜ì–´ vxlanê³¼ í•„ìš” ëª¨ë“ˆë“¤ì´ í™œì„±í™” ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>modprobe vxlan <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  1 vxlan</span>
<span class="c">#    udp_tunnel             36864  1 vxlan</span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  1 vxlan</span>
<span class="c">#    udp_tunnel             36864  1 vxlan</span>

<span class="c"># k8s-w1 ë…¸ë“œì— ë°°í¬ëœ webpod íŒŒë“œ IP ì§€ì •</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD1</span>
<span class="c"># =&gt; 172.20.1.217</span>

<span class="c"># ë°˜ë³µ ping ì‹¤í–‰í•´ë‘ê¸°</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nv">$WEBPOD1</span>


<span class="c"># ì—…ê·¸ë ˆì´ë“œ</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--version</span> 1.18.0 <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>tunnel <span class="nt">--set</span> <span class="nv">tunnelProtocol</span><span class="o">=</span>vxlan <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="c"># ì„¤ì •ì„ ì ìš©í•˜ê¸° ìœ„í•´ì„œ Cilium DaemonSetì„ ì¬ì‹œì‘í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl rollout restart <span class="nt">-n</span> kube-system ds/cilium

<span class="c"># ì„¤ì • í™•ì¸</span>
<span class="nv">$ </span>cilium features status
<span class="nv">$ </span>cilium features status | <span class="nb">grep </span>datapath_network
<span class="c"># =&gt; Cilium   Agents</span>
<span class="c">#    Uniform  Name                             Labels              k8s-ctr  k8s-w0  k8s-w1</span>
<span class="c">#    Yes      cilium_feature_datapath_network  mode=&lt;span style="color: green;"&gt;overlay-vxlan&lt;/span&gt;  1        1        1</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status | <span class="nb">grep</span> ^Routing
<span class="c"># =&gt; Routing:                 Network: &lt;span style="color: green;"&gt;Tunnel [vxlan]&lt;/span&gt;   Host: BPF</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>tunnel
<span class="c"># =&gt; routing-mode                                      &lt;span style="color: green;"&gt;tunnel&lt;/span&gt;</span>
<span class="c">#    tunnel-protocol                                   &lt;span style="color: green;"&gt;vxlan&lt;/span&gt;</span>
<span class="c">#    tunnel-source-port-range                          0-0</span>

<span class="c"># cilium_vxlan í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr show dev cilium_vxlan
<span class="c"># =&gt; 26: cilium_vxlan: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether 42:59:64:e0:f6:38 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::4059:64ff:fee0:f638/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr show dev cilium_vxlan <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    8: cilium_vxlan: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether 02:c4:af:d7:83:fc brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::c4:afff:fed7:83fc/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    8: cilium_vxlan: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether ee:f6:72:2b:b9:b9 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::ecf6:72ff:fe2b:b9b9/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># ë¼ìš°íŒ… ì •ë³´ í™•ì¸ : k8s node ê°„ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì— ìˆë”ë¼ë„, íŒŒë“œì˜ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ì •ë³´ê°€ ë¼ìš°íŒ…ì— ì˜¬ë¼ì™”ë‹¤!</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>cilium_host
<span class="c"># =&gt; 172.20.0.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201</span>
<span class="c">#    172.20.0.201 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.1.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201 mtu 1450</span>
<span class="c">#    172.20.2.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201 mtu 1450 </span>

<span class="nv">$ </span>ip route get 172.20.1.10
<span class="c"># =&gt; 172.20.1.10 dev cilium_host src 172.20.0.201 uid 0</span>
<span class="c">#        cache mtu 1450</span>
<span class="nv">$ </span>ip route get 172.20.2.10
<span class="c"># =&gt; 172.20.2.10 dev cilium_host src 172.20.0.201 uid 0</span>
<span class="c">#        cache mtu 1450</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ MTUëŠ” Maximum Transmission Unitì˜ ì•½ìë¡œ, ë„¤íŠ¸ì›Œí¬ì—ì„œ ì „ì†¡í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ íŒ¨í‚· í¬ê¸°ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ë³¸ë˜ì˜ MTUëŠ” 1500ì´ì§€ë§Œ, VXLANì´ ì´ë¯¸ 50 bytesë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ìµœëŒ€ 1450 bytesê¹Œì§€ ì „ì†¡í•  ìˆ˜ ìˆëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route | <span class="nb">grep </span>cilium_host <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    172.20.0.0/24 via 172.20.1.197 dev cilium_host proto kernel src 172.20.1.197 mtu 1450</span>
<span class="c">#    172.20.1.0/24 via 172.20.1.197 dev cilium_host proto kernel src 172.20.1.197</span>
<span class="c">#    172.20.1.197 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.2.0/24 via 172.20.1.197 dev cilium_host proto kernel src 172.20.1.197 mtu 1450</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    172.20.0.0/24 via 172.20.2.25 dev cilium_host proto kernel src 172.20.2.25 mtu 1450</span>
<span class="c">#    172.20.1.0/24 via 172.20.2.25 dev cilium_host proto kernel src 172.20.2.25 mtu 1450</span>
<span class="c">#    172.20.2.0/24 via 172.20.2.25 dev cilium_host proto kernel src 172.20.2.25</span>
<span class="c">#    172.20.2.25 dev cilium_host proto kernel scope link</span>

<span class="c"># cilium íŒŒë“œ ì´ë¦„ ì§€ì •</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-ctr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w0  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CILIUMPOD0</span> <span class="nv">$CILIUMPOD1</span> <span class="nv">$CILIUMPOD2</span>
<span class="c"># =&gt; cilium-4jf9p cilium-dqgbw cilium-sqx45</span>

<span class="c"># router ì—­í•  IP í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CILIUMPOD0</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium status <span class="nt">--all-addresses</span> | <span class="nb">grep </span>router
<span class="c"># =&gt;   172.20.0.201 (router)</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CILIUMPOD1</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium status <span class="nt">--all-addresses</span> | <span class="nb">grep </span>router
<span class="c"># =&gt;   172.20.1.197 (router)</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CILIUMPOD2</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium status <span class="nt">--all-addresses</span> | <span class="nb">grep </span>router
<span class="c"># =&gt;   172.20.2.25 (router)</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf ipcache list
<span class="c"># =&gt; IP PREFIX/ADDRESS   IDENTITY</span>
<span class="c">#    ...</span>
<span class="c">#    172.20.0.201/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel</span>
<span class="c">#    172.20.2.25/32      identity=6 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel</span>
<span class="c">#    172.20.1.197/32     identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=&lt;none&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD0</span> <span class="nt">--</span> cilium-dbg bpf ipcache list
<span class="c"># =&gt; IP PREFIX/ADDRESS   IDENTITY</span>
<span class="c">#    ...</span>
<span class="c">#    172.20.0.201/32     identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=&lt;none&gt;</span>
<span class="c">#    172.20.2.25/32      identity=6 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel</span>
<span class="c">#    172.20.1.197/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.101 flags=hastunnel</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD1</span> <span class="nt">--</span> cilium-dbg bpf ipcache list
<span class="c"># =&gt; IP PREFIX/ADDRESS   IDENTITY</span>
<span class="c">#    ...</span>
<span class="c">#    172.20.1.197/32     identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=&lt;none&gt;</span>
<span class="c">#    172.20.0.201/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel</span>
<span class="c">#    172.20.2.25/32      identity=6 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD2</span> <span class="nt">--</span> cilium-dbg bpf ipcache list
<span class="c"># =&gt; IP PREFIX/ADDRESS   IDENTITY</span>
<span class="c">#    ...</span>
<span class="c">#    172.20.0.201/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel</span>
<span class="c">#    172.20.2.25/32      identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=&lt;none&gt;</span>
<span class="c">#    172.20.1.197/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.101 flags=hastunnel</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf socknat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD0</span> <span class="nt">--</span> cilium-dbg bpf socknat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD1</span> <span class="nt">--</span> cilium-dbg bpf socknat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD2</span> <span class="nt">--</span> cilium-dbg bpf socknat list
</code></pre></div></div>

<h3 id="íŒŒë“œê°„-í†µì‹ -í™•ì¸">íŒŒë“œê°„ í†µì‹  í™•ì¸</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; ---</span>
<span class="c">#    Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-24ck5  # &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-w0 ë…¸ë“œì— ë°°í¬ëœ webpod íŒŒë“œì— ëŒ€í•´ì„œë„ í†µì‹ ì´ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-66grn</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ VXLAN ì„¤ì • í›„ ì´ì „ì—ëŠ” í†µì‹ ì´ ë˜ì§€ ì•Šë˜ k8s-w0 ë…¸ë“œì— ë°°í¬ëœ webpod íŒŒë“œì— ëŒ€í•´ì„œë„ í†µì‹ ì´ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># k8s-w0 ë…¸ë“œì— ë°°í¬ëœ webpod íŒŒë“œ IP ì§€ì •</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPOD</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w0 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; 172.20.2.73</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 8472 <span class="nt">-nn</span>

<span class="c"># [k8s-ctr] ì—ì„œ ping ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; PING 172.20.2.73 (172.20.2.73) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.20.2.73: icmp_seq=1 ttl=63 time=1.77 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.20.2.73 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.769/1.769/1.769/0.000 ms</span>
<span class="c">#    command terminated with exit code 1</span>

<span class="c"># [router]ì—ì„œ tcpdump í™•ì¸ (VXLAN í¬íŠ¸ 8472/udpë¡œ í†µì‹ ì´ ë˜ëŠ”ì§€ í™•ì¸)</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 8472 <span class="nt">-nn</span>
<span class="c"># =&gt; 16:17:25.514596 eth1  In  IP 192.168.10.100.56046 &gt; 192.168.20.100.8472: OTV, flags [I] (0x08), overlay 0, instance 21500</span>
<span class="c">#    IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 11684, seq 1, length 64</span>
<span class="c">#    16:17:25.514636 eth2  Out IP 192.168.10.100.56046 &gt; 192.168.20.100.8472: OTV, flags [I] (0x08), overlay 0, instance 21500</span>
<span class="c">#    IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 11684, seq 1, length 64</span>
<span class="c">#    16:17:25.515307 eth2  In  IP 192.168.20.100.59302 &gt; 192.168.10.100.8472: OTV, flags [I] (0x08), overlay 0, instance 17081</span>
<span class="c">#    IP 172.20.2.73 &gt; 172.20.0.89: ICMP echo reply, id 11684, seq 1, length 64</span>
<span class="c">#    16:17:25.515315 eth1  Out IP &lt;span style="color: green;"&gt;192.168.20.100.59302 &gt; 192.168.10.100.8472&lt;/span&gt;: OTV, flags [I] (0x08), overlay 0, instance 17081</span>
<span class="c">#    IP &lt;span style="color: green;"&gt;172.20.2.73 &gt; 172.20.0.89&lt;/span&gt;: ICMP echo reply, id 11684, seq 1, length 64</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ VXLANì„ í†µí•´ íŒŒë“œ IPê°„ í†µì‹ ì´ ë…¸ë“œê°„ IPë¡œ ìº¡ìŠí™”ë˜ì–´ í†µì‹ ì´ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [router] : ë¼ìš°íŒ…ì´ ì–´ë–»ê²Œ ë˜ëŠ”ê°€?</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>
<span class="c"># =&gt; (ì—†ìŒ)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ VXLANì„ í†µí•´ ìº¡ìŠí™”ëœ íŒ¨í‚·ìœ¼ë¡œ í†µì‹ ì´ ë˜ê¸° ë•Œë¬¸ì— ì§ì ‘ì ìœ¼ë¡œ ICMP(ping) íŒ¨í‚·ì€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë°˜ë³µ ì ‘ì†</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 8472 <span class="nt">-w</span> /tmp/vxlan.pcap
<span class="nv">$ </span>tshark <span class="nt">-r</span> /tmp/vxlan.pcap <span class="nt">-d</span> udp.port<span class="o">==</span>8472,vxlan
<span class="c"># =&gt;     1   0.000000  172.20.0.89 â†’ 172.20.2.73  TCP 130 53224 â†’ 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2585589520 TSecr=0 WS=128</span>
<span class="c">#        2   0.000015  172.20.0.89 â†’ 172.20.2.73  TCP 130 [TCP Retransmission] 53224 â†’ 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2585589520 TSecr=0 WS=128</span>
<span class="c">#        3   0.000633  172.20.2.73 â†’ 172.20.0.89  TCP 130 80 â†’ 53224 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3020660677 TSecr=2585589520 WS=128</span>
<span class="c">#        4   0.000637  172.20.2.73 â†’ 172.20.0.89  TCP 130 [TCP Retransmission] 80 â†’ 53224 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3020660677 TSecr=2585589520 WS=128</span>
<span class="c">#        5   0.001244  172.20.0.89 â†’ 172.20.2.73  TCP 122 53224 â†’ 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2585589521 TSecr=3020660677</span>
<span class="c">#        6   0.001245  172.20.0.89 â†’ 172.20.2.73  TCP 122 [TCP Dup ACK 5#1] 53224 â†’ 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2585589521 TSecr=3020660677</span>
<span class="c">#        7   0.002239  172.20.0.89 â†’ 172.20.2.73  HTTP 192 GET / HTTP/1.1</span>
<span class="c">#        8   0.002247  172.20.0.89 â†’ 172.20.2.73  TCP 192 [TCP Retransmission] 53224 â†’ 80 [PSH, ACK] Seq=1 Ack=1 Win=64896 Len=70 TSval=2585589522 TSecr=3020660677</span>
<span class="c">#        9   0.002625  172.20.2.73 â†’ 172.20.0.89  TCP 122 80 â†’ 53224 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3020660679 TSecr=2585589522</span>
<span class="c">#       10   0.002628  172.20.2.73 â†’ 172.20.0.89  TCP 122 [TCP Dup ACK 9#1] 80 â†’ 53224 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3020660679 TSecr=2585589522</span>
<span class="c">#       11   0.004215  172.20.2.73 â†’ 172.20.0.89  HTTP 441 HTTP/1.1 200 OK  (text/plain)</span>
<span class="c">#       12   0.004221  172.20.2.73 â†’ 172.20.0.89  TCP 441 [TCP Retransmission] 80 â†’ 53224 [PSH, ACK] Seq=1 Ack=71 Win=64256 Len=319 TSval=3020660680 TSecr=2585589522</span>
<span class="c">#       13   0.004783  172.20.0.89 â†’ 172.20.2.73  TCP 122 53224 â†’ 80 [ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2585589525 TSecr=3020660680</span>
<span class="c">#       14   0.004785  172.20.0.89 â†’ 172.20.2.73  TCP 122 [TCP Dup ACK 13#1] 53224 â†’ 80 [ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2585589525 TSecr=3020660680</span>
<span class="c">#       15   0.005245  172.20.0.89 â†’ 172.20.2.73  TCP 122 53224 â†’ 80 [FIN, ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2585589525 TSecr=3020660680</span>
<span class="c">#       16   0.005248  172.20.0.89 â†’ 172.20.2.73  TCP 122 [TCP Retransmission] 53224 â†’ 80 [FIN, ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2585589525 TSecr=3020660680</span>
<span class="c">#       17   0.005631  172.20.2.73 â†’ 172.20.0.89  TCP 122 80 â†’ 53224 [FIN, ACK] Seq=320 Ack=72 Win=64256 Len=0 TSval=3020660682 TSecr=2585589525</span>
<span class="c">#       18   0.005633  172.20.2.73 â†’ 172.20.0.89  TCP 122 [TCP Retransmission] 80 â†’ 53224 [FIN, ACK] Seq=320 Ack=72 Win=64256 Len=0 TSval=3020660682 TSecr=2585589525</span>
<span class="c">#       19   0.006526  172.20.0.89 â†’ 172.20.2.73  TCP 122 53224 â†’ 80 [ACK] Seq=72 Ack=321 Win=64640 Len=0 TSval=2585589526 TSecr=3020660682</span>
<span class="c">#       20   0.006529  172.20.0.89 â†’ 172.20.2.73  TCP 122 [TCP Dup ACK 19#1] 53224 â†’ 80 [ACK] Seq=72 Ack=321 Win=64640 Len=0 TSval=2585589526 TSecr=3020660682</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ tsharkë¡œë„ VXLAN ìº¡ìŠí™”ëœ íŒ¨í‚·ì„ í•´ì„í•  ìˆ˜ ìˆì§€ë§Œ ì¡°ê¸ˆ ë” ì›í™œí•œ í•´ì„ì„ ìœ„í•´ì„œ termsharkë¥¼ ì‚¬ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>termshark <span class="nt">-r</span> /tmp/vxlan.pcap
<span class="c"># =&gt; termshark 2.4.0  |  vxlan.pcap                                                         Analysis    Misc</span>
<span class="c">#    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“</span>
<span class="c">#    â”ƒFilter:                                                                               &lt;Apply&gt; &lt;Recent&gt; â”ƒ</span>
<span class="c">#    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›</span>
<span class="c">#     No. -  Time -      Source -           Dest -             Proto -  Length -  Info -                     â–²</span>
<span class="c">#     2      0.000015    192.168.10.100     192.168.20.100     UDP      130       56560 â†’ 8472 Len=82</span>
<span class="c">#     3      0.000633    192.168.20.100     192.168.10.100     UDP      130       38192 â†’ 8472 Len=82        â–ˆ</span>
<span class="c">#     4      0.000637    192.168.20.100     192.168.10.100     UDP      130       38192 â†’ 8472 Len=82</span>
<span class="c">#     5      0.001244    192.168.10.100     192.168.20.100     UDP      122       56560 â†’ 8472 Len=74</span>
<span class="c">#     6      0.001245    192.168.10.100     192.168.20.100     UDP      122       56560 â†’ 8472 Len=74</span>
<span class="c">#     7      0.002239    192.168.10.100     192.168.20.100     UDP      192       56560 â†’ 8472 Len=144       â–¼</span>
<span class="c">#    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>
<span class="c">#    [+] Frame 2: 130 bytes on wire (1040 bits), 130 bytes captured (1040 bits) [=]</span>
<span class="c">#    [+] Linux cooked capture v2</span>
<span class="c">#    [+] Internet Protocol Version 4, Src: 192.168.10.100, Dst: 192.168.20.100</span>
<span class="c">#    [+] User Datagram Protocol, Src Port: 56560, Dst Port: 8472</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê¸°ë³¸ termshark ëª…ë ¹ì–´ë¡œëŠ” VXLAN ìº¡ìŠí™”ëœ íŒ¨í‚·ì„ í•´ì„í•  ìˆ˜ ì—†ì–´ì„œ 8472/udpë¡œ ìº¡ìŠí™”ëœ íŒ¨í‚·ì´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>termshark <span class="nt">-r</span> /tmp/vxlan.pcap <span class="nt">-d</span> udp.port<span class="o">==</span>8472,vxlan
<span class="c"># =&gt; termshark 2.4.0  |  vxlan.pcap                                                         Analysis    Misc</span>
<span class="c">#    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“</span>
<span class="c">#    â”ƒFilter:                                                                               &lt;Apply&gt; &lt;Recent&gt; â”ƒ</span>
<span class="c">#    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›</span>
<span class="c">#     No. Time - Source - Dest -   Prot Lengt Info -                                                         â–²</span>
<span class="c">#     1   0.0000 172.20.0 172.20.2 TCP  130   53224 â†’ 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSva</span>
<span class="c">#     2   0.0000 172.20.0 172.20.2 TCP  130   [TCP Retransmission] 53224 â†’ 80 [SYN] Seq=0 Win=64860 Len=0 MS â–ˆ</span>
<span class="c">#     3   0.0006 172.20.2 172.20.0 TCP  130   80 â†’ 53224 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SAC</span>
<span class="c">#     4   0.0006 172.20.2 172.20.0 TCP  130   [TCP Retransmission] 80 â†’ 53224 [SYN, ACK] Seq=0 Ack=1 Win=643</span>
<span class="c">#     5   0.0012 172.20.0 172.20.2 TCP  122   53224 â†’ 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2585589521</span>
<span class="c">#     6   0.0012 172.20.0 172.20.2 TCP  122   [TCP Dup ACK 5#1] 53224 â†’ 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0</span>
<span class="c">#     7   0.0022 172.20.0 172.20.2 HTTP 192   GET / HTTP/1.1</span>
<span class="c">#     8   0.0022 172.20.0 172.20.2 TCP  192   [TCP Retransmission] 53224 â†’ 80 [PSH, ACK] Seq=1 Ack=1 Win=648</span>
<span class="c">#     9   0.0026 172.20.2 172.20.0 TCP  122   80 â†’ 53224 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3020660679</span>
<span class="c">#     10  0.0026 172.20.2 172.20.0 TCP  122   [TCP Dup ACK 9#1] 80 â†’ 53224 [ACK] Seq=1 Ack=71 Win=64256 Len=</span>
<span class="c">#     11  0.0042 172.20.2 172.20.0 HTTP 441   HTTP/1.1 200 OK  (text/plain)                                  â–¼</span>
<span class="c">#    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>
<span class="c">#    [+] Frame 7: 192 bytes on wire (1536 bits), 192 bytes captured (1536 bits)</span>
<span class="c">#    [+] Linux cooked capture v2 [=]</span>
<span class="c">#    [+] Internet Protocol Version 4, &lt;span style="color: green; border: 2px solid rgba(255, 0, 0, 0.5); padding: 1px 4px;"&gt;Src: 192.168.10.100, Dst: 192.168.20.100&lt;/span&gt;</span>
<span class="c">#    [+] User Datagram Protocol, Src Port: 56560, Dst Port: 8472</span>
<span class="c">#    [+] &lt;span style="color: green; border: 2px solid rgba(255, 0, 0, 0.5); padding: 1px 4px;"&gt;Virtual eXtensible Local Area Network&lt;/span&gt;</span>
<span class="c">#    [+] Ethernet II, Src: 46:02:28:c8:e7:b6 (46:02:28:c8:e7:b6), Dst: ca:7a:5c:b2:2c:4a (ca:7a:5c:b2:2c:4a)</span>
<span class="c">#    [+] Internet Protocol Version 4, Src: &lt;span style="color: green; border: 2px solid rgba(255, 0, 0, 0.5); padding: 1px 4px;"&gt;172.20.0.89, Dst: 172.20.2.73&lt;/span&gt;</span>
<span class="c">#    [+] Transmission Control Protocol, Src Port: 53224, Dst Port: 80, Seq: 1, Ack: 1, Len: 70</span>
<span class="c">#    [-] Hypertext Transfer Protocol</span>
<span class="c">#      [+] GET / HTTP/1.1</span>
<span class="c">#          Host: webpod</span>
<span class="c">#          User-Agent: curl/8.14.1</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ -d udp.port==8472,vxlan ì˜µì…˜ì„ í†µí•´ VXLAN ìº¡ìŠí™”ëœ íŒ¨í‚·ì„ í•´ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [k8s-ctr] hubble flow log ëª¨ë‹ˆí„°ë§ : overlay í†µì‹  ëª¨ë“œ í™•ì¸!</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--pod</span> curl-pod
<span class="c"># =&gt; ...</span>
<span class="c">#    Aug  9 07:34:42.262: default/curl-pod:37272 (ID:21500) -&gt; default/webpod-697b545f57-24ck5:80 (ID:17081) &lt;span style="color: green;"&gt;to-overlay FORWARDED&lt;/span&gt; (TCP Flags: SYN)</span>
<span class="c">#    Aug  9 07:34:42.263: default/curl-pod:37272 (ID:21500) &lt;- default/webpod-697b545f57-24ck5:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Aug  9 07:34:42.263: default/curl-pod:37272 (ID:21500) -&gt; default/webpod-697b545f57-24ck5:80 (ID:17081) &lt;span style="color: green;"&gt;to-overlay FORWARDED&lt;/span&gt; (TCP Flags: ACK)</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w4/20250810_cilium_w4_3.png" alt="img.png" class="image-center" />
<em class="image-caption">íŒŒë“œì—ì„œ ë‚˜ê°ˆë•Œ íŒ¨í‚· íë¦„</em></p>

<p><img src="/assets/2025/cilium/w4/20250810_cilium_w4_4.png" alt="img_1.png" class="image-center" />
<em class="image-caption">íŒŒë“œë¡œ ì¸ì…ì‹œ íŒ¨í‚· íë¦„</em></p>

<ul>
  <li>ì´ìƒê³¼ ê°™ì´ VXLANì„ í†µí•´ì„œ íŒŒë“œê°„ í†µì‹ ì´ ê°€ëŠ¥í•´ì¡ŒìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ VXLAN ë“±ì˜ ìº¡ìŠí™” ê¸°ìˆ ì„ ì‚¬ìš©í•˜ê²Œ ë˜ë©´, ë‹¤ìŒì˜ ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>50 bytesì˜ ìº¡ìŠí™” ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí•©ë‹ˆë‹¤. (MTU ê°ì†Œ ë° ê·¸ë¡œì¸í•œ íŒ¨í‚· fragmentation ë°œìƒ ê°€ëŠ¥ì„±)</li>
      <li>ìº¡ìŠí™” ë° ë””ìº¡ìŠí™” ê³¼ì •ì—ì„œ CPU ë¦¬ì†ŒìŠ¤ê°€ ì†Œëª¨ë©ë‹ˆë‹¤.</li>
      <li>ê°™ì€ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì— ìˆë”ë¼ë„ VXLANì„ í†µí•´ ìº¡ìŠí™” ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>VXLANì€ ë³„ë„ì˜ ë„¤íŠ¸ì›Œí¬ ì„¤ì • ì—†ì´ ë…¸ë“œê°„ í†µì‹ ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì¥ì ì´ ìˆì§€ë§Œ, ìœ„ì™€ ê°™ì€ ë¬¸ì œë“¤ë¡œ ì¸í”„ë¼ì ì¸ ì§€ì›ì´ ê°€ëŠ¥í•˜ë‹¤ë©´ Native Routingì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</li>
  <li>MTU(Maximum Transmission Unit)ëŠ” ë„¤íŠ¸ì›Œí¬ì—ì„œ ì „ì†¡í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ íŒ¨í‚· í¬ê¸°ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. VXLANì„ ì‚¬ìš©í•˜ë©´ MTUê°€ ê°ì†Œí•˜ê²Œ ë˜ë©°, ì´ëŠ” íŒ¨í‚·ì´ ë¶„í• (fragmentation)ë˜ì–´ ì „ì†¡ë  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ë”°ë¼ì„œ, VXLANì„ ì‚¬ìš©í•  ë•ŒëŠ” MTU ì„¤ì •ì„ ì£¼ì˜ ê¹Šê²Œ ê´€ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>MTUì— ëŒ€í•œ ê°„ë‹¨í•œ ì‹¤í—˜ì„ í•˜ê³  ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># -M do : Don't Fragment (DF) í”Œë˜ê·¸ë¥¼ ì„¤ì •í•˜ì—¬ ì¡°ê°í™” ë°©ì§€</span>
<span class="c"># -s 1472 : í˜ì´ë¡œë“œ(payload) í¬ê¸°, ì¦‰ ICMP ë°ì´í„° í¬ê¸°</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nt">-M</span> <span class="k">do</span> <span class="nt">-s</span> 1472 <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; PING 172.20.2.73 (172.20.2.73) 1472(1500) bytes of data.</span>
<span class="c">#    ping: sendmsg: Message too large</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ping ëª…ë ¹ì–´ë¥¼ í†µí•´ VXLAN ì— ì˜í•œ MTU (1450 bytes)ë³´ë‹¤ í° 1500 bytesë¥¼ ê°•ì œë¡œ ì „ì†¡í•˜ë©´ &lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   "ping: sendmsg: Message too large" ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ì¦‰, MTUë³´ë‹¤ í° íŒ¨í‚·ì€ ì „ì†¡í•  ìˆ˜ ì—†ìŒì„ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°, MTU ë‹¨ìœ„ë¡œ íŒ¨í‚·ì´ ë¶„í• (fragmentation)ë˜ì–´ ì „ì†¡ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="ë„ì „ê³¼ì œ2-vxlan-ëŒ€ì‹ -geneve-ëª¨ë“œ-ì‚¬ìš©"><code class="language-plaintext highlighter-rouge">ë„ì „ê³¼ì œ2.</code> VXLAN ëŒ€ì‹  GENEVE ëª¨ë“œ ì‚¬ìš©</h3>

<ul>
  <li>Ciliumì€ VXLAN ì™¸ì—ë„ GENEVE ëª¨ë“œë¥¼ ì§€ì›í•©ë‹ˆë‹¤. GENEVEëŠ” VXLANë³´ë‹¤ ë” ìœ ì—°í•˜ê³  í™•ì¥ ê°€ëŠ¥í•œ ìº¡ìŠí™” í”„ë¡œí† ì½œì…ë‹ˆë‹¤.</li>
</ul>

<h4 id="geneve-ì†Œê°œ">GENEVE ì†Œê°œ</h4>

<ul>
  <li>GENEVE(Generic Network Virtualization Encapsulation)ëŠ” VXLAN/NVGRE ë“±ê³¼ ìœ ì‚¬í•œ ë„¤íŠ¸ì›Œí¬ ê°€ìƒí™” ìº¡ìŠí™” í”„ë¡œí† ì½œë¡œ ì¢€ ë” ë°œì „ëœ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>ì£¼ìš” íŠ¹ì§•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_17.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">Geneve í—¤ë” êµ¬ì¡° - <a href="https://www.redhat.com/en/blog/what-geneve">ì¶œì²˜</a></em>
    <ul>
      <li><strong>í™•ì¥ì„± ë†’ì€ ì˜µì…˜ í•„ë“œ(TLV:Type-Length-Value)</strong> : ê³ ì • í—¤ë” êµ¬ì¡°ì—ì„œ ë²—ì–´ë‚˜  ìœ ë™ì ìœ¼ë¡œ ë‹¤ì–‘í•œ ì˜µì…˜ì„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ ë‹¤ì–‘í•œ í™˜ê²½ê³¼ ìš”êµ¬ì‚¬í•­ì— ë§ëŠ” ë°œì „ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ë‹¨, ëŠ˜ì–´ë‚œ í—¤ë” í¬ê¸°ê°€ ì˜¤ë²„í—¤ë“œë¡œ ì‘ìš©í•©ë‹ˆë‹¤.)</li>
      <li><strong>UDP ê¸°ë°˜ ì²˜ë¦¬</strong> : VXLANê³¼ ë§ˆì°¬ê°€ì§€ë¡œ UDP 6081 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©°, í•˜ë“œì›¨ì–´Â·ì†Œí”„íŠ¸ì›¨ì–´ì—ì„œ í˜¸í™˜ì„±ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.</li>
      <li><strong>í‘œì¤€í™”ëœ í”„ë¡œí† ì½œ</strong> : Cisco ì£¼ë„ë¡œ ë§Œë“¤ì–´ì§„ VXLANê³¼ ë‹¬ë¦¬, ì²˜ìŒë¶€í„° IETFì—ì„œ <strong>ë²”ëŒí•˜ëŠ” ìº¡ìŠí™” í”„ë¡œí† ì½œì„ í†µí•©í•  ëª©ì ìœ¼ë¡œ ë§Œë“ </strong> í”„ë¡œí† ì½œë¡œ, ë” ë„ë¦¬ ì±„íƒë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.</li>
      <li><strong>í™•ì¥ ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤</strong> : ì •ì±…, ì „ì†¡ ë³´ì•ˆ, ì„œë¹„ìŠ¤ ì²´ì´ë‹ ë“± ë‹¤ì–‘í•œ ì„œë¹„ìŠ¤ì— ëŒ€í•œ í™•ì¥ì„±ì„ ì œê³µí•˜ë©°, SDN(Software Defined Networking) í™˜ê²½ì—ì„œ ìœ ìš©í•©ë‹ˆë‹¤.</li>
      <li><strong>í•˜ë“œì›¨ì–´ ì˜¤í”„ë¡œë“œ</strong> : VXLANë„ NIC ì˜¤í”„ë¡œë“œë¥¼ ì§€ì›í•˜ì§€ë§Œ, GeneveëŠ” ì„¤ê³„ì‹œ ë¶€í„° í•˜ë“œì›¨ì–´ ì˜¤í”„ë¡œë“œë¥¼ ê³ ë ¤í•˜ì—¬ ì„¤ê³„ë˜ì–´, ì„±ëŠ¥ì´ í–¥ìƒë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h4 id="geneve-ì‹¤ìŠµ">GENEVE ì‹¤ìŠµ</h4>

<ul>
  <li>ì‹¤ìŠµì„ í†µí•´ GENEVE ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒë“œ ê°„ í†µì‹ ì„ ì„¤ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="geneve-ëª¨ë“œ-ì„¤ì •">GENEVE ëª¨ë“œ ì„¤ì •</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># GENEVE ì»¤ë„ ëª¨ë“ˆ ë¡œë“œ</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span>
<span class="c"># =&gt; vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  1 vxlan</span>
<span class="c">#    udp_tunnel             36864  1 vxlan</span>
<span class="nv">$ </span>modprobe geneve
<span class="nv">$ </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span>
<span class="c"># =&gt; &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve                 45056  0&lt;/span&gt;</span>
<span class="c">#    vxlan                 147456  0</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>modprobe geneve <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve                 45056  0&lt;/span&gt;</span>
<span class="c">#    vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  2 &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve&lt;/span&gt;,vxlan</span>
<span class="c">#    udp_tunnel             36864  2 &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve&lt;/span&gt;,vxlan</span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve                 45056  0&lt;/span&gt;</span>
<span class="c">#    vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  2 &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve&lt;/span&gt;,vxlan</span>
<span class="c">#    udp_tunnel             36864  2 &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve&lt;/span&gt;,vxlan</span>

<span class="c"># k8s-w1 ë…¸ë“œì— ë°°í¬ëœ webpod íŒŒë“œ IP ì§€ì •</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD1</span>
<span class="c"># =&gt; 172.20.1.198</span>

<span class="c"># ë°˜ë³µ ping ì‹¤í–‰í•´ë‘ê¸°</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nv">$WEBPOD1</span>


<span class="c"># ì—…ê·¸ë ˆì´ë“œ</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--version</span> 1.18.0 <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>tunnel <span class="nt">--set</span> <span class="nv">tunnelProtocol</span><span class="o">=</span>geneve <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="c"># ì„¤ì •ì„ ì ìš©í•˜ê¸° ìœ„í•´ì„œ Cilium DaemonSetì„ ì¬ì‹œì‘í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl rollout restart <span class="nt">-n</span> kube-system ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># ì„¤ì • í™•ì¸</span>
<span class="nv">$ </span>cilium features status
<span class="nv">$ </span>cilium features status | <span class="nb">grep </span>datapath_network
<span class="c"># =&gt; Cilium   Agents</span>
<span class="c">#    Uniform  Name                             Labels              k8s-ctr  k8s-w0  k8s-w1</span>
<span class="c">#    Yes      cilium_feature_datapath_network                                         mode=&lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;overlay-geneve&lt;/span&gt;                               1        1       1</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status | <span class="nb">grep</span> ^Routing
<span class="c"># =&gt; Routing:                 Network: &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;Tunnel [geneve]&lt;/span&gt;   Host: BPF</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>tunnel
<span class="c"># =&gt; routing-mode                                      tunnel</span>
<span class="c">#    tunnel-protocol                                   geneve</span>
<span class="c">#    tunnel-source-port-range                          0-0</span>

<span class="c"># cilium_geneve í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr show dev cilium_geneve
<span class="c"># =&gt; 29: cilium_geneve: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether 9e:6f:d6:29:71:60 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::9c6f:d6ff:fe29:7160/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr show dev cilium_geneve <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    11: cilium_geneve: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether c2:bd:d4:eb:63:fd brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::c0bd:d4ff:feeb:63fd/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    11: cilium_geneve: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether 0e:fd:73:c8:6f:37 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::cfd:73ff:fec8:6f37/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># ë¼ìš°íŒ… ì •ë³´ í™•ì¸ : k8s node ê°„ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì— ìˆë”ë¼ë„, íŒŒë“œì˜ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ì •ë³´ê°€ ë¼ìš°íŒ…ì— ì˜¬ë¼ì™”ë‹¤!</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>cilium_host
<span class="c"># =&gt; 172.20.0.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201</span>
<span class="c">#    172.20.0.201 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.1.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201 mtu 1450</span>
<span class="c">#    172.20.2.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201 mtu 1450 </span>

<span class="nv">$ </span>ip route get 172.20.1.10
<span class="c"># =&gt; 172.20.1.10 dev cilium_host src 172.20.0.201 uid 0</span>
<span class="c">#        cache mtu 1450</span>
<span class="nv">$ </span>ip route get 172.20.2.10
<span class="c"># =&gt; 172.20.2.10 dev cilium_host src 172.20.0.201 uid 0</span>
<span class="c">#        cache mtu 1450</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ geneveë„ VXLANê³¼ ë§ˆì°¬ê°€ì§€ë¡œ 50 bytesì˜ ìº¡ìŠí™” ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí•˜ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>ì»¤ë„ ëª¨ë“ˆì„ ë¡œë“œí•˜ê³ , helmì„ í†µí•´ GENEVE ëª¨ë“œ ì„¤ì •ì„ ë°”ê¾¸ê³ , daemonsetì„ ì¬ì‹œì‘í•˜ëŠ”ê²ƒ ë§Œìœ¼ë¡œ 
ê°„ë‹¨í•˜ê²Œ VXLAN ëª¨ë“œì—ì„œ GENEVE ëª¨ë“œë¡œ ë³€ê²½í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
  <li>VXLAN ëª¨ë“œë¡œ ë³€ê²½í• ë•Œì™€ ë§ˆì°¬ê°€ì§€ë¡œ <strong>daemonsetì´ ì¬ì‹œì‘ ë˜ëŠ” ë™ì•ˆ íŒŒë“œê°„ í†µì‹ ì´ ì¤‘ë‹¨</strong>ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="íŒŒë“œê°„-í†µì‹ -í™•ì¸-1">íŒŒë“œê°„ í†µì‹  í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s-w0 ë…¸ë“œì— ë°°í¬ëœ webpod íŒŒë“œ IP ì§€ì •</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPOD</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w0 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; 172.20.2.73</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 8472 <span class="nt">-nn</span>

<span class="c"># [k8s-ctr] ì—ì„œ ping ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; PING 172.20.2.73 (172.20.2.73) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.20.2.73: icmp_seq=1 ttl=63 time=4.10 ms</span>
<span class="c">#    64 bytes from 172.20.2.73: icmp_seq=2 ttl=63 time=1.47 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.20.2.73 ping statistics ---</span>
<span class="c">#    2 packets transmitted, 2 received, 0% packet loss, time 1000ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.473/2.786/4.100/1.313 ms</span>

<span class="c"># [router]ì—ì„œ tcpdump í™•ì¸ (GENEVE í¬íŠ¸ 6081/udpë¡œ í†µì‹ ì´ ë˜ëŠ”ì§€ í™•ì¸)</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 6081 <span class="nt">-nn</span>
<span class="c"># =&gt; 00:17:18.537335 eth1  In  IP 192.168.10.100.54038 &gt; 192.168.20.100.6081: Geneve, Flags [none], vni 0x53fc: IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 59783, seq 1, length 64</span>
<span class="c">#    00:17:18.537385 eth2  Out IP 192.168.10.100.54038 &gt; 192.168.20.100.6081: Geneve, Flags [none], vni 0x53fc: IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 59783, seq 1, length 64</span>
<span class="c">#    00:17:18.538608 eth2  In  IP 192.168.20.100.61597 &gt; 192.168.10.100.6081: Geneve, Flags [none], vni 0x42b9: IP 172.20.2.73 &gt; 172.20.0.89: ICMP echo reply, id 59783, seq 1, length 64</span>
<span class="c">#    00:17:18.538616 eth1  Out IP &lt;span style="color: green;"&gt;192.168.20.100.61597 &gt; 192.168.10.100.6081&lt;/span&gt;: &lt;span style="color: green;"&gt;Geneve&lt;/span&gt;, Flags [none], vni 0x42b9: IP &lt;span style="color: green;"&gt;172.20.2.73 &gt; 172.20.0.89&lt;/span&gt;: ICMP echo reply, id 59783, seq 1, length 64</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ GENEVEì„ í†µí•´ íŒŒë“œ IPê°„ í†µì‹ ì´ ë…¸ë“œê°„ IPë¡œ ìº¡ìŠí™”ë˜ì–´ í†µì‹ ì´ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [router] : ë¼ìš°íŒ…ì´ ì–´ë–»ê²Œ ë˜ëŠ”ê°€?</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>
<span class="c"># =&gt; (ì—†ìŒ)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ GENEVEì„ í†µí•´ ìº¡ìŠí™”ëœ íŒ¨í‚·ìœ¼ë¡œ í†µì‹ ì´ ë˜ê¸° ë•Œë¬¸ì— ì§ì ‘ì ìœ¼ë¡œ ICMP(ping) íŒ¨í‚·ì€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë°˜ë³µ ì ‘ì†</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 6081 <span class="nt">-w</span> /tmp/geneve.pcap
<span class="nv">$ </span>tshark <span class="nt">-r</span> /tmp/geneve.pcap <span class="nt">-d</span> udp.port<span class="o">==</span>6081,geneve
<span class="c"># =&gt;     1   0.000000  172.20.0.89 â†’ 172.20.2.73  TCP 130 44270 â†’ 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2614161702 TSecr=0 WS=128</span>
<span class="c">#        2   0.000026  172.20.0.89 â†’ 172.20.2.73  TCP 130 [TCP Retransmission] 44270 â†’ 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2614161702 TSecr=0 WS=128</span>
<span class="c">#        3   0.000809  172.20.2.73 â†’ 172.20.0.89  TCP 130 80 â†’ 44270 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3049232850 TSecr=2614161702 WS=128</span>
<span class="c">#        4   0.000817  172.20.2.73 â†’ 172.20.0.89  TCP 130 [TCP Retransmission] 80 â†’ 44270 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3049232850 TSecr=2614161702 WS=128</span>
<span class="c">#        5   0.001933  172.20.0.89 â†’ 172.20.2.73  TCP 122 44270 â†’ 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2614161704 TSecr=3049232850</span>
<span class="c">#        6   0.001940  172.20.0.89 â†’ 172.20.2.73  TCP 122 [TCP Dup ACK 5#1] 44270 â†’ 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2614161704 TSecr=3049232850</span>
<span class="c">#        7   0.002279  172.20.0.89 â†’ 172.20.2.73  HTTP 192 GET / HTTP/1.1</span>
<span class="c">#        8   0.002446  172.20.0.89 â†’ 172.20.2.73  TCP 192 [TCP Retransmission] 44270 â†’ 80 [PSH, ACK] Seq=1 Ack=1 Win=64896 Len=70 TSval=2614161705 TSecr=3049232850</span>
<span class="c">#        9   0.004700  172.20.2.73 â†’ 172.20.0.89  TCP 122 80 â†’ 44270 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3049232852 TSecr=2614161705</span>
<span class="c">#       10   0.004712  172.20.2.73 â†’ 172.20.0.89  TCP 122 [TCP Dup ACK 9#1] 80 â†’ 44270 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3049232852 TSecr=2614161705</span>
<span class="c">#       11   0.005871  172.20.2.73 â†’ 172.20.0.89  HTTP 441 HTTP/1.1 200 OK  (text/plain)</span>
<span class="c">#       12   0.005874  172.20.2.73 â†’ 172.20.0.89  TCP 441 [TCP Retransmission] 80 â†’ 44270 [PSH, ACK] Seq=1 Ack=71 Win=64256 Len=319 TSval=3049232855 TSecr=2614161705</span>
<span class="c">#       13   0.006514  172.20.0.89 â†’ 172.20.2.73  TCP 122 44270 â†’ 80 [ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2614161709 TSecr=3049232855</span>
<span class="c">#       14   0.006527  172.20.0.89 â†’ 172.20.2.73  TCP 122 [TCP Dup ACK 13#1] 44270 â†’ 80 [ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2614161709 TSecr=3049232855</span>
<span class="c">#       15   0.006916  172.20.0.89 â†’ 172.20.2.73  TCP 122 44270 â†’ 80 [FIN, ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2614161709 TSecr=3049232855</span>
<span class="c">#       16   0.006922  172.20.0.89 â†’ 172.20.2.73  TCP 122 [TCP Retransmission] 44270 â†’ 80 [FIN, ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2614161709 TSecr=3049232855</span>
<span class="c">#       17   0.007468  172.20.2.73 â†’ 172.20.0.89  TCP 122 80 â†’ 44270 [FIN, ACK] Seq=320 Ack=72 Win=64256 Len=0 TSval=3049232856 TSecr=2614161709</span>
<span class="c">#       18   0.007474  172.20.2.73 â†’ 172.20.0.89  TCP 122 [TCP Retransmission] 80 â†’ 44270 [FIN, ACK] Seq=320 Ack=72 Win=64256 Len=0 TSval=3049232856 TSecr=2614161709</span>
<span class="c">#       19   0.008120  172.20.0.89 â†’ 172.20.2.73  TCP 122 44270 â†’ 80 [ACK] Seq=72 Ack=321 Win=64640 Len=0 TSval=2614161710 TSecr=3049232856</span>
<span class="c">#       20   0.008125  172.20.0.89 â†’ 172.20.2.73  TCP 122 [TCP Dup ACK 19#1] 44270 â†’ 80 [ACK] Seq=72 Ack=321 Win=64640 Len=0 TSval=2614161710 TSecr=3049232856</span>
<span class="c">#       ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ tsharkë¡œë„ GENEVE ìº¡ìŠí™”ëœ íŒ¨í‚·ì„ í•´ì„í•  ìˆ˜ ìˆì§€ë§Œ ì¡°ê¸ˆ ë” ì›í™œí•œ í•´ì„ì„ ìœ„í•´ì„œ termsharkë¥¼ ì‚¬ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>termshark <span class="nt">-r</span> /tmp/geneve.pcap <span class="nt">-d</span> udp.port<span class="o">==</span>6081,geneve
<span class="c"># =&gt; termshark 2.4.0  |  geneve.pcap                                                                                                                                  Analysis    Misc</span>
<span class="c">#    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“</span>
<span class="c">#    â”ƒFilter:                                                                                                                                                         &lt;Apply&gt; &lt;Recent&gt; â”ƒ</span>
<span class="c">#    â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›</span>
<span class="c">#     No. - Time -    Source -     Dest -       Proto - Length - Info -                                                                                                                â–²</span>
<span class="c">#     1     0.000000  172.20.0.89  172.20.2.73  TCP     130      44270 â†’ 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2614161702 TSecr=0 WS=128</span>
<span class="c">#     2     0.000026  172.20.0.89  172.20.2.73  TCP     130      [TCP Retransmission] 44270 â†’ 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2614161702 TSecr=0 WS=128</span>
<span class="c">#     3     0.000809  172.20.2.73  172.20.0.89  TCP     130      80 â†’ 44270 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3049232850 TSecr=2614161702 WS=128         â–ˆ</span>
<span class="c">#     4     0.000817  172.20.2.73  172.20.0.89  TCP     130      [TCP Retransmission] 80 â†’ 44270 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3049232850 TSecr=2614</span>
<span class="c">#     5     0.001933  172.20.0.89  172.20.2.73  TCP     122      44270 â†’ 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2614161704 TSecr=3049232850</span>
<span class="c">#     6     0.001940  172.20.0.89  172.20.2.73  TCP     122      [TCP Dup ACK 5#1] 44270 â†’ 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2614161704 TSecr=3049232850</span>
<span class="c">#     7     0.002279  172.20.0.89  172.20.2.73  HTTP    192      GET / HTTP/1.1</span>
<span class="c">#     8     0.002446  172.20.0.89  172.20.2.73  TCP     192      [TCP Retransmission] 44270 â†’ 80 [PSH, ACK] Seq=1 Ack=1 Win=64896 Len=70 TSval=2614161705 TSecr=3049232850</span>
<span class="c">#     9     0.004700  172.20.2.73  172.20.0.89  TCP     122      80 â†’ 44270 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3049232852 TSecr=2614161705</span>
<span class="c">#     10    0.004712  172.20.2.73  172.20.0.89  TCP     122      [TCP Dup ACK 9#1] 80 â†’ 44270 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3049232852 TSecr=2614161705</span>
<span class="c">#     11    0.005871  172.20.2.73  172.20.0.89  HTTP    441      HTTP/1.1 200 OK  (text/plain)                                                                                         â–¼</span>
<span class="c">#    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>
<span class="c">#    [+] Linux cooked capture v2</span>
<span class="c">#    [+] Internet Protocol Version 4, &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;Src: 192.168.10.100, Dst: 192.168.20.100&lt;/span&gt;</span>
<span class="c">#    [+] User Datagram Protocol, Src Port: 41753, Dst Port: 6081</span>
<span class="c">#    [+] &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;Generic Network Virtualization Encapsulation&lt;/span&gt;, VNI: 0x0053fc [=]</span>
<span class="c">#    [+] Ethernet II, Src: 46:02:28:c8:e7:b6 (46:02:28:c8:e7:b6), Dst: ca:7a:5c:b2:2c:4a (ca:7a:5c:b2:2c:4a)</span>
<span class="c">#    [+] Internet Protocol Version 4, Src: &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;172.20.0.89, Dst: 172.20.2.73&lt;/span&gt;</span>
<span class="c">#    [+] Transmission Control Protocol, Src Port: 44270, Dst Port: 80, Seq: 1, Ack: 1, Len: 70</span>
<span class="c">#    [-] Hypertext Transfer Protocol</span>
<span class="c">#      [+] GET / HTTP/1.1</span>
<span class="c">#          Host: webpod</span>
<span class="c">#          User-Agent: curl/8.14.1</span>
<span class="c">#          Accept: */*</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ -d udp.port==6081,geneve ì˜µì…˜ì„ í†µí•´ VXLAN ìº¡ìŠí™”ëœ íŒ¨í‚·ì„ í•´ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ [k8s-ctr] hubble flow log ëª¨ë‹ˆí„°ë§ : overlay í†µì‹  ëª¨ë“œ í™•ì¸!</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--pod</span> curl-pod
<span class="c"># =&gt; ...</span>
<span class="c">#    Aug  9 15:29:04.546: default/curl-pod:53356 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-overlay FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Aug  9 15:29:04.548: default/curl-pod:53356 (ID:21500) &lt;- default/webpod-697b545f57-66grn:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Aug  9 15:29:04.548: default/curl-pod:53356 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-overlay FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>GENEVE ëª¨ë“œë¡œ ë³€ê²½í•œ í›„ì—ë„ íŒŒë“œ ê°„ í†µì‹ ì´ ì •ìƒì ìœ¼ë¡œ ì´ë£¨ì–´ì§€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="k8s-service">K8S Service</h2>

<h3 id="í´ëŸ¬ìŠ¤í„°-ë‚´ë¶€ë¥¼-ì™¸ë¶€ì—-ë…¸ì¶œí•˜ëŠ”-ë°©ë²•ì˜-ë°œì „ë‹¨ê³„">í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ë¥¼ ì™¸ë¶€ì— ë…¸ì¶œí•˜ëŠ” ë°©ë²•ì˜ ë°œì „ë‹¨ê³„</h3>

<ol>
  <li>íŒŒë“œ ìƒì„± : K8S í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì ‘ì†
  <img src="/assets/2025/cilium/w4/20250810_cilium_w4_5.png" alt="img.png" class="image-left" /><br /></li>
  <li>ì„œë¹„ìŠ¤(<strong>Cluster</strong> Type) ì—°ê²° : K8S í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì ‘ì†
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_6.png" alt="img_1.png" class="image-left" />
    <ul>
      <li>ë™ì¼í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë‹¤ìˆ˜ì˜ íŒŒë“œì˜ ì ‘ì†ì„ ìš©ì´í•˜ê²Œ í•˜ê¸° ìœ„í•œ ì„œë¹„ìŠ¤ì— ì ‘ì†</li>
      <li><strong>ê³ ì • ì ‘ì†(í˜¸ì¶œ)</strong> ë°©ë²•ì„ ì œê³µ : í”íˆ ë§í•˜ëŠ” â€˜<strong>ê³ ì • Virtual IP</strong>â€™ ì™€ â€˜<strong>Domainì£¼ì†Œ</strong>â€™ ìƒì„±<br /><br /></li>
    </ul>
  </li>
  <li>ì„œë¹„ìŠ¤(<strong>NodePort</strong> Type) ì—°ê²° : ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ì„œ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ íŒŒë“œë¡œ ì ‘ì†
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_7.png" alt="img_2.png" class="image-left" />
    <ul>
      <li>ì„œë¹„ìŠ¤(<strong>NodePort</strong> Type)ì˜ ì¼ë¶€ ë‹¨ì ì„ ë³´ì™„í•œ ì„œë¹„ìŠ¤(<strong>LoadBalancer</strong> Type) ë„ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ol>

<h3 id="service-ì¢…ë¥˜">Service ì¢…ë¥˜</h3>

<h4 id="clusterip-íƒ€ì…">ClusterIP íƒ€ì…</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_1.png" alt="img.png" class="w-80 image-center" /></p>

<ul>
  <li>ë™ì¼í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ëŠ” ì—¬ëŸ¬ Podì— ì ‘ì†ì„ ìš©ì´í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>ClusterIPëŠ” Cluster ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©° ì™¸ë¶€ì—ì„œëŠ” ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>iptables ì˜ NAT ê¸°ëŠ¥ì„ ì´ìš©í•˜ì—¬ Podì— ì ‘ê·¼í•˜ë©°, ë™ì¼í•œ iptables ë¶„ì‚°ë£°ì„ ê° ë…¸ë“œì— ì ìš©í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="nodeport-íƒ€ì…">NodePort íƒ€ì…</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_2.png" alt="img.png" class="w-80 image-center" /></p>

<ul>
  <li>NodePortëŠ” ClusterIPì™€ ê°™ì´ Cluster ë‚´ë¶€ì—ì„œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©°, ì™¸ë¶€ì—ì„œë„ ì ‘ê·¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>NodePortë„ ClusterIPì™€ ê°™ì´ iptablesì˜ NAT ê¸°ëŠ¥ì„ ì´ìš©í•˜ì—¬ Podì— ì ‘ê·¼í•˜ë©°, ê° ë…¸ë“œì— NodePortë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.</li>
  <li>ì™¸ë¶€ì—ì„œëŠ” NodePortë¥¼ í†µí•´ ê° ë…¸ë“œì— ì ‘ê·¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="loadbalancer-íƒ€ì…">LoadBalancer íƒ€ì…</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_3.png" alt="img.png" class="w-80 image-center" /></p>

<ul>
  <li>LoadBalancerë„ ì™¸ë¶€ì—ì„œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©°, í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì—ì„œ ì œê³µí•˜ëŠ” LoadBalancerë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (AWSì˜ ê²½ìš° ELB(Elastic Load Balancer)ê°€ ì‚¬ìš©ë©ë‹ˆë‹¤.)</li>
  <li>ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œë„ MetalLBì™€ ê°™ì€ LoadBalancerë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ì„œë¹„ìŠ¤ì˜-êµ¬ì¡°">ì„œë¹„ìŠ¤ì˜ êµ¬ì¡°</h3>

<p>ì„œë¹„ìŠ¤ë¥¼ ì„ ì–¸ì‹œ <code class="language-plaintext highlighter-rouge">port</code>ì™€ <code class="language-plaintext highlighter-rouge">targetPort</code>, ê·¸ë¦¬ê³  <code class="language-plaintext highlighter-rouge">label selector</code> ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ê°ê°ì˜ ì—­í• ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">port</code> : ì„œë¹„ìŠ¤ê°€ listen í•  í¬íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">targetPort</code> : ëŒ€ìƒ íŒŒë“œì˜ portë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">label selector</code>  : ëŒ€ìƒ íŒŒë“œë¥¼ íŠ¹ì •í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_7.png" alt="img.png" /></p>

<h3 id="kube-proxy-ëª¨ë“œ">kube-proxy ëª¨ë“œ</h3>

<ul>
  <li>kube-proxyëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì„œë¹„ìŠ¤ì˜ íŠ¸ë˜í”½ì„ íŒŒë“œë¡œ ë¼ìš°íŒ…í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.</li>
  <li><strong>ì„ íƒì‚¬í•­ì´ì§€ë§Œ</strong>, ë°˜ë“œì‹œ kube-proxyë¥¼ ëŒ€ì²´í•  ìˆ˜ ìˆëŠ” ëŒ€ì•ˆì´ ë°°í¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ) cilium ë“±)</li>
  <li>kube-proxyëŠ” ì„œë¹„ìŠ¤ í†µì‹  ë™ì‘ì— ëŒ€í•œ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. ë°ëª¬ì…‹ìœ¼ë¡œ ë°°í¬ë˜ì–´ ëª¨ë“  ë…¸ë“œì— íŒŒë“œê°€ ìƒì„±ë©ë‹ˆë‹¤.</li>
  <li>kube-proxy ëª¨ë“œì˜ ì¢…ë¥˜ëŠ” userspace proxy ëª¨ë“œ, iptables proxy ëª¨ë“œ, ipvs proxy ëª¨ë“œ, nftables proxy ëª¨ë“œ ë“±ì´ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="userspace-proxy-ëª¨ë“œ-í˜„ì¬ëŠ”-ë¯¸ì‚¬ìš©">userspace proxy ëª¨ë“œ (í˜„ì¬ëŠ” ë¯¸ì‚¬ìš©)</h4>

<p><img src="/assets/2025/cilium/w4/20250810_cilium_w4_8.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">ì¶œì²˜ : <a href="https://medium.com/finda-tech/kubernetes-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A0%95%EB%A6%AC-fccd4fd0ae6">https://medium.com/finda-tech/kubernetes-ë„¤íŠ¸ì›Œí¬-ì •ë¦¬-fccd4fd0ae6</a></em></p>

<ul>
  <li>ê¸°ì´ˆì ì¸ ëª¨ë“œì´ë©° ì‚¬ìš©ì ì˜ì—­ì˜ kube-proxyë¥¼ í†µí•´ NIC1ìœ¼ë¡œ ë“¤ì–´ì˜¨ íŒ¨í‚·ì„ NIC2ë¡œ ì „ë‹¬í•˜ì—¬ ëª©ì  íŒŒë“œë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
  <li>ì´ë ‡ê²Œ í•˜ëŠ” ê³¼ì •ì—ì„œ ì»¤ë„ì˜ì—­(netfilter)ê³¼ ì‚¬ìš©ìì˜ì—­(kube-proxy)ë¥¼ ì˜¤ê°€ëŠ” ê³¼ì •ì—ì„œ ìŠ¤ìœ„ì¹­ì— ì˜í•œ ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí•˜ëŠ” ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="iptables-proxy-ëª¨ë“œ">iptables proxy ëª¨ë“œ</h4>

<p><img src="/assets/2025/cilium/w4/20250810_cilium_w4_9.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">ì¶œì²˜ : <a href="https://medium.com/finda-tech/kubernetes-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A0%95%EB%A6%AC-fccd4fd0ae6">https://medium.com/finda-tech/kubernetes-ë„¤íŠ¸ì›Œí¬-ì •ë¦¬-fccd4fd0ae6</a></em></p>

<ul>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜ì‹œ ê¸°ë³¸ ëª¨ë“œì´ë©°, userspace proxy ëª¨ë“œì™€ëŠ” ë‹¬ë¦¬ kube-proxyëŠ” íŠ¸ë˜í”½ ì „ë‹¬ì— ì§ì ‘ ê´€ì—¬í•˜ì§€ëŠ” ì•Šê³ , netfilter(iptables)ë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¸ë˜í”½ì„ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
  <li>iptables proxy ëª¨ë“œëŠ” íŠ¸ë˜í”½ ì „ë‹¬ ê³¼ì •ì—ì„œ kube-proxyë¥¼ ê²½ìœ í•˜ì§€ ì•Šê³ , ì»¤ë„ ì˜ì—­ê³¼ ì‚¬ìš©ì ì˜ì—­ ì „í™˜ì´ í•„ìš”í•˜ì§€ ì•Šì•„ì„œ, ìœ ì €ìŠ¤í˜ì´ìŠ¤ proxy ëª¨ë“œì— ë¹„í•´ ì˜¤ë²„í—¤ë“œê°€ ì¤„ì–´ë“­ë‹ˆë‹¤.</li>
  <li>ë‹¨ì ìœ¼ë¡œëŠ” iptables ê·œì¹™ì´ ë§ì•„ ì§ˆ ê²½ìš° ëª¨ë“  ê·œì¹™ í‰ê°€ í•˜ëŠ”ë° ì§€ì—°ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë˜í•œ ì¥ì• ì‹œ ëª¨ë“  ê·œì¹™ì„ í™•ì¸í•˜ê¸° ì–´ë ¤ì›Œ ì¥ì•  ì²˜ë¦¬ì— ë¶ˆë¦¬í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="ipvs-proxy-ëª¨ë“œ">ipvs proxy ëª¨ë“œ</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_10.png" alt="img.png" /></p>

<ul>
  <li>IPVS ModeëŠ” Linue Kernelì—ì„œ ì œê³µí•˜ëŠ” L4 Load Balacnerì¸ IPVSê°€ Service Proxy ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” Modeì…ë‹ˆë‹¤.</li>
  <li>Packet Load Balancing ìˆ˜í–‰ì‹œ IPVSê°€ iptablesë³´ë‹¤ ë†’ì€ ì„±ëŠ¥ì„ ë³´ì´ê¸° ë•Œë¬¸ì— IPVS ModeëŠ” iptables Modeë³´ë‹¤ ë†’ì€ ì„±ëŠ¥ì„ ë³´ì—¬ì¤€ë‹¤</li>
  <li>IPVS í”„ë¡ì‹œ ëª¨ë“œëŠ” iptables ëª¨ë“œì™€ ìœ ì‚¬í•œ netfilter hook ê¸°ëŠ¥ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ì§€ë§Œ, í•´ì‹œ í…Œì´ë¸”ì„ ê¸°ë³¸ ë°ì´í„° êµ¬ì¡°ë¡œ ì‚¬ìš©í•˜ê³  <strong>ì»¤ë„ ìŠ¤í˜ì´ìŠ¤</strong>ì—ì„œ ë™ì‘í•˜ì—¬ íš¨ìœ¨ ì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</li>
  <li>ë‹¤ë¥¸ í”„ë¡ì‹œ ëª¨ë“œì™€ ë¹„êµí–ˆì„ ë•Œ, IPVS ëª¨ë“œëŠ” ë†’ì€ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ì²˜ë¦¬ëŸ‰ë„ ì§€ì›í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="nftables-proxy-ëª¨ë“œ">nftables proxy ëª¨ë“œ</h4>
<ul>
  <li>nftables ëŠ” iptablesë¥¼ ëŒ€ì²´í•˜ê¸° ìœ„í•´ ê°œë°œëœ íŒ¨í‚· í•„í„°ë§ í”„ë ˆì„ì›Œí¬ë¡œ, iptables ë³´ë‹¤ ë” ìœ ì—°í•˜ê³  ê°•ë ¥í•œ ê·œì¹™ ì„¤ì •ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>í•˜ì§€ë§Œ ì•„ì§  ì‹¤í—˜ì ìœ¼ë¡œ ê°œë°œì¤‘ì¸ ë‹¨ê³„ë¡œ ì‹¤ë¬´ì—ì„œëŠ” ipvs proxy ëª¨ë“œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="ebpf-ëª¨ë“œ--xdp">eBPF ëª¨ë“œ + XDP</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_11.png" alt="img.png" class="w-90 image-center" /></p>

<ul>
  <li>ì•ì—ì„œ ì•Œì•„ë³´ì•˜ë˜ ëª¨ë“  ëª¨ë“œë“¤ì´ netfilter ê¸°ë°˜ì¸ë° ë°˜í•´, eBPF ëª¨ë“œ +  XDP ëŠ” netfilter ì „ ë‹¨ê³„ì—ì„œ íŠ¸ë˜í”½ ë¼ìš°íŒ…ì„ ì²˜ë¦¬í•˜ì—¬ í›¨ì”¬ íš¨ìœ¨ ì ì…ë‹ˆë‹¤. calicoë‚˜ ciliumì„ ì‚¬ìš©í•˜ì—¬ì„œ eBPF ëª¨ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="service-lb-ipam">Service LB-IPAM</h2>

<p><img src="/assets/2025/cilium/w4/20250810_cilium_w4_10.png" alt="img.png" class="image-center" />
<em class="image-caption">ì¶œì²˜ : <a href="https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/#load-balancer-ipam">https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/</a></em></p>

<ul>
  <li>LoadBalancer IP Address Management (LB IPAM) ì†Œê°œ - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/">Docs</a>, <a href="https://www.youtube.com/watch?v=amC00re6-5k">Youtube</a>
    <ul>
      <li>LB-IPAMì€ Ciliumì—ì„œ ì œê³µí•˜ëŠ” LoadBalancer IP Address Management ê¸°ëŠ¥ìœ¼ë¡œ LoadBalancer ì„œë¹„ìŠ¤ì˜ External-IP ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì€ AWS ë“±ì˜ í´ë¼ìš°ë“œ ì œê³µì—…ì²´ì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì´ì§€ë§Œ
Private Cloud í™˜ê²½ì—ì„œëŠ” K8S ìì²´ì—ì„œëŠ” ì§€ì›í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— MetalLBì™€ ê°™ì€ ì†”ë£¨ì…˜ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>Ciliumì€ LB-IPAMì„ í†µí•´ì„œ MetalLBì™€ ê°™ì€ ì†”ë£¨ì…˜ ì—†ì´ë„ LoadBalancer ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
      <li>LB-IPAMì€ <code class="language-plaintext highlighter-rouge">Cilium BGP Control Plane</code> ë° <code class="language-plaintext highlighter-rouge">L2 Announcements</code> / <code class="language-plaintext highlighter-rouge">L2 Aware LB</code> ë“±ì˜ ê¸°ëŠ¥ê³¼ í•¨ê»˜ ì‚¬ìš©ë©ë‹ˆë‹¤. LB-IPAMì´ ì„œë¹„ìŠ¤ ê°ì²´ ë° ê¸°íƒ€ ê¸°ëŠ¥ì— IPë¥¼ í• ë‹¹í•˜ê³ , <code class="language-plaintext highlighter-rouge">L2 Announcements</code>ë¥¼ í†µí•´ì„œ IPë¥¼ ë…¸ì¶œí•˜ê³ , <code class="language-plaintext highlighter-rouge">L2 Aware LB</code>ë¥¼ í†µí•´ì„œ IPë¥¼ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.</li>
      <li>LB IPAMì€ í•­ìƒ í™œì„±í™”ë˜ì–´ ìˆì§€ë§Œ íœ´ë©´ ìƒíƒœì…ë‹ˆë‹¤. ì²« ë²ˆì§¸ IP í’€ì´ í´ëŸ¬ìŠ¤í„°ì— ì¶”ê°€ë˜ë©´ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ í™œì„±í™”ë©ë‹ˆë‹¤.</li>
      <li>ê¸°ëŠ¥
        <ul>
          <li>Service Selectors - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#service-selectors">Docs</a></li>
          <li>Disabling a Pool - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#disabling-a-pool">Docs</a></li>
          <li>Service ì‚¬ìš© í™•ì¸ - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#services">Docs</a></li>
          <li>LoadBalancerClass : BGP or L2 ì§€ì • - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#loadbalancerclass">Docs</a></li>
          <li>Requesting IPs : íŠ¹ì • Serviceì— EX-IPë¥¼ ì§ì ‘ ì„¤ì • - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#loadbalancerclass">Docs</a></li>
          <li>Sharing Keys : EX-IP 1ê°œë¥¼ ê°ê¸° ë‹¤ë¥¸ Port ë¥¼ í†µí•´ì„œ ì‚¬ìš© - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#requesting-ips">Docs</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>[k8s í´ëŸ¬ìŠ¤í„° ë‚´ë¶€] webpod ì„œë¹„ìŠ¤ë¥¼ LoadBalancer Type ì„¤ì • with Cilium LB IPAM</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get CiliumLoadBalancerIPPool <span class="nt">-A</span>
<span class="c"># =&gt; No resources found</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì•„ì§ ë“±ë¡ëœ IP Poolì´ ì—†ìœ¼ë¯€ë¡œ, CiliumLoadBalancerIPPool ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># cilium ip pool ìƒì„±</span>
<span class="c"># ì¶©ëŒë‚˜ì§€ ì•ŠëŠ”ì§€ ëŒ€ì—­ í™•ì¸ í•  ê²ƒ!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"  # v1.17 : cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: "cilium-lb-ippool"
spec:
  blocks:
  - start: "192.168.10.211"
    stop:  "192.168.10.215"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumloadbalancerippool.cilium.io/cilium-lb-ippool created</span>

<span class="nv">$ </span>kubectl get CiliumLoadBalancerIPPool <span class="nt">-A</span>
<span class="c"># =&gt; NAME               DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-lb-ippool   false      False         5               13s</span>

<span class="c"># CiliumLoadBalancerIPPool ì¶•ì•½ì–´ : ippools,ippool,lbippool,lbippools</span>
<span class="nv">$ </span>kubectl api-resources | <span class="nb">grep</span> <span class="nt">-i</span> CiliumLoadBalancerIPPool
<span class="c"># =&gt; ciliumloadbalancerippools           ippools,ippool,lbippool,lbippools   cilium.io/v2                      false        CiliumLoadBalancerIPPool</span>

<span class="nv">$ </span>kubectl get ippools
<span class="c"># =&gt; NAME               DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-lb-ippool   false      False         5               101s</span>

<span class="c"># webpod ì„œë¹„ìŠ¤ë¥¼ LoadBalancer Type ë³€ê²½ ì„¤ì •</span>
<span class="nv">$ </span>kubectl patch svc webpod <span class="nt">-p</span> <span class="s1">'{"spec":{"type":"LoadBalancer"}}'</span>
<span class="c"># =&gt; service/webpod patched</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc webpod
<span class="c"># =&gt; NAME     TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)        AGE</span>
<span class="c">#    webpod   LoadBalancer   10.96.129.95   &lt;span style="color: green;"&gt;192.168.10.211&lt;/span&gt;   80:32203/TCP   3h17m</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ webpod ì„œë¹„ìŠ¤ê°€ LoadBalancer Typeìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìœ¼ë©°, EXTERNAL-IPë¡œ Cilium LB IP Poolì—ì„œ í• ë‹¹ëœ IPê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># LBIPë¡œ curl ìš”ì²­ í™•ì¸ : k8s ë…¸ë“œë“¤ì—ì„œ LB EXIPë¡œ í†µì‹  ê°€ëŠ¥!</span>
<span class="nv">$ </span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span>
<span class="c"># =&gt; 192.168.10.211</span>
<span class="nv">$ LBIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.0.131</span>
<span class="c">#    IP: fe80::48ca:7aff:fee8:da55</span>
<span class="c">#    RemoteAddr: 172.20.0.201:38068</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 192.168.10.211</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.0.131</span>
<span class="c">#    IP: fe80::48ca:7aff:fee8:da55</span>
<span class="c">#    RemoteAddr: 172.20.0.89:33706</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 192.168.10.211</span>
<span class="c">#    User-Agent: curl/8.14.1</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname   <span class="c"># ëŒ€ìƒ íŒŒë“œ ì´ë¦„ ì¶œë ¥</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr <span class="c"># ëŒ€ìƒ íŒŒë“œ ì…ì¥ì—ì„œ ì†ŒìŠ¤ IP ì¶œë ¥(Layer3)</span>
<span class="c"># =&gt; RemoteAddr: 172.20.0.89:46452</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ curl-podì˜ íŒŒë“œ IPê°€ ì†ŒìŠ¤ IPë¡œ ì¶œë ¥ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr <span class="c"># k8s-ctr ë…¸ë“œì—ì„œ curl ìš”ì²­ì‹œ ì†ŒìŠ¤ IP ì¶œë ¥</span>
<span class="c"># =&gt; RemoteAddr: 172.20.0.201:35196</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-ctr ë…¸ë“œì˜ cilium_hostì˜ IPê°€ ì¶œë ¥ë©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë°˜ë³µ ì ‘ì† : </span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      38 Hostname: webpod-697b545f57-66grn</span>
<span class="c">#         35 Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#         27 Hostname: webpod-697b545f57-24ck5</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê° ë…¸ë“œì˜ webpod íŒŒë“œë¡œ Loadbalancingì´ ì˜ ì´ë£¨ì–´ì§€ê³  ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># IP í• ë‹¹ í™•ì¸</span>
<span class="nv">$ </span>kubectl get ippools
<span class="c"># =&gt; NAME               DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-lb-ippool   false      False         4               8m</span>
<span class="nv">$ </span>kubectl get ippools <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].status.conditions[?(@.type!="cilium.io/PoolConflict")]}'</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "lastTransitionTime": "2025-08-09T08:27:06Z",</span>
<span class="c">#      "message": "5",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsTotal"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "lastTransitionTime": "2025-08-09T08:27:06Z",</span>
<span class="c">#      "message": "4",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsAvailable"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "lastTransitionTime": "2025-08-09T08:27:06Z",</span>
<span class="c">#      "message": "1",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsUsed"</span>
<span class="c">#    }</span>

<span class="nv">$ </span>kubectl get svc webpod <span class="nt">-o</span> json | jq
<span class="nv">$ </span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status}'</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "conditions": [</span>
<span class="c">#        {</span>
<span class="c">#          "lastTransitionTime": "2025-08-09T08:29:01Z",</span>
<span class="c">#          "message": "",</span>
<span class="c">#          "reason": "satisfied",</span>
<span class="c">#          "status": "True",</span>
<span class="c">#          "type": "cilium.io/IPAMRequestSatisfied"</span>
<span class="c">#        }</span>
<span class="c">#      ],</span>
<span class="c">#      "loadBalancer": {</span>
<span class="c">#        "ingress": [</span>
<span class="c">#          {</span>
<span class="c">#            "ip": "192.168.10.211",</span>
<span class="c">#            "ipMode": "VIP"</span>
<span class="c">#          }</span>
<span class="c">#        ]</span>
<span class="c">#      }</span>
<span class="c">#    }</span>
</code></pre></div></div>

<ul>
  <li>[k8s í´ëŸ¬ìŠ¤í„° ì™¸ë¶€] webpod ì„œë¹„ìŠ¤ë¥¼ LoadBalancer External IPë¡œ í˜¸ì¶œ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># router : K8S ì™¸ë¶€ì—ì„œ í†µì‹  ë¶ˆê°€! </span>
<span class="nv">$ LBIP</span><span class="o">=</span>192.168.10.211
<span class="nv">$ </span>curl <span class="nt">--connect-timeout</span> 1 <span class="nv">$LBIP</span>
<span class="c"># =&gt; curl: (28) Failed to connect to 192.168.10.211 port 80 after 1002 ms: Timeout was reached</span>
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 1
<span class="c"># =&gt; ARPING 192.168.10.211</span>
<span class="c">#    Timeout</span>
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 100000
<span class="c"># =&gt; ARPING 192.168.10.211</span>
<span class="c">#    Timeout</span>
<span class="c">#    Timeout</span>
<span class="c">#    Timeout</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œëŠ” webpod ì„œë¹„ìŠ¤ì˜ LoadBalancer External IPë¡œ í†µì‹ ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   LB External IPê°€ ì™¸ë¶€ë¡œ ê´‘ê³ (Announcement) ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<hr />

<h2 id="cilium-l2-announcement">Cilium L2 Announcement</h2>

<h3 id="ì°¸ê³ -metallb-layer2-ëª¨ë“œ">(ì°¸ê³ ) MetalLB Layer2 ëª¨ë“œ</h3>

<ul>
  <li><a href="https://metallb.universe.tf/concepts/layer2/">Docs</a></li>
  <li>MetalLBëŠ” Layer2 ëª¨ë“œì—ì„œ BGPë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ARP(IPv4) ë˜ëŠ” NDP(IPv6)ë¥¼ ì‚¬ìš©í•˜ì—¬ IP ì£¼ì†Œë¥¼ ê´‘ê³ í•©ë‹ˆë‹¤.</li>
  <li>í•˜ë‚˜ì˜ ë…¸ë“œ (Leader Node)ì—ì„œë§Œ IP ì£¼ì†Œë¥¼ ê´‘ê³ í•˜ë©°, Leader Nodeê°€ ì¥ì• ê°€ ë°œìƒí•˜ë©´ ë‹¤ë¥¸ ë…¸ë“œê°€ Leader Nodeë¡œ ìŠ¹ê²©ë˜ì–´ IP ì£¼ì†Œë¥¼ ê´‘ê³ í•©ë‹ˆë‹¤.</li>
  <li>MetalLBì˜ ì¥ì ì€ ë³„ë„ì˜ í•˜ë“œì›¨ì–´ë‚˜ ë¼ìš°íŒ… ì¥ì¹˜ê°€ ì—†ì–´ë„ ì–´ë– í•œ ì´ë”ë„· ë„¤íŠ¸ì›Œí¬ì—ì„œë„ ë™ì‘í•œë‹¤ëŠ” ì ì…ë‹ˆë‹¤.</li>
  <li>
    <p>ì•„ë˜ëŠ” MetalLB Layer2 ëª¨ë“œì—ì„œ GARP íŒ¨í‚·ì„ í†µí•´ VIP(Virtual IP : ì„œë¹„ìŠ¤ì˜ IP)ë¥¼ ê´‘ê³ í•˜ëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_11.png" alt="img.png" class="image-center w-80" />
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_12.png" alt="img_1.png" class="image-center w-80" /></p>
  </li>
  <li>MetalLB Layer 2 ëª¨ë“œì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  íŠ¸ë˜í”½ì´ Leader Nodeë¡œ ì „ë‹¬ë˜ë©°, kube-proxy ë“±ì„ í†µí•´ ê° ë…¸ë“œë¡œ íŠ¸ë˜í”½ì´ ë¶„ì‚°ë©ë‹ˆë‹¤.</li>
  <li>
    <p>ì´ë¡œ ì¸í•´ Leader Nodeì— ì¥ì• ê°€ ë°œìƒí•˜ë©´ íŠ¸ë˜í”½ì´ ì¤‘ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_13.png" alt="img_2.png" class="image-center w-80" /></p>
  </li>
  <li>Leader Nodeê°€ ì¥ì• ê°€ ë°œìƒí•˜ë©´, ë‹¤ë¥¸ ë…¸ë“œê°€ Leader Nodeë¡œ ìŠ¹ê²©ë˜ì–´ IP ì£¼ì†Œë¥¼ ê´‘ê³ í•©ë‹ˆë‹¤. 
ì´ë•Œ ìƒˆë¡œìš´ Leader Nodeê°€ IP ì£¼ì†Œë¥¼ GARPë¡œ ê´‘ê³ í•˜ê¸° ì „ì— ì¼ì • ì‹œê°„ ë™ì•ˆ íŠ¸ë˜í”½ì´ ì¤‘ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_14.png" alt="img_3.png" class="image-center w-80" /></li>
</ul>

<h3 id="cilium-layer-2-l2-announcement-using-arp">Cilium Layer 2 (L2) Announcement Using ARP</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/l2-announcements/">Docs</a></li>
  <li>L2 Announcementsì€ ë¡œì»¬ ì˜ì—­ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì„œë¹„ìŠ¤ë¥¼ ê°€ì‹œí™”í•˜ê³  ë„ë‹¬í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</li>
  <li>ì´ ê¸°ëŠ¥ì€ ì£¼ë¡œ ì‚¬ë¬´ì‹¤ì´ë‚˜ ìº í¼ìŠ¤ ë„¤íŠ¸ì›Œí¬ì™€ ê°™ì€ BGP ê¸°ë°˜ ë¼ìš°íŒ… ì—†ì´ ë„¤íŠ¸ì›Œí¬ ë‚´ì—ì„œ 
ì˜¨í”„ë ˆë¯¸ìŠ¤ ë°°í¬ë¥¼ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.</li>
  <li>ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ExternalIPs ë˜ëŠ” LoadBalancer IPì— ëŒ€í•œ ARP ì¿¼ë¦¬ì— ì‘ë‹µí•©ë‹ˆë‹¤. 
ì´ëŸ¬í•œ IPëŠ” ì—¬ëŸ¬ ë…¸ë“œì— ìˆëŠ” VIP(Virtual IP)ì´ë¯€ë¡œ ê° ì„œë¹„ìŠ¤ì— ëŒ€í•´ í•œ ë²ˆì— í•˜ë‚˜ì˜ ë…¸ë“œê°€ 
ARP ì¿¼ë¦¬ì— ì‘ë‹µí•˜ê³  MAC ì£¼ì†Œë¡œ ì‘ë‹µí•©ë‹ˆë‹¤. 
ì´ ë…¸ë“œëŠ” ì„œë¹„ìŠ¤ ë¡œë“œ ë°¸ëŸ°ì‹± ê¸°ëŠ¥ìœ¼ë¡œ ë¡œë“œ ë°¸ëŸ°ì‹±ì„ ìˆ˜í–‰í•˜ì—¬ north/south(ë‚´ë¶€&lt;=&gt;ì™¸ë¶€) ë¡œë“œ ë°¸ëŸ°ì„œ ì—­í• ì„ í•©ë‹ˆë‹¤.</li>
  <li>ì´ ê¸°ëŠ¥ì˜ ì¥ì ì€ ê° ì„œë¹„ìŠ¤ê°€ ê³ ìœ í•œ IPë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ê°€ ë™ì¼í•œ í¬íŠ¸ ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•  
ìˆ˜ ìˆë‹¤ëŠ” ì ì…ë‹ˆë‹¤. NodePortë¥¼ ì‚¬ìš©í•  ë•Œ íŠ¸ë˜í”½ì„ ë³´ë‚¼ í˜¸ìŠ¤íŠ¸ë¥¼ ê²°ì •í•˜ëŠ” ê²ƒì€ í´ë¼ì´ì–¸íŠ¸ì˜ ëª«ì´ë©°, 
ë…¸ë“œê°€ ë‹¤ìš´ë˜ë©´ IP+Port ì¡°í•©ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤. L2 Announcementsë¥¼ í†µí•´ ì„œë¹„ìŠ¤ VIPëŠ” ë‹¤ë¥¸ ë…¸ë“œë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ë©´ ê³„ì† ì‘ë™í•˜ê²Œ ë©ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_15.png" alt="img.png" class="image-center" />
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_16.png" alt="img_1.png" class="image-center" /></li>
</ul>

<h5 id="k8s-í´ëŸ¬ìŠ¤í„°-ì™¸ë¶€-webpod-ì„œë¹„ìŠ¤ë¥¼-loadbalancer-external-ipë¡œ-í˜¸ì¶œí™•ì¸">[k8s í´ëŸ¬ìŠ¤í„° ì™¸ë¶€] webpod ì„œë¹„ìŠ¤ë¥¼ LoadBalancer External IPë¡œ í˜¸ì¶œí™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§ : router VM</span>
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 100000
<span class="c"># =&gt; ARPING 192.168.10.211</span>
<span class="c">#    Timeout</span>
<span class="c">#    Timeout</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì„¤ì • ì—…ê·¸ë ˆì´ë“œ ë° CiliumL2AnnouncementPolicyì„ í†µí•´ ì •ì±… ì„¤ì • ì‹œì ë¶€í„° í†µì‹ ì´ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.211): index=0 time=1.101 msec</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.211): index=1 time=1.967 msec</span>
<span class="c">#    ...</span>

<span class="c"># ì„¤ì • ì—…ê·¸ë ˆì´ë“œ</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--version</span> 1.18.0 <span class="nt">--reuse-values</span> <span class="se">\</span>
   <span class="nt">--set</span> l2announcements.enabled<span class="o">=</span><span class="nb">true</span> 
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>

<span class="nv">$ </span>kubectl rollout restart <span class="nt">-n</span> kube-system ds/cilium
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod <span class="nt">-A</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg config <span class="nt">--all</span> | <span class="nb">grep </span>EnableL2Announcements
<span class="c"># =&gt; EnableL2Announcements             : true</span>

<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>enable-l2
<span class="c"># =&gt; enable-l2-announcements                           true</span>
<span class="c">#    enable-l2-neigh-discovery                         false</span>

<span class="c"># ì •ì±… ì„¤ì • : arp ê´‘ê³ í•˜ê²Œ ë  service ì™€ node ì§€ì •(controlplane ì œì™¸) -&gt; ì„¤ì • ì§í›„ arping í™•ì¸!</span>
<span class="c">## ì œì•½ì‚¬í•­ : L2 ARP ëª¨ë“œì—ì„œ LB IPPool ì€ ê°™ì€ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì—ì„œë§Œ ìœ íš¨. -&gt; k8s-w0 ì„ ì œì™¸í•œ ì´ìœ . í¬í•¨ ì‹œ ë¦¬ë” ë…¸ë“œ ì„ ì • ì‹œ ë™ì‘ ì‹¤íŒ¨ ìƒí™© ë°œìƒ!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2alpha1"  # not v2
kind: CiliumL2AnnouncementPolicy
metadata:
  name: policy1
spec:
  serviceSelector:
    matchLabels:
      app: webpod
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/hostname
        operator: NotIn
        values:
          - k8s-w0
  interfaces:
  - ^eth[1-9]+
  externalIPs: true
  loadBalancerIPs: true
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliuml2announcementpolicy.cilium.io/policy1 created</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì •ì±… ì„¤ì • í›„ ë¶€í„° arpingì´ ì„±ê³µí•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; NAME                                   HOLDER                                                                      AGE</span>
<span class="c">#    cilium-l2announce-default-webpod       k8s-w1                                                                      2m56s</span>
<span class="c">#    ...</span>

<span class="c"># í˜„ì¬ ë¦¬ë” ì—­í•  ë…¸ë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease/cilium-l2announce-default-webpod <span class="nt">-o</span> yaml | yq
<span class="c"># =&gt; ...</span>
<span class="c">#    spec:</span>
<span class="c">#      acquireTime: "2025-08-09T12:01:16.067503Z"</span>
<span class="c">#      holderIdentity: k8s-w1</span>
<span class="c">#      leaseDurationSeconds: 15</span>
<span class="c">#      leaseTransitions: 0</span>
<span class="c">#      renewTime: "2025-08-09T12:05:03.883829Z"</span>

<span class="c"># cilium íŒŒë“œ ì´ë¦„ ì§€ì •</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-ctr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w0  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CILIUMPOD0</span> <span class="nv">$CILIUMPOD1</span> <span class="nv">$CILIUMPOD2</span>
<span class="c"># =&gt; cilium-9dp58 cilium-tj7tw cilium-nftrl</span>

<span class="c"># í˜„ì¬ í•´ë‹¹ IPì— ëŒ€í•œ ë¦¬ë”ê°€ ìœ„ì¹˜í•œ ë…¸ë“œì˜ cilium-agent íŒŒë“œ ë‚´ì—ì„œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD0</span> <span class="nt">--</span> cilium-dbg shell <span class="nt">--</span> db/show l2-announce
<span class="c"># =&gt; IP   NetworkInterface</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD1</span> <span class="nt">--</span> cilium-dbg shell <span class="nt">--</span> db/show l2-announce
<span class="c"># =&gt; IP               NetworkInterface</span>
<span class="c">#    192.168.10.211   eth1</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë¦¬ë” íŒŒë“œê°€ k8s-w1ì— ìˆê¸° ë•Œë¬¸ì— k8s-w1ì˜ IPì™€ Network Interfaceë§Œ ë‚˜ì˜µë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD2</span> <span class="nt">--</span> cilium-dbg shell <span class="nt">--</span> db/show l2-announce
<span class="c"># =&gt; IP   NetworkInterface</span>

<span class="c"># ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs ds/cilium | <span class="nb">grep</span> <span class="s2">"l2"</span>

<span class="c"># router VM : LBIPë¡œ curl ìš”ì²­ í™•ì¸</span>
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 1000

<span class="nv">$ </span>curl <span class="nt">--connect-timeout</span> 1 <span class="nv">$LBIP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.0.131</span>
<span class="c">#    IP: fe80::48ca:7aff:fee8:da55</span>
<span class="c">#    RemoteAddr: 172.20.1.197:44454</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 192.168.10.211</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>

<span class="c"># VIP ì— ëŒ€í•œ mac ì£¼ì†Œê°€ ë¦¬ë” ë…¸ë“œì˜ mac ì£¼ì†Œì™€ ë™ì¼í•¨ì„ í™•ì¸</span>
<span class="nv">$ </span>arp <span class="nt">-a</span>
<span class="c"># =&gt; ? (192.168.10.211) at 08:00:27:8e:9b:f8 [ether] on eth1</span>
<span class="c">#    ? (192.168.10.101) at 08:00:27:8e:9b:f8 [ether] on eth1</span>
<span class="c">#    ? (192.168.10.100) at 08:00:27:42:b2:8c [ether] on eth1</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-24ck5</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr
<span class="c"># =&gt; RemoteAddr: 192.168.10.200:57078</span>

<span class="c"># ë¦¬ë” ë…¸ë“œê°€ ì•„ë‹Œ ë‹¤ë¥¸ ë…¸ë“œì— webpod í†µì‹  ì‹œ, SNAT ë¨ : arp ë™ì‘(ë¦¬ë” ë…¸ë“œ)ìœ¼ë¡œ ì¸í•œ ì œì•½ ì‚¬í•­</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr<span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; RemoteAddr: 192.168.10.200:57284</span>
<span class="c">#    RemoteAddr: 192.168.10.200:57294   </span>
<span class="c">#    RemoteAddr: 172.20.1.197:57306   # &lt;span style="color: green;"&gt;ğŸ‘‰ leader nodeì¸ k8s-w1ì´ ì•„ë‹Œ ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œê°€ ì‘ë‹µí•œ ê²½ìš° SNATìœ¼ë¡œ ì¸í•´ ë‹¤ë¥¸ IPê°€ í‘œì‹œë¨&lt;/span&gt;</span>
<span class="c">#    RemoteAddr: 172.20.1.197:57310 </span>
<span class="c">#    RemoteAddr: 192.168.10.200:57364</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h5 id="l2-announcement-ë¦¬ë”-ë…¸ë“œì—-ì£¼ì…-í›„-failover-í™•ì¸">L2 Announcement ë¦¬ë” ë…¸ë“œì— ì£¼ì… í›„ Failover í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì‹ ê·œ í„°ë¯¸ë„ (router) : ë°˜ë³µ í˜¸ì¶œ</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>

<span class="c"># í˜„ì¬ ë¦¬ë” ë…¸ë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; NAME                                   HOLDER                                                                      AGE</span>
<span class="c">#    cilium-l2announce-default-webpod       k8s-w1                                                                      19m</span>

<span class="c"># ë¦¬ë” ë…¸ë“œ ê°•ì œ reboot</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1  <span class="nb">sudo </span>reboot
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë¦¬ë” ë…¸ë“œ ì¬ë¶€íŒ…ì‹œ curlì´ íƒ€ì„ì•„ì›ƒ ë˜ì–´ í†µì‹ ì´ ì•ˆ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ (router) : arp ë³€ê²½(ê°±ì‹ ) í™•ì¸</span>
<span class="nv">$ </span>arp <span class="nt">-a</span>
<span class="c"># =&gt; ? (192.168.10.211) at &lt;span style="color: green;"&gt;08:00:27:42:b2:8c&lt;/span&gt; [ether] on eth1</span>
<span class="c">#    ? (192.168.10.101) at 08:00:27:8e:9b:f8 [ether] on eth1</span>
<span class="c">#    ? (192.168.10.100) at 08:00:27:42:b2:8c [ether] on eth1</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ VIP(192.168.10.211)ì˜ MAC ì£¼ì†Œê°€ k8s-ctrì˜ eth1ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># í˜„ì¬ ë¦¬ë” ë…¸ë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; cilium-l2announce-default-webpod       k8s-ctr                                                                     24m</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì˜ˆìƒëŒ€ë¡œ k8s-ctr ë…¸ë“œê°€ ë¦¬ë” ë…¸ë“œë¡œ ìŠ¹ê²©ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="service-lb-ipam-ê¸°ëŠ¥">Service LB-IPAM ê¸°ëŠ¥</h3>

<h5 id="service-ì¶”ê°€ì‹œ-ë™ì‘">Service ì¶”ê°€ì‹œ ë™ì‘</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netshoot-web
  labels:
    app: netshoot-web
spec:
  replicas: 3
  selector:
    matchLabels:
      app: netshoot-web
  template:
    metadata:
      labels:
        app: netshoot-web
    spec:
      terminationGracePeriodSeconds: 0
      containers:
        - name: netshoot
          image: nicolaka/netshoot
          ports:
            - containerPort: 8080
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          command: ["sh", "-c"]
          args:
            - |
              while true; do 
                { echo -e "HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="sh">Content-Type: text/plain</span><span class="se">\r\n\r\n</span><span class="sh">OK from </span><span class="se">\$</span><span class="sh">POD_NAME"; } | nc -l -p 8080 -q 1;
              done
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/netshoot-web created</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: netshoot-web
  labels:
    app: netshoot-web
spec:
  type: LoadBalancer
  selector:
    app: netshoot-web
  ports:
    - name: http
      port: 80      
      targetPort: 8080
</span><span class="no">EOF
</span><span class="c"># =&gt; service/netshoot-web created</span>

<span class="c"># LB IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc netshoot-web
<span class="c"># =&gt; NAME           TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)        AGE</span>
<span class="c">#    netshoot-web   LoadBalancer   10.96.170.130   &lt;span style="color: green;"&gt;192.168.10.212&lt;/span&gt;   80:30240/TCP   8s</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2alpha1"  # not v2
kind: CiliumL2AnnouncementPolicy
metadata:
  name: policy2
spec:
  serviceSelector:
    matchLabels:
      app: netshoot-web
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/hostname
        operator: NotIn
        values:
          - k8s-w0
  interfaces:
  - ^eth[1-9]+
  externalIPs: true
  loadBalancerIPs: true
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliuml2announcementpolicy.cilium.io/policy2 created</span>

<span class="c"># Service ë³„ë¡œ ë¦¬ë” ë…¸ë“œê°€ ë‹¤ë¦„ : ì¦‰, ì™¸ë¶€ ì¸ì… ì‹œ Service ë³„ë¡œ ë‚˜ë¦„ ë¶„ì‚°(?) ì²˜ë¦¬.. </span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; cilium-l2announce-default-netshoot-web   k8s-w1                                                                      36s</span>
<span class="c">#    cilium-l2announce-default-webpod         k8s-ctr                                                                     116m</span>

<span class="c"># í˜¸ì¶œ í™•ì¸</span>
<span class="c">## LBIPë¡œ curl ìš”ì²­ í™•ì¸ : k8s ë…¸ë“œë“¤ì—ì„œ LB EXIPë¡œ í†µì‹  ê°€ëŠ¥!</span>
<span class="nv">$ </span>kubectl get svc netshoot-web <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span>
<span class="c"># =&gt; 192.168.10.212</span>
<span class="nv">$ LB2IP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc netshoot-web <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-jsh8p</span>

<span class="c">## ì‹ ê·œí„°ë¯¸ë„ (router)</span>
<span class="nv">$ LB2IP</span><span class="o">=</span>192.168.10.212
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LB2IP</span> <span class="nt">-c</span> 2
<span class="c"># =&gt; ARPING 192.168.10.212</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.212): index=0 time=452.250 usec</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.212): index=1 time=580.375 usec</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.10.212 statistics ---</span>
<span class="c">#    2 packets transmitted, 2 packets received,   0% unanswered (0 extra)</span>
<span class="c">#    rtt min/avg/max/std-dev = 0.452/0.516/0.580/0.064 ms</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-5zb78</span>
</code></pre></div></div>

<ul>
  <li>íŠ¹ì´í•˜ê²Œë„ Serviceë³„ë¡œ ë¦¬ë” ë…¸ë“œê°€ ë‹¤ë¦…ë‹ˆë‹¤. ì„œë¹„ìŠ¤ê°€ ì—¬ëŸ¬ê°œì¸ ê²½ìš°ì—ëŠ” ì„œë¹„ìŠ¤ ë³„ë¡œ ë¶„ì‚°ë˜ëŠ” íš¨ê³¼ê°€ ìˆì–´ì„œ
ë¦¬ë” ë…¸ë“œì— ë¶€í•˜ê°€ ì§‘ì¤‘ë˜ëŠ” ë¬¸ì œê°€ ë‹¤ì†Œ ì™„í™”ë  ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.</li>
</ul>

<h5 id="requesting-ips">Requesting IPs</h5>

<ul>
  <li>íŠ¹ì • Serviceì˜ External IPë¥¼ ì§ì ‘ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#loadbalancerclass">Docs</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Service netshoot-web ì— EX-IPë¥¼ ì§ì ‘ ì§€ì • ë³€ê²½</span>
<span class="nv">$ </span>kubectl edit svc netshoot-web 
<span class="c"># ë˜ëŠ” k9s â†’ svc â†’ &lt;e&gt; edit</span>
<span class="nt">---</span>
<span class="c">## metadata.annotations ì•„ë˜ ì•„ë˜ ì¶”ê°€</span>
  annotations:
    <span class="s2">"lbipam.cilium.io/ips"</span>: <span class="s2">"192.168.10.215"</span>
<span class="nt">---</span>
<span class="c"># =&gt; service/netshoot-web edited</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc netshoot-web
<span class="c"># =&gt; NAME           TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)        AGE</span>
<span class="c">#    netshoot-web   LoadBalancer   10.96.170.130   &lt;span style="color: green;"&gt;192.168.10.215&lt;/span&gt;   80:30240/TCP   9m6s</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ annotationì„ í†µí•´ ì§€ì •í•œ EXTERNAL-IP(192.168.10.215)ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc netshoot-web <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span>
<span class="c"># =&gt; 192.168.10.215</span>
<span class="nv">$ LB2IP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc netshoot-web <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-5zb78</span>
</code></pre></div></div>

<h5 id="sharing-keys">Sharing Keys</h5>

<ul>
  <li>External IP 1ê°œë¥¼ ê°ê¸° ë‹¤ë¥¸ Portë¥¼ í†µí•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#requesting-ips">Docs</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: netshoot-web2
  labels:
    app: netshoot-web
spec:
  type: LoadBalancer
  selector:
    app: netshoot-web
  ports:
    - name: http
      port: 8080      
      targetPort: 8080
</span><span class="no">EOF
</span><span class="c"># =&gt; service/netshoot-web2 created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-web
<span class="c"># =&gt; NAME            TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)          AGE</span>
<span class="c">#    netshoot-web    LoadBalancer   10.96.170.130   192.168.10.215   80:30240/TCP     12m</span>
<span class="c">#    netshoot-web2   LoadBalancer   10.96.75.231    192.168.10.212   8080:31278/TCP   14s</span>

<span class="c"># Service netshoot-webì— annotations ì¶”ê°€</span>
<span class="nv">$ </span>kubectl edit svc netshoot-web 
<span class="c"># ë˜ëŠ” k9s â†’ svc â†’ &lt;e&gt; edit</span>
<span class="nt">---</span> 
<span class="c">## metadata.annotations ì•„ë˜ ì•„ë˜ ì¶”ê°€</span>
  annotations:
    <span class="s2">"lbipam.cilium.io/ips"</span>: <span class="s2">"192.168.10.215"</span>
    <span class="s2">"lbipam.cilium.io/sharing-key"</span>: <span class="s2">"1234"</span>
<span class="nt">---</span>
<span class="c"># =&gt; service/netshoot-web edited</span>

<span class="c"># ë™ì¼í•˜ê²Œ netshoot-web2 ì„œë¹„ìŠ¤ì—ë„ annotations ì¶”ê°€</span>
<span class="nv">$ </span>kubectl edit svc netshoot-web2 
<span class="c"># =&gt; service/netshoot-web2 edited</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-web
<span class="c"># =&gt; NAME            TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)          AGE</span>
<span class="c">#    netshoot-web    LoadBalancer   10.96.170.130   192.168.10.215   80:30240/TCP     18m</span>
<span class="c">#    netshoot-web2   LoadBalancer   10.96.75.231    192.168.10.215   8080:31278/TCP   5m36s</span>

<span class="c"># sharing-key ì‚¬ìš©ë˜ëŠ” IPëŠ” ëª¨ë“  ê°™ì€ ë¦¬ë” ë…¸ë“œ ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; cilium-l2announce-default-netshoot-web    k8s-w1                                                                      17m</span>
<span class="c">#    cilium-l2announce-default-netshoot-web2   k8s-w1                                                                      5m45s</span>
<span class="c">#    cilium-l2announce-default-webpod          k8s-ctr                                                                     133m</span>

<span class="c"># í˜¸ì¶œ í™•ì¸</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-5zb78</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ netshoot-web ì„œë¹„ìŠ¤ ì‘ë‹µ&lt;/span&gt;</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>:8080
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-4fsnp</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ netshoot-web2 ì„œë¹„ìŠ¤ ì‘ë‹µ&lt;/span&gt;</span>

<span class="c"># ì‹ ê·œí„°ë¯¸ë„ (router)</span>
<span class="nv">$ LB2IP</span><span class="o">=</span>192.168.10.215
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LB2IP</span> <span class="nt">-c</span> 2
<span class="c"># =&gt; ARPING 192.168.10.215</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.215): index=0 time=1.236 msec</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.215): index=1 time=372.519 usec</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.10.215 statistics ---</span>
<span class="c">#    2 packets transmitted, 2 packets received,   0% unanswered (0 extra)</span>
<span class="c">#    rtt min/avg/max/std-dev = 0.373/0.804/1.236/0.432 ms</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-jsh8p</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>:8080
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-5zb78</span>
</code></pre></div></div>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œë„ ë…¸ë“œì˜ íŒŒë“œë“¤ê°„ í†µì‹ ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.
ê°€ì¥ ê´€ì‹¬ ìˆê²Œ ë³¸ ì ì€ Ciliumì˜ LoadBalancer IPAM ê¸°ëŠ¥ì„ í†µí•´ì„œ MetalLB (L2 ëª¨ë“œ)ë¥¼ ëŒ€ì²´í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
MetalLBë¼ëŠ” ì¶”ê°€ì ì¸ êµ¬ì„±ìš”ì†Œ ì—†ì´ Cilium ë§Œìœ¼ë¡œ LoadBalancer Serviceë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤ëŠ” ì ì´ ë§¤ë ¥ì ì¸ê²ƒ ê°™ìŠµë‹ˆë‹¤. :relaxed:</p>

<p>ì ì  ë” Ciliumì˜ ë§¤ë ¥ì— ë¹ ì ¸ë“œëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë‹¤ìŒ ì£¼ì—ë„ Ciliumì— ëŒ€í•´ì„œ ë” ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. :smile:</p>

<ul>
  <li>ì•½ì–´ ì†Œê°œ
    <ul>
      <li><strong>S.IP</strong> : Source IP, ì¶œë°œì§€(ì†ŒìŠ¤) IP</li>
      <li><strong>D.IP</strong> : Destination IP, ë„ì°©ì¹˜(ëª©ì ì§€) IP</li>
      <li><strong>S.Port</strong> : Source Port, ì¶œë°œì§€(ì†ŒìŠ¤) í¬íŠ¸</li>
      <li><strong>D.Port</strong> : Destination Port, ë„ì°©ì§€(ëª©ì ì§€) í¬íŠ¸</li>
      <li><strong>NAT</strong> : Network Address Translation, ë„¤íŠ¸ì›Œí¬ ì£¼ì†Œ ë³€í™˜</li>
      <li><strong>SNAT</strong> : Source IP ë¥¼ NAT ì²˜ë¦¬, ì¼ë°˜ì ìœ¼ë¡œ ì¶œë°œì§€ IPë¥¼ ë³€í™˜</li>
      <li><strong>DNAT</strong> : Destination IP ë¥¼ NAT ì²˜ë¦¬, ì¼ë°˜ì ìœ¼ë¡œ ëª©ì ì§€ IPì™€ ëª©ì ì§€ í¬íŠ¸ë¥¼ ë³€í™˜</li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="cilium" /><category term="kubernetes," /><category term="network," /><category term="linux," /><category term="cilium," /><category term="ipam," /><category term="routing," /><category term="masquerading," /><category term="coredns," /><category term="nodelocaldns" /><summary type="html"><![CDATA[ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Overlay Networkì¸ VXLANì„ í†µí•œ íŒŒë“œê°„ í†µì‹ ê³¼ Kubernetes ì„œë¹„ìŠ¤, LB-IPAM ë“±ì„ í†µí•œ í†µì‹ ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[Cilium] Networking - ë…¸ë“œì˜ íŒŒë“œë“¤ê°„ í†µì‹  ìƒì„¸ part 1</title><link href="https://sweetlittlebird.github.io/posts/2025-08-03-Cilium-Week3/" rel="alternate" type="text/html" title="[Cilium] Networking - ë…¸ë“œì˜ íŒŒë“œë“¤ê°„ í†µì‹  ìƒì„¸ part 1" /><published>2025-08-03T00:10:18+09:00</published><updated>2025-08-03T00:10:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/Cilium%20-%20Week3</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2025-08-03-Cilium-Week3/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Ciliumì˜ Networkingì— ëŒ€í•´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. 
Ciliumì´ ì–´ë–»ê²Œ ë…¸ë“œì— ìˆëŠ” íŒŒë“œë“¤ ê°„ì˜ í†µì‹ ì„ ì²˜ë¦¬í•˜ëŠ”ì§€, IP ì£¼ì†Œ í• ë‹¹(IPAM), ë¼ìš°íŒ…, ë§ˆìŠ¤ì»¤ë ˆì´ë”©, DNS ì„¤ì • ë“±ì„ ë‹¤ë£° ê²ƒì…ë‹ˆë‹¤.</p>

<hr />

<h2 id="ì‹¤ìŠµ-í™˜ê²½-êµ¬ì„±">ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±</h2>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” ë‹¤ìŒ ê·¸ë¦¼ê³¼ ê°™ì´ worker ë…¸ë“œë¥¼ 1ëŒ€ ì¤„ì´ê³ , router ë…¸ë“œë¥¼ ì¶”ê°€í•´ì„œ ì‹¤ìŠµí•  ì˜ˆì •ì…ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w3/20250803_cilium_w3_1.png" alt="img.png" class="image-center" />
    <ul>
      <li><strong>ê°€ìƒë¨¸ì‹ </strong> : k8s-ctr, k8s-w1, router</li>
      <li><strong>router</strong> : ì‚¬ë‚´ë§ 10.10.0.0/16 ëŒ€ì—­ í†µì‹ ê³¼ ì—°ê²°, k8s ì— join ë˜ì§€ ì•Šì€ ì„œë²„, loop1/loop2 dump ì¸í„°í˜ì´ìŠ¤ ë°°ì¹˜</li>
      <li>Cilium CNI ê°€ ì„¤ì¹˜ëœ ìƒíƒœë¡œ ë°°í¬ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬-íŒŒì¼">ì‹¤ìŠµí™˜ê²½ ë°°í¬ íŒŒì¼</h3>

<ul>
  <li>
    <p><strong>Vagrantfile</strong> : ê°€ìƒë¨¸ì‹  ì •ì˜, ë¶€íŒ… ì‹œ ì´ˆê¸° í”„ë¡œë¹„ì €ë‹ ì„¤ì •ì„ í¬í•¨í•˜ëŠ” Vagrantfileì…ë‹ˆë‹¤.</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Variables</span>
<span class="no">K8SV</span> <span class="o">=</span> <span class="s1">'1.33.2-1.1'</span> <span class="c1"># Kubernetes Version : apt list -a kubelet, ex) 1.32.5-1.1</span>
<span class="no">CONTAINERDV</span> <span class="o">=</span> <span class="s1">'1.7.27-1'</span> <span class="c1"># Containerd Version : apt list -a containerd.io, ex) 1.6.33-1</span>
<span class="no">CILIUMV</span> <span class="o">=</span> <span class="s1">'1.17.6'</span> <span class="c1"># Cilium CNI Version : https://github.com/cilium/cilium/tags</span>
<span class="no">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># max number of worker nodes</span>
  
<span class="c1"># Base Image  https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-24.04</span>
<span class="no">BOX_IMAGE</span> <span class="o">=</span> <span class="s2">"bento/ubuntu-24.04"</span>
<span class="no">BOX_VERSION</span> <span class="o">=</span> <span class="s2">"202502.21.0"</span>
  
<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
<span class="c1">#-ControlPlane Node</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-ctr"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
        
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">2560</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.100"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60000</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span> <span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-ctr.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">N</span><span class="p">,</span> <span class="no">CILIUMV</span><span class="p">,</span> <span class="no">K8SV</span> <span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"route-add1.sh"</span>
    <span class="k">end</span>
  
<span class="c1">#-Worker Nodes Subnet1</span>
  <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="no">N</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.10</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="s2">"6000</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-w.sh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"route-add1.sh"</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
<span class="c1">#-Router Node</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"router"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"router"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">768</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"router"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.200"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60009</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"router.sh"</span>
    <span class="k">end</span>    
<span class="k">end</span>  
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>init_cfg.sh</strong> : args ì°¸ê³ í•˜ì—¬ ì´ˆê¸° ì„¤ì •ì„ ìˆ˜í–‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime <span class="c"># Change Timezone</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Disable and turn off SWAP"</span>
swapoff <span class="nt">-a</span> <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'/swap/s/^/#/'</span> /etc/fstab
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Install Packages"</span>
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>apt-transport-https ca-certificates curl gpg <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># Download the public signing key for the Kubernetes package repositories.</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nt">-m</span> 755 /etc/apt/keyrings
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$1</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+)\..*/\1/p'</span><span class="si">)</span>
curl <span class="nt">-fsSL</span> https://pkgs.k8s.io/core:/stable:/v<span class="nv">$K8SMMV</span>/deb/Release.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/kubernetes-apt-keyring.gpg
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v</span><span class="nv">$K8SMMV</span><span class="s2">/deb/ /"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list.d/kubernetes.list
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
  
<span class="c"># packets traversing the bridge are processed by iptables for filtering</span>
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
<span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> <span class="o">&gt;&gt;</span> /etc/sysctl.d/k8s.conf
  
<span class="c"># enable br_netfilter for iptables </span>
modprobe br_netfilter
modprobe overlay
<span class="nb">echo</span> <span class="s2">"br_netfilter"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
<span class="nb">echo</span> <span class="s2">"overlay"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)"</span>
<span class="c"># Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version</span>
apt update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># apt list -a kubelet ; apt list -a containerd.io</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubectl</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubeadm</span><span class="o">=</span><span class="nv">$1</span> containerd.io<span class="o">=</span><span class="nv">$2</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-mark hold kubelet kubeadm kubectl <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># containerd configure to default and cgroup managed by systemd</span>
containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SystemdCgroup = false/SystemdCgroup = true/g'</span> /etc/containerd/config.toml
  
<span class="c"># avoid WARN&amp;ERRO(default endpoints) when crictl run  </span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
</span><span class="no">EOF
  
</span><span class="c"># ready to install for k8s </span>
systemctl restart containerd <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable </span>containerd
systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Packages &amp; Helm"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get <span class="nb">install</span> <span class="nt">-y</span> bridge-utils sshpass net-tools conntrack ngrep tcpdump ipset arping wireguard jq yq tree bash-completion unzip kubecolor termshark <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
curl <span class="nt">-s</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
  
</code></pre></div>    </div>
  </li>
  <li><strong>k8s-ctr.sh</strong> : kubeadm initë¥¼ í†µí•˜ì—¬ kubernetes controlplane ë…¸ë“œë¥¼ ì„¤ì •í•˜ê³  Cilium CNI ì„¤ì¹˜, í¸ë¦¬ì„± ì„¤ì •(k, kc)í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Initial Kubernetes"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-init-ctr-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/kubeadm-init-ctr-config.yaml
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$3</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/p'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/K8S_VERSION_PLACEHOLDER/v</span><span class="k">${</span><span class="nv">K8SMMV</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-init-ctr-config.yaml
kubeadm init <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-init-ctr-config.yaml"</span>  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Setting kube config file"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /root/.kube
<span class="nb">cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf /root/.kube/config
<span class="nb">chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> /root/.kube/config
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Source the completion"</span>
<span class="nb">echo</span> <span class="s1">'source &lt;(kubectl completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'source &lt;(kubeadm completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Alias kubectl to k"</span>
<span class="nb">echo</span> <span class="s1">'alias k=kubectl'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'alias kc=kubecolor'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'complete -F __start_kubectl k'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubectx &amp; Kubens"</span>
git clone https://github.com/ahmetb/kubectx /opt/kubectx <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubens /usr/local/bin/kubens
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubectx /usr/local/bin/kubectx
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Kubeps &amp; Setting PS1"</span>
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1 <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">"</span><span class="no">EOT</span><span class="sh">" &gt;&gt; /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
function get_cluster_short() {
  echo "</span><span class="nv">$1</span><span class="sh">" | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=') '
PS1='</span><span class="si">$(</span>kube_ps1<span class="si">)</span><span class="sh">'</span><span class="nv">$PS1</span><span class="sh">
</span><span class="no">EOT
</span>kubectl config rename-context <span class="s2">"kubernetes-admin@kubernetes"</span> <span class="s2">"HomeLab"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"[TASK 7] Install Cilium CNI"</span>
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
helm repo add cilium https://helm.cilium.io/ <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm repo update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> <span class="nv">$2</span> <span class="nt">--namespace</span> kube-system <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.100 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="se">\</span>
<span class="nt">--set</span> ipam.mode<span class="o">=</span><span class="s2">"kubernetes"</span> <span class="nt">--set</span> k8s.requireIPv4PodCIDR<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>10.244.0.0/16 <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> endpointRoutes.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>30003 <span class="se">\</span>
<span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span> <span class="se">\</span>
<span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="c">#--set ipam.mode="cluster-pool" --set ipam.operator.clusterPoolIPv4PodCIDRList={"172.20.0.0/16"} --set ipv4NativeRoutingCIDR=172.20.0.0/16 \</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 8] Install Cilium / Hubble CLI"</span>
<span class="nv">CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz
  
<span class="nv">HUBBLE_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="si">)</span>
<span class="nv">HUBBLE_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">HUBBLE_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/hubble/releases/download/<span class="nv">$HUBBLE_VERSION</span>/hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz
  
<span class="nb">echo</span> <span class="s2">"[TASK 9] Remove node taint"</span>
kubectl taint nodes k8s-ctr node-role.kubernetes.io/control-plane-
  
<span class="nb">echo</span> <span class="s2">"[TASK 10] local DNS with hosts file"</span>
<span class="nb">echo</span> <span class="s2">"192.168.10.100 k8s-ctr"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;<span class="o">=</span><span class="nv">$1</span><span class="p">;</span> i++  <span class="o">))</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"192.168.10.10</span><span class="nv">$i</span><span class="s2"> k8s-w</span><span class="nv">$i</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts<span class="p">;</span> <span class="k">done
  
</span><span class="nb">echo</span> <span class="s2">"[TASK 11] Install Prometheus &amp; Grafana"</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/kubernetes/addons/prometheus/monitoring-example.yaml <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch svc <span class="nt">-n</span> cilium-monitoring prometheus <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 9090, "targetPort": 9090, "nodePort": 30001}]}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch svc <span class="nt">-n</span> cilium-monitoring grafana <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 3000, "targetPort": 3000, "nodePort": 30002}]}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"[TASK 12] Dynamically provisioning persistent local storage with Kubernetes"</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.31/deploy/local-path-storage.yaml <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch storageclass local-path <span class="nt">-p</span> <span class="s1">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>

    <ul>
      <li>ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">--set endpointHealthChecking.enabled=false</code> ê³¼ <code class="language-plaintext highlighter-rouge">--set healthChecking=false</code> ì˜µì…˜ì„ í†µí•´ endpoint health checkë¥¼ ì™„ì „íˆ í•´ì œí•©ë‹ˆë‹¤.</li>
      <li>ì°¸ê³ ë¡œ í•´ë‹¹ health check ê¸°ëŠ¥ì€ ë¹„êµì  ì†Œê·œëª¨ì˜ í´ëŸ¬ìŠ¤í„°(3~10ë…¸ë“œ)ì—ë§Œ í™œì„±í™” í•˜ê¸°ë¥¼ ê¶Œì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤. ëŒ€ê·œëª¨ì˜ í´ëŸ¬ìŠ¤í„°ì—ì„œëŠ” ë°©í™”ë²½ ì •ì±…ì´ë‚˜ í•˜ì´í¼ë°”ì´ì € ì„¤ì •ìœ¼ë¡œ ì¸í•´ íŒ¨í‚· ì†ì‹¤ì´ ë°œìƒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/operations/performance/scalability/report/">Docs</a></li>
      <li>
        <p><strong>kubeadm-init-ctr-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  apiVersion: kubeadm.k8s.io/v1beta4
  kind: <span class="k">**</span>InitConfiguration<span class="k">**</span>
  bootstrapTokens:
  - token: <span class="s2">"123456.1234567890123456"</span>
    ttl: <span class="s2">"0s"</span>
    usages:
    - signing
    - authentication
  localAPIEndpoint:
    advertiseAddress: <span class="s2">"192.168.10.100"</span>
  nodeRegistration:
    <span class="k">**</span>kubeletExtraArgs:
      - name: node-ip
        value: <span class="s2">"192.168.10.100"</span><span class="k">**</span>
    criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
  <span class="nt">---</span>
  apiVersion: kubeadm.k8s.io/v1beta4
  kind: <span class="k">**</span>ClusterConfiguration<span class="k">**</span>
  kubernetesVersion: <span class="s2">"**K8S_VERSION_PLACEHOLDER**"</span>
  networking:
    podSubnet: <span class="s2">"10.244.0.0/16"</span>
    serviceSubnet: <span class="s2">"10.96.0.0/16"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li><strong>k8s-w.sh</strong> : kubernetes worker ë…¸ë“œ ì„¤ì •, kubeadm join, Cilium CNI ì„¤ì¹˜ ë“±ì„ ìˆ˜í–‰í•˜ëŠ”  ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] K8S Controlplane Join"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-join-worker-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-join-worker-config.yaml
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/NODE_IP_PLACEHOLDER/</span><span class="k">${</span><span class="nv">NODEIP</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-join-worker-config.yaml
kubeadm <span class="nb">join</span> <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-join-worker-config.yaml"</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
    <ul>
      <li>
        <p><strong>kubeadm-join-worker-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: kubeadm.k8s.io/v1beta4
kind: JoinConfiguration
discovery:
  bootstrapToken:
    token: <span class="s2">"123456.1234567890123456"</span>
    apiServerEndpoint: <span class="s2">"192.168.10.100:6443"</span>
    unsafeSkipCAVerification: <span class="nb">true
</span>nodeRegistration:
  criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
  kubeletExtraArgs:
    - name: node-ip
      value: <span class="s2">"NODE_IP_PLACEHOLDER"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>route-add1.sh</strong> : k8s node ë“¤ì´ ì‚¬ë‚´ë§(?)ê³¼ í†µì‹ ì„ ìœ„í•œ route ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt;&gt; /etc/netplan/50-vagrant.yaml
      routes:
      - to: 10.10.0.0/16
        via: 192.168.10.200
</span><span class="no">EOT
  
</span>netplan apply
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>router.sh</strong> : router ì—­í• ê³¼ ì¶”ê°€ì ìœ¼ë¡œ ì›¹ì„œë²„ ì—­í• ì„ í•˜ëŠ” ì„œë²„ì˜ ì´ˆê¸° ì„¤ì •ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Add Kernel setting - IP Forwarding"</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g'</span> /etc/sysctl.conf
sysctl <span class="nt">-p</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Setting Dummy Interface"</span>
modprobe dummy
ip <span class="nb">link </span>add loop1 <span class="nb">type </span>dummy
ip <span class="nb">link set </span>loop1 up
ip addr add 10.10.1.200/24 dev loop1
  
ip <span class="nb">link </span>add loop2 <span class="nb">type </span>dummy
ip <span class="nb">link set </span>loop2 up
ip addr add 10.10.2.200/24 dev loop2
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Packages"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>net-tools jq tree ngrep tcpdump arping <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Apache"</span>
apt <span class="nb">install </span>apache2 <span class="nt">-y</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"&lt;h1&gt;Web Server : </span><span class="si">$(</span><span class="nb">hostname</span><span class="si">)</span><span class="s2">&lt;/h1&gt;"</span> <span class="o">&gt;</span> /var/www/html/index.html
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬-ë°-ë¶„ì„-íˆ´-ì„¤ì¹˜">ì‹¤ìŠµí™˜ê²½ ë°°í¬ ë° ë¶„ì„ íˆ´ ì„¤ì¹˜</h3>

<ul>
  <li>
    <p>ì‹¤ìŠµí™˜ê²½ ë°°í¬</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vagrant up
<span class="c"># =&gt;     ...</span>
<span class="c">#        router: [TASK 5] Install Packages</span>
<span class="c">#        router: [TASK 6] Install Apache</span>
<span class="c">#        router: &gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;</span>
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">k8s-ctr</code>, cilium ì„¤ì¹˜ì •ë³´í™•ì¸ì€ ì§€ë‚œì£¼ì˜ í¬ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”. <a href="https://sweetlittlebird.github.io/posts/2025-07-27-Cilium-Week2/#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC">ë§í¬</a></li>
  <li><code class="language-plaintext highlighter-rouge">k9s</code>
    <ul>
      <li>ì´ë²ˆ ì£¼ì—ëŠ” k9së¼ëŠ” CLI ê¸°ë°˜ì˜ Kubernetes ëŒ€ì‹œë³´ë“œ íˆ´ì„ ì„¤ì¹˜í•˜ê³  ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. <a href="https://github.com/derailed/k9s">github</a></li>
      <li>ì„¤ì¹˜ ë° ì‹¤í–‰
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># arm64 CPU ì¼ ê²½ìš°</span>
<span class="nv">$ </span>wget https://github.com/derailed/k9s/releases/latest/download/k9s_linux_arm64.deb <span class="nt">-O</span> /tmp/k9s_linux_arm64.deb
<span class="nv">$ </span>apt <span class="nb">install</span> /tmp/k9s_linux_arm64.deb
<span class="c"># =&gt; ...</span>
<span class="c">#    Preparing to unpack /tmp/k9s_linux_arm64.deb ...</span>
<span class="c">#    Unpacking k9s (0.50.9) ...</span>
<span class="c">#    Setting up k9s (0.50.9) ...</span>
    
<span class="c"># amd64 CPU ì¼ ê²½ìš°</span>
<span class="nv">$ </span>wget https://github.com/derailed/k9s/releases/latest/download/k9s_linux_amd64.deb <span class="nt">-O</span> /tmp/k9s_linux_amd64.deb
<span class="nv">$ </span>apt <span class="nb">install</span> /tmp/k9s_linux_amd64.deb
    
<span class="c"># k9s ì„¤ì¹˜ ê²½ë¡œ í™•ì¸</span>
<span class="nv">$ </span>which k9s
<span class="c"># =&gt; /usr/bin/k9s</span>
    
<span class="c"># k9s ì‹¤í–‰</span>
<span class="nv">$ </span>k9s
</code></pre></div>        </div>
      </li>
      <li>ì‹¤í–‰ í™”ë©´
<img src="/assets/2025/cilium/w3/20250803_cilium_w3_2.png" alt="img.png" />
í„°ë¯¸ë„ì´ì§€ë§Œ í•œëˆˆì— ë³´ê¸° ì‰½ê²Œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">k9s</code> ê¸°ë³¸ ì‚¬ìš©ë²•
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë²„ì „ í™•ì¸</span>
<span class="nv">$ </span>k9s version
<span class="c"># =&gt;  ____  __ ________</span>
<span class="c">#    |    |/  /   __   \______</span>
<span class="c">#    |       /\____    /  ___/</span>
<span class="c">#    |    \   \  /    /\___  \</span>
<span class="c">#    |____|\__ \/____//____  /</span>
<span class="c">#             \/           \/</span>
<span class="c">#    Version:    v0.50.9</span>
<span class="c">#    Commit:     ffdc7b70f044e1f26c2f6fbb93b5495e4ebdb1ad</span>
    
<span class="c"># k9s ëŸ°íƒ€ì„ì— ëŒ€í•œ ì •ë³´</span>
<span class="nv">$ </span>k9s info
<span class="c"># =&gt; ...</span>
<span class="c">#    Version:           v0.50.9</span>
<span class="c">#    Config:            /root/.config/k9s/config.yaml</span>
<span class="c">#    Custom Views:      /root/.config/k9s/views.yaml</span>
<span class="c">#    Plugins:           /root/.config/k9s/plugins.yaml</span>
<span class="c">#    Hotkeys:           /root/.config/k9s/hotkeys.yaml</span>
<span class="c">#    Aliases:           /root/.config/k9s/aliases.yaml</span>
<span class="c">#    Skins:             /root/.config/k9s/skins</span>
<span class="c">#    Context Configs:   /root/.local/share/k9s/clusters</span>
<span class="c">#    Logs:              /root/.local/state/k9s/k9s.log</span>
<span class="c">#    Benchmarks:        /root/.local/state/k9s/benchmarks</span>
<span class="c">#    ScreenDumps:       /root/.local/state/k9s/screen-dumps</span>
    
<span class="c"># CLIì˜ ë„ì›€ë§</span>
<span class="nv">$ </span>k9s <span class="nb">help</span>
    
<span class="c"># íŠ¹ì • ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ K9s ì‹œì‘</span>
<span class="nv">$ </span>k9s <span class="nt">-n</span> mycoolns
    
<span class="c"># KubeConfigì— ì¡´ì¬í•˜ëŠ” ì»¨í…ìŠ¤íŠ¸ë¡œ K9s ì‹œì‘</span>
<span class="nv">$ </span>k9s <span class="nt">--context</span> coolCtx
    
<span class="c"># K9së¥¼ ì½ê¸° ì „ìš© ëª¨ë“œë¡œ ì‹œì‘ - í´ëŸ¬ìŠ¤í„° ìˆ˜ì • ëª…ë ¹ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>k9s <span class="nt">--readonly</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">termshark</code>
    <ul>
      <li>í„°ë¯¸ë„ì—ì„œ Wireshark ì²˜ëŸ¼ íŒ¨í‚·ì„ ë³¼ ìˆ˜ ìˆëŠ” íˆ´ì…ë‹ˆë‹¤. <a href="https://github.com/gcla/termshark">github</a>, <a href="https://termshark.io/">Home</a>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŒ</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
<span class="nv">$ </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> termshark
<span class="c"># =&gt; Reading package lists... Done</span>
<span class="c">#    Building dependency tree... Done</span>
<span class="c">#    Reading state information... Done</span>
<span class="c">#    termshark is already the newest version (2.4.0-1ubuntu0.24.04.3).</span>
<span class="c">#    0 upgraded, 0 newly installed, 0 to remove and 170 not upgraded.</span>
    
<span class="c"># pcap íŒŒì¼ ë¶„ì„</span>
<span class="nv">$ </span>termshark <span class="nt">-r</span> test.pcap
    
<span class="c"># eth0 ì¸í„°í˜ì´ìŠ¤ì—ì„œ ping íŒ¨í‚·ì„ ìº¡ì²˜í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>termshark <span class="nt">-i</span> eth0 icmp
</code></pre></div>        </div>
      </li>
      <li>ì‹¤í–‰ í™”ë©´
<img src="/assets/2025/cilium/w3/20250803_cilium_w3_3.png" alt="img.png" /></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="ipam">IPAM</h2>

<ul>
  <li>
    <p>IPAMì€ <code class="language-plaintext highlighter-rouge">IP Address Management</code>ì˜ ì•½ìë¡œ, ë„¤íŠ¸ì›Œí¬ ì—”ë“œí¬ì¸íŠ¸(ì»¨í…Œì´ë„ˆ ë“±)ì— ëŒ€í•œ IP ì£¼ì†Œë¥¼ í• ë‹¹í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/network/concepts/ipam/">Docs</a></p>

    <table>
      <thead>
        <tr>
          <th><strong>Feature</strong></th>
          <th><strong>Kubernetes Host Scope</strong></th>
          <th><strong>Cluster Scope (default)</strong></th>
          <th><strong>Multi-Pool (Beta)</strong></th>
          <th><strong>CRD-backed</strong></th>
          <th><strong>AWS ENIâ€¦</strong></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Tunnel routing</td>
          <td>âœ…</td>
          <td>âœ…</td>
          <td>âŒ</td>
          <td>âŒ</td>
          <td>âŒ</td>
        </tr>
        <tr>
          <td>Direct routing</td>
          <td>âœ…</td>
          <td>âœ…</td>
          <td>âœ…</td>
          <td>âœ…</td>
          <td>âœ…</td>
        </tr>
        <tr>
          <td>CIDR Configuration</td>
          <td>Kubernetes</td>
          <td>Cilium</td>
          <td>Cilium</td>
          <td>External</td>
          <td>External (AWS)</td>
        </tr>
        <tr>
          <td>Multiple CIDRs per cluster</td>
          <td>âŒ</td>
          <td>âœ…</td>
          <td>âœ…</td>
          <td>N/A</td>
          <td>N/A</td>
        </tr>
        <tr>
          <td>Multiple CIDRs per node</td>
          <td>âŒ</td>
          <td>âŒ</td>
          <td>âœ…</td>
          <td>N/A</td>
          <td>N/A</td>
        </tr>
        <tr>
          <td>Dynamic CIDR/IP allocation</td>
          <td>âŒ</td>
          <td>âŒ</td>
          <td>âœ…</td>
          <td>âœ…</td>
          <td>âœ…</td>
        </tr>
      </tbody>
    </table>

    <blockquote>
      <p>ê¸°ì¡´ <strong>í´ëŸ¬ìŠ¤í„°ì˜ IPAM ëª¨ë“œ</strong>ë¥¼ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.<br />
ë¼ì´ë¸Œ í™˜ê²½ì—ì„œ IPAM ëª¨ë“œë¥¼ ë³€ê²½í•˜ë©´ ê¸°ì¡´ ì›Œí¬ë¡œë“œì˜ <strong>ì§€ì†ì ì¸ ì—°ê²° ì¤‘ë‹¨</strong>ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br />
IPAM ëª¨ë“œë¥¼ ë³€ê²½í•˜ëŠ” ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ì€ ìƒˆë¡œìš´ IPAM êµ¬ì„±ìœ¼ë¡œ ìƒˆë¡œìš´ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ì„¤ì¹˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>
    </blockquote>
  </li>
</ul>

<h3 id="kubernetes-host-scope">Kubernetes Host Scope</h3>

<p><a href="https://docs.cilium.io/en/stable/network/concepts/ipam/kubernetes/">Docs</a></p>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_4.png" alt="img.png" /></p>

<ul>
  <li>Kubernetes í˜¸ìŠ¤íŠ¸ ë²”ìœ„ IPAM ëª¨ë“œëŠ” <code class="language-plaintext highlighter-rouge">ipam: Kubernetes</code>ë¡œ í™œì„±í™”ë˜ë©°, í´ëŸ¬ìŠ¤í„°ì˜ ê° ê°œë³„ ë…¸ë“œì— ì£¼ì†Œ í• ë‹¹ì„ ìœ„ì„í•©ë‹ˆë‹¤.</li>
  <li>IPëŠ” Kubernetesì— ì˜í•´ ê° ë…¸ë“œì— ì—°ê²°ëœ PodCIDR ë²”ìœ„ì—ì„œ í• ë‹¹ë©ë‹ˆë‹¤. ì¦‰, CIDR ì„¤ì •ì˜ ì£¼ì²´ëŠ” Kubernetesì…ë‹ˆë‹¤.</li>
  <li>ì´ ëª¨ë“œì—ì„œëŠ” Cilium ì—ì´ì „íŠ¸ê°€ <code class="language-plaintext highlighter-rouge">Kubernetes v1.Node</code> ê°ì²´ë¥¼ í†µí•´ PodCIDR ë²”ìœ„ê°€ ë‹¤ìŒ ë°©ë²• ì¤‘ í•˜ë‚˜ë¥¼ í†µí•´ í™œì„±í™”ëœ ëª¨ë“  ì£¼ì†Œ íŒ¨ë°€ë¦¬ì— ëŒ€í•´ ì œê³µë ë•Œê¹Œì§€ ì‹œì‘ì‹œ ëŒ€ê¸°í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt;                             "--service-cluster-ip-range=10.96.0.0/16",</span>
<span class="c">#                                "--cluster-cidr=10.244.0.0/16",</span>

<span class="c"># ipam ëª¨ë“œ í™•ì¸</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> ^ipam
<span class="c"># =&gt; ipam                                              kubernetes</span>
<span class="c">#    ipam-cilium-node-update-rate                      15s</span>

<span class="c"># ë…¸ë“œë³„ íŒŒë“œì— í• ë‹¹ë˜ëŠ” IPAM(PodCIDR) ì •ë³´ í™•ì¸</span>
<span class="c"># --allocate-node-cidrs=true ë¡œ ì„¤ì •ëœ kube-controller-managerì—ì„œ CIDRì„ ìë™ í• ë‹¹í•¨</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'</span>
<span class="c"># =&gt; k8s-ctr 10.244.0.0/24</span>
<span class="c">#    k8s-w1  10.244.1.0/24</span>

<span class="nv">$ </span>kc describe pod <span class="nt">-n</span> kube-system kube-controller-manager-k8s-ctr
<span class="c"># =&gt; ....</span>
<span class="c">#    Command:</span>
<span class="c">#          kube-controller-manager</span>
<span class="c">#          --allocate-node-cidrs=true</span>
<span class="c">#          --cluster-cidr=10.244.0.0/16</span>
<span class="c">#          --service-cluster-ip-range=10.96.0.0/16</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl get ciliumnode <span class="nt">-o</span> json | <span class="nb">grep </span>podCIDRs <span class="nt">-A2</span>
<span class="c"># =&gt;                     "podCIDRs": [</span>
<span class="c">#                            "10.244.0.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "10.244.1.0/24"</span>
<span class="c">#                        ],</span>

<span class="c"># íŒŒë“œ ì •ë³´ : ìƒíƒœ, íŒŒë“œ IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get ciliumendpoints.cilium.io <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    cilium-monitoring    grafana-5c69859d9-zgx9k                   22364               ready            10.244.0.5</span>
<span class="c">#    cilium-monitoring    prometheus-6fc896bc5d-5rbpx               15628               ready            10.244.0.143</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-dhckj                  28257               ready            10.244.0.155</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-n4xbw                  28257               ready            10.244.0.7</span>
<span class="c">#    kube-system          hubble-relay-5dcd46f5c-9bcxl              9702                ready            10.244.0.59</span>
<span class="c">#    kube-system          hubble-ui-76d4965bb6-rq9gv                64346               ready            10.244.0.166</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-rrn2r   29718               ready            10.244.0.130</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í˜„ì¬ ëª¨ë“  íŒŒë“œê°€ k8s-ctrì—ì„œ ë™ì‘ ì¤‘ì´ì–´ì„œ 10.244.0.0/24 ì•„ì´í”¼ê°€ í• ë‹¹ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h4 id="ìƒ˜í”Œ-ì• í”Œë¦¬ì¼€ì´ì…˜-ë°°í¬-ë°-í™•ì¸">ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° í™•ì¸</h4>

<ul>
  <li>ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•˜ê³  IPAMì´ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># k8s-ctr ë…¸ë“œì— curl-pod íŒŒë“œ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>
</code></pre></div></div>

<ul>
  <li>ë°°í¬ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   2/2     2            2           77s   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.194.47   &lt;none&gt;        80/TCP    77s   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                       AGE</span>
<span class="c">#    endpoints/webpod   10.244.0.2:80,10.244.1.188:80   77s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="c"># =&gt; NAME           ADDRESSTYPE   PORTS   ENDPOINTS                 AGE</span>
<span class="c">#    webpod-j45jt   IPv4          80      10.244.0.2,10.244.1.188   95s</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="c"># IP í™•ì¸</span>
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  1072                ready            10.244.0.188</span>
<span class="c">#    webpod-697b545f57-2zpdp   24748               ready            10.244.0.2</span>
<span class="c">#    webpod-697b545f57-thl79   24748               ready            10.244.1.188</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg endpoint list

<span class="c"># í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-2zpdp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s webpod | grep Hostname; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-thl79</span>
<span class="c">#    Hostname: webpod-697b545f57-2zpdp</span>
<span class="c">#    Hostname: webpod-697b545f57-thl79</span>
<span class="c">#    Hostname: webpod-697b545f57-thl79</span>
<span class="c">#    Hostname: webpod-697b545f57-2zpdp</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>Hubble í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># hubble ui ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸ : default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸</span>
<span class="nv">$ NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"http://</span><span class="nv">$NODEIP</span><span class="s2">:30003"</span>
<span class="c"># =&gt; http://192.168.10.100:30003</span>

<span class="c"># hubble relay í¬íŠ¸ í¬ì›Œë”© ì‹¤í–‰</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; â„¹ï¸   Hubble Relay is available at 127.0.0.1:4245</span>
<span class="nv">$ </span>hubble status
<span class="c"># =&gt; Healthcheck (via localhost:4245): Ok</span>
<span class="c">#    Current/Max Flows: 5,284/8,190 (64.52%)</span>
<span class="c">#    Flows/s: 33.82</span>
<span class="c">#    Connected Nodes: 2/2</span>

<span class="c"># flow log ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--to-pod</span> curl-pod
<span class="c"># =&gt; Aug  2 08:36:29.808: default/curl-pod:56772 (ID:1072) &lt;- default/webpod-697b545f57-thl79:80 (ID:24748) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Aug  2 08:36:30.530: default/curl-pod:50248 (ID:1072) &lt;- default/webpod-697b545f57-2zpdp:80 (ID:24748) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Aug  2 08:36:30.533: default/curl-pod:50248 (ID:1072) &lt;- default/webpod-697b545f57-2zpdp:80 (ID:24748) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-pod</span> curl-pod
<span class="c"># =&gt; Aug  2 08:36:57.991: default/curl-pod (ID:1072) &lt;&gt; 10.96.194.47:80 (world) pre-xlate-fwd TRACED (TCP)</span>
<span class="c">#    Aug  2 08:36:57.991: default/curl-pod (ID:1072) &lt;&gt; default/webpod-697b545f57-thl79:80 (ID:24748) post-xlate-fwd TRANSLATED (TCP)</span>
<span class="c">#    Aug  2 08:36:57.991: default/curl-pod:51316 (ID:1072) -&gt; default/webpod-697b545f57-thl79:80 (ID:24748) to-network FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Aug  2 08:36:57.992: default/curl-pod:51316 (ID:1072) -&gt; default/webpod-697b545f57-thl79:80 (ID:24748) to-network FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Aug  2 08:36:57.993: default/curl-pod:51316 (ID:1072) -&gt; default/webpod-697b545f57-thl79:80 (ID:24748) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Aug  2 08:36:57.999: default/curl-pod:51316 (ID:1072) -&gt; default/webpod-697b545f57-thl79:80 (ID:24748) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Aug  2 08:36:57.999: default/curl-pod:51316 (ID:1072) -&gt; default/webpod-697b545f57-thl79:80 (ID:24748) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--pod</span> curl-pod
<span class="c"># =&gt; Aug  2 08:37:22.316: default/curl-pod (ID:1072) &lt;&gt; 10.96.194.47:80 (world) pre-xlate-fwd TRACED (TCP)</span>
<span class="c">#    Aug  2 08:37:22.316: default/curl-pod (ID:1072) &lt;&gt; default/webpod-697b545f57-2zpdp:80 (ID:24748) post-xlate-fwd TRANSLATED (TCP)</span>
<span class="c">#    Aug  2 08:37:22.317: default/curl-pod:51022 (ID:1072) -&gt; default/webpod-697b545f57-2zpdp:80 (ID:24748) to-endpoint FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Aug  2 08:37:22.317: default/curl-pod:51022 (ID:1072) &lt;- default/webpod-697b545f57-2zpdp:80 (ID:24748) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Aug  2 08:37:22.317: default/curl-pod:51022 (ID:1072) -&gt; default/webpod-697b545f57-2zpdp:80 (ID:24748) to-endpoint FORWARDED (TCP Flags: ACK)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ pre-xlate-fwd, TRACED : NAT (IP ë³€í™˜) ì „, ì¶”ì  ì¤‘ì¸ flow&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   post-xlate-fwd, TRANSLATED : NAT í›„ì˜ íë¦„, NAT ë³€í™˜ì´ ì¼ì–´ë‚¬ìŒ&lt;/span&gt;</span>

<span class="c"># í˜¸ì¶œ ì‹œë„</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-2zpdp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-thl79</span>
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s webpod | grep Hostname; sleep 1; done'</span>

<span class="c"># tcpdump í™•ì¸ : íŒŒë“œ IP í™•ì¸</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 tcp port 80 <span class="nt">-nn</span>
<span class="c"># =&gt; 20:11:41.085067 IP 10.244.0.188.56954 &gt; 10.244.1.188.80: Flags [P.], seq 1:71, ack 1, win 502, options [nop,nop,TS val 2064675417 ecr 2283779636], length 70: HTTP: GET / HTTP/1.1</span>

<span class="c"># http íŒ¨í‚· ìº¡ì²˜</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 tcp port 80 <span class="nt">-w</span> /tmp/http.pcap

<span class="c"># termsharkë¡œ pcap íŒŒì¼ ë¶„ì„</span>
<span class="nv">$ </span>termshark <span class="nt">-r</span> /tmp/http.pcap
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_5.png" alt="img.png" class="image-center" />
<em class="image-caption">hubble UIì—ì„œ í™•ì¸í•œ íë¦„ ì •ë³´</em></p>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_6.png" alt="img_1.png" class="image-center" />
<em class="image-caption">termsharkì—ì„œ í™•ì¸í•œ íŒ¨í‚· ì •ë³´</em></p>

<h3 id="cilium-cluster-scope">[Cilium] Cluster Scope</h3>

<p><a href="https://docs.cilium.io/en/stable/network/concepts/ipam/cluster-pool/">Docs</a>, <a href="https://docs.cilium.io/en/stable/network/kubernetes/ipam-cluster-pool/">IPAM</a></p>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_7.png" alt="img.png" /></p>

<ul>
  <li>ê° ë…¸ë“œì— ë…¸ë“œë³„ PodCIDR ë²”ìœ„ê°€ í• ë‹¹ë˜ë©°, ê° ë…¸ë“œì˜ í˜¸ìŠ¤íŠ¸ ë²”ìœ„ í• ë‹¹ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ IPë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.</li>
  <li>ì´ ëª¨ë“œëŠ” Kubernetes Host Scope IPAM ëª¨ë“œì™€ ìœ ì‚¬í•˜ì§€ë§Œ, Ciliumì´ <code class="language-plaintext highlighter-rouge">v2.CiliumNode</code>ë¼ëŠ” ë¦¬ì†ŒìŠ¤(CRD)ë¥¼ í†µí•´ ë…¸ë“œë³„ PodCIDR ë²”ìœ„ë¥¼ ê´€ë¦¬í•˜ëŠ” ì ì´ ë‹¤ë¦…ë‹ˆë‹¤.</li>
  <li>ì¥ì ì€ Kubernetesê°€ ë…¸ë“œë³„ PodCIDR ë²”ìœ„ë¥¼ ê´€ë¦¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—, Ciliumì´ ë…¸ë“œë³„ PodCIDR ë²”ìœ„ë¥¼ ë™ì ìœ¼ë¡œ í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ìµœì†Œ ë§ˆìŠ¤í¬ ê¸¸ì´ëŠ” /30ì´ë©°, ê¶Œì¥ ìµœì†Œ ë§ˆìŠ¤í¬ ê¸¸ì´ëŠ” /29 ì´ìƒì…ë‹ˆë‹¤. 2ê°œ ì£¼ì†ŒëŠ” ì˜ˆì•½ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬, ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì£¼ì†Œ)</li>
  <li>ê¸°ë³¸ pod CIDRì€ <code class="language-plaintext highlighter-rouge">10.0.0.0/8</code>ì…ë‹ˆë‹¤.</li>
</ul>

<h4 id="ipam-ëª¨ë“œë¥¼-cluster-scopeë¡œ-ë³€ê²½">IPAM ëª¨ë“œë¥¼ Cluster Scopeë¡œ ë³€ê²½</h4>

<blockquote>
  <p>ì•ì„œ ì–¸ê¸‰í•œê²ƒ ì²˜ëŸ¼ ë¼ì´ë¸Œ í™˜ê²½ì—ì„œ IPAM ëª¨ë“œë¥¼ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°˜ë³µ ìš”ì²­ í•´ë‘ê¸°</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s webpod | grep Hostname; sleep 1; done'</span>

<span class="c"># Cluster Scopre ë¡œ ì„¤ì • ë³€ê²½</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> ipam.mode<span class="o">=</span><span class="s2">"cluster-pool"</span> <span class="nt">--set</span> ipam.operator.clusterPoolIPv4PodCIDRList<span class="o">={</span><span class="s2">"172.20.0.0/16"</span><span class="o">}</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>172.20.0.0/16

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart deploy/cilium-operator <span class="c"># ì˜¤í¼ë ˆì´í„° ì¬ì‹œì‘ í•„ìš”</span>
<span class="c"># =&gt; deployment.apps/cilium-operator restarted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># ë³€ê²½ í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'</span>
<span class="c"># =&gt; k8s-ctr 10.244.0.0/24</span>
<span class="c">#    k8s-w1  10.244.1.0/24</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> ^ipam
<span class="c"># =&gt; ipam                                              cluster-pool</span>
<span class="c">#    ipam-cilium-node-update-rate                      15s</span>

<span class="nv">$ </span>kubectl get ciliumnode <span class="nt">-o</span> json | <span class="nb">grep </span>podCIDRs <span class="nt">-A2</span>
<span class="c"># =&gt;                     "podCIDRs": [</span>
<span class="c">#                            "10.244.0.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "10.244.1.0/24"</span>
<span class="c">#                        ],</span>
<span class="nv">$ </span>kubectl get ciliumendpoints.cilium.io <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    cilium-monitoring    grafana-5c69859d9-zgx9k                   22364               ready            10.244.0.5</span>
<span class="c">#    cilium-monitoring    prometheus-6fc896bc5d-5rbpx               15628               ready            10.244.0.143</span>
<span class="c">#    default              curl-pod                                  1072                ready            10.244.0.188</span>
<span class="c">#    default              webpod-697b545f57-2zpdp                   24748               ready            10.244.0.2</span>
<span class="c">#    default              webpod-697b545f57-thl79                   24748               ready            10.244.1.188</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-dhckj                  28257               ready            10.244.0.155</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-n4xbw                  28257               ready            10.244.0.7</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-rrn2r   29718               ready            10.244.0.130</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ IPAM ëª¨ë“œëŠ” ë³€ê²½ë˜ì—ˆìœ¼ë‚˜ podCIDRì„ ë¹„ë¡¯í•œ IPëŠ” ì•„ì§ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># IPAM ëª¨ë“œ ë³€ê²½ í›„, ë°˜ì˜ì„ ìœ„í•´ Cilium ë…¸ë“œ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚­ì œí•˜ê³  ë°ëª¬ì…‹ì„ ì¬ì‹œì‘í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl delete ciliumnode k8s-w1
<span class="c"># =&gt; ciliumnode.cilium.io "k8s-w1" deleted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>
<span class="nv">$ </span>kubectl get ciliumnode <span class="nt">-o</span> json | <span class="nb">grep </span>podCIDRs <span class="nt">-A2</span>
<span class="c"># =&gt;                     "podCIDRs": [</span>
<span class="c">#                            "10.244.0.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "172.20.0.0/24"</span>
<span class="c">#                        ],</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-w1ì˜ podCIDRì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get ciliumendpoints.cilium.io <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    cilium-monitoring    grafana-5c69859d9-zgx9k                   22364               ready            10.244.0.5</span>
<span class="c">#    cilium-monitoring    prometheus-6fc896bc5d-5rbpx               15628               ready            10.244.0.143</span>
<span class="c">#    default              curl-pod                                  1072                ready            10.244.0.188</span>
<span class="c">#    default              webpod-697b545f57-2zpdp                   24748               ready            10.244.0.2</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-dhckj                  28257               ready            10.244.0.155</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-n4xbw                  28257               ready            10.244.0.7</span>
<span class="c">#    kube-system          hubble-relay-5b48c999f9-qktv5             9702                ready            172.20.0.167</span>
<span class="c">#    kube-system          hubble-ui-655f947f96-ts4n6                64346               ready            172.20.0.122</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-rrn2r   29718               ready            10.244.0.130</span>

<span class="c"># ë§ˆì°¬ê°€ì§€ë¡œ k8s-ctr ë…¸ë“œì˜ podCIDRë„ ë³€ê²½í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl delete ciliumnode k8s-ctr
<span class="c"># =&gt; ciliumnode.cilium.io "k8s-ctr" deleted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>
<span class="nv">$ </span>kubectl get ciliumnode <span class="nt">-o</span> json | <span class="nb">grep </span>podCIDRs <span class="nt">-A2</span>
<span class="c"># =&gt;                     "podCIDRs": [</span>
<span class="c">#                            "172.20.1.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "172.20.0.0/24"</span>
<span class="c">#                        ],</span>
<span class="nv">$ </span>kubectl get ciliumendpoints.cilium.io <span class="nt">-A</span> <span class="c"># íŒŒë“œ IP ë³€ê²½ ë˜ëŠ”ê°€?</span>
<span class="c"># =&gt; NAMESPACE     NAME                            SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-tg9ll        28257               ready            172.20.0.56</span>
<span class="c">#    kube-system   hubble-relay-5b48c999f9-qktv5   9702                ready            172.20.0.167</span>
<span class="c">#    kube-system   hubble-ui-655f947f96-ts4n6      64346               ready            172.20.0.122</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë…¸ë“œì˜ podcidr static routing ìë™ ë³€ê²½ ì ìš© í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.1.113 dev lxc781feae60918&lt;/span&gt; proto kernel scope link</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.0.56 dev lxc1bf5de6d4ec4&lt;/span&gt; proto kernel scope link</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.0.122 dev lxcb644cb2f80be&lt;/span&gt; proto kernel scope link</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.0.167 dev lxc9c5d083a0332&lt;/span&gt; proto kernel scope link</span>

<span class="c"># ì§ì ‘ rollout restart í•˜ì! </span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span> | <span class="nb">grep </span>10.244.
<span class="c"># =&gt; cilium-monitoring    grafana-5c69859d9-zgx9k                   0/1     Running   1 (4h58m ago)   20h     10.244.0.5       k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    cilium-monitoring    prometheus-6fc896bc5d-5rbpx               1/1     Running   1 (4h58m ago)   20h     10.244.0.143     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    default              curl-pod                                  1/1     Running   0               4h18m   10.244.0.188     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    default              webpod-697b545f57-2zpdp                   1/1     Running   0               4h18m   10.244.0.2       k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    default              webpod-697b545f57-thl79                   1/1     Running   0               4h18m   10.244.1.188     k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-rrn2r   1/1     Running   1 (4h58m ago)   20h     10.244.0.130     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì•„ì§ ë³€ê²½ë˜ì§€ ì•Šì€ podë“¤ì´ ë‚¨ì•„ìˆì–´ì„œ ì¬ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart deploy/hubble-relay deploy/hubble-ui
<span class="c"># =&gt; deployment.apps/hubble-relay restarted</span>
<span class="c">#    deployment.apps/hubble-ui restarted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> cilium-monitoring rollout restart deploy/prometheus deploy/grafana
<span class="c"># =&gt; deployment.apps/prometheus restarted</span>
<span class="c">#    deployment.apps/grafana restarted</span>
<span class="nv">$ </span>kubectl rollout restart deploy/webpod
<span class="c"># =&gt; deployment.apps/webpod restarted</span>

<span class="c">#</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; â„¹ï¸ Hubble Relay is available at 127.0.0.1:4245</span>

<span class="c"># curl-podëŠ” íŒŒë“œë§Œ ìˆ˜ë™ìœ¼ë¡œ ë°°í¬í•œê²ƒì´ë¼ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ë§Œë“¤ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl delete pod curl-pod
<span class="c"># =&gt; pod "curl-pod" deleted</span>
<span class="c"># k8s-ctr ë…¸ë“œì— curl-pod íŒŒë“œ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>

<span class="c"># íŒŒë“œ IP ë³€ê²½ í™•ì¸!</span>
<span class="nv">$ </span>kubectl get ciliumendpoints.cilium.io <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE           NAME                            SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    cilium-monitoring   grafana-74f45ff4b-8s8jk         22364               ready            172.20.0.129</span>
<span class="c">#    cilium-monitoring   prometheus-5cd9888b5c-nq2jh     15628               ready            172.20.0.22</span>
<span class="c">#    default             curl-pod                        1072                ready            172.20.1.80</span>
<span class="c">#    default             webpod-bb8b9557f-7rn8t          24748               ready            172.20.0.130</span>
<span class="c">#    default             webpod-bb8b9557f-9tzvj          24748               ready            172.20.1.31</span>
<span class="c">#    kube-system         coredns-674b8bbfcf-58c7n        28257               ready            172.20.1.113</span>
<span class="c">#    kube-system         coredns-674b8bbfcf-tg9ll        28257               ready            172.20.0.56</span>
<span class="c">#    kube-system         hubble-relay-575fc84f49-m7bkm   9702                ready            172.20.0.177</span>
<span class="c">#    kube-system         hubble-ui-5b686f8966-cnqxd      64346               ready            172.20.0.244</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ëª¨ë“  íŒŒë“œì˜ IPê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë°˜ë³µ ìš”ì²­</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s webpod | grep Hostname; sleep 1; done'</span>
</code></pre></div></div>

<ul>
  <li>ì´ë ‡ë“¯ IPAM ëª¨ë“œë¥¼ ë³€ê²½í•´ë„ ì´ë¯¸ ë°°í¬ëœ íŒŒë“œë“¤ì€ IPê°€ ë³€ê²½ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ìš´ì˜ì¤‘ì¸ í´ëŸ¬ìŠ¤í„°ì—ì„œ IPAM ëª¨ë“œë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒì€ ê¶Œì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. <br />
ìƒˆë¡œìš´ IPAM ëª¨ë“œë¡œ ìƒˆë¡œìš´ í´ëŸ¬ìŠ¤í„°ë¥¼ ì„¤ì¹˜í•˜ê³ , ê¸°ì¡´ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì›Œí¬ë¡œë“œë¥¼ ì´ì „í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ì…ë‹ˆë‹¤.</li>
</ul>

<h3 id="cilium-cni-chaining-aws-vpc-cni-plugin">[Cilium CNI Chaining] AWS VPC CNI plugin</h3>

<p><a href="https://docs.cilium.io/en/stable/installation/cni-chaining-aws-cni/">Docs</a></p>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_8.png" alt="img.png" /></p>

<ul>
  <li>ì´ë²ˆì— ì•Œì•„ë³¼ ê²ƒì€ Ciliumì„ AWS VPC CNI í”ŒëŸ¬ê·¸ì¸ê³¼ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.</li>
  <li>ì´ í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œì—ì„œëŠ” AWS VPC CNI í”ŒëŸ¬ê·¸ì¸ì´ ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ ì„¤ì •ë¿ë§Œ ì•„ë‹ˆë¼ ENIë¥¼ í†µí•œ IP ì£¼ì†Œ ê´€ë¦¬(IPAM)ë„ ë‹´ë‹¹í•©ë‹ˆë‹¤.</li>
  <li>ì£¼ì–´ì§„ podì— ëŒ€í•´ ì´ˆê¸° ë„¤íŠ¸ì›Œí‚¹ì´ ì„¤ì •ëœ í›„, Cilium CNI í”ŒëŸ¬ê·¸ì¸ì€ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ì‹œí–‰í•˜ê³  ë¡œë“œë°¸ëŸ°ì‹±ì„ ìˆ˜í–‰í•˜ë©° ì•”í˜¸í™”ë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ AWS VPC CNI í”ŒëŸ¬ê·¸ì¸ì´ ì„¤ì •í•œ ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ì— eBPF í”„ë¡œê·¸ë¨ì„ ì—°ê²°í•˜ë„ë¡ í˜¸ì¶œí•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_9.png" alt="img.png" /></p>

<ul>
  <li><strong>AWS-CNI ì—­í• </strong> : Device plumbing, IPAM(ENI), Routing(Native-Routing ë“±)</li>
  <li><strong>Cilium ì—­í• </strong> : LB, Network Policy, Encrption, Multi-Cluster, Visiblity</li>
  <li><strong>ì„¤ì •</strong>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> 1.17.6 <span class="se">\</span>
  <span class="nt">--namespace</span> kube-system <span class="se">\</span>
  <span class="nt">--set</span> cni.chainingMode<span class="o">=</span>aws-cni <span class="se">\</span>
  <span class="nt">--set</span> cni.exclusive<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">enableIPv4Masquerade</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native
</code></pre></div>    </div>
  </li>
  <li>AWS ENI IPAM ëª¨ë“œ 
<a href="https://docs.cilium.io/en/stable/network/concepts/ipam/eni/">Docs</a>
<img src="/assets/2025/cilium/w3/20250803_cilium_w3_10.png" alt="img.png" /></li>
  <li>AWS ENI í• ë‹¹ê¸°ëŠ” AWS í´ë¼ìš°ë“œì—ì„œ ìˆ˜í–‰ë˜ëŠ” Cilium ë°°í¬ì— íŠ¹í™”ë˜ì–´ìˆìœ¼ë©°, AWS EC2 APIì™€ í†µì‹ í•˜ì—¬ AWS Elastic Network Interface(ENI)ì˜ IPë¥¼ ê¸°ë°˜ìœ¼ë¡œ IP ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.</li>
  <li>ì´ ëª¨ë“œëŠ” ëŒ€ê·œëª¨ í´ëŸ¬ìŠ¤í„°ì—ì„œì˜ ì†ë„ ì œí•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë‹¨ì¼ ìš´ì˜ìë§Œ EC2 ì„œë¹„ìŠ¤ APIì™€ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.</li>
  <li>ì‚¬ì „ í• ë‹¹ ì›Œí„°ë§ˆí¬ëŠ” í´ëŸ¬ìŠ¤í„°ì—ì„œ ìƒˆ podê°€ ì˜ˆì•½ë ë•Œ EC2 APIë¥¼ í˜¸ì¶œí•  í•„ìš”ì—†ì´ ë…¸ë“œì—ì„œ í•­ìƒ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì—¬ëŸ¬ IP ì£¼ì†Œë¥¼ ìœ ì§€í•˜ëŠ”ë° ì‚¬ìš©ë©ë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="routing">Routing</h2>

<ul>
  <li>Ciliumì€ Encapsulationê³¼ Native Routingì„ ì§€ì›í•©ë‹ˆë‹¤. ê°ê°ì— ëŒ€í•´ ì‚´í´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="method-1-encapsulation-vxlan-geneve">Method 1. Encapsulation (VXLAN, GENEVE)</h3>

<p><a href="https://docs.cilium.io/en/stable/network/concepts/routing/">Docs</a></p>

<ul>
  <li>Encapsulation ëª¨ë“œëŠ” íŠ¹ë³„í•œ ì¸í”„ë¼ ìš”êµ¬ì‚¬í•­ì´ ì—†ê¸° ë•Œë¬¸ì— Ciliumì€ ê¸°ë³¸ì ìœ¼ë¡œ Encapsulation ëª¨ë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>ì´ ëª¨ë“œì—ì„œëŠ” ëª¨ë“  í´ëŸ¬ìŠ¤í„° ë…¸ë“œê°€ UDP ê¸°ë°˜ì˜ VXLAN ë˜ëŠ” GENEVEë¥¼ ì‚¬ìš©í•˜ì—¬ í„°ë„ë§ì„ í†µí•´ ì„œë¡œ í†µì‹ í•©ë‹ˆë‹¤.</li>
  <li>Cilium ë…¸ë“œê°„ì˜ ëª¨ë“  íŠ¸ë˜í”½ì´ ìº¡ìŠí™” ë©ë‹ˆë‹¤.</li>
  <li>ê·¸ë¦¬ê³  ìº¡ìŠí™”ëŠ” ì¼ë°˜ ë…¸ë“œê°„ ì—°ê²°ì— ì˜ì¡´í•©ë‹ˆë‹¤. ì¦‰, Cilium ë…¸ë“œê°€ ì´ë¯¸ ì„œë¡œ ì—°ê²°ë  ìˆ˜ ìˆë‹¤ë©´ Encapsulation ëª¨ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ì´ì•¼ê¸° ì…ë‹ˆë‹¤.</li>
  <li>ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ëŠ” IPv4ë¥¼ ì§€ì›í•´ì•¼ í•˜ë©°, ë‹¤ìŒì˜ UDP í¬íŠ¸ë¥¼ ë°©í™”ë²½ì—ì„œ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤.
    <ul>
      <li>VXLAN (Defaut) : UDP 8472</li>
      <li>GENEVE : UDP 6081</li>
    </ul>
  </li>
  <li>ì¥ì 
    <ul>
      <li><strong>ë‹¨ìˆœí•¨</strong> (Simplicity)
        <ul>
          <li>
            <ul>
              <li>í´ëŸ¬ìŠ¤í„° ë…¸ë“œë¥¼ ì—°ê²°í•˜ëŠ” ë„¤íŠ¸ì›Œí¬ëŠ” PodCIDRì„ ì¸ì‹í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
            </ul>
          </li>
          <li>í´ëŸ¬ìŠ¤í„° ë…¸ë“œëŠ” ì—¬ëŸ¬ ë¼ìš°íŒ… ë˜ëŠ” ë§í¬ ê³„ì¸µ ë„ë©”ì¸ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>í´ëŸ¬ìŠ¤í„° ë…¸ë“œê°€ IP/UDPë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¡œ ì—°ê²°í•  ìˆ˜ ìˆëŠ” í•œ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ì˜ í† í´ë¡œì§€ëŠ” ì¤‘ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><strong>ì •ì²´ì„± ë§¥ë½</strong> (Identity context)
        <ul>
          <li>ìº¡ìŠí™” í”„ë¡œí† ì½œì€ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ê³¼ í•¨ê»˜ ë©”íƒ€ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.</li>
          <li>Ciliumì€ ì†ŒìŠ¤ ë³´ì•ˆ IDì™€ ê°™ì€ ë©”íƒ€ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ì´ ê¸°ëŠ¥ì„ í™œìš©í•©ë‹ˆë‹¤.</li>
          <li>ì •ì²´ì„± ì „ë‹¬ì€ ì›ê²© ë…¸ë“œì—ì„œ í•˜ë‚˜ì˜ ì •ì²´ì„± ì¡°íšŒë¥¼ í”¼í•˜ê¸° ìœ„í•´ ì„¤ê³„ëœ ìµœì í™”ì…ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ë‹¨ì 
    <ul>
      <li><strong>MTU Overhead</strong>
        <ul>
          <li>ìº¡ìŠí™” í—¤ë”ê°€ ì¶”ê°€ë¨ì— ì˜í•´ì„œ í˜ì´ë¡œë“œì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìœ íš¨ MTUê°€ ì¤„ì–´ë“­ë‹ˆë‹¤. (VXLANì˜ ê²½ìš° 50ë°”ì´íŠ¸, GENEVEì˜ ê²½ìš° 60ë°”ì´íŠ¸)</li>
          <li>ì´ë¡œ ì¸í•´ íŠ¹ì • ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ëŒ€í•œ ìµœëŒ€ ì²˜ë¦¬ëŸ‰ì´ ë‚®ì•„ì§‘ë‹ˆë‹¤.</li>
          <li>ì ë³´ í”„ë ˆì„(Jumbo Frame)ì„ ì‚¬ìš©í•˜ì—¬ MTUë¥¼ ëŠ˜ë ¤ í•´ë‹¹ ë¬¸ì œë¥¼ í¬ê²Œ ì™„í™”í•  ìˆ˜ ìˆì§€ë§Œ, ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ê°€ ì ë³´ í”„ë ˆì„ì„ ì§€ì›í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li><strong>Encapsulation/Decapsulation Overhead</strong>
        <ul>
          <li>ìº¡ìŠí™” ë° ë””ìº¡ìŠí™”ëŠ” CPU ì˜¤ë²„í—¤ë“œë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.</li>
          <li>ì´ ì˜¤ë²„í—¤ë“œëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ì— ë¹„í•´ ì‘ì§€ë§Œ, ëŒ€ê·œëª¨ í´ëŸ¬ìŠ¤í„°ì—ì„œëŠ” ì„±ëŠ¥ì— ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ì„¤ì •ë°©ë²•
    <ul>
      <li><code class="language-plaintext highlighter-rouge">tunnel-protocol</code> : Encapsulation í”„ë¡œí† ì½œì„ <code class="language-plaintext highlighter-rouge">vxlan</code>ì´ë‚˜ <code class="language-plaintext highlighter-rouge">geneve</code>ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. (ê¸°ë³¸ê°’: vxlan)</li>
      <li><code class="language-plaintext highlighter-rouge">tunnel-port</code> : Encapsulation í”„ë¡œí† ì½œì„ ìœ„í•œ UDP í¬íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. vxlanì˜ ê²½ìš° 8472, geneveì˜ ê²½ìš° 6081ì…ë‹ˆë‹¤. (ê¸°ë³¸ê°’: 8472)</li>
    </ul>
  </li>
</ul>

<h3 id="method-2-native-routing">Method 2. Native Routing</h3>

<p><a href="https://docs.cilium.io/en/stable/network/concepts/routing/#native-routing">Docs</a></p>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_11.png" alt="img.png" /></p>

<ul>
  <li>Native Routing ëª¨ë“œëŠ” Ciliumì´ ìº¡ìŠí™” ì—†ì´ Pod ê°„ì— ì§ì ‘ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.</li>
  <li>ìº¡ìŠí™”ë¥¼ ìˆ˜í–‰í•˜ëŠ” ëŒ€ì‹  Ciliumì´ ì‹¤í–‰ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ì˜ ë¼ìš°íŒ… ê¸°ëŠ¥ì„ í™œìš©í•©ë‹ˆë‹¤.</li>
  <li>Native Routing ëª¨ë“œì—ì„œëŠ” Ciliumì´ ë‹¤ë¥¸ ë¡œì»¬ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì£¼ì†Œë¥¼ ì§€ì •í•˜ì§€ ì•Šì€ ëª¨ë“  íŒ¨í‚·ì„ Linux ì»¤ë„ ë¼ìš°íŒ… í•˜ìœ„ ì‹œìŠ¤í…œì— ìœ„ì„í•©ë‹ˆë‹¤.</li>
  <li>ì´ëŠ” íŒ¨í‚·ì´ ë¡œì»¬ í”„ë¡œì„¸ìŠ¤ê°€ íŒ¨í‚·ì„ ë°©ì¶œí•˜ëŠ” ê²ƒ ì²˜ëŸ¼ ë¼ìš°íŒ… ëœë‹¤ëŠ”ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
  <li>ë”°ë¼ì„œ í´ëŸ¬ìŠ¤í„° ë…¸ë“œë¥¼ ì—°ê²°í•˜ëŠ” ë„¤íŠ¸ì›Œí¬ê°€ PodCIDRì„ ì¸ì‹í•˜ê³ , PodCIDRë¥¼ ë¼ìš°íŒ…í•˜ëŠ” ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>PodCIDR ë¼ìš°íŒ… ë°©ì•ˆ 1
    <ul>
      <li>ê° ê°œë³„ ë…¸ë“œëŠ” ë‹¤ë¥¸ ëª¨ë“  ë…¸ë“œì˜ ëª¨ë“  í¬ë“œ IPë¥¼ ì¸ì‹í•˜ê³  ì´ë¥¼ í‘œí˜„í•˜ê¸° ìœ„í•´ Linux ì»¤ë„ ë¼ìš°íŒ… í…Œì´ë¸”ì— ì‚½ì…í•©ë‹ˆë‹¤.</li>
      <li>ëª¨ë“  ë…¸ë“œê°€ ë‹¨ì¼ L2 ë„¤íŠ¸ì›Œí¬ë¥¼ ê³µìœ í•˜ëŠ” ê²½ìš° <code class="language-plaintext highlighter-rouge">auto-direct-node-routes: true</code>í•˜ì—¬ ì´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ <strong>BGP</strong> ë°ëª¬ê³¼ ê°™ì€ ì¶”ê°€ ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œë¥¼ ì‹¤í–‰í•˜ì—¬ ê²½ë¡œë¥¼ ë°°í¬í•´ì•¼ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>PodCIDR ë¼ìš°íŒ… ë°©ì•ˆ 2
    <ul>
      <li>ë…¸ë“œ ìì²´ëŠ” ëª¨ë“  í¬ë“œ IPë¥¼ ë¼ìš°íŒ…í•˜ëŠ” ë°©ë²•ì„ ëª¨ë¥´ì§€ë§Œ ë‹¤ë¥¸ ëª¨ë“  í¬ë“œì— ë„ë‹¬í•˜ëŠ” ë°©ë²•ì„ ì•„ëŠ” ë¼ìš°í„°ê°€ ë„¤íŠ¸ì›Œí¬ì— ì¡´ì¬í•©ë‹ˆë‹¤.</li>
      <li>ì´ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” Linux ë…¸ë“œê°€ ì´ëŸ¬í•œ ë¼ìš°í„°ë¥¼ ê°€ë¦¬í‚¤ëŠ” ê¸°ë³¸ ê²½ë¡œë¥¼ í¬í•¨í•˜ë„ë¡ êµ¬ì„±ë©ë‹ˆë‹¤.</li>
      <li>ì´ ëª¨ë¸ì€ í´ë¼ìš°ë“œ ì œê³µì ë„¤íŠ¸ì›Œí¬ í†µí•©ì— ì‚¬ìš©ë©ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ <a href="https://docs.cilium.io/en/stable/network/concepts/routing/#google-cloud">Google Cloud</a>, <a href="https://docs.cilium.io/en/stable/network/concepts/routing/#aws-eni">AWS ENI</a> ë° Azure IPAMì„ ì°¸ì¡°í•˜ì„¸ìš”.</li>
    </ul>
  </li>
  <li>ì„¤ì •ë°©ë²•
    <ul>
      <li><code class="language-plaintext highlighter-rouge">routing-mode: native</code>: Native Routing ëª¨ë“œë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">ipv4-native-routing-cidr: x.x.x.x/y</code>: Native Routing ëª¨ë“œì—ì„œ PodCIDRë¥¼ ë¼ìš°íŒ…í•˜ëŠ” CIDRì„ ì„¤ì •í•©ë‹ˆë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">auto-direct-node-routes: true</code> : ë™ì¼ L2 ë„¤íŠ¸ì›Œí¬ ê³µìœ  ì‹œ, ê±± ë…¸ë“œì˜ PodCIDRì— ëŒ€í•œ Linux ì»¤ë„ ë¼ìš°íŒ… í…Œì´ë¸”ì— ì‚½ì…í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Native Roung ì‹¤ìŠµì„ ìœ„í•œ Cilium Agent ë‹¨ì¶•í‚¤ ì§€ì •
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium íŒŒë“œ ì´ë¦„</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-ctr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CILIUMPOD0</span> <span class="nv">$CILIUMPOD1</span> <span class="nv">$CILIUMPOD2</span>
<span class="c"># =&gt; cilium-6ggxf cilium-hb6jp</span>
  
<span class="c"># ë‹¨ì¶•í‚¤(alias) ì§€ì •</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
</code></pre></div>    </div>
  </li>
  <li>ë…¸ë“œê°„ íŒŒë“œ í†µì‹  ìƒì„¸ í™•ì¸ with Native Routing</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   STATUS    RESTARTS   AGE    IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                 1/1     Running   0          104m   172.20.1.80    k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-bb8b9557f-7rn8t   1/1     Running   0          105m   172.20.0.130   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-bb8b9557f-9tzvj   1/1     Running   0          105m   172.20.1.31    k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># Webpod1,2 íŒŒë“œ IP</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPODIP1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod pods <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-ctr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPODIP2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod pods <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPODIP1</span> <span class="nv">$WEBPODIP2</span>
<span class="c"># =&gt; 172.20.1.31 172.20.0.130</span>

<span class="c"># curl-pod ì—ì„œ WEBPODIP2 ë¡œ ping</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nv">$WEBPODIP2</span>

<span class="c"># ì»¤ë„ ë¼ìš°íŒ… í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.0.0/24 via 192.168.10.101 dev eth1 proto kernel&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ curl-podê°€ ìˆëŠ” k8s-ctrì—ì„œëŠ” WEBPODIP2ì˜ 172.20.0.130ì´ í¬í•¨ëœ íŒ¨í‚·ì„ 192.168.10.101 (k8s-w1 ë…¸ë“œ IP)ë¡œ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.0.130 dev lxc9938d1653585 proto kernel scope link&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-w1ì—ì„œëŠ” 172.20.0.130ì˜ IPë¥¼ í•´ë‹¹ podì˜ vethë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; â„¹ï¸   Hubble Relay is available at 127.0.0.1:4245</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--pod</span> curl-pod
<span class="c"># =&gt; Aug  2 14:29:00.271: default/curl-pod (ID:1072) -&gt; default/webpod-bb8b9557f-7rn8t (ID:24748) to-network FORWARDED (ICMPv4 EchoRequest)</span>
<span class="c">#    Aug  2 14:29:00.272: default/curl-pod (ID:1072) &lt;- default/webpod-bb8b9557f-7rn8t (ID:24748) to-endpoint FORWARDED (ICMPv4 EchoReply)</span>

<span class="c">#</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 icmp
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="c">#    listening on eth1, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="c">#    23:29:18.464606 IP 172.20.1.80 &gt; 172.20.0.130: ICMP echo request, id 13, seq 815, length 64</span>
<span class="c">#    23:29:18.465333 IP 172.20.0.130 &gt; 172.20.1.80: ICMP echo reply, id 13, seq 815, length 64</span>

<span class="c">#</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 icmp <span class="nt">-w</span> /tmp/icmp.pcap
<span class="nv">$ </span>termshark <span class="nt">-r</span> /tmp/icmp.pcap
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_14.png" alt="img.png" class="image-center" />
<em class="image-caption">termsharkì—ì„œ í™•ì¸í•œ ICMP íŒ¨í‚· ì •ë³´</em></p>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_13.png" alt="img_1.png" class="image-center" />
<em class="image-caption">Hubble UIì—ì„œ í™•ì¸í•œ ICMP íë¦„ ì •ë³´</em></p>

<hr />

<h2 id="masquerading">Masquerading</h2>

<h3 id="masquerading-ì†Œê°œ">Masquerading ì†Œê°œ</h3>

<p><a href="https://docs.cilium.io/en/stable/network/concepts/masquerading/">Docs</a></p>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_15.png" alt="img.png" /></p>

<ul>
  <li>MasqueradingëŠ” Podê°€ ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ì™€ í†µì‹ í•  ë•Œ Podì˜ IP ì£¼ì†Œë¥¼ Cilium ë…¸ë“œì˜ IP ì£¼ì†Œë¡œ ë³€í™˜í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</li>
  <li>Podì—ì„œ ì‚¬ìš©ë˜ëŠ” IPv4 ì£¼ì†ŒëŠ” ì¼ë°˜ì ìœ¼ë¡œ RFC1918 ê°œì¸ ì£¼ì†Œ ê³µê°„ì— í• ë‹¹ë˜ë¯€ë¡œ ì™¸ë¶€ë¡œ ë¼ìš°íŒ… í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
  <li>Ciliumì€ ì´ëŸ¬í•œ Pod IPë¥¼ ì´ë¯¸ ë„¤íŠ¸ì›Œí¬ì—ì„œ ë¼ìš°íŒ… ê°€ëŠ¥í•œ Cilium ë…¸ë“œì˜ IPë¡œ ë³€í™˜í•˜ì—¬ ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ì™€ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.</li>
  <li>
    <p>ë§Œì•½ masquerading ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë ¤ë©´,  <code class="language-plaintext highlighter-rouge">enable-ipv4-masquerade: false</code>, <code class="language-plaintext highlighter-rouge">enable-ipv6-masquerade: false</code> ë¥¼ ì§€ì •í•©ë‹ˆë‹¤</p>
  </li>
  <li>ê¸°ë³¸ ë™ì‘ì€ ë¡œì»¬ ë…¸ë“œì˜ IP í• ë‹¹ CIDR ë‚´ì—ì„œ ëª¨ë“  ëª©ì ì§€ë¥¼ ì œì™¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</li>
  <li>ì¦‰, Podê°€ ë¡œì»¬ ë…¸ë“œì˜ IP í• ë‹¹ CIDR ë‚´ì— ìˆëŠ” ë‹¤ë¥¸ Podì™€ í†µì‹ í•  ë•ŒëŠ” masqueradingë¥¼ ìˆ˜í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
  <li>ë” ë„“ì€ CIDR ë²”ìœ„ë¥¼ ì œì™¸í•˜ë ¤ë©´ <code class="language-plaintext highlighter-rouge">ipv4-native-routing-cidr: 10.0.0/8</code> (ë˜ëŠ” IPv6 ì£¼ì†Œì˜ ê²½ìš° <code class="language-plaintext highlighter-rouge">ipv6-native-routing-cidr: fd00:/100</code>) 
ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° í•´ë‹¹ CIDR ë‚´ì˜ ëª¨ë“  ëª©ì ì§€ëŠ” masquerade ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ebpf-ê¸°ë°˜-masquerading">eBPF ê¸°ë°˜ Masquerading</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">bpf.masquerade=true</code> ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ eBPF ê¸°ë°˜ masqueradingì„ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê¸°ë³¸ì ìœ¼ë¡œ BPF masqueradingì€ BPF Host-Routing ëª¨ë“œë„ í™œì„±í™” ì‹œí‚µë‹ˆë‹¤. í•´ë‹¹ ëª¨ë“œì˜ ì¥ì ê³¼ í•œê³„ë¥¼ í™•ì¸í•˜ë ¤ë©´ <a href="https://docs.cilium.io/en/stable/operations/performance/tuning/#ebpf-host-routing">eBPF Host-Routing</a> ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.</li>
  <li>Masqueradingì€ eBPF Masquerading í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•˜ëŠ” ì¥ì¹˜ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤.</li>
  <li>ì´ëŠ” ì¶œë ¥ ì¥ì¹˜ê°€ í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•˜ëŠ” ê²½ìš° Podì—ì„œ ì™¸ë¶€ì£¼ì†Œë¡œ ì „ì†¡ëœ íŒ¨í‚·ì´ Masquerading(ì¶œë ¥ì¥ì¹˜ IPv4 ì£¼ì†Œë¡œ) ëœë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent  <span class="nt">--</span> cilium status | <span class="nb">grep </span>Masquerading
<span class="c"># =&gt; Masquerading:            BPF   [eth0, eth1]   172.20.0.0/16  [IPv4: Enabled, IPv6: Disabled]</span>
</code></pre></div>    </div>
  </li>
  <li>ì§€ì •ë˜ì§€ ì•ŠëŠ” ê²½ìš°, í”„ë¡œê·¸ë¨ì€ BPF NodePort ì¥ì¹˜ ê°ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ìë™ìœ¼ë¡œ ê°ì§€ë©ë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½í•˜ë ¤ë©´ <code class="language-plaintext highlighter-rouge">devices</code> helm ì˜µì…˜ì„ ì‚¬ìš©í•˜ì„¸ìš”.</li>
  <li>eBPF ê¸°ë°˜ Masqueradingì€ TCP, UDP ë° ICMP í”„ë¡œí† ì½œì„ ì§€ì›í•©ë‹ˆë‹¤.</li>
  <li>ê¸°ë³¸ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">ipv4-native-routing-cidr</code> ë²”ìœ„ë¥¼ ë²—ì–´ë‚œ IP ì£¼ì†Œë¥¼ í–¥í•˜ëŠ” ëª¨ë“  íŒ¨í‚·ì„ Masqueradeí•˜ì§€ë§Œ, ë‹¤ë¥¸ í´ëŸ¬ìŠ¤í„° ë…¸ë“œì˜ Node IPë¡œ í–¥í•˜ëŠ” íŒ¨í‚·ì€ ì œì™¸ë©ë‹ˆë‹¤.
eBPF Masqueradingì´ í™œì„±í™”ë˜ë©´ podì—ì„œ í´ëŸ¬ìŠ¤í„° ë…¸ë“œì˜ External IPë¡œì˜ íŠ¸ë˜í”½ë„ Masquerading ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>cilium config view  | <span class="nb">grep </span>ipv4-native-routing-cidr
<span class="c"># =&gt; ipv4-native-routing-cidr                          172.20.0.0/16</span>
  
<span class="c"># ë…¸ë“œ IPë¡œ í†µì‹  ì‹œ í™•ì¸</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 icmp <span class="nt">-nn</span>
<span class="c"># =&gt; 23:58:58.175157 IP 172.20.1.80 &gt; 192.168.10.101: ICMP echo request, id 31, seq 1, length 64</span>
<span class="c">#    23:58:58.175918 IP 192.168.10.101 &gt; 172.20.1.80: ICMP echo reply, id 31, seq 1, length 64</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ Node IPë¡œì˜ íŒ¨í‚·ì€ Masquerading ë˜ì§€ ì•Šê³  Pod IPê°€ ì‚¬ìš©ë¨ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping 192.168.10.101
<span class="c"># =&gt; PING 192.168.10.101 (192.168.10.101) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.10.101: icmp_seq=1 ttl=63 time=0.888 ms</span>
<span class="c">#    ...</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="iptables-ê¸°ë°˜-masquerading">iptables ê¸°ë°˜ Masquerading</h3>

<ul>
  <li>ì´ ëª¨ë“œëŠ” ëª¨ë“  ì»¤ë„ë²„ì „ì—ì„œ ì‘ë™í•  ìˆ˜ ìˆëŠ” ë ˆê±°ì‹œ êµ¬í˜„ì…ë‹ˆë‹¤.</li>
  <li>Cilium ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ê°€ ì•„ë‹Œ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ì—ì„œ iptablesë¥¼ ì‚¬ìš©í•˜ì—¬ masqueradingì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
  <li>masqueradingì´ ì‚¬ìš©ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ë¥¼ ì œí•œí•˜ê³  ì‹¶ì„ ê²½ìš° <code class="language-plaintext highlighter-rouge">egress-masquerade-interfaces: eth0</code> ì˜µì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>ëŒ€ìƒ ë„¤íŠ¸ì›Œí¬ CIDRì— ë”°ë¼ ë‹¤ë¥¸ ì†ŒìŠ¤ ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ëŠ” ê³ ê¸‰ êµ¬ì„±ì„ ìœ„í•´ì„œëŠ” <code class="language-plaintext highlighter-rouge">enable-masquerade-to-route-source: "true"</code>ë¥¼ ì‚¬ìš©í•˜ì—¬, ë©”ì¸ network interfaceì˜ ì£¼ì†ŒëŒ€ì‹  ì†ŒìŠ¤ ì£¼ì†Œë“¤ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="masquerading-ì‹¤ìŠµ">Masquerading ì‹¤ìŠµ</h3>

<ul>
  <li>ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±
<img src="/assets/2025/cilium/w3/20250803_cilium_w3_16.png" alt="img.png" />
    <ul>
      <li><strong>router</strong> : ì‚¬ë‚´ë§ 10.10.0.0/16 ëŒ€ì—­ í†µì‹ ê³¼ ì—°ê²°, k8sì— join ë˜ì§€ ì•Šì€ web ì„œë²„, loop1/loop2 dump ì¸í„°í˜ì´ìŠ¤ë¥¼ ë°°ì¹˜</li>
    </ul>
  </li>
  <li>í˜„ì¬ ìƒíƒœ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í˜„ì¬ ì„¤ì • í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent  <span class="nt">--</span> cilium status | <span class="nb">grep </span>Masquerading
<span class="c"># =&gt; Masquerading:            BPF   [eth0, eth1]   172.20.0.0/16  [IPv4: Enabled, IPv6: Disabled]</span>
<span class="c">#</span>
<span class="nv">$ </span>cilium config view  | <span class="nb">grep </span>ipv4-native-routing-cidr
<span class="c"># =&gt; ipv4-native-routing-cidr                          172.20.0.0/16</span>

<span class="c"># iptables í™•ì¸</span>
<span class="nv">$ </span>iptables-save | <span class="nb">grep</span> <span class="nt">-v</span> KUBE | iptables-restore
<span class="nv">$ </span>iptables-save

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 <span class="s2">"sudo iptables-save | grep -v KUBE | sudo iptables-restore"</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 <span class="nb">sudo </span>iptables-save

<span class="c"># í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-bb8b9557f-7rn8t</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-bb8b9557f-9tzvj</span>
</code></pre></div></div>

<ul>
  <li>router eth1 192.168.10.200 í†µì‹  í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„ 2ê°œ ì‚¬ìš©</span>
<span class="o">[</span>k8s-ctr] <span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 icmp <span class="nt">-nn</span> <span class="c"># í˜¹ì€ hubble observe -f --pod curl-pod</span>
<span class="o">[</span>router] <span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 icmp <span class="nt">-nn</span>

<span class="c"># router eth1 192.168.10.200 ë¡œ ping &gt;&gt; IP í™•ì¸í•´ë³´ì!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping 192.168.10.101
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-ctr ìª½ì—ë§Œ íŒ¨í‚·ì´ ìº¡ì³ë¨&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping 192.168.10.200
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-ctr ë° router ëª¨ë‘ íŒ¨í‚·ì´ ìº¡ì³ë¨&lt;/span&gt;</span>

<span class="c"># k8s-ctr íŒ¨í‚· ìº¡ì³ ê²°ê³¼</span>
<span class="c"># =&gt; 00:45:19.552476 IP 192.168.10.100 &gt; 192.168.10.200: ICMP echo request, id 73, seq 1, length 64</span>
<span class="c">#    00:45:19.553044 IP 192.168.10.200 &gt; 192.168.10.100: ICMP echo reply, id 73, seq 1, length 64</span>
<span class="c">#    ...</span>

<span class="c"># router íŒ¨í‚· ìº¡ì³ ê²°ê³¼</span>
<span class="c"># =&gt; 00:45:19.494633 IP 192.168.10.100 &gt; 192.168.10.200: ICMP echo request, id 73, seq 1, length 64</span>
<span class="c">#    00:45:19.494758 IP 192.168.10.200 &gt; 192.168.10.100: ICMP echo reply, id 73, seq 1, length 64</span>
<span class="c">#    ...</span>

<span class="nt">---</span>
<span class="c"># í„°ë¯¸ë„ 2ê°œ ì‚¬ìš©</span>
<span class="o">[</span>k8s-ctr] <span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 tcp port 80 <span class="nt">-nnq</span> <span class="c"># í˜¹ì€ hubble observe -f --pod curl-pod</span>
<span class="o">[</span>router] <span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 tcp port 80 <span class="nt">-nnq</span>

<span class="c"># router eth1 192.168.10.200 ë¡œ curl &gt;&gt; IP í™•ì¸í•´ë³´ì!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> webpod
<span class="c"># =&gt; Hostname: webpod-bb8b9557f-9tzvj</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.1.31</span>
<span class="c">#    IP: fe80::6857:8fff:fe68:c5d5</span>
<span class="c">#    RemoteAddr: 172.20.1.80:56614</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: webpod</span>
<span class="c">#    User-Agent: curl/8.14.1</span>
<span class="c">#    Accept: */*</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-ctr ë…¸ë“œì— ìˆëŠ” webpodì— í†µì‹ í• ë•Œë§Œ k8s-ctrì— ìº¡ì³ë¨&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ routerì—ëŠ” ìº¡ì³ë˜ì§€ ì•ŠìŒ&lt;/span&gt;</span>

<span class="c"># k8s-ctr íŒ¨í‚· ìº¡ì³ ê²°ê³¼</span>
<span class="c"># =&gt; 00:58:25.714438 IP 172.20.1.80.58682 &gt; 172.20.0.130.80: tcp 70</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ IPëŠ” Pod CIDRì„&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> webpod
<span class="c"># =&gt; Hostname: webpod-bb8b9557f-7rn8t</span>
<span class="c">#    IP: 172.20.0.130</span>
<span class="c">#    RemoteAddr: 172.20.1.80:60086</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-1 ë…¸ë“œì— ìˆëŠ” webpodì— í†µì‹ í• ë•ŒëŠ” íŒ¨í‚· ìº¡ì³ ë˜ì§€ì•ŠìŒ&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> 192.168.10.200
<span class="c"># =&gt; &lt;h1&gt;Web Server : router&lt;/h1&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s-ctrì™€ router ëª¨ë‘ì— ìº¡ì³ë¨&lt;/span&gt;</span>

<span class="c"># k8s-ctr íŒ¨í‚· ìº¡ì³ ê²°ê³¼</span>
<span class="c"># =&gt; 01:01:34.458560 IP 192.168.10.100.45668 &gt; 192.168.10.200.80: tcp 78</span>
<span class="c">#    ...</span>
<span class="c"># router íŒ¨í‚· ìº¡ì³ ê²°ê³¼</span>
<span class="c"># =&gt; 01:01:34.501812 IP 192.168.10.100.45668 &gt; 192.168.10.200.80: tcp 78</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í´ëŸ¬ìŠ¤í„° ë°”ê¹¥ì˜ ì„œë²„ì¸ Routerì™€ëŠ” Node IPë¡œ í†µì‹ í•˜ê³  ìˆìŒ&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="ip-masq-agent-ì„¤ì •">ip-masq-agent ì„¤ì •</h3>

<p><a href="https://github.com/kubernetes-sigs/ip-masq-agent">Docs</a></p>

<ul>
  <li>eBPF ê¸°ë°˜ ip-masq-agentëŠ” ì„¤ì •íŒŒì¼ì„ í†µí•´ <code class="language-plaintext highlighter-rouge">nonMasqueradeCIDRs</code>, <code class="language-plaintext highlighter-rouge">masqLinkLocal</code>, <code class="language-plaintext highlighter-rouge">masqLinkLocalIPv6</code> ì˜µì…˜ì„ ì§€ì›í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">nonMasqueradeCIDRs</code>ëŠ” masqueradingì„ ìˆ˜í–‰í•˜ì§€ ì•Šì„ CIDR ë²”ìœ„ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</li>
  <li>í•´ë‹¹ ì„¤ì •ì´ ì—†ëŠ” ê²½ìš° agentëŠ” ë‹¤ìŒì˜ masquerading ì œì™¸ CIDRì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">8</span>
<span class="mi">172</span><span class="p">.</span><span class="mi">16</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">12</span>
<span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">16</span>
<span class="mi">100</span><span class="p">.</span><span class="mi">64</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">10</span>
<span class="mi">192</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span>
<span class="mi">192</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span>
<span class="mi">192</span><span class="p">.</span><span class="mi">88</span><span class="p">.</span><span class="mi">99</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span>
<span class="mi">198</span><span class="p">.</span><span class="mi">18</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">15</span>
<span class="mi">198</span><span class="p">.</span><span class="mi">51</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span>
<span class="mi">203</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">113</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span>
<span class="mi">240</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">4</span>
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">masqLinkLocal</code>ì´ falseì´ê±°ë‚˜ ì§€ì •ë˜ì–´ìˆì§€ ì•Šìœ¼ë©´ <code class="language-plaintext highlighter-rouge">169.254.0.0/16</code> ë˜í•œ masquerading ì œì™¸ CIDRë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</li>
  <li>ipMasqAgent ì„¤ì •
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì•„ë˜ ì„¤ì •ê°’ì€ cilium ë°ëª¬ì…‹ ìë™ ì¬ì‹œì‘ë¨</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> ipMasqAgent.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> ipMasqAgent.config.nonMasqueradeCIDRs<span class="o">=</span><span class="s1">'{10.10.1.0/24,10.10.2.0/24}'</span>
  
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; â„¹ï¸   Hubble Relay is available at 127.0.0.1:4245</span>
  
<span class="c"># ip-masq-agent configmap ìƒì„± í™•ì¸</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system ip-masq-agent <span class="nt">-o</span> yaml | yq
<span class="c"># =&gt; ...</span>
<span class="c">#        "config": "{\"nonMasqueradeCIDRs\":[\"10.10.1.0/24\",\"10.10.2.0/24\"]}"</span>
<span class="c">#    ...</span>
<span class="c">#        "name": "ip-masq-agent",</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> kube-system ip-masq-agent 
<span class="c"># =&gt; Data</span>
<span class="c">#    ====</span>
<span class="c">#    config:</span>
<span class="c">#    ----</span>
<span class="c">#    {"nonMasqueradeCIDRs":["10.10.1.0/24","10.10.2.0/24"]}</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>k9s 
  
<span class="c">#</span>
<span class="nv">$ </span>cilium config view  | <span class="nb">grep</span> <span class="nt">-i</span> ip-masq
<span class="c"># =&gt; enable-ip-masq-agent                              true</span>
  
<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg bpf ipmasq list
<span class="c"># =&gt; IP PREFIX/ADDRESS</span>
<span class="c">#    10.10.1.0/24</span>
<span class="c">#    10.10.2.0/24</span>
<span class="c">#    169.254.0.0/16</span>
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="coredns-nodelocaldns">CoreDNS, NodeLocalDNS</h2>

<h3 id="coredns">CoreDNS</h3>
<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_17.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>CoreDNS ì†Œê°œ - <a href="https://kubernetes.io/ko/docs/tasks/administer-cluster/dns-custom-nameservers/">Docs</a> , <a href="https://coredns.io/manual/toc/">Home</a> , <a href="https://coredns.io/plugins/">Plugins</a> , <a href="https://www.youtube.com/watch?v=W3f5Ks0j2Q8">Youtube</a>
    <ul>
      <li>CoreDNSëŠ” Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ DNS ì„œë²„ë¡œ, í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ì„œë¹„ìŠ¤ì™€ íŒŒë“œì˜ ì´ë¦„ì„ IP ì£¼ì†Œë¡œ ë³€í™˜í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.</li>
      <li>CoreDNSëŠ” BIND, Knot, PowerDNSì™€ ê°™ì€ ì „í†µì ì¸ DNS ì„œë²„ì™€ëŠ” ë‹¤ë¥´ê²Œ 
ëŒ€ë¶€ë¶„ì˜ ê¸°ëŠ¥ì„ í”ŒëŸ¬ê·¸ì¸í™” í•˜ì—¬ ìœ ì—°í•˜ê²Œ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>CoreDNS ì„¤ì • í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë“œì˜ DNS ì„¤ì • ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> <span class="nb">cat</span> /etc/resolv.conf
<span class="c"># =&gt; search default.svc.cluster.local svc.cluster.local cluster.local</span>
<span class="c">#    nameserver 10.96.0.10</span>
<span class="c">#    options ndots:5</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> /var/lib/kubelet/config.yaml | <span class="nb">grep </span>cluster <span class="nt">-A1</span>
<span class="c"># =&gt; clusterDNS:</span>
<span class="c">#    - 10.96.0.10</span>
<span class="c">#    clusterDomain: cluster.local</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> kube-system kube-dns
<span class="c"># =&gt; NAME               TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span>
<span class="c">#    service/kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   24h</span>
<span class="c">#    </span>
<span class="c">#    NAME                 ENDPOINTS                                                   AGE</span>
<span class="c">#    endpoints/kube-dns   172.20.0.56:53,172.20.1.113:53,172.20.0.56:53 + 3 more...   24h</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns
<span class="c"># =&gt; NAME                       READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    coredns-674b8bbfcf-58c7n   1/1     Running   0          4h17m</span>
<span class="c">#    coredns-674b8bbfcf-tg9ll   1/1     Running   0          4h17m</span>

<span class="c">#</span>
<span class="nv">$ </span>kc describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns
<span class="c"># =&gt; ...</span>
<span class="c">#     config-volume:</span>
<span class="c">#        Type:      ConfigMap (a volume populated by a ConfigMap)</span>
<span class="c">#        Name:      coredns</span>
<span class="c">#        Optional:  false</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> kube-system coredns
<span class="c"># =&gt; ...</span>
<span class="c">#    Corefile:</span>
<span class="c">#    ----</span>
<span class="c">#    .:53 {              # ëª¨ë“  ë„ë©”ì¸ ìš”ì²­ì„ 53í¬íŠ¸ì—ì„œ ìˆ˜ì‹ </span>
<span class="c">#        errors          # DNS ì‘ë‹µ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí•  ê²½ìš° ë¡œê·¸ ì¶œë ¥</span>
<span class="c">#        health {        # health ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì œê³µí•˜ì—¬ ìƒíƒœ í™•ì¸ ê°€ëŠ¥</span>
<span class="c">#           lameduck 5s  # ì¢…ë£Œ ì‹œ 5ì´ˆê°„ lameduck ëª¨ë“œë¡œ íŠ¸ë˜í”½ì„ ì ì°¨ ì¤„ì´ë©° ì¢…ë£Œ</span>
<span class="c">#        }</span>
<span class="c">#        ready           # ready ì—”ë“œí¬ì¸íŠ¸ ì œê³µ, 8181 í¬íŠ¸ì˜ HTTP ì—”ë“œí¬ì¸íŠ¸ê°€, ëª¨ë“  í”ŒëŸ¬ê·¸ì¸ì´ ì¤€ë¹„ë˜ì—ˆë‹¤ëŠ” ì‹ í˜¸ë¥¼ ë³´ë‚´ë©´ 200 OK ë¥¼ ë°˜í™˜</span>
<span class="c">#        kubernetes cluster.local in-addr.arpa ip6.arpa {    # Kubernetes DNS í”ŒëŸ¬ê·¸ì¸ ì„¤ì •(í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ ë„ë©”ì¸ ì²˜ë¦¬), cluster.local: í´ëŸ¬ìŠ¤í„° ë„ë©”ì¸</span>
<span class="c">#           pods insecure                         # íŒŒë“œ IPë¡œ DNS ì¡°íšŒ í—ˆìš© (ë³´ì•ˆ ì—†ìŒ)</span>
<span class="c">#           fallthrough in-addr.arpa ip6.arpa     #  í•´ë‹¹ ë„ë©”ì¸ì—ì„œ ê²°ê³¼ ì—†ìœ¼ë©´ ë‹¤ìŒ í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ ì „ë‹¬</span>
<span class="c">#           ttl 30                                #  ìºì‹œ íƒ€ì„ (30ì´ˆ)</span>
<span class="c">#        }</span>
<span class="c">#        prometheus :9153 # Prometheus metrics ìˆ˜ì§‘ ê°€ëŠ¥</span>
<span class="c">#        forward . /etc/resolv.conf {             # CoreDNSê°€ ëª¨ë¥´ëŠ” ë„ë©”ì¸ì€ ì§€ì •ëœ ì—…ìŠ¤íŠ¸ë¦¼(ë³´í†µ ì™¸ë¶€ DNS)ìœ¼ë¡œ ì „ë‹¬, .: ëª¨ë“  ì¿¼ë¦¬</span>
<span class="c">#           max_concurrent 1000                   # ë³‘ë ¬ í¬ì›Œë”© ìµœëŒ€ 1000ê°œ</span>
<span class="c">#        }</span>
<span class="c">#        cache 30 {                        # DNS ì‘ë‹µ ìºì‹œ ê¸°ëŠ¥, ê¸°ë³¸ ìºì‹œ TTL 30ì´ˆ</span>
<span class="c">#           disable success cluster.local  # ì„±ê³µ ì‘ë‹µ ìºì‹œ ì•ˆ í•¨ (cluster.local ë„ë©”ì¸)</span>
<span class="c">#           disable denial cluster.local   # NXDOMAIN ì‘ë‹µë„ ìºì‹œ ì•ˆ í•¨</span>
<span class="c">#        } </span>
<span class="c">#        loop         # ê°„ë‹¨í•œ ì „ë‹¬ ë£¨í”„(loop)ë¥¼ ê°ì§€í•˜ê³ , ë£¨í”„ê°€ ë°œê²¬ë˜ë©´ CoreDNS í”„ë¡œì„¸ìŠ¤ë¥¼ ì¤‘ë‹¨(halt).</span>
<span class="c">#        reload       # Corefile ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ ìë™ìœ¼ë¡œ ì¬ì ìš©, ì»¨í”¼ê·¸ë§µ ì„¤ì •ì„ ë³€ê²½í•œ í›„ì— ë³€ê²½ ì‚¬í•­ì´ ì ìš©ë˜ê¸° ìœ„í•˜ì—¬ ì•½ 2ë¶„ì •ë„ ì†Œìš”.</span>
<span class="c">#        loadbalance  # ì‘ë‹µì— ëŒ€í•˜ì—¬ A, AAAA, MX ë ˆì½”ë“œì˜ ìˆœì„œë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ ì •í•˜ëŠ” ë¼ìš´ë“œ-ë¡œë¹ˆ DNS ë¡œë“œë°¸ëŸ°ì„œ.</span>
<span class="c">#    }</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/resolv.conf
<span class="c"># =&gt; nameserver 127.0.0.53</span>
<span class="c">#    options edns0 trust-ad</span>
<span class="c">#    search .</span>

<span class="nv">$ </span>resolvectl 
<span class="c"># =&gt; Link 2 (eth0)</span>
<span class="c">#        Current Scopes: DNS</span>
<span class="c">#             Protocols: +DefaultRoute -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span>
<span class="c">#    Current DNS Server: 10.0.2.3</span>
<span class="c">#           DNS Servers: 10.0.2.3</span>
</code></pre></div></div>

<ul>
  <li>
    <p>(ì°¸ê³ ) forward í”ŒëŸ¬ê·¸ì¸ - <a href="https://coredns.io/plugins/forward/">Docs</a></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í™œìš© 1 : '.consul.local' ë„ë©”ì¸ì„ ê´€ë¦¬í•˜ëŠ” ë„ë©”ì¸ ì„œë²„ê°€ ì¡´ì¬ ì‹œ, coredns ì—ì„œ í•´ë‹¹ ë„ë©”ì¸ ì„œë²„ë¡œ ì§ˆì˜ ì„¤ì • ì‹œ</span>
consul.local:53 <span class="o">{</span>
    errors
    cache 30
    forward <span class="nb">.</span> 10.150.0.1
<span class="o">}</span>
  
<span class="c"># í™œìš© 2 : ëª¨ë“  ë¹„ í´ëŸ¬ìŠ¤í„°ì˜ DNS ì¡°íšŒê°€ 172.16.0.1 ì˜ íŠ¹ì • ë„¤ì„ì„œë²„ ì‚¬ìš© ì‹œ, /etc/resolv.conf ëŒ€ì‹  forward ë¥¼ ë„¤ì„ì„œë²„ë¡œ ì§€ì •</span>
forward <span class="nb">.</span>  172.16.0.1
  
<span class="c"># ìœ„ 1,2 í¬í•¨í•œ ì„¤ì • ì˜ˆì‹œ</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 <span class="o">{</span>
        errors
        health
        kubernetes cluster.local <span class="k">in</span><span class="nt">-addr</span>.arpa ip6.arpa <span class="o">{</span>
           pods insecure
           fallthrough <span class="k">in</span><span class="nt">-addr</span>.arpa ip6.arpa
        <span class="o">}</span>
        prometheus :9153
        forward <span class="nb">.</span> 172.16.0.1  <span class="c"># í™œìš© 2</span>
        cache 30
        loop
        reload
        loadbalance
    <span class="o">}</span>
    consul.local:53 <span class="o">{</span>         <span class="c"># í™œìš© 1</span>
        errors
        cache 30
        forward <span class="nb">.</span> 10.150.0.1
    <span class="o">}</span>  
</code></pre></div>    </div>
  </li>
  <li>
    <p>íŒŒë“œì—ì„œ DNS ì§ˆì˜ í™•ì¸ - <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/">Docs</a> , <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/">DNS for Services and Pods</a> , <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-horizontal-autoscaling/">Autoscale the DNS Service in a Cluster</a></p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§1</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--port</span> 53
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--port</span> 53 <span class="nt">--protocol</span> UDP

<span class="c"># ëª¨ë‹ˆí„°ë§2</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 53 <span class="nt">-nn</span>

<span class="c"># íŒŒë“œ IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   STATUS    RESTARTS   AGE     IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                 1/1     Running   0          3h55m   172.20.1.80    k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-bb8b9557f-7rn8t   1/1     Running   0          3h55m   172.20.0.130   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-bb8b9557f-9tzvj   1/1     Running   0          3h55m   172.20.1.31    k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                       READY   STATUS    RESTARTS   AGE     IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    coredns-674b8bbfcf-58c7n   1/1     Running   0          4h29m   172.20.1.113   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    coredns-674b8bbfcf-tg9ll   1/1     Running   0          4h29m   172.20.0.56    k8s-w1    &lt;none&gt;           &lt;none&gt;</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> <span class="nb">cat</span> /etc/resolv.conf
<span class="c"># =&gt; search default.svc.cluster.local svc.cluster.local cluster.local</span>
<span class="c">#    nameserver 10.96.0.10</span>
<span class="c">#    options ndots:5</span>

<span class="c"># ì‹¤ìŠµ í¸ë¦¬ë¥¼ ìœ„í•´ coredns íŒŒë“œë¥¼ 1ê°œë¡œ ì¶•ì†Œ</span>
<span class="nv">$ </span>kubectl scale deployment <span class="nt">-n</span> kube-system coredns <span class="nt">--replicas</span> 1
<span class="c"># =&gt; deployment.apps/coredns scaled</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                       READY   STATUS    RESTARTS   AGE     IP            NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    coredns-674b8bbfcf-tg9ll   1/1     Running   0          4h29m   172.20.0.56   k8s-w1   &lt;none&gt;           &lt;none&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl kube-dns.kube-system.svc:9153/metrics | <span class="nb">grep </span>coredns_cache_ | <span class="nb">grep</span> <span class="nt">-v</span> ^#
<span class="c"># =&gt; coredns_cache_entries{server="dns://:53",type="denial",view="",zones="."} 1</span>
<span class="c">#    coredns_cache_entries{server="dns://:53",type="success",view="",zones="."} 0</span>
<span class="c">#    coredns_cache_misses_total{server="dns://:53",view="",zones="."} 46</span>
<span class="c">#    coredns_cache_requests_total{server="dns://:53",view="",zones="."} 46</span>

<span class="c"># ë„ë©”ì¸ ì§ˆì˜</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> nslookup webpod
<span class="c"># =&gt; Server:         10.96.0.10</span>
<span class="c">#    Address:        10.96.0.10#53</span>
<span class="c">#    </span>
<span class="c">#    Name:   webpod.default.svc.cluster.local</span>
<span class="c">#    Address: 10.96.194.47</span>

<span class="c"># tcpdumpë¡œ DNS ì§ˆì˜ íŒ¨í‚· í™•ì¸</span>
<span class="c"># =&gt; 01:27:05.029100 lxc9dcdf61704e7 In  IP 172.20.1.80.41316 &gt; 172.20.0.56&lt;span style="color: green;"&gt;.53&lt;/span&gt;: 62435+ &lt;span style="color: green;"&gt;A? webpod.default.svc.cluster.local.&lt;/span&gt; (50)</span>
<span class="c">#    01:27:05.029378 eth1  Out IP 172.20.1.80.41316 &gt; 172.20.0.56.53: 62435+ A? webpod.default.svc.cluster.local. (50)</span>
<span class="c">#    01:27:05.032936 eth1  In  IP 172.20.0.56.53 &gt; 172.20.1.80.41316: 62435*- &lt;span style="color: green;"&gt;1/0/0 A 10.96.194.47&lt;/span&gt; (98)</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> nslookup <span class="nt">-debug</span> webpod
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> nslookup <span class="nt">-debug</span> google.com
<span class="c"># =&gt; Server:         10.96.0.10</span>
<span class="c">#    Address:        10.96.0.10#53</span>
<span class="c">#    </span>
<span class="c">#    ------------</span>
<span class="c">#        QUESTIONS:</span>
<span class="c">#            google.com.default.svc.cluster.local, type = A, class = IN</span>
<span class="c">#        ...</span>
<span class="c">#    ------------</span>
<span class="c">#    ** server can't find google.com.default.svc.cluster.local: NXDOMAIN</span>
<span class="c">#    ;; Got recursion not available from 10.96.0.10</span>
<span class="c">#    Server:         10.96.0.10</span>
<span class="c">#    Address:        10.96.0.10#53</span>
<span class="c">#    </span>
<span class="c">#    ------------</span>
<span class="c">#        QUESTIONS:</span>
<span class="c">#            google.com.svc.cluster.local, type = A, class = IN</span>
<span class="c">#        ...</span>
<span class="c">#    ------------</span>
<span class="c">#    ** server can't find google.com.svc.cluster.local: NXDOMAIN</span>
<span class="c">#    ;; Got recursion not available from 10.96.0.10</span>
<span class="c">#    Server:         10.96.0.10</span>
<span class="c">#    Address:        10.96.0.10#53</span>
<span class="c">#    </span>
<span class="c">#    ------------</span>
<span class="c">#        QUESTIONS:</span>
<span class="c">#            google.com.cluster.local, type = A, class = IN</span>
<span class="c">#        ...</span>
<span class="c">#    ------------</span>
<span class="c">#    ** server can't find google.com.cluster.local: NXDOMAIN</span>
<span class="c">#    Server:         10.96.0.10</span>
<span class="c">#    Address:        10.96.0.10#53</span>
<span class="c">#    </span>
<span class="c">#    ------------</span>
<span class="c">#        QUESTIONS:</span>
<span class="c">#            google.com, type = A, class = IN</span>
<span class="c">#        ANSWERS:</span>
<span class="c">#        -&gt;  google.com</span>
<span class="c">#            internet address = 142.250.206.238</span>
<span class="c">#            ttl = 30</span>
<span class="c">#        AUTHORITY RECORDS:</span>
<span class="c">#        ADDITIONAL RECORDS:</span>
<span class="c">#    ------------</span>
<span class="c">#    Non-authoritative answer:</span>
<span class="c">#    Name:   google.com</span>
<span class="c">#    Address: 142.250.206.238</span>
<span class="c">#    ------------</span>
<span class="c">#        QUESTIONS:</span>
<span class="c">#            google.com, type = AAAA, class = IN</span>
<span class="c">#        ANSWERS:</span>
<span class="c">#        -&gt;  google.com</span>
<span class="c">#            has AAAA address 2404:6800:400a:804::200e</span>
<span class="c">#            ttl = 30</span>
<span class="c">#        AUTHORITY RECORDS:</span>
<span class="c">#        ADDITIONAL RECORDS:</span>
<span class="c">#    ------------</span>
<span class="c">#    Name:   google.com</span>
<span class="c">#    Address: 2404:6800:400a:804::200e</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì˜ ë„ë©”ì¸ì„ ì§ˆì˜í• ë•ŒëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ search ë„ë©”ì¸ë“¤ì„ ë¨¼ì €&lt;/span&gt; </span>
<span class="c"># &lt;span style="color: green;"&gt;í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ì™¸ë¶€ DNS ì„œë²„ë¡œ ì§ˆì˜í•˜ì—¬ ì‘ë‹µì„ ë°›ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># tcpdumpë¡œ DNS ì§ˆì˜ íŒ¨í‚· í™•ì¸</span>
<span class="c"># =&gt; 01:33:33.852442 lxc9dcdf61704e7 In  IP 172.20.1.80.58442 &gt; 172.20.0.56.53: 52842+ &lt;span style="color: green;"&gt;A? google.com.default.svc.cluster.local.&lt;/span&gt; (54)</span>
<span class="c">#    01:33:33.852610 eth1  Out IP 172.20.1.80.58442 &gt; 172.20.0.56.53: 52842+ A? google.com.default.svc.cluster.local. (54)</span>
<span class="c">#    01:33:33.855947 eth1  In  IP 172.20.0.56.53 &gt; 172.20.1.80.58442: 52842 NXDomain*- 0/1/0 (147)</span>
<span class="c">#    01:33:33.861141 lxc9dcdf61704e7 In  IP 172.20.1.80.36323 &gt; 172.20.0.56.53: 10644+ &lt;span style="color: green;"&gt;A? google.com.svc.cluster.local.&lt;/span&gt; (46)</span>
<span class="c">#    01:33:33.861515 eth1  Out IP 172.20.1.80.36323 &gt; 172.20.0.56.53: 10644+ A? google.com.svc.cluster.local. (46)</span>
<span class="c">#    01:33:33.862582 eth1  In  IP 172.20.0.56.53 &gt; 172.20.1.80.36323: 10644 NXDomain*- 0/1/0 (139)</span>
<span class="c">#    01:33:33.868623 lxc9dcdf61704e7 In  IP 172.20.1.80.48326 &gt; 172.20.0.56.53: 52392+ &lt;span style="color: green;"&gt;A? google.com.cluster.local.&lt;/span&gt; (42)</span>
<span class="c">#    01:33:33.868857 eth1  Out IP 172.20.1.80.48326 &gt; 172.20.0.56.53: 52392+ A? google.com.cluster.local. (42)</span>
<span class="c">#    01:33:33.870240 eth1  In  IP 172.20.0.56.53 &gt; 172.20.1.80.48326: 52392 NXDomain*- 0/1/0 (135)</span>
<span class="c">#    01:33:33.874341 lxc9dcdf61704e7 In  IP 172.20.1.80.50810 &gt; 172.20.0.56.53: 16999+ &lt;span style="color: green;"&gt;A? google.com.&lt;/span&gt; (28)</span>
<span class="c">#    01:33:33.874556 eth1  Out IP 172.20.1.80.50810 &gt; 172.20.0.56.53: 16999+ A? google.com. (28)</span>
<span class="c">#    01:33:33.928831 eth1  In  IP 172.20.0.56.53 &gt; 172.20.1.80.50810: 16999 &lt;span style="color: green;"&gt;1/0/0 A 142.250.206.238&lt;/span&gt; (54)</span>

<span class="c"># coredns ë¡œê¹…, ë””ë²„ê¹… í™œì„±í™”</span>
<span class="c"># k9s â†’ configmap â†’ coredns ì„ íƒ â†’ E(edit) â†’ ì•„ë˜ì²˜ëŸ¼ log, debug ì…ë ¥ í›„ ë¹ ì ¸ë‚˜ì˜¤ê¸°</span>
<span class="nt">---</span>
    .:53 <span class="o">{</span>
        log
        debug
        errors
<span class="nt">---</span>

<span class="c"># ë¡œê·¸ ëª¨ë‹ˆí„°ë§ 3</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">-f</span>

<span class="c"># ë„ë©”ì¸ ì§ˆì˜</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> nslookup webpod
<span class="c"># =&gt; ;; Got recursion not available from 10.96.0.10</span>
<span class="c">#    Server:         10.96.0.10</span>
<span class="c">#    Address:        10.96.0.10#53</span>
<span class="c">#    </span>
<span class="c">#    Name:   webpod.default.svc.cluster.local</span>
<span class="c">#    Address: 10.96.194.47</span>
<span class="c">#    ;; Got recursion not available from 10.96.0.10</span>

<span class="c"># coredns ë¡œê·¸ í™•ì¸</span>
<span class="c"># =&gt; [INFO] 172.20.1.80:46753 - 59201 "A IN webpod.default.svc.cluster.local. udp 50 false 512" NOERROR qr,aa,rd 98 0.000500084s</span>
<span class="c">#    [INFO] 172.20.1.80:39996 - 54949 "AAAA IN webpod.default.svc.cluster.local. udp 50 false 512" NOERROR qr,aa,rd 143 0.000554333s</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> nslookup google.com
<span class="c"># =&gt; Server:         10.96.0.10</span>
<span class="c">#    Address:        10.96.0.10#53</span>
<span class="c">#    </span>
<span class="c">#    Non-authoritative answer:</span>
<span class="c">#    Name:   google.com</span>
<span class="c">#    Address: 142.250.206.238</span>
<span class="c">#    Name:   google.com</span>
<span class="c">#    Address: 2404:6800:400a:804::200e</span>

<span class="c"># coredns ë¡œê·¸ í™•ì¸</span>
<span class="c"># =&gt; [INFO] 172.20.1.80:43389 - 1366 "A IN google.com.default.svc.cluster.local. udp 54 false 512" NXDOMAIN qr,aa,rd 147 0.001736458s</span>
<span class="c">#    [INFO] 172.20.1.80:34460 - 17323 "A IN google.com.svc.cluster.local. udp 46 false 512" NXDOMAIN qr,aa,rd 139 0.000483917s</span>
<span class="c">#    [INFO] 172.20.1.80:40469 - 26458 "A IN google.com.cluster.local. udp 42 false 512" NXDOMAIN qr,aa,rd 135 0.000331334s</span>
<span class="c">#    [INFO] 172.20.1.80:56627 - 19160 "A IN google.com. udp 28 false 512" NOERROR qr,rd,ra 54 0.054453541s</span>
<span class="c">#    [INFO] 172.20.1.80:48324 - 36047 "AAAA IN google.com. udp 28 false 512" NOERROR qr,rd,ra 66 0.044442084s</span>

<span class="c"># CoreDNSê°€ prometheus í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´, ë©”íŠ¸ë¦­ í¬íŠ¸(:9153)ë¥¼ í†µí•´ ìºì‹œ ê´€ë ¨ ì •ë³´ë¥¼ ìˆ˜ì§‘.</span>
<span class="c">## coredns_cache_entries í˜„ì¬ ìºì‹œì— ì €ì¥ëœ ì—”íŠ¸ë¦¬(í•­ëª©) ìˆ˜ : type: success ë˜ëŠ” denial (ì •ìƒ ì‘ë‹µ or NXDOMAIN ë“±)</span>
<span class="c">## coredns_cache_hits_total	ìºì‹œ ì¡°íšŒ ì„±ê³µ íšŸìˆ˜</span>
<span class="c">## coredns_cache_misses_total	ìºì‹œ ë¯¸ìŠ¤ íšŸìˆ˜</span>
<span class="c">## coredns_cache_requests_total	ìºì‹œ ê´€ë ¨ ìš”ì²­ íšŸìˆ˜ì˜ ì´í•©</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl kube-dns.kube-system.svc:9153/metrics | <span class="nb">grep </span>coredns_cache_ | <span class="nb">grep</span> <span class="nt">-v</span> ^#
<span class="c"># =&gt; coredns_cache_entries{server="dns://:53",type="denial",view="",zones="."} 1</span>
<span class="c">#    coredns_cache_entries{server="dns://:53",type="success",view="",zones="."} 2</span>
<span class="c">#    coredns_cache_hits_total{server="dns://:53",type="success",view="",zones="."} 4</span>
<span class="c">#    coredns_cache_misses_total{server="dns://:53",view="",zones="."} 116</span>
<span class="c">#    coredns_cache_requests_total{server="dns://:53",view="",zones="."} 120</span>
</code></pre></div></div>

<h3 id="nodelocaldns">NodeLocalDNS</h3>

<p><a href="https://popappend.tistory.com/142">ì†Œê°œ ë¸”ë¡œê·¸</a></p>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_18.png" alt="img.png" class="image-center" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">NodeLocal DNSCache</code>ëŠ” í´ëŸ¬ìŠ¤í„° ë…¸ë“œì—ì„œ DNS ìºì‹± ì—ì´ì „íŠ¸ë¥¼ DaemonSetìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬ í´ëŸ¬ìŠ¤í„° DNS ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.</li>
  <li>ì˜¤ëŠ˜ë‚ ì˜ ì•„í‚¤í…ì²˜ì—ì„œ â€˜<code class="language-plaintext highlighter-rouge">ClusterFirst</code>â€™ DNS ëª¨ë“œì˜ PodsëŠ” DNS ì¿¼ë¦¬ë¥¼ ìœ„í•´ kube-dns ì„œë¹„ìŠ¤ IPì— ë„ë‹¬í•©ë‹ˆë‹¤.</li>
  <li>ì´ëŠ” kube-proxyì— ì˜í•´ ì¶”ê°€ëœ <strong>iptables</strong> ê·œì¹™ì„ í†µí•´ kube-dns/CoreDNS ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.</li>
  <li>ì´ ìƒˆë¡œìš´ ì•„í‚¤í…ì²˜ë¥¼ í†µí•´ PodsëŠ” ë™ì¼í•œ ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” DNS ìºì‹± ì—ì´ì „íŠ¸ì— ë„ë‹¬í•˜ì—¬ iptables DNAT ê·œì¹™ê³¼ ì—°ê²° ì¶”ì ì„ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë¡œì»¬ ìºì‹± ì—ì´ì „íŠ¸ëŠ” í´ëŸ¬ìŠ¤í„° í˜¸ìŠ¤íŠ¸ ì´ë¦„(ê¸°ë³¸ì ìœ¼ë¡œ â€œcluster.localâ€ ì ‘ë¯¸ì‚¬)ì˜ ìºì‹œ ëˆ„ë½ì— ëŒ€í•´ kube-dns ì„œë¹„ìŠ¤ì— ì¿¼ë¦¬í•©ë‹ˆë‹¤.</li>
  <li>í˜„ì¬ DNS ì•„í‚¤í…ì²˜ì—ì„œëŠ” ë¡œì»¬ kube-dns/CoreDNS ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ëŠ” ê²½ìš° DNS QPSê°€ ê°€ì¥ ë†’ì€ í¬ë“œê°€ ë‹¤ë¥¸ ë…¸ë“œì— ë„ë‹¬í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ë¡œì»¬ ìºì‹œë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ¬í•œ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ì§€ì—° ì‹œê°„ì„ ê°œì„ í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.</li>
  <li>iptables DNAT ë° ì—°ê²° ì¶”ì ì„ ê±´ë„ˆë›°ë©´ <a href="https://github.com/kubernetes/kubernetes/issues/56903">ì—°ê²° ì¶”ì  ë ˆì´ìŠ¤</a>ë¥¼ ì¤„ì´ê³  UDP DNS í•­ëª©ì´ ì—°ê²° ì¶”ì  í…Œì´ë¸”ì„ ì±„ìš°ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.</li>
  <li>ë¡œì»¬ ìºì‹± ì—ì´ì „íŠ¸ì—ì„œ kube-dns ì„œë¹„ìŠ¤ë¡œì˜ ì—°ê²°ì€ TCPë¡œ ì—…ê·¸ë ˆì´ë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. TCP ì—°ê²° íŠ¸ë™ í•­ëª©ì€ ì‹œê°„ ì´ˆê³¼ë¥¼ í•´ì•¼ í•˜ëŠ” UDP í•­ëª©ê³¼ ë‹¬ë¦¬ ì—°ê²° ì¢…ë£Œ ì‹œ ì œê±°ë©ë‹ˆë‹¤(ê¸°ë³¸ê°’ <code class="language-plaintext highlighter-rouge">nf_conntrack_udp_timeout</code>ì€ 30ì´ˆ)</li>
  <li>DNS ì¿¼ë¦¬ë¥¼ UDPì—ì„œ TCPë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ë©´ ì‚­ì œëœ UDP íŒ¨í‚·ê³¼ DNS íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¸í•œ í…Œì¼ ì§€ì—° ì‹œê°„ì´ ë³´í†µ ìµœëŒ€ 30ì´ˆ(3íšŒ ì¬ì‹œë„ + 10ì´ˆ íƒ€ì„ì•„ì›ƒ)ê¹Œì§€ ì¤„ì–´ë“­ë‹ˆë‹¤. ë…¸ë“œë¡œì»¬ ìºì‹œê°€ UDP DNS ì¿¼ë¦¬ë¥¼ ë“£ê¸° ë•Œë¬¸ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë³€ê²½í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
  <li>ë…¸ë“œ ìˆ˜ì¤€ì—ì„œ DNS ìš”ì²­ì— ëŒ€í•œ ë©”íŠ¸ë¦­ ë° ê°€ì‹œì„±.</li>
  <li>
    <p>ë„¤ê±°í‹°ë¸Œ ìºì‹±ì„ ë‹¤ì‹œ í™œì„±í™”í•˜ì—¬ kube-dns ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì¿¼ë¦¬ ìˆ˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>NodeLocal DNSCache ì„¤ì¹˜ ë°©ë²• - <a href="https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/#configuration">Docs</a>
    <ul>
      <li>ì„¤ì¹˜ì‹œ NodeLocal DNSCacheì˜ ë¡œì»¬ Listening IP ì£¼ì†ŒëŠ” í´ëŸ¬ìŠ¤í„°ì˜ ê¸°ì¡´ IPì™€ ì¶©ëŒí•˜ì§€ ì•ŠëŠ” ëª¨ë“  ì£¼ì†Œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ì˜ˆë¥¼ë“¤ì–´ IPv4ì˜ ë§í¬ ë¡œì»¬ ë²”ìœ„ì¸ <code class="language-plaintext highlighter-rouge">169.254.0.0/16</code>ì„ ì‚¬ìš©í•˜ê±°ë‚˜, IPv6ì˜ <code class="language-plaintext highlighter-rouge">fd00::/8</code> ë²”ìœ„ë¥¼ ì‚¬ìš©í•˜ëŠ”ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-LO</span> https://raw.githubusercontent.com/kubernetes/kubernetes/refs/heads/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml

<span class="c"># ë‹¤ìŒ ê°’ë“¤ì€ ì ì ˆí•œ ê°’ìœ¼ë¡œ ëŒ€ì²´ í•©ë‹ˆë‹¤.</span>
<span class="nv">$ kubedns</span><span class="o">=</span><span class="sb">`</span>kubectl get svc kube-dns <span class="nt">-n</span> kube-system <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="sb">`</span> <span class="c"># coredns ì˜ ClusterIP</span>
<span class="c"># $ domain=&lt;cluster-domain&gt; # ë³´í†µ ê¸°ë³¸ê°’ cluster.local ì‚¬ìš©</span>
<span class="nv">$ domain</span><span class="o">=</span>cluster.local
<span class="c"># $ localdns=&lt;node-local-address&gt; # local listen IP address chosen for NodeLocal DNSCache</span>
<span class="nv">$ localdns</span><span class="o">=</span>169.254.20.10
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$kubedns</span> <span class="nv">$domain</span> <span class="nv">$localdns</span>
<span class="c"># =&gt; 10.96.0.10 cluster.local 169.254.1.2</span>

<span class="c"># case 1) kube-proxyê°€ IPTABLES ëª¨ë“œì¸ ê²½ìš°</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/__PILLAR__LOCAL__DNS__/</span><span class="nv">$localdns</span><span class="s2">/g; s/__PILLAR__DNS__DOMAIN__/</span><span class="nv">$domain</span><span class="s2">/g; s/__PILLAR__DNS__SERVER__/</span><span class="nv">$kubedns</span><span class="s2">/g"</span> nodelocaldns.yaml
<span class="c"># ì´ ëª¨ë“œì—ì„œëŠ” node-local-dns í¬ë“œê°€ kube-dns ì„œë¹„ìŠ¤ IPì™€ &lt;node-local-address&gt;ë¥¼ ëª¨ë‘ ìˆ˜ì‹ í•˜ë¯€ë¡œ, í¬ë“œëŠ” IP ì£¼ì†Œ ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ì—¬ DNS ë ˆì½”ë“œë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>

<span class="c"># case 2) kube-proxyê°€ IPVS ëª¨ë“œì¸ ê²½ìš°</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/__PILLAR__LOCAL__DNS__/</span><span class="nv">$localdns</span><span class="s2">/g; s/__PILLAR__DNS__DOMAIN__/</span><span class="nv">$domain</span><span class="s2">/g; s/,__PILLAR__DNS__SERVER__//g; s/__PILLAR__CLUSTER__DNS__/</span><span class="nv">$kubedns</span><span class="s2">/g"</span> nodelocaldns.yaml
<span class="c"># - ì´ ëª¨ë“œì—ì„œëŠ”`node-local-dns` í¬ë“œê°€ **&lt;node-local-address&gt;**ì—ì„œë§Œ ì²­ì·¨í•©ë‹ˆë‹¤.</span>
<span class="c"># - IPVS ë¡œë“œ ë°¸ëŸ°ì‹±ì— ì‚¬ìš©ë˜ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ ì´ë¯¸ ì´ ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— `node-local-dns` ì¸í„°í˜ì´ìŠ¤ëŠ” kube-dns í´ëŸ¬ìŠ¤í„° IPë¥¼ ë°”ì¸ë”©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
<span class="c"># - `__PILLAR__UPSTREAM__SERVERS__`ëŠ” `node-local-dns` í¬ë“œì— ì˜í•´ ì±„ì›Œì§‘ë‹ˆë‹¤.</span>

<span class="nv">$ </span>kubectl create <span class="nt">-f</span> nodelocaldns.yaml
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">node-local-dns</code> í¬ë“œê°€ í™œì„±í™”ë˜ë©´ ê° í´ëŸ¬ìŠ¤í„° ë…¸ë“œì˜ <code class="language-plaintext highlighter-rouge">kube-system</code> ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.</li>
  <li>ì´ í¬ë“œëŠ” ìºì‹œ ëª¨ë“œì—ì„œ CoreDNSë¥¼ ì‹¤í–‰í•˜ë¯€ë¡œ ì„œë¡œ ë‹¤ë¥¸ í”ŒëŸ¬ê·¸ì¸ì´ ë…¸ì¶œí•˜ëŠ” ëª¨ë“  CoreDNS ë©”íŠ¸ë¦­ì„ ë…¸ë“œ ë‹¨ìœ„ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">kubectl delete -f &lt;manifest&gt;</code>ë¥¼ ì‚¬ìš©í•˜ì—¬ DaemonSetì„ ì œê±°í•˜ì—¬ ë¹„í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³€ê²½í•œ ë‚´ìš©ì„ kubetle ì„¤ì •ìœ¼ë¡œ ë˜ëŒë ¤ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>kube-dnsì˜ ConfigMapì— ì§€ì •ëœ StubDomains ê³¼ upstream serversì´ node-local-dnsì— ì˜í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.</li>
  <li>iptables ëª¨ë“œì¼ë•Œì™€ ipvs ëª¨ë“œì¼ë•Œì˜ ì°¨ì´
<img src="/assets/2025/cilium/w3/20250803_cilium_w3_20.png" alt="img.png" class="image-center" />
<em class="image-caption">iptables ëª¨ë“œì¼ë•Œ</em>
<img src="/assets/2025/cilium/w3/20250803_cilium_w3_21.png" alt="img_1.png" class="image-center" />
<em class="image-caption">ipvs ëª¨ë“œì¼ë•Œ</em>
    <ul>
      <li>iptables ëª¨ë“œì¼ ë•Œì™€ ipvs ëª¨ë“œì¼ ë•Œì˜ ì°¨ì´ì ì€, ipvs ëª¨ë“œì—ì„œëŠ” Podì—ì„œ Domain Resolve ìš”ì²­ì„ CoreDNS Serviceì˜ ClusterIPì¸ 10.96.0.10 IP ì£¼ì†Œê°€ ì•„ë‹ˆë¼ NodeLocal DNSCacheì˜ CoreDNSê°€ ì„¤ì •í•œ Local Address IPì¸ 169.254.25.10 IP ì£¼ì†Œë¡œ ì „ì†¡í•œë‹¤ëŠ” ì ì…ë‹ˆë‹¤.</li>
      <li>ë”°ë¼ì„œ Kubernetes Clusterê°€ ipvs ëª¨ë“œ kube-proxyë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´ NodeLocal DNSCache ê¸°ë²• ì ìš© ìœ ë¬´ë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ipvs ëª¨ë“œì—ì„œëŠ” ë§¤ë²ˆ kubeletì˜ Pod DNS Server ì£¼ì†Œë¥¼ ë³€ê²½í•˜ê³  kubletì„ ì¬ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ Podë“¤ë„ ì¬ì‹œì‘í•˜ì—¬ Podê°€ ì´ìš©í•˜ëŠ” DNS Serverì˜ ì£¼ì†Œê°€ ë³€ê²½ë˜ë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>Kubernetes Clusterê°€ ipvs kube-proxy ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ë©´ ipvsê°€ iptablesì˜ NOTRACK Rule ì„ ë¬´ì‹œí•˜ê³  Loadbalancing í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="nodelocal-dnscache-ì„¤ì¹˜-ë°-í™•ì¸">NodeLocal DNSCache ì„¤ì¹˜ ë° í™•ì¸</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># iptables í™•ì¸</span>
<span class="nv">$ </span>iptables-save | <span class="nb">tee </span>before.txt

<span class="c">#</span>
<span class="nv">$ </span>wget https://github.com/kubernetes/kubernetes/raw/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml
<span class="c"># =&gt; 2025-08-03 02:19:25 (534 KB/s) - â€˜nodelocaldns.yamlâ€™ saved [5377/5377]</span>

<span class="c"># kubedns ëŠ” coredns ì„œë¹„ìŠ¤ì˜ ClusterIPë¥¼ ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ kubedns</span><span class="o">=</span><span class="sb">`</span>kubectl get svc kube-dns <span class="nt">-n</span> kube-system <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="sb">`</span>
<span class="nv">$ domain</span><span class="o">=</span><span class="s1">'cluster.local'</span>    <span class="c">## default ê°’</span>
<span class="nv">$ localdns</span><span class="o">=</span><span class="s1">'169.254.20.10'</span>  <span class="c">## default ê°’</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$kubedns</span> <span class="nv">$domain</span> <span class="nv">$localdns</span>
<span class="c"># =&gt; 10.96.0.10 cluster.local 169.254.20.10</span>

<span class="c"># iptables ëª¨ë“œ ì‚¬ìš© ì¤‘ìœ¼ë¡œ ì•„ë˜ ëª…ë ¹ì–´ ìˆ˜í–‰</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/__PILLAR__LOCAL__DNS__/</span><span class="nv">$localdns</span><span class="s2">/g; s/__PILLAR__DNS__DOMAIN__/</span><span class="nv">$domain</span><span class="s2">/g; s/__PILLAR__DNS__SERVER__/</span><span class="nv">$kubedns</span><span class="s2">/g"</span> nodelocaldns.yaml

<span class="c"># nodelocaldns ì„¤ì¹˜</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> nodelocaldns.yaml
<span class="c"># =&gt; serviceaccount/node-local-dns created</span>
<span class="c">#    service/kube-dns-upstream created</span>
<span class="c">#    configmap/node-local-dns created</span>
<span class="c">#    daemonset.apps/node-local-dns created</span>
<span class="c">#    service/node-local-dns created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>node-local-dns <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                   READY   STATUS              RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    node-local-dns-6gzpj   0/1     ContainerCreating   0          10s   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    node-local-dns-c2846   0/1     ContainerCreating   0          10s   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl edit cm <span class="nt">-n</span> kube-system node-local-dns <span class="c"># 'cluster.local' ê³¼ '.:53' ì— log, debug ì¶”ê°€</span>
<span class="c"># =&gt; configmap/node-local-dns edited</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds node-local-dns
<span class="c"># =&gt; daemonset.apps/node-local-dns restarted</span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system node-local-dns
<span class="c"># =&gt; cluster.local:53 {</span>
<span class="c">#        log</span>
<span class="c">#        debug</span>
<span class="c">#        errors</span>
<span class="c">#        cache {</span>
<span class="c">#                success 9984 30</span>
<span class="c">#                denial 9984 5</span>
<span class="c">#        }</span>
<span class="c">#        reload</span>
<span class="c">#        loop</span>
<span class="c">#        bind 169.254.20.10 10.96.0.10</span>
<span class="c">#        forward . __PILLAR__CLUSTER__DNS__ {</span>
<span class="c">#                force_tcp</span>
<span class="c">#        }</span>
<span class="c">#        prometheus :9253</span>
<span class="c">#        health 169.254.20.10:8080</span>
<span class="c">#        }</span>
<span class="c">#    ...</span>
<span class="c">#    .:53 {</span>
<span class="c">#        log</span>
<span class="c">#        debug</span>
<span class="c">#        errors</span>
<span class="c">#        cache 30</span>
<span class="c">#        reload</span>
<span class="c">#        loop</span>
<span class="c">#        bind 169.254.20.10 10.96.0.10</span>
<span class="c">#        forward . __PILLAR__UPSTREAM__SERVERS__</span>
<span class="c">#        prometheus :9253</span>
<span class="c">#        }</span>

<span class="c"># iptables í™•ì¸ : ê·œì¹™ ì—…ë°ì´íŠ¸ê¹Œì§€ ë‹¤ì†Œ ì‹œê°„ ì†Œìš”!</span>
<span class="nv">$ </span>iptables-save | <span class="nb">tee </span>after.txt
<span class="nv">$ </span>diff before.txt after.txt

<span class="c">##</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nt">-i</span> dns
<span class="c"># =&gt; -A INPUT -d 10.96.0.10/32 -p udp -m udp --dport 53 -m comment --comment "NodeLocal DNS Cache: allow DNS traffic" -j ACCEPT</span>
<span class="c">#    -A INPUT -d 10.96.0.10/32 -p tcp -m tcp --dport 53 -m comment --comment "NodeLocal DNS Cache: allow DNS traffic" -j ACCEPT</span>
<span class="c">#    -A INPUT -d 169.254.20.10/32 -p udp -m udp --dport 53 -m comment --comment "NodeLocal DNS Cache: allow DNS traffic" -j ACCEPT</span>
<span class="c">#    -A INPUT -d 169.254.20.10/32 -p tcp -m tcp --dport 53 -m comment --comment "NodeLocal DNS Cache: allow DNS traffic" -j ACCEPT</span>
<span class="c">#    -A OUTPUT -s 10.96.0.10/32 -p udp -m udp --sport 53 -m comment --comment "NodeLocal DNS Cache: allow DNS traffic" -j ACCEPT</span>
<span class="c">#    -A OUTPUT -s 10.96.0.10/32 -p tcp -m tcp --sport 53 -m comment --comment "NodeLocal DNS Cache: allow DNS traffic" -j ACCEPT</span>
<span class="c">#    -A OUTPUT -s 169.254.20.10/32 -p udp -m udp --sport 53 -m comment --comment "NodeLocal DNS Cache: allow DNS traffic" -j ACCEPT</span>
<span class="c">#    -A OUTPUT -s 169.254.20.10/32 -p tcp -m tcp --sport 53 -m comment --comment "NodeLocal DNS Cache: allow DNS traffic" -j ACCEPT</span>

<span class="c">##</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nt">-i</span> dns
<span class="c"># =&gt; -A PREROUTING -d 10.96.0.10/32 -p udp -m udp --dport 53 -m comment --comment "NodeLocal DNS Cache: skip conntrack" -j NOTRACK</span>
<span class="c">#    -A PREROUTING -d 10.96.0.10/32 -p tcp -m tcp --dport 53 -m comment --comment "NodeLocal DNS Cache: skip conntrack" -j NOTRACK</span>
<span class="c">#    -A PREROUTING -d 169.254.20.10/32 -p udp -m udp --dport 53 -m comment --comment "NodeLocal DNS Cache: skip conntrack" -j NOTRACK</span>
<span class="c">#    -A PREROUTING -d 169.254.20.10/32 -p tcp -m tcp --dport 53 -m comment --comment "NodeLocal DNS Cache: skip conntrack" -j NOTRACK</span>
<span class="c">#    -A OUTPUT -s 10.96.0.10/32 -p tcp -m tcp --sport 8080 -m comment --comment "NodeLocal DNS Cache: skip conntrack" -j NOTRACK</span>
<span class="c">#    -A OUTPUT -d 10.96.0.10/32 -p tcp -m tcp --dport 8080 -m comment --comment "NodeLocal DNS Cache: skip conntrack" -j NOTRACK</span>
<span class="c">#    ...</span>

<span class="c"># logs : </span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">-f</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs <span class="nt">-l</span> k8s-app<span class="o">=</span>node-local-dns <span class="nt">-f</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> <span class="nb">cat</span> /etc/resolv.conf
<span class="c"># =&gt; search default.svc.cluster.local svc.cluster.local cluster.local</span>
<span class="c">#    nameserver 10.96.0.10</span>
<span class="c">#    options ndots:5</span>

<span class="c"># </span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> nslookup webpod
<span class="c"># kube-dns ë¡œê·¸ í™•ì¸</span>
<span class="c"># =&gt; [INFO] 172.20.1.80:57227 - 46178 "A IN webpod.default.svc.cluster.local. udp 50 false 512" NOERROR qr,aa,rd 98 0.000729042s</span>
<span class="c">#    [INFO] 172.20.1.80:49087 - 7946 "AAAA IN webpod.default.svc.cluster.local. udp 50 false 512" NOERROR qr,aa,rd 143 0.000557625s</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> nslookup google.com
<span class="c"># kube-dns ë¡œê·¸ í™•ì¸</span>
<span class="c"># =&gt; [INFO] 172.20.1.80:52008 - 19063 "A IN google.com.default.svc.cluster.local. udp 54 false 512" NXDOMAIN qr,aa,rd 147 0.000802417s</span>
<span class="c">#    [INFO] 172.20.1.80:53056 - 1029 "A IN google.com.svc.cluster.local. udp 46 false 512" NXDOMAIN qr,aa,rd 139 0.000377583s</span>
<span class="c">#    [INFO] 172.20.1.80:40165 - 2061 "A IN google.com.cluster.local. udp 42 false 512" NXDOMAIN qr,aa,rd 135 0.000287959s</span>
<span class="c">#    [INFO] 172.20.1.80:42852 - 42332 "A IN google.com. udp 28 false 512" NOERROR qr,aa,rd,ra 54 0.000450083s</span>
<span class="c">#    [INFO] 172.20.1.80:52047 - 947 "AAAA IN google.com. udp 28 false 512" NOERROR qr,aa,rd,ra 66 0.000662125s</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë¡œê·¸ê°€ kube-dns ìª½ì—ë§Œ ìŒ“ì…ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl delete pod curl-pod

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> <span class="nb">cat</span> /etc/resolv.conf
<span class="c"># =&gt; search default.svc.cluster.local svc.cluster.local cluster.local</span>
<span class="c">#    nameserver 10.96.0.10</span>
<span class="c">#    options ndots:5</span>

<span class="c"># ë¡œê·¸ í™•ì¸ ì‹œ í˜„ì¬ nodelocaldns ë¯¸í™œìš©! </span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">-f</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs <span class="nt">-l</span> k8s-app<span class="o">=</span>node-local-dns <span class="nt">-f</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> nslookup webpod
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> nslookup google.com
</code></pre></div></div>

<ul>
  <li>ìœ„ì˜ ì˜ˆì œì—ì„œëŠ” ì•„ì§ NodeLocal DNSCacheë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="cilium-local-redirect-policy">Cilium Local Redirect Policy</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">--set localRedirectPolicy=true</code> í•´ì„œ Local Redirect Policyë¥¼ í™œì„±í™”í•˜ë©´, Ciliumì€ NodeLocal DNSCacheë¥¼ ì‚¬ìš©í•˜ì—¬ DNS ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/network/kubernetes/local-redirect-policy/">Docs</a></li>
  <li>IP ì£¼ì†Œì™€ Port/Protocol tuple ë˜ëŠ” <strong>Kubernetes Service</strong> ë¡œ í–¥í•˜ëŠ” í¬ë“œ <strong>íŠ¸ë˜í”½</strong>ì„ eBPFë¥¼ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ ë‚´ <strong>ë°±ì—”ë“œ í¬ë“œë¡œ ë¡œì»¬ë¡œ ë¦¬ë””ë ‰ì…˜</strong>í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” Ciliumì˜ ë¡œì»¬ ë¦¬ë””ë ‰ì…˜ ì •ì±…ì„ êµ¬ì„±í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.</li>
  <li>ë°±ì—”ë“œ í¬ë“œì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ì •ì±…ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>CiliumLocalRedirectPolicyëŠ” CustomResourceDefinitionìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">localRedirectPolicy</span><span class="o">=</span><span class="nb">true</span>

<span class="nv">$ </span>kubectl rollout restart deploy cilium-operator <span class="nt">-n</span> kube-system
<span class="c"># =&gt; deployment.apps/cilium-operator restarted</span>
<span class="nv">$ </span>kubectl rollout restart ds cilium <span class="nt">-n</span> kube-system
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c">#</span>
<span class="nv">$ </span>wget https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/kubernetes-local-redirect/node-local-dns.yaml

<span class="nv">$ kubedns</span><span class="o">=</span><span class="si">$(</span>kubectl get svc kube-dns <span class="nt">-n</span> kube-system <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/__PILLAR__DNS__SERVER__/</span><span class="nv">$kubedns</span><span class="s2">/g;"</span> node-local-dns.yaml
<span class="nv">$ </span>vi <span class="nt">-d</span> nodelocaldns.yaml node-local-dns.yaml
</code></pre></div></div>

<ul>
  <li>nodelocaldns.yamlê³¼ node-local-dns.yamlì˜ diff ê²°ê³¼ 
<img src="/assets/2025/cilium/w3/20250803_cilium_w3_22.png" alt="img.png" />
<img src="/assets/2025/cilium/w3/20250803_cilium_w3_23.png" alt="img_1.png" /></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## before</span>
<span class="c"># args: [ "-localip", "169.254.20.10,10.96.0.10", "-conf", "/etc/Corefile", "-upstreamsvc", "kube-dns-upstream" ]</span>

<span class="c">## after</span>
<span class="c"># args: [ "-localip", "169.254.20.10,10.96.0.10", "-conf", "/etc/Corefile", "-upstreamsvc", "kube-dns-upstream", "-skipteardown=true", "-setupinterface=false", "-setupiptables=false" ]</span>


<span class="c"># ë°°í¬</span>
<span class="c"># Modify Node-local DNS cacheâ€™s deployment yaml to pass these additional arguments to node-cache: </span>
<span class="c">## -skipteardown=true, -setupinterface=false, and -setupiptables=false.</span>

<span class="c"># Modify Node-local DNS cacheâ€™s deployment yaml to put it in non-host namespace by setting hostNetwork: false for the daemonset.</span>
<span class="c"># In the Corefile, bind to 0.0.0.0 instead of the static IP.</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> node-local-dns.yaml
<span class="c"># =&gt; serviceaccount/node-local-dns configured</span>
<span class="c">#    service/kube-dns-upstream configured</span>
<span class="c">#    configmap/node-local-dns configured</span>
<span class="c">#    daemonset.apps/node-local-dns configured</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl edit cm <span class="nt">-n</span> kube-system node-local-dns <span class="c"># log, debug ì¶”ê°€</span>
<span class="c"># =&gt; configmap/node-local-dns edited</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds node-local-dns
<span class="c"># =&gt; daemonset.apps/node-local-dns restarted</span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system node-local-dns
<span class="c"># =&gt; ...</span>
<span class="c">#    cluster.local:53 {</span>
<span class="c">#        log</span>
<span class="c">#        debug</span>
<span class="c">#        errors</span>
<span class="c">#        cache {</span>
<span class="c">#                success 9984 30</span>
<span class="c">#                denial 9984 5</span>
<span class="c">#        }</span>
<span class="c">#        reload</span>
<span class="c">#        loop</span>
<span class="c">#        bind 0.0.0.0</span>
<span class="c">#        forward . __PILLAR__CLUSTER__DNS__ {</span>
<span class="c">#                force_tcp</span>
<span class="c">#        }</span>
<span class="c">#        prometheus :9253</span>
<span class="c">#        health</span>
<span class="c">#        }</span>
<span class="c">#    ...</span>
<span class="c">#    .:53 {</span>
<span class="c">#        log</span>
<span class="c">#        debug</span>
<span class="c">#        errors</span>
<span class="c">#        cache 30</span>
<span class="c">#        reload</span>
<span class="c">#        loop</span>
<span class="c">#        bind 0.0.0.0</span>
<span class="c">#        forward . __PILLAR__UPSTREAM__SERVERS__</span>
<span class="c">#        prometheus :9253</span>
<span class="c">#        }</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>wget https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/kubernetes-local-redirect/node-local-dns-lrp.yaml
<span class="nv">$ </span><span class="nb">cat </span>node-local-dns-lrp.yaml
<span class="c"># =&gt; apiVersion: "cilium.io/v2"</span>
<span class="c">#    kind: CiliumLocalRedirectPolicy</span>
<span class="c">#    metadata:</span>
<span class="c">#      name: "nodelocaldns"</span>
<span class="c">#      namespace: kube-system</span>
<span class="c">#    spec:</span>
<span class="c">#      redirectFrontend:</span>
<span class="c">#        serviceMatcher:</span>
<span class="c">#          serviceName: kube-dns</span>
<span class="c">#          namespace: kube-system</span>
<span class="c">#      redirectBackend:</span>
<span class="c">#        localEndpointSelector:</span>
<span class="c">#          matchLabels:</span>
<span class="c">#            k8s-app: node-local-dns</span>
<span class="c">#        toPorts:</span>
<span class="c">#          - port: "53"</span>
<span class="c">#            name: dns</span>
<span class="c">#            protocol: UDP</span>
<span class="c">#          - port: "53"</span>
<span class="c">#            name: dns-tcp</span>
<span class="c">#            protocol: TCP</span>
        
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/kubernetes-local-redirect/node-local-dns-lrp.yaml
<span class="c"># =&gt; ciliumlocalredirectpolicy.cilium.io/nodelocaldns created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get CiliumLocalRedirectPolicy <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE     NAME           AGE</span>
<span class="c">#    kube-system   nodelocaldns   8s</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg lrp list
<span class="c"># =&gt; LRP namespace   LRP name       FrontendType                Matching Service</span>
<span class="c">#    kube-system     nodelocaldns   clusterIP + all svc ports   kube-system/kube-dns</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg service list | <span class="nb">grep </span>LocalRedirect
<span class="c"># =&gt; 16   10.96.0.10:53/UDP       LocalRedirect   1 =&gt; 172.20.0.73:53/UDP (active)</span>
<span class="c">#    17   10.96.0.10:53/TCP       LocalRedirect   1 =&gt; 172.20.0.73:53/TCP (active)</span>

<span class="c"># logs</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">-f</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs <span class="nt">-l</span> k8s-app<span class="o">=</span>node-local-dns <span class="nt">-f</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> nslookup www.google.com
<span class="c"># =&gt; Server:         10.96.0.10</span>
<span class="c">#    Address:        10.96.0.10#53</span>
<span class="c">#    </span>
<span class="c">#    Non-authoritative answer:</span>
<span class="c">#    Name:   www.google.com</span>
<span class="c">#    Address: 142.250.206.228</span>
<span class="c">#    Name:   www.google.com</span>
<span class="c">#    Address: 2404:6800:400a:804::2004</span>

<span class="c"># kube-dns ë¡œê·¸ í™•ì¸</span>
<span class="c"># =&gt; [INFO] 172.20.1.178:55860 - 32731 "A IN www.google.com.default.svc.cluster.local. tcp 58 false 65535" NXDOMAIN qr,aa,rd 151 0.002254584s</span>
<span class="c">#    [INFO] 172.20.1.178:55860 - 50477 "A IN www.google.com.svc.cluster.local. tcp 50 false 65535" NXDOMAIN qr,aa,rd 143 0.000426625s</span>
<span class="c">#    [INFO] 172.20.1.178:55860 - 42463 "A IN www.google.com.cluster.local. tcp 46 false 65535" NXDOMAIN qr,aa,rd 139 0.000225583s</span>

<span class="c"># node-local-dns ë¡œê·¸ í™•ì¸</span>
<span class="c"># =&gt; [INFO] 172.20.1.20:52275 - 32731 "A IN www.google.com.default.svc.cluster.local. udp 58 false 512" NXDOMAIN qr,aa,rd 151 0.009171834s</span>
<span class="c">#    [INFO] 172.20.1.20:60077 - 50477 "A IN www.google.com.svc.cluster.local. udp 50 false 512" NXDOMAIN qr,aa,rd 143 0.001657537s</span>
<span class="c">#    [INFO] 172.20.1.20:48089 - 42463 "A IN www.google.com.cluster.local. udp 46 false 512" NXDOMAIN qr,aa,rd 139 0.001401951s</span>
<span class="c">#    [INFO] 172.20.1.20:58721 - 18703 "A IN www.google.com. udp 32 false 512" NOERROR qr,rd,ra 62 0.046337824s</span>
<span class="c">#    [INFO] 172.20.1.20:42914 - 43270 "AAAA IN www.google.com. udp 32 false 512" NOERROR qr,rd,ra 74 0.042382055s</span>

<span class="c"># í•œë²ˆë” dns ì¡°íšŒ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> nslookup www.google.com
<span class="c"># =&gt; Server:         10.96.0.10</span>
<span class="c">#    Address:        10.96.0.10#53</span>
<span class="c">#    </span>
<span class="c">#    Non-authoritative answer:</span>
<span class="c">#    Name:   www.google.com</span>
<span class="c">#    Address: 142.250.206.228</span>
<span class="c">#    Name:   www.google.com</span>
<span class="c">#    Address: 2404:6800:400a:804::2004</span>

<span class="c"># kube-dns ë¡œê·¸ í™•ì¸</span>
<span class="c"># =&gt; (ë¡œê·¸ ì—†ìŒ)</span>

<span class="c"># node-local-dns ë¡œê·¸ í™•ì¸</span>
<span class="c"># =&gt; [INFO] 172.20.1.20:52275 - 32731 "A IN www.google.com.default.svc.cluster.local. udp 58 false 512" NXDOMAIN qr,aa,rd 151 0.009171834s</span>
<span class="c">#    [INFO] 172.20.1.20:60077 - 50477 "A IN www.google.com.svc.cluster.local. udp 50 false 512" NXDOMAIN qr,aa,rd 143 0.001657537s</span>
<span class="c">#    [INFO] 172.20.1.20:48089 - 42463 "A IN www.google.com.cluster.local. udp 46 false 512" NXDOMAIN qr,aa,rd 139 0.001401951s</span>
<span class="c">#    [INFO] 172.20.1.20:58721 - 18703 "A IN www.google.com. udp 32 false 512" NOERROR qr,rd,ra 62 0.046337824s</span>
<span class="c">#    [INFO] 172.20.1.20:42914 - 43270 "AAAA IN www.google.com. udp 32 false 512" NOERROR qr,rd,ra 74 0.042382055s</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì—°ì† ì¡°íšŒì‹œ node-local-dnsì— ìºì‹œê°€ ë˜ì–´ì„œ kube-dnsì˜ ì¡°íšŒê°€ ì¤„ì–´ë“¬ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># nodelocaldns ì— ìºì‹œëœ ì •ë³´ë¡œ ë°”ë¡œ ì§ˆì˜ ì‘ë‹µ í™•ì¸!</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs <span class="nt">-l</span> k8s-app<span class="o">=</span>node-local-dns <span class="nt">-f</span>
<span class="c"># =&gt; [INFO] 172.20.1.20:52275 - 32731 "A IN www.google.com.default.svc.cluster.local. udp 58 false 512" NXDOMAIN qr,aa,rd 151 0.009171834s</span>
<span class="c">#    [INFO] 172.20.1.20:60077 - 50477 "A IN www.google.com.svc.cluster.local. udp 50 false 512" NXDOMAIN qr,aa,rd 143 0.001657537s</span>
<span class="c">#    [INFO] 172.20.1.20:48089 - 42463 "A IN www.google.com.cluster.local. udp 46 false 512" NXDOMAIN qr,aa,rd 139 0.001401951s</span>
<span class="c">#    [INFO] 172.20.1.20:58721 - 18703 "A IN www.google.com. udp 32 false 512" NOERROR qr,rd,ra 62 0.046337824s</span>
<span class="c">#    [INFO] 172.20.1.20:42914 - 43270 "AAAA IN www.google.com. udp 32 false 512" NOERROR qr,rd,ra 74 0.042382055s</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w3/20250803_cilium_w3_24.png" alt="img.png" class="image-center" /></p>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë…¸ë“œì˜ íŒŒë“œ ë“¤ê°„ í†µì‹ ê³¼ ì™¸ë¶€ì™€ì˜ í†µì‹ , DNS ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.
ë„¤íŠ¸ì›Œí¬ëŠ” ë³¼ë•Œë§ˆë‹¤ ì–´ë ¤ìš´ê²ƒ ê°™ìŠµë‹ˆë‹¤. :sweat_smile: 
í•˜ì§€ë§Œ ì¡°ê¸ˆì”© ì´í•´ê°€ ë˜ê³ , ìµìˆ™í•´ì§€ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. í•œê±¸ìŒ í•œê±¸ìŒ ë‚˜ì•„ê°€ê³  ìˆëŠ”ê²ƒì´ ëŠê»´ì§‘ë‹ˆë‹¤.</p>

<p>ë‹¤ì–‘í•œ ì£¼ì œì— ê±¸ì³ ë°°ì› ëŠ”ë°, ëª¨ë“  íŒŒíŠ¸ì—ì„œ ìˆ˜ ë§ì€ ì‚¬ëŒë“¤ì´ ì¡°ê¸ˆì´ë¼ë„ ë„¤íŠ¸ì›Œí¬ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ í•˜ê¸°ìœ„í•´ì„œ
ì• ì“´ í”ì ë“¤ì„ ë³¼ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ° ë¶„ë“¤ì´ ìˆì–´ì„œ ì§€ê¸ˆ ì´ë ‡ê²Œ ì¸í„°ë„·ì„ ì‚¬ìš©í•˜ê³  í´ë¼ìš°ë“œë¥¼ ì´ìš©í•  ìˆ˜ ìˆìœ¼ë‹ˆ
í•œë²ˆë„ ëµŒì ì€ ì—†ì§€ë§Œ ê·¸ë¶„ë“¤ì—ê²Œ ê°ì‚¬ì˜ ë§ˆìŒì„ ì „í•©ë‹ˆë‹¤. :pray:</p>

<hr />

<h2 id="ë¶€ë¡">ë¶€ë¡</h2>

<h3 id="k9s-ì£¼ìš”-ë‹¨ì¶•í‚¤">K9s ì£¼ìš” ë‹¨ì¶•í‚¤</h3>

<table>
  <thead>
    <tr>
      <th><strong>Action</strong></th>
      <th><strong>Command</strong></th>
      <th><strong>Comment</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Show active keyboard mnemonics and help</td>
      <td><code class="language-plaintext highlighter-rouge">?</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>Show all available resource alias</td>
      <td><code class="language-plaintext highlighter-rouge">ctrl-a</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>To bail out of K9s</td>
      <td><code class="language-plaintext highlighter-rouge">:quit</code> <code class="language-plaintext highlighter-rouge">:q</code> <code class="language-plaintext highlighter-rouge">ctrl-c</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>To go up/back to the previous view</td>
      <td><code class="language-plaintext highlighter-rouge">esc</code></td>
      <td>If you have crumbs on, this will go to the previous one</td>
    </tr>
    <tr>
      <td>View a Kubernetes resource using singular/plural or short-name</td>
      <td><code class="language-plaintext highlighter-rouge">:pod</code></td>
      <td>accepts singular, plural, short-name or alias ie pod or pods</td>
    </tr>
    <tr>
      <td>View a Kubernetes resource in a given namespace</td>
      <td><code class="language-plaintext highlighter-rouge">:pod ns-x</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>View filtered pods (New v0.30.0!)</td>
      <td><code class="language-plaintext highlighter-rouge">:pod /fred</code></td>
      <td>View all pods filtered by fred</td>
    </tr>
    <tr>
      <td>View labeled pods (New v0.30.0!)</td>
      <td><code class="language-plaintext highlighter-rouge">:pod app=fred,env=dev</code></td>
      <td>View all pods with labels matching app=fred and env=dev</td>
    </tr>
    <tr>
      <td>View pods in a given context (New v0.30.0!)</td>
      <td><code class="language-plaintext highlighter-rouge">:pod @ctx1</code></td>
      <td>View all pods in context ctx1. Switches out your current k9s context!</td>
    </tr>
    <tr>
      <td>Filter out a resource view given a filter</td>
      <td><code class="language-plaintext highlighter-rouge">/filter</code></td>
      <td>Regex2 supported ie <code class="language-plaintext highlighter-rouge">fred</code></td>
    </tr>
    <tr>
      <td>Inverse regex filter</td>
      <td><code class="language-plaintext highlighter-rouge">/! filter</code></td>
      <td>Keep everything that <em>doesnâ€™t</em> match.</td>
    </tr>
    <tr>
      <td>Filter resource view by labels</td>
      <td><code class="language-plaintext highlighter-rouge">/-l label-selector</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>Fuzzy find a resource given a filter</td>
      <td><code class="language-plaintext highlighter-rouge">/-f filter</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>Bails out of view/command/filter mode</td>
      <td><code class="language-plaintext highlighter-rouge">&lt;esc&gt;</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>Key mapping to describe, view, edit, view logs,â€¦</td>
      <td><code class="language-plaintext highlighter-rouge">d</code>, <code class="language-plaintext highlighter-rouge">v</code>, <code class="language-plaintext highlighter-rouge">e</code>, <code class="language-plaintext highlighter-rouge">l</code>,â€¦</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>To view and switch to another Kubernetes context (Pod view)</td>
      <td><code class="language-plaintext highlighter-rouge">:ctx</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>To view and switch directly to another Kubernetes context (Last used view)</td>
      <td><code class="language-plaintext highlighter-rouge">:ctx context-name</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>To view and switch to another Kubernetes namespace</td>
      <td><code class="language-plaintext highlighter-rouge">:ns</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>To switch back to the last active command (like how â€œcd -â€œ works)</td>
      <td><code class="language-plaintext highlighter-rouge">-</code></td>
      <td>Navigation that adds breadcrumbs to the bottom are not commands</td>
    </tr>
    <tr>
      <td>To go back and forward through the command history</td>
      <td>back: <code class="language-plaintext highlighter-rouge">[</code>, forward: <code class="language-plaintext highlighter-rouge">]</code></td>
      <td>Same as above</td>
    </tr>
    <tr>
      <td>To view all saved resources</td>
      <td><code class="language-plaintext highlighter-rouge">:screendump</code> or <code class="language-plaintext highlighter-rouge">:sd</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>To delete a resource (TAB and ENTER to confirm)</td>
      <td><code class="language-plaintext highlighter-rouge">ctrl-d</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>To kill a resource (no confirmation dialog, equivalent to kubectl delete â€“now)</td>
      <td><code class="language-plaintext highlighter-rouge">ctrl-k</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>Launch pulses view</td>
      <td><code class="language-plaintext highlighter-rouge">:pulses</code> or <code class="language-plaintext highlighter-rouge">:pu</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>Launch XRay view</td>
      <td><code class="language-plaintext highlighter-rouge">:xray RESOURCE [NAMESPACE]</code></td>
      <td>RESOURCE can be one of po, <strong>svc</strong>, dp, rs, sts, ds, NAMESPACE is optional</td>
    </tr>
    <tr>
      <td>Launch Popeye view</td>
      <td><code class="language-plaintext highlighter-rouge">:popeye</code> or <code class="language-plaintext highlighter-rouge">:pop</code></td>
      <td>See <a href="https://github.com/derailed/k9s#popeye">popeye</a></td>
    </tr>
  </tbody>
</table>]]></content><author><name></name></author><category term="cilium" /><category term="kubernetes," /><category term="network," /><category term="linux," /><category term="cilium," /><category term="ipam," /><category term="routing," /><category term="masquerading," /><category term="coredns," /><category term="nodelocaldns" /><summary type="html"><![CDATA[Ciliumì˜ Networkingì— ëŒ€í•´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤. Ciliumì´ ì–´ë–»ê²Œ ë…¸ë“œì— ìˆëŠ” íŒŒë“œë“¤ ê°„ì˜ í†µì‹ ì„ ì²˜ë¦¬í•˜ëŠ”ì§€, IP ì£¼ì†Œ í• ë‹¹(IPAM), ë¼ìš°íŒ…, ë§ˆìŠ¤ì»¤ë ˆì´ë”©, DNS ì„¤ì • ë“±ì„ ë‹¤ë£° ê²ƒì…ë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[Cilium] (Observability) Hubble, Prometheus, Grafana</title><link href="https://sweetlittlebird.github.io/posts/2025-07-27-Cilium-Week2/" rel="alternate" type="text/html" title="[Cilium] (Observability) Hubble, Prometheus, Grafana" /><published>2025-07-27T00:10:18+09:00</published><updated>2025-07-27T00:10:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/Cilium%20-%20Week2</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2025-07-27-Cilium-Week2/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆì—ëŠ” Hubble, Prometheus, Grafana ë“±ì„ ì´ìš©í•˜ì—¬ Ciliumì˜ ê´€ì¸¡ì„±(Observability)ì— ëŒ€í•´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="ì‹¤ìŠµ-í™˜ê²½-êµ¬ì„±">ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±</h2>

<ul>
  <li>ì‹¤ìŠµ í™˜ê²½ ì†Œê°œ</li>
</ul>

<p>ì‹¤ìŠµ í™˜ê²½ì€ ì§€ë‚œì£¼ì™€ ê±°ì˜ ìœ ì‚¬í•©ë‹ˆë‹¤. ë‹¨, íŒŒë“œ IP ëŒ€ì—­ì´ <code class="language-plaintext highlighter-rouge">10.244.0.0/16</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">172.20.0.0/16</code>ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_1.png" alt="img.png" /></p>

<ul>
  <li>ë°°í¬ ê°€ìƒ ë¨¸ì‹ ì€ ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì¸ k8s-ctr, ì›Œì»¤ë…¸ë“œ k8s-w1, k8s-w2ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>eth0 : 10.0.2.15 (ëª¨ë“  ë…¸ë“œê°€ ë™ì¼)</li>
      <li>eth1 : 192.168.10.100~102</li>
    </ul>
  </li>
  <li>ì´ˆê¸° í”„ë¡œë¹„ì €ë‹ì‹œ <code class="language-plaintext highlighter-rouge">kubeadm init</code>ê³¼ <code class="language-plaintext highlighter-rouge">join</code> ì„ ì‹¤í–‰í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ë©°, <strong>ì´ë²ˆì—ëŠ” Cilium CNIê°€ ì„¤ì¹˜ëœ ìƒíƒœë¡œ ë°°í¬ë©ë‹ˆë‹¤</strong>.</li>
</ul>

<h3 id="ì‹¤ìŠµ-í™˜ê²½-ë°°í¬-íŒŒì¼-ì‘ì„±">ì‹¤ìŠµ í™˜ê²½ ë°°í¬ íŒŒì¼ ì‘ì„±</h3>

<h4 id="vagrantfile"><strong>Vagrantfile</strong></h4>
<ul>
  <li>ê°€ìƒë¨¸ì‹ ì„ ì •ì˜í•˜ê³  ë¶€íŒ…ì‹œ ì‹¤í–‰í•  í”„ë¡œë¹„ì €ë‹ ì„¤ì •ì„ í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Variables</span>
<span class="no">K8SV</span> <span class="o">=</span> <span class="s1">'1.33.2-1.1'</span> <span class="c1"># Kubernetes Version : apt list -a kubelet , ex) 1.32.5-1.1</span>
<span class="no">CONTAINERDV</span> <span class="o">=</span> <span class="s1">'1.7.27-1'</span> <span class="c1"># Containerd Version : apt list -a containerd.io , ex) 1.6.33-1</span>
<span class="no">CILIUMV</span> <span class="o">=</span> <span class="s1">'1.17.6'</span> <span class="c1"># Cilium CNI Version : https://github.com/cilium/cilium/tags</span>
<span class="no">N</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># max number of worker nodes</span>

<span class="c1"># Base Image  https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-24.04</span>
<span class="no">BOX_IMAGE</span> <span class="o">=</span> <span class="s2">"bento/ubuntu-24.04"</span>
<span class="no">BOX_VERSION</span> <span class="o">=</span> <span class="s2">"202502.21.0"</span>

<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1">#-ControlPlane Node</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-ctr"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>

    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">2048</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.100"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60000</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span> <span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-ctr.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">N</span><span class="p">,</span> <span class="no">CILIUMV</span> <span class="p">]</span>
  <span class="k">end</span>

  <span class="c1">#-Worker Nodes Subnet1</span>
  <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="no">N</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.10</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="s2">"6000</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-w.sh"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="init_cfgsh"><strong>init_cfg.sh</strong></h4>
<ul>
  <li>í”„ë¡œë¹„ì €ë‹ì‹œ vagrantê°€ ì‹¤í–‰í•  ì´ˆê¸° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. argumentsë¡œ Kubernetes ë²„ì „ê³¼ Containerd ë²„ì „ë“±ì„ ë°›ì•„ì„œ ì„¤ì¹˜í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>

<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime <span class="c"># Change Timezone</span>

<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="nb">echo</span> <span class="s2">"[TASK 3] Disable and turn off SWAP"</span>
swapoff <span class="nt">-a</span> <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'/swap/s/^/#/'</span> /etc/fstab

<span class="nb">echo</span> <span class="s2">"[TASK 4] Install Packages"</span>
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>apt-transport-https ca-certificates curl gpg <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="c"># Download the public signing key for the Kubernetes package repositories.</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nt">-m</span> 755 /etc/apt/keyrings
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$1</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+)\..*/\1/p'</span><span class="si">)</span>
curl <span class="nt">-fsSL</span> https://pkgs.k8s.io/core:/stable:/v<span class="nv">$K8SMMV</span>/deb/Release.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/kubernetes-apt-keyring.gpg
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v</span><span class="nv">$K8SMMV</span><span class="s2">/deb/ /"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list.d/kubernetes.list
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null

<span class="c"># packets traversing the bridge are processed by iptables for filtering</span>
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
<span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> <span class="o">&gt;&gt;</span> /etc/sysctl.d/k8s.conf

<span class="c"># enable br_netfilter for iptables </span>
modprobe br_netfilter
modprobe overlay
<span class="nb">echo</span> <span class="s2">"br_netfilter"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
<span class="nb">echo</span> <span class="s2">"overlay"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf

<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)"</span>
<span class="c"># Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version</span>
apt update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="c"># apt list -a kubelet ; apt list -a containerd.io</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubectl</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubeadm</span><span class="o">=</span><span class="nv">$1</span> containerd.io<span class="o">=</span><span class="nv">$2</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-mark hold kubelet kubeadm kubectl <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="c"># containerd configure to default and cgroup managed by systemd</span>
containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SystemdCgroup = false/SystemdCgroup = true/g'</span> /etc/containerd/config.toml

<span class="c"># avoid WARN&amp;ERRO(default endpoints) when crictl run  </span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
</span><span class="no">EOF

</span><span class="c"># ready to install for k8s </span>
systemctl restart containerd <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable </span>containerd
systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet

<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Packages &amp; Helm"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get <span class="nb">install</span> <span class="nt">-y</span> bridge-utils sshpass net-tools conntrack ngrep tcpdump ipset arping wireguard jq tree bash-completion unzip kubecolor termshark <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
curl <span class="nt">-s</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div></div>

<h4 id="k8s-ctrsh"><strong>k8s-ctr.sh</strong></h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">kubeadm init</code>ìœ¼ë¡œ ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì„ ì„¤ì •í•˜ê³ , Cilium CNIë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤. ë˜í•œ í¸ì˜ë¥¼ ìœ„í•œ <code class="language-plaintext highlighter-rouge">k</code>, <code class="language-plaintext highlighter-rouge">kc</code> ë“±ì˜ aliasë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane config Start &lt;&lt;&lt;&lt;"</span>

<span class="nb">echo</span> <span class="s2">"[TASK 1] Initial Kubernetes"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-init-ctr-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-init-ctr-config.yaml
kubeadm init <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-init-ctr-config.yaml"</span> <span class="nt">--skip-phases</span><span class="o">=</span>addon/kube-proxy  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1


<span class="nb">echo</span> <span class="s2">"[TASK 2] Setting kube config file"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /root/.kube
<span class="nb">cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf /root/.kube/config
<span class="nb">chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> /root/.kube/config


<span class="nb">echo</span> <span class="s2">"[TASK 3] Source the completion"</span>
<span class="nb">echo</span> <span class="s1">'source &lt;(kubectl completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'source &lt;(kubeadm completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile


<span class="nb">echo</span> <span class="s2">"[TASK 4] Alias kubectl to k"</span>
<span class="nb">echo</span> <span class="s1">'alias k=kubectl'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'alias kc=kubecolor'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'complete -F __start_kubectl k'</span> <span class="o">&gt;&gt;</span> /etc/profile


<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubectx &amp; Kubens"</span>
git clone https://github.com/ahmetb/kubectx /opt/kubectx <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubens /usr/local/bin/kubens
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubectx /usr/local/bin/kubectx


<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Kubeps &amp; Setting PS1"</span>
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1 <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">"</span><span class="no">EOT</span><span class="sh">" &gt;&gt; /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
function get_cluster_short() {
  echo "</span><span class="nv">$1</span><span class="sh">" | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=') '
PS1='</span><span class="si">$(</span>kube_ps1<span class="si">)</span><span class="sh">'</span><span class="nv">$PS1</span><span class="sh">
</span><span class="no">EOT
</span>kubectl config rename-context <span class="s2">"kubernetes-admin@kubernetes"</span> <span class="s2">"HomeLab"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1


<span class="nb">echo</span> <span class="s2">"[TASK 7] Install Cilium CNI"</span>
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
helm repo add cilium https://helm.cilium.io/ <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm repo update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> <span class="nv">$2</span> <span class="nt">--namespace</span> kube-system <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.100 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="se">\</span>
<span class="nt">--set</span> ipam.mode<span class="o">=</span><span class="s2">"cluster-pool"</span> <span class="nt">--set</span> ipam.operator.clusterPoolIPv4PodCIDRList<span class="o">={</span><span class="s2">"172.20.0.0/16"</span><span class="o">}</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>172.20.0.0/16 <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> endpointRoutes.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1


<span class="nb">echo</span> <span class="s2">"[TASK 8] Install Cilium CLI"</span>
<span class="nv">CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz


<span class="nb">echo</span> <span class="s2">"[TASK 9] local DNS with hosts file"</span>
<span class="nb">echo</span> <span class="s2">"192.168.10.100 k8s-ctr"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;<span class="o">=</span><span class="nv">$1</span><span class="p">;</span> i++  <span class="o">))</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"192.168.10.10</span><span class="nv">$i</span><span class="s2"> k8s-w</span><span class="nv">$i</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts<span class="p">;</span> <span class="k">done


</span><span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ë¶€ê°€ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">kubeadm-init-ctr-config.yaml</code> íŒŒì¼ì€ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kubeadm.k8s.io/v1beta4</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">InitConfiguration</span>
<span class="na">bootstrapTokens</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">token</span><span class="pi">:</span> <span class="s2">"</span><span class="s">123456.1234567890123456"</span>
  <span class="na">ttl</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0s"</span>
  <span class="na">usages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">signing</span>
  <span class="pi">-</span> <span class="s">authentication</span>
<span class="na">localAPIEndpoint</span><span class="pi">:</span>
  <span class="na">advertiseAddress</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.10.100"</span>
<span class="na">nodeRegistration</span><span class="pi">:</span>
  <span class="na">kubeletExtraArgs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">node-ip</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.10.100"</span>
  <span class="na">criSocket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">unix:///run/containerd/containerd.sock"</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kubeadm.k8s.io/v1beta4</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterConfiguration</span>
<span class="na">kubernetesVersion</span><span class="pi">:</span> <span class="s">v1.33.2</span>
<span class="na">networking</span><span class="pi">:</span>
  <span class="na">podSubnet</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.244.0.0/16"</span>
  <span class="na">serviceSubnet</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.96.0.0/16"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="k8s-wsh"><strong>k8s-w.sh</strong></h4>
<ul>
  <li>ì›Œì»¤ë…¸ë“œì—ì„œ <code class="language-plaintext highlighter-rouge">kubeadm join</code>ì„ ì‹¤í–‰í•˜ì—¬ ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì— ì¡°ì¸í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;"</span>

<span class="nb">echo</span> <span class="s2">"[TASK 1] K8S Controlplane Join"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-join-worker-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-join-worker-config.yaml
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/NODE_IP_PLACEHOLDER/</span><span class="k">${</span><span class="nv">NODEIP</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-join-worker-config.yaml
kubeadm <span class="nb">join</span> <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-join-worker-config.yaml"</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">kubeadm-join-worker-config.yaml</code> íŒŒì¼ì€ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kubeadm.k8s.io/v1beta4</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">JoinConfiguration</span>
<span class="na">discovery</span><span class="pi">:</span>
  <span class="na">bootstrapToken</span><span class="pi">:</span>
    <span class="na">token</span><span class="pi">:</span> <span class="s2">"</span><span class="s">123456.1234567890123456"</span>
    <span class="na">apiServerEndpoint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.10.100:6443"</span>
    <span class="na">unsafeSkipCAVerification</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">nodeRegistration</span><span class="pi">:</span>
  <span class="na">criSocket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">unix:///run/containerd/containerd.sock"</span>
  <span class="na">kubeletExtraArgs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">node-ip</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">NODE_IP_PLACEHOLDER"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="ì‹¤ìŠµí™˜ê²½-ë°°í¬">ì‹¤ìŠµí™˜ê²½ ë°°í¬</h3>

<ul>
  <li>ë°°í¬</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vagrant up
</code></pre></div></div>

<ul>
  <li>[k8s-ctr] ì ‘ì† í›„ ê¸°ë³¸ ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s-ctr ì ‘ì†</span>
<span class="nv">$ </span>vagrant ssh k8s-ctr
<span class="nt">---</span>
<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
<span class="c"># =&gt; 127.0.0.1 localhost</span>
<span class="c">#    127.0.1.1 vagrant</span>
<span class="c">#    ...</span>
<span class="c">#    127.0.2.1 k8s-ctr k8s-ctr</span>
<span class="c">#    192.168.10.100 k8s-ctr</span>
<span class="c">#    192.168.10.101 k8s-w1</span>
<span class="c">#    192.168.10.102 k8s-w2</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-w1 <span class="nb">hostname</span>
<span class="c"># =&gt; k8s-w1</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-w2 <span class="nb">hostname</span>
<span class="c"># =&gt; k8s-w2</span>

<span class="c">#</span>
<span class="nv">$ </span>ifconfig | <span class="nb">grep</span> <span class="nt">-iEA1</span> <span class="s1">'eth[0-9]:'</span>
<span class="c"># =&gt; eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255</span>
<span class="c">#    --</span>
<span class="c">#    eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 192.168.10.100  netmask 255.255.255.0  broadcast 192.168.10.255</span>

<span class="c"># í´ëŸ¬ìŠ¤í„° ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt;                             "--service-cluster-ip-range=10.96.0.0/16",</span>
<span class="c">#                                "--cluster-cidr=10.244.0.0/16",</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubeadm-config
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubelet-config

<span class="c"># ë…¸ë“œ ì •ë³´ : ìƒíƒœ, INTERNAL-IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME      STATUS   ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    k8s-ctr   Ready    control-plane   14m   v1.33.2   &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt;   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w1    Ready    &lt;none&gt;          11m   v1.33.2   &lt;span style="color: green;"&gt;192.168.10.101&lt;/span&gt;   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w2    Ready    &lt;none&gt;          10m   v1.33.2   &lt;span style="color: green;"&gt;192.168.10.102&lt;/span&gt;   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>

<span class="c"># ë…¸ë“œë³„ kubeadm-flags.env ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> /var/lib/kubelet/kubeadm-flags.env
<span class="c"># =&gt; KUBELET_KUBEADM_ARGS="--container-runtime-endpoint=unix:///run/containerd/containerd.sock --node-ip=192.168.10.100 --pod-infra-container-image=registry.k8s.io/pause:3.10"</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">cat</span> /var/lib/kubelet/kubeadm-flags.env <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># íŒŒë“œ ì •ë³´ : ìƒíƒœ, íŒŒë“œ IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'</span>
<span class="c"># =&gt; k8s-ctr 10.244.0.0/24</span>
<span class="c">#    k8s-w1  10.244.1.0/24</span>
<span class="c">#    k8s-w2  10.244.2.0/24</span>
<span class="nv">$ </span>kubectl get ciliumnode <span class="nt">-o</span> json | <span class="nb">grep </span>podCIDRs <span class="nt">-A2</span>
<span class="c"># =&gt;                     "podCIDRs": [ "172.20.0.0/24" ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [ "172.20.1.0/24" ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [ "172.20.2.0/24" ],</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-2rgdx&lt;/span&gt;                       1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-envoy-q97fq&lt;/span&gt;                 1/1     Running   0          12m   192.168.10.102   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-envoy-xzxd6&lt;/span&gt;                 1/1     Running   0          13m   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-envoy-zzzw5&lt;/span&gt;                 1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-fdqhq&lt;/span&gt;                       1/1     Running   0          12m   192.168.10.102   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-kv67c&lt;/span&gt;                       1/1     Running   0          13m   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-operator-5bc66f5b9b-xps5x&lt;/span&gt;   1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-4h2lt           1/1     &lt;span style="color: green;"&gt;Running&lt;/span&gt;   0          15m   172.20.0.233     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-7m82r           1/1     &lt;span style="color: green;"&gt;Running&lt;/span&gt;   0          15m   172.20.0.167     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   etcd-k8s-ctr                       1/1     Running   0          16m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-apiserver-k8s-ctr             1/1     Running   0          16m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-controller-manager-k8s-ctr    1/1     Running   0          16m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-scheduler-k8s-ctr             1/1     Running   0          16m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ cilium CNIê°€ ì„¤ì¹˜ë˜ì–´ìˆê³ , CNIê°€ ì„¤ì¹˜ë˜ì—ˆê¸° ë•Œë¬¸ì— corednsê°€ Running ìƒíƒœë¡œ ì‹œì‘ë¨ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë˜í•œ kube-proxyê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ê³ , Ciliumì´ kube-proxyë¥¼ ëŒ€ì²´í•˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># iptables í™•ì¸</span>
<span class="nv">$ </span>iptables-save
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
</code></pre></div></div>

<ul>
  <li>[k8s-ctr] cilium ì„¤ì¹˜ ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>which cilium
<span class="c"># =&gt; /usr/local/bin/cilium</span>
<span class="nv">$ </span>cilium status
<span class="c"># =&gt;     /Â¯Â¯\</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Cilium:             OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Operator:           OK</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Envoy DaemonSet:    OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Hubble Relay:       disabled</span>
<span class="c">#        \__/       ClusterMesh:        disabled</span>
<span class="c">#    </span>
<span class="c">#    DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    Deployment             cilium-operator          Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Containers:            cilium                   Running: 3</span>
<span class="c">#                           cilium-envoy             Running: 3</span>
<span class="c">#                           cilium-operator          Running: 1</span>
<span class="c">#                           clustermesh-apiserver</span>
<span class="c">#                           hubble-relay</span>
<span class="c">#    Cluster Pods:          2/2 managed by Cilium</span>
<span class="c">#    Helm chart version:    1.17.6</span>
<span class="c">#    Image versions         cilium             quay.io/cilium/cilium:v1.17.6@sha256:544de3d4fed7acba72758413812780a4972d47c39035f2a06d6145d8644a3353: 3</span>
<span class="c">#                           cilium-envoy       quay.io/cilium/cilium-envoy:v1.33.4-1752151664-7c2edb0b44cf95f326d628b837fcdd845102ba68@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3</span>
<span class="c">#                           cilium-operator    quay.io/cilium/operator-generic:v1.17.6@sha256:91ac3bf7be7bed30e90218f219d4f3062a63377689ee7246062fa0cc3839d096: 1</span>
<span class="nv">$ </span>cilium config view
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg config
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg status <span class="nt">--verbose</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg metrics list

<span class="c">#</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>

<span class="c"># monitor</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">-v</span>

<span class="c">## Filter for only the events related to endpoint</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">--related-to</span><span class="o">=</span>&lt;<span class="nb">id</span><span class="o">&gt;</span>

<span class="c">## Show notifications only for dropped packet events</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">--type</span> drop

<span class="c">## Donâ€™t dissect packet payload, display payload in hex information</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">-v</span> <span class="nt">--hex</span>

<span class="c">## Layer7</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
</code></pre></div></div>

<h3 id="cilium-agent-ë‹¨ì¶•í‚¤-ì§€ì •">Cilium Agent ë‹¨ì¶•í‚¤ ì§€ì •</h3>

<ul>
  <li><a href="https://sweetlittlebird.github.io/posts/2025-07-20-Cilium-Week1/#%EB%A7%88%EC%B9%98%EB%A9%B0">[Cilium] ì‹¤ìŠµ í™˜ê²½ êµ¬ì„± ë° Cilium ì„¤ì¹˜</a>ì˜ Cilium CMD Cheatsheetë¥¼ ì°¸ê³ í•˜ì—¬ í™˜ê²½ë³€ìˆ˜ì™€ aliasë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium íŒŒë“œ ì´ë¦„</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-ctr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w2  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CILIUMPOD0</span> <span class="nv">$CILIUMPOD1</span> <span class="nv">$CILIUMPOD2</span>
<span class="c"># =&gt; cilium-5kc8d cilium-w9st8 cilium-l8lm7</span>

<span class="c"># ë‹¨ì¶•í‚¤(alias) ì§€ì •</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>

<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
</code></pre></div></div>

<h2 id="network-observability-with-hubble">Network Observability with Hubble</h2>

<h3 id="hubble-ì†Œê°œ">Hubble ì†Œê°œ</h3>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_2.png" alt="img.png" class="image-center w-80" /></p>

<ul>
  <li><strong>Hubble</strong>ì€ Ciliumê³¼ eBPFë¥¼ ê¸°ë°˜ìœ¼ë¡œ êµ¬ì¶•ëœ <strong>ì™„ì „íˆ ë¶„ì‚°ëœ ë„¤íŠ¸ì›Œí‚¹ ë° ë³´ì•ˆ ê´€ì¸¡ ê°€ëŠ¥ì„± í”Œë«í¼</strong>ì…ë‹ˆë‹¤.
ì„œë¹„ìŠ¤ì˜ í†µì‹  ë° ë™ì‘ë¿ë§Œ ì•„ë‹ˆë¼ ë„¤íŠ¸ì›Œí‚¹ ì¸í”„ë¼ì— ëŒ€í•œ ê¹Šì€ ê°€ì‹œì„±ì„ íˆ¬ëª…í•˜ê²Œ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li><strong>Hubble</strong>ì€ ì˜¤ë²„í—¤ë“œë¥¼ ìµœì†Œí™” í•˜ëŠ” ë™ì  ì ‘ê·¼ ë°©ì‹ì„ ì œê³µí•˜ë©°, ë‹¤ì¤‘ í´ëŸ¬ìŠ¤í„°(ClusterMesh) í™˜ê²½ì—ì„œë„ ë…¸ë“œ ìˆ˜ì¤€, ì»¨íŠ¸ë¡¤ëŸ¬ ìˆ˜ì¤€ ë˜ëŠ”
í´ëŸ¬ìŠ¤í„° ê°„ ê°€ì‹œì„±ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>Hubble API</strong>ëŠ” Cilium ì—ì´ì „íŠ¸ê°€ ì‹¤í–‰ë˜ëŠ” ê°œë³„ ë…¸ë“œì—ì„œ ì‘ë™í•©ë‹ˆë‹¤. Hubble CLIëŠ” ë¡œì»¬ ìœ ë‹‰ìŠ¤ ë„ë©”ì¸ ì†Œì¼“ì„ í†µí•´ ì œê³µë˜ëŠ” Hubble APIë¥¼ ì¿¼ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li><strong>Hubble Relay</strong>ë¥¼ ë°°í¬í•˜ë©´ í´ëŸ¬ìŠ¤í„° ë©”ì‹œ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ì „ì²´ í´ëŸ¬ìŠ¤í„° ë˜ëŠ” ì—¬ëŸ¬ í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ê°€ì‹œì„±ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ ëª¨ë“œì—ì„œëŠ”
Hubble CLIë¥¼ Hubble Relayì— ì—°ê²°í•˜ì—¬ ëª¨ë“  ë…¸ë“œì—ì„œ ìˆ˜ì§‘ëœ ì´ë²¤íŠ¸ë¥¼ ì¿¼ë¦¬í•˜ê±°ë‚˜, Hubble UIë¥¼ í†µí•´ Hubble ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì„œë¹„ìŠ¤ ì˜ì¡´ì„± ë° í†µì‹  ê·¸ë˜í”„ë¥¼ ì‹œê°í™” í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë„¤íŠ¸ì›Œí¬ ì •ì±… ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ì„ ì œê³µí•˜ì—¬ ë„¤íŠ¸ì›Œí¬ í†µì‹  ì‹¤íŒ¨ ë“±ì„ ëª¨ë‹ˆí„°ë§ í•˜ê³  ì›ì¸ì„ íŒŒì•…í•˜ëŠ”ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.</li>
  <li>ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ì„ í†µí•´ ì„œë¹„ìŠ¤ ê°„ì˜ ì§€ì—° ì‹œê°„, ì˜¤ë¥˜ìœ¨ ë“±ì„ ì¸¡ì •í•˜ê³  ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë³´ì•ˆ ì •ì±… ëª¨ë‹ˆí„°ë§ì„ í†µí•´ ë„¤íŠ¸ì›Œí¬ ì •ì±… ìœ„ë°˜, ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íŠ¸ë˜í”½ ë“±ì„ ê°ì§€í•˜ê³  ëŒ€ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="hubble-observability-ì„¤ì¹˜">Hubble Observability ì„¤ì¹˜</h3>

<ul>
  <li>ê´€ë ¨ ë¬¸ì„œ : <a href="https://docs.cilium.io/en/stable/observability/hubble/setup/">docs</a></li>
  <li>ì„¤ì¹˜ ì „ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>cilium status
<span class="c"># =&gt; ...</span>
<span class="c">#     \__/Â¯Â¯\__/    Hubble Relay:       disabled</span>
<span class="c">#    ...</span>
<span class="c">#    Containers:            cilium                   Running: 3</span>
<span class="c">#                           cilium-envoy             Running: 3</span>
<span class="c">#                           cilium-operator          Running: 1</span>
<span class="c">#                           clustermesh-apiserver</span>
<span class="c">#                           hubble-relay</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> hubble
<span class="c"># =&gt; enable-hubble                                     false</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í˜„ì¬ Hubbleì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq
<span class="c"># =&gt; ...</span>
<span class="c">#        "enable-hubble": "false",</span>
<span class="c">#</span>
<span class="nv">$ </span>kubectl get secret <span class="nt">-n</span> kube-system | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'cilium-ca|hubble'</span>
<span class="c"># =&gt; (ê³µë°±) </span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'cilium|hubble'</span> | <span class="nb">tee </span>before.txt
<span class="c"># =&gt; LISTEN 0      4096        127.0.0.1:37303      0.0.0.0:*    users:(("cilium-agent",pid=2853,fd=42))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:*    users:(("cilium-operator",pid=2153,fd=9))</span>
<span class="c">#    LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=25))</span>
<span class="c">#    LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=24))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:*    users:(("cilium-agent",pid=2853,fd=6))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:*    users:(("cilium-operator",pid=2153,fd=6))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=27))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=26))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:*    users:(("cilium-agent",pid=2853,fd=51))</span>
<span class="c">#    LISTEN 0      4096                *:9963             *:*    users:(("cilium-operator",pid=2153,fd=7))</span>
</code></pre></div></div>

<ul>
  <li>Hubble ì„¤ì¹˜</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì„¤ì¹˜ë°©ì•ˆ 1 : hubble í™œì„±í™”, ë©”íŠ¸ë¦­ ì„¤ì • ë“±ë“±</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>31234 <span class="se">\</span>
  <span class="nt">--set</span> hubble.export.static.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.export.static.filePath<span class="o">=</span>/var/run/cilium/hubble/events.log <span class="se">\</span>
  <span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    NAME: cilium</span>
<span class="c">#    LAST DEPLOYED: Thu Jul 24 23:16:48 2025</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 2</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    You have successfully installed Cilium with Hubble Relay and Hubble UI.</span>
<span class="c">#    </span>
<span class="c">#    Your release version is 1.17.6.  </span>

<span class="c"># ì„¤ì¹˜ë°©ì•ˆ 2 : hubble í™œì„±í™”</span>
<span class="nv">$ </span>cilium hubble <span class="nb">enable</span>
<span class="nv">$ </span>cilium hubble <span class="nb">enable</span> <span class="nt">--ui</span>

<span class="c"># cilium statusë¥¼ í†µí•œ hubble ì„¤ì¹˜ ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>cilium status
<span class="c"># =&gt; ...</span>
<span class="c">#     \__/Â¯Â¯\__/    Hubble Relay:       OK</span>
<span class="c">#    ...</span>
<span class="c">#    Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Deployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Containers:            hubble-relay             Running: 1</span>
<span class="c">#                           hubble-ui                Running: 1</span>

<span class="c"># hubble ê´€ë ¨ ì„¤ì • ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> hubble
<span class="c"># =&gt; enable-hubble                                     true</span>
<span class="c">#    enable-hubble-open-metrics                        true</span>
<span class="c">#    hubble-disable-tls                                false</span>
<span class="c">#    hubble-export-allowlist</span>
<span class="c">#    hubble-export-denylist</span>
<span class="c">#    hubble-export-fieldmask</span>
<span class="c">#    hubble-export-file-max-backups                    5</span>
<span class="c">#    hubble-export-file-max-size-mb                    10</span>
<span class="c">#    hubble-export-file-path                           /var/run/cilium/hubble/events.log</span>
<span class="c">#    hubble-listen-address                             :4244</span>
<span class="c">#    hubble-metrics                                    dns drop tcp flow port-distribution icmp httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction</span>
<span class="c">#    hubble-metrics-server                             :9965</span>
<span class="c">#    hubble-metrics-server-enable-tls                  false</span>
<span class="c">#    hubble-socket-path                                /var/run/cilium/hubble.sock</span>
<span class="c">#    hubble-tls-cert-file                              /var/lib/cilium/tls/hubble/server.crt</span>
<span class="c">#    hubble-tls-client-ca-files                        /var/lib/cilium/tls/hubble/client-ca.crt</span>
<span class="c">#    hubble-tls-key-file                               /var/lib/cilium/tls/hubble/server.key</span>

<span class="c"># config mapì—ì„œ hubble ê´€ë ¨ ì„¤ì • ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | <span class="nb">grep</span> <span class="nt">-i</span> hubble
<span class="c"># =&gt;         "enable-hubble": "true",</span>
<span class="c">#            "enable-hubble-open-metrics": "true",</span>
<span class="c">#            "hubble-disable-tls": "false",</span>
<span class="c">#            "hubble-export-allowlist": "",</span>
<span class="c">#    ...</span>

<span class="c"># hubble ê´€ë ¨ secret ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get secret <span class="nt">-n</span> kube-system | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'cilium-ca|hubble'</span>
<span class="c"># =&gt; cilium-ca                      Opaque                          2      4m57s</span>
<span class="c">#    hubble-relay-client-certs      kubernetes.io/tls               3      4m57s</span>
<span class="c">#    hubble-server-certs            kubernetes.io/tls               3      4m57s</span>

<span class="c"># TCP í¬íŠ¸ 4244ë¥¼ ëª¨ë“  ciliumì„ ì‹¤í–‰í•˜ëŠ” ë…¸ë“œì—ì„œ ì—´ì–´ì•¼ í•  í•„ìš”ê°€ ìˆìŒ</span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'cilium|hubble'</span> | <span class="nb">tee </span>after.txt
<span class="c"># =&gt; LISTEN 0      4096        127.0.0.1:37303      0.0.0.0:*    users:(("cilium-agent",pid=4891,fd=52))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:*    users:(("cilium-operator",pid=2153,fd=9))</span>
<span class="c">#    LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=25))</span>
<span class="c">#    LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=24))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:*    users:(("cilium-agent",pid=4891,fd=6))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:*    users:(("cilium-operator",pid=2153,fd=6))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=27))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=26))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:*    users:(("cilium-agent",pid=4891,fd=62))</span>
<span class="c">#    LISTEN 0      4096                *:4244             *:*    users:(("cilium-agent",pid=4891,fd=55))</span>
<span class="c">#    LISTEN 0      4096                *:9965             *:*    users:(("cilium-agent",pid=4891,fd=34))</span>
<span class="c">#    LISTEN 0      4096                *:9962             *:*    users:(("cilium-agent",pid=4891,fd=7))</span>
<span class="c">#    LISTEN 0      4096                *:9963             *:*    users:(("cilium-operator",pid=2153,fd=7))</span>

<span class="c"># Hubble ì‹¤í–‰ ì „ê³¼ í›„ì˜ ë¦¬ìŠ¤ë‹ í¬íŠ¸ ë³€ê²½í™•ì¸</span>
<span class="nv">$ </span>vi <span class="nt">-d</span> before.txt after.txt
<span class="c"># =&gt;   LISTEN 0      4096        127.0.0.1:37303      0.0.0.0:|  LISTEN 0      4096        127.0.0.1:37303      0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:|  LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:|  LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:</span>
<span class="c">#      -------------------------------------------------------|  &lt;span style="background-color: green; color: #fff;"&gt;LISTEN 0      4096                *:4244             *:&lt;/span&gt;</span>
<span class="c">#      -------------------------------------------------------|  &lt;span style="background-color: green; color: #fff;"&gt;LISTEN 0      4096                *:9965             *:&lt;/span&gt;</span>
<span class="c">#      -------------------------------------------------------|  &lt;span style="background-color: green; color: #fff;"&gt;LISTEN 0      4096                *:9962             *:&lt;/span&gt;</span>
<span class="c">#      LISTEN 0      4096                *:9963             *:|  LISTEN 0      4096                *:9963             *:</span>

<span class="c"># ê° ë…¸ë“œì˜ 4244 í¬íŠ¸ ì˜¤í”ˆ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>ss <span class="nt">-tnlp</span> |grep 4244 <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    LISTEN 0      4096               *:4244             *:*    users:(("cilium-agent",pid=3528,fd=50))</span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    LISTEN 0      4096               *:4244             *:*    users:(("cilium-agent",pid=3268,fd=46))</span>

<span class="c"># Hubble Relay Pod í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>hubble-relay
<span class="c"># =&gt; NAME                           READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    hubble-relay-5dcd46f5c-n4zfx   1/1     Running   0          12m</span>

<span class="nv">$ </span>kc describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>hubble-relay
<span class="c"># =&gt; Name:             hubble-relay-5dcd46f5c-n4zfx</span>
<span class="c">#    Namespace:        kube-system</span>
<span class="c">#    Service Account:  hubble-relay</span>
<span class="c">#    Labels:           app.kubernetes.io/name=hubble-relay</span>
<span class="c">#                      app.kubernetes.io/part-of=cilium</span>
<span class="c">#                      k8s-app=hubble-relay</span>
<span class="c">#    ...</span>
<span class="c">#        Image:         quay.io/cilium/hubble-relay:v1.17.6@sha256:7d17ec10b3d37341c18ca56165b2f29a715cb8ee81311fd07088d8bf68c01e60</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kc get svc,ep <span class="nt">-n</span> kube-system hubble-relay
<span class="c"># =&gt; NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/hubble-relay   ClusterIP   10.96.207.219   &lt;none&gt;        80/TCP    14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                     ENDPOINTS           AGE</span>
<span class="c">#    endpoints/hubble-relay   172.20.2.214:4245   14m</span>

<span class="c"># hubble-relay ëŠ” hubble-peer ì˜ ì„œë¹„ìŠ¤(ClusterIP :443)ì„ í†µí•´ ëª¨ë“  ë…¸ë“œì˜ :4244ì— ìš”ì²­ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME                                                   DATA   AGE</span>
<span class="c">#    cilium-config                                          158    23h</span>
<span class="c">#    cilium-envoy-config                                    1      23h</span>
<span class="c">#    ...</span>
<span class="c">#    hubble-relay-config                                    1      17m</span>
<span class="c">#    hubble-ui-nginx                                        1      17m</span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system hubble-relay-config
<span class="c"># =&gt; ...</span>
<span class="c">#    cluster-name: default</span>
<span class="c">#    peer-service: "hubble-peer.kube-system.svc.cluster.local.:443"</span>
<span class="c">#    listen-address: :4245</span>
<span class="c">#    ...</span>

<span class="c"># Hubble Peer Pod í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> kube-system hubble-peer
<span class="c"># =&gt; NAME                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/hubble-peer   ClusterIP   10.96.12.202   &lt;none&gt;        443/TCP   21m</span>
<span class="c">#    </span>
<span class="c">#    NAME                    ENDPOINTS                                                     AGE</span>
<span class="c">#    endpoints/hubble-peer   192.168.10.100:4244,192.168.10.101:4244,192.168.10.102:4244   21m</span>

<span class="c">#</span>
<span class="nv">$ </span>kc describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>hubble-ui
<span class="c"># =&gt; ...</span>
<span class="c">#      frontend:</span>
<span class="c">#        Port:           8081/TCP</span>
<span class="c">#        ...</span>
<span class="c">#      backend:</span>
<span class="c">#        Port:           8090/TCP</span>
<span class="c">#        ...</span>

<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> kube-system hubble-ui-nginx
<span class="c"># =&gt; ...</span>
<span class="c">#    nginx.conf:</span>
<span class="c">#    ----</span>
<span class="c">#    server {</span>
<span class="c">#        listen       8081;</span>
<span class="c">#        listen       [::]:8081;</span>
<span class="c">#        server_name  localhost;</span>
<span class="c">#        root /app;</span>
<span class="c">#        index index.html;</span>
<span class="c">#        client_max_body_size 1G;</span>
<span class="c">#    </span>
<span class="c">#        location / {</span>
<span class="c">#            proxy_set_header Host $host;</span>
<span class="c">#            proxy_set_header X-Real-IP $remote_addr;</span>
<span class="c">#    </span>
<span class="c">#            location /api {</span>
<span class="c">#                proxy_http_version 1.1;</span>
<span class="c">#                proxy_pass_request_headers on;</span>
<span class="c">#                proxy_pass http://127.0.0.1:8090;</span>
<span class="c">#            }</span>
<span class="c">#            location / {</span>
<span class="c">#                # double `/index.html` is required here</span>
<span class="c">#                try_files $uri $uri/ /index.html /index.html;</span>
<span class="c">#            }</span>
<span class="c">#    </span>
<span class="c">#            # Liveness probe</span>
<span class="c">#            location /healthz {</span>
<span class="c">#                access_log off;</span>
<span class="c">#                add_header Content-Type text/plain;</span>
<span class="c">#                return 200 'ok';</span>
<span class="c">#            }</span>
<span class="c">#        }</span>
<span class="c">#    }</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> kube-system hubble-ui
<span class="c"># =&gt; NAME                TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/hubble-ui   NodePort   10.96.183.249   &lt;none&gt;        80:31234/TCP   26m</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS           AGE</span>
<span class="c">#    endpoints/hubble-ui   172.20.1.189:8081   26m</span>

<span class="c"># hubble ui ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"http://</span><span class="nv">$NODEIP</span><span class="s2">:31234"</span>
<span class="c"># =&gt; http://192.168.10.100:31234</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Hubble ui ì ‘ì† í…ŒìŠ¤íŠ¸ -&gt; ì ‘ì† í›„ kube-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì„ íƒ
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_3.png" alt="img.png" class="image-center" /></p>
  </li>
  <li>
    <p>Hubble Client ì„¤ì¹˜ - <a href="https://docs.cilium.io/en/stable/observability/hubble/setup/#install-the-hubble-client">docs</a></p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ HUBBLE_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="si">)</span>
<span class="nv">$ HUBBLE_ARCH</span><span class="o">=</span>amd64
<span class="nv">$ </span><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">HUBBLE_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi</span>
<span class="nv">$ </span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/hubble/releases/download/<span class="nv">$HUBBLE_VERSION</span>/hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
<span class="nv">$ </span><span class="nb">sudo tar </span>xzvfC hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="c"># =&gt; hubble</span>
<span class="nv">$ </span>which hubble
<span class="c"># =&gt; /usr/local/bin/hubble</span>
<span class="nv">$ </span>hubble status
<span class="c"># =&gt; failed getting status: rpc error: code = Unavailable desc = connection error: desc = "transport: Error while dialing: dial tcp 127.0.0.1:4245: connect: connection refused"</span>
</code></pre></div></div>

<ul>
  <li>Hubble clientë¥¼ ì„¤ì¹˜í–ˆì§€ë§Œ ê¸°ë³¸ì ìœ¼ë¡œ localhostë¥¼ í†µí•´ ì—°ê²°ì„ ì‹œë„í•˜ê¸° ë•Œë¬¸ì— ì—°ê²°ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
í¬íŠ¸í¬ì›Œë”©ì„ í†µí•´ hubble relayë¥¼ í†µí•´ ì—°ê²°í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt;   Hubble Relay is available at 127.0.0.1:4245</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 4245 í¬íŠ¸ê°€ localhostë¡œ í¬ì›Œë”© ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep </span>4245
<span class="c"># =&gt; LISTEN 0      4096        127.0.0.1:4245       0.0.0.0:*    users:(("cilium",pid=3402,fd=7))</span>

<span class="c"># Now you can validate that you can access the Hubble API via the installed CLI</span>
<span class="nv">$ </span>hubble status
<span class="c"># =&gt; Healthcheck (via localhost:4245): Ok</span>
<span class="c">#    Current/Max Flows: 12,285/12,285 (100.00%)</span>
<span class="c">#    Flows/s: 31.55</span>
<span class="c">#    Connected Nodes: 3/3</span>

<span class="c"># hubble (api) server ê¸°ë³¸ ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ </span>hubble config view 
<span class="c"># =&gt; ...</span>
<span class="c">#    port-forward-port: "4245"</span>
<span class="c">#    server: localhost:4245</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h3 id="star-wars-demoë¥¼-í†µí•œ-hubbleui-ì²´í—˜">Star Wars Demoë¥¼ í†µí•œ Hubble/UI ì²´í—˜</h3>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_4.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">ëª©í‘œ ë°°í¬ìƒíƒœ</em></p>

<ul>
  <li>ìŠ¤íƒ€ì›Œì¦ˆì—ì„œ ì˜ê°ì„ ë°›ì€ ì˜ˆì œì´ë©°, deathstar, xwing, tiefighterì˜ ì„¸ê°€ì§€ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
  <li>deathstarëŠ” 80í¬íŠ¸ì—ì„œ http ì›¹ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ë©°, ë‘ ê°œì˜ pod ë³µì œë³¸ì— ê±¸ì³ ë¡œë“œ ë°¸ëŸ°ì‹±ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
  <li>deathstar ì„œë¹„ìŠ¤ëŠ” empireì˜ ìš°ì£¼ì„ ì— ì°©ë¥™ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ì—¬ ì°©ë¥™ í¬íŠ¸ ìš”ì²­ì„ í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.</li>
  <li>tiefighterëŠ” ì¼ë°˜ì ì¸ ì œêµ­ ìš°ì£¼ì„ ì˜ ì°©ë¥™ ìš”ì²­ í´ë¼ì´ì–¸íŠ¸ ì„œë¹„ìŠ¤ë¥¼ ë‚˜íƒ€ë‚´ë©° xwingì€ ì—°í•© ìš°ì£¼ì„ ì˜ ì°©ë¥™ ìš”ì²­ í´ë¼ì´ì–¸íŠ¸ ì„œë¹„ìŠ¤ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li>
  <li>deathstar ì°©ë¥™ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ ì œì–´ë¥¼ ìœ„í•œ ë‹¤ì–‘í•œ ë³´ì•ˆ ì •ì±…ì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•˜ì—¬ êµ¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="ë°ëª¨-ì• í”Œë¦¬ì¼€ì´ì…˜-ë°°í¬">ë°ëª¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/http-sw-app.yaml
<span class="c"># =&gt; service/deathstar created</span>
<span class="c">#    deployment.apps/deathstar created</span>
<span class="c">#    pod/tiefighter created</span>
<span class="c">#    pod/xwing created</span>

<span class="c"># íŒŒë“œ ë¼ë²¨ labels í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">--show-labels</span>
<span class="c"># =&gt; NAME                        READY   STATUS    RESTARTS   AGE   LABELS</span>
<span class="c">#    deathstar-8c4c77fb7-5zqmp   1/1     Running   0          12h   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=8c4c77fb7</span>
<span class="c">#    deathstar-8c4c77fb7-h2rsh   1/1     Running   0          12h   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=8c4c77fb7</span>
<span class="c">#    tiefighter                  1/1     Running   0          12h   app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire</span>
<span class="c">#    xwing                       1/1     Running   0          12h   app.kubernetes.io/name=xwing,class=xwing,org=alliance</span>

<span class="nv">$ </span>kubectl get deploy,svc,ep deathstar
<span class="c"># =&gt; NAME                        READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/deathstar   2/2     2            2           12h</span>
<span class="c">#    </span>
<span class="c">#    NAME                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/deathstar   ClusterIP   10.96.153.126   &lt;none&gt;        80/TCP    12h</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS                        AGE</span>
<span class="c">#    endpoints/deathstar   172.20.1.67:80,172.20.2.251:80   12h</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get ciliumendpoints.cilium.io <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE     NAME                           SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    default       deathstar-8c4c77fb7-5zqmp      46219               ready            172.20.2.251</span>
<span class="c">#    default       deathstar-8c4c77fb7-h2rsh      46219               ready            172.20.1.67</span>
<span class="c">#    default       tiefighter                     50993               ready            172.20.2.254</span>
<span class="c">#    default       xwing                          14847               ready            172.20.2.111</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-7m82r       30923               ready            172.20.0.134</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-dnc5n       30923               ready            172.20.1.13</span>
<span class="c">#    kube-system   hubble-relay-5dcd46f5c-n4zfx   5844                ready            172.20.2.144</span>
<span class="c">#    kube-system   hubble-ui-76d4965bb6-7mcft     14841               ready            172.20.1.30</span>
<span class="nv">$ </span>kubectl get ciliumidentities.cilium.io
<span class="c"># =&gt; NAME    NAMESPACE     AGE</span>
<span class="c">#    10901   default       12h</span>
<span class="c">#    14841   kube-system   37h</span>
<span class="c">#    14847   default       12h</span>
<span class="c">#    30923   kube-system   2d13h</span>
<span class="c">#    46219   default       12h</span>
<span class="c">#    50993   default       12h</span>
<span class="c">#    5844    kube-system   37h</span>

<span class="c"># in a multi-node installation, only the ones running on the same node will be listed</span>
<span class="c"># cilium ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡ í™•ì¸. ëª…ë ¹ì„ ì‹¤í–‰í•œ ë…¸ë“œì˜ ì—”ë“œí¬ì¸íŠ¸ë§Œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    1332       Disabled           Disabled          1          k8s:node-role.kubernetes.io/control-plane                                                          ready</span>
<span class="c">#                                                               k8s:node.kubernetes.io/exclude-from-external-load-balancers</span>
<span class="c">#                                                               reserved:host</span>
<span class="c">#    1814       Disabled           Disabled          30923      k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.20.0.134   ready</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=coredns</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#                                                               k8s:k8s-app=kube-dns</span>
<span class="nv">$ </span>c0 endpoint list
<span class="c"># =&gt; ...</span>
<span class="c">#    1814 Disabled Disabled 30923 k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system 172.20.0.134   ready</span>
<span class="nv">$ </span>c1 endpoint list
<span class="c"># =&gt; ...</span>
<span class="c">#    507  Disabled Disabled 46219 k8s:app.kubernetes.io/name=deathstar                                       172.20.1.67   ready</span>
<span class="c">#    ...</span>
<span class="c">#    966  Disabled Disabled 30923 k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system 172.20.1.13   ready</span>
<span class="c">#    ...</span>
<span class="c">#    1864 Disabled Disabled 14841 k8s:app.kubernetes.io/name=hubble-ui                                       172.20.1.30   ready</span>
<span class="nv">$ </span>c2 endpoint list
<span class="c"># =&gt; ENDPOINT POLICY (ingress) POLICY (egress) IDENTITY LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#             ENFORCEMENT      ENFORCEMENT</span>
<span class="c">#    309      &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;         &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;        14847    k8s:app.kubernetes.io/name=xwing                                                    172.20.2.111   ready</span>
<span class="c">#    721      &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;         &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;        50993    k8s:app.kubernetes.io/name=tiefighter                                               172.20.2.254   ready</span>
<span class="c">#    1282     &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;         &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;        1        reserved:host                                                                                      ready</span>
<span class="c">#    1391     &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;         &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;        46219    k8s:app.kubernetes.io/name=deathstar                                                172.20.2.251   ready</span>
<span class="c">#                                                       &lt;span style="color: green;"&gt;k8s:class=deathstar&lt;/span&gt;</span>
<span class="c">#                                                       k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default</span>
<span class="c">#                                                       k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                       k8s:io.cilium.k8s.policy.serviceaccount=default</span>
<span class="c">#                                                       k8s:io.kubernetes.pod.namespace=default</span>
<span class="c">#                                                       &lt;span style="color: green;"&gt;k8s:org=empire&lt;/span&gt;</span>
<span class="c">#    3027     &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;         &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;        5844     k8s:app.kubernetes.io/name=hubble-relay                                             172.20.2.144   ready</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í˜„ì¬ ingress/egress ì— ì •ì±…(Policy) ì—†ìŒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ labelì„ í†µí•´ ë‹¤ì–‘í•œ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h4 id="í˜„ì¬-ì ‘ê·¼ìƒíƒœ-í™•ì¸">í˜„ì¬ ì ‘ê·¼ìƒíƒœ í™•ì¸</h4>

<ul>
  <li>deathstar ì„œë¹„ìŠ¤ì˜ ê´€ì ì—ì„œëŠ” org=empire ë¼ë²¨ì´ ìˆëŠ” ìš°ì£¼ì„ ë§Œ ì°©ë¥™ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì•„ì§ê¹Œì§€ëŠ” ingress/egress ì •ì±…ì´ ì—†ê¸° ë•Œë¬¸ì— ì œêµ­ ìš°ì£¼ì„  ë¿ë§Œ ì•„ë‹ˆë¼ ì—°í•©ì˜ ìš°ì£¼ì„  ì°©ë¥™ ìš”ì²­ë„ í—ˆìš©ë©ë‹ˆë‹¤.</li>
  <li>ì•„ë˜ì˜ ëª…ë ¹ì„ í†µí•´ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì•„ë˜ ì¶œë ¥ì—ì„œ xwing ì™€ tiefighter ì˜ IDENTITY ê°’ì„ í™•ì¸í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>c1 endpoint list | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'xwing|tiefighter|deathstar'</span>
<span class="c"># =&gt; 507        Disabled           Disabled          &lt;span style="color: green;"&gt;46219&lt;/span&gt;      k8s:app.kubernetes.io/name=deathstar                                                172.20.1.67   ready</span>
<span class="nv">$ </span>c2 endpoint list | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'xwing|tiefighter|deathstar'</span>
<span class="c"># =&gt; 309        Disabled           Disabled          &lt;span style="color: green;"&gt;14847&lt;/span&gt;      k8s:app.kubernetes.io/name=xwing                                                    172.20.2.111   ready</span>
<span class="c">#    721        Disabled           Disabled          &lt;span style="color: green;"&gt;50993&lt;/span&gt;      k8s:app.kubernetes.io/name=tiefighter                                               172.20.2.254   ready</span>
<span class="c">#    1391       Disabled           Disabled          &lt;span style="color: green;"&gt;46219&lt;/span&gt;      k8s:app.kubernetes.io/name=deathstar                                                172.20.2.251   ready</span>
<span class="nv">$ XWINGID</span><span class="o">=</span>14847
<span class="nv">$ TIEFIGHTERID</span><span class="o">=</span>50993
<span class="nv">$ DEATHSTARID</span><span class="o">=</span>46219

<span class="c"># ëª¨ë‹ˆí„°ë§ ì¤€ë¹„ : í„°ë¯¸ë„ 3ê°œ, ë‹¨ì¶•í‚¤ ì„¤ì •</span>
<span class="c">## ê°ê° monitor í™•ì¸</span>
<span class="nv">$ </span>c0 monitor <span class="nt">-v</span> <span class="nt">-v</span>
<span class="nv">$ </span>c1 monitor <span class="nt">-v</span> <span class="nt">-v</span>
<span class="nv">$ </span>c2 monitor <span class="nt">-v</span> <span class="nt">-v</span>

<span class="c"># ëª¨ë‹ˆí„°ë§ ì¤€ë¹„ : í„°ë¯¸ë„ 1ê°œ</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span>

<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--from-identity</span> <span class="nv">$XWINGID</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> udp <span class="nt">--from-identity</span> <span class="nv">$XWINGID</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$XWINGID</span>

<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$DEATHSTARID</span>

<span class="c"># í˜¸ì¶œ ì‹œë„ 1</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing <span class="p">;</span> <span class="nb">sleep </span>5 <span class="p">;</span> <span class="k">done</span>

<span class="c"># í˜¸ì¶œ ì‹œë„ 2</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing <span class="p">;</span> <span class="nb">sleep </span>5 <span class="p">;</span> <span class="k">done</span>

<span class="c">## ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$TIEFIGHTERID</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$DEATHSTARID</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_5.png" alt="img.png" class="image-center" />
<em class="image-caption">Hubble UIì—ì„œ ëª¨ë‹ˆí„°ë§</em></p>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_6.png" alt="img.png" class="image-center" />
<em class="image-caption">hubble observeì—ì„œ ëª¨ë‹ˆí„°ë§</em></p>

<ul>
  <li>ì œêµ­êµ° ìš°ì£¼ì„  tiefighter ë¿ë§Œì•„ë‹ˆë¼ ì—°í•©êµ° ìš°ì£¼ì„  xwingì˜ ì°©ë¥™ ìš”ì²­ë„ í—ˆìš©ë˜ê³  ìˆëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="l3l4-ì •ì±…-ì ìš©">L3/L4 ì •ì±… ì ìš©</h4>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-an-l3-l4-policy">ê´€ë ¨ë¬¸ì„œ</a></li>
  <li>L3/L4 ì •ì±…ì„ ì ìš©í•˜ì—¬ ì œêµ­ ìš°ì£¼ì„ ë§Œ ì°©ë¥™ ìš”ì²­ì„ í—ˆìš©í•˜ë„ë¡ í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_7.png" alt="img.png" class="image-center" />
<em class="image-caption">L3/L4 ì •ì±… ì ìš© í›„ ëª©í‘œ ìƒíƒœ</em></p>

<ul>
  <li>Ciliumì˜ ë³´ì•ˆì •ì±…ì€ <strong>Endpointì˜ IPì£¼ì†ŒëŠ” ì¤‘ìš”í•˜ì§€ ì•Šê³ </strong>, Podì˜ <strong>labelì„ ì‚¬ìš©í•˜ì—¬ ë³´ì•ˆ ì •ì±…ì„ ì •ì˜</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì•„ë˜ì˜ ì •ì±…ì„ ì ìš©í•˜ì—¬ ì œêµ­ ìš°ì£¼ì„ ë§Œ ì°©ë¥™ ìš”ì²­ì„ í—ˆìš©í•˜ë„ë¡ í•©ë‹ˆë‹¤. ì´ë ‡ê²Œí•˜ë©´ org=empire ë¼ë²¨ì´ ìˆëŠ” Podë§Œ ì°©ë¥™ ìš”ì²­ì„ í—ˆìš©í•˜ê²Œ ë˜ê³ ,
í•´ë‹¹ ë¼ë²¨ì´ ì—†ëŠ” íŒŒë“œëŠ” deathstar ì„œë¹„ìŠ¤ì— ì—°ê²°ì¡°ì°¨ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ ì •ì±…ì€ IP í”„ë¡œí† ì½œ(ë„¤íŠ¸ì›Œí¬ ê³„ì¸µ 3)ì™€ TCP í”„ë¡œí† ì½œ(ì „ì†¡ ê³„ì¸µ 4)ì—ë§Œ ì ìš©í•˜ëŠ”
L3/L4 ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ì •ì±…ì´ë¼ê³  í•©ë‹ˆë‹¤.</li>
  <li>ì°¸ê³  : Ciliumì€ <strong>ìƒíƒœë³„ ì—°ê²° ì¶”ì </strong>ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. 
ì¦‰, í”„ë¡ íŠ¸ì—”ë“œê°€ ë°±ì—”ë“œì— ë„ë‹¬í•  ìˆ˜ ìˆìœ¼ë©´, ë™ì¼í•œ TCP/UDP ì—°ê²°ë‚´ì˜ ì‘ë‹µì€ ìë™ìœ¼ë¡œ í—ˆìš©ëœë‹¤ëŠ”ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CiliumNetworkPolicy</span>
<span class="c1">## CiliumNetworkPolicysëŠ” "endpointSelector"ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŸ ë ˆì´ë¸”ì—ì„œ ì •ì±…ì´ ì ìš©ë˜ëŠ” ì†ŒìŠ¤ì™€ ëª©ì ì§€ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤. </span>
<span class="c1">## ì•„ë˜ ì •ì±…ì€ TCP í¬íŠ¸ 80ì—ì„œ ë ˆì´ë¸”(org=empire)ì´ ìˆëŠ” ëª¨ë“  íŒŸì—ì„œ ë ˆì´ë¸”(org=empire, class=deathstar)ì´ ìˆëŠ” ë°ìŠ¤ìŠ¤íƒ€ íŒŸìœ¼ë¡œ ì „ì†¡ë˜ëŠ” íŠ¸ë˜í”½ì„ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cilium.io/v2"</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CiliumNetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rule1"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">L3-L4</span><span class="nv"> </span><span class="s">policy</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">restrict</span><span class="nv"> </span><span class="s">deathstar</span><span class="nv"> </span><span class="s">access</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">empire</span><span class="nv"> </span><span class="s">ships</span><span class="nv"> </span><span class="s">only"</span>
  <span class="na">endpointSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">org</span><span class="pi">:</span> <span class="s">empire</span>
      <span class="na">class</span><span class="pi">:</span> <span class="s">deathstar</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">fromEndpoints</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">matchLabels</span><span class="pi">:</span>
        <span class="na">org</span><span class="pi">:</span> <span class="s">empire</span>
    <span class="na">toPorts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">80"</span>
        <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/sw_l3_l4_policy.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/rule1 created</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME    AGE   VALID</span>
<span class="c">#    rule1   8s    True</span>
<span class="nv">$ </span>kubectl get cnp <span class="nt">-o</span> json | jq
<span class="c"># =&gt; ...</span>
<span class="c">#          "spec": {</span>
<span class="c">#            "description": "L3-L4 policy to restrict deathstar access to empire ships only",</span>
<span class="c">#            "endpointSelector": {</span>
<span class="c">#              "matchLabels": {</span>
<span class="c">#                "class": "deathstar",</span>
<span class="c">#                "org": "empire"</span>
<span class="c">#              }</span>
<span class="c">#            },</span>
<span class="c">#            "ingress": [ { </span>
<span class="c">#                 "fromEndpoints": [ { "matchLabels": { "org": "empire" } } ],</span>
<span class="c">#                 "toPorts": [ { "ports": [ { "port": "80", "protocol": "TCP" } ] } ]</span>
<span class="c">#            } ]</span>
<span class="c">#          },</span>
<span class="c">#    ...</span>

<span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--type</span> drop

<span class="c"># í˜¸ì¶œ ì‹œë„ 1 </span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing <span class="nt">--connect-timeout</span> 2
<span class="c"># =&gt; command terminated with exit code 28</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì—°í•©êµ°ì˜ ìš°ì£¼ì„  xwingì˜ ì°©ë¥™ ìš”ì²­ì€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤!&lt;/span&gt;</span>

<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ DROP ëœ íŒ¨í‚· ëª¨ë‹ˆí„°ë§&lt;/span&gt;</span>
<span class="c"># =&gt; (âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble observe -f --type drop</span>
<span class="c">#    Jul 26 07:50:53.384: default/xwing:46590 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) Policy denied DROPPED (TCP Flags: SYN)</span>
<span class="c">#    Jul 26 07:50:54.407: default/xwing:46590 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) Policy denied DROPPED (TCP Flags: SYN)</span>

<span class="c"># ëª¨ë‹ˆí„°ë§ </span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$DEATHSTARID</span>

<span class="c"># í˜¸ì¶œ ì‹œë„ 2</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì œêµ­êµ°ì˜ ìš°ì£¼ì„  tiefighterì˜ ì°©ë¥™ ìš”ì²­ì€ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!&lt;/span&gt;</span>

<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ í—ˆìš©ëœ íŒ¨í‚· ëª¨ë‹ˆí„°ë§&lt;/span&gt;</span>
<span class="c"># =&gt; (âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble observe -f --protocol tcp --from-identity $DEATHSTARID</span>
<span class="c">#    Jul 26 07:52:52.016: default/tiefighter:43410 (ID:50993) &lt;- default/deathstar-8c4c77fb7-5zqmp:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Jul 26 07:52:52.016: default/deathstar-8c4c77fb7-5zqmp:80 (ID:46219) &lt;&gt; default/tiefighter (ID:50993) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Jul 26 07:52:52.016: default/deathstar-8c4c77fb7-5zqmp:80 (ID:46219) &lt;&gt; default/tiefighter (ID:50993) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Jul 26 07:52:52.019: default/tiefighter:43410 (ID:50993) &lt;- default/deathstar-8c4c77fb7-5zqmp:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Jul 26 07:52:52.021: default/tiefighter:43410 (ID:50993) &lt;- default/deathstar-8c4c77fb7-5zqmp:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_8.png" alt="img.png" /></p>

<ul>
  <li>ì •ì±…ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># deathstar ì— ingress ì— policy í™œì„±í™” í™•ì¸</span>
<span class="nv">$ </span>c0 endpoint list
<span class="nv">$ </span>c1 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4          STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    ...</span>
<span class="c">#    507        &lt;span style="color: green;"&gt;Enabled&lt;/span&gt;            Disabled          46219      k8s:app.kubernetes.io/name=deathstar                                                172.20.1.67   ready</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c2 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    ...</span>
<span class="c">#    1391       &lt;span style="color: green;"&gt;Enabled&lt;/span&gt;            Disabled          46219      k8s:app.kubernetes.io/name=deathstar                                                172.20.2.251   ready</span>
<span class="c">#    ...</span>
                                                           
<span class="nv">$ </span>kc describe cnp rule1
<span class="c"># =&gt; ...</span>
<span class="c">#    Spec:</span>
<span class="c">#      Description:  L3-L4 policy to restrict deathstar access to empire ships only</span>
<span class="c">#      Endpoint Selector:</span>
<span class="c">#        Match Labels:</span>
<span class="c">#          Class:  deathstar</span>
<span class="c">#          Org:    empire</span>
<span class="c">#      Ingress:</span>
<span class="c">#        From Endpoints:</span>
<span class="c">#          Match Labels:</span>
<span class="c">#            Org:  empire</span>
<span class="c">#        To Ports:</span>
<span class="c">#          Ports:</span>
<span class="c">#            Port:      80</span>
<span class="c">#            Protocol:  TCP</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>Life of a Packet : L7 ë™ì‘ ì²˜ë¦¬ëŠ” cilium-envoy ë°ëª¬ì…‹ì´ ë‹´ë‹¹í•©ë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/network/ebpf/lifeofapacket/">Docs</a></li>
</ul>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_9.png" alt="img.png" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get ds <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span>
<span class="c">#    cilium         3         3         3       3            3           kubernetes.io/os=linux   2d17h</span>
<span class="c">#    cilium-envoy   3         3         3       3            3           kubernetes.io/os=linux   2d17h</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium-envoy <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 READY   STATUS    RESTARTS        AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    cilium-envoy-q97fq   1/1     Running   3 (3h59m ago)   2d16h   192.168.10.102   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    cilium-envoy-xzxd6   1/1     Running   3 (3h59m ago)   2d16h   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    cilium-envoy-zzzw5   1/1     Running   3 (3h59m ago)   2d17h   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kc describe ds <span class="nt">-n</span> kube-system cilium-envoy
<span class="c"># =&gt;     Mounts:</span>
<span class="c">#          /sys/fs/bpf from bpf-maps (rw)</span>
<span class="c">#          /var/run/cilium/envoy/ from envoy-config (ro)</span>
<span class="c">#          /var/run/cilium/envoy/artifacts from envoy-artifacts (ro)</span>
<span class="c">#          &lt;span style="color: green;"&gt;/var/run/cilium/envoy/sockets from envoy-sockets (rw)&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c">#       envoy-config:</span>
<span class="c">#        Type:      ConfigMap (a volume populated by a ConfigMap)</span>
<span class="c">#        Name:      &lt;span style="color: green;"&gt;cilium-envoy-config&lt;/span&gt;</span>
<span class="c">#        Optional:  false</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> ss <span class="nt">-xnp</span> | <span class="nb">grep</span> <span class="nt">-i</span> <span class="nt">-envoy</span>
<span class="c"># =&gt; u_str  ESTAB  0  0  /var/run/cilium/envoy/sockets/admin.sock  16193  *  16192</span>
<span class="c">#    u_str  ESTAB  0  0  /var/run/cilium/envoy/sockets/admin.sock  17068  *  17067</span>
<span class="c">#    u_str  ESTAB  0  0  /var/run/cilium/envoy/sockets/xds.sock    15993  *  15992  users:(("cilium-agent",pid=1,fd=106))</span>

<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> kube-system cilium-envoy-config
<span class="c"># =&gt; ...</span>
<span class="c">#    Data</span>
<span class="c">#    ====</span>
<span class="c">#    bootstrap-config.json:</span>
<span class="c">#    ----</span>
<span class="c">#    {"admin":{"address":{"pipe":{"path":"/var/run/cilium/envoy/sockets/admin.sock"}}}...</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h4 id="http-aware-l7-ì •ì±…-ì ìš©-ë°-í…ŒìŠ¤íŠ¸">HTTP-aware L7 ì •ì±… ì ìš© ë° í…ŒìŠ¤íŠ¸</h4>

<ul>
  <li>HTTP-aware L7 ì •ì±…ì„ ì ìš©í•˜ê³  í…ŒìŠ¤íŠ¸í•´ë³´ê² ìŠµë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-and-test-http-aware-l7-policy">Docs</a></li>
</ul>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_10.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>ì´ì „ì˜ ê°„ë‹¨í•œ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” tiefighterì™€ xwingì—ê²Œ deathstar APIì— ëŒ€í•œ ì „ì²´ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ê±°ë‚˜, ì ‘ì† ìì²´ë¥¼ ì°¨ë‹¨í•˜ëŠ”ê²ƒìœ¼ë¡œ ì¶©ë¶„í–‡ìŠµë‹ˆë‹¤.</li>
  <li>í•˜ì§€ë§Œ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ê°„ì˜ ê°•ë ¥í•œ ë³´ì•ˆ(ì¦‰, ìµœì†Œ ê¶Œí•œ ê²©ë¦¬ë¥¼ ê°•ì œí•˜ëŠ” ê²ƒ)ì„ ì œê³µí•˜ê¸° ìœ„í•´ì„œëŠ” deathstar APIë¥¼ í˜¸ì¶œí•˜ëŠ” ê° ì„œë¹„ìŠ¤ê°€ ìš´ì˜ì— í•„ìš”í•œ HTTP ìš”ì²­ë§Œ ìˆ˜í–‰í•˜ë„ë¡ ì œí•œ í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>ì˜ˆë¥¼ ë“¤ì–´ deathstar ì„œë¹„ìŠ¤ê°€ ì„ì˜ì˜ ì œêµ­ ìš°ì£¼ì„ ì´ í˜¸ì¶œí•´ì„œëŠ” ì•ˆ ë˜ëŠ” ìœ ì§€ë³´ìˆ˜ APIë¥¼ ì œê³µí•œë‹¤ê³  ê°€ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§ &gt;&gt; Layer3/4 ì—ì„œëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœë¥¼ í™•ì¸ í•  ìˆ˜ ì—†ìŒ!</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$DEATHSTARID</span>
<span class="c"># =&gt; Jul 26 08:29:39.157: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-network FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Jul 26 08:29:39.161: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-network FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Jul 26 08:29:39.164: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Jul 26 08:29:39.201: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Jul 26 08:29:39.201: default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) &lt;&gt; default/tiefighter (ID:50993) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Jul 26 08:29:39.201: default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) &lt;&gt; default/tiefighter (ID:50993) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Jul 26 08:29:39.205: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Jul 26 08:29:39.207: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>

<span class="c"># í˜¸ì¶œí•´ì„œëŠ” ì•ˆ ë˜ëŠ” ì¼ë¶€ ìœ ì§€ë³´ìˆ˜ APIë¥¼ ë…¸ì¶œ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPUT</span> deathstar.default.svc.cluster.local/v1/exhaust-port
<span class="c"># =&gt; Panic: deathstar exploded</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì„ì˜ë¡œ í˜¸ì¶œí•´ì„œëŠ” ì•ˆë˜ëŠ” APIê°€ ì‹¤í–‰ë˜ì–´ deathstarê°€ í­ë°œí–ˆìŠµë‹ˆë‹¤!&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="ciliumì„-í†µí•œ-l7-ì •ì±…-ì ìš©">ciliumì„ í†µí•œ L7 ì •ì±… ì ìš©</h5>

<ul>
  <li>ciliumì€ HTTP ê³„ì¸µ(L7) ì •ì±…ì„ ì ìš©í•˜ì—¬ tiefighterê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” API URLì„ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒì€ tiefighterê°€ POST /v1/request-landing URLì—ë§Œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ì •ì±…ì…ë‹ˆë‹¤.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ê¸°ì¡´ rule1 ì •ì±…ì„ ì—…ë°ì´íŠ¸ í•´ì„œ ì‚¬ìš©</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cilium.io/v2"</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CiliumNetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rule1"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">L7</span><span class="nv"> </span><span class="s">policy</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">restrict</span><span class="nv"> </span><span class="s">access</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">specific</span><span class="nv"> </span><span class="s">HTTP</span><span class="nv"> </span><span class="s">call"</span>
  <span class="na">endpointSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">org</span><span class="pi">:</span> <span class="s">empire</span>
      <span class="na">class</span><span class="pi">:</span> <span class="s">deathstar</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">fromEndpoints</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">matchLabels</span><span class="pi">:</span>
        <span class="na">org</span><span class="pi">:</span> <span class="s">empire</span>
    <span class="na">toPorts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">80"</span>
        <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">rules</span><span class="pi">:</span>
        <span class="na">http</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">method</span><span class="pi">:</span> <span class="s2">"</span><span class="s">POST"</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/v1/request-landing"</span>
</code></pre></div></div>

<ul>
  <li>tiefigher ì—ëŠ” ì°©ë¥™ ìš”ì²­ë§Œ í—ˆìš©í•˜ëŠ” L7 ì •ì±… ì ìš©í›„ deathstar ì„œë¹„ìŠ¤ì— ì°©ë¥™ ìš”ì²­ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Update the existing rule to apply L7-aware policy to protect deathstar using:</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/sw_l3_l4_l7_policy.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/rule1 configured</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME    AGE    VALID</span>
<span class="c">#    rule1   168m   True</span>
<span class="nv">$ </span>kc describe cnp
<span class="c"># =&gt; ...</span>
<span class="c">#    Spec:</span>
<span class="c">#      Description:  L7 policy to restrict access to specific HTTP call</span>
<span class="c">#      Endpoint Selector:</span>
<span class="c">#        Match Labels:</span>
<span class="c">#          Class:  deathstar</span>
<span class="c">#          Org:    empire</span>
<span class="c">#      Ingress:</span>
<span class="c">#        From Endpoints:</span>
<span class="c">#          Match Labels:</span>
<span class="c">#            Org:  empire</span>
<span class="c">#        To Ports:</span>
<span class="c">#          Ports:</span>
<span class="c">#            Port:      80</span>
<span class="c">#            Protocol:  TCP</span>
<span class="c">#          Rules:</span>
<span class="c">#            Http:</span>
<span class="c">#              Method:  POST</span>
<span class="c">#              Path:    /v1/request-landing</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 policy get

<span class="c"># íŒŒë“œ ì´ë¦„ ì§€ì •í•˜ì—¬ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--pod</span> deathstar <span class="nt">--protocol</span> http
Jul 20 01:28:02.184: default/tiefighter:59020 <span class="o">(</span>ID:19274<span class="o">)</span> -&gt; default/deathstar-8c4c77fb7-9klws:80 <span class="o">(</span>ID:318<span class="o">)</span> http-request FORWARDED <span class="o">(</span>HTTP/1.1 POST http://deathstar.default.svc.cluster.local/v1/request-landing<span class="o">)</span>
Jul 20 01:28:02.190: default/tiefighter:59020 <span class="o">(</span>ID:19274<span class="o">)</span> &lt;- default/deathstar-8c4c77fb7-9klws:80 <span class="o">(</span>ID:318<span class="o">)</span> http-response FORWARDED <span class="o">(</span>HTTP/1.1 200 6ms <span class="o">(</span>POST http://deathstar.default.svc.cluster.local/v1/request-landing<span class="o">))</span>

<span class="c"># ì°©ë¥™ ìš”ì²­ì„ í…ŒìŠ¤íŠ¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë‹¹ì—°íˆ API í˜¸ì¶œì— ì„±ê³µí•©ë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_11.png" alt="img.png" /></p>

<ul>
  <li>ì´ë²ˆì—ëŠ” tiefighterê°€ í—ˆìš©ë˜ì§€ ì•Šì€ APIë¥¼ í˜¸ì¶œí•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë“œ ì´ë¦„ ì§€ì •í•˜ì—¬ ë“œëëœ íŒ¨í‚· ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--pod</span> deathstar <span class="nt">--verdict</span> DROPPED
<span class="c"># =&gt; Jul 26 10:48:17.734: default/tiefighter:40606 (ID:50993) -&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) http-request DROPPED (HTTP/1.1 PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port)</span>

<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span>c1 monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
<span class="nv">$ </span>c2 monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
<span class="c"># =&gt; &lt;- Request http from 721 ([k8s:app.kubernetes.io/name=tiefighter k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]) to 1391 ([k8s:app.kubernetes.io/name=deathstar k8s:class=deathstar k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]), identity 50993-&gt;46219, verdict Denied PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port =&gt; 0</span>
<span class="c">#    &lt;- Response http to 721 ([k8s:app.kubernetes.io/name=tiefighter k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]) from 1391 ([k8s:app.kubernetes.io/name=deathstar k8s:class=deathstar k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]), identity 46219-&gt;50993, verdict Forwarded PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port =&gt; 403</span>

<span class="c"># ì•ì„œ deathstarë¥¼ í­íŒŒì‹œì¼°ë˜ tiefighterì—ê²Œ í—ˆìš©ë˜ì§€ ì•Šì€ APIë¥¼ í˜¸ì¶œí•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPUT</span> deathstar.default.svc.cluster.local/v1/exhaust-port
<span class="c"># =&gt; Access denied</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_12.png" alt="img.png" class="image-center" />
<em class="image-caption">L7 ì •ì±…ì— ì˜í•´ í—ˆìš©ë˜ì§€ ì•Šì€ API í˜¸ì¶œì´ ê±°ë¶€ëœ ëª¨ìŠµ</em></p>

<ul>
  <li>xwingìœ¼ë¡œ ì°©ë¥™ìš”ì²­ì„ í•´ì„œ ìœ„ì™€ ì°¨ì´ì ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§ : íŒŒë“œ ì´ë¦„ ì§€ì •</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--pod</span> xwing

<span class="c"># í˜¸ì¶œ ì‹œë„ : ìœ„ì™€ ì•„ë˜ ì‹¤í–‰ ì¢…ë£Œì˜ ì°¨ì´ì ì„ ì´í•´í•´ë³´ì!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing <span class="nt">--connect-timeout</span> 2
<span class="c"># =&gt; command terminated with exit code 28</span>

<span class="c"># (âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble observe -f --pod xwing</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Jul 26 10:50:31.048: default/xwing:57832 (ID:14847) -&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-network FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Jul 26 10:50:31.049: default/xwing:57832 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span>
<span class="c">#    Jul 26 10:50:31.049: default/xwing:57832 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) Policy denied DROPPED (TCP Flags: SYN)</span>
<span class="c">#    ...</span>
<span class="c">#    Jul 26 10:50:32.053: default/xwing:57832 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span>
<span class="c">#    Jul 26 10:50:32.053: default/xwing:57832 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) Policy denied DROPPED (TCP Flags: SYN)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ xwingì˜ deathstarë¡œì˜ ì ‘ê·¼ì€ TCP (L4) ì—°ê²° ìì²´ê°€ ì°¨ë‹¨(DROP)ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_13.png" alt="img.png" class="image-center" />
<em class="image-caption">xwingì´ L7 ì •ì±… ì´ì „ì— L4 ì •ì±…ì— ì˜í•´ deathstarë¡œì˜ ì ‘ê·¼ì´ ì°¨ë‹¨ëœ ëª¨ìŠµ</em></p>

<ul>
  <li>ë‹¤ìŒ ì‹¤ìŠµì„ ìœ„í•´ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚­ì œí•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë‹¤ìŒ ì‹¤ìŠµì„ ìœ„í•´ ë¦¬ì†ŒìŠ¤ ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/http-sw-app.yaml
<span class="c"># =&gt; service "deathstar" deleted</span>
<span class="c">#    deployment.apps "deathstar" deleted</span>
<span class="c">#    pod "tiefighter" deleted</span>
<span class="c">#    pod "xwing" deleted</span>
<span class="nv">$ </span>kubectl delete cnp rule1
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io "rule1" deleted</span>

<span class="c"># ì‚­ì œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; No resources found in default namespace.</span>
</code></pre></div></div>

<h4 id="configuring-hubble-exporter">Configuring Hubble Exporter</h4>

<ul>
  <li>íë¦„ ë¡œê·¸ - <a href="https://docs.cilium.io/en/stable/observability/hubble/configuration/export/">Docs</a></li>
  <li>Hubble ExporterëŠ” ë‚˜ì¤‘ì— ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ Hubble flows ë¡œê·¸ë¥¼ íŒŒì¼ì— ì €ì¥í•˜ëŠ” cilium-agentì˜ ê¸°ëŠ¥ì…ë‹ˆë‹¤.</li>
  <li>Hubble ExporterëŠ” file rotation, size limits, filters, field masksë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
  <li>Hubble ExporterëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì´ë¯¸ cilium ì„¤ì¹˜í• ë•Œ ì ìš©ë˜ì–´ì„œ ì‹¤ìŠµ ê³¼ì •ì—ëŠ” ì ìš©í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.export.static.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.export.static.filePath<span class="o">=</span>/var/run/cilium/hubble/events.log

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout status ds/cilium
</code></pre></div></div>

<ul>
  <li>Hubble Exporterì˜ ì„¤ì •ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | <span class="nb">grep </span>hubble-export
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>hubble-export
<span class="c"># =&gt; hubble-export-allowlist</span>
<span class="c">#    hubble-export-denylist</span>
<span class="c">#    hubble-export-fieldmask</span>
<span class="c">#    hubble-export-file-max-backups   5     # rotateëœ Hubble export íŒŒì¼ì„ ìœ ì§€í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ê°œìˆ˜. (ê¸°ë³¸ê°’: 5)</span>
<span class="c">#    hubble-export-file-max-size-mb   10    # Hubble export íŒŒì¼ì„ rotateí•  ë•Œì˜ í¬ê¸°(MB). (ê¸°ë³¸ê°’: 10)</span>
<span class="c">#    hubble-export-file-path          /var/run/cilium/hubble/events.log   # ëŒ€ìƒ ë¡œê·¸ íŒŒì¼ì˜ ê²½ë¡œ. (ê¸°ë³¸ê°’: /var/run/cilium/hubble/events.log)</span>

<span class="c"># Verify that flow logs are stored in target files</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">--</span> <span class="nb">tail</span> <span class="nt">-f</span> /var/run/cilium/hubble/events.log
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë¡œê·¸ê°€ ê³„ì† ë‚˜ì˜µë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'tail -f /var/run/cilium/hubble/events.log'</span> | jq
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë¡œê·¸ê°€ json í˜•íƒœë¡œ ê³„ì† ë‚˜ì˜µë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h2 id="prometheusì™€-grafanaë¥¼-í†µí•œ-ëª¨ë‹ˆí„°ë§">Prometheusì™€ Grafanaë¥¼ í†µí•œ ëª¨ë‹ˆí„°ë§</h2>

<ul>
  <li>Prometheusì™€ Grafanaë¥¼ í†µí•´ Ciliumì˜ ëª¨ë‹ˆí„°ë§ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/observability/grafana/">Docs</a></li>
  <li>ë„ë¦¬ ì•Œë ¤ì§„ íˆ´ë“¤ì´ë¼ ë‹¤ë“¤ ì•„ì‹œê² ì§€ë§Œ ê°„ëµí•˜ê²Œ ì†Œê°œí•´ ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li><strong>Prometheus</strong> : ì˜¤í”ˆ ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œìœ¼ë¡œ, ì‹œê³„ì—´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤. ì¼ì¢…ì˜ TSDB(Time Series Database)ë¡œ, ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ê³  ì¿¼ë¦¬í•  ìˆ˜ ìˆëŠ” ê°•ë ¥í•œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
      <li><strong>Grafana</strong> : ì‹œê°í™” ë„êµ¬ë¡œ, Prometheusì™€ ê°™ì€ ë°ì´í„° ì†ŒìŠ¤ì—ì„œ ìˆ˜ì§‘ëœ ë©”íŠ¸ë¦­ì„ ëŒ€ì‹œë³´ë“œ í˜•íƒœë¡œ ì‹œê°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ì–‘í•œ í”ŒëŸ¬ê·¸ì¸ì„ í†µí•´ ë‹¤ì–‘í•œ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì¶”ì²œê¸€
    <ul>
      <li>ì•…ë¶„ë‹˜ í”„ë¡œë©”í…Œìš°ìŠ¤ ì˜¤í¼ë ˆì´í„° ì†Œê°œ - <a href="https://malwareanalysis.tistory.com/566">Blog</a></li>
      <li>hanhorangë‹˜ íƒ€ë…¸ìŠ¤ ì†Œê°œ - <a href="https://hanhorang31.github.io/post/pkos2-4-monitoring/">Blog</a></li>
      <li>[AWS EC2] í”„ë¡œë©”í…Œìš°ìŠ¤ ì§ì ‘ ì„¤ì¹˜ - <a href="https://prometheus.io/docs/prometheus/latest/getting_started/">Docs</a></li>
    </ul>
  </li>
</ul>

<h3 id="ìƒ˜í”Œ-ì• í”Œë¦¬ì¼€ì´ì…˜-ë°°í¬-ë°-í™•ì¸">ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° í™•ì¸</h3>

<ul>
  <li>Prometheusì™€ Grafanaë¥¼ ì„¤ì¹˜í•˜ê¸° ì „ì— ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•˜ê³ , Ciliumì˜ ëª¨ë‹ˆí„°ë§ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF

</span><span class="c"># k8s-ctr ë…¸ë“œì— curl-pod íŒŒë“œ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span></code></pre></div></div>

<ul>
  <li>ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   2/2     2            2           41s   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.147.79   &lt;none&gt;        80/TCP    41s   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                       AGE</span>
<span class="c">#    endpoints/webpod   172.20.1.4:80,172.20.2.101:80   41s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="c"># =&gt; NAME           ADDRESSTYPE   PORTS   ENDPOINTS                 AGE</span>
<span class="c">#    webpod-g9ldp   IPv4          80      172.20.1.4,172.20.2.101   49s</span>
<span class="nv">$ </span>kubectl get ciliumendpoints
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  472                 ready            172.20.0.43</span>
<span class="c">#    webpod-697b545f57-mvz92   18655               ready            172.20.2.101</span>
<span class="c">#    webpod-697b545f57-ns4sw   18655               ready            172.20.1.4</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    272        Disabled           Disabled          472        k8s:app=curl                                                                        172.20.0.43    ready</span>
<span class="c">#                                                               k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=default</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=default</span>
<span class="c">#    1332       Disabled           Disabled          1          k8s:node-role.kubernetes.io/control-plane                                                          ready</span>
<span class="c">#                                                               k8s:node.kubernetes.io/exclude-from-external-load-balancers</span>
<span class="c">#                                                               reserved:host</span>
<span class="c">#    1814       Disabled           Disabled          30923      k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.20.0.134   ready</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=coredns</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#                                                               k8s:k8s-app=kube-dns</span>

<span class="c"># í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-mvz92</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s webpod | grep Hostname; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-ns4sw</span>
<span class="c">#    Hostname: webpod-697b545f57-mvz92</span>
<span class="c">#    Hostname: webpod-697b545f57-mvz92</span>
<span class="c">#    Hostname: webpod-697b545f57-ns4sw</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h3 id="prometheus-ì™€-grafana-ì„¤ì¹˜-ë°-ì„¤ì •">Prometheus ì™€ Grafana ì„¤ì¹˜ ë° ì„¤ì •</h3>

<ul>
  <li>ì´ë²ˆ ì˜ˆì œëŠ” Prometheusì™€ Grafanaë¥¼ í•œë²ˆì— ì„¤ì¹˜í•˜ëŠ” ì˜ˆì œë¥¼ ë”°ë¼í•˜ë©° ì§„í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤. <a href="https://www.youtube.com/watch?v=DdWksYq5Pv4">Youtube ì˜ìƒ</a>
    <ul>
      <li>ë°°í¬ íŒŒì¼ì— Grafanaì—ëŠ” Cilium Dashboardê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ì´ë²ˆ ì˜ˆì œ ë°°í¬íŒŒì¼ì—ëŠ” Prometheusì™€ Grafanaê°€ Ciliumê³¼ Hubbleì˜ ë©”íŠ¸ë¦­ì„ ìë™ìœ¼ë¡œ ìˆ˜ì§‘í•˜ê³  ì‹œê°í™”í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/kubernetes/addons/prometheus/monitoring-example.yaml
<span class="c"># =&gt; namespace/cilium-monitoring created</span>
<span class="c">#    serviceaccount/prometheus-k8s created</span>
<span class="c">#    configmap/grafana-config created</span>
<span class="c">#    configmap/grafana-cilium-dashboard created</span>
<span class="c">#    configmap/grafana-cilium-operator-dashboard created</span>
<span class="c">#    configmap/grafana-hubble-dashboard created</span>
<span class="c">#    configmap/grafana-hubble-l7-http-metrics-by-workload created</span>
<span class="c">#    configmap/prometheus created</span>
<span class="c">#    clusterrole.rbac.authorization.k8s.io/prometheus created</span>
<span class="c">#    clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span>
<span class="c">#    service/grafana created</span>
<span class="c">#    service/prometheus created</span>
<span class="c">#    deployment.apps/grafana created</span>
<span class="c">#    deployment.apps/prometheus created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/grafana      0/1     1            0           14s</span>
<span class="c">#    deployment.apps/prometheus   1/1     1            1           14s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS              RESTARTS   AGE</span>
<span class="c">#    pod/grafana-5c69859d9-7cpvl       0/1     ContainerCreating   0          14s</span>
<span class="c">#    pod/prometheus-6fc896bc5d-9xfll   1/1     Running             0          14s</span>
<span class="c">#    </span>
<span class="c">#    NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/grafana      ClusterIP   10.96.10.188   &lt;none&gt;        3000/TCP   14s</span>
<span class="c">#    service/prometheus   ClusterIP   10.96.218.78   &lt;none&gt;        9090/TCP   14s</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS           AGE</span>
<span class="c">#    endpoints/grafana      &lt;none&gt;              14s</span>
<span class="c">#    endpoints/prometheus   172.20.2.115:9090   14s</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME                                         DATA   AGE</span>
<span class="c">#    grafana-cilium-dashboard                     1      23s</span>
<span class="c">#    grafana-cilium-operator-dashboard            1      23s</span>
<span class="c">#    grafana-config                               3      24s</span>
<span class="c">#    grafana-hubble-dashboard                     1      23s</span>
<span class="c">#    grafana-hubble-l7-http-metrics-by-workload   1      23s</span>
<span class="c">#    kube-root-ca.crt                             1      24s</span>
<span class="c">#    prometheus                                   1      23s</span>

<span class="c"># í”„ë¡œë©”í…Œìš°ìŠ¤ ì„œë²„ ì„¤ì •</span>
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring prometheus

<span class="c"># ê·¸ë¼íŒŒë‚˜ ì„œë²„ ì„¤ì •</span>
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring grafana-config

<span class="c"># ê·¸íŒŒë¼ë‚˜ ëŒ€ì‹œë³´ë“œë“¤ ì£¼ì…ì„ ìœ„í•œ ì„¤ì • í™•ì¸</span>
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring grafana-cilium-dashboard
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring grafana-hubble-dashboard
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì„¤ì • ë‚´ìš©ì´ ê¸¸ì–´ì„œ ìº¡ì³ëŠ” ìƒëµí•˜ê² ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="ciliumê³¼-hubble-ë©”íŠ¸ë¦­-ì¼œê¸°">Ciliumê³¼ Hubble ë©”íŠ¸ë¦­ ì¼œê¸°</h3>

<ul>
  <li>ì´ë²ˆ ì˜ˆì œì—ëŠ” Ciliumê³¼ Hubbleì˜ ë©”íŠ¸ë¦­ì„ Prometheusì™€ Grafanaê°€ ìˆ˜ì§‘í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
  <li>í•˜ì§€ë§Œ ê¸°ë³¸ì ìœ¼ë¡œ Cilium, Hubble, Cilium Operatorì˜ ë©”íŠ¸ë¦­ì€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë”°ë¼ì„œ Prometheusì™€ Grafanaê°€ Ciliumê³¼ Hubbleì˜ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •ì„ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/observability/grafana/#deploy-cilium-and-hubble-with-metrics-enabled">Docs</a></li>
  <li>ë©”íŠ¸ë¦­ì„ í™œì„±í™”í•˜ë©´ êµ¬ì„±ìš”ì†Œê°€ ì‹¤í–‰ì¤‘ì¸ ëª¨ë“  ë…¸ë“œì— ê°ê° <code class="language-plaintext highlighter-rouge">9962</code>, <code class="language-plaintext highlighter-rouge">9965</code>, <code class="language-plaintext highlighter-rouge">9963</code> í¬íŠ¸ê°€ ì—´ë¦½ë‹ˆë‹¤.</li>
  <li>Cilium, Hubble, Cilium Operatorì€ ë‹¤ìŒ helm ê°’ìœ¼ë¡œ ì„œë¡œ ë…ë¦½ì ìœ¼ë¡œ í™œì„±í™” í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">prometheus.enabled=true</code>: cilium-agent ë©”íŠ¸ë¦­ ì¼œê¸°.</li>
      <li><code class="language-plaintext highlighter-rouge">operator.prometheus.enabled=true</code>: cilium-operator ë©”íŠ¸ë¦­ ì¼œê¸°.</li>
      <li><code class="language-plaintext highlighter-rouge">hubble.metrics.enabled</code>: ì£¼ì–´ì§„ Hubble ë©”íŠ¸ë¦­ ëª©ë¡ì„ ì¼œê¸°
        <ul>
          <li>Hubble ë©”íŠ¸ë¦­ ì‹¤í–‰ì„ ìœ„í•´ì„œëŠ” <code class="language-plaintext highlighter-rouge">hubble.enabled=true</code>ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
          <li><a href="https://docs.cilium.io/en/stable/observability/metrics/#hubble-exported-metrics">Hubble exported metrics</a>ì—ì„œ í™œì„±í™” í•  ìˆ˜ ìˆëŠ” Hubble ë©”íŠ¸ë¦­ì„ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤..</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì´ë²ˆ ì˜ˆì œì—ì„œëŠ” ì´ë¯¸ í™œì„±í™” ë˜ì–´ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> 1.17.6 <span class="se">\</span>
   <span class="nt">--namespace</span> kube-system <span class="se">\</span>
   <span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span>

<span class="c"># í˜¸ìŠ¤íŠ¸ì— í¬íŠ¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'9962|9963|9965'</span>
<span class="c"># =&gt; LISTEN 0      4096                *:9962             *:*    users:(("cilium-agent",pid=2870,fd=7))     # cilium ë©”íŠ¸ë¦­</span>
<span class="c">#    LISTEN 0      4096                *:9963             *:*    users:(("cilium-operator",pid=1917,fd=7))  # cilium-opeator ë©”íŠ¸ë¦­</span>
<span class="c">#    LISTEN 0      4096                *:9965             *:*    users:(("cilium-agent",pid=2870,fd=31))    # hubble ë©”íŠ¸ë¦­</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 9963 í¬íŠ¸ëŠ” cilium-operator ë©”íŠ¸ë¦­ì„ ìœ„í•œ í¬íŠ¸ë¡œ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œì—ì„œë§Œ ì—´ë¦¬ëŠ”ë“¯ í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'9962|9963|9965'</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    LISTEN 0      4096               *:9965             *:*    users:(("cilium-agent",pid=2032,fd=39))     # hubble ë©”íŠ¸ë¦­</span>
<span class="c">#    LISTEN 0      4096               *:9962             *:*    users:(("cilium-agent",pid=2032,fd=7))      # cilium ë©”íŠ¸ë¦­</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    LISTEN 0      4096               *:9962             *:*    users:(("cilium-agent",pid=2036,fd=7))      # cilium ë©”íŠ¸ë¦­</span>
<span class="c">#    LISTEN 0      4096               *:9965             *:*    users:(("cilium-agent",pid=2036,fd=30))     # hubble ë©”íŠ¸ë¦­</span>
</code></pre></div></div>

<h3 id="prometheusì™€-grafana-ì ‘ì†í•´ì„œ-í™•ì¸">Prometheusì™€ Grafana ì ‘ì†í•´ì„œ í™•ì¸</h3>

<ul>
  <li>Prometheusì™€ Grafanaë¥¼ í˜¸ìŠ¤íŠ¸ì—ì„œ ì ‘ì†í•˜ê¸° ìœ„í•´ NodePortë¥¼ ì‚¬ìš©í•˜ì—¬ ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    grafana      ClusterIP   10.96.10.188   &lt;none&gt;        3000/TCP   10m</span>
<span class="c">#    prometheus   ClusterIP   10.96.218.78   &lt;none&gt;        9090/TCP   10m</span>

<span class="c"># NodePort ì„¤ì •</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> cilium-monitoring prometheus <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 9090, "targetPort": 9090, "nodePort": 30001}]}}'</span>
<span class="c"># =&gt; service/prometheus patched</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> cilium-monitoring grafana <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 3000, "targetPort": 3000, "nodePort": 30002}]}}'</span>
<span class="c"># =&gt; service/grafana patched</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME         TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    grafana      NodePort   10.96.10.188   &lt;none&gt;        3000:30002/TCP   11m</span>
<span class="c">#    prometheus   NodePort   10.96.218.78   &lt;none&gt;        9090:30001/TCP   11m</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ NodePortê°€ ê°ê° 30002, 30001ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"http://192.168.10.100:30001"</span>  <span class="c"># prometheus</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"http://192.168.10.100:30002"</span>  <span class="c"># grafana</span>
</code></pre></div></div>

<ul>
  <li>ê°„í˜¹ Prometheusì˜ ì ‘ì†ì‹œ ì„œë²„ì™€ ë¸Œë¼ìš°ì €ê°„ì˜ ì‹œê°„ ì°¨ì´ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>ì´ë•ŒëŠ” ëª¨ë“  ê°€ìƒë¨¸ì‹ ì„ rebootí›„ ì¬ì ‘ì†í•˜ë©´ í•´ê²°ë˜ëŠ”ë“¯ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Prometheus ì ‘ì† í™•ì¸
    <ul>
      <li>ì„¤ì •í™•ì¸
        <ul>
          <li>Status &gt; Configurationì—ì„œ Prometheus ì„¤ì •ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>Status &gt; Service Discoveryì—ì„œ kubernetesì˜ í†µí•œ ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ë¥¼ í†µí•´ ìˆ˜ì§‘ëœ ëŒ€ìƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>Status &gt; Targetsì—ì„œ Cilium, Hubble, Cilium Operatorì˜ ë©”íŠ¸ë¦­ì´ ìˆ˜ì§‘ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ê¸°ë³¸ ì¿¼ë¦¬ì°½ì—ì„œ <code class="language-plaintext highlighter-rouge">cilium_</code>, <code class="language-plaintext highlighter-rouge">cilium_operator_</code>, <code class="language-plaintext highlighter-rouge">hubble_</code>ë¡œ ì‹œì‘í•˜ëŠ” ë©”íŠ¸ë¦­ì„ ê²€ìƒ‰í•´ë³´ë©´ Cilium, Hubble, Cilium Operatorì˜ ë©”íŠ¸ë¦­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_14.png" alt="img.png" class="image-center" />
<em class="image-caption"><code class="language-plaintext highlighter-rouge">hubble_drop_total</code> ë©”íŠ¸ë¦­ ê²€ìƒ‰ ì˜ˆì œ</em></li>
    </ul>
  </li>
  <li>Grafana ì ‘ì† í™•ì¸
    <ul>
      <li>Configuration &gt; Data Sourcesì—ì„œ Prometheus ì„œë¹„ìŠ¤ì˜ ë„ë©”ì¸ ì£¼ì†Œë¥¼ í™•ì¸í•  ìˆ˜ ìˆê³ , Prometheusì—ì„œ ìˆ˜ì§‘í•œ ë©”íŠ¸ë¦­ì„ ì‚¬ìš©í•˜ê³  ìˆëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_15.png" alt="img.png" class="image-center" /></li>
      <li>Dashboard &gt; General : ë¯¸ë¦¬ ì„¤ì •ëœ ëŒ€ì‹œë³´ë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_16.png" alt="img.png" class="image-center" /></li>
    </ul>
  </li>
  <li>Cilium Metric ëŒ€ì‹œë³´ë“œ ë° ê°„ë‹¨ ì¿¼ë¦¬ë¬¸ ì•Œì•„ë³´ê¸° : Generic, API, Cilium(BPF, kvstore, NW info, Endpoints, k8s integration)
    <ul>
      <li>Cilium Metric ëŒ€ì‹œë³´ë“œëŠ” ì „ì²´ì ì¸ Ciliumì˜ ë©”íŠ¸ë¦­ì„ í™•ì¸í•  ìˆ˜ ìˆëŠ” ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.</li>
      <li>map ops (average node) íŒ¨ë„ ë¶„ì„
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_17.png" alt="img.png" class="image-center" />
        <ul>
          <li>ìœ„ì˜ ìº¡ì³ì—ì„œ ë³¸ë°”ì™€ ê°™ì´ ì•„ë˜ì™€ ê°™ì€ PromQL ì¿¼ë¦¬ë¬¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
            <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">topk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="k">avg</span><span class="p">(</span><span class="n">rate</span><span class="p">(</span><span class="n">cilium_bpf_map_ops_total</span><span class="p">{</span><span class="n">k8s_app</span><span class="o">=</span><span class="nv">"cilium"</span><span class="p">,</span> <span class="n">pod</span><span class="o">=~</span><span class="nv">"$pod"</span><span class="p">}[</span><span class="mi">5</span><span class="n">m</span><span class="p">]))</span> <span class="k">by</span> <span class="p">(</span><span class="n">pod</span><span class="p">,</span> <span class="n">map_name</span><span class="p">,</span> <span class="k">operation</span><span class="p">))</span>
</code></pre></div>            </div>
          </li>
          <li>Prometheusì—ì„œ ìœ„ì˜ ì¿¼ë¦¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ í•´ì„œ ë¶„ì„í•´ ë³´ê² ìŠµë‹ˆë‹¤.
            <ul>
              <li><a href="https://docs.cilium.io/en/stable/observability/metrics/">ê³µì‹ë¬¸ì„œ</a>ì—ì„œ í™•ì¸í•´ë³´ë©´ <code class="language-plaintext highlighter-rouge">cilium_bpf_map_ops_total</code>ëŠ”
ìˆ˜í–‰ëœ eBPF Map ì‘ì—…ìˆ˜ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
                <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
cilium_bpf_map_ops_total 
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì „ì²´ cilium_bpf_map_ops_total ì¡°íšŒ&lt;/span&gt;</span>
cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s_appì´ ciliumì¸ cilium_bpf_map_ops_total ì¡°íšŒ&lt;/span&gt;</span>
cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span>, <span class="nv">pod</span><span class="o">=</span><span class="s2">"cilium-4hghz"</span><span class="o">}</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s_appì´ ciliumì´ë©´ì„œ pod ëª…ì´ cilium-4hghzì¸ cilium_bpf_map_ops_total ì¡°íšŒ&lt;/span&gt;</span>
  
<span class="c"># ìµœê·¼ 5ë¶„ ê°„ì˜ ë°ì´í„°ë¡œ ì¦ê°€ìœ¨ ê³„ì‚°</span>
rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">)</span> <span class="c"># Graph í™•ì¸</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s_appì´ ciliumì¸ cilium_bpf_map_ops_total ì˜ 5ë¶„ê°„ ë°ì´í„° ì¦ê°€ìœ¨ ê³„ì‚°&lt;/span&gt;</span>
  
<span class="c"># ì—¬ëŸ¬ ì‹œê³„ì—´(metric series)ì˜ ê°’ì˜ í‰ê· </span>
avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">))</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ k8s_appì´ ciliumì¸ cilium_bpf_map_ops_total ì˜ 5ë¶„ê°„ ë°ì´í„° ì¦ê°€ìœ¨ì˜ í‰ê· &lt;/span&gt;</span>
  
<span class="c"># ì§‘ê³„ í•¨ìˆ˜(ì˜ˆ: sum, avg, max, rate)ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ì—¬ ì–´ë–¤ ë ˆì´ë¸”(label)ì„ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”í• ì§€ë¥¼ ì§€ì •í•˜ëŠ” ê·¸ë£¹í•‘(grouping) </span>
avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">))</span> by <span class="o">(</span>pod<span class="o">)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ podëª…ìœ¼ë¡œ ê·¸ë£¹í•‘&lt;/span&gt;</span>
avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">))</span> by <span class="o">(</span>pod, map_name<span class="o">)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ podëª…ê³¼ mapì´ë¦„ìœ¼ë¡œ ê·¸ë£¹í•‘&lt;/span&gt;</span>
avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">))</span> by <span class="o">(</span>pod, map_name, operation<span class="o">)</span> <span class="c"># Graph í™•ì¸</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ podëª…ê³¼ mapì´ë¦„, map ë™ì‘ìœ¼ë¡œ ê·¸ë£¹í•‘&lt;/span&gt;</span>
  
<span class="c"># ì‹œê³„ì—´ ì¤‘ì—ì„œ ê°€ì¥ í° kê°œë¥¼ ì„ íƒ</span>
topk<span class="o">(</span>5, avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">)))</span> by <span class="o">(</span>pod, map_name, operation<span class="o">)</span>
topk<span class="o">(</span>5, avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span>, <span class="nv">pod</span><span class="o">=</span><span class="s2">"cilium-4hghz"</span><span class="o">}[</span>5m]<span class="o">)))</span> by <span class="o">(</span>pod, map_name, operation<span class="o">)</span>
</code></pre></div>                </div>
              </li>
            </ul>
          </li>
          <li>Grafana í•´ë‹¹ ëŒ€ì‹œë³´ë“œ í¸ì§‘í•´ì„œ Variablesì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
            <ul>
              <li>ì•ì„  PromQL ì¿¼ë¦¬ë¬¸ì—ì„œ <code class="language-plaintext highlighter-rouge">$pod</code>ëŠ” Variablesë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
              <li>í•´ë‹¹ dashboard &gt; Settings &gt; Variablesì—ì„œ <code class="language-plaintext highlighter-rouge">$pod</code>ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_18.png" alt="img.png" class="image-center" /></li>
              <li><code class="language-plaintext highlighter-rouge">label_values(cilium_version, pod)</code>ëŠ” Prometheusì—ì„œ <code class="language-plaintext highlighter-rouge">cilium_version</code>ìœ¼ë¡œ ì¿¼ë¦¬í•´ì„œ ì–»ì–´ì§€ëŠ” labelë“¤ ì¤‘ <code class="language-plaintext highlighter-rouge">pod</code>ê°’ì„ ì·¨í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_19.png" alt="img.png" class="image-center" /></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Cilium Operator ëŒ€ì‹œë³´ë“œ : IPAM ê´€ë ¨ ë©”íŠ¸ë¦­ì„ ì£¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. IPAMì€ IP ì£¼ì†Œ ê´€ë¦¬(IP Address Management)ë¡œ, Ciliumì—ì„œ IP ì£¼ì†Œë¥¼ í• ë‹¹í•˜ê³  ê´€ë¦¬í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</li>
  <li>Hubble ëŒ€ì‹œë³´ë“œ : General Processing, Network, Network Policy, HTTP, DNS ê´€ë ¨ ë©”íŠ¸ë¦­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>Hubble L7 HTTP Metrics by Workload ëŒ€ì‹œë³´ë“œ : HTTP ìš”ì²­ ë° ì‘ë‹µì— ëŒ€í•œ ë©”íŠ¸ë¦­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_20.png" alt="img.png" /></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="monitoring--metrics">Monitoring &amp; Metrics</h2>

<h3 id="cilium-metrics-ì„¤ì •-ë°-ìˆ˜ì§‘-ë°©ë²•">Cilium Metrics ì„¤ì • ë° ìˆ˜ì§‘ ë°©ë²•</h3>

<p><a href="https://docs.cilium.io/en/stable/observability/metrics/#cilium-metrics">Docs</a></p>

<ul>
  <li>Cilium MetricsëŠ” Cilium ìì²´ì˜ ìƒíƒœ, ì¦‰ Cilium Agent, Cilium Envoy, Cilium Operator í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ê³  ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>Prometheusì—ì„œ ìˆ˜ì§‘í•  ìˆ˜ ìˆë„ë¡ í•˜ë ¤ë©´ <code class="language-plaintext highlighter-rouge">prometheus.enabled=true</code>ë¡œ ì„¤ì •í•´ì„œ helm chartë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>Cilium MetricsëŠ” <code class="language-plaintext highlighter-rouge">cilium_</code>ë¼ëŠ” ì ‘ë‘ì‚¬ë¥¼ ê°€ì§„ ë©”íŠ¸ë¦­ì„ Prometheusì— ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>Envoy MetricsëŠ” <code class="language-plaintext highlighter-rouge">envoy_</code>ë¼ëŠ” ì ‘ë‘ì‚¬ë¥¼ ê°€ì§„ ë©”íŠ¸ë¦­ì„ Prometheusì— ì œê³µí•˜ë©°, Ciliumì´ ì •ì˜í•œ ë©”íŠ¸ë¦­ì€ <code class="language-plaintext highlighter-rouge">cilium_envoy_</code>ë¼ëŠ” ì ‘ë‘ì‚¬ë¥¼ ê°€ì§‘ë‹ˆë‹¤.</li>
  <li>Kubernetesì—ì„œ ì‹¤í–‰ ë° ìˆ˜ì§‘ë ë•Œ pod ì´ë¦„ê³¼ namespaceë¥¼ í¬í•¨í•œ ë ˆì´ë¸”ì„ ì¶”ê°€í•©ë‹ˆë‹¤.</li>
  <li>ì„¤ì • ë°©ë²• (ë³¸ ì‹¤ìŠµì—ì„œëŠ” ì´ë¯¸ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.)
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> 1.17.6 <span class="se">\</span>
  <span class="nt">--namespace</span> kube-system <span class="se">\</span>
  <span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span>

  <span class="c"># The ports can be configured via prometheus.port, envoy.prometheus.port, or operator.prometheus.port respectively.</span>
  <span class="nt">--set</span> prometheus.port
  <span class="nt">--set</span> envoy.prometheus.port
  <span class="nt">--set</span> operator.prometheus.port
  ...
</code></pre></div>    </div>
  </li>
  <li>Metricì´ í™œì„±í™”ë˜ë©´ ëª¨ë“  Cilium êµ¬ì„±ìš”ì†Œì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ annotationì´ í‘œì‹œë©ë‹ˆë‹¤. annotationì€ Prometheusê°€ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í• ì§€ ì—¬ë¶€ë¥¼ ì•Œë¦¬ëŠ”ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium-agent ë°ëª¬ì…‹ íŒŒë“œ</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium | <span class="nb">grep </span>prometheus
<span class="c"># =&gt;                       prometheus.io/port: 9962</span>
<span class="c">#                          prometheus.io/scrape: true</span>
  
<span class="nv">$ </span>curl 192.168.10.100:9962/metrics
<span class="c"># =&gt; # HELP cilium_agent_api_process_time_seconds Duration of processed API calls labeled by path, method and return code.</span>
<span class="c">#    # TYPE cilium_agent_api_process_time_seconds histogram</span>
<span class="c">#    cilium_agent_api_process_time_seconds_bucket{method="DELETE",path="/v1/endpoint",return_code="404",le="0.005"} 3</span>
<span class="c">#    cilium_agent_api_process_time_seconds_bucket{method="DELETE",path="/v1/endpoint",return_code="404",le="0.01"} 3</span>
<span class="c">#    cilium_agent_api_process_time_seconds_bucket{method="DELETE",path="/v1/endpoint",return_code="404",le="0.025"} 3</span>
<span class="c">#    ...</span>
  
<span class="c"># cilium-operator ë””í”Œë¡œì´ë¨¼íŠ¸ íŒŒë“œ </span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> <span class="nv">name</span><span class="o">=</span>cilium-operator | <span class="nb">grep </span>prometheus
<span class="c"># =&gt; Annotations:          prometheus.io/port: 9963</span>
<span class="c">#                          prometheus.io/scrape: true</span>
  
<span class="nv">$ </span>curl 192.168.10.100:9963/metrics
<span class="c"># =&gt; # HELP certwatcher_read_certificate_errors_total Total number of certificate read errors</span>
<span class="c">#    # TYPE certwatcher_read_certificate_errors_total counter</span>
<span class="c">#    certwatcher_read_certificate_errors_total 0</span>
<span class="c">#    # HELP certwatcher_read_certificate_total Total number of certificate reads</span>
<span class="c">#    # TYPE certwatcher_read_certificate_total counter</span>
<span class="c">#    certwatcher_read_certificate_total 0</span>
<span class="c">#    ...</span>
</code></pre></div>    </div>
  </li>
  <li>PrometheusëŠ”  ë‹¤ìŒì˜ scrape_configs ì„¹ì…˜ì˜ ì„¤ì •ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™ìœ¼ë¡œ Ciliumê³¼ Envoyì˜ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring prometheus
<span class="c"># =&gt; prometheus.yaml:</span>
<span class="c">#    ...</span>
<span class="c">#    scrape_configs:</span>
<span class="c">#      ...    </span>
<span class="c">#      # https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L156</span>
<span class="c">#      - job_name: 'kubernetes-pods'</span>
<span class="c">#        kubernetes_sd_configs:</span>
<span class="c">#          - role: pod</span>
<span class="c">#        relabel_configs:</span>
<span class="c">#          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span>
<span class="c">#            action: keep</span>
<span class="c">#            regex: true</span>
<span class="c">#          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: __metrics_path__</span>
<span class="c">#            regex: (.+)</span>
<span class="c">#          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span>
<span class="c">#            action: replace</span>
<span class="c">#            regex: (.+):(?:\d+);(\d+)</span>
<span class="c">#            replacement: ${1}:${2}</span>
<span class="c">#            target_label: __address__</span>
<span class="c">#          - action: labelmap</span>
<span class="c">#            regex: __meta_kubernetes_pod_label_(.+)</span>
<span class="c">#          - source_labels: [__meta_kubernetes_namespace]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: namespace</span>
<span class="c">#          - source_labels: [__meta_kubernetes_pod_name]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: pod</span>
<span class="c">#          - source_labels: [__meta_kubernetes_pod_container_port_number]</span>
<span class="c">#            action: keep</span>
<span class="c">#            regex: \d+</span>
<span class="c">#    ...</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_21.png" alt="img.png" /></p>

<h3 id="hubble-metrics-ì„¤ì •-ë°-ìˆ˜ì§‘-ë°©ë²•">Hubble Metrics ì„¤ì • ë° ìˆ˜ì§‘ ë°©ë²•</h3>

<p><a href="https://docs.cilium.io/en/stable/observability/metrics/#hubble-metrics">Docs</a></p>

<ul>
  <li>Cilium Metricì€ Ciliumì˜ ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§ í•  ìˆ˜ ìˆê²Œ í•´ì£¼ì§€ë§Œ, Hubble Metricì€ Ciliumì´ ê´€ë¦¬í•˜ëŠ” Kubernetes podì˜ ë„¤íŠ¸ì›Œí¬ ë™ì‘ì„ ì—°ê²°ê³¼ ë³´ì•ˆê³¼ ê´€ë ¨í•˜ì—¬ ëª¨ë‹ˆí„°ë§ í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.</li>
  <li>ì„¤ì •ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. (ì‹¤ìŠµí™˜ê²½ì—ì„œëŠ” ì´ë¯¸ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.)
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> 1.17.6 <span class="se">\</span>
<span class="nt">--namespace</span> kube-system <span class="se">\</span>
<span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span>
<span class="nt">--set</span> hubble.metrics.port
</code></pre></div>    </div>
  </li>
  <li>L7 ë©”íŠ¸ë¦­ì€ L7 ê°€ì‹œì„± í™œì„±í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">hubble.metrics.enabled</code> ì„¤ì •ì€ Hubbleì—ì„œ ìˆ˜ì§‘í•  ë©”íŠ¸ë¦­ì„ ì§€ì •í•©ë‹ˆë‹¤.
    <ul>
      <li>ì˜ˆë¥¼ ë“¤ì–´, <code class="language-plaintext highlighter-rouge">hubble.metrics.enabled</code> ê°’ì„ Helm ì± íŠ¸ valueì— ì„¤ì •í•˜ë©´, Cilium ì± íŠ¸ëŠ” <code class="language-plaintext highlighter-rouge">hubble-metrics</code>ë¼ëŠ” í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
      <li>ì´ ì„œë¹„ìŠ¤ëŠ” <code class="language-plaintext highlighter-rouge">prometheus.io/scrape:'true'</code> annotationì„ ê°–ê³  ìˆì–´ Prometheusì˜ ëŒ€ìƒì´ ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># hubble-metrics í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> kube-system hubble-metrics
<span class="c"># =&gt; NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    hubble-metrics   ClusterIP   None         &lt;none&gt;        9965/TCP   2d</span>
<span class="nv">$ </span>kc describe svc <span class="nt">-n</span> kube-system hubble-metrics
<span class="c"># =&gt; Annotations:              meta.helm.sh/release-name: cilium</span>
<span class="c">#                              meta.helm.sh/release-namespace: kube-system</span>
<span class="c">#                              prometheus.io/port: 9965</span>
<span class="c">#                              prometheus.io/scrape: true</span>
<span class="c">#    ...</span>
<span class="c">#    Endpoints:                192.168.10.102:9965,192.168.10.100:9965,192.168.10.101:9965</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>curl 192.168.10.100:9965/metrics
<span class="c"># =&gt; # HELP grpc_server_handled_total Total number of RPCs completed on the server, regardless of success or failure.</span>
<span class="c">#    # TYPE grpc_server_handled_total counter</span>
<span class="c">#    grpc_server_handled_total{grpc_code="Aborted",grpc_method="Check",grpc_service="grpc.health.v1.Health",grpc_type="unary"} 0</span>
<span class="c">#    grpc_server_handled_total{grpc_code="Aborted",grpc_method="GetAgentEvents",grpc_service="observer.Observer",grpc_type="server_stream"} 0</span>
<span class="c">#    grpc_server_handled_total{grpc_code="Aborted",grpc_method="GetDebugEvents",grpc_service="observer.Observer",grpc_type="server_stream"} 0</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring prometheus
<span class="c"># =&gt; prometheus.yaml:</span>
<span class="c">#    ...</span>
<span class="c">#    scrape_configs:</span>
<span class="c">#      # https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L79</span>
<span class="c">#      - job_name: 'kubernetes-endpoints'</span>
<span class="c">#        kubernetes_sd_configs:</span>
<span class="c">#          - role: endpoints</span>
<span class="c">#        relabel_configs:</span>
<span class="c">#          - source_labels: [__meta_kubernetes_pod_label_k8s_app]</span>
<span class="c">#            action: keep</span>
<span class="c">#            regex: cilium</span>
<span class="c">#          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span>
<span class="c">#            action: keep</span>
<span class="c">#            regex: true</span>
<span class="c">#          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: __scheme__</span>
<span class="c">#            regex: (https?)</span>
<span class="c">#          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: __metrics_path__</span>
<span class="c">#            regex: (.+)</span>
<span class="c">#          - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: __address__</span>
<span class="c">#            regex: (.+)(?::\d+);(\d+)</span>
<span class="c">#            replacement: $1:$2</span>
<span class="c">#          - action: labelmap</span>
<span class="c">#            regex: __meta_kubernetes_service_label_(.+)</span>
<span class="c">#          - source_labels: [__meta_kubernetes_namespace]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: namespace</span>
<span class="c">#          - source_labels: [__meta_kubernetes_service_name]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: service</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_22.png" alt="img.png" /></p>

<h2 id="layer-7-protocol-visibility">Layer 7 Protocol Visibility</h2>

<ul>
  <li>Monitoring Datapath StateëŠ” ê¸°ë³¸ì ìœ¼ë¡œ L3/L4 íŒ¨í‚·ì— ëŒ€í•œ ê°€ì‹œì„±ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>HTTPë‚˜ DNSê°™ì€ L7 í”„ë¡œí† ì½œì— ëŒ€í•œ ê°€ì‹œì„±ì„ ì œê³µí•˜ê¸° ìœ„í•´ì„œëŠ” L7 í”„ë¡œí† ì½œ ê°€ì‹œì„±ì„ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>L7 íŠ¸ë˜í”½ì— ëŒ€í•œ ê°€ì‹œì„±ì„ í™œì„±í™” í•˜ë ¤ë©´ L7 ê·œì¹™ì„ ì§€ì •í•˜ëŠ” CiliumNetworkPolicyë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>CiliumNetworkPolicyëŠ” L7 ê·œì¹™ê³¼ ì¼ì¹˜í•˜ëŠ” íŠ¸ë˜í”½ì˜ íë¦„ì´ Ciliumì— í‘œì‹œë˜ë¯€ë¡œ ìµœì¢…ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>L7 ë„¤íŠ¸ì›Œí¬ ì •ì±…ì€ ê°€ì‹œì„±ì„ ê°€ëŠ¥í•˜ê²Œ í•  ë¿ë§Œ ì•„ë‹ˆë¼ podì— ë“¤ì–´ê°€ê³  ë‚˜ê°€ëŠ” íŠ¸ë˜í”½ì„ ì œì–´í•  ìˆ˜ ìˆìŒì„ ê¸°ì–µí•´ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<h3 id="ì‹¤ìŠµ">ì‹¤ìŠµ</h3>

<ul>
  <li>ë‹¤ìŒ ì˜ˆì œëŠ” DNS(TCP/UDP/53) ë° HTTP(TCP/80 ë° TCP/8080) íŠ¸ë˜í”½ì„ ê¸°ë³¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì— í‘œì‹œí•  ìˆ˜ ìˆë„ë¡ L7 ê·œì¹™ì„ ì§€ì •í•©ë‹ˆë‹¤.</li>
  <li>í•˜ë‚˜ëŠ” DNS ê·œì¹™ê³¼ í•˜ë‚˜ëŠ” HTTP ê·œì¹™ì„ ì œê³µí•˜ë©°, í•œ ì¶œë ¥ í†µì‹ ì„ ì œì™¸í•˜ê³  ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ëª¨ë“ ê²ƒì„ ì‚­ì œí•©ë‹ˆë‹¤.</li>
  <li>ê·œì¹™ì´ L7 ì¼ì¹˜ ì¡°ê±´ì´ ìƒëµë˜ê±°ë‚˜ ì™€ì¼ë“œì¹´ë“œ ì²˜ë¦¬ë˜ë©´ L4 ì„¹ì…˜ê³¼ ì¼ì¹˜í•˜ëŠ” ëª¨ë“  ìš”ì²­ì´ í—ˆìš©ë©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°˜ë³µ ì ‘ì† í•´ë‘” ìƒíƒœ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s webpod | grep Hostname; sleep 1; done'</span>

<span class="c"># default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìˆëŠ” Podë“¤ì˜ egress(ì¶œë°©í–¥) íŠ¸ë˜í”½ì„ ì œì–´í•˜ë©°, L7 HTTP ë° DNS íŠ¸ë˜í”½ì— ëŒ€í•œ ê°€ì‹œì„±ê³¼ ì œì–´ë¥¼ ì„¤ì •</span>
<span class="c">## method/path ê¸°ë°˜ í•„í„°ë§ì€ ì•ˆ í•˜ì§€ë§Œ, HTTP ìš”ì²­ ì •ë³´ëŠ” Envoyë¥¼ í†µí•´ ê¸°ë¡/ê´€ì°°ë¨</span>
<span class="c">## cilium-envoyë¥¼ ê²½ìœ í•˜ê²Œ ë¨ (DNS + HTTP ëª¨ë‘ L7 ì²˜ë¦¬ ëŒ€ìƒ)</span>
<span class="c">## ì´ ì •ì±…ì´ ì ìš©ë˜ë©´, ëª…ì‹œëœ egress ì™¸ì˜ ëª¨ë“  egress íŠ¸ë˜í”½ì€ ì°¨ë‹¨ë©ë‹ˆë‹¤ (Cilium ì •ì±…ì€ default-deny ëª¨ë¸ì„)</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "l7-visibility"
spec:
  endpointSelector:
    matchLabels:
      "k8s:io.kubernetes.pod.namespace": default  # default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì˜ ëª¨ë“  Podì— ëŒ€í•´ egress ì •ì±…ì´ ì ìš©
  egress:
  - toPorts:
    - ports:
      - port: "53"
        protocol: ANY  # TCP, UDP ë‘˜ ë‹¤ í—ˆìš©
      rules:
        dns:
        - matchPattern: "*"  # ëª¨ë“  ë„ë©”ì¸ ì¡°íšŒ í—ˆìš©, L7 ê°€ì‹œì„± í™œì„±í™”
  - toEndpoints:
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": default
    toPorts:
    - ports:
      - port: "80"  # default ë‹¤ë¥¸ íŒŒë“œì˜ HTTP TCP 80 ìš”ì²­ í—ˆìš©
        protocol: TCP
      - port: "8080"  # default ë‹¤ë¥¸ íŒŒë“œì˜ HTTP TCP 8080 ìš”ì²­ í—ˆìš©
        protocol: TCP
      rules:
        http: [{}]  # ëª¨ë“  HTTP ìš”ì²­ì„ í—ˆìš©, L7 ê°€ì‹œì„± í™œì„±í™”
</span><span class="no">EOF

</span><span class="nv">$ </span>kubectl get cnp <span class="nt">-o</span> yaml
<span class="c"># =&gt;   kind: CiliumNetworkPolicy</span>
<span class="c">#      ...</span>
<span class="c">#      spec:</span>
<span class="c">#        egress:</span>
<span class="c">#        - toPorts:</span>
<span class="c">#          - ports:</span>
<span class="c">#            - port: "53"</span>
<span class="c">#              protocol: ANY</span>
<span class="c">#            rules:</span>
<span class="c">#              dns:</span>
<span class="c">#              - matchPattern: '*'</span>
<span class="c">#        - toEndpoints:</span>
<span class="c">#          - matchLabels:</span>
<span class="c">#              k8s:io.kubernetes.pod.namespace: default</span>
<span class="c">#          toPorts:</span>
<span class="c">#          - ports:</span>
<span class="c">#            - port: "80"</span>
<span class="c">#              protocol: TCP</span>
<span class="c">#            - port: "8080"</span>
<span class="c">#              protocol: TCP</span>
<span class="c">#            rules:</span>
<span class="c">#              http:</span>
<span class="c">#              - {}</span>
<span class="c">#        endpointSelector:</span>
<span class="c">#          matchLabels:</span>
<span class="c">#            k8s:io.kubernetes.pod.namespace: default</span>
<span class="c">#      ...</span>

<span class="c"># í˜¸ì¶œ í™•ì¸ : cilium-envoy ê²½ìœ  í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> webpod
<span class="c"># =&gt; Hostname: webpod-697b545f57-mvz92</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.2.101</span>
<span class="c">#    IP: fe80::68c6:baff:fe2c:766b</span>
<span class="c">#    &lt;span style="color: green;"&gt;RemoteAddr: 172.20.0.43:39216&lt;/span&gt; # í•´ë‹¹ IPëŠ” curl-pod ì˜ IPë¡œ cilium-envoy IPë¡œ SNAT ë˜ì§€ ì•Šì•˜ìŒ!</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: webpod</span>
<span class="c">#    User-Agent: curl/8.14.1</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    &lt;span style="color: green;"&gt;X-Envoy-Expected-Rq-Timeout-Ms: 3600000&lt;/span&gt;   # cilium-envoy ê²½ìœ  í™•ì¸</span>
<span class="c">#    &lt;span style="color: green;"&gt;X-Envoy-Internal: true&lt;/span&gt;</span>
<span class="c">#    X-Forwarded-Proto: http</span>
<span class="c">#    X-Request-Id: 913dbacf-5559-4d13-8855-afaa41979f4e</span>

<span class="c"># ê°€ì‹œì„± í™•ì¸</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">-t</span> l7 <span class="nt">-o</span> compact
<span class="c"># =&gt; Jul 26 14:58:47.953: default/curl-pod:34773 (ID:472) -&gt; kube-system/coredns-674b8bbfcf-7m82r:53 (ID:30923) dns-request proxy FORWARDED (DNS Query webpod.default.svc.cluster.local. AAAA)</span>
<span class="c">#    Jul 26 14:58:47.953: default/curl-pod:34773 (ID:472) -&gt; kube-system/coredns-674b8bbfcf-7m82r:53 (ID:30923) dns-request proxy FORWARDED (DNS Query webpod.default.svc.cluster.local. A)</span>
<span class="c">#    Jul 26 14:58:47.954: default/curl-pod:34773 (ID:472) &lt;- kube-system/coredns-674b8bbfcf-7m82r:53 (ID:30923) dns-response proxy FORWARDED (DNS Answer "10.96.147.79" TTL: 30 (Proxy webpod.default.svc.cluster.local. A))</span>
<span class="c">#    Jul 26 14:58:47.956: default/curl-pod:34773 (ID:472) &lt;- kube-system/coredns-674b8bbfcf-7m82r:53 (ID:30923) dns-response proxy FORWARDED (DNS Answer  TTL: 4294967295 (Proxy webpod.default.svc.cluster.local. AAAA))</span>
<span class="c">#    Jul 26 14:58:47.961: default/curl-pod:52022 (ID:472) -&gt; default/webpod-697b545f57-mvz92:80 (ID:18655) http-request FORWARDED (HTTP/1.1 GET http://webpod/)</span>
<span class="c">#    Jul 26 14:58:47.967: default/curl-pod:52022 (ID:472) &lt;- default/webpod-697b545f57-mvz92:80 (ID:18655) http-response FORWARDED (HTTP/1.1 200 5ms (GET http://webpod/))</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>Grafanaì—ì„œ L7 HTTP Metrics by Workload ëŒ€ì‹œë³´ë“œë¥¼ í™•ì¸í•´ë³´ë©´, HTTP ìš”ì²­ ë° ì‘ë‹µì— ëŒ€í•œ ë©”íŠ¸ë¦­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_23.png" alt="img.png" class="image-center" />
    <ul>
      <li>ì´ë•Œ í˜„ì¬ labelì—ëŠ” destination_workloadê°€ í¬í•¨ë˜ì–´ìˆì§€ ì•Šì•„ì„œ ë©”íŠ¸ë¦­ì´ ë‚˜íƒ€ë‚˜ì§€ ì•ŠëŠ”ë° Destination Workloadë¥¼ ì„ì‹œë¡œ <code class="language-plaintext highlighter-rouge">.*</code> (ì •ê·œí‘œí˜„ì‹ì—ì„œ ì™€ì¼ë“œ ì¹´ë“œ)ë¡œ í•˜ê±°ë‚˜ PromQLì—ì„œ í•´ë‹¹ ë¶€ë¶„ì„ ì œì™¸í•˜ê±°ë‚˜ labelì— ì¶”ê°€í•˜ë©´ ë©”íŠ¸ë¦­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Prometheusì—ì„œë„ <code class="language-plaintext highlighter-rouge">rate(hubble_http_requests_total[5m])</code>ë¥¼ í†µí•´ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤. 
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_24.png" alt="img.png" /></li>
</ul>

<h3 id="security-implications-ë°-ì‹¤ìŠµ">Security Implications ë° ì‹¤ìŠµ</h3>

<p><a href="https://docs.cilium.io/en/stable/observability/visibility/#security-implications">Docs</a></p>

<ul>
  <li>L7 íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ì€ <strong>ì‚¬ìš©ì ì´ë¦„, ë¹„ë°€ë²ˆí˜¸, ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜, API í‚¤</strong> ë“± ì ì¬ì ìœ¼ë¡œ ë¯¼ê°í•œ ì •ë³´ë¥¼ í¬í•¨í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë³´ì•ˆì— ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>ê¸°ë³¸ì ìœ¼ë¡œ Hubbleì€ L7 íŠ¸ë˜í”½ì˜ ë¯¼ê° ì •ë³´ë¥¼ í•„í„°ë§í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
  <li>ê°„ë‹¨í•œ ì‹¤ìŠµì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">-t</span> l7
<span class="c"># =&gt; Jul 26 15:50:11.494: default/curl-pod:49308 (ID:472) -&gt; default/webpod-697b545f57-mvz92:80 (ID:18655) http-request FORWARDED (HTTP/1.1 GET http://webpod/?user_id=1234)</span>
<span class="c">#    Jul 26 15:50:11.499: default/curl-pod:49308 (ID:472) &lt;- default/webpod-697b545f57-mvz92:80 (ID:18655) http-response FORWARDED (HTTP/1.1 200 5ms (GET http://webpod/?user_id=1234))</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì•„ë˜ì˜ curl ëª…ë ¹ìœ¼ë¡œ ë³´ë‚¸ user_idê°€ ê·¸ëŒ€ë¡œ ë³´ì´ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
  
<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'curl -s webpod/?user_id=1234'</span>
  
<span class="c"># ë¯¼ê°ì •ë³´ ë¯¸ì¶œë ¥ ì„¤ì •</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">extraArgs</span><span class="o">=</span><span class="s2">"{--hubble-redact-enabled,--hubble-redact-http-urlquery}"</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    NAME: cilium</span>
<span class="c">#    LAST DEPLOYED: Sun Jul 27 00:51:08 2025</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 10</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    You have successfully installed Cilium with Hubble Relay and Hubble UI.</span>
<span class="c">#    </span>
<span class="c">#    Your release version is 1.17.6.</span>
  
<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'curl -s webpod/?user_id=1234'</span>
  
<span class="c">#</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">-t</span> l7
<span class="c"># =&gt; Jul 26 15:51:49.594: default/curl-pod:53276 (ID:472) -&gt; default/webpod-697b545f57-ns4sw:80 (ID:18655) http-request FORWARDED (HTTP/1.1 GET http://webpod/)</span>
<span class="c">#    Jul 26 15:51:49.601: default/curl-pod:53276 (ID:472) &lt;- default/webpod-697b545f57-ns4sw:80 (ID:18655) http-response FORWARDED (HTTP/1.1 200 9ms (GET http://webpod/))</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë¯¼ê°ì •ë³´ê°€ í•„í„°ë§ ëœê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>ë³´ì•ˆì„ ê°•í™”í•˜ê¸° ìœ„í•´ Ciliumì€ í—ˆë¸”ì´ ë ˆì´ì–´ 7 íë¦„ì— ì¡´ì¬í•˜ëŠ” ë¯¼ê°í•œ ì •ë³´ë¥¼ ì²˜ë¦¬(ì œê±°ë‚˜ ë§ˆìŠ¤í‚¹)í•  ìˆ˜ ìˆë„ë¡ <code class="language-plaintext highlighter-rouge">--hubble-redact-enabled</code> ì˜µì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.
    <ul>
      <li>HTTPì—ì„œ URL ì¿¼ë¦¬ íŒŒë¼ë©”í„°(GET)ì„ í•„í„°ë§ í•˜ê¸°ìœ„í•´ <code class="language-plaintext highlighter-rouge">--hubble-redact-http-urlquery</code>ë¥¼ ì‚¬ìš© =&gt; URLì˜ <code class="language-plaintext highlighter-rouge">?query=value</code> ì œê±°
        <ul>
          <li>ì˜ˆì‹œ) ì„¤ì • ì „
            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"method"</span>: <span class="s2">"GET"</span>,
<span class="s2">"url"</span>: <span class="s2">"/user/profile?user_id=1234&amp;token=abcd1234"</span>,
<span class="s2">"status"</span>: 200
</code></pre></div>            </div>
          </li>
          <li>ì˜ˆì‹œ) ì„¤ì • í›„ : <code class="language-plaintext highlighter-rouge">--set extraArgs="{--hubble-redact-http-urlquery}â€</code>
            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"method"</span>: <span class="s2">"GET"</span>,
<span class="s2">"url"</span>: <span class="s2">"/user/profile"</span>, <span class="c"># ì¿¼ë¦¬ ë¬¸ìì—´ì´ ì œê±°ë˜ì–´ ì¶œë ¥, ë¯¼ê° ì •ë³´ ë³´í˜¸ë¨</span>
<span class="s2">"status"</span>: 200
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>HTTPì—ì„œ ì‚¬ìš©ìì •ë³´ (basic authì˜ ì•„ì´ë”” ë¹„ë°€ë²ˆí˜¸) ë“±ì„ í•„í„°ë§í•˜ê¸°ìœ„í•´ <code class="language-plaintext highlighter-rouge">--hubble-redact-http-userinfo</code>ë¥¼ ì‚¬ìš© =&gt; URLì˜ <code class="language-plaintext highlighter-rouge">user:pass@</code> ì œê±°</li>
      <li>Kafkaì—ì„œ API í‚¤ë¥¼ í•„í„°ë§í•˜ë ¤ë©´ <code class="language-plaintext highlighter-rouge">--hubble-redact-kafka-apikey</code> ì‚¬ìš©</li>
      <li>HTTP í—¤ë”ë¥¼ í•„í„°ë§í•˜ê¸° ìœ„í•´ì„œëŠ” í—ˆìš©ë¦¬ìŠ¤íŠ¸(<code class="language-plaintext highlighter-rouge">--hubble-redact-http-headers-allow</code>) ë˜ëŠ” ê±°ë¶€ë¦¬ìŠ¤íŠ¸ (<code class="language-plaintext highlighter-rouge">--hubble-redact-http-headers-deny</code>)ë¥¼ ì‚¬ìš©</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="pwru-packet-where-are-you">pwru (Packet where are you)</h2>

<ul>
  <li>pwruëŠ” eBPF ê¸°ë°˜ì˜ linux ì»¤ë„ ë””ë²„ê±°ì…ë‹ˆë‹¤. <a href="https://github.com/cilium/pwru">https://github.com/cilium/pwru</a></li>
  <li>ì£¼ìš” íŠ¹ì§•
    <ul>
      <li>eBPF ê¸°ë°˜ ë„¤íŠ¸ì›Œí¬ íŠ¸ë ˆì´ì‹± íˆ´ë¡œ, ì»¤ë„ íŒ¨í‚· ê²½ë¡œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.</li>
      <li>ê³ ê¸‰ í•„í„°ë§ ê¸°ëŠ¥ì„ ì œê³µí•˜ì—¬, ê´€ì‹¬ ìˆëŠ” íŒ¨í‚·ë§Œ ê³¨ë¼ì„œ ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
      <li>ë„¤íŠ¸ì›Œí¬ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…, ì¦‰ íŒ¨í‚· ì†ì‹¤ ë° ì²˜ë¦¬ ìœ„ì¹˜ íŒŒì•…, ë‹¤ì–‘í•œ ì»¤ë„ ëª¨ë“ˆê³¼ì˜ ìƒí˜¸ì‘ìš© ë“±ì„ ì´í•´í•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤.</li>
      <li>ì»¤ë§¨ë“œë¼ì¸ì—ì„œ ë‹¤ì–‘í•œ ì˜µì…˜ê³¼ PCAP í•„í„°ë¥¼ ì ìš©í•´ì„œ ìƒì„¸ ë¶„ì„ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="pwru-ì„¤ì¹˜-ë°-ì‹¤í–‰">pwru ì„¤ì¹˜ ë° ì‹¤í–‰</h3>

<ul>
  <li><a href="https://medium.com/@Nikhil690/debugging-packet-drops-and-kernel-flows-with-pwru-fc03f3d479a4">PWRU: Debugging Packets and Kernel Flows</a>ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹¤í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Prerequisites</span>
<span class="nv">$ </span><span class="nb">sudo </span>apt update
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> clang llvm gcc make flex bison byacc yacc libpcap-dev golang

<span class="c"># Building PWRU from Source</span>
<span class="c">## Clone the PWRU GitHub repository</span>
<span class="nv">$ </span>git clone https://github.com/cilium/pwru.git
<span class="c"># =&gt; Cloning into 'pwru'...</span>
<span class="c">#    remote: Enumerating objects: 7681, done.</span>
<span class="c">#    remote: Counting objects: 100% (211/211), done.</span>
<span class="c">#    remote: Compressing objects: 100% (127/127), done.</span>
<span class="c">#    remote: Total 7681 (delta 117), reused 94 (delta 83), pack-reused 7470 (from 3)</span>
<span class="c">#    Receiving objects: 100% (7681/7681), 9.40 MiB | 18.12 MiB/s, done.</span>
<span class="c">#    Resolving deltas: 100% (4723/4723), done.</span>

<span class="c">## Navigate to the project directory</span>
<span class="nv">$ </span><span class="nb">cd </span>pwru

<span class="c">## Build the project : Compile the eBPF object files, Build the userspace Go application, Link everything together</span>
<span class="nv">$ </span>make
<span class="c"># =&gt; ...</span>
<span class="c">#    TARGET_GOARCH=&lt;span style="color: green;"&gt;amd64&lt;/span&gt; go generate</span>
<span class="c">#    Generating for &lt;span style="color: green;"&gt;amd64&lt;/span&gt;</span>
<span class="c">#    CC=cc GOARCH=&lt;span style="color: green;"&gt;amd64&lt;/span&gt; CGO_ENABLED=1 go build  \</span>
<span class="c">#            -ldflags "-w -s \</span>
<span class="c">#            -X 'github.com/cilium/pwru/internal/pwru.Version=v1.0.10-pre-110-gbd7ffd8'"</span>
<span class="c">#    # runtime/cgo</span>
<span class="c">#    &lt;span style="background-color: red; color: #fff;"&gt;cc: error: unrecognized command-line option '-m64'&lt;/span&gt;</span>
<span class="c">#    make: *** [Makefile:22: pwru] Error 1</span>
</code></pre></div></div>

<ul>
  <li>M1 Macì—ì„œ ë¹Œë“œí•  ë•ŒëŠ” <code class="language-plaintext highlighter-rouge">-m64</code> ì˜µì…˜ì´ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¤ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ë¹Œë“œ-íŠ¸ëŸ¬ë¸”ìŠˆíŒ…-ë°-ì‹¤í–‰">ë¹Œë“œ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ë° ì‹¤í–‰</h3>

<ul>
  <li>ë¹Œë“œ ë¡œê·¸ë¥¼ ë´¤ì„ë•Œ ìê¾¸ amd64ë¡œ ë¹Œë“œí•˜ë ¤ê³  í•˜ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
<span class="c"># =&gt; Linux k8s-ctr 6.8.0-53-generic #55-Ubuntu SMP PREEMPT_DYNAMIC Fri Jan 17 15:02:14 UTC 2025 &lt;span style="color: green;"&gt;aarch64 aarch64 aarch64&lt;/span&gt; GNU/Linux</span>
</code></pre></div></div>

<ul>
  <li>í•˜ì§€ë§Œ ì œ í™˜ê²½ì€ aarch64ìœ¼ë¡œ ë­”ê¸° ë¹Œë“œ ì„¤ì •ì´ ì˜ëª»ëœê²ƒ ê°™ìŠµë‹ˆë‹¤. ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìˆ˜ì •í•˜ê³  PRì„ ì˜¬ë¦¬ë©´ ì¢‹ê² ì§€ë§Œ ì‹œê°„ì´ ì—†ìœ¼ë¯€ë¡œ arm64ë¡œ ê°•ì œë¡œ ë¹Œë“œí•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># (ê¸°ì¡´) TARGET_GOARCH=amd64 go generate</span>
<span class="nv">$ TARGET_GOARCH</span><span class="o">=</span>arm64 go generate
<span class="c"># =&gt; Generating for arm64</span>

<span class="c"># (ê¸°ì¡´) CC=cc GOARCH=amd64 CGO_ENABLED=1 go build  \</span>
<span class="c">#         -ldflags "-w -s \</span>
<span class="c">#         -X 'github.com/cilium/pwru/internal/pwru.Version=v1.0.10-pre-110-gbd7ffd8'"</span>
<span class="nv">$ CC</span><span class="o">=</span>cc <span class="nv">GOARCH</span><span class="o">=</span>arm64 <span class="nv">CGO_ENABLED</span><span class="o">=</span>1 go build  <span class="se">\</span>
        <span class="nt">-ldflags</span> <span class="s2">"-w -s </span><span class="se">\</span><span class="s2">
        -X 'github.com/cilium/pwru/internal/pwru.Version=v1.0.10-pre-110-gbd7ffd8'"</span>
<span class="c"># =&gt; # github.com/cilium/pwru</span>
<span class="c">#    /usr/bin/ld: /tmp/go-link-4205941405/000020.o: in function `_cgo_77133bf98b3a_C2func_getaddrinfo':</span>
<span class="c">#    /tmp/go-build/cgo_unix_cgo.cgo2.c:60:(.text+0x30): warning: Using 'getaddrinfo' in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span>
<span class="c">#    /usr/bin/ld: /root/pwru/internal/libpcap/../../libpcap/libpcap.a(nametoaddr.o): in function `pcap_nametoaddr':</span>
<span class="c">#    /root/pwru/libpcap/./nametoaddr.c:181:(.text+0x8): warning: Using 'gethostbyname' in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span>
<span class="c">#    /usr/bin/ld: /root/pwru/internal/libpcap/../../libpcap/libpcap.a(nametoaddr.o): in function `pcap_nametonetaddr':</span>
<span class="c">#    /root/pwru/libpcap/./nametoaddr.c:270:(.text+0x104): warning: Using 'getnetbyname_r' in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span>
<span class="c">#    /usr/bin/ld: /root/pwru/internal/libpcap/../../libpcap/libpcap.a(nametoaddr.o): in function `pcap_nametoproto':</span>
<span class="c">#    /root/pwru/libpcap/./nametoaddr.c:527:(.text+0x4cc): warning: Using 'getprotobyname_r' in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ warningì´ ëœ¨ê¸´ í–ˆì§€ë§Œ ë¹Œë“œê°€ ëœê²ƒ ê°™ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> pwru
<span class="c"># =&gt; -rwxr-xr-x 1 root root 8561904 Jul 27 00:39 pwru</span>
</code></pre></div></div>

<ul>
  <li>ë¹Œë“œê°€ ì™„ë£Œë˜ë©´ <code class="language-plaintext highlighter-rouge">pwru</code> ì‹¤í–‰íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤. ì´ íŒŒì¼ì„ ì‹¤í–‰í•˜ë©´ PWRUë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë¦¬ëˆ…ìŠ¤ ì»¤ë„ê³¼ eBPF ì„œë¸Œì‹œìŠ¤í…œì— ì§ì ‘ ìƒí˜¸ì‘ìš©í•˜ê¸° ë•Œë¬¸ì— root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Running PWRU</span>
<span class="c">## Since PWRU interacts directly with kernel functions and eBPF subsystems, you need root permissions to run it:</span>
<span class="nv">$ </span><span class="nb">sudo</span> ./pwru <span class="o">[</span>options] <span class="o">[</span>pcap-filter]

<span class="c"># ICMP (ping) íŒ¨í‚·ì„ ì¶”ì í•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">sudo</span> ./pwru <span class="nt">--output-tuple</span> icmp
<span class="c"># =&gt; 2025/07/27 00:40:49 Attaching kprobes (via kprobe)...</span>
<span class="c">#    1669 / 1669 [--------------------------------------------------------] 100.00% 1455 p/s</span>
<span class="c">#    2025/07/27 00:40:50 Attached (ignored 5)</span>
<span class="c">#    2025/07/27 00:40:50 Listening for events..  # &lt;span style="color: green;"&gt;ğŸ‘‰ eBPF ì„¤ì¹˜í•˜ëŠ” ê³¼ì •ì´ ì¢…ë£Œë˜ê³  ì´ë²¤íŠ¸ë¥¼ listening í•˜ê³  ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#    SKB                CPU PROCESS          NETNS      MARK/x        IFACE       PROTO  MTU   LEN   TUPLE FUNC</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 0               0         0x0000 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     ip_send_skb</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 0               0         0x0000 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     __ip_local_out</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 0               0         0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     nf_hook_slow</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00             0         0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     ip_output</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     nf_hook_slow</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     apparmor_ip_postroute</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     ip_finish_output</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     __ip_finish_output</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     ip_finish_output2</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     __dev_queue_xmit</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     qdisc_pkt_len_init</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     netdev_core_pick_tx</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     dev_qdisc_enqueue</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     __skb_get_hash</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     sch_direct_xmit</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     validate_xmit_skb_list</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     validate_xmit_skb</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     netif_skb_features</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     skb_network_protocol</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     validate_xmit_xfrm</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     dev_hard_start_xmit</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     skb_clone_tx_timestamp</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     napi_consume_skb</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     skb_release_head_state</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     sock_wfree</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     skb_release_data</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     skb_free_head</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     napi_skb_cache_put</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 0             eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     inet_gro_receive</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 0             eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_defer_rx_timestamp</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 0             eth0:2      0x0800 1500  98    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_ensure_writable</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_rcv_core</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     nf_hook_slow</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     nf_ip_checksum</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     __skb_checksum_complete</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_route_input_noref</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_route_input_slow</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     fib_validate_source</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     __fib_validate_source</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_local_deliver</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     nf_hook_slow</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_local_deliver_finish</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_protocol_deliver_rcu</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     raw_local_deliver</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     raw_v4_input</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_clone</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     raw_rcv</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_push</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ipv4_pktinfo_prepare</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     sock_queue_rcv_skb_reason</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     sk_filter_trim_cap</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     security_sock_rcv_skb</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     apparmor_socket_sock_rcv_skb</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     __sock_queue_rcv_skb</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     icmp_rcv</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 56    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ping_rcv</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 56    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_push</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     kfree_skb_reason(SKB_DROP_REASON_NO_SOCKET)</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_release_head_state</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_release_data</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     kfree_skbmem</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     __sock_recv_cmsgs</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     __sock_recv_timestamp</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_free_datagram</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     consume_skb</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_release_head_state</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     sock_rfree</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_release_data</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_free_head</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     kfree_skbmem</span>

<span class="c"># ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ping ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 8.8.8.8
<span class="c"># =&gt; PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 8.8.8.8: icmp_seq=1 ttl=255 time=38.7 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 8.8.8.8 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 38.740/38.740/38.740/0.000 ms</span>
</code></pre></div></div>

<ul>
  <li>ping í•œë²ˆ ë³´ëƒˆì„ ë¿ì¸ë° ì—„ì²­ë‚œ ëŸ‰ì˜ ì •ë³´ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤. ìì„¸í•œ ìë£ŒëŠ” ì•„ë˜ì˜ ì°¸ê³  ìë£Œë¥¼ ì°¸ê³ í•´ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
  <li>ì°¸ê³  ìë£Œ
    <ul>
      <li><a href="https://nuguni.tistory.com/97">ë„¤íŠ¸ì›Œí¬ íŒ¨í‚· ì¶”ì  ë„êµ¬ - PWRU: Packet, Where Are You?</a></li>
      <li><a href="https://cilium.io/blog/2023/03/22/packet-where-are-you/">Going from Packet Where Arenâ€™t You to pwru</a></li>
      <li><a href="https://medium.com/@Nikhil690/debugging-packet-drops-and-kernel-flows-with-pwru-fc03f3d479a4">PWRU: Debugging Packets and Kernel Flows</a></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Ciliumì˜ ê´€ì¸¡ì„±(Observability)ì„ ìœ„í•œ Hubbleê³¼ Prometheus/Grafana ì—°ë™, ê°ì¢… ë©”íŠ¸ë¦­ ê·¸ë¦¬ê³  PWRUë¥¼ ì„¤ì¹˜í•˜ê³  ì‚¬ìš©í•´ë³´ì•˜ìŠµë‹ˆë‹¤.
êµ‰ì¥íˆ ë§ì€ ì •ë³´ëŸ‰ì— ì••ë„ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì°¨ê·¼ì°¨ê·¼ ë”°ë¼ê°€ë©´ì„œ ì‹¤ìŠµí•´ë³´ë‹ˆ Ciliumì˜ ê´€ì¸¡ì„± ê¸°ëŠ¥ì„ ì´í•´í•˜ëŠ”ë° í° ë„ì›€ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

<p>ê´€ì¸¡ì„± ë„êµ¬ë“¤ì€ ì •ë§ ê°•ë ¥í•˜ê³  ìœ ìš©í•œ ê¸°ëŠ¥ì´ì§€ë§Œ ë¯¼ê°í•œ ì •ë³´ê°€ ë…¸ì¶œë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì£¼ì˜í•´ì„œ ì‚¬ìš©í•´ì•¼ í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.
íŠ¹íˆ ëŠì„ì—†ì´ ìƒˆë¡œìš´ ê¸°ìˆ ì´ ë‚˜ì˜¤ê³ , ìƒˆë¡œìš´ íˆ´ë“¤ì´ ë‚˜ì˜¤ê³ , ì‰½ê²Œ ì„¤ì¹˜í•˜ê³  ë²„ì „ì„ ë°”ê¾¸ê³  í•˜ëŠ” í˜„ì‹¤ì—ì„œ
ì‚¬ì†Œí•œ ì„¤ì •í•˜ë‚˜ë¡œ ì •ë³´ ìœ ì¶œì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤ëŠ” ì ì´ ë¬´ì„­ê¸°ë„ í•©ë‹ˆë‹¤. 
ê°œë°œí™˜ê²½ì´ë‚˜ ë‚´ë¶€ì—ì„œ ì¶©ë¶„íˆ í…ŒìŠ¤íŠ¸í•˜ê³  ê²€ì¦í•œ í›„ì— í”„ë¡œë•ì…˜ í™˜ê²½ì— ì ìš©í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<p>ì´ì œ ì¡°ê¸ˆì”© íšŒì‚¬ ì—…ë¬´ì—ë„ Ciliumì„ ì ìš©í•˜ê³  ìˆì–´ì„œ ì´ë²ˆì— í•™ìŠµí•œ ê´€ì¸¡ì„± ê¸°ëŠ¥ë“¤ì„ í™œìš©í•´ì„œ
Ciliumì„ ë” ì˜ ì´í•´í•˜ê³ , ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ”ë° ë„ì›€ì´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ì´ë²ˆ ì£¼ë„ ìŠ¤í„°ë”” ì¤€ë¹„í•´ì£¼ì‹  ëª¨ë“  ë¶„ë“¤ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤. :bow:</p>]]></content><author><name></name></author><category term="cilium" /><category term="kubernetes," /><category term="network," /><category term="linux," /><category term="cilium," /><category term="observability," /><category term="hubble," /><category term="prometheus," /><category term="grafana" /><summary type="html"><![CDATA[ì´ë²ˆì—ëŠ” Hubble, Prometheus, Grafanaë¥¼ ì´ìš©í•˜ì—¬ Ciliumì˜ Observabilityë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[Cilium] ì‹¤ìŠµ í™˜ê²½ êµ¬ì„± ë° Cilium ì„¤ì¹˜</title><link href="https://sweetlittlebird.github.io/posts/2025-07-20-Cilium-Week1/" rel="alternate" type="text/html" title="[Cilium] ì‹¤ìŠµ í™˜ê²½ êµ¬ì„± ë° Cilium ì„¤ì¹˜" /><published>2025-07-20T00:10:18+09:00</published><updated>2025-07-20T00:10:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/Cilium%20-%20Week1</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2025-07-20-Cilium-Week1/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì˜¤ëœë§Œì— ë‹¤ì‹œ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
ì´ë²ˆì—ë„ CloudNet@ íŒ€ì—ì„œ ì§„í–‰í•˜ëŠ” ìŠ¤í„°ë””ë¡œ ê³ ë§™ê²Œë„ ìŠ¤í„°ë””ì— ì°¸ì—¬í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
ì´ë²ˆ ìŠ¤í„°ë””ëŠ” Ciliumì˜ ê³µì‹ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹¤ìŠµí•´ë³´ëŠ” ìŠ¤í„°ë””ì…ë‹ˆë‹¤.
Cilium í•œê°€ì§€ ì£¼ì œë¡œ ì§„í–‰ë˜ëŠ” ë§Œí¼ ê¹Šê³  ì§„í•˜ê²Œ í•™ìŠµí•  ìˆ˜ ìˆì„ê²ƒ ê°™ì•„ ê¸°ëŒ€ê°€ ë©ë‹ˆë‹¤.</p>

<p>ì²«ì£¼ì°¨ì—ëŠ” ì‹¤ìŠµ í™˜ê²½ì„ êµ¬ì„±í•˜ê³  Ciliumì„ ì„¤ì¹˜í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="ì‹¤ìŠµ-í™˜ê²½-êµ¬ì„±">ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±</h2>

<h3 id="ì‹¤ìŠµ-í™˜ê²½-êµ¬ì„±-ì¤€ë¹„">ì‹¤ìŠµ í™˜ê²½ êµ¬ì„± ì¤€ë¹„</h3>

<p>ì €ëŠ” MacOSë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸°ë•Œë¬¸ì— homebrewë¥¼ ì´ìš©í•˜ì—¬ VirtualBoxì™€ Vagrantë¥¼ ì„¤ì¹˜í•˜ì˜€ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>VirtualBox ì„¤ì¹˜</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>brew <span class="nb">install</span> <span class="nt">--cask</span> virtualbox
<span class="c"># =&gt; ğŸº  virtualbox was successfully installed!</span>

<span class="nv">$ </span>VBoxManage <span class="nt">--version</span>
<span class="c"># =&gt; 7.1.10r169112</span>
</code></pre></div></div>

<ul>
  <li>Vagrant ì„¤ì¹˜</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>brew <span class="nb">install</span> <span class="nt">--cask</span> vagrant
<span class="c"># =&gt; ğŸº  vagrant was successfully installed!</span>

<span class="nv">$ </span>vagrant version
<span class="c"># =&gt; Installed Version: 2.4.7</span>
<span class="c">#    Latest Version: 2.4.7</span>
<span class="c">#    </span>
<span class="c">#    You're running an up-to-date version of Vagrant!</span>
</code></pre></div></div>

<h3 id="ì‹¤ìŠµ-í™˜ê²½-ì†Œê°œ">ì‹¤ìŠµ í™˜ê²½ ì†Œê°œ</h3>

<p>ì‹¤ìŠµ í™˜ê²½ì„ ë„ì‹í™”í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2025/cilium/w1/20250720_cilium_w1_1.png" alt="img.png" /></p>

<ul>
  <li>ë°°í¬ ê°€ìƒ ë¨¸ì‹ ì€ ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì¸ k8s-ctr, ì›Œì»¤ë…¸ë“œ k8s-w1, k8s-w2ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>eth0 : 10.0.2.15 (ëª¨ë“  ë…¸ë“œê°€ ë™ì¼)</li>
      <li>eth1 : 192.168.10.100~102</li>
    </ul>
  </li>
  <li>ì´ˆê¸° í”„ë¡œë¹„ì €ë‹ì‹œ <code class="language-plaintext highlighter-rouge">kubeadm init</code>ê³¼ <code class="language-plaintext highlighter-rouge">join</code> ì„ ì‹¤í–‰í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ë©°, ì´ˆê¸°ì—ëŠ” <strong>CNIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤</strong>.</li>
</ul>

<h3 id="ì‹¤ìŠµ-í™˜ê²½-ë°°í¬-íŒŒì¼-ì‘ì„±">ì‹¤ìŠµ í™˜ê²½ ë°°í¬ íŒŒì¼ ì‘ì„±</h3>

<h4 id="vagrantfile"><strong>Vagrantfile</strong></h4>
<ul>
  <li>ê°€ìƒë¨¸ì‹ ì„ ì •ì˜í•˜ê³  ë¶€íŒ…ì‹œ ì‹¤í–‰í•  í”„ë¡œë¹„ì €ë‹ ì„¤ì •ì„ í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Variables</span>
<span class="no">K8SV</span> <span class="o">=</span> <span class="s1">'1.33.2-1.1'</span> <span class="c1"># Kubernetes Version : apt list -a kubelet , ex) 1.32.5-1.1</span>
<span class="no">CONTAINERDV</span> <span class="o">=</span> <span class="s1">'1.7.27-1'</span> <span class="c1"># Containerd Version : apt list -a containerd.io , ex) 1.6.33-1</span>
<span class="no">N</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># max number of worker nodes</span>

<span class="c1"># Base Image  https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-24.04</span>
<span class="c1">## Rocky linux Image https://portal.cloud.hashicorp.com/vagrant/discover/rockylinux</span>
<span class="no">BOX_IMAGE</span> <span class="o">=</span> <span class="s2">"bento/ubuntu-24.04"</span>
<span class="no">BOX_VERSION</span> <span class="o">=</span> <span class="s2">"202502.21.0"</span>

<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
<span class="c1">#-ControlPlane Node</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-ctr"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">2048</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.100"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60000</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-ctr.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">N</span> <span class="p">]</span>
    <span class="k">end</span>

<span class="c1">#-Worker Nodes Subnet1</span>
  <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="no">N</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.10</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="s2">"6000</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-w.sh"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="init_cfgsh"><strong>init_cfg.sh</strong></h4>
<ul>
  <li>í”„ë¡œë¹„ì €ë‹ì‹œ vagrantê°€ ì‹¤í–‰í•  ì´ˆê¸° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. argumentsë¡œ Kubernetes ë²„ì „ê³¼ Containerd ë²„ì „ë“±ì„ ë°›ì•„ì„œ ì„¤ì¹˜í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>

<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Change Timezone"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime

<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="nb">echo</span> <span class="s2">"[TASK 3] Disable and turn off SWAP"</span>
swapoff <span class="nt">-a</span> <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'/swap/s/^/#/'</span> /etc/fstab

<span class="nb">echo</span> <span class="s2">"[TASK 4] Install Packages"</span>
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>apt-transport-https ca-certificates curl gpg <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="c"># Download the public signing key for the Kubernetes package repositories.</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nt">-m</span> 755 /etc/apt/keyrings
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$1</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+)\..*/\1/p'</span><span class="si">)</span>
curl <span class="nt">-fsSL</span> https://pkgs.k8s.io/core:/stable:/v<span class="nv">$K8SMMV</span>/deb/Release.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/kubernetes-apt-keyring.gpg
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v</span><span class="nv">$K8SMMV</span><span class="s2">/deb/ /"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list.d/kubernetes.list
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null

<span class="c"># packets traversing the bridge are processed by iptables for filtering</span>
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
<span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> <span class="o">&gt;&gt;</span> /etc/sysctl.d/k8s.conf

<span class="c"># enable br_netfilter for iptables </span>
modprobe br_netfilter
modprobe overlay
<span class="nb">echo</span> <span class="s2">"br_netfilter"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
<span class="nb">echo</span> <span class="s2">"overlay"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf

<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)"</span>
<span class="c"># Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version</span>
apt update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="c"># apt list -a kubelet ; apt list -a containerd.io</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubectl</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubeadm</span><span class="o">=</span><span class="nv">$1</span> containerd.io<span class="o">=</span><span class="nv">$2</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-mark hold kubelet kubeadm kubectl <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="c"># containerd configure to default and cgroup managed by systemd</span>
containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SystemdCgroup = false/SystemdCgroup = true/g'</span> /etc/containerd/config.toml

<span class="c"># avoid WARN&amp;ERRO(default endpoints) when crictl run  </span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
</span><span class="no">EOF

</span><span class="c"># ready to install for k8s </span>
systemctl restart containerd <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable </span>containerd
systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet

<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Packages &amp; Helm"</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> bridge-utils sshpass net-tools conntrack ngrep tcpdump ipset arping wireguard jq tree bash-completion unzip kubecolor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
curl <span class="nt">-s</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div></div>

<h4 id="k8s-ctrsh"><strong>k8s-ctr.sh</strong></h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">kubeadm init</code>ìœ¼ë¡œ ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì„ ì„¤ì •í•˜ê³ , í¸ì˜ë¥¼ ìœ„í•œ <code class="language-plaintext highlighter-rouge">k</code>, <code class="language-plaintext highlighter-rouge">kc</code> ë“±ì˜ aliasë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane config Start &lt;&lt;&lt;&lt;"</span>

<span class="nb">echo</span> <span class="s2">"[TASK 1] Initial Kubernetes"</span>
kubeadm init <span class="nt">--token</span> 123456.1234567890123456 <span class="nt">--token-ttl</span> 0 <span class="nt">--pod-network-cidr</span><span class="o">=</span>10.244.0.0/16 <span class="nt">--service-cidr</span><span class="o">=</span>10.96.0.0/16 <span class="nt">--apiserver-advertise-address</span><span class="o">=</span>192.168.10.100 <span class="nt">--cri-socket</span><span class="o">=</span>unix:///run/containerd/containerd.sock <span class="o">&gt;</span>/dev/null 2&gt;&amp;1


<span class="nb">echo</span> <span class="s2">"[TASK 2] Setting kube config file"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /root/.kube
<span class="nb">cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf /root/.kube/config
<span class="nb">chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> /root/.kube/config


<span class="nb">echo</span> <span class="s2">"[TASK 3] Source the completion"</span>
<span class="nb">echo</span> <span class="s1">'source &lt;(kubectl completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'source &lt;(kubeadm completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile


<span class="nb">echo</span> <span class="s2">"[TASK 4] Alias kubectl to k"</span>
<span class="nb">echo</span> <span class="s1">'alias k=kubectl'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'alias kc=kubecolor'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'complete -F __start_kubectl k'</span> <span class="o">&gt;&gt;</span> /etc/profile


<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubectx &amp; Kubens"</span>
git clone https://github.com/ahmetb/kubectx /opt/kubectx <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubens /usr/local/bin/kubens
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubectx /usr/local/bin/kubectx


<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Kubeps &amp; Setting PS1"</span>
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1 <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">"</span><span class="no">EOT</span><span class="sh">" &gt;&gt; /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
function get_cluster_short() {
  echo "</span><span class="nv">$1</span><span class="sh">" | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=') '
PS1='</span><span class="si">$(</span>kube_ps1<span class="si">)</span><span class="sh">'</span><span class="nv">$PS1</span><span class="sh">
</span><span class="no">EOT
</span>kubectl config rename-context <span class="s2">"kubernetes-admin@kubernetes"</span> <span class="s2">"HomeLab"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1


<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Kubeps &amp; Setting PS1"</span>
<span class="nb">echo</span> <span class="s2">"192.168.10.100 k8s-ctr"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;<span class="o">=</span><span class="nv">$1</span><span class="p">;</span> i++  <span class="o">))</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"192.168.10.10</span><span class="nv">$i</span><span class="s2"> k8s-w</span><span class="nv">$i</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts<span class="p">;</span> <span class="k">done


</span><span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div></div>

<h4 id="k8s-wsh"><strong>k8s-w.sh</strong></h4>
<ul>
  <li>ì›Œì»¤ë…¸ë“œì—ì„œ <code class="language-plaintext highlighter-rouge">kubeadm join</code>ì„ ì‹¤í–‰í•˜ì—¬ ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì— ì¡°ì¸í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;"</span>

<span class="nb">echo</span> <span class="s2">"[TASK 1] K8S Controlplane Join"</span> 
kubeadm <span class="nb">join</span> <span class="nt">--token</span> 123456.1234567890123456 <span class="nt">--discovery-token-unsafe-skip-ca-verification</span> 192.168.10.100:6443  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div></div>

<h3 id="ì‹¤ìŠµ-í™˜ê²½-ë°°í¬">ì‹¤ìŠµ í™˜ê²½ ë°°í¬</h3>

<ul>
  <li>ì‹¤ìŠµ í™˜ê²½ ë°°í¬ë¥¼ ìœ„í•œ íŒŒì¼ì´ ì¤€ë¹„ë˜ì—ˆìœ¼ë‹ˆ <code class="language-plaintext highlighter-rouge">vagrant up</code> ëª…ë ¹ì„ ì´ìš©í•˜ì—¬ ê°€ìƒ ë¨¸ì‹ ì„ ë°°í¬í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vagrant up
<span class="c"># =&gt; Bringing machine 'k8s-ctr' up with 'virtualbox' provider...</span>
<span class="c">#    Bringing machine 'k8s-w1' up with 'virtualbox' provider...</span>
<span class="c">#    Bringing machine 'k8s-w2' up with 'virtualbox' provider...</span>
<span class="c">#    ==&gt; k8s-ctr: Box 'bento/ubuntu-24.04' could not be found. Attempting to find and install...</span>
<span class="c">#        k8s-ctr: Box Provider: virtualbox</span>
<span class="c">#        k8s-ctr: Box Version: 202502.21.0</span>
<span class="c">#    ==&gt; k8s-ctr: Loading metadata for box 'bento/ubuntu-24.04'</span>
<span class="c">#        k8s-ctr: URL: https://vagrantcloud.com/api/v2/vagrant/bento/ubuntu-24.04</span>
<span class="c">#    ==&gt; k8s-ctr: Adding box 'bento/ubuntu-24.04' (v202502.21.0) for provider: virtualbox (arm64)</span>
<span class="c">#        k8s-ctr: Downloading: https://vagrantcloud.com/bento/boxes/ubuntu-24.04/versions/202502.21.0/providers/virtualbox/arm64/vagrant.box</span>
<span class="c">#    ==&gt; k8s-ctr: Successfully added box 'bento/ubuntu-24.04' (v202502.21.0) for 'virtualbox (arm64)'!</span>
<span class="c">#    ==&gt; k8s-ctr: Preparing master VM for linked clones...</span>
<span class="c">#    ...</span>
<span class="c">#        k8s-w2: &gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;</span>
</code></pre></div></div>

<ul>
  <li>ë°°í¬ í›„ ê° ë…¸ë“œì— sshë¡œ ì ‘ì†í•˜ì—¬ ipë¥¼ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>ctr w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> vagrant ssh k8s-<span class="nv">$i</span> <span class="nt">-c</span> <span class="s1">'ip -c -4 addr show dev eth0'</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span> <span class="c">#</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-ctr &lt;&lt;</span>
<span class="c">#    2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s8</span>
<span class="c">#        inet 10.0.2.15/24 metric 100 brd 10.0.2.255 scope global dynamic eth0</span>
<span class="c">#           valid_lft 85500sec preferred_lft 85500sec</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s8</span>
<span class="c">#        inet 10.0.2.15/24 metric 100 brd 10.0.2.255 scope global dynamic eth0</span>
<span class="c">#           valid_lft 85707sec preferred_lft 85707sec</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s8</span>
<span class="c">#        inet 10.0.2.15/24 metric 100 brd 10.0.2.255 scope global dynamic eth0</span>
<span class="c">#           valid_lft 85781sec preferred_lft 85781sec</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">k8s-ctr</code> ë…¸ë“œì— ì ‘ì†í•˜ì—¬ ê¸°ë³¸ ì •ë³´ë¥¼ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vagrant ssh k8s-ctr
<span class="nt">---</span>
<span class="c"># =&gt; Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-53-generic aarch64)</span>
<span class="c">#    ...</span>
<span class="c">#    (âˆ|HomeLab:N/A) root@k8s-ctr:~#</span>
<span class="nv">$ </span><span class="nb">whoami</span>
<span class="c"># =&gt; root</span>
<span class="nv">$ </span><span class="nb">pwd</span>
<span class="c"># =&gt; /root</span>
<span class="nv">$ </span>hostnamectl
<span class="c"># =&gt;  Static hostname: k8s-ctr</span>
<span class="c">#           Icon name: computer-vm</span>
<span class="c">#             Chassis: vm</span>
<span class="c">#          Machine ID: 3d6bd65db7dd43d392b2d5229abb5654</span>
<span class="c">#             Boot ID: 2d9ede04fd294425988e58c588dd201c</span>
<span class="c">#      Virtualization: qemu</span>
<span class="c">#    Operating System: Ubuntu 24.04.2 LTS</span>
<span class="c">#              Kernel: Linux 6.8.0-53-generic</span>
<span class="c">#        Architecture: arm64</span>
<span class="nv">$ </span>htop

<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
<span class="c"># =&gt; 127.0.0.1 localhost</span>
<span class="c">#    127.0.1.1 vagrant</span>
<span class="c">#    ...</span>
<span class="c">#    127.0.2.1 k8s-ctr k8s-ctr</span>
<span class="c">#    192.168.10.100 k8s-ctr</span>
<span class="c">#    192.168.10.101 k8s-w1</span>
<span class="c">#    192.168.10.102 k8s-w2</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 k8s-w1
<span class="c"># =&gt; PING k8s-w1 (192.168.10.101) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from k8s-w1 (192.168.10.101): icmp_seq=1 ttl=64 time=0.795 ms</span>
<span class="c">#    </span>
<span class="c">#    --- k8s-w1 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.795/0.795/0.795/0.000 ms</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 k8s-w2
<span class="c"># =&gt; PING k8s-w2 (192.168.10.102) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from k8s-w2 (192.168.10.102): icmp_seq=1 ttl=64 time=1.20 ms</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-w1 <span class="nb">hostname</span>
<span class="c"># =&gt; k8s-w1</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-w2 <span class="nb">hostname</span>
<span class="c"># =&gt; k8s-w2</span>

<span class="c"># vagrant ssh ë¡œ ì ‘ì† ì‹œ tcp ì—°ê²° ì •ë³´ : NAT Mode 10.0.2.2(GateWay)</span>
<span class="nv">$ </span>ss <span class="nt">-tnp</span> |grep sshd
<span class="c"># =&gt; ESTAB 0      0           [::ffff:10.0.2.15]:22          [::ffff:10.0.2.2]:63578 users:((&amp;quot;sshd&amp;quot;,pid=5141,fd=4),(&amp;quot;sshd&amp;quot;,pid=5094,fd=4))</span>

<span class="c"># nic ì •ë³´</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="c"># =&gt; 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span>
<span class="c">#       ...</span>
<span class="c">#    2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        link/ether 08:00:27:71:19:d8 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        altname enp0s8</span>
<span class="c">#        inet 10.0.2.15/24 metric 100 brd 10.0.2.255 scope global dynamic eth0</span>
<span class="c">#           valid_lft 82445sec preferred_lft 82445sec</span>
<span class="c">#    3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        link/ether 08:00:27:da:24:93 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet 192.168.10.100/24 brd 192.168.10.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># default ë¼ìš°íŒ… ì •ë³´ </span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100</span>

<span class="c"># dns ì„œë²„ ì •ë³´ : NAT Mode 10.0.2.3</span>
<span class="nv">$ </span>resolvectl
<span class="c"># =&gt; Global</span>
<span class="c">#             Protocols: -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span>
<span class="c">#      resolv.conf mode: stub</span>
<span class="c">#    </span>
<span class="c">#    Link 2 (eth0)</span>
<span class="c">#        Current Scopes: DNS</span>
<span class="c">#             Protocols: +DefaultRoute -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span>
<span class="c">#    Current DNS Server: 10.0.2.3</span>
<span class="c">#           DNS Servers: 10.0.2.3</span>
<span class="c">#    </span>
<span class="c">#    Link 3 (eth1)</span>
<span class="c">#        Current Scopes: none</span>
<span class="c">#             Protocols: -DefaultRoute -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">---</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">k8s-ctr</code> k8s ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://192.168.10.100:6443</span>
<span class="c">#    CoreDNS is running at https://192.168.10.100:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="c">#    </span>
<span class="c">#    To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>

<span class="c"># ë…¸ë“œ ì •ë³´ : ìƒíƒœ, INTERNAL-IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME      STATUS     ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    k8s-ctr   NotReady   control-plane   2d    v1.33.2   192.168.10.100   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w1    NotReady   &lt;none&gt;          2d    v1.33.2   10.0.2.15        &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w2    NotReady   &lt;none&gt;          2d    v1.33.2   10.0.2.15        &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>

<span class="c"># íŒŒë“œ ì •ë³´ : ìƒíƒœ, íŒŒë“œ IP í™•ì¸ - kube-proxy í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE     NAME                              READY   STATUS    RESTARTS      AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-79mbb          0/1     Pending   0             2d    &lt;none&gt;           &lt;none&gt;    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-rtx95          0/1     Pending   0             2d    &lt;none&gt;           &lt;none&gt;    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   etcd-k8s-ctr                      1/1     Running   1 (12m ago)   2d    192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-apiserver-k8s-ctr            1/1     Running   1 (12m ago)   2d    192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-controller-manager-k8s-ctr   1/1     Running   1 (12m ago)   2d    192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-proxy-hdffr                  1/1     Running   1 (11m ago)   2d    10.0.2.15        k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-proxy-r96sz                  1/1     Running   1 (12m ago)   2d    192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-proxy-swgmb                  1/1     Running   1 (11m ago)   2d    10.0.2.15        k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-scheduler-k8s-ctr            1/1     Running   1 (12m ago)   2d    192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># ë‹¨ì¶•ì–´ í™•ì¸(kc = kubecolor) &amp; coredns íŒŒë“œ ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>k  describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns
<span class="c"># =&gt; Name:                 coredns-674b8bbfcf-79mbb</span>
<span class="c">#    Namespace:            kube-system</span>
<span class="c">#    Priority:             2000000000</span>
<span class="c">#    Priority Class Name:  system-cluster-critical</span>
<span class="c">#    Service Account:      coredns</span>
<span class="c">#    Node:                 &lt;none&gt;</span>
<span class="c">#    Labels:               k8s-app=kube-dns</span>
<span class="c">#                          pod-template-hash=674b8bbfcf</span>
<span class="c">#    Annotations:          &lt;none&gt;</span>
<span class="c">#    Status:               Pending</span>
<span class="c">#    IP:</span>
<span class="c">#    IPs:                  &lt;none&gt;</span>
<span class="c">#    Controlled By:        ReplicaSet/coredns-674b8bbfcf</span>
<span class="c">#    Containers:</span>
<span class="c">#      coredns:</span>
<span class="c">#        Image:       registry.k8s.io/coredns/coredns:v1.12.0</span>
<span class="c">#        Ports:       53/UDP, 53/TCP, 9153/TCP</span>
<span class="c">#        Host Ports:  0/UDP, 0/TCP, 0/TCP</span>
<span class="c">#        Args:</span>
<span class="c">#          -conf</span>
<span class="c">#          /etc/coredns/Corefile</span>
<span class="c">#        Limits:</span>
<span class="c">#          memory:  170Mi</span>
<span class="c">#        Requests:</span>
<span class="c">#          cpu:        100m</span>
<span class="c">#          memory:     70Mi</span>
<span class="c">#        Liveness:     http-get http://:8080/health delay=60s timeout=5s period=10s #success=1 #failure=5</span>
<span class="c">#        Readiness:    http-get http://:8181/ready delay=0s timeout=1s period=10s #success=1 #failure=3</span>
<span class="c">#        Environment:  &lt;none&gt;</span>
<span class="c">#        Mounts:</span>
<span class="c">#          /etc/coredns from config-volume (ro)</span>
<span class="c">#          /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-vrqlj (ro)</span>
<span class="c">#    Conditions:</span>
<span class="c">#      Type           Status</span>
<span class="c">#      PodScheduled   False</span>
<span class="c">#    Volumes:</span>
<span class="c">#      config-volume:</span>
<span class="c">#        Type:      ConfigMap (a volume populated by a ConfigMap)</span>
<span class="c">#        Name:      coredns</span>
<span class="c">#        Optional:  false</span>
<span class="c">#      kube-api-access-vrqlj:</span>
<span class="c">#        Type:                    Projected (a volume that contains injected data from multiple sources)</span>
<span class="c">#        TokenExpirationSeconds:  3607</span>
<span class="c">#        ConfigMapName:           kube-root-ca.crt</span>
<span class="c">#        Optional:                false</span>
<span class="c">#        DownwardAPI:             true</span>
<span class="c">#    QoS Class:                   Burstable</span>
<span class="c">#    Node-Selectors:              kubernetes.io/os=linux</span>
<span class="c">#    Tolerations:                 CriticalAddonsOnly op=Exists</span>
<span class="c">#                                 node-role.kubernetes.io/control-plane:NoSchedule</span>
<span class="c">#                                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span>
<span class="c">#                                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span>
<span class="c">#    Events:</span>
<span class="c">#      Type     Reason            Age                  From               Message</span>
<span class="c">#      ----     ------            ----                 ----               -------</span>
<span class="c">#      Warning  FailedScheduling  7m18s (x2 over 12m)  default-scheduler  0/3 nodes are available: 3 node(s) had untolerated taint {node.kubernetes.io/not-ready: }. preemption: 0/3 nodes are available: 3 Preemption is not helpful for scheduling.</span>
<span class="c">#      Warning  FailedScheduling  47h(x12 over 2d)    default-scheduler  0/3 nodes are available: 3 node(s) had untolerated taint {node.kubernetes.io/not-ready: }. preemption: 0/3 nodes are available: 3 Preemption is not helpful for scheduling.</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kc describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">k8s-ctr</code> INTERNAL-IP ë³€ê²½ ì„¤ì •</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> /var/lib/kubelet/kubeadm-flags.env
<span class="c"># =&gt; KUBELET_KUBEADM_ARGS="--container-runtime-endpoint=unix:///run/containerd/containerd.sock --pod-infra-container-image=registry.k8s.io/pause:3.10"</span>

<span class="c"># INTERNAL-IP ë³€ê²½ ì„¤ì •</span>
<span class="nv">$ NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/^</span><span class="se">\(</span><span class="s2">KUBELET_KUBEADM_ARGS=</span><span class="se">\"\)</span><span class="s2">/</span><span class="se">\1</span><span class="s2">--node-ip=</span><span class="k">${</span><span class="nv">NODEIP</span><span class="k">}</span><span class="s2"> /"</span> /var/lib/kubelet/kubeadm-flags.env
<span class="nv">$ </span>systemctl daemon-reexec <span class="o">&amp;&amp;</span> systemctl restart kubelet

<span class="nv">$ </span><span class="nb">cat</span> /var/lib/kubelet/kubeadm-flags.env
<span class="c"># =&gt; KUBELET_KUBEADM_ARGS="--node-ip=192.168.10.100 --container-runtime-endpoint=unix:///run/containerd/containerd.sock --pod-infra-container-image=registry.k8s.io/pause:3.10"</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME      STATUS     ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    k8s-ctr   NotReady   control-plane   2d    v1.33.2   192.168.10.100   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w1    NotReady   &lt;none&gt;          2d    v1.33.2   10.0.2.15        &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w2    NotReady   &lt;none&gt;          2d    v1.33.2   10.0.2.15        &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">k8s-w1</code>, <code class="language-plaintext highlighter-rouge">k8s-w2</code> ì—ë„ ìœ„ì™€ ë™ì¼í•œ ë°©ë²•ìœ¼ë¡œ INTERNAL-IPë¥¼ 192.168.10.xë¡œ ë³€ê²½í•©ë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">k8s-w1/w2</code> ì„¤ì • ì™„ë£Œ í›„ INTERNAL-IP í™•ì¸</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME      STATUS     ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    k8s-ctr   NotReady   control-plane   2d    v1.33.2   192.168.10.100   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w1    NotReady   &lt;none&gt;          2d    v1.33.2   192.168.10.101   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w2    NotReady   &lt;none&gt;          2d    v1.33.2   192.168.10.102   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE     NAME                              READY   STATUS    RESTARTS      AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-79mbb          0/1     Pending   0             2d    &lt;none&gt;           &lt;none&gt;    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-rtx95          0/1     Pending   0             2d    &lt;none&gt;           &lt;none&gt;    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   etcd-k8s-ctr                      1/1     Running   1 (27m ago)   2d    192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-apiserver-k8s-ctr            1/1     Running   1 (27m ago)   2d    192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-controller-manager-k8s-ctr   1/1     Running   1 (27m ago)   2d    192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-proxy-hdffr                  1/1     Running   1 (26m ago)   2d    192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-proxy-r96sz                  1/1     Running   1 (27m ago)   2d    192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-proxy-swgmb                  1/1     Running   1 (26m ago)   2d    192.168.10.102   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-scheduler-k8s-ctr            1/1     Running   1 (27m ago)   2d    192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">k8s-ctr</code> static podì˜ IP ë³€ê²½ ì„¤ì •</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>tree /etc/kubernetes/manifests
<span class="c"># =&gt; /etc/kubernetes/manifests</span>
<span class="c">#    â”œâ”€â”€ etcd.yaml</span>
<span class="c">#    â”œâ”€â”€ kube-apiserver.yaml</span>
<span class="c">#    â”œâ”€â”€ kube-controller-manager.yaml</span>
<span class="c">#    â””â”€â”€ kube-scheduler.yaml</span>

<span class="c"># etcd ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/kubernetes/manifests/etcd.yaml
<span class="c"># =&gt;   ...</span>
<span class="c">#      volumes:</span>
<span class="c">#      - hostPath:</span>
<span class="c">#          path: /etc/kubernetes/pki/etcd</span>
<span class="c">#          type: DirectoryOrCreate</span>
<span class="c">#        name: etcd-certs</span>
<span class="c">#      - hostPath:</span>
<span class="c">#          path: /var/lib/etcd</span>
<span class="c">#          type: DirectoryOrCreate</span>
<span class="c">#        name: etcd-data</span>
<span class="c">#      ...</span>

<span class="nv">$ </span>tree /var/lib/etcd/
<span class="c"># =&gt; /var/lib/etcd/</span>
<span class="c">#    â””â”€â”€ member</span>
<span class="c">#        â”œâ”€â”€ snap</span>
<span class="c">#        â”‚   â”œâ”€â”€ 0000000000000003-0000000000002711.snap</span>
<span class="c">#        â”‚   â””â”€â”€ db</span>
<span class="c">#        â””â”€â”€ wal</span>
<span class="c">#            â”œâ”€â”€ 0000000000000000-0000000000000000.wal</span>
<span class="c">#            â””â”€â”€ 0.tmp</span>

<span class="c"># k8s-ctr ì¬ë¶€íŒ…</span>
<span class="nv">$ </span>reboot
</code></pre></div></div>

<hr />

<h2 id="flannel-cni">Flannel CNI</h2>

<h3 id="flannel-ì†Œê°œ">Flannel ì†Œê°œ</h3>

<ul>
  <li>Flannelì€ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ë„¤íŠ¸ì›Œí¬ ìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±í•˜ëŠ” ê°€ì¥ ê°„ë‹¨í•˜ê³  ì‚¬ìš©í•˜ê¸° ì‰¬ìš´ ì˜¤ë²„ë ˆì´ ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</li>
  <li>Flannelì€ ê°€ìƒ ë„¤íŠ¸ì›Œí¬ë¥¼ ìƒì„±í•˜ì—¬ íŒŒë“œ ê°„ í†µì‹ ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ë©°, VXLAN, UDP, Host-GW ë“± ë‹¤ì–‘í•œ ë°±ì—”ë“œë¥¼ ì§€ì›í•©ë‹ˆë‹¤. ì´ ì¤‘ì—ì„œëŠ” VXLAN ì‚¬ìš©ì´ ê°€ì¥ ê¶Œì¥ë©ë‹ˆë‹¤.</li>
  <li>VXLAN(Virtual eXtensible Local Area Network)ì€ ë¬¼ë¦¬ì ì¸ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ìœ„ì— ë…¼ë¦¬ì ì¸ ê°€ìƒ ë„¤íŠ¸ì›Œí¬ë¥¼ êµ¬ì„±í•˜ëŠ” ê¸°ìˆ ë¡œ, UDP 8472 í¬íŠ¸ë¥¼ í†µí•´ ë…¸ë“œ ê°„ í„°ë„ë§ ë°©ì‹ìœ¼ë¡œ í†µì‹ í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2025/cilium/w1/20250720_cilium_w1_2.png" alt="img.png" class="image-center" />
<em class="image-caption">Flannel êµ¬ì¡° (ì¶œì²˜: ì¶”ê°€ì˜ˆì •)</em></p>

<ul>
  <li>ìœ„ ê·¸ë¦¼ì²˜ëŸ¼ íŒŒë“œì˜ eth0 ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ëŠ” í˜¸ìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ veth ì¸í„°í˜ì´ìŠ¤ì™€ ì—°ê²°ë˜ê³ , vethëŠ” cni0ì™€ ì—°ê²°ë©ë‹ˆë‹¤.</li>
  <li>ê°™ì€ ë…¸ë“œ ë‚´ì—ì„œëŠ” cni0 ë¸Œë¦¿ì§€ë¥¼ í†µí•´ íŒŒë“œ ê°„ í†µì‹ ì´ ì´ë£¨ì–´ì§€ë©°, ë‹¤ë¥¸ ë…¸ë“œì™€ì˜ í†µì‹ ì€ VXLANì„ í†µí•´ ì²˜ë¦¬ë©ë‹ˆë‹¤.</li>
  <li>VXLAN ê²½ë¡œì—ì„œëŠ” cni0 ë¸Œë¦¿ì§€ë¥¼ ê±°ì³ flannel.1 ì¸í„°í˜ì´ìŠ¤ë¡œ íŒ¨í‚·ì´ ì „ë‹¬ë˜ê³ , flannel.1ì€ í˜¸ìŠ¤íŠ¸ì˜ eth0ì„ í†µí•´ ë‹¤ë¥¸ ë…¸ë“œë¡œ ì „ì†¡í•©ë‹ˆë‹¤. ì´ë•Œ <strong>flannel.1ì€ VTEP(Vxlan Tunnel End Point)</strong> ì—­í• ì„ í•˜ë©°, íŒ¨í‚·ì„ ìº¡ìŠí™”í•˜ì—¬ ëŒ€ìƒ ë…¸ë“œì˜ IPë¡œ ì „ì†¡í•˜ê³ , ë„ì°©í•œ ë…¸ë“œì—ì„œëŠ” ìº¡ìŠì„ í•´ì œí•´ í•´ë‹¹ íŒŒë“œë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
  <li>ê° ë…¸ë“œëŠ” íŒŒë“œì— í• ë‹¹í•  ìˆ˜ ìˆëŠ” IP ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, flannelì„ í†µí•´ ETCDë‚˜ Kubernetes APIì— ì „ë‹¬ëœ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ëª¨ë“  ë…¸ë“œëŠ” ìì‹ ì˜ ë¼ìš°íŒ… í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì„œë¡œ ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œë¼ë¦¬ë„ ë‚´ë¶€ IP ì£¼ì†Œë¡œ í†µì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="flannel-ì„¤ì¹˜-ë°-í™•ì¸">Flannel ì„¤ì¹˜ ë° í™•ì¸</h3>

<ul>
  <li>ì„¤ì¹˜ ì „ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># IP ì£¼ì†Œ ë²”ìœ„ í™•ì¸</span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt;                             "--service-cluster-ip-range=10.96.0.0/16",</span>
<span class="c">#                                "--cluster-cidr=10.244.0.0/16",</span>

<span class="c"># coredns íŒŒë“œ ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                       READY   STATUS    RESTARTS   AGE     IP       NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    coredns-674b8bbfcf-79mbb   0/1     &lt;span style="color: green;"&gt;Pending&lt;/span&gt;   0          2d14h   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    coredns-674b8bbfcf-rtx95   0/1     &lt;span style="color: green;"&gt;Pending&lt;/span&gt;   0          2d14h   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;ğŸ‘‰ CNIê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•„ì„œ Pending ìƒíƒœì…ë‹ˆë‹¤&lt;/span&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 08:00:27:71:19:d8 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 08:00:27:da:24:93 brd ff:ff:ff:ff:ff:ff</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100</span>
<span class="nv">$ </span>brctl show
<span class="c"># =&gt; &lt;span style="color: green;"&gt;ì—†ìŒ&lt;/span&gt;</span>

<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        link/ether 08:00:27:71:19:d8 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 10.0.2.15/24 metric 100 brd 10.0.2.255 scope global dynamic eth0</span>
<span class="c">#           valid_lft 85957sec preferred_lft 85957sec</span>
<span class="c">#    3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        link/ether 08:00:27:da:24:93 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 192.168.10.100/24 brd 192.168.10.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>ifconfig | <span class="nb">grep</span> <span class="nt">-iEA1</span> <span class="s1">'eth[0-9]:'</span>
<span class="c"># =&gt; eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255</span>
<span class="c">#    --</span>
<span class="c">#    eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 192.168.10.100  netmask 255.255.255.0  broadcast 192.168.10.255</span>

<span class="c">#</span>
<span class="nv">$ </span>iptables-save
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>

<span class="c"># flannel ì„¤ì¹˜ í›„ ë¹„êµë¥¼ ìœ„í•´ ì„¤ì¹˜ ì „ì˜ iptables ì„¤ì •ì„ ì €ì¥í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>iptables-save <span class="o">&gt;</span> iptables-before-flannel.txt

<span class="c">#</span>
<span class="nv">$ </span>tree /etc/cni/net.d/
<span class="c"># =&gt; /etc/cni/net.d/</span>
<span class="c">#    </span>
<span class="c">#    0 directories, 0 files</span>
</code></pre></div></div>

<ul>
  <li>Flannel ì„¤ì¹˜</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># helmì— ì˜í•œ namespace ìƒì„± ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ kube-flannel ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl create ns kube-flannel
<span class="c"># =&gt; namespace/kube-flannel created</span>
<span class="nv">$ </span>kubectl label <span class="nt">--overwrite</span> ns kube-flannel pod-security.kubernetes.io/enforce<span class="o">=</span>privileged
<span class="c"># =&gt; namespace/kube-flannel labeled</span>

<span class="nv">$ </span>helm repo add flannel https://flannel-io.github.io/flannel/
<span class="c"># =&gt; "flannel" has been added to your repositories</span>
<span class="nv">$ </span>helm repo list
<span class="c"># =&gt; NAME    URL</span>
<span class="c">#    flannel https://flannel-io.github.io/flannel/</span>

<span class="nv">$ </span>helm search repo flannel
<span class="c"># =&gt; NAME            CHART VERSION   APP VERSION     DESCRIPTION</span>
<span class="c">#    flannel/flannel v0.27.1         v0.27.1         Install Flannel Network Plugin.</span>
<span class="nv">$ </span>helm show values flannel/flannel
<span class="c"># =&gt; ...</span>
<span class="c">#    podCidr: "10.244.0.0/16"</span>
<span class="c">#    ...</span>
<span class="c">#      cniBinDir: "/opt/cni/bin"</span>
<span class="c">#      cniConfDir: "/etc/cni/net.d"</span>
<span class="c">#      skipCNIConfigInstallation: false</span>
<span class="c">#      enableNFTables: false</span>
<span class="c">#      args:</span>
<span class="c">#      - "--ip-masq"</span>
<span class="c">#      - "--kube-subnet-mgr"</span>
<span class="c">#      backend: "vxlan"</span>
<span class="c">#    ...</span>

<span class="c"># k8s ê´€ë ¨ íŠ¸ë˜í”½ í†µì‹  ë™ì‘í•˜ëŠ” nic ì§€ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; flannel-values.yaml
podCidr: "10.244.0.0/16"

flannel:
  args:
  - "--ip-masq"
  - "--kube-subnet-mgr"
  - "--iface=eth1"  
</span><span class="no">EOF

</span><span class="c"># helm ì„¤ì¹˜</span>
<span class="nv">$ </span>helm <span class="nb">install </span>flannel <span class="nt">--namespace</span> kube-flannel flannel/flannel <span class="nt">-f</span> flannel-values.yaml
<span class="c"># =&gt; NAME: flannel</span>
<span class="c">#    LAST DEPLOYED: Mon Jan 19 13:52:04 2025</span>
<span class="c">#    NAMESPACE: kube-flannel</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="nv">$ </span>helm list <span class="nt">-A</span>
<span class="c"># =&gt; NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION</span>
<span class="c">#    flannel kube-flannel    1               2025-01-19 13:52:04.427781204 +0900 KST deployed        flannel-v0.27.1 v0.27.1</span>

<span class="c"># í™•ì¸ : install-cni-plugin, install-cni</span>
<span class="nv">$ </span>kc describe pod <span class="nt">-n</span> kube-flannel <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>flannel
<span class="c"># =&gt; Name:                 kube-flannel-ds-5fm6l</span>
<span class="c">#    Namespace:            kube-flannel</span>
<span class="c">#    Priority:             2000001000</span>
<span class="c">#    Priority Class Name:  system-node-critical</span>
<span class="c">#    Service Account:      flannel</span>
<span class="c">#    Node:                 &lt;span style="color: green;"&gt;k8s-w1/192.168.10.101&lt;/span&gt;</span>
<span class="c">#    Start Time:           Sat, 19 Jul 2025 13:52:06 +0900</span>
<span class="c">#    Labels:               app=flannel</span>
<span class="c">#                          controller-revision-hash=66c5c78475</span>
<span class="c">#                          pod-template-generation=1</span>
<span class="c">#                          tier=node</span>
<span class="c">#    Annotations:          &lt;none&gt;</span>
<span class="c">#    Status:               Running</span>
<span class="c">#    IP:                   192.168.10.101</span>
<span class="c">#    IPs:</span>
<span class="c">#      IP:           192.168.10.101</span>
<span class="c">#    Controlled By:  DaemonSet/kube-flannel-ds</span>
<span class="c">#    Init Containers:</span>
<span class="c">#      install-cni-plugin:</span>
<span class="c">#      ...</span>
<span class="c">#      install-cni:</span>
<span class="c">#      ....</span>
<span class="c">#    Containers:</span>
<span class="c">#      kube-flannel:</span>
<span class="c">#        Container ID:  containerd://c6a1e24ae6193491289908c4b10a8ce6f9a36e000114aaf61dc60da43bdc50ca</span>
<span class="c">#        Image:         ghcr.io/flannel-io/flannel:v0.27.1</span>
<span class="c">#        Image ID:      ghcr.io/flannel-io/flannel@sha256:0c95c822b690f83dc827189d691015f92ab7e249e238876b56442b580c492d85</span>
<span class="c">#        Port:          &lt;none&gt;</span>
<span class="c">#        Host Port:     &lt;none&gt;</span>
<span class="c">#    ...</span>
<span class="c">#    Name:                 kube-flannel-ds-dstmv</span>
<span class="c">#    Namespace:            kube-flannel</span>
<span class="c">#    Priority:             2000001000</span>
<span class="c">#    Priority Class Name:  system-node-critical</span>
<span class="c">#    Service Account:      flannel</span>
<span class="c">#    Node:                 &lt;span style="color: green;"&gt;k8s-w2/192.168.10.102&lt;/span&gt;</span>
<span class="c">#    Start Time:           Sat, 19 Jul 2025 13:52:05 +0900</span>
<span class="c">#    ...</span>
<span class="c">#    IP:                   192.168.10.102</span>
<span class="c">#    ...</span>
<span class="c">#    Name:                 kube-flannel-ds-lsf7h</span>
<span class="c">#    Namespace:            kube-flannel</span>
<span class="c">#    Priority:             2000001000</span>
<span class="c">#    Priority Class Name:  system-node-critical</span>
<span class="c">#    Service Account:      flannel</span>
<span class="c">#    Node:                 &lt;span style="color: green;"&gt;k8s-ctr/192.168.10.100&lt;/span&gt;</span>
<span class="c">#    Start Time:           Sat, 19 Jul 2025 13:52:04 +0900</span>
<span class="c">#    Labels:               app=flannel</span>
<span class="c">#                          controller-revision-hash=66c5c78475</span>
<span class="c">#                          pod-template-generation=1</span>
<span class="c">#                          tier=node</span>
<span class="c">#    Annotations:          &lt;none&gt;</span>
<span class="c">#    Status:               Running</span>
<span class="c">#    IP:                   192.168.10.100</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>tree /opt/cni/bin/ <span class="c"># flannel</span>
<span class="c"># =&gt; /opt/cni/bin/</span>
<span class="c">#    â”œâ”€â”€ bandwidth</span>
<span class="c">#    â”œâ”€â”€ bridge</span>
<span class="c">#    â”œâ”€â”€ dhcp</span>
<span class="c">#    â”œâ”€â”€ dummy</span>
<span class="c">#    â”œâ”€â”€ firewall</span>
<span class="c">#    â”œâ”€â”€ flannel</span>
<span class="c">#    â”œâ”€â”€ host-device</span>
<span class="c">#    â”œâ”€â”€ host-local</span>
<span class="c">#    â”œâ”€â”€ ipvlan</span>
<span class="c">#    â”œâ”€â”€ LICENSE</span>
<span class="c">#    â”œâ”€â”€ loopback</span>
<span class="c">#    â”œâ”€â”€ macvlan</span>
<span class="c">#    â”œâ”€â”€ portmap</span>
<span class="c">#    â”œâ”€â”€ ptp</span>
<span class="c">#    â”œâ”€â”€ README.md</span>
<span class="c">#    â”œâ”€â”€ sbr</span>
<span class="c">#    â”œâ”€â”€ static</span>
<span class="c">#    â”œâ”€â”€ tap</span>
<span class="c">#    â”œâ”€â”€ tuning</span>
<span class="c">#    â”œâ”€â”€ vlan</span>
<span class="c">#    â””â”€â”€ vrf</span>
<span class="c">#    </span>
<span class="c">#    1 directory, 21 files</span>
<span class="nv">$ </span>tree /etc/cni/net.d/
<span class="c"># =&gt; /etc/cni/net.d/</span>
<span class="c">#    â””â”€â”€ 10-flannel.conflist</span>
<span class="c">#    </span>
<span class="c">#    1 directory, 1 file</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/cni/net.d/10-flannel.conflist | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "name": "cbr0",</span>
<span class="c">#      "cniVersion": "0.3.1",</span>
<span class="c">#      "plugins": [</span>
<span class="c">#        {</span>
<span class="c">#          "type": "flannel",</span>
<span class="c">#          "delegate": {</span>
<span class="c">#            "hairpinMode": true,</span>
<span class="c">#            "isDefaultGateway": true</span>
<span class="c">#          }</span>
<span class="c">#        },</span>
<span class="c">#        {</span>
<span class="c">#          "type": "portmap",</span>
<span class="c">#          "capabilities": {</span>
<span class="c">#            "portMappings": true</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> kube-flannel kube-flannel-cfg
<span class="c"># =&gt; ...</span>
<span class="c">#    net-conf.json:</span>
<span class="c">#    ----</span>
<span class="c">#    {</span>
<span class="c">#      "Network": "10.244.0.0/16",</span>
<span class="c">#      "Backend": {</span>
<span class="c">#        "Type": "vxlan"</span>
<span class="c">#      }</span>
<span class="c">#    }</span>

<span class="c"># ì„¤ì¹˜ ì „ê³¼ ë¹„êµí•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 08:00:27:71:19:d8 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 08:00:27:da:24:93 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    &lt;span style="color: green;"&gt;4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;    link/ether aa:3f:e5:cd:ae:92 brd ff:ff:ff:ff:ff:ff&lt;/span&gt;</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>10.244.
<span class="c"># =&gt; 10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink</span>
<span class="c">#    10.244.2.0/24 via 10.244.2.0 dev flannel.1 onlink</span>

<span class="nv">$ </span>ping <span class="nt">-c</span> 1 10.244.1.0
<span class="c"># =&gt; PING 10.244.1.0 (10.244.1.0) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 10.244.1.0: icmp_seq=1 ttl=64 time=1.31 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 10.244.1.0 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.314/1.314/1.314/0.000 ms</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 10.244.2.0
<span class="c"># =&gt; PING 10.244.2.0 (10.244.2.0) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 10.244.2.0: icmp_seq=1 ttl=64 time=1.31 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 10.244.2.0 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.312/1.312/1.312/0.000 ms</span>

<span class="nv">$ </span>brctl show
<span class="nv">$ </span>iptables-save
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables-save <span class="o">&gt;</span> iptables-after-flannel.txt
<span class="c"># ì„¤ì¹˜ ì „ê³¼ í›„ì˜ iptables ì„¤ì •ì„ ë¹„êµí•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>diff <span class="nt">-u</span> iptables-before-flannel.txt iptables-after-flannel.txt

<span class="c"># k8s-w1, k8s-w2 ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> <span class="nb">link</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> brctl show <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<h3 id="ìƒ˜í”Œ-ì• í”Œë¦¬ì¼€ì´ì…˜-ë°°í¬-ë°-í™•ì¸">ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° í™•ì¸</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># k8s-ctr ë…¸ë“œì— curl-pod íŒŒë“œ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
    - name: curl
      image: alpine/curl
      command: ["sleep", "36000"]
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>

<span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œ(k8s-ctr)ì—ì„œ íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>crictl ps
<span class="c"># =&gt; CONTAINER     IMAGE         CREATED        STATE   NAME                    ATTEMPT POD ID        POD                               NAMESPACE</span>
<span class="c">#    ba7ddc59fa138 1fb7da88b3320 1 second ago   Running curl                    0       a87775d3d7098 &lt;span style="color: green;"&gt;curl-pod&lt;/span&gt;                          default</span>
<span class="c">#    2c095a0d795b7 83a2e3e54aa1e 19 minutes ago Running kube-flannel            0       49d7f057d7491 kube-flannel-ds-lsf7h             kube-flannel</span>
<span class="c">#    13ff95772dd16 738e99dbd7325 35 minutes ago Running kube-proxy              3       0ce95a5226767 kube-proxy-r96sz                  kube-system</span>
<span class="c">#    625a7ec089f93 c03972dff86ba 35 minutes ago Running kube-scheduler          3       7691ca47ac391 kube-scheduler-k8s-ctr            kube-system</span>
<span class="c">#    3b02267780926 ef439b94d49d4 35 minutes ago Running kube-controller-manager 3       232075758b77f kube-controller-manager-k8s-ctr   kube-system</span>
<span class="c">#    f956731d12744 31747a36ce712 35 minutes ago Running etcd                    3       7ac2514bac9cb etcd-k8s-ctr                      kube-system</span>
<span class="c">#    9f50506b3ca66 c0425f3fe3fbf 35 minutes ago Running kube-apiserver          3       d5246dd2d31b9 kube-apiserver-k8s-ctr            kube-system</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ curl-podëŠ” nodeName: ì„ í†µí•´ ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œ(k8s-ctr)ì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì›Œì»¤ ë…¸ë“œ(k8s-w1, k8s-w2)ì—ì„œ íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>crictl ps <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; CONTAINER     IMAGE         CREATED        STATE   NAME                    ATTEMPT POD ID        POD                       NAMESPACE</span>
<span class="c">#    c934a221a4fec ab541801c8cc5 57 seconds ago Running webpod                  0       7323e0f4eced8 &lt;span style="color: green;"&gt;webpod-697b545f57-7j5vt&lt;/span&gt;   default</span>
<span class="c">#    c6a1e24ae6193 83a2e3e54aa1e 20 minutes ago Running kube-flannel            0       3a86bc505126a kube-flannel-ds-5fm6l     kube-flannel</span>
<span class="c">#    b55a66b5cd0a6 738e99dbd7325 35 minutes ago Running kube-proxy              2       8bc7a54488b35 kube-proxy-hdffr          kube-system</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    CONTAINER     IMAGE         CREATED        STATE   NAME                    ATTEMPT POD ID              POD                        NAMESPACE</span>
<span class="c">#    54658fa9cfc29 ab541801c8cc5 58 seconds ago Running webpod                  0       8dec7a5a7aed1 &lt;span style="color: green;"&gt;webpod-697b545f57-sdv4l&lt;/span&gt;    default</span>
<span class="c">#    9b2a414ee1acc f72407be9e08c 19 minutes ago Running coredns                 0       23071bf7a21e4 coredns-674b8bbfcf-rtx95   kube-system</span>
<span class="c">#    e1c86c4fa20fe f72407be9e08c 20 minutes ago Running coredns                 0       757397c6bcd8f coredns-674b8bbfcf-79mbb   kube-system</span>
<span class="c">#    eeac62c8beba7 83a2e3e54aa1e 20 minutes ago Running kube-flannel            0       1b4ba4f721424 kube-flannel-ds-dstmv      kube-flannel</span>
<span class="c">#    0a6112c11e948 738e99dbd7325 35 minutes ago Running kube-proxy              2       f9f19975aed04 kube-proxy-swgmb           kube-system</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ webpodëŠ” ë³„ë„ë¡œ nodeName: ì„ ì§€ì •í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ì›Œì»¤ ë…¸ë“œ(k8s-w1, k8s-w2)ì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   2/2     2            2           18m   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.62.184   &lt;none&gt;        80/TCP    18m   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                     AGE</span>
<span class="c">#    endpoints/webpod   10.244.1.2:80,10.244.2.4:80   18m</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl api-resources | <span class="nb">grep</span> <span class="nt">-i</span> endpoint
<span class="c"># =&gt; endpoints                           ep           v1                                true         Endpoints</span>
<span class="c">#    endpointslices                                   discovery.k8s.io/v1               true         EndpointSlice</span>

<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="c"># =&gt; NAME           ADDRESSTYPE   PORTS   ENDPOINTS               AGE</span>
<span class="c">#    webpod-9pfs7   IPv4          80      10.244.2.4,10.244.1.2   18m</span>

<span class="c"># ë°°í¬ ì „ê³¼ ë¹„êµí•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 08:00:27:71:19:d8 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 08:00:27:da:24:93 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default</span>
<span class="c">#        link/ether aa:3f:e5:cd:ae:92 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    5: cni0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether b2:e2:a2:aa:4e:5c brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    &lt;span style="color: green;"&gt;6: veth0911be7c@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master cni0 state UP mode DEFAULT group default qlen 1000&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;    link/ether 6a:8b:92:5e:74:b3 brd ff:ff:ff:ff:ff:ff link-netns cni-15400ffe-d5f7-c6c2-78d9-dbbbc2f08db7&lt;/span&gt;</span>
<span class="nv">$ </span>brctl show
<span class="c"># =&gt; bridge name     bridge id               STP enabled     interfaces</span>
<span class="c">#    cni0            8000.b2e2a2aa4e5c       no              veth0911be7c</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ veth ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ íŒŒë“œì™€ ì—°ê²°ëœ cni0 ë¸Œë¦¿ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>iptables-save
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables-save <span class="o">&gt;</span> iptables-after-deployment.txt
<span class="nv">$ </span>diff iptables-after-flannel.txt iptables-after-deployment.txt
<span class="c"># =&gt; ...</span>
<span class="c">#    62a63,64</span>
<span class="c">#    &gt; :KUBE-SEP-PQBQBGZJJ5FKN3TB - [0:0]</span>
<span class="c">#    &gt; :KUBE-SEP-R5LRHDMUTGTM635J - [0:0]</span>
<span class="c">#    66a69</span>
<span class="c">#    &gt; :KUBE-SVC-CNZCPOCNCNOROALA - [0:0]</span>
<span class="c">#    92a96,99</span>
<span class="c">#    &gt; -A KUBE-SEP-PQBQBGZJJ5FKN3TB -s 10.244.1.2/32 -m comment --comment "default/webpod" -j KUBE-MARK-MASQ</span>
<span class="c">#    &gt; -A KUBE-SEP-PQBQBGZJJ5FKN3TB -p tcp -m comment --comment "default/webpod" -m tcp -j DNAT --to-destination 10.244.1.2:80</span>
<span class="c">#    &gt; -A KUBE-SEP-R5LRHDMUTGTM635J -s 10.244.2.4/32 -m comment --comment "default/webpod" -j KUBE-MARK-MASQ</span>
<span class="c">#    &gt; -A KUBE-SEP-R5LRHDMUTGTM635J -p tcp -m comment --comment "default/webpod" -m tcp -j DNAT --to-destination 10.244.2.4:80</span>
<span class="c">#    98a106</span>
<span class="c">#    &gt; -A KUBE-SERVICES -d 10.96.62.184/32 -p tcp -m comment --comment "default/webpod cluster IP" -m tcp --dport 80 -j KUBE-SVC-CNZCPOCNCNOROALA</span>
<span class="c">#    103a112,114</span>
<span class="c">#    &gt; -A KUBE-SVC-CNZCPOCNCNOROALA ! -s 10.244.0.0/16 -d 10.96.62.184/32 -p tcp -m comment --comment "default/webpod cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ</span>
<span class="c">#    &gt; -A KUBE-SVC-CNZCPOCNCNOROALA -m comment --comment "default/webpod -&gt; 10.244.1.2:80" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-PQBQBGZJJ5FKN3TB</span>
<span class="c">#    &gt; -A KUBE-SVC-CNZCPOCNCNOROALA -m comment --comment "default/webpod -&gt; 10.244.2.4:80" -j KUBE-SEP-R5LRHDMUTGTM635J</span>
<span class="c">#    ...</span>

<span class="c"># k8s-w1, k8s-w2 ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> <span class="nb">link</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    ...</span>
<span class="c">#    5: cni0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 56:8b:b8:09:e1:a0 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    6: veth52205e86@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master cni0 state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether ba:b1:d5:a8:5e:c6 brd ff:ff:ff:ff:ff:ff link-netns cni-42b4483c-e253-de82-a5c3-2cbf657cc6ed</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    ...</span>
<span class="c">#    5: cni0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether b6:aa:16:04:b0:58 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    6: veth605dad7b@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master cni0 state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 36:5a:70:ff:de:e9 brd ff:ff:ff:ff:ff:ff link-netns cni-e020c420-373a-900d-bf44-34fbe4622f7e</span>
<span class="c">#    7: veth002efe84@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master cni0 state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether be:86:35:e2:1a:5d brd ff:ff:ff:ff:ff:ff link-netns cni-af271963-86ee-26b6-35b9-39173672cd1a</span>
<span class="c">#    8: veth1dce6530@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master cni0 state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether fa:d9:af:04:69:e2 brd ff:ff:ff:ff:ff:ff link-netns cni-ca1eedc6-43ff-e346-318d-ba345e0ba532</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> brctl show <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>í†µì‹  í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE   IP           NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    webpod-697b545f57-7j5vt   1/1     Running   0          24m   10.244.1.2   k8s-w1   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-sdv4l   1/1     Running   0          24m   10.244.2.4   k8s-w2   &lt;none&gt;           &lt;none&gt;</span>
<span class="nv">$ POD1IP</span><span class="o">=</span>10.244.1.2
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nv">$POD1IP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-7j5vt</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 10.244.1.2</span>
<span class="c">#    IP: fe80::dc28:1fff:fe46:abd0</span>
<span class="c">#    RemoteAddr: 10.244.0.2:46774</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 10.244.1.2</span>
<span class="c">#    User-Agent: curl/8.14.1</span>
<span class="c">#    Accept: */*</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc,ep webpod
<span class="c"># =&gt; NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/webpod   ClusterIP   10.96.62.184   &lt;none&gt;        80/TCP    25m</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                     AGE</span>
<span class="c">#    endpoints/webpod   10.244.1.2:80,10.244.2.4:80   25m</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod
<span class="c"># =&gt; Hostname: webpod-697b545f57-7j5vt</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 10.244.1.2</span>
<span class="c">#    IP: fe80::dc28:1fff:fe46:abd0</span>
<span class="c">#    RemoteAddr: 10.244.0.2:55684</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: webpod</span>
<span class="c">#    User-Agent: curl/8.14.1</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-7j5vt</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s webpod | grep Hostname; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-7j5vt</span>
<span class="c">#    Hostname: webpod-697b545f57-sdv4l</span>
<span class="c">#    Hostname: webpod-697b545f57-7j5vt</span>
<span class="c">#    ...</span>

<span class="c"># Service ë™ì‘ ì²˜ë¦¬ì— iptables ê·œì¹™ í™œìš© í™•ì¸ &gt;&gt; Service ê°€ 100ê°œ , 1000ê°œ , 10000ê°œ ì¦ê°€ ë˜ë©´???</span>
<span class="nv">$ </span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.clusterIP}"</span>
<span class="c"># =&gt; 10.96.62.184</span>
<span class="nv">$ SVCIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.clusterIP}"</span><span class="si">)</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nv">$SVCIP</span>
<span class="c"># =&gt; -A KUBE-SERVICES -d 10.96.62.184/32 -p tcp -m comment --comment "default/webpod cluster IP" -m tcp --dport 80 -j KUBE-SVC-CNZCPOCNCNOROALA</span>
<span class="c">#    -A KUBE-SVC-CNZCPOCNCNOROALA ! -s 10.244.0.0/16 -d 10.96.62.184/32 -p tcp -m comment --comment "default/webpod cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nv">$SVCIP</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    -A KUBE-SERVICES -d 10.96.62.184/32 -p tcp -m comment --comment "default/webpod cluster IP" -m tcp --dport 80 -j KUBE-SVC-CNZCPOCNCNOROALA</span>
<span class="c">#    -A KUBE-SVC-CNZCPOCNCNOROALA ! -s 10.244.0.0/16 -d 10.96.62.184/32 -p tcp -m comment --comment "default/webpod cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    -A KUBE-SERVICES -d 10.96.62.184/32 -p tcp -m comment --comment "default/webpod cluster IP" -m tcp --dport 80 -j KUBE-SVC-CNZCPOCNCNOROALA</span>
<span class="c">#    -A KUBE-SVC-CNZCPOCNCNOROALA ! -s 10.244.0.0/16 -d 10.96.62.184/32 -p tcp -m comment --comment "default/webpod cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ</span>
</code></pre></div></div>

<ul>
  <li>ëŒ€ê·œëª¨ í™˜ê²½ì—ì„œ iptables ë‹¨ì 
    <ul>
      <li>kube-proxyì— ì˜í•´ ìƒì„±ë˜ëŠ” iptables ê·œì¹™ì´ ë§ì•„ì§ˆìˆ˜ë¡ ì„±ëŠ¥ ì €í•˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>íŠ¹íˆ, ë§ì€ ìˆ˜ì˜ ì„œë¹„ìŠ¤ê°€ ìˆëŠ” ê²½ìš° iptables ê·œì¹™ì´ ê¸‰ê²©íˆ ì¦ê°€í•˜ì—¬ ì„±ëŠ¥ì— ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>í…ŒìŠ¤íŠ¸ í´ëŸ¬ìŠ¤í„°ì—ì„œ 3800ê°œ ë…¸ë“œì˜ 19000ê°œ íŒŒë“œë¥¼ ë°°í¬í•œ ê²°ê³¼, iptables ê·œì¹™ì´ 24,000ê°œ ì´ìƒ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
      <li>ì´ë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
        <ul>
          <li>í†µì‹  ì—°ê²°ì‹œ 1.2msì˜ ì§€ì—°ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>
          <li>í´ëŸ¬ìŠ¤í„°ì˜ iptables ê·œì¹™ ê°±ì‹ ì´ 5ë¶„ ì´ìƒ ì†Œìš”ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
          <li>53%ì˜ CPU ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ì´ëŸ¬í•œ ë¬¸ì œë¡œ ì¸í•´ iptablesë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  eBPFì„ ì‚¬ìš©í•˜ëŠ” cilium ê³¼ ê°™ì€ CNI í”ŒëŸ¬ê·¸ì¸ì´ ëŒ€ì•ˆìœ¼ë¡œ ì¸ê¸°ë¥¼ ì–»ê³  ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h2 id="cilium-cni">Cilium CNI</h2>

<h3 id="cilium-cni-ì†Œê°œ">Cilium CNI ì†Œê°œ</h3>

<ul>
  <li><strong>Cilium</strong>ì€ ê¸°ì¡´ì˜ ë³µì¡í•œ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ <strong>eBPF</strong>ë¥¼ í†µí•´ <strong>ê°„ì†Œí™”</strong>í•˜ê³ , <strong>ë¹ ë¥´ê²Œ ì²˜ë¦¬</strong>í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” CNI í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</li>
  <li>iptables ê¸°ë°˜ì˜ kube-proxyë¥¼ ëŒ€ì²´í•˜ì—¬, ì•ì„œ ì‚´í´ë³¸ ê¸°ì¡´ì˜ Iptables ê¸°ë°˜ì˜ CNI í”ŒëŸ¬ê·¸ì¸ ë“¤ì˜ ë‹¨ì ì„ ëŒ€ë¶€ë¶„ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_5.png" alt="img.png" class="image-center w-80" />
<em class="image-caption"><a href="https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/">https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/</a></em></p>

<ul>
  <li>Cilium eBPFëŠ” ì¶”ê°€ì ì¸ ì½”ë“œ ìˆ˜ì •ì´ë‚˜ ì„¤ì • ë³€ê²½ì—†ì´, ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ ë™ì‘í•˜ëŠ” Bytecodeë¥¼ ììœ ë¡­ê²Œ í”„ë¡œê·¸ë˜ë°í•˜ì—¬ ì»¤ë„ì— ë¡œë”©ì‹œì¼œ ë™ì‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. <a href="https://www.youtube.com/watch?v=qsnR-s4XuGo&amp;t=1059s">ë§í¬</a>
<img src="/assets/2025/cilium/w1/20250720_cilium_w1_19.png" alt="img.png" /></li>
  <li>ë˜í•œ eBPFëŠ” ëª¨ë“  íŒ¨í‚·ì„ ê°€ë¡œì±„ê¸° ìœ„í•´ì„œ ìˆ˜ì‹  NICì˜ ingress TC(<a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/">Traffic Control</a>) hooksë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_6.png" alt="img.png" class="image-center w-60" />
<em class="image-caption">NICì˜ TC Hooksì— eBPF í”„ë¡œê·¸ë¨ì´ attach ëœ ì˜ˆ</em></li>
  <li>Ciliumì€ í„°ë„ëª¨ë“œ(VXLAN, GENEVE), ë„¤ì´í‹°ë¸Œ ë¼ìš°íŒ… ëª¨ë“œì˜ 2ê°€ì§€ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/network/concepts/routing/">Docs</a>
    <ul>
      <li><strong>í„°ë„ëª¨ë“œ</strong> : Ciliumì´ VXLAN(UDP 8472), GENEVE(UDP 6081) ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ ì´ë“¤ì„ í†µí•´ íŠ¸ë˜í”½ì„ ì „ë‹¬í•©ë‹ˆë‹¤. Encapsulation ëª¨ë“œë¼ê³ ë„ í•©ë‹ˆë‹¤.</li>
      <li><strong>ë„¤ì´í‹°ë¸Œ ë¼ìš°íŒ… ëª¨ë“œ</strong> : Ciliumê°€ íŒ¨í‚· ì „ë‹¬ì„ ìœ„í•´ êµ¬ì„±ì„ ë³€ê²½í•˜ì§€ ì•Šê³ , ì™¸ë¶€ì—ì„œ ì œê³µë˜ëŠ” íŒ¨í‚· ì „ë‹¬ ë°©ë²•(í´ë¼ìš°ë“œ ë˜ëŠ” BGP ë¼ìš°íŒ…ë“±)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. Direct Routing ëª¨ë“œë¼ê³ ë„ í•©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_7.png" alt="img.png" class="image-center w-80" />
<img src="/assets/2025/cilium/w1/20250720_cilium_w1_16.png" alt="img.png" /></li>
    </ul>
  </li>
  <li>2021ë…„ 10ì›” Ciliumì€ CNCFì— ì±„íƒë˜ì—ˆìŠµë‹ˆë‹¤. <a href="https://cilium.io/blog/2021/10/13/cilium-joins-cncf/">ë§í¬</a></li>
  <li>Googke GKE dataplaneê³¼ AWS EKS Anywhereì—ì„œ ê¸°ë³¸ CNIë¡œ Ciliumì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. <a href="https://isovalent.com/blog/post/2021-09-aws-eks-anywhere-chooses-cilium/">ë§í¬</a></li>
  <li>Ciliumì€ Kube-Proxyë¥¼ 100% ëŒ€ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    <ul>
      <li>iptablesë¥¼ ê±°ì˜ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ ë™ì‘í•˜ë©°, ì´ë¥¼ í†µí•´ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>í•˜ì§€ë§Œ istio, FHRP, VRRP ë“±ê³¼ ê°™ì´ iptables ê¸°ëŠ¥ì„ í™œìš©í•˜ëŠ” ë™ì‘ë“¤ì€ ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©°, ì°¨ì¸° í•´ê²°í•´ ë‚˜ê°€ê³  ìˆìŠµë‹ˆë‹¤.</li>
      <li>ë™ì‘ ì†Œê°œ 1 - <a href="https://www.youtube.com/watch?v=yKPNmhckJHY">Youtube</a></li>
      <li>ë™ì‘ ì†Œê°œ 2 : ByteDance ì‚¬ë¡€ - <a href="https://www.youtube.com/watch?v=cKPW67D7X10">Youtube</a>, <a href="https://kccncchn2025.sched.com/event/1x5hK/simplifying-the-networking-and-security-stack-with-cilium-hubble-and-tetragon-liyi-huang-isovalent-at-cisco-kaixi-fan-bytedance">CNCF</a></li>
    </ul>
  </li>
  <li>êµ¬ì„±ìš”ì†Œ - <a href="https://ssup2.github.io/blog-software/docs/theory-analysis/kubernetes-cilium-plugin/">ë§í¬</a>
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_8.png" alt="img.png" class="image-center w-80" />
<em class="image-caption">Cilium ì•„í‚¤í…ì³ - <a href="https://github.com/cilium/cilium">ì¶œì²˜</a></em>
    <ul>
      <li>Cilium <strong>Operator</strong> : K8S í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ í•œ ë²ˆì”© ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ì‘ì—…ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
      <li>Cilium <strong>Agent</strong> : ë°ëª¬ì…‹ìœ¼ë¡œ ì‹¤í–‰, K8S API ì„¤ì •ìœ¼ë¡œ ë¶€í„° â€˜ë„¤íŠ¸ì›Œí¬ ì„¤ì •, ë„¤íŠ¸ì›Œí¬ ì •ì±…, ì„œë¹„ìŠ¤ ë¶€í•˜ë¶„ì‚°, ëª¨ë‹ˆí„°ë§â€™ ë“±ì„ ìˆ˜í–‰í•˜ë©°, eBPF í”„ë¡œê·¸ë¨ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
      <li>Cilium <strong>Client</strong> (CLI) : Cilium ì»¤ë©˜ë“œíˆ´ë¡œ eBPF maps ì— ì§ì ‘ ì ‘ì†í•˜ì—¬ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>Hubble</strong> : ë„¤íŠ¸ì›Œí¬ì™€ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ í”Œë«í¼ ì—­í• ì„ í•˜ì—¬, Server, Relay, Client, Graphical UI ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>Data Store</strong> : Cilium Agent ê°„ì˜ ìƒíƒœë¥¼ ì €ì¥í•˜ê³  ì „íŒŒí•˜ëŠ” ë°ì´í„° ì €ì¥ì†Œ, 2ê°€ì§€ ì¢…ë¥˜ ì¤‘ ì„ íƒ(K8S CRDs, Key-Value Store)í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w1/20250720_cilium_w1_17.png" alt="img.png" />
<img src="/assets/2025/cilium/w1/20250720_cilium_w1_18.png" alt="img_1.png" /></li>
    </ul>
  </li>
</ul>

<h3 id="cilium-cni-ì„¤ì¹˜">Cilium CNI ì„¤ì¹˜</h3>

<h4 id="cilium-ì‹œìŠ¤í…œ-ìš”êµ¬-ì‚¬í•­-í™•ì¸---ê³µì‹-ë¬¸ì„œ">Cilium ì‹œìŠ¤í…œ ìš”êµ¬ ì‚¬í•­ í™•ì¸ - <a href="https://docs.cilium.io/en/stable/operations/system_requirements/">ê³µì‹ ë¬¸ì„œ</a></h4>

<ul>
  <li>AMD64 ë˜ëŠ” AArch64 CPU ì•„í‚¤í…ì²˜ë¥¼ ì‚¬ìš©í•˜ëŠ” í˜¸ìŠ¤íŠ¸</li>
  <li><a href="https://docs.cilium.io/en/stable/operations/system_requirements/#linux-kernel">Linux ì»¤ë„</a> 5.4 ì´ìƒ ë˜ëŠ” ë™ë“± ë²„ì „(ì˜ˆ: RHEL 8.6ì˜ ê²½ìš° 4.18)
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">arch</span>
<span class="c"># =&gt; aarch64</span>
      
<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-r</span>
<span class="c"># =&gt; 6.8.0-53-generic</span>
</code></pre></div>    </div>
  </li>
  <li>ì»¤ë„ êµ¬ì„± ì˜µì…˜ í™œì„±í™”
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [ì»¤ë„ êµ¬ì„± ì˜µì…˜] ê¸°ë³¸ ìš”êµ¬ ì‚¬í•­ </span>
<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'CONFIG_BPF|CONFIG_BPF_SYSCALL|CONFIG_NET_CLS_BPF|CONFIG_BPF_JIT|CONFIG_NET_CLS_ACT|CONFIG_NET_SCH_INGRESS|CONFIG_CRYPTO_SHA1|CONFIG_CRYPTO_USER_API_HASH|CONFIG_CGROUPS|CONFIG_CGROUP_BPF|CONFIG_PERF_EVENTS|CONFIG_SCHEDSTATS'</span> /boot/config-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>
<span class="c"># =&gt; CONFIG_BPF=y</span>
<span class="c">#    CONFIG_BPF_SYSCALL=y</span>
<span class="c">#    CONFIG_BPF_JIT=y</span>
<span class="c">#    CONFIG_BPF_JIT_ALWAYS_ON=y</span>
<span class="c">#    CONFIG_BPF_JIT_DEFAULT_ON=y</span>
<span class="c">#    CONFIG_BPF_UNPRIV_DEFAULT_OFF=y</span>
<span class="c">#    # CONFIG_BPF_PRELOAD is not set</span>
<span class="c">#    CONFIG_BPF_LSM=y</span>
<span class="c">#    CONFIG_CGROUPS=y</span>
<span class="c">#    CONFIG_CGROUP_BPF=y</span>
<span class="c">#    CONFIG_PERF_EVENTS=y</span>
<span class="c">#    CONFIG_NET_SCH_INGRESS=m</span>
<span class="c">#    CONFIG_NET_CLS_BPF=m</span>
<span class="c">#    CONFIG_NET_CLS_ACT=y</span>
<span class="c">#    CONFIG_BPF_STREAM_PARSER=y</span>
<span class="c">#    CONFIG_CRYPTO_SHA1=y</span>
<span class="c">#    CONFIG_CRYPTO_USER_API_HASH=m</span>
<span class="c">#    CONFIG_CRYPTO_SHA1_ARM64_CE=m</span>
<span class="c">#    CONFIG_SCHEDSTATS=y</span>
<span class="c">#    CONFIG_BPF_EVENTS=y</span>
<span class="c">#    CONFIG_BPF_KPROBE_OVERRIDE=y</span>
    
<span class="c"># [ì»¤ë„ êµ¬ì„± ì˜µì…˜] Requirements for Tunneling and Routing</span>
<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'CONFIG_VXLAN=y|CONFIG_VXLAN=m|CONFIG_GENEVE=y|CONFIG_GENEVE=m|CONFIG_FIB_RULES=y'</span> /boot/config-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>
<span class="nv">$ CONFIG_FIB_RULES</span><span class="o">=</span>y <span class="c"># ì»¤ë„ì— ë‚´ì¥ë¨</span>
<span class="nv">$ CONFIG_VXLAN</span><span class="o">=</span>m <span class="c"># ëª¨ë“ˆë¡œ ì»´íŒŒì¼ë¨ â†’ ì»¤ë„ì— ë¡œë“œí•´ì„œ ì‚¬ìš©</span>
<span class="nv">$ CONFIG_GENEVE</span><span class="o">=</span>m <span class="c"># ëª¨ë“ˆë¡œ ì»´íŒŒì¼ë¨ â†’ ì»¤ë„ì— ë¡œë“œí•´ì„œ ì‚¬ìš©</span>
    
<span class="c">## (ì°¸ê³ ) ì»¤ë„ ë¡œë“œ</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span>
<span class="c"># =&gt; vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  1 vxlan</span>
<span class="c">#    udp_tunnel             36864  1 vxlan</span>
<span class="nv">$ </span>modprobe geneve
<span class="nv">$ </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span>
<span class="c"># =&gt; geneve                 45056  0</span>
<span class="c">#    vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  2 geneve,vxlan</span>
<span class="c">#    udp_tunnel             36864  2 geneve,vxlan</span>
    
<span class="c"># [ì»¤ë„ êµ¬ì„± ì˜µì…˜] Requirements for L7 and FQDN Policies</span>
<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'CONFIG_NETFILTER_XT_TARGET_TPROXY|CONFIG_NETFILTER_XT_TARGET_MARK|CONFIG_NETFILTER_XT_TARGET_CT|CONFIG_NETFILTER_XT_MATCH_MARK|CONFIG_NETFILTER_XT_MATCH_SOCKET'</span> /boot/config-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>
<span class="c"># =&gt; CONFIG_NETFILTER_XT_TARGET_CT=m</span>
<span class="c">#    CONFIG_NETFILTER_XT_TARGET_MARK=m</span>
<span class="c">#    CONFIG_NETFILTER_XT_TARGET_TPROXY=m</span>
<span class="c">#    CONFIG_NETFILTER_XT_MATCH_MARK=m</span>
<span class="c">#    CONFIG_NETFILTER_XT_MATCH_SOCKET=m</span>
    
<span class="c"># [ì»¤ë„ êµ¬ì„± ì˜µì…˜] Requirements for Netkit Device Mode</span>
<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'CONFIG_NETKIT=y|CONFIG_NETKIT=m'</span> /boot/config-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>
<span class="c"># =&gt; CONFIG_NETKIT=y</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ê³ ê¸‰ ê¸°ëŠ¥ ë™ì‘ì„ ìœ„í•œ ìµœì†Œ ì»¤ë„ ë²„ì „ - <a href="https://docs.cilium.io/en/stable/operations/system_requirements/#required-kernel-versions-for-advanced-features">Docs</a></p>

    <table>
      <thead>
        <tr>
          <th><strong>Cilium Feature</strong></th>
          <th><strong>Minimum Kernel Version</strong></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><a href="https://docs.cilium.io/en/stable/security/network/encryption-wireguard/#encryption-wg">WireGuard Transparent Encryption</a></td>
          <td>&gt;= 5.6</td>
        </tr>
        <tr>
          <td>Full support forÂ <a href="https://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/#session-affinity">Session Affinity</a></td>
          <td>&gt;= 5.7</td>
        </tr>
        <tr>
          <td>BPF-based proxy redirection</td>
          <td>&gt;= 5.7</td>
        </tr>
        <tr>
          <td>Socket-level LB bypass in pod netns</td>
          <td>&gt;= 5.7</td>
        </tr>
        <tr>
          <td>L3 devices</td>
          <td>&gt;= 5.8</td>
        </tr>
        <tr>
          <td><strong>BPF-based host routing</strong></td>
          <td><strong>&gt;= 5.10</strong></td>
        </tr>
        <tr>
          <td><a href="https://docs.cilium.io/en/stable/network/multicast/#enable-multicast">Multicast Support in Cilium (Beta)</a>Â (AMD64)</td>
          <td>&gt;= 5.10</td>
        </tr>
        <tr>
          <td>IPv6 BIG TCP support</td>
          <td>&gt;= 5.19</td>
        </tr>
        <tr>
          <td><a href="https://docs.cilium.io/en/stable/network/multicast/#enable-multicast">Multicast Support in Cilium (Beta)</a>Â (AArch64)</td>
          <td>&gt;= 6.0</td>
        </tr>
        <tr>
          <td><strong>IPv4 BIG TCP support</strong></td>
          <td><strong>&gt;= 6.3</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>Cilium ë™ì‘(Node ê°„)ì„ ìœ„í•œ ë°©í™”ë²½ ê·œì¹™ : í•´ë‹¹ í¬íŠ¸ ì¸/ì•„ì›ƒ í—ˆìš© í•„ìš” - <a href="https://docs.cilium.io/en/stable/operations/system_requirements/#firewall-rules">Docs</a></li>
  <li><strong>Mounted eBPF filesystem</strong> : ì¼ë¶€ ë°°í¬íŒ ë§ˆìš´íŠ¸ë˜ì–´ ìˆìŒ, í˜¹ì€ Cilium ì„¤ì¹˜ ì‹œ ë§ˆìš´íŠ¸ ì‹œë„ - <a href="https://docs.cilium.io/en/stable/operations/system_requirements/#mounted-ebpf-filesystem">Docs</a>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># eBPF íŒŒì¼ ì‹œìŠ¤í…œ ë§ˆìš´íŠ¸ í™•ì¸</span>
<span class="nv">$ </span>mount | <span class="nb">grep</span> /sys/fs/bpf
<span class="c"># =&gt; bpf on /sys/fs/bpf type bpf (rw,nosuid,nodev,noexec,relatime,mode=700)</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Privileges</strong> : Cilium ë™ì‘ì„ ìœ„í•´ì„œ ê´€ë¦¬ì ìˆ˜ì¤€ ê¶Œí•œ í•„ìš” - <a href="https://docs.cilium.io/en/stable/operations/system_requirements/#privileges">Docs</a>
    <ul>
      <li>ciliumì€ ë„¤íŠ¸ì›Œí‚¹ ì‘ì—…ê³¼ ë³´ì•ˆ ì •ì±…ì„ êµ¬í˜„í•˜ëŠ” eBPF í”„ë¡œê·¸ë¨ ì„¤ì¹˜ë¥¼ ìœ„í•´ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ê³¼ ìƒí˜¸ì‘ìš©í•©ë‹ˆë‹¤. 
ì´ ì‘ì—…ì€ ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•˜ë©°, ciliumì€ ì´ë¥¼ ìœ„í•´ <code class="language-plaintext highlighter-rouge">CAP_SYS_ADMIN</code> ê¶Œí•œì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ë˜í•œ í•´ë‹¹ ê¶Œí•œì€ cilium-agent ì»¨í…Œì´ë„ˆì— ë¶€ì—¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>ê°€ì¥ í¸ë¦¬í•œ ë°©ë²•ì€ cilium-agentë¥¼ <code class="language-plaintext highlighter-rouge">root</code> ì‚¬ìš©ìë‚˜ privileged ëª¨ë“œë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</li>
      <li>ciliumì€ ë˜í•œ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí‚¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ì„ í•„ìš”ë¡œ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ cilium íŒŒë“œëŠ” í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí‚¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì§ì ‘ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h4 id="kube-proxy-ì œê±°">kube-proxy ì œê±°</h4>

<ul>
  <li>ê¸°ì¡´ Flannel CNIë¥¼ ì œê±°í•©ë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>helm uninstall <span class="nt">-n</span> kube-flannel flannel
<span class="c"># =&gt; release "flannel" uninstalled</span>
<span class="nv">$ </span>helm list <span class="nt">-A</span>
<span class="c"># =&gt; NAME    NAMESPACE       REVISION        UPDATED STATUS  CHART   APP VERSION</span>
  
<span class="c">#</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> kube-flannel
<span class="nv">$ </span><span class="o">=&gt;</span> No resources found <span class="k">in </span>kube-flannel namespace.
<span class="nv">$ </span>kubectl delete ns kube-flannel
<span class="c"># =&gt; namespace "kube-flannel" deleted</span>
  
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
</code></pre></div>    </div>
  </li>
  <li>k8s-ctr, k8s-w1, k8s-w2 ëª¨ë“  ë…¸ë“œì—ì„œ ì•„ë˜ ì‹¤í–‰í•˜ì—¬ flannel ê´€ë ¨ëœ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì œê±° ì „ í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default</span>
<span class="c">#        link/ether aa:3f:e5:cd:ae:92 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    5: cni0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 1e:a9:44:a0:00:e1 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    6: veth322e34b5@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master cni0 state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 8e:ea:40:c5:46:a7 brd ff:ff:ff:ff:ff:ff link-netns cni-62beabc5-97a9-e6cf-7f8f-bd4de413d33c</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> <span class="nb">link</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    ...</span>
<span class="c">#    4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default</span>
<span class="c">#        link/ether c2:b2:62:af:c2:93 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    5: cni0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 06:8a:4c:62:12:de brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    6: vethd8fb7cb1@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master cni0 state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether e2:3f:03:c3:be:a2 brd ff:ff:ff:ff:ff:ff link-netns cni-81f15ae4-4a35-bce7-f755-657f3b8e39ea</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    ...</span>
<span class="c">#    4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default</span>
<span class="c">#        link/ether 02:dd:56:d3:f6:3f brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    5: cni0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 06:57:05:39:42:57 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    6: veth390f8e9e@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master cni0 state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 5a:23:ff:ba:28:90 brd ff:ff:ff:ff:ff:ff link-netns cni-a27cec88-43c0-acf5-0bc5-f64e945bded3</span>
<span class="c">#    7: veth357a49b9@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master cni0 state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether b6:6c:69:43:29:a6 brd ff:ff:ff:ff:ff:ff link-netns cni-36af9b39-bcb8-ad52-beb5-4b67475b404f</span>
<span class="c">#    8: vethf9bb5584@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master cni0 state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 4a:7c:ab:42:e7:ca brd ff:ff:ff:ff:ff:ff link-netns cni-29e132ee-4860-b74c-c4f5-d5d27b341b83</span>

<span class="nv">$ </span>brctl show
<span class="c"># =&gt; bridge name     bridge id               STP enabled     interfaces</span>
<span class="c">#    cni0            8000.1ea944a000e1       no              veth322e34b5</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> brctl show <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    bridge name     bridge id               STP enabled     interfaces</span>
<span class="c">#    cni0            8000.068a4c6212de       no              vethd8fb7cb1</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    bridge name     bridge id               STP enabled     interfaces</span>
<span class="c">#    cni0            8000.065705394257       no              veth357a49b9</span>
<span class="c">#                                                            veth390f8e9e</span>
<span class="c">#                                                            vethf9bb5584</span>

<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.244.0.0/24 dev cni0 proto kernel scope link src 10.244.0.1</span>
<span class="c">#    10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink</span>
<span class="c">#    10.244.2.0/24 via 10.244.2.0 dev flannel.1 onlink</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.244.0.0/24 via 10.244.0.0 dev flannel.1 onlink</span>
<span class="c">#    10.244.1.0/24 dev cni0 proto kernel scope link src 10.244.1.1</span>
<span class="c">#    10.244.2.0/24 via 10.244.2.0 dev flannel.1 onlink</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.101</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.244.0.0/24 via 10.244.0.0 dev flannel.1 onlink</span>
<span class="c">#    10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink</span>
<span class="c">#    10.244.2.0/24 dev cni0 proto kernel scope link src 10.244.2.1</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.102</span>

<span class="c"># vnic ì œê±°</span>
<span class="nv">$ </span>ip <span class="nb">link </span>del flannel.1
<span class="nv">$ </span>ip <span class="nb">link </span>del cni0

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nb">link </span>del flannel.1 <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nb">link </span>del cni0 <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># ì œê±° í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    6: veth322e34b5@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 8e:ea:40:c5:46:a7 brd ff:ff:ff:ff:ff:ff link-netns cni-62beabc5-97a9-e6cf-7f8f-bd4de413d33c</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ flannel.1ê³¼ cni0ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> <span class="nb">link</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="nv">$ </span>brctl show
<span class="c"># =&gt; &lt;span style="color: green;"&gt;ì—†ìŒ&lt;/span&gt;</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> brctl show <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>

<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.101</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.102</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ flannel.1ê³¼ cni0ê°€ ì‚­ì œë˜ì–´, ê´€ë ¨ ë¼ìš°íŒ… ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>ê¸°ì¡´ kube-proxyë¥¼ ì œê±°í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system delete ds kube-proxy
<span class="c"># =&gt; daemonset.apps "kube-proxy" deleted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system delete cm kube-proxy
<span class="c"># =&gt; configmap "kube-proxy" deleted</span>

<span class="c"># ë°°í¬ëœ íŒŒë“œì˜ IPëŠ” ë‚¨ê²¨ì ¸ ìˆìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE     NAME                              READY   STATUS             RESTARTS         AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    default       curl-pod                          1/1     Running            1 (143m ago)     3h1m    10.244.0.3       k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    default       webpod-697b545f57-7j5vt           1/1     Running            1 (142m ago)     3h2m    10.244.1.3       k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    default       webpod-697b545f57-sdv4l           1/1     Running            1 (142m ago)     3h2m    10.244.2.7       k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-79mbb          0/1     CrashLoopBackOff   27 (4m ago)      2d17h   10.244.2.5       k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-rtx95          0/1     CrashLoopBackOff   27 (4m26s ago)   2d17h   10.244.2.6       k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   etcd-k8s-ctr                      1/1     Running            4 (143m ago)     2d17h   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-apiserver-k8s-ctr            1/1     Running            4 (143m ago)     2d17h   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-controller-manager-k8s-ctr   1/1     Running            4 (143m ago)     2d17h   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-scheduler-k8s-ctr            1/1     Running            4 (143m ago)     2d17h   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod
<span class="c"># =&gt; curl: (6) Could not resolve host: webpod</span>
<span class="c">#    command terminated with exit code 6</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ kube-proxyì™€ CNIì˜ ì‚­ì œë¡œ corednsê°€ ë™ì‘í•˜ì§€ ì•Šì•„ì„œ webpod ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>iptables-save

<span class="c"># Run on each node with root permissions:</span>
<span class="nv">$ </span>iptables-save | <span class="nb">grep</span> <span class="nt">-v</span> KUBE | <span class="nb">grep</span> <span class="nt">-v</span> FLANNEL | iptables-restore
<span class="nv">$ </span>iptables-save

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 <span class="s2">"sudo iptables-save | grep -v KUBE | grep -v FLANNEL | sudo iptables-restore"</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 <span class="nb">sudo </span>iptables-save

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w2 <span class="s2">"sudo iptables-save | grep -v KUBE | grep -v FLANNEL | sudo iptables-restore"</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w2 <span class="nb">sudo </span>iptables-save

<span class="c">#</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS       AGE     IP           NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                  1/1     Running   1 (155m ago)   3h14m   10.244.0.3   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-7j5vt   1/1     Running   1 (155m ago)   3h14m   10.244.1.3   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-sdv4l   1/1     Running   1 (155m ago)   3h14m   10.244.2.7   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
</code></pre></div></div>

<ul>
  <li>ë…¸ë“œë³„ íŒŒë“œì— í• ë‹¹ë˜ëŠ” IPAM(PodCIDR) ì •ë³´ë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#--allocate-node-cidrs=true ë¡œ ì„¤ì •ëœ kube-controller-managerì—ì„œ CIDRì„ ìë™ í• ë‹¹í•¨</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'</span>
<span class="c"># =&gt; k8s-ctr 10.244.0.0/24</span>
<span class="c">#    k8s-w1  10.244.1.0/24</span>
<span class="c">#    k8s-w2  10.244.2.0/24</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS       AGE     IP           NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                  1/1     Running   1 (157m ago)   3h15m   10.244.0.3   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-7j5vt   1/1     Running   1 (156m ago)   3h16m   10.244.1.3   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-sdv4l   1/1     Running   1 (156m ago)   3h16m   10.244.2.7   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kc describe pod <span class="nt">-n</span> kube-system kube-controller-manager-k8s-ctr
<span class="c"># =&gt; ...</span>
<span class="c">#       Command:</span>
<span class="c">#          kube-controller-manager</span>
<span class="c">#          --allocate-node-cidrs=true</span>
<span class="c">#          --cluster-cidr=10.244.0.0/16</span>
<span class="c">#          --service-cluster-ip-range=10.96.0.0/16</span>
<span class="c">#    ... </span>
</code></pre></div></div>

<h4 id="cilium-cni-ì„¤ì¹˜-with-helm">Cilium CNI ì„¤ì¹˜ with Helm</h4>

<ul>
  <li>ê´€ë ¨ ë¬¸ì„œ : <a href="https://docs.cilium.io/en/stable/helm-reference/">Helm</a>, <a href="https://docs.cilium.io/en/stable/network/concepts/masquerading/">Masquering</a>, <a href="https://docs.cilium.io/en/stable/network/concepts/ipam/cluster-pool/">ClusterScope</a>, <a href="https://docs.cilium.io/en/stable/network/concepts/routing/">Routing</a></li>
  <li>Cilium 1.17.5 Helm Chart - <a href="https://artifacthub.io/packages/helm/cilium/cilium/1.17.5">ArtifactHub</a>ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì¹˜í•©ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w1/20250720_cilium_w1_3.png" alt="img.png" /></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Cilium ì„¤ì¹˜ with Helm</span>
<span class="nv">$ </span>helm repo add cilium https://helm.cilium.io/
<span class="c"># =&gt; "cilium" has been added to your repositories</span>

<span class="c"># ëª¨ë“  NIC ì§€ì • + bpf.masq=true + NoIptablesRules</span>
<span class="nv">$ </span>helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> 1.17.5 <span class="nt">--namespace</span> kube-system <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.100 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> ipam.mode<span class="o">=</span><span class="s2">"cluster-pool"</span> <span class="se">\</span>
  <span class="nt">--set</span> ipam.operator.clusterPoolIPv4PodCIDRList<span class="o">={</span><span class="s2">"172.20.0.0/16"</span><span class="o">}</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>172.20.0.0/16 <span class="se">\</span>
  <span class="nt">--set</span> endpointRoutes.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> ipv6.enabled<span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; NAME: cilium</span>
<span class="c">#    LAST DEPLOYED: Sat Jul 19 17:34:05 2025</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    You have successfully installed Cilium with Hubble.</span>
<span class="c">#    </span>
<span class="c">#    Your release version is 1.17.5.</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>helm get values cilium <span class="nt">-n</span> kube-system
<span class="c"># =&gt; USER-SUPPLIED VALUES:</span>
<span class="c">#    autoDirectNodeRoutes: true</span>
<span class="c">#    bpf:</span>
<span class="c">#      masquerade: true</span>
<span class="c">#    endpointRoutes:</span>
<span class="c">#      enabled: true</span>
<span class="c">#    installNoConntrackIptablesRules: true</span>
<span class="c">#    ipam:</span>
<span class="c">#      mode: cluster-pool</span>
<span class="c">#      operator:</span>
<span class="c">#        clusterPoolIPv4PodCIDRList:</span>
<span class="c">#        - 172.20.0.0/16</span>
<span class="c">#    ipv4NativeRoutingCIDR: 172.20.0.0/16</span>
<span class="c">#    ipv6:</span>
<span class="c">#      enabled: false</span>
<span class="c">#    k8sServiceHost: 192.168.10.100</span>
<span class="c">#    k8sServicePort: 6443</span>
<span class="c">#    kubeProxyReplacement: true</span>
<span class="c">#    routingMode: native</span>
<span class="nv">$ </span>helm list <span class="nt">-A</span>
<span class="c"># =&gt; NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION</span>
<span class="c">#    cilium  kube-system     1               2025-07-19 17:34:05.700270399 +0900 KST deployed        cilium-1.17.5   1.17.5</span>
<span class="nv">$ </span>kubectl get crd
<span class="c"># =&gt; No resources found</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod <span class="nt">-A</span>
<span class="c"># =&gt; Every 2.0s: kubectl get pod -A                                                                                                                 k8s-ctr: Sat Jul 19 17:36:42 2025</span>
<span class="c">#    </span>
<span class="c">#    NAMESPACE     NAME                               READY   STATUS    RESTARTS       AGE</span>
<span class="c">#    default       curl-pod                           1/1     Running   1 (166m ago)   3h24m</span>
<span class="c">#    default       webpod-697b545f57-7j5vt            1/1     Running   1 (165m ago)   3h25m</span>
<span class="c">#    default       webpod-697b545f57-sdv4l            1/1     Running   1 (165m ago)   3h25m</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-envoy-b2mn9&lt;/span&gt;                 1/1     Running   0              2m36s</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-envoy-dgdmn&lt;/span&gt;                 1/1     Running   0              2m36s</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-envoy-pjn95&lt;/span&gt;                 1/1     Running   0              2m36s</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-fl689&lt;/span&gt;                       1/1     Running   0              2m36s</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-mqnkn&lt;/span&gt;                       1/1     Running   0              2m36s</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-operator-865bc7f457-hpwvh&lt;/span&gt;   1/1     Running   0              2m36s</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-operator-865bc7f457-v5k84&lt;/span&gt;   1/1     Running   0              2m36s</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-zz9k4&lt;/span&gt;                       1/1     Running   0              2m36s</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-7q52c           1/1     &lt;span style="color: green;"&gt;Running&lt;/span&gt;   0              52s</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-bvsfb           1/1     &lt;span style="color: green;"&gt;Running&lt;/span&gt;   0              66s</span>
<span class="c">#    kube-system   etcd-k8s-ctr                       1/1     Running   4 (166m ago)   2d18h</span>
<span class="c">#    kube-system   kube-apiserver-k8s-ctr             1/1     Running   4 (166m ago)   2d18h</span>
<span class="c">#    kube-system   kube-controller-manager-k8s-ctr    1/1     Running   4 (166m ago)   2d18h</span>
<span class="c">#    kube-system   kube-scheduler-k8s-ctr             1/1     Running   4 (166m ago)   2d18h</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ cilium ê´€ë ¨ëœ íŒŒë“œê°€ ë°°í¬ë˜ì—ˆê³  coredns íŒŒë“œë„ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg status <span class="nt">--verbose</span>
<span class="c"># =&gt; KubeProxyReplacement:   True   [eth0    10.0.2.15 fd17:625c:f037:2:a00:27ff:fe71:19d8 fe80::a00:27ff:fe71:19d8, eth1   192.168.10.102 fe80::a00:27ff:fe79:58ac (Direct Routing)]</span>
<span class="c">#    ...</span>
<span class="c">#    Routing:                Network: Native   Host: BPF</span>
<span class="c">#    ...</span>
<span class="c">#    Masquerading:           BPF   [eth0, eth1]   172.20.0.0/16 [IPv4: Enabled, IPv6: Disabled]</span>
<span class="c">#    ...</span>

<span class="c"># ë…¸ë“œì— iptables í™•ì¸</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="c"># =&gt; -P PREROUTING ACCEPT</span>
<span class="c">#    -P INPUT ACCEPT</span>
<span class="c">#    -P OUTPUT ACCEPT</span>
<span class="c">#    -P POSTROUTING ACCEPT</span>
<span class="c">#    -N CILIUM_OUTPUT_nat</span>
<span class="c">#    -N CILIUM_POST_nat</span>
<span class="c">#    -N CILIUM_PRE_nat</span>
<span class="c">#    -N KUBE-KUBELET-CANARY</span>
<span class="c">#    -A PREROUTING -m comment --comment "cilium-feeder: CILIUM_PRE_nat" -j CILIUM_PRE_nat</span>
<span class="c">#    -A OUTPUT -m comment --comment "cilium-feeder: CILIUM_OUTPUT_nat" -j CILIUM_OUTPUT_nat</span>
<span class="c">#    -A POSTROUTING -m comment --comment "cilium-feeder: CILIUM_POST_nat" -j CILIUM_POST_nat</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="nv">$ </span>iptables-save
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>iptables-save <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span> 
</code></pre></div></div>

<ul>
  <li>PodCIDR IPAM í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/network/concepts/ipam/cluster-pool/">ClusterScope</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'</span>
<span class="c"># =&gt; k8s-ctr 10.244.0.0/24</span>
<span class="c">#    k8s-w1  10.244.1.0/24</span>
<span class="c">#    k8s-w2  10.244.2.0/24</span>

<span class="c"># íŒŒë“œ IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS       AGE     IP           NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                  1/1     Running   1 (172m ago)   3h30m   10.244.0.3   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-7j5vt   1/1     Running   1 (171m ago)   3h30m   10.244.1.3   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-sdv4l   1/1     Running   1 (171m ago)   3h30m   10.244.2.7   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get ciliumnodes
<span class="c"># =&gt; NAME      CILIUMINTERNALIP   INTERNALIP       AGE</span>
<span class="c">#    k8s-ctr   172.20.2.68        192.168.10.100   6m11s</span>
<span class="c">#    k8s-w1    172.20.1.88        192.168.10.101   6m50s</span>
<span class="c">#    k8s-w2    172.20.0.235       192.168.10.102   7m8s</span>
<span class="nv">$ </span>kubectl get ciliumnodes <span class="nt">-o</span> json | <span class="nb">grep </span>podCIDRs <span class="nt">-A2</span>
<span class="c"># =&gt;                     "podCIDRs": [</span>
<span class="c">#                            "172.20.2.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "172.20.1.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "172.20.0.0/24"</span>
<span class="c">#                        ],</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl rollout restart deployment webpod
<span class="c"># =&gt; deployment.apps/webpod restarted</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS       AGE     IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                  1/1     Running   1 (172m ago)   3h31m   10.244.0.3     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-86f878c468-448pc   1/1     Running   0              11s     172.20.0.202   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-86f878c468-ttbs2   1/1     Running   0              15s     172.20.1.123   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># k8s-ctr ë…¸ë“œì— curl-pod íŒŒë“œ ë°°í¬</span>
<span class="nv">$ </span>kubectl delete pod curl-pod <span class="nt">--grace-period</span><span class="o">=</span>0
<span class="c"># =&gt; pod "curl-pod" deleted</span>

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE   IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                  1/1     Running   0          33s   172.20.2.15    k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-86f878c468-448pc   1/1     Running   0          66s   172.20.0.202   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-86f878c468-ttbs2   1/1     Running   0          70s   172.20.1.123   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="nv">$ </span>kubectl get ciliumendpoints
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  5180                ready            172.20.2.15</span>
<span class="c">#    webpod-86f878c468-448pc   34270               ready            172.20.0.202</span>
<span class="c">#    webpod-86f878c468-ttbs2   34270               ready            172.20.1.123</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    60         Disabled           Disabled          20407      k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.20.0.167   ready</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=coredns</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#                                                               k8s:k8s-app=kube-dns</span>
<span class="c">#    71         Disabled           Disabled          4          reserved:health                                                                     172.20.0.114   ready</span>
<span class="c">#    1368       Disabled           Disabled          20407      k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.20.0.92    ready</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=coredns</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#                                                               k8s:k8s-app=kube-dns</span>
<span class="c">#    2533       Disabled           Disabled          1          reserved:host                                                                                      ready</span>
<span class="c">#    2605       Disabled           Disabled          34270      k8s:app=webpod                                                                      172.20.0.202   ready</span>
<span class="c">#                                                               k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=default</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=default</span>

<span class="c"># í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-86f878c468-448pc</span>

</code></pre></div></div>

<h3 id="cilium-ì„¤ì¹˜-í™•ì¸">Cilium ì„¤ì¹˜ í™•ì¸</h3>

<ul>
  <li>cilium clië¥¼ ì„¤ì¹˜í•˜ì—¬ Cilium ìƒíƒœë¥¼ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium cli ì„¤ì¹˜</span>
<span class="nv">$ CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">$ CLI_ARCH</span><span class="o">=</span>amd64
<span class="nv">$ </span><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi</span>
<span class="nv">$ </span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nv">$ </span><span class="nb">tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="c"># =&gt; cilium</span>
<span class="nv">$ </span><span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz

<span class="c"># cilium ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>which cilium
<span class="c"># =&gt; /usr/local/bin/cilium</span>
<span class="nv">$ </span>cilium status
<span class="c"># =&gt;     /Â¯Â¯\</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Cilium:             OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Operator:           OK</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Envoy DaemonSet:    OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Hubble Relay:       disabled</span>
<span class="c">#        \__/       ClusterMesh:        disabled</span>
<span class="c">#    </span>
<span class="c">#    DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    Deployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2</span>
<span class="c">#    Containers:            cilium                   Running: 3</span>
<span class="c">#                           cilium-envoy             Running: 3</span>
<span class="c">#                           cilium-operator          Running: 2</span>
<span class="c">#                           clustermesh-apiserver</span>
<span class="c">#                           hubble-relay</span>
<span class="c">#    Cluster Pods:          5/5 managed by Cilium</span>
<span class="c">#    Helm chart version:    1.17.5</span>
<span class="c">#    Image versions         cilium             quay.io/cilium/cilium:v1.17.5@sha256:baf8541723ee0b72d6c489c741c81a6fdc5228940d66cb76ef5ea2ce3c639ea6: 3</span>
<span class="c">#                           cilium-envoy       quay.io/cilium/cilium-envoy:v1.32.6-1749271279-0864395884b263913eac200ee2048fd985f8e626@sha256:9f69e290a7ea3d4edf9192acd81694089af048ae0d8a67fb63bd62dc1d72203e: 3</span>
<span class="c">#                           cilium-operator    quay.io/cilium/operator-generic:v1.17.5@sha256:f954c97eeb1b47ed67d08cc8fb4108fb829f869373cbb3e698a7f8ef1085b09e: 2</span>
<span class="nv">$ </span>cilium config view
<span class="c"># =&gt; ...</span>
<span class="c">#    cluster-pool-ipv4-cidr                            172.20.0.0/16</span>
<span class="c">#    default-lb-service-ipam                           lbipam</span>
<span class="c">#    ipam                                              cluster-pool</span>
<span class="c">#    ipam-cilium-node-update-rate                      15s</span>
<span class="c">#    iptables-random-fully                             false</span>
<span class="c">#    ipv4-native-routing-cidr                          172.20.0.0/16</span>
<span class="c">#    kube-proxy-replacement                            true</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq

<span class="c">#</span>
<span class="nv">$ </span>cilium config <span class="nb">set </span>debug <span class="nb">true</span> <span class="o">&amp;&amp;</span> watch kubectl get pod <span class="nt">-A</span>
<span class="c"># =&gt; âœ¨ Patching ConfigMap cilium-config with debug=true...</span>
<span class="c">#    â™»ï¸  Restarted Cilium pods</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> debug
<span class="c"># =&gt; debug                                             true</span>
<span class="c">#    debug-verbose</span>

<span class="c"># cilium daemon = cilium-dbg</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg config
<span class="c"># =&gt; ##### Read-write configurations #####</span>
<span class="c">#    ConntrackAccounting               : Disabled</span>
<span class="c">#    ConntrackLocal                    : Disabled</span>
<span class="c">#    Debug                             : Disabled</span>
<span class="c">#    DebugLB                           : Disabled</span>
<span class="c">#    DebugPolicy                       : Enabled</span>
<span class="c">#    DropNotification                  : Enabled</span>
<span class="c">#    MonitorAggregationLevel           : Medium</span>
<span class="c">#    PolicyAccounting                  : Enabled</span>
<span class="c">#    PolicyAuditMode                   : Disabled</span>
<span class="c">#    PolicyTracing                     : Disabled</span>
<span class="c">#    PolicyVerdictNotification         : Enabled</span>
<span class="c">#    SourceIPVerification              : Enabled</span>
<span class="c">#    TraceNotification                 : Enabled</span>
<span class="c">#    MonitorNumPages                   : 64</span>
<span class="c">#    PolicyEnforcement                 : default</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg status <span class="nt">--verbose</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    KubeProxyReplacement:   True   [eth0    10.0.2.15 fd17:625c:f037:2:a00:27ff:fe71:19d8 fe80::a00:27ff:fe71:19d8, eth1   192.168.10.102 fe80::a00:27ff:fe79:58ac (Direct Routing)]</span>
<span class="c">#    Routing:                Network: Native   Host: BPF</span>
<span class="c">#    Attach Mode:            TCX</span>
<span class="c">#    Device Mode:            veth</span>
<span class="c">#    ...</span>
<span class="c">#    KubeProxyReplacement Details:</span>
<span class="c">#      Status:                 True</span>
<span class="c">#      Socket LB:              Enabled</span>
<span class="c">#      Socket LB Tracing:      Enabled</span>
<span class="c">#      Socket LB Coverage:     Full</span>
<span class="c">#      Devices:                eth0    10.0.2.15 fd17:625c:f037:2:a00:27ff:fe71:19d8 fe80::a00:27ff:fe71:19d8, eth1   192.168.10.102 fe80::a00:27ff:fe79:58ac (Direct Routing)</span>
<span class="c">#      Mode:                   SNAT</span>
<span class="c">#      Backend Selection:      Random</span>
<span class="c">#      Session Affinity:       Enabled</span>
<span class="c">#      Graceful Termination:   Enabled</span>
<span class="c">#      NAT46/64 Support:       Disabled</span>
<span class="c">#      XDP Acceleration:       Disabled</span>
<span class="c">#      Services:</span>
<span class="c">#      - ClusterIP:      Enabled</span>
<span class="c">#      - NodePort:       Enabled (Range: 30000-32767)</span>
<span class="c">#      - LoadBalancer:   Enabled</span>
<span class="c">#      - externalIPs:    Enabled</span>
<span class="c">#      - HostPort:       Enabled</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>cilium_host, cilium_net, cilium_health ë“±ì˜ ë„¤íŠ¸ì›Œí¬ ê¸°ë³¸ ì •ë³´ë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2025/cilium/w1/20250720_cilium_w1_4.png" alt="img.png" class="image-center" />
<img src="/assets/2025/cilium/w1/20250720_cilium_w1_5.png" alt="img_1.png" class="image-center w-50" />
<a href="https://arthurchiao.art/blog/ctrip-network-arch-evolution/" class="image-caption">ì¶œì²˜ : https://arthurchiao.art/blog/ctrip-network-arch-evolution/</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    7: cilium_net@cilium_host: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether 4e:28:ea:3e:83:e0 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::4c28:eaff:fe3e:83e0/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    8: cilium_host@cilium_net: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether 22:ad:62:34:21:8e brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 172.20.2.68/32 scope global cilium_host</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::20ad:62ff:fe34:218e/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    12: lxcc4a3ffff7931@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether 76:62:d3:8d:58:1f brd ff:ff:ff:ff:ff:ff link-netns cni-ca74ac02-08e1-9092-74ad-f60026576c19</span>
<span class="c">#        inet6 fe80::7462:d3ff:fe8d:581f/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    14: lxc_health@if13: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether ca:67:c2:a6:88:89 brd ff:ff:ff:ff:ff:ff link-netnsid 2</span>
<span class="c">#        inet6 fe80::c867:c2ff:fea6:8889/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c">#</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr show cilium_net
<span class="c"># =&gt; 7: cilium_net@cilium_host: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether 4e:28:ea:3e:83:e0 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::4c28:eaff:fe3e:83e0/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr show cilium_host
<span class="c"># =&gt; 8: cilium_host@cilium_net: &lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether 22:ad:62:34:21:8e brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 172.20.2.68/32 scope global cilium_host</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::20ad:62ff:fe34:218e/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr show cilium_net  <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr show cilium_host <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># lxc_health ì¸í„°í˜ì´ìŠ¤ëŠ” veth ë¡œ cilium(NET NS 0, í˜¸ìŠ¤íŠ¸ì™€ ë‹¤ë¦„)ê³¼ veth pair ì´ë‹¤ - ë§í¬</span>
<span class="c"># cilium ì¸í„°í˜ì´ìŠ¤ì— íŒŒë“œ IPê°€ í• ë‹¹ë˜ì–´ ìˆìœ¼ë©°, cilium-health-responder ë¡œ ë™ì‘í•œë‹¤</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr show lxc_health
<span class="c"># =&gt; 14: lxc_health@if13: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether ca:67:c2:a6:88:89 brd ff:ff:ff:ff:ff:ff link-netnsid 2</span>
<span class="c">#        inet6 fe80::c867:c2ff:fea6:8889/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr show lxc_health  <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># IP í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg status <span class="nt">--verbose</span>
<span class="c"># =&gt; ....</span>
<span class="c">#    Name              IP              Node   Endpoints</span>
<span class="c">#      k8s-w2 (localhost):</span>
<span class="c">#        Host connectivity to 192.168.10.102:   &lt;span style="color: green;"&gt;# &lt;-- NodeIP&lt;/span&gt;</span>
<span class="c">#          ICMP to stack:   OK, RTT=440.958Âµs</span>
<span class="c">#          HTTP to agent:   OK, RTT=539.708Âµs</span>
<span class="c">#        Endpoint connectivity to 172.20.0.114: &lt;span style="color: green;"&gt;# &lt;-- HealthIP&lt;/span&gt;</span>
<span class="c">#          ICMP to stack:   OK, RTT=189Âµs</span>
<span class="c">#          HTTP to agent:   OK, RTT=502Âµs</span>
<span class="c">#      k8s-ctr:</span>
<span class="c">#        Host connectivity to 192.168.10.100:   &lt;span style="color: green;"&gt;# &lt;-- NodeIP&lt;/span&gt;</span>
<span class="c">#          ICMP to stack:   OK, RTT=1.011167ms</span>
<span class="c">#          HTTP to agent:   OK, RTT=1.071083ms</span>
<span class="c">#        Endpoint connectivity to 172.20.2.223: &lt;span style="color: green;"&gt;# &lt;-- HealthIP&lt;/span&gt;</span>
<span class="c">#          ICMP to stack:   OK, RTT=1.027125ms</span>
<span class="c">#          HTTP to agent:   OK, RTT=7.677708ms</span>
<span class="c">#      k8s-w1:</span>
<span class="c">#        Host connectivity to 192.168.10.101:   &lt;span style="color: green;"&gt;# &lt;-- NodeIP&lt;/span&gt;</span>
<span class="c">#          ICMP to stack:   OK, RTT=888.417Âµs</span>
<span class="c">#          HTTP to agent:   OK, RTT=1.167333ms</span>
<span class="c">#        Endpoint connectivity to 172.20.1.229: &lt;span style="color: green;"&gt;# &lt;-- HealthIP&lt;/span&gt;</span>
<span class="c">#          ICMP to stack:   OK, RTT=1.806167ms</span>
<span class="c">#          HTTP to agent:   OK, RTT=1.903ms</span>
<span class="c">#    ....</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg endpoint list | <span class="nb">grep </span>health
<span class="c"># =&gt; 2955  Disabled  Disabled  4  reserved:health  172.20.0.114  ready                                                             172.20.1.40    ready </span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg status <span class="nt">--all-addresses</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Allocated addresses:</span>
<span class="c">#      172.20.0.114 (health)</span>
<span class="c">#      172.20.0.167 (kube-system/coredns-674b8bbfcf-bvsfb [restored])</span>
<span class="c">#      172.20.0.202 (default/webpod-86f878c468-448pc [restored])</span>
<span class="c">#      172.20.0.235 (router)</span>
<span class="c">#      172.20.0.92 (kube-system/coredns-674b8bbfcf-7q52c [restored])</span>
<span class="c">#    ...</span>

<span class="c"># Check health info in CT/NAT tables : ICMP records in Conntrack (CT) table and NAT table</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium bpf ct list global | <span class="nb">grep </span>ICMP |head <span class="nt">-n4</span>
<span class="c"># =&gt; ICMP IN 192.168.10.101:19430 -&gt; 172.20.0.114:0 expires=11874 Packets=0 Bytes=0 RxFlagsSeen=0x00 LastRxReport=11814 TxFlagsSeen=0x00 LastTxReport=11814 Flags=0x0000 [ ] RevNAT=0 SourceSecurityID=6 IfIndex=0 BackendID=0</span>
<span class="c">#    ICMP IN 192.168.10.101:0 -&gt; 172.20.0.114:0 related expires=11874 Packets=0 Bytes=0 RxFlagsSeen=0x00 LastRxReport=11814 TxFlagsSeen=0x00 LastTxReport=0 Flags=0x0000 [ ] RevNAT=0 SourceSecurityID=6 IfIndex=0 BackendID=0</span>
<span class="c">#    ICMP IN 192.168.10.101:2374 -&gt; 172.20.0.114:0 expires=11535 Packets=0 Bytes=0 RxFlagsSeen=0x00 LastRxReport=11475 TxFlagsSeen=0x00 LastTxReport=11475 Flags=0x0000 [ ] RevNAT=0 SourceSecurityID=6 IfIndex=0 BackendID=0</span>
<span class="c">#    ICMP IN 192.168.10.101:47855 -&gt; 172.20.0.114:0 expires=11415 Packets=0 Bytes=0 RxFlagsSeen=0x00 LastRxReport=11355 TxFlagsSeen=0x00 LastTxReport=11355 Flags=0x0000 [ ] RevNAT=0 SourceSecurityID=6 IfIndex=0 BackendID=0</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium bpf nat list | <span class="nb">grep </span>ICMP |head <span class="nt">-n4</span>
<span class="c"># =&gt; ICMP OUT 192.168.10.102:35430 -&gt; 172.20.1.229:0 XLATE_SRC 192.168.10.102:35430 Created=164sec ago NeedsCT=1</span>
<span class="c">#    ICMP IN 172.20.2.223:0 -&gt; 192.168.10.102:47029 XLATE_DST 192.168.10.102:47029 Created=464sec ago NeedsCT=1</span>
<span class="c">#    ICMP IN 172.20.2.223:0 -&gt; 192.168.10.102:52326 XLATE_DST 192.168.10.102:52326 Created=54sec ago NeedsCT=1</span>
<span class="c">#    ICMP OUT 192.168.10.102:47029 -&gt; 172.20.2.223:0 XLATE_SRC 192.168.10.102:47029 Created=464sec ago NeedsCT=1</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w1/20250720_cilium_w1_6.png" alt="img.png" class="image-center" />
<em class="image-caption"><a href="https://arthurchiao.art/blog/cilium-code-health-probe">node ë° endpoint health check ì ˆì°¨</a></em></p>

<ul>
  <li>routing ì •ë³´ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Native-Routing + autoDirectNodeRoutes=true</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>172.20 | <span class="nb">grep </span>eth1
<span class="c"># =&gt; 172.20.0.0/24 via 192.168.10.102 dev eth1 proto kernel</span>
<span class="c">#    172.20.1.0/24 via 192.168.10.101 dev eth1 proto kernel</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route | <span class="nb">grep </span>172.20 | <span class="nb">grep </span>eth1 <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># hostNetwork ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” íŒŒë“œì˜ ê²½ìš° endpointRoutes.enabled=true ì„¤ì •ìœ¼ë¡œ lxcY ì¸í„°í˜ì´ìŠ¤ ìƒì„±ë¨</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE     NAME                       SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    default       curl-pod                   5180                ready            172.20.2.15</span>
<span class="c">#    default       webpod-86f878c468-448pc    34270               ready            172.20.0.202</span>
<span class="c">#    default       webpod-86f878c468-ttbs2    34270               ready            172.20.1.123</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-7q52c   20407               ready            172.20.0.92</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-bvsfb   20407               ready            172.20.0.167</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>lxc
<span class="c"># =&gt; 172.20.2.15 dev lxcc4a3ffff7931 proto kernel scope link</span>
<span class="c">#    172.20.2.223 dev lxc_health proto kernel scope link</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route | <span class="nb">grep </span>lxc <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>ë³´ë‹¤ ìƒì„¸í•œ ë‚´ìš©ì€ <a href="https://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/">ê³µì‹ë¬¸ì„œ</a>ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.</li>
</ul>

<hr />

<h2 id="í†µì‹ -í™•ì¸">í†µì‹  í™•ì¸</h2>

<h3 id="ë…¸ë“œê°„-íŒŒë“œ---íŒŒë“œ-í†µì‹ ">ë…¸ë“œê°„ â€˜íŒŒë“œ -&gt; íŒŒë“œâ€™ í†µì‹ </h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/ebpf/lifeofapacket/">ì°¸ê³ </a> <a href="https://velog.io/@_gyullbb/Cilium">ì¶”ì²œ ê¸€</a></li>
</ul>

<p><img src="/assets/2025/cilium/w1/20250720_cilium_w1_7.png" alt="img.png" class="image-center" />
<em class="image-caption">íŒŒë“œì—ì„œ ë¹ ì ¸ë‚˜ê°ˆ ë•Œ</em></p>

<p><img src="/assets/2025/cilium/w1/20250720_cilium_w1_8.png" alt="img_1.png" class="image-center" />
<em class="image-caption">íŒŒë“œë¡œ ë“¤ì–´ì˜¬ ë•Œ</em></p>

<ul>
  <li>cilium ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë¨¼ì € ì•„ë˜ì˜ cheatsheetì„ ì°¸ê³ í•˜ì—¬ c0, c0bpf ë“±ì˜ ë‹¨ì¶•í‚¤(alias)ë¥¼ ì§€ì •í•œ í›„ì— ì§„í–‰í•©ë‹ˆë‹¤.</span>

<span class="c"># ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE     IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                  1/1     Running   0          3h40m   172.20.2.15    k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-86f878c468-448pc   1/1     Running   0          3h41m   &lt;span style="color: green;"&gt;172.20.0.202&lt;/span&gt;   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-86f878c468-ttbs2   1/1     Running   0          3h41m   172.20.1.123   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="nv">$ </span>kubectl get svc,ep webpod
<span class="c"># =&gt; NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/webpod   ClusterIP   10.96.62.184   &lt;none&gt;        80/TCP    7h12m</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/webpod   172.20.0.202:80,172.20.1.123:80   7h12m</span>

<span class="c"># ì²«ë²ˆì§¸ webpodì˜ IP ì£¼ì†Œë¥¼ WEBPOD1IP ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.</span>
<span class="nv">$ WEBPOD1IP</span><span class="o">=</span>172.20.0.202

<span class="c"># BPF maps : ëª©ì ì§€ íŒŒë“œì™€ í†µì‹  ì‹œ ì–´ëŠê³³ìœ¼ë¡œ ë³´ë‚´ì•¼ ë ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤</span>
<span class="nv">$ </span>c0 map get cilium_ipcache
<span class="nv">$ </span>c0 map get cilium_ipcache | <span class="nb">grep</span> <span class="nv">$WEBPOD1IP</span>
<span class="c"># =&gt; 172.20.0.202/32     identity=34270 encryptkey=0 tunnelendpoint=192.168.10.102 flags=&lt;none&gt;   sync</span>

<span class="c"># curl-pod ì˜ LXC ë³€ìˆ˜ ì§€ì •</span>
<span class="c"># $ LXC=&lt;k8s-ctrì˜ ê°€ì¥ ë‚˜ì¤‘ì— lxc ì´ë¦„(lxc_health ì œì™¸)&gt;</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>lxc
<span class="c"># =&gt; 172.20.2.15 dev &lt;span style="color: green;"&gt;lxcc4a3ffff7931&lt;/span&gt; proto kernel scope link</span>
<span class="c">#    172.20.2.223 dev lxc_health proto kernel scope link</span>
<span class="nv">$ LXC</span><span class="o">=</span>lxcc4a3ffff7931

<span class="c"># Nodeâ€™s eBPF programs</span>
<span class="c">## list of eBPF programs</span>
<span class="nv">$ </span>c0bpf net show
<span class="nv">$ </span>c0bpf net show | <span class="nb">grep</span> <span class="nv">$LXC</span> 
<span class="c"># =&gt; lxcc4a3ffff7931(12) tcx/ingress cil_from_container prog_id 1212 link_id 22</span>
<span class="c">#    lxcc4a3ffff7931(12) tcx/egress cil_to_container prog_id 1214 link_id 23 </span>

<span class="c">## Use bpftool prog show id to view additional information about a program, including a list of attached eBPF maps:</span>
<span class="c"># $ c0bpf prog show id &lt;ì¶œë ¥ëœ prog id ì…ë ¥&gt;</span>
<span class="nv">$ </span>c0bpf prog show <span class="nb">id </span>1214
<span class="c"># =&gt; 1214: sched_cls  name cil_to_container  tag 0b3125767ba1861c  gpl</span>
<span class="c">#            loaded_at 2025-07-19T08:50:37+0000  uid 0</span>
<span class="c">#            xlated 1448B  jited 1144B  memlock 4096B  map_ids 219,41,218</span>
<span class="c">#            btf_id 468</span>

<span class="nv">$ </span>c0bpf map list
<span class="c"># =&gt; ...</span>
<span class="c">#    41: percpu_hash  name cilium_metrics  flags 0x1</span>
<span class="c">#            key 8B  value 16B  max_entries 1024  memlock 19024B</span>
<span class="c">#    ...</span>
<span class="c">#    227: array  name .rodata.config  flags 0x480</span>
<span class="c">#            key 4B  value 52B  max_entries 1  memlock 8192B</span>
<span class="c">#            btf_id 496  frozen</span>
<span class="c">#    228: prog_array  name cilium_calls_ne  flags 0x0</span>
<span class="c">#            key 4B  value 4B  max_entries 50  memlock 720B</span>
<span class="c">#            owner_prog_type sched_cls  owner jited</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>ë‹¤ë¥¸ ë…¸ë“œ ê°„ â€˜íŒŒë“œ -&gt; íŒŒë“œâ€™ í†µì‹ ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># vagrant ssh k8s-w1 , # vagrant ssh k8s-w2 ê°ê° í„°ë¯¸ë„ ì ‘ì† í›„ ì•„ë˜ ì‹¤í–‰</span>
<span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> eth1 <span class="s1">''</span> <span class="s1">'tcp port 80'</span>

<span class="c"># [k8s-ctr] curl-pod ì—ì„œ curl ìš”ì²­ ì‹œë„</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nv">$WEBPOD1IP</span>
<span class="c"># ê°ê° í„°ë¯¸ë„ì—ì„œ ì¶œë ¥ í™•ì¸ : íŒŒë“œì˜ ì†ŒìŠ¤ IPì™€ ëª©ì ì§€ IPê°€ ë‹¤ë¥¸ ë…¸ë“œì˜ ì„œë²„ NICì—ì„œ í™•ì¸! : Native-Routung </span>
<span class="c"># =&gt; ####</span>
<span class="c">#    T 2025/07/19 21:36:42.198609 172.20.2.15:46708 -&gt; 172.20.0.202:80 [AP] #4</span>
<span class="c">#    GET / HTTP/1.1.</span>
<span class="c">#    ...</span>
<span class="c">#    ##</span>
<span class="c">#    T 2025/07/19 21:36:42.200368 172.20.0.202:80 -&gt; 172.20.2.15:46708 [AP] #6</span>
<span class="c">#    HTTP/1.1 200 OK.</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w1/20250720_cilium_w1_9.png" alt="img.png" class="image-center" /></p>

<h3 id="ë…¸ë“œê°„-íŒŒë“œ---ì„œë¹„ìŠ¤-í†µì‹ ">ë…¸ë“œê°„ â€˜íŒŒë“œ -&gt; ì„œë¹„ìŠ¤â€™ í†µì‹ </h3>

<ul>
  <li>ì°¸ê³  : <a href="https://velog.io/@haruband/K8SCilium-Socket-Based-LoadBalancing-%EA%B8%B0%EB%B2%95">[K8S/Cilium] Socket-Based LoadBalancing ê¸°ë²•</a></li>
</ul>

<p><img src="/assets/2025/cilium/w1/20250720_cilium_w1_10.png" alt="img.png" class="image-center" />
<em class="image-caption">ë„¤íŠ¸ì›Œí¬ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± vs ì†Œì¼“ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± ë¹„êµ</em></p>

<ul>
  <li>Pod1 ì•ˆì—ì„œ ë™ì‘í•˜ëŠ” ì•±ì´ <strong>connect() ì‹œìŠ¤í…œì½œ</strong>ì„ ì´ìš©í•˜ì—¬ ì†Œì¼“ì„ ì—°ê²°í•  ë•Œ ëª©ì ì§€ ì£¼ì†Œê°€ ì„œë¹„ìŠ¤ ì£¼ì†Œ(10.10.8.55)ì´ë©´ ì†Œì¼“ì˜ ëª©ì ì§€ ì£¼ì†Œë¥¼ ë°”ë¡œ ë°±ì—”ë“œ ì£¼ì†Œ(10.0.0.31)ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.</li>
  <li>ì´í›„ ì•±ì—ì„œ í•´ë‹¹ ì†Œì¼“ì„ í†µí•´ ë³´ë‚´ëŠ” ëª¨ë“  íŒ¨í‚·ì˜ ëª©ì ì§€ ì£¼ì†ŒëŠ” ì´ë¯¸ ë°±ì—”ë“œ ì£¼ì†Œ(10.0.0.31)ë¡œ ì„¤ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ì¤‘ê°„ì— <strong>DNAT ë³€í™˜ ë° ì—­ë³€í™˜ ê³¼ì •ì´ í•„ìš”ì—†ì–´ì§‘ë‹ˆë‹¤.</strong></li>
  <li><strong>Destination NAT</strong> ë³€í™˜ì€ ì‹œìŠ¤í…œ ì½œ ë ˆë²¨ì—ì„œ ë°œìƒí•˜ë©°, íŒ¨í‚·ì´ ì»¤ë„ì— ì˜í•´ ìƒì„±ë˜ê¸°ë„ ì „ì— ìˆ˜í–‰ë©ë‹ˆë‹¤.</li>
  <li><strong>Socket operations</strong> : <strong>BPF socket operations program</strong> ì€ <strong>root cgroup ì— ì—°ê²°</strong>ë˜ë©° TCP <strong>event</strong>(ESTABLISHED) ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.</li>
  <li>
    <p><strong>Socket send/recv</strong> : Socket send/recv hook ì€ <strong>TCP</strong> socket ì˜ ëª¨ë“  <strong>ì†¡ìˆ˜ì‹ </strong> ì‘ì—…ì—ì„œ ì‹¤í–‰ë˜ë©°, <strong>hook</strong> ì—ì„œ <strong>ê²€ì‚¬/ì‚­ì œ/ë¦¬ë‹¤ì´ë ‰ì…˜</strong>ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2025/cilium/w1/20250720_cilium_w1_11.png" alt="img.png" class="image-center" />
<em class="image-caption">https://cilium.io/blog/2020/11/10/ebpf-future-of-networking/</em></p>
  </li>
  <li>íŒŒë“œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ Socket-Based LoadBalancing ê¸°ë²•ì„ ê·¸ë¦¼ìœ¼ë¡œ ì •ë¦¬í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2025/cilium/w1/20250720_cilium_w1_12.png" alt="img.png" class="image-center" />
<em class="image-caption">ì¶œì²˜ : <a href="https://velog.io/@haruband/K8SCilium-Socket-Based-LoadBalancing-%EA%B8%B0%EB%B2%95">[K8S/Cilium] Socket-Based LoadBalancing ê¸°ë²•</a></em></p>

<ul>
  <li>ê·¸ë¦¼ìƒì˜ ì¢Œì¸¡ì€ ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± ê¸°ë²•ì„ ì‚¬ìš©í•œ ê²½ìš°ì´ê³ , ìš°ì¸¡ì€ ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± ê¸°ë²•ì„ ì‚¬ìš©í•œ ê²½ìš°ì…ë‹ˆë‹¤.</li>
  <li>
    <p>ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± ê¸°ë²•ì€ ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± ê¸°ë²•ê³¼ ë¹„êµí•˜ì—¬ DNAT ë³€í™˜ ë° ì—­ë³€í™˜ ê³¼ì •ì´ í•„ìš” ì—†ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ í–¥ìƒë©ë‹ˆë‹¤.</p>
  </li>
  <li>connect() ì™€ sendto() ì†Œì¼“ í•¨ìˆ˜ì— ì—°ê²°ëœ í”„ë¡œê·¸ë¨(connect4, sendmsg4)ì—ì„œëŠ” ì†Œì¼“ì˜ ëª©ì ì§€ ì£¼ì†Œë¥¼ ë°±ì—”ë“œ ì£¼ì†Œì™€ í¬íŠ¸ë¡œ ë³€í™˜í•˜ê³ , cilium_lb4_backends ë§µì— ë°±ì—”ë“œ ì£¼ì†Œì™€ í¬íŠ¸ë¥¼ ë“±ë¡í•´ë†“ìŠµë‹ˆë‹¤.</li>
  <li>
    <p>ì´í›„ recvmsg() ì†Œì¼“ í•¨ìˆ˜ì— ì—°ê²°ëœ í”„ë¡œê·¸ë¨(recvmsg4)ì—ì„œëŠ” cilium_lb4_reverse_nat ë§µì„ ì´ìš©í•´ì„œ ëª©ì ì§€ ì£¼ì†Œì™€ í¬íŠ¸ë¥¼ ë‹¤ì‹œ ì„œë¹„ìŠ¤ ì£¼ì†Œì™€ í¬íŠ¸ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
<img src="/assets/2025/cilium/w1/20250720_cilium_w1_14.png" alt="img.png" class="image-center" />
<em class="image-caption">https://k8s.networkop.co.uk/services/clusterip/dataplane/ebpf/</em></p>
  </li>
  <li>ì‹¤ìŠµ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># curl í˜¸ì¶œ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod

<span class="c"># ì‹ ê·œ í„°ë¯¸ë„ : íŒŒë“œì—ì„œ SVC(ClusterIP) ì ‘ì† ì‹œ tcpdump ë¡œ í™•ì¸ : ClusterIPê°€ ì†Œì¼“ ë ˆë²¨ì—ì„œ ì´ë¯¸ Endpoint ë¡œ ë³€ê²½ë˜ì—ˆìŒì„ í™•ì¸!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>curl-pod <span class="nt">--</span> tcpdump <span class="nt">-enni</span> any <span class="nt">-q</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    14:09:05.318403 eth0  Out ifindex 11 d6:ab:bb:21:3a:93 172.20.2.15.40982 &gt; 172.20.1.123.80: tcp 0</span>
<span class="c">#    14:09:05.319286 eth0  In  ifindex 11 76:62:d3:8d:58:1f 172.20.1.123.80 &gt; 172.20.2.15.40982: tcp 0</span>
<span class="c">#    ...</span>

<span class="c"># Socket-Based LoadBalancing ê´€ë ¨ ì„¤ì •ë“¤ í™•ì¸</span>
<span class="nv">$ </span>c0 status <span class="nt">--verbose</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    KubeProxyReplacement Details:</span>
<span class="c">#      Status:                 True</span>
<span class="c">#      Socket LB:              Enabled</span>
<span class="c">#      Socket LB Tracing:      Enabled</span>
<span class="c">#      Socket LB Coverage:     Full</span>
<span class="c">#      Devices:                eth0    10.0.2.15 fd17:625c:f037:2:a00:27ff:fe71:19d8 fe80::a00:27ff:fe71:19d8, eth1   192.168.10.100 fe80::a00:27ff:feda:2493 (Direct Routing)</span>
<span class="c">#      Mode:                   SNAT</span>
<span class="c">#      Backend Selection:      Random</span>
<span class="c">#      Session Affinity:       Enabled</span>
<span class="c">#      Graceful Termination:   Enabled</span>
<span class="c">#      NAT46/64 Support:       Disabled</span>
<span class="c">#      XDP Acceleration:       Disabled</span>
<span class="c">#      Services:</span>
<span class="c">#      - ClusterIP:      Enabled</span>
<span class="c">#      - NodePort:       Enabled (Range: 30000-32767)</span>
<span class="c">#      - LoadBalancer:   Enabled</span>
  
<span class="c"># syscall í˜¸ì¶œ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>curl-pod <span class="nt">--</span> strace <span class="nt">-c</span> curl <span class="nt">-s</span> webpod
<span class="c"># =&gt; ...</span>
<span class="c">#    % time     seconds  usecs/call     calls    errors syscall</span>
<span class="c">#    ------ ----------- ----------- --------- --------- ----------------</span>
<span class="c">#     &lt;span style="color: green;"&gt;19.00    0.001003         334         3         1 connect&lt;/span&gt;</span>
<span class="c">#     15.97    0.000843         281         3           sendto</span>
<span class="c">#     15.82    0.000835          23        35           munmap</span>
<span class="c">#     10.59    0.000559          93         6         3 recvfrom</span>
<span class="c">#     10.33    0.000545           8        63           mmap</span>
<span class="c">#      7.58    0.000400           8        47        30 openat</span>
<span class="c">#      4.32    0.000228          10        22           close</span>
<span class="c">#      3.87    0.000204          20        10           lseek</span>
<span class="c">#      2.94    0.000155           6        24           fcntl</span>
<span class="c">#      2.56    0.000135           4        28           rt_sigaction</span>
<span class="c">#      1.46    0.000077           8         9           ppoll</span>
<span class="c">#      1.23    0.000065          16         4           socket</span>
<span class="c">#      0.72    0.000038          12         3         3 ioctl</span>
<span class="c">#      0.68    0.000036          36         1           newfstatat</span>
<span class="c">#      0.63    0.000033           2        14           mprotect</span>
<span class="c">#      &lt;span style="color: green;"&gt;0.63    0.000033           1        27           read&lt;/span&gt;</span>
<span class="c">#      0.55    0.000029           9         3           readv</span>
<span class="c">#      0.21    0.000011           0        12           fstat</span>
<span class="c">#      0.21    0.000011           0        14           rt_sigprocmask</span>
<span class="c">#      0.17    0.000009           9         1           writev</span>
<span class="c">#      0.15    0.000008           1         5           setsockopt</span>
<span class="c">#      &lt;span style="color: green;"&gt;0.15    0.000008           1         5           getsockname&lt;/span&gt;</span>
<span class="c">#      0.09    0.000005           5         1           eventfd2</span>
<span class="c">#      0.06    0.000003           0         4           brk</span>
<span class="c">#      0.04    0.000002           2         1           getrandom</span>
<span class="c">#      &lt;span style="color: green;"&gt;0.04    0.000002           2         1           getsockopt&lt;/span&gt;</span>
<span class="c">#      0.02    0.000001           1         1           getgid</span>
<span class="c">#      0.00    0.000000           0         1           set_tid_address</span>
<span class="c">#      0.00    0.000000           0         1           getuid</span>
<span class="c">#      0.00    0.000000           0         2           geteuid</span>
<span class="c">#      0.00    0.000000           0         1           getegid</span>
<span class="c">#      0.00    0.000000           0         1           execve</span>
<span class="c">#    ------ ----------- ----------- --------- --------- ----------------</span>
<span class="c">#    100.00    0.005278          14       353        37 total</span>

<span class="c"># ìƒì„¸ ì¶œë ¥</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>curl-pod <span class="nt">--</span> strace <span class="nt">-s</span> 65535 <span class="nt">-f</span> <span class="nt">-tt</span> curl <span class="nt">-s</span> webpod

<span class="c"># íŠ¹ì • ì´ë²¤íŠ¸ í•„í„°ë§ : -e</span>
<span class="c">## connect ë¡œ ì¶œë ¥ë˜ëŠ” 10.96.62.184 ëŠ” webpod Service ì˜ ClusterIPì…ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>curl-pod <span class="nt">--</span> strace <span class="nt">-e</span> <span class="nv">trace</span><span class="o">=</span>connect     curl <span class="nt">-s</span> webpod
<span class="c"># =&gt; connect(5, {sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("10.96.62.184")}, 16) = 0</span>
<span class="c">#    connect(4, {sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("10.96.62.184")}, 16) = -1 EINPROGRESS (Operation in progress)</span>
<span class="c">#    ...</span>

<span class="c">## connect ë¡œ ì¶œë ¥ë˜ëŠ” 172.20.2.15 ëŠ” curl-pod ì˜ íŒŒë“œ IPì…ë‹ˆë‹¤. -&gt; ëª©ì ì§€ webpod íŒŒë“œ IPê°€ ì•„ë‹™ë‹ˆë‹¤.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>curl-pod <span class="nt">--</span> strace <span class="nt">-e</span> <span class="nv">trace</span><span class="o">=</span>getsockname curl <span class="nt">-s</span> webpod
<span class="c"># =&gt; getsockname(4, {sa_family=AF_INET, sin_port=htons(52951), sin_addr=inet_addr("172.20.2.15")}, [128 =&gt; 16]) = 0</span>
<span class="c">#    getsockname(5, {sa_family=AF_INET, sin_port=htons(42089), sin_addr=inet_addr("172.20.2.15")}, [16]) = 0</span>
<span class="c">#    getsockname(4, {sa_family=AF_INET, sin_port=htons(60934), sin_addr=inet_addr("172.20.2.15")}, [128 =&gt; 16]) = 0</span>
<span class="c">#    getsockname(4, {sa_family=AF_INET, sin_port=htons(60934), sin_addr=inet_addr("172.20.2.15")}, [128 =&gt; 16]) = 0</span>
<span class="c">#    getsockname(4, {sa_family=AF_INET, sin_port=htons(60934), sin_addr=inet_addr("172.20.2.15")}, [128 =&gt; 16]) = 0</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>curl-pod <span class="nt">--</span> strace <span class="nt">-e</span> <span class="nv">trace</span><span class="o">=</span>getsockopt curl <span class="nt">-s</span> webpod
<span class="c"># =&gt; getsockopt(4, SOL_SOCKET, SO_ERROR, [0], [4]) = 0 # ì†Œì¼“ ì—°ê²° ì„±ê³µ</span>
</code></pre></div></div>

<ul>
  <li>straceë¥¼ í†µí•´ ìœ„ì™€ ê°™ì´ IP ë³€í™˜ì— ëŒ€í•´ ì•Œì•„ë³´ë ¤ í–ˆì§€ë§Œ 
ì‹¤ì œë¡œëŠ” ì†Œì¼“ ë ˆë²¨ì—ì„œ ì´ë¯¸ ë³€í™˜ì´ ì™„ë£Œë˜ì–´ ìˆê¸° ë•Œë¬¸ì— straceë¡œëŠ” í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
  <li>ì´ëŠ” eBPFë¥¼ í†µí•´ ì‹œìŠ¤í…œ ì½œì„ ì¤„ì—¬ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ëŠ” Ciliumì˜ íŠ¹ì§• ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.</li>
  <li>â„¹ï¸ ì°¸ê³ ë¡œ  straceëŠ” ì‹œìŠ¤í…œ ì½œì„ ì¶”ì í•˜ëŠ” ë„êµ¬ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ê¸°ëŠ¥ë“¤ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì¤‘ë‹¨ì  íŠ¸ë ˆì´ì‹± : -ttt(ì²« ì—´ì— ê¸°ì¤€ì‹œê°„ìœ¼ë¡œë¶€í„° íë¥¸ ì‹œê°„ í‘œì‹œ) , -T(ë§ˆì§€ë§‰ í•„ë“œ timeì— ì‹œìŠ¤í…œ ì½œì— ê±¸ë¦° ì‹œê°„ì„ í‘œì‹œ) , -p PID(í”„ë¡œì„¸ìŠ¤ IDê°€ PID ì¸ í”„ë¡œì„¸ìŠ¤ë¥¼ íŠ¸ë ˆì´ì‹±)</span>
<span class="nv">$ </span>strace <span class="nt">-ttt</span> <span class="nt">-T</span> <span class="nt">-p</span> 1884
  
<span class="c"># ì‹œìŠ¤í…œ ì½œë³„ í†µê³„</span>
<span class="nv">$ </span>strace <span class="nt">-c</span> <span class="nt">-p</span> 1884
  
<span class="c"># í”„ë¡œê·¸ë¨ ì‹¤í–‰ì‹œ ì‹œìŠ¤í…œ ì½œ ì¶”ì </span>
<span class="nv">$ </span>strace <span class="nb">ls</span>
  
<span class="c"># ì˜µì…˜ ì‚¬ìš©í•´ë³´ê¸° : -s(ì¶œë ¥ string ê²°ê³¼ ìµœëŒ“ê°’ ì§€ì •), -tt(ì²« ì—´ì— ê¸°ì¤€ì‹œê°„ìœ¼ë¡œë¶€í„° íë¥¸ ì‹œê°„ í‘œì‹œ, msë‹¨ìœ„), -f(ë©€í‹° ìŠ¤ë ˆë“œ,ë©€í‹° í”„ë¡œë ˆìŠ¤ì˜ ìì‹ í”„ë¡œì„¸ìŠ¤ì˜ ì‹œìŠ¤í…œ ì½œ ì¶”ì )</span>
<span class="nv">$ </span>strace <span class="nt">-s</span> 65535 <span class="nt">-f</span> <span class="nt">-T</span> <span class="nt">-tt</span> <span class="nt">-o</span> &lt;íŒŒì¼ëª…&gt; <span class="nt">-p</span> &lt;pid&gt;
  
<span class="c"># hostname ëª…ë ¹ ë¶„ì„í•˜ê¸° : -o &lt;íŒŒì¼ëª…&gt; ì¶œë ¥ ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ë–¨êµ¬ê¸°</span>
<span class="nv">$ </span>strace <span class="nt">-s</span> 65535 <span class="nt">-f</span> <span class="nt">-T</span> <span class="nt">-tt</span> <span class="nt">-o</span> hostname_f_trace <span class="nb">hostname</span> <span class="nt">-f</span>
  
<span class="c"># íŠ¹ì • ì´ë²¤íŠ¸ : -e</span>
<span class="nv">$ </span>strace <span class="nt">-e</span> <span class="nv">trace</span><span class="o">=</span>connect curl ipinfo.io
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="cilium-ì‚¬ìš©ì‹œ-ì£¼ì˜ì‚¬í•­">Cilium ì‚¬ìš©ì‹œ ì£¼ì˜ì‚¬í•­</h3>

<ul>
  <li>ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± ì´ìš©ì‹œ Istio(EnvoyProxy)ì™€ ê°™ì€ ì‚¬ì´ë“œì¹´ ìš°íšŒë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://velog.io/@haruband/K8S-Cilium-Socket-based-LoadBalancing-%EC%97%90-%EC%9D%98%ED%95%9C-Istio-Envoy-%EC%9A%B0%ED%9A%8C-%EB%AC%B8%EC%A0%9C-%EB%B6%84%EC%84%9D">ë§í¬</a>
<img src="/assets/2025/cilium/w1/20250720_cilium_w1_15.png" alt="img.png" />
    <ul>
      <li>ì•ì„œ í™•ì¸í•œê²ƒ ì²˜ëŸ¼ ì„œë¹„ìŠ¤ì˜ IPê°€ ì´ë¯¸ ë°±ì—”ë“œ IPë¡œ ë³€í™˜ë˜ì—ˆê¸° ë•Œë¬¸ì—, ì„œë¹„ìŠ¤ IPê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ëª¨ë“  í•„í„°ê°€ ìš°íšŒë˜ëŠ” í˜„ìƒì…ë‹ˆë‹¤.</li>
      <li>í•´ê²° ë°©ì•ˆì€ íŒŒë“œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œëŠ” ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²ƒì…ë‹ˆë‹¤. ì¦‰, í˜¸ìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë§Œ ì‚¬ìš©í•˜ê²Œ ì„¤ì •í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤
        <ul>
          <li>HTTPì˜ ê²½ìš° Envoyì˜ HTTP í•„í„°ê°€ HTTP íŒ¨í‚·ì˜ host í—¤ë”ë¥¼ í•„í„°ë§í•˜ì—¬ íŒ¨í‚·ì˜ ëª©ì ì§€ ì£¼ì†Œë¥¼ ì„œë¹„ìŠ¤ IPì—ì„œ ë°±ì—”ë“œ IPë¡œ ë³€í™˜ì„ ì˜ í•©ë‹ˆë‹¤.</li>
          <li>í•˜ì§€ë§Œ, HTTPê°€ ì•„ë‹Œ ì¼ë°˜ TCP ì„œë¹„ìŠ¤ (ì˜ˆ) Telnet ë“±)ì€ ìœ„ í™˜ê²½ì—ì„œ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.</li>
        </ul>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì„¤ì •</span>
<span class="nv">$ VERSION</span><span class="o">=</span>1.17.5
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> <span class="nv">$VERSION</span> <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> socketLB.hostNamespaceOnly<span class="o">=</span><span class="nb">true</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>
  
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>bpf-lb-sock-hostns-only
<span class="c"># =&gt; bpf-lb-sock-hostns-only                           true</span>
  
<span class="c"># í™•ì¸</span>
<span class="c"># ì§€ì†ì ìœ¼ë¡œ ì ‘ì† íŠ¸ë˜í”½ ë°œìƒ</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec </span>curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$SVCIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span><span class="nb">echo</span> <span class="s2">"-----"</span><span class="p">;</span><span class="nb">sleep </span>1<span class="p">;</span><span class="k">done</span>
<span class="c"># =&gt; Hostname: webpod-86f878c468-448pc</span>
<span class="c">#    -----</span>
<span class="c">#    Hostname: webpod-86f878c468-ttbs2</span>
<span class="c">#    -----</span>
<span class="c">#    Hostname: webpod-86f878c468-ttbs2</span>
<span class="c">#    ...</span>
  
<span class="c"># íŒŒë“œì—ì„œ SVC(ClusterIP) ì ‘ì† ì‹œ tcpdump ë¡œ í™•ì¸ &gt;&gt; íŒŒë“œ ë‚´ë¶€ ìº¡ì³ì¸ë°, SVC(10.96.62.184) íŠ¸ë˜í”½ì´ ë³´ì¸ë‹¤!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>curl-pod <span class="nt">--</span> tcpdump <span class="nt">-enni</span> any <span class="nt">-q</span>
<span class="c"># =&gt; 14:38:41.369005 eth0  Out ifindex 11 d6:ab:bb:21:3a:93 172.20.2.15.52976 &gt; &lt;span style="color: green;"&gt;10.96.62.184.80&lt;/span&gt;: tcp 0</span>
<span class="c">#    14:38:41.369050 eth0  Out ifindex 11 d6:ab:bb:21:3a:93 172.20.2.15.52976 &gt; &lt;span style="color: green;"&gt;10.96.62.184.80&lt;/span&gt;: tcp 76</span>
<span class="c">#    14:38:41.369767 eth0  In  ifindex 11 76:62:d3:8d:58:1f &lt;span style="color: green;"&gt;10.96.62.184.80&lt;/span&gt; &gt; 172.20.2.15.52976: tcp 0</span>
<span class="c">#    14:38:41.370802 eth0  In  ifindex 11 76:62:d3:8d:58:1f &lt;span style="color: green;"&gt;10.96.62.184.80&lt;/span&gt; &gt; 172.20.2.15.52976: tcp 327</span>
<span class="c">#    ...	</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Service ClusterIPë¡œ NFSë‚˜ SMB ê°™ì€ í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ë©´ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Longhorn, Portworx, Robin ë“±) - <a href="https://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/#limitations">Docs</a>, <a href="https://github.com/cilium/cilium/issues/21541">Issue</a>
    <ul>
      <li>Ciliumì˜ eBPFë¥¼ í†µí•œ kube-proxy ëŒ€ì²´ ê¸°ëŠ¥ì€ socketê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, ì•ì„œ ì‚´í´ë³¸ê²ƒ ì²˜ëŸ¼ ì„œë¹„ìŠ¤ IPê°€ ë°±ì—”ë“œ IPë¡œ ë³€í™˜ë˜ì–´ ì‚¬ìš©ë©ë‹ˆë‹¤.</li>
      <li>NFSë‚˜ SMB í”„ë¡œí† ì½œì€ ì„œë¹„ìŠ¤ IPë¥¼ ì‚¬ìš©í•˜ì—¬ í†µì‹ í•˜ê¸° ë•Œë¬¸ì—, socketê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±ì„ ì‚¬ìš©í•˜ë©´ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ ë¬¸ì œëŠ” Longhorn, Portworx, Robin ë“±ê³¼ ê°™ì€ ìŠ¤í† ë¦¬ì§€ ì‹œìŠ¤í…œì—ì„œ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©°, <code class="language-plaintext highlighter-rouge">ReadWriteMany</code> ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ìŠ¤í† ë¦¬ì§€ ì‹œìŠ¤í…œì—ì„œë„ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒì˜ íŒ¨ì¹˜ë“¤ì´ ì»¤ë„ì— í¬í•¨ë˜ì–´ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        <ul>
          <li><code class="language-plaintext highlighter-rouge">0bdf399342c5 ("net: Avoid address overwrite in kernel_connect")</code></li>
          <li><code class="language-plaintext highlighter-rouge">86a7e0b69bd5 ("net: prevent rewrite of msg_name in sock_sendmsg()")</code></li>
          <li><code class="language-plaintext highlighter-rouge">01b2885d9415 ("net: Save and restore msg_namelen in sock_sendmsg")</code></li>
          <li><code class="language-plaintext highlighter-rouge">cedc019b9f26 ("smb: use kernel_connect() and kernel_bind()")</code> (SMB only)</li>
        </ul>
      </li>
      <li>ìœ„ì˜ íŒ¨ì¹˜ë“¤ì€ ë§ì€ ì•ˆì •í™” ì»¤ë„ë²„ì „ì— ë°±í¬íŠ¸ ë˜ì—ˆìœ¼ë©°, ì•„ë˜ì˜ ë°°í¬íŒ ì¤‘ í•´ë‹¹ ë²„ì „ ì´ìƒì—ì„œëŠ” í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.
        <ul>
          <li><strong>Ubuntu</strong>: <code class="language-plaintext highlighter-rouge">5.4.0-187-generic</code>, <code class="language-plaintext highlighter-rouge">5.15.0-113-generic</code>, <code class="language-plaintext highlighter-rouge">6.5.0-41-generic</code> or newer.</li>
          <li><strong>RHEL 8</strong>: <code class="language-plaintext highlighter-rouge">4.18.0-553.8.1.el8_10.x86_64</code> or newer (RHEL 8.10+).</li>
          <li><strong>RHEL 9</strong>: <code class="language-plaintext highlighter-rouge">kernel-5.14.0-427.31.1.el9_4</code> or newer (RHEL 9.4+).</li>
        </ul>
      </li>
      <li>ë³´ë‹¤ ìì„¸í•œ ì‚¬í•­ì€ <a href="https://github.com/cilium/cilium/issues/21541">Github Issue 21541</a>ë¥¼ í™•ì¸í•˜ì„¸ìš”.</li>
    </ul>
  </li>
  <li>Ciliumì€ kubernetesì˜ ì¤‘ì¶”ì ì¸ ì—­í• ì„ í•˜ëŠ” kube-proxyë¥¼ ëŒ€ì²´í•˜ê¸° ë•Œë¬¸ì—, Linux Network Stackì„ ì‚¬ìš©í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë“±ì„
ì ìš©ì‹œ ê¼­ ì‚¬ì „ ê²€ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆ ì£¼ì—ëŠ” ê°€ì¥ ê¸°ë³¸ì ì¸ CNIì¸ Flannelê³¼ ê°€ì¥ ê³ ë„í™”ëœ CNI ì¤‘ì˜ í•˜ë‚˜ì¸ Ciliumì„ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.
í•œë²ˆì— ë‘ê°€ì§€ë¥¼ ë¹„êµí•´ ë³´ë©´ì„œ Ciliumì˜ íŠ¹ì§•ê³¼ ì¥ì ì„ í™•ì¸í•˜ëŠ” ì‹œê°„ì´ì—ˆìŠµë‹ˆë‹¤.
ë˜í•œ Ciliumì´ ê¸°ëŠ¥ì ìœ¼ë¡œ í˜ì‹ ì ì´ê³  ìµœê·¼ ê¸°ìˆ ì¸ ë§Œí¼ ì•„ì§ ì—£ì§€ ì¼€ì´ìŠ¤ê°€ ë§ì´ ë‚¨ì•„ìˆë‹¤ëŠ” ê²ƒë„ ì•Œ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

<p>ì¤Œ ì˜ìƒ ìŠ¤í„°ë””ë¡œ í•œë²ˆ ì„¤ëª…ì„ ë“£ê³ , ì •ë¦¬ëœ ì‹¤ìŠµìë£Œë¥¼ ë”°ë¼í•˜ëŠ”ë° ì‹œê°„ì´ ì­‰ì­‰ ê°€ê³ , ì´í•´ê°€ ì˜ ì•ˆ ê°€ëŠ” ë¶€ë¶„ì´ ë§ì€ë°, 
ìŠ¤í„°ë””ë¥¼ ì¤€ë¹„í•´ì£¼ì‹œëŠ” CloudNet@ íŒ€ ë¶„ë“¤ì´ ì–¼ë§ˆë‚˜ ì •ì„±ê³¼ ì‹œê°„ì„ ìŸì•˜ì„ì§€ ê°ì‚¬í•œ ë§ˆìŒì´ ë“­ë‹ˆë‹¤.</p>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤ìŠµí™˜ê²½ì„ ì‚­ì œí•˜ë©° ë§ˆì¹˜ê² ìŠµë‹ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vagrant destroy <span class="nt">-f</span> <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> .vagrant
</code></pre></div></div>

<hr />

<ul>
  <li>ğŸ’ ì°¸ê³  : Cilium CMD Cheatsheet
    <ul>
      <li>Cheatsheet - <a href="https://docs.cilium.io/en/stable/cheatsheet/">Docs</a></li>
      <li>CMD References - <a href="https://docs.cilium.io/en/stable/cmdref/">Docs</a></li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium íŒŒë“œ ì´ë¦„</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-ctr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w2  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CILIUMPOD0</span> <span class="nv">$CILIUMPOD1</span> <span class="nv">$CILIUMPOD2</span>
  
<span class="c"># ë‹¨ì¶•í‚¤(alias) ì§€ì •</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
  
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
  
<span class="c"># endpoint</span>
<span class="nv">$ </span>c0 endpoint list
<span class="nv">$ </span>c0 endpoint list <span class="nt">-o</span> json
<span class="nv">$ </span>c1 endpoint list
<span class="nv">$ </span>c2 endpoint list
  
<span class="nv">$ </span>c1 endpoint get &lt;<span class="nb">id</span><span class="o">&gt;</span>
<span class="nv">$ </span>c1 endpoint log &lt;<span class="nb">id</span><span class="o">&gt;</span>
  
<span class="c">## Enable debugging output on the cilium-dbg monitor for this endpoint</span>
<span class="nv">$ </span>c1 endpoint config &lt;<span class="nb">id</span><span class="o">&gt;</span> <span class="nv">Debug</span><span class="o">=</span><span class="nb">true</span>
  
<span class="c"># monitor</span>
<span class="nv">$ </span>c1 monitor
<span class="nv">$ </span>c1 monitor <span class="nt">-v</span>
<span class="nv">$ </span>c1 monitor <span class="nt">-v</span> <span class="nt">-v</span>
  
<span class="c">## Filter for only the events related to endpoint</span>
<span class="nv">$ </span>c1 monitor <span class="nt">--related-to</span><span class="o">=</span>&lt;<span class="nb">id</span><span class="o">&gt;</span>
  
<span class="c">## Show notifications only for dropped packet events</span>
<span class="nv">$ </span>c1 monitor <span class="nt">--type</span> drop
  
<span class="c">## Donâ€™t dissect packet payload, display payload in hex information</span>
<span class="nv">$ </span>c1 monitor <span class="nt">-v</span> <span class="nt">-v</span> <span class="nt">--hex</span>
  
<span class="c">## Layer7</span>
<span class="nv">$ </span>c1 monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
  
<span class="c"># Manage IP addresses and associated information - IP List</span>
<span class="nv">$ </span>c0 ip list
  
<span class="c"># IDENTITY :  1(host), 2(world), 4(health), 6(remote), íŒŒë“œë§ˆë‹¤ ê°œë³„ ID</span>
<span class="nv">$ </span>c0 ip list <span class="nt">-n</span>
  
<span class="c"># Retrieve information about an identity</span>
<span class="nv">$ </span>c0 identity list
  
<span class="c"># ì—”ë“œí¬ì¸íŠ¸ ê¸°ì¤€ ID</span>
<span class="nv">$ </span>c0 identity list <span class="nt">--endpoints</span>
  
<span class="c"># ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • í™•ì¸ ë° ë³€ê²½</span>
<span class="nv">$ </span>c0 endpoint config &lt;ì—”íŠ¸í¬ì¸íŠ¸ID&gt;
  
<span class="c"># ì—”ë“œí¬ì¸íŠ¸ ìƒì„¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>c0 endpoint get &lt;ì—”íŠ¸í¬ì¸íŠ¸ID&gt;
  
<span class="c"># ì—”ë“œí¬ì¸íŠ¸ ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>c0 endpoint log &lt;ì—”íŠ¸í¬ì¸íŠ¸ID&gt;
  
<span class="c"># Show bpf filesystem mount details</span>
<span class="nv">$ </span>c0 bpf fs show
  
<span class="c"># bfp ë§ˆìš´íŠ¸ í´ë” í™•ì¸</span>
<span class="nv">$ </span>tree /sys/fs/bpf
  
<span class="c"># Get list of loadbalancer services</span>
<span class="nv">$ </span>c0 service list
<span class="nv">$ </span>c1 service list
<span class="nv">$ </span>c2 service list
  
<span class="c">## Or you can get the loadbalancer information using bpf list</span>
<span class="nv">$ </span>c0 bpf lb list
<span class="nv">$ </span>c1 bpf lb list
<span class="nv">$ </span>c2 bpf lb list
  
<span class="c">## List reverse NAT entries</span>
<span class="nv">$ </span>c1 bpf lb list <span class="nt">--revnat</span>
<span class="nv">$ </span>c2 bpf lb list <span class="nt">--revnat</span>
  
<span class="c"># List connection tracking entries</span>
<span class="nv">$ </span>c0 bpf ct list global
<span class="nv">$ </span>c1 bpf ct list global
<span class="nv">$ </span>c2 bpf ct list global
  
<span class="c"># Flush connection tracking entries</span>
<span class="nv">$ </span>c0 bpf ct flush
<span class="nv">$ </span>c1 bpf ct flush
<span class="nv">$ </span>c2 bpf ct flush
  
<span class="c"># List all NAT mapping entries</span>
<span class="nv">$ </span>c0 bpf nat list
<span class="nv">$ </span>c1 bpf nat list
<span class="nv">$ </span>c2 bpf nat list
  
<span class="c"># Flush all NAT mapping entries</span>
<span class="nv">$ </span>c0 bpf nat flush
<span class="nv">$ </span>c1 bpf nat flush
<span class="nv">$ </span>c2 bpf nat flush
  
<span class="c"># Manage the IPCache mappings for IP/CIDR &lt;-&gt; Identity</span>
<span class="nv">$ </span>c0 bpf ipcache list# Display cgroup metadata maintained by Cilium
<span class="nv">$ </span>c0 cgroups list
<span class="nv">$ </span>c1 cgroups list
<span class="nv">$ </span>c2 cgroups list
  
<span class="c"># List all open BPF maps</span>
<span class="nv">$ </span>c0 map list
<span class="nv">$ </span>c1 map list <span class="nt">--verbose</span>
<span class="nv">$ </span>c2 map list <span class="nt">--verbose</span>
  
<span class="nv">$ </span>c1 map events cilium_lb4_services_v2
<span class="nv">$ </span>c1 map events cilium_lb4_reverse_nat
<span class="nv">$ </span>c1 map events cilium_lxc
<span class="nv">$ </span>c1 map events cilium_ipcache
  
<span class="c"># List all metrics</span>
<span class="nv">$ </span>c1 metrics list
  
<span class="c"># List contents of a policy BPF map : Dump all policy maps</span>
<span class="nv">$ </span>c0 bpf policy get <span class="nt">--all</span>
<span class="nv">$ </span>c1 bpf policy get <span class="nt">--all</span> <span class="nt">-n</span>
<span class="nv">$ </span>c2 bpf policy get <span class="nt">--all</span> <span class="nt">-n</span>
  
<span class="c"># Dump StateDB contents as JSON</span>
<span class="nv">$ </span>c0 statedb dump
  
<span class="c">#</span>
<span class="nv">$ </span>c0 shell <span class="nt">--</span> db/show devices
<span class="nv">$ </span>c1 shell <span class="nt">--</span> db/show devices
<span class="nv">$ </span>c2 shell <span class="nt">--</span> db/show devices 
</code></pre></div>    </div>
  </li>
</ul>]]></content><author><name></name></author><category term="cilium" /><category term="kubernetes," /><category term="network," /><category term="linux," /><category term="cilium" /><summary type="html"><![CDATA[Cilium CNIë¥¼ ì‹¤ìŠµí•˜ê¸° ìœ„í•œ í™˜ê²½ì„ êµ¬ì„±í•˜ê³  Ciliumì„ ì„¤ì¹˜í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë´…ë‹ˆë‹¤.]]></summary></entry><entry><title type="html">MacOS ì—…ë°ì´íŠ¸ í›„ Magnetì´ ìë™ ì‹œì‘ì´ ì•ˆ ë  ë•Œ í•´ê²° ë°©ë²•</title><link href="https://sweetlittlebird.github.io/posts/2025-06-28-MacOS-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8-%ED%9B%84-Magnet%EC%9D%B4-%EC%9E%90%EB%8F%99-%EC%8B%9C%EC%9E%91%EC%9D%B4-%EC%95%88-%EB%90%A0-%EB%95%8C-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95/" rel="alternate" type="text/html" title="MacOS ì—…ë°ì´íŠ¸ í›„ Magnetì´ ìë™ ì‹œì‘ì´ ì•ˆ ë  ë•Œ í•´ê²° ë°©ë²•" /><published>2025-06-28T10:00:00+09:00</published><updated>2025-06-28T10:00:00+09:00</updated><id>https://sweetlittlebird.github.io/posts/MacOS%20%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8%20%ED%9B%84%20Magnet%EC%9D%B4%20%EC%9E%90%EB%8F%99%20%EC%8B%9C%EC%9E%91%EC%9D%B4%20%EC%95%88%20%EB%90%A0%20%EB%95%8C%20%ED%95%B4%EA%B2%B0%20%EB%B0%A9%EB%B2%95</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2025-06-28-MacOS-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8-%ED%9B%84-Magnet%EC%9D%B4-%EC%9E%90%EB%8F%99-%EC%8B%9C%EC%9E%91%EC%9D%B4-%EC%95%88-%EB%90%A0-%EB%95%8C-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p><img src="/assets/2025/2025-06-28/img.png" alt="img.png" class="w-20 image-center" /></p>

<p>Magnetì€ MacOSì—ì„œ ì°½ ê´€ë¦¬ë¥¼ ë„ì™€ì£¼ëŠ” ìœ ìš©í•œ ì•±ì…ë‹ˆë‹¤. 
ìœ ë£Œ ì•±ì´ê³  Mac App Storeì—ì„œ êµ¬ë§¤í•´ì•¼ í•˜ì§€ë§Œ, ê·¸ë§Œí•œ ê°€ì¹˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
ë¬´ë£Œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” <a href="https://rectangleapp.com/">Rectangle</a>ê³¼ ê°™ì€ ëŒ€ì•ˆë„ ìˆì§€ë§Œ, 
ë¬´ìƒ ì—…ë°ì´íŠ¸ë¥¼ ê³„ì† í•´ì£¼ê³  ìˆê³  Mac App Storeì—ì„œ êµ¬ë§¤í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë¯¿ì„ ìˆ˜ ìˆì–´ì„œ
ê³„ì† ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>

<p>í•˜ì§€ë§Œ MacOS ì—…ë°ì´íŠ¸ í›„ Magnetì´ ìë™ìœ¼ë¡œ ì‹œì‘ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê¸€ì—ì„œëŠ” ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h2 id="ë¬¸ì œ-ë°œìƒ">ë¬¸ì œ ë°œìƒ</h2>

<p>MacOS Venturaì—ì„œ Sequoiaë¡œ ì—…ë°ì´íŠ¸í•œ í›„ Magnetì´ ê¸°ëŠ¥ì€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ì§€ë§Œ,
ìë™ìœ¼ë¡œ ì‹œì‘ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
ì‹œìŠ¤í…œ ì„¤ì •ì—ì„œ 
<code class="language-plaintext highlighter-rouge">ì‹œìŠ¤í…œ ì„¤ì • &gt; ì¼ë°˜ &gt; ë¡œê·¸ì¸ í•­ëª©</code>ì— Magnetì´ ë“±ë¡ë˜ì–´ìˆì§€ ì•Šê³  
<code class="language-plaintext highlighter-rouge">ì‹œìŠ¤í…œ ì„¤ì • &gt; ì¼ë°˜ &gt; ë¡œê·¸ì¸ í•­ëª© &gt; + ë²„íŠ¼</code>ì„ ëˆŒëŸ¬ì„œ Magnetì„ ì¶”ê°€í•´ë„ ì¶”ê°€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>

<p>ìˆ˜ë™ìœ¼ë¡œ ì¼œë©´ ë˜ì§€ë§Œ ë§¤ë²ˆ ìˆ˜ë™ìœ¼ë¡œ ì¼œëŠ” ê²ƒì€ ë²ˆê±°ë¡­ê¸° ë•Œë¬¸ì—
ë¬¸ì œ í•´ê²° ë°©ë²•ì„ ì°¾ì•„ë³´ì•˜ìŠµë‹ˆë‹¤.</p>

<h2 id="í•´ê²°-ë°©ë²•">í•´ê²° ë°©ë²•</h2>

<p><a href="https://www.reddit.com/r/MacOS/comments/101s7d3/magnet_app_does_not_start_on_boot/">ë ˆë”§ ê¸€</a>ì—ì„œ í•´ê²°ë°©ë²•ì„ ì°¾ì•„ì„œ
ì—¬ê¸°ì— ë‚¨ê²¨ ë´…ë‹ˆë‹¤.</p>

<ol>
  <li>ì ‘ê·¼ì„± ê¶Œí•œ ì¬ì„¤ì •
    <ul>
      <li>Magnet ì¢…ë£Œ â†’ <code class="language-plaintext highlighter-rouge">ì‹œìŠ¤í…œ ì„¤ì • &gt; ê°œì¸ì •ë³´ ë³´í˜¸ ë° ë³´ì•ˆ &gt; ì ‘ê·¼ì„±</code>ì—ì„œ Magnet ë¹„í™œì„±í™” ë° ì œê±°</li>
    </ul>
  </li>
  <li>ì•± ë° ì„¤ì • íŒŒì¼ ì™„ì „ ì‚­ì œ
    <ul>
      <li>Magnet ì•±ì„ ì‘ìš© í”„ë¡œê·¸ë¨ í´ë”ì—ì„œ ì‚­ì œ.</li>
      <li>~/Library/Preferences í´ë”ì—ì„œ com.crowdcafe.windowmagnet.plist íŒŒì¼ ì‚­ì œ.</li>
      <li>íœ´ì§€í†µ ë¹„ìš°ê¸° ë° Mac ì¬ì‹œë™.</li>
    </ul>
  </li>
  <li>ì•± ì¬ì„¤ì¹˜ ë° ê¶Œí•œ ì¬ë¶€ì—¬
    <ul>
      <li>App Storeì—ì„œ Magnet ìµœì‹  ë²„ì „ ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜.</li>
      <li>Magnet ì‹¤í–‰ í›„ ì ‘ê·¼ì„± ê¶Œí•œ ìš”ì²­ ì‹œ, ë°˜ë“œì‹œ í—ˆìš©.</li>
      <li>Magnet í™˜ê²½ì„¤ì •ì—ì„œ â€˜ë¡œê·¸ì¸ ì‹œ ìë™ ì‹¤í–‰(Launch at Login)â€™ ì˜µì…˜ í™œì„±í™”.</li>
    </ul>
  </li>
  <li>ë¬¸ì œ ì§€ì† ì‹œ
    <ul>
      <li>ìœ„ ê³¼ì •ì„ ë°˜ë³µí•´ë„ ë¬¸ì œê°€ ê³„ì†ëœë‹¤ë©´, Magnet ê°œë°œì‚¬ì— ë²„ê·¸ ë¦¬í¬íŠ¸ ì œì¶œ</li>
    </ul>
  </li>
</ol>

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ ë°©ë²•ìœ¼ë¡œ Magnetì´ ìë™ìœ¼ë¡œ ì‹œì‘ë˜ì§€ ì•ŠëŠ” ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
ë¸”ë¡œê·¸ ê¸€ì„ ì“°ë‹¤ë³´ë‹ˆ í•´ê²°í•˜ëŠ” ë°©ë²•ë³´ë‹¤ ë¶€ê°€ì ì¸ ë‚´ìš©ì„ ë” ë§ì´ ì‘ì„±í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ì´ê²Œ ë§ë‚˜ ì‹¶ê¸´í•œë° ë°˜ë…„ë™ì•ˆ ë°©ì¹˜í–ˆë˜ ë¸”ë¡œê·¸ë¥¼ ë‹¤ì‹œ ì‹œì‘í•˜ëŠ” ì˜ë¯¸ë¡œ
ì‘ì„±í•´ë´…ë‹ˆë‹¤. ë‹¤ìŒë²ˆì—ëŠ” ë” ìœ ìµí•œ ê¸€ë¡œ ì°¾ì•„ëµ™ê¸°ë¥¼ ê¸°ì›í•´ë´…ë‹ˆë‹¤. :pray:</p>

<p>ps. ì—…ë°ì´íŠ¸ í›„ Magnetì— ì„¤ì •ê¸°ëŠ¥ì´ êµ‰ì¥íˆ ê°•ë ¥í•´ì§„ê²ƒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.
ë¬´ìƒìœ¼ë¡œ ì´ë ‡ê²Œ ì¢‹ì€ ê¸°ëŠ¥ì„ ì œê³µí•´ì£¼ë‹¤ë‹ˆ ê°œë°œì‚¬ì— ê°ì‚¬í•  ë”°ë¦„ì…ë‹ˆë‹¤.</p>

<p><img src="/assets/2025/2025-06-28/20250628_magnet.png" alt="img.png" class="w-80 image-center" /></p>]]></content><author><name></name></author><category term="macos," /><category term="troubleshooting" /><category term="macos," /><category term="magnet," /><category term="troubleshooting" /><summary type="html"><![CDATA[Magnetì€ MacOSì—ì„œ ì°½ ê´€ë¦¬ë¥¼ ë„ì™€ì£¼ëŠ” ìœ ìš©í•œ ì•±ì…ë‹ˆë‹¤. MacOS ì—…ë°ì´íŠ¸ í›„ Magnetì´ ìë™ìœ¼ë¡œ ì‹œì‘ë˜ì§€ ì•ŠëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë´…ë‹ˆë‹¤.]]></summary></entry><entry><title type="html">[CI/CD] Jenkins CI/ArgoCD + K8S</title><link href="https://sweetlittlebird.github.io/posts/2024-12-22-CICD-Lite-Week3/" rel="alternate" type="text/html" title="[CI/CD] Jenkins CI/ArgoCD + K8S" /><published>2024-12-22T00:01:18+09:00</published><updated>2024-12-22T00:01:18+09:00</updated><id>https://sweetlittlebird.github.io/posts/CICD%20Lite%20-%20Week3</id><content type="html" xml:base="https://sweetlittlebird.github.io/posts/2024-12-22-CICD-Lite-Week3/"><![CDATA[<h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆ ì£¼ì—ëŠ” ArgoCDì™€ Jenkinsë¥¼ ì‚¬ìš©í•˜ì—¬ Kubernetesë¡œì˜ ë°°í¬ë¥¼ í•˜ëŠ” CI/CDë¥¼ êµ¬ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h2 id="jenkins-ciargocd--k8s">Jenkins CI/ArgoCD + K8S</h2>

<h3 id="ì‹¤ìŠµí™˜ê²½-êµ¬ì„±">ì‹¤ìŠµí™˜ê²½ êµ¬ì„±</h3>

<ul>
  <li>ì´ë²ˆì—ëŠ” ê°œë°œ PCì— Jenkinsì™€ Gogsë¥¼ ì„¤ì¹˜í•˜ê³ , Kindë¥¼ ì‚¬ìš©í•˜ì—¬ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ê³  ArgoCDë¥¼ ì„¤ì¹˜í•˜ì—¬ CI/CDë¥¼ êµ¬ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="jenkins-gogs-ì„¤ì¹˜">Jenkins, Gogs ì„¤ì¹˜</h4>

<ul>
  <li>Jenkinsì˜ ê²½ìš° 1ì£¼ì°¨ì—ì„œ ì„¤ì¹˜í•˜ì˜€ì§€ë§Œ ë‹¤ì‹œ í•œë²ˆ ë˜ì§šì–´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ë˜í•œ ì´ë²ˆì—ëŠ” Gitlab í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ëŒ€ì‹ , ìì²´ PCì— Gogsë¥¼ ì„¤ì¹˜í•˜ì—¬ ì‚¬ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„± í›„ ì´ë™</span>
<span class="nv">$ </span><span class="nb">mkdir </span>cicd-labs
<span class="nv">$ </span><span class="nb">cd </span>cicd-labs

<span class="c"># </span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; docker-compose.yaml
services:

  jenkins:
    container_name: jenkins
    image: jenkins/jenkins
    restart: unless-stopped
    networks:
      - cicd-network
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - jenkins_home:/var/jenkins_home

  gogs:
    container_name: gogs
    image: gogs/gogs
    restart: unless-stopped
    networks:
      - cicd-network
    ports:
      - "10022:22"
      - "3000:3000"
    volumes:
      - gogs-data:/data

volumes:
  jenkins_home:
  gogs-data:

networks:
  cicd-network:
    driver: bridge
</span><span class="no">EOT


</span><span class="c"># ë°°í¬</span>
<span class="nv">$ </span>docker compose up <span class="nt">-d</span>
<span class="c"># =&gt; [+] Running 2/2</span>
<span class="c">#     â ¿ Container jenkins  Started  0.5s</span>
<span class="c">#     â ¿ Container gogs     Started  0.5s</span>
<span class="nv">$ </span>docker compose ps
<span class="c"># =&gt; NAME                COMMAND                  SERVICE             STATUS              PORTS</span>
<span class="c">#    gogs                &amp;quot;/app/gogs/docker/stâ€¦&amp;quot;   gogs                running (healthy)   0.0.0.0:10022-&amp;gt;22/tcp, 0.0.0.0:3000-&amp;gt;3000/tcp</span>
<span class="c">#    jenkins             &amp;quot;/usr/bin/tini -- /uâ€¦&amp;quot;   jenkins             running             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp</span>

<span class="c"># ê¸°ë³¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>gogs jenkins <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; container : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker compose <span class="nb">exec</span> <span class="nv">$i</span> sh <span class="nt">-c</span> <span class="s2">"whoami &amp;&amp; pwd"</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; container : gogs &amp;lt;&amp;lt;</span>
<span class="c">#    root</span>
<span class="c">#    /app/gogs</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; container : jenkins &amp;lt;&amp;lt;</span>
<span class="c">#    jenkins</span>
<span class="c">#    /</span>

<span class="c"># ë„ì»¤ë¥¼ ì´ìš©í•˜ì—¬ ê° ì»¨í…Œì´ë„ˆë¡œ ì ‘ì†</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins bash
<span class="nv">$ </span><span class="nb">exit</span>

<span class="nv">$ </span>docker compose <span class="nb">exec </span>gogs bash
<span class="nv">$ </span><span class="nb">exit</span>
</code></pre></div></div>

<h4 id="jenkins-ì»¨í…Œì´ë„ˆ-ì´ˆê¸°ì„¤ì •">Jenkins ì»¨í…Œì´ë„ˆ ì´ˆê¸°ì„¤ì •</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Jenkins ì´ˆê¸° ì•”í˜¸ í™•ì¸</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins <span class="nb">cat</span> /var/jenkins_home/secrets/initialAdminPassword
<span class="c"># =&gt; 3da38dccc7d14d1a8bee4b02c4e09da8</span>

<span class="c"># Jenkins ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸ : ê³„ì • / ì•”í˜¸ ì…ë ¥ &gt;&gt; **admin / qwe123**</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:8080"</span> <span class="c"># macOS</span>

<span class="c"># (ì°¸ê³ ) ë¡œê·¸ í™•ì¸ : í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ê³¼ì • í™•ì¸</span>
<span class="nv">$ </span>docker compose logs jenkins <span class="nt">-f</span>

<span class="c"># IP í™•ì¸ (MacOS ê¸°ì¤€)</span>
<span class="nv">$ </span>ifconfig | <span class="nb">grep</span> <span class="s2">"inet "</span> | <span class="nb">grep</span> <span class="nt">-v</span> 127.0.0
<span class="c"># =&gt; inet &lt;span style="color: red;"&gt;10.0.4.3&lt;/span&gt; netmask 0xffffff00 broadcast 10.0.4.255</span>
<span class="c"># ë˜ëŠ”</span>
<span class="nv">$ </span>ipconfig getifaddr en0
<span class="c"># =&gt; &lt;span style="color: red;"&gt;10.0.4.3&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>Jenkins URL ì„¤ì •</li>
</ul>

<p>ì•ì„œ í™•ì¸í•œ IP ì£¼ì†Œë¥¼ ì´ìš©í•˜ì—¬ Jenkins URLì„ ì„¤ì •í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_1.png" alt="img.png" /></p>

<ul>
  <li>1ì£¼ì°¨ë•Œì™€ ë§ˆì°¬ê°€ì§€ë¡œ Docker-out-of-Dockerë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ <a href="https://sweetlittlebird.github.io/posts/2024-12-08-CICD-Lite-Week1/#jenkins-%EC%86%8C%EA%B0%9C">1ì£¼ì°¨ ë‚´ìš©</a>ì„ ì°¸ê³ í•˜ì„¸ìš”.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Jenkins ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— ë„ì»¤ ì‹¤í–‰ íŒŒì¼ ì„¤ì¹˜</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins bash
<span class="nt">-----------------------------------------------------</span>
<span class="nv">$ </span><span class="nb">id</span>

<span class="nv">$ </span>curl <span class="nt">-fsSL</span> https://download.docker.com/linux/debian/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="c"># =&gt; uid=0(root) gid=0(root) groups=0(root)</span>
<span class="nv">$ </span><span class="nb">chmod </span>a+r /etc/apt/keyrings/docker.asc
<span class="nv">$ </span><span class="nb">echo</span> <span class="se">\</span>
  <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian </span><span class="se">\</span><span class="s2">
  </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="se">\</span>
  <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
<span class="nv">$ </span>apt-get update <span class="o">&amp;&amp;</span> apt <span class="nb">install </span>docker-ce-cli curl tree jq yq <span class="nt">-y</span>

<span class="nv">$ </span>docker info
<span class="c"># =&gt; Client: Docker Engine - Community</span>
<span class="c">#     Version:    27.4.1</span>
<span class="c">#     Context:    default</span>
<span class="c">#     Debug Mode: false</span>
<span class="c">#     Plugins:</span>
<span class="c">#      buildx: Docker Buildx (Docker Inc.)</span>
<span class="c">#        Version:  v0.19.3</span>
<span class="c">#        Path:     /usr/libexec/docker/cli-plugins/docker-buildx</span>
<span class="c">#      compose: Docker Compose (Docker Inc.)</span>
<span class="c">#        Version:  v2.32.1</span>
<span class="c">#        Path:     /usr/libexec/docker/cli-plugins/docker-compose</span>
<span class="c">#    </span>
<span class="c">#    Server:</span>
<span class="c">#     Containers: 29</span>
<span class="c">#      Running: 2</span>
<span class="c">#      Paused: 0</span>
<span class="c">#      Stopped: 27</span>
<span class="c">#     Images: 42</span>
<span class="c">#     Server Version: 20.10.12</span>
<span class="c">#     Storage Driver: overlay2</span>
<span class="c">#      Backing Filesystem: extfs</span>
<span class="c">#      Supports d_type: true</span>
<span class="c">#      Native Overlay Diff: true</span>
<span class="c">#      userxattr: false</span>
<span class="c">#     Logging Driver: json-file</span>
<span class="c">#     Cgroup Driver: cgroupfs</span>
<span class="c">#     Cgroup Version: 2</span>
<span class="c">#     ...</span>
<span class="c">#     Insecure Registries:</span>
<span class="c">#      hubproxy.docker.internal:5000</span>
<span class="c">#      127.0.0.0/8</span>
<span class="c">#     Live Restore Enabled: false</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE             COMMAND                  CREATED        STATUS                    PORTS                                              NAMES</span>
<span class="c">#    110494b9ca48   gogs/gogs         &amp;quot;/app/gogs/docker/stâ€¦&amp;quot;   14 hours ago   Up 37 minutes (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins   &amp;quot;/usr/bin/tini -- /uâ€¦&amp;quot;   14 hours ago   Up 37 minutes             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ DooDì´ê¸° ë•Œë¬¸ì— í˜¸ìŠ¤íŠ¸ì—ì„œ ë™ì‘ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ë³´ì…ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>which docker
<span class="c"># =&gt; /usr/bin/docker</span>

<span class="c"># Jenkins ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ rootê°€ ì•„ë‹Œ jenkins ìœ ì €ë„ dockerë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ ë¶€ì—¬</span>
<span class="nv">$ </span>groupadd <span class="nt">-g</span> 2000 <span class="nt">-f</span> docker  <span class="c"># macOS(Container)</span>
<span class="c"># $ groupadd -g 1001 -f docker  # Windows WSL2(Container) &gt;&gt; cat /etc/group ì—ì„œ docker ê·¸ë£¹IDë¥¼ ì§€ì •</span>

<span class="nv">$ </span><span class="nb">chgrp </span>docker /var/run/docker.sock
<span class="nv">$ </span><span class="nb">chmod </span>g+w /var/run/docker.sock
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /var/run/docker.sock
<span class="c"># =&gt; srwxrwxr-x 1 root docker 0 Oct 01 06:03 /var/run/docker.sock</span>
<span class="nv">$ </span>usermod <span class="nt">-aG</span> docker jenkins
<span class="nv">$ </span><span class="nb">cat</span> /etc/group | <span class="nb">grep </span>docker
<span class="c"># =&gt; docker:x:2000:jenkins</span>

<span class="nb">exit</span>
<span class="nt">--------------------------------------------</span>

<span class="c"># jenkins item ì‹¤í–‰ ì‹œ docker ëª…ë ¹ ì‹¤í–‰ ê¶Œí•œ ì—ëŸ¬ ë°œìƒ : Jenkins ì»¨í…Œì´ë„ˆ ì¬ê¸°ë™ìœ¼ë¡œ ìœ„ ì„¤ì • ë‚´ìš©ì„ Jenkins app ì—ë„ ì ìš© í•„ìš”</span>
<span class="nv">$ </span>docker compose restart jenkins
<span class="c"># =&gt; [+] Running 1/1</span>
<span class="c">#     â ¿ Container jenkins  Started    0.9s</span>
<span class="c"># $ sudo docker compose restart jenkins  # Windows ê²½ìš° ì´í›„ë¶€í„° sudo ë¶™ì—¬ì„œ ì‹¤í–‰í•˜ì</span>

<span class="c"># jenkins userë¡œ docker ëª…ë ¹ ì‹¤í–‰ í™•ì¸</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins <span class="nb">id</span>
<span class="c"># =&gt; uid=1000(jenkins) gid=1000(jenkins) groups=1000(jenkins),2000(docker)</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins docker info
<span class="c"># =&gt; Client: Docker Engine - Community</span>
<span class="c">#     Version:    27.4.1</span>
<span class="c">#     ...</span>
<span class="c">#    </span>
<span class="c">#    Server:</span>
<span class="c">#     Containers: 29</span>
<span class="c">#      Running: 2</span>
<span class="c">#      Paused: 0</span>
<span class="c">#      Stopped: 27</span>
<span class="c">#     Images: 42</span>
<span class="c">#     Server Version: 20.10.12</span>
<span class="c">#     ...</span>
<span class="c">#     Live Restore Enabled: false</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE             COMMAND                  CREATED        STATUS                    PORTS                                              NAMES</span>
<span class="c">#    110494b9ca48   gogs/gogs         &amp;quot;/app/gogs/docker/stâ€¦&amp;quot;   14 hours ago   Up 41 minutes (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins   &amp;quot;/usr/bin/tini -- /uâ€¦&amp;quot;   14 hours ago   Up 57 seconds             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>
</code></pre></div></div>

<ul>
  <li>OS ì¬ë¶€íŒ…ì‹œì— jenkins ì»¨í…Œì´ë„ˆì—ì„œ docker ì‹¤í–‰ì´ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ê°€ ìˆëŠ”ë°, ê·¸ëŸ´ ê²½ìš° ì•„ë˜ì™€ ê°™ì´ docker ê·¸ë£¹ì„ ë‹¤ì‹œ ì§€ì •í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì†Œì¼“ íŒŒì¼ì˜ ê¶Œí•œ í™•ì¸</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins <span class="nb">ls</span> <span class="nt">-l</span> /var/run/docker.sock
<span class="c"># =&gt; srwxr-xr-x 1 root root 0 Oct 01 05:22 /var/run/docker.sock</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê·¸ë£¹ì´ rootë¡œ ë³µêµ¬ë˜ì–´ìˆìŠµë‹ˆë‹¤. docker ê·¸ë£¹ìœ¼ë¡œ ë‹¤ì‹œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì†Œì¼“ íŒŒì¼ì— docker ê·¸ë£¹ì„ ë‹¤ì‹œ ì§€ì •</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins <span class="nb">chgrp </span>docker /var/run/docker.sock

<span class="c"># ì†Œì¼“ íŒŒì¼ì— docker ê·¸ë£¹ ì“°ê¸°ê¶Œí•œ ë‹¤ì‹œ ì§€ì •</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins <span class="nb">chmod </span>g+w /var/run/docker.sock

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins <span class="nb">ls</span> <span class="nt">-l</span> /var/run/docker.sock
<span class="c"># =&gt; srwxrwxr-x 1 root docker 0 Oct 01 05:22 /var/run/docker.sock</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins docker info
</code></pre></div></div>

<h4 id="gogs-ì´ˆê¸°-ì„¤ì •">Gogs ì´ˆê¸° ì„¤ì •</h4>

<ul>
  <li>ì´ˆê¸°ì„¤ì •ì„ ìœ„í•´ ì›¹ ì ‘ì†ì„ í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì´ˆê¸° ì„¤ì • ì›¹ ì ‘ì†</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:3000/install"</span> <span class="c"># macOS</span>
<span class="c"># ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ http://127.0.0.1:3000/install ì ‘ì† # Windows</span>
</code></pre></div></div>

<ul>
  <li>ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •ê°’ì„ ë³€ê²½í•©ë‹ˆë‹¤.
    <ul>
      <li>Database Type : SQLite3</li>
      <li>Application URL : <code class="language-plaintext highlighter-rouge">http://&lt;ì•ì—ì„œ í™•ì¸í•œ IP&gt;:3000/</code></li>
      <li>Default Branch : main</li>
      <li>ê´€ë¦¬ì ê³„ì • ì„¤ì • í´ë¦­ : username : devops, password : qwe123, emailì…ë ¥
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_2.png" alt="img.png" /></li>
    </ul>
  </li>
  <li>Install Gogs ë²„íŠ¼ í´ë¦­ =&gt; ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</li>
</ul>

<h5 id="access-token-ë°œí–‰">Access Token ë°œí–‰</h5>

<ul>
  <li>ë¡œê·¸ì¸ í›„ Your Settings &gt; Applications &gt; Generate New Token í´ë¦­ &gt; Token Name(devops) &gt; Generate Token í´ë¦­í•˜ì—¬ í† í°ì„ ë°œí–‰í•©ë‹ˆë‹¤.</li>
  <li>ë°œí–‰ëœ í† í°(<code class="language-plaintext highlighter-rouge">a85f33b7fd28ac1ed83c3233fc4ca3a67c04c296</code>)ì„ ë³µì‚¬í•˜ì—¬ ì•ˆì „í•œ ê³³ì— ê¸°ë¡í•´ë‘¡ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_3.png" alt="img.png" /></p>

<h5 id="repository-ìƒì„±">Repository ìƒì„±</h5>

<ul>
  <li>ìš°ì¸¡ìƒë‹¨ì˜ <code class="language-plaintext highlighter-rouge">+</code> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë‚˜ì˜¤ëŠ” ë©”ë‰´ì—ì„œ New Repositoryë¥¼ í´ë¦­í•´ì„œ ìƒˆë¡œìš´ Repositoryë¥¼ ë‹¤ìŒê³¼ ê°™ì´ 2ê°œ ìƒì„±í•©ë‹ˆë‹¤.</li>
  <li><strong>ê°œë°œíŒ€ìš©</strong>
    <ul>
      <li>Repository Name : <strong>dev-app</strong></li>
      <li>Visibility : (<strong>Check</strong>) This repository is <strong>Private</strong></li>
      <li>.gitignore : <strong>Python</strong></li>
      <li>Readme : Default â†’ (Check) initialize this repository with selected files and template</li>
    </ul>

    <p>â‡’ Create Repository í´ë¦­ =&gt; Repo ì£¼ì†Œ í™•ì¸ (<code class="language-plaintext highlighter-rouge">http://10.0.4.3:3000/devops/dev-apps.git</code>)</p>
  </li>
  <li><strong>ë°ë¸Œì˜µìŠ¤íŒ€ìš©</strong>
    <ul>
      <li>Repository Name : <strong>ops-deploy</strong></li>
      <li>Visibility : (<strong>ì²´í¬</strong>) This repository is <strong>Private</strong></li>
      <li>Readme : Default â†’ (ì²´í¬) initialize this repository with selected files and template</li>
    </ul>

    <p>â‡’ Create Repository í´ë¦­ =&gt; Repo ì£¼ì†Œ í™•ì¸ (<code class="language-plaintext highlighter-rouge">http://10.0.4.3:3000/devops/ops-deploy.git</code>)</p>
  </li>
</ul>

<h5 id="gogs-ì‹¤ìŠµì„-ìœ„í•´-í˜¸ìŠ¤íŠ¸-pcì˜-git-ì„¤ì •">Gogs ì‹¤ìŠµì„ ìœ„í•´ í˜¸ìŠ¤íŠ¸ PCì˜ git ì„¤ì •</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># (ì˜µì…˜) GIT ì¸ì¦ ì •ë³´ ì´ˆê¸°í™”</span>
<span class="nv">$ </span>git credential-cache <span class="nb">exit</span>

<span class="c">#</span>
<span class="c"># $ git clone &lt;ê°ì Gogs dev-app repo ì£¼ì†Œ&gt;</span>
<span class="nv">$ </span>git clone http://10.0.4.3:3000/devops/dev-app.git
<span class="c"># =&gt; Cloning into 'dev-app'...</span>
<span class="c">#    Username for 'http://10.0.4.3:3000': devops</span>
<span class="c">#    Password for 'http://a@10.0.4.3:3000': # &lt;span style="color: green;"&gt;ì•ì„œ ë°œê¸‰ë°›ì€ access key ì…ë ¥&lt;/span&gt;</span>

<span class="c">#    remote: Enumerating objects: 4, done.</span>
<span class="c">#    remote: Counting objects: 100% (4/4), done.</span>
<span class="c">#    remote: Compressing objects: 100% (3/3), done.</span>
<span class="c">#    remote: Total 4 (delta 0), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    Unpacking objects: 100% (4/4), 705 bytes | 352.00 KiB/s, done.</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cd </span>dev-app

<span class="c">#</span>
<span class="nv">$ </span>git config user.name <span class="s2">"devops"</span>
<span class="nv">$ </span>git config user.email <span class="s2">"a@a.com"</span>
<span class="nv">$ </span>git config init.defaultBranch main
<span class="nv">$ </span>git config credential.helper store

<span class="c">#</span>
<span class="nv">$ </span>git branch
<span class="c"># =&gt; * main</span>
<span class="nv">$ </span>git remote <span class="nt">-v</span>
<span class="c"># =&gt; origin  http://10.0.4.3:3000/devops/dev-app.git (fetch)</span>
<span class="c">#    origin  http://10.0.4.3:3000/devops/dev-app.git (push)</span>

<span class="c"># server.py íŒŒì¼ ì‘ì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> server.py <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
from http.server import ThreadingHTTPServer, BaseHTTPRequestHandler
from datetime import datetime
import socket

class RequestHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()
        
        now = datetime.now()
        hostname = socket.gethostname()
        response_string = now.strftime("The time is %-I:%M:%S %p, VERSION 0.0.1</span><span class="se">\n</span><span class="sh">")
        response_string += f"Server hostname: {hostname}</span><span class="se">\n</span><span class="sh">"
        self.wfile.write(bytes(response_string, "utf-8")) 

def startServer():
    try:
        server = ThreadingHTTPServer(('', 80), RequestHandler)
        print("Listening on " + ":".join(map(str, server.server_address)))
        server.serve_forever()
    except KeyboardInterrupt:
        server.shutdown()

if __name__ == "__main__":
    startServer()
</span><span class="no">EOF

</span><span class="c"># Dockerfile ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Dockerfile <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
FROM python:3.12
ENV PYTHONUNBUFFERED 1
COPY . /app
WORKDIR /app 
CMD python3 server.py
</span><span class="no">EOF

</span><span class="c"># VERSION íŒŒì¼ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"0.0.1"</span> <span class="o">&gt;</span> VERSION

<span class="c">#</span>
<span class="nv">$ </span>git status
<span class="c"># =&gt; On branch main</span>
<span class="c">#    Your branch is up to date with 'origin/main'.</span>
<span class="c">#    </span>
<span class="c">#    Untracked files:</span>
<span class="c">#      (use &amp;quot;git add &amp;lt;file&amp;gt;...&amp;quot; to include in what will be committed)</span>
<span class="c">#            Dockerfile</span>
<span class="c">#            VERSION</span>
<span class="c">#            server.py</span>
<span class="c">#    </span>
<span class="c">#    nothing added to commit but untracked files present (use &amp;quot;git add&amp;quot; to track)</span>
<span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add dev-app"</span>
<span class="c"># =&gt; [main 3531233] Add dev-app</span>
<span class="c">#     3 files changed, 32 insertions(+)</span>
<span class="c">#     create mode 100644 Dockerfile</span>
<span class="c">#     create mode 100644 VERSION</span>
<span class="c">#     create mode 100644 server.py</span>
<span class="nv">$ </span>git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; Enumerating objects: 6, done.</span>
<span class="c">#    Counting objects: 100% (6/6), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (4/4), done.</span>
<span class="c">#    Writing objects: 100% (5/5), 900 bytes | 900.00 KiB/s, done.</span>
<span class="c">#    Total 5 (delta 0), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/dev-app.git</span>
<span class="c">#       5c906c3..3531233  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div></div>

<ul>
  <li>Gogs Repoì—ì„œ í™•ì¸
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_4.png" alt="img.png" /></li>
</ul>

<h4 id="ë„ì»¤-í—ˆë¸Œ--ì„¤ì •">ë„ì»¤ í—ˆë¸Œ  ì„¤ì •</h4>

<ul>
  <li>ë„ì»¤ í—ˆë¸Œì— ë¡œê·¸ì¸í•˜ì—¬ dev-appì´ë¼ëŠ” Repositoryë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ë„ì»¤í—ˆë¸Œ ì†Œê°œì™€ Repository ìƒì„±ì€ <a href="https://sweetlittlebird.github.io/posts/2024-12-08-CICD-Lite-Week1/#docker-hub-%EC%86%8C%EA%B0%9C">1ì£¼ì°¨ ë‚´ìš©</a>ì„ ì°¸ê³ í•˜ì„¸ìš”.</li>
  <li>ë°°í¬ë¥¼ í¸í•˜ê²Œ í•˜ê¸°ìœ„í•´ Tokenë„ ë°œê¸‰í•˜ì—¬ ì‚¬ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <ol>
      <li>ê³„ì • &gt; Account Settings &gt; Security í´ë¦­
  <img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_5.png" alt="img.png" class="image-center" /></li>
      <li>New Access Token í´ë¦­
        <ul>
          <li>Token Name : devops</li>
          <li>Expireation date : ë§Œë£Œì¼ì„ ì ì ˆíˆ ì„ íƒí•©ë‹ˆë‹¤.</li>
          <li>ê¶Œí•œì€ Read, Write, Deleteë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</li>
          <li>Create í´ë¦­í•˜ì—¬ í† í°ì„ ìƒì„±í•˜ê³ , ë°œê¸‰ëœ í† í°ì„ ë³µì‚¬í•˜ì—¬ ì•ˆì „í•œ ê³³ì— ì €ì¥í•©ë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_6.png" alt="img.png" class="image-center" />
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_7.png" alt="img_1.png" class="image-center" /></li>
          <li>ë°œê¸‰ëœ í† í° : <code class="language-plaintext highlighter-rouge">dckr_****</code></li>
        </ul>
      </li>
    </ol>
  </li>
</ul>

<hr />

<h3 id="jenkins-ci--k8s-kind">Jenkins CI + K8S (Kind)</h3>

<h4 id="kind-ì†Œê°œ-ë°-ì„¤ì¹˜">Kind ì†Œê°œ ë° ì„¤ì¹˜</h4>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_8.png" alt="img.png" class="w-20 image-center" /></p>

<ul>
  <li>KindëŠ” Kubernetes in Dockerì˜ ì¤„ì„ë§ë¡œ, ë¡œì»¬ í™˜ê²½ì—ì„œ ì‰½ê²Œ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.</li>
  <li>ì´ë¦„ì²˜ëŸ¼ Dockerë¥¼ ì´ìš©í•˜ì—¬ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ë©°, Dockerë¥¼ ì´ìš©í•˜ê¸° ë•Œë¬¸ì— ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>KindëŠ” HAë¥¼ í¬í•¨í•œ ë©€í‹°ë…¸ë“œë¥¼ ì§€ì›í•˜ì§€ë§Œ, í…ŒìŠ¤íŠ¸ì™€ ì‹¤í—˜ì ì¸ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ê¸°ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.</li>
  <li>KindëŠ” í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ê¸° ìœ„í•´ kubeadmì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li><a href="https://sweetlittlebird.github.io/posts/2024-09-07-KANS-Study-Week2/#kind-%EC%86%8C%EA%B0%9C-%EB%B0%8F-%EC%84%A4%EC%B9%98">Kind ì†Œê°œ ë° ì„¤ì¹˜</a>, <a href="https://kind.sigs.k8s.io/docs/user/quick-start/">Kind ê³µì‹ë¬¸ì„œ</a></li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_9.png" alt="img.png" class="image-center" />
<em class="image-caption">Kind êµ¬ì„±ë„</em></p>

<h5 id="kind-ë°-íˆ´-ì„¤ì¹˜">Kind ë° íˆ´ ì„¤ì¹˜</h5>

<ul>
  <li>í•„ìˆ˜ íˆ´ ì„¤ì¹˜</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install Kind</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kind
<span class="nv">$ </span>kind <span class="nt">--version</span>
<span class="c"># =&gt; kind version 0.26.0</span>

<span class="c"># Install kubectl</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubernetes-cli
<span class="nv">$ </span>kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Client Version: v1.31.0</span>
<span class="c">#    Kustomize Version: v5.4.2</span>
<span class="c">#    Kubecolor Version: v0.4.0</span>

<span class="c">## kubectl -&gt; k ë‹¨ì¶•í‚¤ ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"alias kubectl=kubecolor"</span> <span class="o">&gt;&gt;</span> ~/.zshrc

<span class="c"># Install Helm</span>
<span class="nv">$ </span>brew <span class="nb">install </span>helm
<span class="nv">$ </span>helm version
<span class="c"># =&gt; version.BuildInfo{Version:&amp;quot;v3.15.4&amp;quot;, GitCommit:&amp;quot;fa9efb07d9d8debbb4306d72af76a383895aa8c4&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;, GoVersion:&amp;quot;go1.22.6&amp;quot;}</span>
</code></pre></div></div>

<ul>
  <li>(ê¶Œì¥) ìœ ìš©í•œ íˆ´ ì„¤ì¹˜</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>brew <span class="nb">install </span>krew
<span class="nv">$ </span>brew <span class="nb">install </span>kube-ps1
<span class="nv">$ </span>brew <span class="nb">install </span>kubectx

<span class="c"># kubectl ì¶œë ¥ ì‹œ í•˜ì´ë¼ì´íŠ¸ ì²˜ë¦¬</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubecolor
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"alias kubectl=kubecolor"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"compdef kubecolor=kubectl"</span> <span class="o">&gt;&gt;</span> ~/.zshrc

<span class="c"># krew í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜</span>
<span class="nv">$ </span>kubectl krew <span class="nb">install </span>neat stren
</code></pre></div></div>

<h5 id="kind-ê¸°ë³¸-ì‚¬ìš©---í´ëŸ¬ìŠ¤í„°-ë°°í¬-ë°-í™•ì¸">Kind ê¸°ë³¸ ì‚¬ìš© - í´ëŸ¬ìŠ¤í„° ë°°í¬ ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ë°°í¬ ì „ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE             COMMAND                  CREATED        STATUS                 PORTS                                              NAMES</span>
<span class="c">#    110494b9ca48   gogs/gogs         &amp;quot;/app/gogs/docker/stâ€¦&amp;quot;   19 hours ago   Up 5 hours (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins   &amp;quot;/usr/bin/tini -- /uâ€¦&amp;quot;   19 hours ago   Up 4 hours             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>

<span class="c"># Create a cluster with kind</span>
<span class="nv">$ </span>kind create cluster
<span class="c"># =&gt; Creating cluster &amp;quot;kind&amp;quot; ...</span>
<span class="c">#     âœ“ Ensuring node image (kindest/node:v1.32.0) ğŸ–¼</span>
<span class="c">#     âœ“ Preparing nodes ğŸ“¦</span>
<span class="c">#     âœ“ Writing configuration ğŸ“œ</span>
<span class="c">#     âœ“ Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#     âœ“ Installing CNI ğŸ”Œ</span>
<span class="c">#     âœ“ Installing StorageClass ğŸ’¾</span>
<span class="c">#    Set kubectl context to &amp;quot;kind-kind&amp;quot;</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-kind</span>
<span class="c">#    </span>
<span class="c">#    Not sure what to do next? ğŸ˜…  Check out https://kind.sigs.k8s.io/docs/user/quick-start/</span>

<span class="c"># í´ëŸ¬ìŠ¤í„° ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kind get clusters
<span class="c"># =&gt; kind</span>
<span class="nv">$ </span>kind get nodes
<span class="c"># =&gt; kind-control-plane</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://127.0.0.1:64234</span>
<span class="c">#    CoreDNS is running at https://127.0.0.1:64234/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="c">#    </span>
<span class="c">#    To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>

<span class="c"># ë…¸ë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                 STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    kind-control-plane   Ready    control-plane   63s   v1.32.0   172.20.0.2    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.24</span>

<span class="c"># íŒŒë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-system          coredns-668d6bf9bc-8pqmk                     1/1     Running   0          67s</span>
<span class="c">#    kube-system          coredns-668d6bf9bc-9ngw2                     1/1     Running   0          67s</span>
<span class="c">#    kube-system          etcd-kind-control-plane                      1/1     Running   0          74s</span>
<span class="c">#    kube-system          kindnet-zlwz2                                1/1     Running   0          67s</span>
<span class="c">#    kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          74s</span>
<span class="c">#    kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          74s</span>
<span class="c">#    kube-system          kube-proxy-nbp2t                             1/1     Running   0          67s</span>
<span class="c">#    kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          74s</span>
<span class="c">#    local-path-storage   local-path-provisioner-58cc7856b6-wl6z8      1/1     Running   0          67s</span>
<span class="nv">$ </span>kubectl get componentstatuses
<span class="c"># =&gt; NAME                 STATUS    MESSAGE   ERROR</span>
<span class="c">#    controller-manager   Healthy   ok</span>
<span class="c">#    scheduler            Healthy   ok</span>
<span class="c">#    etcd-0               Healthy   ok</span>

<span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ (ì»¨í…Œì´ë„ˆ) ë…¸ë“œ 1ëŒ€ê°€ ì‹¤í–‰</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS                 PORTS                                              NAMES</span>
<span class="c">#    3d4063180754   kindest/node:v1.32.0   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   About a minute ago   Up About a minute      127.0.0.1:64234-&amp;gt;6443/tcp                          kind-control-plane</span>
<span class="c">#    110494b9ca48   gogs/gogs              &amp;quot;/app/gogs/docker/stâ€¦&amp;quot;   19 hours ago         Up 5 hours (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins        &amp;quot;/usr/bin/tini -- /uâ€¦&amp;quot;   19 hours ago         Up 4 hours             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>
<span class="nv">$ </span>docker images
<span class="c"># =&gt; REPOSITORY                                                                   TAG           IMAGE ID       CREATED         SIZE</span>
<span class="c">#    kindest/node                                                                 &amp;lt;none&amp;gt;        b5a8f8764a3e   7 days ago      1.05GB</span>

<span class="c"># kube config íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
<span class="c"># í˜¹ì€</span>
<span class="c"># $ cat $KUBECONFIG # KUBECONFIG ë³€ìˆ˜ ì§€ì • ì‚¬ìš© ì‹œ</span>

<span class="c"># nginx íŒŒë“œ ë°°í¬ ë° í™•ì¸ : ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œì¸ë° íŒŒë“œê°€ ë°°í¬ ë ê¹Œìš”?</span>
<span class="nv">$ </span>kubectl run nginx <span class="nt">--image</span><span class="o">=</span>nginx:alpine
<span class="c"># =&gt; pod/nginx created</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME    READY   STATUS    RESTARTS   AGE   IP           NODE                 NOMINATED NODE   READINESS GATES</span>
<span class="c">#    nginx   1/1     Running   0          10s   10.244.0.5   kind-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># ë…¸ë“œì— Taints ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe node | <span class="nb">grep </span>Taints
<span class="c"># =&gt; Taints:             &amp;lt;none&amp;gt;</span>

<span class="c"># í´ëŸ¬ìŠ¤í„° ì‚­ì œ</span>
<span class="nv">$ </span>kind delete cluster
<span class="c"># =&gt; Deleting cluster &amp;quot;kind&amp;quot; ...</span>
<span class="c">#    Deleted nodes: [&amp;quot;kind-control-plane&amp;quot;]</span>

<span class="c"># kube config ì‚­ì œ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
<span class="c"># í˜¹ì€</span>
<span class="c"># $ cat $KUBECONFIG # KUBECONFIG ë³€ìˆ˜ ì§€ì • ì‚¬ìš© ì‹œ</span>
</code></pre></div></div>

<h4 id="kindë¡œ-kubernetes-í´ëŸ¬ìŠ¤í„°-ë°°í¬---3ë…¸ë“œ">Kindë¡œ Kubernetes í´ëŸ¬ìŠ¤í„° ë°°í¬ - 3ë…¸ë“œ</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ë°°í¬ ì „ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE             COMMAND                  CREATED        STATUS                 PORTS                                              NAMES</span>
<span class="c">#    110494b9ca48   gogs/gogs         &amp;quot;/app/gogs/docker/stâ€¦&amp;quot;   19 hours ago   Up 5 hours (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins   &amp;quot;/usr/bin/tini -- /uâ€¦&amp;quot;   19 hours ago   Up 4 hours             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>

<span class="c"># ë°©ì•ˆ1 : í™˜ê²½ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$PWD</span>/kubeconfig

<span class="c"># Create a cluster with kind</span>
<span class="c"># $ MyIP=&lt;ê°ì ìì‹ ì˜ PC IP&gt;</span>
<span class="nv">$ MyIP</span><span class="o">=</span>10.0.4.3

<span class="nv">$ </span><span class="nb">cd</span> ..
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> kind-3node.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
networking:
  apiServerAddress: "</span><span class="nv">$MyIP</span><span class="sh">"
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  - containerPort: 30003
    hostPort: 30003
- role: worker
- role: worker
</span><span class="no">EOF
</span><span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-3node.yaml <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.30.6
<span class="c"># =&gt; Creating cluster &amp;quot;myk8s&amp;quot; ...</span>
<span class="c">#     âœ“ Ensuring node image (kindest/node:v1.30.6) ğŸ–¼</span>
<span class="c">#     âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦</span>
<span class="c">#     âœ“ Writing configuration ğŸ“œ</span>
<span class="c">#     âœ“ Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#     âœ“ Installing CNI ğŸ”Œ</span>
<span class="c">#     âœ“ Installing StorageClass ğŸ’¾</span>
<span class="c">#     âœ“ Joining worker nodes ğŸšœ</span>
<span class="c">#    Set kubectl context to &amp;quot;kind-myk8s&amp;quot;</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-myk8s</span>
<span class="c">#    </span>
<span class="c">#    Thanks for using kind! ğŸ˜Š</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kind get nodes <span class="nt">--name</span> myk8s
<span class="c"># =&gt; myk8s-control-plane</span>
<span class="c">#    myk8s-worker</span>
<span class="c">#    myk8s-worker2</span>
<span class="nv">$ </span>kubens default
<span class="c"># =&gt; Context &amp;quot;kind-myk8s&amp;quot; modified.</span>
<span class="c">#    Active namespace is &amp;quot;default&amp;quot;.</span>

<span class="c"># kind ëŠ” ë³„ë„ ë„ì»¤ ë„¤íŠ¸ì›Œí¬ ìƒì„± í›„ ì‚¬ìš© : ê¸°ë³¸ê°’ 172.18.0.0/16</span>
<span class="nv">$ </span>docker network <span class="nb">ls</span>
<span class="c"># =&gt; NETWORK ID     NAME                     DRIVER    SCOPE</span>
<span class="c">#    8204a0851463   host                     host      local</span>
<span class="c">#    3bbcc6aa8f38   kind                     bridge    local</span>
<span class="nv">$ </span>docker inspect kind | jq
<span class="c"># =&gt; [</span>
<span class="c">#      {</span>
<span class="c">#        &amp;quot;Name&amp;quot;: &amp;quot;kind&amp;quot;,</span>
<span class="c">#        &amp;quot;Id&amp;quot;: &amp;quot;3bbcc6aa8f388f86f02478f41de1e4dd917e5812b6cf6257972e4af0bedf5021&amp;quot;,</span>
<span class="c">#        &amp;quot;Created&amp;quot;: &amp;quot;2024-10-01T11:37:09.195259833Z&amp;quot;,</span>
<span class="c">#        &amp;quot;Scope&amp;quot;: &amp;quot;local&amp;quot;,</span>
<span class="c">#        &amp;quot;Driver&amp;quot;: &amp;quot;bridge&amp;quot;,</span>
<span class="c">#        &amp;quot;EnableIPv6&amp;quot;: true,</span>
<span class="c">#        &amp;quot;IPAM&amp;quot;: {</span>
<span class="c">#          &amp;quot;Driver&amp;quot;: &amp;quot;default&amp;quot;,</span>
<span class="c">#          &amp;quot;Options&amp;quot;: {},</span>
<span class="c">#          &amp;quot;Config&amp;quot;: [</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;Subnet&amp;quot;: &amp;quot;172.20.0.0/16&amp;quot;,</span>
<span class="c">#              &amp;quot;Gateway&amp;quot;: &amp;quot;172.20.0.1&amp;quot;</span>
<span class="c">#            }</span>
<span class="c">#          ]</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;Internal&amp;quot;: false,</span>
<span class="c">#        &amp;quot;Attachable&amp;quot;: false,</span>
<span class="c">#        &amp;quot;Ingress&amp;quot;: false,</span>
<span class="c">#        &amp;quot;ConfigFrom&amp;quot;: {</span>
<span class="c">#          &amp;quot;Network&amp;quot;: &amp;quot;&amp;quot;</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;ConfigOnly&amp;quot;: false,</span>
<span class="c">#        &amp;quot;Containers&amp;quot;: {</span>
<span class="c">#          &amp;quot;35739bf3542771236d47fd4dcb27da13814184a3de57c7203904f66ecbab4710&amp;quot;: {</span>
<span class="c">#            &amp;quot;Name&amp;quot;: &amp;quot;myk8s-worker&amp;quot;,</span>
<span class="c">#            &amp;quot;EndpointID&amp;quot;: &amp;quot;5de8e9e48e611f2c4cb908649f5dcdf63c82d624b85f85a6573ced7cbd454554&amp;quot;,</span>
<span class="c">#            &amp;quot;MacAddress&amp;quot;: &amp;quot;02:42:ac:14:00:03&amp;quot;,</span>
<span class="c">#            &amp;quot;IPv4Address&amp;quot;: &amp;quot;172.20.0.3/16&amp;quot;,</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;48023a25d056141b00747f14ff52da2b46c46c0d0edbeb714dedd1f3c71360e4&amp;quot;: {</span>
<span class="c">#            &amp;quot;Name&amp;quot;: &amp;quot;myk8s-control-plane&amp;quot;,</span>
<span class="c">#            &amp;quot;EndpointID&amp;quot;: &amp;quot;9d51136474882d6ca7a4aabe7291e26527f44c3b88c7191b654506fdf1d65c84&amp;quot;,</span>
<span class="c">#            &amp;quot;MacAddress&amp;quot;: &amp;quot;02:42:ac:14:00:04&amp;quot;,</span>
<span class="c">#            &amp;quot;IPv4Address&amp;quot;: &amp;quot;172.20.0.4/16&amp;quot;,</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;fefdfb00a2228f646119483a24503e1dc8bd74292e462fc9fa2ef3446004b4af&amp;quot;: {</span>
<span class="c">#            &amp;quot;Name&amp;quot;: &amp;quot;myk8s-worker2&amp;quot;,</span>
<span class="c">#            &amp;quot;EndpointID&amp;quot;: &amp;quot;c669ce7940abb8722b7ac41cc533c260838d31881c915a49147829e9d28a746c&amp;quot;,</span>
<span class="c">#            &amp;quot;MacAddress&amp;quot;: &amp;quot;02:42:ac:14:00:02&amp;quot;,</span>
<span class="c">#            &amp;quot;IPv4Address&amp;quot;: &amp;quot;172.20.0.2/16&amp;quot;,</span>
<span class="c">#          }</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;Options&amp;quot;: {</span>
<span class="c">#          &amp;quot;com.docker.network.bridge.enable_ip_masquerade&amp;quot;: &amp;quot;true&amp;quot;,</span>
<span class="c">#          &amp;quot;com.docker.network.driver.mtu&amp;quot;: &amp;quot;1500&amp;quot;</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;Labels&amp;quot;: {}</span>
<span class="c">#      }</span>
<span class="c">#    ]</span>

<span class="c"># k8s api ì£¼ì†Œ í™•ì¸ : ì–´ë–»ê²Œ ë¡œì»¬ì—ì„œ ì ‘ì†ì´ ë˜ëŠ” ê±¸ê¹Œ?</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://10.0.4.3:51235</span>
<span class="c">#    CoreDNS is running at https://10.0.4.3:51235/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="c">#    </span>
<span class="c">#    To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ dockerê°€ 10.0.4.3:51235 ì ‘ì†ì‹œ kind ì»¨í…Œì´ë„ˆì˜ 6443 í¬íŠ¸ë¡œ í¬ì›Œë”© í•´ì£¼ê³ &lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ~/.kube/config ì—ì„œ 10.0.4.3:51235ë¥¼ apiserver ì£¼ì†Œë¡œ ì§€ì •í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë…¸ë“œ ì •ë³´ í™•ì¸ : CRI ëŠ” containerd ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   3m8s    v1.30.6   172.20.0.4    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker          Ready    &amp;lt;none&amp;gt;          2m48s   v1.30.6   172.20.0.3    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker2         Ready    &amp;lt;none&amp;gt;          2m48s   v1.30.6   172.20.0.2    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>

<span class="c"># íŒŒë“œ ì •ë³´ í™•ì¸ : CNI ëŠ” kindnet ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-o</span> wide
<span class="c"># =&gt; NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE     IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system          coredns-55cb58b774-m7h2c                      1/1     Running   0          3m7s    10.244.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          coredns-55cb58b774-z88v5                      1/1     Running   0          3m7s    10.244.0.3   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          etcd-myk8s-control-plane                      1/1     Running   0          3m22s   172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kindnet-mp6mj                                 1/1     Running   0          3m7s    172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kindnet-q2k9w                                 1/1     Running   0          3m4s    172.20.0.2   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kindnet-t99c4                                 1/1     Running   0          3m4s    172.20.0.3   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-apiserver-myk8s-control-plane            1/1     Running   0          3m21s   172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-controller-manager-myk8s-control-plane   1/1     Running   0          3m21s   172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-proxy-f85sx                              1/1     Running   0          3m7s    172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-proxy-ltckc                              1/1     Running   0          3m4s    172.20.0.2   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-proxy-njr42                              1/1     Running   0          3m4s    172.20.0.3   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-scheduler-myk8s-control-plane            1/1     Running   0          3m21s   172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    local-path-storage   local-path-provisioner-7d4d9bdcc5-jhl5h       1/1     Running   0          3m7s    10.244.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸ &gt;&gt; ë„ì»¤ ì»¨í…Œì´ë„ˆì—ì„œ ë°°ìš´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ ë‹¤ë¦…ë‹ˆë‹¤!</span>
<span class="nv">$ </span>kubectl get namespaces
<span class="c"># =&gt; NAME                 STATUS   AGE</span>
<span class="c">#    default              Active   3m42s</span>
<span class="c">#    kube-node-lease      Active   3m42s</span>
<span class="c">#    kube-public          Active   3m42s</span>
<span class="c">#    kube-system          Active   3m42s</span>
<span class="c">#    local-path-storage   Active   3m35s</span>

<span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸/ì›Œì»¤ ë…¸ë“œ(ì»¨í…Œì´ë„ˆ) í™•ì¸ : ë„ì»¤ ì»¨í…Œì´ë„ˆ ì´ë¦„ì€ myk8s-control-plane , myk8s-worker/worker-2 ì„ì„ í™•ì¸</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS                 PORTS                                                            NAMES</span>
<span class="c">#    35739bf35427   kindest/node:v1.30.6   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   4 minutes ago   Up 4 minutes                                                                            myk8s-worker</span>
<span class="c">#    48023a25d056   kindest/node:v1.30.6   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   4 minutes ago   Up 4 minutes           0.0.0.0:30000-30003-&amp;gt;30000-30003/tcp, 10.0.4.3:51235-&amp;gt;6443/tcp   myk8s-control-plane</span>
<span class="c">#    fefdfb00a222   kindest/node:v1.30.6   &amp;quot;/usr/local/bin/entrâ€¦&amp;quot;   4 minutes ago   Up 4 minutes                                                                            myk8s-worker2</span>
<span class="nv">$ </span>docker images

<span class="c"># ë””ë²„ê·¸ìš© ë‚´ìš© ì¶œë ¥ì— ~/.kube/config ê¶Œí•œ ì¸ì¦ ë¡œë“œ</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-v6</span>
<span class="c"># =&gt; I1221 20:19:47.265879   56969 loader.go:395] Config loaded from file:  /Users/anonym/Documents/GitHub/cicd-lite/w3/1/dev-app/kubeconfig</span>
<span class="c">#    I1221 20:19:47.354543   56969 round_trippers.go:553] GET https://10.0.4.3:51235/api/v1/namespaces/default/pods?limit=500 200 OK in 79 milliseconds</span>
<span class="c">#    No resources found in default namespace.</span>

<span class="c"># kube config íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$KUBECONFIG</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> <span class="nv">$KUBECONFIG</span>
<span class="c"># =&gt; .rw------- anonym staff 5.5 KB Sat Oct 01 20:16:21 2024 ï€– /Users/user/Documents/GitHub/cicd-lite/w3/1/dev-app/kubeconfig</span>
</code></pre></div></div>

<h5 id="kube-ops-view-ì„¤ì¹˜">kube-ops-view ì„¤ì¹˜</h5>

<ul>
  <li>kube-ops-viewëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœë¥¼ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kube-ops-view</span>
<span class="c"># helm show values geek-cookbook/kube-ops-view</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>NodePort,service.main.ports.http.nodePort<span class="o">=</span>30001 <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep <span class="nt">-n</span> kube-system <span class="nt">-l</span> app.kubernetes.io/instance<span class="o">=</span>kube-ops-view
<span class="c"># =&gt; NAME                            READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/kube-ops-view   1/1     1            1           25s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                 READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/kube-ops-view-796947d6dc-6b6xx   1/1     Running   0          25s</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/kube-ops-view   NodePort   10.96.18.59   &amp;lt;none&amp;gt;        8080:30001/TCP   25s</span>
<span class="c">#    </span>
<span class="c">#    NAME                      ENDPOINTS         AGE</span>
<span class="c">#    endpoints/kube-ops-view   10.244.1.2:8080   25s</span>

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 , 2 ë°°ìœ¨)</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:30001/#scale=1.5"</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:30001/#scale=2"</span>
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_10.png" alt="img.png" class="w-80 image-center" /></p>

<h5 id="í´ëŸ¬ìŠ¤í„°-ì‚­ì œ">í´ëŸ¬ìŠ¤í„° ì‚­ì œ</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í´ëŸ¬ìŠ¤í„° ì‚­ì œ</span>
<span class="nv">$ </span>kind delete cluster <span class="nt">--name</span> myk8s
<span class="c"># =&gt; Deleting cluster &amp;quot;myk8s&amp;quot; ...</span>
<span class="c">#    Deleted nodes: [&amp;quot;myk8s-worker&amp;quot; &amp;quot;myk8s-control-plane&amp;quot; &amp;quot;myk8s-worker2&amp;quot;]</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE             COMMAND                  CREATED        STATUS                 PORTS                                              NAMES</span>
<span class="c">#    110494b9ca48   gogs/gogs         &amp;quot;/app/gogs/docker/stâ€¦&amp;quot;   19 hours ago   Up 6 hours (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins   &amp;quot;/usr/bin/tini -- /uâ€¦&amp;quot;   19 hours ago   Up 5 hours             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$KUBECONFIG</span>
<span class="nv">$ </span><span class="nb">unset </span>KUBECONFIG
</code></pre></div></div>

<h4 id="jenkins-ì„¤ì •--plugin-ì„¤ì¹˜-ìê²©ì¦ëª…-ì„¤ì •">Jenkins ì„¤ì • : Plugin ì„¤ì¹˜, ìê²©ì¦ëª… ì„¤ì •</h4>

<ul>
  <li>Jenkins Plugin ì„¤ì¹˜ : Dashboard &gt; Manage Jenkins &gt; Plugins &gt; Available plugins íƒ­ì—ì„œ ì„¤ì¹˜
    <ul>
      <li><strong>Pipeline Stage View</strong> - <a href="https://plugins.jenkins.io/pipeline-stage-view/">Docs</a></li>
      <li><strong>Docker Pipeline</strong> : building, testing, and using Docker images from Jenkins Pipeline - <a href="https://plugins.jenkins.io/docker-workflow/">Docs</a></li>
      <li><strong>Gogs</strong> : Webhook Plugin - <a href="https://plugins.jenkins.io/gogs-webhook/">Docs</a>
        <ul>
          <li>ì˜ˆì‹œ : <code class="language-plaintext highlighter-rouge">http(s)://&lt;&lt; jenkins-server &gt;&gt;/gogs-webhook/?job=&lt;&lt;jobname&gt;&gt;</code></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ìê²©ì¦ëª… ì„¤ì • : Dashboard &gt; Manage Jenkins &gt; Credentials &gt; Global &gt; Add Credentials ì—ì„œ ì¶”ê°€
    <ol>
      <li>Gogs Repo ìê²©ì¦ëª… ì„¤ì • : <strong>gogs-crd</strong>
        <ul>
          <li>Kind : Username with password</li>
          <li>Username : <code class="language-plaintext highlighter-rouge">devops</code></li>
          <li>Password : <code class="language-plaintext highlighter-rouge">&lt;Gogs í† í°&gt;</code></li>
          <li>ID : <code class="language-plaintext highlighter-rouge">gogs-crd</code></li>
        </ul>
      </li>
      <li>ë„ì»¤ í—ˆë¸Œ ìê²©ì¦ëª… ì„¤ì • : <strong>dockerhub-crd</strong>
        <ul>
          <li>Kind : Username with password</li>
          <li>Username : <code class="language-plaintext highlighter-rouge">&lt;ë„ì»¤ ê³„ì •ëª…&gt;</code></li>
          <li>Password : <code class="language-plaintext highlighter-rouge">&lt;ë„ì»¤ ê³„ì • ì•”í˜¸ í˜¹ì€ í† í°&gt;</code></li>
          <li>ID : <code class="language-plaintext highlighter-rouge">dockerhub-crd</code></li>
        </ul>
      </li>
      <li>k8s(kind) ìê²©ì¦ëª… ì„¤ì • : <strong>k8s-crd</strong>
        <ul>
          <li>Kind : <code class="language-plaintext highlighter-rouge">Secret file</code></li>
          <li>File : <code class="language-plaintext highlighter-rouge">&lt;kubeconfig íŒŒì¼ ì—…ë¡œë“œ&gt;</code></li>
          <li>ID : <code class="language-plaintext highlighter-rouge">k8s-crd</code></li>
        </ul>
      </li>
    </ol>
  </li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_11.png" alt="img.png" class="image-center" />
<em class="image-caption">Jenkins ìê²©ì¦ëª… ì„¤ì • ê²°ê³¼</em></p>

<h5 id="jenkins-item-ìƒì„±-pipeline">Jenkins item ìƒì„± (Pipeline)</h5>

<ul>
  <li>ê°„ë‹¨í•œ Pipeline ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•˜ì—¬ gogsì™€ ë„ì»¤í—ˆë¸Œì˜ ìê²©ì¦ëª…ì´ ì˜ ì—°ë™ë¨ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ì•„ë˜ì˜ Pipeline ìŠ¤í¬ë¦½íŠ¸ë¥¼ <code class="language-plaintext highlighter-rouge">pipeline-ci</code>ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">DOCKER_IMAGE</span> <span class="o">=</span> <span class="s1">'&lt;ìì‹ ì˜ ë„ì»¤ í—ˆë¸Œ ê³„ì •&gt;/dev-app'</span> <span class="c1">// Docker ì´ë¯¸ì§€ ì´ë¦„</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Checkout'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                 <span class="n">git</span> <span class="nl">branch:</span> <span class="s1">'main'</span><span class="o">,</span>
                 <span class="nl">url:</span> <span class="s1">'http://&lt;PCì˜ IP&gt;:3000/devops/dev-app.git'</span><span class="o">,</span>  <span class="c1">// Gitì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ</span>
                 <span class="nl">credentialsId:</span> <span class="s1">'gogs-crd'</span>  <span class="c1">// Credentials ID</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Read VERSION'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="c1">// VERSION íŒŒì¼ ì½ê¸°</span>
                    <span class="kt">def</span> <span class="n">version</span> <span class="o">=</span> <span class="n">readFile</span><span class="o">(</span><span class="s1">'VERSION'</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span>
                    <span class="n">echo</span> <span class="s2">"Version found: ${version}"</span>
                    <span class="c1">// í™˜ê²½ ë³€ìˆ˜ ì„¤ì •</span>
                    <span class="n">env</span><span class="o">.</span><span class="na">DOCKER_TAG</span> <span class="o">=</span> <span class="n">version</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Docker Build and Push'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s1">'https://index.docker.io/v1/'</span><span class="o">,</span> <span class="s1">'dockerhub-crd'</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// DOCKER_TAG ì‚¬ìš©</span>
                        <span class="kt">def</span> <span class="n">appImage</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="s2">"${DOCKER_IMAGE}:${DOCKER_TAG}"</span><span class="o">)</span>
                        <span class="n">appImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
                        <span class="n">appImage</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="s2">"latest"</span><span class="o">)</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">post</span> <span class="o">{</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s2">"Docker image ${DOCKER_IMAGE}:${DOCKER_TAG} has been built and pushed successfully!"</span>
        <span class="o">}</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s2">"Pipeline failed. Please check the logs."</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ì§€ê¸ˆ ë¹Œë“œ =&gt; ì½˜ì†” Output í™•ì¸
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_12.png" alt="img.png" class="image-center" /></li>
  <li>ë„ì»¤ í—ˆë¸Œ í™•ì¸
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_13.png" alt="img.png" class="image-center" />
    <ul>
      <li>ìê²©ì¦ëª…ë“¤ì´ ì˜ ì—°ë™ë˜ì–´, íŒŒì´í”„ë¼ì¸ì—ì„œ ì§€ì •í•œê²ƒ ì²˜ëŸ¼ ë²„ì „ëª…ì˜ íƒœê·¸(0.0.1)ê³¼ latest íƒœê·¸ê°€ ì˜ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</li>
    </ul>
  </li>
</ul>

<h4 id="kubernetes-í´ëŸ¬ìŠ¤í„°ì—-ì‘ìš©í”„ë¡œê·¸ë¨-ë°°í¬í•˜ê¸°">Kubernetes í´ëŸ¬ìŠ¤í„°ì— ì‘ìš©í”„ë¡œê·¸ë¨ ë°°í¬í•˜ê¸°</h4>

<ul>
  <li>Jenkins Pipelineì„ í†µí•´ Kubernetes í´ëŸ¬ìŠ¤í„°ì— ì‘ìš©í”„ë¡œê·¸ë¨ì„ ë°°í¬í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ë¨¼ì € Kubernetes í´ëŸ¬ìŠ¤í„°ì— ë°°í¬í• ë•Œ ì‚¬ìš©í•˜ëŠ” deploymentì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h5 id="deployment-ì†Œê°œ">Deployment ì†Œê°œ</h5>

<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<div class="mermaid">
  graph TD
      subgraph Deployment
          subgraph ReplicaSet
              direction TB
              subgraph Pod[Pod]
                  direction LR
                  Container1(Container)
                  Container2(Container)
              end
              subgraph Pod2[Pod]
                  direction LR
                  Container3(Container)
                  Container4(Container)
              end
              subgraph Pod3[Pod]
                  direction LR
                  Container5(Container)
              end
          end
      end
  classDef Pod fill:#fff,stroke:#ccc,stroke-width:2px;
  classDef ReplicaSet fill:#fff,stroke:#ccc,stroke-width:2px;
  classDef Deployment fill:#fff,stroke:#ccc,stroke-width:2px;
  class Pod,Pod2,Pod3 Pod;
  class Deployment Deployment;
  </div>
<p><em class="image-caption">Kubernetes ë°°í¬ êµ¬ì¡°</em></p>

<ul>
  <li>Kubernetesë¥¼ ë°°í¬í•˜ëŠ” ìµœì†Œë‹¨ìœ„ëŠ” <strong>Pod</strong>ì´ë©°, <strong>í•˜ë‚˜ ì´ìƒì˜ ì»¨í…Œì´ë„ˆë¡œ êµ¬ì„±</strong>ë©ë‹ˆë‹¤.</li>
  <li>PodëŠ” <strong>ReplicaSet</strong>ì— ì˜í•´ ê´€ë¦¬ë˜ë©°, ReplicaSetì€ <strong>Podì˜ ìˆ˜ë¥¼ ìœ ì§€í•˜ë„ë¡ ê´€ë¦¬</strong>í•©ë‹ˆë‹¤.</li>
  <li>
    <p><strong>Deployment</strong>ëŠ” <strong>ReplicaSetì„ ê´€ë¦¬í•˜ë©°, Podì˜ ë°°í¬ ë° ì—…ë°ì´íŠ¸ë¥¼ ê´€ë¦¬</strong>í•©ë‹ˆë‹¤.</p>
  </li>
  <li>KubernetesëŠ” manifestë¼ëŠ” yaml íŒŒì¼ì„ í†µí•´ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•˜ê³ , ì„ ì–¸í˜• ë°©ì‹ìœ¼ë¡œ ì›í•˜ëŠ” ìƒíƒœë¥¼ ì„ ì–¸ì‹œ í•´ë‹¹ ìƒíƒœë¥¼ ì¶©ì¡±ì‹œí‚¤ê¸° ìœ„í•´ í´ëŸ¬ìŠ¤í„°ë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.</li>
  <li>ì•„ë˜ëŠ” kubernetesì˜ manifestì˜ êµ¬ì¡°ì…ë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: ...   <span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë¦¬ì†ŒìŠ¤ë¥¼ ë§Œë“œëŠ”ë° ì‚¬ìš©í•  Kubernetes API ë²„ì „&lt;/span&gt;</span>
kind: ...         <span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë§Œë“¤ê³ ì í•˜ëŠ” ë¦¬ì†ŒìŠ¤ì˜ ì¢…ë¥˜&lt;/span&gt;</span>
metadata:
    ...           <span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë¦¬ì†ŒìŠ¤ë¥¼ ì‹ë³„í•˜ëŠ” ê³ ìœ  ë°ì´í„°ì™€ ìƒíƒœì™€ ê´€ë ¨ì—†ëŠ” ë©”íƒ€ë°ì´í„°&lt;/span&gt;</span>
spec:
    ...           <span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë¦¬ì†ŒìŠ¤ì˜ ì›í•˜ëŠ” ìƒíƒœë¥¼ ì •ì˜&lt;/span&gt;</span>
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="deployment-ë°°í¬-ì‹¤ìŠµ">Deployment ë°°í¬ ì‹¤ìŠµ</h5>

<ul>
  <li>
    <p>ì•ì„œ ì‘ì„±í•œ Jenkins Pipelineì„ í†µí•´ ë¹Œë“œëœ ë„ì»¤ ì´ë¯¸ì§€ë¥¼ Kubernetes í´ëŸ¬ìŠ¤í„°ì— ì‘ìš©í”„ë¡œê·¸ë¨ì„ ë°°í¬í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë””í”Œë¡œì´ë¨¼íŠ¸ ì˜¤ë¸Œì íŠ¸ ë°°í¬ : ë¦¬í”Œë¦¬ì¹´(íŒŒë“œ 2ê°œ), ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ &gt;&gt; ì•„ë˜ ë„ì»¤ ê³„ì • ë¶€ë¶„ë§Œ ë³€ê²½í•´ì„œ ë°°í¬í•´ë³´ì</span>
<span class="c">#$ DHUSER=&lt;ë„ì»¤ í—ˆë¸Œ ê³„ì •ëª…&gt;</span>
<span class="nv">$ DHUSER</span><span class="o">=</span>sweetlittlebird
  
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: timeserver
spec:
  replicas: 2
  selector:
    matchLabels:
      pod: timeserver-pod
  template:
    metadata:
      labels:
        pod: timeserver-pod
    spec:
      containers:
      - name: timeserver-container
        image: docker.io/</span><span class="nv">$DHUSER</span><span class="sh">/dev-app:0.0.1
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/timeserver created</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get deploy,pod <span class="nt">-o</span> wide
  
<span class="c"># ë°°í¬ ìƒíƒœ í™•ì¸ : kube-ops-view ì›¹ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,pod <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                         READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS             IMAGES                                    SELECTOR</span>
<span class="c">#    deployment.apps/timeserver   0/2     2            0           45s   timeserver-container   docker.io/sweetlittlebird/dev-app:0.0.1   pod=timeserver-pod</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS             RESTARTS   AGE   IP           NODE            NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/timeserver-5b5ff6d859-s282p   0/1     &lt;span style="color: red;"&gt;ImagePullBackOff&lt;/span&gt;   0          45s   10.244.2.2   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/timeserver-5b5ff6d859-v7gs7   0/1     &lt;span style="color: red;"&gt;ImagePullBackOff&lt;/span&gt;   0          45s   10.244.1.2   myk8s-worker    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë°°í¬ìƒíƒœê°€ ImagePullBackOffë¡œ ë°°í¬ê°€ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
  
<span class="nv">$ </span>kubectl describe pod
<span class="c"># =&gt; Name:             timeserver-5b5ff6d859-s282p</span>
<span class="c">#    ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type     Reason     Age                    From               Message</span>
<span class="c">#      ----     ------     ----                   ----               -------</span>
<span class="c">#      Normal   Scheduled  5m38s                  default-scheduler  Successfully assigned default/timeserver-5b5ff6d859-s282p to myk8s-worker2</span>
<span class="c">#      Normal   Pulling    4m4s (x4 over 5m37s)   kubelet            Pulling image &amp;quot;docker.io/sweetlittlebird/dev-app:0.0.1&amp;quot;</span>
<span class="c">#      Warning  Failed     4m3s (x4 over 5m35s)   kubelet            Failed to pull image &amp;quot;docker.io/sweetlittlebird/dev-app:0.0.1&amp;quot;: failed to pull and unpack image &amp;quot;docker.io/sweetlittlebird/dev-app:0.0.1&amp;quot;: failed to resolve reference &amp;quot;docker.io/sweetlittlebird/dev-app:0.0.1&amp;quot;: pull access denied, repository does not exist or may require authorization: server message: insufficient_scope: authorization failed</span>
<span class="c">#      Warning  Failed     4m3s (x4 over 5m35s)   kubelet            Error: ErrImagePull</span>
<span class="c">#      Warning  Failed     3m48s (x6 over 5m35s)  kubelet            Error: ImagePullBackOff</span>
<span class="c">#      Normal   BackOff    22s (x20 over 5m35s)   kubelet            Back-off pulling image &amp;quot;docker.io/sweetlittlebird/dev-app:0.0.1&amp;quot;```</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_14.png" alt="img.png" class="image-center" />
<em class="image-caption">Kube-Ops-Viewë¥¼ í†µí•´ ì‚´í´ë³¸ Kubernetes í´ëŸ¬ìŠ¤í„°ì— timeserver ë°°í¬ ì‹¤íŒ¨</em></p>

<ul>
  <li>ìœ„ì™€ ê°™ì´ Image pull errorê°€ ë‚˜ë©´ì„œ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">kubectl describe pod</code>ë¥¼ í†µí•´ í™•ì¸í•œ ê²°ê³¼, <code class="language-plaintext highlighter-rouge">pull access denied, repository does not exist or may require authorization: server message: insufficient_scope: authorization failed</code>ì™€ ê°™ì€ ë©”ì‹œì§€ê°€ ë‚˜íƒ€ë‚˜ê³ 
ì´ëŠ” Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ ë„ì»¤ ì´ë¯¸ì§€ë¥¼ pullí•  ë•Œ ë„ì»¤ í—ˆë¸Œì— ì¸ì¦ í† í°ì´ ë˜ì–´ìˆì§€ ì•Šì•„ì„œ ë°œìƒí•œ ë¬¸ì œë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
  <li>ë„ì»¤ í—ˆë¸Œì˜ ì¸ì¦í† í°ì„ ë“±ë¡í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="k8sì—-docker-hub-ì¸ì¦í† í°-ë“±ë¡-í›„-ë‹¤ì‹œ-ë°°í¬">K8Sì— Docker Hub ì¸ì¦í† í° ë“±ë¡ í›„ ë‹¤ì‹œ ë°°í¬</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s secret : ë„ì»¤ ìê²©ì¦ëª… ì„¤ì •</span>
 
<span class="nv">$ </span>kubectl get secret <span class="nt">-A</span>  <span class="c"># ê¸°ì¡´ ì‹œí¬ë¦¿ í™•ì¸</span>
<span class="c"># =&gt; NAMESPACE     NAME                                  TYPE                            DATA   AGE</span>
<span class="c">#    kube-system   bootstrap-token-abcdef                bootstrap.kubernetes.io/token   6      164m</span>
<span class="c">#    kube-system   sh.helm.release.v1.kube-ops-view.v1   helm.sh/release.v1              1      25m</span>

<span class="c">#$ DHUSER=&lt;ë„ì»¤ í—ˆë¸Œ ê³„ì •&gt;</span>
<span class="c">#$ DHPASS=&lt;ë„ì»¤ í—ˆë¸Œ ì•”í˜¸ í˜¹ì€ í† í°&gt;</span>

<span class="nv">$ DHUSER</span><span class="o">=</span>sweetlittlebird
<span class="nv">$ DHPASS</span><span class="o">=</span>dckr_<span class="k">****</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$DHUSER</span> <span class="nv">$DHPASS</span>
<span class="c"># =&gt; sweetlittlebird dckr_****</span>

<span class="c"># ë„ì»¤ í—ˆë¸Œ ì‹œí¬ë¦¿ ìƒì„±</span>
<span class="nv">$ </span>kubectl create secret docker-registry dockerhub-secret <span class="se">\</span>
  <span class="nt">--docker-server</span><span class="o">=</span>https://index.docker.io/v1/ <span class="se">\</span>
  <span class="nt">--docker-username</span><span class="o">=</span><span class="nv">$DHUSER</span> <span class="se">\</span>
  <span class="nt">--docker-password</span><span class="o">=</span><span class="nv">$DHPASS</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get secret
<span class="c"># =&gt; NAME               TYPE                             DATA   AGE</span>
<span class="c">#    dockerhub-secret   kubernetes.io/dockerconfigjson   1      8s</span>
<span class="nv">$ </span>kubectl describe secret
<span class="c"># =&gt; Name:         dockerhub-secret</span>
<span class="c">#    Namespace:    default</span>
<span class="c">#    Labels:       &amp;lt;none&amp;gt;</span>
<span class="c">#    Annotations:  &amp;lt;none&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    Type:  kubernetes.io/dockerconfigjson</span>
<span class="c">#    </span>
<span class="c">#    Data</span>
<span class="c">#    ====</span>
<span class="c">#    .dockerconfigjson:  205 bytes</span>
<span class="nv">$ </span>kubectl get secrets <span class="nt">-o</span> yaml | kubectl neat  <span class="c"># base64 ì¸ì½”ë”© í™•ì¸</span>
<span class="c"># =&gt; apiVersion: v1</span>
<span class="c">#    items:</span>
<span class="c">#    - apiVersion: v1</span>
<span class="c">#      data:</span>
<span class="c">#        .dockerconfigjson: eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJzZWNyZXRsaXR0bGViaXJkIiwicGFzc3dvcmQiOiJkY2tyX3BhdF9QdWNpVTRIMFBPZVpYWGNvV1VNd1ozTVpZVEUiLCJhdXRoIjoiYzJWamNtVjBiR2wwZEd4bFltbHlaRHBrWTJ0eVgzQmhkRjlRZFdOcFZUUklNRkJQWlZwWVdHTnZWMVZOZDFvelRWcFpWRVU9In19fQ==</span>
<span class="c">#      kind: Secret</span>
<span class="c">#      metadata:</span>
<span class="c">#        name: dockerhub-secret</span>
<span class="c">#        namespace: default</span>
<span class="c">#      type: kubernetes.io/dockerconfigjson</span>
<span class="c">#    kind: List</span>
<span class="c">#    metadata: {}</span>

<span class="nv">$ SECRET</span><span class="o">=</span><span class="nv">eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJzZWNyZXRsaXR0bGViaXJkIiwicGFzc3dvcmQiOiJkY2tyX3BhdF9QdWNpVTRIMFBPZVpYWGNvV1VNd1ozTVpZVEUiLCJhdXRoIjoiYzJWamNtVjBiR2wwZEd4bFltbHlaRHBrWTJ0eVgzQmhkRjlRZFdOcFZUUklNRkJQWlZwWVdHTnZWMVZOZDFvelRWcFpWRVU9In19fQ</span><span class="o">==</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SECRET</span><span class="s2">"</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="p">;</span> <span class="nb">echo</span>
<span class="c"># =&gt; {&amp;quot;auths&amp;quot;:{&amp;quot;https://index.docker.io/v1/&amp;quot;:{&amp;quot;username&amp;quot;:&amp;quot;sweetlittlebird&amp;quot;,&amp;quot;password&amp;quot;:&amp;quot;dckr_****&amp;quot;,&amp;quot;auth&amp;quot;:&amp;quot;c2VjcmV0bGl0dGxlYmlyZDpkY2tyX3BhdF9QdWNpVTRIMFBPZVpYWGNvV1VNd1ozTVpZVEU=&amp;quot;}}}</span>

<span class="c"># ë„ì»¤í—ˆë¸Œ ì¸ì¦ í† í°ì´ ë“±ë¡ë˜ì—ˆìœ¼ë‹ˆ ë‹¤ì‹œ ë°°í¬í•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: timeserver
spec:
  replicas: 2
  selector:
    matchLabels:
      pod: timeserver-pod
  template:
    metadata:
      labels:
        pod: timeserver-pod
    spec:
      containers:
      - name: timeserver-container
        image: docker.io/</span><span class="nv">$DHUSER</span><span class="sh">/dev-app:0.0.1
      imagePullSecrets:
      - name: dockerhub-secret
</span><span class="no">EOF
</span><span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get deploy,pod <span class="nt">-o</span> wide

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,pod
<span class="c"># =&gt; NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/timeserver   2/2     2            2           39s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/timeserver-549cc9bc89-k6n6g   1/1     Running   0          39s</span>
<span class="c">#    pod/timeserver-549cc9bc89-kdmgx   1/1     Running   0          39s</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë°°í¬ê°€ ì˜ ë˜ì—ˆìŠµë‹ˆë‹¤!&lt;/span&gt;</span>

<span class="c"># ì ‘ì†ì„ ìœ„í•œ curl íŒŒë“œ ìƒì„±</span>
<span class="nv">$ </span>kubectl run curl-pod <span class="nt">--image</span><span class="o">=</span>curlimages/curl:latest <span class="nt">--command</span> <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s2">"while true; do sleep 3600; done"</span>
<span class="c"># =&gt; pod/curl-pod created</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                          READY   STATUS    RESTARTS   AGE    IP           NODE            NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                      1/1     Running   0          22s    10.244.2.6   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    timeserver-549cc9bc89-k6n6g   1/1     Running   0          103s   10.244.2.5   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    timeserver-549cc9bc89-kdmgx   1/1     Running   0          103s   10.244.1.6   myk8s-worker    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># timeserver íŒŒë“œ IP 1ê°œ í™•ì¸ í›„ ì ‘ì† í™•ì¸</span>
<span class="c">#$ PODIP1=&lt;timeserver-Y íŒŒë“œ IP&gt;</span>
<span class="nv">$ PODIP1</span><span class="o">=</span>10.244.2.5

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nv">$PODIP1</span>
<span class="c"># =&gt; The time is 2:51:54 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-k6n6g</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nv">$PODIP1</span>
<span class="c"># =&gt; The time is 2:52:03 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-k6n6g</span>

<span class="c"># ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl logs deploy/timeserver
<span class="nv">$ </span>kubectl logs deploy/timeserver <span class="nt">-f</span>
<span class="nv">$ </span>kubectl stern deploy/timeserver
<span class="nv">$ </span>kubectl stern <span class="nt">-l</span> <span class="nv">pod</span><span class="o">=</span>timeserver-pod
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_15.png" alt="img.png" class="image-center" /></p>

<ul>
  <li>kube-ops-viewë¥¼ í†µí•´ì„œë„ ë°°í¬ê°€ ì˜ ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>íŒŒë“œ 1ê°œ ì‚­ì œ í›„ ë™ì‘ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="c">#$ POD1NAME=&lt;íŒŒë“œ 1ê°œ ì´ë¦„&gt;</span>
<span class="nv">$ POD1NAME</span><span class="o">=</span>timeserver-549cc9bc89-k6n6g

<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                          READY   STATUS    RESTARTS   AGE    IP           NODE            NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                      1/1     Running   0          22s    10.244.2.6   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    timeserver-549cc9bc89-k6n6g   1/1     Running   0          103s   10.244.2.5   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    timeserver-549cc9bc89-kdmgx   1/1     Running   0          103s   10.244.1.6   myk8s-worker    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="nv">$ </span>kubectl delete pod <span class="nv">$POD1NAME</span> <span class="o">&amp;&amp;</span> kubectl get pod <span class="nt">-w</span>
<span class="c"># =&gt; pod &amp;quot;timeserver-549cc9bc89-k6n6g&amp;quot; deleted              # &lt;span style="color: green;"&gt;ğŸ‘‰ ë¶„ëª…íˆ timeserver íŒŒë“œ 1ê°œë¥¼ ì‚­ì œí•˜ì˜€ëŠ”ë°&lt;/span&gt;</span>
<span class="c">#    NAME                          READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    curl-pod                      1/1     Running   0          115s</span>
<span class="c">#    timeserver-549cc9bc89-kdmgx   1/1     Running   0          7m20s</span>
<span class="c">#    timeserver-549cc9bc89-pvm5k   1/1     Running   0          31s   # &lt;span style="color: green;"&gt;ğŸ‘‰ ë‹¤ì‹œ ìƒˆë¡œìš´ íŒŒë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì…€í”„ íë§ , íŒŒë“œ IP ë³€ê²½ -&gt; ê³ ì • ì§„ì…ì (ê³ ì • IP/ë„ë©”ì¸ë„¤ì„) í•„ìš” =&gt; Service</span>
<span class="nv">$ </span>kubectl get deploy,rs,pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                         READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS             IMAGES                                    SELECTOR</span>
<span class="c">#    deployment.apps/timeserver   2/2     2            2           10m   timeserver-container   docker.io/sweetlittlebird/dev-app:0.0.1   pod=timeserver-pod</span>
<span class="c">#    </span>
<span class="c">#    NAME                                    DESIRED   CURRENT   READY   AGE   CONTAINERS             IMAGES                                    SELECTOR</span>
<span class="c">#    replicaset.apps/timeserver-549cc9bc89   2         2         2       10m   timeserver-container   docker.io/sweetlittlebird/dev-app:0.0.1   pod=timeserver-pod,pod-template-hash=549cc9bc89</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS    RESTARTS   AGE     IP           NODE            NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/curl-pod                      1/1     Running   0          4m56s   10.244.2.7   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/timeserver-549cc9bc89-kdmgx   1/1     Running   0          10m     10.244.1.6   myk8s-worker    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/timeserver-549cc9bc89-pvm5k   1/1     Running   0          3m32s   10.244.2.8   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
</code></pre></div></div>

<ul>
  <li>ìœ„ì™€ ê°™ì´ íŒŒë“œê°€ ì‚­ì œë˜ë©´ ReplicaSetì— ì˜í•´ ìƒˆë¡œìš´ íŒŒë“œê°€ ìƒì„±ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ë•Œ IPê°€ ë³€ê²½ë˜ì–´ ìƒˆë¡œìš´ íŒŒë“œê°€ ìƒì„±ë˜ëŠ”ë°, ì´ë ‡ê²Œ ë˜ë©´ ë§¤ë²ˆ íŒŒë“œê°€ ìƒì„±ë ë•Œ ë§ˆë‹¤ IPê°€ ë³€ê²½ë˜ì–´ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ <strong>Service</strong>ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="service-ì†Œê°œ">Service ì†Œê°œ</h5>

<ul>
  <li><strong>Service</strong>ëŠ” Podì˜ ì§‘í•©ì— ëŒ€í•œ ê³ ì •ëœ ì§„ì…ì ì„ ì œê³µí•©ë‹ˆë‹¤. ì•ì„œ ì‚´í´ë³¸ê²ƒê³¼ ê°™ì´ PodëŠ” ìƒì„±/ì‚­ì œë˜ë©´ IPê°€ ë³€ê²½ë˜ëŠ”ë°, ì´ë¥¼ Serviceë¥¼ í†µí•´ ê³ ì •ëœ IPë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Deploymentë¥¼ í†µí•´ Podê°€ ì—¬ëŸ¬ ê°œ ìƒì„±ë˜ë©´, ServiceëŠ” ì´ë“¤ì„ í•˜ë‚˜ì˜ ì§‘í•©ìœ¼ë¡œ ë¬¶ì–´ì„œ ë¶€í•˜ë¶„ì‚°(Load Balancing)ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>ServiceëŠ” Deploymentë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ì§€ì•Šê³ , Podë¥¼ ëŒ€ìƒìœ¼ë¡œ í•©ë‹ˆë‹¤. Podì˜ Label Selectorë¥¼ í†µí•´ ServiceëŠ” Podë¥¼ ì„ íƒí•©ë‹ˆë‹¤. 
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_16.png" alt="img.png" class="image-center" />
<em class="image-caption">Serviceì™€ Deployment, Pod manifestì˜ ê´€ê³„</em></li>
  <li>ServiceëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì¢…ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li><strong>ClusterIP</strong> : í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li><strong>NodePort</strong> : í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œëŠ” ë¬¼ë¡  ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì´ë•Œ íŒŒë“œê°€ ë™ì‘í•˜ëŠ” ë…¸ë“œ IPì˜ ì§€ì •ëœ í¬íŠ¸ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li><strong>LoadBalancer</strong> : í´ë¼ìš°ë“œ ì œê³µìì˜ ë¡œë“œë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h5 id="service-ë°°í¬-ì‹¤ìŠµ">Service ë°°í¬ ì‹¤ìŠµ</h5>

<ul>
  <li>ê°„ë‹¨í•œ ì„œë¹„ìŠ¤ë¥¼ ë°°í¬í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì„œë¹„ìŠ¤ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: timeserver
spec:
  selector:
    pod: timeserver-pod
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    nodePort: 30000
  type: NodePort
</span><span class="no">EOF
</span><span class="c"># =&gt; service/timeserver created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get service,ep timeserver <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span>
<span class="c">#    service/timeserver   NodePort   10.96.204.127   &amp;lt;none&amp;gt;        80:30000/TCP   13s   pod=timeserver-pod</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                     AGE</span>
<span class="c">#    endpoints/timeserver   10.244.1.6:80,10.244.2.8:80   13s</span>

<span class="c"># Service(ClusterIP)ë¡œ ì ‘ì† í™•ì¸ : ë„ë©”ì¸ë„¤ì„ ë°©ì‹</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl timeserver
<span class="c"># =&gt; The time is 3:29:30 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl timeserver.default.svc.cluster.local
<span class="c"># =&gt; The time is 3:29:33 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>

<span class="c"># Service(ClusterIP)ë¡œ ì ‘ì† í™•ì¸ : í´ëŸ¬ìŠ¤í„° IP ë°©ì‹</span>
<span class="nv">$ </span>kubectl get svc timeserver <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span>
<span class="c"># =&gt; 10.96.204.127</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="si">$(</span>kubectl get svc timeserver <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
<span class="c"># =&gt; The time is 3:29:40 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>

<span class="c"># Service(NodePort)ë¡œ ì ‘ì† í™•ì¸ "ë…¸ë“œIP:NodePort"</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; The time is 3:32:43 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-&lt;span style="color: red;"&gt;kdmgx&lt;/span&gt;</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; The time is 3:32:59 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-&lt;span style="color: red;"&gt;pvm5k&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì„œë¹„ìŠ¤ê°€ 2ê°œì˜ Pod ì‚¬ì´ë¥¼ Load balancing í•˜ëŠ”ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë°˜ë³µ ì ‘ì† í•´ë‘ê¸° : ë¶€í•˜ë¶„ì‚° í™•ì¸</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 | <span class="nb">grep </span>name <span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> http://127.0.0.1:30000 | <span class="nb">grep </span>name<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;   54 Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#      46 Server hostname: timeserver-549cc9bc89-kdmgx</span>

<span class="c"># íŒŒë“œ ë³µì œë³µ ì¦ê°€ : service endpoint ëŒ€ìƒì— ìë™ ì¶”ê°€</span>
<span class="nv">$ </span>kubectl scale deployment timeserver <span class="nt">--replicas</span> 4
<span class="c"># =&gt; deployment.apps/timeserver scaled</span>
<span class="nv">$ </span>kubectl get service,ep timeserver <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span>
<span class="c">#    service/timeserver   NodePort   10.96.204.127   &amp;lt;none&amp;gt;        80:30000/TCP   37m   pod=timeserver-pod</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                                               AGE</span>
<span class="c">#    endpoints/timeserver   10.244.1.6:80,10.244.1.7:80,10.244.2.8:80 + 1 more...   37m</span>

<span class="c"># ë°˜ë³µ ì ‘ì† í•´ë‘ê¸° : ë¶€í•˜ë¶„ì‚° í™•ì¸</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 | <span class="nb">grep </span>name <span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-h9q6p</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-h9q6p</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> http://127.0.0.1:30000 | <span class="nb">grep </span>name<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;   29 Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#      27 Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#      22 Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#      22 Server hostname: timeserver-549cc9bc89-h9q6p</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ íŒŒë“œ ìˆ˜ ë§Œí¼ ìë™ìœ¼ë¡œ ë¡œë“œë°¸ëŸ°ì‹± ë˜ëŠ”ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="ì•±-ì—…ë°ì´íŠ¸-í›„-ì¬ë°°í¬">ì•± ì—…ë°ì´íŠ¸ í›„ ì¬ë°°í¬</h5>

<ul>
  <li>ìƒ˜í”Œ ì•±ì˜ server.pyì™€ VERSION íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•˜ê³ , Jenkins Pipelineì„ í†µí•´ ìƒˆë¡œìš´ ë²„ì „ì„ ë°°í¬í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ë¨¼ì € ìƒ˜í”Œ ì•±ì˜ ì—…ë°ì´íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì—…ë°ì´íŠ¸</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s/0.0.1/0.0.2/g'</span> server.py
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"0.0.2"</span> <span class="o">&gt;</span> VERSION
<span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Update to 0.0.2"</span>
<span class="c"># =&gt; main c17ce89] Update to 0.0.2</span>
<span class="c">#     2 files changed, 2 insertions(+), 2 deletions(-)</span>
<span class="nv">$ </span>git push origin main
<span class="c"># =&gt; Enumerating objects: 7, done.</span>
<span class="c">#    Counting objects: 100% (7/7), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (3/3), done.</span>
<span class="c">#    Writing objects: 100% (4/4), 332 bytes | 332.00 KiB/s, done.</span>
<span class="c">#    Total 4 (delta 2), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/dev-app.git</span>
<span class="c">#       3531233..c17ce89  main -&amp;gt; main</span>
</code></pre></div>    </div>
  </li>
  <li>Jenkinsì—ì„œ Build Nowë¥¼ í´ë¦­í•˜ì—¬ í†µí•´ ìƒˆë¡œìš´ ë²„ì „ì„ docker hubì— ì—…ë¡œë“œ í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_17.png" alt="img.png" /></p>

<ul>
  <li>ìƒˆë¡œìš´ ë²„ì „ì´ docker hubì— ì—…ë¡œë“œ ë˜ì—ˆìœ¼ë‹ˆ, Kubernetes í´ëŸ¬ìŠ¤í„°ì— ë°°í¬í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë“œ ë³µì œë³µ ì¦ê°€</span>
<span class="nv">$ </span>kubectl scale deployment timeserver <span class="nt">--replicas</span> 4
<span class="c"># =&gt; deployment.apps/timeserver scaled</span>
<span class="nv">$ </span>kubectl get service,ep timeserver <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span>
<span class="c">#    service/timeserver   NodePort   10.96.204.127   &amp;lt;none&amp;gt;        80:30000/TCP   45m   pod=timeserver-pod</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                                               AGE</span>
<span class="c">#    endpoints/timeserver   10.244.1.6:80,10.244.1.7:80,10.244.2.8:80 + 1 more...   45m</span>

<span class="c"># ë°˜ë³µ ì ‘ì† í•´ë‘ê¸° : ë¶€í•˜ë¶„ì‚° í™•ì¸</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 | <span class="nb">grep </span>name <span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-h9q6p</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> http://127.0.0.1:30000 | <span class="nb">grep </span>name<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;   32 Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#      27 Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#      25 Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#      16 Server hostname: timeserver-549cc9bc89-h9q6p</span>

<span class="c"># ì—…ë°ì´íŠ¸ë¥¼ ë°°í¬í•˜ê¸° ìœ„í•´ì„œ kubectl set imageë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.</span>
<span class="c"># $ kubectl set image deployment timeserver timeserver-container=$DHUSER/dev-app:0.0.Y &amp;&amp; watch -d "kubectl get deploy,ep timeserver; echo; kubectl get rs,pod"</span>
<span class="nv">$ </span>kubectl <span class="nb">set </span>image deployment timeserver timeserver-container<span class="o">=</span><span class="nv">$DHUSER</span>/dev-app:0.0.2 <span class="o">&amp;&amp;</span> watch <span class="nt">-d</span> <span class="s2">"kubectl get deploy,ep timeserver; echo; kubectl get rs,pod"</span>
<span class="c"># =&gt; Every 2.0s: kubectl get deploy,ep timeserver; echo; kubectl get rs,pod                                                                 Balthazar.local: Sun Oct 01 01:17:30 2024</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS        RESTARTS   AGE</span>
<span class="c">#    pod/timeserver-549cc9bc89-h9q6p   1/1     Terminating   0          11m</span>
<span class="c">#    pod/timeserver-549cc9bc89-kdmgx   1/1     Terminating   0          88m</span>
<span class="c">#    pod/timeserver-549cc9bc89-pvm5k   1/1     Terminating   0          81m</span>
<span class="c">#    pod/timeserver-549cc9bc89-xlbck   1/1     Terminating   0          11m</span>
<span class="c">#    pod/timeserver-6f476fdbf-f8hw5    1/1     Running       0          9s</span>
<span class="c">#    pod/timeserver-6f476fdbf-k5fsn    1/1     Running       0          9s</span>
<span class="c">#    pod/timeserver-6f476fdbf-qq465    1/1     Running       0          4s</span>
<span class="c">#    pod/timeserver-6f476fdbf-tvrl5    1/1     Running       0          3s</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê¸°ì¡´ ë²„ì „ì˜ íŒŒë“œê°€ ì¢…ë£Œë˜ê³  ìƒˆë¡œìš´ íŒŒë“œê°€ replica ìˆ˜ ë§Œí¼ ìƒì„± ë˜ëŠ” ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ë¡¤ë§ì—…ë°ì´íŠ¸ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ë³„ë„ì˜ í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒì˜ ëª…ë ¹ì„ ì…ë ¥í•©ë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000<span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    The time is 4:17:24 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    The time is 4:17:25 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#    The time is 4:17:26 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#    The time is 4:17:27 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    The time is 4:17:28 PM, VERSION 0.0.2</span>
<span class="c">#    Server hostname: timeserver-6f476fdbf-k5fsn</span>
<span class="c">#    The time is 4:17:29 PM, VERSION 0.0.2</span>
<span class="c">#    Server hostname: timeserver-6f476fdbf-qq465</span>
<span class="c">#    The time is 4:17:30 PM, VERSION 0.0.2</span>
<span class="c">#    Server hostname: timeserver-6f476fdbf-tvrl5</span>
<span class="c">#    The time is 4:17:31 PM, VERSION 0.0.2</span>
<span class="c">#    Server hostname: timeserver-6f476fdbf-f8hw5</span>
<span class="c">#    The time is 4:17:32 PM, VERSION 0.0.2</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë¡¤ë§ì—…ë°ì´íŠ¸ë¥¼ í†µí•´ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ì´ ë°°í¬ê°€ ì˜ ë¨ì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>


<span class="c"># ë¡¤ë§ ì—…ë°ì´íŠ¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,rs,pod,svc,ep <span class="nt">-owide</span>

<span class="c"># kubectl get deploy $DEPLOYMENT_NAME</span>
<span class="nv">$ </span>kubectl get deploy timeserver
<span class="c"># =&gt; NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    timeserver   4/4     4            4           90m</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ READYëŠ” ì „ì²´ replica ì¤‘ ëª‡ ê°œì˜ íŒŒë“œê°€ ì„œë¹„ìŠ¤ê°€ ê°€ëŠ¥í•œì§€ ì•Œë ¤ì¤ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    UP-TO-DATEëŠ” ëª‡ ê°œì˜ íŒŒë“œê°€ í˜„ì¬ì˜ ë²„ì „(ìƒíƒœ)ì¸ì§€ ì•Œë ¤ì¤ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl get pods <span class="nt">-l</span> <span class="nv">pod</span><span class="o">=</span>timeserver-pod
<span class="c"># =&gt; NAME                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    timeserver-6f476fdbf-f8hw5   1/1     Running   0          3m3s</span>
<span class="c">#    timeserver-6f476fdbf-k5fsn   1/1     Running   0          3m3s</span>
<span class="c">#    timeserver-6f476fdbf-qq465   1/1     Running   0          2m58s</span>
<span class="c">#    timeserver-6f476fdbf-tvrl5   1/1     Running   0          2m57s</span>
</code></pre></div></div>

<h4 id="gogs-webhookì„-í†µí•´-jenkins-pipeline-ìë™í™”">Gogs Webhookì„ í†µí•´ Jenkins Pipeline ìë™í™”</h4>

<ul>
  <li>Jenkins Pipelineì„ í†µí•´ ìƒˆë¡œìš´ ë²„ì „ì„ ë°°í¬í•˜ëŠ” ê³¼ì •ì„ ìë™í™”í•˜ê¸° ìœ„í•´ Gogs Webhookì„ ì„¤ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>git pushë¥¼ í†µí•´ ìƒˆë¡œìš´ ë²„ì „ì„ ì—…ë¡œë“œí•˜ë©´, Gogs Webhookì„ í†µí•´ Jenkins Pipelineì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ ìƒˆë¡œìš´ ë²„ì „ì˜ ë„ì»¤ ì´ë¯¸ì§€ê°€ docker hubì— ì—…ë¡œë“œë˜ë„ë¡ í•©ë‹ˆë‹¤.</li>
</ul>

<h5 id="gogs-ì„¤ì •-ìˆ˜ì •-ë°-webhook-ì„¤ì •">Gogs ì„¤ì • ìˆ˜ì • ë° Webhook ì„¤ì •</h5>

<ul>
  <li>
    <p>ë¨¼ì € gogs ì»¨í…Œì´ë„ˆì˜ app.ini íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ jenkinsê°€ gogsì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># app.ini íŒŒì¼ ìˆ˜ì •</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>gogs vi /data/gogs/conf/app.ini
</code></pre></div>    </div>

    <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># app.ini
</span><span class="err">...</span>
<span class="nn">[security]</span>
<span class="py">INSTALL_LOCK</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">SECRET_KEY</span>   <span class="p">=</span> <span class="s">atxaUPQcbAEwpIu</span>
<span class="py">LOCAL_NETWORK_ALLOWLIST</span> <span class="p">=</span> <span class="s">10.0.4.3 # ê°ì ìì‹ ì˜ PC IP</span>
<span class="err">...</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Gogs ì»¨í…Œì´ë„ˆë¥¼ ì¬ê¸°ë™í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker compose restart gogs
</code></pre></div>    </div>
  </li>
  <li>
    <p>Gogs ì—ì„œ Webhookì„ ì„¤ì •í•©ë‹ˆë‹¤.</p>
    <ol>
      <li>Repositoryë¥¼ ì„ íƒí›„ ìš°ì¸¡ì˜ Settings &gt; Webhooks &gt; Add a new webhookì—ì„œ Gogsë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
  <img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_18.png" alt="img.png" /></li>
      <li>Payload URL : <code class="language-plaintext highlighter-rouge">http://&lt;Jenkinsì˜ IP = PCì˜ IP&gt;:8080/gogs-webhook/?job=SCM-Pipeline/</code></li>
      <li>Content Type : <code class="language-plaintext highlighter-rouge">application/json</code></li>
      <li>Secret : <code class="language-plaintext highlighter-rouge">qwe123</code></li>
      <li>When should this webhook be triggered? : Just the push event</li>
      <li>Active : ì²´í¬</li>
      <li>Add Webhookì„ í´ë¦­í•˜ì—¬ ì›¹í›…ì„ ì €ì¥í•©ë‹ˆë‹¤.</li>
    </ol>
  </li>
</ul>

<h5 id="jenkinsì—ì„œ-gogs-webhookì„-í†µí•œ-pipeline-ìƒì„±">Jenkinsì—ì„œ Gogs Webhookì„ í†µí•œ Pipeline ìƒì„±</h5>

<ul>
  <li>ì´ë²ˆì—ëŠ” Jenkinsì—ì„œ ì•ì„œ ìƒì„±í•œ Gogs Webhookì„ í†µí•´ ìƒˆë¡œìš´ ë²„ì „ì„ ë°°í¬í•˜ëŠ” Pipelineì„ ìƒì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>Dashboard &gt; New Item ì„ ì„ íƒí•©ë‹ˆë‹¤.
    <ul>
      <li>item name : SCM-Pipeline</li>
      <li>item type : Pipeline</li>
      <li>OKë¥¼ í´ë¦­í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Pipeline ì„¤ì •ì„ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•©ë‹ˆë‹¤.
    <ul>
      <li>GitHub project : <code class="language-plaintext highlighter-rouge">http://&lt;PCì˜ IP&gt;:3000/&lt;Gogs ê³„ì •ëª…&gt;/dev-app.git</code></li>
      <li>Use Gogs secret : <code class="language-plaintext highlighter-rouge">qwe123</code></li>
      <li>Build Triggers : Build when a change is pushed to Gogs ì²´í¬</li>
      <li>Pipeline script from SCM
        <ul>
          <li>SCM : Git
            <ul>
              <li>Repo URL : <code class="language-plaintext highlighter-rouge">http://&lt;PCì˜ IP&gt;:3000/&lt;Gogs ê³„ì •ëª…&gt;/dev-app.git</code></li>
              <li>Credentials : <code class="language-plaintext highlighter-rouge">devops/*</code></li>
              <li>Branch : <code class="language-plaintext highlighter-rouge">*/main</code></li>
            </ul>
          </li>
          <li>Script Path : <code class="language-plaintext highlighter-rouge">Jenkinsfile</code> 
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_19.png" alt="img.png" /></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="jenkinsfile-ì‘ì„±-í›„-git-push">Jenkinsfile ì‘ì„± í›„ Git Push</h5>

<ul>
  <li>Jenkinsfileì„ ì‘ì„±í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">DOCKER_IMAGE</span> <span class="o">=</span> <span class="s1">'&lt;ìì‹ ì˜ ë„ì»¤ í—ˆë¸Œ ê³„ì •&gt;/dev-app'</span> <span class="c1">// Docker ì´ë¯¸ì§€ ì´ë¦„</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Checkout'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                 <span class="n">git</span> <span class="nl">branch:</span> <span class="s1">'main'</span><span class="o">,</span>
                 <span class="nl">url:</span> <span class="s1">'http://&lt;PCì˜ IP&gt;:3000/devops/dev-app.git'</span><span class="o">,</span>  <span class="c1">// Gitì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ</span>
                 <span class="nl">credentialsId:</span> <span class="s1">'gogs-crd'</span>  <span class="c1">// Credentials ID</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Read VERSION'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="c1">// VERSION íŒŒì¼ ì½ê¸°</span>
                    <span class="kt">def</span> <span class="n">version</span> <span class="o">=</span> <span class="n">readFile</span><span class="o">(</span><span class="s1">'VERSION'</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span>
                    <span class="n">echo</span> <span class="s2">"Version found: ${version}"</span>
                    <span class="c1">// í™˜ê²½ ë³€ìˆ˜ ì„¤ì •</span>
                    <span class="n">env</span><span class="o">.</span><span class="na">DOCKER_TAG</span> <span class="o">=</span> <span class="n">version</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Docker Build and Push'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s1">'https://index.docker.io/v1/'</span><span class="o">,</span> <span class="s1">'dockerhub-crd'</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// DOCKER_TAG ì‚¬ìš©</span>
                        <span class="kt">def</span> <span class="n">appImage</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="s2">"${DOCKER_IMAGE}:${DOCKER_TAG}"</span><span class="o">)</span>
                        <span class="n">appImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
                        <span class="n">appImage</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="s2">"latest"</span><span class="o">)</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">post</span> <span class="o">{</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s2">"Docker image ${DOCKER_IMAGE}:${DOCKER_TAG} has been built and pushed successfully!"</span>
        <span class="o">}</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s2">"Pipeline failed. Please check the logs."</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>VERSION íŒŒì¼ê³¼ server.py íŒŒì¼ì„ 0.0.2 =&gt; 0.0.3ìœ¼ë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤.</li>
  <li>ì‘ì„±ëœ íŒŒì¼ push</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"VERSION </span><span class="si">$(</span><span class="nb">cat </span>VERSION<span class="si">)</span><span class="s2"> Changed"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
</code></pre></div></div>

<ul>
  <li>Pushì™€ ê±°ì˜ ë™ì‹œì— Jenkinsì—ì„œ Buildê°€ ì‹œì‘ë˜ê³  ì„±ê³µì ìœ¼ë¡œ ë¹Œë“œê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_20.png" alt="img.png" /></p>

<ul>
  <li>Docker hubì—ë„ 0.0.3 ë²„ì „ì´ ì—…ë¡œë“œ ì˜ ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_21.png" alt="img.png" /></p>

<ul>
  <li>Gogsì—ì„œ Repository &gt; Settings &gt; Webhooks &gt; ì›¹í›… í´ë¦­í•˜ë©´ ì›¹í›… ì „ë‹¬ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
Gogs =&gt; Jenkinsì˜ ë°©í–¥ìœ¼ë¡œ Webhookì´ ì „ë‹¬ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_22.png" alt="img.png" /></p>

<ul>
  <li>ë§ˆì§€ë§‰ìœ¼ë¡œ Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ ìƒˆë¡œìš´ ë²„ì „ì„ ë°°í¬í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl <span class="nb">set </span>image deployment timeserver timeserver-container<span class="o">=</span><span class="nv">$DHUSER</span>/dev-app:0.0.3 <span class="o">&amp;&amp;</span> watch <span class="nt">-d</span> <span class="s2">"kubectl get deploy,ep timeserver; echo; kubectl get rs,pod"</span>
</code></pre></div></div>

<hr />

<h3 id="jenkins-cicd--k8s-kind">Jenkins CI/CD + K8S (Kind)</h3>

<ul>
  <li>ì´ë²ˆì—ëŠ” Jenkinsì—ì„œ ë°”ë¡œ Kubernetes í´ëŸ¬ìŠ¤í„°ì— ë°°í¬í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>Jenkins ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— í•„ìš”í•œ íˆ´(kubectl, helm)ì„ ì„¤ì¹˜ í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install kubectl, helm</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins bash
<span class="nt">--------------------------------------------</span>
<span class="c">#curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl" </span>
<span class="nv">$ </span>curl <span class="nt">-LO</span> <span class="s2">"https://dl.k8s.io/release/</span><span class="si">$(</span>curl <span class="nt">-L</span> <span class="nt">-s</span> https://dl.k8s.io/release/stable.txt<span class="si">)</span><span class="s2">/bin/linux/arm64/kubectl"</span>  <span class="c"># macOS</span>
<span class="c"># $ curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"  # WindowOS</span>

<span class="nv">$ </span><span class="nb">install</span> <span class="nt">-o</span> root <span class="nt">-g</span> root <span class="nt">-m</span> 0755 kubectl /usr/local/bin/kubectl
<span class="nv">$ </span>kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Client Version: v1.32.0</span>
<span class="c">#    Kustomize Version: v5.5.0</span>

<span class="c">#</span>
<span class="nv">$ </span>curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
<span class="nv">$ </span>helm version
<span class="c"># =&gt; version.BuildInfo{Version:&amp;quot;v3.16.4&amp;quot;, GitCommit:&amp;quot;7877b45b63f95635153b29a42c0c2f4273ec45ca&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;, GoVersion:&amp;quot;go1.22.7&amp;quot;}</span>

<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">--------------------------------------------</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Client Version: v1.32.0</span>
<span class="c">#    Kustomize Version: v5.5.0</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins helm version
<span class="c"># =&gt; version.BuildInfo{Version:&amp;quot;v3.16.4&amp;quot;, GitCommit:&amp;quot;7877b45b63f95635153b29a42c0c2f4273ec45ca&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;, GoVersion:&amp;quot;go1.22.7&amp;quot;}</span>
</code></pre></div></div>

<ul>
  <li>Jenkins Item ìƒì„±(Pipeline) : item name(k8s-cmd)</li>
</ul>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">KUBECONFIG</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">(</span><span class="s1">'k8s-crd'</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'List Pods'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">'''
                # Fetch and display Pods
                kubectl get pods -A --kubeconfig "$KUBECONFIG"
                '''</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_23.png" alt="img.png" /></p>

<h5 id="jenkinsë¥¼-ì´ìš©í•œ-blue-green-ë°°í¬-ì‹¤ìŠµ">Jenkinsë¥¼ ì´ìš©í•œ blue-green ë°°í¬ ì‹¤ìŠµ</h5>

<ul>
  <li>ë””í”Œë¡œì´ë¨¼íŠ¸ / ì„œë¹„ìŠ¤ yaml íŒŒì¼ ì‘ì„± - http-echo ë° ì½”ë“œ push</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># </span>
<span class="nv">$ </span><span class="nb">cd </span>dev-app

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">mkdir </span>deploy

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> deploy/echo-server-blue.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-server-blue
spec:
  replicas: 2
  selector:
    matchLabels:
      app: echo-server
      version: blue
  template:
    metadata:
      labels:
        app: echo-server
        version: blue
    spec:
      containers:
      - name: echo-server
        image: hashicorp/http-echo
        args:
        - "-text=Hello from Blue"
        ports:
        - containerPort: 5678
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> deploy/echo-server-service.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Service
metadata:
  name: echo-server-service
spec:
  selector:
    app: echo-server
    version: blue
  ports:
  - protocol: TCP
    port: 80
    targetPort: 5678
    nodePort: 30000
  type: NodePort
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> deploy/echo-server-green.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-server-green
spec:
  replicas: 2
  selector:
    matchLabels:
      app: echo-server
      version: green
  template:
    metadata:
      labels:
        app: echo-server
        version: green
    spec:
      containers:
      - name: echo-server
        image: hashicorp/http-echo
        args:
        - "-text=Hello from Green"
        ports:
        - containerPort: 5678
</span><span class="no">EOF

</span><span class="c">#</span>
<span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Add echo server yaml"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; main 76adc73] Add echo server yaml</span>
<span class="c">#     3 files changed, 60 insertions(+)</span>
<span class="c">#     create mode 100644 deploy/echo-server-blue.yaml</span>
<span class="c">#     create mode 100644 deploy/echo-server-green.yaml</span>
<span class="c">#     create mode 100644 deploy/echo-server-service.yaml</span>
<span class="c">#    Enumerating objects: 7, done.</span>
<span class="c">#    Counting objects: 100% (7/7), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (6/6), done.</span>
<span class="c">#    Writing objects: 100% (6/6), 789 bytes | 789.00 KiB/s, done.</span>
<span class="c">#    Total 6 (delta 2), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/dev-app.git</span>
<span class="c">#       60f336b..76adc73  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div></div>

<ul>
  <li>Jenkinsì—ì„œ Pipelineì„ ì‘ì„±í•˜ì—¬ ë°°í¬í•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ë¨¼ì €, ì´ì „ ì‹¤ìŠµì—ì„œ ë°°í¬í•œ deploymentì™€ serviceë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete deploy,svc timeserver
<span class="c"># =&gt; deployment.apps &amp;quot;timeserver&amp;quot; deleted</span>
<span class="c">#    service &amp;quot;timeserver&amp;quot; deleted</span>
</code></pre></div></div>

<ul>
  <li>ë°˜ë³µì ‘ì†ì„ ë¯¸ë¦¬ ì‹¤í–‰í•´ë‘¡ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë³„ë„ì˜ í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> <span class="nb">sleep </span>1  <span class="p">;</span> kubectl get deploy <span class="nt">-owide</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> kubectl get svc,ep echo-server-service <span class="nt">-owide</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"------------"</span> <span class="p">;</span> <span class="k">done</span>
<span class="c"># í˜¹ì€ </span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 <span class="p">;</span> <span class="nb">date</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>Jenkinsì—ì„œ Pipeline ìƒì„± : item name(k8s-bluegreen)</li>
</ul>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>

    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">KUBECONFIG</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">(</span><span class="s1">'k8s-crd'</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Checkout'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                 <span class="n">git</span> <span class="nl">branch:</span> <span class="s1">'main'</span><span class="o">,</span>
                 <span class="nl">url:</span> <span class="s1">'http://&lt;PCì˜ IP&gt;:3000/devops/dev-app.git'</span><span class="o">,</span>  <span class="c1">// Gitì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ</span>
                 <span class="nl">credentialsId:</span> <span class="s1">'gogs-crd'</span>  <span class="c1">// Credentials ID</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'container image build'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">"container image build"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'container image upload'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">"container image upload"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'k8s deployment blue version'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">"kubectl apply -f ./deploy/echo-server-blue.yaml --kubeconfig $KUBECONFIG"</span>
                <span class="n">sh</span> <span class="s2">"kubectl apply -f ./deploy/echo-server-service.yaml --kubeconfig $KUBECONFIG"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'approve green version'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">input</span> <span class="nl">message:</span> <span class="s1">'approve green version'</span><span class="o">,</span> <span class="nl">ok:</span> <span class="s2">"Yes"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'k8s deployment green version'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
	        	<span class="n">sh</span> <span class="s2">"kubectl apply -f ./deploy/echo-server-green.yaml --kubeconfig $KUBECONFIG"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'approve version switching'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">returnValue</span> <span class="o">=</span> <span class="n">input</span> <span class="nl">message:</span> <span class="s1">'Green switching?'</span><span class="o">,</span> <span class="nl">ok:</span> <span class="s2">"Yes"</span><span class="o">,</span> <span class="nl">parameters:</span> <span class="o">[</span><span class="n">booleanParam</span><span class="o">(</span><span class="nl">defaultValue:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">'IS_SWITCHED'</span><span class="o">)]</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">returnValue</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s2">"kubectl patch svc echo-server-service -p '{\"spec\": {\"selector\": {\"version\": \"green\"}}}' --kubeconfig $KUBECONFIG"</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'Blue Rollback'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">returnValue</span> <span class="o">=</span> <span class="n">input</span> <span class="nl">message:</span> <span class="s1">'Blue Rollback?'</span><span class="o">,</span> <span class="nl">parameters:</span> <span class="o">[</span><span class="n">choice</span><span class="o">(</span><span class="nl">choices:</span> <span class="o">[</span><span class="s1">'done'</span><span class="o">,</span> <span class="s1">'rollback'</span><span class="o">],</span> <span class="nl">name:</span> <span class="s1">'IS_ROLLBACk'</span><span class="o">)]</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">returnValue</span> <span class="o">==</span> <span class="s2">"done"</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s2">"kubectl delete -f ./deploy/echo-server-blue.yaml --kubeconfig $KUBECONFIG"</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">returnValue</span> <span class="o">==</span> <span class="s2">"rollback"</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s2">"kubectl patch svc echo-server-service -p '{\"spec\": {\"selector\": {\"version\": \"blue\"}}}' --kubeconfig $KUBECONFIG"</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Build Nowë¡œ ë°°í¬ í›„ ë™ì‘ì„ í™•ì¸í•©ë‹ˆë‹¤.
    <ul>
      <li>blue ë²„ì „ì´ ë°°í¬ëœ ë‹¤ìŒ green ë²„ì „ì„ ë°°í¬í• ì§€ ìŠ¹ì¸ ì—¬ë¶€ë¥¼ ë¬»ìŠµë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_24.png" alt="img.png" /></li>
      <li>ìŠ¹ì¸í•˜ë©´ green ë²„ì „ì´ ë°°í¬ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì•„ì§ íŠ¸ë˜í”½ì€ Blueë¡œë§Œ íë¦…ë‹ˆë‹¤.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get deploy <span class="nt">-owide</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> kubectl get svc,ep echo-server-service <span class="nt">-owide</span>
<span class="c"># =&gt; Hello from Blue</span>
<span class="c">#    </span>
<span class="c">#    NAME                READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS    IMAGES                SELECTOR</span>
<span class="c">#    echo-server-blue    2/2     2            2           3m46s   echo-server   hashicorp/http-echo   app=echo-server,version=blue</span>
<span class="c">#    echo-server-green   2/2     2            2           31s     echo-server   hashicorp/http-echo   app=echo-server,version=green</span>
<span class="c">#    </span>
<span class="c">#    NAME                          TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE     SELECTOR</span>
<span class="c">#    service/echo-server-service   NodePort   10.96.40.148   &amp;lt;none&amp;gt;        80:30000/TCP   3m45s   app=echo-server,version=blue</span>
<span class="c">#    </span>
<span class="c">#    NAME                            ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/echo-server-service   10.244.1.8:5678,10.244.2.8:5678   3m45s</span>
</code></pre></div>        </div>
      </li>
      <li>greenìœ¼ë¡œ ë°°í¬í• ì§€ ìŠ¹ì¸í•˜ë©´ ë§ˆì¹¨ë‚´ greenìœ¼ë¡œ íŠ¸ë˜í”½ì´ ì „ë‹¬ ë©ë‹ˆë‹¤. 
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_25.png" alt="img.png" />
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get deploy <span class="nt">-owide</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> kubectl get svc,ep echo-server-service <span class="nt">-owide</span>
<span class="c"># =&gt; Hello from Green</span>
<span class="c">#    </span>
<span class="c">#    NAME                READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS    IMAGES                SELECTOR</span>
<span class="c">#    echo-server-blue    2/2     2            2           6m14s   echo-server   hashicorp/http-echo   app=echo-server,version=blue</span>
<span class="c">#    echo-server-green   2/2     2            2           2m59s   echo-server   hashicorp/http-echo   app=echo-server,version=green</span>
<span class="c">#    </span>
<span class="c">#    NAME                          TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE     SELECTOR</span>
<span class="c">#    service/echo-server-service   NodePort   10.96.40.148   &amp;lt;none&amp;gt;        80:30000/TCP   6m13s   app=echo-server,version=green</span>
<span class="c">#    </span>
<span class="c">#    NAME                            ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/echo-server-service   10.244.1.9:5678,10.244.2.9:5678   6m13s</span>
</code></pre></div>        </div>
      </li>
      <li>ë§ˆì§€ë§‰ìœ¼ë¡œ blueë¥¼ ë¡¤ë°±í• ì§€ ë¬¼ìœ¼ë©°, ìŠ¹ì¸í•˜ë©´ blueê°€ ì‚­ì œ ë©ë‹ˆë‹¤.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># =&gt; Hello from Green</span>
<span class="c">#    </span>
<span class="c">#    NAME                READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS    IMAGES                SELECTOR</span>
<span class="c">#    echo-server-green   2/2     2            2           4m55s   echo-server   hashicorp/http-echo   app=echo-server,version=green</span>
<span class="c">#    </span>
<span class="c">#    NAME                          TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE    SELECTOR</span>
<span class="c">#    service/echo-server-service   NodePort   10.96.40.148   &amp;lt;none&amp;gt;        80:30000/TCP   8m9s   app=echo-server,version=green</span>
<span class="c">#    </span>
<span class="c">#    NAME                            ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/echo-server-service   10.244.1.9:5678,10.244.2.9:5678   8m9s</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>ì‹¤ìŠµ ì™„ë£Œ í›„ ì‚­ì œ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete deploy echo-server-blue echo-server-green
<span class="nv">$ </span>kubectl delete svc echo-server-service
</code></pre></div></div>

<h3 id="jenkins-ci--argocd--k8s-kind">Jenkins CI + ArgoCD + K8S (Kind)</h3>

<h4 id="argocd-ì†Œê°œ">ArgoCD ì†Œê°œ</h4>

<ul>
  <li>ArgoCDëŠ” GitOpsë¥¼ ì§€ì›í•˜ëŠ” CD ë„êµ¬ë¡œ, Kubernetes í´ëŸ¬ìŠ¤í„°ì— ë°°í¬ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìƒíƒœë¥¼ ì§€ì†ì ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ê³ ,
Git ì €ì¥ì†Œì— ì •ì˜ëœ ìƒíƒœì™€ ì‹¤ì œ ìƒíƒœê°€ ì¼ì¹˜í•˜ì§€ ì•Šì„ ê²½ìš° ìë™ìœ¼ë¡œ ë™ê¸°í™”í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì›í•˜ëŠ” ìƒíƒœë¡œ ìœ ì§€í•˜ëŠ” íˆ´ì…ë‹ˆë‹¤.</li>
  <li>ArgoCDì˜ ì•„í‚¤í…ì³
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_26.png" alt="img.png" /></li>
  <li>ArgoCDëŠ” ë°°í¬ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìƒíƒœì¸ Kubernetes manifestë¥¼ ë‹¤ìŒì˜ ë°©ì‹ë“¤ë¡œ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li><a href="https://kustomize.io/">Kustomize</a> ì• í”Œë¦¬ì¼€ì´ì…˜</li>
      <li><a href="https://helm.sh/">helm</a> chart</li>
      <li><a href="https://jsonnet.org/">jsonnet</a> íŒŒì¼</li>
      <li>yaml/json manifest íŒŒì¼ì´ ìˆëŠ” ë””ë ‰í„°ë¦¬</li>
      <li>ê¸°íƒ€ config management pluginì—ì„œ ì •ì˜í•œ íŒŒì¼</li>
    </ul>
  </li>
  <li>ìì„¸í•œ ì‚¬í•­ì€ <a href="https://argoproj.github.io/">ê³µì‹ í™ˆí˜ì´ì§€</a>ë‚˜ <a href="https://malwareanalysis.tistory.com/tag/ArgoCD">ì•…ë¶„ë‹˜ ArgoCD ì •ë¦¬ ë¸”ë¡œê·¸</a>ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.</li>
</ul>

<h4 id="argocd-ì„¤ì¹˜-ë°-ê¸°ë³¸ì„¤ì •">ArgoCD ì„¤ì¹˜ ë° ê¸°ë³¸ì„¤ì •</h4>

<ul>
  <li>ArgoCDë¥¼ ì„¤ì¹˜í•˜ê³  ê¸°ë³¸ ì„¤ì •ì„ ì§„í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± ë° íŒŒë¼ë¯¸í„° íŒŒì¼ ì‘ì„±</span>
<span class="nv">$ </span>kubectl create ns argocd
<span class="c"># =&gt; namespace/argocd created</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; argocd-values.yaml
dex:
  enabled: false

server:
  service:
    type: NodePort
    nodePortHttps: 30002
</span><span class="no">EOF

</span><span class="c"># ì„¤ì¹˜</span>
<span class="nv">$ </span>helm repo add argo https://argoproj.github.io/argo-helm
<span class="c"># =&gt; &amp;quot;argo&amp;quot; has been added to your repositories</span>
<span class="nv">$ </span>helm <span class="nb">install </span>argocd argo/argo-cd <span class="nt">--version</span> 7.7.10 <span class="nt">-f</span> argocd-values.yaml <span class="nt">--namespace</span> argocd
<span class="c"># =&gt; NAME: argocd</span>
<span class="c">#    LAST DEPLOYED: Sun Oct 01 16:53:42 2024</span>
<span class="c">#    NAMESPACE: argocd</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    In order to access the server UI you have the following options:</span>
<span class="c">#    </span>
<span class="c">#    1. kubectl port-forward service/argocd-server -n argocd 8080:443</span>
<span class="c">#        and then open the browser on http://localhost:8080 and accept the certificate</span>
<span class="c">#    </span>
<span class="c">#    2. enable ingress in the values file `server.ingress.enabled` and either</span>
<span class="c">#          - Add the annotation for ssl passthrough: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-1-ssl-passthrough</span>
<span class="c">#          - Set the `configs.params.&amp;quot;server.insecure&amp;quot;` in the values file and terminate SSL at your ingress: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-2-multiple-ingress-objects-and-hosts</span>
<span class="c">#    </span>
<span class="c">#    After reaching the UI the first time you can login with username: admin and the random password generated during the installation. You can find the password by running:</span>
<span class="c">#    kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=&amp;quot;{.data.password}&amp;quot; | base64 -d</span>
<span class="c">#    (You should delete the initial secret afterwards as suggested by the Getting Started Guide: https://argo-cd.readthedocs.io/en/stable/getting_started/#4-login-using-the-cli)</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod,svc,ep <span class="nt">-n</span> argocd
<span class="c"># =&gt; NAME                                                    READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/argocd-application-controller-0                     1/1     Running   0          4m55s</span>
<span class="c">#    pod/argocd-applicationset-controller-856f6bd788-zvtd2   1/1     Running   0          4m55s</span>
<span class="c">#    pod/argocd-notifications-controller-764b9d6597-z4mrx    1/1     Running   0          4m55s</span>
<span class="c">#    pod/argocd-redis-5c67786686-qwx8f                       1/1     Running   0          4m55s</span>
<span class="c">#    pod/argocd-repo-server-c9f8b6dbf-jpjcq                  1/1     Running   0          4m55s</span>
<span class="c">#    pod/argocd-server-7bff46b6bd-7n6vx                      1/1     Running   0          4m55s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span>
<span class="c">#    service/argocd-applicationset-controller   ClusterIP   10.96.166.245   &amp;lt;none&amp;gt;        7000/TCP                     4m55s</span>
<span class="c">#    service/argocd-redis                       ClusterIP   10.96.46.103    &amp;lt;none&amp;gt;        6379/TCP                     4m55s</span>
<span class="c">#    service/argocd-repo-server                 ClusterIP   10.96.117.132   &amp;lt;none&amp;gt;        8081/TCP                     4m55s</span>
<span class="c">#    service/argocd-server                      NodePort    10.96.75.70     &amp;lt;none&amp;gt;        80:30080/TCP,443:30002/TCP   4m55s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                         ENDPOINTS                           AGE</span>
<span class="c">#    endpoints/argocd-applicationset-controller   10.244.2.13:7000                    4m55s</span>
<span class="c">#    endpoints/argocd-redis                       10.244.2.12:6379                    4m55s</span>
<span class="c">#    endpoints/argocd-repo-server                 10.244.1.11:8081                    4m55s</span>
<span class="c">#    endpoints/argocd-server                      10.244.1.10:8080,10.244.1.10:8080   4m55s</span>
<span class="nv">$ </span>kubectl get crd | <span class="nb">grep </span>argo
<span class="c"># =&gt; applications.argoproj.io      2024-10-01T07:54:01Z</span>
<span class="c">#    applicationsets.argoproj.io   2024-10-01T07:54:01Z</span>
<span class="c">#    appprojects.argoproj.io       2024-10-01T07:54:01Z</span>

<span class="c"># ìµœì´ˆ ì ‘ì† ì•”í˜¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> argocd get secret argocd-initial-admin-secret <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data.password}"</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; ZaQfvE9xrehyKxvl</span>

<span class="c"># Argo CD ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸ : ì´ˆê¸° ì•”í˜¸ ì…ë ¥ (admin ê³„ì •)</span>
<span class="nv">$ </span>open <span class="s2">"https://127.0.0.1:30002"</span> <span class="c"># macOS</span>
<span class="c">## Windows OSê²½ìš° ì§ì ‘ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ https://127.0.0.1:30002 ì ‘ì†</span>
</code></pre></div></div>

<ul>
  <li>Argo CD ì›¹ ì ‘ì† í™•ì¸ - ìœ„ì—ì„œ í™•ì¸í•œ ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_27.png" alt="img.png" class="image-center" />
<em class="image-caption">Argo CD ì›¹ ì´ˆê¸° í™”ë©´</em>
    <ul>
      <li>User Info &gt; Update passwordë¡œ admin ê³„ì • ì•”í˜¸ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤. (qwe12345)</li>
    </ul>
  </li>
  <li>Settings &gt; Clusters, Projects, Accounts ë“± ê¸°ë³¸ì •ë³´ë¥¼ í™•ì¸í•´ë´…ë‹ˆë‹¤.</li>
  <li>ì‹¤ìŠµì„ ìœ„í•´ ops-deploy Repoë¥¼ ë“±ë¡í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>Settings &gt; Repositories &gt; Connect Repo í´ë¦­
        <ul>
          <li>connection method : VIA HTTPS</li>
          <li>Type : git</li>
          <li>Project : default</li>
          <li>Repo URL : http://<PCì˜ IP="">:3000/devops/ops-deploy</PCì˜></li>
          <li>Username : devops</li>
          <li>Password : <Gogs í† í°=""></Gogs></li>
        </ul>

        <p>=&gt;  ì…ë ¥ í›„ CONNECT í´ë¦­
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_28.png" alt="img.png" /></p>
      </li>
      <li>ëª¨ë“  ì •ë³´ê°€ ì •í™•í•˜ì—¬ ì—°ê²°ì´ ë˜ë©´ ì—°ê²°ìƒíƒœê°€ Successfulë¡œ ë“±ë¡ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h4 id="helm-chartë¥¼-í†µí•œ-ë°°í¬-ì‹¤ìŠµ">Helm chartë¥¼ í†µí•œ ë°°í¬ ì‹¤ìŠµ</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">mkdir </span>nginx-chart
<span class="nv">$ </span><span class="nb">cd </span>nginx-chart

<span class="nv">$ </span><span class="nb">mkdir </span>templates

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> templates/configmap.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}
data:
  index.html: |
{{ .Values.indexHtml | indent 4 }}
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> templates/deployment.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}
    spec:
      containers:
      - name: nginx
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        ports:
        - containerPort: 80
        volumeMounts:
        - name: index-html
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
      volumes:
      - name: index-html
        configMap:
          name: {{ .Release.Name }}
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> templates/service.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}
spec:
  selector:
    app: {{ .Release.Name }}
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
    nodePort: 30000
  type: NodePort
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> values.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;Nginx version 1.26.1&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: 1.26.1

replicaCount: 1
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Chart.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v2
name: nginx-chart
description: A Helm chart for deploying Nginx with custom index.html
type: application
version: 1.0.0
appVersion: "1.26.1"
</span><span class="no">EOF

</span><span class="c"># ì´ì „ timeserver/service(nodeport) ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete deploy,svc <span class="nt">--all</span>

<span class="c"># ì§ì ‘ ë°°í¬ í•´ë³´ê¸°</span>
<span class="nv">$ </span>helm <span class="nb">install </span>dev-nginx <span class="nb">.</span> <span class="nt">-f</span> values.yaml
<span class="c"># =&gt; NAME: dev-nginx</span>
<span class="c">#    LAST DEPLOYED: Sun Oct 01 19:54:23 2024</span>
<span class="c">#    NAMESPACE: default</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="nv">$ </span>helm list
<span class="c"># =&gt; NAME       NAMESPACE REVISION  UPDATED                             STATUS    CHART             APP VERSION</span>
<span class="c">#    dev-nginx  default   1         2024-10-01 19:54:23.03644 +0900 KST deployed  nginx-chart-1.0.0 1.26.1     </span>
<span class="nv">$ </span>kubectl get deploy,svc,ep,cm dev-nginx <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                        READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR</span>
<span class="c">#    deployment.apps/dev-nginx   1/1     1            1           4s    nginx        nginx:1.26.1   app=dev-nginx</span>
<span class="c">#    </span>
<span class="c">#    NAME                TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span>
<span class="c">#    service/dev-nginx   NodePort   10.96.79.233   &amp;lt;none&amp;gt;        80:30000/TCP   4s    app=dev-nginx</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS        AGE</span>
<span class="c">#    endpoints/dev-nginx   10.244.1.16:80   4s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  DATA   AGE</span>
<span class="c">#    configmap/dev-nginx   1      4s</span>

<span class="c">#</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; &lt;!DOCTYPE html&amp;gt;</span>
<span class="c">#    &amp;lt;html&amp;gt;</span>
<span class="c">#    &amp;lt;head&amp;gt;</span>
<span class="c">#      &amp;lt;title&amp;gt;Welcome to Nginx!&amp;lt;/title&amp;gt;</span>
<span class="c">#    &amp;lt;/head&amp;gt;</span>
<span class="c">#    &amp;lt;body&amp;gt;</span>
<span class="c">#      &amp;lt;h1&amp;gt;Hello, Kubernetes!&amp;lt;/h1&amp;gt;</span>
<span class="c">#      &amp;lt;p&amp;gt;Nginx version 1.26.1&amp;lt;/p&amp;gt;</span>
<span class="c">#    &amp;lt;/body&amp;gt;</span>
<span class="c">#    &amp;lt;/html&amp;gt;</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> http://127.0.0.1:30000 | <span class="nb">grep </span>version
<span class="c"># =&gt;   &amp;lt;p&amp;gt;Nginx version 1.26.1&amp;lt;/p&amp;gt;</span>
<span class="nv">$ </span>open http://127.0.0.1:30000

<span class="c"># value ê°’ ë³€ê²½ í›„ ì ìš© í•´ë³´ê¸° : version/tag, replicaCount</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> values.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;Nginx version 1.26.2&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: 1.26.2

replicaCount: 2
</span><span class="no">EOF

</span><span class="c"># helm chart ì—…ê·¸ë ˆì´ë“œ ì ìš©</span>
<span class="nv">$ </span>helm upgrade dev-nginx <span class="nb">.</span> <span class="nt">-f</span> values.yaml
<span class="c"># =&gt; Release &amp;quot;dev-nginx&amp;quot; has been upgraded. Happy Helming!</span>
<span class="c">#    NAME: dev-nginx</span>
<span class="c">#    LAST DEPLOYED: Sun Oct 01 19:56:59 2024</span>
<span class="c">#    NAMESPACE: default</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 2</span>
<span class="c">#    TEST SUITE: None</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>helm list
<span class="c"># =&gt; NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION</span>
<span class="c">#    dev-nginx       default         2               2024-10-01 19:56:59.30731 +0900 KST     deployed        nginx-chart-1.0.0       1.26.1</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep,cm dev-nginx <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                        READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR</span>
<span class="c">#    deployment.apps/dev-nginx   &lt;span style="color: red;"&gt;2/2     2            2&lt;/span&gt;           38s   nginx        &lt;span style="color: red;"&gt;nginx:1.26.2&lt;/span&gt;   app=dev-nginx</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ Replicaê°€ 2ê°œë¡œ ëŠ˜ì–´ë‚˜ì„œ íŒŒë“œê°€ 2ê°œê°€ ë˜ì—ˆê³  ë²„ì „ 1.26.2ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; &amp;lt;!DOCTYPE html&amp;gt;</span>
<span class="c">#    &amp;lt;html&amp;gt;</span>
<span class="c">#    &amp;lt;head&amp;gt;</span>
<span class="c">#      &amp;lt;title&amp;gt;Welcome to Nginx!&amp;lt;/title&amp;gt;</span>
<span class="c">#    &amp;lt;/head&amp;gt;</span>
<span class="c">#    &amp;lt;body&amp;gt;</span>
<span class="c">#      &amp;lt;h1&amp;gt;Hello, Kubernetes!&amp;lt;/h1&amp;gt;</span>
<span class="c">#      &amp;lt;p&amp;gt;Nginx version 1.26.2&amp;lt;/p&amp;gt;</span>
<span class="c">#    &amp;lt;/body&amp;gt;</span>
<span class="c">#    &amp;lt;/html&amp;gt;</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> http://127.0.0.1:30000 | <span class="nb">grep </span>version
<span class="c"># =&gt;   &amp;lt;p&amp;gt;Nginx version 1.26.2&amp;lt;/p&amp;gt;</span>
<span class="nv">$ </span>open http://127.0.0.1:30000

<span class="c"># í™•ì¸ í›„ ì‚­ì œ</span>
<span class="nv">$ </span>helm uninstall dev-nginx
</code></pre></div></div>

<h5 id="repoops-deploy-ì—-nginx-helm-chart-ë¥¼-argo-cdë¥¼-í†µí•œ-ë°°í¬-1">Repo(ops-deploy) ì— nginx helm chart ë¥¼ Argo CDë¥¼ í†µí•œ ë°°í¬ 1</h5>

<ul>
  <li>git ì‘ì—…</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">mkdir </span>cicd-labs
<span class="nv">$ </span><span class="nb">cd </span>cicd-labs
<span class="nv">$ </span>git clone http://10.0.4.3:3000/devops/ops-deploy.git
<span class="c"># =&gt; Cloning into 'ops-deploy'...</span>
<span class="c">#    remote: Enumerating objects: 3, done.</span>
<span class="c">#    remote: Counting objects: 100% (3/3), done.</span>
<span class="c">#    remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    Unpacking objects: 100% (3/3), 228 bytes | 114.00 KiB/s, done.</span>
<span class="nv">$ </span><span class="nb">cd </span>ops-deploy

<span class="c">#</span>
<span class="nv">$ </span>git config user.name <span class="s2">"devops"</span>
<span class="nv">$ </span>git config user.email <span class="s2">"a@a.com"</span>
<span class="nv">$ </span>git config init.defaultBranch main
<span class="nv">$ </span>git config credential.helper store

<span class="c">#</span>
<span class="nv">$ VERSION</span><span class="o">=</span>1.26.1
<span class="nv">$ </span><span class="nb">mkdir </span>nginx-chart
<span class="nv">$ </span><span class="nb">mkdir </span>nginx-chart/templates

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/VERSION <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
</span><span class="nv">$VERSION</span><span class="sh">
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/templates/configmap.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: ConfigMap
metadata:
  name: 
data:
  index.html: |
</span><span class="no">
EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/templates/deployment.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: 
spec:
  replicas: 
  selector:
    matchLabels:
      app: 
  template:
    metadata:
      labels:
        app: 
    spec:
      containers:
      - name: nginx
        image: :
        ports:
        - containerPort: 80
        volumeMounts:
        - name: index-html
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
      volumes:
      - name: index-html
        configMap:
          name: 
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/templates/service.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Service
metadata:
  name: 
spec:
  selector:
    app: 
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
    nodePort: 30000
  type: NodePort
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/values-dev.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;DEV : Nginx version </span><span class="nv">$VERSION</span><span class="sh">&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: </span><span class="nv">$VERSION</span><span class="sh">

replicaCount: 1
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/values-prd.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;PRD : Nginx version </span><span class="nv">$VERSION</span><span class="sh">&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: </span><span class="nv">$VERSION</span><span class="sh">

replicaCount: 2
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/Chart.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v2
name: nginx-chart
description: A Helm chart for deploying Nginx with custom index.html
type: application
version: 1.0.0
appVersion: "</span><span class="nv">$VERSION</span><span class="sh">"
</span><span class="no">EOF

</span><span class="nv">$ </span>tree nginx-chart
<span class="c"># =&gt; nginx-chart</span>
<span class="c">#    â”œâ”€â”€ Chart.yaml</span>
<span class="c">#    â”œâ”€â”€ VERSION</span>
<span class="c">#    â”œâ”€â”€ templates</span>
<span class="c">#    â”‚   â”œâ”€â”€ configmap.yaml</span>
<span class="c">#    â”‚   â”œâ”€â”€ deployment.yaml</span>
<span class="c">#    â”‚   â””â”€â”€ service.yaml</span>
<span class="c">#    â”œâ”€â”€ values-dev.yaml</span>
<span class="c">#    â””â”€â”€ values-prd.yaml</span>

<span class="c">#</span>
<span class="nv">$ </span>git status <span class="o">&amp;&amp;</span> git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Add nginx helm chart"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; On branch main</span>
<span class="c">#    Your branch is up to date with 'origin/main'.</span>
<span class="c">#    </span>
<span class="c">#    Untracked files:</span>
<span class="c">#      (use &amp;quot;git add &amp;lt;file&amp;gt;...&amp;quot; to include in what will be committed)</span>
<span class="c">#            nginx-chart/</span>
<span class="c">#    </span>
<span class="c">#    nothing added to commit but untracked files present (use &amp;quot;git add&amp;quot; to track)</span>
<span class="c">#    [main 2bcfda2] Add nginx helm chart</span>
<span class="c">#     7 files changed, 88 insertions(+)</span>
<span class="c">#     create mode 100644 nginx-chart/Chart.yaml</span>
<span class="c">#     create mode 100644 nginx-chart/VERSION</span>
<span class="c">#     create mode 100644 nginx-chart/templates/configmap.yaml</span>
<span class="c">#     create mode 100644 nginx-chart/templates/deployment.yaml</span>
<span class="c">#     create mode 100644 nginx-chart/templates/service.yaml</span>
<span class="c">#     create mode 100644 nginx-chart/values-dev.yaml</span>
<span class="c">#     create mode 100644 nginx-chart/values-prd.yaml</span>
<span class="c">#    Enumerating objects: 12, done.</span>
<span class="c">#    Counting objects: 100% (12/12), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (10/10), done.</span>
<span class="c">#    Writing objects: 100% (11/11), 1.44 KiB | 1.44 MiB/s, done.</span>
<span class="c">#    Total 11 (delta 1), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/ops-deploy.git</span>
<span class="c">#       f7dc047..2bcfda2  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_29.png" alt="img.png" /></p>

<h5 id="argo-cdì—-app-ë“±ë¡">Argo CDì— App ë“±ë¡</h5>

<ul>
  <li>ArgoCDì—ì„œ Application &gt; New Appì„ í´ë¦­í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë“±ë¡í•©ë‹ˆë‹¤.
    <ul>
      <li>GENERAL
        <ul>
          <li>App Name : dev-nginx</li>
          <li>Project Name : default</li>
          <li>SYNC POLICY : Manual</li>
          <li>SYNC OPTIONS : AUTO-CREATE NAMESPACE(Check)</li>
        </ul>
      </li>
      <li>Source
        <ul>
          <li>Repo URL : <code class="language-plaintext highlighter-rouge">&lt;ì„¤ì •ë˜ì–´ ìˆëŠ” ê²ƒ ì„ íƒ&gt;</code> (http://10.0.4.3:3000/devops/ops-deploy)</li>
          <li>Revision : HEAD</li>
          <li>PATH : nginx-chart</li>
        </ul>
      </li>
      <li>DESTINATION
        <ul>
          <li>Cluster URL : <code class="language-plaintext highlighter-rouge">&lt;ê¸°ë³¸ê°’&gt;</code></li>
          <li>NAMESPACE : dev-nginx</li>
        </ul>
      </li>
      <li>HELM
        <ul>
          <li>Values files : values-dev.yaml 
=&gt; ì‘ì„± í›„ ìƒë‹¨ CREATE í´ë¦­</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_30.png" alt="img.png" class="image-center" />
<em class="image-caption">Argo CD Application ë“±ë¡ ì§í›„</em></p>

<ul>
  <li>ë“±ë¡ ì§í›„ì—ëŠ” gitì— ë“±ë¡ëœ manifest íŒŒì¼ì˜ ë‚´ìš©ê³¼ í˜„ì¬ k8sì˜ ìƒíƒœê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— <code class="language-plaintext highlighter-rouge">OutOfSync</code> ìƒíƒœë¡œ í‘œì‹œë©ë‹ˆë‹¤.</li>
  <li>dev-nginxë¥¼ í´ë¦­í•´ì„œ ë³´ë©´ ë¦¬ì†ŒìŠ¤ì˜ ë°°ì¹˜ì™€ ì–´ë–¤ ë¦¬ì†ŒìŠ¤ê°€ <code class="language-plaintext highlighter-rouge">OutOfSync</code>ì¸ì§€ í‘œì‹œê°€ ë©ë‹ˆë‹¤.</li>
  <li>ë‹¤ìŒ ëª…ë ¹ì„ ì…ë ¥í•´ì„œ applicationì˜ ë°°í¬ìƒíƒœë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd
<span class="c"># =&gt; NAME        SYNC STATUS   HEALTH STATUS</span>
<span class="c">#    dev-nginx   OutOfSync     Missing</span>

<span class="nv">$ </span>kubectl describe applications <span class="nt">-n</span> argocd dev-nginx
<span class="c"># =&gt; ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason           Age    From                           Message</span>
<span class="c">#      ----    ------           ----   ----                           -------</span>
<span class="c">#      Normal  ResourceCreated  7m38s  argocd-server                  admin created application</span>
<span class="c">#      Normal  ResourceUpdated  7m     argocd-application-controller  Updated sync status:  -&amp;gt; Unknown</span>
<span class="c">#      Normal  ResourceUpdated  6m58s  argocd-application-controller  Updated health status:  -&amp;gt; Healthy</span>
<span class="c">#      Normal  ResourceUpdated  3m35s  argocd-application-controller  Updated sync status: Unknown -&amp;gt; OutOfSync</span>
<span class="c">#      Normal  ResourceUpdated  3m35s  argocd-application-controller  Updated health status: Healthy -&amp;gt; Missing</span>

<span class="c"># ë°˜ë³µ ì ‘ì† ì‹œë„</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 <span class="p">;</span> <span class="nb">date</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>ArgoCDì—ì„œ DIFF ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í˜„ì¬ ìƒíƒœì™€ gitì— ë“±ë¡ëœ ìƒíƒœë¥¼ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_31.png" alt="img.png" class="image-center" />
<em class="image-caption">Argo CD Application DIFF í™”ë©´</em></li>
  <li>SYNC ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ gitì˜ manifestì— ì§€ì •ëœ ìƒíƒœì™€ k8sì˜ ìƒíƒœë¥¼ ë™ê¸°í™” í•´ë³´ê² ìŠµë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_32.png" alt="img.png" /></li>
  <li>ë™ê¸°í™”ê°€ ì™„ë£Œë˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë…¸ë€ìƒ‰ í™”ì‚´í‘œ ì•„ì´ì½˜ ëŒ€ì‹  ë…¹ìƒ‰ ì²´í¬í‘œì‹œê°€ ë‚˜ë©´ì„œ <code class="language-plaintext highlighter-rouge">Synced</code> ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤. 
ë˜í•œ ë™ì‹œì— Kubernetesì— NGINXê°€ ë°°í¬ê°€ ì˜ ë˜ì—ˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_33.png" alt="img.png" class="image-center" />
<em class="image-caption">Argo CD Application ë™ê¸°í™” ì™„ë£Œ</em></li>
</ul>

<h5 id="ì½”ë“œ-ìˆ˜ì •-í›„-ë°˜ì˜-í™•ì¸">ì½”ë“œ ìˆ˜ì • í›„ ë°˜ì˜ í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ VERSION</span><span class="o">=</span>1.26.2

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/VERSION <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
</span><span class="nv">$VERSION</span><span class="sh">
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/values-dev.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;DEV : Nginx version </span><span class="nv">$VERSION</span><span class="sh">&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: </span><span class="nv">$VERSION</span><span class="sh">

replicaCount: 2
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/values-prd.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;PRD : Nginx version </span><span class="nv">$VERSION</span><span class="sh">&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: </span><span class="nv">$VERSION</span><span class="sh">

replicaCount: 2
</span><span class="no">EOF

</span><span class="c">#</span>
<span class="nv">$ </span>git status <span class="o">&amp;&amp;</span> git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Update nginx version </span><span class="si">$(</span><span class="nb">cat </span>nginx-chart/VERSION<span class="si">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; On branch main</span>
<span class="c">#    Your branch is up to date with 'origin/main'.</span>
<span class="c">#    </span>
<span class="c">#    Changes not staged for commit:</span>
<span class="c">#      (use &amp;quot;git add &amp;lt;file&amp;gt;...&amp;quot; to update what will be committed)</span>
<span class="c">#      (use &amp;quot;git restore &amp;lt;file&amp;gt;...&amp;quot; to discard changes in working directory)</span>
<span class="c">#            modified:   nginx-chart/VERSION</span>
<span class="c">#            modified:   nginx-chart/values-dev.yaml</span>
<span class="c">#            modified:   nginx-chart/values-prd.yaml</span>
<span class="c">#    </span>
<span class="c">#    no changes added to commit (use &amp;quot;git add&amp;quot; and/or &amp;quot;git commit -a&amp;quot;)</span>
<span class="c">#    [main e1b02a2] Update nginx version 1.26.2</span>
<span class="c">#     3 files changed, 6 insertions(+), 6 deletions(-)</span>
<span class="c">#    Enumerating objects: 11, done.</span>
<span class="c">#    Counting objects: 100% (11/11), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (5/5), done.</span>
<span class="c">#    Writing objects: 100% (6/6), 589 bytes | 589.00 KiB/s, done.</span>
<span class="c">#    Total 6 (delta 2), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/ops-deploy.git</span>
<span class="c">#       2bcfda2..e1b02a2  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div></div>

<ul>
  <li>Argo CD ì›¹ í™•ì¸ =&gt; REFRESH í´ë¦­
    <ul>
      <li>ArgoCDëŠ” ì£¼ê¸°ì ìœ¼ë¡œ ë™ê¸°í™” ë˜ë‚˜ ë°”ë¡œ í™•ì¸í•˜ë ¤ë©´ REFRESH ë²„íŠ¼ì„ í´ë¦­í•´ì•¼ í•©ë‹ˆë‹¤. (ê¸°ë³¸ ì£¼ê¸°ëŠ” 3ë¶„)
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_34.png" alt="img.png" class="image-center" /></li>
      <li>DIFFë¡œ í™•ì¸í•˜ë©´ manifest íŒŒì¼ì˜ ë³€ê²½ì‚¬í•­ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_35.png" alt="img.png" class="image-center" /></li>
    </ul>
  </li>
  <li>SYNC &gt; SYNCHRONIZEë¥¼ í´ë¦­í•˜ì—¬ ë™ê¸°í™” í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬í™•ì¸</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> dev-nginx <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE   IP           NODE            NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/dev-nginx-5db658bd4f-nfldn   1/1     Running   0          8s    10.244.1.7   myk8s-worker    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/dev-nginx-5db658bd4f-rxmfz   1/1     Running   0          10s   10.244.2.6   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span>
<span class="c">#    service/dev-nginx   NodePort   10.96.233.99   &amp;lt;none&amp;gt;        80:30000/TCP   16m   app=dev-nginx</span>
<span class="c">#    </span>
<span class="c">#    NAME                        READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR</span>
<span class="c">#    deployment.apps/dev-nginx   2/2     2            2           16m   nginx        &lt;span style="color: red;"&gt;nginx:1.26.2&lt;/span&gt;   app=dev-nginx</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë³€ê²½ëœ ë²„ì „ì´ ì˜ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                                   DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR</span>
<span class="c">#    replicaset.apps/dev-nginx-5db658bd4f   2         2         2       11s   nginx        nginx:1.26.2   app=dev-nginx,pod-template-hash=5db658bd4f</span>
<span class="c">#    replicaset.apps/dev-nginx-77d44dfbf6   0         0         0       16m   nginx        nginx:1.26.1   app=dev-nginx,pod-template-hash=77d44dfbf6</span>
</code></pre></div>    </div>
  </li>
  <li>ì—¬ê¸°ì—ì„œ replicasetì€ ê¸°ì¡´ 1.26.1ì´ ë‚¨ì•„ìˆëŠ”ë° ê·¸ê²ƒì€ ArgoCDê°€ Rollbackì„ ì§€ì›í•˜ê¸° ìœ„í•´ ê¸°ì¡´ replicasetì„ ë‚¨ê²¨ì„œ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
  <li>ëª‡ê°œì˜ historyë¥¼ ë‚¨ê¸¸ì§€ëŠ” ì„¤ì •ì—ì„œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ArgoCDì›¹ ì—ì„œ APP ì‚­ì œí•˜ê³  ì•„ë˜ì˜ ëª…ë ¹ìœ¼ë¡œ ì‚­ì œ ì§„í–‰ìƒí™©ì„ í™•ì¸í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get all <span class="nt">-n</span> dev-nginx <span class="nt">-o</span> wide
</code></pre></div></div>

<h4 id="argocd-declarative-setupìœ¼ë¡œ-ë°°í¬-ì‹¤ìŠµ">ArgoCD Declarative Setupìœ¼ë¡œ ë°°í¬ ì‹¤ìŠµ</h4>

<ul>
  <li>ì´ë²ˆì—ëŠ” ArgoCD ì• í”Œë¦¬ì¼€ì´ì…˜ ìì²´ë¥¼ yamlë¡œ ìƒì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìƒì„±í•˜ê³  ë°°í¬í•˜ëŠ” ê³¼ì •ì„ ìë™í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ìì„¸í•œ ì‚¬í•­ì€ ë‹¤ìŒ ê³µì‹ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì„¸ìš”. <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/">ArgoCD Declarative Setup - Project, applications, ArgoCD Settings - Docs</a></li>
  <li>dev-nginx App ìƒì„± ë° Auto SYNC</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Declarative ë°©ì‹ìœ¼ë¡œ ArgoCD App ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: dev-nginx
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    helm:
      valueFiles:
      - values-dev.yaml
    path: nginx-chart
    repoURL: http://10.0.4.3:3000/devops/ops-deploy
    targetRevision: HEAD
  syncPolicy:
    automated:
      prune: true
    syncOptions:
    - CreateNamespace=true
  destination:
    namespace: dev-nginx
    server: https://kubernetes.default.svc
</span><span class="no">EOF
</span><span class="c"># =&gt; application.argoproj.io/dev-nginx created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd dev-nginx
<span class="c"># =&gt; NAME        SYNC STATUS   HEALTH STATUS</span>
<span class="c">#    dev-nginx   Synced        Healthy</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ automated sync ì •ì±…ì´ì–´ì„œ ë°°í¬ ì§í›„ ë™ê¸°í™” ëœ ìƒíƒœê°€ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd dev-nginx <span class="nt">-o</span> yaml | kubectl neat
<span class="nv">$ </span>kubectl describe applications <span class="nt">-n</span> argocd dev-nginx
<span class="c"># =&gt; ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason              Age   From                           Message</span>
<span class="c">#      ----    ------              ----  ----                           -------</span>
<span class="c">#      Normal  ResourceUpdated     80s   argocd-application-controller  Updated sync status:  -&amp;gt; Unknown</span>
<span class="c">#      Normal  ResourceUpdated     80s   argocd-application-controller  Updated health status:  -&amp;gt; Healthy</span>
<span class="c">#      Normal  OperationStarted    57s   argocd-application-controller  Initiated automated sync to 'e1b02a29e47a839ebcc93e46ee9da1f2d5320148'</span>
<span class="c">#      Normal  ResourceUpdated     57s   argocd-application-controller  Updated sync status: Unknown -&amp;gt; OutOfSync</span>
<span class="c">#      Normal  ResourceUpdated     57s   argocd-application-controller  Updated health status: Healthy -&amp;gt; Missing</span>
<span class="c">#      Normal  ResourceUpdated     57s   argocd-application-controller  Updated sync status: OutOfSync -&amp;gt; Synced</span>
<span class="c">#      Normal  ResourceUpdated     57s   argocd-application-controller  Updated health status: Missing -&amp;gt; Progressing</span>
<span class="c">#      Normal  OperationCompleted  57s   argocd-application-controller  Sync operation to e1b02a29e47a839ebcc93e46ee9da1f2d5320148 succeeded</span>
<span class="c">#      Normal  ResourceUpdated     55s   argocd-application-controller  Updated health status: Progressing -&amp;gt; Healthy</span>
<span class="nv">$ </span>kubectl get pod,svc,ep,cm <span class="nt">-n</span> dev-nginx
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/dev-nginx-5db658bd4f-blcr6   1/1     Running   0          74s</span>
<span class="c">#    pod/dev-nginx-5db658bd4f-k984k   1/1     Running   0          74s</span>
<span class="c">#    </span>
<span class="c">#    NAME                TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/dev-nginx   NodePort   10.96.176.134   &amp;lt;none&amp;gt;        80:30000/TCP   74s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS                     AGE</span>
<span class="c">#    endpoints/dev-nginx   10.244.1.8:80,10.244.2.8:80   74s</span>
<span class="c">#    </span>
<span class="c">#    NAME                         DATA   AGE</span>
<span class="c">#    configmap/dev-nginx          1      74s</span>
<span class="c">#    configmap/kube-root-ca.crt   1      24m</span>

<span class="c">#</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; &amp;lt;!DOCTYPE html&amp;gt;</span>
<span class="c">#    &amp;lt;html&amp;gt;</span>
<span class="c">#    &amp;lt;head&amp;gt;</span>
<span class="c">#      &amp;lt;title&amp;gt;Welcome to Nginx!&amp;lt;/title&amp;gt;</span>
<span class="c">#    &amp;lt;/head&amp;gt;</span>
<span class="c">#    &amp;lt;body&amp;gt;</span>
<span class="c">#      &amp;lt;h1&amp;gt;Hello, Kubernetes!&amp;lt;/h1&amp;gt;</span>
<span class="c">#      &amp;lt;p&amp;gt;DEV : Nginx version 1.26.2&amp;lt;/p&amp;gt;</span>
<span class="c">#    &amp;lt;/body&amp;gt;</span>
<span class="c">#    &amp;lt;/html&amp;gt;</span>
<span class="nv">$ </span>open http://127.0.0.1:30000

<span class="c"># Argo CD App ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete applications <span class="nt">-n</span> argocd dev-nginx
<span class="c"># =&gt; application.argoproj.io &amp;quot;dev-nginx&amp;quot; deleted</span>
</code></pre></div></div>

<ul>
  <li>prd-nginx App ìƒì„± ë° Auto SYNC</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prd-nginx
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: prd-nginx
    server: https://kubernetes.default.svc
  project: default
  source:
    helm:
      valueFiles:
      - values-prd.yaml
    path: nginx-chart
    repoURL: http://10.0.4.3:3000/devops/ops-deploy
    targetRevision: HEAD
  syncPolicy:
    automated:
      prune: true
    syncOptions:
    - CreateNamespace=true
</span><span class="no">EOF
</span><span class="c"># =&gt; application.argoproj.io/prd-nginx created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd prd-nginx
<span class="c"># =&gt; NAME        SYNC STATUS   HEALTH STATUS</span>
<span class="c">#    prd-nginx   Synced        Healthy</span>
<span class="nv">$ </span>kubectl describe applications <span class="nt">-n</span> argocd prd-nginx
<span class="c"># =&gt; ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason              Age   From                           Message</span>
<span class="c">#      ----    ------              ----  ----                           -------</span>
<span class="c">#      Normal  ResourceUpdated     28s   argocd-application-controller  Updated sync status:  -&amp;gt; Unknown</span>
<span class="c">#      Normal  ResourceUpdated     28s   argocd-application-controller  Updated health status:  -&amp;gt; Healthy</span>
<span class="c">#      Normal  OperationStarted    18s   argocd-application-controller  Initiated automated sync to 'e1b02a29e47a839ebcc93e46ee9da1f2d5320148'</span>
<span class="c">#      Normal  ResourceUpdated     18s   argocd-application-controller  Updated sync status: Unknown -&amp;gt; OutOfSync</span>
<span class="c">#      Normal  ResourceUpdated     18s   argocd-application-controller  Updated health status: Healthy -&amp;gt; Missing</span>
<span class="c">#      Normal  ResourceUpdated     15s   argocd-application-controller  Updated sync status: OutOfSync -&amp;gt; Synced</span>
<span class="c">#      Normal  ResourceUpdated     15s   argocd-application-controller  Updated health status: Missing -&amp;gt; Progressing</span>
<span class="c">#      Normal  OperationCompleted  15s   argocd-application-controller  Sync operation to e1b02a29e47a839ebcc93e46ee9da1f2d5320148 succeeded</span>
<span class="c">#      Normal  ResourceUpdated     13s   argocd-application-controller  Updated health status: Progressing -&amp;gt; Healthy</span>
<span class="nv">$ </span>kubectl get pod,svc,ep,cm <span class="nt">-n</span> prd-nginx
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/prd-nginx-645b5ffbbf-9jp6g   1/1     Running   0          45s</span>
<span class="c">#    pod/prd-nginx-645b5ffbbf-ch6q2   1/1     Running   0          45s</span>
<span class="c">#    </span>
<span class="c">#    NAME                TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/prd-nginx   NodePort   10.96.206.18   &amp;lt;none&amp;gt;        80:30000/TCP   45s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS                     AGE</span>
<span class="c">#    endpoints/prd-nginx   10.244.1.9:80,10.244.2.9:80   45s</span>
<span class="c">#    </span>
<span class="c">#    NAME                         DATA   AGE</span>
<span class="c">#    configmap/kube-root-ca.crt   1      47s</span>
<span class="c">#    configmap/prd-nginx          1      45s</span>

<span class="c">#</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; &amp;lt;!DOCTYPE html&amp;gt;</span>
<span class="c">#    &amp;lt;html&amp;gt;</span>
<span class="c">#    &amp;lt;head&amp;gt;</span>
<span class="c">#      &amp;lt;title&amp;gt;Welcome to Nginx!&amp;lt;/title&amp;gt;</span>
<span class="c">#    &amp;lt;/head&amp;gt;</span>
<span class="c">#    &amp;lt;body&amp;gt;</span>
<span class="c">#      &amp;lt;h1&amp;gt;Hello, Kubernetes!&amp;lt;/h1&amp;gt;</span>
<span class="c">#      &amp;lt;p&amp;gt;PRD : Nginx version 1.26.2&amp;lt;/p&amp;gt;</span>
<span class="c">#    &amp;lt;/body&amp;gt;</span>
<span class="c">#    &amp;lt;/html&amp;gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ PRD nginxê°€ ì˜ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>open http://127.0.0.1:30000

<span class="c"># Argo CD App ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete applications <span class="nt">-n</span> argocd prd-nginx
<span class="c"># =&gt; application.argoproj.io &amp;quot;prd-nginx&amp;quot; deleted</span>
</code></pre></div></div>

<h4 id="argocdë¥¼-ì´ìš©í•œ-full-cicd-êµ¬ì„±">ArgoCDë¥¼ ì´ìš©í•œ Full CI/CD êµ¬ì„±</h4>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_36.png" alt="img.png" /></p>

<ul>
  <li>ìµœì¢…ì ìœ¼ë¡œ ìœ„ì™€ ê°™ì´ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cd </span>ops-deploy
<span class="nv">$ </span><span class="nb">mkdir </span>dev-app

<span class="c"># ë„ì»¤ ê³„ì • ì •ë³´</span>
<span class="c">#$ DHUSER=&lt;ë„ì»¤ í—ˆë¸Œ ê³„ì •&gt;</span>
<span class="nv">$ DHUSER</span><span class="o">=</span>sweetlittlebird

<span class="c"># ë²„ì „ ì •ë³´ </span>
<span class="nv">$ VERSION</span><span class="o">=</span>0.0.1

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> dev-app/VERSION <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
</span><span class="nv">$VERSION</span><span class="sh">
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> dev-app/timeserver.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: timeserver
spec:
  replicas: 2
  selector:
    matchLabels:
      pod: timeserver-pod
  template:
    metadata:
      labels:
        pod: timeserver-pod
    spec:
      containers:
      - name: timeserver-container
        image: docker.io/</span><span class="nv">$DHUSER</span><span class="sh">/dev-app:</span><span class="nv">$VERSION</span><span class="sh">
      imagePullSecrets:
      - name: dockerhub-secret
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> dev-app/service.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Service
metadata:
  name: timeserver
spec:
  selector:
    pod: timeserver-pod
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    nodePort: 30000
  type: NodePort
</span><span class="no">EOF

</span><span class="c">#</span>
<span class="nv">$ </span>git status <span class="o">&amp;&amp;</span> git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Add dev-app deployment yaml"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
</code></pre></div></div>

<ul>
  <li>ArgoCDì— app ìƒì„±</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: timeserver
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    path: dev-app
    repoURL: http://10.0.4.3:3000/devops/ops-deploy
    targetRevision: HEAD
  syncPolicy:
    automated:
      prune: true
    syncOptions:
    - CreateNamespace=true
  destination:
    namespace: default
    server: https://kubernetes.default.svc
</span><span class="no">EOF
</span><span class="c"># =&gt; application.argoproj.io/timeserver created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd timeserver
<span class="c"># =&gt; NAME         SYNC STATUS   HEALTH STATUS</span>
<span class="c">#    timeserver   Synced        Healthy</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd timeserver <span class="nt">-o</span> yaml | kubectl neat
<span class="nv">$ </span>kubectl describe applications <span class="nt">-n</span> argocd timeserver
<span class="c"># =&gt; ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason              Age   From                           Message</span>
<span class="c">#      ----    ------              ----  ----                           -------</span>
<span class="c">#      Normal  OperationStarted    23s   argocd-application-controller  Initiated automated sync to 'd64cb772abc1646bd74abbd47b688eeb6d59d65a'</span>
<span class="c">#      Normal  ResourceUpdated     23s   argocd-application-controller  Updated sync status:  -&amp;gt; OutOfSync</span>
<span class="c">#      Normal  ResourceUpdated     23s   argocd-application-controller  Updated health status:  -&amp;gt; Missing</span>
<span class="c">#      Normal  ResourceUpdated     23s   argocd-application-controller  Updated sync status: OutOfSync -&amp;gt; Synced</span>
<span class="c">#      Normal  OperationCompleted  23s   argocd-application-controller  Sync operation to d64cb772abc1646bd74abbd47b688eeb6d59d65a succeeded</span>
<span class="c">#      Normal  ResourceUpdated     23s   argocd-application-controller  Updated health status: Missing -&amp;gt; Progressing</span>
<span class="c">#      Normal  ResourceUpdated     21s   argocd-application-controller  Updated health status: Progressing -&amp;gt; Healthy</span>
<span class="nv">$ </span>kubectl get deploy,rs,pod
<span class="c"># =&gt; NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/timeserver   2/2     2            2           42s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                    DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/timeserver-549cc9bc89   2         2         2       42s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS    RESTARTS      AGE</span>
<span class="c">#    pod/curl-pod                      1/1     Running   2 (51m ago)   21h</span>
<span class="c">#    pod/timeserver-549cc9bc89-5bsfm   1/1     Running   0             42s</span>
<span class="c">#    pod/timeserver-549cc9bc89-rwcsz   1/1     Running   0             42s</span>
<span class="nv">$ </span>kubectl get svc,ep timeserver
<span class="c"># =&gt; NAME                 TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/timeserver   NodePort   10.96.45.219   &amp;lt;none&amp;gt;        80:30000/TCP   50s</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                       AGE</span>
<span class="c">#    endpoints/timeserver   10.244.1.10:80,10.244.2.10:80   50s</span>

<span class="c">#</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; The time is 12:16:57 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-5bsfm</span>
<span class="nv">$ </span>open http://127.0.0.1:30000
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_37.png" alt="img.png" /></p>

<h5 id="dev-app-repo-ì½”ë“œ-ì‘ì—…">dev-app Repo ì½”ë“œ ì‘ì—…</h5>

<ul>
  <li>dev-app Repoì— VERSION ì—…ë°ì´íŠ¸ ì‹œ =&gt; ops-deploy Repo ì— dev-app ì— íŒŒì¼ì— ë²„ì „ ì •ë³´ ì—…ë°ì´íŠ¸ ì‘ì—… ì¶”ê°€
    <ol>
      <li>ê¸°ì¡´ ë²„ì „ ì •ë³´ëŠ” VERSION íŒŒì¼ ë‚´ì— ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ë³€ìˆ˜ ì§€ì • : <code class="language-plaintext highlighter-rouge">OLDVER=$(cat dev-app/VERSION)</code></li>
      <li>ì‹ ê·œ ë²„ì „ ì •ë³´ëŠ” environment ë„ì»¤ íƒœê·¸ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ë³€ìˆ˜ ì§€ì • : <code class="language-plaintext highlighter-rouge">NEWVER=$(echo ${DOCKER_TAG})</code></li>
      <li>ì´í›„ sed ë¡œ ops-deploy Repo ì— dev-app/VERSION, timeserver.yaml 2ê°œ íŒŒì¼ì— â€˜ê¸°ì¡´ ë²„ì „â€™ â†’ â€˜ì‹ ê·œ ë²„ì „â€™ìœ¼ë¡œ ê°’ ë³€ê²½</li>
      <li>ì´í›„ ops-deploy Repo ì— git push â‡’ Argo CD app ê°€ ìµœëŒ€ 3ë¶„ ì‚¬ì´ì— ë³€ê²½ í™•ì¸ í›„ AutoSync ë¡œ ì‹ ê·œ ë²„ì „ ì—…ë°ì´íŠ¸ ì§„í–‰</li>
    </ol>
  </li>
  <li>ì•„ë˜ëŠ” dev-app ì— ìœ„ì¹˜í•œ Jenkinsfileë¡œ ì  í‚¨ìŠ¤ì— SCM-Pipeline (SCM:git) ìœ¼ë¡œ ì‚¬ìš©ë˜ê³  ìˆëŠ” íŒŒì¼ì„ ìˆ˜ì •í•´ì„œ ì‹¤ìŠµì— ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Jenkinsfile</span>
pipeline <span class="o">{</span>
    agent any
    environment <span class="o">{</span>
        DOCKER_IMAGE <span class="o">=</span> <span class="s1">'sweetlittlebird/dev-app'</span> // Docker ì´ë¯¸ì§€ ì´ë¦„
        GOGSCRD <span class="o">=</span> credentials<span class="o">(</span><span class="s1">'gogs-crd'</span><span class="o">)</span>
    <span class="o">}</span>
    stages <span class="o">{</span>
        stage<span class="o">(</span><span class="s1">'dev-app Checkout'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                 git branch: <span class="s1">'main'</span>,
                 url: <span class="s1">'http://10.0.4.3:3000/devops/dev-app.git'</span>,  // Gitì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                 credentialsId: <span class="s1">'gogs-crd'</span>  // Credentials ID
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'Read VERSION'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                script <span class="o">{</span>
                    // VERSION íŒŒì¼ ì½ê¸°
                    def version <span class="o">=</span> readFile<span class="o">(</span><span class="s1">'VERSION'</span><span class="o">)</span>.trim<span class="o">()</span>
                    <span class="nb">echo</span> <span class="s2">"Version found: </span><span class="k">${</span><span class="nv">version</span><span class="k">}</span><span class="s2">"</span>
                    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                    env.DOCKER_TAG <span class="o">=</span> version
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'Docker Build and Push'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                script <span class="o">{</span>
                    docker.withRegistry<span class="o">(</span><span class="s1">'https://index.docker.io/v1/'</span>, <span class="s1">'dockerhub-crd'</span><span class="o">)</span> <span class="o">{</span>
                        // DOCKER_TAG ì‚¬ìš©
                        def appImage <span class="o">=</span> docker.build<span class="o">(</span><span class="s2">"</span><span class="k">${</span><span class="nv">DOCKER_IMAGE</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">DOCKER_TAG</span><span class="k">}</span><span class="s2">"</span><span class="o">)</span>
                        appImage.push<span class="o">()</span>
                        appImage.push<span class="o">(</span><span class="s2">"latest"</span><span class="o">)</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'ops-deploy Checkout'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                 git branch: <span class="s1">'main'</span>,
                 url: <span class="s1">'http://10.0.4.3:3000/devops/ops-deploy.git'</span>,  // Gitì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                 credentialsId: <span class="s1">'gogs-crd'</span>  // Credentials ID
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'ops-deploy version update push'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                sh <span class="s1">'''
                OLDVER=$(cat dev-app/VERSION)
                NEWVER=$(echo ${DOCKER_TAG})
                sed -i -e "s/$OLDVER/$NEWVER/" dev-app/timeserver.yaml
                sed -i -e "s/$OLDVER/$NEWVER/" dev-app/VERSION
                git add ./dev-app
                git config user.name "devops"
                git config user.email "a@a.com"
                git commit -m "version update ${DOCKER_TAG}"
                git push http://${GOGSCRD_USR}:${GOGSCRD_PSW}@10.0.4.3:3000/devops/ops-deploy.git
                '''</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    post <span class="o">{</span>
        success <span class="o">{</span>
            <span class="nb">echo</span> <span class="s2">"Docker image </span><span class="k">${</span><span class="nv">DOCKER_IMAGE</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">DOCKER_TAG</span><span class="k">}</span><span class="s2"> has been built and pushed successfully!"</span>
        <span class="o">}</span>
        failure <span class="o">{</span>
            <span class="nb">echo</span> <span class="s2">"Pipeline failed. Please check the logs."</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ì•„ë˜ëŠ” dev-app (Repo) ì—ì„œ VERSIONê³¼ server.py ìˆ˜ì • í›„ git pushë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># VERSION íŒŒì¼ ìˆ˜ì • : 0.0.4</span>
<span class="c"># server.py íŒŒì¼ ìˆ˜ì • : 0.0.4</span>

<span class="c"># git push : VERSION, server.py, Jenkinsfile</span>
git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"VERSION </span><span class="si">$(</span><span class="nb">cat </span>VERSION<span class="si">)</span><span class="s2"> Changed"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
</code></pre></div></div>
<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_38.png" alt="img.png" /></p>

<ul>
  <li>ArgoCD ì›¹ì—ì„œ ë™ì‘ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>Jenkins Pipelineì´ ì‹¤í–‰ë˜ë©´ì„œ dev-app Repoì˜ ë²„ì „ ì •ë³´ê°€ ë³€ê²½ë˜ê³ , ops-deploy Repoì˜ dev-app/VERSION íŒŒì¼ê³¼ timeserver.yaml íŒŒì¼ì´ 
ë³€ê²½ë˜ì–´ ArgoCDê°€ ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•˜ê³  ìë™ìœ¼ë¡œ ë°°í¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</li>
  <li>REFRESH ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜ ArgoCD WebHook ì„¤ì •ì‹œ ì¦‰ì‹œ ë°˜ì˜ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_39.png" alt="img.png" /></p>

<ul>
  <li>dev-app Repoì—ì„œ ëª‡ë²ˆ ë” ë²„ì „ì„ ì—…ë°ì´íŠ¸ í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># VERSION íŒŒì¼ ìˆ˜ì • : 0.0.5</span>
<span class="c"># server.py íŒŒì¼ ìˆ˜ì • : 0.0.5</span>

<span class="c"># git push : VERSION, server.py, Jenkinsfile</span>
<span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"VERSION </span><span class="si">$(</span><span class="nb">cat </span>VERSION<span class="si">)</span><span class="s2"> Changed"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; [main 881d051] VERSION 0.0.5 Changed</span>
<span class="c">#     2 files changed, 2 insertions(+), 2 deletions(-)</span>
<span class="c">#    Enumerating objects: 7, done.</span>
<span class="c">#    Counting objects: 100% (7/7), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (3/3), done.</span>
<span class="c">#    Writing objects: 100% (4/4), 329 bytes | 329.00 KiB/s, done.</span>
<span class="c">#    Total 4 (delta 2), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/dev-app.git</span>
<span class="c">#       1d4cec2..881d051  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>

<span class="c"># ë°°í¬ ê²°ê³¼ í™•ì¸</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; The time is 12:34:14 PM, VERSION 0.0.5</span>
<span class="c">#    Server hostname: timeserver-7546694df7-wds9r</span>
</code></pre></div></div>

<ul>
  <li>CI/CDê°€ ì˜ ë™ì‘í•˜ì—¬ ìµœì‹ ë²„ì „ì´ ë°°í¬ë¨ì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h3 id="argo-rollout--k8skind">Argo Rollout + K8S(Kind)</h3>

<ul>
  <li>ArgoëŠ” ArgoCD ë¿ë§Œ ì•„ë‹ˆë¼ ë‹¤ì–‘í•œ í”„ë¡œì íŠ¸ë¥¼ ì œê³µí•˜ê³  ìˆìœ¼ë©°, ê·¸ì¤‘ì˜ í•˜ë‚˜ê°€ Argo Rolloutì…ë‹ˆë‹¤.</li>
  <li>Argo Rolloutì€ Kubernetesì˜ Deployment, StatefulSet, DaemonSet, Job, CronJob ë“±ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ëŒ€ì²´í•˜ì—¬ ë¡¤ì•„ì›ƒì„ ê´€ë¦¬í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì…ë‹ˆë‹¤.</li>
  <li>ë‹¤ìŒê³¼ ê°™ì€ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. <a href="https://argoproj.github.io/argo-rollouts/concepts/">ë¬¸ì„œ</a>
    <ul>
      <li>Blue-Green ì—…ë°ì´íŠ¸ ì „ëµ
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_40.png" alt="img.png" class="image-center" /></li>
      <li>Canary ì—…ë°ì´íŠ¸ ì „ëµ
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_41.png" alt="img_1.png" class="image-center" /></li>
      <li>ì„¸ë°€í•˜ê³  ê°€ì¤‘ì¹˜ê°€ ë¶€ì—¬ëœ íŠ¸ë˜í”½ ì „í™˜</li>
      <li>ìë™í™”ëœ ë¡¤ë°± ë° í”„ë¡œëª¨ì…˜</li>
      <li>ìˆ˜ë™ íŒë‹¨</li>
      <li>ì‚¬ìš©ì ì •ì˜ ê°€ëŠ¥í•œ ë©”íŠ¸ë¦­ ì¿¼ë¦¬ ë° ë¹„ì¦ˆë‹ˆìŠ¤ KPI ë¶„ì„</li>
      <li>ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ í†µí•©: NGINX, ALB, Apache APISIX</li>
      <li>ì„œë¹„ìŠ¤ ë©”ì‰¬ í†µí•©: Istio, Linkerd, SMI</li>
      <li>ì—¬ëŸ¬ ì œê³µìì˜ ë™ì‹œ ì‚¬ìš©: SMI + NGINX, Istio + ALB ë“±</li>
      <li>ë©”íŠ¸ë¦­ ì œê³µì í†µí•©: Prometheus, Wavefront, Kayenta, Web, Kubernetes Jobs, Datadog, New Relic, Graphite, InfluxDB</li>
    </ul>
  </li>
</ul>

<h5 id="argo-rollout-ì„¤ì¹˜-ë°-ì‹¤ìŠµ">Argo Rollout ì„¤ì¹˜ ë° ì‹¤ìŠµ</h5>

<ul>
  <li>Argo Rolloutì„ ì„¤ì¹˜í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± ë° íŒŒë¼ë¯¸í„° íŒŒì¼ ì‘ì„±</span>
<span class="nv">$ </span>kubectl create ns argo-rollouts
<span class="c"># =&gt; namespace/argo-rollouts created</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; argorollouts-values.yaml
dashboard:
  enabled: true
  service:
    type: NodePort
    nodePort: 30003
</span><span class="no">EOT

</span><span class="c"># ì„¤ì¹˜</span>
<span class="nv">$ </span>helm <span class="nb">install </span>argo-rollouts argo/argo-rollouts <span class="nt">--version</span> 2.35.1 <span class="nt">-f</span> argorollouts-values.yaml <span class="nt">--namespace</span> argo-rollouts
<span class="c"># =&gt; NAME: argo-rollouts</span>
<span class="c">#    LAST DEPLOYED: Sun Oct 01 23:05:23 2024</span>
<span class="c">#    NAMESPACE: argo-rollouts</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> argo-rollouts
<span class="c"># =&gt; NAME                                           READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/argo-rollouts-86469b5878-j6p5k             1/1     Running   0          42s</span>
<span class="c">#    pod/argo-rollouts-86469b5878-vlr6z             1/1     Running   0          43s</span>
<span class="c">#    pod/argo-rollouts-dashboard-7c88d965fc-l6lml   1/1     Running   0          43s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/argo-rollouts-dashboard   NodePort   10.96.195.148   &amp;lt;none&amp;gt;        3100:30003/TCP   43s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/argo-rollouts             2/2     2            2           43s</span>
<span class="c">#    deployment.apps/argo-rollouts-dashboard   1/1     1            1           43s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                 DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/argo-rollouts-86469b5878             2         2         2       43s</span>
<span class="c">#    replicaset.apps/argo-rollouts-dashboard-7c88d965fc   1         1         1       43s</span>
<span class="nv">$ </span>kubectl get crds
<span class="c"># =&gt; NAME                                   CREATED AT</span>
<span class="c">#    analysisruns.argoproj.io               2024-10-01T14:05:24Z</span>
<span class="c">#    analysistemplates.argoproj.io          2024-10-01T14:05:24Z</span>
<span class="c">#    applications.argoproj.io               2024-10-01T07:54:01Z</span>
<span class="c">#    applicationsets.argoproj.io            2024-10-01T07:54:01Z</span>
<span class="c">#    appprojects.argoproj.io                2024-10-01T07:54:01Z</span>
<span class="c">#    clusteranalysistemplates.argoproj.io   2024-10-01T14:05:24Z</span>
<span class="c">#    experiments.argoproj.io                2024-10-01T14:05:24Z</span>
<span class="c">#    rollouts.argoproj.io                   2024-10-01T14:05:24Z</span>

<span class="c"># Argo rollouts ëŒ€ì‹œë³´ë“œ ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:30003"</span>
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_42.png" alt="img.png" /></p>

<ul>
  <li>Argo Rolloutì„ ì´ìš©í•´ì„œ ë°°í¬ë¥¼ ì§„í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run the following command to deploy the initial Rollout and Service:</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/argoproj/argo-rollouts/master/docs/getting-started/basic/rollout.yaml
<span class="c"># =&gt; rollout.argoproj.io/rollouts-demo created</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/argoproj/argo-rollouts/master/docs/getting-started/basic/service.yaml
<span class="c"># =&gt; service/rollouts-demo created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get rollout
<span class="c"># =&gt; NAME            DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    rollouts-demo   5         5         5            5           16s</span>
<span class="nv">$ </span>kubectl describe rollout
<span class="c"># =&gt; ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason                  Age   From                 Message</span>
<span class="c">#      ----    ------                  ----  ----                 -------</span>
<span class="c">#      Normal  RolloutAddedToInformer  25s   rollouts-controller  Rollout resource added to informer: default/rollouts-demo</span>
<span class="c">#      Normal  RolloutNotCompleted     25s   rollouts-controller  Rollout not completed, started update to revision 1 (687d76d795)</span>
<span class="c">#      Normal  RolloutUpdated          25s   rollouts-controller  Rollout updated to revision 1</span>
<span class="c">#      Normal  NewReplicaSetCreated    25s   rollouts-controller  Created ReplicaSet rollouts-demo-687d76d795 (revision 1)</span>
<span class="c">#      Normal  ScalingReplicaSet       25s   rollouts-controller  Scaled up ReplicaSet rollouts-demo-687d76d795 (revision 1) from 0 to 5</span>
<span class="c">#      Normal  RolloutCompleted        25s   rollouts-controller  Rollout completed update to revision 1 (687d76d795): Initial deploy</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rollouts-demo
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    rollouts-demo-687d76d795-7pbl9   1/1     Running   0          46s</span>
<span class="c">#    rollouts-demo-687d76d795-bnl2c   1/1     Running   0          46s</span>
<span class="c">#    rollouts-demo-687d76d795-ggzsq   1/1     Running   0          46s</span>
<span class="c">#    rollouts-demo-687d76d795-vtnlj   1/1     Running   0          46s</span>
<span class="c">#    rollouts-demo-687d76d795-xmk2x   1/1     Running   0          46s</span>
<span class="nv">$ </span>kubectl get svc,ep rollouts-demo
<span class="c"># =&gt; NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/rollouts-demo   ClusterIP   10.96.237.173   &amp;lt;none&amp;gt;        80/TCP    47s</span>
<span class="c">#    </span>
<span class="c">#    NAME                      ENDPOINTS                                                        AGE</span>
<span class="c">#    endpoints/rollouts-demo   10.244.1.14:8080,10.244.1.15:8080,10.244.1.16:8080 + 2 more...   47s</span>
<span class="nv">$ </span>kubectl get rollouts rollouts-demo <span class="nt">-o</span> yaml | kubectl neat
<span class="c"># =&gt; ...</span>
<span class="c">#    spec:</span>
<span class="c">#      replicas: 5</span>
<span class="c">#      revisionHistoryLimit: 2</span>
<span class="c">#      selector:</span>
<span class="c">#        matchLabels:</span>
<span class="c">#          app: rollouts-demo</span>
<span class="c">#      strategy:</span>
<span class="c">#        canary:</span>
<span class="c">#          steps:</span>
<span class="c">#          - setWeight: 20</span>
<span class="c">#          - setWeight: 40</span>
<span class="c">#          - pause:</span>
<span class="c">#              duration: 10</span>
<span class="c">#          - setWeight: 60</span>
<span class="c">#          - pause:</span>
<span class="c">#              duration: 10</span>
<span class="c">#          - setWeight: 80</span>
<span class="c">#          - pause:</span>
<span class="c">#              duration: 10</span>
<span class="c">#      ...</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ìš°ì¸¡ìƒë‹¨ì˜ NAMESPACEë¥¼ defaultë¡œ ë³€ê²½í•˜ê³  rollout-demoë¥¼ í´ë¦­í•˜ë©´ ë‹¤ìŒì˜ rollout í™”ë©´ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_43.png" alt="img.png" /></p>
  </li>
  <li>
    <p>rollouts-demo:blueë¥¼ rollouts-demo:yellowë¡œ ë³€ê²½í•´ì„œ ë°°í¬í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl edit rollouts rollouts-demo
...
     - image: argoproj/rollouts-demo:yellow
...
<span class="c"># =&gt; rollout.argoproj.io/rollouts-demo edited</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ìœ„ì™€ ê°™ì´ rollouts-demo/blueë¥¼ rollouts-demo/yellowë¡œ ë³€ê²½í•©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># íŒŒë“œ label ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rollouts-demo <span class="nt">-owide</span> <span class="nt">--show-labels</span>
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_44.png" alt="img.png" /></p>

<ul>
  <li>ìœ„ì™€ê°™ì´ yellowê°€ 20% ë§Œí¼ canary ë°°í¬ë˜ê³  ì •ì ìƒíƒœì— ìˆìŠµë‹ˆë‹¤.</li>
  <li>Promote ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_45.png" alt="img.png" /></p>

<ul>
  <li>ì •í•´ì§„ rollout ruleì— ë”°ë¼ 10ì´ˆì”© ëŒ€ê¸° í›„ 20%ì”© canary ë°°í¬ ë¹„ìœ¨ì„ ë†’ì—¬ì„œ ìµœì¢…ì ìœ¼ë¡œ ì „ì²´ê°€ yellowë¡œ ë°°í¬ë©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_46.png" alt="img.png" /></p>

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆì£¼ì—ëŠ” ìƒê°ë³´ë‹¤ ì‹¤ìŠµëŸ‰ì´ ë§ì•„ì„œ ì‹œê°„ì´ ë§ì´ ê±¸ë ¸ìŠµë‹ˆë‹¤. 
í•˜ì§€ë§Œ, K8Sì— CI/CD ë°°í¬í•˜ëŠ”ê²ƒê³¼ ArgoCDì™€ Argo Rolloutì„ ì´ìš©í•œ CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì„±ì„ ê²½í—˜í•´ë³¼ ìˆ˜ ìˆì–´ì„œ ì¢‹ì•˜ìŠµë‹ˆë‹¤.
íŠ¹íˆ ArgoCDì™€ Argo Rolloutì€ ì›¹ UIëŠ” ì¡°ê¸ˆ ë‚ ê²ƒ ëŠë‚Œì´ ë‚¬ì§€ë§Œ,
ê¸°ëŠ¥ì´ë‚˜ ì»¨ì…‰ ìì²´ëŠ” ì¢‹ì€ê²ƒ ê°™ê³ , 
ì„ ì–¸ì ì¸ ë°©ì‹ì´ë‚˜ CLIë¥¼ í†µí•´ì„œ ìë™í™”í•  ìˆ˜ ìˆìœ¼ë‹ˆ ë‹¤ì–‘í•˜ê²Œ í™œìš©í•  ìˆ˜ ìˆì„ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<p>ìŠ¤í„°ë”” ì»¨ì…‰ì´ CI/CD ë§›ë³´ê¸°ì—¬ì„œ ê°€ë²¼ìš´ ë§ˆìŒìœ¼ë¡œ ì‹œì‘í–ˆëŠ”ë°
ì‹¤ì œ ìŠ¤í„°ë””ëŠ” ê°€ë³ì§€ ì•Šì•˜ë˜ê²ƒ ê°™ìŠµë‹ˆë‹¤.<br />
ì´ ë§›ì— ìŠ¤í„°ë””í•©ë‹ˆë‹¤. 
:sweat_smile: ë§›ë³´ê¸°ê°€ ì´ ì •ë„ì´ë‹ˆ ë³¸í¸ì€ ì–¼ë§ˆë‚˜ ê¹Šê³  ë„“ì„ì§€ ê¸°ëŒ€ê°€ ë©ë‹ˆë‹¤.</p>

<p>ì—°ë§ì— ì–´ìˆ˜ì„ í•œ ê°€ìš´ë° ë‹¤ë“¤ ìŠ¤í„°ë”” ì°¸ì—¬í•˜ì‹  ë¶„ë“¤ ëª¨ë‘ ê³ ìƒ ë§ìœ¼ì…¨ê³ , 
ì§„í–‰í•´ì£¼ì‹  ê°€ì‹œë‹¤ë‹˜ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.</p>

<p>ê¸´ ê¸€ ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. 
í•œ í•´ ë§ˆë¬´ë¦¬ ì˜ í•˜ì‹œê³ , ê±´ê°•í•œ ëª¨ìŠµìœ¼ë¡œ ë‚´ë…„ì— ë˜ ëµ™ê¸°ë¥¼ ê¸°ì›í•©ë‹ˆë‹¤. :bow::bowing_woman:</p>]]></content><author><name></name></author><category term="kans" /><category term="cicd," /><category term="jenkins," /><category term="git," /><category term="linux" /><summary type="html"><![CDATA[ì´ë²ˆ ì£¼ì—ëŠ” ArgoCDì™€ Jenkinsë¥¼ ì‚¬ìš©í•˜ì—¬ Kubernetesë¡œì˜ ë°°í¬ë¥¼ í•˜ëŠ” CI/CDë¥¼ êµ¬ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.]]></summary></entry></feed>