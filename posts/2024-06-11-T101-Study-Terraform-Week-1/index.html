<!DOCTYPE html>
<html lang="ko"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[T101 4기] 테라폼 기본 사용법 1/3 | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="[T101 4기] 테라폼 기본 사용법 1/3" />
<meta property="og:locale" content="ko" />
<meta name="description" content="앞으로 몇 주간에 걸쳐 테라폼 기초 입문 실습 스터디에 참여하면서 배운 내용을 정리하려 합니다. 이번 글의 주제는 테라폼의 기본 사용법이며 “테라폼으로 시작하는 IaC” 책을 기준으로 정리하였습니다." />
<meta property="og:description" content="앞으로 몇 주간에 걸쳐 테라폼 기초 입문 실습 스터디에 참여하면서 배운 내용을 정리하려 합니다. 이번 글의 주제는 테라폼의 기본 사용법이며 “테라폼으로 시작하는 IaC” 책을 기준으로 정리하였습니다." />
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2024-06-11-T101-Study-Terraform-Week-1/" />
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2024-06-11-T101-Study-Terraform-Week-1/" />
<meta property="og:site_name" content="Sweet Little Bird" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-11T23:41:18+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="[T101 4기] 테라폼 기본 사용법 1/3" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-06-11T23:41:18+09:00","datePublished":"2024-06-11T23:41:18+09:00","description":"앞으로 몇 주간에 걸쳐 테라폼 기초 입문 실습 스터디에 참여하면서 배운 내용을 정리하려 합니다. 이번 글의 주제는 테라폼의 기본 사용법이며 “테라폼으로 시작하는 IaC” 책을 기준으로 정리하였습니다.","headline":"[T101 4기] 테라폼 기본 사용법 1/3","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2024-06-11-T101-Study-Terraform-Week-1/"},"url":"https://sweetlittlebird.github.io/posts/2024-06-11-T101-Study-Terraform-Week-1/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="/assets/main_dark.css" media="(prefers-color-scheme: dark)">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer" /><link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">소개</a><a class="page-link" href="/posts/">글 목록</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[T101 4기] 테라폼 기본 사용법 1/3</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-06-11T23:41:18+09:00" itemprop="datePublished">2024년 06월 11일에 작성
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div>
      목차
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#들어가며">들어가며</a></li>
<li class="toc-entry toc-h1"><a href="#iac-와-테라폼">IaC 와 테라폼</a></li>
<li class="toc-entry toc-h1"><a href="#실행-환경-구성">실행 환경 구성</a></li>
<li class="toc-entry toc-h1"><a href="#terraform-명령의-주요-서브-커맨드">terraform 명령의 주요 서브 커맨드</a></li>
<li class="toc-entry toc-h1"><a href="#terraform-명령의-주요-옵션">terraform 명령의 주요 옵션</a></li>
<li class="toc-entry toc-h1"><a href="#hcl">HCL</a>
<ul>
<li class="toc-entry toc-h2"><a href="#hcl-네이티브-문법-예시">HCL 네이티브 문법 예시</a></li>
<li class="toc-entry toc-h2"><a href="#테라폼-블록">테라폼 블록</a>
<ul>
<li class="toc-entry toc-h3"><a href="#terraform-블록">terraform 블록</a></li>
<li class="toc-entry toc-h3"><a href="#resource-블록">resource 블록</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#실습">실습</a>
<ul>
<li class="toc-entry toc-h2"><a href="#aws에-배포하기">AWS에 배포하기</a></li>
<li class="toc-entry toc-h2"><a href="#도전과제-3-lifecycle의-precondition">도전과제 3 lifecycle의 precondition</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#마치며">마치며</a></li>
</ul>
    </div>
    <h1 id="들어가며">들어가며</h1>

<p>앞으로 몇 주간에 걸쳐 테라폼 기초 입문 실습 스터디에 참여하면서 배운 내용을 정리하려 합니다.
이번 글의 주제는 테라폼의 기본 사용법이며 “테라폼으로 시작하는 IaC” 책을 기준으로 정리하였습니다.</p>

<blockquote>
  <p><img src="/assets/2024/20240614_terraform_book.jpg" alt="테라폼으로 시작하는 IaC" /></p>

  <p><a href="https://product.kyobobook.co.kr/detail/S000202478097">테라폼으로 시작하는 IaC</a></p>
</blockquote>

<h1 id="iac-와-테라폼">IaC 와 테라폼</h1>

<p>하나의 서버를 운영하기 위해서는 수 많은 설치와 설정의 과정이 필요합니다.
서버에 운영체제를 설치하고, 패키지를 설치하고, 설정을 하는 기나긴 작업이 필요합니다.
이것으로 끝나는 것이 아니라 방화벽을 비롯한 네트워크 설정, 보안 설정, 모니터링 설정 등 다양한 설정이 필요합니다.
이러한 작업을 수동으로 진행하다 보면 시간도 많이 소요되고 실수할 가능성도 높아집니다.</p>

<p>하나의 서버를 설정하기 위해서도 이러한 작업이 필요한데, 수대, 수십대, 수백대의 서버를 운영한다면 시간과 실수할 가능성은
엄청 나게 늘어납니다. 이러한 문제를 해결하기 위해 나온 것이 <code class="language-plaintext highlighter-rouge">IaC(Infrastructure as Code)</code>입니다.</p>

<p><code class="language-plaintext highlighter-rouge">IaC(Infrastructure as Code)</code>는 인프라를 코드로 관리하는 방식을 말하며, 코드를 <code class="language-plaintext highlighter-rouge">git</code>을 이용하여 버전 관리도 할 수 있고
코드 리뷰도 할 수 있습니다. 또한 코드를 통해 인프라를 구성하면 인프라를 재사용하기도 쉽고, 확장하기도 쉽습니다.</p>

<p>이 <code class="language-plaintext highlighter-rouge">IaC</code>에 대표적인 도구로는 <code class="language-plaintext highlighter-rouge">테라폼(Terraform)</code>이 있습니다. 
테라폼은 인프라를 코드로 관리할 수 있는 도구로, 다양한 클라우드 서비스를 지원하며, 코드를 통해 인프라를 구성할 수 있습니다.
서버만을 예시로 들었지만 테라폼은 서버 뿐만 아니라 AWS와 같은 클라우드 상의 다양한 서비스를 관리할 수 있습니다.</p>

<p>테라폼은 크게 3가지 형태로 구성되어 있습니다.</p>

<ul>
  <li>On-premise : Terraform 이라 불리는 형태로, 사용자의 컴퓨팅 환경에 오픈소스 버전의 테라폼을 사용하는 형태입니다.</li>
  <li>Hosted SaaS : Terraform Cloud 라 불리며, HashiCorp 에서 제공하는 SaaS 서비스로, HashiCorp 가 관리하는 서버 환경을 사용합니다.</li>
  <li>Private Install : Terraform Enterprise 라 불리는 서버 설치형 구성 환경으로, 기업 내부에 설치하여 사용하는 형태입니다. 외부 네트워크와 격리가 가능합니다.</li>
</ul>

<h1 id="실행-환경-구성">실행 환경 구성</h1>

<p>제가 사용중인 macOS를 기준으로 작성하였습니다.
macOS에서 테라폼을 설치하려면 <code class="language-plaintext highlighter-rouge">Homebrew</code>를 이용하여 설치할 수 있습니다.</p>

<p>(홈브루 설치 방법은 <a href="https://whalec.io/homebrew-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EC%82%AC%EC%9A%A9-%EB%B0%A9%EB%B2%95/">https://whalec.io/homebrew-설치-및-사용-방법</a> 를 참고하세요.)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># tfenv 설치</span>
brew <span class="nb">install </span>tfenv

<span class="c"># 테라폼 1.8.5 설치</span>
tfenv <span class="nb">install </span>1.8.5

<span class="c"># 테라폼 1.8.5 버전을 사용</span>
tfenv use 1.8.5

<span class="c"># 버전 확인</span>
terraform version

<span class="c"># 자동완성 스크립트 추가</span>
terraform <span class="nt">-install-autocomplete</span>

<span class="c"># 자동완성 스크립트 적용 (zsh의 경우)</span>
<span class="nb">source</span> ~/.zshrc
</code></pre></div></div>

<h1 id="terraform-명령의-주요-서브-커맨드">terraform 명령의 주요 서브 커맨드</h1>

<ul>
  <li><code class="language-plaintext highlighter-rouge">terraform init</code> : 현재 디렉토리에 terraform 설정 파일들을 생성하고 초기화합니다. 새로운 프로젝트를 만든다는 느낌입니다.</li>
  <li><code class="language-plaintext highlighter-rouge">terraform validate</code> : terraform 설정 파일들을 검증합니다. 설정 파일들이 올바르게 작성되었는지 확인합니다.</li>
  <li><code class="language-plaintext highlighter-rouge">terraform plan</code> : terraform 설정 파일들을 기반으로 실행할 계획을 확인합니다. <strong>실제로 실행되는 것은 아닙니다.</strong>
어떤 리소스가 생성되고, 삭제되며, 변경되는지 등을 확인할 수 있습니다.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">terraform plan -out=tfplan</code> : 실행할 계획을 파일로 저장합니다. 이후 <code class="language-plaintext highlighter-rouge">terraform apply plan.out</code>으로 실행할 수 있습니다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">terraform apply</code> : terraform 설정 파일들을 기반으로 <strong>실제</strong> 작업을 실행합니다. 사전에 <code class="language-plaintext highlighter-rouge">terraform plan</code>으로 변경사항을 확인하고 실행해야 합니다.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">terraform apply -replace=리소스</code> : 프로비저닝이 완료된 후 특정 리소스를 삭제 후 다시 생성 합니다. <code class="language-plaintext highlighter-rouge">plan</code>, <code class="language-plaintext highlighter-rouge">apply</code> 모두 적용 가능합니다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">terraform state list</code> : 생성된 리소스들의 목록을 확인합니다.</li>
  <li><code class="language-plaintext highlighter-rouge">terraform destroy</code> : terraform 설정 파일들을 기반으로 생성된 리소스들을 모두 삭제합니다.</li>
  <li><code class="language-plaintext highlighter-rouge">terraform fmt</code> : terraform 설정 파일들을 표준 형식과 표준 스타일로 정렬하여 가독성을 높입니다.</li>
</ul>

<h1 id="terraform-명령의-주요-옵션">terraform 명령의 주요 옵션</h1>

<ul>
  <li><code class="language-plaintext highlighter-rouge">-auto-approve</code> : <code class="language-plaintext highlighter-rouge">terraform apply</code> 시 Y/N을 묻지 않고 자동으로 승인합니다.</li>
  <li><code class="language-plaintext highlighter-rouge">-help</code> : 도움말을 확인합니다. <code class="language-plaintext highlighter-rouge">terraform apply -help</code>와 같이 명렁어와 함께 사용시 해당 명령어의 옵션을 확인 할 수 있습니다.</li>
  <li><code class="language-plaintext highlighter-rouge">-no-color</code> : <code class="language-plaintext highlighter-rouge">&lt;-[0m&lt;[1m</code> 과 같은 문자가 표시되는 경우 색상 정보를 안 나오게하여 정상적으로 나오게 합니다. <code class="language-plaintext highlighter-rouge">terraform validate -no-color</code>와 같이 사용할 수 있습니다.</li>
</ul>

<h1 id="hcl">HCL</h1>

<p>HCL은 <strong>H</strong>ashiCorp <strong>C</strong>onfiguration <strong>L</strong>anguage의 약자로, HashiCorp에서 만든 IaC와 구성정보를 명시하기 위한 언어입니다.
HCL은 네이티브 문법과 json 호환 문법을 지원합니다. 네이티브 문법의 경우 보통 <code class="language-plaintext highlighter-rouge">.tf</code> 확장자를, json 호환 문법의 경우 <code class="language-plaintext highlighter-rouge">.tf.json</code> 확장자를 사용합니다.</p>

<p>네이티브 문법이 더 가독성이 좋고 작성하기 편하기 때문에 보통 네이티브 문법을 사용합니다.
주요 문법 적인 특징은 다음과 같습니다.</p>

<ul>
  <li>쿠버네티스 처럼 선언적인 구조를 가지고 있습니다. 즉, 어떻게 하는지 절차를 기록하는것이 아닌, 최종 결과를 정하면 Terraform이 적절한 절차의 계획(plan)을 세워서 적용합니다..</li>
  <li>변수와 문자열 값을 함께 사용하는 인터폴레이션(interpolation)을 지원합니다.
    <ul>
      <li>예) <code class="language-plaintext highlighter-rouge">name = "Hello~ {$var.name}!"</code></li>
    </ul>
  </li>
  <li>HCL은 코드의 모듈화와 재사용성을 위한 기능을 제공합니다.</li>
</ul>

<h2 id="hcl-네이티브-문법-예시">HCL 네이티브 문법 예시</h2>

<div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 한줄 주석 방법1</span>
<span class="c1"># 한줄 주석 방법2</span>

<span class="cm">/*
라인
주석
*/</span>

<span class="nx">locals</span> <span class="p">{</span>
  <span class="nx">key1</span>     <span class="p">=</span> <span class="s2">"value1"</span>     <span class="c1"># = 를 기준으로 키와 값이 구분되며</span>
  <span class="nx">myStr</span>    <span class="p">=</span> <span class="s2">"TF ♡ UTF-8"</span> <span class="c1"># UTF-8 문자를 지원한다.</span>
  <span class="nx">multiStr</span> <span class="p">=</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
  Multi
  Line
  String
  with anytext
</span><span class="no">EOF

</span>  <span class="nx">boolean1</span>    <span class="p">=</span> <span class="kc">true</span>   <span class="c1"># boolean true</span>
  <span class="nx">boolean2</span>    <span class="p">=</span> <span class="kc">false</span>  <span class="c1"># boolean false를 지원한다.</span>
  <span class="nx">deciaml</span>     <span class="p">=</span> <span class="mi">123</span>    <span class="c1"># 기본적으로 숫자는 10진수,</span>
  <span class="nx">octal</span>       <span class="p">=</span> <span class="mi">0123</span>   <span class="c1"># 0으로 시작하는 숫자는 8진수,</span>
  <span class="nx">hexadecimal</span> <span class="p">=</span> <span class="s2">"0xD5"</span> <span class="c1"># 0x 값을 포함하는 스트링은 16진수,</span>
  <span class="nx">scientific</span>  <span class="p">=</span> <span class="mi">1</span><span class="nx">e10</span>   <span class="c1"># 과학표기 법도 지원한다.</span>

  <span class="c1"># funtion 호출 예</span>
  <span class="nx">myprojectname</span> <span class="p">=</span> <span class="nx">format</span><span class="p">(</span><span class="s2">"%s is myproject name"</span><span class="p">,</span> <span class="kd">var</span><span class="p">.</span><span class="nx">project</span><span class="p">)</span>

  <span class="c1"># 3항 연산자 조건문을 지원한다.</span>
  <span class="nx">credentials</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">credentials</span> <span class="p">==</span> <span class="s2">""</span> <span class="err">?</span> <span class="nx">file</span><span class="p">(</span><span class="kd">var</span><span class="p">.</span><span class="nx">credentials_file</span><span class="p">)</span> <span class="err">:</span> <span class="kd">var</span><span class="p">.</span><span class="nx">credentials</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>HCL은 주석 부터 변수 정의, 연산, 조건문 등 프로그래밍적인 요소를 가지고 있고, 구성 편의성을 높이기 위한 function을 제공합니다.
    <ul>
      <li><a href="https://developer.hashicorp.com/terraform/language/functions">built in function 소개</a></li>
    </ul>
  </li>
  <li>테라폼으로 인프라를 구성하기 위한 terraform, resource, data, variable, local, output 과 같은 선언 블록도 다수 존재합니다.</li>
</ul>

<h2 id="테라폼-블록">테라폼 블록</h2>

<p>테라폼은 다양한 블록을 제공하며, 각 블록은 특정한 역할을 수행합니다.</p>

<h3 id="terraform-블록">terraform 블록</h3>

<ul>
  <li>Terraform의 버전이나 프로바이더 버전 등을 지정 할 수 있고, 리소스를 생성하기 위한 설정을 지정할 수 있습니다.</li>
  <li>버전을 지정함으로써 <strong>오늘 실행하던, 3년 후에 실행하던</strong> 같은 결과를 보장할 수 있습니다.</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">terraform</code> 블록 예시</p>

    <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">required_version</span> <span class="p">=</span> <span class="s2">"~&gt; 1.3.0"</span> <span class="c1"># 테라폼 버전</span>
  
  <span class="nx">required_providers</span> <span class="p">{</span> <span class="c1"># 프로바이더 버전을 나열</span>
    <span class="nx">random</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">version</span> <span class="p">=</span> <span class="s2">"&gt;= 3.0.0, &lt; 3.1.0"</span>
    <span class="p">}</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">version</span> <span class="p">=</span> <span class="s2">"4.2.0"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">cloud</span> <span class="p">{</span> <span class="c1"># Cloud/Enterprise 같은 원격 실행을 위한 정보</span>
    <span class="nx">organization</span> <span class="p">=</span> <span class="s2">"&lt;MY_ORG_NAME&gt;"</span>
    <span class="nx">workspaces</span> <span class="p">{</span>
      <span class="nx">name</span> <span class="p">=</span> <span class="s2">"my-first-workspace"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">backend</span> <span class="s2">"local"</span> <span class="p">{</span> <span class="c1"># state를 보관하는 위치를 지정</span>
    <span class="nx">path</span> <span class="p">=</span> <span class="s2">"relative/path/to/terraform.tfstate"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>버전 표현 방법
    <ul>
      <li>버전은 Semantic Versioning을 따릅니다. Semantic Versioning은 <code class="language-plaintext highlighter-rouge">Major.Minor.Patch</code> 형태로 버전을 관리합니다.
        <ul>
          <li><code class="language-plaintext highlighter-rouge">Major</code> 버전 : 하위 호환성이 없는 변경 사항</li>
          <li><code class="language-plaintext highlighter-rouge">Minor</code> 버전 : 하위 호환성이 있는 변경 사항</li>
          <li><code class="language-plaintext highlighter-rouge">Patch</code> 버전 : 하위 호환성이 있는 버그 수정</li>
        </ul>
      </li>
      <li>또한 버전은 제약 조건을 지정할 수 있습니다.
        <ul>
          <li><code class="language-plaintext highlighter-rouge">=</code> 또는 연산자 없음 : 정확히 해당 버전</li>
          <li><code class="language-plaintext highlighter-rouge">!=</code> : 지정된 버전을 제외</li>
          <li><code class="language-plaintext highlighter-rouge">&gt;, &gt;=, &lt;, &lt;=</code> : 각각 해당 버전보다 높은 버전, 높거나 같은 버전, 작은 버전, 작거나 같은 버전 사용</li>
          <li><code class="language-plaintext highlighter-rouge">~&gt;</code> : 지정된 버전에서 가장 자리수가 낮은 구성요소만 변경되는것을 허용
            <ul>
              <li>예) <code class="language-plaintext highlighter-rouge">~&gt; x.y</code> 인 경우 <code class="language-plaintext highlighter-rouge">y</code> 버전에 대해서만, <code class="language-plaintext highlighter-rouge">~&gt; x.y.z</code> 인 경우 <code class="language-plaintext highlighter-rouge">z</code> 버전에 대해서만 변경을 허용</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="terraform-버전-지정">Terraform 버전 지정</h4>

<p>위의 예제에서 본것 처럼 <code class="language-plaintext highlighter-rouge">required_version</code>을 통해 테라폼 버전을 지정할 수 있습니다. 
지정된 버전의 조건에 맞을때만 테라폼이 실행됩니다.</p>

<ul>
  <li>Terraform 버전 확인</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform version

<span class="c"># Terraform v1.8.5</span>
<span class="c"># on darwin_arm64</span>
<span class="c"># + provider registry.terraform.io/hashicorp/local v2.5.1</span>
</code></pre></div></div>

<ul>
  <li>main.tf 수정</li>
</ul>

<div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">terraform</span> <span class="p">{</span>
  <span class="c1"># 현재 설치된 terraform 버전인 1.8.5 미만으로 지정</span>
  <span class="nx">required_version</span> <span class="p">=</span> <span class="s2">"&lt; 1.8.5"</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>terraform plan 실행</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform plan

<span class="c"># Error: Unsupported Terraform Core version</span>
<span class="c"># </span>
<span class="c">#   on main.tf line 3, in terraform:</span>
<span class="c">#    3:   required_version = "&lt; 1.8.5"</span>
<span class="c"># </span>
<span class="c"># This configuration does not support Terraform version 1.8.5. To proceed, either choose another supported Terraform version or update this version constraint. Version constraints</span>
<span class="c"># are normally set for good reason, so updating the constraint may lead to other errors or unexpected behavior.</span>
</code></pre></div></div>

<p>현재 설치된 버전보다 이전으로 지정되어서 에러가 나고 종료되는것을 확인 할 수 있습니다.</p>

<h4 id="프로바이더-버전">프로바이더 버전</h4>

<p><code class="language-plaintext highlighter-rouge">terraform { required_providers { ... } }</code> 블록을 사용하여 프로바이더 버전을 지정할 수 있습니다.</p>

<div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">source</span> <span class="p">=</span> <span class="s2">"hashicorp/aws"</span>
      <span class="nx">version</span> <span class="p">=</span> <span class="s2">"~&gt; 4.2.0"</span>
    <span class="p">}</span>
    <span class="nx">azurerm</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">source</span> <span class="p">=</span> <span class="s2">"hashicorp/azurerm"</span>
      <span class="nx">version</span> <span class="p">=</span> <span class="s2">"&gt;= 2.99.0"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>아래의 주소에서 프로바이더들의 목록과 버전을 확인할 수 있습니다.</p>

<ul>
  <li><a href="https://registry.terraform.io/browse/providers">Terraform Provider Registry</a></li>
</ul>

<p>사이트 접속 후 원하는 프로바이더를 선택하고 우측 상단의 “USE PROVIDER”를 클릭하면 해당 프로바이더의 사용법을 확인할 수 있습니다.</p>

<h4 id="cloud-블록">cloud 블록</h4>

<p><code class="language-plaintext highlighter-rouge">terraform { cloud { ... } }</code> 블록을 사용하여 Terraform Cloud나 Terraform Enterprise 환경에서 사용하는 설정을 지정할 수 있습니다.</p>

<div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">cloud</span> <span class="p">{</span>
    <span class="nx">hostname</span> <span class="p">=</span> <span class="s2">"app.terraform.io"</span>        
    <span class="nx">organization</span> <span class="p">=</span> <span class="s2">"my-org"</span>  
    <span class="nx">workspaces</span> <span class="p">{</span>              
      <span class="nx">name</span> <span class="p">=</span> <span class="s2">"my-app-prod"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="backend-블록">backend 블록</h4>

<p><code class="language-plaintext highlighter-rouge">terraform { backend { ... } }</code> 블록을 사용하여 state 파일을 저장하는 위치를 지정할 수 있습니다.</p>

<ul>
  <li>Local 파일 시스템을 사용하는 경우</li>
</ul>

<div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">backend</span> <span class="s2">"local"</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="p">=</span> <span class="s2">"relative/path/to/terraform.tfstate"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>AWS S3를 사용하는 경우</li>
</ul>

<div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">backend</span> <span class="s2">"s3"</span> <span class="p">{</span>
    <span class="nx">bucket</span> <span class="p">=</span> <span class="s2">"mybucket"</span>
    <span class="nx">key</span>    <span class="p">=</span> <span class="s2">"path/to/my/key"</span>
    <span class="nx">region</span> <span class="p">=</span> <span class="s2">"us-west-2"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="resource-블록">resource 블록</h3>

<p>resource 블록은 클라우드 서비스의 인스턴스, 네트워크, 스토리지 등과 같은 구성요소를 정의합니다.</p>

<ul>
  <li>resource는 <code class="language-plaintext highlighter-rouge">resource "&lt;프로바이더이름_리소스유형&gt;" "&lt;사용자 지정 리소스명&gt;" { ... }</code> 형태로 정의합니다.</li>
  <li>
    <p>local 프로바이더의 file 리소스를 사용하는 예시</p>

    <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"abc"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">"123"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/abc.txt"</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>AWS 프로바이더의 ec2 리소스를 사용하는 예시</p>

    <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"web"</span> <span class="p">{</span>
  <span class="nx">ami</span> <span class="p">=</span> <span class="s2">"ami-a1b2c3d4"</span>
  <span class="nx">instance_type</span> <span class="p">=</span> <span class="s2">"t2.micro"</span>  
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>리소스 동작 보조 추가 <strong>메타인수</strong>를 정의 할 수 있습니다.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">depends_on</code> : 종속성을 선언하며, 선언된 구성요소와의 생성 시점에 대해 정의</li>
      <li><code class="language-plaintext highlighter-rouge">count</code> : 선언된 개수에 따라 여러 리소스를 생성</li>
      <li><code class="language-plaintext highlighter-rouge">for_each</code> : map 또는 set 타입의 데이터 배열의 값을 기준으로 여러 리소스를 생성</li>
      <li><code class="language-plaintext highlighter-rouge">provider</code> : 동일한 프로바이더가 다수 정의되어 있는 경우 지정</li>
      <li><code class="language-plaintext highlighter-rouge">lifecycle</code> : 리소스의 수명주기 관리</li>
      <li><code class="language-plaintext highlighter-rouge">provisioner</code> : 리소스 생성 후 추가 작업 정의</li>
      <li><code class="language-plaintext highlighter-rouge">timeouts</code> : 프로바이더에서 정의한 일부 리소스 유형에서는 create, update, delete에 대한 허용 시간 정의 가능</li>
    </ul>
  </li>
</ul>

<h4 id="resource-의-종속성">resource 의 종속성</h4>

<ul>
  <li>테라폼의 종속성은 resource와 module 선언으로 프로비저닝 되는 각 요소의 생성 순서를 정합니다.</li>
  <li>종속성의 종류
    <ul>
      <li>implicit (암시적) 종속성 : 리소스가 다른 리소스를 사용하는 등의 의존성이 있는 경우, 테라폼이 자동으로 종속성을 설정합니다.</li>
      <li>explicit (명시적) 종속성 : <code class="language-plaintext highlighter-rouge">depends_on</code> 메타인수를 사용하여 명시적으로 종속성을 설정할 수 있습니다.</li>
    </ul>
  </li>
  <li>종속성은 <code class="language-plaintext highlighter-rouge">terraform graph</code> 명령어를 통해 시각적으로 확인할 수 있습니다.</li>
  <li>
    <p>종속성이 없는 상태 확인</p>

    <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"abc"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">"123!"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/abc.txt"</span>
<span class="p">}</span>
  
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"def"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">"456!"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/def.txt"</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <p>위와같은 파일을 만들고 <code class="language-plaintext highlighter-rouge">terraform graph &gt; graph-1.dot</code> 을 실행하고 vscode의 graphviz 확장을 설치하면 아래와 같은 그래프를 확인할 수 있습니다.</p>

    <svg width="102pt" height="98pt" viewBox="0.00 0.00 102.00 98.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 94)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-94 98,-94 98,4 -4,4" />
<!-- local_file.abc -->
<g id="node1" class="node">
<title>local_file.abc</title>
<polygon fill="none" stroke="black" points="94,-36 0,-36 0,0 94,0 94,-36" />
<text text-anchor="middle" x="47" y="-12.2" font-family="sans-serif" font-size="14.00">local_file.abc</text>
</g>
<!-- local_file.def -->
<g id="node2" class="node">
<title>local_file.def</title>
<polygon fill="none" stroke="black" points="92.5,-90 1.5,-90 1.5,-54 92.5,-54 92.5,-90" />
<text text-anchor="middle" x="47" y="-66.2" font-family="sans-serif" font-size="14.00">local_file.def</text>
</g>
</g>
</svg>
  </li>
  <li>
    <p>암시적 종속성이 있는 상태 확인</p>

    <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"abc"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">"123!"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/abc.txt"</span>
<span class="p">}</span>
  
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"def"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="nx">local_file</span><span class="p">.</span><span class="nx">abc</span><span class="p">.</span><span class="nx">content</span> <span class="err">+</span> <span class="s2">"456!"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/def.txt"</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <svg width="229pt" height="44pt" viewBox="0.00 0.00 229.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 225,-40 225,4 -4,4" />
<!-- local_file.abc -->
<g id="node1" class="node">
<title>local_file.abc</title>
<polygon fill="none" stroke="black" points="94,-36 0,-36 0,0 94,0 94,-36" />
<text text-anchor="middle" x="47" y="-12.2" font-family="sans-serif" font-size="14.00">local_file.abc</text>
</g>
<!-- local_file.def -->
<g id="node2" class="node">
<title>local_file.def</title>
<polygon fill="none" stroke="black" points="221,-36 130,-36 130,0 221,0 221,-36" />
<text text-anchor="middle" x="175.5" y="-12.2" font-family="sans-serif" font-size="14.00">local_file.def</text>
</g>
<!-- local_file.def&#45;&gt;local_file.abc -->
<g id="edge1" class="edge">
<title>local_file.def&#45;&gt;local_file.abc</title>
<path fill="none" stroke="black" d="M129.54,-18C121.73,-18 113.5,-18 105.4,-18" />
<polygon fill="black" stroke="black" points="105.61,-14.5 95.61,-18 105.61,-21.5 105.61,-14.5" />
</g>
</g>
</svg>
  </li>
  <li>
    <p>명시적 종속성이 있는 상태 확인</p>

    <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"abc"</span> <span class="p">{</span>
  <span class="nx">depends_on</span> <span class="p">=</span> <span class="p">[</span>  <span class="c1"># 명시적 종속성 선언</span>
    <span class="nx">local_file</span><span class="p">.</span><span class="nx">def</span>
  <span class="p">]</span>
  
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">"123!"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/abc.txt"</span>
<span class="p">}</span>
  
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"def"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">"456!"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/def.txt"</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <svg width="229pt" height="44pt" viewBox="0.00 0.00 229.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>G</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-40 225,-40 225,4 -4,4" />
<!-- local_file.abc -->
<g id="node1" class="node">
<title>local_file.abc</title>
<polygon fill="none" stroke="black" points="221,-36 127,-36 127,0 221,0 221,-36" />
<text text-anchor="middle" x="174" y="-12.2" font-family="sans-serif" font-size="14.00">local_file.abc</text>
</g>
<!-- local_file.def -->
<g id="node2" class="node">
<title>local_file.def</title>
<polygon fill="none" stroke="black" points="91,-36 0,-36 0,0 91,0 91,-36" />
<text text-anchor="middle" x="45.5" y="-12.2" font-family="sans-serif" font-size="14.00">local_file.def</text>
</g>
<!-- local_file.abc&#45;&gt;local_file.def -->
<g id="edge1" class="edge">
<title>local_file.abc&#45;&gt;local_file.def</title>
<path fill="none" stroke="black" d="M126.61,-18C118.75,-18 110.52,-18 102.45,-18" />
<polygon fill="black" stroke="black" points="102.71,-14.5 92.71,-18 102.71,-21.5 102.71,-14.5" />
</g>
</g>
</svg>
  </li>
</ul>

<h4 id="리소스-속성-참조">리소스 속성 참조</h4>

<ul>
  <li>리소스 구성에서 참조 가능한 인수와 속성이 있습니다.
    <ul>
      <li>인수 (arguments) : 리소스를 생성할 때 사용자가 선언 하는 값</li>
      <li>속성 (attributes) : 사용자가 설정할 수는 없지만, 리소스가 생성되면 읽을 수 있는 리소스의 고유 값</li>
    </ul>

    <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">resource</span> <span class="s2">"&lt;프로바이더_유형&gt;"</span> <span class="s2">"&lt;이름&gt;"</span> <span class="p">{</span>
  <span class="err">&lt;인수&gt;</span>           <span class="p">=</span> <span class="err">&lt;값&gt;</span>
<span class="p">}</span>
  
<span class="c1"># 리소스 참조</span>
<span class="err">&lt;프로바이더</span><span class="nx">_</span><span class="err">유형&gt;.&lt;이름&gt;.&lt;인수&gt;</span>
<span class="err">&lt;프로바이더</span><span class="nx">_</span><span class="err">유형&gt;.&lt;이름&gt;.&lt;속성&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>리소스가 생성될때 사용자가 입력한 인수를 받아서 실제 리소스가 생성되면, 일부 리소스는 자동으로 기본값이나 추가되는 속성이 부여됩니다.
    <ul>
      <li>예) <code class="language-plaintext highlighter-rouge">aws_instance</code> 리소스의 경우 <code class="language-plaintext highlighter-rouge">ami</code>, <code class="language-plaintext highlighter-rouge">instance_type</code> 등의 인수를 받아서 리소스가 생성되면 <code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">public_ip</code> 등의 속성이 부여됩니다.</li>
    </ul>
  </li>
</ul>

<h4 id="리소스의-수명-주기">리소스의 수명 주기</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">lifecycle</code>은 리소스의 기본 수명 주기를 사용자가 제어할 수 있게 해줍니다.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">create_before_destroy</code> (bool) : 리소스를 새로 생성하기 전에 기존 리소스를 삭제합니다.</li>
      <li><code class="language-plaintext highlighter-rouge">prevent_destroy</code> (bool) : 리소스가 삭제되지 않도록 방지합니다.</li>
      <li><code class="language-plaintext highlighter-rouge">ignore_changes</code> (list) : 특정 인수의 변경을 무시합니다.</li>
      <li><code class="language-plaintext highlighter-rouge">precondition</code> : 리소스를 생성하기 전에 특정 조건을 검증합니다.</li>
      <li><code class="language-plaintext highlighter-rouge">postcondition</code> : Plan 과 Apply 이후의 결과를 속성값으로 검증합니다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">create_before_destroy</code>
    <ul>
      <li>테라폼은 기본 수명 주기가 <strong>삭제 후 생성</strong>입니다. 즉, 리소스를 새로 생성하기 전에 기존 리소스를 삭제합니다.</li>
      <li>
        <p>의도적으로 생성 후 삭제를 원할때 <code class="language-plaintext highlighter-rouge">create_before_destroy = true</code>를 사용합니다.</p>

        <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"abc"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">"lifecycle - step 1"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/abc.txt"</span>
  
  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">create_before_destroy</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
      <li>하지만 이 상태에서 <code class="language-plaintext highlighter-rouge">terraform apply</code>를 실행하면 파일이 삭제 됩니다. 이는 abc.txt 라는 파일을 생성 한 다음 삭제하기 때문에, 
마지막 동작이 삭제이기 때문에 파일이 없습니다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">prevent_destroy</code>
    <ul>
      <li>
        <p>리소스가 삭제되지 않도록 방지합니다. 이 속성은 특정 리소스가 삭제되지 않도록 방지할 때 사용합니다.</p>

        <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"abc"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">"lifecycle - step 1"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/abc.txt"</span>
  
  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">prevent_destroy</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>이 상태에서 <code class="language-plaintext highlighter-rouge">terraform destroy</code>를 실행하면 아래와 같은 에러가 발생합니다.</p>

        <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform destroy
    
<span class="c"># Error: Instance cannot be destroyed</span>
<span class="c">#  </span>
<span class="c">#  on main.tf line 1:</span>
<span class="c">#   1: resource "local_file" "abc" {</span>
<span class="c">#  </span>
<span class="c"># Resource local_file.abc has lifecycle.prevent_destroy set, but the plan calls for this resource to be destroyed. To avoid this error and continue with the plan, either disable</span>
<span class="c"># lifecycle.prevent_destroy or reduce the scope of the plan using the -target option.    </span>
</code></pre></div>        </div>
      </li>
      <li>하지만 리소스를 수정한 다음 <code class="language-plaintext highlighter-rouge">terraform apply -auto-approve</code>를 실행해도 수정시 동일한 오류가 발생합니다.</li>
      <li><code class="language-plaintext highlighter-rouge">destroy</code> 했을때는 이해가 가지만 <code class="language-plaintext highlighter-rouge">apply</code> 시에도 동일한 오류가 발생하는 이유는 수정 동작이 <strong>삭제</strong> 후 생성으로 인식되기 때문입니다.
즉 <code class="language-plaintext highlighter-rouge">apply</code> 시에도 리소스가 수정되면 삭제 단계가 있기 때문에 <code class="language-plaintext highlighter-rouge">prevent_destroy</code>가 적용되어 삭제되지 않습니다.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">ignore_changes</code>
    <ul>
      <li>
        <p>특정 인수의 변경을 무시합니다. 이 속성은 특정 인수의 변경을 무시하고 리소스를 업데이트할 때 사용합니다.</p>

        <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"abc"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">"lifecycle - step 1"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/abc.txt"</span>
  
  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">ignore_changes</span> <span class="p">=</span> <span class="p">[</span>
      <span class="nx">content</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>모든 변경울 무시하고 싶다면 <code class="language-plaintext highlighter-rouge">ignore_changes = all</code>을 사용합니다.</p>
      </li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">precondition</code>
    <ul>
      <li>리소스를 생성하기 전에 특정 조건을 검증합니다.</li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">condition</code>이 <code class="language-plaintext highlighter-rouge">true</code>인지 확인 하고, 조건이 맞지 않는 경우 <code class="language-plaintext highlighter-rouge">error_message</code>로 지정된 에러메시지를 표시합니다.</p>

        <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">variable</span> <span class="s2">"file_name"</span> <span class="p">{</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="s2">"step0.txt"</span>
<span class="p">}</span>
  
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"abc"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">"lifecycle - step 6"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">file_name</span><span class="k">}</span><span class="s2">"</span>
  
  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">precondition</span> <span class="p">{</span>
      <span class="nx">condition</span>     <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">file_name</span> <span class="p">==</span> <span class="s2">"step6.txt"</span>
      <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"file name is not </span><span class="se">\"</span><span class="s2">step6.txt</span><span class="se">\"</span><span class="s2">"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>  
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">postcondition</code>
    <ul>
      <li>프로비저닝 이후의 결과를 속성값으로 검증합니다.</li>
      <li>
        <p>마찬가지로 <code class="language-plaintext highlighter-rouge">condition</code> 인수로 검증하고, 조건이 맞지 않는 경우 <code class="language-plaintext highlighter-rouge">error_message</code>로 지정된 에러메시지를 표시합니다.</p>

        <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"abc"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">""</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/step7.txt"</span>

  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">postcondition</span> <span class="p">{</span>
      <span class="nx">condition</span>     <span class="p">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">content</span> <span class="err">!</span><span class="p">=</span> <span class="s2">""</span>
      <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"content cannot empty"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">output</span> <span class="s2">"step7_content"</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="nx">local_file</span><span class="p">.</span><span class="nx">abc</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h1 id="실습">실습</h1>

<h2 id="aws에-배포하기">AWS에 배포하기</h2>

<ul>
  <li>
    <p>AWS를 사용하기 위해 awscli 설치</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>awscli 
</code></pre></div>    </div>
  </li>
  <li>
    <p>AWS CLI의 로그인 credentials 설정</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws configure

<span class="c"># access key, secret key, 기본 region 입력</span>
</code></pre></div>    </div>

    <p>서울 리전을 사용하기 위해 <code class="language-plaintext highlighter-rouge">ap-northeast-2</code>를 입력하였습니다.</p>
  </li>
  <li>
    <p>AWS CLI를 사용하여 최신 ubuntu 22.04 AMI 이미지 얻기</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws ec2 describe-images <span class="nt">--owners</span> 099720109477 <span class="se">\</span>
  <span class="nt">--filters</span> <span class="s2">"Name=name,Values=ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"</span> <span class="s2">"Name=state,Values=available"</span> <span class="se">\</span>
  <span class="nt">--query</span> <span class="s1">'Images|sort_by(@, &amp;CreationDate)[-1].[ImageId, Name]'</span> <span class="nt">--output</span> text
  
<span class="c"># (결과)</span>
<span class="c"># ami-0bcdae8006538619a   ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-20240614</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>환경 변수에 AMI ID 저장</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">TF_VAR_ami_id</span><span class="o">=</span><span class="s2">"ami-0bcdae8006538619a"</span>
</code></pre></div>    </div>

    <p>이렇게 <code class="language-plaintext highlighter-rouge">TF_VAR_</code>를 붙여서 환경변수를 셋팅하면 .tf 파일에서 해당 변수를 사용할 수 있습니다.</p>
  </li>
  <li>
    <p>main.tf 파일 생성</p>

    <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="p">=</span> <span class="s2">"ap-northeast-2"</span>
<span class="p">}</span>
  
<span class="c1"># TF_VAR_ami_id 환경변수를 사용하기 위해 선언. var.ami_id 와 같이 사용 가능</span>
<span class="k">variable</span> <span class="s2">"ami_id"</span> <span class="p">{</span> <span class="p">}</span>  
  
<span class="k">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"example"</span> <span class="p">{</span>
  <span class="nx">ami</span>                    <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">ami_id</span><span class="k">}</span><span class="s2">"</span>
  <span class="nx">instance_type</span>          <span class="p">=</span> <span class="s2">"t2.micro"</span>
  <span class="nx">vpc_security_group_ids</span> <span class="p">=</span> <span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  
  <span class="nx">user_data</span> <span class="p">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOF</span><span class="sh">
              #!/bin/bash
              echo "Hello, T101 Study 9090" &gt; index.html
              nohup busybox httpd -f -p 9090 &amp;
</span><span class="no">              EOF
  
</span>  <span class="nx">user_data_replace_on_change</span> <span class="p">=</span> <span class="kc">true</span>
  
  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="s2">"Single-WebSrv"</span>
  <span class="p">}</span>
<span class="p">}</span>
  
<span class="k">resource</span> <span class="s2">"aws_security_group"</span> <span class="s2">"instance"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">security_group_name</span>
  
  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">from_port</span>   <span class="p">=</span> <span class="mi">9090</span>
    <span class="nx">to_port</span>     <span class="p">=</span> <span class="mi">9090</span>
    <span class="nx">protocol</span>    <span class="p">=</span> <span class="s2">"tcp"</span>
    <span class="nx">cidr_blocks</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
  
<span class="k">variable</span> <span class="s2">"security_group_name"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"The name of the security group"</span>
  <span class="nx">type</span>        <span class="p">=</span> <span class="nx">string</span>
  <span class="nx">default</span>     <span class="p">=</span> <span class="s2">"terraform-example-instance"</span>
<span class="p">}</span>
  
<span class="k">output</span> <span class="s2">"public_ip"</span> <span class="p">{</span>
  <span class="nx">value</span>       <span class="p">=</span> <span class="nx">aws_instance</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">public_ip</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"The public IP of the Instance"</span>
<span class="p">}</span> 
</code></pre></div>    </div>
  </li>
  <li>
    <p>plan 확인 후 apply</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform plan
<span class="c"># plan 확인</span>
terraform apply <span class="nt">-auto-approve</span>
</code></pre></div>    </div>

    <p>다음과 같이 32초 가량 소요 후 최종적으로 생성된 인스턴스의 public ip를 확인 할 수 있습니다.</p>

    <p><img src="/assets/2024/20240616_terraform_apply_1.png" alt="terraform apply 화면" /></p>

    <p>AWS 콘솔에서도 아래와 같이 잘 생성된 EC2 인스턴스와 보안 그룹이 생성된것을 확인 할 수 있었습니다.</p>

    <p><img src="/assets/2024/20240616_terraform_apply_2.png" alt="AWS 콘솔에서 EC2 인스턴스 확인" /></p>

    <p>물론 접속도 잘 됩니다.</p>

    <p><img src="/assets/2024/20240616_terraform_apply_3.png" alt="크롬에서 접속 확인" /></p>
  </li>
  <li>
    <p>destroy 를 사용하여 리소스 삭제</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform destroy 
</code></pre></div>    </div>

    <p>삭제도 잘 되었습니다. :)</p>

    <p><img src="/assets/2024/20240616_terraform_destroy.png" alt="destroy 확인" /></p>
  </li>
</ul>

<h2 id="도전과제-3-lifecycle의-precondition">도전과제 3 <strong>lifecycle의 precondition</strong></h2>
<ul>
  <li>도전과제 : lifecycle의 precondition 실습 내용에서 step<strong>0</strong>.txt ~ step<strong>6</strong>.txt 총 <strong>7개의 파일 이름 중 하나가 일치 시</strong> <strong>검증 조건 만족</strong>으로 <strong>코드 작성</strong></li>
  <li>
    <p>답안 : 정규표현식을 사용하여 아래와 같이 작성하였습니다.</p>

    <div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">variable</span> <span class="s2">"file_name"</span> <span class="p">{</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="s2">"step0.txt"</span>
<span class="p">}</span>
  
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"abc"</span> <span class="p">{</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="s2">"lifecycle - step 6"</span> <span class="c1"># 수정</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">file_name</span><span class="k">}</span><span class="s2">"</span>
  
  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">precondition</span> <span class="p">{</span>
      <span class="nx">condition</span>     <span class="p">=</span> <span class="nx">length</span><span class="p">(</span><span class="nx">regex</span><span class="p">(</span><span class="s2">"^step[0-6]</span><span class="se">\\</span><span class="s2">.txt</span><span class="err">$</span><span class="s2">"</span><span class="p">,</span> <span class="kd">var</span><span class="p">.</span><span class="nx">file_name</span><span class="p">))</span> <span class="err">&gt;</span> <span class="mi">0</span>
      <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"file name is not </span><span class="se">\"</span><span class="s2">step6.txt</span><span class="se">\"</span><span class="s2">"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span> 
</code></pre></div>    </div>
  </li>
  <li>
    <p>실행 결과</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform plan <span class="nt">-var</span><span class="o">=</span><span class="s1">'file_name=step0.txt'</span>
terraform plan <span class="nt">-var</span><span class="o">=</span><span class="s1">'file_name=step1.txt'</span>
terraform plan <span class="nt">-var</span><span class="o">=</span><span class="s1">'file_name=step2.txt'</span>
terraform plan <span class="nt">-var</span><span class="o">=</span><span class="s1">'file_name=step3.txt'</span>
terraform plan <span class="nt">-var</span><span class="o">=</span><span class="s1">'file_name=step4.txt'</span>
terraform plan <span class="nt">-var</span><span class="o">=</span><span class="s1">'file_name=step5.txt'</span>
terraform plan <span class="nt">-var</span><span class="o">=</span><span class="s1">'file_name=step6.txt'</span>

<span class="c"># 아래와 같이 precondition이 true여서 계획이 성립됨</span>
<span class="c">#</span>
<span class="c"># Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span>
<span class="c"># -/+ destroy and then create replacement</span>
<span class="c">#</span>
<span class="c"># Terraform will perform the following actions:</span>
<span class="c"># (이하 생략)  </span>

terraform plan <span class="nt">-var</span><span class="o">=</span><span class="s1">'file_name=step7.txt'</span>
  
<span class="c"># step0.txt ~ step6.txt 이외의 파일명인 step7.txt가 입력되어서 아래와 같이 에러가 발생함</span>
<span class="c">#</span>
<span class="c"># Planning failed. Terraform encountered an error while generating this plan.</span>
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="마치며">마치며</h1>

<p>이상과 같이 첫주차에는 테라폼 설치에서 부터 <code class="language-plaintext highlighter-rouge">lifecycle</code> 까지 스터디 하였습니다. 
생각보다 외워야 하는 부분이 많아서 나중에 다시 확인하기 위해 키워드 위주로 정리하여 보았습니다.
HCL을 통해 선언적으로 .tf 파일을 만들면 알아서 계획을 만들고 프로비저닝 해준다니 참 똑똑한 도구인것 같습니다. 
앞으로 배우는 내용들도 재밌을것 같아 기대됩니다.</p>

  </div><a class="u-url" href="/posts/2024-06-11-T101-Study-Terraform-Week-1/" hidden></a>
</article>



<div class="PageNavigation">
  
  
  <a class="next" href="/posts/2024-06-23-T101-Study-Terraform-Week-2/">[T101 4기] 테라폼 기본 사용법 2/3 &raquo;</a>
  
</div>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>공부 기록과 개발 이야기를 담은 블로그입니다.</p>
      </div>
    </div>

  </div>

</footer>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-EWGY9N8QXY');
    </script>
  </body>

</html>
