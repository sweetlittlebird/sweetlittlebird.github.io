<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[T101 4기] OpenTofu | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[T101 4기] OpenTofu">
<meta property="og:locale" content="ko">
<meta name="description" content="이번 주가 8주차이자 벌써 마지막주차입니다. T101 4기에서 마지막으로 알아볼 주제는 OpenTofu로 Terraform의 오픈소스 커뮤니티에서 포크한 버전으로 앞으로가 기대되는 프로젝트입니다.">
<meta property="og:description" content="이번 주가 8주차이자 벌써 마지막주차입니다. T101 4기에서 마지막으로 알아볼 주제는 OpenTofu로 Terraform의 오픈소스 커뮤니티에서 포크한 버전으로 앞으로가 기대되는 프로젝트입니다.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2024-08-03-T101-Study-Terraform-Week-8/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2024-08-03-T101-Study-Terraform-Week-8/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-08-03T16:02:00+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[T101 4기] OpenTofu">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-08-03T16:02:00+09:00","datePublished":"2024-08-03T16:02:00+09:00","description":"이번 주가 8주차이자 벌써 마지막주차입니다. T101 4기에서 마지막으로 알아볼 주제는 OpenTofu로 Terraform의 오픈소스 커뮤니티에서 포크한 버전으로 앞으로가 기대되는 프로젝트입니다.","headline":"[T101 4기] OpenTofu","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2024-08-03-T101-Study-Terraform-Week-8/"},"url":"https://sweetlittlebird.github.io/posts/2024-08-03-T101-Study-Terraform-Week-8/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">소개</a><a class="page-link" href="/posts/">글 목록</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[T101 4기] OpenTofu</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-08-03T16:02:00+09:00" itemprop="datePublished">2024년 08월 03일에 작성
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>목차</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#opentofu">OpenTofu</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EA%B0%9C%EC%9A%94">개요</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%8A%B9%EC%9D%B4%EC%82%AC%ED%95%AD">특이사항</a></li>
<li class="toc-entry toc-h3"><a href="#opentofu-%EC%84%A4%EC%B9%98">OpenTofu 설치</a></li>
<li class="toc-entry toc-h3">
<a href="#opentofu-17">OpenTofu 1.7</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-provider-defined-functions">[실습] Provider-defined functions</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-loopable-import-blocks">[실습] Loopable import blocks</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-state-file-encryption---local">[실습] State file encryption - Local</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-removed-block">[실습] Removed Block</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-test">[실습] Test</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-terraform%EC%9D%84-opentofu-17%EB%A1%9C-%EC%9D%B4%EC%A0%84%ED%95%98%EA%B8%B0">[실습] Terraform을 OpenTofu 1.7로 이전하기</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#opentofu-18">OpenTofu 1.8</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-early-variablelocals-evaluation">[실습] Early variable/locals evaluation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
    </div>
    <h2 id="들어가며">들어가며</h2>

<p>이번 주가 8주차이자 벌써 마지막주차입니다. 
T101 4기에서 마지막으로 알아볼 주제는 OpenTofu로 Terraform의 
오픈소스 커뮤니티에서 포크한 버전으로 앞으로가 기대되는 프로젝트입니다.
이 블로그 글의 내용은 
<a href="https://product.kyobobook.co.kr/detail/S000202478097">테라폼으로 시작하는 IaC</a>를 참고하였습니다.</p>

<blockquote>
  <p><img src="/assets/2024/t101-4th/20240614_terraform_book.jpg" alt="테라폼으로 시작하는 IaC" loading="lazy" width="458" height="589"></p>

  <p><a href="https://product.kyobobook.co.kr/detail/S000202478097">테라폼으로 시작하는 IaC</a></p>
</blockquote>

<h2 id="opentofu">OpenTofu</h2>

<h3 id="개요">개요</h3>

<p><img src="/assets/2024/t101-4th/20240803_terraform_w8_opentofu_1.png" alt="OpenTofu 로고" class="image-center" loading="lazy" width="1417" height="390">
<em class="image-caption">OpenTofu 로고</em></p>

<ul>
  <li>OpenTofu는 HashiCorp가 Terraform의 라이센스를 MPL(Mozilla Public License)에서 비오픈 소스 라이센스인 BUSL(Business Source License)로 변경한 것에
반발하여 만들어진 프로젝트입니다. BUSL로 라이센스가 변경되기 전의 소스를 포크하였으며, 초기에는 OpenTF 라는 이름을 사용하다가
OpenTofu로 변경하였습니다.
    <ul>
      <li>Terraform AWS Provider 등은 아직 MPL 버전이어서 OpenTofu에서 사용 가능합니다.</li>
    </ul>
  </li>
  <li>초기에는 Terraform의 오픈소스버전을 유지하기 위한 프로젝트였으나, 현재는 상태파일 암호화나 Backend 블록에서 Variable을 사용할 수 있게 하는 등
본가의 Terraform 에서 조차 지원하지 않는 편리한 기능들을 추가하며 발전해가고 있습니다.</li>
</ul>

<h3 id="특이사항">특이사항</h3>

<ul>
  <li>OpenTofu 1.6.x는 Terraform 1.6.x와 기능적으로 매우 유사하지만, 앞으로 기능추가 등 각각 독자적인 방향으로 발전할 가능성이 있습니다.</li>
  <li>Terraform 1.5.x 및 1.6.x 와 상당 부분 호환되므로 해당 버전을 사용 중이었다면 OpenTofu로 전환하기가 쉽습니다.</li>
  <li>Terraform 1.5.x 까지와는 상태 파일 그대로 호환 될정도입니다.</li>
  <li>OpenTofu는 현재 자체 Provider가 없으며, Terraform의 Provider는 라이센스가 변경되지 않는 이상 최신버전을 사용할 수 없습니다.</li>
  <li>현재 OpenTofu는 Terraform 공급자와 함께 동작할 수 있지만 별도의 레지스트리를 사용합니다.</li>
  <li>OpenTofu 1.7 버전 부터는 프로덕션환경에서 쓸 수 있는 버전으로 알려져있습니다.</li>
</ul>

<p>OpenTofu는 Terraform과 유사하여 바로 설치 후 실습을 진행하겠습니다.</p>

<h3 id="opentofu-설치">OpenTofu 설치</h3>

<p>tenv를 사용하여 OpenTofu를 설치해보겠습니다.
tenv는 tfenv와 유사하나 Terraform만 관리하는 tfenv와는 달리 tenv는  Terraform 외에도 OpenTofu, Terragrunt 등을 설치하고 버전을 관리할 수 있습니다.</p>

<p>각 툴별로 명령과 환경 변수는 아래와 같습니다.</p>

<table>
  <thead>
    <tr>
      <th>툴</th>
      <th>명령어</th>
      <th>환경변수</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>OpenTofu</td>
      <td>tofu</td>
      <td>TOFUENV_</td>
    </tr>
    <tr>
      <td>Terraform</td>
      <td>terraform</td>
      <td>TFENV_</td>
    </tr>
    <tr>
      <td>Terragrunt</td>
      <td>terragrunt</td>
      <td>TG_</td>
    </tr>
    <tr>
      <td>Atmos</td>
      <td>atmos</td>
      <td>ATMOS_</td>
    </tr>
  </tbody>
</table>

<p>MacOS를 기준으로 설치하겠습니다.</p>

<ul>
  <li>tenv 설치
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 먼저 tfenv를 삭제합니다.</span>
<span class="nv">$ </span>brew remove tfenv
  
<span class="c"># tenv를 설치</span>
<span class="nv">$ </span>brew <span class="nb">install </span>tenv
  
<span class="nv">$ </span>tenv <span class="nt">--version</span>
<span class="c"># =&gt; tenv version 2.7.9</span>
  
<span class="nv">$ </span>tenv <span class="nt">-h</span>       <span class="c"># 도움말 보기 </span>
<span class="nv">$ </span>tenv tofu <span class="nt">-h</span>  <span class="c"># OpenTofu 도움말 보기</span>
  
<span class="c"># (옵션) Install shell completion</span>
<span class="nv">$ </span>tenv completion zsh <span class="o">&gt;</span> ~/.tenv.completion.zsh
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"source '~/.tenv.completion.zsh'"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
</code></pre></div>    </div>
  </li>
  <li>OpenTofu 설치
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tenv tofu list            <span class="c"># 현재 설치된 목록 확인</span>
<span class="nv">$ </span>tenv tofu list-remote     <span class="c"># 설치가능한 목록 확인</span>
  
<span class="c"># 설치</span>
<span class="nv">$ </span>tenv tofu <span class="nb">install </span>1.7.3   <span class="c"># 1.8은 너무 최신이어서 안정적인 1.7.3 버전을 설치합니다.</span>
<span class="c"># =&gt; Installation of OpenTofu 1.7.3 successful</span>
  
<span class="nv">$ </span>tenv tofu list            <span class="c"># 설치된 목록 확인</span>
<span class="c"># =&gt; 1.7.3</span>
<span class="nv">$ </span>tenv tofu use 1.7.3       <span class="c"># 사용할 버전 선택</span>
<span class="nv">$ </span>tenv tofu detect          <span class="c"># 현재 사용하는 버전의 위치를 확인</span>
  
<span class="nv">$ </span>tofu version       <span class="c"># OpenTofu 버전 확인</span>
<span class="c"># =&gt; OpenTofu v1.7.3</span>
<span class="c">#    on darwin_arm64</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="opentofu-17">OpenTofu 1.7</h3>

<h4 id="실습-provider-defined-functions">[실습] Provider-defined functions</h4>

<p>OpenTofu에서 Provider-defined functions을 사용해 보겠습니다.
Functions는 크게 Built-in functions와 Provider-defined functions로 나뉩니다.
Built-in functions는 OpenTofu(Terraform)에서 기본적으로 제공하는 함수이며, Provider-defined functions는 Provider에서 제공하는 함수입니다.
각각 아래의 링크에서 목록을 확인할 수 있습니다.</p>
<ul>
  <li>Built-in functions: <a href="https://opentofu.org/docs/language/functions/">https://opentofu.org/docs/language/functions/</a>
</li>
  <li>Provider-defined functions: <a href="https://library.tf/providers">https://library.tf/providers</a> 
=&gt; (Provider를 선택하고 Functions 탭에서 확인)</li>
</ul>

<p>이번 실습에서 사용할 함수는 <a href="https://library.tf/providers/northwood-labs/corefunc/latest/docs/functions/str_snake">Provider::corefunc::str_snake</a>으로
문자열을 snake_case로 변환하는 함수입니다.</p>

<ul>
  <li>main.tf 생성
    <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">corefunc</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">source</span> <span class="p">=</span> <span class="s2">"northwood-labs/corefunc"</span>
      <span class="nx">version</span> <span class="p">=</span> <span class="s2">"1.4.0"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
  
<span class="k">provider</span> <span class="s2">"corefunc"</span> <span class="p">{</span>
<span class="p">}</span>
  
<span class="k">output</span> <span class="s2">"test"</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="k">provider</span><span class="err">::</span><span class="nx">corefunc</span><span class="err">::</span><span class="nx">str_snake</span><span class="p">(</span><span class="s2">"Hello world!"</span><span class="p">)</span>
  <span class="c1"># Prints: hello_world</span>
<span class="p">}</span>   
</code></pre></div>    </div>
  </li>
  <li>실행
    <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 초기화 (프로바이더 다운로드 등)</span>
<span class="nv">$ </span>tofu init
  
<span class="c"># 프로바이더 정보 확인</span>
<span class="nv">$ </span>tree .terraform
<span class="c"># =&gt; .terraform</span>
<span class="c">#    └── providers</span>
<span class="c">#        └── registry.opentofu.org</span>
<span class="c">#            └── northwood-labs</span>
<span class="c">#                └── corefunc</span>
<span class="c">#                    ...  </span>
  
<span class="c"># 실행계획 보기</span>
<span class="nv">$ </span>tofu plan
<span class="c"># 적용</span>
<span class="nv">$ </span>tofu apply <span class="nt">-auto-approve</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Outputs:</span>
<span class="c">#    test = "hello_world"</span>
  
<span class="nv">$ </span>tofu output
<span class="c"># =&gt; test = "hello_world"</span>
<span class="nv">$ </span><span class="nb">cat </span>terraform.tfstate | jq
</code></pre></div>    </div>
    <p>명령만 terraform에서 tofu로 바뀌었을 뿐, 사용법과 결과는 거의 동일한것을 확인할 수 있었습니다.</p>
  </li>
  <li>main.tf 를 수정하여 str_camel 함수를 사용하여 snake_case를 camelCase로 변환해보겠습니다.
    <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">required_providers</span> <span class="p">{</span>
    <span class="nx">corefunc</span> <span class="p">=</span> <span class="p">{</span>
      <span class="nx">source</span> <span class="p">=</span> <span class="s2">"northwood-labs/corefunc"</span>
      <span class="nx">version</span> <span class="p">=</span> <span class="s2">"1.4.0"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
  
<span class="k">provider</span> <span class="s2">"corefunc"</span> <span class="p">{</span>
<span class="p">}</span>
  
<span class="k">output</span> <span class="s2">"test"</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="k">provider</span><span class="err">::</span><span class="nx">corefunc</span><span class="err">::</span><span class="nx">str_camel</span><span class="p">(</span><span class="s2">"Hello world!"</span><span class="p">)</span>  <span class="c1"># str_snake =&gt; str_camel로 변경</span>
  <span class="c1"># Prints: hello_world</span>
<span class="p">}</span>   
</code></pre></div>    </div>
  </li>
  <li>실행
    <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tofu plan
<span class="c"># =&gt; Changes to Outputs:</span>
<span class="c">#    ~ test = "hello_world" -&gt; "helloWorld"</span>
  
<span class="c"># 적용</span>
<span class="nv">$ </span>tofu apply <span class="nt">-auto-approve</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Outputs:</span>
<span class="c">#    test = "helloWorld"</span>
  
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> terraform.tfstate<span class="k">*</span>
<span class="c"># =&gt; -rw-r--r--  1 user  staff  255  8  3 16:02 terraform.tfstate</span>
<span class="c">#    -rw-r--r--  1 user  staff  256  8  3 16:02 terraform.tfstate.backup</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="실습-loopable-import-blocks">[실습] Loopable import blocks</h4>
<p><a href="https://opentofu.org/docs/v1.7/intro/whats-new/#loopable-import-blocks">관련문서</a></p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">import</code> 블록은 `terraform import 명령 처럼 기존 리소스를 가져오는 기능입니다. 차이점은 terraform 선언 파일에서 사용할 수 있다는 것입니다.</li>
  <li>아래는 aws_instance.example 리소스를 가져오는 예제입니다. <code class="language-plaintext highlighter-rouge">import</code> 블록에서 <code class="language-plaintext highlighter-rouge">id</code>를 사용하여 가져올 리소스를 지정합니다.
    <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># import 블록 예제</span>
<span class="nx">import</span> <span class="p">{</span>
  <span class="nx">to</span> <span class="p">=</span> <span class="nx">aws_instance</span><span class="p">.</span><span class="nx">example</span>
  <span class="nx">id</span> <span class="p">=</span> <span class="s2">"i-abcd1234"</span>
<span class="p">}</span>
  
<span class="k">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"example"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="p">=</span> <span class="s2">"hashi"</span>
  <span class="c1"># (other resource arguments...)</span>
<span class="p">}</span>
</code></pre></div>    </div>
    <p>위의 예제를 수행하면 <code class="language-plaintext highlighter-rouge">aws_instance.example</code>은 마치 <code class="language-plaintext highlighter-rouge">OpenTofu</code>에서 프로비저닝한것 처럼 state 파일에 추가 됩니다.</p>
  </li>
  <li>이번 실습에서는 위의 <code class="language-plaintext highlighter-rouge">import</code> 블록을 Loop를 돌려서 여러개의 리소스를 가져와 보겠습니다.</li>
  <li>먼저 정상적으로 AWS 상에 EC2 인스턴스를 생성하겠습니다.
    <ul>
      <li>main.tf 생성
        <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">data</span> <span class="s2">"aws_ami"</span> <span class="s2">"ubuntu"</span> <span class="p">{</span>
    <span class="nx">most_recent</span> <span class="p">=</span> <span class="kc">true</span>
    
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"name"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"virtualization-type"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"hvm"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">owners</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"099720109477"</span><span class="p">]</span> <span class="c1"># Canonical</span>
<span class="p">}</span>
    
<span class="k">variable</span> <span class="s2">"instance_tags"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"web"</span><span class="p">,</span> <span class="s2">"app"</span><span class="p">]</span>
<span class="p">}</span>
    
<span class="k">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"this"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="p">=</span> <span class="nx">length</span><span class="p">(</span><span class="kd">var</span><span class="p">.</span><span class="nx">instance_tags</span><span class="p">)</span>
  <span class="nx">ami</span>                    <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_ami</span><span class="p">.</span><span class="nx">ubuntu</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">instance_type</span>          <span class="p">=</span> <span class="s2">"t3.micro"</span>
    
  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">instance_tags</span><span class="p">[</span><span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>    
</code></pre></div>        </div>
      </li>
      <li>실행
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 초기화</span>
<span class="nv">$ </span>tofu init
    
<span class="c"># 프로바이더 정보 확인</span>
<span class="nv">$ </span>tree .terraform
<span class="c"># =&gt; .terraform</span>
<span class="c">#    └── providers</span>
<span class="c">#        └── registry.opentofu.org</span>
<span class="c">#            └── hashicorp</span>
<span class="c">#                └── aws</span>
<span class="c">#                    └── 5.60.0</span>
                              
<span class="c"># 적용</span>
<span class="nv">$ </span>tofu apply <span class="nt">-auto-approve</span>
<span class="c"># =&gt; Apply complete! Resources: 2 added, 0 changed, 0 destroyed.</span>
    
<span class="c"># EC2 확인</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws ec2 describe-instances <span class="nt">--query</span> <span class="s2">"Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,InstanceName:Tags[?Key=='Name']|[0].Value,Status:State.Name}"</span> <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>instance-state-name,Values<span class="o">=</span>running <span class="nt">--output</span> text <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"------------------------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; app     3.36.26.23      running</span>
<span class="c">#    web     3.39.248.105    running</span>
    
<span class="c"># 확인</span>
<span class="nv">$ </span>tofu state list
<span class="nv">$ </span>tofu state <span class="nb">ls</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"data.aws_ami.ubuntu"</span> | tofu console
<span class="nv">$ </span>tofu show          
</code></pre></div>        </div>
      </li>
      <li>tfstate 파일을 삭제하여 문제 상황을 만들어보겠습니다.
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 문제 상황 발생 : tfstate 파일 삭제</span>
<span class="nv">$ </span><span class="nb">rm</span> <span class="nt">-r</span> .terraform<span class="k">*</span> terraform.tfstate<span class="k">*</span>
    
<span class="c"># EC2 ID 확인 : ID 메모 </span>
<span class="nv">$ </span>aws ec2 describe-instances <span class="nt">--query</span> <span class="s1">'Reservations[*].Instances[*].{InstanceID:InstanceId,PublicIP:PublicIpAddress,Name:Tags[?Key==`Name`]|[0].Value}'</span> <span class="nt">--output</span> json | jq <span class="nt">-r</span> <span class="s1">'.[][] | "\(.InstanceID)\t\(.PublicIP)\t\(.Name)"'</span>
<span class="c"># =&gt; i-051d42d1feafc4d4a     3.36.26.23      app</span>
<span class="c">#    i-0bb0a855d1749a7c2     3.39.248.105    web</span>
</code></pre></div>        </div>
      </li>
      <li>main.tf 파일 수정하여 instance id를 위에서 확인한 ID 값으로 수정합니다.
        <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">data</span> <span class="s2">"aws_ami"</span> <span class="s2">"ubuntu"</span> <span class="p">{</span>
    <span class="nx">most_recent</span> <span class="p">=</span> <span class="kc">true</span>
    
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"name"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"virtualization-type"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"hvm"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">owners</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"099720109477"</span><span class="p">]</span> <span class="c1"># Canonical</span>
<span class="p">}</span>
    
<span class="c1"># 추가 시작</span>
<span class="k">variable</span> <span class="s2">"instance_ids"</span> <span class="p">{</span>                                   
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"i-051d42d1feafc4d4a"</span><span class="p">,</span> <span class="s2">"i-0bb0a855d1749a7c2"</span><span class="p">]</span>
<span class="p">}</span>
<span class="c1"># 추가 종료</span>
    
<span class="k">variable</span> <span class="s2">"instance_tags"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"web"</span><span class="p">,</span> <span class="s2">"app"</span><span class="p">]</span>
<span class="p">}</span>
    
<span class="k">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"this"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="p">=</span> <span class="nx">length</span><span class="p">(</span><span class="kd">var</span><span class="p">.</span><span class="nx">instance_tags</span><span class="p">)</span>
  <span class="nx">ami</span>                    <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_ami</span><span class="p">.</span><span class="nx">ubuntu</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">instance_type</span>          <span class="p">=</span> <span class="s2">"t3.micro"</span>
    
  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">instance_tags</span><span class="p">[</span><span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
    
<span class="c1"># 추가 시작</span>
<span class="nx">import</span> <span class="p">{</span>
  <span class="nx">for_each</span> <span class="p">=</span> <span class="p">{</span> <span class="nx">for</span> <span class="nx">idx</span><span class="p">,</span> <span class="nx">item</span> <span class="nx">in</span> <span class="kd">var</span><span class="p">.</span><span class="nx">instance_ids</span> <span class="err">:</span> <span class="nx">idx</span> <span class="p">=</span><span class="err">&gt;</span> <span class="nx">item</span> <span class="p">}</span>
  <span class="nx">to</span> <span class="p">=</span> <span class="nx">aws_instance</span><span class="p">.</span><span class="nx">this</span><span class="p">[</span><span class="nx">tonumber</span><span class="p">(</span><span class="nx">each</span><span class="p">.</span><span class="nx">key</span><span class="p">)]</span>
  <span class="nx">id</span> <span class="p">=</span> <span class="nx">each</span><span class="p">.</span><span class="nx">value</span>
<span class="p">}</span>
<span class="c1"># 추가 종료 </span>
</code></pre></div>        </div>
      </li>
      <li>실행
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 초기화 </span>
<span class="nv">$ </span>tofu init
    
<span class="c"># import 실행</span>
<span class="nv">$ </span>tofu apply <span class="nt">-auto-approve</span>
<span class="c"># =&gt; Plan: 2 to import, 0 to add, 2 to change, 0 to destroy.</span>
<span class="c">#    aws_instance.this[1]: Importing... [id=i-0bb0a855d1749a7c2]</span>
<span class="c">#    aws_instance.this[1]: Import complete [id=i-0bb0a855d1749a7c2]</span>
<span class="c">#    aws_instance.this[0]: Importing... [id=i-051d42d1feafc4d4a]</span>
<span class="c">#    aws_instance.this[0]: Import complete [id=i-051d42d1feafc4d4a]</span>
<span class="c">#    aws_instance.this[0]: Modifying... [id=i-051d42d1feafc4d4a]</span>
<span class="c">#    aws_instance.this[1]: Modifying... [id=i-0bb0a855d1749a7c2]</span>
<span class="c">#    aws_instance.this[0]: Modifications complete after 1s [id=i-051d42d1feafc4d4a]</span>
<span class="c">#    aws_instance.this[1]: Modifications complete after 1s [id=i-0bb0a855d1749a7c2]</span>
<span class="c">#    Apply complete! Resources: 2 imported, 0 added, 2 changed, 0 destroyed.</span>
    
<span class="c"># 확인</span>
<span class="nv">$ </span>tofu state <span class="nb">ls</span>
<span class="nv">$ </span>tofu show
    
<span class="c"># 상태파일 확인</span>
<span class="nv">$ </span><span class="nb">cat </span>terraform.tfstate | jq    
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<p>테라폼에서 한번에 하나씩만 import 할 수 있었는데 OpenTofu에서는 여러 건을 한꺼번에 import 할 수 있어 편리한것 같습니다. 
테라폼과 OpenTofu의 경쟁을 통해 더욱 빠르고 강력하게 될것같아 기대됩니다.</p>

<h4 id="실습-state-file-encryption---local">[실습] State file encryption - Local</h4>

<ul>
  <li>OpenTofu에서는 상태파일을 로컬 스토리지 및 백엔드에서 암호화 하는것을 지원합니다. 또한 <code class="language-plaintext highlighter-rouge">terraform_remote_state</code> 데이터 소스와 함께 암호화를 사용할 수도 있습니다.</li>
  <li>사용 형태
    <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">encryption</span> <span class="p">{</span>
    <span class="nx">key_provider</span> <span class="s2">"some_key_provider"</span> <span class="s2">"some_name"</span> <span class="p">{</span>
      <span class="c1"># 키 프로바이더 옵션 지정 </span>
    <span class="p">}</span>
  
    <span class="nx">method</span> <span class="s2">"some_method"</span> <span class="s2">"some_method_name"</span> <span class="p">{</span>
      <span class="c1"># 메쏘드 옵션 지정</span>
      <span class="nx">keys</span> <span class="p">=</span> <span class="nx">key_provider</span><span class="p">.</span><span class="nx">some_key_provider</span><span class="p">.</span><span class="nx">some_name</span>
    <span class="p">}</span>
  
    <span class="nx">state</span> <span class="p">{</span>
      <span class="c1"># 상태데이터 암호화/복호화</span>
      <span class="nx">method</span> <span class="p">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">some_method</span><span class="p">.</span><span class="nx">some_method_name</span>   
        
      <span class="nx">fallback</span> <span class="p">{</span>     <span class="c1"># (선택사항)</span>
        <span class="c1"># 위의 method가 실패할 경우 사용할 method</span>
        <span class="nx">method</span> <span class="p">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">some_method</span><span class="p">.</span><span class="nx">old_method_name</span>
      <span class="p">}</span>
    <span class="p">}</span>
  
    <span class="nx">plan</span> <span class="p">{</span>
      <span class="c1"># 계획(plan) 데이터 암호화/복호화</span>
      <span class="nx">method</span> <span class="p">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">some_method</span><span class="p">.</span><span class="nx">some_method_name</span>
      <span class="nx">fallback</span> <span class="p">{</span>     <span class="c1"># (선택사항)</span>
        <span class="c1"># 위의 method가 실패할 경우 사용할 method</span>
        <span class="nx">method</span> <span class="p">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">some_method</span><span class="p">.</span><span class="nx">old_method_name</span>
      <span class="p">}</span>
    <span class="p">}</span>
  
    <span class="nx">remote_state_data_sources</span> <span class="p">{</span>
      <span class="c1"># terraform_remote_state 데이터 소스 지정</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>위의 사용 형태를 조금 더 자세하게 알아보겠습니다.
    <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">encryption</span> <span class="p">{</span>
    <span class="c1">## Step 1: 암호화 되지 않은 method:</span>
    <span class="nx">method</span> <span class="s2">"unencrypted"</span> <span class="s2">"migrate"</span> <span class="p">{}</span>
  
    <span class="c1">## Step 2: key provider 지정 - 아래의 예제에서는 pbkdf2 키 프로바이더를 사용하고 리소스 이름을 mykey로 지정합니다.</span>
    <span class="nx">key_provider</span> <span class="s2">"pbkdf2"</span> <span class="s2">"mykey"</span> <span class="p">{</span>
      <span class="c1"># 암호화 키를 지정합니다. (pbkdf2는 16자 이상 지정이 필요합니다.)</span>
      <span class="nx">passphrase</span> <span class="p">=</span> <span class="s2">"correct-horse-battery-staple"</span>
  
      <span class="c1"># 암호화 키를 암호화 method에 맞게 조정합니다. (aes-gcm은 32자로 지정합니다.)</span>
      <span class="nx">key_length</span> <span class="p">=</span> <span class="mi">32</span>
        
      <span class="c1"># Specify the number of iterations (min. 200.000, default: 600.000)</span>
        <span class="c1">## The work factor for PBKDF2 is implemented through an iteration count, which should set differently based on the internal hashing algorithm used.</span>
            <span class="c1">## PBKDF2-HMAC-SHA1: 1,300,000 iterations</span>
            <span class="c1">## PBKDF2-HMAC-SHA256: 600,000 iterations</span>
            <span class="c1">## PBKDF2-HMAC-SHA512: 210,000 iterations</span>
  
      <span class="c1"># PBKDF2에서 사용할 반복 횟수를 지정하십시오 (최소 200,000, 기본값: 600,000)</span>
            <span class="c1">## PBKDF2-HMAC-SHA1: 1,300,000 iterations</span>
            <span class="c1">## PBKDF2-HMAC-SHA256: 600,000 iterations</span>
            <span class="c1">## PBKDF2-HMAC-SHA512: 210,000 iterations</span>
      <span class="nx">iterations</span> <span class="p">=</span> <span class="mi">600000</span>
        
      <span class="c1"># 암호화 salt 길이를 byte로 지정하십시오. (기본값: 32)</span>
      <span class="nx">salt_length</span> <span class="p">=</span> <span class="mi">32</span>
        
      <span class="c1"># 해시함수를 지정하십시오. (sha256 or sha512, default: sha512)</span>
      <span class="nx">hash_function</span> <span class="p">=</span> <span class="s2">"sha512"</span>  
    <span class="p">}</span>
  
    <span class="c1">## Step 3: 암호화 method를 지정하십시오 - 아래의 예제에서는 aes_gcm 암호화 method를 사용하고 리소스 이름을 new_method로 지정합니다.</span>
    <span class="nx">method</span> <span class="s2">"aes_gcm"</span> <span class="s2">"new_method"</span> <span class="p">{</span>
      <span class="c1"># 암호화 키를 지정합니다. 앞에서 만든 my_key 리소스를 지정합니다.</span>
      <span class="nx">keys</span> <span class="p">=</span> <span class="nx">key_provider</span><span class="p">.</span><span class="nx">pbkdf2</span><span class="p">.</span><span class="nx">mykey</span>
    <span class="p">}</span>
  
    <span class="nx">state</span> <span class="p">{</span>
      <span class="c1"># 상태 파일의 암호화 방법을 지정합니다.</span>
  
      <span class="c1">## Step 4: 암호화 method를 지정하십시오.</span>
      <span class="nx">method</span> <span class="p">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">aes_gcm</span><span class="p">.</span><span class="nx">new_method</span>
  
      <span class="c1">## Step 5: Step 4가 실패할 경우 사용할 "fallback" method를 지정하십시오.</span>
      <span class="nx">fallback</span> <span class="p">{</span>
        <span class="c1">## "unencrypted" method를 사용합니다.</span>
        <span class="nx">method</span> <span class="p">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">unencrypted</span><span class="p">.</span><span class="nx">migrate</span>
      <span class="p">}</span>
  
      <span class="c1">## Step 6: "tofu apply" 적용</span>
  
      <span class="c1">## Step 7: 암호화를 강제 하고 싶으면 fallback 블록을 삭제하고 아래의 enforce = true 옵션을 추가하십시오.</span>
      <span class="c1"># enforced = true</span>
    <span class="p">}</span>
  
    <span class="c1">## Step 8: 계획(plan)도 암호화 하고 싶다면 Step 4 ~ 7을 반복하십시오.</span>
  <span class="p">}</span>
<span class="p">}</span>  
</code></pre></div>    </div>
  </li>
  <li>암호화 실습
    <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
  
<span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">encryption</span> <span class="p">{</span>
    <span class="nx">key_provider</span> <span class="s2">"pbkdf2"</span> <span class="s2">"my_passphrase"</span> <span class="p">{</span>
      <span class="c1">## Enter a passphrase here:</span>
      <span class="nx">passphrase</span> <span class="p">=</span> <span class="s2">"ChangeIt_123abcd"</span>
    <span class="p">}</span>
  
    <span class="nx">method</span> <span class="s2">"aes_gcm"</span> <span class="s2">"my_method"</span> <span class="p">{</span>
      <span class="nx">keys</span> <span class="p">=</span> <span class="nx">key_provider</span><span class="p">.</span><span class="nx">pbkdf2</span><span class="p">.</span><span class="nx">my_passphrase</span>
    <span class="p">}</span>
  
    <span class="c1">## Remove this after the migration:</span>
    <span class="nx">method</span> <span class="s2">"unencrypted"</span> <span class="s2">"migration"</span> <span class="p">{</span>
    <span class="p">}</span>
  
    <span class="nx">state</span> <span class="p">{</span>
      <span class="nx">method</span> <span class="p">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">aes_gcm</span><span class="p">.</span><span class="nx">my_method</span>
  
      <span class="c1">## Remove the fallback block after migration:</span>
      <span class="nx">fallback</span><span class="p">{</span>
        <span class="nx">method</span> <span class="p">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">unencrypted</span><span class="p">.</span><span class="nx">migration</span>
      <span class="p">}</span>
      <span class="c1">## Enable this after migration:</span>
      <span class="c1">#enforced = true</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
    <ul>
      <li>실행
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tofu init <span class="o">&amp;&amp;</span> tofu apply <span class="nt">-auto-approve</span>
<span class="nv">$ </span>tofu state list 
<span class="nv">$ </span>tofu show 
    
<span class="c"># 상태 파일 암호화 확인</span>
<span class="nv">$ </span><span class="nb">cat </span>terraform.tfstate | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "serial": 1,</span>
<span class="c">#      "lineage": "35fa959f-d819-8d1b-e036-c81f4827cf21",</span>
<span class="c">#      "meta": {</span>
<span class="c">#        "key_provider.pbkdf2.my_passphrase": "eyJzYWx0IjoiRGJXSzhyR3hBSHdQOUoxSmZncTYyaEJFSW9LaVZGNy9GK2JjSmlxQTBiT</span>
<span class="c">#         T0iLCJpdGVyYXRpb25zIjo2MDAwMDAsImhhc2hfZnVuY3Rpb24iOiJzaGE1MTIiLCJrZXlfbGVuZ3RoIjozMn0="</span>
<span class="c">#      },</span>
<span class="c">#      "encrypted_data": "EIuEr7sU9kb37t11Oy2JmbI1F/WFOYPuBjUlVV//IlrXVQYWyhlgw+JXu8m+2cztDGbkNIZ5h/giflO4nCUESI3mSP</span>
<span class="c">#         D8ZGETc80hR/JptGIv03RnKcyYXqzwoFDHS/7D8I4E5/itpBnmWCAXsFUTpoJ/vKySl3DfUrd/KFDKm0Db5RK2BjYywF+BeexpL7l//EZM</span>
<span class="c">#         zvyXkz0Tx85b+7q6SopHwUm1FztxSjqL2yiz1uZlyv5cJgUFHpsYV4geF/geMmDc5Kf9sysRNiJYaEJSrg==",</span>
<span class="c">#      "encryption_version": "v0"</span>
<span class="c">#    }    </span>
</code></pre></div>        </div>
      </li>
      <li>암호화 된 것을 확인할 수 있습니다.</li>
      <li>암호화가 apply 된 이후에는 <code class="language-plaintext highlighter-rouge">method "unencrypt"</code>와 <code class="language-plaintext highlighter-rouge">fallback</code> 블록을 삭제하고, <code class="language-plaintext highlighter-rouge">enforced = true</code> 옵션을 추가하여 암호화를 강제할 수 있습니다.</li>
    </ul>
  </li>
  <li>복호화 실습
    <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">encryption</span> <span class="p">{</span>
    <span class="nx">key_provider</span> <span class="s2">"pbkdf2"</span> <span class="s2">"my_passphrase"</span> <span class="p">{</span>
      <span class="c1">## Enter a passphrase here:</span>
      <span class="nx">passphrase</span> <span class="p">=</span> <span class="s2">"ChangeIt_123abcd"</span>
    <span class="p">}</span>
  
    <span class="nx">method</span> <span class="s2">"aes_gcm"</span> <span class="s2">"my_method"</span> <span class="p">{</span>
      <span class="nx">keys</span> <span class="p">=</span> <span class="nx">key_provider</span><span class="p">.</span><span class="nx">pbkdf2</span><span class="p">.</span><span class="nx">my_passphrase</span>
    <span class="p">}</span>
  
    <span class="c1">## Remove this after the migration:</span>
    <span class="nx">method</span> <span class="s2">"unencrypted"</span> <span class="s2">"migration"</span> <span class="p">{</span>
    <span class="p">}</span>
  
    <span class="nx">state</span> <span class="p">{</span>
      <span class="nx">method</span> <span class="p">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">unencrypted</span><span class="p">.</span><span class="nx">migration</span>
  
      <span class="c1">## Remove the fallback block after migration:</span>
      <span class="nx">fallback</span><span class="p">{</span>
        <span class="nx">method</span> <span class="p">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">aes_gcm</span><span class="p">.</span><span class="nx">my_method</span>
      <span class="p">}</span>
      <span class="c1"># Enable this after migration:</span>
      <span class="nx">enforced</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
    <ul>
      <li>실행
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tofu apply <span class="nt">-auto-approve</span>
    
<span class="c"># 상태 파일 복호화 확인</span>
<span class="nv">$ </span><span class="nb">cat </span>terraform.tfstate | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "version": 4,</span>
<span class="c">#      "terraform_version": "1.7.3",</span>
<span class="c">#      "serial": 1,</span>
<span class="c">#      "lineage": "35fa959f-d819-8d1b-e036-c81f4827cf21",</span>
<span class="c">#      "outputs": {},</span>
<span class="c">#      "resources": [],</span>
<span class="c">#      "check_results": null</span>
<span class="c">#    }    </span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>복호화가 정상적으로 되었음을 확인할 수 있습니다.
실습에서는 암호화키를 하드코딩하였지만,
실제 사용할때는 암호화 키를 변수로 입력 받도록 하거나, AWS KMS 와 같이 관리되는 키를 사용하면 보안성을 높일 수 있을것 같습니다.</li>
</ul>

<h4 id="실습-removed-block">[실습] Removed Block</h4>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">removed</code> 블록을 사용하면 실제 인프라스트럭쳐에 프로비저닝된 리소스는 삭제하지 않고 상태파일에서만 삭제할 수 있습니다.</li>
  <li>사용 방법
    <ul>
      <li>먼저 리소스를 생성 합니다.
        <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"test"</span> <span class="p">{</span>
  <span class="nx">content</span> <span class="p">=</span> <span class="s2">"Hello world!"</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"test.txt"</span>
<span class="p">}</span> 
</code></pre></div>        </div>
      </li>
      <li>
<code class="language-plaintext highlighter-rouge">removed</code> 블록을 추가하여 상태파일에서만 삭제합니다.
        <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nx">removed</span> <span class="p">{</span>
  <span class="nx">from</span> <span class="p">=</span> <span class="nx">local_file</span><span class="p">.</span><span class="nx">test</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
      <li>실행을 하면 <code class="language-plaintext highlighter-rouge">local_file.test</code> 리소스는 상태 파일에서 삭제 되지만, 프로비저닝된 test.txt는 그대로 남아있음을 확인 할 수 있습니다.</li>
      <li>
<code class="language-plaintext highlighter-rouge">removed</code> 블록을 apply 한 이후에 <code class="language-plaintext highlighter-rouge">resource</code> 블록을 삭제해도 됩니다.</li>
    </ul>
  </li>
  <li>실습
    <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">data</span> <span class="s2">"aws_ami"</span> <span class="s2">"ubuntu"</span> <span class="p">{</span>
    <span class="nx">most_recent</span> <span class="p">=</span> <span class="kc">true</span>
  
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"name"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"</span><span class="p">]</span>
    <span class="p">}</span>
  
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"virtualization-type"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"hvm"</span><span class="p">]</span>
    <span class="p">}</span>
  
    <span class="nx">owners</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"099720109477"</span><span class="p">]</span> <span class="c1"># Canonical</span>
<span class="p">}</span>
  
<span class="k">variable</span> <span class="s2">"instance_tags"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"web"</span><span class="p">,</span> <span class="s2">"app"</span><span class="p">]</span>
<span class="p">}</span>
  
<span class="k">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"this"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="p">=</span> <span class="nx">length</span><span class="p">(</span><span class="kd">var</span><span class="p">.</span><span class="nx">instance_tags</span><span class="p">)</span>
  <span class="nx">ami</span>                    <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_ami</span><span class="p">.</span><span class="nx">ubuntu</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">instance_type</span>          <span class="p">=</span> <span class="s2">"t3.micro"</span>
  
  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">instance_tags</span><span class="p">[</span><span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
  
<span class="k">resource</span> <span class="s2">"aws_ssm_parameter"</span> <span class="s2">"this"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="p">=</span> <span class="nx">length</span><span class="p">(</span><span class="kd">var</span><span class="p">.</span><span class="nx">instance_tags</span><span class="p">)</span>
  <span class="nx">name</span>  <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">instance_tags</span><span class="p">[</span><span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span>
  <span class="nx">type</span>  <span class="p">=</span> <span class="s2">"String"</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="nx">aws_instance</span><span class="p">.</span><span class="nx">this</span><span class="p">[</span><span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">id</span>
<span class="p">}</span>    
</code></pre></div>    </div>
    <ul>
      <li>실행
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tofu init <span class="o">&amp;&amp;</span> tofu apply <span class="nt">-auto-approve</span>
<span class="c"># =&gt; Apply complete! Resources: 4 added, 0 changed, 0 destroyed.</span>
    
<span class="nv">$ </span>tree .terraform
<span class="nv">$ </span>tofu state <span class="nb">ls</span>
<span class="nv">$ </span>tofu show
<span class="nv">$ </span>tofu state show <span class="s1">'aws_ssm_parameter.this[0]'</span>
    
<span class="c"># tfstate 파일 확인</span>
<span class="nv">$ </span><span class="nb">cat </span>terraform.tfstate | jq
    
<span class="nv">$ </span><span class="nb">cat </span>terraform.tfstate | jq | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'"i-'</span>
<span class="c"># =&gt; "id": "i-036b9e057c2eb71d8",</span>
<span class="c">#    "id": "i-0f8f05caabc524b47",</span>
<span class="c">#    "value": "i-036b9e057c2eb71d8",</span>
<span class="c">#    "value": "i-0f8f05caabc524b47",    </span>
    
<span class="c"># parameters 정보 확인</span>
<span class="nv">$ </span>aws ssm describe-parameters | jq
<span class="nv">$ </span>aws ssm get-parameter <span class="nt">--name</span> <span class="s2">"web"</span>
<span class="nv">$ </span>aws ssm get-parameter <span class="nt">--name</span> <span class="s2">"web"</span> <span class="nt">--query</span> <span class="s2">"Parameter.Value"</span> <span class="nt">--output</span> text
<span class="c"># =&gt; i-036b9e057c2eb71d8</span>
<span class="nv">$ </span>aws ssm get-parameter <span class="nt">--name</span> <span class="s2">"app"</span>
<span class="nv">$ </span>aws ssm get-parameter <span class="nt">--name</span> <span class="s2">"app"</span> <span class="nt">--query</span> <span class="s2">"Parameter.Value"</span> <span class="nt">--output</span> text
<span class="c"># =&gt; i-0f8f05caabc524b47</span>
    
<span class="c"># EC2 목록 확인</span>
<span class="nv">$ </span>aws ec2 describe-instances <span class="nt">--query</span> <span class="s1">'Reservations[*].Instances[*].{InstanceID:InstanceId,PublicIP:PublicIpAddress,Name:Tags[?Key==`Name`]|[0].Value}'</span> <span class="nt">--output</span> json | jq <span class="nt">-r</span> <span class="s1">'.[][] | "\(.InstanceID)\t\(.PublicIP)\t\(.Name)"'</span>
<span class="c"># =&gt; i-036b9e057c2eb71d8     3.34.132.49     web</span>
<span class="c">#    i-0f8f05caabc524b47     3.35.51.118     app   </span>
</code></pre></div>        </div>
      </li>
      <li>
<code class="language-plaintext highlighter-rouge">removed</code> 블록 추가하여 ssm parameter와 EC2를 리소스는 그대로 두고 state 파일에서만 삭제하겠습니다.
        <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">data</span> <span class="s2">"aws_ami"</span> <span class="s2">"ubuntu"</span> <span class="p">{</span>
    <span class="nx">most_recent</span> <span class="p">=</span> <span class="kc">true</span>
    
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"name"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"virtualization-type"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"hvm"</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="nx">owners</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"099720109477"</span><span class="p">]</span> <span class="c1"># Canonical</span>
<span class="p">}</span>
    
<span class="k">variable</span> <span class="s2">"instance_tags"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"web"</span><span class="p">,</span> <span class="s2">"app"</span><span class="p">]</span>
<span class="p">}</span>
    
<span class="c1">## 리소스 정의 파일에서 주석처리하여 삭제</span>
<span class="c1"># resource "aws_instance" "this" {</span>
<span class="c1">#   count = length(var.instance_tags)</span>
<span class="c1">#   ami                    = data.aws_ami.ubuntu.id</span>
<span class="c1">#   instance_type          = "t3.micro"</span>
<span class="c1">#  </span>
<span class="c1">#   tags = {</span>
<span class="c1">#     Name = var.instance_tags[count.index]</span>
<span class="c1">#   }</span>
<span class="c1"># }</span>
    
<span class="c1">## 리소스 정의 파일에서 주석처리하여 삭제</span>
<span class="c1"># resource "aws_ssm_parameter" "this" {</span>
<span class="c1">#   count = length(var.instance_tags)</span>
<span class="c1">#   name  = var.instance_tags[count.index]</span>
<span class="c1">#   type  = "String"</span>
<span class="c1">#   value = aws_instance.this[count.index].id</span>
<span class="c1"># }    </span>
  
<span class="nx">removed</span> <span class="p">{</span> <span class="c1"># 추가</span>
  <span class="nx">from</span> <span class="p">=</span> <span class="nx">aws_ssm_parameter</span><span class="p">.</span><span class="nx">this</span>
<span class="p">}</span>
  
<span class="nx">removed</span> <span class="p">{</span> <span class="c1"># 추가</span>
  <span class="nx">from</span> <span class="p">=</span> <span class="nx">aws_instance</span><span class="p">.</span><span class="nx">this</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
      <li>실행
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tofu apply <span class="nt">-auto-approve</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    # aws_ssm_parameter.this[0] will be removed from the OpenTofu state but will not be destroyed</span>
<span class="c">#    ...</span>
<span class="c">#    # aws_ssm_parameter.this[1] will be removed from the OpenTofu state but will not be destroyed</span>
<span class="c">#    Apply complete! Resources: 0 added, 0 changed, 0 destroyed.</span>

<span class="c"># tfstate 파일 확인</span>
<span class="nv">$ </span><span class="nb">cat </span>terraform.tfstate | jq
    
<span class="nv">$ </span><span class="nb">cat </span>terraform.tfstate | jq | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'"i-'</span>
<span class="c"># =&gt; &lt;결과 없음&gt;         </span>
</code></pre></div>        </div>
        <p>상태파일에서 삭제된것을 확인할 수 있었습니다. AWS에서 리소스를 확인해보겠습니다.</p>
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws ssm describe-parameters | jq
<span class="nv">$ </span>aws ssm get-parameter <span class="nt">--name</span> <span class="s2">"web"</span>
<span class="nv">$ </span>aws ssm get-parameter <span class="nt">--name</span> <span class="s2">"web"</span> <span class="nt">--query</span> <span class="s2">"Parameter.Value"</span> <span class="nt">--output</span> text
<span class="c"># =&gt; i-036b9e057c2eb71d8</span>
<span class="nv">$ </span>aws ssm get-parameter <span class="nt">--name</span> <span class="s2">"app"</span>
<span class="nv">$ </span>aws ssm get-parameter <span class="nt">--name</span> <span class="s2">"app"</span> <span class="nt">--query</span> <span class="s2">"Parameter.Value"</span> <span class="nt">--output</span> text
<span class="c"># =&gt; i-0f8f05caabc524b47</span>
    
<span class="nv">$ </span>aws ec2 describe-instances <span class="nt">--query</span> <span class="s1">'Reservations[*].Instances[*].{InstanceID:InstanceId,PublicIP:PublicIpAddress,Name:Tags[?Key==`Name`]|[0].Value}'</span> <span class="nt">--output</span> json | jq <span class="nt">-r</span> <span class="s1">'.[][] | "\(.InstanceID)\t\(.PublicIP)\t\(.Name)"'</span>
<span class="c"># =&gt; i-036b9e057c2eb71d8     3.34.132.49     web</span>
<span class="c">#    i-0f8f05caabc524b47     3.35.51.118     app</span>
</code></pre></div>        </div>
        <p>상태 파일에서는 없어졌지만 AWS에 프로비저닝된 리소스는 남아있는것을 확인할 수 있습니다.</p>
      </li>
      <li>이렇게하여 <code class="language-plaintext highlighter-rouge">removed</code> 블록을 실습해보았습니다. AWS에서 실습한 리소스를 삭제하시거나, 
추가적으로 import 블록을 사용하여 상태파일에 다시 넣은 다음 destroy 하는것을 실습해보는것도 좋을것 같습니다.</li>
    </ul>
  </li>
</ul>

<h4 id="실습-test">[실습] Test</h4>

<ul>
  <li>OpenTofu에서는 <code class="language-plaintext highlighter-rouge">tofu test</code>라는 명령을 통해 구성파일의 내용을 테스트 할 수 있습니다. 실제 인프라를 프로비저닝하고 원하는 조건이 맞는지 확인하는 과정을 거칩니다.
<code class="language-plaintext highlighter-rouge">postcondition</code>과 유사한데 <strong>다른 점</strong>은 테스트 중에 <strong>생성한 리소스는 자동으로 삭제된다</strong>는 것입니다.</li>
  <li>사용 방법
    <ul>
      <li>먼저 구성파일과 같은 디렉터리 또는 <code class="language-plaintext highlighter-rouge">tests</code> 디렉터리 아래에 <code class="language-plaintext highlighter-rouge">*.tftest.hcl</code> 파일을 생성합니다.</li>
      <li>
<code class="language-plaintext highlighter-rouge">*.tftest.hcl</code> 파일에 테스트 코드를 작성합니다. 또한 테스트를 위한 변수파일 (.tfvars)가 필요하면 해당 파일도 <code class="language-plaintext highlighter-rouge">tests</code> 디렉터리에 만들면 테스트 시에만 사용 됩니다.</li>
      <li>
<code class="language-plaintext highlighter-rouge">*.tftest.hcl</code> 의 형태는 아래와 같습니다.
        <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nx">run</span> <span class="s2">"test"</span> <span class="p">{</span>
  <span class="nx">assert</span> <span class="p">{</span>
    <span class="nx">condition</span>     <span class="p">=</span> <span class="nx">file</span><span class="p">(</span><span class="nx">local_file</span><span class="p">.</span><span class="nx">test</span><span class="p">.</span><span class="nx">filename</span><span class="p">)</span> <span class="p">==</span> <span class="s2">"Hello world!"</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"Incorrect content in </span><span class="k">${</span><span class="nx">local_file</span><span class="p">.</span><span class="nx">test</span><span class="p">.</span><span class="nx">filename</span><span class="k">}</span><span class="s2">."</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>실습
    <ul>
      <li>main.tf 작성
        <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">variable</span> <span class="s2">"test"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">string</span>
<span class="p">}</span>
    
<span class="k">resource</span> <span class="s2">"local_file"</span> <span class="s2">"this"</span> <span class="p">{</span>
  <span class="nx">filename</span> <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="nx">path</span><span class="p">.</span><span class="k">module}</span><span class="s2">/test.txt"</span>
  <span class="nx">content</span>  <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">test</span>
<span class="p">}</span>     
</code></pre></div>        </div>
      </li>
      <li>tests/main.tftest.hcl 작성
        <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># tests/main.tftest.hcl           </span>
<span class="nx">run</span> <span class="s2">"test"</span> <span class="p">{</span>
  <span class="nx">assert</span> <span class="p">{</span>
    <span class="nx">condition</span>     <span class="p">=</span> <span class="nx">file</span><span class="p">(</span><span class="nx">local_file</span><span class="p">.</span><span class="nx">this</span><span class="p">.</span><span class="nx">filename</span><span class="p">)</span> <span class="p">==</span> <span class="kd">var</span><span class="p">.</span><span class="nx">test</span>
    <span class="nx">error_message</span> <span class="p">=</span> <span class="s2">"Incorrect content in file"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
      <li>실행 후 확인
        <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tofu init
<span class="nv">$ </span>tree .terraform
    
<span class="c"># Test 실행</span>
<span class="nv">$ </span>tofu <span class="nb">test</span>
<span class="c"># =&gt; tests/main.tftest.hcl... fail</span>
<span class="c">#      run "test"... fail</span>
<span class="c">#      │ Error: No value for required variable</span>
</code></pre></div>        </div>
      </li>
      <li>변수가 없다며 테스트가 실패합니다. 변수를 넣어서 다시 실행해 보겠습니다.
        <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 방법1. -var 로 변수를 넣어서 실행</span>
<span class="nv">$ </span>tofu <span class="nb">test</span> <span class="nt">-var</span> <span class="s1">'test=Hello world!'</span>
<span class="c"># =&gt; tests/main.tftest.hcl... pass</span>
<span class="c">#      run "test"... pass</span>
<span class="c">#    Success! 1 passed, 0 failed.</span>
    
<span class="c"># 방법2. tests/terraform.tfvars 파일 작성</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'test = "T101 4th thank you!"'</span> <span class="o">&gt;</span> tests/terraform.tfvars 
<span class="nv">$ </span>tofu <span class="nb">test</span>
<span class="c"># =&gt; tests/main.tftest.hcl... pass</span>
<span class="c">#      run "test"... pass</span>
<span class="c">#    Success! 1 passed, 0 failed.</span>
    
<span class="nv">$ </span>tofu state list
<span class="c"># =&gt; No state file was found!</span>
<span class="c"># 상태파일이 없다고 나오는데, 테스트를 위해 프로비저닝한 리소스는 자동으로 삭제되어서 별도로 상태파일을 생성하지 않는것 같습니다.</span>

<span class="nv">$ </span><span class="nb">cat </span>test.txt
<span class="c"># =&gt; cat: test.txt: No such file or directory</span>
<span class="c"># 테스트된 파일은 삭제된것을 확인할 수 있습니다.</span>
        
<span class="c"># Apply 확인</span>
<span class="nv">$ </span>tofu apply <span class="nt">-auto-approve</span>
<span class="nv">$ </span>tofu state list
<span class="c"># =&gt; local_file.this    </span>
<span class="nv">$ </span><span class="nb">cat </span>test.txt
<span class="c"># =&gt; T101 4th thank you!</span>
</code></pre></div>        </div>
      </li>
      <li>혹시나 해서 <code class="language-plaintext highlighter-rouge">tofu test</code>를 한번더 실행한 다음 결과를 확인해보겠습니다.
        <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tofu <span class="nb">test</span>
<span class="nv">$ </span>tofu state list
<span class="c"># =&gt; local_file.this</span>
<span class="nv">$ </span><span class="nb">cat </span>test.txt
<span class="c"># =&gt; cat: test.txt: No such file or directory</span>
</code></pre></div>        </div>
      </li>
      <li>이미 프로비저닝 된 상태에서 test를 할 경우 <strong>상태파일은 남아있지만 실제 리소스(여기서는 파일)은 삭제되</strong>는것 같습니다. 
프로덕션 환경에서 사용시 주의가 필요해보입니다. <img class="emoji" title=":sweat_smile:" alt=":sweat_smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png" height="20" width="20" loading="lazy">
</li>
    </ul>
  </li>
</ul>

<h4 id="실습-terraform을-opentofu-17로-이전하기">[실습] Terraform을 OpenTofu 1.7로 이전하기</h4>

<ul>
  <li>OpenTofu 1.7로 Terraform을 이전하는 방법을 실습해보겠습니다. Terraform 버전은 최소 1.8.2 이상을 사용할것을 권고한다 합니다.
여기에서는 Terraform 1.8.5 버전으로 실습해 보겠습니다.</li>
  <li>Tenv로 Terraform 1.8.5 설치
    <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tenv tf <span class="nb">install </span>1.8.5 
<span class="c"># =&gt; ...</span>
<span class="c">#    Installation of Terraform 1.8.5 successful</span>
<span class="nv">$ </span>tenv tf list
<span class="c"># =&gt;   1.8.5 (never used)</span>
<span class="nv">$ </span>tenv tf detect
</code></pre></div>    </div>
  </li>
  <li>main.tf 파일 작성
    <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># main.tf</span>
<span class="k">data</span> <span class="s2">"aws_ami"</span> <span class="s2">"ubuntu"</span> <span class="p">{</span>
    <span class="nx">most_recent</span> <span class="p">=</span> <span class="kc">true</span>
  
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"name"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"</span><span class="p">]</span>
    <span class="p">}</span>
  
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"virtualization-type"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"hvm"</span><span class="p">]</span>
    <span class="p">}</span>
  
    <span class="nx">owners</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"099720109477"</span><span class="p">]</span> <span class="c1"># Canonical</span>
<span class="p">}</span>
  
<span class="k">variable</span> <span class="s2">"instance_tags"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">list</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"web"</span><span class="p">,</span> <span class="s2">"app"</span><span class="p">]</span>
<span class="p">}</span>
  
<span class="k">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"this"</span> <span class="p">{</span>
  <span class="nx">count</span> <span class="p">=</span> <span class="nx">length</span><span class="p">(</span><span class="kd">var</span><span class="p">.</span><span class="nx">instance_tags</span><span class="p">)</span>
  <span class="nx">ami</span>                    <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_ami</span><span class="p">.</span><span class="nx">ubuntu</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">instance_type</span>          <span class="p">=</span> <span class="s2">"t3.micro"</span>
  
  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">instance_tags</span><span class="p">[</span><span class="nx">count</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>실행 후 확인
    <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 초기화</span>
<span class="nv">$ </span>terraform init
  
<span class="c"># 프로바이더 정보 확인</span>
<span class="nv">$ </span>tree .terraform 
<span class="c"># =&gt; .terraform</span>
<span class="c">#    └── providers</span>
<span class="c">#        └── registry.terraform.io</span>
<span class="c">#            └── hashicorp</span>
<span class="c">#                └── aws</span>
<span class="c">#                    └── 5.61.0  </span>
                                 
<span class="c"># 적용</span>
<span class="nv">$ </span>terraform apply <span class="nt">-auto-approve</span>
<span class="c"># =&gt; Apply complete! Resources: 2 added, 0 changed, 0 destroyed.</span>
  
<span class="c"># EC2 확인</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws ec2 describe-instances <span class="nt">--query</span> <span class="s2">"Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,InstanceName:Tags[?Key=='Name']|[0].Value,Status:State.Name}"</span> <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>instance-state-name,Values<span class="o">=</span>running <span class="nt">--output</span> text <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"------------------------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; app     3.38.165.56     running</span>
<span class="c">#    web     43.203.241.233  running</span>
  
<span class="c"># 상태 확인</span>
<span class="nv">$ </span>terraform state list
<span class="c"># =&gt; data.aws_ami.ubuntu</span>
<span class="c">#    aws_instance.this[0]</span>
<span class="c">#    aws_instance.this[1]</span>
  
<span class="c"># tfstate 파일 확인</span>
<span class="nv">$ </span><span class="nb">cat </span>terraform.tfstate | jq
</code></pre></div>    </div>
  </li>
  <li>마이그레이션
    <ul>
      <li>현재 최신 상태여부 확인
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>terraform plan 
<span class="c"># =&gt; No changes. Your infrastructure matches the configuration.</span>
</code></pre></div>        </div>
      </li>
      <li>tfstate 파일과 구성 파일 백업
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cp </span>terraform.tfstate terraform.tfstate.bak
<span class="nv">$ </span><span class="nb">cp </span>main.tf main.tf.bak
</code></pre></div>        </div>
      </li>
      <li>Terraform과 OpenTofu 간의 차이로 인한 수정이 불가피한 코드 변경
        <ul>
          <li>S3 Backend 사용시 다음의 변경이 필요합니다.
            <ul>
              <li>
<code class="language-plaintext highlighter-rouge">skip_s3_checksum</code> 옵션을 사용중이라면 OpenTofu는 필요로 하지 않기 때문에 삭제합니다.</li>
              <li>
<code class="language-plaintext highlighter-rouge">endpoints</code> =&gt; <code class="language-plaintext highlighter-rouge">sso</code> 옵션을 사용중이거나 <code class="language-plaintext highlighter-rouge">AWS_ENDPOINT_URL</code> 환경 변수를 사용중이라면 삭제합니다.</li>
            </ul>
          </li>
          <li>
<code class="language-plaintext highlighter-rouge">removed</code> 블록 삭제 : OpenTofu의 <code class="language-plaintext highlighter-rouge">removed</code> 블록과는 동작 방식 차이가 있기 때문에 삭제합니다.</li>
        </ul>
      </li>
      <li>OpenTofu 초기화 및 Plan
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 초기화</span>
<span class="nv">$ </span>tofu init
<span class="nv">$ </span>tree .terraform <span class="nt">-L</span> 5 
<span class="c"># =&gt; .terraform</span>
<span class="c">#    └── providers</span>
<span class="c">#        ├── registry.opentofu.org</span>
<span class="c">#        │   └── hashicorp</span>
<span class="c">#        │       └── aws</span>
<span class="c">#        │           └── 5.61.0</span>
<span class="c">#        └── registry.terraform.io</span>
<span class="c">#            └── hashicorp</span>
<span class="c">#                └── aws</span>
<span class="c">#                    └── 5.61.0</span>
    
<span class="c"># Plan</span>
<span class="nv">$ </span>tofu plan
<span class="c"># =&gt; No changes. Your infrastructure matches the configuration.</span>
</code></pre></div>        </div>
      </li>
      <li>정상적으로 Terraform을 OpenTofu로 마이그레이션 완료한것 같습니다. <code class="language-plaintext highlighter-rouge">.terraform</code> 디렉터리에는 Terraform용 프로바이더와 OpenTofu용 프로바이더 둘 다 존재하는것을 확인할 수 있습니다.</li>
      <li>이제 실제 적용해 보겠습니다.
        <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tofu apply <span class="nt">-auto-approve</span>
<span class="c"># =&gt; No changes. Your infrastructure matches the configuration.</span>
<span class="c">#    OpenTofu has compared your real infrastructure against your configuration and found no differences, so no changes are needed.</span>
<span class="c">#    Apply complete! Resources: 0 added, 0 changed, 0 destroyed.</span>
    
<span class="c"># EC2 인스턴스에 신규 태그를 추가 후 apply 해보겠습니다.</span>
<span class="nv">$ </span>vi main.tf 
...
tags <span class="o">=</span> <span class="o">{</span>
  Name <span class="o">=</span> var.instance_tags[count.index]
  T101 <span class="o">=</span> <span class="s2">"end"</span>
<span class="o">}</span>
...
    
<span class="c"># 적용</span>
<span class="nv">$ </span>tofu apply <span class="nt">-auto-approve</span>
</code></pre></div>        </div>
        <p><img src="/assets/2024/t101-4th/20240803_terraform_w8_opentofu_2.png" alt="img.png" loading="lazy" width="203" height="185"></p>
      </li>
    </ul>
  </li>
  <li>실습 리소스 삭제
    <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tofu destroy <span class="nt">-auto-approve</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="opentofu-18">OpenTofu 1.8</h3>

<ul>
  <li>OpenTofu 1.8이 지난 7월 29일 출시 되었습니다. 자세한 소식은 아래의 블로그에서 확인할 수 있습니다.
    <ul>
      <li><a href="https://opentofu.org/blog/opentofu-1-8-0/">OpenTofu 1.8 릴리즈 블로그</a></li>
      <li><a href="https://github.com/opentofu/opentofu/releases/tag/v1.8.0">OpenTofu 1.8 Github</a></li>
    </ul>
  </li>
  <li>주요 변경점은 아래와 같습니다.
    <ul>
      <li>variable과 locals를 module 소스와 backend 설정에 사용할 수 있게 되었습니다.</li>
      <li>
<code class="language-plaintext highlighter-rouge">.tofu</code> 확장자가 추가되었습니다. <code class="language-plaintext highlighter-rouge">.tf</code> 파일에 추가적으로 OpenTofu 전용 기능을 사용할 수 있습니다.</li>
      <li>테스트 프레임워크에서 사용할 수 있는 <code class="language-plaintext highlighter-rouge">override_resource</code>, <code class="language-plaintext highlighter-rouge">override_data</code>, <code class="language-plaintext highlighter-rouge">override_module</code>,
<code class="language-plaintext highlighter-rouge">mock_resource</code>, <code class="language-plaintext highlighter-rouge">mock_data</code>, <code class="language-plaintext highlighter-rouge">mock_module</code> 등이 추가되었습니다.</li>
      <li>Deprecation : <code class="language-plaintext highlighter-rouge">use_legacy_workflow</code> 가 S3 backend 설정에서 제거되었습니다.</li>
    </ul>
  </li>
  <li>1.8.0 사용 설정
    <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tenv tofu list
<span class="c"># =&gt; * 1.7.3</span>
<span class="nv">$ </span>tenv tofu list-remote 
<span class="c"># =&gt; ...</span>
<span class="c">#    1.7.3 (installed)</span>
<span class="c">#    ...</span>
<span class="c">#    1.8.0 </span>
  
<span class="c"># 설치</span>
<span class="nv">$ </span>tenv tofu <span class="nb">install </span>1.8.0
<span class="nv">$ </span>tenv tofu list
<span class="nv">$ </span>tenv tofu use 1.8.0
<span class="nv">$ </span>tenv tofu detect
  
<span class="c"># 버전 확인</span>
<span class="nv">$ </span>tofu <span class="nt">-h</span>
<span class="nv">$ </span>tofu version
<span class="c"># =&gt; OpenTofu v1.8.0</span>
<span class="c">#    on darwin_arm64</span>
<span class="c">#    + provider registry.opentofu.org/hashicorp/aws v5.61.0</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="실습-early-variablelocals-evaluation">[실습] Early variable/locals evaluation</h4>

<p><img src="/assets/2024/t101-4th/20240803_terraform_w8_opentofu_3.png" alt="img.png" loading="lazy" width="1820" height="1101">
기존에는 variable을 Backend 설정이나 mobule 블록, 암호화 설정 등에서 사용하지 못하였는데 OpenTofu 1.8부터는 사용할 
수 있게 되었습니다. 실습을 통해 알아보겠습니다.</p>

<ul>
  <li>AWS S3 버킷 생성 : Backend State 저장용도
    <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws s3 mb s3://&lt;생성할 고유한 S3 버킷명&gt; <span class="nt">--region</span> ap-northeast-2 
<span class="nv">$ </span>aws s3 mb s3://t101-4th-tofu-1-8 <span class="nt">--region</span> ap-northeast-2
  
<span class="c"># 버킷 확인</span>
<span class="nv">$ </span>aws s3 <span class="nb">ls</span> 
</code></pre></div>    </div>
  </li>
  <li>main.tf 생성
    <div class="language-tf highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># main.tofu</span>
<span class="k">variable</span> <span class="s2">"s3bucket_myname"</span> <span class="p">{</span>
 <span class="nx">type</span> <span class="p">=</span> <span class="nx">string</span>
 <span class="nx">default</span> <span class="p">=</span> <span class="s2">"t101-4th-tofu-1-8"</span> <span class="c1"># 생성한 S3 버킷명</span>
<span class="p">}</span>
  
<span class="k">terraform</span> <span class="p">{</span>
  <span class="nx">backend</span> <span class="s2">"s3"</span> <span class="p">{</span>
    <span class="nx">bucket</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">s3bucket_myname</span>
    <span class="nx">key</span> <span class="p">=</span> <span class="s2">"terraform.tfstate"</span>
    <span class="nx">region</span> <span class="p">=</span> <span class="s2">"ap-northeast-2"</span>
    <span class="nx">encrypt</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>
  
<span class="k">data</span> <span class="s2">"aws_ami"</span> <span class="s2">"ubuntu"</span> <span class="p">{</span>
    <span class="nx">most_recent</span> <span class="p">=</span> <span class="kc">true</span>
  
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"name"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"</span><span class="p">]</span>
    <span class="p">}</span>
  
    <span class="nx">filter</span> <span class="p">{</span>
        <span class="nx">name</span>   <span class="p">=</span> <span class="s2">"virtualization-type"</span>
        <span class="nx">values</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"hvm"</span><span class="p">]</span>
    <span class="p">}</span>
  
    <span class="nx">owners</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"099720109477"</span><span class="p">]</span> <span class="c1"># Canonical</span>
<span class="p">}</span>
  
<span class="k">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"this"</span> <span class="p">{</span>
  <span class="nx">ami</span>                    <span class="p">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">aws_ami</span><span class="p">.</span><span class="nx">ubuntu</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">instance_type</span>          <span class="p">=</span> <span class="s2">"t3.micro"</span>
  
  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="p">=</span> <span class="s2">"final-labs"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>초기화 및 프로바이더 확인
    <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 테라폼으로 확인</span>
<span class="nv">$ </span>terraform init
<span class="c"># =&gt; Initializing the backend...</span>
<span class="c">#    │ Error: Variables not allowed</span>
<span class="c">#    │   on main.tf line 8, in terraform:</span>
<span class="c">#    │    8:     bucket = var.s3bucket_myname</span>
<span class="c">#    │ Variables may not be used here.</span>
  
<span class="c"># OpenTofu 1.7.x로 확인</span>
<span class="nv">$ </span>tenv tofu use 1.7.3
<span class="nv">$ </span>tofu version
<span class="c"># =&gt; OpenTofu v1.7.3</span>
<span class="c">#    on darwin_arm64</span>
<span class="nv">$ </span>tofu init
<span class="c"># =&gt; Initializing the backend...</span>
<span class="c">#    │ Error: Variables not allowed</span>
<span class="c">#    │   on main.tf line 8, in terraform:</span>
<span class="c">#    │    8:     bucket = var.s3bucket_myname</span>
<span class="c">#    │ Variables may not be used here.</span>
  
<span class="c"># OpenTofu 1.8.0로 확인</span>
<span class="nv">$ </span>tenv tofu use 1.8.0
<span class="nv">$ </span>
<span class="c"># =&gt; OpenTofu v1.8.0</span>
<span class="c">#    on darwin_arm64</span>
<span class="nv">$ </span>tofu init
<span class="c"># =&gt; Initializing the backend...    </span>
<span class="c">#    ...</span>
<span class="c">#    OpenTofu has been successfully initialized!</span>
</code></pre></div>    </div>
    <p>Terraform이나 OpenTofu 1.7.x에서는 Backend 설정에 variable을 사용할 수 없었지만, OpenTofu 1.8.0에서는 사용할 수 있게 된것을 확인하였습니다.
이제 적용을 해서 실제 동작하는지 확인해보겠습니다.</p>
  </li>
  <li>실행
    <div class="language-sh highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tofu apply <span class="nt">-auto-approve</span>
<span class="c"># =&gt; Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span>
  
<span class="c"># 확인</span>
<span class="nv">$ </span>aws s3 <span class="nb">ls </span>s3://t101-4th-tofu-1-8
<span class="c"># =&gt; 2024-08-03 21:04:56       4890 terraform.tfstate</span>
<span class="nv">$ </span><span class="nb">cat</span> .terraform/terraform.tfstate | <span class="nb">grep </span>bucket
<span class="c"># =&gt; "bucket": "t101-4th-tofu-1-8",  </span>
</code></pre></div>    </div>
    <p>잘 동작하여 상태파일이 S3 Backend에 잘 저장되었음을 확인할 수 있습니다.</p>
  </li>
  <li>실습 리소스 삭제
    <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 리소스 삭제</span>
<span class="nv">$ </span>tofu apply <span class="nt">-destroy</span> <span class="nt">-auto-approve</span>
  
<span class="c"># 상태파일은 아직 존재 합니다.</span>
<span class="nv">$ </span>aws s3 <span class="nb">ls </span>s3://t101-4th-tofu-1-8
  
<span class="c"># 상태파일을 삭제하고</span>
<span class="nv">$ </span>aws s3 <span class="nb">rm </span>s3://t101-4th-tofu-1-8 <span class="nt">--recursive</span>
<span class="c"># 버킷을 삭제합니다.</span>
<span class="nv">$ </span>aws s3 rb s3://t101-4th-tofu-1-8
  
<span class="c"># 버킷이 삭제되었음을 확인합니다.</span>
<span class="nv">$ </span>aws s3 <span class="nb">ls</span> 
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="마치며">마치며</h2>

<p>이렇게 OpenTofu에 대하여 알아보았습니다.
Terraform이 계속 오픈소스 커뮤니티의 사랑을 받았었다면 좋았겠지만,
그러지 못하여 OpenTofu가 나온것을 보면 다소 씁쓸합니다.
아무쪼록 경쟁을 통해 둘 다 발전하는 모습을 보여주었으면 좋겠습니다.</p>

<p>이번 테라폼 기초 입문 실습 스터디 4기 과정을 통해 IaC가 무엇인지와
Terraform 사용 방법 등 많은것을 배울 수 있었습니다.
가장 큰 결실은 블로그를 만들었다는 것입니다!
회사 팀장님의 추천에 얼떨결에 시작하였고,
매주 블로그 글 쓰기가 벅차서 몇 번이고 포기 할뻔 했지만 
무사히 마칠 수 있어서 감개무량합니다. (이번주도 무사히 지나가야 하긴 합니다. <img class="emoji" title=":sweat_smile:" alt=":sweat_smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png" height="20" width="20" loading="lazy">)
앞으로도 꾸준히 배우고 누군가에게 도움이 될 수 있도록 
블로그에 기록하며 성장해 나가겠습니다.</p>

<p>함께 고생한 Gasida님을 비롯한 T101 4기 멤버분들도 모두 고생 많으셨습니다.
특히 매주 실습을 준비하고, 강의를 진행해주신 Gasida님과 조력자 분들께 감사드립니다.
다음 스터디도 참여할 수 있다면 또 열심히 달려보겠습니다.
다들 건강하시고 행복한 모습으로 다시 뵙기를 고대합니다! <img class="emoji" title=":smile:" alt=":smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png" height="20" width="20" loading="lazy"></p>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#opentofu">OpenTofu</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EA%B0%9C%EC%9A%94">개요</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%8A%B9%EC%9D%B4%EC%82%AC%ED%95%AD">특이사항</a></li>
<li class="toc-entry toc-h3"><a href="#opentofu-%EC%84%A4%EC%B9%98">OpenTofu 설치</a></li>
<li class="toc-entry toc-h3">
<a href="#opentofu-17">OpenTofu 1.7</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-provider-defined-functions">[실습] Provider-defined functions</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-loopable-import-blocks">[실습] Loopable import blocks</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-state-file-encryption---local">[실습] State file encryption - Local</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-removed-block">[실습] Removed Block</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-test">[실습] Test</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-terraform%EC%9D%84-opentofu-17%EB%A1%9C-%EC%9D%B4%EC%A0%84%ED%95%98%EA%B8%B0">[실습] Terraform을 OpenTofu 1.7로 이전하기</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#opentofu-18">OpenTofu 1.8</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-early-variablelocals-evaluation">[실습] Early variable/locals evaluation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2024-08-03-T101-Study-Terraform-Week-8/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2024-07-27-T101-Study-Terraform-Week-7/">« [T101 4기] 테라폼으로 AWS EKS 배포</a>
  
  
  <a class="next" href="/posts/2024-08-27-KANS-Study-Week1/">[KANS 3기] 컨테이너 격리 »</a>
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2024-08-03-T101-Study-Terraform-Week-8/";
this.page.identifier = "/posts/T101 Study - Terraform Week 8";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>공부 기록과 개발 이야기를 담은 블로그입니다.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>
  </body>

</html>
