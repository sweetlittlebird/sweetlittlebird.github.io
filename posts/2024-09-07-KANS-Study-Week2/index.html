<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[KANS 3기] K8S Flannel CNI &amp; PAUSE | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[KANS 3기] K8S Flannel CNI &amp; PAUSE">
<meta property="og:locale" content="ko">
<meta name="description" content="지난주에 이어 이번주에는 쿠버네티스에대해 간략하게 알아보고 KIND, PAUSE 컨테이너와 Flannel CNI에 대해 알아보겠습니다.">
<meta property="og:description" content="지난주에 이어 이번주에는 쿠버네티스에대해 간략하게 알아보고 KIND, PAUSE 컨테이너와 Flannel CNI에 대해 알아보겠습니다.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2024-09-07-KANS-Study-Week2/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2024-09-07-KANS-Study-Week2/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-09-07T17:40:18+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[KANS 3기] K8S Flannel CNI &amp; PAUSE">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-09-07T17:40:18+09:00","datePublished":"2024-09-07T17:40:18+09:00","description":"지난주에 이어 이번주에는 쿠버네티스에대해 간략하게 알아보고 KIND, PAUSE 컨테이너와 Flannel CNI에 대해 알아보겠습니다.","headline":"[KANS 3기] K8S Flannel CNI &amp; PAUSE","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2024-09-07-KANS-Study-Week2/"},"url":"https://sweetlittlebird.github.io/posts/2024-09-07-KANS-Study-Week2/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body class="body--contents">
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">소개</a><a class="page-link" href="/posts/">글 목록</a>
</div>
      </nav>
</div>
  
  <span id="scroll-indicator"></span>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[KANS 3기] K8S Flannel CNI &amp; PAUSE</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-09-07T17:40:18+09:00" itemprop="datePublished">2024년 09월 07일에 작성
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>목차</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2"><a href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EC%86%8C%EA%B0%9C">쿠버네티스 소개</a></li>
<li class="toc-entry toc-h2">
<a href="#kind-%EC%86%8C%EA%B0%9C-%EB%B0%8F-%EC%84%A4%EC%B9%98">kind 소개 및 설치</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%84%A4%EC%B9%98">설치</a></li>
<li class="toc-entry toc-h3"><a href="#1-node-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B5%AC%EC%84%B1-%ED%85%8C%EC%8A%A4%ED%8A%B8">1-Node 클러스터 구성 테스트</a></li>
<li class="toc-entry toc-h3"><a href="#2-node-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B5%AC%EC%84%B1-%ED%85%8C%EC%8A%A4%ED%8A%B8">2-Node 클러스터 구성 테스트</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EA%B4%80%EB%A0%A8-%EC%A0%95%EB%B3%B4-%EC%A1%B0%EC%82%AC">쿠버네티스 관련 정보 조사</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%8C%8C%EB%93%9C-%EC%83%9D%EC%84%B1-%EB%B0%8F-%ED%99%95%EC%9D%B8">파드 생성 및 확인</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%BB%A8%ED%8A%B8%EB%A1%A4-%ED%94%8C%EB%A0%88%EC%9D%B8-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EC%A0%95%EB%B3%B4-%ED%99%95%EC%9D%B8">컨트롤 플레인 컨테이너 정보 확인</a></li>
<li class="toc-entry toc-h3"><a href="#multi-node-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-with-kube-ops-view--mapping-ports">Multi-Node 클러스터 with kube-ops-view &amp; mapping ports</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#%ED%8C%8C%EB%93%9C--pause-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88">파드 &amp; PAUSE 컨테이너</a>
<ul>
<li class="toc-entry toc-h3"><a href="#k8s-cri-container-runtime-interface">K8S CRI (Container Runtime Interface)</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%8C%8C%EB%93%9C-pod">파드 (Pod)</a></li>
<li class="toc-entry toc-h3">
<a href="#pause-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88">PAUSE 컨테이너</a>
<ul>
<li class="toc-entry toc-h4"><a href="#pause-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EC%8B%A4%EC%8A%B5">Pause 컨테이너 실습</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#cni-container-network-interface">CNI (Container Network Interface)</a>
<ul>
<li class="toc-entry toc-h3"><a href="#4%EA%B0%80%EC%A7%80-%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD%EA%B3%BC-4%EA%B0%80%EC%A7%80-%EB%AC%B8%EC%A0%9C">4가지 요구사항과 4가지 문제</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#flannel">Flannel</a>
<ul>
<li class="toc-entry toc-h3"><a href="#kind-%EC%99%80-flannel-%EC%84%A4%EC%B9%98">Kind 와 Flannel 설치</a></li>
<li class="toc-entry toc-h3"><a href="#flannel-%EC%84%A4%EC%B9%98-%ED%99%95%EC%9D%B8">Flannel 설치 확인</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%86%B5%EC%8B%A0-%ED%9D%90%EB%A6%84-%EC%9D%B4%ED%95%B4">통신 흐름 이해</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
    </div>
    <h2 id="들어가며">들어가며</h2>

<p>지난주에 이어 이번주에는 쿠버네티스에대해 간략하게 알아보고 KIND, PAUSE 컨테이너와 Flannel CNI에 대해 알아보겠습니다.
KANS 3기 2주차 스터디를 시작하겠습니다.</p>

<h2 id="쿠버네티스-소개">쿠버네티스 소개</h2>

<ul>
  <li>쿠버네티스는 구글에서 오픈소스로 공개한 컨테이너화된 애플리케이션을 자동으로 배포, 스케일링 및 관리하는 오픈소스 플랫폼입니다.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_1.gif" alt="20240907_kans_w2_1.gif" class="image-center" loading="lazy" width="693" height="359">
<em class="image-caption">출처: <a href="https://blog.naver.com/love_tolty/222167051615">https://blog.naver.com/love_tolty/222167051615</a></em></p>

<ul>
  <li>
    <p>쿠버네티스는 위의 그림과 같이 다양한 컴포넌트로 이루어져 있습니다. 각 요소를 살펴보면 아래와 같습니다.</p>
  </li>
  <li>
<strong>Control Plane(마스터 노드)</strong> : 마스터는 단일 서버 혹은 고가용성을 위한 클러스터 마스터로 구축
    <ul>
      <li>kube-<strong>apiserver</strong> : <strong>모든 요청</strong>을 받아 드리는 <strong>API 서버</strong>
</li>
      <li>etcd : 클러스터내 모든 메타 정보를 저장하는 key/value DB 서비스</li>
      <li>kube-scheduler : 컨테이너를 워커 노드에 배치하는 스케줄러</li>
      <li>kube-controller-manager : 현재 상태와 바라는 상태를 지속적으로 확인하며 특정 이벤트에 따라 특정 동작을 수행하는 컨트롤러 - <a href="https://kubernetes.io/docs/concepts/architecture/controller/">링크</a>
</li>
      <li>cloud-controller-manager : (AWS, GCP, Azure 등 클라우드 플랫폼에 특화된 리소스를 제어하는 클라우드 컨트롤러 - <a href="https://kubernetes.io/docs/concepts/architecture/cloud-controller/">링크</a>
</li>
    </ul>
  </li>
  <li>
<strong>Worker Node(워커 노드)</strong> - <a href="https://kubernetes.io/docs/concepts/architecture/nodes/">링크</a>
    <ul>
      <li>kubelet : 마스터의 명령에 따라 컨테이너의 라이프 사이클을 관리하는 노드 관리자</li>
      <li>kube-proxy : 컨테이너의 네트워킹을 책임지는 프록시, 네트워크 규칙을 유지 관리</li>
      <li>Container Runtime : 실제 컨테이너를 실행하는 컨테이너 실행 환경, (ContainerD, CRI-O, …) - <a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">링크</a>
</li>
    </ul>
  </li>
  <li>
<strong>Addon(애드온)</strong>
    <ul>
      <li>CNI : Container Network Interface 는 k8s 네트워크 환경을 구성해줍니다.
        <ul>
          <li>예) Flannel, Calico, Weave Net, Cilium, …</li>
        </ul>
      </li>
      <li>DNS : 클러스터 내부 DNS 서비스를 제공합니다.
        <ul>
          <li>예) CoreDNS, Kube-DNS, …</li>
        </ul>
      </li>
      <li>기타 : 모니터링, 대시보드, 로깅 등등</li>
    </ul>
  </li>
</ul>

<hr>

<h2 id="kind-소개-및-설치">kind 소개 및 설치</h2>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_2.png" alt="img.png" class="w-30 image-center" loading="lazy" width="985" height="594"></p>

<p>kind는 <strong>K</strong>ubernetes <strong>IN</strong> <strong>D</strong>ocker의 약자로, 로컬 환경에서 쿠버네티스 클러스터를 쉽게 구성할 수 있도록 도와주는 도구입니다. 이름에서 알 수 있듯이 Kubernetes를 Docker 안에서 DIND(Docker in Docker) 방식으로 구동시켜주는 도구입니다.
minikube나 k3s 등과 달리 <strong>Docker만 설치되어 있으면 손쉽게 쿠버네티스 클러스터를 구성</strong>할 수 있습니다.</p>

<ul>
  <li>kind의 구조를 그림으로 표현하면 아래와 같습니다.
<img src="/assets/2024/kans-3th/w2/20240907_kans_w2_3.png" alt="img.png" class="image-center" loading="lazy" width="2560" height="1440">
<em class="image-caption">출처 : <a href="[https://kind.sigs.k8s.io/docs/design/initial/">https://kind.sigs.k8s.io/docs/design/initial/</a></em>
</li>
</ul>

<h3 id="설치">설치</h3>

<p>제가 사용중인 macOS를 기준으로 작성하였습니다. macOS에서 테라폼을 설치하려면 Homebrew를 이용하여 설치할 수 있습니다.
(홈브루 설치 방법은 <a href="https://whalec.io/homebrew-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EC%82%AC%EC%9A%A9-%EB%B0%A9%EB%B2%95">https://whalec.io/homebrew-설치-및-사용-방법</a> 를 참고하세요.)</p>

<ul>
  <li>kind 설치 및 필수 툴 설치</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install Kind</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kind
<span class="nv">$ </span>kind <span class="nt">--version</span>
<span class="c"># =&gt; kind version 0.24.0</span>

<span class="c"># Install kubectl</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubernetes-cli
<span class="nv">$ </span>kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Client Version: v1.31.0</span>
<span class="c">#    Kustomize Version: v5.4.2</span>

<span class="c"># Install Helm</span>
<span class="nv">$ </span>brew <span class="nb">install </span>helm
<span class="nv">$ </span>helm version
<span class="c"># =&gt; version.BuildInfo{Version:&amp;quot;v3.15.4&amp;quot;, GitCommit:&amp;quot;fa9efb07d9d8debbb4306d72af76a383895aa8c4&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;, GoVersion:&amp;quot;go1.22.6&amp;quot;}</span>

<span class="c"># Install Wireshark : 캡처된 패킷 확인</span>
<span class="nv">$ </span>brew <span class="nb">install</span> <span class="nt">--cask</span> wireshark

<span class="c"># (선택) kubectl 출력 시 하이라이트 처리</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubecolor
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"alias kubectl=kubecolor"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"compdef kubecolor=kubectl"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
</code></pre></div></div>

<h3 id="1-node-클러스터-구성-테스트">1-Node 클러스터 구성 테스트</h3>

<ul>
  <li>간단한 클러스터를 만들고 테스트 해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 클러스터 배포 전 확인</span>
<span class="nv">$ </span>docker ps

<span class="c"># Create a cluster with kind</span>
<span class="nv">$ </span>kind create cluster
<span class="c"># =&gt; Creating cluster &amp;quot;kind&amp;quot; ...</span>
<span class="c">#    &lt;span style="color:green;"&gt;✓&lt;/span&gt; Ensuring node image (kindest/node:v1.31.0) 🖼</span>
<span class="c">#    &lt;span style="color:green;"&gt;✓&lt;/span&gt; Preparing nodes 📦 </span>
<span class="c">#    &lt;span style="color:green;"&gt;✓&lt;/span&gt; Writing configuration 📜</span>
<span class="c">#    &lt;span style="color:green;"&gt;✓&lt;/span&gt; Starting control-plane 🕹️</span>
<span class="c">#    &lt;span style="color:green;"&gt;✓&lt;/span&gt; Installing CNI 🔌</span>
<span class="c">#    &lt;span style="color:green;"&gt;✓&lt;/span&gt; Installing StorageClass 💾</span>
<span class="c">#    Set kubectl context to &amp;quot;kind-kind&amp;quot;</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-kind </span>
<span class="c">#    </span>
<span class="c">#    Not sure what to do next? 😅  Check out https://kind.sigs.k8s.io/docs/user/quick-start/</span>

<span class="c"># 클러스터 배포 확인</span>
<span class="nv">$ </span>kind get clusters
<span class="nv">$ </span>kind get nodes
<span class="nv">$ </span>kubectl cluster-info

<span class="c"># 노드 정보 확인</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide

<span class="c"># 파드 정보 확인</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
<span class="nv">$ </span>kubectl get componentstatuses

<span class="c"># 컨트롤플레인 (컨테이너) 노드 1대가 실행</span>
<span class="nv">$ </span>docker ps
<span class="nv">$ </span>docker images

<span class="c"># kube config 파일 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config

<span class="c"># nginx 파드 배포 및 확인 : 컨트롤플레인 노드인데 파드가 배포 될까요?</span>
<span class="nv">$ </span>kubectl run nginx <span class="nt">--image</span><span class="o">=</span>nginx:alpine
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>

<span class="c"># 노드에 Taints 정보 확인</span>
<span class="nv">$ </span>kubectl describe node | <span class="nb">grep </span>Taints
<span class="c"># =&gt; Taints:             &lt;none&gt;</span>

<span class="c"># 클러스터 삭제</span>
<span class="nv">$ </span>kind delete cluster

<span class="c"># kube config 삭제 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
</code></pre></div></div>

<ul>
  <li>테스트 중에 노드가 커트롤 플레인 하나 뿐인데도 파드가 배포되는것을 확인할 수 있습니다.</li>
  <li>
<code class="language-plaintext highlighter-rouge">kubectl describe node | grep Taints</code>를 통해 확인해본 결과 <code class="language-plaintext highlighter-rouge">=&gt; Taints: &lt;none&gt;</code>로 컨트롤 플레인에 보통 걸려있는 taint가 없어서 파드가 배포되는 것을 확인할 수 있습니다.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_4.png" alt="img.png" loading="lazy" width="1334" height="1256"></p>

<h3 id="2-node-클러스터-구성-테스트">2-Node 클러스터 구성 테스트</h3>

<ul>
  <li>이번에는 좀 더 나아가서 control-plane과 worker의 2개의 노드로 구성된 KIND 클러스터를 만들고, 클러스터 구성을 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 클러스터 배포 전 확인</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span>

<span class="c"># kind 는 별도 도커 네트워크 생성 후 사용 : 기본값 172.18.0.0/16</span>
<span class="nv">$ </span>docker network <span class="nb">ls</span>
<span class="c"># =&gt; NETWORK ID     NAME                     DRIVER    SCOPE</span>
<span class="c">#    ...</span>
<span class="c">#    3bbcc6aa8f38   kind                     bridge    local</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>docker inspect kind | jq
<span class="c"># =&gt; [</span>
<span class="c">#      {</span>
<span class="c">#        &amp;quot;Name&amp;quot;: &amp;quot;kind&amp;quot;,</span>
<span class="c">#        &amp;quot;Driver&amp;quot;: &amp;quot;bridge&amp;quot;,</span>
<span class="c">#        ...</span>
<span class="c">#        &amp;quot;IPAM&amp;quot;: {</span>
<span class="c">#          &amp;quot;Driver&amp;quot;: &amp;quot;default&amp;quot;,</span>
<span class="c">#          &amp;quot;Options&amp;quot;: {},</span>
<span class="c">#          &amp;quot;Config&amp;quot;: [</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;Subnet&amp;quot;: &amp;quot;172.20.0.0/16&amp;quot;,</span>
<span class="c">#              &amp;quot;Gateway&amp;quot;: &amp;quot;172.20.0.1&amp;quot;</span>
<span class="c">#            }</span>
<span class="c">#          ]</span>
<span class="c">#        },</span>
<span class="c">#       ...</span>
<span class="c">#      }</span>
<span class="c">#    ]</span>

<span class="c"># KIND로 control-plane, worker라는 2개의 노드를 가진 클러스터 만들기</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOT</span><span class="sh"> &gt; kind-2node.yaml 
# two node (one workers) cluster config
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
</span><span class="no">EOT
</span><span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-2node.yaml <span class="nt">--name</span> myk8s

<span class="c"># 확인</span>
<span class="nv">$ </span>kind get nodes <span class="nt">--name</span> myk8s
<span class="c"># =&gt; myk8s-worker</span>
<span class="c">#    myk8s-control-plane</span>

<span class="c"># k8s api 주소 확인</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; &lt;span style="color:green;"&gt;Kubernetes control plane&lt;/span&gt; is running at &lt;span style="color:olive;"&gt;https://127.0.0.1:58638&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:green;"&gt;CoreDNS&lt;/span&gt; is running at &lt;span style="color:olive;"&gt;https://127.0.0.1:58638/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>

<span class="c"># 호스트에서 접속 테스트 </span>
<span class="nv">$ </span>curl <span class="nt">-k</span> https://localhost:58638
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;kind&amp;quot;: &amp;quot;Status&amp;quot;,</span>
<span class="c">#      &amp;quot;apiVersion&amp;quot;: &amp;quot;v1&amp;quot;,</span>
<span class="c">#      &amp;quot;metadata&amp;quot;: {},</span>
<span class="c">#      &amp;quot;status&amp;quot;: &amp;quot;Failure&amp;quot;,</span>
<span class="c">#      &amp;quot;message&amp;quot;: &amp;quot;forbidden: User \&amp;quot;system:anonymous\&amp;quot; cannot get path \&amp;quot;/\&amp;quot;&amp;quot;,</span>
<span class="c">#      &amp;quot;reason&amp;quot;: &amp;quot;Forbidden&amp;quot;,</span>
<span class="c">#      &amp;quot;details&amp;quot;: {},</span>
<span class="c">#      &amp;quot;code&amp;quot;: 403</span>
<span class="c">#    } # 호스트에서 접속이 됩니다! 왜 그럴까요?</span>

<span class="nv">$ </span>docker ps <span class="c"># 포트 포워딩 정보 확인</span>
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS         PORTS                                  NAMES</span>
<span class="c">#    6228f280b992   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entr…&amp;quot;   3 minutes ago   Up 3 minutes   0.0.0.0:30000-30001-&amp;gt;30000-30001/tcp   myk8s-worker</span>
<span class="c">#    219113c36204   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entr…&amp;quot;   3 minutes ago   Up 3 minutes   127.0.0.1:58638-&amp;gt;6443/tcp              myk8s-control-plane</span>

<span class="c"># 도커에서 127.0.0.1:58638-&amp;gt;6443/tcp 로 포트포워딩을 하기 때문인것을 확인할 수 있습니다. </span>

<span class="c"># apiserver 프로세스 확인</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ss <span class="nt">-tnlp</span> | <span class="nb">grep </span>6443
<span class="c"># =&gt; LISTEN 0      4096               *:6443             *:*    users:((&amp;quot;kube-apiserver&amp;quot;,pid=584,fd=3)) </span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>kube-apiserver <span class="nt">-owide</span> <span class="c"># 파드 IP 확인</span>
<span class="c"># =&gt; NAME                                 READY   STATUS    RESTARTS   AGE     IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-apiserver-myk8s-control-plane   1/1     Running   0          5m39s   172.20.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c"># kube-apiserver 파드 상세 정보 확인</span>
<span class="nv">$ </span>kubectl describe  pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>kube-apiserver

<span class="c"># health check 주소 접속 확인</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane curl <span class="nt">-k</span> https://localhost:6443/livez <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; ok</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane curl <span class="nt">-k</span> https://localhost:6443/readyz <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; ok</span>

<span class="c"># 노드 정보 확인 : CRI 는 containerd 사용</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   7m15s   v1.31.0   172.20.0.2    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker          Ready    &amp;lt;none&amp;gt;          7m1s    v1.31.0   172.20.0.3    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>

<span class="c"># 파드 정보 확인 : CNI 는 kindnet 사용</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE   IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system          coredns-6f6b679f8f-9gxnw                      1/1     Running   0          10m   10.244.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          etcd-myk8s-control-plane                      1/1     Running   0          10m   172.20.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kindnet-b5brb                                 1/1     Running   0          10m   172.20.0.3   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-apiserver-myk8s-control-plane            1/1     Running   0          10m   172.20.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-controller-manager-myk8s-control-plane   1/1     Running   0          10m   172.20.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-proxy-tbh7b                              1/1     Running   0          10m   172.20.0.3   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-scheduler-myk8s-control-plane            1/1     Running   0          10m   172.20.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    local-path-storage   local-path-provisioner-57c5987fd4-nfcv8       1/1     Running   0          10m   10.244.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    ...</span>

<span class="c"># 네임스페이스 확인 </span>
<span class="nv">$ </span>kubectl get namespaces
<span class="c"># =&gt; NAME                 STATUS   AGE</span>
<span class="c">#    default              Active   11m</span>
<span class="c">#    kube-node-lease      Active   11m</span>
<span class="c">#    kube-public          Active   11m</span>
<span class="c">#    kube-system          Active   11m</span>
<span class="c">#    local-path-storage   Active   10m</span>

<span class="c"># 디버그용 내용 출력에 ~/.kube/config 권한 인증 로드</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-v6</span>
<span class="c"># =&gt; I0907 21:08:08.698472   40997 loader.go:395] Config loaded from file:  /Users/psyche/.kube/config</span>
<span class="c">#    I0907 21:08:08.709347   40997 round_trippers.go:553] GET https://127.0.0.1:58638/api/v1/namespaces/default/pods?limit=500 200 OK in 8 milliseconds</span>
<span class="c">#    No resources found in default namespace.</span>

<span class="c"># kube config 파일 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config

<span class="c"># local-path 라는 StorageClass 가 설치, local-path 는 노드의 로컬 저장소를 활용함</span>
<span class="c"># 로컬 호스트의 path 를 지정할 필요 없이 local-path provisioner 이 볼륨을 관리</span>
<span class="nv">$ </span>kubectl get sc
<span class="c"># =&gt; NAME                 PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span>
<span class="c">#    standard (default)   rancher.io/local-path   Delete          WaitForFirstConsumer   false                  12m</span>
<span class="nv">$ </span>kubectl get deploy <span class="nt">-n</span> local-path-storage
</code></pre></div></div>

<h3 id="쿠버네티스-관련-정보-조사">쿠버네티스 관련 정보 조사</h3>

<p>이번에는 KIND 내부의 쿠버네티스 관련 정보를 살펴보겠습니다.
원활한 테스트를 위해 필요한 툴을 설치하고, KIND 내부의 쿠버네티스 관련 정보를 살펴보겠습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 툴 설치</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop git nano -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop git nano -y'</span>

<span class="c"># static pod manifest 위치 찾기</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane <span class="nb">grep </span>staticPodPath /var/lib/kubelet/config.yaml
<span class="c"># =&gt; staticPodPath: /etc/kubernetes/manifests</span>

<span class="c"># static pod 정보 확인 : kubectl 및 control plane 에서 관리되지 않고 kubelet 을 통해 지정한 컨테이너를 배포</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane tree /etc/kubernetes/manifests/
<span class="c"># =&gt; /etc/kubernetes/manifests/</span>
<span class="c">#    |-- etcd.yaml</span>
<span class="c">#    |-- kube-apiserver.yaml</span>
<span class="c">#    |-- kube-controller-manager.yaml</span>
<span class="c">#    `-- kube-scheduler.yaml</span>

<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker tree /etc/kubernetes/manifests/
<span class="c"># =&gt; /etc/kubernetes/manifests/</span>

<span class="c"># 워커 노드(컨테이너) bash 진입</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="c"># ---------------------------------</span>
<span class="nv">$ </span><span class="nb">whoami</span>
<span class="c"># =&gt; root</span>

<span class="c"># kubelet 상태 확인</span>
<span class="nv">$ </span>systemctl status kubelet
<span class="c"># =&gt; ● kubelet.service - kubelet: The Kubernetes Node Agent</span>
<span class="c">#         Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; preset: enabled)</span>
<span class="c">#        Drop-In: /etc/systemd/system/kubelet.service.d</span>
<span class="c">#                 └─10-kubeadm.conf, 11-kind.conf</span>
<span class="c">#         Active: active (running) since Sat 2024-09-07 11:56:44 UTC; 48min ago</span>
<span class="c">#           Docs: http://kubernetes.io/docs/</span>
<span class="c">#       Main PID: 236 (kubelet)</span>
<span class="c">#          Tasks: 15 (limit: 2254)</span>
<span class="c">#         Memory: 32.9M</span>
<span class="c">#            CPU: 1min 7.074s</span>
<span class="c">#         CGroup: /kubelet.slice/kubelet.service</span>
<span class="c">#                 └─236 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/conf&gt;</span>
<span class="c">#    ...</span>

<span class="c"># 컨테이너 확인</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; bash: docker: command not found</span>
<span class="nv">$ </span>crictl ps
<span class="c"># =&gt; CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD</span>
<span class="c">#    dd7ff0509e335       6a23fa8fd2b78       49 minutes ago      Running             kindnet-cni         0                   99f981aced025       kindnet-b5brb</span>
<span class="c">#    41b224e66bc3c       c573e1357a14e       49 minutes ago      Running             kube-proxy          0                   8880634c13ba5       kube-proxy-tbh7b</span>
</code></pre></div></div>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">docker ps</code>했을때는 <code class="language-plaintext highlighter-rouge">command not found</code>가 나오고 <code class="language-plaintext highlighter-rouge">crictl ps</code>로 했을때 컨테이너 정보가 나오는 것을 보면, KIND는 이름과는 다르게 Docker 대신 CRI(Container Runtime Interface)를 사용하고 있기 때문에 <code class="language-plaintext highlighter-rouge">docker</code> 명령어 대신 <code class="language-plaintext highlighter-rouge">crictl</code> 명령어를 사용해야 합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kube-proxy 확인</span>
<span class="nv">$ </span>pstree
<span class="c"># =&gt; systemd-+-containerd---15*[{containerd}]</span>
<span class="c">#            |-containerd-shim-+-kube-proxy---8*[{kube-proxy}]</span>
<span class="c">#            |                 |-pause</span>
<span class="c">#            |                 `-12*[{containerd-shim}]</span>
<span class="c">#            |-containerd-shim-+-kindnetd---11*[{kindnetd}]</span>
<span class="c">#            |                 |-pause</span>
<span class="c">#            |                 `-12*[{containerd-shim}]</span>
<span class="c">#            |-kubelet---14*[{kubelet}]</span>
<span class="c">#            `-systemd-journal</span>
<span class="nv">$ </span>pstree <span class="nt">-p</span>
<span class="c"># kube-proxy 프로세스 정보</span>
<span class="nv">$ </span>ps afxuwww |grep proxy 
<span class="c"># =&gt; root         387  0.0  1.1 1290144 24112 ?       Ssl  11:56   0:02  \_ /usr/local/bin/kube-proxy --config=/var/lib/kube-proxy/config.conf --hostname-override=myk8s-worker</span>
<span class="c"># 방화벽 설정 확인</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> security <span class="nt">-S</span>

<span class="c"># tcp listen 포트 정보 확인</span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span>

<span class="c"># 빠져나오기</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="c"># ---------------------------------</span>
</code></pre></div></div>

<h3 id="파드-생성-및-확인">파드 생성 및 확인</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 파드 생성</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: netpod
spec:
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx-pod
    image: nginx:alpine
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/netpod created</span>
<span class="c">#    pod/nginx created</span>

<span class="c"># 파드 확인</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME     READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES</span>
<span class="c">#    netpod   1/1     Running   0          52s   10.244.1.3   myk8s-worker   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    nginx    1/1     Running   0          52s   10.244.1.2   myk8s-worker   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># netpod 파드에서 nginx 웹 접속</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> netpod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="si">$(</span>kubectl get pod nginx <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.podIP<span class="o">}</span><span class="si">)</span> | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
<span class="c"># =&gt; &lt;title&gt;Welcome to nginx!&lt;/title&gt;</span>
</code></pre></div></div>

<h3 id="컨트롤-플레인-컨테이너-정보-확인">컨트롤 플레인 컨테이너 정보 확인</h3>

<p>이번에는 컨트롤 플레인 컨테이너의 정보를 확인해보겠습니다. kind는 Docker IN Docker 방식으로 컨트롤 플레인을 구성하기 때문에
컨트롤 플레인에서 정보를 확인할 때와 호스트에서 docker 정보를 확인할때와 차이가 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 도커 컨테이너 확인</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED       STATUS       PORTS                                  NAMES</span>
<span class="c">#    6228f280b992   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entr…&amp;quot;   2 hours ago   Up 2 hours   0.0.0.0:30000-30001-&amp;gt;30000-30001/tcp   myk8s-worker</span>
<span class="c">#    219113c36204   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entr…&amp;quot;   2 hours ago   Up 2 hours   127.0.0.1:58638-&amp;gt;6443/tcp              myk8s-control-plane</span>

<span class="nv">$ </span>docker inspect myk8s-control-plane | jq
...
      <span class="s2">"Entrypoint"</span>: <span class="o">[</span>
        <span class="s2">"/usr/local/bin/entrypoint"</span>,
        <span class="s2">"/sbin/init"</span>
      <span class="o">]</span>,
...

<span class="c"># 컨트롤플레인 컨테이너 bash 접속 후 확인</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nt">-------------------------------------------</span>
<span class="c"># CPU 정보 확인</span>
<span class="nv">$ </span><span class="nb">arch</span>
<span class="c"># =&gt; aarch64      # intel 호환 CPU인 경우 x86_64가 표시됩니다.</span>

<span class="c"># 기본 사용자 확인</span>
<span class="nv">$ </span><span class="nb">whoami</span>
<span class="c"># =&gt; root</span>

<span class="c"># 네트워크 정보 확인</span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8</span>
<span class="c">#    vethfbd4a037@if4 UP             10.244.0.1/32</span>
<span class="c">#    veth50a51781@if4 UP             10.244.0.1/32</span>
<span class="c">#    veth1822edcc@if4 UP             10.244.0.1/32</span>
<span class="c">#    eth0@if17        UP             172.20.0.2/16</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; 10.244.0.2 dev vethfbd4a037 scope host</span>
<span class="c">#    10.244.0.3 dev veth50a51781 scope host</span>
<span class="c">#    10.244.0.4 dev veth1822edcc scope host</span>
<span class="c">#    10.244.1.0/24 via 172.20.0.3 dev eth0</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.2</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/resolv.conf
<span class="c"># =&gt; nameserver 192.168.65.2</span>
<span class="c">#    options ndots:0</span>

<span class="c"># Entrypoint 정보 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> /usr/local/bin/entrypoint

<span class="c"># 프로세스 확인 : PID 1 은 /sbin/init</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span>
<span class="c"># =&gt; UID          PID    PPID  C STIME TTY          TIME CMD</span>
<span class="c">#    root           1       0  0 11:56 ?        00:00:01 /sbin/init</span>
<span class="c">#    ...</span>

<span class="c"># kind는 docker 안에서 docker를 운영하기 위해 OS를 흉내내기 위해 자체적으로 systemd를 사용하기 때문에</span>
<span class="c"># 위와 같이 PID 1이 /sbin/init 가 되고, systemctl 명령도 사용할 수 있습니다.</span>
 
<span class="c"># 컨테이터 런타임 정보 확인</span>
<span class="nv">$ </span>systemctl status containerd

<span class="c"># DinD 컨테이너 확인 : crictl 사용</span>
<span class="nv">$ </span>crictl version
<span class="c"># =&gt; Version:  0.1.0</span>
<span class="c">#    RuntimeName:  containerd</span>
<span class="c">#    RuntimeVersion:  v1.7.18</span>
<span class="c">#    RuntimeApiVersion:  v1</span>
<span class="nv">$ </span>crictl info
<span class="nv">$ </span>crictl ps <span class="nt">-o</span> json | jq <span class="nt">-r</span> <span class="s1">'.containers[] | {NAME: .metadata.name, POD: .labels["io.kubernetes.pod.name"]}'</span>
<span class="nv">$ </span>crictl ps
<span class="c"># =&gt; CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID              POD</span>
<span class="c">#    075e7a9f5f7a3       2437cf7621777       2 hours ago         Running             coredns                   0                   5e7c18501fc65       coredns-6f6b679f8f-9gxnw</span>
<span class="c">#    6f61738127a55       2437cf7621777       2 hours ago         Running             coredns                   0                   3b69c8d195b5d       coredns-6f6b679f8f-fk27q</span>
<span class="c">#    ...</span>

<span class="c"># 파드 이미지 확인</span>
<span class="nv">$ </span>crictl images
<span class="c"># =&gt; IMAGE                                           TAG                  IMAGE ID            SIZE</span>
<span class="c">#    docker.io/library/nginx                         alpine               9d6767b714bf1       20.2MB</span>
<span class="c">#    docker.io/nicolaka/netshoot                     latest               eead9e442471d       178MB</span>
<span class="c">#    ...</span>

<span class="c"># kubectl 확인</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-v6</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/kubernetes/admin.conf

<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">-------------------------------------------</span>

<span class="c"># 도커 컨테이너 확인 : 다시 한번 자신의 호스트PC에서 도커 컨테이너 확인, DinD 컨테이너가 호스트에서 보이는지 확인</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED       STATUS       PORTS                                  NAMES</span>
<span class="c">#    6228f280b992   kindest/node:v1.31.0   "/usr/local/bin/entr…"   2 hours ago   Up 2 hours   0.0.0.0:30000-30001-&gt;30000-30001/tcp   myk8s-worker</span>
<span class="c">#    219113c36204   kindest/node:v1.31.0   "/usr/local/bin/entr…"   2 hours ago   Up 2 hours   127.0.0.1:58638-&gt;6443/tcp              myk8s-control-plane</span>
<span class="nv">$ </span>docker port myk8s-control-plane

<span class="c"># kubectl 확인 : k8s api 호출 주소 확인</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-v6</span> 
</code></pre></div></div>

<ul>
  <li>KIND의 컨트롤 플레인에서 <code class="language-plaintext highlighter-rouge">crictl ps</code>로 컨테이너를 확인할때와 호스트에서 <code class="language-plaintext highlighter-rouge">docker ps</code>로 확인할때의 차이가 나는것을 확인할 수 있습니다.</li>
  <li>
    <p>이것은 앞에서도 docker 컨테이너 안에서 docker (정확히는 containerd)를 별도로 사용하기 때문에 발생하는 현상입니다. 이것이 DIND(Docker IN Docker)입니다.
—만약 같은 컨테이너가 나온다면 Docker OUT Docker로 동작하기 때문일것입니다—</p>
  </li>
  <li>클러스터를 삭제하겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 클러스터 삭제</span>
<span class="nv">$ </span>kind delete cluster <span class="nt">--name</span> myk8s
<span class="c"># =&gt; Deleting cluster "myk8s" ...</span>
<span class="c">#    Deleted nodes: ["myk8s-worker" "myk8s-control-plane"]</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span>
</code></pre></div></div>

<h3 id="multi-node-클러스터-with-kube-ops-view--mapping-ports">Multi-Node 클러스터 with kube-ops-view &amp; mapping ports</h3>

<p>이번에는 KIND로 Multi-Node 클러스터를 구성하고, kube-ops-view를 설치하여 클러스터 정보를 시각화하고, 포트 매핑을 통해 호스트에서 접속할 수 있도록 설정해보겠습니다.</p>

<ul>
  <li>클러스터 구성 및 노드 정보 확인</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># '컨트롤플레인, 워커 노드 1대' 클러스터 배포 : 파드에 접속하기 위한 포트 맵핑 설정</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; kind-2node.yaml
# two node (one workers) cluster config
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
  extraPortMappings:
  - containerPort: 31000
    hostPort: 31000
    listenAddress: "0.0.0.0" # Optional, defaults to "0.0.0.0"
    protocol: tcp # Optional, defaults to tcp
  - containerPort: 31001
    hostPort: 31001
</span><span class="no">EOT

</span><span class="nv">$ CLUSTERNAME</span><span class="o">=</span>myk8s
<span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-2node.yaml <span class="nt">--name</span> <span class="nv">$CLUSTERNAME</span>
<span class="c"># =&gt; Creating cluster "myk8s" ...</span>
<span class="c">#     ✓ Ensuring node image (kindest/node:v1.31.0) 🖼</span>
<span class="c">#     ✓ Preparing nodes 📦 📦</span>
<span class="c">#     ✓ Writing configuration 📜</span>
<span class="c">#     ✓ Starting control-plane 🕹️</span>
<span class="c">#     ✓ Installing CNI 🔌</span>
<span class="c">#     ✓ Installing StorageClass 💾</span>
<span class="c">#     ✓ Joining worker nodes 🚜</span>
<span class="c">#    Set kubectl context to "kind-myk8s"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-myk8s</span>
<span class="c">#    </span>
<span class="c">#    Have a nice day! 👋</span>

<span class="c"># 배포 확인</span>
<span class="nv">$ </span>kind get clusters
<span class="c"># =&gt; myk8s</span>
<span class="nv">$ </span>kind get nodes <span class="nt">--name</span> <span class="nv">$CLUSTERNAME</span>
<span class="c"># =&gt; myk8s-control-plane</span>
<span class="c">#    myk8s-worker</span>

<span class="c"># 노드 확인</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   2m12s   v1.31.0   172.20.0.2    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker          Ready    &amp;lt;none&amp;gt;          119s    v1.31.0   172.20.0.3    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>

<span class="c"># 노드에 Taints 정보 확인</span>
<span class="nv">$ </span>kubectl describe node <span class="nv">$CLUSTERNAME</span><span class="nt">-control-plane</span> | <span class="nb">grep </span>Taints
<span class="c"># =&gt; Taints:             node-role.kubernetes.io/control-plane:NoSchedule</span>

<span class="nv">$ </span>kubectl describe node <span class="nv">$CLUSTERNAME</span><span class="nt">-worker</span> | <span class="nb">grep </span>Taints
<span class="c"># =&gt; Taints:             &amp;lt;none&amp;gt;</span>

<span class="c"># control-plane 노드에는 taints가 걸려있어서 스케쥴링이 되지 않고 </span>
<span class="c"># worker 노드에는 taints가 없어서 스케쥴링이 될 것을 예상할 수 있습니다.</span>

<span class="c"># 컨테이너 확인 : 컨테이너 갯수, 컨테이너 이름 확인</span>
<span class="c"># kind yaml 에 포트 맵핑 정보 처럼, 자신의 PC 호스트에 31000 포트 접속 시, 워커노드(실제로는 컨테이너)에 TCP 31000 포트로 연결</span>
<span class="c"># 즉, 워커노드에 NodePort TCP 31000 설정 시 자신의 PC 호스트에서 접속 가능!</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS         PORTS                                  NAMES</span>
<span class="c">#    7724a7ff92bb   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entr…&amp;quot;   6 minutes ago   Up 6 minutes   127.0.0.1:58498-&amp;gt;6443/tcp              myk8s-control-plane</span>
<span class="c">#    5b7fa2f98703   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entr…&amp;quot;   6 minutes ago   Up 6 minutes   0.0.0.0:31000-31001-&amp;gt;31000-31001/tcp   myk8s-worker</span>
<span class="nv">$ </span>docker port <span class="nv">$CLUSTERNAME</span><span class="nt">-worker</span>
<span class="c"># =&gt; 31000/tcp -&amp;gt; 0.0.0.0:31000</span>
<span class="c">#    31001/tcp -&amp;gt; 0.0.0.0:31001</span>

<span class="c"># 각 노드들의 정보 확인을 docker를 통해서 확인해 볼 수도 있습니다.</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLUSTERNAME</span><span class="nt">-control-plane</span> ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLUSTERNAME</span><span class="nt">-worker</span>  ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
</code></pre></div></div>

<ul>
  <li>
    <p>이번에 KIND를 통해 만든 클러스터는 호스트에서 31000, 31001 포트로 접속시 워커노드(컨테이너)의 31000, 31001 포트로 
연결되도록 설정되는데, 그 이유는 KIND 클러스터를 생성할때 아래와 같이 포트를 열것을 지정했기 때문입니다.</p>

    <div class="language-yml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
<span class="pi">-</span> <span class="na">role</span><span class="pi">:</span> <span class="s">worker</span>
  <span class="na">extraPortMappings</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">31000</span>
    <span class="na">hostPort</span><span class="pi">:</span> <span class="m">31000</span>
    <span class="na">listenAddress</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0.0.0.0"</span> <span class="c1"># Optional, defaults to "0.0.0.0"</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">tcp</span> <span class="c1"># Optional, defaults to tcp</span>
  <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">31001</span>
    <span class="na">hostPort</span><span class="pi">:</span> <span class="m">31001</span>
<span class="nn">...</span>
</code></pre></div>    </div>
    <p>추가적인 포트 매핑이 필요한 경우 위와 같이 <code class="language-plaintext highlighter-rouge">extraPortMappings</code>에 추가하여 포트를 매핑할 수 있습니다.</p>
  </li>
  <li>
    <p>Kube-ops-view 설치 : Node port 31000</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kube-ops-view</span>
<span class="c"># helm show values geek-cookbook/kube-ops-view</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>NodePort,service.main.ports.http.nodePort<span class="o">=</span>31000 <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system

<span class="c"># 설치 확인</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep <span class="nt">-n</span> kube-system <span class="nt">-l</span> app.kubernetes.io/instance<span class="o">=</span>kube-ops-view
<span class="c"># =&gt; NAME                            READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/kube-ops-view   0/1     1            0           18s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                 READY   STATUS              RESTARTS   AGE</span>
<span class="c">#    pod/kube-ops-view-657dbc6cd8-tmkl5   0/1     ContainerCreating   0          18s</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/kube-ops-view   NodePort   10.96.212.51   &amp;lt;none&amp;gt;        8080:31000/TCP   18s</span>
<span class="c">#    </span>
<span class="c">#    NAME                      ENDPOINTS   AGE</span>
<span class="c">#    endpoints/kube-ops-view   &amp;lt;none&amp;gt;      18s</span>

<span class="c"># kube-ops-view 접속 URL 확인 (1.5 , 2 배율)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:31000/#scale=1.5"</span>
<span class="c"># =&gt; KUBE-OPS-VIEW URL = http://localhost:31000/#scale=1.5</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:31000/#scale=2"</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_5.png" alt="img.png" loading="lazy" width="997" height="475"></p>

<p>클러스터 구성시 노드의 31000포트를 호스트의 31000에 매핑시켜서 호스트에서 위와 같이 열 수 있습니다.</p>

<ul>
  <li>nginx 설치 : NodePort 31001</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 디플로이먼트와 서비스 배포</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-websrv
spec:
  replicas: 2
  selector:
    matchLabels:
      app: deploy-websrv
  template:
    metadata:
      labels:
        app: deploy-websrv
    spec:
      terminationGracePeriodSeconds: 0
      containers:
      - name: deploy-websrv
        image: nginx:alpine
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: deploy-websrv
spec:
  ports:
    - name: svc-webport
      port: 80
      targetPort: 80
      nodePort: 31001
  selector:
    app: deploy-websrv
  type: NodePort
</span><span class="no">EOF

</span><span class="c"># 확인</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                  NAMES</span>
<span class="c">#    5b7fa2f98703   kindest/node:v1.31.0   &amp;quot;/usr/local/bin/entr…&amp;quot;   15 minutes ago   Up 15 minutes   0.0.0.0:31000-31001-&amp;gt;31000-31001/tcp   myk8s-worker</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl get deploy,svc,ep deploy-websrv
<span class="c"># =&gt; ...</span>
<span class="c">#    NAME                    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/deploy-websrv   NodePort   10.96.115.233   &amp;lt;none&amp;gt;        80:31001/TCP   47s</span>
<span class="c">#    ...</span>

<span class="c"># 자신의 PC에 호스트 포트 31001 접속 시 쿠버네티스 서비스에 접속 확인</span>
<span class="nv">$ </span>open http://localhost:31001
<span class="nv">$ </span>curl <span class="nt">-s</span> localhost:31001 | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
<span class="c"># =&gt; &lt;title&gt;Welcome to nginx!&lt;/title&gt;</span>

<span class="c"># 디플로이먼트와 서비스 삭제</span>
<span class="nv">$ </span>kubectl delete deploy,svc deploy-websrv
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_6.png" alt="img.png" class="image-center" loading="lazy" width="997" height="475">
<em class="image-caption">31001 포트로 접속시 nginx 페이지가 나오는 것을 확인할 수 있습니다.</em></p>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_7.png" alt="img_1.png" loading="lazy" width="997" height="475">
<em class="image-caption">kube-ops-view에서 deploy된 정보를 확인할 수 있습니다.</em></p>

<hr>

<h2 id="파드--pause-컨테이너">파드 &amp; PAUSE 컨테이너</h2>

<p><strong>파드(pod)</strong>는 쿠버네티스에서 <strong>배포하는 최소 단위</strong>이며, 파드 내부에는 <strong>여러 컨테이너가 포함될 수</strong> 있습니다. 
파드 내부에는 PAUSE 컨테이너가 존재하며, <strong>PAUSE 컨테이너</strong>는 <strong>Network/IPC/UTS 네임스페이스</strong>를 <strong>생성</strong>하고 <strong>유지</strong>/<strong>공유</strong>하는 역할울 합니다. 
네임스페이스와 네트워크 등에 대해서는 1주차에서 학습한 내용이 많이 도움되었습니다. <a href="https://sweetlittlebird.github.io/posts/2024-08-27-KANS-Study-Week1/">1주차 링크</a></p>

<h3 id="k8s-cri-container-runtime-interface">K8S CRI (Container Runtime Interface)</h3>

<p>먼저 파드와 PAUSE 컨테이너에 대해 알아보기전에 앞선 실습에서 보았던 CRI(Container Runtime Interface)에 대해 알아보겠습니다.
쿠버네티스는 컨테이너를 관리하기 위해 <strong>CRI(Container Runtime Interface)</strong>를 사용합니다.</p>

<p>CRI의 탄생 배경은 먼저 Docker에서 부터 찾아볼 수 있습니다.
Docker가 대성공하고 컨테이너 기술이 확산되면서, 쿠버네티스도 Docker를 기본 컨테이너 런타임으로 사용했습니다.
하지만 Docker Inc라는 회사에 종속되는것을 우려하여, 표준화된 인터페이스를 만들어서 다양한 컨테이너 런타임을 지원하고자 했습니다.
그래서 CRI가 탄생하게 되었습니다. CRI라는 표준 인터페이스만 지키면 어떤 컨테이너 런타임이라도 쿠버네티스에서 사용할 수 있게 되었습니다.
이 과정에서 아쉬운건 Docker는 CRI를 지원하지 않았기 때문에, Docker를 사용하는 경우에는 Docker shim이라는 프록시를 사용해야 했었습니다.</p>

<h3 id="파드-pod">파드 (Pod)</h3>

<p>컨테이너 애플리케이션의 기본 단위를 파드(Pod)라고 부르며, 파드는 1개 이상의 컨테이너로 구성된 컨테이너의 집합입니다.</p>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_8.png" alt="img.png" loading="lazy" width="2000" height="995"></p>

<ul>
  <li>Pod는 1개 이상의 컨테이너를 가질 수 있습니다.</li>
  <li>Pod내에 실행되는 컨테이너들은 동일한 노드에 할당되며 동일한 생명 주기(Life-cycle)를 갖습니다.</li>
  <li>Pod는 노드 IP 와 별개로 클러스터 내에서 접근 가능한 IP를 할당 받으며, 다른 노드에 위치한 Pod 도 <strong>CNI를 통해</strong> NAT 없이 Pod IP로 접근 가능합니다.</li>
  <li>Pod내에 있는 컨테이너들은 서로 IP를 공유합니다. 같은 Pod내의 컨테이너끼리는 localhost 통해 서로 접근가능 합니다.
    <ul>
      <li>
<strong>pause</strong> 컨테이너가 network ns 를 만들어 주고, 내부의 컨테이너들은 해당 net ns 를 공유하기 때문에 IP를 공유하게 됩니다.</li>
    </ul>
  </li>
  <li>Pod 안의 컨테이너들은 동일한 볼륨과 연결이 가능하여 파일 시스템을 기반으로 서로 파일을 주고받을 수 있습니다.</li>
  <li>Pod는 리소스 제약이 있는 격리된 환경의 애플리케이션 컨테이너 그룹으로 구성됩니다.</li>
  <li>포드를 시작하기 전에 kubelet은 RuntimeService.RunPodSandbox를 호출하여 환경을 만듭니다.</li>
  <li>Kubelet은 RPC를 통해 컨테이너의 수명 주기를 관리하고, 컨테이너 수명 주기 후크와 활성/준비 확인을 실행하며, Pod의 재시작 정책을 준수합니다</li>
</ul>

<h3 id="pause-컨테이너">PAUSE 컨테이너</h3>

<ul>
  <li>쿠버네티스에서 <strong>pause</strong> 컨테이너는 포드의 모든 컨테이너에 대한 “<strong>부모 컨테이너</strong>” 역할을 합니다. - <a href="https://sklar.rocks/what-is-a-pod-sandbox/">Link</a>
</li>
  <li>
<strong>pause</strong> 컨테이너에는 두 가지 핵심 책임이 있습니다.
    <ol>
      <li>파드에서 Linux <strong>네임스페이스 공유의 기반</strong> 역할을 합니다. (Network, IPC, UTS 네임스페이스)</li>
      <li>PID(프로세스 ID) 네임스페이스 공유가 활성화되면 각 포드에 대한 <strong>PID 1 역할</strong>을 하며 <strong>좀비 프로세스를 거둡</strong>니다.</li>
    </ol>
  </li>
  <li>pause의 핵심 소스코드는 <a href="https://github.com/kubernetes/kubernetes/blob/master/build/pause/linux/pause.c">여기</a>에서 확인할 수 있습니다. 
매우 짧지만 중요한 코드입니다. 상세하게 코드분석한 분이 있어서 자세히 알고 싶으신 분은 다음 링크를 참고하세요.
<a href="https://mateon.tistory.com/127">한글 링크</a>
<a href="https://www.ianlewis.org/en/almighty-pause-container">영문 링크</a>
</li>
</ul>

<h4 id="pause-컨테이너-실습">Pause 컨테이너 실습</h4>

<ul>
  <li>Pause 컨테이너의 동작에 대해 실습하기 위한 환경을 구성해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># '컨트롤플레인, 워커 노드 1대' 클러스터 배포 : 파드에 접속하기 위한 포트 맵핑 설정</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; kind-2node.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
</span><span class="no">EOT
</span><span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-2node.yaml <span class="nt">--name</span> myk8s

<span class="c"># 툴 설치</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop git nano -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker        sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop -y'</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> wide
<span class="nv">$ </span>docker ps
<span class="nv">$ </span>docker port myk8s-worker
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr

<span class="c"># kube-ops-view</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>NodePort,service.main.ports.http.nodePort<span class="o">=</span>30000 <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system

<span class="c"># 설치 확인</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep <span class="nt">-n</span> kube-system <span class="nt">-l</span> app.kubernetes.io/instance<span class="o">=</span>kube-ops-view

<span class="c"># kube-ops-view 접속 URL 확인 (1.5 , 2 배율)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:30000/#scale=1.5"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:30000/#scale=2"</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_9.png" alt="img.png" loading="lazy" width="1362" height="798"></p>

<ul>
  <li>worker 노드에 진입 후 네임스페이스 격리를 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [터미널1] myk8s-worker bash 진입 후 실행 및 확인</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="nt">----------------------------------</span>
<span class="nv">$ </span>systemctl list-unit-files | <span class="nb">grep</span> <span class="s1">'enabled         enabled'</span>
<span class="c"># =&gt; containerd.service                                                                    enabled         enabled</span>
<span class="c">#    kubelet.service                                                                       enabled         enabled</span>
<span class="c">#    ...</span>

<span class="c"># 확인 : kubelet에 --container-runtime-endpoint=unix:///run/containerd/containerd.sock</span>
<span class="nv">$ </span>pstree <span class="nt">-aln</span>
<span class="c"># =&gt; systemd</span>
<span class="c">#      |-systemd-journal</span>
<span class="c">#      |-containerd</span>
<span class="c">#      |   `-15*[{containerd}]</span>
<span class="c">#      |-kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --container-runtime-endpoint=unix:///run/containerd/containerd.sock --node-ip=172.20.0.3 --node-labels= --pod-infra-container-image=registry.k8s.io/pause:3.10 --provider-id=kind://docker/myk8s/myk8s-worker --runtime-cgroups=/system.slice/containerd.service</span>
<span class="c">#      |   `-13*[{kubelet}]</span>
<span class="c">#      |-containerd-shim -namespace k8s.io -id 3368a087d8af3e241201257993e178d6a7d8ea23d3148cdf2ec5392f9db49832 -address /run/containerd/containerd.sock</span>
<span class="c">#      |   |-11*[{containerd-shim}]</span>
<span class="c">#      |   |-pause</span>
<span class="c">#      |   `-kindnetd</span>
<span class="c">#      |       `-11*[{kindnetd}]</span>
<span class="c">#      |-containerd-shim -namespace k8s.io -id e983e9fcff0162dec6128e014ae9092454fe0fd748ba237320aec17fa85fb17b -address /run/containerd/containerd.sock</span>
<span class="c">#      |   |-11*[{containerd-shim}]</span>
<span class="c">#      |   |-pause</span>
<span class="c">#      |   `-kube-proxy --config=/var/lib/kube-proxy/config.conf --hostname-override=myk8s-worker</span>
<span class="c">#      |       `-8*[{kube-proxy}]</span>
<span class="c">#      `-containerd-shim -namespace k8s.io -id 9cdabafac520e373ff0efdbbbe8b87bdfd7a0d02bd897863b609eefc4ae21b36 -address /run/containerd/containerd.sock</span>
<span class="c">#          |-12*[{containerd-shim}]</span>
<span class="c">#          |-pause</span>
<span class="c">#          `-python3 /usr/local/bin/python3 -m kube_ops_view</span>
<span class="c">#              `-2*[{python3}]</span>
          
<span class="c"># 확인 : 파드내에 pause 컨테이너와 kube_ops_view 컨테이너, 네임스페이스 정보</span>
<span class="nv">$ </span>pstree <span class="nt">-aclnpsS</span>
<span class="c"># =&gt; ...</span>
<span class="c">#      `-containerd-shim,1089 -namespace k8s.io -id 9cdabafac520e373ff0efdbbbe8b87bdfd7a0d02bd897863b609eefc4ae21b36 -address /run/containerd/contai</span>
<span class="c">#    nerd.sock</span>
<span class="c">#          |-{containerd-shim},1090</span>
<span class="c">#          ...</span>
<span class="c">#          |-pause,1110,ipc,mnt,net,pid,uts</span>
<span class="c">#          |-python3,1173,cgroup,ipc,mnt,net,pid,uts /usr/local/bin/python3 -m kube_ops_view</span>
<span class="c">#          ...</span>
<span class="c">#    ...</span>
      
<span class="c"># 네임스페이스 확인 : lsns - List system namespaces</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> 1
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="nv">$$</span>
<span class="c"># =&gt;         NS TYPE   NPROCS PID USER COMMAND</span>
<span class="c">#    4026531834 time       15   1 root /sbin/init</span>
<span class="c">#    4026531837 user       15   1 root /sbin/init</span>
<span class="c">#    4026532329 mnt         9   1 root /sbin/init</span>
<span class="c">#    4026532330 uts        13   1 root /sbin/init</span>
<span class="c">#    4026532338 ipc         9   1 root /sbin/init</span>
<span class="c">#    4026532339 pid         9   1 root /sbin/init</span>
<span class="c">#    4026532341 net        13   1 root /sbin/init</span>
<span class="c">#    4026532417 cgroup     13   1 root /sbin/init</span>

<span class="c"># 파드의 pause 컨테이너는 노드의 NS와 다른 5개의 NS를 가짐 : mnt/pid 는 pasue 자신만 사용, net/uts/ipc는 app 컨테이너를 위해서 먼저 생성해둠</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> 1797  <span class="c"># kube_ops_view 파드의 pause 컨테이너</span>
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    4026531834 time       15     1 root  /sbin/init</span>
<span class="c">#    4026531837 user       15     1 root  /sbin/init</span>
<span class="c">#    4026532417 cgroup     13     1 root  /sbin/init </span>
<span class="c">#    4026532805 net         2  1110 65535 /pause      # Node NS와 다름  </span>
<span class="c">#    4026532883 mnt         1  1110 65535 /pause      # Node NS와 다름</span>
<span class="c">#    4026532884 uts         2  1110 65535 /pause      # Node NS와 다름</span>
<span class="c">#    4026532885 ipc         2  1110 65535 /pause      # Node NS와 다름</span>
<span class="c">#    4026532886 pid         1  1110 65535 /pause      # Node NS와 다름</span>

<span class="c"># app 컨테이너(kube_ops_view)는 호스트NS와 다른 6개의 NS를 가짐 : mnt/pid/cgroup 는 자신만 사용, net/uts/ipc는 pause 컨테이너가 생성한 것을 공유 사용함</span>
<span class="nv">$ </span>pgrep <span class="nt">-f</span> kube_ops_view
<span class="c"># =&gt; 1173</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="si">$(</span>pgrep <span class="nt">-f</span> kube_ops_view<span class="si">)</span>
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    4026531834 time       15     1 root  /sbin/init</span>
<span class="c">#    4026531837 user       15     1 root  /sbin/init</span>
<span class="c">#    4026532805 net         2  1110 65535 /pause      # pause 컨테이너와 공유</span>
<span class="c">#    4026532884 uts         2  1110 65535 /pause      # pause 컨테이너와 공유</span>
<span class="c">#    4026532885 ipc         2  1110 65535 /pause      # pause 컨테이너와 공유</span>
<span class="c">#    4026532887 mnt         1  1173 1000  /usr/bin/qemu-x86_64 /usr/local/bin/python3 -m kube_ops_view  # 자신만 사용</span>
<span class="c">#    4026532888 pid         1  1173 1000  /usr/bin/qemu-x86_64 /usr/local/bin/python3 -m kube_ops_view  # 자신만 사용</span>
<span class="c">#    4026532889 cgroup      1  1173 1000  /usr/bin/qemu-x86_64 /usr/local/bin/python3 -m kube_ops_view  # 자신만 사용</span>
</code></pre></div></div>

<ul>
  <li>위와 같이 파드 내부의 pause 컨테이너와 kube_ops_view 컨테이너는 net, uts, ipc 네임스페이스를 공유하고, mnt, pid, cgroup 네임스페이스는 각각의 컨테이너가 사용하는 것을 확인할 수 있습니다.</li>
  <li>이렇게 pause 컨테이너가 파드 내부의 컨테이너들이 공유하는 네임스페이스를 생성하고 유지하는 역할을 하는것을 확인 할 수 있었습니다.</li>
  <li>마지막으로 DIND를 위한 containerd.sock 과 cgroup2fs, sys, proc 등의 정보를 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># containerd.sock 정보 확인 (docker.sock과 비슷한 역할)</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /run/containerd/containerd.sock
<span class="c"># =&gt; srw-rw---- 1 root root 0 Sep  7 15:20 /run/containerd/containerd.sock</span>

<span class="c"># 특정 소켓 파일을 사용하는 프로세스 확인</span>
<span class="nv">$ </span>lsof /run/containerd/containerd.sock
<span class="c"># =&gt; COMMAND   PID USER   FD   TYPE             DEVICE SIZE/OFF   NODE NAME</span>
<span class="c">#    container 106 root    9u  unix 0x0000000000000000      0t0 726698 /run/containerd/containerd.sock type=STREAM (LISTEN)</span>
<span class="c">#    container 106 root   11u  unix 0x0000000000000000      0t0 734691 /run/containerd/containerd.sock type=STREAM (CONNECTED)</span>
<span class="c">#    container 106 root   12u  unix 0x0000000000000000      0t0 738482 /run/containerd/containerd.sock type=STREAM (CONNECTED)</span>
<span class="c">#    container 106 root   14u  unix 0x0000000000000000      0t0 736712 /run/containerd/containerd.sock type=STREAM (CONNECTED)</span>

<span class="c"># /sys 디렉터리 확인</span>
<span class="nv">$ </span>findmnt <span class="nt">-A</span>
<span class="c"># =&gt; TARGET                                                  SOURCE                 FSTYPE    OPTIONS</span>
<span class="c">#    /                                                       overlay                overlay   rw,relatime,lowerdir=/var/lib/docker/overlay2/l/5UMBJJ</span>
<span class="c">#    ...</span>
<span class="c">#    |-/sys                                                  sysfs                  sysfs     ro,nosuid,nodev,noexec,relatime</span>
<span class="c">#    | |-/sys/kernel/tracing                                 tracefs                tracefs   rw,nosuid,nodev,noexec,relatime</span>
<span class="c">#    | |-/sys/kernel/debug                                   debugfs                debugfs   rw,nosuid,nodev,noexec,relatime</span>
<span class="c">#    | |-/sys/fs/fuse/connections                            fusectl                fusectl   rw,nosuid,nodev,noexec,relatime</span>
<span class="c">#    | |-/sys/kernel/config                                  configfs               configfs  rw,nosuid,nodev,noexec,relatime</span>
<span class="c">#    | `-/sys/fs/cgroup                                      cgroup                 cgroup2   rw,nosuid,nodev,noexec,relatime</span>
<span class="c">#    ...</span>

<span class="c"># cgroup 정보 확인</span>
<span class="nv">$ </span>findmnt <span class="nt">-t</span> cgroup2
<span class="c"># =&gt; TARGET         SOURCE FSTYPE  OPTIONS</span>
<span class="c">#    /sys/fs/cgroup cgroup cgroup2 rw,nosuid,nodev,noexec,relatime</span>
<span class="nv">$ </span><span class="nb">grep </span>cgroup /proc/filesystems
<span class="c"># =&gt; nodev	cgroup</span>
<span class="c">#    nodev	cgroup2</span>
<span class="nv">$ </span><span class="nb">stat</span> <span class="nt">-fc</span> %T /sys/fs/cgroup/
<span class="c"># =&gt; cgroup2fs</span>

<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------------</span>
</code></pre></div></div>

<ul>
  <li>신규파드를 배포하고 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [터미널2] kubectl 명령 실행 및 확인</span>

<span class="c"># Pod 생성 : YAML 파일에 컨테이너가 사용할 포트(TCP 80)을 설정</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: myweb
spec:
  containers:
  - image: nginx:alpine
    name: myweb-container
    ports:
    - containerPort: 80
      protocol: TCP
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF

</span><span class="c"># Pod 정보 확인 : pause 컨테이너 정보가 보이는지 확인</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME    READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES</span>
<span class="c">#    myweb   1/1     Running   0          15s   10.244.1.3   myk8s-worker   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="nv">$ </span>kubectl describe pod myweb | <span class="nb">grep</span> <span class="nt">-i</span> pause
<span class="nv">$ </span>kubectl get pod myweb <span class="nt">-o</span> json | <span class="nb">grep</span> <span class="nt">-i</span> pause

<span class="nt">---</span>

<span class="c"># [터미널1] myk8s-worker bash 진입 후 실행 및 확인</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="nt">----------------------------------</span>
<span class="nv">$ </span>crictl ps
<span class="nv">$ </span>pstree <span class="nt">-aln</span>
<span class="nv">$ </span>pstree <span class="nt">-aclnpsS</span> <span class="c"># 파드내에 pause 컨테이너와 app 컨테이너, 네임스페이스 정보</span>
<span class="c"># =&gt;   `-containerd-shim,1673 -namespace k8s.io -id 482ba93ecf76d46938d60e58f363e63e681d8a779439f270ff9c8417ad25a641 -address /run/containerd/containerd.sock</span>
<span class="c">#          |-{containerd-shim},1674</span>
<span class="c">#          ...</span>
<span class="c">#          |-pause,1693,ipc,mnt,net,pid,uts</span>
<span class="c">#          |-nginx,1754,cgroup,ipc,mnt,net,pid,uts</span>

<span class="c"># 네임스페이스 확인 : lsns - List system namespaces</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> 1
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="nv">$$</span>
<span class="c"># =&gt;         NS TYPE   NPROCS PID USER COMMAND</span>
<span class="c">#    4026531834 time       25   1 root /sbin/init</span>
<span class="c">#    4026531837 user       25   1 root /sbin/init</span>
<span class="c">#    4026532329 mnt        10   1 root /sbin/init</span>
<span class="c">#    4026532330 uts        14   1 root /sbin/init</span>
<span class="c">#    4026532338 ipc        10   1 root /sbin/init</span>
<span class="c">#    4026532339 pid        10   1 root /sbin/init</span>
<span class="c">#    4026532341 net        14   1 root /sbin/init</span>
<span class="c">#    4026532417 cgroup     15   1 root /sbin/init</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> 1693 
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    4026531834 time       25     1 root  /sbin/init</span>
<span class="c">#    4026531837 user       25     1 root  /sbin/init</span>
<span class="c">#    4026532417 cgroup     15     1 root  /sbin/init</span>
<span class="c">#    4026532891 net         9  1693 65535 /pause</span>
<span class="c">#    4026532969 mnt         1  1693 65535 /pause</span>
<span class="c">#    4026532970 uts         9  1693 65535 /pause</span>
<span class="c">#    4026532971 ipc         9  1693 65535 /pause</span>
<span class="c">#    4026532972 pid         1  1693 65535 /pause</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="si">$(</span>pgrep <span class="nt">-n</span> nginx<span class="si">)</span> <span class="c"># app 컨테이너(nginx)</span>
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    4026531834 time       25     1 root  /sbin/init</span>
<span class="c">#    4026531837 user       25     1 root  /sbin/init</span>
<span class="c">#    4026532891 net         9  1693 65535 /pause</span>
<span class="c">#    4026532970 uts         9  1693 65535 /pause</span>
<span class="c">#    4026532971 ipc         9  1693 65535 /pause</span>
<span class="c">#    4026532973 mnt         8  1754 root  nginx: master process nginx -g daemon off;</span>
<span class="c">#    4026532974 pid         8  1754 root  nginx: master process nginx -g daemon off;</span>
<span class="c">#    4026532975 cgroup      8  1754 root  nginx: master process nginx -g daemon off;</span>
<span class="nt">----------------------------------</span>
<span class="c"># [터미널2] kubectl 명령 실행 및 확인</span>
<span class="nv">$ </span>kubectl delete pod myweb
</code></pre></div></div>

<ul>
  <li>위와 같이 <code class="language-plaintext highlighter-rouge">kubectl</code>과 같은 high-level에서는 <code class="language-plaintext highlighter-rouge">pause</code> 컨테이너가 보이지 않지만, <code class="language-plaintext highlighter-rouge">ps</code>나 <code class="language-plaintext highlighter-rouge">lsns</code>와 같은 OS에 접근 가능한 명령으로는 
<code class="language-plaintext highlighter-rouge">pause</code> 컨테이너가 확인이 되었습니다.</li>
  <li>이는 pause 컨테이너는 공기와 같이 항상 파드에 존재하기 때문에 굳이 보여줘서 화면만 복잡하게 할 뿐 보여줄 필요가 없다 판단한것 같습니다.</li>
  <li>PAUSE Container가 ns를 공유하는 특성을 이용하여,
애플리케이션과 런타임 의존성만 포함하는 최소화된 이미지기반 컨테이너인 Distroless Container를 대상으로
Ephemeral Containers와 같은 형태로 디버깅에 활용할 수 있습니다. <a href="https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/">Link</a>
</li>
</ul>

<h2 id="cni-container-network-interface">CNI (Container Network Interface)</h2>

<ul>
  <li>쿠버네티스는 CNI(Container Network Interface)를 사용하여 네트워크를 관리합니다. 
CNI는 컨테이너 런타임과 네트워크 플러그인을 연결하는 인터페이스로 네트워크 인터페이스를 생성하고, IP 주소를 할당하며,
네트워크 정책을 적용하는 역할을 수행합니다.</li>
  <li>CNI의 주요 기능
    <ul>
      <li>
<strong>네트워크 인터페이스 생성</strong>: CNI 플러그인은 컨테이너에 네트워크 인터페이스(예: 가상 이더넷 장치)를 생성하고 컨테이너 네임스페이스에 이를 연결합니다.</li>
      <li>
<strong>IP 주소 할당</strong>: 플러그인은 네트워크 인터페이스에 IP 주소를 할당하고, 필요에 따라 IP 주소 관리를 처리합니다.</li>
      <li>
<strong>네트워크 정책 적용</strong>: 네트워크 정책을 통해 트래픽을 제어할 수 있으며, CNI 플러그인은 이를 구현하는 데 사용됩니다.</li>
      <li>
<strong>다양한 네트워크 모드 지원</strong>: 다양한 네트워크 토폴로지와 요구 사항을 지원하기 위해 여러 네트워크 모드(예: 브리지, VLAN, 오버레이 네트워크 등)를 지원합니다.</li>
    </ul>
  </li>
  <li>CNI의 작동 방식
    <ul>
      <li>CNI는 기본적으로 플러그인 기반 구조를 따릅니다. 오케스트레이션 도구는 특정 이벤트가 발생할 때 CNI 플러그인을 호출하여 필요한 네트워크 설정을 수행합니다. 각 CNI 플러그인은 JSON 형식의 구성 파일로 정의되며, 이를 통해 플러그인의 동작을 제어할 수 있습니다.</li>
    </ul>
  </li>
  <li>CNI 플러그인의 종류 : CNI 플러그인은 다양한 종류가 있으며, 각기 다른 네트워킹 요구 사항을 충족시킵니다. 대표적인 CNI 플러그인은 다음과 같습니다.
    <ul>
      <li>
<strong>Flannel</strong>: 간단하고 사용하기 쉬운 오버레이 네트워크 플러그인입니다.</li>
      <li>
<strong>Calico</strong>: 네트워크 정책과 보안을 강조하는 플러그인으로, 네트워크 격리 및 정책 적용에 강점이 있습니다.</li>
      <li>
<strong>Weave</strong>: 자동 메쉬 네트워크와 서비스 디스커버리를 제공하는 플러그인입니다.</li>
      <li>
<strong>Cilium</strong>: 고성능 BPF 기반 네트워킹 및 보안을 제공하는 플러그인입니다.</li>
      <li>
<strong>Multus</strong>: 여러 CNI 플러그인을 사용하여 컨테이너에 여러 네트워크 인터페이스를 지원하는 플러그인입니다.</li>
    </ul>
  </li>
</ul>

<h3 id="4가지-요구사항과-4가지-문제">4가지 요구사항과 4가지 문제</h3>

<p>쿠버네티스의 네트워크 모델은 4가지 요구사항을 만족해아하며 4가지 문제를 해결해야 합니다.</p>

<ul>
  <li>4가지 요구사항
    <ol>
      <li>파드와 파드 간 통신 시 NAT(Network Address Translation) 없이 통신이 가능해야 합니다.</li>
      <li>노드의 에이전트(예) kubelet, 시스템 데몬)는 Pod와 통신이 가능해야 합니다.</li>
      <li>호스트 네트워크를 사용하는 파드는 NAT 없이 파드와 통신이 가능해야 합니다.</li>
      <li>서비스 클러스터 IP 대역과 파드가 사용하는 IP 대역은 중복되지 않아야 합니다.</li>
    </ol>
  </li>
  <li>해결해야 하는 문제
    <ol>
      <li>파드 내 컨테이너는 Loopback을 통한 통신을 할 수 있도록 해야 합니다.</li>
      <li>파드 간 통신을 할 수 있어야 합니다.</li>
      <li>클러스터 내부에서 Service를 통한 통신을 할 수 있어야 합니다.</li>
      <li>클러스터 외부에서 Service를 통한 통신을 할 수 있어야 합니다.</li>
    </ol>
  </li>
</ul>

<p>위와 같은 요구사항과 문제를 해결하고 원활한 네트워크 통신을 위해 CNI(Container Network Interface)를 정의했습니다.
CNI 플러그인들은 이러한 요구사항들을 기반으로 만들어졌습니다.</p>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_10.png" alt="img.png" class="image-center" loading="lazy" width="392" height="164">
<em class="image-caption">CNI 플러그인 동작 (출처: 추가예정)</em></p>

<p>Kubelet을 통해 파드가 신규 생성될 때 네트워크 관련 설정 추가 필요합니다. 
CNI 플러그인은 전달되는 설정 정의서를 보고 실제 파드가 통신하기 위한 네트워크 설정들을 실행하게 됩니다.
또한 CNI 플러그인은 IPAM(IP Address Management), 
즉 IP 할당 관리를 수행해야 하며, 파드 간 통신을 위한 라우팅 설정을 처리해야 합니다.</p>

<h2 id="flannel">Flannel</h2>

<ul>
  <li>Flannel은 쿠버네티스의 네트워크 요구사항을 충족하는 가장 간단하고 사용하기 쉬운 오버레이 네트워크 플러그인입니다.</li>
  <li>Flannel은 가상 네트워크를 생성하여 파드 간 통신을 가능하게 하며, VXLAN, UDP, Host-GW 등의 백엔드를 지원합니다.
하지만 VXLAN 사용이 권장됩니다.</li>
  <li>VXLAN은 Virtual eXtensible Local Area Network의 약자로, 물리적인 네트워크 환경에서  논리적인 가상의 네트워크 환경을 만들어 주는 것으로, UDP 8472  포트를 통해 노드 간 터널링 기법으로 통신하는 기술입니다. </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_11.png" alt="img.png" class="image-center" loading="lazy" width="495" height="241">
<em class="image-caption">Flannel 구조 (출처: 추가예정)</em></p>

<ul>
  <li>위의 그림과 같이 파드의 eth0 네트워크 인터페이스는 호스트 네임스페이스의 veth 인터페이스와 연결되고,
veth는 cni0와 연결됩니다.</li>
  <li>이를 통해 같은 노드에서 통신시 cni0 브릿지를 통해서 통신하고, 다른 노드와 통신시 VXLAN을 통해 통신합니다.</li>
  <li>VXLAN으로 가는 과정은 cni0 브릿지를 통해 flannel.1 인터페이스로 가고, flannel.1은 호스트의 eth0을 통해 다른 노드에 전송을 합니다.
이때 <strong>flannel.1은 VTEP(Vxlan Tunnel End Point)</strong>라고 하며 패킷을 감싸서 목표 node의 IP로 전송하면, 목표 node에서 감싼 패킷을 풀어서 
해당 파드의 IP로 다시 보내는 역할을 수행합니다.</li>
  <li>각 노드마다 파드에 할당할 수 있는 IP 네트워크 대역이 있고, flannel을 통하여 ETCD나 Kubernetes API에 전달되어, 모든 노드는 해당 정보를 자신의 라우팅 테이블에 업데이트합니다.
이를 통해 각각 다른 노드의 파드끼리도 내부 IP 주소를 통해 통신이 가능하게 됩니다.</li>
</ul>

<h3 id="kind-와-flannel-설치">Kind 와 Flannel 설치</h3>

<ul>
  <li>Kind 클러스터에 Flannel을 설치해보겠습니다. kind는 기본 CNI로 kindnet을 사용하는데 실습을 위해 kindnet을 끄고 클러스터를 구축하겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">&gt; kind-cni.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  labels:
    mynode: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    controllerManager:
      extraArgs:
        bind-address: 0.0.0.0
    etcd:
      local:
        extraArgs:
          listen-metrics-urls: http://0.0.0.0:2381
    scheduler:
      extraArgs:
        bind-address: 0.0.0.0
  - |
    kind: KubeProxyConfiguration
    metricsBindAddress: 0.0.0.0
- role: worker
  labels:
    mynode: worker
- role: worker
  labels:
    mynode: worker2
networking:
  disableDefaultCNI: true
</span><span class="no">EOF
</span><span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-cni.yaml <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.30.4

<span class="c"># 배포 확인</span>
<span class="nv">$ </span>kind get clusters
<span class="nv">$ </span>kind get nodes <span class="nt">--name</span> myk8s
<span class="nv">$ </span>kubectl cluster-info

<span class="c"># 네트워크 확인</span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>

<span class="c"># 노드 확인 : CRI</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> wide

<span class="c"># 노드 라벨 확인</span>
<span class="nv">$ </span>kubectl get nodes myk8s-control-plane <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.metadata.labels<span class="o">}</span> | jq
...
<span class="s2">"mynode"</span>: <span class="s2">"control-plane"</span>,
...

<span class="nv">$ </span>kubectl get nodes myk8s-worker <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.metadata.labels<span class="o">}</span> | jq
<span class="nv">$ </span>kubectl get nodes myk8s-worker2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.metadata.labels<span class="o">}</span> | jq

<span class="c"># 컨테이너 확인 : 컨테이너 갯수, 컨테이너 이름 확인</span>
<span class="nv">$ </span>docker ps
<span class="nv">$ </span>docker port myk8s-control-plane
<span class="nv">$ </span>docker port myk8s-worker
<span class="nv">$ </span>docker port myk8s-worker2

<span class="c"># 컨테이너 내부 정보 확인</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2  ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr

<span class="c">#</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping htop git nano -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping -y'</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_12.png" alt="img.png" loading="lazy" width="1397" height="1280"></p>

<ul>
  <li>다음 명령을 통해 bridge 실행파일을 생성해서 각 인스턴스마다 배포해야합니다. 먼저 다음과 같이 bridge 파일을 생헝 후 로컬에 복사하겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nt">---------------------------------------</span>
<span class="c"># 빌드환경 구성</span>
<span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt <span class="nb">install </span>golang git <span class="nt">-y</span>
<span class="nv">$ </span>git clone https://github.com/containernetworking/plugins
<span class="nv">$ </span><span class="nb">cd </span>plugins
<span class="nv">$ </span><span class="nb">chmod</span> +x build_linux.sh

<span class="c"># 빌드</span>
<span class="nv">$ </span>./build_linux.sh

<span class="c"># 파일 권한 확인 755</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> bin
<span class="c"># =&gt; -rwxr-xr-x 1 root root  4471145 Sep  7 16:53 bridge</span>
<span class="c">#    ...</span>

<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">---------------------------------------</span>

<span class="c"># 자신의 PC에 복사 : -a 권한 보존하여 복사(755)</span>
<span class="nv">$ </span>docker <span class="nb">cp</span> <span class="nt">-a</span> myk8s-control-plane:/plugins/bin/bridge <span class="nb">.</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> bridge
<span class="c"># =&gt; .rwxr-xr-x root staff 4.3 MB Sun Sep  0 00:00:00 2024 bridge</span>
</code></pre></div></div>

<ul>
  <li>이제 Flannel을 설치하겠습니다. 현재 기본 CNI 인 kindnet 없이 설치했기 때문에 node가 not ready 상태여서 스케쥴링이 안 되고 있습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns | <span class="nb">grep </span>Events: <span class="nt">-A</span> 6
<span class="c"># =&gt; Events:</span>
<span class="c">#      Type     Reason            Age                  From               Message</span>
<span class="c">#      ----     ------            ----                 ----               -------</span>
<span class="c">#      Warning  FailedScheduling  19m                  default-scheduler  0/1 nodes are available: 1 node(s) had untolerated taint {node.kubernetes.io/not-ready: }. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling.</span>

<span class="c"># 기본 CNI 인 kindnet 없이 설치했기 때문에 node가 not ready 상태여서 스케쥴링이 안 되고 있습니다.</span>

<span class="c"># Flannel cni 설치</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
<span class="c"># =&gt; namespace/kube-flannel created</span>
<span class="c">#    clusterrole.rbac.authorization.k8s.io/flannel created</span>
<span class="c">#    clusterrolebinding.rbac.authorization.k8s.io/flannel created</span>
<span class="c">#    serviceaccount/flannel created</span>
<span class="c">#    configmap/kube-flannel-cfg created</span>
<span class="c">#    daemonset.apps/kube-flannel-ds created</span>

<span class="c"># namespace 에 pod-security.kubernetes.io/enforce=privileged Label 확인 </span>
<span class="nv">$ </span>kubectl get ns <span class="nt">--show-labels</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    kube-flannel         Active   60s   k8s-app=flannel,kubernetes.io/metadata.name=kube-flannel,pod-security.kubernetes.io/enforce=privileged</span>
<span class="nv">$ </span>kubectl get ds,pod,cm <span class="nt">-n</span> kube-flannel <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE    CONTAINERS     IMAGES                              SELECTOR</span>
<span class="c">#    daemonset.apps/kube-flannel-ds   3         3         3       3            3           &amp;lt;none&amp;gt;          100s   kube-flannel   docker.io/flannel/flannel:v0.25.6   app=flannel</span>
<span class="c">#    </span>
<span class="c">#    NAME                        READY   STATUS    RESTARTS   AGE    IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/kube-flannel-ds-2l9p6   1/1     Running   0          100s   172.20.0.2   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/kube-flannel-ds-67ftf   1/1     Running   0          100s   172.20.0.3   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/kube-flannel-ds-87wv8   1/1     Running   0          100s   172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                         DATA   AGE</span>
<span class="c">#    configmap/kube-flannel-cfg   2      100s</span>
<span class="c">#    configmap/kube-root-ca.crt   1      100s</span>

<span class="c"># kube-flannel-ds가 daemonset으로 노드마다 실행중인것을 확인할 수 있습니다.</span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-flannel kube-flannel-cfg

<span class="nv">$ </span>kubectl describe ds <span class="nt">-n</span> kube-flannel kube-flannel-ds

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> ds/kube-flannel-ds <span class="nt">-n</span> kube-flannel <span class="nt">-c</span> kube-flannel <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /etc/kube-flannel


<span class="c"># failed to find plugin "bridge" in path [/opt/cni/bin]</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns
<span class="c"># =&gt; Warning  FailedCreatePodSandBox  2m16s                   kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox "b0023dea7d730b58cfea0163318641ff1d000d368f8ad3b552c53040b371388c": plugin type="flannel" failed (add): failed to delegate add: failed to find plugin "bridge" in path [/opt/cni/bin]</span>
<span class="c">#    Warning  FailedCreatePodSandBox  2m15s                   kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox "0454cbf9ae3c434f163865f6cd261ef2fa298a2de107471600195ebffa0b44cc": plugin type="flannel" failed (add): failed to delegate add: failed to find plugin "bridge" in path [/opt/cni/bin]</span>
</code></pre></div></div>

<ul>
  <li>현재 /opt/cni/bin/bridge 파일이 없어서 오류가 발생하고 있습니다. 이를 해결하기 위해 bridge 파일을 복사하겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># bridge 파일 복사</span>
<span class="nv">$ </span>docker <span class="nb">cp </span>bridge myk8s-control-plane:/opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">cp </span>bridge myk8s-worker:/opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">cp </span>bridge myk8s-worker2:/opt/cni/bin/bridge

<span class="c"># 권한 부여</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  <span class="nb">chmod </span>755 /opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker         <span class="nb">chmod </span>755 /opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2        <span class="nb">chmod </span>755 /opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  <span class="nb">chown </span>root:root /opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker         <span class="nb">chown </span>root:root /opt/cni/bin/bridge
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2        <span class="nb">chown </span>root:root /opt/cni/bin/bridge

<span class="c"># bridge 파일이 잘 복사되었는지 확인합니다.</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  <span class="nb">ls</span> <span class="nt">-l</span> /opt/cni/bin/
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  <span class="nb">ls</span> <span class="nt">-l</span> /opt/cni/bin/
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 <span class="nb">ls</span> <span class="nt">-l</span> /opt/cni/bin/
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>myk8s-control-plane myk8s-worker myk8s-worker2<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$i</span> <span class="nb">ls</span> /opt/cni/bin/<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done
</span>bridge	flannel  host-local  loopback  portmap	ptp

<span class="c">#</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE     IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    ...</span>
<span class="c">#    kube-system          coredns-7db6d8ff4d-hjmjf                      1/1     Running   0          29m     10.244.1.4   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          coredns-7db6d8ff4d-lfmzj                      1/1     Running   0          29m     10.244.1.3   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h3 id="flannel-설치-확인">Flannel 설치 확인</h3>

<ul>
  <li>Flannel 설치 후 coredns가 정상적으로 배포되었습니다. 이제 Flannel이 정상적으로 설치되었는지 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get ds,pod,cm <span class="nt">-n</span> kube-flannel <span class="nt">-owide</span>
<span class="c"># =&gt; &lt;span style="font-weight:bold;"&gt;NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE   CONTAINERS     IMAGES                              SELECTOR&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;daemonset.apps/kube-flannel-ds&lt;/span&gt;   &lt;span style="color:teal;"&gt;3&lt;/span&gt;         &lt;span style="color:gray;"&gt;3&lt;/span&gt;         &lt;span style="color:teal;"&gt;3&lt;/span&gt;       &lt;span style="color:gray;"&gt;3&lt;/span&gt;            &lt;span style="color:teal;"&gt;3&lt;/span&gt;           &lt;span style="color:gray;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;          &lt;span style="color:teal;"&gt;13m&lt;/span&gt;   &lt;span style="color:gray;"&gt;kube-flannel&lt;/span&gt;   &lt;span style="color:teal;"&gt;docker.io/flannel/flannel:v0.25.6&lt;/span&gt;   &lt;span style="color:gray;"&gt;app=flannel&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &lt;span style="font-weight:bold;"&gt;NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE                  NOMINATED NODE   READINESS GATES&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;pod/kube-flannel-ds-2l9p6&lt;/span&gt;   &lt;span style="color:teal;"&gt;1/1&lt;/span&gt;     &lt;span style="color:green;"&gt;Running&lt;/span&gt;   &lt;span style="color:teal;"&gt;0&lt;/span&gt;          &lt;span style="color:gray;"&gt;13m&lt;/span&gt;   &lt;span style="color:teal;"&gt;172.20.0.2&lt;/span&gt;   &lt;span style="color:gray;"&gt;myk8s-worker2&lt;/span&gt;         &lt;span style="color:teal;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;           &lt;span style="color:gray;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;pod/kube-flannel-ds-67ftf&lt;/span&gt;   &lt;span style="color:teal;"&gt;1/1&lt;/span&gt;     &lt;span style="color:green;"&gt;Running&lt;/span&gt;   &lt;span style="color:teal;"&gt;0&lt;/span&gt;          &lt;span style="color:gray;"&gt;13m&lt;/span&gt;   &lt;span style="color:teal;"&gt;172.20.0.3&lt;/span&gt;   &lt;span style="color:gray;"&gt;myk8s-worker&lt;/span&gt;          &lt;span style="color:teal;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;           &lt;span style="color:gray;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;pod/kube-flannel-ds-87wv8&lt;/span&gt;   &lt;span style="color:teal;"&gt;1/1&lt;/span&gt;     &lt;span style="color:green;"&gt;Running&lt;/span&gt;   &lt;span style="color:teal;"&gt;0&lt;/span&gt;          &lt;span style="color:gray;"&gt;13m&lt;/span&gt;   &lt;span style="color:teal;"&gt;172.20.0.4&lt;/span&gt;   &lt;span style="color:gray;"&gt;myk8s-control-plane&lt;/span&gt;   &lt;span style="color:teal;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;           &lt;span style="color:gray;"&gt;&amp;lt;none&amp;gt;&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &lt;span style="font-weight:bold;"&gt;NAME                         DATA   AGE&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;configmap/kube-flannel-cfg&lt;/span&gt;   &lt;span style="color:teal;"&gt;2&lt;/span&gt;      &lt;span style="color:gray;"&gt;13m&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color:gray;"&gt;configmap/kube-root-ca.crt&lt;/span&gt;   &lt;span style="color:teal;"&gt;1&lt;/span&gt;      &lt;span style="color:gray;"&gt;13m&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-flannel kube-flannel-cfg

<span class="c"># iptables 정보 확인</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># flannel 정보 확인 : 대역, MTU</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>myk8s-control-plane myk8s-worker myk8s-worker2<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$i</span> <span class="nb">cat</span> /run/flannel/subnet.env <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
<span class="c">#    FLANNEL_NETWORK=10.244.0.0/16</span>
<span class="c">#    FLANNEL_SUBNET=10.244.0.1/24</span>
<span class="c">#    FLANNEL_MTU=1450</span>
<span class="c">#    FLANNEL_IPMASQ=true</span>
<span class="c">#    ...</span>

<span class="c"># 노드마다 할당된 dedicated subnet (podCIDR) 확인</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].spec.podCIDR}'</span> <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; 10.244.0.0/24 10.244.2.0/24 10.244.1.0/24</span>

<span class="c"># 노드 정보 중 flannel 관련 정보 확인 : VXLAN 모드 정보와, VTEP 정보(노드 IP, VtepMac) 를 확인</span>
<span class="nv">$ </span>kubectl describe node | <span class="nb">grep</span> <span class="nt">-A3</span> Annotations
<span class="c"># =&gt; Annotations:        flannel.alpha.coreos.com/backend-data: {&amp;quot;VNI&amp;quot;:1,&amp;quot;VtepMAC&amp;quot;:&amp;quot;6e:0e:72:1e:72:1d&amp;quot;}</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-type: vxlan</span>
<span class="c">#                        flannel.alpha.coreos.com/kube-subnet-manager: true</span>
<span class="c">#                        flannel.alpha.coreos.com/public-ip: 172.20.0.4</span>
<span class="c">#    --</span>
<span class="c">#    Annotations:        flannel.alpha.coreos.com/backend-data: {&amp;quot;VNI&amp;quot;:1,&amp;quot;VtepMAC&amp;quot;:&amp;quot;ca:de:a3:b8:65:d8&amp;quot;}</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-type: vxlan</span>
<span class="c">#                        flannel.alpha.coreos.com/kube-subnet-manager: true</span>
<span class="c">#                        flannel.alpha.coreos.com/public-ip: 172.20.0.3</span>
<span class="c">#    --</span>
<span class="c">#    Annotations:        flannel.alpha.coreos.com/backend-data: {&amp;quot;VNI&amp;quot;:1,&amp;quot;VtepMAC&amp;quot;:&amp;quot;1e:1e:b1:15:9e:d3&amp;quot;}</span>
<span class="c">#                        flannel.alpha.coreos.com/backend-type: vxlan</span>
<span class="c">#                        flannel.alpha.coreos.com/kube-subnet-manager: true</span>
<span class="c">#                        flannel.alpha.coreos.com/public-ip: 172.20.0.2</span>

<span class="c"># 각 노드(?) 마다 bash 진입 후 아래 기본 정보 확인 : 먼저 worker 부터 bash 진입 후 확인하자</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker        bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2       bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nt">----------------------------------------</span>
<span class="c"># 호스트 네트워크 NS와 flannel, kube-proxy 컨테이너의 네트워크 NS 비교 =&gt; 모두 동일한 NS를 가집니다. </span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> 1
<span class="c"># =&gt;         NS TYPE   NPROCS PID USER COMMAND</span>
<span class="c">#    ...</span>
<span class="c">#    4026532344 net        12   1 root /sbin/init</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="si">$(</span>pgrep flanneld<span class="si">)</span>
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    ...</span>
<span class="c">#    4026532344 net        12     1 root  /sbin/init</span>
<span class="nv">$ </span>lsns <span class="nt">-p</span> <span class="si">$(</span>pgrep kube-proxy<span class="si">)</span>
<span class="c"># =&gt;         NS TYPE   NPROCS   PID USER  COMMAND</span>
<span class="c">#    ...</span>
<span class="c">#    4026532344 net        12     1 root  /sbin/init</span>

<span class="c"># 기본 네트워크 정보 확인</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-br</span> addr
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8 ::1/128</span>
<span class="c">#    flannel.1        UNKNOWN        10.244.2.0/32</span>
<span class="c">#    eth0@if37        UP             172.20.0.3/16 fc00:f853:ccd:e793::3/64 fe80::42:acff:fe14:3/64</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'flannel|cni|veth'</span> <span class="nt">-A1</span>
<span class="c"># =&gt; 4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default</span>
<span class="c">#       link/ether ca:de:a3:b8:65:d8 brd ff:ff:ff:ff:ff:ff</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-d</span> addr show cni0     <span class="c"># 네트워크 네임스페이스 격리 파드가 1개 이상 배치 시 확인됨</span>
<span class="c"># =&gt; (공백)</span>

<span class="c"># 현재 네트워크 네임스페이스에 격리된 파드가 없어서 cni0 인터페이스가 없습니다.</span>

<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-d</span> addr show flannel.1
<span class="c"># =&gt; 4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether ca:de:a3:b8:65:d8 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 65535</span>
<span class="c">#        vxlan id 1 local 172.20.0.3 dev eth0 srcport 0 0 dstport 8472 nolearning ttl auto ageing 300 udpcsum noudp6zerocsumtx noudp6zerocsumrx numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535</span>
<span class="c">#        inet 10.244.2.0/32 scope global flannel.1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
    
<span class="nv">$ </span>brctl show
<span class="c"># =&gt; (공백)</span>

<span class="c"># 라우팅 정보 확인 : 다른 노드의 파드 대역(podCIDR)의 라우팅 정보가 업데이트되어 있음을 확인		</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.244.0.0/24 via 10.244.0.0 dev flannel.1 onlink</span>
<span class="c">#    10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.3</span>

<span class="c"># flannel.1 인터페이스를 통한 ARP 테이블 정보 확인 : 다른 노드의 flannel.1 IP와 MAC 정보를 확인</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> neigh show dev flannel.1
<span class="c"># =&gt; 10.244.1.0 lladdr 1e:1e:b1:15:9e:d3 PERMANENT</span>
<span class="c">#    10.244.0.0 lladdr 6e:0e:72:1e:72:1d PERMANENT</span>

<span class="c"># 브리지 fdb 정보에서 해당 MAC 주소와 통신 시 각 노드의 enp0s8 </span>
<span class="nv">$ </span>bridge fdb show dev flannel.1
<span class="c"># =&gt; 6e:0e:72:1e:72:1d dst 172.20.0.4 self permanent</span>
<span class="c">#    1e:1e:b1:15:9e:d3 dst 172.20.0.2 self permanent</span>

<span class="c"># 다른 노드의 flannel.1 인터페이스로 ping 통신 : VXLAN 오버레이를 통해서 통신</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 10.244.0.0
<span class="c"># =&gt; ...</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 10.244.1.0
<span class="c"># =&gt; ...</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 10.244.2.0
<span class="c"># =&gt; ...</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>

<span class="c"># 다른 노드와 VXLAN을 통해서 잘 통신 됩니다.</span>

<span class="c"># iptables 필터 테이블 정보 확인 : 파드의 10.244.0.0/16 대역 끼리는 모든 노드에서 전달이 가능</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span> | <span class="nb">grep </span>10.244.0.0
<span class="c"># =&gt; -A FLANNEL-FWD -s 10.244.0.0/16 -m comment --comment "flanneld forward" -j ACCEPT</span>
<span class="c">#    -A FLANNEL-FWD -d 10.244.0.0/16 -m comment --comment "flanneld forward" -j ACCEPT</span>

<span class="c"># iptables NAT 테이블 정보 확인 : 10.244.0.0/16 대역 끼리 통신은 마스커레이딩 없이 통신을 하며,</span>
<span class="c"># 10.244.0.0/16 대역에서 동일 대역(10.244.0.0/16)과 멀티캐스트 대역(224.0.0.0/4) 를 제외한 나머지 (외부) 통신 시에는 마스커레이딩을 수행</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'flanneld masq'</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'! -s'</span>
<span class="c"># =&gt; -A POSTROUTING -m comment --comment "flanneld masq" -j FLANNEL-POSTRTG</span>
<span class="c">#    -A FLANNEL-POSTRTG -m mark --mark 0x4000/0x4000 -m comment --comment "flanneld masq" -j RETURN</span>
<span class="c">#    -A FLANNEL-POSTRTG -s 10.244.2.0/24 -d 10.244.0.0/16 -m comment --comment "flanneld masq" -j RETURN</span>
<span class="c">#    -A FLANNEL-POSTRTG -s 10.244.0.0/16 -d 10.244.2.0/24 -m comment --comment "flanneld masq" -j RETURN</span>
<span class="c">#    -A FLANNEL-POSTRTG -s 10.244.0.0/16 ! -d 224.0.0.0/4 -m comment --comment "flanneld masq" -j MASQUERADE --random-fully</span>

<span class="nt">----------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>파드 2개를 생성해서 CNI 네트워크 브리지의 정보를  확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [터미널1,2] 워커 노드1,2 - 모니터링</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
<span class="nt">-----------------------------</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"ip link | egrep 'cni|veth' ;echo; brctl show cni0"</span>
<span class="nt">-----------------------------</span>

<span class="c"># [터미널3] cat &amp; here document 명령 조합으로 즉석(?) 리소스 생성</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: pod-1
  labels:
    app: pod
spec:
  nodeSelector:
    kubernetes.io/hostname: myk8s-worker
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-2
  labels:
    app: pod
spec:
  nodeSelector:
    kubernetes.io/hostname: myk8s-worker2
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF

</span><span class="c"># 파드 확인 : IP 확인</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_13.png" alt="img.png" loading="lazy" width="1334" height="835"></p>

<ul>
  <li>CNI 가 없었는데 파드 패포후 CNI 네트워크 브리지가 생성되는 것을 확인할 수 있습니다. 정보를 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
<span class="nt">-----------------------------</span>
<span class="c"># 브리지 정보 확인</span>
<span class="nv">$ </span>brctl show cni0

<span class="c"># 브리지 연결 링크(veth) 확인</span>
<span class="nv">$ </span>bridge <span class="nb">link</span>

<span class="c"># 브리지 VLAN 정보 확인</span>
<span class="nv">$ </span>bridge vlan

<span class="c"># cbr(custom bridge) 정보 : kubenet CNI의 bridge - 링크</span>
<span class="nv">$ </span>tree /var/lib/cni/networks/cbr0

<span class="c"># 네트워크 관련 정보들 확인</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr | <span class="nb">grep </span>veth <span class="nt">-A3</span>
<span class="nt">-----------------------------</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_14.png" alt="img.png" loading="lazy" width="1012" height="1150"></p>

<h3 id="통신-흐름-이해">통신 흐름 이해</h3>

<ul>
  <li>Flannel 기반으로 네트워크를 구축할 때는 다음과 같이 세가지의 통신 시나리오가 생길 수 있습니다.
    <ol>
      <li>동일 노드에서 파드간 통신하는 경우
  <img src="/assets/2024/kans-3th/w2/20240907_kans_w2_15.png" alt="img.png" class="image-center" loading="lazy" width="365" height="253">
</li>
      <li>파드에서 외부와 통신하는 경우
  <img src="/assets/2024/kans-3th/w2/20240907_kans_w2_16.png" alt="img_1.png" class="image-center" loading="lazy" width="344" height="305">
</li>
      <li>서로다른 노드에서 파드간 통신하는 경우
  <img src="/assets/2024/kans-3th/w2/20240907_kans_w2_17.png" alt="img_2.png" class="image-center" loading="lazy" width="1209" height="568">
</li>
    </ol>
  </li>
</ul>

<p>파드 간 통신, 서로다른 노드의 파드간 통신, 외부 통신 여부에 대해 살펴보고, 통신이 일어나는 상황의 패킷을 캡처하면서 Flannel network에 대해 이해해 보았습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> pod-1 <span class="nt">--</span> zsh
<span class="nt">-----------------------------</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr show eth0

<span class="c"># GW IP는 어떤 인터페이스인가? =&gt; cni0</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="nv">$ </span>route <span class="nt">-n</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 &lt;GW IP&gt;
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 &lt;pod-2 IP&gt;  <span class="c"># 다른 노드에 배포된 파드 통신 확인</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 8.8.8.8     <span class="c"># 외부 인터넷 IP   접속 확인</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> wttr.in/Seoul <span class="c"># 외부 인터넷 도메인 접속 확인</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> neigh
<span class="nv">$ </span><span class="nb">exit</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_18.png" alt="img.png" loading="lazy" width="887" height="1464"></p>

<ul>
  <li>서로다른 노드간 파드의 통신, 외부와의 통신 등이 모두 잘 통신 되는것을 확인할 수 있습니다.</li>
  <li>이번에는 각 노드의 cni0에서 패킷 캡쳐를 진행해 보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [터미널1,2] 워커 노드1,2</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
<span class="nt">-----------------------------</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> cni0 <span class="nt">-nn</span> icmp
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> flannel.1 <span class="nt">-nn</span> icmp
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> icmp
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> udp port 8472 <span class="nt">-w</span> /root/vxlan.pcap 
<span class="c"># CTRL+C 취소 후 확인 : ls -l /root/vxlan.pcap</span>

<span class="nv">$ </span>conntrack <span class="nt">-L</span> | <span class="nb">grep</span> <span class="nt">-i</span> icmp
<span class="nt">-----------------------------</span>

<span class="c"># [터미널3]</span>
<span class="nv">$ </span>docker <span class="nb">cp </span>myk8s-worker:/root/vxlan.pcap <span class="nb">.</span>
<span class="nv">$ </span>wireshark vxlan.pcap
</code></pre></div></div>

<ul>
  <li>Pod-1 =&gt; Pod-2 (cni0 관점)
    <ul>
      <li>브릿지를 통해 각각 오가는 패킷이 잘 보입니다.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_19.png" alt="img.png" loading="lazy" width="1481" height="625"></p>

<ul>
  <li>Pod-1 =&gt; 외부 (cni0 관점)
    <ul>
      <li>같은 노드에서는 패킷이 외부로 나갔다 오는것이 잘 보입니다.</li>
      <li>하지만 다른 노드 (worker2)에서는 외부와 오가는 패킷이 보이지 않습니다.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_20.png" alt="img.png" loading="lazy" width="1481" height="625"></p>

<ul>
  <li>Pod-1 =&gt; Pod-2 (flannel.1 관점)
    <ul>
      <li>flannel.1을 통해 각각 오가는 패킷이 잘 보입니다.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_21.png" alt="img.png" loading="lazy" width="1481" height="625"></p>

<ul>
  <li>Pod-1 -&gt; 외부 (flannel.1 관점)
    <ul>
      <li>앞선 그림에서 보았듯 외부와 통신시 VTEP인 flannel.1을 거치지 않고 cni0에서 호스트의 eth0로 바로 나가기 때문에 패킷이 캡쳐되지 않습니다.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_22.png" alt="img.png" loading="lazy" width="1481" height="625"></p>

<ul>
  <li>Pod 1 -&gt; Pod 2 (eth0 관점)
    <ul>
      <li>eth0에서 봤을때는 캡쳐가 되지 않습니다. 이유는 flannel.1을 통해 tcp 패킷이 캡슐화 되어 udp 8472로 eth0를 통해 전달되기 때문에
<code class="language-plaintext highlighter-rouge">-nn icmp</code> 옵션으로 icmp 패킷 (ping)만 캡쳐할때는 보이지 않습니다.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_23.png" alt="img.png" loading="lazy" width="1481" height="625"></p>

<ul>
  <li>Pod 1 -&gt; Pod 2 (eth0 관점, udp port 8472 덤프)
    <ul>
      <li>udp 패킷을 캡쳐하여 wireshark로 확인해보겠습니다.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_25.png" alt="img.png" loading="lazy" width="1437" height="581"></p>

<ul>
  <li>udp 8472 포트를 통해 icmp (ping)이 오가는 것을 확인할 수 있습니다. (8472는 VXLAN 포트가 아니기 때문에 옵션에서 VXLAN을 지정해야 보입니다.)</li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_26.png" alt="img_1.png" loading="lazy" width="1482" height="701"></p>

<ul>
  <li>Pod 1 -&gt; 8.8.8.8(외부) (eth0 관점)
    <ul>
      <li>eth0에서 외부와 통신하는 패킷이 같은 노드에서는 보이고, 다른 노드에서는 안 보입니다.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w2/20240907_kans_w2_24.png" alt="img.png" loading="lazy" width="1481" height="625"></p>

<hr>

<h2 id="마치며">마치며</h2>

<p>이번주에도 많은 내용들을 스터디해보았습니다. 
KIND를 알게되어서 참 좋았던것 같습니다. 
기존에 사내 교육을 위해서 kubernetes를 설치하려면 갖은 어려움이 있었는데
docker만 있으면 간단하게 설치가 가능하다는 것이 참 좋은것 같습니다.</p>

<p>막연하게 알고 있었던 노드간의 파드의 통신에 대해서 알게되었고,
쿠버네티스의 운영중 네트워크 장애에 대해 1주차 스터디와 이번 스터디를 통해
자신감이 조금 생겼습니다.
남은 스터디도 열심히해서 쿠버네티스의 네트워크에 대해 조금 아는 사람이 되어보겠습니다.</p>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2"><a href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EC%86%8C%EA%B0%9C">쿠버네티스 소개</a></li>
<li class="toc-entry toc-h2">
<a href="#kind-%EC%86%8C%EA%B0%9C-%EB%B0%8F-%EC%84%A4%EC%B9%98">kind 소개 및 설치</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%84%A4%EC%B9%98">설치</a></li>
<li class="toc-entry toc-h3"><a href="#1-node-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B5%AC%EC%84%B1-%ED%85%8C%EC%8A%A4%ED%8A%B8">1-Node 클러스터 구성 테스트</a></li>
<li class="toc-entry toc-h3"><a href="#2-node-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B5%AC%EC%84%B1-%ED%85%8C%EC%8A%A4%ED%8A%B8">2-Node 클러스터 구성 테스트</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EA%B4%80%EB%A0%A8-%EC%A0%95%EB%B3%B4-%EC%A1%B0%EC%82%AC">쿠버네티스 관련 정보 조사</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%8C%8C%EB%93%9C-%EC%83%9D%EC%84%B1-%EB%B0%8F-%ED%99%95%EC%9D%B8">파드 생성 및 확인</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%BB%A8%ED%8A%B8%EB%A1%A4-%ED%94%8C%EB%A0%88%EC%9D%B8-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EC%A0%95%EB%B3%B4-%ED%99%95%EC%9D%B8">컨트롤 플레인 컨테이너 정보 확인</a></li>
<li class="toc-entry toc-h3"><a href="#multi-node-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-with-kube-ops-view--mapping-ports">Multi-Node 클러스터 with kube-ops-view &amp; mapping ports</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#%ED%8C%8C%EB%93%9C--pause-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88">파드 &amp; PAUSE 컨테이너</a>
<ul>
<li class="toc-entry toc-h3"><a href="#k8s-cri-container-runtime-interface">K8S CRI (Container Runtime Interface)</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%8C%8C%EB%93%9C-pod">파드 (Pod)</a></li>
<li class="toc-entry toc-h3">
<a href="#pause-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88">PAUSE 컨테이너</a>
<ul>
<li class="toc-entry toc-h4"><a href="#pause-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EC%8B%A4%EC%8A%B5">Pause 컨테이너 실습</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#cni-container-network-interface">CNI (Container Network Interface)</a>
<ul>
<li class="toc-entry toc-h3"><a href="#4%EA%B0%80%EC%A7%80-%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD%EA%B3%BC-4%EA%B0%80%EC%A7%80-%EB%AC%B8%EC%A0%9C">4가지 요구사항과 4가지 문제</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#flannel">Flannel</a>
<ul>
<li class="toc-entry toc-h3"><a href="#kind-%EC%99%80-flannel-%EC%84%A4%EC%B9%98">Kind 와 Flannel 설치</a></li>
<li class="toc-entry toc-h3"><a href="#flannel-%EC%84%A4%EC%B9%98-%ED%99%95%EC%9D%B8">Flannel 설치 확인</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%86%B5%EC%8B%A0-%ED%9D%90%EB%A6%84-%EC%9D%B4%ED%95%B4">통신 흐름 이해</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2024-09-07-KANS-Study-Week2/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2024-08-27-KANS-Study-Week1/">« [KANS 3기] 컨테이너 격리</a>
  
  
  <a class="next" href="/posts/2024-09-22-KANS-Study-Week3/">[KANS 3기] K8S Calico CNI »</a>
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2024-09-07-KANS-Study-Week2/";
this.page.identifier = "/posts/KANS Study - Week2";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>

<!--      <div class="adsbygoogle-side">-->
<!--        &lt;!&ndash; ad_side &ndash;&gt;-->
<!--        <ins class="adsbygoogle "-->
<!--             style="display: block"-->
<!--             data-ad-client="ca-pub-6564723532026864"-->
<!--             data-ad-slot="1339398797"-->
<!--             data-ad-format="auto"-->
<!--             data-full-width-responsive="true"></ins>-->
<!--      </div>-->
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>공부 기록과 개발 이야기를 담은 블로그입니다.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>

<!--    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6564723532026864"-->
<!--            crossorigin="anonymous"></script>-->
<!--    <script>-->
<!--    (adsbygoogle = window.adsbygoogle || []).push({});-->
<!--    </script>-->
  </body>

</html>
