<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[KANS 3ê¸°] K8S Service : ClusterIP, NodePort | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[KANS 3ê¸°] K8S Service : ClusterIP, NodePort">
<meta property="og:locale" content="ko">
<meta name="description" content="ì§€ë‚œì£¼ì— ì´ì–´ ì´ë²ˆì£¼ì—ëŠ” Kubernetesì˜ Service, ê·¸ ì¤‘ì— ClusterIP, NodePortì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.">
<meta property="og:description" content="ì§€ë‚œì£¼ì— ì´ì–´ ì´ë²ˆì£¼ì—ëŠ” Kubernetesì˜ Service, ê·¸ ì¤‘ì— ClusterIP, NodePortì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2024-09-27-KANS-Study-Week4/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2024-09-27-KANS-Study-Week4/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-09-27T01:00:18+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[KANS 3ê¸°] K8S Service : ClusterIP, NodePort">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-09-27T01:00:18+09:00","datePublished":"2024-09-27T01:00:18+09:00","description":"ì§€ë‚œì£¼ì— ì´ì–´ ì´ë²ˆì£¼ì—ëŠ” Kubernetesì˜ Service, ê·¸ ì¤‘ì— ClusterIP, NodePortì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.","headline":"[KANS 3ê¸°] K8S Service : ClusterIP, NodePort","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2024-09-27-KANS-Study-Week4/"},"url":"https://sweetlittlebird.github.io/posts/2024-09-27-KANS-Study-Week4/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">ì†Œê°œ</a><a class="page-link" href="/posts/">ê¸€ ëª©ë¡</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[KANS 3ê¸°] K8S Service : ClusterIP, NodePort</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-09-27T01:00:18+09:00" itemprop="datePublished">2024ë…„ 09ì›” 27ì¼ì— ì‘ì„±
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>ëª©ì°¨</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">ë“¤ì–´ê°€ë©°</a></li>
<li class="toc-entry toc-h2">
<a href="#k8s-service">K8S Service</a>
<ul>
<li class="toc-entry toc-h3"><a href="#service%EC%9D%98-%ED%83%84%EC%83%9D-%EB%B0%B0%EA%B2%BD">Serviceì˜ íƒ„ìƒ ë°°ê²½</a></li>
<li class="toc-entry toc-h3">
<a href="#k8s-service-%EC%A2%85%EB%A5%98">K8S Service ì¢…ë¥˜</a>
<ul>
<li class="toc-entry toc-h4"><a href="#clusterip">ClusterIP</a></li>
<li class="toc-entry toc-h4"><a href="#nodeport">NodePort</a></li>
<li class="toc-entry toc-h4"><a href="#loadbalancer">LoadBalancer</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4%EC%9D%98-%EA%B5%AC%EC%A1%B0">ì„œë¹„ìŠ¤ì˜ êµ¬ì¡°</a></li>
<li class="toc-entry toc-h3">
<a href="#kube-proxy-%EB%AA%A8%EB%93%9C">kube-proxy ëª¨ë“œ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#userspace-proxy-%EB%AA%A8%EB%93%9C">userspace proxy ëª¨ë“œ</a></li>
<li class="toc-entry toc-h4"><a href="#iptables-proxy-%EB%AA%A8%EB%93%9C">iptables proxy ëª¨ë“œ</a></li>
<li class="toc-entry toc-h4"><a href="#ipvs-proxy-%EB%AA%A8%EB%93%9C">ipvs proxy ëª¨ë“œ</a></li>
<li class="toc-entry toc-h4"><a href="#nftables-proxy-%EB%AA%A8%EB%93%9C">nftables proxy ëª¨ë“œ</a></li>
<li class="toc-entry toc-h4"><a href="#ebpf-%EB%AA%A8%EB%93%9C--xdp">eBPF ëª¨ë“œ + XDP</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%EC%8B%A4%EC%8A%B5">ì‹¤ìŠµ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%B6%95">ì‹¤ìŠµí™˜ê²½ êµ¬ì¶•</a></li>
<li class="toc-entry toc-h4"><a href="#clusterip-%EC%8B%A4%EC%8A%B5">ClusterIP ì‹¤ìŠµ</a></li>
<li class="toc-entry toc-h4"><a href="#nodeport-%EC%8B%A4%EC%8A%B5">NodePort ì‹¤ìŠµ</a></li>
<li class="toc-entry toc-h4"><a href="#%ED%8C%8C%EB%93%9C%EA%B0%84-%EC%86%8D%EB%8F%84-%EC%B8%A1%EC%A0%95">íŒŒë“œê°„ ì†ë„ ì¸¡ì •</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">ë§ˆì¹˜ë©°</a></li>
</ul>
    </div>
    <h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì§€ë‚œì£¼ì— ì´ì–´ ì´ë²ˆì£¼ì—ëŠ” Kubernetesì˜ Service, ê·¸ ì¤‘ì— ClusterIP, NodePortì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
KANS 3ê¸° 4ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr>

<h2 id="k8s-service">K8S Service</h2>

<p>Kubernetesì˜ ServiceëŠ” ê°œë³„ Podì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ì¶”ìƒí™”ëœ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.
PodëŠ” ìƒì„±ë  ë•Œë§ˆë‹¤ IPê°€ ë™ì ìœ¼ë¡œ í• ë‹¹ë˜ê¸° ë•Œë¬¸ì— Podì˜ IPë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ì¢‹ì€ ë°©ë²•ì´ ì•„ë‹™ë‹ˆë‹¤.
ServiceëŠ” Podì˜ IPë¥¼ ì¶”ìƒí™”í•˜ì—¬ Podì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•´ì¤ë‹ˆë‹¤.</p>

<h3 id="serviceì˜-íƒ„ìƒ-ë°°ê²½">Serviceì˜ íƒ„ìƒ ë°°ê²½</h3>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_4.png" alt="img.png" loading="lazy" width="766" height="228"></p>

<p>ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ í•˜ë‚˜ì˜ íŒŒë“œì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë‹¤ë¥¸ íŒŒë“œ (ë˜ëŠ” ì™¸ë¶€)ì—ì„œ ì‚¬ìš©í• ë•Œ, í•´ë‹¹ íŒŒë“œì˜ IPë¡œ ì§€ì •ì„ í•˜ë©´, íŒŒë“œê°€ ì¬ì‹¤í–‰ ë  ë•Œ IPê°€ ë³€ê²½ë˜ì–´ ì ‘ì†ì´ ì•ˆ ë˜ì„œ ì¥ì• ê°€ ë°œìƒí•˜ëŠ” í˜„ìƒì´ ìƒê¹ë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_5.png" alt="img.png" loading="lazy" width="948" height="213"></p>

<p>ê·¸ë˜ì„œ ê³ ì •ëœ IPì˜ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ê³  ì„œë¹„ìŠ¤ì˜ IPë¡œ ì ‘ì†ì‹œ íŒŒë“œê°€ ì¬ì‹¤í–‰ë˜ì–´ë„ ì•ˆì •ì ìœ¼ë¡œ ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ í•˜ê¸°ìœ„í•´ì„œ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_6.png" alt="img.png" loading="lazy" width="741" height="241"></p>

<p>ì„œë¹„ìŠ¤ëŠ” ë˜í•œ ë¶€í•˜ë¶„ì‚°ì˜ ê¸°ëŠ¥ë„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ íŒŒë“œê°€ ì—¬ëŸ¬ê°œì¼ë•Œ ì„œë¹„ìŠ¤ IPë¡œ ì ‘ì†ì‹œ ê° íŒŒë“œë“¤ì— ë¶€í•˜ë¥¼ ë¶„ì‚°ì‹œí‚¬ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.</p>

<h3 id="k8s-service-ì¢…ë¥˜">K8S Service ì¢…ë¥˜</h3>

<h4 id="clusterip">ClusterIP</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_1.png" alt="img.png" class="w-80 image-center" loading="lazy" width="1111" height="382"></p>

<ul>
  <li>ë™ì¼í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ëŠ” ì—¬ëŸ¬ Podì— ì ‘ì†ì„ ìš©ì´í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>ClusterIPëŠ” Cluster ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©° ì™¸ë¶€ì—ì„œëŠ” ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>iptables ì˜ NAT ê¸°ëŠ¥ì„ ì´ìš©í•˜ì—¬ Podì— ì ‘ê·¼í•˜ë©°, ë™ì¼í•œ iptables ë¶„ì‚°ë£°ì„ ê° ë…¸ë“œì— ì ìš©í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="nodeport">NodePort</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_2.png" alt="img.png" class="w-80 image-center" loading="lazy" width="972" height="375"></p>

<ul>
  <li>NodePortëŠ” ClusterIPì™€ ê°™ì´ Cluster ë‚´ë¶€ì—ì„œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©°, ì™¸ë¶€ì—ì„œë„ ì ‘ê·¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>NodePortë„ ClusterIPì™€ ê°™ì´ iptablesì˜ NAT ê¸°ëŠ¥ì„ ì´ìš©í•˜ì—¬ Podì— ì ‘ê·¼í•˜ë©°, ê° ë…¸ë“œì— NodePortë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.</li>
  <li>ì™¸ë¶€ì—ì„œëŠ” NodePortë¥¼ í†µí•´ ê° ë…¸ë“œì— ì ‘ê·¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="loadbalancer">LoadBalancer</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_3.png" alt="img.png" class="w-80 image-center" loading="lazy" width="1157" height="362"></p>

<ul>
  <li>LoadBalancerë„ ì™¸ë¶€ì—ì„œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©°, í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì—ì„œ ì œê³µí•˜ëŠ” LoadBalancerë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (AWSì˜ ê²½ìš° ELB(Elastic Load Balancer)ê°€ ì‚¬ìš©ë©ë‹ˆë‹¤.)</li>
  <li>ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œë„ MetalLBì™€ ê°™ì€ LoadBalancerë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ì„œë¹„ìŠ¤ì˜-êµ¬ì¡°">ì„œë¹„ìŠ¤ì˜ êµ¬ì¡°</h3>

<p>ì„œë¹„ìŠ¤ë¥¼ ì„ ì–¸ì‹œ <code class="language-plaintext highlighter-rouge">port</code>ì™€ <code class="language-plaintext highlighter-rouge">targetPort</code>, ê·¸ë¦¬ê³  <code class="language-plaintext highlighter-rouge">label</code> <code class="language-plaintext highlighter-rouge">selector</code> ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ê°ê°ì˜ ì—­í• ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">port</code> : ì„œë¹„ìŠ¤ê°€ listen í•  í¬íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</li>
  <li>
<code class="language-plaintext highlighter-rouge">targetPort</code> : ëŒ€ìƒ íŒŒë“œì˜ portë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</li>
  <li>
<code class="language-plaintext highlighter-rouge">label selector</code>  : ëŒ€ìƒ íŒŒë“œë¥¼ íŠ¹ì •í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_7.png" alt="img.png" loading="lazy" width="824" height="221"></p>

<h3 id="kube-proxy-ëª¨ë“œ">kube-proxy ëª¨ë“œ</h3>

<ul>
  <li>kube-proxyëŠ” ì„œë¹„ìŠ¤ í†µì‹  ë™ì‘ì— ëŒ€í•œ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. ë°ëª¬ì…‹ìœ¼ë¡œ ë°°í¬ë˜ì–´ ëª¨ë“  ë…¸ë“œì— íŒŒë“œê°€ ìƒì„±ë©ë‹ˆë‹¤.</li>
  <li>kube-proxy ëª¨ë“œì˜ ì¢…ë¥˜ëŠ” userspace proxy ëª¨ë“œ, iptables proxy ëª¨ë“œ, ipvs proxy ëª¨ë“œ, nftables proxy ëª¨ë“œ ë“±ì´ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="userspace-proxy-ëª¨ë“œ">userspace proxy ëª¨ë“œ</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_8.png" alt="img.png" loading="lazy" width="941" height="271"></p>

<ul>
  <li>ê¸°ì´ˆì ì¸ ëª¨ë“œì´ë©° ì‚¬ìš©ì ì˜ì—­ì˜ kube-proxyë¥¼ í†µí•´ NIC1ìœ¼ë¡œ ë“¤ì–´ì˜¨ íŒ¨í‚·ì„ NIC2ë¡œ ì „ë‹¬í•˜ì—¬ ëª©ì  íŒŒë“œë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
  <li>ì´ë ‡ê²Œ í•˜ëŠ” ê³¼ì •ì—ì„œ ì»¤ë„ì˜ì—­(netfilter)ê³¼ ì‚¬ìš©ìì˜ì—­(kube-proxy)ë¥¼ ì˜¤ê°€ëŠ” ê³¼ì •ì—ì„œ ìŠ¤ìœ„ì¹­ì— ì˜í•œ ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí•˜ëŠ” ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="iptables-proxy-ëª¨ë“œ">iptables proxy ëª¨ë“œ</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_9.png" alt="img.png" loading="lazy" width="949" height="278"></p>

<ul>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜ì‹œ ê¸°ë³¸ ëª¨ë“œì´ë©°, kube-proxyëŠ”  íŠ¸ë˜í”½ ì „ë‹¬ì— ì§ì ‘ ê´€ì—¬í•˜ì§€ëŠ” ì•Šê³ , iptables ê·œì¹™ì„ ê´€ë¦¬í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.</li>
  <li>iptables proxy ëª¨ë“œëŠ” íŠ¸ë˜í”½ ì „ë‹¬ ê³¼ì •ì—ì„œ kube-proxyë¥¼ ê²½ìœ í•˜ì§€ ì•Šê³ , ì»¤ë„ ì˜ì—­ê³¼ ì‚¬ìš©ì ì˜ì—­ ì „í™˜ì´ í•„ìš”í•˜ì§€ ì•Šì•„ì„œ, ìœ ì €ìŠ¤í˜ì´ìŠ¤ proxy ëª¨ë“œì— ë¹„í•´ ì˜¤ë²„í—¤ë“œê°€ ì¤„ì–´ë“­ë‹ˆë‹¤.</li>
  <li>ë‹¨ì ìœ¼ë¡œëŠ” iptables ê·œì¹™ì´ ë§ì•„ ì§ˆ ê²½ìš° ëª¨ë“  ê·œì¹™ í‰ê°€ í•˜ëŠ”ë° ì§€ì—°ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ë˜í•œ ì¥ì• ì‹œ ëª¨ë“  ê·œì¹™ì„ í™•ì¸í•˜ê¸° ì–´ë ¤ì›Œ ì¥ì•  ì²˜ë¦¬ì— ë¶ˆë¦¬í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="ipvs-proxy-ëª¨ë“œ">ipvs proxy ëª¨ë“œ</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_10.png" alt="img.png" loading="lazy" width="939" height="274"></p>

<ul>
  <li>ipvs proxy ëª¨ë“œëŠ” ì§€ê¸ˆê¹Œì§€ì˜ ëª¨ë“œ ì¤‘ ê°€ì¥ íš¨ìœ¨ì ì¸ ëª¨ë“œì…ë‹ˆë‹¤. IPVS(IP Virtual Server)ëŠ” ë„·í•„í„°ì—ì„œ ë™ì‘í•˜ëŠ” Layer 4 ë¡œë“œë°¸ëŸ°ì„œì…ë‹ˆë‹¤. iptables ë³´ë‹¤ ë” ë†’ì€ ì„±ëŠ¥ ì²˜ë¦¬ë¥¼ ë³´ì—¬ì£¼ê³ , ê·œì¹™ ê°¯ìˆ˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ ë‹¤ì–‘í•œ ë¶€í•˜ë¶„ì‚° ì•Œê³ ë¦¬ì¦˜ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="nftables-proxy-ëª¨ë“œ">nftables proxy ëª¨ë“œ</h4>
<ul>
  <li>nftables ëŠ” iptablesë¥¼ ëŒ€ì²´í•˜ê¸° ìœ„í•´ ê°œë°œëœ íŒ¨í‚· í•„í„°ë§ í”„ë ˆì„ì›Œí¬ë¡œ, iptables ë³´ë‹¤ ë” ìœ ì—°í•˜ê³  ê°•ë ¥í•œ ê·œì¹™ ì„¤ì •ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>í•˜ì§€ë§Œ ì•„ì§  ì‹¤í—˜ì ìœ¼ë¡œ ê°œë°œì¤‘ì¸ ë‹¨ê³„ë¡œ ì‹¤ë¬´ì—ì„œëŠ” ipvs proxy ëª¨ë“œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="ebpf-ëª¨ë“œ--xdp">eBPF ëª¨ë“œ + XDP</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_11.png" alt="img.png" class="w-90 image-center" loading="lazy" width="1205" height="1232"></p>

<ul>
  <li>ì•ì—ì„œ ì•Œì•„ë³´ì•˜ë˜ ëª¨ë“  ëª¨ë“œë“¤ì´ netfilter ê¸°ë°˜ì¸ë° ë°˜í•´, eBPF ëª¨ë“œ +  XDP ëŠ” netfilter ì „ ë‹¨ê³„ì—ì„œ íŠ¸ë˜í”½ ë¼ìš°íŒ…ì„ ì²˜ë¦¬í•˜ì—¬ í›¨ì”¬ íš¨ìœ¨ ì ì…ë‹ˆë‹¤. calicoë‚˜ ciliumì„ ì‚¬ìš©í•˜ì—¬ì„œ eBPF ëª¨ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="ì‹¤ìŠµ">ì‹¤ìŠµ</h3>

<h4 id="ì‹¤ìŠµí™˜ê²½-êµ¬ì¶•">ì‹¤ìŠµí™˜ê²½ êµ¬ì¶•</h4>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì€ ì‹¤ìŠµí™˜ê²½ êµ¬ì¶•ì˜ ìš©ì´ì„±ì„ ìœ„í•´ì„œ kindë¥¼ ì´ìš©í•˜ì—¬ ì‹¤ìŠµí•˜ì˜€ìŠµë‹ˆë‹¤.</li>
  <li>ì‹¤ìŠµ í™˜ê²½ êµ¬ì¶•ì€ ë‹¤ìŒê³¼ ê°™ì´ ì§„í–‰ í•˜ì˜€ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kind í´ëŸ¬ìŠ¤í„° ì •ì˜ íŒŒì¼ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; kind-svc-w3.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
featureGates:
  "InPlacePodVerticalScaling": true
  "MultiCIDRServiceAllocator": true
nodes:
- role: control-plane
  labels:
    mynode: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
      extraArgs:
        runtime-config: api/all=true
- role: worker
  labels:
    mynode: worker1
- role: worker
  labels:
    mynode: worker2
- role: worker
  labels:
    mynode: worker3
networking:
  podSubnet: 10.10.0.0/16
  serviceSubnet: 10.200.1.0/24
</span><span class="no">EOT

</span><span class="c"># k8s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-svc-w3.yaml <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.31.0
<span class="c"># =&gt; Creating cluster "myk8s" ...</span>
<span class="c">#     âœ“ Ensuring node image (kindest/node:v1.31.0) ğŸ–¼</span>
<span class="c">#     âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦ ğŸ“¦</span>
<span class="c">#     âœ“ Writing configuration ğŸ“œ</span>
<span class="c">#     âœ“ Starting control-plane ğŸ•¹ï¸</span>
<span class="c">#     âœ“ Installing CNI ğŸ”Œ</span>
<span class="c">#     âœ“ Installing StorageClass ğŸ’¾</span>
<span class="c">#     âœ“ Joining worker nodes ğŸšœ</span>
<span class="c">#    Set kubectl context to "kind-myk8s"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-myk8s</span>

<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                                COMMAND                  CREATED          STATUS                 PORTS                                                            NAMES</span>
<span class="c">#    1b7e6b646e48   kindest/node:v1.31.0                 "/usr/local/bin/entrâ€¦"   18 minutes ago   Up 18 minutes                                                                           myk8s-worker</span>
<span class="c">#    5406c013a571   kindest/node:v1.31.0                 "/usr/local/bin/entrâ€¦"   18 minutes ago   Up 18 minutes          0.0.0.0:30000-30002-&gt;30000-30002/tcp, 127.0.0.1:43315-&gt;6443/tcp  myk8s-control-plane</span>
<span class="c">#    4134657c5a70   kindest/node:v1.31.0                 "/usr/local/bin/entrâ€¦"   18 minutes ago   Up 18 minutes                                                                           myk8s-worker3</span>
<span class="c">#    6caf2b177502   kindest/node:v1.31.0                 "/usr/local/bin/entrâ€¦"   18 minutes ago   Up 18 minutes                                                                           myk8s-worker2</span>

<span class="c"># ë…¸ë“œì— ê¸°ë³¸ íˆ´ ì„¤ì¹˜</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget bridge-utils net-tools ipset ipvsadm nfacct tcpdump ngrep iputils-ping arping git vim arp-scan -y'</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget bridge-utils net-tools ipset ipvsadm nfacct tcpdump ngrep iputils-ping arping -y'</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># k8s v1.31.0 ë²„ì „ í™•ì¸</span>
<span class="nv">$ </span>kubectl get node
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE   VERSION</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   40m   v1.31.0</span>
<span class="c">#    myk8s-worker          Ready    &lt;none&gt;          40m   v1.31.0</span>
<span class="c">#    myk8s-worker2         Ready    &lt;none&gt;          40m   v1.31.0</span>
<span class="c">#    myk8s-worker3         Ready    &lt;none&gt;          40m   v1.31.0</span>

<span class="c"># ë…¸ë“œ labels í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].metadata.labels}"</span> | <span class="nb">grep </span>mynode
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].metadata.labels}"</span> | jq | <span class="nb">grep </span>mynode
<span class="c"># =&gt;   "mynode": "control-plane",</span>
<span class="c">#      "mynode": "worker1"</span>
<span class="c">#      "mynode": "worker2"</span>
<span class="c">#      "mynode": "worker3"</span>

<span class="c"># kind network ì¤‘ ì»¨í…Œì´ë„ˆ(ë…¸ë“œ) IP(ëŒ€ì—­) í™•ì¸ : 172.18.0.2~ ë¶€í„° í• ë‹¹ë˜ë©°, control-plane ì´ ê¼­ 172.18.0.2ê°€ ì•ˆë  ìˆ˜ ë„ ìˆìŒ</span>
<span class="nv">$ </span>docker ps <span class="nt">-q</span> | xargs docker inspect <span class="nt">--format</span> <span class="s1">' '</span>
<span class="c"># =&gt; /myk8s-control-plane 172.23.0.2</span>
<span class="c">#    /myk8s-worker 172.23.0.4</span>
<span class="c">#    /myk8s-worker2 172.23.0.5</span>
<span class="c">#    /myk8s-worker3 172.23.0.3</span>
    
<span class="c"># íŒŒë“œCIDR ê³¼ Service ëŒ€ì—­ í™•ì¸ : CNIëŠ” kindnet ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system kubeadm-config <span class="nt">-oyaml</span> | <span class="nb">grep</span> <span class="nt">-i</span> subnet
<span class="c"># =&gt;       podSubnet: 10.10.0.0/16</span>
<span class="c">#          serviceSubnet: 10.200.1.0/24</span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt;                             "--service-cluster-ip-range=10.200.1.0/24",</span>
<span class="c">#                                "--cluster-cidr=10.10.0.0/16",</span>

<span class="c"># feature-gates í™•ì¸ : https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system | <span class="nb">grep </span>feature-gates
<span class="c"># =&gt;       --feature-gates=InPlacePodVerticalScaling=true,MultiCIDRServiceAllocator=true</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system | <span class="nb">grep </span>runtime-config
<span class="c"># =&gt;       --runtime-config=api/all=true</span>

<span class="c"># MultiCIDRServiceAllocator : https://kubernetes.io/docs/tasks/network/extend-service-ip-ranges/</span>
<span class="nv">$ </span>kubectl get servicecidr
<span class="c"># =&gt; NAME         CIDRS           AGE</span>
<span class="c">#    kubernetes   10.200.1.0/24   62m</span>

<span class="c"># ë…¸ë“œë§ˆë‹¤ í• ë‹¹ëœ dedicated subnet (podCIDR) í™•ì¸</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].spec.podCIDR}"</span>
<span class="c"># =&gt; 10.10.0.0/24 10.10.4.0/24 10.10.1.0/24 10.10.2.0/24</span>

<span class="c"># kube-proxy configmap í™•ì¸</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kube-proxy
<span class="c"># =&gt; ...</span>
<span class="c">#    iptables:</span>
<span class="c">#      localhostNodePorts: null</span>
<span class="c">#      masqueradeAll: false</span>
<span class="c">#      masqueradeBit: null</span>
<span class="c">#      minSyncPeriod: 1s</span>
<span class="c">#      syncPeriod: 0s</span>
<span class="c">#    mode: iptables</span>
<span class="c">#    ...</span>

<span class="c"># kube-proxyê°€ iptables ëª¨ë“œë¡œ ë™ì‘ì¤‘ì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>

<span class="c"># ë…¸ë“œ ë³„ ë„¤íŠ¸ì›ŒíŠ¸ ì •ë³´ í™•ì¸ : CNIëŠ” kindnet ì‚¬ìš©</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> <span class="nb">ls</span> /opt/cni/bin/<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> <span class="nb">cat</span> /etc/cni/net.d/10-kindnet.conflist<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth0<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># iptables ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker  iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>filter nat mangle raw <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; IPTables Type : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker3 iptables <span class="nt">-t</span> <span class="nv">$i</span> <span class="nt">-S</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># ê° ë…¸ë“œ bash ì ‘ì†</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker3 bash
<span class="nt">----------------------------------------</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------------------</span>

<span class="c"># kind ì„¤ì¹˜ ì‹œ kind ì´ë¦„ì˜ ë„ì»¤ ë¸Œë¦¬ì§€ê°€ ìƒì„±ë©ë‹ˆë‹¤. : 172.18.0.0/16 ëŒ€ì—­</span>
<span class="nv">$ </span>docker network <span class="nb">ls</span>
<span class="c"># =&gt; NETWORK ID     NAME                           DRIVER    SCOPE</span>
<span class="c">#    ...</span>
<span class="c">#    1c5d73657215   kind                           bridge    local</span>

<span class="nv">$ </span>docker inspect kind
<span class="c"># =&gt; [</span>
<span class="c">#        {</span>
<span class="c">#            "Name": "kind",</span>
<span class="c">#            ...</span>
<span class="c">#            "IPAM": {</span>
<span class="c">#                ...</span>
<span class="c">#                "Config": [</span>
<span class="c">#                    {</span>
<span class="c">#                        "Subnet": "172.23.0.0/16",</span>
<span class="c">#                        "Gateway": "172.23.0.1"</span>
<span class="c">#                    }</span>
<span class="c">#                ]</span>
<span class="c">#            },</span>
<span class="c">#            ...</span>
<span class="c">#            "Containers": {</span>
<span class="c">#                "1b7e6b646e4867591b5dd2a3bb4fcd2223dfcfd36dc08d86c8efc8fdc2112462": {</span>
<span class="c">#                    "Name": "myk8s-worker",</span>
<span class="c">#                    "IPv4Address": "172.23.0.4/16",</span>
<span class="c">#                },</span>
<span class="c">#                "4134657c5a7049d20944c2f80d3a3183a91a70107a47be72888e5c5fa972312a": {</span>
<span class="c">#                    "Name": "myk8s-worker3",</span>
<span class="c">#                    "IPv4Address": "172.23.0.3/16",</span>
<span class="c">#                },</span>
<span class="c">#                "5406c013a57167caf9a94ee9e89e550899a6efed9386f35548f03d2f670e8196": {</span>
<span class="c">#                    "Name": "myk8s-control-plane",</span>
<span class="c">#                    "IPv4Address": "172.23.0.2/16",</span>
<span class="c">#                },</span>
<span class="c">#                "6caf2b177502b92eccd4353ae3f4b3ac2da2949fc840225a02c9e83e1d24b09a": {</span>
<span class="c">#                    "Name": "myk8s-worker2",</span>
<span class="c">#                    "IPv4Address": "172.23.0.5/16",</span>
<span class="c">#                }</span>
<span class="c">#            },</span>
<span class="c">#            ...</span>
<span class="c">#        }</span>
<span class="c">#    ]</span>

<span class="c"># arp scan í•´ë‘ê¸°</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane arp-scan <span class="nt">--interfac</span><span class="o">=</span>eth0 <span class="nt">--localnet</span>
<span class="c"># =&gt; Interface: eth0, type: EN10MB, MAC: 02:42:ac:17:00:02, IPv4: 172.23.0.2</span>
<span class="c">#    Starting arp-scan 1.10.0 with 65536 hosts (https://github.com/royhills/arp-scan)</span>
<span class="c">#    172.23.0.1	02:42:a4:3f:b3:d9	(Unknown: locally administered)</span>
<span class="c">#    172.23.0.3	02:42:ac:17:00:03	(Unknown: locally administered)</span>
<span class="c">#    172.23.0.4	02:42:ac:17:00:04	(Unknown: locally administered)</span>
<span class="c">#    172.23.0.5	02:42:ac:17:00:05	(Unknown: locally administered)</span>

<span class="c"># mypc ì»¨í…Œì´ë„ˆ ê¸°ë™ : kind ë„ì»¤ ë¸Œë¦¬ì§€ë¥¼ ì‚¬ìš©í•˜ê³ , ì»¨í…Œì´ë„ˆ IPë¥¼ ì§ì ‘ ì§€ì •</span>
<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">--rm</span> <span class="nt">--name</span> mypc <span class="nt">--network</span> kind <span class="nt">--ip</span> 172.23.0.100 nicolaka/netshoot <span class="nb">sleep </span>infinity
<span class="nv">$ </span>docker ps
<span class="c">## ë§Œì•½ kind ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì´ ë‹¤ë¥¼ ê²½ìš° ìœ„ IP ì§€ì •ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë‹ˆ, ê·¸ëƒ¥ IP ì§€ì • ì—†ì´ mypc ì»¨í…Œì´ë„ˆ ê¸°ë™ í•  ê²ƒ</span>
<span class="c">## docker run -d --rm --name mypc --network kind nicolaka/netshoot sleep infinity</span>

<span class="c"># í†µì‹  í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ping <span class="nt">-c</span> 1 172.23.0.1
<span class="c"># =&gt; PING 172.23.0.1 (172.23.0.1) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.23.0.1: icmp_seq=1 ttl=64 time=0.154 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.23.0.1 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.154/0.154/0.154/0.000 ms</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..5<span class="o">}</span> <span class="p">;</span> <span class="k">do </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc ping <span class="nt">-c</span> 1 172.23.0.<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh
<span class="nt">-------------</span>
<span class="nv">$ </span>ifconfig
<span class="c"># =&gt; eth0      Link encap:Ethernet  HWaddr 02:42:AC:17:00:06  </span>
<span class="c">#              inet addr:172.23.0.6  Bcast:172.23.255.255  Mask:255.255.0.0</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 172.23.0.2
<span class="c"># =&gt; PING 172.23.0.2 (172.23.0.2) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.23.0.2: icmp_seq=1 ttl=64 time=0.258 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.23.0.2 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.258/0.258/0.258/0.000 ms</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">-------------</span>

<span class="c"># kube-ops-view ì„¤ì¹˜</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="c"># =&gt; "geek-cookbook" has been added to your repositories</span>
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>NodePort,service.main.ports.http.nodePort<span class="o">=</span>30000 <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system
<span class="c"># =&gt; NAME: kube-ops-view</span>
<span class="c">#    ...</span>
<span class="c">#    1. Get the application URL by running these commands:</span>
<span class="c">#      export NODE_PORT=$(kubectl get --namespace kube-system -o jsonpath="{.spec.ports[0].nodePort}" services kube-ops-view)</span>
<span class="c">#      export NODE_IP=$(kubectl get nodes --namespace kube-system -o jsonpath="{.items[0].status.addresses[0].address}")</span>
<span class="c">#      echo http://$NODE_IP:$NODE_PORT</span>

<span class="c"># myk8s-control-plane ë°°ì¹˜</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system edit deploy kube-ops-view
<span class="nt">---</span>
spec:
  ...
  template:
    ...
    spec:
      nodeSelector:
        mynode: control-plane
      tolerations:
      - key: <span class="s2">"node-role.kubernetes.io/control-plane"</span>
        operator: <span class="s2">"Equal"</span>
        effect: <span class="s2">"NoSchedule"</span>
<span class="nt">---</span>

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get pod <span class="nt">-o</span> wide <span class="nt">-l</span> app.kubernetes.io/instance<span class="o">=</span>kube-ops-view
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE   IP          NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-ops-view-58f96c464d-t5t68   1/1     Running   0          30s   10.10.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 , 2 ë°°ìœ¨) : macOS ì‚¬ìš©ì</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:30000/#scale=1.5"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://localhost:30000/#scale=2"</span>

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 , 2 ë°°ìœ¨) : Windows ì‚¬ìš©ì</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://192.168.50.10:30000/#scale=1.5"</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KUBE-OPS-VIEW URL = http://192.168.50.10:30000/#scale=2"</span>

</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_12.png" alt="img.png" loading="lazy" width="698" height="265"></p>

<h4 id="clusterip-ì‹¤ìŠµ">ClusterIP ì‹¤ìŠµ</h4>

<ul>
  <li>ì•ì—ì„œ ì•Œì•„ë³¸ ClusterIP íƒ€ì…ì— ëŒ€í•´ ì‹¤ìŠµí•´ ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ë‹¤ìŒì˜ ì‚¬í•­ë“¤ì„ ì‚´í´ë³¼ ê²ƒì…ë‹ˆë‹¤.
    <ul>
      <li>ClusterIPì˜ ì„œë¹„ìŠ¤ì˜ ê²½ìš° í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•œ íŠ¹ì„±ì´ ìˆìŠµë‹ˆë‹¤.</li>
      <li>IPë¡œë„ ì ‘ì†í•  ìˆ˜ ìˆì§€ë§Œ ë„ë©”ì¸ ëª…ìœ¼ë¡œë„ ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li>ì„œë¹„ìŠ¤ íƒ€ì…(ClusterIP)ì„ ìƒì„±í•˜ë©´ apiserver â‡’ (kubelet) â‡’ kube-proxy â‡’ iptables ì— rule ì´ ìƒì„± ë©ë‹ˆë‹¤.</li>
      <li>ëª¨ë“  ë…¸ë“œ(ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ í¬í•¨) ì— iptables ruleì´ ì„¤ì • ë˜ë¯€ë¡œ, íŒŒë“œì—ì„œ ì ‘ì† ì‹œ í•´ë‹¹ ë…¸ë“œì— ì¡´ì¬í•˜ëŠ” iptables rule ì— ì˜í•´ ë¶„ì‚° ì ‘ì†ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì‹¤ìŠµ êµ¬ì„±
    <ul>
      <li>
        <p>ëª©ì ì§€(backend) íŒŒë“œ (pod) ìƒì„± : 3pod.yml</p>

        <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c1"># 3pod.yml</span>
  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">webpod1</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">webpod</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">nodeName</span><span class="pi">:</span> <span class="s">myk8s-worker</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">container</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">traefik/whoami</span>
    <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
  <span class="s">---</span>
  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">webpod2</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">webpod</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">nodeName</span><span class="pi">:</span> <span class="s">myk8s-worker2</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">container</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">traefik/whoami</span>
    <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
  <span class="s">---</span>
  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">webpod3</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">webpod</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">nodeName</span><span class="pi">:</span> <span class="s">myk8s-worker3</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">container</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">traefik/whoami</span>
    <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>í´ë¼ì´ì–¸íŠ¸ ìƒì„± : netpod.yml</p>

        <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c1"># netpod.yml</span>
  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">net-pod</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">nodeName</span><span class="pi">:</span> <span class="s">myk8s-control-plane</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">netshoot-pod</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">nicolaka/netshoot</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">tail"</span><span class="pi">]</span>
      <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">-f"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/dev/null"</span><span class="pi">]</span>
    <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì„œë¹„ìŠ¤(ClusterIP) ìƒì„± : svc-clusterip.yml</p>

        <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c1"># svc-clusterip.yml</span>
  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">svc-clusterip</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">svc-webport</span>
        <span class="na">port</span><span class="pi">:</span> <span class="m">9000</span>        <span class="c1"># ì„œë¹„ìŠ¤ IP ì— ì ‘ì† ì‹œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ port ë¥¼ ì˜ë¯¸</span>
        <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>    <span class="c1"># íƒ€í‚· targetPort ëŠ” ì„œë¹„ìŠ¤ë¥¼ í†µí•´ì„œ ëª©ì ì§€ íŒŒë“œë¡œ ì ‘ì† ì‹œ í•´ë‹¹ íŒŒë“œë¡œ ì ‘ì†í•˜ëŠ” í¬íŠ¸ë¥¼ ì˜ë¯¸</span>
    <span class="na">selector</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">webpod</span>         <span class="c1"># ì…€ë ‰í„° ì•„ë˜ app:webpod ë ˆì´ë¸”ì´ ì„¤ì •ë˜ì–´ ìˆëŠ” íŒŒë“œë“¤ì€ í•´ë‹¹ ì„œë¹„ìŠ¤ì— ì—°ë™ë¨</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>       <span class="c1"># ì„œë¹„ìŠ¤ íƒ€ì…</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ìƒì„± ë° í™•ì¸</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># ëª¨ë‹ˆí„°ë§</span>
  <span class="nv">$ </span><span class="k">**</span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pod -owide ;echo; kubectl get svc,ep svc-clusterip'</span><span class="k">**</span>
      
  <span class="c"># ìƒì„±</span>
  <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> 3pod.yml,netpod.yml,svc-clusterip.yml
  <span class="c"># =&gt; pod/webpod1 created</span>
  <span class="c">#    pod/webpod2 created</span>
  <span class="c">#    pod/webpod3 created</span>
  <span class="c">#    pod/net-pod created</span>
  <span class="c">#    service/svc-clusterip created</span>
      
  <span class="c"># íŒŒë“œì™€ ì„œë¹„ìŠ¤ ì‚¬ìš© ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ì •ë³´ í™•ì¸ </span>
  <span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
  <span class="c"># =&gt; "--service-cluster-ip-range=10.200.1.0/24",</span>
  <span class="c">#    "--cluster-cidr=10.10.0.0/16",</span>
      
  <span class="c"># í™•ì¸</span>
  <span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
  <span class="c"># =&gt; NAME      READY   STATUS    RESTARTS   AGE    IP          NODE                  NOMINATED NODE   READINESS GATES</span>
  <span class="c">#    net-pod   1/1     Running   0          2m8s   10.10.0.7   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    webpod1   1/1     Running   0          2m8s   10.10.4.3   myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    webpod2   1/1     Running   0          2m8s   10.10.1.4   myk8s-worker2         &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    webpod3   1/1     Running   0          2m8s   10.10.2.3   myk8s-worker3         &lt;none&gt;           &lt;none&gt;</span>
  <span class="nv">$ </span>kubectl get svc svc-clusterip
  <span class="c"># =&gt; NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE</span>
  <span class="c">#    svc-clusterip   ClusterIP   10.200.1.96   &lt;none&gt;        9000/TCP   2m15s</span>
      
  <span class="c"># spec.ports.port ì™€ spec.ports.targetPort ê°€ ì–´ë–¤ ì˜ë¯¸ì¸ì§€ ê¼­ ì´í•´í•˜ì!</span>
  <span class="nv">$ </span>kubectl describe svc svc-clusterip
  <span class="c"># =&gt; Name:              svc-clusterip</span>
  <span class="c">#    Namespace:         default</span>
  <span class="c">#    Labels:            &lt;none&gt;</span>
  <span class="c">#    Annotations:       &lt;none&gt;</span>
  <span class="c">#    Selector:          app=webpod</span>
  <span class="c">#    Type:              ClusterIP</span>
  <span class="c">#    IP Family Policy:  SingleStack</span>
  <span class="c">#    IP Families:       IPv4</span>
  <span class="c">#    IP:                10.200.1.96</span>
  <span class="c">#    IPs:               10.200.1.96</span>
  <span class="c">#    Port:              svc-webport  9000/TCP                    # serviceì˜ listening port</span>
  <span class="c">#    TargetPort:        80/TCP                                   # podì˜ ì‹¤ì œ port</span>
  <span class="c">#    Endpoints:         10.10.1.4:80,10.10.2.3:80,10.10.4.3:80   # podì˜ ip:port ëª©ë¡</span>
  <span class="c">#    Session Affinity:  None</span>
  <span class="c">#    Events:            &lt;none&gt;</span>
      
  <span class="c"># ì„œë¹„ìŠ¤ ìƒì„± ì‹œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±, ë¬¼ë¡  ìˆ˜ë™ìœ¼ë¡œ ì„¤ì • ìƒì„±ë„ ê°€ëŠ¥</span>
  <span class="nv">$ </span>kubectl get endpoints svc-clusterip
  <span class="c"># =&gt; NAME            ENDPOINTS                                AGE</span>
  <span class="c">#    svc-clusterip   10.10.1.4:80,10.10.2.3:80,10.10.4.3:80   3m32s</span>
  <span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> kubernetes.io/service-name<span class="o">=</span>svc-clusterip
  <span class="c"># =&gt; NAME                  ADDRESSTYPE   PORTS   ENDPOINTS                       AGE</span>
  <span class="c">#    svc-clusterip-xxvws   IPv4          80      10.10.4.3,10.10.1.4,10.10.2.3   3m39s</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_13.png" alt="img.png" loading="lazy" width="799" height="270"></p>

<ul>
  <li>ì„œë¹„ìŠ¤ (ClusterIP) ì ‘ì† í™•ì¸
    <ul>
      <li>
        <p>í´ë¼ì´ì–¸íŠ¸ (TestPod)ì˜ Shell ì— ì ‘ì†í•˜ì—¬ ì„œë¹„ìŠ¤(ClusterIP) ë¶€í•˜ë¶„ì‚° ì ‘ì† í™•ì¸</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># webpod íŒŒë“œì˜ IP ë¥¼ ì¶œë ¥</span>
  <span class="nv">$ </span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].status.podIP}"</span>
  <span class="c"># =&gt; 10.10.4.3 10.10.1.4 10.10.2.3</span>
      
  <span class="c"># webpod íŒŒë“œì˜ IPë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
  <span class="nv">$ WEBPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get pod webpod1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.podIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ WEBPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get pod webpod2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.podIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ WEBPOD3</span><span class="o">=</span><span class="si">$(</span>kubectl get pod webpod3 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.podIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD1</span> <span class="nv">$WEBPOD2</span> <span class="nv">$WEBPOD3</span>
  <span class="c"># =&gt; 10.10.4.3 10.10.1.4 10.10.2.3</span>
      
  <span class="c"># net-pod íŒŒë“œì—ì„œ webpod íŒŒë“œì˜ IPë¡œ ì§ì ‘ curl ë¡œ ë°˜ë³µ ì ‘ì†</span>
  <span class="nv">$ </span><span class="k">for </span>pod <span class="k">in</span> <span class="nv">$WEBPOD1</span> <span class="nv">$WEBPOD2</span> <span class="nv">$WEBPOD3</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$pod</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; Hostname: webpod1</span>
  <span class="c">#    IP: 10.10.4.3</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:56374</span>
  <span class="c">#    GET / HTTP/1.1</span>
  <span class="c">#    Host: 10.10.4.3</span>
  <span class="c">#    User-Agent: curl/8.7.1</span>
  <span class="c">#    Accept: */*</span>
  <span class="c">#    </span>
  <span class="c">#    Hostname: webpod2</span>
  <span class="c">#    ...</span>
  <span class="c">#    Hostname: webpod3</span>
  <span class="c">#    ...</span>
  <span class="nv">$ </span><span class="k">for </span>pod <span class="k">in</span> <span class="nv">$WEBPOD1</span> <span class="nv">$WEBPOD2</span> <span class="nv">$WEBPOD3</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$pod</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; Hostname: webpod1</span>
  <span class="c">#    Hostname: webpod2</span>
  <span class="c">#    Hostname: webpod3</span>
  <span class="nv">$ </span><span class="k">for </span>pod <span class="k">in</span> <span class="nv">$WEBPOD1</span> <span class="nv">$WEBPOD2</span> <span class="nv">$WEBPOD3</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$pod</span> | <span class="nb">grep </span>Host<span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; Hostname: webpod1</span>
  <span class="c">#    Host: 10.10.4.3</span>
  <span class="c">#    Hostname: webpod2</span>
  <span class="c">#    Host: 10.10.1.4</span>
  <span class="c">#    Hostname: webpod3</span>
  <span class="c">#    Host: 10.10.2.3</span>
  <span class="nv">$ </span><span class="k">for </span>pod <span class="k">in</span> <span class="nv">$WEBPOD1</span> <span class="nv">$WEBPOD2</span> <span class="nv">$WEBPOD3</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$pod</span> | egrep <span class="s1">'Host|RemoteAddr'</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; Hostname: webpod1</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:36382</span>
  <span class="c">#    Host: 10.10.4.3</span>
  <span class="c">#    Hostname: webpod2</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:52122</span>
  <span class="c">#    Host: 10.10.1.4</span>
  <span class="c">#    Hostname: webpod3</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:55962</span>
  <span class="c">#    Host: 10.10.2.3</span>
      
  <span class="c"># ì„œë¹„ìŠ¤ IP ë³€ìˆ˜ ì§€ì • : svc-clusterip ì˜ ClusterIPì£¼ì†Œ</span>
  <span class="nv">$ SVC1</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$SVC1</span>
  <span class="c"># =&gt; 10.200.1.96</span>
      
  <span class="c"># ìœ„ ì„œë¹„ìŠ¤ ìƒì„± ì‹œ kube-proxy ì— ì˜í•´ì„œ iptables ê·œì¹™ì´ ëª¨ë“  ë…¸ë“œì— ì¶”ê°€ë¨ </span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nv">$SVC1</span>
  <span class="c"># =&gt; -A KUBE-SERVICES -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF</span>
  <span class="c">#    -A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ</span>
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nv">$SVC1</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
  <span class="c">#    -A KUBE-SERVICES -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF</span>
  <span class="c">#    -A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
  <span class="c">#    -A KUBE-SERVICES -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF</span>
  <span class="c">#    -A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
  <span class="c">#    -A KUBE-SERVICES -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF</span>
  <span class="c">#    -A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
  <span class="c">#    -A KUBE-SERVICES -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF</span>
  <span class="c">#    -A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.96/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ</span>
      
  <span class="c">## (ì°¸ê³ ) ss íˆ´ë¡œ tcp listen ì •ë³´ì—ëŠ” ì—†ìŒ , ë³„ë„ /32 host ë¼ìš°íŒ… ì¶”ê°€ ì—†ìŒ -&gt; ì¦‰, iptables rule ì— ì˜í•´ì„œ ì²˜ë¦¬ë¨ì„ í™•ì¸</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ss <span class="nt">-tnlp</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ip <span class="nt">-c</span> route
      
  <span class="c"># TCP 80,9000 í¬íŠ¸ë³„ ì ‘ì† í™•ì¸ : ì¶œë ¥ ì •ë³´ ì˜ë¯¸ í™•ì¸</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$SVC1</span>:80
  <span class="c"># =&gt; (ê³µë°±)</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$SVC1</span>:9000
  <span class="c"># =&gt; Hostname: webpod2</span>
  <span class="c">#    ...</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$SVC1</span>:9000 | <span class="nb">grep </span>Hostname
  <span class="c"># =&gt; Hostname: webpod3</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$SVC1</span>:9000 | <span class="nb">grep </span>Hostname
  <span class="c"># =&gt; Hostname: webpod1 </span>
      
  <span class="c"># curlë¡œ ì ‘ì†í–ˆì„ë•Œ ì»¨í…Œì´ë„ˆì˜ í¬íŠ¸ì¸ targetPort 80ìœ¼ë¡œëŠ” ì ‘ì†ì´ ì•ˆ ë˜ê³  port 9000ë¡œëŠ” ì ‘ì†ì´ ë©ë‹ˆë‹¤.</span>
  <span class="c"># ë˜í•œ ì ‘ì†ì‹œë§ˆë‹¤ ê° podì— ë¶€í•˜ê°€ ë¶„ì‚°ë˜ì–´ HostName: ì´ ë³€ê²½ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
      
  <span class="c"># ì„œë¹„ìŠ¤(ClusterIP) ë¶€í•˜ë¶„ì‚° ì ‘ì† í™•ì¸</span>
  <span class="c">## for ë¬¸ì„ ì´ìš©í•˜ì—¬ SVC1 IP ë¡œ 100ë²ˆ ì ‘ì†ì„ ì‹œë„ í›„ ì¶œë ¥ë˜ëŠ” ë‚´ìš© ì¤‘ ë°˜ë³µë˜ëŠ” ë‚´ìš©ì˜ ê°¯ìˆ˜ ì¶œë ¥</span>
  <span class="c">## ë°˜ë³µí•´ì„œ ì‹¤í–‰ì„ í•´ë³´ë©´, SVC1 IPë¡œ curl ì ‘ì† ì‹œ 3ê°œì˜ íŒŒë“œë¡œ ëŒ€ëµ 33% ì •ë„ë¡œ ë¶€í•˜ë¶„ì‚° ì ‘ì†ë¨ì„ í™•ì¸</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..10};   do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;       4 Hostname: webpod3</span>
  <span class="c">#          4 Hostname: webpod2</span>
  <span class="c">#          2 Hostname: webpod1</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};  do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;      38 Hostname: webpod3</span>
  <span class="c">#         35 Hostname: webpod1</span>
  <span class="c">#         27 Hostname: webpod2</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..1000}; do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     346 Hostname: webpod2</span>
  <span class="c">#        336 Hostname: webpod1</span>
  <span class="c">#        318 Hostname: webpod3</span>
  <span class="c"># í˜¹ì€</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};   do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; sleep 1; done"</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};   do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; sleep 0.1; done"</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..10000}; do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; sleep 0.01; done"</span>
      
  <span class="c"># conntrack í™•ì¸</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
  <span class="nt">----------------------------------------</span>
  <span class="nv">$ </span>conntrack <span class="nt">-h</span>
  <span class="nv">$ </span>conntrack <span class="nt">-E</span>
  <span class="c"># =&gt;     [NEW] tcp      6 120 SYN_SENT src=172.23.0.2 dst=172.23.0.2 sport=45466 dport=6443 [UNREPLIED] src=172.23.0.2 dst=172.23.0.2 sport=6443 dport=45466</span>
  <span class="c">#     [UPDATE] tcp      6 60 SYN_RECV src=172.23.0.2 dst=172.23.0.2 sport=45466 dport=6443 src=172.23.0.2 dst=172.23.0.2 sport=6443 dport=45466</span>
  <span class="nv">$ </span>conntrack <span class="nt">-C</span>
  <span class="c"># =&gt; 2763</span>
  <span class="nv">$ </span>conntrack <span class="nt">-S</span>
  <span class="c"># =&gt; cpu=0           found=0 invalid=0 insert=0 insert_failed=0 drop=0 early_drop=0 error=0 search_restart=3 clash_resolve=0 chaintoolong=0</span>
  <span class="c">#    cpu=1           found=0 invalid=0 insert=0 insert_failed=0 drop=0 early_drop=0 error=0 search_restart=0 clash_resolve=0 chaintoolong=0</span>
  <span class="nv">$ </span>conntrack <span class="nt">-L</span> <span class="nt">--src</span> 10.200.0.7 <span class="c"># net-pod IP</span>
  <span class="c"># =&gt; tcp      6 93 TIME_WAIT src=10.10.0.7 dst=10.200.1.96 sport=37008 dport=9000 src=10.10.2.3 dst=10.10.0.7 sport=80 dport=37008 [ASSURED] mark=0 use=1</span>
  <span class="c">#    tcp      6 93 TIME_WAIT src=10.10.0.7 dst=10.200.1.96 sport=36584 dport=9000 src=10.10.2.3 dst=10.10.0.7 sport=80 dport=36584 [ASSURED] mark=0 use=1</span>
  <span class="nv">$ SVC1</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ </span>conntrack <span class="nt">-L</span> <span class="nt">--dst</span> <span class="nv">$SVC1</span>     <span class="c"># service ClusterIP</span>
  <span class="c"># =&gt; tcp      6 31 TIME_WAIT src=10.10.0.7 dst=10.200.1.96 sport=37008 dport=9000 src=10.10.2.3 dst=10.10.0.7 sport=80 dport=37008 [ASSURED] mark=0 use=1</span>
  <span class="c">#    tcp      6 31 TIME_WAIT src=10.10.0.7 dst=10.200.1.96 sport=36584 dport=9000 src=10.10.2.3 dst=10.10.0.7 sport=80 dport=36584 [ASSURED] mark=0 use=1</span>
  <span class="nv">$ </span><span class="nb">exit</span>
  <span class="nt">----------------------------------------</span>
      
  <span class="c"># (ì°¸ê³ ) Link layer ì—ì„œ ë™ì‘í•˜ëŠ” ebtables</span>
  <span class="nv">$ </span>ebtables <span class="nt">-L</span>
  <span class="c"># =&gt; Bridge table: filter</span>
  <span class="c">#    Bridge chain: INPUT, entries: 0, policy: ACCEPT</span>
  <span class="c">#    Bridge chain: FORWARD, entries: 0, policy: ACCEPT</span>
  <span class="c">#    Bridge chain: OUTPUT, entries: 0, policy: ACCEPT</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ê° ì›Œì»¤ ë…¸ë“œì—ì„œ íŒ¨í‚·  ë¤í”„ í™•ì¸</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># ë°©ì•ˆ1 : 1ëŒ€ í˜¹ì€ 3ëŒ€ bash ì§„ì… í›„ tcpdump í•´ë‘˜ ê²ƒ</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker2 bash
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker3 bash
  <span class="nt">----------------------------------</span>
  <span class="c"># nic ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span>
  <span class="c"># =&gt; &lt;&lt;myk8s-worker&gt;&gt;</span>
  <span class="c">#    3: veth9a888981@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether 26:a5:d2:44:f4:b4 brd ff:ff:ff:ff:ff:ff link-netns cni-0b7e59c3-3920-ce1f-874a-9e228adf3b72</span>
  <span class="c">#    134: eth0@if135: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:04 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
  <span class="c">#    </span>
  <span class="c">#    &lt;&lt;myk8s-worker2&gt;&gt;</span>
  <span class="c">#    4: veth570fce87@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether a6:8a:d8:a3:f4:ac brd ff:ff:ff:ff:ff:ff link-netns cni-8dcb2d16-f339-2571-03d2-d6b0f850878d</span>
  <span class="c">#    136: eth0@if137: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:05 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
  <span class="c">#    </span>
  <span class="c">#    &lt;&lt;myk8s-worker3&gt;&gt;</span>
  <span class="c">#    3: veth2e19df47@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether da:5e:a5:14:62:7b brd ff:ff:ff:ff:ff:ff link-netns cni-1f44bebd-9ebf-6af4-7888-945649a2b5c8</span>
  <span class="c">#    132: eth0@if133: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
      
  <span class="nv">$ </span>ip <span class="nt">-c</span> route
  <span class="c"># =&gt; &lt;&lt;myk8s-worker&gt;&gt;</span>
  <span class="c">#    default via 172.23.0.1 dev eth0</span>
  <span class="c">#    10.10.0.0/24 via 172.23.0.2 dev eth0</span>
  <span class="c">#    10.10.1.0/24 via 172.23.0.5 dev eth0</span>
  <span class="c">#    10.10.2.0/24 via 172.23.0.3 dev eth0</span>
  <span class="c">#    10.10.4.3 dev veth9a888981 scope host</span>
  <span class="c">#    172.23.0.0/16 dev eth0 proto kernel scope link src 172.23.0.4</span>
  <span class="c">#</span>
  <span class="c">#    &lt;&lt;myk8s-worker2&gt;&gt;</span>
  <span class="c">#    default via 172.23.0.1 dev eth0</span>
  <span class="c">#    10.10.0.0/24 via 172.23.0.2 dev eth0</span>
  <span class="c">#    10.10.1.4 dev veth570fce87 scope host</span>
  <span class="c">#    10.10.2.0/24 via 172.23.0.3 dev eth0</span>
  <span class="c">#    10.10.4.0/24 via 172.23.0.4 dev eth0</span>
  <span class="c">#    172.23.0.0/16 dev eth0 proto kernel scope link src 172.23.0.5</span>
  <span class="c">#    </span>
  <span class="c">#    &lt;&lt;myk8s-worker3&gt;&gt;</span>
  <span class="c">#    default via 172.23.0.1 dev eth0</span>
  <span class="c">#    10.10.0.0/24 via 172.23.0.2 dev eth0</span>
  <span class="c">#    10.10.1.0/24 via 172.23.0.5 dev eth0</span>
  <span class="c">#    10.10.2.3 dev veth2e19df47 scope host</span>
  <span class="c">#    10.10.4.0/24 via 172.23.0.4 dev eth0</span>
  <span class="c">#    172.23.0.0/16 dev eth0 proto kernel scope link src 172.23.0.3</span>
      
  <span class="nv">$ </span>ip <span class="nt">-c</span> addr
  <span class="c"># =&gt; &lt;&lt;myk8s-worker&gt;&gt;</span>
  <span class="c">#    3: veth9a888981@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether 26:a5:d2:44:f4:b4 brd ff:ff:ff:ff:ff:ff link-netns cni-0b7e59c3-3920-ce1f-874a-9e228adf3b72</span>
  <span class="c">#        inet 10.10.4.1/32 scope global veth9a888981</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
  <span class="c">#    134: eth0@if135: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:04 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
  <span class="c">#        inet 172.23.0.4/16 brd 172.23.255.255 scope global eth0</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
  <span class="c">#    </span>
  <span class="c">#    &lt;&lt;myk8s-worker2&gt;&gt;</span>
  <span class="c">#    4: veth570fce87@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether a6:8a:d8:a3:f4:ac brd ff:ff:ff:ff:ff:ff link-netns cni-8dcb2d16-f339-2571-03d2-d6b0f850878d</span>
  <span class="c">#        inet 10.10.1.1/32 scope global veth570fce87</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
  <span class="c">#    136: eth0@if137: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:05 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
  <span class="c">#        inet 172.23.0.5/16 brd 172.23.255.255 scope global eth0</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
  <span class="c">#    </span>
  <span class="c">#    &lt;&lt;myk8s-worker3&gt;&gt;</span>
  <span class="c">#    3: veth2e19df47@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether da:5e:a5:14:62:7b brd ff:ff:ff:ff:ff:ff link-netns cni-1f44bebd-9ebf-6af4-7888-945649a2b5c8</span>
  <span class="c">#        inet 10.10.2.1/32 scope global veth2e19df47</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
  <span class="c">#    132: eth0@if133: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span>
  <span class="c">#        link/ether 02:42:ac:17:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
  <span class="c">#        inet 172.23.0.3/16 brd 172.23.255.255 scope global eth0</span>
  <span class="c">#           valid_lft forever preferred_lft forever</span>
      
  <span class="c"># tcpdump/ngrep : eth0 &gt;&gt; tcp 9000 í¬íŠ¸ íŠ¸ë˜í”½ì€ ì™œ ì—†ì„ê¹Œ? iptables rule ë™ì‘ ê·¸ë¦¼ì„ í•œë²ˆ ë” í™•ì¸í•˜ê³  ì´í•´í•´ë³´ì</span>
  <span class="c">## ngrep ë„¤íŠ¸ì›Œí¬ íŒ¨í‚· ë¶„ì„ê¸° í™œìš©í•´ë³´ê¸° : íŠ¹ì • url í˜¸ì¶œì— ëŒ€í•´ì„œë§Œ í•„í„° ë“± ê¹”ë”í•˜ê²Œ ë³¼ ìˆ˜ ìˆìŒ - ë§í¬</span>
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 tcp port 80 <span class="nt">-nnq</span>
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 tcp port 80 <span class="nt">-w</span> /root/svc1-1.pcap
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth0 tcp port 9000 <span class="nt">-nnq</span>
  <span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> eth0 <span class="s1">''</span> <span class="s1">'tcp port 80'</span>
      
  <span class="c"># tcpdump/ngrep : vethX</span>
  <span class="c"># $ VETH1=&lt;ê°ì ìì‹ ì˜ veth ì´ë¦„&gt;</span>
  <span class="nv">$ VETH1</span><span class="o">=</span>veth9a888981
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> <span class="nv">$VETH1</span> tcp port 80 <span class="nt">-nn</span>
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> <span class="nv">$VETH1</span> tcp port 80 <span class="nt">-w</span> /root/svc1-2.pcap
  <span class="nv">$ </span>tcpdump <span class="nt">-i</span> <span class="nv">$VETH1</span> tcp port 9000 <span class="nt">-nn</span>
  <span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> <span class="nv">$VETH1</span> <span class="s1">''</span> <span class="s1">'tcp port 80'</span>
      
  <span class="nv">$ </span><span class="nb">exit</span>
  <span class="nt">----------------------------------</span>
      
  <span class="c"># ë°©ì•ˆ2 : kind ë…¸ë“œ ì»¨í…Œì´ë„ˆ bash ì§ì ‘ ì ‘ì†í•˜ì§€ ì•Šê³  í˜¸ìŠ¤íŠ¸ì—ì„œ tcpdump í•˜ê¸°</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker tcpdump <span class="nt">-i</span> eth0 tcp port 80 <span class="nt">-nnq</span>
  <span class="nv">$ VETH1</span><span class="o">=</span>&lt;ê°ì ìì‹ ì˜ veth ì´ë¦„&gt; docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker ip <span class="nt">-c</span> route
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker tcpdump <span class="nt">-i</span> <span class="nv">$VETH1</span> tcp port 80 <span class="nt">-nnq</span>
      
  <span class="c"># í˜¸ìŠ¤íŠ¸PCì— pcap íŒŒì¼ ë³µì‚¬ &gt;&gt; wireshark ì—ì„œ ë¶„ì„</span>
  <span class="nv">$ </span>docker <span class="nb">cp </span>myk8s-worker:/root/svc1-1.pcap <span class="nb">.</span>
  <span class="nv">$ </span>docker <span class="nb">cp </span>myk8s-worker:/root/svc1-2.pcap <span class="nb">.</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>net-pod í¬ë“œì— ì ‘ì† í›„ 10ê°œ curl ìš”ì²­</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh
<span class="nt">----------------------------------</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span>   <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$SVC1</span>:9000 | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;       4 Hostname: webpod3</span>
<span class="c">#          3 Hostname: webpod2</span>
<span class="c">#          3 Hostname: webpod1</span>
    
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------------</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ê°ê° net-podì™€ ì›Œì»¤ ë…¸ë“œë“¤ì˜ íŒ¨í‚·ìº¡ì³íŒŒì¼(*.pcap)ë¥¼ ë°›ì•„ì„œ ì™€ì´ì–´ìƒ¤í¬ë¡œ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>
        <ul>
          <li>
            <p>net-pod(10.10.0.7)ì—ì„œ ì„œë¹„ìŠ¤:9000 (IP:10.200.1.96)ìœ¼ë¡œ ìš”ì²­ëœ íŒ¨í‚·ì´ DNAT ë˜ì–´ k8s-workerì˜ webpod1:80 (IP:10.10.4.3)ìœ¼ë¡œ ì „ë‹¬ë˜ê³ , ì‘ë‹µì€ ê·¸ ë°˜ëŒ€ë¡œ ì „ë‹¬ ë˜ëŠ” ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_14.png" alt="img.png" loading="lazy" width="1123" height="122"></p>
          </li>
          <li>
            <p>ë˜í•œ Stastics ë©”ë‰´ì˜â†’ Flow Graph ê¸°ëŠ¥ì„ í†µí•´ íŒ¨í‚·ì˜ íë¦„ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

            <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_15.png" alt="img.png" loading="lazy" width="1498" height="314"></p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>iptables ì •ì±… í™•ì¸
    <ul>
      <li>kubernetesì—ì„œ serviceëŠ” ë‹¤ìŒì˜ iptables ê³¼ì •ì„ ê±°ì¹©ë‹ˆë‹¤.
        <ul>
          <li>(1) PREROUTING â‡’ (2) KUBE-SERVICES â‡’ (3) KUBE-SVC-YYY â‡’ (4) KUBE-SEP-#íŒŒë“œ1, KUBE-SEP-#íŒŒë“œ2, KUBE-SEP-#íŒŒë“œ3</li>
          <li>ê·¸ë¦¼ìœ¼ë¡œ ë‚˜íƒ€ë‚´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</li>
        </ul>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_16.png" alt="img.png" loading="lazy" width="828" height="195"></p>

        <ul>
          <li>
            <p>ê°ê°ì— ëŒ€í•˜ì—¬ iptables ë£°ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

            <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ í™•ì¸í•˜ê² ìŠµë‹ˆë‹¤.</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
  <span class="nt">----------------------------------------</span>
        
  <span class="c"># iptables í™•ì¸</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">wc</span> <span class="nt">-l</span>
  <span class="c"># =&gt; 97</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
        
  <span class="c"># iptables ìƒì„¸ í™•ì¸ - ë§¤ì¹­ íŒ¨í‚· ì¹´ìš´íŠ¸, ì¸í„°í˜ì´ìŠ¤ ì •ë³´ ë“± í¬í•¨</span>
  <span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> filter
  <span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> nat
  <span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> mangle
        
  <span class="c"># rule ê°¯ìˆ˜ í™•ì¸</span>
  <span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> filter | <span class="nb">wc</span> <span class="nt">-l</span>
  <span class="c"># =&gt; 47</span>
  <span class="nv">$ </span>iptables <span class="nt">-nvL</span> <span class="nt">-t</span> nat | <span class="nb">wc</span> <span class="nt">-l</span>
  <span class="c"># =&gt; 158</span>
        
  <span class="c"># ê·œì¹™ íŒ¨í‚· ë°”ì´íŠ¸ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">--zero</span><span class="p">;</span> iptables <span class="nt">-t</span> nat <span class="nt">--zero</span><span class="p">;</span> iptables <span class="nt">-t</span> mangle <span class="nt">--zero</span>
        
  <span class="c"># ì •ì±… í™•ì¸ : ì•„ë˜ ì •ì±… ë‚´ìš©ì€ í•µì‹¬ì ì¸ ë£°(rule)ë§Œ í‘œì‹œí–ˆìŠµë‹ˆë‹¤!</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-nvL</span>
  <span class="c"># =&gt; Chain PREROUTING (policy ACCEPT 121 packets, 7260 bytes) &lt;&lt;1. PREROUTING&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#      121  7260 KUBE-SERVICES  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span>
  <span class="c">#    ...</span>
  <span class="c">#    </span>
  <span class="c">#    Chain INPUT (policy ACCEPT 121 packets, 7260 bytes)</span>
  <span class="c">#    </span>
  <span class="c">#    Chain OUTPUT (policy ACCEPT 392 packets, 23520 bytes)</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#      392 23520 KUBE-SERVICES  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span>
  <span class="c">#    ...</span>
  <span class="c">#    </span>
  <span class="c">#    Chain KUBE-MARK-MASQ (18 references)</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 MARK       0    --  *      *       0.0.0.0/0            0.0.0.0/0            MARK or 0x4000</span>
  <span class="c">#    </span>
  <span class="c">#    Chain KUBE-SERVICES (2 references) &lt;&lt;2. SERVICES&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 KUBE-SVC-KBDEBIL6IU6WL7RF  6    --  *      *       0.0.0.0/0            10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
  <span class="c">#    ...</span>
  <span class="c">#    </span>
  <span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references) &lt;&lt;3. KUBE-SVC-YYY&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
  <span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
  <span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
  <span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
  <span class="c">#    </span>
  <span class="c">#    Chain KUBE-SEP-X47GKN7LA32LZ4H7 (1 references) &lt;&lt;4. KUBE-SEP-#WEBPOD1&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 KUBE-MARK-MASQ  0    --  *      *       10.10.4.3            0.0.0.0/0            /* default/svc-clusterip:svc-webport */</span>
  <span class="c">#        0     0 DNAT       6    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport */ tcp to:10.10.4.3:80</span>
  <span class="c">#    </span>
  <span class="c">#    Chain KUBE-SEP-T7YVH2JOMUTQFUDU (1 references) &lt;&lt;4. KUBE-SEP-#WEBPOD2&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 KUBE-MARK-MASQ  0    --  *      *       10.10.1.4            0.0.0.0/0            /* default/svc-clusterip:svc-webport */</span>
  <span class="c">#        0     0 DNAT       6    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport */ tcp to:10.10.1.4:80</span>
  <span class="c">#</span>
  <span class="c">#    Chain KUBE-SEP-SZHENXPAXVOCHRDA (1 references) &lt;&lt;4. KUBE-SEP-#WEBPOD3&gt;&gt;</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#        0     0 KUBE-MARK-MASQ  0    --  *      *       10.10.2.3            0.0.0.0/0            /* default/svc-clusterip:svc-webport */</span>
  <span class="c">#        0     0 DNAT       6    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport */ tcp to:10.10.2.3:80</span>
        
  <span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> PREROUTING | column <span class="nt">-t</span>
  <span class="c"># =&gt; Chain  PREROUTING  (policy        ACCEPT  777  packets,  46620  bytes)</span>
  <span class="c">#    pkts   bytes       target         prot    opt  in        out    source     destination</span>
  <span class="c">#    777    46620       KUBE-SERVICES  0       --   *         *      0.0.0.0/0  0.0.0.0/0    /*  kubernetes  service  portals  */</span>
  <span class="c">#    0      0           DOCKER_OUTPUT  0       --   *         *      0.0.0.0/0  172.23.0.1</span>
        
  <span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SERVICES | column
  <span class="c"># ë°”ë¡œ ì•„ë˜ ë£°(rule)ì— ì˜í•´ì„œ ì„œë¹„ìŠ¤(ClusterIP)ë¥¼ ì¸ì§€í•˜ê³  ì²˜ë¦¬ë¥¼ í•©ë‹ˆë‹¤</span>
  <span class="c"># =&gt; Chain  KUBE-SERVICES  (2                         references)</span>
  <span class="c">#    pkts   bytes          target                     prot         opt  in  out  source     destination</span>
  <span class="c">#    0      0              KUBE-SVC-KBDEBIL6IU6WL7RF  6            --   *   *    0.0.0.0/0  10.200.1.96   /*  default/svc-clusterip:svc-webport  cluster  IP          */     tcp   dpt:9000</span>
        
  <span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SVC-KBDEBIL6IU6WL7RF | column
  <span class="c"># =&gt; Chain  KUBE-SVC-KBDEBIL6IU6WL7RF  (1                         references)</span>
  <span class="c">#    pkts   bytes                      target                     prot         opt  in  out  source         destination</span>
  <span class="c">#    0      0                          KUBE-SEP-T7YVH2JOMUTQFUDU  0            --   *   *    0.0.0.0/0      0.0.0.0/0    /*  default/svc-clusterip:svc-webport  -&gt;       10.10.1.4:80  */  statistic  mode      random  probability  0.33333333349</span>
  <span class="c">#    0      0                          KUBE-SEP-SZHENXPAXVOCHRDA  0            --   *   *    0.0.0.0/0      0.0.0.0/0    /*  default/svc-clusterip:svc-webport  -&gt;       10.10.2.3:80  */  statistic  mode      random  probability  0.50000000000</span>
  <span class="c">#    0      0                          KUBE-SEP-X47GKN7LA32LZ4H7  0            --   *   *    0.0.0.0/0      0.0.0.0/0    /*  default/svc-clusterip:svc-webport  -&gt;       10.10.4.3:80  */</span>
        
  <span class="c"># íŒ¨í‚· ì „ë‹¬ ìˆ˜ë¥¼ í™•ì¸ í•˜ê¸° ìœ„í•´ watchë¥¼ ê²ë‹ˆë‹¤.</span>
  <span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF'</span>
        
  <span class="c"># control-plane ì—ì„œ í…ŒìŠ¤íŠ¸ íŒ¨í‚·ì„ ë³´ëƒ…ë‹ˆë‹¤.</span>
  <span class="nv">$ SVC1</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};   do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; sleep 1; done"</span>
</code></pre></div>            </div>

            <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_17.png" alt="img.png" loading="lazy" width="1940" height="756"></p>
          </li>
          <li>
            <p>iptablesì—ì„œ  ì¹´ìš´íŠ¸ê°€ ì¦ê°€í•¨ì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># SVC-### ì—ì„œ ëœë¤ í™•ë¥ (ëŒ€ëµ 33%)ë¡œ SEP(Service EndPoint)ì¸ ê°ê° íŒŒë“œ IPë¡œ DNAT ë©ë‹ˆë‹¤!</span>
<span class="c">## ì²«ë²ˆì§¸ ë£°ì— ì¼ì¹˜ í™•ë¥ ì€ 33% ì´ê³ , ë§¤ì¹­ë˜ì§€ ì•Šì„ ê²½ìš° ì•„ë˜ 2ê°œ ë‚¨ì„ë•ŒëŠ” ë£° ì¼ì¹˜ í™•ë¥ ì€ 50%ê°€ ë©ë‹ˆë‹¤. ì´ê²ƒë„ ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ë§ˆì§€ë§‰ ë£°ë¡œ 100% ì¼ì¹˜ë©ë‹ˆë‹¤</span>
<span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination</span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#       41  2460 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#       47  2820 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#       45  2700 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
      
<span class="c"># $ iptables -v --numeric --table nat --list KUBE-SEP-&lt;ê°ì ê°’ ì…ë ¥&gt;</span>
<span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SEP-T7YVH2JOMUTQFUDU
<span class="c"># =&gt; Chain  KUBE-SEP-T7YVH2JOMUTQFUDU  (1              references)</span>
<span class="c">#    pkts   bytes                      target          prot         opt  in  out  source     destination</span>
<span class="c">#    49     2940                       DNAT            6            --   *   *    0.0.0.0/0  0.0.0.0/0    /*  default/svc-clusterip:svc-webport  */  tcp  to:10.10.1.4:80</span>
      
<span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SEP-SZHENXPAXVOCHRDA  | column <span class="nt">-t</span>
<span class="c"># =&gt; Chain  KUBE-SEP-SZHENXPAXVOCHRDA  (1              references)</span>
<span class="c">#    pkts   bytes                      target          prot         opt  in  out  source     destination</span>
<span class="c">#    0      0                          KUBE-MARK-MASQ  0            --   *   *    10.10.2.3  0.0.0.0/0    /*  default/svc-clusterip:svc-webport  */</span>
<span class="c">#    56     3360                       DNAT            6            --   *   *    0.0.0.0/0  0.0.0.0/0    /*  default/svc-clusterip:svc-webport  */  tcp  to:10.10.2.3:80</span>
      
<span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SEP-X47GKN7LA32LZ4H7  | column <span class="nt">-t</span>
<span class="c"># =&gt; Chain  KUBE-SEP-X47GKN7LA32LZ4H7  (1              references)</span>
<span class="c">#    pkts   bytes                      target          prot         opt  in  out  source     destination</span>
<span class="c">#    0      0                          KUBE-MARK-MASQ  0            --   *   *    10.10.4.3  0.0.0.0/0    /*  default/svc-clusterip:svc-webport  */</span>
<span class="c">#    48     2880                       DNAT            6            --   *   *    0.0.0.0/0  0.0.0.0/0    /*  default/svc-clusterip:svc-webport  */  tcp  to:10.10.4.3:80</span>
      
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">--zero</span>
<span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> POSTROUTING | column<span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-POSTROUTING | column
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -v --numeric --table nat --list POSTROUTING; echo ; iptables -v --numeric --table nat --list KUBE-POSTROUTING'</span>
<span class="c"># POSTROUTE(nat) : 0x4000 ë§ˆí‚¹ ë˜ì–´ ìˆì§€ ì•Šìœ¼ë‹ˆ RETURN ë˜ê³  ê·¸ëƒ¥ ë¹ ì ¸ë‚˜ê°€ì„œ SNAT ë˜ì§€ ì•ŠëŠ”ë‹¤!</span>
<span class="c"># =&gt; Chain  POSTROUTING  (policy             ACCEPT  0    packets,  0    bytes)</span>
<span class="c">#    pkts   bytes        target              prot    opt  in        out  source     destination</span>
<span class="c">#    0      0            KUBE-POSTROUTING    0       --   *         *    0.0.0.0/0  0.0.0.0/0    /*        kubernetes  postrouting  rules   */</span>
<span class="c">#    0      0            DOCKER_POSTROUTING  0       --   *         *    0.0.0.0/0  172.23.0.1</span>
<span class="c">#    0      0            KIND-MASQ-AGENT     0       --   *         *    0.0.0.0/0  0.0.0.0/0    ADDRTYPE  match       dst-type     !LOCAL  /*  kind-masq-agent:  ensure  nat  POSTROUTING  directs  all  non-LOCAL  destination  traffic  to  our  custom  KIND-MASQ-AGENT  chain  */</span>
<span class="c"># =&gt; Chain  KUBE-POSTROUTING  (1          references)</span>
<span class="c">#    pkts   bytes             target      prot         opt  in  out  source     destination</span>
<span class="c">#    0      0                 RETURN      0            --   *   *    0.0.0.0/0  0.0.0.0/0    mark  match       !        0x4000/0x4000</span>
<span class="c">#    0      0                 MARK        0            --   *   *    0.0.0.0/0  0.0.0.0/0    MARK  xor         0x4000</span>
<span class="c">#    0      0                 MASQUERADE  0            --   *   *    0.0.0.0/0  0.0.0.0/0    /*    kubernetes  service  traffic        requiring  SNAT  */  random-fully</span>
      
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>KUBE-POSTROUTING
<span class="c"># =&gt; -N KUBE-POSTROUTING</span>
<span class="c">#    -A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING</span>
<span class="c">#    -A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN</span>
<span class="c">#    -A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0</span>
<span class="c">#    -A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -j MASQUERADE --random-fully</span>
      
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------------------</span>
      
<span class="c"># ìœ„ ì„œë¹„ìŠ¤ ìƒì„± ì‹œ kube-proxy ì— ì˜í•´ì„œ iptables ê·œì¹™ì´ ëª¨ë“  ë…¸ë“œì— ì¶”ê°€ë¨ì„ í•œë²ˆ ë” í™•ì¸</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SVC-KBDEBIL6IU6WL7RF
<span class="c"># =&gt; Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
      
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> KUBE-SVC-KBDEBIL6IU6WL7RF<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
<span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
<span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
<span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
<span class="c">#    Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
<span class="c">#        0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.96          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000</span>
<span class="c">#        0     0 KUBE-SEP-T7YVH2JOMUTQFUDU  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.1.4:80 */ statistic mode random probability 0.33333333349</span>
<span class="c">#        0     0 KUBE-SEP-SZHENXPAXVOCHRDA  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.2.3:80 */ statistic mode random probability 0.50000000000</span>
<span class="c">#        0     0 KUBE-SEP-X47GKN7LA32LZ4H7  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -&gt; 10.10.4.3:80 */</span>
</code></pre></div>            </div>
          </li>
          <li>
            <p>ë™ì¼í•œ iptables ë£°ì´ ê° ë…¸ë“œì— ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          </li>
        </ul>
      </li>
      <li>íŒŒë“œ 1ê°œì— ì¥ì• ë¥¼ ë°œìƒì‹œì¼œì„œ ì¥ì• ì‹œ ë™ì‘ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
        <ul>
          <li>
            <p>ë™ì‘ í™•ì¸ì„ ìœ„í•œ ëª¨ë‹ˆí„°ë§</p>

            <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># í„°ë¯¸ë„1 &gt;&gt; ENDPOINTS ë³€í™”ë¥¼ ì˜ í™•ì¸í•´ë³´ì!</span>
  <span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pod -owide;echo; kubectl get svc,ep svc-clusterip;echo; kubectl get endpointslices -l kubernetes.io/service-name=svc-clusterip'</span>
        
  <span class="c"># í„°ë¯¸ë„2</span>
  <span class="nv">$ SVC1</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-clusterip <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$SVC1</span><span class="s2">:9000 | egrep 'Hostname|IP: 10'; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>
  <span class="c"># í˜¹ì€</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};  do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
</code></pre></div>            </div>
          </li>
          <li>
            <p>íŒŒë“œ 1ê°œ ì‚­ì œ í›„ í™•ì¸</p>

            <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># (ë°©ì•ˆ1) íŒŒë“œ3ë²ˆ ì‚­ì œ &gt;&gt; ì„œë¹„ìŠ¤ì˜ ì—”ë“œí¬ì¸íŠ¸ê°€ ì–´ë–»ê²Œ ë³€ê²½ë˜ëŠ”ì§€ í™•ì¸ í•˜ì!, ì§€ì†ì ì¸ curl ì ‘ì† ê²°ê³¼ í™•ì¸!, for ë¬¸ ì‹¤í–‰ ì‹œ ê²°ê³¼ í™•ì¸!, ì ˆì²´ ì‹œê°„(ìˆœë‹¨) í™•ì¸!</span>
  <span class="nv">$ </span>kubectl delete pod webpod3
        
  <span class="c"># (ë°©ì•ˆ1) ê²°ê³¼ í™•ì¸ í›„ ë‹¤ì‹œ íŒŒë“œ 3ë²ˆ ìƒì„± &gt;&gt; ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬!</span>
  <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> 3pod.yaml
        
  <span class="nt">---------------------------------</span>
  <span class="c"># (ë°©ì•ˆ2) íŒŒë“œ3ë²ˆì— ë ˆì´ë¸” ì‚­ì œ</span>
  <span class="nv">$ </span>kubectl get pod <span class="nt">--show-labels</span>
        
  <span class="c">## ë ˆì´ë¸”(ë¼ë²¨)ì˜ í‚¤ê°’ ë°”ë¡œ ë’¤ì— í•˜ì´í”ˆ(-) ì…ë ¥ ì‹œ í•´ë‹¹ ë ˆì´ë¸” ì‚­ì œë¨! &gt;&gt; ë ˆì´ë¸”ê³¼ ì…€ë ‰í„°ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì—ì„œ ë§¤ìš° ë§ì´ í™œìš©ëœë‹¤!</span>
  <span class="nv">$ </span>kubectl label pod webpod3 app-
  <span class="nv">$ </span>kubectl get pod <span class="nt">--show-labels</span>
        
  <span class="c"># (ë°©ì•ˆ2) ê²°ê³¼ í™•ì¸ í›„ íŒŒë“œ3ë²ˆì— ë‹¤ì‹œ ë ˆì´ë¸” ìƒì„±</span>
  <span class="nv">$ </span>kubectl label pod webpod3 <span class="nv">app</span><span class="o">=</span>webpod
</code></pre></div>            </div>

            <ul>
              <li>
                <p>íŒŒë“œ ì‚­ì œ ì „</p>

                <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_18.png" alt="img.png" loading="lazy" width="1453" height="1023"></p>
              </li>
              <li>
                <p>íŒŒë“œ ì‚­ì œ í›„</p>

                <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_19.png" alt="img.png" loading="lazy" width="1453" height="1023"></p>
              </li>
              <li>
                <p>íŒŒë“œ ë‹¤ì‹œ ìƒì„± í›„</p>

                <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_20.png" alt="img.png" loading="lazy" width="1453" height="1023"></p>
              </li>
              <li>
                <p>ë ˆì´ë¸” ì‚­ì œ í›„</p>

                <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_21.png" alt="img.png" loading="lazy" width="1453" height="1023"></p>
              </li>
              <li>
                <p>ë ˆì´ë¸” ë³µêµ¬ í›„</p>

                <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_22.png" alt="img.png" loading="lazy" width="1453" height="1023"></p>
              </li>
            </ul>
          </li>
          <li>
            <p>íŒŒë“œê°€ ì‚­ì œë˜ê³  ë³µêµ¬ ë¨ì— ë”°ë¼ ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì‚­ì œë˜ê³ , label selector ì— ë”°ë¼ì„œë„ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì‚­ì œë˜ê³  ë³µêµ¬ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>
          </li>
        </ul>
      </li>
      <li>sessionAffinity: ClientIP
        <ul>
          <li>
<code class="language-plaintext highlighter-rouge">sessionAffinity: ClientIP</code> : í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ì†í•œ ëª©ì ì§€(íŒŒë“œ)ì— ê³ ì •ì ì¸ ì ‘ì†ì„ ì§€ì›í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>
            <p>ê¸°ë³¸ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ëŠ” íŒŒë“œì— ëœë¤ìœ¼ë¡œ ë¶€í•˜ë¥¼ ë¶„ì‚°í•˜ì§€ë§Œ <code class="language-plaintext highlighter-rouge">sessionAffinity: ClientIP</code>ë¥¼ í†µí•´ ë™ì¼í•œ íŒŒë“œì— ì ‘ì†í•˜ë„ë¡ ê°•ì œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_23.png" alt="img.png" loading="lazy" width="1092" height="366"></p>
          </li>
          <li>
            <p>ì„¤ì • ë° íŒŒë“œ ì ‘ì† í™•ì¸</p>

            <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># ê¸°ë³¸ ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>kubectl get svc svc-clusterip <span class="nt">-o</span> yaml
  <span class="nv">$ </span>kubectl get svc svc-clusterip <span class="nt">-o</span> yaml | <span class="nb">grep </span>sessionAffinity
  <span class="c"># =&gt;   sessionAffinity: None</span>
        
  <span class="c"># ë°˜ë³µ ì ‘ì†</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$SVC1</span><span class="s2">:9000 | egrep 'Hostname|IP: 10|Remote'; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>
  <span class="c"># =&gt; Hostname: webpod2</span>
  <span class="c">#    IP: 10.10.1.4</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:57246</span>
  <span class="c">#    2024-09-01 12:25:49</span>
  <span class="c">#    </span>
  <span class="c">#    Hostname: webpod1</span>
  <span class="c">#    IP: 10.10.4.3</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:57250</span>
  <span class="c">#    2024-09-01 12:25:50</span>
  <span class="c">#    </span>
  <span class="c">#    Hostname: webpod3</span>
  <span class="c">#    IP: 10.10.2.6</span>
  <span class="c">#    RemoteAddr: 10.10.0.7:57252</span>
  <span class="c">#    2024-09-01 12:25:51</span>
        
  <span class="c"># í˜„ì¬ëŠ” ëœë¤ìœ¼ë¡œ ì ‘ì† ë©ë‹ˆë‹¤.</span>
        
  <span class="c"># sessionAffinity: ClientIP ì„¤ì • ë³€ê²½</span>
  <span class="nv">$ </span>kubectl patch svc svc-clusterip <span class="nt">-p</span> <span class="s1">'{"spec":{"sessionAffinity":"ClientIP"}}'</span>
  <span class="c"># =&gt; service/svc-clusterip patched</span>
  <span class="c"># í˜¹ì€</span>
  <span class="c">## $ kubectl get svc svc-clusterip -o yaml | sed -e "s/sessionAffinity: None/sessionAffinity: ClientIP/" | kubectl apply -f -</span>
        
  <span class="c">#</span>
  <span class="nv">$ </span>kubectl get svc svc-clusterip <span class="nt">-o</span> yaml
  <span class="c"># =&gt; ...</span>
  <span class="c">#      sessionAffinity: ClientIP</span>
  <span class="c">#      sessionAffinityConfig:</span>
  <span class="c">#        clientIP:</span>
  <span class="c">#          timeoutSeconds: 10800</span>
  <span class="c">#    ...</span>
        
  <span class="c"># í´ë¼ì´ì–¸íŠ¸(TestPod) Shell ì‹¤í–‰</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100};  do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt; 100 Hostname: webpod2</span>
  <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> net-pod <span class="nt">--</span> zsh <span class="nt">-c</span> <span class="s2">"for i in {1..1000}; do curl -s </span><span class="nv">$SVC1</span><span class="s2">:9000 | grep Hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt; 1000 Hostname: webpod2</span>
</code></pre></div>            </div>

            <ul>
              <li>sessionAffinity: ClientIPë¥¼ í•˜ë©´ spec.sessionAffinityConfig.clientIP.timeoutSeconds ì‹œê°„ë™ì•ˆ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ì ‘ì† ë˜ëŠ” íŒŒë“œê°€ ê³ ì •ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ì´ìƒê³¼ ê°™ì´ ClusterIP íƒ€ì…ì˜ ì„œë¹„ìŠ¤ë¥¼ í™•ì¸í•´ë³´ì•˜ìŠµë‹ˆë‹¤.</li>
  <li>ClusterIP íƒ€ì…ì˜ ì„œë¹„ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ì ì´ ìˆë‹¤ê³  í•©ë‹ˆë‹¤.
    <ul>
      <li>í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œëŠ” ì„œë¹„ìŠ¤(ClusterIP)ë¡œ ì ‘ì†ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. â‡’ <strong>NodePort</strong> íƒ€ì…ìœ¼ë¡œ ì™¸ë¶€ì—ì„œ ì ‘ì† ê°€ëŠ¥</li>
      <li>IPtables ëŠ” íŒŒë“œì— ëŒ€í•œ í—¬ìŠ¤ì²´í¬ ê¸°ëŠ¥ì´ ì—†ì–´ì„œ ë¬¸ì œ ìˆëŠ” íŒŒë“œì— ì—°ê²°ì´ ë˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤. â‡’ ì„œë¹„ìŠ¤ ì‚¬ìš©, íŒŒë“œì— Readiness Probe ì„¤ì •ìœ¼ë¡œ íŒŒë“œ ë¬¸ì œ ì‹œ ì„œë¹„ìŠ¤ì˜ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì œê±°ë˜ê²Œ í•˜ì! â† ì´ ì •ë„ë©´ ì¶©ë¶„í•œê°€? í˜¹ì‹œ ë¶€ì¡±í•œ ì ì´ ì—†ì„ê¹Œ?</li>
      <li>ì„œë¹„ìŠ¤ì— ì—°ë™ëœ íŒŒë“œ ê°¯ìˆ˜ í¼ì„¼íŠ¸(%)ë¡œ <strong>ëœë¤ ë¶„ì‚°</strong> ë°©ì‹, <strong>ì„¸ì…˜ì–´í”¼ë‹ˆí‹°</strong> ì´ì™¸ì— <strong>ë‹¤ë¥¸ ë¶„ì‚° ë°©ì‹ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</strong> â‡’ <strong>IPVS</strong> ê²½ìš° ë‹¤ì–‘í•œ ë¶„ì‚° ë°©ì‹(ì•Œê³ ë¦¬ì¦˜) ê°€ëŠ¥
        <ul>
          <li>ëª©ì ì§€ íŒŒë“œ ë‹¤ìˆ˜ê°€ ìˆëŠ” í™˜ê²½ì—ì„œ, ì¶œë°œì§€ íŒŒë“œì™€ ëª©ì ì§€ íŒŒë“œê°€ ë™ì¼í•œ ë…¸ë“œì— ë°°ì¹˜ë˜ì–´ ìˆì–´ë„, ëœë¤ ë¶„ì‚°ìœ¼ë¡œ ë‹¤ë¥¸ ë…¸ë“œì— ëª©ì ì§€ íŒŒë“œë¡œ ì—°ê²° ê°€ëŠ¥</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="nodeport-ì‹¤ìŠµ">NodePort ì‹¤ìŠµ</h4>

<ul>
  <li>NodePortëŠ” ClusterIPì™€ ë‹¤ë¥´ê²Œ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œë„ ì ‘ì† í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì„ í¬í•¨í•œ ëª¨ë“  ë…¸ë“œì— iptables ruleì´ ì ìš©ë˜ë¯€ë¡œ, ëª¨ë“  ë…¸ë“œì— NodePortë¡œ ì ‘ì†ì‹œ iptables ruleì— ì˜í•´ì„œ ë¶„ì‚° ì ‘ì†ì´ ë©ë‹ˆë‹¤.</li>
  <li>Nodeì˜ ëª¨ë“  Local IP (loopbackì„ í¬í•¨í•œ ê° í˜¸ìŠ¤íŠ¸ì˜ interfaceì˜ IP) ì‚¬ìš© ê°€ëŠ¥í•˜ê³  Local IP ì§€ì •ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ NodePortëŠ” ê¸°ë³¸ 30000~32767 í¬íŠ¸ì—ì„œ ëœë¤ìœ¼ë¡œ ì§€ì •ë©ë‹ˆë‹¤.
    <ul>
      <li>
        <p>ëœë¤ í¬íŠ¸ ë²”ìœ„ë¥¼ ë°”ê¾¸ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´  <code class="language-plaintext highlighter-rouge">/etc/kubernetes/manifests/kube-apiserver.yaml</code> íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ kube-apiserver ì˜ íŒŒë¼ë©”í„°ì— <code class="language-plaintext highlighter-rouge">--service-node-port-range=ì‹œì‘í¬íŠ¸-ì¢…ë£Œí¬íŠ¸</code>ë¥¼ ë³€ê²½í•˜ë©´ë©ë‹ˆë‹¤. <a href="https://blog.frec.kr/cloud/modify_nodeport_range/">ì°¸ê³ </a></p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># /etc/kubernetes/manifests/kube-apiserver.yaml</span>
      
  ...
  spec:
    containers:
    - <span class="nb">command</span>:
      - kube-apiserver
      - <span class="nt">--authorization-mode</span><span class="o">=</span>Node,RBAC
      ...
      - <span class="nt">--service-node-port-range</span><span class="o">=</span>30000-50000
  ...
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>ì‹¤ìŠµ êµ¬ì„±
    <ul>
      <li>
        <p>ëª©ì ì§€(backend) ë””í”Œë¡œì´ë¨¼íŠ¸ íŒŒì¼ ìƒì„± : echo-deploy.yml</p>

        <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">deploy-echo</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
    <span class="na">selector</span><span class="pi">:</span>
      <span class="na">matchLabels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">deploy-websrv</span>
    <span class="na">template</span><span class="pi">:</span>
      <span class="na">metadata</span><span class="pi">:</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="na">app</span><span class="pi">:</span> <span class="s">deploy-websrv</span>
      <span class="na">spec</span><span class="pi">:</span>
        <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
        <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">kans-websrv</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">mendhak/http-https-echo</span>
          <span class="na">ports</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì„œë¹„ìŠ¤(NodePort) íŒŒì¼ ìƒì„± : svc-nodeport.yml</p>

        <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="err">*</span><span class="nv">*Service</span><span class="err">**</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">svc-nodeport</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">svc-webport</span>
        <span class="na">port</span><span class="pi">:</span> <span class="m">9000</span>        <span class="c1"># ì„œë¹„ìŠ¤ ClusterIP ì— ì ‘ì† ì‹œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ port ë¥¼ ì˜ë¯¸</span>
        <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>  <span class="c1"># íƒ€í‚· targetPort ëŠ” ì„œë¹„ìŠ¤ë¥¼ í†µí•´ì„œ ëª©ì ì§€ íŒŒë“œë¡œ ì ‘ì† ì‹œ í•´ë‹¹ íŒŒë“œë¡œ ì ‘ì†í•˜ëŠ” í¬íŠ¸ë¥¼ ì˜ë¯¸</span>
    <span class="na">selector</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">deploy-websrv</span>
    <span class="na">**type</span><span class="pi">:</span> <span class="s">NodePort**</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ìƒì„± ë° í™•ì¸</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># ìƒì„±</span>
  <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> echo-deploy.yml,svc-nodeport.yml
  <span class="c"># =&gt; deployment.apps/deploy-echo created</span>
  <span class="c">#    service/svc-nodeport created</span>
      
  <span class="c"># ëª¨ë‹ˆí„°ë§</span>
  <span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pod -owide;echo; kubectl get svc,ep svc-nodeport'</span>
      
  <span class="c"># í™•ì¸</span>
  <span class="nv">$ </span>kubectl get deploy,pod <span class="nt">-o</span> wide
  <span class="c"># =&gt; NAME                          READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS    IMAGES                    SELECTOR</span>
  <span class="c">#    deployment.apps/deploy-echo   3/3     3            3           49s   kans-websrv   mendhak/http-https-echo   app=deploy-websrv</span>
  <span class="c">#    </span>
  <span class="c">#    NAME                               READY   STATUS    RESTARTS   AGE    IP          NODE                  NOMINATED NODE   READINESS GATES</span>
  <span class="c">#    pod/deploy-echo-5c689d5454-dxf2t   1/1     Running   0          49s    10.10.4.4   myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    pod/deploy-echo-5c689d5454-rbgcp   1/1     Running   0          49s    10.10.1.5   myk8s-worker2         &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    pod/deploy-echo-5c689d5454-wppr8   1/1     Running   0          49s    10.10.2.7   myk8s-worker3         &lt;none&gt;           &lt;none&gt;</span>
      
  <span class="c"># ì•„ë˜ 31791ì€ ì„œë¹„ìŠ¤(NodePort) ì •ë³´!</span>
  <span class="nv">$ </span>kubectl get svc svc-nodeport
  <span class="c"># =&gt; NAME           TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
  <span class="c">#    svc-nodeport   NodePort   10.200.1.169   &lt;none&gt;        9000:31791/TCP   69s</span>
      
  <span class="nv">$ </span>kubectl get endpoints svc-nodeport
  <span class="c"># =&gt; NAME           ENDPOINTS                                      AGE</span>
  <span class="c">#    svc-nodeport   10.10.1.5:8080,10.10.2.7:8080,10.10.4.4:8080   85s</span>
      
  <span class="c"># Port , TargetPort , NodePort ê°ê°ì˜ ì°¨ì´ì ì˜ ì˜ë¯¸ë¥¼ ì•Œì!</span>
  <span class="nv">$ </span>kubectl describe svc svc-nodeport
  <span class="c"># =&gt; Name:                     svc-nodeport</span>
  <span class="c">#    Namespace:                default</span>
  <span class="c">#    Labels:                   &lt;none&gt;</span>
  <span class="c">#    Annotations:              &lt;none&gt;</span>
  <span class="c">#    Selector:                 app=deploy-websrv</span>
  <span class="c">#    Type:                     NodePort</span>
  <span class="c">#    IP Family Policy:         SingleStack</span>
  <span class="c">#    IP Families:              IPv4</span>
  <span class="c">#    IP:                       10.200.1.169</span>
  <span class="c">#    IPs:                      10.200.1.169</span>
  <span class="c">#    Port:                     svc-webport  9000/TCP     &lt;&lt;ClusterIPì™€ ë™ì¼í•˜ê²Œ ë™ì‘í•˜ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸&gt;&gt;</span>
  <span class="c">#    TargetPort:               8080/TCP                  &lt;&lt;íŒŒë“œì˜ ì»¨í…Œì´ë„ˆì˜ í¬íŠ¸&gt;&gt;</span>
  <span class="c">#    NodePort:                 svc-webport  31791/TCP    &lt;&lt;ê° Nodeì—ì„œ Listening í•˜ëŠ” nodePort&gt;&gt;</span>
  <span class="c">#    Endpoints:                10.10.1.5:8080,10.10.2.7:8080,10.10.4.4:8080    &lt;&lt;Port Forwarding ëŒ€ìƒì´ ë˜ëŠ” íŒŒë“œì˜ ì—”ë“œí¬ì¸íŠ¸ íŒŒë“œIP:íŒŒë“œPort&gt;&gt;</span>
  <span class="c">#    Session Affinity:         None</span>
  <span class="c">#    External Traffic Policy:  Cluster &lt;&lt;ë¶€í•˜ ë¶„ì‚°ë°©ì‹&gt;&gt;</span>
  <span class="c">#    Events:                   &lt;none&gt;</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>2.3. ì„œë¹„ìŠ¤ ì ‘ì† í™•ì¸
    <ul>
      <li>
        <p>NodePortì˜ ì„œë¹„ìŠ¤ ì ‘ì†ì„ í†µí•œ í†µì‹ ì˜ íë¦„</p>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_24.png" alt="img.png" loading="lazy" width="825" height="203"></p>

        <ul>
          <li>Client ê°€ìƒ ë¨¸ì‹ (192.168.10.200)ì—ì„œ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ IP(192.168.10.10)ì˜ nodePort ì ‘ì†ì„ ì‹œë„í•©ë‹ˆë‹¤.</li>
          <li>nodePortëŠ” ì„œë¹„ìŠ¤(NodePort) ìƒì„±ì‹œì— í• ë‹¹ëœ ëœë¤í¬íŠ¸ê°€ ì‚¬ìš© ë©ë‹ˆë‹¤.</li>
          <li>ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì˜ iptablesì˜ NAT í…Œì´ë¸”ì˜ ê·œì¹™ê³¼ ë§¤ì¹­ë˜ì–´ ëª©ì ì§€ IPì™€ ëª©ì ì§€ PortëŠ” ë³€í™˜ ë©ë‹ˆë‹¤. ëª©ì ì§€ IPëŠ” app=deploy-websrv ë ˆì´ë¸”ì„ ê°€ì§€ê³  ìˆëŠ” íŒŒë“œ 3ê°œê°€ ëŒ€ìƒì´ ë˜ë©°, ëœë¤ ë¶€í•˜ë¶„ì‚°ì´ ì„ íƒë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>
        <p>ì‹¤ìŠµì„ í†µí•´ ìœ„ì˜ ê³¼ì •ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤. ë‹¨ í˜„ì¬ ì‹¤ìŠµí™˜ê²½ì—ì„œëŠ” ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ëŠ” íŒŒë“œê°€ ì—†ìœ¼ë¯€ë¡œ ìœ„ì˜ ì„¤ëª…ê³¼ëŠ” ë‹¤ë¥´ê²Œ ì›Œì»¤ë…¸ë“œì˜ íŒŒë“œë¥¼ ì ‘ì†í•˜ëŠ”ê²ƒìœ¼ë¡œ ì‹¤ìŠµí•˜ê² ìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># NodePort í™•ì¸ : ì•„ë˜ NodePort ëŠ” ë²”ìœ„ë‚´ ëœë¤ í• ë‹¹ìœ¼ë¡œ ì‹¤ìŠµ í™˜ê²½ë§ˆë‹¤ ë‹¤ë¦…ë‹ˆë‹¤</span>
  <span class="nv">$ </span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span>
  <span class="c"># =&gt; 31791</span>
      
  <span class="c"># NodePort ë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
  <span class="nv">$ NPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NPORT</span>
  <span class="c"># =&gt; 31791</span>
      
  <span class="c"># í˜„ì¬ k8s ë²„ì „ì—ì„œëŠ” í¬íŠ¸ Listen ë˜ì§€ ì•Šê³ , iptables rules ì²˜ë¦¬ë¨</span>
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> ss <span class="nt">-tlnp</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
  <span class="c">#    State  Recv-Q Send-Q Local Address:Port  Peer Address:PortProcess                                  </span>
  <span class="c">#    LISTEN 0      4096       127.0.0.1:2381       0.0.0.0:*    users:(("etcd",pid=710,fd=15))          </span>
  <span class="c">#    ... nodePortì¸ 31791ë¥¼ LISTENí•˜ëŠ” ê±´ì´ ì—†ìŒ</span>
  <span class="c">#</span>
  <span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
  <span class="c">#    State  Recv-Q Send-Q Local Address:Port  Peer Address:PortProcess                              </span>
  <span class="c">#    LISTEN 0      4096      127.0.0.11:35033      0.0.0.0:*                                        </span>
  <span class="c">#    ... nodePortì¸ 31791ë¥¼ LISTENí•˜ëŠ” ê±´ì´ ì—†ìŒ</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
  <span class="c">#    State  Recv-Q Send-Q Local Address:Port  Peer Address:PortProcess                              </span>
  <span class="c">#    LISTEN 0      4096      127.0.0.11:45927      0.0.0.0:*                                        </span>
  <span class="c">#    ... nodePortì¸ 31791ë¥¼ LISTENí•˜ëŠ” ê±´ì´ ì—†ìŒ</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
  <span class="c">#    State  Recv-Q Send-Q Local Address:Port  Peer Address:PortProcess                              </span>
  <span class="c">#    LISTEN 0      4096       127.0.0.1:10248      0.0.0.0:*    users:(("kubelet",pid=262,fd=19))   </span>
  <span class="c">#    ... nodePortì¸ 31791ë¥¼ LISTENí•˜ëŠ” ê±´ì´ ì—†ìŒ</span>
      
  <span class="c">## (ì°¸ê³ ) ì•„ë˜ì²˜ëŸ¼ ì˜ˆì „ k8s í™˜ê²½ì—ì„œ Service(NodePort) ìƒì„± ì‹œ, TCP Port Listen ë˜ì—ˆì—ˆìŒ</span>
  <span class="c"># $ root@k8s-m:~# ss -4tlnp | egrep "(Process|$NPORT)"</span>
  <span class="c"># State     Recv-Q    Send-Q        Local Address:Port        Peer Address:Port   Process</span>
  <span class="c"># LISTEN    0         4096                0.0.0.0:30466            0.0.0.0:*       users:(("kube-proxy",pid=8661,fd=10))</span>
      
  <span class="c"># íŒŒë“œ ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸ (ì›¹ íŒŒë“œì— ì ‘ì†ìì˜ IPê°€ ì¶œë ¥)</span>
  <span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>deploy-websrv <span class="nt">-f</span>
  <span class="c"># =&gt; Listening on ports 8080 for http, and 8443 for https.</span>
  <span class="c">#    ...</span>
  <span class="c">#    ::ffff:172.23.0.2 - - [26/Sep/2024:04:35:00 +0000] "GET / HTTP/1.1" 200 396 "-" "curl/7.88.1"</span>
  <span class="c">#    ...</span>
      
  <span class="c"># ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸(mypc ì»¨í…Œì´ë„ˆ)ì—ì„œ ì ‘ì† ì‹œë„ë¥¼ í•´ë³´ì</span>
      
  <span class="c"># ë…¸ë“œì˜ IPì™€ NodePortë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
  <span class="c">## CNODE=&lt;ì»¨íŠ¸ë¡¤í”Œë ˆì¸ë…¸ë“œì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE1=&lt;ë…¸ë“œ1ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE2=&lt;ë…¸ë“œ2ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE3=&lt;ë…¸ë“œ3ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="nv">$ CNODE</span><span class="o">=</span>172.23.0.2
  <span class="nv">$ NODE1</span><span class="o">=</span>172.23.0.4
  <span class="nv">$ NODE2</span><span class="o">=</span>172.23.0.5
  <span class="nv">$ NODE3</span><span class="o">=</span>172.23.0.3
      
  <span class="nv">$ NPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NPORT</span>
      
  <span class="c"># ì„œë¹„ìŠ¤(NodePort) ë¶€í•˜ë¶„ì‚° ì ‘ì† í™•ì¸</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nv">$CNODE</span>:<span class="nv">$NPORT</span> | jq <span class="c"># headers.host ì£¼ì†ŒëŠ” ì™œ ê·¸ëŸ°ê±°ì£ ?</span>
  <span class="c"># =&gt; {</span>
  <span class="c">#      "path": "/",</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.2:31791",  &lt;&lt;ì—¬ê¸°ì˜ headers.hostëŠ” ìš”ì²­í•˜ëŠ” urlì˜ ì£¼ì†Œì¸ë°, ìš°ë¦¬ê°€ $CNODE(ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì˜ IP)ì˜ urlë¡œ ì ‘ì†í–ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.&gt;&gt;</span>
  <span class="c">#        "user-agent": "curl/8.7.1",</span>
  <span class="c">#        "accept": "*/*"</span>
  <span class="c">#      },</span>
  <span class="c">#      "method": "GET",</span>
  <span class="c">#      "body": "",</span>
  <span class="c">#      "fresh": false,</span>
  <span class="c">#      "hostname": "172.23.0.2",   &lt;&lt;ì´ hostnameê³¼&gt;&gt;</span>
  <span class="c">#      "ip": "::ffff:172.23.0.2",  &lt;&lt;ì´ ipëŠ” ì ‘ì†í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ipì¸ë° ë¶€í•˜ë¶„ì‚° ê³¼ì •ì—ì„œ ëª©ì ì§€ê°€ Local Podê°€ ì•„ë‹Œ ê²½ìš° Node IPë¡œ POSTROUTING(SNAT) ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.&gt;&gt;</span>
  <span class="c">#      "ips": [],</span>
  <span class="c">#      "protocol": "http",</span>
  <span class="c">#      "query": {},</span>
  <span class="c">#      "subdomains": [],</span>
  <span class="c">#      "xhr": false,</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#      },</span>
  <span class="c">#      "connection": {}</span>
  <span class="c">#    }</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$CNODE</span> <span class="nv">$NODE1</span> <span class="nv">$NODE2</span> <span class="nv">$NODE3</span> <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nv">$i</span>:<span class="nv">$NPORT</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node 172.23.0.2 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.2:31791",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
  <span class="c">#      ...</span>
  <span class="c">#      "hostname": "172.23.0.2",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.2",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-dxf2t" </span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.4 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.4:31791",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
  <span class="c">#      ...</span>
  <span class="c">#      "hostname": "172.23.0.4",</span>
  <span class="c">#      "ip": "::ffff:10.10.4.1",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.5 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.5:31791",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
  <span class="c">#      ...</span>
  <span class="c">#      "hostname": "172.23.0.5",</span>
  <span class="c">#      "ip": "::ffff:10.10.1.1",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.3 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.3:31791",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
  <span class="c">#      ...</span>
  <span class="c">#      "hostname": "172.23.0.3",</span>
  <span class="c">#      "ip": "::ffff:10.10.2.1",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
      
  <span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œì—ëŠ” ëª©ì ì§€ íŒŒë“œê°€ ì—†ëŠ”ë°ë„, ì ‘ì†ì„ ë°›ì•„ì¤ë‹ˆë‹¤! ì´ìœ ëŠ” ì„œë¹„ìŠ¤(nodePort)ì˜ endpointë¡œ ë¡œë“œë°¸ëŸ°ì‹± ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$CNODE</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.2",</span>
  <span class="c">#         37     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#         33     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c">#         30     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$NODE1</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.4",</span>
  <span class="c">#         40     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#         32     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#         28     "hostname": "deploy-echo-5c689d5454-rbgcp"$ docker exec -it mypc zsh -c "for i in {1..100}; do curl -s $NODE2:$NPORT | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$NODE3</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.3",</span>
  <span class="c">#         43     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#         34     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#         23     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c"># ì•„ë˜ ë°˜ë³µ ì ‘ì† ì‹¤í–‰ í•´ë‘ì</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$CNODE</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>
      
  <span class="c"># NodePort ì„œë¹„ìŠ¤ëŠ” ClusterIP ë¥¼ í¬í•¨</span>
  <span class="c"># CLUSTER-IP:PORT ë¡œ ì ‘ì† ê°€ëŠ¥! &lt;- ì»¨íŠ¸ë¡¤ë…¸ë“œì—ì„œ ì•„ë˜ ì‹¤í–‰ í•´ë³´ì</span>
  <span class="nv">$ </span>kubectl get svc svc-nodeport
  <span class="c"># =&gt; NAME           TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
  <span class="c">#    svc-nodeport   NodePort   10.200.1.169   &lt;none&gt;        9000:31791/TCP   51m</span>
      
  <span class="nv">$ CIP</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.clusterIP}"</span><span class="si">)</span>
  <span class="nv">$ CIPPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.ports[0].port}"</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CIP</span> <span class="nv">$CIPPORT</span>
  <span class="c"># =&gt; 10.200.1.169 9000</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane curl <span class="nt">-s</span> <span class="nv">$CIP</span>:<span class="nv">$CIPPORT</span> | jq
  <span class="c"># =&gt; {</span>
  <span class="c">#      "path": "/",</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "10.200.1.169:9000",</span>
  <span class="c">#        "user-agent": "curl/7.88.1",</span>
  <span class="c">#        "accept": "*/*"</span>
  <span class="c">#      },</span>
  <span class="c">#      "method": "GET",</span>
  <span class="c">#      "body": "",</span>
  <span class="c">#      "fresh": false,</span>
  <span class="c">#      "hostname": "10.200.1.169",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.2",</span>
  <span class="c">#      "ips": [],</span>
  <span class="c">#      "protocol": "http",</span>
  <span class="c">#      "query": {},</span>
  <span class="c">#      "subdomains": [],</span>
  <span class="c">#      "xhr": false,</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c">#      },</span>
  <span class="c">#      "connection": {}</span>
  <span class="c">#    }</span>
      
  <span class="c"># mypcì—ì„œ CLUSTER-IP:PORT ë¡œ ì ‘ì† ê°€ëŠ¥í• ê¹Œ?</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nv">$CIP</span>:<span class="nv">$CIPPORT</span>
  <span class="c"># =&gt; (ì—ëŸ¬)</span>
      
  <span class="c"># mypcì—ì„œ cluster ip portë¡œì˜ ì ‘ì†ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. mypcëŠ” kubernetes í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì— ìˆì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</span>
      
  <span class="c"># (ì˜µì…˜) ë…¸ë“œì—ì„œ Network Connection</span>
  <span class="nv">$ </span>conntrack <span class="nt">-E</span>
  <span class="c"># =&gt;     [NEW] tcp      6 120 SYN_SENT src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 [UNREPLIED] src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907</span>
  <span class="c">#     [UPDATE] tcp      6 60 SYN_RECV src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907</span>
  <span class="c">#     [UPDATE] tcp      6 86400 ESTABLISHED src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907 [ASSURED]</span>
  <span class="c">#     [UPDATE] tcp      6 120 FIN_WAIT src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907 [ASSURED]</span>
  <span class="c">#     [UPDATE] tcp      6 30 LAST_ACK src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907 [ASSURED]</span>
  <span class="c">#     [UPDATE] tcp      6 120 TIME_WAIT src=172.23.0.2 dst=10.10.4.4 sport=36907 dport=8080 src=10.10.4.4 dst=172.23.0.2 sport=8080 dport=36907 [ASSURED]</span>
  <span class="c">#      ...</span>
  <span class="c"># SNATë‚˜ ë¹ ë¥¸ iptables ë£° ì²˜ë¦¬ë“±ì„ ìœ„í•´ ì ‘ì† ì •ë³´ê°€ ì¶”ì ë¨ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
      
  <span class="nv">$ </span>conntrack <span class="nt">-L</span> <span class="nt">--any-nat</span>
</code></pre></div>        </div>
      </li>
      <li>íŒŒë“œì—ì„œ ë°”ë¼ë³¸ í´ë¼ì´ì–¸íŠ¸ì˜ ì£¼ì†Œê°€ ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ê°€ ì•„ë‹Œ nodeì˜ ipë¡œ í‘œì‹œë˜ëŠ”ë° ê·¸ ì´ìœ ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.
        <ul>
          <li>
            <p>ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ì„œ iptablesì˜ nat í…Œì´ë¸”ì˜ KUBE-POSTROUTING ë£°ì„ í™•ì¸í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

            <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>iptables <span class="nt">-v</span> <span class="nt">--numeric</span> <span class="nt">--table</span> nat <span class="nt">--list</span> 
  <span class="c"># =&gt; Chain POSTROUTING (policy ACCEPT 5813 packets, 349K bytes)</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination         </span>
  <span class="c">#    37925 2276K KUBE-POSTROUTING  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */</span>
  <span class="c">#    ...</span>
  <span class="c">#    Chain KUBE-POSTROUTING (1 references)</span>
  <span class="c">#     pkts bytes target     prot opt in     out     source               destination</span>
  <span class="c">#     5343  321K RETURN     0    --  *      *       0.0.0.0/0            0.0.0.0/0            mark match ! 0x4000/0x4000</span>
  <span class="c">#     1265 75900 MARK       0    --  *      *       0.0.0.0/0            0.0.0.0/0            MARK xor 0x4000</span>
  <span class="c">#     1265 75900 MASQUERADE  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service traffic requiring SNAT */ random-fully</span>
</code></pre></div>            </div>

            <p>í™•ì¸ ê²°ê³¼ POSTROUTINGì‹œ KUBE-POSTROUTINGì„ í†µí•´ SNAT ë˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          </li>
        </ul>
      </li>
      <li>
        <p>ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë¹„ìŠ¤(NodePort) ì ‘ì† ì‹œ : 3ê°œì˜ ëª©ì ì§€(backend) íŒŒë“œë¡œ <strong>ëœë¤ ë¶€í•˜ ë¶„ì‚°</strong> ì ‘ì†ë¨ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$CNODE</span>:<span class="nv">$NPORT</span> | <span class="nb">grep hostname</span><span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
  <span class="c"># =&gt;    100   "hostname": "172.23.0.2",</span>
  <span class="c">#        42     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#        31     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#        27     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$NODE1</span>:<span class="nv">$NPORT</span> | <span class="nb">grep hostname</span><span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.4",</span>
  <span class="c">#         37     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#         34     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c">#         29     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$NODE2</span>:<span class="nv">$NPORT</span> | <span class="nb">grep hostname</span><span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.5",</span>
  <span class="c">#         41     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#         32     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
  <span class="c">#         27     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$NODE3</span>:<span class="nv">$NPORT</span> | <span class="nb">grep hostname</span><span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.3",</span>
  <span class="c">#         39     "hostname": "deploy-echo-5c689d5454-dxf2t"</span>
  <span class="c">#         34     "hostname": "deploy-echo-5c689d5454-wppr8"</span>
  <span class="c">#         27     "hostname": "deploy-echo-5c689d5454-rbgcp"</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì›¹ íŒŒë“œì—ì„œ  logë¥¼ í†µí•´ ì ‘ì†ìì˜ IP í™•ì¸ì‹œ ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ IPê°€ ì•„ë‹Œ, ë…¸ë“œì˜ IPë¡œ SNAT ë˜ì–´ì„œ ì ‘ì†ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>kubectl logs <span class="nt">-f</span> deploy-echo-5c689d5454-dxf2t | <span class="nb">grep </span>HTTP
  <span class="c"># =&gt; ::ffff:172.23.0.3 - - [01/Sep/2024:05:28:36 +0000] "GET / HTTP/1.1" 200 398 "-" "curl/7.88.1"</span>
  <span class="c">#    ::ffff:172.23.0.3 - - [01/Sep/2024:05:28:36 +0000] "GET / HTTP/1.1" 200 398 "-" "curl/7.88.1"</span>
  <span class="c">#    ::ffff:172.23.0.3 - - [01/Sep/2024:05:28:36 +0000] "GET / HTTP/1.1" 200 398 "-" "curl/7.88.1"</span>
  <span class="c">#    ::ffff:172.23.0.3 - - [01/Sep/2024:05:28:36 +0000] "GET / HTTP/1.1" 200 398 "-" "curl/7.88.1"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>2.4.  IPTABLES ì •ì±… í™•ì¸
    <ul>
      <li>
        <p>iptables ì •ì±… ì ìš© ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_25.png" alt="img.png" loading="lazy" width="829" height="245"></p>

        <ul>
          <li>PREROUTING â†’ KUBE-SERVICES â†’ KUBE-NODEPORTS â†’ <strong>KUBE-EXT-#(MARK)</strong> â†’ KUBE-SVC-# â†’ KUBE-SEP-#  â‡’ KUBE-POSTROUTING (MASQUERADE) <strong>**</strong>
</li>
          <li>
<code class="language-plaintext highlighter-rouge">KUBE-EXT-#(MARK)</code> ê·œì¹™ ê³¼ì •ì´ ì¶”ê°€ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ê¸°ë³¸ ê·œì¹™ì€ ClusterIP ì„œë¹„ìŠ¤ ë™ì‘ ê·œì¹™ê³¼ ê±°ì˜ ê°™ìœ¼ë©° ì°¨ì´ì ì€ KUBE-NODEPORTS, KUBE-MARK-MASK, KUBE-POSTROUTING ì²´ì¸ì´  ë‹¤ë¦…ë‹ˆë‹¤. í•µì‹¬ ë‚´ìš©ì€ NodePortì— ë§¤ì¹­ì‹œ ë§ˆí‚¹ í›„ ì¶œë°œì§€ IPë¥¼ í•´ë‹¹ ë…¸ë“œì— ìˆëŠ” ë„¤íŠ¸ì›Œí¬ IPë¡œ ë³€í™˜(MASQUERADE : SNAT)í•˜ì—¬ ëª©ì ì§€ íŒŒë“œë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.</li>
      <li>
        <p>ì‹¤ìŠµì„ í†µí•´ iptables ì •ì±…ì— ëŒ€í•´ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.  ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ ì‹¤ìŠµì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane bash
  <span class="nt">----------------------------------------</span>
      
  <span class="c"># íŒ¨í‚· ì¹´ìš´íŠ¸ ì´ˆê¸°í™”</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">--zero</span>
      
  <span class="c"># PREROUTING ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>PREROUTING
  <span class="c"># =&gt; -P PREROUTING ACCEPT</span>
  <span class="c">#    -A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES</span>
  <span class="c">#    -A PREROUTING -d 172.23.0.1/32 -j DOCKER_OUTPUT</span>
      
  <span class="c"># ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ê°€ ë…¸ë“œIP:NodePort ë¡œ ì ‘ì†í•˜ê¸° ë•Œë¬¸ì— --dst-type LOCAL ì— ë§¤ì¹­ë˜ì–´ì„œ -j KUBE-NODEPORTS ë¡œ ì í”„!</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>KUBE-SERVICES
  <span class="c"># =&gt; ...</span>
  <span class="c">#    -A KUBE-SERVICES -m comment --comment "kubernetes service nodeports; NOTE: this must be the last rule in this chain" -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS</span>
      
  <span class="c"># KUBE-NODEPORTS ì—ì„œ KUBE-EXT-# ë¡œ ì í”„!</span>
  <span class="c">## -m nfacct --nfacct-name localhost_nps_accepted_pkts ì¶”ê°€ë¨ : íŒ¨í‚· flow ì¹´ìš´íŒ… - ì¹´ìš´íŠ¸ ì´ë¦„ ì§€ì • </span>
  <span class="nv">$ NPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NPORT</span>
  <span class="c"># =&gt; 31791</span>
      
  <span class="c"># $ iptables -t nat -S | grep KUBE-NODEPORTS | grep &lt;NodePort&gt;</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>KUBE-NODEPORTS | <span class="nb">grep</span> <span class="nv">$NPORT</span>
  <span class="c"># =&gt; -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
      
  <span class="c"># (ì°¸ê³ ) nfacct í™•ì¸</span>
  <span class="nv">$ </span>nfacct list
  <span class="c">## nfacct flush # ì´ˆê¸°í™”</span>
      
  <span class="c">## KUBE-EXT-# ì—ì„œ 'KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000' ë§ˆí‚¹ ë° KUBE-SVC-# ë¡œ ì í”„!</span>
  <span class="c"># docker exec -it mypc zsh -c "while true; do curl -s --connect-timeout 1 $CNODE:$NPORT | grep hostname; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done" ë°˜ë³µ ì ‘ì† í›„ ì•„ë˜ í™•ì¸</span>
  <span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -v --numeric --table nat --list KUBE-EXT-VTR7MTHHNMFZ3OFS'</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s2">"A KUBE-EXT-VTR7MTHHNMFZ3OFS"</span>
  <span class="c"># =&gt; -A KUBE-EXT-VTR7MTHHNMFZ3OFS -m comment --comment "masquerade traffic for default/svc-nodeport:svc-webport external destinations" -j KUBE-MARK-MASQ</span>
  <span class="c">#    -A KUBE-EXT-VTR7MTHHNMFZ3OFS -j KUBE-SVC-VTR7MTHHNMFZ3OFS</span>
      
  <span class="c"># iptables -t nat -S | grep "A KUBE-MARK-MASQ" | sed -e 's/^/#    /' -e '1s/^#    /# =&gt; /'</span>
  <span class="c"># =&gt; -A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000        # 0x4000/0x4000ìœ¼ë¡œ ë§ˆí‚¹í•˜ëŠ” ë£°</span>
      
  <span class="c"># KUBE-SVC-# ì´í›„ ê³¼ì •ì€ Cluster-IP ì™€ ë™ì¼! : 3ê°œì˜ íŒŒë“œë¡œ DNAT ë˜ì–´ì„œ ì „ë‹¬</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s2">"A KUBE-SVC-VTR7MTHHNMFZ3OFS -"</span>
  <span class="c"># =&gt; -A KUBE-SVC-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.1.5:8080" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-SESYGQFRQSLJQZ6Q</span>
  <span class="c">#    -A KUBE-SVC-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.2.7:8080" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-FBJG45W6XHLV2NA6</span>
  <span class="c">#    -A KUBE-SVC-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.4.4:8080" -j KUBE-SEP-GEQNJ6BO5AOHB6LH</span>
      
  <span class="c"># POSTROUTING ì •ë³´ í™•ì¸</span>
  <span class="c"># ë§ˆí‚¹ë˜ì–´ ìˆì–´ì„œ ì¶œë°œì§€IPë¥¼ ì ‘ì†í•œ ë…¸ë“œì˜ IP ë¡œ SNAT(MASQUERADE) ì²˜ë¦¬í•¨! , ìµœì´ˆ ì¶œë°œì§€PortëŠ” ëœë¤Port ë¡œ ë³€ê²½</span>
  <span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s2">"A KUBE-POSTROUTING"</span>
  <span class="c"># =&gt; -A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN   # 0x4000/0x4000 ë˜ì–´ ìˆìœ¼ë‹ˆ ì—¬ê¸°ì— ë§¤ì¹­ë˜ì§€ ì•Šê³  ì•„ë˜ Ruleë¡œ ë‚´ë ¤ê°</span>
  <span class="c">#    -A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0</span>
  <span class="c">#    -A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -j MASQUERADE --random-fully</span>
      
  <span class="c"># docker exec -it mypc zsh -c "while true; do curl -s --connect-timeout 1 $CNODE:$NPORT | grep hostname; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done" ë°˜ë³µ ì ‘ì† í›„ ì•„ë˜ í™•ì¸</span>
  <span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'iptables -v --numeric --table nat --list KUBE-POSTROUTING;echo;iptables -v --numeric --table nat --list POSTROUTING'</span>
      
  <span class="nv">$ </span><span class="nb">exit</span>
  <span class="nt">----------------------------------------</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì„œë¹„ìŠ¤ (NodePort) ìƒì„± ì‹œ kube-proxyì— ì˜í•´ì„œ iptables ê·œì¹™ì´ ëª¨ë“  ë…¸ë“œì— ì¶”ê°€ë˜ëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c">#</span>
  <span class="nv">$ NPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NPORT</span> 
  <span class="c"># =&gt; 31791</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>KUBE-NODEPORTS | <span class="nb">grep</span> <span class="nv">$NPORT</span>
  <span class="c"># =&gt; -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>KUBE-NODEPORTS | <span class="nb">grep</span> <span class="nv">$NPORT</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
  <span class="c">#    -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
  <span class="c">#    -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
  <span class="c">#    -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
  <span class="c">#    -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31791 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
</code></pre></div>        </div>
      </li>
      <li>iptables ë£°ì´ ëª¨ë“  ë…¸ë“œì— ì¶”ê°€ë˜ì–´ìˆìŒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>2.5. externalTrafficPolicy  ì„¤ì •
    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> : ì•ì—ì„œ ì‹¤ìŠµí•œ ë°”ì™€ê°™ì´ ì„œë¹„ìŠ¤ê°€ ë°”ë¼ë³´ëŠ” íŒŒë“œì— ì ‘ì†ì‹œ í´ë¼ì´ì–¸íŠ¸ IPê°€ nodeì˜ IPë¡œ ì ‘ì†ë©ë‹ˆë‹¤. ì´ë•Œ <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> ë¥¼ í•˜ë©´ <strong>í•´ë‹¹ ë…¸ë“œì— ë°°ì¹˜ëœ íŒŒë“œë¡œë§Œ ì ‘ì†ë˜ë©´ì„œ</strong>, SNATê°€ ë˜ì§€ì•Šì•„ <strong>ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ IPê°€ ë³´ì¡´</strong>ë©ë‹ˆë‹¤.</p>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_26.png" alt="img.png" loading="lazy" width="955" height="354"></p>

        <ul>
          <li>ì´ì „ê¹Œì§€ëŠ” ê°™ì€ iptables ë£°ì´ ëª¨ë“  ë…¸ë“œì— ì ìš© ë˜ì—ˆì§€ë§Œ, ë…¸ë“œ ìì‹ ì˜ íŒŒë“œë¡œë§Œ ê°€ëŠ” ë£°ë§Œ ìˆì–´ì„œ ê°ê° ì¡°ê¸ˆì”© ë‹¤ë¥¸ ë£°ì´ ì ìš©ë˜ê²Œ ë©ë‹ˆë‹¤.</li>
        </ul>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_27.png" alt="img.png" loading="lazy" width="952" height="356"></p>

        <ul>
          <li>ë§Œì•½ ë…¸ë“œì— í•´ë‹¹í•˜ëŠ” íŒŒë“œê°€ ì—†ìœ¼ë©´ ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ ì—°ê²°ì´ ì‹¤íŒ¨í•˜ê²Œë˜ë‹ˆ ì‚¬ìš©ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> ì„¤ì • ì‹œì˜ í†µì‹  íë¦„ì„ ì¢€ ë” ìì„¸íˆ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_28.png" alt="img.png" loading="lazy" width="722" height="180"></p>

        <ul>
          <li>í´ë¼ì´ì–¸íŠ¸ì—ì„œ íŒŒë“œê°€ ë°°í¬ë˜ì–´ìˆëŠ” ì›Œì»¤ë…¸ë“œ1ì— NodePortë¡œ ì ‘ì†í•©ë‹ˆë‹¤.</li>
          <li>ì›Œì»¤ë…¸ë“œ1ì˜ IPTABLESì˜ nat í…Œì´ë¸” ê·œì¹™ê³¼ ë§¤ì¹­ë˜ì–´ ëª©ì ì§€ IPì™€ ëª©ì ì§€ PortëŠ” ë³€í™˜ ë˜ì§€ë§Œ, SNAT ë˜ì§€ ì•Šê³  ë°”ë¡œ íŒŒë“œë¡œ ì „ë‹¬ë˜ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ì˜ IPê°€ íŒŒë“œì— ê·¸ëŒ€ë¡œ ì „ë‹¬ ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>
        <p>ì„¤ì • ë° íŒŒë“œ ì ‘ì† í™•ì¸</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># ê¸°ë³¸ ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>kubectl get svc svc-nodeport <span class="nt">-o</span> json | <span class="nb">grep</span> <span class="s1">'TrafficPolicy"'</span>
  <span class="c"># =&gt;         "externalTrafficPolicy": "Cluster",</span>
  <span class="c">#            "internalTrafficPolicy": "Cluster",</span>
      
  <span class="c"># ê¸°ì¡´ í†µì‹  ì—°ê²° ì •ë³´(conntrack) ì œê±° í›„ ì•„ë˜ ì‹¤ìŠµ ì§„í–‰í•˜ì! : (ëª¨ë“  ë…¸ë“œì—ì„œ) conntrack -F</span>
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> conntrack <span class="nt">-F</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
  <span class="c">#    conntrack v1.4.7 (conntrack-tools): connection tracking table has been emptied.</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
  <span class="c">#    conntrack v1.4.7 (conntrack-tools): connection tracking table has been emptied.</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
  <span class="c">#    conntrack v1.4.7 (conntrack-tools): connection tracking table has been emptied.</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
  <span class="c">#    conntrack v1.4.7 (conntrack-tools): connection tracking table has been emptied.</span>
  <span class="c">#    </span>
  <span class="nv">$ </span>kubectl delete <span class="nt">-f</span> svc-nodeport.yml
  <span class="c"># =&gt; service "svc-nodeport" deleted</span>
  <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> svc-nodeport.yml
  <span class="c"># =&gt; service/svc-nodeport created</span>
      
  <span class="c"># externalTrafficPolicy: local ì„¤ì • ë³€ê²½</span>
  <span class="nv">$ </span>kubectl patch svc svc-nodeport <span class="nt">-p</span> <span class="s1">'{"spec":{"externalTrafficPolicy": "Local"}}'</span>
  <span class="c"># =&gt; service/svc-nodeport patched</span>
  <span class="nv">$ </span>kubectl get svc svc-nodeport <span class="nt">-o</span> json | <span class="nb">grep</span> <span class="s1">'TrafficPolicy"'</span>
  <span class="c"># =&gt;         "externalTrafficPolicy": "Local",</span>
  <span class="c">#            "internalTrafficPolicy": "Cluster",</span>
      
  <span class="c"># íŒŒë“œ 3ê°œë¥¼ 2ê°œë¡œ ì¤„ì…ë‹ˆë‹¤.</span>
  <span class="nv">$ </span>kubectl scale deployment deploy-echo <span class="nt">--replicas</span><span class="o">=</span>2
  <span class="c"># =&gt; deployment.apps/deploy-echo scaled</span>
</code></pre></div>        </div>

        <p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_29.png" alt="img.png" loading="lazy" width="719" height="277"></p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># íŒŒë“œ ì¡´ì¬í•˜ëŠ” ë…¸ë“œ ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
  <span class="c"># =&gt; NAME                           READY   STATUS    RESTARTS   AGE   IP          NODE                  NOMINATED NODE   READINESS GATES</span>
  <span class="c">#    deploy-echo-5c689d5454-24cql   1/1     Running   0          30s   10.10.4.5   myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    deploy-echo-5c689d5454-2kgfj   1/1     Running   0          30s   10.10.1.6   myk8s-worker2         &lt;none&gt;           &lt;none&gt;</span>
  <span class="c">#    net-pod                        1/1     Running   0          46h   10.10.0.7   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
      
  <span class="c"># íŒŒë“œ ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸ (ì›¹ íŒŒë“œì— ì ‘ì†ìì˜ IPê°€ ì¶œë ¥)</span>
  <span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>deploy-websrv <span class="nt">-f</span>
      
  <span class="c"># ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸(mypc)ì—ì„œ ì ‘ì† ì‹œë„</span>
      
  <span class="c"># ë…¸ë“œì˜ IPì™€ NodePortë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
  <span class="c">## CNODE=&lt;ì»¨íŠ¸ë¡¤í”Œë ˆì¸ë…¸ë“œì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE1=&lt;ë…¸ë“œ1ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE2=&lt;ë…¸ë“œ2ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="c">## NODE3=&lt;ë…¸ë“œ3ì˜ IPì£¼ì†Œ&gt;</span>
  <span class="nv">$ CNODE</span><span class="o">=</span>172.23.0.2
  <span class="nv">$ NODE1</span><span class="o">=</span>172.23.0.4
  <span class="nv">$ NODE2</span><span class="o">=</span>172.23.0.5
  <span class="nv">$ NODE3</span><span class="o">=</span>172.23.0.3
      
  <span class="c">## NodePort ë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
  <span class="nv">$ NPORT</span><span class="o">=</span><span class="si">$(</span>kubectl get service svc-nodeport <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[0].nodePort}'</span><span class="si">)</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NPORT</span>
  <span class="c"># =&gt; 31177</span>
      
  <span class="c"># ì„œë¹„ìŠ¤(NodePort) ë¶€í•˜ë¶„ì‚° ì ‘ì† í™•ì¸ : íŒŒë“œê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë…¸ë“œë¡œëŠ” ì ‘ì† ì‹¤íŒ¨!, íŒŒë“œê°€ ì¡´ì¬í•˜ëŠ” ë…¸ë“œëŠ” ì ‘ì† ì„±ê³µ ë° í´ë¼ì´ì–¸íŠ¸ IP í™•ì¸!</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$CNODE</span>:<span class="nv">$NPORT</span> | jq
  <span class="c"># =&gt; (ê³µë°±)</span>
  <span class="c"># ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ëŠ” íŒŒë“œê°€ ì—†ìœ¼ë¯€ë¡œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
      
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$CNODE</span> <span class="nv">$NODE1</span> <span class="nv">$NODE2</span> <span class="nv">$NODE3</span> <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> mypc curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$i</span>:<span class="nv">$NPORT</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node 172.23.0.2 &lt;&lt;</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node 172.23.0.4 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "path": "/",</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.4:31177",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
  <span class="c">#      ...</span>
  <span class="c">#      "hostname": "172.23.0.4",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.6",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-24cql"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.5 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.5:31177",</span>
  <span class="c">#        ...</span>
  <span class="c">#      },</span>
      
  <span class="c">#      "hostname": "172.23.0.5",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.6",</span>
  <span class="c">#      ...</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-2kgfj"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.3 &lt;&lt;</span>
  <span class="c">#    </span>
      
  <span class="c"># ëª©ì ì§€ íŒŒë“œê°€ ë°°ì¹˜ë˜ì§€ ì•Šì€ ë…¸ë“œëŠ” ì ‘ì†ì´ ì–´ë–»ê²Œ? ì™œ ê·¸ëŸ°ê°€?</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$CNODE</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt; </span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$NODE1</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.4",</span>
  <span class="c">#        100     "hostname": "deploy-echo-5c689d5454-24cql"</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$NODE2</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt;     100   "hostname": "172.23.0.5",</span>
  <span class="c">#        100     "hostname": "deploy-echo-5c689d5454-2kgfj"</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"for i in {1..100}; do curl -s </span><span class="nv">$NODE3</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; done | sort | uniq -c | sort -nr"</span>
  <span class="c"># =&gt; </span>
  <span class="c"># ëª©ì ì§€ íŒŒë“œê°€ ë°°ì¹˜ë˜ì§€ ì•Šì€ ë…¸ë“œëŠ” ì‘ë‹µì´ ì—†ì–´ íƒ€ì„ì•„ì›ƒì´ ë©ë‹ˆë‹¤. ê·¸ ì´ìœ ëŠ” externalTrafficPolicy: Localì—¬ì„œ ë…¸ë“œí¬íŠ¸ë¡œ ì˜¨ íŒ¨í‚·ì´, local podë¡œ ì „ë‹¬í•˜ë ¤ê³  í•˜ëŠ”ë°</span>
  <span class="c"># local podê°€ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</span>
      
  <span class="c"># ì•„ë˜ ë°˜ë³µ ì ‘ì† ì‹¤í–‰ í•´ë‘ì</span>
  <span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> mypc zsh <span class="nt">-c</span> <span class="s2">"while true; do curl -s --connect-timeout 1 </span><span class="nv">$NODE2</span><span class="s2">:</span><span class="nv">$NPORT</span><span class="s2"> | grep hostname; date '+%Y-%m-%d %H:%M:%S' ; echo ;  sleep 1; done"</span>
      
  <span class="c"># (ì˜µì…˜) ë…¸ë“œì—ì„œ Network Connection</span>
  <span class="nv">$ </span>conntrack <span class="nt">-E</span>
  <span class="nv">$ </span>conntrack <span class="nt">-L</span> <span class="nt">--any-nat</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ â†’ ê°ê° ì›Œì»¤ ë…¸ë“œ 1,2 ì ‘ì†ì‹œ ê°ê° ë…¸ë“œì˜ íŒŒë“œë¡œë§Œ ì ‘ì† ë©ë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># í˜¸ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰</span>
  <span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$CNODE</span> <span class="nv">$NODE1</span> <span class="nv">$NODE2</span> <span class="nv">$NODE3</span> <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$i</span>:<span class="nv">$NPORT</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  <span class="c"># =&gt; &gt;&gt; node 172.23.0.2 &lt;&lt;</span>
  <span class="c">#    </span>
  <span class="c">#    &gt;&gt; node 172.23.0.4 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.4:31177",</span>
  <span class="c">#      },</span>
  <span class="c">#      "hostname": "172.23.0.4",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.1",</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-24cql"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.5 &lt;&lt;</span>
  <span class="c">#    {</span>
  <span class="c">#      "headers": {</span>
  <span class="c">#        "host": "172.23.0.5:31177",</span>
  <span class="c">#      },</span>
  <span class="c">#      "hostname": "172.23.0.5",</span>
  <span class="c">#      "ip": "::ffff:172.23.0.1",</span>
  <span class="c">#      "os": {</span>
  <span class="c">#        "hostname": "deploy-echo-5c689d5454-2kgfj"</span>
  <span class="c">#      }</span>
  <span class="c">#    }</span>
  <span class="c">#    &gt;&gt; node 172.23.0.3 &lt;&lt;    </span>
    
  <span class="c"># ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ë¡œê·¸ í‘œì‹œ</span>
  <span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>deploy-websrv <span class="nt">-f</span> | <span class="nb">grep </span>HTTP
  ::ffff:172.23.0.1 - - <span class="o">[</span>26/Sep/2024:07:33:09 +0000] <span class="s2">"GET / HTTP/1.1"</span> 200 397 <span class="s2">"-"</span> <span class="s2">"curl/8.7.1"</span>
  ::ffff:172.23.0.1 - - <span class="o">[</span>26/Sep/2024:07:33:10 +0000] <span class="s2">"GET / HTTP/1.1"</span> 200 397 <span class="s2">"-"</span> <span class="s2">"curl/8.7.1"</span>
  ::ffff:172.23.0.1 - - <span class="o">[</span>26/Sep/2024:07:33:26 +0000] <span class="s2">"GET / HTTP/1.1"</span> 200 397 <span class="s2">"-"</span> <span class="s2">"curl/8.7.1"</span>
  ::ffff:172.23.0.1 - - <span class="o">[</span>26/Sep/2024:07:33:26 +0000] <span class="s2">"GET / HTTP/1.1"</span> 200 397 <span class="s2">"-"</span> <span class="s2">"curl/8.7.1"</span>
</code></pre></div>        </div>
        <ul>
          <li>
<code class="language-plaintext highlighter-rouge">kubectl logs -l app=deploy-websrv -f</code>ë¡œ í™•ì¸ì‹œ ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ì¸ 172.23.0.1ì´ ë³´ì¡´ë˜ëŠ” ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ì´ë ‡ê²Œ ë™ì‘í•˜ëŠ” ì´ìœ ë¥¼ iptables ë£°ì„ í†µí•´ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œ - iptables ë¶„ì„ &lt;&lt; ì •ì±… í™•ì¸ : ì•„ë˜ ì •ì±… ë‚´ìš©ì€ í•µì‹¬ì ì¸ ë£°(rule)ë§Œ í‘œì‹œí–ˆìŠµë‹ˆë‹¤!</span>
<span class="c"># (ì˜ˆì‹œ) íŒŒë“œê°€ ë°°í¬ë˜ì–´ ìˆëŠ” ë…¸ë“œ1ì—ì„œ í™•ì¸í–ˆìŠµë‹ˆë‹¤</span>
    
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-worker bash
<span class="nt">---------------------------------------</span>
    
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="c"># $ iptables -t nat -S | grep &lt;NodePort&gt;</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep </span>31177
<span class="c"># =&gt; -A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31177 -j KUBE-EXT-VTR7MTHHNMFZ3OFS</span>
    
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A KUBE-EXT-VTR7MTHHNMFZ3OFS'</span>
<span class="c"># =&gt; -A KUBE-EXT-VTR7MTHHNMFZ3OFS -s 10.10.0.0/16 -m comment --comment "pod traffic for default/svc-nodeport:svc-webport external destinations" -j KUBE-SVC-VTR7MTHHNMFZ3OFS</span>
<span class="c">#    -A KUBE-EXT-VTR7MTHHNMFZ3OFS -m comment --comment "masquerade LOCAL traffic for default/svc-nodeport:svc-webport external destinations" -m addrtype --src-type LOCAL -j KUBE-MARK-MASQ</span>
<span class="c">#    -A KUBE-EXT-VTR7MTHHNMFZ3OFS -m comment --comment "route LOCAL traffic for default/svc-nodeport:svc-webport external destinations" -m addrtype --src-type LOCAL -j KUBE-SVC-VTR7MTHHNMFZ3OFS</span>
<span class="c">#    -A KUBE-EXT-VTR7MTHHNMFZ3OFS -j KUBE-SVL-VTR7MTHHNMFZ3OFS</span>
    
<span class="c"># ì‹¤ìŠµ í™˜ê²½ì—ì„œëŠ” ì•„ë˜ì²˜ëŸ¼ 2ê°œì˜ íŒŒë“œ ì¤‘ ìì‹ ì˜ ë…¸ë“œì— ìƒì„±ëœ íŒŒë“œ 1ê°œë§Œ DNAT ì—°ê²°ë¨</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A KUBE-SVL-VTR7MTHHNMFZ3OFS'</span>
<span class="c"># =&gt; -A KUBE-SVL-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.4.5:8080" -j KUBE-SEP-COBCKEECYTEF2ZXK</span>
    
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A KUBE-SEP-COBCKEECYTEF2ZXK'</span>
<span class="c"># =&gt; -A KUBE-SEP-COBCKEECYTEF2ZXK -s 10.10.4.5/32 -m comment --comment "default/svc-nodeport:svc-webport" -j KUBE-MARK-MASQ</span>
<span class="c">#    -A KUBE-SEP-COBCKEECYTEF2ZXK -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp -j DNAT --to-destination 10.10.4.5:8080</span>
    
<span class="nv">$ </span><span class="nb">exit</span>
<span class="c"># ---------------------------------------</span>
</code></pre></div>        </div>
        <ul>
          <li>ì •ì±…ì„ í™•ì¸í•´ë³´ë©´ <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> ì„¤ì • ì „ì—ëŠ” MASQUERADEë¡œ SNAT ë˜ì—ˆì§€ë§Œ, ì„¤ì • í›„ì—ëŠ” DNATìœ¼ë¡œ ë°”ë¡œ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>SNAT ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— í´ë¼ì´ì–¸íŠ¸ì˜ IPê°€ ê·¸ëŒ€ë¡œ ì „ë‹¬ë˜ì–´ íŒŒë“œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ì„œë¹„ìŠ¤(NodePort, externalTrafficPolicy: Local) ìƒì„± ì‹œ iptables ê·œì¹™(KUBE-SVL-#)ì´ ëª¨ë“  ë…¸ë“œì— ì¶”ê°€ë˜ëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ëŠ” íŒŒë“œê°€ ì—†ìœ¼ë¯€ë¡œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A KUBE-SVL-VTR7MTHHNMFZ3OFS'</span>
<span class="c"># =&gt; (ê³µë°±)</span>
    
<span class="c"># ê° ë…¸ë“œì— í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>control-plane worker worker2 worker3<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node myk8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-<span class="nv">$i</span> iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A KUBE-SVL-VTR7MTHHNMFZ3OFS'</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node myk8s-control-plane &lt;&lt;</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker &lt;&lt;</span>
<span class="c">#    -A KUBE-SVL-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.4.5:8080" -j KUBE-SEP-COBCKEECYTEF2ZXK</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker2 &lt;&lt;</span>
<span class="c">#    -A KUBE-SVL-VTR7MTHHNMFZ3OFS -m comment --comment "default/svc-nodeport:svc-webport -&gt; 10.10.1.6:8080" -j KUBE-SEP-ABUS75FNO53OAK6G</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node myk8s-worker3 &lt;&lt;</span>
</code></pre></div>        </div>
        <ul>
          <li>íŒŒë“œê°€ ìˆëŠ” worker, worker2 ë…¸ë“œì—ë§Œ iptables ê·œì¹™ì´ ì¶”ê°€ë˜ì–´ ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>NodePortì˜ ë¶€ì¡±í•œ ì 
        <ul>
          <li>ì™¸ë¶€ì—ì„œ ë…¸ë“œì˜ IPì™€ í¬íŠ¸ë¡œ ì§ì ‘ ì ‘ì†ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
          <li>ë”°ë¼ì„œ ë‚´ë¶€ë§ì´ ì™¸ë¶€ì— ê³µê°œ(ë¼ìš°íŒ… ê°€ëŠ¥)ë˜ì–´ ë³´ì•ˆì— ì·¨ì•½í•©ë‹ˆë‹¤.
            <ul>
              <li>=&gt; <strong>LoadBalancer ì„œë¹„ìŠ¤</strong> íƒ€ì…ìœ¼ë¡œ ì™¸ë¶€ ê³µê°œ ìµœì†Œí™” ê°€ëŠ¥</li>
            </ul>
          </li>
          <li>í´ë¼ì´ì–¸íŠ¸ IP ë³´ì¡´ì„ ìœ„í•´ì„œ, <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: local</code>ë¥¼ ì‚¬ìš©í•˜ë©´ íŒŒë“œê°€ ì—†ëŠ” ë…¸ë“œ IPë¡œ NodePort ì ‘ì† ì‹œ ì‹¤íŒ¨í•˜ê²Œ ë©ë‹ˆë‹¤.
            <ul>
              <li>=&gt; <strong>LoadBalancer ì„œë¹„ìŠ¤</strong>ì—ì„œ í—¬ìŠ¤ì²´í¬(Probe) ë¡œ ëŒ€ì‘ ê°€ëŠ¥</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="íŒŒë“œê°„-ì†ë„-ì¸¡ì •">íŒŒë“œê°„ ì†ë„ ì¸¡ì •</h4>

<ul>
  <li>ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” iperf3ë¥¼ ì‚¬ìš©í•´ì„œ íŒŒë“œê°„ ì†ë„ë¥¼ ì¸¡ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>iperf3ëŠ” ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ì„ ì¸¡ì •í•˜ëŠ” ë„êµ¬ë¡œ, ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ë¡œ ë‚˜ë‰˜ì–´ ì„œë²„ëŠ” ëŒ€ì—­í­ì„ ì œê³µí•˜ê³  í´ë¼ì´ì–¸íŠ¸ëŠ” ëŒ€ì—­í­ì„ ì¸¡ì •í•©ë‹ˆë‹¤. TCPì™€ UDP, SCTPë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
  <li>iperf3ì˜ ê¸°ë³¸ ì‚¬ìš©ë²•ì„ ì‚´í´ ë³´ê² ìŠµë‹ˆë‹¤.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># iperf3 ì„¤ì¹˜ </span>
<span class="c"># macOS ì¸ ê²½ìš°</span>
<span class="nv">$ </span>brew <span class="nb">install </span>iperf3
<span class="c"># ubuntu ë“± debian ê³„ì—´ì¸ ê²½ìš° </span>
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>iperf3 <span class="nt">-y</span>
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 1 : TCP 5201, ì¸¡ì •ì‹œê°„ 10ì´ˆ</span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> <span class="c"># ì„œë²„ëª¨ë“œ ì‹¤í–‰</span>
<span class="c"># =&gt; -----------------------------------------------------------</span>
<span class="c">#    Server listening on 5201</span>
<span class="c">#    -----------------------------------------------------------</span>
<span class="c">#    Accepted connection from 127.0.0.1, port 40142</span>
<span class="c">#    [  5] local 127.0.0.1 port 5201 connected to 127.0.0.1 port 40154</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-1.00   sec  7.11 GBytes  61.1 Gbits/sec</span>
<span class="c">#    [  5]   1.00-2.00   sec  8.03 GBytes  68.9 Gbits/sec</span>
<span class="c">#    [  5]   2.00-3.00   sec  7.53 GBytes  64.7 Gbits/sec</span>
<span class="c">#    [  5]   3.00-4.00   sec  7.73 GBytes  66.4 Gbits/sec</span>
<span class="c">#    [  5]   4.00-5.00   sec  7.64 GBytes  65.6 Gbits/sec</span>
<span class="c">#    [  5]   5.00-6.00   sec  7.89 GBytes  67.8 Gbits/sec</span>
<span class="c">#    [  5]   6.00-7.00   sec  7.95 GBytes  68.3 Gbits/sec</span>
<span class="c">#    [  5]   7.00-8.00   sec  7.78 GBytes  66.9 Gbits/sec</span>
<span class="c">#    [  5]   8.00-9.00   sec  7.91 GBytes  67.9 Gbits/sec</span>
<span class="c">#    [  5]   9.00-10.00  sec  7.64 GBytes  65.6 Gbits/sec</span>
<span class="c">#    [  5]  10.00-10.05  sec   384 MBytes  66.0 Gbits/sec</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-10.05  sec  77.6 GBytes  66.3 Gbits/sec                  receiver</span>
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="c"># ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ëª¨ë“œ ì‹¤í–‰</span>
<span class="c"># =&gt; Connecting to host 127.0.0.1, port 5201</span>
<span class="c">#    [  5] local 127.0.0.1 port 40154 connected to 127.0.0.1 port 5201</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5]   0.00-1.00   sec  7.48 GBytes  64.2 Gbits/sec    8   2.69 MBytes</span>
<span class="c">#    ...</span>
<span class="c">#    [  5]   9.00-10.00  sec  7.72 GBytes  66.3 Gbits/sec    1   3.06 MBytes</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5]   0.00-10.00  sec  77.6 GBytes  66.6 Gbits/sec   53             sender</span>
<span class="c">#    [  5]   0.00-10.05  sec  77.6 GBytes  66.3 Gbits/sec                  receiver</span>
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 2 : TCP 80, ì¸¡ì •ì‹œê°„ 5ì´ˆ</span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> <span class="nt">-p</span> 80
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="nt">-p</span> 80 <span class="nt">-t</span> 5
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 3 : UDP ì‚¬ìš©, ì—­ë°©í–¥ ëª¨ë“œ(-R)</span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> 
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="nt">-u</span> <span class="nt">-b</span> 100G
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 4 : ì—­ë°©í–¥ ëª¨ë“œ(-R) =&gt; ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ì†¡í• ë•Œ ì†ë„ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.  </span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> 
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="nt">-R</span>
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 5 : ìŒë°©í–¥ ëª¨ë“œ(-R)</span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> 
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="nt">--bidir</span>
  
<span class="c"># iperf3 í…ŒìŠ¤íŠ¸ 6 : TCP ë‹¤ì¤‘ ìŠ¤íŠ¸ë¦¼(30ê°œ), -P(number of parallel client streams to run)</span>
<span class="nv">$ </span>iperf3 <span class="nt">-s</span> 
<span class="nv">$ </span>iperf3 <span class="nt">-c</span> 127.0.0.1 <span class="nt">-P</span> 2 <span class="nt">-t</span> 30
</code></pre></div>    </div>
  </li>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì—ì„œ ì†ë„ ì¸¡ì • í…ŒìŠ¤íŠ¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>í…ŒìŠ¤íŠ¸ í™˜ê²½ ë°°í¬
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/gasida/PKOS/main/aews/k8s-iperf3.yaml
    
<span class="c"># í™•ì¸ : ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°€ ë‹¤ë¥¸ ì›Œì»¤ë…¸ë“œì— ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS      IMAGES                    SELECTOR</span>
<span class="c">#    deployment.apps/iperf3-client   0/1     1            0           5s    iperf3-client   networkstatic/iperf3      app=iperf3-client</span>
<span class="c">#    deployment.apps/iperf3-server   0/1     1            0           5s    iperf3-server   networkstatic/iperf3      app=iperf3-server</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE    SELECTOR</span>
<span class="c">#    service/iperf3-server   ClusterIP   10.200.1.166   &lt;none&gt;        5201/TCP,5201/UDP   5s     app=iperf3-server</span>
<span class="c">#    </span>
<span class="c">#    NAME                                 READY   STATUS              RESTARTS   AGE    IP          NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/iperf3-client-598b85fd6b-tq5xg   0/1     ContainerCreating   0          5s     &lt;none&gt;      myk8s-worker3         &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    pod/iperf3-server-688df6d56f-hlhrm   0/1     ContainerCreating   0          5s     &lt;none&gt;      myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
    
<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
</code></pre></div>        </div>
      </li>
      <li>TCP 5201, ì¸¡ì •ì‹œê°„ 5ì´ˆ
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-t</span> 5
<span class="c"># =&gt; Connecting to host iperf3-server, port 5201</span>
<span class="c">#    [  5] local 10.10.2.9 port 54972 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5]   0.00-1.00   sec  4.68 GBytes  40.2 Gbits/sec  3333   1.07 MBytes</span>
<span class="c">#    [  5]   1.00-2.00   sec  4.87 GBytes  41.8 Gbits/sec  1293   1.09 MBytes</span>
<span class="c">#    [  5]   2.00-3.00   sec  4.86 GBytes  41.8 Gbits/sec  1020   1.11 MBytes</span>
<span class="c">#    [  5]   3.00-4.00   sec  4.85 GBytes  41.7 Gbits/sec  590   1.21 MBytes</span>
<span class="c">#    [  5]   4.00-5.00   sec  4.93 GBytes  42.4 Gbits/sec  988   1.27 MBytes</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5]   0.00-5.00   sec  24.2 GBytes  41.6 Gbits/sec  7224             sender</span>
<span class="c">#    [  5]   0.00-5.00   sec  24.2 GBytes  41.6 Gbits/sec                  receiver</span>
    
<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
<span class="c"># =&gt; -----------------------------------------------------------</span>
<span class="c">#    Server listening on 5201 (test #1)</span>
<span class="c">#    -----------------------------------------------------------</span>
<span class="c">#    Accepted connection from 10.10.2.9, port 54962</span>
<span class="c">#    [  5] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 54972</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-1.00   sec  4.67 GBytes  40.1 Gbits/sec</span>
<span class="c">#    [  5]   1.00-2.00   sec  4.87 GBytes  41.8 Gbits/sec</span>
<span class="c">#    [  5]   2.00-3.00   sec  4.86 GBytes  41.8 Gbits/sec</span>
<span class="c">#    [  5]   3.00-4.00   sec  4.85 GBytes  41.7 Gbits/sec</span>
<span class="c">#    [  5]   4.00-5.00   sec  4.93 GBytes  42.4 Gbits/sec</span>
<span class="c">#    [  5]   5.00-5.00   sec   384 KBytes  41.4 Gbits/sec</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-5.00   sec  24.2 GBytes  41.6 Gbits/sec                  receiver</span>
</code></pre></div>        </div>
      </li>
      <li>UDP ì‚¬ìš©, ì—­ë°©í–¥ ëª¨ë“œ(-R)
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-u</span> <span class="nt">-b</span> 20G
<span class="c"># =&gt; Connecting to host iperf3-server, port 5201</span>
<span class="c">#    [  5] local 10.10.2.9 port 41928 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Total Datagrams</span>
<span class="c">#    [  5]   0.00-1.00   sec   161 MBytes  1.35 Gbits/sec  116453</span>
<span class="c">#    [  5]   1.00-2.00   sec   187 MBytes  1.57 Gbits/sec  135745</span>
<span class="c">#    [  5]   2.00-3.00   sec   163 MBytes  1.36 Gbits/sec  117693</span>
<span class="c">#    [  5]   3.00-4.00   sec   220 MBytes  1.84 Gbits/sec  159109</span>
<span class="c">#    [  5]   4.00-5.00   sec   168 MBytes  1.41 Gbits/sec  121705</span>
<span class="c">#    [  5]   5.00-6.00   sec   183 MBytes  1.54 Gbits/sec  132730</span>
<span class="c">#    [  5]   6.00-7.00   sec   184 MBytes  1.54 Gbits/sec  133267</span>
<span class="c">#    [  5]   7.00-8.00   sec   158 MBytes  1.32 Gbits/sec  114073</span>
<span class="c">#    [  5]   8.00-9.00   sec   171 MBytes  1.44 Gbits/sec  124005</span>
<span class="c">#    [  5]   9.00-10.00  sec   160 MBytes  1.35 Gbits/sec  116175</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams</span>
<span class="c">#    [  5]   0.00-10.00  sec  1.71 GBytes  1.47 Gbits/sec  0.000 ms  0/1270955 (0%)  sender</span>
<span class="c">#    [  5]   0.00-10.00  sec  1.68 GBytes  1.44 Gbits/sec  0.008 ms  28438/1270955 (2.2%)  receiver</span>
    
<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
<span class="c"># =&gt; -----------------------------------------------------------</span>
<span class="c">#    Server listening on 5201 (test #3)</span>
<span class="c">#    -----------------------------------------------------------</span>
<span class="c">#    Accepted connection from 10.10.2.9, port 48546</span>
<span class="c">#    [  5] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 41928</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams</span>
<span class="c">#    [  5]   0.00-1.00   sec   158 MBytes  1.33 Gbits/sec  0.011 ms  2000/116449 (1.7%)</span>
<span class="c">#    [  5]   1.00-2.00   sec   180 MBytes  1.51 Gbits/sec  0.009 ms  5401/135743 (4%)</span>
<span class="c">#    [  5]   2.00-3.00   sec   161 MBytes  1.35 Gbits/sec  0.011 ms  1241/117696 (1.1%)</span>
<span class="c">#    [  5]   3.00-4.00   sec   215 MBytes  1.81 Gbits/sec  0.009 ms  3132/159105 (2%)</span>
<span class="c">#    [  5]   4.00-5.00   sec   165 MBytes  1.39 Gbits/sec  0.007 ms  2073/121704 (1.7%)</span>
<span class="c">#    [  5]   5.00-6.00   sec   179 MBytes  1.51 Gbits/sec  0.008 ms  2758/132731 (2.1%)</span>
<span class="c">#    [  5]   6.00-7.00   sec   181 MBytes  1.52 Gbits/sec  0.009 ms  2397/133243 (1.8%)</span>
<span class="c">#    [  5]   7.00-8.00   sec   153 MBytes  1.28 Gbits/sec  0.007 ms  3612/114097 (3.2%)</span>
<span class="c">#    [  5]   8.00-9.00   sec   166 MBytes  1.39 Gbits/sec  0.009 ms  3707/124005 (3%)</span>
<span class="c">#    [  5]   9.00-10.00  sec   158 MBytes  1.32 Gbits/sec  0.009 ms  2117/116179 (1.8%)</span>
<span class="c">#    [  5]  10.00-10.00  sec  4.24 KBytes   656 Mbits/sec  0.008 ms  0/3 (0%)</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams</span>
<span class="c">#    [  5]   0.00-10.00  sec  1.68 GBytes  1.44 Gbits/sec  0.008 ms  28438/1270955 (2.2%)  receiver</span>
</code></pre></div>        </div>
      </li>
      <li>TCP, ìŒë°©í–¥ ëª¨ë“œ(-R)
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-t</span> 5 <span class="nt">--bidir</span>
<span class="c"># =&gt; Connecting to host iperf3-server, port 5201</span>
<span class="c">#    [  5] local 10.10.2.9 port 59852 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [  7] local 10.10.2.9 port 59860 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [ ID][Role] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5][TX-C]   0.00-1.00   sec  3.85 GBytes  33.0 Gbits/sec  2249   1.55 MBytes</span>
<span class="c">#    [  7][RX-C]   0.00-1.00   sec   553 MBytes  4.64 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   1.00-2.00   sec  1.77 GBytes  15.2 Gbits/sec  3105   1.07 MBytes</span>
<span class="c">#    [  7][RX-C]   1.00-2.00   sec  2.73 GBytes  23.4 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   2.00-3.00   sec  1.64 GBytes  14.1 Gbits/sec  639    850 KBytes</span>
<span class="c">#    [  7][RX-C]   2.00-3.00   sec  2.93 GBytes  25.2 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   3.00-4.00   sec  2.07 GBytes  17.8 Gbits/sec    0    853 KBytes</span>
<span class="c">#    [  7][RX-C]   3.00-4.00   sec  2.48 GBytes  21.3 Gbits/sec</span>
<span class="c">#    [  5][TX-C]   4.00-5.00   sec  1.22 GBytes  10.5 Gbits/sec    2    877 KBytes</span>
<span class="c">#    [  7][RX-C]   4.00-5.00   sec  3.25 GBytes  27.9 Gbits/sec</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID][Role] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5][TX-C]   0.00-5.00   sec  10.5 GBytes  18.1 Gbits/sec  5995             sender</span>
<span class="c">#    [  5][TX-C]   0.00-5.00   sec  10.5 GBytes  18.1 Gbits/sec                  receiver</span>
<span class="c">#    [  7][RX-C]   0.00-5.00   sec  11.9 GBytes  20.5 Gbits/sec  9201             sender</span>
<span class="c">#    [  7][RX-C]   0.00-5.00   sec  11.9 GBytes  20.5 Gbits/sec                  receiver</span>
    
<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
<span class="c"># =&gt; -----------------------------------------------------------</span>
<span class="c">#    Server listening on 5201 (test #2)</span>
<span class="c">#    -----------------------------------------------------------</span>
<span class="c">#    Accepted connection from 10.10.2.9, port 59836</span>
<span class="c">#    [  5] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 59852</span>
<span class="c">#    [  8] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 59860</span>
<span class="c">#    [ ID][Role] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5][RX-S]   0.00-1.00   sec  3.85 GBytes  33.0 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   0.00-1.00   sec   561 MBytes  4.70 Gbits/sec   59   1.02 MBytes</span>
<span class="c">#    [  5][RX-S]   1.00-2.00   sec  1.77 GBytes  15.2 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   1.00-2.00   sec  2.73 GBytes  23.5 Gbits/sec  2468   1.09 MBytes</span>
<span class="c">#    [  5][RX-S]   2.00-3.00   sec  1.63 GBytes  14.0 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   2.00-3.00   sec  2.92 GBytes  25.1 Gbits/sec  3327   1.10 MBytes</span>
<span class="c">#    [  5][RX-S]   3.00-4.00   sec  2.08 GBytes  17.9 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   3.00-4.00   sec  2.49 GBytes  21.4 Gbits/sec  2315   1.13 MBytes</span>
<span class="c">#    [  5][RX-S]   4.00-5.00   sec  1.22 GBytes  10.5 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   4.00-5.00   sec  3.25 GBytes  27.9 Gbits/sec  1032   1.16 MBytes</span>
<span class="c">#    [  5][RX-S]   5.00-5.00   sec   768 KBytes  27.6 Gbits/sec</span>
<span class="c">#    [  8][TX-S]   5.00-5.00   sec  1.25 MBytes  41.3 Gbits/sec    0   1.16 MBytes</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID][Role] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5][RX-S]   0.00-5.00   sec  10.5 GBytes  18.1 Gbits/sec                  receiver</span>
<span class="c">#    [  8][TX-S]   0.00-5.00   sec  11.9 GBytes  20.5 Gbits/sec  9201             sender</span>
</code></pre></div>        </div>
      </li>
      <li>TCP ë‹¤ì¤‘ ìŠ¤íŠ¸ë¦¼(30ê°œ), -P(number of parallel client streams to run)
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># í´ë¼ì´ì–¸íŠ¸ íŒŒë“œì—ì„œ ì•„ë˜ ëª…ë ¹ ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/iperf3-client <span class="nt">--</span> iperf3 <span class="nt">-c</span> iperf3-server <span class="nt">-t</span> 10 <span class="nt">-P</span> 2
<span class="c"># =&gt; [  5] local 10.10.2.9 port 41976 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [  7] local 10.10.2.9 port 41982 connected to 10.200.1.166 port 5201</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span>
<span class="c">#    [  5]   0.00-1.00   sec  2.87 GBytes  24.7 Gbits/sec  822    570 KBytes</span>
<span class="c">#    [  7]   0.00-1.00   sec  2.88 GBytes  24.7 Gbits/sec  159    576 KBytes</span>
<span class="c">#    [SUM]   0.00-1.00   sec  5.75 GBytes  49.4 Gbits/sec  981</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    ...</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate         Retr</span>
<span class="c">#    [  5]   0.00-10.00  sec  29.2 GBytes  25.1 Gbits/sec  3825             sender</span>
<span class="c">#    [  5]   0.00-10.00  sec  29.2 GBytes  25.1 Gbits/sec                  receiver</span>
<span class="c">#    [  7]   0.00-10.00  sec  29.2 GBytes  25.1 Gbits/sec  2063             sender</span>
<span class="c">#    [  7]   0.00-10.00  sec  29.2 GBytes  25.0 Gbits/sec                  receiver</span>
<span class="c">#    [SUM]   0.00-10.00  sec  58.3 GBytes  50.1 Gbits/sec  5888             sender</span>
<span class="c">#    [SUM]   0.00-10.00  sec  58.3 GBytes  50.1 Gbits/sec                  receiver</span>
    
<span class="c"># ì„œë²„ íŒŒë“œ ë¡œê·¸ í™•ì¸ : ê¸°ë³¸ 5201 í¬íŠ¸ Listen</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>iperf3-server <span class="nt">-f</span>
<span class="c"># =&gt; -----------------------------------------------------------</span>
<span class="c">#    Server listening on 5201 (test #4)</span>
<span class="c">#    -----------------------------------------------------------</span>
<span class="c">#    Accepted connection from 10.10.2.9, port 41962</span>
<span class="c">#    [  5] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 41976</span>
<span class="c">#    [  8] local 10.10.4.6 port 5201 connected to 10.10.2.9 port 41982</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-1.00   sec  2.87 GBytes  24.6 Gbits/sec</span>
<span class="c">#    [  8]   0.00-1.00   sec  2.87 GBytes  24.7 Gbits/sec</span>
<span class="c">#    [SUM]   0.00-1.00   sec  5.74 GBytes  49.3 Gbits/sec</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    ...</span>
<span class="c">#    - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<span class="c">#    [ ID] Interval           Transfer     Bitrate</span>
<span class="c">#    [  5]   0.00-10.00  sec  29.2 GBytes  25.1 Gbits/sec                  receiver</span>
<span class="c">#    [  8]   0.00-10.00  sec  29.2 GBytes  25.0 Gbits/sec                  receiver</span>
<span class="c">#    [SUM]   0.00-10.00  sec  58.3 GBytes  50.1 Gbits/sec                  receiver</span>
</code></pre></div>        </div>
      </li>
      <li>ì‹¤ìŠµê²°ê³¼ <code class="language-plaintext highlighter-rouge">iperf3 -c 127.0.0.1 -t 5</code>ë¡œ ì¸¡ì •í•˜ì˜€ì„ë•ŒëŠ” í˜¸ìŠ¤íŠ¸ì—ì„œëŠ” 67.1 Gbits/sec ì˜€ë˜ê²ƒì— ë°˜í•´, ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ í†µí•˜ë©´ 41.6 Gbits/secë¡œ ì¸¡ì •ë©ë‹ˆë‹¤.
        <ul>
          <li>ì¿ ë²„ë„¤í‹°ìŠ¤ë„ ë¡œì»¬í˜¸ìŠ¤íŠ¸ì—ì„œ dockerë¡œ ì‹¤í–‰ë˜ëŠ”ë° kube-proxy, iptables í¬ì›Œë”© ë“±ì˜ ì˜¤ë²„í—¤ë“œë¡œ ì¸í•´ ë°œìƒí•˜ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>UDPì˜ ê²½ìš°ì—ë„ <code class="language-plaintext highlighter-rouge">iperf3 -c 127.0.0.1 -u -b 20G</code>ë¡œ ì¸¡ì •í–ˆì„ë•Œ í˜¸ìŠ¤íŠ¸ì—ì„œëŠ” 20.0 Gbits/secê°€ ë‚˜ì˜¤ëŠ”ë°, ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ í†µí•˜ë©´ 1.41 Gbits/secë¡œ ì¸¡ì •ë©ë‹ˆë‹¤.
        <ul>
          <li>UDPëŠ” ë” ì˜¤ë²„í—¤ë“œê°€ ì‹¬í•œë° ì›ì¸ì„ ì°¾ì•„ë´ì•¼ í• ê²ƒ ê°™ìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ì´ë²ˆ ì‹¤ìŠµì„ í†µí•´ ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ CNI, ì„¤ì •ë“±ì„ ë³€ê²½í•´ê°€ë©° ìµœì ì˜ ì„¤ì •ì„ ì°¾ì•„ë³´ëŠ” ë°©ë²•ì„ ë°°ì›Œë³´ì•˜ìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<hr>

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì‹¤ìŠµì„ í• ìˆ˜ë¡ ì ì  ë” iptablesê³¼ ì¹œìˆ™í•´ì§€ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ëˆˆì— ìµì€ê²Œ ë§ì•„ì§€ê³ ëŠ” ìˆì§€ë§Œ, nftablesë¼ë˜ì§€ ipvsë¼ë˜ì§€, eBPFë¼ë˜ì§€ ì•„ì§ ê°ˆê¸¸ì´ ë©‰ë‹ˆë‹¤. ğŸ˜…</p>

<p>ìƒˆì‚¼ìŠ¤ë ˆ ìŠ¤í„°ë””ë¥¼ ì§„í–‰í•˜ì‹œëŠ” ê°€ì‹œë‹¤ë‹˜ì„ ë¹„ë¡¯í•´ì„œ ì¡°ë ¥ì ë¶„ë“¤ë„ ì •ë§ ëŒ€ë‹¨í•˜ë‹¤ëŠ” ìƒê°ì´ ë“­ë‹ˆë‹¤.
ê·¸ë¦¬ê³  ë‚´ìš©ë“¤ ë° ê·¸ë¦¼ë“¤ì´ ê°€ì‹œë‹¤ë‹˜ì´ ì§‘í•„í•˜ì‹  ì±…ì—ì„œ ë§ì´ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.
ì±…ì´ ì¶œíŒë˜ë©´ ê¼­ êµ¬ë§¤í•´ì„œ ì½ì–´ë³´ê² ìŠµë‹ˆë‹¤! 
ì´ì œ ìŠ¤í„°ë””ë„ ì¤‘ë°˜ì„ í–¥í•´ ë‹¬ë ¤ê°€ê³  ìˆìŠµë‹ˆë‹¤. ë‚¨ì€ ë‚ ë“¤ë„ ìŠ¤í„°ë””ì—ì„œ ìƒì¡´í•  ìˆ˜ ìˆê¸°ë¥¼ ë°”ëë‹ˆë‹¤. <img class="emoji" title=":pray:" alt=":pray:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f64f.png" height="20" width="20" loading="lazy"></p>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">ë“¤ì–´ê°€ë©°</a></li>
<li class="toc-entry toc-h2">
<a href="#k8s-service">K8S Service</a>
<ul>
<li class="toc-entry toc-h3"><a href="#service%EC%9D%98-%ED%83%84%EC%83%9D-%EB%B0%B0%EA%B2%BD">Serviceì˜ íƒ„ìƒ ë°°ê²½</a></li>
<li class="toc-entry toc-h3">
<a href="#k8s-service-%EC%A2%85%EB%A5%98">K8S Service ì¢…ë¥˜</a>
<ul>
<li class="toc-entry toc-h4"><a href="#clusterip">ClusterIP</a></li>
<li class="toc-entry toc-h4"><a href="#nodeport">NodePort</a></li>
<li class="toc-entry toc-h4"><a href="#loadbalancer">LoadBalancer</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4%EC%9D%98-%EA%B5%AC%EC%A1%B0">ì„œë¹„ìŠ¤ì˜ êµ¬ì¡°</a></li>
<li class="toc-entry toc-h3">
<a href="#kube-proxy-%EB%AA%A8%EB%93%9C">kube-proxy ëª¨ë“œ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#userspace-proxy-%EB%AA%A8%EB%93%9C">userspace proxy ëª¨ë“œ</a></li>
<li class="toc-entry toc-h4"><a href="#iptables-proxy-%EB%AA%A8%EB%93%9C">iptables proxy ëª¨ë“œ</a></li>
<li class="toc-entry toc-h4"><a href="#ipvs-proxy-%EB%AA%A8%EB%93%9C">ipvs proxy ëª¨ë“œ</a></li>
<li class="toc-entry toc-h4"><a href="#nftables-proxy-%EB%AA%A8%EB%93%9C">nftables proxy ëª¨ë“œ</a></li>
<li class="toc-entry toc-h4"><a href="#ebpf-%EB%AA%A8%EB%93%9C--xdp">eBPF ëª¨ë“œ + XDP</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%EC%8B%A4%EC%8A%B5">ì‹¤ìŠµ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%B6%95">ì‹¤ìŠµí™˜ê²½ êµ¬ì¶•</a></li>
<li class="toc-entry toc-h4"><a href="#clusterip-%EC%8B%A4%EC%8A%B5">ClusterIP ì‹¤ìŠµ</a></li>
<li class="toc-entry toc-h4"><a href="#nodeport-%EC%8B%A4%EC%8A%B5">NodePort ì‹¤ìŠµ</a></li>
<li class="toc-entry toc-h4"><a href="#%ED%8C%8C%EB%93%9C%EA%B0%84-%EC%86%8D%EB%8F%84-%EC%B8%A1%EC%A0%95">íŒŒë“œê°„ ì†ë„ ì¸¡ì •</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">ë§ˆì¹˜ë©°</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2024-09-27-KANS-Study-Week4/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2024-09-22-KANS-Study-Week3/">Â« [KANS 3ê¸°] K8S Calico CNI</a>
  
  
  <a class="next" href="/posts/2024-10-05-KANS-Study-Week5/">[KANS 3ê¸°] LoadBalancer(MetalLB), IPVS Â»</a>
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2024-09-27-KANS-Study-Week4/";
this.page.identifier = "/posts/KANS Study - Week4";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>ê³µë¶€ ê¸°ë¡ê³¼ ê°œë°œ ì´ì•¼ê¸°ë¥¼ ë‹´ì€ ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>
  </body>

</html>
