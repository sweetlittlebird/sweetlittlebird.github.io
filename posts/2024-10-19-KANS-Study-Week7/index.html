<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[KANS 3ê¸°] Service Mesh : Istio - Mode (Sidecar, Ambient) | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[KANS 3ê¸°] Service Mesh : Istio - Mode (Sidecar, Ambient)">
<meta property="og:locale" content="ko">
<meta name="description" content="ì´ë²ˆì£¼ì—ëŠ” Service Meshì™€ ëŒ€í‘œì ì¸ ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ì¸ Istioì— ëŒ€í•´ ì•Œì•„ ë³´ê² ìŠµë‹ˆë‹¤.">
<meta property="og:description" content="ì´ë²ˆì£¼ì—ëŠ” Service Meshì™€ ëŒ€í‘œì ì¸ ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ì¸ Istioì— ëŒ€í•´ ì•Œì•„ ë³´ê² ìŠµë‹ˆë‹¤.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2024-10-19-KANS-Study-Week7/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2024-10-19-KANS-Study-Week7/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-10-19T01:00:18+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[KANS 3ê¸°] Service Mesh : Istio - Mode (Sidecar, Ambient)">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-10-19T01:00:18+09:00","datePublished":"2024-10-19T01:00:18+09:00","description":"ì´ë²ˆì£¼ì—ëŠ” Service Meshì™€ ëŒ€í‘œì ì¸ ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ì¸ Istioì— ëŒ€í•´ ì•Œì•„ ë³´ê² ìŠµë‹ˆë‹¤.","headline":"[KANS 3ê¸°] Service Mesh : Istio - Mode (Sidecar, Ambient)","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2024-10-19-KANS-Study-Week7/"},"url":"https://sweetlittlebird.github.io/posts/2024-10-19-KANS-Study-Week7/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">ì†Œê°œ</a><a class="page-link" href="/posts/">ê¸€ ëª©ë¡</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[KANS 3ê¸°] Service Mesh : Istio - Mode (Sidecar, Ambient)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-10-19T01:00:18+09:00" itemprop="datePublished">2024ë…„ 10ì›” 19ì¼ì— ì‘ì„±
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>ëª©ì°¨</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">ë“¤ì–´ê°€ë©°</a></li>
<li class="toc-entry toc-h2">
<a href="#istio-%EC%86%8C%EA%B0%9C">Istio ì†Œê°œ</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%A9%94%EC%8B%9C-service-mesh%EB%9E%80">ì„œë¹„ìŠ¤ ë©”ì‹œ (Service Mesh)ë€?</a></li>
<li class="toc-entry toc-h3">
<a href="#envoy">Envoy</a>
<ul>
<li class="toc-entry toc-h4"><a href="#envoy-%EC%8B%A4%EC%8A%B5">Envoy ì‹¤ìŠµ</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#istio-%EC%86%8C%EA%B0%9C-1">Istio ì†Œê°œ</a></li>
<li class="toc-entry toc-h3"><a href="#istio-%EC%84%A4%EC%B9%98-sidecar-%EB%AA%A8%EB%93%9C">Istio ì„¤ì¹˜ (Sidecar ëª¨ë“œ)</a></li>
<li class="toc-entry toc-h3"><a href="#istio%EB%A5%BC-%ED%86%B5%ED%95%9C-%EC%99%B8%EB%B6%80-%EB%85%B8%EC%B6%9C">Istioë¥¼ í†µí•œ ì™¸ë¶€ ë…¸ì¶œ</a></li>
<li class="toc-entry toc-h3">
<a href="#bookinfo-%EC%8B%A4%EC%8A%B5-%EB%B0%8F-istio-%EA%B8%B0%EB%8A%A5-%ED%99%95%EC%9D%B8">Bookinfo ì‹¤ìŠµ ë° Istio ê¸°ëŠ¥ í™•ì¸</a>
<ul>
<li class="toc-entry toc-h4"><a href="#bookinfo">Bookinfo</a></li>
<li class="toc-entry toc-h4"><a href="#istio%EB%A5%BC-%ED%86%B5%ED%95%9C-%EC%9D%B8%EC%9E%85-%EA%B8%B0%EB%B3%B8-%EC%84%A4%EC%A0%95">Istioë¥¼ í†µí•œ ì¸ì… ê¸°ë³¸ ì„¤ì •</a></li>
<li class="toc-entry toc-h4"><a href="#%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">ëª¨ë‹ˆí„°ë§</a></li>
<li class="toc-entry toc-h4"><a href="#traffic-management">Traffic Management</a></li>
<li class="toc-entry toc-h4"><a href="#security-%EB%B3%B4%EC%95%88">Security (ë³´ì•ˆ)</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#istio-%ED%86%B5%EC%8B%A0-%ED%9D%90%EB%A6%84">Istio í†µì‹  íë¦„</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">ë§ˆì¹˜ë©°</a></li>
</ul>
    </div>
    <h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆì£¼ì—ëŠ” Service Meshì™€ ëŒ€í‘œì ì¸ ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ì¸ Istioì— ëŒ€í•´ ì•Œì•„ ë³´ê² ìŠµë‹ˆë‹¤.
KANS 3ê¸° 7ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr>

<h2 id="istio-ì†Œê°œ">Istio ì†Œê°œ</h2>

<p>IstioëŠ” ì„œë¹„ìŠ¤ ë©”ì‹œë¥¼ êµ¬ì¶•í•˜ê³  ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì˜¤í”ˆì†ŒìŠ¤ í”Œë«í¼ì…ë‹ˆë‹¤. Istioë¥¼ ì•Œì•„ë³´ê¸°ì— ì•ì„œ ì„œë¹„ìŠ¤ ë©”ì‹œì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h3 id="ì„œë¹„ìŠ¤-ë©”ì‹œ-service-meshë€">ì„œë¹„ìŠ¤ ë©”ì‹œ (Service Mesh)ë€?</h3>

<ul>
  <li>
<strong>ì„œë¹„ìŠ¤ ë©”ì‹œ</strong>ëŠ” ì„œë¹„ìŠ¤ ê°„ <strong>í†µì‹ ì„ ì œì–´</strong>í•˜ê³  <strong>ëª¨ë‹ˆí„°ë§</strong>í•˜ëŠ” ë ˆì´ì–´ë¥¼ ì œê³µí•˜ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ê³„ì¸µì…ë‹ˆë‹¤.</li>
  <li>
<strong>ë“±ì¥ë°°ê²½</strong> : MSA í™˜ê²½ì—ì„œ ì„œë¹„ìŠ¤ê°€ ë§ì•„ì§€ë‹¤ ë³´ë‹ˆ ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì´ ë³µì¡í•´ì§€ê³ , ì´ë¡œ ì¸í•´ ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì„ ê´€ë¦¬í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ëŠ” ê²ƒì´ ì–´ë ¤ì›Œì¡ŒìŠµë‹ˆë‹¤.
ì´ë¡œì¸í•´ ì¥ì• ê°€ ë°œìƒí•˜ê±°ë‚˜ ë³‘ëª© í˜„ìƒì´ ë°œìƒí–ˆì„ë•Œ ì›ì¸ê³¼ ë°œìƒí•˜ëŠ” êµ¬ê°„ì„ ì°¾ê¸°ê°€ ì–´ë ¤ì›Œì¡ŒìŠµë‹ˆë‹¤. ì´ê²ƒì„ í•´ê²° í•˜ê¸° ìœ„í•´ ë“±ì¥í•œ ê²ƒì´ ì„œë¹„ìŠ¤ ë©”ì‹œì…ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_1.png" alt="img.png" class="image-center w-80" loading="lazy" width="1792" height="1024">
</li>
  <li>
<strong>ê°œë…</strong> : ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ê°„ì— í†µì‹ ì´ë‚˜ ê²½ë¡œë¥¼ ì œì–´ - ì˜ˆ) istio, linkerd, consul, envoy, â€¦</li>
  <li>
<strong>ê¸°ë³¸ ë™ì‘</strong> : íŒŒë“œê°„ í†µì‹ ê²½ë¡œì— í”„ë¡ì‹œë¥¼ ë‘ê³  íŠ¸ë˜í”½ì„ ëª¨ë‹ˆí„°ë§í•˜ê±°ë‚˜ ì»¨íŠ¸ë¡¤ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ê¸°ì¡´ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ìˆ˜ì •í•˜ì§€ ì•Šê³ ë„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_2.png" alt="img.png" class="image-center w-80" loading="lazy" width="1837" height="880">
ìœ„ì˜ ê·¸ë¦¼ ì²˜ëŸ¼ ì„œë¹„ìŠ¤ ë©”ì‹œëŠ” ê° íŒŒë“œì— í”„ë¡ì‹œë¥¼ ë‘ê³  í”„ë¡ì‹œë¥¼ í†µí•´ í†µì‹ ì„ í•˜ë„ë¡í•œ ë‹¤ìŒ í”„ë¡ì‹œë¥¼ í†µí•´ íŠ¸ë˜í”½ì„ ëª¨ë‹ˆí„°ë§í•˜ê±°ë‚˜ ì»¨íŠ¸ë¡¤ í•©ë‹ˆë‹¤.
    <ul>
      <li>ì´ë•Œ í”„ë¡ì‹œëŠ” <strong>Sidecar</strong> ëª¨ë“œë¡œ ë™ì‘í•˜ê±°ë‚˜ <strong>Ambient</strong> ëª¨ë“œë¡œ ë™ì‘í•˜ë©° ëŒ€í‘œì ì¸ í”„ë¡ì‹œë¡œëŠ” Envoysê°€ ìˆìŠµë‹ˆë‹¤.</li>
      <li>EnvoyëŠ” êµ¬ê¸€, IBM, Lyftê°€ ì¤‘ì‹¬ì´ ë˜ì–´ ê°œë°œí•˜ê³  ìˆëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡ì‹œì…ë‹ˆë‹¤.</li>
      <li>ë„¤íŠ¸ì›Œí¬ íˆ¬ëª…ì„±ì„ ëª©í‘œë¡œ ë‹¤ì–‘í•œ í•„í„° ì²´ì¸ ì§€ì›(L3, L4, L7), ë™ì  Configuration APIë¥¼ ì œê³µí•˜ê³ , hot reloadë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>
<strong>ì£¼ìš”ê¸°ëŠ¥</strong>
    <ul>
      <li>
<strong>íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§</strong> : ìš”ì²­ì˜ ì—ëŸ¬ìœ¨, ì§€ì—°ì‹œê°„, ì»¨ë„¥ì…˜ ê°œìˆ˜, ìš”ì²­ê°œìˆ˜ ë“±ì˜ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ì—¬ ëª¨ë‹ˆí„°ë§í•˜ê³ , ì„œë¹„ìŠ¤ê°„ í˜¹ì€ íŠ¹ì • ìš”ì²­ ê²½ë¡œë¥¼ í•„í„°ë§ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
=&gt; ì›ì¸ íŒŒì•… ìš©ì´</li>
      <li>
<strong>íŠ¸ë˜í”½ ì»¨íŠ¸ë¡¤</strong>
        <ul>
          <li>íŠ¸ë˜í”½ ì‹œí”„íŒ…(traffic shifting) : íŠ¸ë˜í”½ì„ ì„œë¹„ìŠ¤ê°„ì— ë¶„ì‚°ì‹œí‚¤ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ, íŠ¹ì • ë‹¨ë§/ì‚¬ìš©ìëŠ” ì‹ ê·œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ì—°ê²°í•˜ë„ë¡ í•˜ëŠ” ì¹´ë‚˜ë¦¬ ë°°í¬ë“±ì— í™œìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ì„œí‚· ë¸Œë ˆì´ì»¤(circuit breaker) : íŠ¹ì • ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ìˆì„ë•Œ ì ‘ì†ì„ ì°¨ë‹¨í•˜ê³ , ì¶œë°œì§€ ì„œë¹„ìŠ¤ì— ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ë„ë¡ í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. (ì—°ì‡„ì¥ì• , ì‹œìŠ¤í…œ ì „ì²´ ì¥ì•  ë°©ì§€)</li>
          <li>í”ŒíŠ¸ ì¸ì ì…˜(fault injection) : ì˜ë„ì ìœ¼ë¡œ ìš”ì²­ì„ ì§€ì—°ì‹œí‚¤ê±°ë‚˜ ì‹¤íŒ¨í•˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ë¹„ì •ìƒ ìƒí™© í…ŒìŠ¤íŠ¸)</li>
          <li>ì†ë„ ì œí•œ(rate limiting) : íŠ¹ì • ì„œë¹„ìŠ¤ì— ëŒ€í•œ ìš”ì²­ ê°œìˆ˜ë¥¼ ì œí•œí•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="envoy">Envoy</h3>

<ul>
  <li>ì§€ë‚œì£¼ì— ì‚´ì§ ì–¸ê¸‰ë˜ì—ˆë˜ ë‚´ìš©ì¸ë° ì´ë²ˆ ì£¼ì— ì¢€ ë” ìì„¸íˆ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>EnvoyëŠ” êµ¬ê¸€, IBM, Lyftê°€ ì¤‘ì‹¬ì´ ë˜ì–´ ê°œë°œí•˜ê³  ìˆëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡ì‹œì…ë‹ˆë‹¤.</li>
  <li>Istioì˜ í•µì‹¬ ê¸°ëŠ¥ë“¤ì€ Envoyë¥¼ ê°ì‹¼ istio proxyë¥¼ í†µí•´ ì´ë£¨ì–´ì§€ë¯€ë¡œ Envoyì— ëŒ€í•œ ì´í•´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_4.svg" alt="20241019_kans_w7_4.svg" class="image-center w-80" loading="lazy" width="693" height="341"></p>

<ul>
  <li>Envoyì—ì„œ ì‚¬ìš©í•˜ëŠ” ìš©ì–´ ë“¤ì„ ì •ë¦¬í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>ìš©ì–´</th>
      <th>ì„¤ëª…</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Cluster</td>
      <td>envoyê°€ íŠ¸ë˜í”½ì„ í¬ì›Œë”©í•  ìˆ˜ ìˆëŠ” ë…¼ë¦¬ì  ì„œë¹„ìŠ¤ (ì—”ë“œí¬ì¸íŠ¸ ì…‹íŠ¸)</td>
    </tr>
    <tr>
      <td>Endpoint</td>
      <td>IP ì£¼ì†Œì™€ í¬íŠ¸ ë²ˆí˜¸ë¡œ êµ¬ì„±ëœ ì„œë¹„ìŠ¤ì˜ ì‹¤ì œ ì¸ìŠ¤í„´ìŠ¤. ì—”ë“œí¬ì¸íŠ¸ê°€ ëª¨ì—¬ì„œ í•˜ë‚˜ì˜ Clusterë¥¼ ì´ë£¸</td>
    </tr>
    <tr>
      <td>Listener</td>
      <td>í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ì†í•˜ëŠ” í¬íŠ¸, ìœ ë‹‰ìŠ¤ ë„ë©”ì¸ ì†Œì¼“ ë“±ì„ ë…¸ì¶œí•˜ê³ , ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë¶€í„° ë°›ì€ ìš”ì²­ì„ ì²˜ë¦¬</td>
    </tr>
    <tr>
      <td>Route</td>
      <td>Listenerë¡œ ë“¤ì–´ì˜¨ ìš”ì²­ì„ ì–´ë–¤ í´ëŸ¬ìŠ¤í„°ë¡œ ë³´ë‚¼ì§€ ì •ì˜</td>
    </tr>
    <tr>
      <td>Filter</td>
      <td>Listenerë¡œ ë¶€í„° ì„œë¹„ìŠ¤ì— íŠ¸ë˜í”½ ì „ë‹¬í•˜ê¸° ì „ì— íŠ¸ë˜í”½ì„ ê°€ê³µí•˜ê±°ë‚˜ ì°¨ë‹¨í•˜ëŠ” ì—­í• ì„ í•˜ëŠ” ì»´í¬ë„ŒíŠ¸</td>
    </tr>
    <tr>
      <td>UpStream</td>
      <td>envoy ìš”ì²­ì„ í¬ì›Œë”©í•´ì„œ ì—°ê²°í•˜ëŠ” ë°±ì—”ë“œ ë„¤íŠ¸ì›Œí¬ ë…¸ë“œ - ì‚¬ì´ë“œì¹´ì¼ë•ŒëŠ” application app, ì•„ë‹ë•ŒëŠ” ì›ê²© ë°±ì—”ë“œ</td>
    </tr>
    <tr>
      <td>DownStream</td>
      <td>envoyë¡œ ì—°ê²°í•˜ì—¬ ìš”ì²­ì„ ë³´ë‚´ëŠ” ê°œì²´. ì‚¬ì´ë“œì¹´ê°€ ì•„ë‹ë•ŒëŠ” ì›ê²©ì§€ì˜ í´ë¼ì´ì–¸íŠ¸</td>
    </tr>
    <tr>
      <td>Host</td>
      <td>ë„¤íŠ¸ì›Œí¬ í†µì‹ ì´ ê°€ëŠ¥í•œ ê°œì²´ (PC, ì„œë²„, íœ´ëŒ€í°, ë„¤íŠ¸ì›Œí¬ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë“±)</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>ë§ì€ Service Mesh ì†”ë£¨ì…˜ì´ë‚˜, Gateway API êµ¬í˜„ì²´ë“¤ì´ ë‚´ë¶€ì ìœ¼ë¡œ Envoyë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©°, Envoyê°€ ì œê³µí•˜ëŠ” ë™ì  êµ¬ì„±ì„ ìœ„í•œ API(xDS Sync API)ë¥¼ 
ì´ìš©í•˜ì—¬ ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ êµ¬ì„±í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
  <li>Envoyì˜ xDS Sync APIëŠ” ì•„ë˜ì™€ ê°™ì€ ë ˆì´ì–´ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.
    <ul>
      <li>LDS - Listener Discovery Service</li>
      <li>RDS - Route Discovery Service</li>
      <li>CDS - Cluster Discovery Service</li>
      <li>EDS - Endpoint Discovery Service</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_5.png" alt="img.png" class="image-center w-80" loading="lazy" width="966" height="417"></p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_6.png" alt="img.png" class="image-center w-80" loading="lazy" width="765" height="499"></p>

<h4 id="envoy-ì‹¤ìŠµ">Envoy ì‹¤ìŠµ</h4>

<ul>
  <li>test pcì— Envoy ì„¤ì¹˜</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì„¤ì¹˜</span>
<span class="c"># echo "deb [signed-by=/etc/apt/keyrings/envoy-keyring.gpg] https://apt.envoyproxy.io focal main" | sudo tee /etc/apt/sources.list.d/envoy.list</span>
<span class="nv">$ </span>wget <span class="nt">-O-</span> https://apt.envoyproxy.io/signing.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/envoy-keyring.gpg
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/envoy-keyring.gpg] https://apt.envoyproxy.io jammy main"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/envoy.list
<span class="nv">$ </span><span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install </span>envoy <span class="nt">-y</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>envoy <span class="nt">--version</span>
<span class="c"># =&gt; envoy  version: e3b4a6e9570da15ac1caffdded17a8bebdc7dfc9/1.32.0/Clean/RELEASE/BoringSSL</span>

<span class="c"># ë„ì›€ë§</span>
<span class="nv">$ </span>envoy <span class="nt">--help</span>
</code></pre></div></div>

<ul>
  <li>Envoy proxy ì‹¤ìŠµ - <a href="https://www.envoyproxy.io/docs/envoy/latest/start/quick-start/">Link</a>
    <ul>
      <li>envoy-demo.yml ì‘ì„±
        <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># envoy-demo.yml</span>
<span class="na">static_resources</span><span class="pi">:</span>
    
  <span class="na">listeners</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">listener_0</span>
    <span class="na">address</span><span class="pi">:</span>
      <span class="na">socket_address</span><span class="pi">:</span>
        <span class="na">address</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
        <span class="na">port_value</span><span class="pi">:</span> <span class="m">10000</span>
    <span class="na">filter_chains</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">filters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.network.http_connection_manager</span>
        <span class="na">typed_config</span><span class="pi">:</span>
          <span class="s2">"</span><span class="s">@type"</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>
          <span class="s">stat_prefix</span><span class="err">:</span> <span class="s">ingress_http</span>
          <span class="s">access_log</span><span class="err">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.access_loggers.stdout</span>
            <span class="na">typed_config</span><span class="pi">:</span>
              <span class="s2">"</span><span class="s">@type"</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog</span>
          <span class="na">http_filters</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.http.router</span>
          <span class="na">route_config</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">local_route</span>
            <span class="na">virtual_hosts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">local_service</span>
              <span class="na">domains</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">*"</span><span class="pi">]</span>
              <span class="na">routes</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
                  <span class="na">prefix</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/"</span>
                <span class="na">route</span><span class="pi">:</span>
                  <span class="na">host_rewrite_literal</span><span class="pi">:</span> <span class="s">www.envoyproxy.io</span>
                  <span class="na">cluster</span><span class="pi">:</span> <span class="s">service_envoyproxy_io</span>
    
  <span class="na">clusters</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">service_envoyproxy_io</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">LOGICAL_DNS</span>
    <span class="c1"># Comment out the following line to test on v6 networks</span>
    <span class="na">dns_lookup_family</span><span class="pi">:</span> <span class="s">V4_ONLY</span>
    <span class="na">connect_timeout</span><span class="pi">:</span> <span class="s">5s</span>
    <span class="na">load_assignment</span><span class="pi">:</span>
      <span class="na">cluster_name</span><span class="pi">:</span> <span class="s">service_envoyproxy_io</span>
      <span class="na">endpoints</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">lb_endpoints</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">endpoint</span><span class="pi">:</span>
            <span class="na">address</span><span class="pi">:</span>
              <span class="na">socket_address</span><span class="pi">:</span>
                <span class="na">address</span><span class="pi">:</span> <span class="s">www.envoyproxy.io</span>
                <span class="na">port_value</span><span class="pi">:</span> <span class="m">443</span>
    <span class="na">transport_socket</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.transport_sockets.tls</span>
      <span class="na">typed_config</span><span class="pi">:</span>
        <span class="s2">"</span><span class="s">@type"</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext</span>
        <span class="s">sni</span><span class="err">:</span> <span class="s">www.envoyproxy.io</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì‹¤í–‰</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># (í„°ë¯¸ë„1) ë°ëª¨ config ì ìš©í•˜ì—¬ ì‹¤í–‰</span>
  <span class="nv">$ </span>curl <span class="nt">-O</span> https://www.envoyproxy.io/docs/envoy/latest/_downloads/92dcb9714fb6bc288d042029b34c0de4/envoy-demo.yaml
  <span class="nv">$ </span>envoy <span class="nt">-c</span> envoy-demo.yaml
  <span class="c"># =&gt; [2024-10-01 16:41:51.547][4479][info][main] [source/server/server.cc:426] initializing epoch 0 (base id=0, hot restart version=11.104)</span>
  <span class="c">#    ...</span>
    
  <span class="c"># (í„°ë¯¸ë„2) ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>ss <span class="nt">-tnlp</span>
  <span class="c"># =&gt; State           Recv-Q           Send-Q                     Local Address:Port                      Peer Address:Port          Process</span>
  <span class="c">#    LISTEN          0                4096                             0.0.0.0:10000                          0.0.0.0:*              users:((&amp;quot;envoy&amp;quot;,pid=4479,fd=35))</span>
  <span class="c">#    LISTEN          0                4096                             0.0.0.0:10000                          0.0.0.0:*              users:((&amp;quot;envoy&amp;quot;,pid=4479,fd=34))</span>
  <span class="c">#    LISTEN          0                4096                             0.0.0.0:10000                          0.0.0.0:*              users:((&amp;quot;envoy&amp;quot;,pid=4479,fd=33))</span>
  <span class="c">#    LISTEN          0                4096                             0.0.0.0:10000                          0.0.0.0:*              users:((&amp;quot;envoy&amp;quot;,pid=4479,fd=32))</span>
  <span class="c">#    ...</span>
    
  <span class="c"># ì ‘ì† í…ŒìŠ¤íŠ¸</span>
  <span class="nv">$ </span>curl <span class="nt">-s</span> http://127.0.0.1:10000 | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
  <span class="c"># =&gt; &amp;lt;title&amp;gt;Envoy proxy - home&amp;lt;/title&amp;gt;</span>
    
  <span class="c"># ì™¸ë¶€ ì ‘ì† ì •ë³´ ì¶œë ¥</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:10000"</span>
  <span class="c"># =&gt; http://54.123.42.212:10000</span>
    
  <span class="nt">--------------------</span>
  <span class="c"># ìì‹ ì˜ PC ì›¹ë¸Œë¼ìš°ì €ì—ì„œ ì™¸ë¶€ ì ‘ì† ì •ë³´ ì ‘ì† í™•ì¸!</span>
    
  <span class="c"># k3s-m ì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
  <span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.56.104:10000 | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
  <span class="c"># =&gt; &amp;lt;title&amp;gt;Envoy proxy - home&amp;lt;/title&amp;gt; </span>
  <span class="nt">--------------------</span>
    
  <span class="c"># ì—°ê²° ì •ë³´ í™•ì¸</span>
  <span class="nv">$ </span>ss <span class="nt">-tnp</span>
    
  <span class="c"># (í„°ë¯¸ë„1) envoy ì‹¤í–‰ ì·¨ì†Œ(CTRL+C) í›„ (ê´€ë¦¬ìí˜ì´ì§€) ì„¤ì • ë®ì–´ì“°ê¸° - ë§í¬</span>
  <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt; envoy-override.yaml
  admin:
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 9902
</span><span class="no">  EOT
</span>  <span class="nv">$ </span>envoy <span class="nt">-c</span> envoy-demo.yaml <span class="nt">--config-yaml</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">cat </span>envoy-override.yaml<span class="si">)</span><span class="s2">"</span>
    
  <span class="c"># envoy ê´€ë¦¬í˜ì´ì§€ ì™¸ë¶€ ì ‘ì† ì •ë³´ ì¶œë ¥</span>
  <span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:9902"</span>
  <span class="c"># =&gt; http://54.123.42.212:9902</span>
    
  <span class="nt">--------------------</span>
  <span class="c"># ìì‹ ì˜ PC ì›¹ë¸Œë¼ìš°ì €ì—ì„œ ê´€ë¦¬ í˜ì´ì§€ ì™¸ë¶€ ì ‘ì† ì •ë³´ ì ‘ì† í™•ì¸!</span>
</code></pre></div>        </div>

        <p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_7.png" alt="img.png" class="image-center" loading="lazy" width="1249" height="688">
  <em class="image-caption">PCì—ì„œ ì ‘ì†í•œ í™”ë©´</em></p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="istio-ì†Œê°œ-1">Istio ì†Œê°œ</h3>

<ul>
  <li>
<strong>Istio</strong>ëŠ” ì„œë¹„ìŠ¤ ë©”ì‹œë¥¼ êµ¬ì¶•í•˜ê³  ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì˜¤í”ˆì†ŒìŠ¤ í”Œë«í¼ì…ë‹ˆë‹¤.</li>
  <li>
<strong>Istioì˜ êµ¬ì„±</strong>
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_3.svg" alt="20241019_kans_w7_3.svg" class="image-center w-80" loading="lazy" width="680" height="475">
    <ul>
      <li>íŒŒì¼ëŸ¿(Pilot) : ëª¨ë“  Envoy ì‚¬ì´ë“œì¹´ì—ì„œ í”„ë¡ì‹œ ë¼ìš°íŒ… ê·œì¹™ì„ ê´€ë¦¬í•˜ë©°, ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬, ë¡œë“œë°¸ëŸ°ì‹± ì„¤ì •ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
      <li>ê²”ë¦¬(Galley) : Istioì™€ ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì—°ê²°í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ë©”ì‹œ êµ¬ì„± ë°ì´í„°ë¥¼ ê²€ì¦í•˜ê³  ë³€í™˜í•©ë‹ˆë‹¤.</li>
      <li>ì‹œíƒ€ë¸(Citadel) : ì„œë¹„ìŠ¤ ê°„ì˜ ì¸ì¦ê³¼ ë³´ì•ˆì„ ê´€ë¦¬í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ê°„ì˜ TLS í†µì‹ ì„ ì œê³µí•˜ê³ , ì„œë¹„ìŠ¤ ê°„ì˜ ì¸ì¦ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Istioì˜ êµ¬ì„±ìš”ì†Œ
    <ul>
      <li>istiod : Istioì˜ ì¤‘ì•™ ì œì–´ í”Œë ˆì¸ìœ¼ë¡œ, Pilot, Citadel, Galleyë¥¼ í¬í•¨í•©ë‹ˆë‹¤.</li>
      <li>istio proxy : Envoy ê¸°ë°˜ì˜ í”„ë¡ì‹œë¡œ, istiodì™€ í†µì‹ í•˜ë©°, ì„œë¹„ìŠ¤ íŠ¸ë˜í”½ì„ í†µì œí•˜ê³  ì˜µì €ë¹Œë¦¬í‹°ë¥¼ ìœ„í•œ ë©”íŠ¸ë¦­ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>íŠ¹ì§•
    <ul>
      <li>IstioëŠ” ê° íŒŒë“œì•ˆì—ì„œ ì‚¬ì´ë“œì¹´ë¡œ ë™ì‘í•˜ëŠ” Envoyê°€ íŠ¸ë˜í”½ì„ ì œì–´í•˜ê³  ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.</li>
      <li>ëª¨ë“  ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ê°„ í†µì‹ ì€ Envoyë¥¼ í†µí•´ ì´ë£¨ì–´ì§€ë©°, ì´ë¥¼ í†µí•´ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ê±°ë‚˜ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>íŠ¸ë˜í”½ì„ ì»¨íŠ¸ë¡¤ í•˜ê¸° ìœ„í•´ì„œ Envoy í”„ë¡ì‹œì— ì „ì†¡ë£°ì„ ì •ì˜ í•©ë‹ˆë‹¤.</li>
      <li>ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ê°„ì˜ í†µì‹ ì„ mutual TLS ì¸ì¦(mTLS)ì„ í†µí•´ ë³´ì•ˆí•©ë‹ˆë‹¤.</li>
      <li>ê° ì–´í”Œë¦¬ì¼€ì´ì…˜ì€ íŒŒë“œ ë‚´ì˜ ì—”ë³´ì´ í”„ë¡ì‹œì— ì ‘ì†í•˜ê¸° ìœ„í•´ localhostì— TCP ì ‘ì†ì„ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="istio-ì„¤ì¹˜-sidecar-ëª¨ë“œ">Istio ì„¤ì¹˜ (Sidecar ëª¨ë“œ)</h3>

<ul>
  <li>Istio ê³µì‹ ë¬¸ì„œ : <a href="https://istio.io/latest/docs/">Link</a>
    <ul>
      <li>Istio Sidecar mode ì„¤ì¹˜ : v1.23.2 - 
<a href="https://istio.io/latest/docs/releases/supported-releases/#support-status-of-istio-releases">ë²„ì „</a>
<a href="https://istio.io/latest/docs/setup/getting-started/">ì„¤ì¹˜</a>,</li>
      <li>without GwApi - <a href="https://istio.io/latest/docs/setup/additional-setup/getting-started-istio-apis/">Docs</a>
</li>
      <li>Operator ë°©ì‹ ì„¤ì¹˜ : https://istio.io/latest/docs/setup/install/operator/ (Istio OperatorëŠ” <strong>Deprecated</strong> ë˜ì—ˆìŠµë‹ˆë‹¤.)</li>
    </ul>
  </li>
  <li>Istio ì„¤ì¹˜
```bash</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># istioctl ì„¤ì¹˜</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">ISTIOV</span><span class="o">=</span>1.23.2
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export ISTIOV=1.23.2"</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-L</span> https://istio.io/downloadIstio | <span class="nv">ISTIO_VERSION</span><span class="o">=</span><span class="nv">$ISTIOV</span> <span class="nv">TARGET_ARCH</span><span class="o">=</span>x86_64 sh -
<span class="nv">$ </span>tree istio-<span class="nv">$ISTIOV</span> <span class="nt">-L</span> 2 <span class="c"># sample yaml í¬í•¨</span>
<span class="c"># =&gt; istio-1.23.2</span>
<span class="c">#    â”œâ”€â”€ LICENSE</span>
<span class="c">#    â”œâ”€â”€ README.md</span>
<span class="c">#    â”œâ”€â”€ bin</span>
<span class="c">#    â”‚   â””â”€â”€ istioctl</span>
<span class="c">#    â”œâ”€â”€ manifest.yaml</span>
<span class="c">#    â”œâ”€â”€ manifests</span>
<span class="c">#    â”‚   â”œâ”€â”€ charts</span>
<span class="c">#    â”‚   â””â”€â”€ profiles</span>
<span class="c">#    â”œâ”€â”€ samples</span>
<span class="c">#    â”‚   ...</span>
<span class="c">#    â””â”€â”€ tools</span>
<span class="c">#        â”œâ”€â”€ _istioctl</span>
<span class="c">#        â”œâ”€â”€ certs</span>
<span class="c">#        â””â”€â”€ istioctl.bash</span>
<span class="nv">$ </span><span class="nb">cp </span>istio-<span class="nv">$ISTIOV</span>/bin/istioctl /usr/local/bin/istioctl
<span class="nv">$ </span>istioctl version <span class="nt">--remote</span><span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; client version: 1.23.2</span>

<span class="c"># (demo í”„ë¡œíŒŒì¼) ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë°°í¬ - ë§í¬ Customizing</span>
<span class="c"># The istioctl command supports the full IstioOperator API via command-line options for individual settings or for passing a yaml file containing an IstioOperator custom resource (CR).</span>
<span class="nv">$ </span>istioctl profile list
<span class="c"># =&gt; Istio configuration profiles:</span>
<span class="c">#        ambient</span>
<span class="c">#        default</span>
<span class="c">#        demo</span>
<span class="c">#        empty</span>
<span class="c">#        minimal</span>
<span class="c">#        openshift</span>
<span class="c">#        openshift-ambient</span>
<span class="c">#        preview</span>
<span class="c">#        remote</span>
<span class="c">#        stable</span>
<span class="nv">$ </span>istioctl profile dump default
<span class="nv">$ </span>istioctl profile dump <span class="nt">--config-path</span> components.ingressGateways
<span class="c"># =&gt; - enabled: true</span>
<span class="c">#      name: istio-ingressgateway</span>
<span class="nv">$ </span>istioctl profile dump <span class="nt">--config-path</span> values.gateways.istio-ingressgateway
<span class="c"># =&gt; {}</span>
<span class="nv">$ </span>istioctl profile dump demo
<span class="c"># =&gt; apiVersion: install.istio.io/v1alpha1</span>
<span class="c">#    kind: IstioOperator</span>
<span class="c">#    spec:</span>
<span class="c">#      components:</span>
<span class="c">#        base:</span>
<span class="c">#          enabled: true</span>
<span class="c">#        egressGateways:</span>
<span class="c">#        - enabled: true</span>
<span class="c">#          name: istio-egressgateway</span>
<span class="c">#        ingressGateways:</span>
<span class="c">#        - enabled: true</span>
<span class="c">#          name: istio-ingressgateway</span>
<span class="c">#        pilot:</span>
<span class="c">#          enabled: true</span>
<span class="c">#      hub: docker.io/istio</span>
<span class="c">#      profile: demo</span>
<span class="c">#      tag: 1.23.2</span>
<span class="c">#      values:</span>
<span class="c">#        defaultRevision: &amp;quot;&amp;quot;</span>
<span class="c">#        gateways:</span>
<span class="c">#          istio-egressgateway: {}</span>
<span class="c">#          istio-ingressgateway: {}</span>
<span class="c">#        global:</span>
<span class="c">#          configValidation: true</span>
<span class="c">#          istioNamespace: istio-system</span>
<span class="c">#        profile: demo</span>

<span class="nv">$ </span>istioctl profile dump demo <span class="o">&gt;</span> demo-profile.yaml
<span class="nv">$ </span>vi demo-profile.yaml <span class="c"># ë³µì¡ì„±ì„ ì¤„ì´ê²Œ ì‹¤ìŠµ ì‹œë‚˜ë¦¬ì˜¤ í™˜ê²½ ë§ì¶¤</span>
<span class="nt">--------------------</span>
    egressGateways:
    - enabled: <span class="nb">false</span>
<span class="nt">--------------------</span>    

<span class="nv">$ </span>istioctl <span class="nb">install</span> <span class="nt">-f</span> demo-profile.yaml <span class="nt">-y</span>
<span class="c"># =&gt; âœ” Istio core installed â›µï¸</span>
<span class="c">#    âœ” Istiod installed ğŸ§ </span>
<span class="c">#    âœ” Ingress gateways installed ğŸ›¬</span>
<span class="c">#    âœ” Installation complete</span>
<span class="c">#    Made this installation the default for cluster-wide operations.</span>

<span class="c"># ì„¤ì¹˜ í™•ì¸ : istiod, istio-ingressgateway</span>
<span class="nv">$ </span>kubectl get all,svc,ep,sa,cm,secret,pdb <span class="nt">-n</span> istio-system
<span class="c"># =&gt; NAME                                        READY   STATUS    RESTARTS      AGE</span>
<span class="c">#    pod/istio-ingressgateway-5f9f654d46-l7mqp   1/1     Running   0             14m</span>
<span class="c">#    pod/istiod-7f8b586864-8mc4c                 1/1     Running   1 (82s ago)   14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                           TYPE           CLUSTER-IP      EXTERNAL-IP                                    PORT(S)                                                                      AGE</span>
<span class="c">#    service/istio-ingressgateway   LoadBalancer   10.10.200.171   192.168.10.101,192.168.10.102,192.168.10.103   15021:30953/TCP,80:31677/TCP,443:30737/TCP,31400:30617/TCP,15443:31668/TCP   14m</span>
<span class="c">#    service/istiod                 ClusterIP      10.10.200.215   &amp;lt;none&amp;gt;                                         15010/TCP,15012/TCP,443/TCP,15014/TCP                                        14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/istio-ingressgateway   1/1     1            1           14m</span>
<span class="c">#    deployment.apps/istiod                 1/1     1            1           14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                                              DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/istio-ingressgateway-5f9f654d46   1         1         1       14m</span>
<span class="c">#    replicaset.apps/istiod-7f8b586864                 1         1         1       14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                             ENDPOINTS                                                           AGE</span>
<span class="c">#    endpoints/istio-ingressgateway   172.16.2.14:15443,172.16.2.14:15021,172.16.2.14:31400 + 2 more...   14m</span>
<span class="c">#    endpoints/istiod                 172.16.3.16:15012,172.16.3.16:15010,172.16.3.16:15017 + 1 more...   14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                  SECRETS   AGE</span>
<span class="c">#    serviceaccount/istio-ingressgateway-service-account   0         14m</span>
<span class="c">#    serviceaccount/istio-reader-service-account           0         14m</span>
<span class="c">#    serviceaccount/istiod                                 0         14m</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAME                                            DATA   AGE</span>
<span class="c">#    configmap/istio                                 2      14m</span>
<span class="c">#    configmap/istio-sidecar-injector                2      14m</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAME                     TYPE               DATA   AGE</span>
<span class="c">#    secret/istio-ca-secret   istio.io/ca-root   5      14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                                              MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE</span>
<span class="c">#    poddisruptionbudget.policy/istio-ingressgateway   1               N/A               0                     14m</span>
<span class="c">#    poddisruptionbudget.policy/istiod                 1               N/A               0                     14m</span>
<span class="nv">$ </span>kubectl get crd | <span class="nb">grep </span>istio.io | <span class="nb">sort</span>
<span class="c"># =&gt; authorizationpolicies.security.istio.io      2024-10-01T05:26:47Z</span>
<span class="c">#    destinationrules.networking.istio.io         2024-10-01T05:26:47Z</span>
<span class="c">#    envoyfilters.networking.istio.io             2024-10-01T05:26:47Z</span>
<span class="c">#    gateways.networking.istio.io                 2024-10-01T05:26:47Z</span>
<span class="c">#    peerauthentications.security.istio.io        2024-10-01T05:26:47Z</span>
<span class="c">#    proxyconfigs.networking.istio.io             2024-10-01T05:26:47Z</span>
<span class="c">#    requestauthentications.security.istio.io     2024-10-01T05:26:47Z</span>
<span class="c">#    serviceentries.networking.istio.io           2024-10-01T05:26:47Z</span>
<span class="c">#    sidecars.networking.istio.io                 2024-10-01T05:26:47Z</span>
<span class="c">#    telemetries.telemetry.istio.io               2024-10-01T05:26:48Z</span>
<span class="c">#    virtualservices.networking.istio.io          2024-10-01T05:26:48Z</span>
<span class="c">#    wasmplugins.extensions.istio.io              2024-10-01T05:26:48Z</span>
<span class="c">#    workloadentries.networking.istio.io          2024-10-01T05:26:48Z</span>
<span class="c">#    workloadgroups.networking.istio.io           2024-10-01T05:26:48Z</span>

<span class="c"># istio-ingressgateway ì˜ envoy ë²„ì „ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">-c</span> istio-proxy <span class="nt">--</span> envoy <span class="nt">--version</span>
<span class="c"># =&gt; envoy  version: 6c72b2179f5a58988b920a55b0be8346de3f7b35/1.31.2-dev/Clean/RELEASE/BoringSSL</span>

<span class="c"># istio-ingressgateway ì„œë¹„ìŠ¤ NodePortë¡œ ë³€ê²½</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> istio-system istio-ingressgateway <span class="nt">-p</span> <span class="s1">'{"spec":{"type":"NodePort"}}'</span>
<span class="c"># =&gt; service/istio-ingressgateway patched</span>

<span class="c"># istio-ingressgateway ì„œë¹„ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> istio-system istio-ingressgateway
<span class="c"># =&gt; NAME                           TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE</span>
<span class="c">#    service/istio-ingressgateway   NodePort   10.10.200.171   &amp;lt;none&amp;gt;        15021:30953/TCP,80:31677/TCP,443:30737/TCP,31400:30617/TCP,15443:31668/TCP   16m</span>
<span class="c">#    </span>
<span class="c">#    NAME                             ENDPOINTS                                                           AGE</span>
<span class="c">#    endpoints/istio-ingressgateway   172.16.2.14:15443,172.16.2.14:15021,172.16.2.14:31400 + 2 more...   16m</span>

<span class="c">## istio-ingressgateway ì„œë¹„ìŠ¤ í¬íŠ¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> istio-system istio-ingressgateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[<span class="k">*</span><span class="o">]}</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;name&amp;quot;: &amp;quot;https&amp;quot;,</span>
<span class="c">#      &amp;quot;nodePort&amp;quot;: 30737,</span>
<span class="c">#      &amp;quot;port&amp;quot;: 443,</span>
<span class="c">#      &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;,</span>
<span class="c">#      &amp;quot;targetPort&amp;quot;: 8443</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;name&amp;quot;: &amp;quot;tcp&amp;quot;,</span>
<span class="c">#      &amp;quot;nodePort&amp;quot;: 30617,</span>
<span class="c">#      &amp;quot;port&amp;quot;: 31400,</span>
<span class="c">#      &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;,</span>
<span class="c">#      &amp;quot;targetPort&amp;quot;: 31400</span>
<span class="c">#    }</span>
<span class="c">#    ...</span>

<span class="c">## istio-ingressgateway ë””í”Œë¡œì´ë¨¼íŠ¸ íŒŒë“œì˜ í¬íŠ¸ ì •ë³´ í™•ì¸ </span>
<span class="nv">$ </span>kubectl get deploy/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.template.spec.containers[0].ports[<span class="k">*</span><span class="o">]}</span> | jq
<span class="c"># =&gt; ...</span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;containerPort&amp;quot;: 8443,</span>
<span class="c">#      &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      &amp;quot;containerPort&amp;quot;: 31400,</span>
<span class="c">#      &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;</span>
<span class="c">#    }</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get deploy/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.template.spec.containers[0].readinessProbe<span class="o">}</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;failureThreshold&amp;quot;: 30,</span>
<span class="c">#      &amp;quot;httpGet&amp;quot;: {</span>
<span class="c">#        &amp;quot;path&amp;quot;: &amp;quot;/healthz/ready&amp;quot;,</span>
<span class="c">#        &amp;quot;port&amp;quot;: 15021,</span>
<span class="c">#        &amp;quot;scheme&amp;quot;: &amp;quot;HTTP&amp;quot;</span>
<span class="c">#      },</span>
<span class="c">#      &amp;quot;initialDelaySeconds&amp;quot;: 1,</span>
<span class="c">#      &amp;quot;periodSeconds&amp;quot;: 2,</span>
<span class="c">#      &amp;quot;successThreshold&amp;quot;: 1,</span>
<span class="c">#      &amp;quot;timeoutSeconds&amp;quot;: 1</span>
<span class="c">#    }</span>

<span class="c"># istiod(ì»¨íŠ¸ë¡¤í”Œë ˆì¸) ë””í”Œë¡œì´ë¨¼íŠ¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-tnlp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-tnp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ps <span class="nt">-ef</span>
<span class="c"># =&gt; UID          PID    PPID  C STIME TTY          TIME CMD</span>
<span class="c">#    istio-p+       1       0  0 05:39 ?        00:00:01 /usr/local/bin/pilot-discovery discovery --monitoringAddr=:15014 --log_output_level=default:info --domain cluster.local --ke</span>

<span class="c"># istio-ingressgateway ë””í”Œë¡œì´ë¨¼íŠ¸ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-tnlp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-tnp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> ps <span class="nt">-ef</span>
<span class="c"># =&gt; UID          PID    PPID  C STIME TTY          TIME CMD</span>
<span class="c">#    istio-p+       1       0  0 05:27 ?        00:00:08 /usr/local/bin/pilot-agent proxy router --domain istio-system.svc.cluster.local</span>
<span class="c">#    istio-p+      16       1  0 05:27 ?        00:00:04 /usr/local/bin/envoy -c etc/istio/proxy/envoy-rev.json --drain-time-s 45 --drai</span>
<span class="c"># # &lt;span style="color: green;"&gt;ğŸ‘‰ pilot-agentì™€ envoyê°€ ë™ì‘ ì¤‘ì…ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># envoy ì„¤ì • í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> <span class="nb">cat</span> /etc/istio/proxy/envoy-rev.json
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-xnlp</span>
<span class="c"># =&gt; Netid      State       Recv-Q      Send-Q                                          Local Address:Port              Peer Address:Port      Process</span>
<span class="c">#    u_str      LISTEN      0           4096               var/run/secrets/workload-spiffe-uds/socket 32430                        * 0          users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=9))</span>
<span class="c">#    u_str      LISTEN      0           4096                                      etc/istio/proxy/XDS 32431                        * 0          users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=10))</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment.apps/istio-ingressgateway <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-xnp</span>
<span class="c"># =&gt; Netid State Recv-Q Send-Q                              Local Address:Port  Peer Address:Port Process</span>
<span class="c">#    u_str ESTAB 0      0                                               * 39978            * 37977 users:((&amp;quot;envoy&amp;quot;,pid=16,fd=19))</span>
<span class="c">#    u_str ESTAB 0      0                                               * 37501            * 37981 users:((&amp;quot;envoy&amp;quot;,pid=16,fd=32))</span>
<span class="c">#    u_str ESTAB 0      0                             etc/istio/proxy/XDS 37977            * 39978 users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=11))</span>
<span class="c">#    u_str ESTAB 0      0      var/run/secrets/workload-spiffe-uds/socket 37981            * 37501 users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=15))</span>
</code></pre></div></div>

<ul>
  <li>Auto Injection with namespace label</li>
  <li>
    <p>í•´ë‹¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìƒì„±ë˜ëŠ” ëª¨ë“  íŒŒë“œë“¤ì€ istio ì‚¬ì´ë“œì¹´ê°€ ìë™ìœ¼ë¡œ injection ë©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># mutating Webhook admisstion controller ì‚¬ìš©</span>
<span class="nv">$ </span>kubectl label namespace default istio-injection<span class="o">=</span>enabled
<span class="c"># =&gt; namespace/default labeled</span>
<span class="nv">$ </span>kubectl get ns <span class="nt">-L</span> istio-injection
<span class="c"># =&gt; NAME              STATUS   AGE     ISTIO-INJECTION</span>
<span class="c">#    default           Active   7d      enabled</span>
<span class="c">#    ...</span>
</code></pre></div>    </div>

    <p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_8.png" alt="img.png" class="image-center" loading="lazy" width="751" height="474"></p>
  </li>
  <li>Istio ì ‘ì† í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ë³€ìˆ˜ ì§€ì • ë° k3s-mì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k3s-m)</span>
<span class="c"># istio ingress gw NodePort(HTTP ì ‘ì†ìš©) ë³€ìˆ˜ ì§€ì • </span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">IGWHTTP</span><span class="o">=</span><span class="si">$(</span>kubectl get service <span class="nt">-n</span> istio-system istio-ingressgateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[1].nodePort}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; 31677</span>

<span class="c"># /etc/hosts íŒŒì¼ ìˆ˜ì •</span>
<span class="c"># $ MYDOMAIN=&lt;ê°ì ìì‹ ì˜ www ë„ë©”ì¸&gt; # ë‹¨, ì‚¬ìš©í•˜ê³  ìˆì§€ ì•ŠëŠ” ê³µì¸ ë„ë©”ì¸ì„ ì‚¬ìš© í•  ê²ƒ</span>
<span class="c"># $ echo "&lt;istio-ingressgateway íŒŒë“œê°€ ìˆëŠ” ì›Œì»¤ ë…¸ë“œ&gt; $MYDOMAIN" &gt;&gt; /etc/hosts</span>

<span class="nv">$ </span><span class="nb">export </span><span class="nv">MYDOMAIN</span><span class="o">=</span>sweetlittlebird.com
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"192.168.10.10 </span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"export MYDOMAIN=</span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile

<span class="c"># istio ingress gw ì ‘ì† í…ŒìŠ¤íŠ¸ : ì•„ì§ì€ ì„¤ì •ì´ ì—†ì–´ì„œ ì ‘ì† ì‹¤íŒ¨ê°€ ë©ë‹ˆë‹¤.</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; *   Trying 192.168.10.10:31677...</span>
<span class="c">#    * connect to 192.168.10.10 port 31677 failed: Connection refused</span>
<span class="c">#    * Failed to connect to sweetlittlebird.com port 31677 after 3 ms: Connection refused</span>
<span class="c">#    * Closing connection 0</span>
</code></pre></div></div>

<ul>
  <li>testpcì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì•„ë˜ ë³€ìˆ˜ëŠ” ê°ì ìì‹ ì˜ ê°’ì„ ì§ì ‘ ì…ë ¥ í•  ê²ƒ</span>
<span class="c"># $ IGWHTTP=&lt;ê°ì ì¶œë ¥ëœ NodePort&gt;</span>
<span class="nv">$ IGWHTTP</span><span class="o">=</span>31677
<span class="nv">$ </span><span class="nb">export </span><span class="nv">MYDOMAIN</span><span class="o">=</span>sweetlittlebird.com
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"192.168.10.10 </span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"export MYDOMAIN=</span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile

<span class="c"># istio ingress gw ì ‘ì† í…ŒìŠ¤íŠ¸ : ì•„ì§ì€ ì„¤ì •ì´ ì—†ì–´ì„œ ì ‘ì† ì‹¤íŒ¨ê°€ ëœë‹¤</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; * Host sweetlittlebird.com:31677 was resolved.</span>
<span class="c">#    * ...</span>
<span class="c">#    * Failed to connect to sweetlittlebird.com port 31677 after 2 ms: Couldn't connect to server</span>
<span class="c">#    * ...</span>
</code></pre></div></div>

<ul>
  <li>ìì‹ ì˜ pcì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì•„ë˜ ë³€ìˆ˜ëŠ” ê°ì ìì‹ ì˜ ê°’ì„ ì§ì ‘ ì…ë ¥ í•  ê²ƒ</span>
<span class="c"># $ IGWHTTP=&lt;ê°ì ì¶œë ¥ëœ NodePort&gt;</span>
<span class="nv">$ IGWHTTP</span><span class="o">=</span>31677
<span class="c"># $ ISTIONODEIP=&lt;k3s-m ì˜ ìœ ë™ ê³µì¸ IP&gt;</span>
<span class="nv">$ ISTIONODEIP</span><span class="o">=</span>54.123.42.212

<span class="nv">$ </span><span class="nb">export </span><span class="nv">MYDOMAIN</span><span class="o">=</span>sweetlittlebird.com
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"192.168.10.10 </span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"export MYDOMAIN=</span><span class="nv">$MYDOMAIN</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile

<span class="c"># istio ingress gw ì ‘ì† í…ŒìŠ¤íŠ¸ : ì•„ì§ì€ ì„¤ì •ì´ ì—†ì–´ì„œ ì ‘ì† ì‹¤íŒ¨ê°€ ëœë‹¤</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; * Host sweetlittlebird.com:31677 was resolved.</span>
<span class="c">#    * ...</span>
<span class="c">#    * Failed to connect to sweetlittlebird.com port 31677 after 2 ms: Couldn't connect to server</span>
<span class="c">#    * ...</span>
</code></pre></div></div>

<h3 id="istioë¥¼-í†µí•œ-ì™¸ë¶€-ë…¸ì¶œ">Istioë¥¼ í†µí•œ ì™¸ë¶€ ë…¸ì¶œ</h3>

<ul>
  <li>Nginx ë””í”Œë¡œì´ë¨¼íŠ¸ì™€ ì„œë¹„ìŠ¤ ë°°í¬</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë¡œê·¸ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> istio-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>istiod
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS      AGE</span>
<span class="c">#    istiod-7f8b586864-8mc4c   1/1     Running   1 (60m ago)   73m</span>
<span class="nv">$ </span>kubetail <span class="nt">-n</span> istio-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>istiod <span class="nt">-f</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> istio-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>istio-ingressgateway
<span class="c"># =&gt; NAME                                    READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    istio-ingressgateway-5f9f654d46-l7mqp   1/1     Running   0          74m</span>
<span class="nv">$ </span>kubetail <span class="nt">-n</span> istio-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>istio-ingressgateway <span class="nt">-f</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kans-nginx
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-websrv
spec:
  replicas: 1
  selector:
    matchLabels:
      app: deploy-websrv
  template:
    metadata:
      labels:
        app: deploy-websrv
    spec:
      serviceAccountName: kans-nginx
      terminationGracePeriodSeconds: 0
      containers:
      - name: deploy-websrv
        image: nginx:alpine
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: svc-clusterip
spec:
  ports:
    - name: svc-webport
      port: 80
      targetPort: 80
  selector:
    app: deploy-websrv
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; serviceaccount/kans-nginx created</span>
<span class="c">#    deployment.apps/deploy-websrv created</span>
<span class="c">#    service/svc-clusterip created</span>

<span class="c"># ì‚¬ì´ë“œì¹´ ì»¨í…Œì´ë„ˆ ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod,svc,ep,sa <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                                 READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/deploy-websrv-778ffd6947-cxf5k   2/2     Running   0          50s   172.16.1.13   k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE     SELECTOR</span>
<span class="c">#    service/kubernetes      ClusterIP   10.10.200.1     &amp;lt;none&amp;gt;        443/TCP   6d16h   &amp;lt;none&amp;gt;</span>
<span class="c">#    service/svc-clusterip   ClusterIP   10.10.200.243   &amp;lt;none&amp;gt;        80/TCP    50s     app=deploy-websrv</span>
<span class="c">#    </span>
<span class="c">#    NAME                      ENDPOINTS            AGE</span>
<span class="c">#    endpoints/kubernetes      192.168.10.10:6443   6d16h</span>
<span class="c">#    endpoints/svc-clusterip   172.16.1.13:80       50s</span>
<span class="c">#    </span>
<span class="c">#    NAME                        SECRETS   AGE</span>
<span class="c">#    serviceaccount/default      0         7d1h</span>
<span class="c">#    serviceaccount/kans-nginx   0         50s</span>

<span class="nv">$ </span>kubectl describe pod
<span class="c"># =&gt; Name:             deploy-websrv-778ffd6947-cxf5k</span>
<span class="c">#    Namespace:        default</span>
<span class="c">#    Priority:         0</span>
<span class="c">#    Service Account:  kans-nginx</span>
<span class="c">#    Node:             k3s-w2/192.168.10.102</span>
<span class="c">#    Labels:           app=deploy-websrv</span>
<span class="c">#                      security.istio.io/tlsMode=istio</span>
<span class="c">#                      ...</span>
<span class="c">#    Annotations:      istio.io/rev: default</span>
<span class="c">#                      sidecar.istio.io/status:</span>
<span class="c">#                        {&amp;quot;initContainers&amp;quot;:[&amp;quot;istio-init&amp;quot;],&amp;quot;containers&amp;quot;:[&amp;quot;istio-proxy&amp;quot;],&amp;quot;volumes&amp;quot;:[&amp;quot;workload-socket&amp;quot;,&amp;quot;credential-socket&amp;quot;,&amp;quot;workload-certs&amp;quot;,&amp;quot;istio-env...</span>
<span class="c">#    Status:           Running</span>
<span class="c">#    ...</span>
<span class="c">#    Controlled By:  ReplicaSet/deploy-websrv-778ffd6947</span>
<span class="c">#    &lt;span style="color: red;"&gt;Init Containers:&lt;/span&gt;  # &lt;span style="color: green;"&gt;ğŸ‘‰ init containerê°€ íŒŒë“œë‚´ iptables ì…‹íŒ…&lt;/span&gt;</span>
<span class="c">#      istio-init:</span>
<span class="c">#        Container ID:  containerd://2a114fe0624581b35bda9ca257c6d3c831138e8a44900a6130e988bb51eb05da</span>
<span class="c">#        Image:         docker.io/istio/proxyv2:1.23.2</span>
<span class="c">#        Image ID:      docker.io/istio/proxyv2@sha256:2876cfc2fdf47e4b9665390ccc9ccf2bf913b71379325b8438135c9f35578e1a</span>
<span class="c">#        Port:          &amp;lt;none&amp;gt;</span>
<span class="c">#        Host Port:     &amp;lt;none&amp;gt;</span>
<span class="c">#        Args:</span>
<span class="c">#          &lt;span style="color: red;"&gt;istio-iptables&lt;/span&gt;</span>
<span class="c">#          -p</span>
<span class="c">#          15001</span>
<span class="c">#          -z</span>
<span class="c">#          15006</span>
<span class="c">#          -u</span>
<span class="c">#          1337</span>
<span class="c">#          -m</span>
<span class="c">#          REDIRECT</span>
<span class="c">#          -i</span>
<span class="c">#          *</span>
<span class="c">#          -x</span>
<span class="c">#    </span>
<span class="c">#          -b</span>
<span class="c">#          *</span>
<span class="c">#          -d</span>
<span class="c">#          15090,15021,15020</span>
<span class="c">#          --log_output_level=default:info</span>
<span class="c">#        State:          Terminated</span>
<span class="c">#          Reason:       Completed</span>
<span class="c">#        ...</span>
<span class="c">#    Containers:</span>
<span class="c">#      deploy-websrv:</span>
<span class="c">#        Container ID:   containerd://8918e0bb760bce8d090e84818bc189ae3ababdf9e74eb7dd3fb9709b356891f9</span>
<span class="c">#        Image:          nginx:alpine</span>
<span class="c">#        ...</span>
<span class="c">#      &lt;span style="color: red;"&gt;istio-proxy:&lt;/span&gt;  # &lt;span style="color: green;"&gt;ğŸ‘‰ istio-proxyë¼ëŠ” ì»¨í…Œì´ë„ˆê°€ sidecarë¡œ ë™ì‘ ì¤‘&lt;/span&gt;</span>
<span class="c">#        Container ID:  containerd://71d9e07a530dfce2ec34810d60a28dc3f9445b8eab714c2a7e204c459c59bcd3</span>
<span class="c">#        Image:         docker.io/istio/proxyv2:1.23.2</span>
<span class="c">#        Image ID:      docker.io/istio/proxyv2@sha256:2876cfc2fdf47e4b9665390ccc9ccf2bf913b71379325b8438135c9f35578e1a</span>
<span class="c">#        Port:          15090/TCP</span>
<span class="c">#        Host Port:     0/TCP</span>
<span class="c">#        Args:</span>
<span class="c">#          proxy</span>
<span class="c">#          sidecar</span>
<span class="c">#          --domain</span>
<span class="c">#          $(POD_NAMESPACE).svc.cluster.local</span>
<span class="c">#          --proxyLogLevel=warning</span>
<span class="c">#          --proxyComponentLogLevel=misc:error</span>
<span class="c">#          --log_output_level=default:info</span>
<span class="c">#        State:          Running</span>
<span class="c">#        ...</span>
</code></pre></div></div>

<ul>
  <li>Istio Gateway/VirtualService ì„¤ì • - Host ê¸°ë°˜ íŠ¸ë˜í”½ ë¼ìš°íŒ… ì„¤ì • <a href="https://istio.io/latest/docs/setup/additional-setup/gateway/">ë§í¬</a>
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_9.png" alt="img.png" class="image-center w-80" loading="lazy" width="714" height="353">
    <ul>
      <li>í´ë¼ì´ì–¸íŠ¸ PC â†’ (Service:NodePort) Istio ingressgateway íŒŒë“œ â†’ (Gateway, VirtualService, Service ëŠ” Bypass) â†’ Endpoint(íŒŒë“œ : ì‚¬ì´ë“œì¹´ - Application ì»¨í…Œì´ë„ˆ)</li>
      <li>Gateway : ì§€ì •í•œ ì¸ê·¸ë ˆìŠ¤ ê²Œì´íŠ¸ì›¨ì´ë¡œë¶€í„° íŠ¸ë˜í”½ì´ ì¸ì…, í”„ë¡œí† ì½œ ë° í¬íŠ¸, HOSTS, Proxy ë“± ì„¤ì • ê°€ëŠ¥ <a href="https://istio.io/latest/docs/setup/additional-setup/gateway/">ë§í¬</a>
</li>
      <li>VirtualService : ì¸ì… ì²˜ë¦¬í•  hosts ì„¤ì •, L7 PATH ë³„ ë¼ìš°íŒ…, ëª©ì ì§€ì— ëŒ€í•œ ì •ì±… ì„¤ì • ê°€ëŠ¥ (envoy route config)</li>
      <li>(ì°¸ê³ ) Introducing Istio v1 APIs - <a href="https://istio.io/latest/blog/2024/v1-apis/">Blog</a>
</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: test-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
---
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: nginx-service
spec:
  hosts:
  - "</span><span class="nv">$MYDOMAIN</span><span class="sh">"
  gateways:
  - test-gateway
  http:
  - route:
    - destination:
        host: svc-clusterip
        port:
          number: 80
</span><span class="no">EOF
</span><span class="c"># =&gt; gateway.networking.istio.io/test-gateway created</span>
<span class="c">#    virtualservice.networking.istio.io/nginx-service created</span>

<span class="c"># Istio Gateway(=gw)/VirtualService(=vs) ì„¤ì • ì •ë³´ë¥¼ í™•ì¸</span>
<span class="nv">$ </span>kubectl explain gateways.networking.istio.io
<span class="nv">$ </span>kubectl explain virtualservices.networking.istio.io
<span class="nv">$ </span>kubectl api-resources  | <span class="nb">grep </span>istio
<span class="c"># =&gt; wasmplugins                                      extensions.istio.io/v1alpha1      true         WasmPlugin</span>
<span class="c">#    destinationrules                    dr           networking.istio.io/v1            true         DestinationRule</span>
<span class="c">#    envoyfilters                                     networking.istio.io/v1alpha3      true         EnvoyFilter</span>
<span class="c">#    gateways                            gw           networking.istio.io/v1            true         Gateway</span>
<span class="c">#    proxyconfigs                                     networking.istio.io/v1beta1       true         ProxyConfig</span>
<span class="c">#    serviceentries                      se           networking.istio.io/v1            true         ServiceEntry</span>
<span class="c">#    sidecars                                         networking.istio.io/v1            true         Sidecar</span>
<span class="c">#    virtualservices                     vs           networking.istio.io/v1            true         VirtualService</span>
<span class="c">#    workloadentries                     we           networking.istio.io/v1            true         WorkloadEntry</span>
<span class="c">#    workloadgroups                      wg           networking.istio.io/v1            true         WorkloadGroup</span>
<span class="c">#    authorizationpolicies               ap           security.istio.io/v1              true         AuthorizationPolicy</span>
<span class="c">#    peerauthentications                 pa           security.istio.io/v1              true         PeerAuthentication</span>
<span class="c">#    requestauthentications              ra           security.istio.io/v1              true         RequestAuthentication</span>
<span class="c">#    telemetries                         telemetry    telemetry.istio.io/v1             true         Telemetry</span>

<span class="c"># virtual service ëŠ” ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ì„œë¹„ìŠ¤(ex. svc-nn.&lt;ns&gt;)ë„ ì°¸ì¡°í•  ìˆ˜ ìˆë‹¤</span>
<span class="nv">$ </span>kubectl get gw,vs
<span class="c"># =&gt; NAME                                       AGE</span>
<span class="c">#    gateway.networking.istio.io/test-gateway   105s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                               GATEWAYS           HOSTS                     AGE</span>
<span class="c">#    virtualservice.networking.istio.io/nginx-service   [&amp;quot;test-gateway&amp;quot;]   [&amp;quot;sweetlittlebird.com&amp;quot;]   105s</span>

<span class="c"># Retrieves last sent and last acknowledged xDS sync from Istiod to each Envoy in the mesh</span>
<span class="c"># istioctl proxy-status command was improved to include the time since last change, and more relevant status values.</span>
<span class="nv">$ </span>istioctl proxy-status <span class="c"># ë‹¨ì¶•ì–´ ps</span>
<span class="nv">$ </span>istioctl ps
<span class="c"># =&gt; NAME                                                   CLUSTER        CDS                LDS                EDS              RDS                ECDS        ISTIOD                      VERSION</span>
<span class="c">#    deploy-websrv-778ffd6947-cxf5k.default                 Kubernetes     SYNCED (22m)       SYNCED (22m)       SYNCED (22m)     SYNCED (22m)       IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    istio-ingressgateway-5f9f654d46-l7mqp.istio-system     Kubernetes     SYNCED (2m14s)     SYNCED (2m14s)     SYNCED (22m)     SYNCED (2m14s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
</code></pre></div></div>

<ul>
  <li>Istioë¥¼ í†µí•œ Nginx íŒŒë“œ ì ‘ì† í…ŒìŠ¤íŠ¸
    <ul>
      <li>ì™¸ë¶€ (ìì‹ ì˜ PC, test pc)ì—ì„œ ì ‘ì† í…ŒìŠ¤íŠ¸</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># istio ingress gw ë¥¼ í†µí•œ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span> | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
<span class="c"># =&gt; &lt;title&gt;Welcome to nginx!&lt;/title&gt;</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; * Host sweetlittlebird.com:31677 was resolved.</span>
<span class="c">#    * IPv6: (none)</span>
<span class="c">#    * IPv4: 192.168.10.10, 192.168.10.10</span>
<span class="c">#    *   Trying 192.168.10.10:31677...</span>
<span class="c">#    * Connected to sweetlittlebird.com (192.168.10.10) port 31677</span>
<span class="c">#    &amp;gt; GET / HTTP/1.1</span>
<span class="c">#    &amp;gt; Host: sweetlittlebird.com:31677</span>
<span class="c">#    &amp;gt; User-Agent: curl/8.5.0</span>
<span class="c">#    &amp;gt; Accept: */*</span>
<span class="c">#    &amp;gt;</span>
<span class="c">#    &amp;lt; HTTP/1.1 200 OK</span>
<span class="c">#    &amp;lt; server: istio-envoy</span>
<span class="c">#    &amp;lt; date: Sat, 19 Oct 2024 07:14:25 GMT</span>
<span class="c">#    &amp;lt; content-type: text/html</span>
<span class="c">#    &amp;lt; content-length: 615</span>
<span class="c">#    &amp;lt; last-modified: Wed, 02 Oct 2024 16:07:39 GMT</span>
<span class="c">#    &amp;lt; etag: &amp;quot;66fd6fcb-267&amp;quot;</span>
<span class="c">#    &amp;lt; accept-ranges: bytes</span>
<span class="c">#    &amp;lt; x-envoy-upstream-service-time: 1</span>
<span class="c">#    ...</span>
<span class="c"># $ curl -v -s &lt;ìœ ë™ê³µì¸ì´IP&gt;:$IGWHTTP</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> 54.123.42.212:<span class="nv">$IGWHTTP</span>
</code></pre></div></div>

<ul>
  <li>ì¶œë ¥ ë¡œê·¸ ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubetail <span class="nt">-n</span> istio-system <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>istio-ingressgateway <span class="nt">-f</span>
<span class="c"># =&gt; [istio-ingressgateway-5f9f654d46-l7mqp] [2024-10-01T07:49:20.833Z] &amp;quot;GET / HTTP/1.1&amp;quot; 200 - via_upstream - &amp;quot;-&amp;quot; 0 615 6 5 &amp;quot;172.16.0.0&amp;quot; &amp;quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&amp;quot; &amp;quot;6f246b4e-d675-971e-9a9d-dd809f560c6f&amp;quot; &amp;quot;sweetlittlebird.com:31677&amp;quot; &amp;quot;172.16.1.13:80&amp;quot; </span>
<span class="c">#    &lt;span style="color: red;"&gt;outbound|80||svc-clusterip.default.svc.cluster.local&lt;/span&gt; 172.16.2.14:60786 172.16.2.14:8080 172.16.0.0:8773 - -</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>deploy-websrv
<span class="c"># =&gt; [deploy-websrv-778ffd6947-cxf5k istio-proxy] [2024-10-01T07:49:20.866Z] &amp;quot;GET / HTTP/1.1&amp;quot; 200 - via_upstream - &amp;quot;-&amp;quot; 0 615 2 1 &amp;quot;172.16.0.0&amp;quot; &amp;quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15&amp;quot; &amp;quot;6f246b4e-d675-971e-9a9d-dd809f560c6f&amp;quot; &amp;quot;sweetlittlebird.com:31677&amp;quot; &amp;quot;172.16.1.13:80&amp;quot; </span>
<span class="c">#    &lt;span style="color: red;"&gt;inbound|80||&lt;/span&gt; 127.0.0.6:40337 172.16.1.13:80 172.16.0.0:0 invalid:outbound_.80_._.svc-clusterip.default.svc.cluster.local default</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_10.png" alt="img.png" class="image-center" loading="lazy" width="669" height="163"></p>

<ul>
  <li>istioctl ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>istioctl proxy-status
<span class="c"># =&gt; NAME                                                   CLUSTER        CDS              LDS              EDS              RDS              ECDS        ISTIOD                      VERSION</span>
<span class="c">#    deploy-websrv-778ffd6947-cxf5k.default                 Kubernetes     SYNCED (19m)     SYNCED (19m)     SYNCED (19m)     SYNCED (19m)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    istio-ingressgateway-5f9f654d46-l7mqp.istio-system     Kubernetes     SYNCED (24m)     SYNCED (24m)     SYNCED (24m)     SYNCED (24m)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>

<span class="c"># Envoy config dump : all, cluster, endpoint, listener ë“±</span>
<span class="nv">$ </span>istioctl proxy-config <span class="nt">--help</span> 
<span class="nv">$ </span>istioctl proxy-config all deploy-websrv-778ffd6947-cxf5k
<span class="nv">$ </span>istioctl proxy-config all deploy-websrv-778ffd6947-cxf5k <span class="nt">-o</span> json | jq
<span class="nv">$ </span>istioctl proxy-config route deploy-websrv-778ffd6947-cxf5k <span class="nt">-o</span> json | jq
</code></pre></div></div>

<ul>
  <li>pilot : istio-proxyë‚´ udsë¡œ envoyì™€ grpcí†µì‹ , istiodì—ì„œ ë°›ì•„ì˜¨ dynamic configë¥¼ envoyì— ì „ë‹¬</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># istio-proxy ì‚¬ìš©ì ì •ë³´ í™•ì¸ : uid(1337):gid(1337) í™•ì¸ -&gt; iptables rule ì—ì„œ ì‚¬ìš©ë¨</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> <span class="nb">tail</span> <span class="nt">-n</span> 3 /etc/passwd
<span class="c"># =&gt; ubuntu:x:1000:1000:Ubuntu:/home/ubuntu:/bin/bash</span>
<span class="c">#    tcpdump:x:100:102::/nonexistent:/usr/sbin/nologin</span>
<span class="c">#    istio-proxy:x:1337:1337::/home/istio-proxy:/bin/sh</span>

<span class="c"># envoy ì„¤ì • ì •ë³´ í™•ì¸ : dynamic_resources , static_resources - listeners  </span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> <span class="nb">cat</span> /etc/istio/proxy/envoy-rev.json
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> ss <span class="nt">-nlp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> ss <span class="nt">-np</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> netstat <span class="nt">-np</span>
<span class="c"># =&gt; Active Internet connections (w/o servers)</span>
<span class="c">#    Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span>
<span class="c">#    tcp        0      0 127.0.0.1:33168         127.0.0.1:15020         ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 127.0.0.1:33156         127.0.0.1:15020         ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 172.16.1.13:15006       172.16.2.14:33006       ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 172.16.1.13:59774       10.10.200.215:15012     ESTABLISHED 1/pilot-agent</span>
<span class="c">#    tcp        0      0 172.16.1.13:15006       172.16.2.14:60786       ESTABLISHED 13/envoy</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 172.16.1.13 : deploy-websrv íŒŒë“œ ip&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    172.16.2.14 : istio-ingressgateway íŒŒë“œ ip&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    10.10.200.215 : istiod ì„œë¹„ìŠ¤ì˜ Cluster-IP&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c">#    Active UNIX domain sockets (w/o servers)</span>
<span class="c">#    Proto RefCnt Flags       Type       State         I-Node   PID/Program name     Path</span>
<span class="c">#    unix  3      [ ]         STREAM     CONNECTED     54162    13/envoy</span>
<span class="c">#    unix  3      [ ]         STREAM     CONNECTED     54709    1/pilot-agent        var/run/secrets/workload-spiffe-uds/socket</span>
<span class="c">#    unix  3      [ ]         STREAM     CONNECTED     71034    1/pilot-agent        etc/istio/proxy/XDS</span>
<span class="c">#    unix  3      [ ]         STREAM     CONNECTED     72979    13/envoy</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> ps <span class="nt">-ef</span>
<span class="c"># =&gt; UID          PID    PPID  C STIME TTY          TIME CMD</span>
<span class="c">#    istio-p+       1       0  0 06:43 ?        00:00:01 /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --proxyLogLevel=warning --proxyComponentLogLevel=mi</span>
<span class="c">#    istio-p+      13       1  0 06:43 ?        00:00:34 /usr/local/bin/envoy -c etc/istio/proxy/envoy-rev.json --drain-time-s 45 --drain-strategy immediate --local-address-ip-version</span>

<span class="c"># </span>
<span class="nv">$ </span>kubectl get pod,svc <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE      NAME                                            READY   STATUS    RESTARTS        AGE     IP            NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    default        pod/deploy-websrv-778ffd6947-cxf5k              2/2     Running   0               91m     172.16.1.13   k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    istio-system   pod/istio-ingressgateway-5f9f654d46-l7mqp       1/1     Running   0               167m    172.16.2.14   k3s-w3   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    istio-system   pod/istiod-7f8b586864-8mc4c                     1/1     Running   1 (154m ago)    167m    172.16.3.16   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAMESPACE      NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE     SELECTOR</span>
<span class="c">#    default        service/kubernetes                           ClusterIP   10.10.200.1     &amp;lt;none&amp;gt;        443/TCP                                                                      6d17h   &amp;lt;none&amp;gt;</span>
<span class="c">#    default        service/svc-clusterip                        ClusterIP   10.10.200.243   &amp;lt;none&amp;gt;        80/TCP                                                                       91m     app=deploy-websrv</span>
<span class="c">#    istio-system   service/istio-ingressgateway                 NodePort    10.10.200.171   &amp;lt;none&amp;gt;        15021:30953/TCP,80:31677/TCP,443:30737/TCP,31400:30617/TCP,15443:31668/TCP   167m    app=istio-ingressgateway,istio=ingressgateway</span>
<span class="c">#    istio-system   service/istiod                               ClusterIP   10.10.200.215   &amp;lt;none&amp;gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP                                        167m    app=istiod,istio=pilot</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> netstat <span class="nt">-antp</span>
<span class="c"># =&gt; Active Internet connections (servers and established)</span>
<span class="c">#    Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span>
<span class="c">#    tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -</span>
<span class="c">#    ...</span>
<span class="c">#    tcp        0      0 127.0.0.1:33168         127.0.0.1:15020         ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 127.0.0.1:33156         127.0.0.1:15020         ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 172.16.1.13:15006       172.16.2.14:33006       ESTABLISHED 13/envoy</span>
<span class="c">#    tcp        0      0 172.16.1.13:59774       10.10.200.215:15012     ESTABLISHED 1/pilot-agent</span>
<span class="c">#    tcp        0      0 172.16.1.13:15006       172.16.2.14:60786       ESTABLISHED 13/envoy</span>
<span class="c">#    tcp6       0      0 127.0.0.1:15020         127.0.0.1:33168         ESTABLISHED 1/pilot-agent</span>
<span class="c">#    tcp6       0      0 127.0.0.1:15020         127.0.0.1:33156         ESTABLISHED 1/pilot-agent</span>

<span class="c"># istiod ì •ë³´ ê°™ì´ í™•ì¸ : ì¶œë ¥ë˜ëŠ” IPê°€ ëˆ„êµ¬ì¸ì§€ í™•ì¸ í•´ë³´ì</span>
<span class="nv">$ </span>kubectl get pod,svc <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ps <span class="nt">-ef</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> netstat <span class="nt">-antp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-nlp</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/istiod <span class="nt">-n</span> istio-system <span class="nt">--</span> ss <span class="nt">-np</span>
<span class="c"># =&gt; Netid  State  Recv-Q  Send-Q         Local Address:Port           Peer Address:Port   Process</span>
<span class="c">#    tcp    ESTAB  0       0                172.16.3.16:33552           10.10.200.1:443     users:((&amp;quot;pilot-discovery&amp;quot;,pid=1,fd=7))</span>
<span class="c">#    tcp    ESTAB  0       0       [::ffff:172.16.3.16]:15012  [::ffff:172.16.2.14]:37102   users:((&amp;quot;pilot-discovery&amp;quot;,pid=1,fd=13))</span>
<span class="c">#    tcp    ESTAB  0       0       [::ffff:172.16.3.16]:15012  [::ffff:172.16.1.13]:56560   users:((&amp;quot;pilot-discovery&amp;quot;,pid=1,fd=14))</span>
</code></pre></div></div>

<ul>
  <li>istio-proxy, istiodê°€ ê°ê° ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ ì •ë³´ <a href="https://istio.io/latest/docs/ops/deployment/application-requirements/">ë§í¬</a>
    <ul>
      <li>
        <p>istio-proxy</p>

        <table>
          <thead>
            <tr>
              <th>Port</th>
              <th>Protocol</th>
              <th>Description</th>
              <th>Pod-internal only</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>15000</td>
              <td>TCP</td>
              <td>Envoy admin port (commands/diagnostics)</td>
              <td>Yes</td>
            </tr>
            <tr>
              <td>15001</td>
              <td>TCP</td>
              <td>Envoy outbound</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15004</td>
              <td>HTTP</td>
              <td>Debug port</td>
              <td>Yes</td>
            </tr>
            <tr>
              <td>15006</td>
              <td>TCP</td>
              <td>Envoy inbound</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15008</td>
              <td>HTTP2</td>
              <td>HBONE mTLS tunnel port</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15020</td>
              <td>HTTP</td>
              <td>Merged Prometheus telemetry from Istio agent, Envoy, and application No</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15021</td>
              <td>HTTP</td>
              <td>Health checks</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15053</td>
              <td>DNS</td>
              <td>DNS port, if capture is enabled</td>
              <td>Yes</td>
            </tr>
            <tr>
              <td>15090</td>
              <td>HTTP</td>
              <td>Envoy Prometheus telemetry</td>
              <td>No</td>
            </tr>
          </tbody>
        </table>
      </li>
      <li>
        <p>istiod (ì»¨íŠ¸ë¡¤í”Œë ˆì¸)</p>

        <table>
          <thead>
            <tr>
              <th>Port</th>
              <th>Protocol</th>
              <th>Description</th>
              <th>Pod-internal only</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>443</td>
              <td>HTTPS</td>
              <td>Webhooks service port</td>
              <td>No</td>
            </tr>
            <tr>
              <td>8080</td>
              <td>HTTP</td>
              <td>Debug interface (deprecated, container port only)</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15010</td>
              <td>GRPC</td>
              <td>XDS and CA services (Plaintext, only for secure networks)</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15012</td>
              <td>GRPC</td>
              <td>XDS and CA services (TLS and mTLS, recommended for production use)</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15014</td>
              <td>HTTP</td>
              <td>Control plane monitoring</td>
              <td>No</td>
            </tr>
            <tr>
              <td>15017</td>
              <td>HTTPS</td>
              <td>Webhook container port, forwarded from 443</td>
              <td>No</td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>
  </li>
  <li>Istio - Istio proxyì™€ Envoy í”„ë¡œì„¸ìŠ¤ê°„ ìœ ë‹‰ìŠ¤ ë„ë©”ì¸ ì†Œì¼“ í†µì‹  í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    deploy-websrv-778ffd6947-cxf5k   2/2     Running   0          106m</span>

<span class="c"># istio ì»¨í…Œì´ë„ˆ ì ‘ì†</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deploy/deploy-websrv <span class="nt">-c</span> istio-proxy <span class="nt">--</span> bash
<span class="nt">---------------------------------------------------------------</span>
<span class="c"># SDS, XDS ëŠ” ì†Œì¼“ íƒ€ì…</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /etc/istio/proxy
<span class="c"># =&gt; total 24</span>
<span class="c">#    drwxrwxrwt 2 root        root          100 Oct 19 06:43 .</span>
<span class="c">#    drwxr-xr-x 4 root        root         4096 Oct 19 06:43 ..</span>
<span class="c">#    srw-rw-rw- 1 istio-proxy istio-proxy     0 Oct 19 06:43 XDS</span>
<span class="c">#    -rw-r--r-- 1 istio-proxy istio-proxy 13644 Oct 19 06:43 envoy-rev.json</span>
<span class="c">#    -rw-r--r-- 1 istio-proxy istio-proxy  2747 Oct 19 06:43 grpc-bootstrap.json</span>

<span class="c"># .json íŒŒì¼ í™•ì¸</span>
<span class="nv">$ </span>more /etc/istio/proxy/envoy-rev.json
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;node&amp;quot;: {</span>
<span class="c">#        &amp;quot;id&amp;quot;: &amp;quot;sidecar~172.16.1.13~deploy-websrv-778ffd6947-cxf5k.default~default.svc.cluster.local&amp;quot;,</span>
<span class="c">#        &amp;quot;cluster&amp;quot;: &amp;quot;deploy-websrv.default&amp;quot;,</span>
<span class="c">#    ...</span>
<span class="c">#      &amp;quot;admin&amp;quot;: {</span>
<span class="c">#        &amp;quot;access_log&amp;quot;: [</span>
<span class="c">#          {</span>
<span class="c">#            &amp;quot;name&amp;quot;: &amp;quot;envoy.access_loggers.file&amp;quot;,</span>
<span class="c">#            &amp;quot;typed_config&amp;quot;: {</span>
<span class="c">#              &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog&amp;quot;,</span>
<span class="c">#              &amp;quot;path&amp;quot;: &amp;quot;/dev/null&amp;quot;</span>
<span class="c">#            }</span>
<span class="c">#          }</span>
<span class="c">#        ],</span>
<span class="c">#        &amp;quot;profile_path&amp;quot;: &amp;quot;/var/lib/istio/data/envoy.prof&amp;quot;,</span>
<span class="c">#        &amp;quot;address&amp;quot;: {</span>
<span class="c">#          &amp;quot;socket_address&amp;quot;: {</span>
<span class="c">#            &amp;quot;address&amp;quot;: &amp;quot;127.0.0.1&amp;quot;,</span>
<span class="c">#            &amp;quot;port_value&amp;quot;: 15000</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      },</span>
<span class="c">#    ...</span>
<span class="c">#    &amp;quot;dynamic_resources&amp;quot;: {</span>
<span class="c">#        &amp;quot;lds_config&amp;quot;: {</span>
<span class="c">#          &amp;quot;ads&amp;quot;: {},</span>
<span class="c">#          &amp;quot;initial_fetch_timeout&amp;quot;: &amp;quot;0s&amp;quot;,</span>
<span class="c">#          &amp;quot;resource_api_version&amp;quot;: &amp;quot;V3&amp;quot;</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;cds_config&amp;quot;: {</span>
<span class="c">#          &amp;quot;ads&amp;quot;: {},</span>
<span class="c">#          &amp;quot;initial_fetch_timeout&amp;quot;: &amp;quot;0s&amp;quot;,</span>
<span class="c">#          &amp;quot;resource_api_version&amp;quot;: &amp;quot;V3&amp;quot;</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;ads_config&amp;quot;: {</span>
<span class="c">#          &amp;quot;api_type&amp;quot;: &amp;quot;GRPC&amp;quot;,</span>
<span class="c">#          &amp;quot;set_node_on_first_message_only&amp;quot;: true,</span>
<span class="c">#          &amp;quot;transport_api_version&amp;quot;: &amp;quot;V3&amp;quot;,</span>
<span class="c">#          &amp;quot;grpc_services&amp;quot;: [</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;envoy_grpc&amp;quot;: {</span>
<span class="c">#                &amp;quot;cluster_name&amp;quot;: &amp;quot;xds-grpc&amp;quot;</span>
<span class="c">#    ...</span>
<span class="c">#    &amp;quot;static_resources&amp;quot;: {</span>
<span class="c">#        &amp;quot;clusters&amp;quot;: [</span>
<span class="c">#          {</span>
<span class="c">#            ...</span>
<span class="c">#            &amp;quot;name&amp;quot;: &amp;quot;xds-grpc&amp;quot;,</span>
<span class="c">#            &amp;quot;alt_stat_name&amp;quot;: &amp;quot;xds-grpc;&amp;quot;,</span>
<span class="c">#            &amp;quot;type&amp;quot; : &amp;quot;STATIC&amp;quot;,</span>
<span class="c">#            &amp;quot;connect_timeout&amp;quot;: &amp;quot;1s&amp;quot;,</span>
<span class="c">#            &amp;quot;lb_policy&amp;quot;: &amp;quot;ROUND_ROBIN&amp;quot;,</span>
<span class="c">#            &amp;quot;load_assignment&amp;quot;: {</span>
<span class="c">#              &amp;quot;cluster_name&amp;quot;: &amp;quot;xds-grpc&amp;quot;,</span>
<span class="c">#              &amp;quot;endpoints&amp;quot;: [{</span>
<span class="c">#                &amp;quot;lb_endpoints&amp;quot;: [{</span>
<span class="c">#                  &amp;quot;endpoint&amp;quot;: {</span>
<span class="c">#                    &amp;quot;address&amp;quot;:{</span>
<span class="c">#                      &amp;quot;pipe&amp;quot;: {</span>
<span class="c">#                        &amp;quot;path&amp;quot;: &amp;quot;./etc/istio/proxy/XDS&amp;quot;</span>
<span class="c">#                      }</span>
<span class="c">#    ...</span>
<span class="c">#    &amp;quot;listeners&amp;quot;:[</span>
<span class="c">#      ...</span>
<span class="c">#      &amp;quot;address&amp;quot;: {</span>
<span class="c">#        &amp;quot;socket_address&amp;quot;: {</span>
<span class="c">#          &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;,</span>
<span class="c">#          &amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,</span>
<span class="c">#          &amp;quot;port_value&amp;quot;: 15090</span>
<span class="c">#        }</span>
<span class="c">#      },</span>
<span class="c">#     &amp;quot;filter_chains&amp;quot;: [</span>
<span class="c">#                &amp;quot;filters&amp;quot;: [</span>
<span class="c">#                  {</span>
<span class="c">#                    &amp;quot;name&amp;quot;: &amp;quot;envoy.filters.network.http_connection_manager&amp;quot;,</span>
<span class="c">#                    &amp;quot;typed_config&amp;quot;: {</span>
<span class="c">#                      &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&amp;quot;,</span>
<span class="c">#                      &amp;quot;codec_type&amp;quot;: &amp;quot;AUTO&amp;quot;,</span>
<span class="c">#                      &amp;quot;stat_prefix&amp;quot;: &amp;quot;agent&amp;quot;,</span>
<span class="c">#                      &amp;quot;route_config&amp;quot;: {</span>
<span class="c">#                        &amp;quot;virtual_hosts&amp;quot;: [</span>
<span class="c">#                          {</span>
<span class="c">#                            &amp;quot;name&amp;quot;: &amp;quot;backend&amp;quot;,</span>
<span class="c">#                            &amp;quot;domains&amp;quot;: [</span>
<span class="c">#                              &amp;quot;*&amp;quot;</span>
<span class="c">#                            ],</span>
<span class="c">#                            &amp;quot;routes&amp;quot;: [</span>
<span class="c">#                              {</span>
<span class="c">#                                &amp;quot;match&amp;quot;: {</span>
<span class="c">#                                  &amp;quot;prefix&amp;quot;: &amp;quot;/healthz/ready&amp;quot;</span>
<span class="c">#                                },</span>
<span class="c">#                                &amp;quot;route&amp;quot;: {</span>
<span class="c">#                                  &amp;quot;cluster&amp;quot;: &amp;quot;agent&amp;quot;</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>more /etc/istio/proxy/grpc-bootstrap.json
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;xds_servers&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;server_uri&amp;quot;: &lt;span style="color: red;"&gt;&amp;quot;unix:///etc/istio/proxy/XDS&amp;quot;,&lt;/span&gt;</span>
<span class="c">#          ...</span>
<span class="c">#        }</span>
<span class="c">#      ],</span>
<span class="c">#      &amp;quot;node&amp;quot;: {</span>
<span class="c">#        &amp;quot;id&amp;quot;: &amp;quot;sidecar~172.16.1.13~deploy-websrv-778ffd6947-cxf5k.default~default.svc.cluster.local&amp;quot;,</span>
<span class="c">#        &amp;quot;metadata&amp;quot;: {</span>
<span class="c">#          &amp;quot;ANNOTATIONS&amp;quot;: {</span>
<span class="c">#            &amp;quot;istio.io/rev&amp;quot;: &amp;quot;default&amp;quot;,</span>
<span class="c">#            &amp;quot;kubectl.kubernetes.io/default-container&amp;quot;: &amp;quot;deploy-websrv&amp;quot;,</span>
<span class="c">#            &amp;quot;kubectl.kubernetes.io/default-logs-container&amp;quot;: &amp;quot;deploy-websrv&amp;quot;,</span>
<span class="c">#            ...</span>
<span class="c">#            &amp;quot;sidecar.istio.io/status&amp;quot;: &amp;quot;{\&amp;quot;initContainers\&amp;quot;:[\&amp;quot;istio-init\&amp;quot;],\&amp;quot;containers\&amp;quot;:[\&amp;quot;istio-proxy\&amp;quot;],\&amp;quot;volumes\&amp;quot;:[\&amp;quot;workload-socket\&amp;quot;,\&amp;quot;credential-socket\&amp;quot;,\&amp;quot;workload-certs\&amp;quot;</span>
<span class="c">#    ,\&amp;quot;istio-envoy\&amp;quot;,\&amp;quot;istio-data\&amp;quot;,\&amp;quot;istio-podinfo\&amp;quot;,\&amp;quot;istio-token\&amp;quot;,\&amp;quot;istiod-ca-cert\&amp;quot;],\&amp;quot;imagePullSecrets\&amp;quot;:null,\&amp;quot;revision\&amp;quot;:\&amp;quot;default\&amp;quot;}&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          ...</span>
<span class="c">#          &amp;quot;SERVICE_ACCOUNT&amp;quot;: &amp;quot;kans-nginx&amp;quot;,</span>
<span class="c">#          &amp;quot;WORKLOAD_NAME&amp;quot;: &amp;quot;deploy-websrv&amp;quot;</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;locality&amp;quot;: {},</span>
<span class="c">#        &amp;quot;UserAgentVersionType&amp;quot;: null</span>
<span class="c">#      },</span>
<span class="c">#      &amp;quot;server_listener_resource_name_template&amp;quot;: &amp;quot;xds.istio.io/grpc/lds/inbound/%s&amp;quot;</span>
<span class="c">#    }</span>

<span class="c"># display only Unix domain sockets : Listener ê³¼ ESTAB ìƒíƒœ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ss <span class="nt">-xpl</span>
<span class="c"># =&gt; Netid State  Recv-Q Send-Q                              Local Address:Port  Peer Address:PortProcess</span>
<span class="c">#    u_str LISTEN 0      4096                          etc/istio/proxy/XDS 54694            * 0    users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=11))</span>
<span class="c">#    u_str LISTEN 0      4096   var/run/secrets/workload-spiffe-uds/socket 54693            * 0    users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=9))</span>
<span class="nv">$ </span>ss <span class="nt">-xp</span>
<span class="c"># =&gt; Netid State Recv-Q Send-Q                              Local Address:Port  Peer Address:Port Process</span>
<span class="c">#    u_str ESTAB 0      0                             etc/istio/proxy/XDS 79304            * 82228 users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=10))</span>
<span class="c">#    u_str ESTAB 0      0      var/run/secrets/workload-spiffe-uds/socket 54709            * 54162 users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=16))</span>
<span class="c">#    u_str ESTAB 0      0                                               * 82228            * 79304 users:((&amp;quot;envoy&amp;quot;,pid=13,fd=19))</span>
<span class="c">#    u_str ESTAB 0      0                                               * 54162            * 54709 users:((&amp;quot;envoy&amp;quot;,pid=13,fd=32))</span>

<span class="c"># display only TCP sockets and display only IP version 4 sockets : TCP ìƒíƒœ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ss <span class="nt">-4tpl</span>
<span class="c"># =&gt; LISTEN 0      4096         0.0.0.0:15090      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=21))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15090      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=20))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15021      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=23))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15021      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=22))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15001      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=35))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15001      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=34))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15006      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=37))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:15006      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=36))</span>
<span class="c">#    LISTEN 0      4096       127.0.0.1:15000      0.0.0.0:*    users:((&amp;quot;envoy&amp;quot;,pid=13,fd=18))</span>
<span class="c">#    LISTEN 0      4096       127.0.0.1:15004      0.0.0.0:*    users:((&amp;quot;pilot-agent&amp;quot;,pid=1,fd=13))</span>
<span class="c">#    LISTEN 0      511          0.0.0.0:http       0.0.0.0:*</span>
</code></pre></div></div>

<h3 id="bookinfo-ì‹¤ìŠµ-ë°-istio-ê¸°ëŠ¥-í™•ì¸">Bookinfo ì‹¤ìŠµ ë° Istio ê¸°ëŠ¥ í™•ì¸</h3>

<h4 id="bookinfo">Bookinfo</h4>

<ul>
  <li>BookinfoëŠ” istioì˜ ê¸°ëŠ¥ì„ ì„¤ëª…í•˜ê¸°ìœ„í•œ MSA(Microservices Architecture)  ê¸°ë°˜ì˜ ì˜ˆì œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_11.png" alt="img.png" class="image-center" loading="lazy" width="662" height="453">
<em class="image-caption">Bookinfo ì–´í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì„±</em>
    <ul>
      <li>productpage, details, reviews, ratings ì„œë¹„ìŠ¤ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. <a href="https://istio.io/latest/docs/examples/bookinfo/">ì†Œê°œ ë§í¬</a>
</li>
      <li>
<strong>ProductPage</strong> í˜ì´ì§€ì—ì„œ ìš”ì²­ì„ ë°›ìœ¼ë©´, ë„ì„œ ë¦¬ë·°ë¥¼ ë³´ì—¬ì£¼ëŠ” <strong>Reviews</strong> ì„œë¹„ìŠ¤ì™€ ë„ì„œ ìƒì„¸ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ëŠ” <strong>Details</strong> ì„œë¹„ìŠ¤ì— ì ‘ì†í•˜ê³ ,</li>
      <li>ProductPage ëŠ” <strong>Reviews</strong> ì™€ <strong>Details</strong> ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ì‘ë‹µí•©ë‹ˆë‹¤.</li>
      <li>
<strong>Reviews</strong> ì„œë¹„ìŠ¤ëŠ” v1, v2, v3 ì„¸ ê°œì˜ ë²„ì „ì´ ìˆê³  v2, v3 ë²„ì „ì˜ ê²½ìš° <strong>Ratings</strong> ì„œë¹„ìŠ¤ì— ì ‘ì†Œê°›ì—¬ ë„ì„œì— ëŒ€í•œ 5ë‹¨ê³„ í‰ê°€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.</li>
      <li>Reviews ì„œë¹„ìŠ¤ì˜ ì°¨ì´ëŠ”, v1ì€ Rating ì´ <strong>ì—†ê³ </strong>, v2ëŠ” <strong>ê²€ì€ìƒ‰</strong> ë³„ë¡œ Ratings ê°€ í‘œì‹œë˜ë©°, v3ëŠ” <strong>ìƒ‰ê¹”ì´</strong> ìˆëŠ” ë³„ë¡œ Ratings ê°€ í‘œì‹œë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì„¤ì¹˜ ë° í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pod -owide;echo;kubectl get svc'</span>

<span class="c"># Bookinfo ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$ISTIOV</span>
<span class="c"># =&gt; 1.23.2</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/platform/kube/bookinfo.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/platform/kube/bookinfo.yaml
<span class="c"># =&gt; service/details created</span>
<span class="c">#    serviceaccount/bookinfo-details created</span>
<span class="c">#    deployment.apps/details-v1 created</span>
<span class="c">#    service/ratings created</span>
<span class="c">#    serviceaccount/bookinfo-ratings created</span>
<span class="c">#    deployment.apps/ratings-v1 created</span>
<span class="c">#    service/reviews created</span>
<span class="c">#    serviceaccount/bookinfo-reviews created</span>
<span class="c">#    deployment.apps/reviews-v1 created</span>
<span class="c">#    deployment.apps/reviews-v2 created</span>
<span class="c">#    deployment.apps/reviews-v3 created</span>
<span class="c">#    service/productpage created</span>
<span class="c">#    serviceaccount/bookinfo-productpage created</span>
<span class="c">#    deployment.apps/productpage-v1 created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get all,sa
<span class="c"># =&gt; NAME                                 READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/details-v1-65cfcf56f9-8465x      2/2     Running   0          87s</span>
<span class="c">#    pod/productpage-v1-d5789fdfb-f8gdf   2/2     Running   0          86s</span>
<span class="c">#    pod/ratings-v1-7c9bd4b87f-s9gxs      2/2     Running   0          87s</span>
<span class="c">#    pod/reviews-v1-6584ddcf65-gnc9j      2/2     Running   0          87s</span>
<span class="c">#    pod/reviews-v2-6f85cb9b7c-cfc68      2/2     Running   0          87s</span>
<span class="c">#    pod/reviews-v3-6f5b775685-cw7tc      2/2     Running   0          87s</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/details         ClusterIP   10.10.200.54    &amp;lt;none&amp;gt;        9080/TCP   87s</span>
<span class="c">#    service/productpage     ClusterIP   10.10.200.184   &amp;lt;none&amp;gt;        9080/TCP   87s</span>
<span class="c">#    service/ratings         ClusterIP   10.10.200.163   &amp;lt;none&amp;gt;        9080/TCP   87s</span>
<span class="c">#    service/reviews         ClusterIP   10.10.200.214   &amp;lt;none&amp;gt;        9080/TCP   87s</span>
<span class="c">#    </span>
<span class="c">#    NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/details-v1       1/1     1            1           87s</span>
<span class="c">#    deployment.apps/productpage-v1   1/1     1            1           86s</span>
<span class="c">#    deployment.apps/ratings-v1       1/1     1            1           87s</span>
<span class="c">#    deployment.apps/reviews-v1       1/1     1            1           87s</span>
<span class="c">#    deployment.apps/reviews-v2       1/1     1            1           87s</span>
<span class="c">#    deployment.apps/reviews-v3       1/1     1            1           87s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                       DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/details-v1-65cfcf56f9      1         1         1       87s</span>
<span class="c">#    replicaset.apps/productpage-v1-d5789fdfb   1         1         1       86s</span>
<span class="c">#    replicaset.apps/ratings-v1-7c9bd4b87f      1         1         1       87s</span>
<span class="c">#    replicaset.apps/reviews-v1-6584ddcf65      1         1         1       87s</span>
<span class="c">#    replicaset.apps/reviews-v2-6f85cb9b7c      1         1         1       87s</span>
<span class="c">#    replicaset.apps/reviews-v3-6f5b775685      1         1         1       87s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                  SECRETS   AGE</span>
<span class="c">#    serviceaccount/bookinfo-details       0         87s</span>
<span class="c">#    serviceaccount/bookinfo-productpage   0         86s</span>
<span class="c">#    serviceaccount/bookinfo-ratings       0         87s</span>
<span class="c">#    serviceaccount/bookinfo-reviews       0         87s</span>

<span class="c"># product ì›¹ ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="s2">"</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>ratings <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span><span class="s2">"</span> <span class="nt">-c</span> ratings <span class="nt">--</span> curl <span class="nt">-sS</span> productpage:9080/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
<span class="c"># =&gt; &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>

<span class="c"># ë¡œê·¸</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>productpage <span class="nt">-f</span>
</code></pre></div></div>

<h4 id="istioë¥¼-í†µí•œ-ì¸ì…-ê¸°ë³¸-ì„¤ì •">Istioë¥¼ í†µí•œ ì¸ì… ê¸°ë³¸ ì„¤ì •</h4>

<h5 id="istio-gatewayvirtualservice-ì„¤ì •">Istio Gateway/VirtualService ì„¤ì •</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Istio Gateway/VirtualService ì„¤ì •</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/networking/bookinfo-gateway.yaml
<span class="c"># =&gt; apiVersion: networking.istio.io/v1alpha3</span>
<span class="c">#    kind: Gateway</span>
<span class="c">#    metadata:</span>
<span class="c">#      name: bookinfo-gateway</span>
<span class="c">#    spec:</span>
<span class="c">#      # The selector matches the ingress gateway pod labels.</span>
<span class="c">#      # If you installed Istio using Helm following the standard documentation, this would be &amp;quot;istio=ingress&amp;quot;</span>
<span class="c">#      selector:</span>
<span class="c">#        istio: ingressgateway # use istio default controller</span>
<span class="c">#      servers:</span>
<span class="c">#      - port:</span>
<span class="c">#          number: 8080</span>
<span class="c">#          name: http</span>
<span class="c">#          protocol: HTTP</span>
<span class="c">#        hosts:</span>
<span class="c">#        - &amp;quot;*&amp;quot;</span>
<span class="c">#    ---</span>
<span class="c">#    apiVersion: networking.istio.io/v1alpha3</span>
<span class="c">#    kind: VirtualService</span>
<span class="c">#    metadata:</span>
<span class="c">#      name: bookinfo</span>
<span class="c">#    spec:</span>
<span class="c">#      hosts:</span>
<span class="c">#      - &amp;quot;*&amp;quot;</span>
<span class="c">#      gateways:</span>
<span class="c">#      - bookinfo-gateway</span>
<span class="c">#      http:</span>
<span class="c">#      - match:</span>
<span class="c">#        - uri:</span>
<span class="c">#            exact: /productpage</span>
<span class="c">#        - uri:</span>
<span class="c">#            prefix: /static</span>
<span class="c">#        - uri:</span>
<span class="c">#            exact: /login</span>
<span class="c">#        - uri:</span>
<span class="c">#            exact: /logout</span>
<span class="c">#        - uri:</span>
<span class="c">#            prefix: /api/v1/products</span>
<span class="c">#        route:</span>
<span class="c">#        - destination:</span>
<span class="c">#            host: productpage</span>
<span class="c">#            port:</span>
<span class="c">#              number: 9080</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/networking/bookinfo-gateway.yaml
<span class="c"># =&gt; gateway.networking.istio.io/bookinfo-gateway created</span>
<span class="c">#    virtualservice.networking.istio.io/bookinfo created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get gw,vs
<span class="nv">$ </span>istioctl proxy-status
<span class="c"># =&gt; NAME                                                   CLUSTER        CDS                LDS                EDS                RDS                ECDS        ISTIOD                      VERSION</span>
<span class="c">#    deploy-websrv-778ffd6947-cxf5k.default                 Kubernetes     SYNCED (5m9s)      SYNCED (5m9s)      SYNCED (4m24s)     SYNCED (5m9s)      IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    details-v1-65cfcf56f9-8465x.default                    Kubernetes     SYNCED (4m43s)     SYNCED (4m43s)     SYNCED (4m24s)     SYNCED (4m43s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    istio-ingressgateway-5f9f654d46-l7mqp.istio-system     Kubernetes     SYNCED (10s)       SYNCED (10s)       SYNCED (4m24s)     SYNCED (10s)       IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    productpage-v1-d5789fdfb-f8gdf.default                 Kubernetes     SYNCED (4m53s)     SYNCED (4m53s)     SYNCED (4m24s)     SYNCED (4m53s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    ratings-v1-7c9bd4b87f-s9gxs.default                    Kubernetes     SYNCED (4m24s)     SYNCED (4m24s)     SYNCED (4m24s)     SYNCED (4m24s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    reviews-v1-6584ddcf65-gnc9j.default                    Kubernetes     SYNCED (4m47s)     SYNCED (4m47s)     SYNCED (4m24s)     SYNCED (4m47s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    reviews-v2-6f85cb9b7c-cfc68.default                    Kubernetes     SYNCED (4m41s)     SYNCED (4m41s)     SYNCED (4m24s)     SYNCED (4m41s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>
<span class="c">#    reviews-v3-6f5b775685-cw7tc.default                    Kubernetes     SYNCED (4m43s)     SYNCED (4m43s)     SYNCED (4m24s)     SYNCED (4m43s)     IGNORED     istiod-7f8b586864-8mc4c     1.23.2</span>

<span class="c"># productpage íŒŒë“œì˜ istio-proxy ë¡œê·¸ í™•ì¸ Access log ê°€ ì¶œë ¥ - Default access log format : ë§í¬</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>productpage <span class="nt">-c</span> istio-proxy <span class="nt">-f</span>
</code></pre></div></div>

<ul>
  <li>
<strong>k3s-m</strong> NodePort ì ‘ì† í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">IGWHTTP</span><span class="o">=</span><span class="si">$(</span>kubectl get service <span class="nt">-n</span> istio-system istio-ingressgateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.ports[1].nodePort}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; 31677</span>

<span class="c"># ì ‘ì† í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> istio-system istio-ingressgateway
<span class="c"># =&gt; NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE</span>
<span class="c">#    istio-ingressgateway   NodePort   10.10.200.171   &amp;lt;none&amp;gt;        15021:30953/TCP,80:31677/TCP,443:30737/TCP,31400:30617/TCP,15443:31668/TCP   3h31m</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> http://localhost:<span class="nv">$IGWHTTP</span>/productpage
<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.10.101:<span class="nv">$IGWHTTP</span>/productpage
<span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.10.102:<span class="nv">$IGWHTTP</span>/productpage
<span class="c"># =&gt; &amp;lt;meta charset=&amp;quot;utf-8&amp;quot;&amp;gt;</span>
<span class="c">#    &amp;lt;meta http-equiv=&amp;quot;X-UA-Compatible&amp;quot; content=&amp;quot;IE=edge&amp;quot;&amp;gt;</span>
<span class="c">#    &amp;lt;meta name=&amp;quot;viewport&amp;quot; content=&amp;quot;width=device-width, initial-scale=1.0&amp;quot;&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    ...</span>

<span class="c"># ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$MYDOMAIN</span>
<span class="c"># =&gt; sweetlittlebird.com</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
<span class="c"># =&gt; ...</span>
<span class="c">#    127.0.2.1 k3s-m k3s-m</span>
<span class="c">#    192.168.10.10 k3s-m</span>
<span class="c">#    192.168.10.101 k3s-w1</span>
<span class="c">#    192.168.10.102 k3s-w2</span>
<span class="c">#    192.168.10.103 k3s-w3</span>
<span class="c">#    192.168.10.10 sweetlittlebird.com</span>

<span class="c">#</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> http://<span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage
<span class="c"># =&gt; &amp;lt;meta charset=&amp;quot;utf-8&amp;quot;&amp;gt;</span>
<span class="c">#    &amp;lt;meta http-equiv=&amp;quot;X-UA-Compatible&amp;quot; content=&amp;quot;IE=edge&amp;quot;&amp;gt;</span>
<span class="c">#    &amp;lt;meta name=&amp;quot;viewport&amp;quot; content=&amp;quot;width=device-width, initial-scale=1.0&amp;quot;&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>ìì‹ ì˜ PCì—ì„œ ì ‘ì† í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$MYDOMAIN</span> <span class="nv">$IGWHTTP</span>
<span class="c"># =&gt; sweetlittlebird.com 31677</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts

<span class="c">#</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_12.png" alt="img.png" class="image-center" loading="lazy" width="1076" height="727">
<em class="image-caption">Bookinfo ì ‘ì† ê²°ê³¼ - ìƒˆë¡œê³ ì¹¨ í•  ë•Œ ë§ˆë‹¤ ë‹¤ë¥¸ íŒŒë“œì— ì ‘ì†ë˜ë©´ì„œ ë¦¬ë·°ê°€ ë‹¬ë¼ì§</em></p>

<ul>
  <li><strong>testpc ì—ì„œ ì ‘ì† ì‹¤í–‰</strong></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># istio ingress gw ë¥¼ í†µí•œ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span>
<span class="c"># =&gt; &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    --------------</span>
<span class="c">#    &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    --------------</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    &amp;lt;title&amp;gt;Simple Bookstore App&amp;lt;/title&amp;gt;</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h4 id="ëª¨ë‹ˆí„°ë§">ëª¨ë‹ˆí„°ë§</h4>

<ul>
  <li>ì˜µì €ë¹Œë¦¬í‹° ì—°ë™ ë¬¸ì„œ : <a href="https://istio.io/latest/docs/ops/integrations/">ë§í¬</a>
</li>
</ul>

<h5 id="kiali-í‚¤ì•Œë¦¬-ì†Œê°œ">Kiali (í‚¤ì•Œë¦¬) ì†Œê°œ</h5>

<ul>
  <li>KialiëŠ” Istio ì„œë¹„ìŠ¤ ë©”ì‹œì˜ ëª¨ë‹ˆí„°ë§ ë° ì‹œê°í™” ë„êµ¬ì…ë‹ˆë‹¤.</li>
  <li>ì£¼ ë°ì´í„° ì†ŒìŠ¤ëŠ” Prometheusì™€ Jaeger ë“±ì…ë‹ˆë‹¤.</li>
  <li>íŠ¹íˆ Jaegerì™€ ì—°ë™í•˜ì—¬ ì„œë¹„ìŠ¤ ê°„ì˜ í˜¸ì¶œ ê´€ê³„ë¥¼ ì‹œê°í™”í•˜ì—¬ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Istiodì˜ health ìƒíƒœë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ istiod íŒŒë“œë¥¼ ì§ì ‘ ì ‘ì†í•©ë‹ˆë‹¤. (ê¸°ë³¸ 15014í¬íŠ¸)</li>
</ul>

<h5 id="kiali-ì„¤ì¹˜-ë°-í™•ì¸">Kiali ì„¤ì¹˜ ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install Kiali and the other addons and wait for them to be deployed. : Kiali dashboard, along with Prometheus, Grafana, and Jaeger.</span>
<span class="nv">$ </span>tree ~/istio-<span class="nv">$ISTIOV</span>/samples/addons/
<span class="c"># =&gt; /root/istio-1.23.2/samples/addons/</span>
<span class="c">#    â”œâ”€â”€ README.md</span>
<span class="c">#    â”œâ”€â”€ extras</span>
<span class="c">#    â”‚   â”œâ”€â”€ prometheus-operator.yaml</span>
<span class="c">#    â”‚   â”œâ”€â”€ skywalking.yaml</span>
<span class="c">#    â”‚   â””â”€â”€ zipkin.yaml</span>
<span class="c">#    â”œâ”€â”€ grafana.yaml</span>
<span class="c">#    â”œâ”€â”€ jaeger.yaml</span>
<span class="c">#    â”œâ”€â”€ kiali.yaml</span>
<span class="c">#    â”œâ”€â”€ loki.yaml</span>
<span class="c">#    â””â”€â”€ prometheus.yaml</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/addons <span class="c"># ë””ë ‰í„°ë¦¬ì— ìˆëŠ” ëª¨ë“  yaml ìì›ì„ ìƒì„±</span>
<span class="c"># =&gt; deployment.apps/grafana created</span>
<span class="c">#    deployment.apps/jaeger created</span>
<span class="c">#    deployment.apps/kiali created</span>
<span class="c">#    deployment.apps/prometheus created</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl rollout status deployment/kiali <span class="nt">-n</span> istio-system
<span class="c"># =&gt; deployment &amp;quot;kiali&amp;quot; successfully rolled out</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get all,sa,cm <span class="nt">-n</span> istio-system
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> istio-system
<span class="c"># =&gt; NAME                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE</span>
<span class="c">#    service/grafana                ClusterIP   10.10.200.178   &amp;lt;none&amp;gt;        3000/TCP                                                                     69s</span>
<span class="c">#    service/istio-ingressgateway   NodePort    10.10.200.171   &amp;lt;none&amp;gt;        15021:30953/TCP,80:31677/TCP,443:30737/TCP,31400:30617/TCP,15443:31668/TCP   5h48m</span>
<span class="c">#    service/istiod                 ClusterIP   10.10.200.215   &amp;lt;none&amp;gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP                                        5h48m</span>
<span class="c">#    service/jaeger-collector       ClusterIP   10.10.200.121   &amp;lt;none&amp;gt;        14268/TCP,14250/TCP,9411/TCP,4317/TCP,4318/TCP                               69s</span>
<span class="c">#    service/kiali                  ClusterIP   10.10.200.19    &amp;lt;none&amp;gt;        20001/TCP,9090/TCP                                                           68s</span>
<span class="c">#    service/loki                   ClusterIP   10.10.200.227   &amp;lt;none&amp;gt;        3100/TCP,9095/TCP                                                            68s</span>
<span class="c">#    service/loki-headless          ClusterIP   None            &amp;lt;none&amp;gt;        3100/TCP                                                                     68s</span>
<span class="c">#    service/loki-memberlist        ClusterIP   None            &amp;lt;none&amp;gt;        7946/TCP                                                                     68s</span>
<span class="c">#    service/prometheus             ClusterIP   10.10.200.148   &amp;lt;none&amp;gt;        9090/TCP                                                                     68s</span>
<span class="c">#    service/tracing                ClusterIP   10.10.200.133   &amp;lt;none&amp;gt;        80/TCP,16685/TCP                                                             69s</span>
<span class="c">#    service/zipkin                 ClusterIP   10.10.200.29    &amp;lt;none&amp;gt;        9411/TCP                                                                     69s</span>
<span class="c">#    </span>
<span class="c">#    NAME                             ENDPOINTS                                                           AGE</span>
<span class="c">#    endpoints/grafana                172.16.2.17:3000                                                    69s</span>
<span class="c">#    endpoints/istio-ingressgateway   172.16.2.14:15443,172.16.2.14:15021,172.16.2.14:31400 + 2 more...   5h48m</span>
<span class="c">#    endpoints/istiod                 172.16.3.16:15012,172.16.3.16:15010,172.16.3.16:15017 + 1 more...   5h48m</span>
<span class="c">#    endpoints/jaeger-collector       172.16.3.19:9411,172.16.3.19:14250,172.16.3.19:4317 + 2 more...     69s</span>
<span class="c">#    endpoints/kiali                  172.16.1.16:9090,172.16.1.16:20001                                  68s</span>
<span class="c">#    endpoints/loki                                                                                       68s</span>
<span class="c">#    endpoints/loki-headless                                                                              68s</span>
<span class="c">#    endpoints/loki-memberlist                                                                            68s</span>
<span class="c">#    endpoints/prometheus             172.16.3.20:9090                                                    67s</span>
<span class="c">#    endpoints/tracing                172.16.3.19:16685,172.16.3.19:16686                                 69s</span>
<span class="c">#    endpoints/zipkin                 172.16.3.19:9411                                                    69s</span>

<span class="c"># kiali ì„œë¹„ìŠ¤ ë³€ê²½</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> istio-system kiali <span class="nt">-p</span> <span class="s1">'{"spec":{"type":"NodePort"}}'</span>
<span class="c"># =&gt; service/kiali patched</span>

<span class="c"># kiali ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ KIALINodePort</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> istio-system kiali <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"KIALI UI URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$KIALINodePort</span><span class="s2">"</span>
<span class="c"># =&gt; KIALI UI URL = http://54.123.42.212:31274</span>

<span class="c"># Grafana ì„œë¹„ìŠ¤ ë³€ê²½</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> istio-system grafana <span class="nt">-p</span> <span class="s1">'{"spec":{"type":"NodePort"}}'</span>
<span class="c"># =&gt; service/grafana patched</span>

<span class="c"># Grafana ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸ : 7ê°œì˜ ëŒ€ì‹œë³´ë“œ</span>
<span class="nv">$ GRAFANANodePort</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> istio-system grafana <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Grafana URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$GRAFANANodePort</span><span class="s2">"</span>
<span class="c"># =&gt; Grafana URL = http://54.123.42.212:30266</span>

<span class="c"># Prometheus ì„œë¹„ìŠ¤ ë³€ê²½</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> istio-system prometheus <span class="nt">-p</span> <span class="s1">'{"spec":{"type":"NodePort"}}'</span>
<span class="c"># =&gt; service/prometheus patched</span>

<span class="c"># Prometheus ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ PROMENodePort</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> istio-system prometheus <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Prometheus URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$PROMENodePort</span><span class="s2">"</span>
<span class="c"># =&gt; Prometheus URL = http://54.123.42.212:30506</span>
</code></pre></div></div>

<ul>
  <li>Prometheus : Targets - íŒŒë“œë³„ë¡œ tcp/15020ì˜ /stats/prometheusë¥¼ í†µí•´ ìˆ˜ì§‘</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_13.png" alt="img.png" class="image-center" loading="lazy" width="1580" height="784"></p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_14.png" alt="img.png" class="image-center" loading="lazy" width="1050" height="704"></p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_15.png" alt="img.png" class="image-center" loading="lazy" width="1050" height="704"></p>

<ul>
  <li>Grafana : 7ê°œì˜ ëŒ€ì‹œë³´ë“œ</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_17.png" alt="img.png" class="image-center" loading="lazy" width="1910" height="1210"></p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_16.png" alt="img.png" class="image-center" loading="lazy" width="1910" height="1210"></p>

<ul>
  <li>Kiali : ì„œë¹„ìŠ¤ê°„ì˜ í˜¸ì¶œ ê´€ê³„ë¥¼ ì‹œê°í™”</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_18.png" alt="img.png" class="image-center" loading="lazy" width="1910" height="1210"></p>

<h5 id="kiali-í‚¤ì•Œë¦¬-ëŒ€ì‹œë³´ë“œ-ë‘˜ëŸ¬ë³´ê¸°">Kiali (í‚¤ì•Œë¦¬) ëŒ€ì‹œë³´ë“œ ë‘˜ëŸ¬ë³´ê¸°</h5>

<ul>
  <li>Namespace ë¥¼ default ë¡œ ì„ íƒ í›„ Graph (Traffic, Versioned app graph) ì—ì„œ Display ì˜µì…˜ ì¤‘ â€˜Traffic Distributionâ€™ê³¼
â€˜Traffic Animationâ€™ í™œì„±í™”, Security ì²´í¬ í•´ì„œ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>íŠ¸ë˜í”½ì„ ë°œìƒì‹œì¼œì„œ Kiali ëŒ€ì‹œë³´ë“œë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># testpc ì—ì„œ ì•„ë˜ ì‹¤í–‰</span>
<span class="c"># ë°˜ë³µ ì ‘ì† í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">sleep </span>0.5<span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..1000<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-o</span> <span class="s2">"&lt;title&gt;.*&lt;/title&gt;"</span> <span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>
<strong>Traffic Graph</strong>ì—ì„œëŠ” íŠ¸ë˜í”½ íë¦„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_19.png" alt="img.png" class="image-center" loading="lazy" width="1211" height="801"></p>

<ul>
  <li>
<strong>Workloads</strong>ì—ì„œëŠ” Log ë“±ì„ í™•ì¸í•  ìˆ˜ ìˆê³ , Envoy ê´€ë ¨ ì„¤ì • ì •ë³´(Listener, Cluster, Route, Endpoint ë“±)ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_20.png" alt="img.png" class="image-center" loading="lazy" width="1572" height="558"></p>

<ul>
  <li>
<strong>Istio Config</strong>ì—ì„œ Istio ê´€ë ¨ ì„¤ì •ì„ ë³¼ ìˆ˜ ìˆê³ , <strong>Action</strong> ìœ¼ë¡œ Istio ê´€ë ¨ ì˜¤ë¸Œì íŠ¸ë¥¼ ì„¤ì •/ì‚­ì œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="traffic-management">Traffic Management</h4>

<ul>
  <li>
<strong>ë™ì‘ ì†Œê°œ</strong> : í´ë¼ì´ì–¸íŠ¸ PC â†’ Istio <strong>ingressgateway</strong> íŒŒë“œ â†’ (Gateway, <strong>VirtualService</strong> + <strong>DestinationRule</strong>) â†’ Cluster(<strong>Endpoint</strong> - íŒŒë“œ)
    <ul>
      <li>
<strong>Gateway</strong> : ì§€ì •í•œ ì¸ê·¸ë ˆìŠ¤ ê²Œì´íŠ¸ì›¨ì´ë¡œë¶€í„° íŠ¸ë˜í”½ì´ ì¸ì…, í”„ë¡œí† ì½œ ë° í¬íŠ¸, HOSTS, Proxy ë“± ì„¤ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li>
<strong>VirtualService</strong> : ì¸ì… ì²˜ë¦¬í•  hosts ì„¤ì •, L7 PATH ë³„ ë¼ìš°íŒ…, ëª©ì ì§€ì— ëŒ€í•œ ì •ì±… ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤. (envoy route config) - <a href="https://istio.io/latest/docs/concepts/traffic-management/#virtual-services">ë§í¬</a>
        <ul>
          <li>VirtualService ëŠ” DestinationRule ì—ì„œ ì„¤ì •ëœ <strong>ì„œë¸Œì…‹(subset)</strong>ì„ ì‚¬ìš©í•˜ì—¬ <strong>íŠ¸ë˜í”½ ì»¨íŠ¸ë¡¤</strong>ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>
<strong>hosts í•„ë“œ</strong> : ëª©ì ì§€ ì£¼ì†Œ - IP address, a DNS name (FQDN), í˜¹ì€ k8s svc ì´ë¦„, wildcard (â€*â€) prefixes</li>
          <li>
<strong>Routing rules</strong> : HTTP ê²½ìš° - Match í•„ë“œ(ì˜ˆ) í—¤ë”), Destination(istio/envoy ì— ë“±ë¡ëœ ëŒ€ìƒ, subnet ì— DestinationRule í™œìš©)
            <ul>
              <li>
<strong>HTTPRoute</strong> : redirect , rewrite , fault(ì¥ì•  ì£¼ì…) , mirror(ë³µì œ, ê¸°ë³¸ 100%) , corsPolicy(CORS ì‚½ì…) , headers(í—¤ë” ì¡°ì‘) ë“± - <a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRoute">ë§í¬</a>
</li>
            </ul>
          </li>
          <li>Routing rule precedence : Routing rules are evaluated in sequential order from top to bottom - ìœ„ì—ì„œ ìˆœì°¨ì  ì ìš©</li>
        </ul>
      </li>
      <li>DestinationRule : ì‹¤ì œ ë„ì°©ì§€(ì„œë¹„ìŠ¤ì™€ 1:1 ì—°ê²°)ì˜ ì •êµí•œ ì •ì±…(ë¶€í•˜ë¶„ì‚°, ì—°ê²° ì˜µì…˜, ì„œí‚· ë¸Œë ˆì´í¬, TLS ë“±)ì„ ì„¤ì • - <a href="https://istio.io/latest/docs/concepts/traffic-management/#destination-rules">ë§í¬</a>
        <ul>
          <li>
<strong>Load balancing options</strong> : Round robin(ê¸°ë³¸ê°’) , Random , Weighted , Least requests - <a href="https://www.envoyproxy.io/docs/envoy/v1.5.0/intro/arch_overview/load_balancing">ë§í¬</a>
            <ul>
              <li>
<strong>Destination Rule</strong> : TrafficPolicy , Subset , ConnectionPoolSettings ë“± - <a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/">ë§í¬</a>
</li>
              <li>ì„œë¸Œì…‹(subsets)ì„ ì •ì˜í•  ìˆ˜ ìˆì–´ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ <strong>ë²„ì „ë³„ë¡œ ë¼ìš°íŒ…</strong>í•  ë•Œ ì‚¬ìš©í•œë‹¤</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="request-routing-ì‹¤ìŠµ">Request Routing ì‹¤ìŠµ</h5>

<ul>
  <li>ì‹¤ìŠµì „ ê¸°ë³¸ DestinationRule ì ìš©</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒ˜í”Œ íŒŒì¼ë“¤ í™•ì¸</span>
<span class="nv">$ </span>tree ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/networking
<span class="c"># =&gt; /root/istio-1.23.2/samples/bookinfo/networking</span>
<span class="c">#    â”œâ”€â”€ bookinfo-gateway.yaml</span>
<span class="c">#    â”œâ”€â”€ certmanager-gateway.yaml</span>
<span class="c">#    â”œâ”€â”€ destination-rule-all-mtls.yaml</span>
<span class="c">#    â”œâ”€â”€ destination-rule-all.yaml</span>
<span class="c">#    â”œâ”€â”€ destination-rule-reviews.yaml</span>
<span class="c">#    â”œâ”€â”€ egress-rule-google-apis.yaml</span>
<span class="c">#    â”œâ”€â”€ fault-injection-details-v1.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-all-v1.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-details-v2.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-ratings-db.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-ratings-mysql-vm.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-ratings-mysql.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-ratings-test-abort.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-ratings-test-delay.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-50-v3.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-80-20.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-90-10.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-jason-v2-v3.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-test-v2.yaml</span>
<span class="c">#    â”œâ”€â”€ virtual-service-reviews-v2-v3.yaml</span>
<span class="c">#    â””â”€â”€ virtual-service-reviews-v3.yaml</span>

<span class="c"># ê¸°ë³¸ DestinationRule ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ~/istio-<span class="nv">$ISTIOV</span>/samples/bookinfo/networking/destination-rule-all.yaml
<span class="c"># =&gt; destinationrule.networking.istio.io/productpage created</span>
<span class="c">#    destinationrule.networking.istio.io/reviews created</span>
<span class="c">#    destinationrule.networking.istio.io/ratings created</span>
<span class="c">#    destinationrule.networking.istio.io/details created</span>

<span class="c"># DestinationRule í™•ì¸ dr(=destinationrules) : KIALI Services í™•ì¸ ì‹œ GW, VS, DR í™•ì¸</span>
<span class="nv">$ </span>kubectl get dr
<span class="c"># =&gt; NAME          HOST          AGE</span>
<span class="c">#    details       details       31s</span>
<span class="c">#    productpage   productpage   31s</span>
<span class="c">#    ratings       ratings       31s</span>
<span class="c">#    reviews       reviews       31s</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_21.png" alt="img.png" loading="lazy" width="1609" height="337"></p>

<ul>
  <li>
<strong>virtual-service-all-v1.yaml</strong> : 4ê°œ ì„œë¹„ìŠ¤ ëª¨ë‘ v1 ì˜ ì„œë¸Œì…‹(subset) ì— ì „ì†¡í•˜ëŠ” ì •ì±… í…ŒìŠ¤íŠ¸</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># virtual-service-all-v1.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">productpage</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">productpage</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">productpage</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">reviews</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">reviews</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ratings</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ratings</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">ratings</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">details</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">details</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">details</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
<span class="nn">---</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># istio vs(virtualservices) í™•ì¸</span>
<span class="nv">$ </span>kubectl get vs
<span class="c"># =&gt; NAME       GATEWAYS               HOSTS   AGE</span>
<span class="c">#    bookinfo   [&amp;quot;bookinfo-gateway&amp;quot;]   [&amp;quot;*&amp;quot;]   3h30m</span>

<span class="c"># ëª¨ë“  ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì— ëŒ€í•´ v1 ì˜ ì„œë¸Œì…‹(subset) ì— ì „ì†¡ë˜ê²Œ virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-all-v1.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/productpage created</span>
<span class="c">#    virtualservice.networking.istio.io/reviews created</span>
<span class="c">#    virtualservice.networking.istio.io/ratings created</span>
<span class="c">#    virtualservice.networking.istio.io/details created</span>

<span class="c"># istio vs(virtualservices) í™•ì¸ &gt;&gt; KIALI ì—ì„œ reviews v2,v3 í–¥í•˜ëŠ” íŠ¸ë˜í”½ ê²½ë¡œê°€ ì‚¬ë¼ì§„ë‹¤!</span>
<span class="nv">$ </span>kubectl get virtualservices
<span class="c"># =&gt; NAME          GATEWAYS               HOSTS             AGE</span>
<span class="c">#    bookinfo      [&amp;quot;bookinfo-gateway&amp;quot;]   [&amp;quot;*&amp;quot;]             3h30m</span>
<span class="c">#    details                              [&amp;quot;details&amp;quot;]       10s</span>
<span class="c">#    productpage                          [&amp;quot;productpage&amp;quot;]   10s</span>
<span class="c">#    ratings                              [&amp;quot;ratings&amp;quot;]       10s</span>
<span class="c">#    reviews                              [&amp;quot;reviews&amp;quot;]       10s</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_22.png" alt="img.png" loading="lazy" width="1371" height="687"></p>

<ul>
  <li>
    <p>ëª¨ë“  íŠ¸ë˜í”½ì´ v1ìœ¼ë¡œ í–¥í•˜ê²Œ ë˜ì–´ì„œ ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë„ v1ë§Œ ë‚˜ì˜¤ê²Œ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>virtual-service-reviews-test-v2.yaml</strong> : User Identity ê¸°ë°˜ ë¼ìš°íŒ…, end-user ì»¤ìŠ¤í…€ í—¤ë”ì— <strong>jason</strong> ë§¤ì¹­ ì‹œ <strong>reviews v2</strong> ë¡œ ì „ë‹¬</p>
    <ul>
      <li>Match ì¡°ê±´ì—ëŠ” ì™„ì „ ì¼ì¹˜(exact) , ì „ë°© ì¼ì¹˜(prefix) , ì •ê·œ í‘œí˜„(regex) - 3ê°€ì§€ íŒ¨í„´ì„ ì„ íƒí•  ìˆ˜ ìˆë‹¤</li>
    </ul>
  </li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># virtual-service-reviews-test-v2.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">reviews</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">reviews</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">headers</span><span class="pi">:</span>
        <span class="na">end-user</span><span class="pi">:</span>
          <span class="na">exact</span><span class="pi">:</span> <span class="s">jason</span>
    <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v2</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë“  ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì— ëŒ€í•´ v1 ì˜ ì„œë¸Œì…‹(subset) ì— ì „ì†¡ë˜ê²Œ virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-reviews-test-v2.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/reviews configured</span>

<span class="c"># jason ë¡œê·¸ì¸ ì‹œ ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>productpage <span class="nt">-f</span>
<span class="c"># =&gt; [productpage-v1-d5789fdfb-f8gdf productpage] DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): details:9080</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] send: b'GET /details/0 HTTP/1.1\r\nHost: details:9080\r\nuser-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15\r\nAccept-Encoding: gzip, deflate\r\nAccept: */*\r\nConnection: keep-alive\r\nx-request-id: 3aa3c711-d014-930f-8c2a-563c3dbbd8b5\r\n\r\n'</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] reply: 'HTTP/1.1 200 OK\r\n'</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: content-type: application/json</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: server: envoy</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: date: Sat, 19 Oct 2024 14:32:09 GMT</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: content-length: 178</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: x-envoy-upstream-service-time: 6</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] DEBUG:urllib3.connectionpool:http://details:9080 &amp;quot;GET /details/0 HTTP/1.1&amp;quot; 200 178</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): reviews:9080</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] send: b'GET /reviews/0 HTTP/1.1</span>
<span class="c">#    Host: reviews:9080</span>
<span class="c">#    user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15</span>
<span class="c">#    Accept-Encoding: gzip, deflate</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    Connection: keep-alive</span>
<span class="c">#    x-request-id: 3aa3c711-d014-930f-8c2a-563c3dbbd8b5\r\n\r\n'</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] reply: 'HTTP/1.1 200 OK\r\n'</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: x-powered-by: Servlet/3.1</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: content-type: application/json</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: date: Sat, 19 Oct 2024 14:32:09 GMT</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: content-language: en-US</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: content-length: 358</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: x-envoy-upstream-service-time: 1</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] header: server: envoy</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] DEBUG:urllib3.connectionpool:http://reviews:9080 &amp;quot;GET /reviews/0 HTTP/1.1&amp;quot; 200 358</span>
<span class="c">#    [productpage-v1-d5789fdfb-f8gdf productpage] INFO:werkzeug:::ffff:127.0.0.6 - - [19/Oct/2024 14:32:09] &amp;quot;GET /productpage HTTP/1.1&amp;quot; 200 -</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>ì›¹ë¸Œë¼ìš°ì €ì—ì„œ productpageë¡œ ì ‘ì† í›„ ìƒˆë¡œê³ ì¹¨ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>ë¡œê·¸ì¸ ì „ì—ëŠ” v1ìœ¼ë¡œ ì ‘ì† ë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_23.png" alt="img.png" loading="lazy" width="1418" height="571">
</li>
    </ul>
  </li>
  <li>ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ Sign in í´ë¦­ í›„ jasonìœ¼ë¡œ ë¡œê·¸ì¸ í›„ ìƒˆë¡œê³ ì¹¨ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>ë¡œê·¸ì¸ í›„ì—ëŠ” v2ë¡œ ì ‘ì† ë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_24.png" alt="img_1.png" loading="lazy" width="1462" height="615">
</li>
      <li>
        <p>í—¤ë”ì—ëŠ” end-user:jason ì´ ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># ë¡œê·¸ì¸ í›„ í—¤ë”í—¤ë”</span>
<span class="c"># =&gt; [productpage-v1-d5789fdfb-f8gdf productpage] send: b'GET /reviews/0 HTTP/1.1</span>
<span class="c">#    Host: reviews:9080</span>
<span class="c">#    user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Safari/605.1.15</span>
<span class="c">#    Accept-Encoding: gzip, deflate</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    Connection: keep-alive</span>
<span class="c">#    &lt;span style="color: red;"&gt;end-user: jason&lt;/span&gt;</span>
<span class="c">#    x-request-id: 03366677-7032-9291-a4b9-7009a6257394</span>
<span class="c">#    cookie: session=eyJ1c2VyIjoiamFzb24ifQ.ZxPUxA.3MJkXTFH8zJtg_YlXlvzq8xArpc'</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h5 id="fault-injection-ì‹¤ìŠµ">Fault Injection ì‹¤ìŠµ</h5>

<ul>
  <li>
<strong>virtual-service-ratings-test-delay.yaml</strong> : end-user ê°€ jason ëŠ” ratings v1 ì— 7ì´ˆ ì§€ì—° ë°œìƒ, ê·¸ì™¸ ì‚¬ìš©ìëŠ” ratings v1 ì •ìƒ ì—°ê²°</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># virtual-service-ratings-test-delay.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ratings</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ratings</span>
  <span class="na">http</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">headers</span><span class="pi">:</span>
            <span class="na">end-user</span><span class="pi">:</span>
              <span class="na">exact</span><span class="pi">:</span> <span class="s">jason</span>
      <span class="na">fault</span><span class="pi">:</span>
        <span class="na">delay</span><span class="pi">:</span>
          <span class="na">percentage</span><span class="pi">:</span>
            <span class="na">value</span><span class="pi">:</span> <span class="m">100.0</span>
          <span class="na">fixedDelay</span><span class="pi">:</span> <span class="s">7s</span>
      <span class="na">route</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
            <span class="na">host</span><span class="pi">:</span> <span class="s">ratings</span>
            <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
            <span class="na">host</span><span class="pi">:</span> <span class="s">ratings</span>
            <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-ratings-test-delay.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/ratings configured</span>

<span class="c"># ë¡œê·¸ í™•ì¸ : product ì…ì¥ì—ì„œ ì ‘ì† ì‚¬ìš©ì(clinet) ì—°ê²°ì„ ëŠì–´ë²„ë¦¼ 0 DC downstream_remote_disconnect</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>productpage <span class="nt">-f</span>
</code></pre></div></div>

<ul>
  <li>ì›¹ë¸Œë¼ìš°ì €ì—ì„œ jasonìœ¼ë¡œ ë¡œê·¸ì¸ëœ ìƒíƒœì—ì„œ ì ‘ì†ì‹œ 6~7ì´ˆ ì§€ì—°ì´ ë°œìƒí•˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_25.png" alt="img.png" loading="lazy" width="1462" height="615"></p>

<ul>
  <li>
<strong>virtual-service-ratings-test-abort.yaml</strong> : end-user ê°€ jason ëŠ” ratings v1 ì— 500 ì—ëŸ¬ ë¦¬í„´, ê·¸ì™¸ ì‚¬ìš©ìëŠ” ratings v1 ì •ìƒ ì—°ê²°</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># virtual-service-ratings-test-abort.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ratings</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ratings</span>
  <span class="na">http</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">headers</span><span class="pi">:</span>
            <span class="na">end-user</span><span class="pi">:</span>
              <span class="na">exact</span><span class="pi">:</span> <span class="s">jason</span>
      <span class="na">fault</span><span class="pi">:</span>
        <span class="na">abort</span><span class="pi">:</span>
          <span class="na">percentage</span><span class="pi">:</span>
            <span class="na">value</span><span class="pi">:</span> <span class="m">100.0</span>
          <span class="na">httpStatus</span><span class="pi">:</span> <span class="m">500</span>
      <span class="na">route</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
            <span class="na">host</span><span class="pi">:</span> <span class="s">ratings</span>
            <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
            <span class="na">host</span><span class="pi">:</span> <span class="s">ratings</span>
            <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-ratings-test-abort.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/ratings configured</span>

<span class="c"># ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">version</span><span class="o">=</span>v2 <span class="nt">-f</span>
</code></pre></div></div>

<p>jasonìœ¼ë¡œ ë¡œê·¸ì¸ í–ˆì„ë•Œ Rating ì„œë¹„ìŠ¤ì— 500 ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_26.png" alt="img.png" loading="lazy" width="1462" height="615"></p>

<p>ë˜í•œ kialiì—ì„œë„ ì–´ëŠ êµ¬ê°„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°, Flagsë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log-format-response-flags">ë§í¬</a><br>
(ì´ê²½ìš° FIëŠ” Fault Injectionì„ ì˜ë¯¸ìœ¼ë¡œ ì¼ë¶€ëŸ¬ ì˜¤ë¥˜ë¥¼ ì¼ìœ¼í‚¨ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)</p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_27.png" alt="img.png" loading="lazy" width="1519" height="835"></p>

<h5 id="traffic-shifting-ì‹¤ìŠµ">Traffic Shifting ì‹¤ìŠµ</h5>

<ul>
  <li>
    <p>ì¹´ë‚˜ë¼ ë°°í¬ ì „ëµ ë“± í™œìš© - <a href="https://istio.io/latest/docs/tasks/traffic-management/traffic-shifting/">ë§í¬</a></p>
  </li>
  <li>
    <p><strong>virtual-service-reviews-50-v3.yaml</strong> : ê°€ì¤‘ì¹˜ (weight-based routing), reviews ì— v1(50%), v3(50%)</p>
  </li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">reviews</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">reviews</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">50</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v3</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">50</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-reviews-50-v3.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/reviews configured</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-m</span> 1 <span class="s2">"reviews-v</span><span class="se">\?</span><span class="s2">"</span> <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span>
<span class="c"># =&gt;      53                   reviews-v1-6584ddcf65-gnc9j</span>
<span class="c">#         47                   reviews-v3-6f5b775685-cw7tc</span>
</code></pre></div></div>

<p>ëŒ€ëµ 50%ì˜ í™•ë¥ ë¡œ v1ê³¼ v3ë¡œ ì ‘ì†ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>
<strong>virtual-service-reviews-80-20.yaml</strong> : ê°€ì¤‘ì¹˜ (weight-based routing), reviews ì— v1(80%), v2(20%)</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">reviews</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">reviews</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">80</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">reviews</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v2</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">20</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># virtualservices ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> virtual-service-reviews-80-20.yaml
<span class="c"># =&gt; virtualservice.networking.istio.io/reviews configured</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$MYDOMAIN</span>:<span class="nv">$IGWHTTP</span>/productpage | <span class="nb">grep</span> <span class="nt">-m</span> 1 <span class="s2">"reviews-v</span><span class="se">\?</span><span class="s2">"</span> <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span>
<span class="c"># =&gt;      79                   reviews-v1-6584ddcf65-gnc9j</span>
<span class="c">#         21                   reviews-v2-6f85cb9b7c-cfc68</span>
</code></pre></div></div>

<p>ëŒ€ëµ 80%ì˜ í™•ë¥ ë¡œ v1ê³¼ 20%ì˜ í™•ë¥ ë¡œ v2ë¡œ ì ‘ì†ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>kialiì—ì„œë„ ì–´ëŠ êµ¬ê°„ì—ì„œ ì–´ë– í•œ ë¹„ì¤‘ìœ¼ë¡œ íŠ¸ë˜í”½ì´ í˜ëŸ¬ê°€ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_28.png" alt="img.png" loading="lazy" width="1134" height="526"></p>

<h4 id="security-ë³´ì•ˆ">Security (ë³´ì•ˆ)</h4>

<ul>
  <li>ìš”êµ¬ì‚¬í•­
    <ul>
      <li>MITM (Man-In-The-Middle) ê³µê²© ë°©ì§€ë¥¼ ìœ„í•´ ëª¨ë“  íŠ¸ë˜í”½ì€ mTLSë¡œ ì•”í˜¸í™” ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>ë˜í•œ ì ‘ê·¼ ì œì–´ ì •ì±…ì´ í•„ìš”í•˜ë©°, ê°ì‚¬ ë¡œê¹…ì„ í†µí•´ ë³´ì•ˆ ì´ìŠˆë¥¼ ì‹ë³„ì´ ê°€ëŠ¥ í•´ì•¼ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ëª©í‘œ
    <ul>
      <li>ê¸°ë³¸ ì…‹íŒ…ì„ ì•ˆì „í•˜ê²Œ í•˜ê¸° : ë³„ë„ì˜ ì…‹íŒ…ì´ ì—†ì–´ë„ ë³´ì•ˆì„ ìœ ì§€í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •</li>
      <li>ê¹Šì€ ë°©ì–´ : ê¸°ì¡´ì— ì¡´ì¬í•˜ëŠ” ë³´ì•ˆ ì‹œìŠ¤í…œê³¼ í†µí•©ë˜ì–´, ë‹¤ì¸µ ë°©ì–´ë¥¼ êµ¬ì„±</li>
      <li>
<strong>Zero-trust network</strong> : ë„¤íŠ¸ì›Œí¬ë¥¼ ì‹ ë¢°í•˜ì§€ ì•ŠìŒìœ¼ë¡œì¨ ë³´ì•ˆ ê°•í™” <a href="https://genians.co.kr/genians-nac/zt/">https://genians.co.kr/genians-nac/zt/</a>
</li>
    </ul>
  </li>
  <li>êµ¬ì„±ìš”ì†Œ
    <ul>
      <li>Certification Authority (CA) : ì¸ì¦ì„œ ë°œê¸‰, ê´€ë¦¬, ê°±ì‹ </li>
      <li>ë³´ì•ˆ ì •ì±… (ì¸ì¦ì •ì±…, ì¸ê°€ì •ì±… ë“±) ê´€ë ¨ ì„¤ì •ì„ ê° í”„ë¡ì‹œì— ì „ë‹¬í•˜ëŠ” API ì„œë²„</li>
      <li>ì‚¬ì´ë“œì¹´ì™€ í”„ë¡ì‹œë¥¼ ì •ì±… ê°•ì œ ì§€ì (Policy Enforcement Point-PEPs)ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°„ì˜ í†µì‹ ì„ ë³´í˜¸</li>
      <li>Envoy Proxy í™•ì¥ ê¸°ëŠ¥ì„ í†µí•´ telemetryì™€ ê°ì‚¬ ë¡œê¹… ìˆ˜ì§‘</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_29.svg" alt="20241019_kans_w7_29.svg" class="image-center" loading="lazy" width="1127" height="536">
<em class="image-caption">istio ë³´ì•ˆ ì•„í‚¤í…ì³</em></p>

<ul>
  <li>TLSì™€ mTLS
    <ul>
      <li>
<strong>TLS (Transport Layer Security)</strong> : í†µì‹  ë³´ì•ˆì„ ìœ„í•œ í”„ë¡œí† ì½œë¡œ, ì¸í„°ë„· ìƒì—ì„œ ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•˜ëŠ” í‘œì¤€í™”ëœ ë°©ë²•ì…ë‹ˆë‹¤.
ê¸°ë³¸ì ìœ¼ë¡œ ì„œë²„ì˜ ì¸ì¦ì„œë§Œ í™•ì¸í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
      <li>
<strong>mTLS (mutual TLS)</strong> : ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë¡œ ì¸ì¦ì„ í•˜ê³  ì„œë¡œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Authentication (ì¸ì¦), Authorization (ì¸ê°€) (Auto mTLS)
    <ul>
      <li>IstioëŠ” ëª¨ë“  ì›Œí¬ë¡œë“œì— X.509 ì¸ì¦ì„œë¥¼ ë¶€ì—¬í•˜ê³ , ì„œë¡œ ì¸ì¦ì„ í†µí•´ í†µì‹ ì„ ë³´í˜¸í•©ë‹ˆë‹¤.</li>
      <li>Envoy proxyì™€ í•¨ê»˜ ì‹¤í–‰ë˜ëŠ” Istio agentëŠ” istiodì™€ í•¨ê»˜ ë™ì‘í•˜ë©´ì„œ ìë™ìœ¼ë¡œ ì¸ì¦ì„œë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤. 
 <img src="/assets/2024/kans-3th/w7/20241019_kans_w7_30.svg" alt="20241019_kans_w7_30.svg" class="image-center" loading="lazy" width="481" height="441">
        <ol>
          <li>istiodëŠ” CSR(ì¸ì¦ì„œ ì„œëª… ìš”ì²­)ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ gRPC ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
          <li>EnvoyëŠ” SDS(Secret Discovery Serice) APIë¥¼ í†µí•´ ì¸ì¦ì„œì™€ í‚¤ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.</li>
          <li>istio-agentëŠ” SDs ìš”ì²­ì„ ë°›ìœ¼ë©´ Private Keyì™€ CSRì„ ìƒì„±í•œ í›„ ìê²©ì¦ëª…
   (credential)ê³¼ í•¨ê»˜ CSR istiodì— ì „ì†¡í•˜ì—¬ ì„œëª…ì„ ìš”ì²­í•©ë‹ˆë‹¤.</li>
          <li>CAëŠ” CSRì— í¬í•¨ëœ ìê²©ì¦ëª…(credential) ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ê³  CSRì— ì„œëª…í•˜ì—¬ ì¸ì¦ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
          <li>istio-agentëŠ” istiodë¡œë¶€í„° ë°›ì€ ì¸ì¦ì„œ(certiftcate)ì™€ ê°œì¸í‚¤ private Key)ë¥¼ Envoy SDS
   APIë¥¼ í†µí•´ Envoyì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.</li>
          <li>ìœ„ì˜ CSR í”„ë¡œì„¸ìŠ¤ëŠ” ì¸ì¦ì„œ ë° í‚¤ ìˆœí™˜ì„ ìœ„í•´ ì£¼ê¸°ì ìœ¼ë¡œ ë°˜ë³µë©ë‹ˆë‹¤</li>
        </ol>
      </li>
    </ul>
  </li>
  <li>Authentication (ì¸ì¦) : 2ê°€ì§€ íƒ€ì… ì œê³µ
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_31.svg" alt="20241019_kans_w7_31.svg" loading="lazy" width="820" height="570">
    <ol>
      <li>Peer Authentication :
        <ul>
          <li>ì„œë¹„ìŠ¤ê°„ ì¸ì¦ì— ì‚¬ìš©ë˜ë©° Clientê°€ ì—°ê²°ì„ í™•ì¸í•˜ëŠ”ë° ì‚¬ìš©. ì„œë¹„ìŠ¤ ì½”ë“œ ë³€ê²½ì—†ì´ mTLS ì œê³µ</li>
        </ul>
      </li>
      <li>Request Authentication :
        <ul>
          <li>Requestì— ì²¨ë¶€ëœ ìê²©ì¦ëª…(Credential)ì„ í†µí•´ ìµœì¢… ì‚¬ìš©ì ì¸ì¦ì— ì‚¬ìš©</li>
          <li>istioëŠ” JWT (JSON Web Token)ì„ ì§€ì›í•˜ì—¬ ìµœì¢… ì‚¬ìš©ì ì¸ì¦ì„ ì œê³µ</li>
          <li>ì»¤ìŠ¤í…€ ì¸ì¦ ì œê³µìë¥¼ ë¹„ë¡¯í•˜ì—¬ OpenID Connect, Keycloak, Auth0 ë“± ë‹¤ì–‘í•œ ì¸ì¦ ë°©ì‹ì„ ì§€ì›</li>
        </ul>
      </li>
    </ol>
  </li>
  <li>Authorization (ì¸ê°€)
<img src="/assets/2024/kans-3th/w7/20241019_kans_w7_32.svg" alt="20241019_kans_w7_32.svg" loading="lazy" width="682" height="343">
    <ul>
      <li>istioëŠ” mesh ë‹¨ìœ„, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‹¨ìœ„, ì›Œí¬ë¡œë“œ ë‹¨ìœ„ë¡œ ì ‘ê·¼ì„ ì œì–´ í•  ìˆ˜ ìˆëŠ” ì¸ê°€ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ì´ì ì´ ìˆìŠµë‹ˆë‹¤.
        <ul>
          <li>ì›Œí¬ë¡œë“œì™€ ì›Œí¬ë¡œë“œê°„, ë˜ëŠ” ì‚¬ìš©ìì™€ ì›Œí¬ë¡œë“œê°„ ì¸ê°€ ì œê³µ</li>
          <li>ë‹¨ì¼í•œ AuthorizationPolicy CRDë¥¼ ì‚¬ìš©í•œ ë‹¨ìˆœí•œ API ì œê³µ</li>
          <li>ìœ ì—°í•œ ì •ì±… ì œê³µ : ì»¤ìŠ¤í…€ ì¡°ê±´ì„ ë“±ë¡í•  ìˆ˜ ìˆê³ , CUSTOM, DENY, ALLOW ì•¡ì…˜ ì§€ì›</li>
          <li>ê³ ì„±ëŠ¥ : Envoy Proxyë¥¼ í†µí•´ ì¸ê°€ ì •ì±…ì„ ì ìš©í•˜ë¯€ë¡œ ì„±ëŠ¥ ì €í•˜ê°€ ì—†ìŒ</li>
          <li>ë†’ì€ í˜¸í™˜ì„± : gRPC, HTTP, HTTPS ë“±ì„ ì§€ì›í•˜ë©°, ì¼ë°˜ì ì¸ TCP í”„ë¡œí† ì½œë„ ì§€ì›</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="authentication-auto-mtls-ì‹¤ìŠµ">Authentication (Auto mTLS) ì‹¤ìŠµ</h5>

<ul>
  <li>
    <p>ê¸°ì¡´ íŒŒë“œì— ë¡œê·¸ì—ì„œ ì¸ì¦ì„œ ë“± ë³´ì•ˆ ê´€ë ¨ ë‚´ìš© í™•ì¸</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># CA Endpoint, CA(/var/run/secret/istio/root-cert,pem), citadelclient, SDS server ë“±ë“±</span>
  <span class="nv">$ </span>kubectl logs ratings-v1-7c9bd4b87f-s9gxs <span class="nt">-c</span> istio-proxy <span class="nt">-f</span>
  <span class="nv">$ </span>kubetail
  
  <span class="c"># ì¸ì¦ì •ì±… í™•ì¸</span>
  <span class="nv">$ </span>kubectl get peerauthentications.security.istio.io
  <span class="c"># =&gt; No resources found </span>
    
  <span class="c"># envoy ì— cert ì •ë³´ í™•ì¸ : istio-proxy ì— adminí˜ì´ì§€ ì ‘ì† or kaila ì—ì„œ envoy ì—ì„œ í™•ì¸    </span>
</code></pre></div>    </div>
  </li>
  <li>bookinfo â†’ kiali â†’ product ê³„ì† ì ‘ì†</li>
  <li>kiali ì—ì„œ Display(Security ì²´í¬) í›„ ìë¬¼ì‡  í´ë¦­í•˜ë©´ ì˜¤ë¥¸ìª½ ì°½ì—ì„œ ë³´ì•ˆì„¤ì •ì„ í™•ì´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. : mTLS Enabled, spiffe(Secure name)</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_33.png" alt="img.png" loading="lazy" width="705" height="293"></p>

<ul>
  <li>test ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± í›„ íŒŒë“œ ìƒì„±(sidecar ë¯¸ì ìš©) í›„ ratings ì ‘ì†</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±</span>
<span class="nv">$ </span>kubectl create ns <span class="nb">test</span>
<span class="c"># =&gt; namespace/test created</span>

<span class="c"># íŒŒë“œ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: netpod
  namespace: test
spec:
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF

</span><span class="c"># í™•ì¸ : sidecar ë¯¸ì ìš©</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> <span class="nb">test</span>
<span class="c"># =&gt; NAME     READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    netpod   1/1     Running   0          19s</span>

<span class="c"># ratings ì„œë¹„ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc ratings
<span class="c"># =&gt; NAME      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    ratings   ClusterIP   10.10.200.163   &amp;lt;none&amp;gt;        9080/TCP   8h</span>

<span class="c"># ratings ì ‘ì† ì‹œë„ : ì„±ê³µ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> <span class="nb">test </span>netpod <span class="nt">--</span> curl ratings.default:9080/health <span class="p">;</span><span class="nb">echo</span>
<span class="nv">$ </span><span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"Ratings is healthy"</span><span class="o">}</span>

<span class="c"># ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>ratings <span class="nt">-f</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_34.png" alt="img.png" class="image-center w-80" loading="lazy" width="982" height="406">
<em class="image-caption">NS(default, test ì²´í¬) netpod ì—ì„œ ì ‘ì† ì‹œ unknown ìœ¼ë¡œ í‘œê¸°ë˜ë©°, ì ‘ê·¼ ì„±ê³µ(ë…¹ìƒ‰) í™•ì¸</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Peer authentication ì„¤ì • ë³€ê²½ : PERMISSIVE(mTLS ì‚¬ìš©/ë¯¸ì‚¬ìš© ëª¨ë‘ í—ˆìš©) â†’ STRICT(ë°˜ë“œì‹œ mTLS ì‚¬ìš©, ë¯¸ì‚¬ìš© ì‹œ ê±°ë¶€)</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default-strict
spec:
  mtls:
    mode: STRICT
</span><span class="no">EOF

</span><span class="c"># ratings ì ‘ì† ì‹œë„ : ì‹¤íŒ¨!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> <span class="nb">test </span>netpod <span class="nt">--</span> curl ratings.default:9080/health <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; curl: (56) Recv failure: Connection reset by peer</span>
<span class="c">#    command terminated with exit code 56</span>

<span class="nv">$ </span>kubetail <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>ratings <span class="nt">-f</span>
<span class="c"># =&gt; [ratings-v1-7c9bd4b87f-s9gxs istio-proxy] [2024-10-01T17:21:12.708Z] &amp;quot;- - -&amp;quot; 0 NR filter_chain_not_found - &amp;quot;-&amp;quot; 0 0 0 - &amp;quot;-&amp;quot; &amp;quot;-&amp;quot; &amp;quot;-&amp;quot; &amp;quot;-&amp;quot; &amp;quot;-&amp;quot; - - 172.16.3.17:9080 172.16.1.17:34938 - -</span>
</code></pre></div></div>

<ul>
  <li>ì‹¤ìŠµ ìì› ì‚­ì œ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete PeerAuthentication default-strict
<span class="c"># =&gt; peerauthentication.security.istio.io &amp;quot;default-strict&amp;quot; deleted</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> <span class="nb">test </span>netpod <span class="nt">--</span> curl ratings.default:9080/health <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; {&amp;quot;status&amp;quot;:&amp;quot;Ratings is healthy&amp;quot;}</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì¸ì¦ì •ì±… ê°•ì œ ì •ì±… ì‚­ì œì‹œ ë‹¤ì‹œ í†µì‹ ì´ ë©ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl delete pod <span class="nt">-n</span> <span class="nb">test </span>netpod
<span class="nv">$ </span>kubectl delete ns <span class="nb">test</span>
</code></pre></div></div>

<h3 id="istio-í†µì‹ -íë¦„">Istio í†µì‹  íë¦„</h3>

<p>istio ì‚¬ìš©ì‹œ íŠ¸ë˜í”½ì€ í˜¸ìŠ¤íŠ¸ì˜ tcp/ip ìŠ¤íƒê³¼ iptables, íŒŒë“œë‚´ì˜ iptablesì™€ envoyë¥¼ ê²½ìœ í•˜ê²Œ ë©ë‹ˆë‹¤.
istioëŠ” ê°•ë ¥í•˜ê³  ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì„ ì œê³µí•˜ì§€ë§Œ ë¹„ìš©(ì§€ì—°ì¶”ê°€, í”„ë¡œì„¸ì„œ ì‚¬ìš©ëŸ‰ ì¶”ê°€, ë³µì¡í•œ êµ¬ì¡°)ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_35.png" alt="img.png" class="image-center w-80" loading="lazy" width="539" height="399"></p>

<p>ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸(PC ë“±)ì—ì„œ íŒŒë“œë¡œ ì ‘ì†ë˜ëŠ” ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_36.png" alt="img_1.png" loading="lazy" width="1882" height="771"></p>

<p>ìœ„ì˜ ê·¸ë¦¼ì—ì„œ ì²˜ëŸ¼ iptablesë¥¼ ì—¬ëŸ¬ë²ˆ ê±°ì¹˜ê³ , DNATë“±ì„ í†µí•´ í¬íŠ¸ë²ˆí˜¸ë“±ì´ 80 (http) =&gt; 15006 (istio-proxy) ë¡œ ë³€ê²½ë˜ëŠ” ë“±ì˜ ì‘ì—…ì„ ì—¬ëŸ¬ë²ˆ ê±°ì¹©ë‹ˆë‹¤.
ë˜í•œ íŒŒë“œì™€ í˜¸ìŠ¤íŠ¸ê°„ í†µì‹  envoyë¥¼ ìš”ì²­ì„ ë°›ì„ë•Œì™€ ì‘ë‹µí• ë•Œ ëª¨ë‘ ê±°ì³ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>íŒŒë“œ ë‚´ Iptables ì ìš© íë¦„</li>
</ul>

<p><img src="/assets/2024/kans-3th/w7/20241019_kans_w7_37.png" alt="img.png" class="image-center" loading="lazy" width="1493" height="935">
<em class="image-caption">ì¶œì²˜ : <a href="https://jimmysong.io/en/blog/sidecar-injection-iptables-and-traffic-routing/#understand-outbound-handler">Jimmy song</a> ë¸”ë¡œê·¸</em></p>

<p>ë‹¤ìŒ ë¸”ë¡œê·¸ì—ì„œ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<a href="https://jimmysong.io/en/blog/sidecar-injection-iptables-and-traffic-routing/#understand-outbound-handler">Understanding the Sidecar Injection, Traffic Intercepting &amp; Routing Process in Istio</a></p>

<hr>

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>1ì£¼ì°¨ ì»¨í…Œì´ë„ˆ ê²©ë¦¬ ì´í›„ì— ë˜ ë‹¤ì‹œ ë‡Œì •ì§€ê°€ ì°¾ì•„ì˜¨ ì£¼ì°¨ì˜€ìŠµë‹ˆë‹¤.
ì´ë²ˆì£¼ì— í•™ìŠµí•œê²ƒë„ ë§ì€ë°, ì´ê²ƒì´ ì¼ë¶€ë§Œ ì‚´í´ë³¸ê²ƒì´ë¼ë‹ˆ ë†€ëìŠµë‹ˆë‹¤.
ì •ë§ ë§Œë“  ë¶„ë“¤ë„, ì“°ëŠ” ë¶„ë“¤ë„, ìŠ¤í„°ë””ë¥¼ ì§„í–‰í•´ì£¼ì‹œëŠ” ë¶„ë“¤ë„ ëŒ€ë‹¨í•©ë‹ˆë‹¤. <img class="emoji" title=":thumbsup:" alt=":thumbsup:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f44d.png" height="20" width="20" loading="lazy"></p>

<p>ì¸ì¦ì´ë‚˜ ì¸ê°€ ë“± gateway apiì—ì„œ ì•„ì‰¬ì› ë˜ ë¶€ë¶„ë“¤ì´ ë‚˜ì™€ì„œ ì¢‹ì•˜ìŠµë‹ˆë‹¤.
ì°¾ë˜ ê¸°ëŠ¥ì¸ë° ë§ˆì¹¨ ì´ë²ˆì£¼ì— ë‹¤ë£¨ê²Œ ë˜ì–´ì„œ ì¢‹ì•˜ìŠµë‹ˆë‹¤. 
Kialië¥¼ í†µí•œ íŠ¸ë˜í”½ ì‹œê°í™”ë„ ì •ë§ ìœ ìš©í•˜ê²Œ ì“°ì¼ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ë³µì¡í•˜ê¸´ í•˜ì§€ë§Œ ì¢‹ì€ ê¸°ëŠ¥ë“¤ì´ ë§ì•˜ìŠµë‹ˆë‹¤.</p>

<p>ì‹œê°„ì´ ëª¨ìë¼ì„œ ë¯¸ì²˜ ì‹¤ìŠµí•˜ì§€ ëª»í•œ ë¶€ë¶„ë“¤ê³¼ Ambient Meshë„ ë°”ìœì¼ì´ ì§€ë‚˜ê°€ë©´ ë‹¤ì‹œ ì‚´í´ë´ì•¼ê² ìŠµë‹ˆë‹¤.
ìŠ¤í„°ë””ë¥¼ ì¤€ë¹„í•´ì£¼ì‹  ê°€ì‹œë‹¤ë‹˜ê³¼ ì°¸ì—¬í•˜ì‹  ë¶„ë“¤ ê°ì‚¬í•©ë‹ˆë‹¤. <img class="emoji" title=":pray:" alt=":pray:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f64f.png" height="20" width="20" loading="lazy"></p>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">ë“¤ì–´ê°€ë©°</a></li>
<li class="toc-entry toc-h2">
<a href="#istio-%EC%86%8C%EA%B0%9C">Istio ì†Œê°œ</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%A9%94%EC%8B%9C-service-mesh%EB%9E%80">ì„œë¹„ìŠ¤ ë©”ì‹œ (Service Mesh)ë€?</a></li>
<li class="toc-entry toc-h3">
<a href="#envoy">Envoy</a>
<ul>
<li class="toc-entry toc-h4"><a href="#envoy-%EC%8B%A4%EC%8A%B5">Envoy ì‹¤ìŠµ</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#istio-%EC%86%8C%EA%B0%9C-1">Istio ì†Œê°œ</a></li>
<li class="toc-entry toc-h3"><a href="#istio-%EC%84%A4%EC%B9%98-sidecar-%EB%AA%A8%EB%93%9C">Istio ì„¤ì¹˜ (Sidecar ëª¨ë“œ)</a></li>
<li class="toc-entry toc-h3"><a href="#istio%EB%A5%BC-%ED%86%B5%ED%95%9C-%EC%99%B8%EB%B6%80-%EB%85%B8%EC%B6%9C">Istioë¥¼ í†µí•œ ì™¸ë¶€ ë…¸ì¶œ</a></li>
<li class="toc-entry toc-h3">
<a href="#bookinfo-%EC%8B%A4%EC%8A%B5-%EB%B0%8F-istio-%EA%B8%B0%EB%8A%A5-%ED%99%95%EC%9D%B8">Bookinfo ì‹¤ìŠµ ë° Istio ê¸°ëŠ¥ í™•ì¸</a>
<ul>
<li class="toc-entry toc-h4"><a href="#bookinfo">Bookinfo</a></li>
<li class="toc-entry toc-h4"><a href="#istio%EB%A5%BC-%ED%86%B5%ED%95%9C-%EC%9D%B8%EC%9E%85-%EA%B8%B0%EB%B3%B8-%EC%84%A4%EC%A0%95">Istioë¥¼ í†µí•œ ì¸ì… ê¸°ë³¸ ì„¤ì •</a></li>
<li class="toc-entry toc-h4"><a href="#%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">ëª¨ë‹ˆí„°ë§</a></li>
<li class="toc-entry toc-h4"><a href="#traffic-management">Traffic Management</a></li>
<li class="toc-entry toc-h4"><a href="#security-%EB%B3%B4%EC%95%88">Security (ë³´ì•ˆ)</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#istio-%ED%86%B5%EC%8B%A0-%ED%9D%90%EB%A6%84">Istio í†µì‹  íë¦„</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">ë§ˆì¹˜ë©°</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2024-10-19-KANS-Study-Week7/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2024-10-13-KANS-Study-Week6/">Â« [KANS 3ê¸°] Ingress &amp; Gateway API</a>
  
  
  <a class="next" href="/posts/2024-10-26-KANS-Study-Week8/">[KANS 3ê¸°] Cilium CNI Â»</a>
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2024-10-19-KANS-Study-Week7/";
this.page.identifier = "/posts/KANS Study - Week7";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>ê³µë¶€ ê¸°ë¡ê³¼ ê°œë°œ ì´ì•¼ê¸°ë¥¼ ë‹´ì€ ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>
  </body>

</html>
