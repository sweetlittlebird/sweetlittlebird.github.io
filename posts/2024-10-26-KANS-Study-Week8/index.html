<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[KANS 3ê¸°] Cilium CNI | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[KANS 3ê¸°] Cilium CNI">
<meta property="og:locale" content="ko">
<meta name="description" content="ì´ë²ˆì£¼ì—ëŠ” ë“œë””ì–´ CNIì˜ ëíŒ ì™•(ì œê°€ ì•„ëŠ” í•œì—ì„œ)ì¸ Ciliumì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.">
<meta property="og:description" content="ì´ë²ˆì£¼ì—ëŠ” ë“œë””ì–´ CNIì˜ ëíŒ ì™•(ì œê°€ ì•„ëŠ” í•œì—ì„œ)ì¸ Ciliumì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2024-10-26-KANS-Study-Week8/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2024-10-26-KANS-Study-Week8/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-10-26T01:00:18+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[KANS 3ê¸°] Cilium CNI">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-10-26T01:00:18+09:00","datePublished":"2024-10-26T01:00:18+09:00","description":"ì´ë²ˆì£¼ì—ëŠ” ë“œë””ì–´ CNIì˜ ëíŒ ì™•(ì œê°€ ì•„ëŠ” í•œì—ì„œ)ì¸ Ciliumì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.","headline":"[KANS 3ê¸°] Cilium CNI","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2024-10-26-KANS-Study-Week8/"},"url":"https://sweetlittlebird.github.io/posts/2024-10-26-KANS-Study-Week8/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body class="body--contents">
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">ì†Œê°œ</a><a class="page-link" href="/posts/">ê¸€ ëª©ë¡</a>
</div>
      </nav>
</div>
  
  <span id="scroll-indicator"></span>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[KANS 3ê¸°] Cilium CNI</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-10-26T01:00:18+09:00" itemprop="datePublished">2024ë…„ 10ì›” 26ì¼ì— ì‘ì„±
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>ëª©ì°¨</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">ë“¤ì–´ê°€ë©°</a></li>
<li class="toc-entry toc-h2">
<a href="#cilium">Cilium</a>
<ul>
<li class="toc-entry toc-h3"><a href="#bpfebpf-%EC%86%8C%EA%B0%9C">BPF/eBPF ì†Œê°œ</a></li>
<li class="toc-entry toc-h3">
<a href="#cilium-%EC%86%8C%EA%B0%9C">Cilium ì†Œê°œ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#cilium-%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90">Cilium ì•„í‚¤í…ì³</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#cilium-%EC%8B%A4%EC%8A%B5">Cilium ì‹¤ìŠµ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#cilium-%EC%84%A4%EC%B9%98">Cilium ì„¤ì¹˜</a></li>
<li class="toc-entry toc-h4"><a href="#cilium-%EA%B8%B0%EB%B3%B8%EC%A0%95%EB%B3%B4-%ED%99%95%EC%9D%B8">Cilium ê¸°ë³¸ì •ë³´ í™•ì¸</a></li>
<li class="toc-entry toc-h4"><a href="#hubble">Hubble</a></li>
<li class="toc-entry toc-h4"><a href="#%EB%85%B8%EB%93%9C%EA%B0%84-%ED%8C%8C%EB%93%9C-%ED%86%B5%EC%8B%A0">ë…¸ë“œê°„ íŒŒë“œ í†µì‹ </a></li>
<li class="toc-entry toc-h4"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4-%ED%86%B5%EC%8B%A0-%ED%99%95%EC%9D%B8">ì„œë¹„ìŠ¤ í†µì‹  í™•ì¸</a></li>
<li class="toc-entry toc-h4"><a href="#prometheus%EC%99%80-grafana%EB%A5%BC-%ED%86%B5%ED%95%9C-cilium-%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">Prometheusì™€ Grafanaë¥¼ í†µí•œ Cilium ëª¨ë‹ˆí„°ë§</a></li>
<li class="toc-entry toc-h4"><a href="#network-policy-l3-l4-l7">Network Policy (L3, L4, L7)</a></li>
<li class="toc-entry toc-h4"><a href="#bandwidth-manager">Bandwidth Manager</a></li>
<li class="toc-entry toc-h4"><a href="#l2-announcements--l2-aware-lb-beta">L2 Announcements / L2 Aware LB (Beta)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">ë§ˆì¹˜ë©°</a></li>
</ul>
    </div>
    <h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì´ë²ˆì£¼ì—ëŠ” ë“œë””ì–´ CNIì˜ ëíŒ ì™•(ì œê°€ ì•„ëŠ” í•œì—ì„œ)ì¸ Ciliumì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
ì–´ë–¤ ê²ƒë“¤ì´ ê°€ëŠ¥í• ì§€ ê¶ê¸ˆí•©ë‹ˆë‹¤. 
KANS 3ê¸° 8ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr>

<h2 id="cilium">Cilium</h2>

<p>Ciliumì€ eBPF(Berkeley Packet Filter)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ë° ë¼ìš°íŒ…ì„ ì œê³µí•˜ëŠ” CNI(Container Network Interface) í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.
ë¨¼ì € Ciliumì˜ ê·¼ê°„ì´ ë˜ëŠ” eBPFì— ëŒ€í•´ ê°„ë‹¨íˆ ì†Œê°œí•˜ê³ , Ciliumì— ëŒ€í•œ ì†Œê°œì™€ ì‹¤ìŠµì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h3 id="bpfebpf-ì†Œê°œ">BPF/eBPF ì†Œê°œ</h3>

<ul>
  <li>ì†Œê°œê¸€ : <a href="https://hyeyoo.com/133">ë§í¬</a>
</li>
</ul>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_1.png" alt="img.png" class="image-center" loading="lazy" width="350" height="263">
<em class="image-caption">ê¸°ì¡´ ë¦¬ëˆ…ìŠ¤ Netfilter ê¸°ë°˜ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒ</em></p>

<p>ê¸°ì¡´ì˜ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì€ Netfilter ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ë©°, ë³µì¡í•œ ë„¤íŠ¸ì›Œí¬ ë ˆì´ì–´ë¥¼ ê±°ì³ì•¼í•˜ê³  ì´ ë ˆì´ì–´ë¥¼ ê±´ë„ˆë›°ê¸° ì–´ë µìŠµë‹ˆë‹¤.
ë˜í•œ kube-proxyì™€ ê°™ì€ userland í”„ë¡œì„¸ìŠ¤ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. 
ê·¸ëŸ¬ë‹¤ë³´ë‹ˆ ì˜¤ë²„í—¤ë“œê°€ ì»¤ì ¸ì„œ ì„±ëŠ¥ì´ ë–¨ì–´ì§€ê³ , ë£°ì´ ë³µì¡í•´ì§ˆ ê²½ìš° ìˆ˜ ë§ì€ ë£°ì„ ê´€ë¦¬í•´ì•¼í•˜ëŠ” ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_2.png" alt="img_1.png" class="image-center" loading="lazy" width="302" height="266">
<em class="image-caption">eBPF ê¸°ë°˜ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒ</em></p>

<p>eBPFëŠ” ì»¤ë„ ë‚´ë¶€ì—ì„œ ë™ì‘í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
íŠ¹íˆ ìƒŒë“œë°•ìŠ¤ ë°©ì‹ì„ í†µí•´ eBPF í”„ë¡œê·¸ë¨ì´ ì»¤ë„ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šë„ë¡ ë³´í˜¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
ì¦‰, eBPF í”„ë¡œê·¸ë¨ì´ ì˜ëª»ëœ ë™ì‘ì„ í•˜ë”ë¼ë„ ì»¤ë„ íŒ¨ë‹‰ë“±ì˜ ë°œìƒì´ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤.</p>

<p>ë˜í•œ XDP(eXpress Data Path)ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìœ¼ë©°, 
ì´ XDPëŠ” ë„¤íŠ¸ì›Œí¬ ì¹´ë“œ(Offloaded mode), ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„(Native mode), ì»¤ë„ ìŠ¤í˜ì´ìŠ¤(Generic Mode)ì—ì„œ
ë™ì‘í•˜ì—¬ í›¨ì”¬ ë¹ ë¥´ê²Œ íŒ¨í‚·ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_3.png" alt="img.png" class="image-center w-80" loading="lazy" width="772" height="390">
<em class="image-caption">iptablesì™€ eBPF ì„±ëŠ¥ ë¹„êµ</em></p>

<ul>
  <li>eBPF í™œìš©ì²˜
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_4.png" alt="img.png" class="image-center w-80" loading="lazy" width="1086" height="262">
    <ul>
      <li>
<strong>Security</strong> (ë³´ì•ˆ) : eBPFëŠ” í•˜ë“œì›¨ì–´ ë ˆë²¨ì—ì„œ ë¶€í„° ëª¨ë“  ì‹œìŠ¤í…œ ì½œì„ ì´í•´í•˜ê³  ì²˜ë¦¬í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë³´ë‹¤ ë” ì„¸ë°€í•˜ê³  ê°•ë ¥í•œ ë³´ì•ˆ ì •ì±…ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>
<strong>Tracing &amp; Profiling</strong> (ì¶”ì  ë° í”„ë¡œíŒŒì¼ë§) : eBPFëŠ” ì»¤ë„ ë‚´ë¶€ì˜ ëª¨ë“  ì´ë²¤íŠ¸ë¥¼ ì¶”ì í•˜ê³  í”„ë¡œíŒŒì¼ë§ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ì¡´ì— í•´ê²°í•˜ê¸° ì–´ë ¤ì› ë˜ ì„±ëŠ¥ ë¬¸ì œë“¤ë„ eBPFë¥¼ í†µí•´ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>
<strong>Networking</strong> (ë„¤íŠ¸ì›Œí‚¹) : eBPFëŠ” ì»¤ë„ ìŠ¤í˜ì´ìŠ¤ë¥¼ ë– ë‚˜ì§€ ì•Šê³  ìƒˆë¡œìš´ í”„ë¡œí† ì½œì„ ë§Œë“ ë‹¤ë˜ì§€, ë¼ìš°íŒ…ì„ êµ¬í˜„í•˜ëŠ” ë“±ì˜ ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ ê¸°ëŠ¥ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>
<strong>Observability</strong> (ê°€ì‹œì„±) : ì»¤ë„ë‚´ë¶€ì—ì„œ ë‹¤ì–‘í•œ ì†ŒìŠ¤ì—ì„œ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ê³ , ì²˜ë¦¬í•  ìˆ˜ ìˆê³ , ì¼ë¶€ ë°ì´í„°ë§Œ ìƒ˜í”Œë§í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ëª¨ë“  ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="cilium-ì†Œê°œ">Cilium ì†Œê°œ</h3>

<ul>
  <li>
<strong>Cilium</strong>ì€ ê¸°ì¡´ì˜ ë³µì¡í•œ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ <strong>eBPF</strong>ë¥¼ í†µí•´ <strong>ê°„ì†Œí™”</strong>í•˜ê³ , <strong>ë¹ ë¥´ê²Œ ì²˜ë¦¬</strong>í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” CNI í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_5.png" alt="img.png" class="image-center w-80" loading="lazy" width="1600" height="1025">
<em class="image-caption"><a href="https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/">https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/</a></em></p>

<ul>
  <li>Cilium eBPFëŠ” ì¶”ê°€ì ì¸ ì½”ë“œ ìˆ˜ì •ì´ë‚˜ ì„¤ì • ë³€ê²½ì—†ì´, ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ ë™ì‘í•˜ëŠ” Bytecodeë¥¼ ììœ ë¡­ê²Œ í”„ë¡œê·¸ë˜ë°í•˜ì—¬ ì»¤ë„ì— ë¡œë”©ì‹œì¼œ ë™ì‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. <a href="https://www.youtube.com/watch?v=qsnR-s4XuGo&amp;t=1059s">ë§í¬</a>
</li>
  <li>ë˜í•œ eBPFëŠ” ëª¨ë“  íŒ¨í‚·ì„ ê°€ë¡œì±„ê¸° ìœ„í•´ì„œ ìˆ˜ì‹  NICì˜ ingress TC(<a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/">Traffic Control</a>) hooksë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_6.png" alt="img.png" class="image-center w-60" loading="lazy" width="1100" height="644">
<em class="image-caption">NICì˜ TC Hooksì— eBPF í”„ë¡œê·¸ë¨ì´ attach ëœ ì˜ˆ</em>
</li>
  <li>Ciliumì€ í„°ë„ëª¨ë“œ(VXLAN, GENEVE), ë„¤ì´í‹°ë¸Œ ë¼ìš°íŒ… ëª¨ë“œì˜ 2ê°€ì§€ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.
    <ul>
      <li>
<strong>í„°ë„ëª¨ë“œ</strong> : Ciliumì´ VXLAN(UDP 8472), GENEVE(UDP 6081) ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ ì´ë“¤ì„ í†µí•´ íŠ¸ë˜í”½ì„ ì „ë‹¬í•©ë‹ˆë‹¤. Encapsulation ëª¨ë“œë¼ê³ ë„ í•©ë‹ˆë‹¤.</li>
      <li>
<strong>ë„¤ì´í‹°ë¸Œ ë¼ìš°íŒ… ëª¨ë“œ</strong> : Ciliumê°€ íŒ¨í‚· ì „ë‹¬ì„ ìœ„í•´ êµ¬ì„±ì„ ë³€ê²½í•˜ì§€ ì•Šê³ , ì™¸ë¶€ì—ì„œ ì œê³µë˜ëŠ” íŒ¨í‚· ì „ë‹¬ ë°©ë²•(í´ë¼ìš°ë“œ ë˜ëŠ” BGP ë¼ìš°íŒ…ë“±)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. Direct Routing ëª¨ë“œë¼ê³ ë„ í•©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_7.png" alt="img.png" class="image-center w-80" loading="lazy" width="946" height="481">
<em class="image-caption">Cilium ë„¤íŠ¸ì›Œí¬ ëª¨ë“œ - <a href="https://docs.cilium.io/en/stable/network/concepts/routing/">ë§í¬</a></em>
</li>
    </ul>
  </li>
  <li>2021ë…„ 10ì›” Ciliumì€ CNCFì— ì±„íƒë˜ì—ˆìŠµë‹ˆë‹¤. <a href="https://cilium.io/blog/2021/10/13/cilium-joins-cncf/">ë§í¬</a>
</li>
  <li>Googke GKE dataplaneê³¼ AWS EKS Anywhereì—ì„œ ê¸°ë³¸ CNIë¡œ Ciliumì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. <a href="https://isovalent.com/blog/post/2021-09-aws-eks-anywhere-chooses-cilium/">ë§í¬</a>
</li>
  <li>Ciliumì€ Kube-Proxyë¥¼ 100% ëŒ€ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    <ul>
      <li>iptablesë¥¼ ê±°ì˜ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ ë™ì‘í•˜ë©°, ì´ë¥¼ í†µí•´ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>í•˜ì§€ë§Œ istio, FHRP, VRRP ë“±ê³¼ ê°™ì´ iptables ê¸°ëŠ¥ì„ í™œìš©í•˜ëŠ” ë™ì‘ë“¤ì€ ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©°, ì°¨ì¸° í•´ê²°í•´ ë‚˜ê°€ê³  ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h4 id="cilium-ì•„í‚¤í…ì³">Cilium ì•„í‚¤í…ì³</h4>

<ul>
  <li>êµ¬ì„±ìš”ì†Œ - <a href="https://ssup2.github.io/blog-software/docs/theory-analysis/kubernetes-cilium-plugin/">ë§í¬</a>
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_8.png" alt="img.png" class="image-center w-80" loading="lazy" width="2048" height="1664">
<em class="image-caption">Cilium ì•„í‚¤í…ì³ - <a href="https://github.com/cilium/cilium">ì¶œì²˜</a></em>
    <ul>
      <li>Cilium <strong>Agent</strong> : ë°ëª¬ì…‹ìœ¼ë¡œ ì‹¤í–‰, K8S API ì„¤ì •ìœ¼ë¡œ ë¶€í„° â€˜ë„¤íŠ¸ì›Œí¬ ì„¤ì •, ë„¤íŠ¸ì›Œí¬ ì •ì±…, ì„œë¹„ìŠ¤ ë¶€í•˜ë¶„ì‚°, ëª¨ë‹ˆí„°ë§â€™ ë“±ì„ ìˆ˜í–‰í•˜ë©°, eBPF í”„ë¡œê·¸ë¨ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
      <li>Cilium <strong>Client</strong> (CLI) : Cilium ì»¤ë©˜ë“œíˆ´ë¡œ eBPF maps ì— ì§ì ‘ ì ‘ì†í•˜ì—¬ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>Cilium <strong>Operator</strong> : K8S í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ í•œ ë²ˆì”© ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ì‘ì—…ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</li>
      <li>
<strong>Hubble</strong> : ë„¤íŠ¸ì›Œí¬ì™€ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ í”Œë«í¼ ì—­í• ì„ í•˜ì—¬, Server, Relay, Client, Graphical UI ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
      <li>
<strong>Data Store</strong> : Cilium Agent ê°„ì˜ ìƒíƒœë¥¼ ì €ì¥í•˜ê³  ì „íŒŒí•˜ëŠ” ë°ì´í„° ì €ì¥ì†Œ, 2ê°€ì§€ ì¢…ë¥˜ ì¤‘ ì„ íƒ(K8S CRDs, Key-Value Store)í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="cilium-ì‹¤ìŠµ">Cilium ì‹¤ìŠµ</h3>

<p>ì‹¤ìŠµì„ í†µí•´ Cilium CNIì— ëŒ€í•´ì„œ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤. ë¨¼ì € Ciliumì„ ì„¤ì¹˜í•˜ê³ , ê¸°ë³¸ì ì¸ ì„¤ì •ì„ í™•ì¸í•˜ê³ , ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ì„¤ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h4 id="cilium-ì„¤ì¹˜">Cilium ì„¤ì¹˜</h4>

<h5 id="helmì„-í†µí•œ-ì„¤ì¹˜-ë°-í™•ì¸">Helmì„ í†µí•œ ì„¤ì¹˜ ë° í™•ì¸</h5>

<ul>
  <li>helm ì˜µì…˜ : <a href="https://docs.cilium.io/en/stable/helm-reference/">https://docs.cilium.io/en/stable/helm-reference/</a>
</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get node,pod <span class="nt">-A</span> <span class="nt">-owide</span>

<span class="c">#</span>
<span class="nv">$ </span>helm repo add cilium https://helm.cilium.io/
<span class="c"># =&gt; &amp;quot;cilium&amp;quot; has been added to your repositories</span>
<span class="nv">$ </span>helm repo update
<span class="c"># =&gt; ...Successfully got an update from the &amp;quot;cilium&amp;quot; chart repository</span>
<span class="c">#    Update Complete. âˆHappy Helming!âˆ</span>

<span class="c">#</span>
<span class="nv">$ </span>helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> 1.16.3 <span class="nt">--namespace</span> kube-system <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.10 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">rollOutCiliumPods</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.hostRouting<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> endpointRoutes.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> ipam.mode<span class="o">=</span>kubernetes <span class="nt">--set</span> k8s.requireIPv4PodCIDR<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>192.168.0.0/16 <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns:query;ignoreAAAA,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.replicas<span class="o">=</span>1
<span class="c"># =&gt; NAME: cilium</span>
<span class="c">#    LAST DEPLOYED: Sat Oct 01 07:23:34 2024</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    You have successfully installed Cilium with Hubble Relay and Hubble UI.</span>
<span class="c">#    </span>
<span class="c">#    Your release version is 1.16.3.</span>
<span class="c">#    </span>
<span class="c">#    For any further help, visit https://docs.cilium.io/en/v1.16/gettinghelp</span>

<span class="c">## ì£¼ìš” íŒŒë¼ë¯¸í„° ì„¤ëª…</span>
<span class="c"># --set debug.enabled=true # cilium íŒŒë“œì— ë¡œê·¸ ë ˆë²¨ì„ debug ì„¤ì •</span>
<span class="c"># --set autoDirectNodeRoutes=true # ë™ì¼ ëŒ€ì—­ ë‚´ì˜ ë…¸ë“œë“¤ ë¼ë¦¬ëŠ” ìƒëŒ€ ë…¸ë“œì˜ podCIDR ëŒ€ì—­ì˜ ë¼ìš°íŒ…ì´ ìë™ìœ¼ë¡œ ì„¤ì •</span>
<span class="c"># --set endpointRoutes.enabled=true # í˜¸ìŠ¤íŠ¸ì— endpoint(íŒŒë“œ)ë³„ ê°œë³„ ë¼ìš°íŒ… ì„¤ì •</span>
<span class="c"># --set hubble.relay.enabled=true --set hubble.ui.enabled=true # hubble í™œì„±í™”</span>
<span class="c"># --set ipam.mode=kubernetes --set k8s.requireIPv4PodCIDR=true # k8s IPAM í™œìš©</span>
<span class="c"># --set kubeProxyReplacement=true # kube-proxy ì—†ì´ (ìµœëŒ€í•œ) ëŒ€ì²˜í• ìˆ˜ ìˆìˆ˜ ìˆê²Œ</span>
<span class="c"># --set ipv4NativeRoutingCIDR=192.168.0.0/16 # í•´ë‹¹ ëŒ€ì—­ê³¼ í†µì‹  ì‹œ IP Masq í•˜ì§€ ì•ŠìŒ, ë³´í†µ ì‚¬ë‚´ë§ ëŒ€ì—­ì„ ì§€ì •</span>
<span class="c"># --set operator.replicas=1 # cilium-operator íŒŒë“œ ê¸°ë³¸ 1ê°œ</span>
<span class="c"># --set enableIPv4Masquerade=true --set bpf.masquerade=true # íŒŒë“œë¥¼ ìœ„í•œ Masquerade , ì¶”ê°€ë¡œ Masquerade ì„ BPF ë¡œ ì²˜ë¦¬ &gt;&gt; enableIPv4Masquerade=true ì¸ ìƒíƒœì—ì„œ ì¶”ê°€ë¡œ bpf.masquerade=true ì ìš©ì´ ê°€ëŠ¥</span>

<span class="c"># ì„¤ì • ë° í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    4: cilium_net@cilium_host: &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether 3a:03:2f:7e:cc:72 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::3803:2fff:fe7e:cc72/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    5: cilium_host@cilium_net: &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether ca:73:d2:a6:00:b4 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 172.16.0.227/32 scope global cilium_host</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::c873:d2ff:fea6:b4/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get node,pod,svc <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAME          STATUS   ROLES                  AGE     VERSION        INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION       CONTAINER-RUNTIME</span>
<span class="c">#    node/k3s-m    Ready    control-plane,master   3h58m   v1.30.5+k3s1   192.168.10.10    &amp;lt;none&amp;gt;        Ubuntu 22.04.5 LTS   5.15.0-119-generic   containerd://1.7.21-k3s2</span>
<span class="c">#    node/k3s-w1   Ready    &amp;lt;none&amp;gt;                 3h57m   v1.30.5+k3s1   192.168.10.101   &amp;lt;none&amp;gt;        Ubuntu 22.04.5 LTS   5.15.0-119-generic   containerd://1.7.21-k3s2</span>
<span class="c">#    node/k3s-w2   Ready    &amp;lt;none&amp;gt;                 3h55m   v1.30.5+k3s1   192.168.10.102   &amp;lt;none&amp;gt;        Ubuntu 22.04.5 LTS   5.15.0-119-generic   containerd://1.7.21-k3s2</span>
<span class="c">#    </span>
<span class="c">#    NAMESPACE     NAME                                          READY   STATUS    RESTARTS         AGE     IP               NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system   pod/cilium-envoy-9q7c6                        1/1     Running   0                5m19s   192.168.10.102   k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/cilium-ljv9t                              1/1     Running   0                5m19s   192.168.10.101   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/cilium-operator-76bb588dbc-gxrqx          1/1     Running   0                5m19s   192.168.10.101   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/cilium-q96l4                              1/1     Running   0                5m19s   192.168.10.102   k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/coredns-7b98449c4-x5756                   1/1     Running   0                2m59s   172.16.1.21      k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/hubble-relay-88f7f89d4-fcq2s              1/1     Running   0                5m19s   172.16.1.99      k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/hubble-ui-59bb4cb67b-r48tz                2/2     Running   0                5m19s   172.16.0.238     k3s-m    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/local-path-provisioner-6795b5f9d8-84m96   1/1     Running   11 (5m28s ago)   3h58m   172.16.2.184     k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   pod/metrics-server-cdcc87586-g5m2d            1/1     Running   11 (5m10s ago)   3h58m   172.16.2.223     k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAMESPACE     NAME                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE     SELECTOR</span>
<span class="c">#    default       service/kubernetes       ClusterIP   10.10.200.1     &amp;lt;none&amp;gt;        443/TCP                  3h58m   &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system   service/cilium-envoy     ClusterIP   None            &amp;lt;none&amp;gt;        9964/TCP                 5m19s   k8s-app=cilium-envoy</span>
<span class="c">#    kube-system   service/hubble-metrics   ClusterIP   None            &amp;lt;none&amp;gt;        9965/TCP                 5m19s   k8s-app=cilium</span>
<span class="c">#    kube-system   service/hubble-peer      ClusterIP   10.10.200.203   &amp;lt;none&amp;gt;        443/TCP                  5m19s   k8s-app=cilium</span>
<span class="c">#    kube-system   service/hubble-relay     ClusterIP   10.10.200.175   &amp;lt;none&amp;gt;        80/TCP                   5m19s   k8s-app=hubble-relay</span>
<span class="c">#    kube-system   service/hubble-ui        ClusterIP   10.10.200.125   &amp;lt;none&amp;gt;        80/TCP                   5m19s   k8s-app=hubble-ui</span>
<span class="c">#    kube-system   service/kube-dns         ClusterIP   10.10.200.10    &amp;lt;none&amp;gt;        53/UDP,53/TCP,9153/TCP   3h58m   k8s-app=kube-dns</span>
<span class="c">#    kube-system   service/metrics-server   ClusterIP   10.10.200.180   &amp;lt;none&amp;gt;        443/TCP                  3h58m   k8s-app=metrics-server</span>

<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
<span class="nv">$ </span>conntrack <span class="nt">-L</span>

<span class="nv">$ </span>kubectl get crd | <span class="nb">grep </span>cilium
<span class="c"># =&gt; ciliumcidrgroups.cilium.io                   2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumclusterwidenetworkpolicies.cilium.io   2024-10-01T11:10:58Z</span>
<span class="c">#    ciliumendpoints.cilium.io                    2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumexternalworkloads.cilium.io            2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumidentities.cilium.io                   2024-10-01T11:10:58Z</span>
<span class="c">#    ciliuml2announcementpolicies.cilium.io       2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumloadbalancerippools.cilium.io          2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumnetworkpolicies.cilium.io              2024-10-01T11:10:58Z</span>
<span class="c">#    ciliumnodeconfigs.cilium.io                  2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumnodes.cilium.io                        2024-10-01T11:10:57Z</span>
<span class="c">#    ciliumpodippools.cilium.io                   2024-10-01T11:10:57Z</span>
<span class="nv">$ </span>kubectl get ciliumnodes <span class="c"># cilium_host ì¸í„°í˜ì´ìŠ¤ì˜ IP í™•ì¸ : CILIUMINTERNALIP</span>
<span class="c"># =&gt; NAME     CILIUMINTERNALIP   INTERNALIP       AGE</span>
<span class="c">#    k3s-m    172.16.0.227       192.168.10.10    21m</span>
<span class="c">#    k3s-w1   172.16.1.82        192.168.10.101   21m</span>
<span class="c">#    k3s-w2   172.16.2.25        192.168.10.102   21m</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE     NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    kube-system   coredns-7b98449c4-x5756                   11970               ready            172.16.1.21</span>
<span class="c">#    kube-system   hubble-relay-88f7f89d4-fcq2s              4124                ready            172.16.1.99</span>
<span class="c">#    kube-system   hubble-ui-59bb4cb67b-r48tz                37523               ready            172.16.0.238</span>
<span class="c">#    kube-system   local-path-provisioner-6795b5f9d8-84m96   11088               ready            172.16.2.184</span>
<span class="c">#    kube-system   metrics-server-cdcc87586-g5m2d            27624               ready            172.16.2.223</span>

<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq

<span class="nv">$ </span>kubetail <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium <span class="nt">--since</span> 1h
<span class="nv">$ </span>kubetail <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium-envoy <span class="nt">--since</span> 1h

<span class="c"># Native XDP ì§€ì› NIC í™•ì¸ : https://docs.cilium.io/en/stable/bpf/progtypes/#xdp-drivers</span>
<span class="nv">$ </span>ethtool <span class="nt">-i</span> enp0s8
<span class="c"># =&gt; driver: virtio_net   # &gt;= XDP 4.10 ë¶€í„° ì§€ì›ë˜ëŠ”ë“¯ í•©ë‹ˆë‹¤.</span>
<span class="c">#    version: 1.0.0</span>
<span class="c">#    ...</span>

<span class="c"># https://docs.cilium.io/en/stable/operations/performance/tuning/#bypass-iptables-connection-tracking</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod <span class="nt">-A</span> <span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Release &amp;quot;cilium&amp;quot; has been upgraded. Happy Helming!</span>
<span class="c">#    NAME: cilium</span>
<span class="c">#    LAST DEPLOYED: Sat Oct 01 11:42:10 2024</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 2</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    You have successfully installed Cilium with Hubble Relay and Hubble UI.</span>
<span class="c">#    </span>
<span class="c">#    Your release version is 1.16.3.</span>
<span class="c">#    </span>
<span class="c">#    For any further help, visit https://docs.cilium.io/en/v1.16/gettinghelp</span>

<span class="c"># í™•ì¸: ê¸°ì¡´ raw ì— ì•„ë˜ rule ì¶”ê°€ í™•ì¸</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span> | <span class="nb">grep </span>notrack
<span class="c"># =&gt; -A CILIUM_OUTPUT_raw -d 192.168.0.0/16 -m comment --comment "cilium: NOTRACK for pod traffic" -j CT --notrack</span>
<span class="c">#    -A CILIUM_OUTPUT_raw -s 192.168.0.0/16 -m comment --comment "cilium: NOTRACK for pod traffic" -j CT --notrack</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>conntrack <span class="nt">-F</span>
<span class="nv">$ </span>conntrack <span class="nt">-L</span>
<span class="nv">$ </span>conntrack <span class="nt">-L</span> |grep <span class="nt">-v</span> 2379
</code></pre></div></div>

<h5 id="cilium-clië¥¼-í†µí•œ-í™•ì¸">Cilium CLIë¥¼ í†µí•œ í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium CLI ì„¤ì¹˜</span>
<span class="nv">$ CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">$ CLI_ARCH</span><span class="o">=</span>amd64
<span class="nv">$ </span><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi</span>
<span class="nv">$ </span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
<span class="nv">$ </span><span class="nb">sha256sum</span> <span class="nt">--check</span> cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz.sha256sum
<span class="nv">$ </span><span class="nb">sudo tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nv">$ </span><span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>

<span class="c"># í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>cilium status <span class="nt">--wait</span>
<span class="c"># =&gt;     /Â¯Â¯\</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Cilium:             OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Operator:           OK</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Envoy DaemonSet:    OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Hubble Relay:       OK</span>
<span class="c">#        \__/       ClusterMesh:        disabled</span>
<span class="c">#    </span>
<span class="c">#    DaemonSet              cilium             Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    DaemonSet              cilium-envoy       Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    Deployment             cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Deployment             hubble-relay       Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Deployment             hubble-ui          Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Containers:            cilium             Running: 3</span>
<span class="c">#                           cilium-envoy       Running: 3</span>
<span class="c">#                           cilium-operator    Running: 1</span>
<span class="c">#                           hubble-relay       Running: 1</span>
<span class="c">#                           hubble-ui          Running: 1</span>
<span class="c">#    Cluster Pods:          5/5 managed by Cilium</span>
<span class="c">#    Helm chart version:    1.16.3</span>
<span class="c">#    Image versions         cilium             quay.io/cilium/cilium:v1.16.3@sha256:62d2a09bbef840a46099ac4c69421c90f84f28d018d479749049011329aa7f28: 3</span>
<span class="c">#                           cilium-envoy       quay.io/cilium/cilium-envoy:v1.29.9-1728346947-0d05e48bfbb8c4737ec40d5781d970a550ed2bbd@sha256:42614a44e508f70d03a04470df5f61e3cffd22462471a0be0544cf116f2c50ba: 3</span>
<span class="c">#                           cilium-operator    quay.io/cilium/operator-generic:v1.16.3@sha256:6e2925ef47a1c76e183c48f95d4ce0d34a1e5e848252f910476c3e11ce1ec94b: 1</span>
<span class="c">#                           hubble-relay       quay.io/cilium/hubble-relay:v1.16.3@sha256:feb60efd767e0e7863a94689f4a8db56a0acc7c1d2b307dee66422e3dc25a089: 1</span>
<span class="c">#                           hubble-ui          quay.io/cilium/hubble-ui-backend:v0.13.1@sha256:0e0eed917653441fded4e7cdb096b7be6a3bddded5a2dd10812a27b1fc6ed95b: 1</span>
<span class="c">#                           hubble-ui          quay.io/cilium/hubble-ui:v0.13.1@sha256:e2e9313eb7caf64b0061d9da0efbdad59c6c461f6ca1752768942bfeda0796c6: 1</span>

<span class="nv">$ </span>cilium connectivity <span class="nb">test</span>

<span class="nv">$ </span>cilium config view
<span class="c"># =&gt; agent-not-ready-taint-key                         node.cilium.io/agent-not-ready</span>
<span class="c">#    arping-refresh-period                             30s</span>
<span class="c">#    auto-direct-node-routes                           true</span>
<span class="c">#    bpf-events-drop-enabled                           true</span>
<span class="c">#    bpf-events-policy-verdict-enabled                 true</span>
<span class="c">#    bpf-events-trace-enabled                          true</span>
<span class="c">#    bpf-lb-acceleration                               disabled</span>
<span class="c">#    bpf-lb-external-clusterip                         false</span>
<span class="c">#    bpf-lb-map-max                                    65536</span>
<span class="c">#    bpf-lb-sock                                       false</span>
<span class="c">#    bpf-lb-sock-terminate-pod-connections             false</span>
<span class="c">#    bpf-map-dynamic-size-ratio                        0.0025</span>
<span class="c">#    bpf-policy-map-max                                16384</span>
<span class="c">#    bpf-root                                          /sys/fs/bpf</span>
<span class="c">#    ...</span>
<span class="c">#    ipv4-native-routing-cidr                          192.168.0.0/16</span>
<span class="c">#    ...</span>
<span class="c">#    kube-proxy-replacement                            true</span>
<span class="c">#    kube-proxy-replacement-healthz-bind-address</span>
<span class="c">#    max-connected-clusters                            255</span>
<span class="c">#    mesh-auth-enabled                                 true</span>
<span class="c">#    ...</span>

<span class="c"># cilium ë°ëª¬ì…‹ íŒŒë“œ ë‚´ì—ì„œ cilium ëª…ë ¹ì–´ë¡œ ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k3s-m  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span>c0 status <span class="nt">--verbose</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    KubeProxyReplacement:   True   [enp0s3   10.0.2.15 fe80::6d:daff:feb3:d4d3, enp0s8   192.168.10.10 fe80::27ff:fe8a:de00 (Direct Routing)]</span>
<span class="c">#    ...</span>
<span class="c">#    IPAM:                   IPv4: 4/254 allocated from 172.16.0.0/24, </span>
<span class="c">#    Allocated addresses:</span>
<span class="c">#      172.16.0.223 (kube-system/hubble-ui-59bb4cb67b-r48tz)</span>
<span class="c">#      172.16.0.227 (router)</span>
<span class="c">#      172.16.0.26 (health)</span>
<span class="c">#      172.16.0.44 (cilium-test-1/client3-67f959dd9b-ptl65)</span>
<span class="c">#    ...</span>
<span class="c">#    Routing:                Network: Native   Host: BPF</span>
<span class="c">#    ...</span>
<span class="c">#    Device Mode:            veth</span>
<span class="c">#    Masquerading:           BPF   [ens5]   192.168.0.0/16 [IPv4: Enabled, IPv6: Disabled]</span>
<span class="c">#    ...  </span>
<span class="c">#    Proxy Status:            OK, ip 172.16.0.227, 0 redirects active on ports 10000-20000, Envoy: external</span>
<span class="c">#    ...</span>
<span class="c">#    KubeProxyReplacement Details:</span>
<span class="c">#      Status:                 True</span>
<span class="c">#      Socket LB:              Enabled</span>
<span class="c">#      Socket LB Tracing:      Enabled</span>
<span class="c">#      Socket LB Coverage:     Full</span>
<span class="c">#      Devices:                enp0s3   10.0.2.15 fe80::6d:daff:feb3:d4d3, enp0s8   192.168.10.10 fe80::27ff:fe8a:de00 (Direct Routing)</span>
<span class="c">#      Mode:                   SNAT</span>
<span class="c">#      Backend Selection:      Random</span>
<span class="c">#      Session Affinity:       Enabled</span>
<span class="c">#      Graceful Termination:   Enabled</span>
<span class="c">#      NAT46/64 Support:       Disabled</span>
<span class="c">#      XDP Acceleration:       Disabled</span>
<span class="c">#      Services:</span>
<span class="c">#      - ClusterIP:      Enabled</span>
<span class="c">#      - NodePort:       Enabled (Range: 30000-32767) </span>
<span class="c">#      - LoadBalancer:   Enabled </span>
<span class="c">#      - externalIPs:    Enabled </span>
<span class="c">#      - HostPort:       Enabled</span>
<span class="c">#    BPF Maps:   dynamic sizing: on (ratio: 0.002500)</span>
<span class="c">#    ...</span>

<span class="c"># Native Routing í™•ì¸ : # 192.168.0.0/16 ëŒ€ì—­ì€ IP Masq ì—†ì´ ë¼ìš°íŒ…</span>
<span class="nv">$ </span>c0 status | <span class="nb">grep </span>KubeProxyReplacement
<span class="c"># =&gt; KubeProxyReplacement:    True   [enp0s3   10.0.2.15 fe80::6d:daff:feb3:d4d3, enp0s8   192.168.10.10 fe80::27ff:fe8a:de00 (Direct Routing)]</span>

<span class="c"># enableIPv4Masquerade=true(ê¸°ë³¸ê°’) , bpf.masquerade=true í™•ì¸</span>
<span class="nv">$ </span>cilium config view | egrep <span class="s1">'enable-ipv4-masquerade|enable-bpf-masquerade'</span>
<span class="c"># =&gt; enable-bpf-masquerade                             true</span>
<span class="c">#    enable-ipv4-masquerade                            true</span>

<span class="nv">$ </span>c0 status <span class="nt">--verbose</span> | <span class="nb">grep </span>Masquerading
<span class="c"># =&gt; Masquerading:           BPF   [enp0s3, enp0s8]   192.168.0.0/16 [IPv4: Enabled, IPv6: Disabled]</span>

<span class="c"># Configure the eBPF-based ip-masq-agent</span>
<span class="c"># https://docs.cilium.io/en/stable/network/concepts/masquerading/</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="nt">--set</span> ipMasqAgent.enabled<span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Release &amp;quot;cilium&amp;quot; has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> masq
<span class="c"># =&gt; enable-bpf-masquerade                             true</span>
<span class="c">#    enable-ip-masq-agent                              true</span>
<span class="c">#    ...</span>

<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k3s-m  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span>c0 status <span class="nt">--verbose</span> | <span class="nb">grep </span>Masquerading
<span class="c"># =&gt; Masquerading:           BPF (ip-masq-agent)   [enp0s3, enp0s8]   192.168.0.0/16 [IPv4: Enabled, IPv6: Disabled]</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ BPFê°€ BPF (ip-masq-agent)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ip-masq-agentëŠ” k8s í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ IP ë§ˆìŠ¤ì»¤ë ˆì´ë”©ì„ ê´€ë¦¬í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ë¡œ,&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ë§ˆìŠ¤ì»¤ë ˆì´ë”© ì—¬ë¶€ë¥¼ ê²°ì •í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ìì› ì‚¬ìš©ì„ ìµœì í™” í•´ì¤ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> yaml  | <span class="nb">grep </span>ip-masq
<span class="c"># =&gt;   enable-ip-masq-agent: &amp;quot;true&amp;quot;</span>
</code></pre></div></div>

<h4 id="cilium-ê¸°ë³¸ì •ë³´-í™•ì¸">Cilium ê¸°ë³¸ì •ë³´ í™•ì¸</h4>

<h5 id="ë³€ìˆ˜--ë‹¨ì¶•í‚¤">ë³€ìˆ˜ &amp; ë‹¨ì¶•í‚¤</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium íŒŒë“œ ì´ë¦„</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k3s-m  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k3s-w1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k3s-w2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>

<span class="c"># ë‹¨ì¶•í‚¤(alias) ì§€ì •</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>

<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>

<span class="c"># Hubble UI ì›¹ ì ‘ì†</span>
<span class="nv">$ </span>kubectl patch <span class="nt">-n</span> kube-system svc hubble-ui <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>
<span class="c"># =&gt; service/hubble-ui patched</span>
<span class="nv">$ HubbleUiNodePort</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> kube-system hubble-ui <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Hubble UI URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$HubbleUiNodePort</span><span class="s2">"</span>
<span class="c"># =&gt; Hubble UI URL = http://54.180.146.116:30732</span>
</code></pre></div></div>

<h5 id="ìì£¼-ì“°ëŠ”-cilium-cli-ëª…ë ¹ì–´">ìì£¼ ì“°ëŠ” Cilium CLI ëª…ë ¹ì–´</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium <span class="nt">-owide</span>
<span class="c"># =&gt; NAME           READY   STATUS    RESTARTS   AGE     IP               NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    cilium-5gx8w   1/1     Running   0          9m12s   192.168.10.102   k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    cilium-92k6s   1/1     Running   0          8m53s   192.168.10.101   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    cilium-zv22g   1/1     Running   0          9m12s   192.168.10.10    k3s-m    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># cilium íŒŒë“œ ì¬ì‹œì‘</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>
<span class="c"># í˜¹ì€</span>
<span class="nv">$ </span>kubectl delete pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium
<span class="c"># =&gt; pod &amp;quot;cilium-5p4q4&amp;quot; deleted</span>
<span class="c">#    pod &amp;quot;cilium-bc7jz&amp;quot; deleted</span>
<span class="c">#    pod &amp;quot;cilium-zqs9l&amp;quot; deleted</span>

<span class="c"># cilium ì„¤ì • ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>cilium config view

<span class="c"># cilium íŒŒë“œì˜ cilium ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>c0 status <span class="nt">--verbose</span>

<span class="c"># cilium ì—”ë“œí¬ì¸íŠ¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE       NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    kube-system     coredns-7b98449c4-x5756                   11970               ready            172.16.1.21</span>
<span class="c">#    kube-system     hubble-relay-88f7f89d4-fcq2s              4124                ready            172.16.1.99</span>
<span class="c">#    kube-system     hubble-ui-59bb4cb67b-r48tz                37523               ready            172.16.0.223</span>
<span class="c">#    kube-system     local-path-provisioner-6795b5f9d8-84m96   11088               ready            172.16.2.184</span>
<span class="c">#    kube-system     metrics-server-cdcc87586-g5m2d            27624               ready            172.16.2.223</span>
<span class="nv">$ </span>c0 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    640        Disabled           Disabled          37523      k8s:app.kubernetes.io/name=hubble-ui                                                172.16.0.223   ready</span>
<span class="c">#                                                               k8s:app.kubernetes.io/part-of=cilium</span>
<span class="c">#                                                               k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#                                                               k8s:k8s-app=hubble-ui</span>
<span class="c">#    1196       Disabled           Disabled          1          k8s:node-role.kubernetes.io/control-plane=true                                                     ready</span>
<span class="c">#                                                               k8s:node-role.kubernetes.io/master=true</span>
<span class="c">#                                                               k8s:node.kubernetes.io/instance-type=k3s</span>
<span class="c">#                                                               reserved:host</span>
<span class="c">#    1598       Disabled           Disabled          4          reserved:health                                                                     172.16.0.26    ready</span>
<span class="nv">$ </span>c0 bpf endpoint list
<span class="c"># =&gt; IP ADDRESS        LOCAL ENDPOINT INFO</span>
<span class="c">#    172.16.0.26:0     id=1598  sec_id=4     flags=0x0000 ifindex=17  mac=CE:24:50:27:35:B9 nodemac=FE:57:C1:AD:A6:28</span>
<span class="c">#    172.16.0.223:0    id=640   sec_id=37523 flags=0x0000 ifindex=9   mac=AE:B8:81:A6:B1:28 nodemac=C2:21:B8:92:DA:FD</span>
<span class="c">#    172.16.0.227:0    (localhost)</span>
<span class="c">#    192.168.10.10:0   (localhost)</span>
<span class="c">#    10.0.2.15:0       (localhost)</span>
<span class="nv">$ </span>c0 map get cilium_lxc
<span class="c"># =&gt; Key              Value                                                                                            State   Error</span>
<span class="c">#    172.16.0.223:0   id=640   sec_id=37523 flags=0x0000 ifindex=9   mac=AE:B8:81:A6:B1:28 nodemac=C2:21:B8:92:DA:FD   sync</span>
<span class="c">#    172.16.0.26:0    id=1598  sec_id=4     flags=0x0000 ifindex=17  mac=CE:24:50:27:35:B9 nodemac=FE:57:C1:AD:A6:28   sync</span>
<span class="nv">$ </span>c0 ip list

<span class="c"># Manage the IPCache mappings for IP/CIDR &lt;-&gt; Identity</span>
<span class="nv">$ </span>c0 bpf ipcache list

<span class="c"># Service/NAT List í™•ì¸</span>
<span class="nv">$ </span>c0 service list
<span class="c"># =&gt; ID   Frontend              Service Type   Backend</span>
<span class="c">#    1    10.10.200.1:443       ClusterIP      1 =&amp;gt; 192.168.10.10:6443 (active)</span>
<span class="c">#    ...</span>
<span class="c">#    6    10.10.200.10:9153     ClusterIP      1 =&amp;gt; 172.16.1.21:9153 (active)</span>
<span class="c">#    7    10.10.200.180:443     ClusterIP      1 =&amp;gt; 172.16.2.223:10250 (active)</span>
<span class="c">#    16   0.0.0.0:30732         NodePort       1 =&amp;gt; 172.16.0.223:8081 (active)</span>
<span class="c">#    17   10.0.2.15:30732       NodePort       1 =&amp;gt; 172.16.0.223:8081 (active)</span>
<span class="c">#    18   192.168.10.10:30732   NodePort       1 =&amp;gt; 172.16.0.223:8081 (active)</span>
<span class="nv">$ </span>c0 bpf lb list
<span class="c"># =&gt; SERVICE ADDRESS           BACKEND ADDRESS (REVNAT_ID) (SLOT)</span>
<span class="c">#    10.10.200.1:443 (0)       0.0.0.0:0 (1) (0) [ClusterIP, non-routable]</span>
<span class="c">#    ...</span>
<span class="c">#    10.10.200.10:9153 (0)     0.0.0.0:0 (6) (0) [ClusterIP, non-routable]</span>
<span class="c">#    10.10.200.180:443 (1)     172.16.2.223:10250 (7) (1)</span>
<span class="c">#    0.0.0.0:30732 (0)         0.0.0.0:0 (16) (0) [NodePort, non-routable]</span>
<span class="c">#    192.168.10.10:30732 (0)   0.0.0.0:0 (18) (0) [NodePort]</span>
<span class="c">#    10.0.2.15:30732 (0)       0.0.0.0:0 (17) (0) [NodePort]</span>
<span class="nv">$ </span>c0 bpf lb list <span class="nt">--revnat</span>
<span class="c"># =&gt; ID   BACKEND ADDRESS (REVNAT_ID) (SLOT)</span>
<span class="c">#    7    10.10.200.180:443</span>
<span class="c">#    6    10.10.200.10:9153</span>
<span class="c">#    ...</span>
<span class="c">#    1    10.10.200.1:443</span>
<span class="c">#    17   10.0.2.15:30732</span>
<span class="c">#    16   0.0.0.0:30732</span>
<span class="c">#    18   192.168.10.10:30732</span>
<span class="nv">$ </span>c0 bpf nat list
<span class="c"># =&gt; TCP OUT 192.168.10.10:34576 -&amp;gt; 192.168.10.101:4240 XLATE_SRC 192.168.10.10:34576 Created=409sec ago NeedsCT=1</span>
<span class="c">#    TCP IN 192.168.10.101:4240 -&amp;gt; 192.168.10.10:34576 XLATE_DST 192.168.10.10:34576 Created=409sec ago NeedsCT=1</span>
<span class="c">#    ICMP OUT 192.168.10.10:35656 -&amp;gt; 172.16.1.224:0 XLATE_SRC 192.168.10.10:35656 Created=169sec ago NeedsCT=1</span>
<span class="c">#    ICMP OUT 192.168.10.10:35656 -&amp;gt; 192.168.10.102:0 XLATE_SRC 192.168.10.10:35656 Created=169sec ago NeedsCT=1</span>
<span class="c">#    ...</span>

<span class="c"># List all open BPF maps</span>
<span class="nv">$ </span>c0 map list
<span class="c"># =&gt; Name                       Num entries   Num errors   Cache enabled</span>
<span class="c">#    cilium_lb4_backends_v3     2             0            true</span>
<span class="c">#    cilium_lb4_source_range    0             0            true</span>
<span class="c">#    cilium_policy_01196        2             0            true</span>
<span class="c">#    cilium_policy_01598        3             0            true</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 map list <span class="nt">--verbose</span>

<span class="c"># List contents of a policy BPF map : Dump all policy maps</span>
<span class="nv">$ </span>c0 bpf policy get <span class="nt">--all</span>
<span class="nv">$ </span>c0 bpf policy get <span class="nt">--all</span> <span class="nt">-n</span>

<span class="c"># cilium monitor</span>
<span class="nv">$ </span>c0 monitor <span class="nt">-v</span>
<span class="c"># =&gt; Listening for events on 4 CPUs with 64x4096 of shared memory</span>
<span class="c">#    Press Ctrl-C to quit</span>
<span class="c">#    time=&amp;quot;2024-10-01T12:11:28Z&amp;quot; level=info msg=&amp;quot;Initializing dissection cache...&amp;quot; subsys=monitor</span>
<span class="c">#    -&amp;gt; network flow 0x206747a1 , identity health-&amp;gt;remote-node state reply ifindex enp0s8 orig-ip 0.0.0.0: 172.16.0.26:4240 -&amp;gt; 192.168.10.102:39142 tcp ACK</span>
<span class="c">#    -&amp;gt; endpoint 1598 flow 0x0 , identity remote-node-&amp;gt;health state established ifindex lxc_health orig-ip 192.168.10.102: 192.168.10.102:39142 -&amp;gt; 172.16.0.26:4240 tcp ACK</span>
<span class="c">#    -&amp;gt; endpoint 640 flow 0x665dd157 , identity host-&amp;gt;37523 state new ifindex lxcdd00fea91485 orig-ip 10.0.2.15: 10.0.2.15:37040 -&amp;gt; 172.16.0.223:8081 tcp SYN</span>
<span class="c">#    -&amp;gt; stack flow 0xf0f2648f , identity 37523-&amp;gt;host state reply ifindex 0 orig-ip 0.0.0.0: 172.16.0.223:8081 -&amp;gt; 10.0.2.15:37040 tcp SYN, ACK</span>
<span class="c">#    -&amp;gt; endpoint 640 flow 0x665dd157 , identity host-&amp;gt;37523 state established ifindex lxcdd00fea91485 orig-ip 10.0.2.15: 10.0.2.15:37040 -&amp;gt; 172.16.0.223:8081 tcp ACK</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ cilium monitorëŠ” ìì²´ì ìœ¼ë¡œ ë§ˆì¹˜ tcpdumpì²˜ëŸ¼ íŒ¨í‚·ì˜ ì´ë™ì„ ëª¨ë‹ˆí„°ë§ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span>c0 monitor <span class="nt">-v</span> <span class="nt">--type</span> l7   <span class="c"># Layer 7 (Application layer) ë§Œì„ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</span>
<span class="c"># =&gt; CPU 01: [pre-xlate-rev] cgroup_id: 5161 sock_cookie: 14187, dst [10.0.2.15]:43070 tcp</span>
<span class="c">#    CPU 01: [pre-xlate-rev] cgroup_id: 2800 sock_cookie: 14188, dst [172.16.0.223]:8081 tcp</span>
<span class="c">#    CPU 01: [pre-xlate-rev] cgroup_id: 5161 sock_cookie: 14189, dst [10.0.2.15]:43080 tcp</span>
<span class="c">#    CPU 01: [pre-xlate-rev] cgroup_id: 2800 sock_cookie: 10103, dst [172.16.0.223]:8081 tcp</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h5 id="ë„¤íŠ¸ì›Œí¬-ê¸°ë³¸-ì •ë³´-í™•ì¸--k3s-w1w2-ì—-ssh-ì ‘ì†-í›„-ip--c-linkroute-ì •ë³´-í™•ì¸">ë„¤íŠ¸ì›Œí¬ ê¸°ë³¸ ì •ë³´ í™•ì¸ : k3s-w1/w2 ì— SSH ì ‘ì† í›„ ip -c link/route ì •ë³´ í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nb">link</span>
<span class="c"># =&gt; lo               UNKNOWN        00:00:00:00:00:00 &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    enp0s3           UP             02:6d:da:b3:d4:d3 &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    enp0s8           UP             08:00:27:35:1b:07 &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    cilium_net@cilium_host UP             16:9d:bb:67:fc:a0 &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    cilium_host@cilium_net UP             7e:ea:43:69:1e:4b &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    lxcb0b60514c056@if10 UP             be:61:78:59:9a:b9 &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    lxcb6d4cfe53c6a@if12 UP             b6:62:74:02:2f:32 &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    lxc_health@if18  UP             aa:7e:99:a8:fd:c3 &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> addr
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8 ::1/128</span>
<span class="c">#    enp0s3           UP             10.0.2.15/24 metric 100 fe80::6d:daff:feb3:d4d3/64</span>
<span class="c">#    enp0s8           UP             192.168.10.101/24 fe80::a00:27ff:fe35:1b07/64</span>
<span class="c">#    cilium_net@cilium_host UP             fe80::149d:bbff:fe67:fca0/64</span>
<span class="c">#    cilium_host@cilium_net UP             172.16.1.82/32 fe80::7cea:43ff:fe69:1e4b/64</span>
<span class="c">#    lxcb0b60514c056@if10 UP             fe80::bc61:78ff:fe59:9ab9/64</span>
<span class="c">#    lxcb6d4cfe53c6a@if12 UP             fe80::b462:74ff:fe02:2f32/64</span>
<span class="c">#    lxc_health@if18  UP             fe80::a87e:99ff:fea8:fdc3/64</span>

<span class="nt">--------------------------------------------</span>
<span class="c"># cilium_net ê³¼ cilium_host ëŠ” veth peer ê´€ê³„ì´ë©°, cilium_host ëŠ” íŒŒë“œì˜ GW IP ì£¼ì†Œë¡œ ì§€ì •ë˜ë©° 32bit ì´ë‹¤</span>
<span class="c"># =&gt; 4: cilium_net@cilium_host: &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether 16:9d:bb:67:fc:a0 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::149d:bbff:fe67:fca0/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    5: cilium_host@cilium_net: &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether 7e:ea:43:69:1e:4b brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 172.16.1.82/32 scope global cilium_host</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::7cea:43ff:fe69:1e4b/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># proxy arp ëŠ” disable(0) ìƒíƒœì´ë©°, íŒŒë“œì™€ ì—°ê²°ëœ lxc ë„ ëª¨ë‘ 0 ì´ë‹¤</span>
<span class="c"># íŒŒë“œì˜ 32bit ipì˜ gw ê°€ ê°ê° ì—°ê²°ëœ veth ì¸í„°í˜ì´ìŠ¤ì˜ mac ìœ¼ë¡œ cilium_host ì˜ IP/MAC ì‘ë‹µì„ ì²˜ë¦¬í•œë‹¤, ì–´ë–»ê²Œ ë™ì‘ì´ ë˜ëŠ”ê±¸ê¹Œìš”? &gt;&gt; eBPF program!!!</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/net/ipv4/conf/cilium_net/proxy_arp
<span class="c"># =&gt; 0</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/net/ipv4/conf/cilium_host/proxy_arp
<span class="c"># =&gt; 0</span>

<span class="c"># lxc_health ì¸í„°í˜ì´ìŠ¤ëŠ” veth ë¡œ cilium(NET NS 0, í˜¸ìŠ¤íŠ¸ì™€ ë‹¤ë¦„)ê³¼ veth pair ì´ë‹¤ - ë§í¬</span>
<span class="c"># cilium ì¸í„°í˜ì´ìŠ¤ì— íŒŒë“œ IPê°€ í• ë‹¹ë˜ì–´ ìˆìœ¼ë©°, cilium-health-responder ë¡œ ë™ì‘í•œë‹¤</span>
<span class="nv">$ </span>lsns <span class="nt">-t</span> net
<span class="c"># =&gt;         NS TYPE NPROCS   PID USER     NETNSID NSFS                                                COMMAND</span>
<span class="c">#    4026531840 net     133     1 root  unassigned                                                     /sbin/init</span>
<span class="c">#    4026532195 net       2  8433 65535          1 /run/netns/cni-0943b57a-e695-904e-87f6-7edb4fb0cd92 /pause</span>
<span class="c">#    4026532350 net       1 18060 root           0                                                     cilium-health-responder --listen 4240 --pidfile /var/run/cilium/state/health-endp</span>
<span class="c">#    4026532359 net       2 10652 65535          2 /run/netns/cni-1b359731-9a53-2db0-eee1-63b0c5643c27 /pause</span>
</code></pre></div></div>

<h4 id="hubble">Hubble</h4>

<p>Cilliumì€ Hubbleì„ í†µí•´ í†µì‹  ë° ì„œë¹„ìŠ¤ì™€ ë„¤íŠ¸ì›Œí‚¹ ì¸í”„ë¼ì˜ ë™ì‘ì— ëŒ€í•œ ì‹¬ì¸µì ì¸ ê°€ì‹œì„±ì„ ì™„ì „íˆ íˆ¬ëª…í•œ ë°©ì‹ìœ¼ë¡œ ê´€ì°°ì„±ì„ ì œê³µí•©ë‹ˆë‹¤. - <a href="https://cilium.io/blog/2019/11/19/announcing-hubble/">ì°¸ê³ </a></p>
<ul>
  <li>Hubbleì€ <strong>ì™„ì „íˆ ë¶„ì‚°ëœ ë„¤íŠ¸ì›Œí‚¹ ë° ë³´ì•ˆ ëª¨ë‹ˆí„°ë§</strong> í”Œë«í¼ì…ë‹ˆë‹¤</li>
  <li>Cilium ê³¼ eBPF ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ë©°, <strong>ì–´í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì •ì—†ì´ë„</strong> ë³´ë‹¤ ì‹¬ë„ìˆëŠ” ê°€ì‹œì„±ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
  <li>Hubbleì€ ì»¨í…Œì´ë„ˆ ê¸°ë°˜ ì›Œí¬ë¡œë“œ ë¿ë§Œ ì•„ë‹ˆë¼ ì „í†µì ì¸ <strong>í‘œì¤€ ë¦¬ëˆ…ìŠ¤ í”„ë¡œì„¸ìŠ¤ë‚˜ VM ê¸°ë°˜ ì›Œí¬ë¡œë“œì— ëŒ€í•´ì„œë„ ê°€ì‹œì„±ì„ ì œê³µ</strong>í•©ë‹ˆë‹¤.</li>
  <li>eBPFë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ì „í†µì ì¸ IP ê¸°ë°˜ì´ ì•„ë‹Œ <strong>ì„œë¹„ìŠ¤/íŒŒë“œ/ì»¨í…Œì´ë„ˆ ìˆ˜ì¤€ì˜ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½</strong>ì— ëŒ€í•´ì„œ ë³´ì•ˆ ê°€ì‹œì„± ë° í†µì œë¥¼ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë˜í•œ <strong>ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆì´ì–´(L7)ì—ì„œ í•„í„°ë§ í•  ìˆ˜ ë„</strong> ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê¸°ë³¸ì ìœ¼ë¡œ Hubble APIëŠ” Cilium ì—ì´ì „íŠ¸ê°€ ì‹¤í–‰ë˜ëŠ” ê°œë³„ ë…¸ë“œì˜ ë²”ìœ„ ë‚´ì—ì„œ ì‘ë™í•©ë‹ˆë‹¤. 
ì´ëŠ” ë„¤íŠ¸ì›Œí¬ í†µì°°ë ¥ì„ ë¡œì»¬ Cilium ì—ì´ì „íŠ¸ê°€ ê´€ì°°í•œ íŠ¸ë˜í”½ìœ¼ë¡œ ì œí•œí•©ë‹ˆë‹¤.<br>
Hubble <strong>CLI</strong>(<code class="language-plaintext highlighter-rouge">hubble</code>)ë¥¼ ì‚¬ìš©í•˜ì—¬ <strong>ë¡œì»¬ Unix Domain Socket</strong>ì„ í†µí•´ ì œê³µëœ <strong>Hubble APIë¥¼ ì¿¼ë¦¬</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Hubble CLI ë°”ì´ë„ˆë¦¬ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Cilium ì—ì´ì „íŠ¸ í¬ë“œì— ì„¤ì¹˜ë©ë‹ˆë‹¤.</li>
  <li>
<strong>Hubble Relay</strong>ë¥¼ ë°°í¬í•˜ë©´ ì „ì²´ í´ëŸ¬ìŠ¤í„° ë˜ëŠ” ClusterMesh ì‹œë‚˜ë¦¬ì˜¤ì˜ ì—¬ëŸ¬ <strong>í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ê°€ì‹œì„±</strong>ì´ ì œê³µë©ë‹ˆë‹¤. ì´ ëª¨ë“œì—ì„œ Hubble ë°ì´í„°ëŠ” Hubble CLI(<code class="language-plaintext highlighter-rouge">hubble</code>)ë¥¼ Hubble Relay ì„œë¹„ìŠ¤ë¡œ ì§€ì •í•˜ê±°ë‚˜ Hubble UIë¥¼ í†µí•´ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Hubble UIëŠ” L3/L4 ë° L7 ê³„ì¸µì—ì„œ ì„œë¹„ìŠ¤ ì¢…ì†ì„± ê·¸ë˜í”„ë¥¼ ìë™ìœ¼ë¡œ ê²€ìƒ‰í•  ìˆ˜ ìˆëŠ” ì›¹ ì¸í„°í˜ì´ìŠ¤ë¡œ, ì‚¬ìš©ì ì¹œí™”ì ì¸ ì‹œê°í™” ë° ì„œë¹„ìŠ¤ ë§µìœ¼ë¡œì„œì˜ ë°ì´í„° íë¦„ í•„í„°ë§ì„ í—ˆìš©í•©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_10.png" alt="img.png" class="image-center w-80" loading="lazy" width="1008" height="486">
<em class="image-caption">Hubble Relayë¥¼ í†µí•œ ì „ì²´ í´ëŸ¬ìŠ¤í„° ëª¨ë‹ˆí„°ë§ <a href="https://cilium.io/blog/2020/06/22/cilium-18/">ë§í¬</a></em>
</li>
  <li>ë©”íŠ¸ë¦­ì€ <strong>Prometheus</strong>ë¡œ ìˆ˜ì§‘ë˜ë©°, <strong>Grafana</strong>ë¥¼ í†µí•´ ì‹œê°í™”í•  ìˆ˜ë„ ìˆì–´ì„œ ê¸°ì¡´ì˜ ëŒ€ì‹œë³´ë“œì™€ í†µí•©ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_9.png" alt="img.png" class="image-center w-80" loading="lazy" width="1008" height="508">
<em class="image-caption"><a href="https://cilium.io/blog/2019/11/19/announcing-hubble/">https://cilium.io/blog/2019/11/19/announcing-hubble/</a></em>
</li>
  <li>Hubble UI í™”ë©´
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_11.png" alt="img.png" class="image-center w-100" loading="lazy" width="1392" height="820">
<em class="image-caption">ì„œë¹„ìŠ¤ ì¢…ì†ì„± ê·¸ë˜í”„</em>
</li>
  <li>í†µì œ ì˜ˆì‹œ
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">/public/.*</code> ê²½ë¡œì— ëŒ€í•œ <code class="language-plaintext highlighter-rouge">GET</code> ìš”ì²­ë§Œ í—ˆìš©í•˜ê³ , ë‹¤ë¥¸ ëª¨ë“  ìš”ì²­ì€ ê±°ë¶€</li>
      <li>
<code class="language-plaintext highlighter-rouge">service1</code>ì´ <code class="language-plaintext highlighter-rouge">topic1</code>ì´ë¼ëŠ” í† í”½ì„ ìƒì‚°í•˜ê³ , <code class="language-plaintext highlighter-rouge">service2</code>ê°€ <code class="language-plaintext highlighter-rouge">topic1</code>ì„ ì†Œë¹„í•˜ë„ë¡ í—ˆìš©í•˜ê³ , ê·¸ ì™¸ì˜ ëª¨ë“  ì¹´í”„ì¹´ ë©”ì‹œì§€ëŠ” ê±°ë¶€</li>
      <li>HTTP í—¤ë”ì— <code class="language-plaintext highlighter-rouge">X-Token: [0-9]+</code>ê°€ í¬í•¨ëœ ëª¨ë“  ìš”ì²­ì„ í—ˆìš©í•˜ê³ , ê·¸ë ‡ì§€ ì•Šì€ ìš”ì²­ì€ ê±°ë¶€</li>
    </ul>
  </li>
</ul>

<h5 id="hubble-uicli-ì ‘ê·¼-ë°-í™•ì¸">Hubble UI/CLI ì ‘ê·¼ ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í™•ì¸</span>
<span class="nv">$ </span>cilium status
<span class="c"># =&gt;     /Â¯Â¯\</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Cilium:             OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Operator:           OK</span>
<span class="c">#     /Â¯Â¯\__/Â¯Â¯\    Envoy DaemonSet:    OK</span>
<span class="c">#     \__/Â¯Â¯\__/    Hubble Relay:       OK</span>
<span class="c">#        \__/       ClusterMesh:        disabled</span>
<span class="c">#    </span>
<span class="c">#    DaemonSet              cilium             Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    ...</span>

<span class="c"># UI íŒŒë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>hubble-ui <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                         READY   STATUS    RESTARTS      AGE    IP             NODE    NOMINATED NODE   READINESS GATES</span>
<span class="c">#    hubble-ui-59bb4cb67b-r48tz   2/2     Running   2 (87m ago)   101m   172.16.0.223   k3s-m   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># Hubble UI ì›¹ ì ‘ì†</span>
<span class="nv">$ </span>kubectl patch <span class="nt">-n</span> kube-system svc hubble-ui <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>
<span class="c"># =&gt; service/hubble-ui patched</span>
<span class="nv">$ HubbleUiNodePort</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> kube-system hubble-ui <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Hubble UI URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$HubbleUiNodePort</span><span class="s2">"</span>
<span class="c"># =&gt; Hubble UI URL = http://54.180.146.116:30732</span>

<span class="c">## Service NodePort ìƒì„± í›„ ì•„ë˜ ì •ë³´ í™•ì¸!</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="c"># =&gt; -P PREROUTING ACCEPT</span>
<span class="c">#    -P INPUT ACCEPT</span>
<span class="c">#    -P OUTPUT ACCEPT</span>
<span class="c">#    -P POSTROUTING ACCEPT</span>
<span class="c">#    ...</span>
<span class="c">#    -N KUBE-EXT-ZGWW2L4XLRSDZ3EF</span>
<span class="c">#    -N KUBE-MARK-MASQ</span>
<span class="c">#    -N KUBE-NODEPORTS</span>
<span class="c">#    ...</span>
<span class="c">#    -N KUBE-SEP-UOFUVE4S3JB7NP6T</span>
<span class="c">#    -N KUBE-SERVICES</span>
<span class="c">#    ...</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (1)&lt;/span&gt;-A PREROUTING -m comment --comment &amp;quot;kubernetes service portals&amp;quot; -j KUBE-SERVICES</span>
<span class="c">#    ...</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (4)&lt;/span&gt;-A KUBE-EXT-ZGWW2L4XLRSDZ3EF -m comment --comment &amp;quot;masquerade traffic for kube-system/hubble-ui:http external destinations&amp;quot; -j KUBE-MARK-MASQ</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (5)&lt;/span&gt;-A KUBE-EXT-ZGWW2L4XLRSDZ3EF -j KUBE-SVC-ZGWW2L4XLRSDZ3EF</span>
<span class="c">#    -A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (3)&lt;/span&gt;-A KUBE-NODEPORTS -p tcp -m comment --comment &amp;quot;kube-system/hubble-ui:http&amp;quot; -m tcp --dport 30732 -j KUBE-EXT-ZGWW2L4XLRSDZ3EF</span>
<span class="c">#    ...</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (8)&lt;/span&gt;-A KUBE-SEP-UOFUVE4S3JB7NP6T -s 172.16.0.223/32 -m comment --comment &amp;quot;kube-system/hubble-ui:http&amp;quot; -j KUBE-MARK-MASQ</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (9)&lt;/span&gt;-A KUBE-SEP-UOFUVE4S3JB7NP6T -p tcp -m comment --comment &amp;quot;kube-system/hubble-ui:http&amp;quot; -m tcp -j DNAT --to-destination 172.16.0.223:8081</span>
<span class="c">#    ...</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (2)&lt;/span&gt;-A KUBE-SERVICES -m comment --comment &amp;quot;kubernetes service nodeports; NOTE: this must be the last rule in this chain&amp;quot; -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS</span>
<span class="c">#    ...</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (6)&lt;/span&gt;-A KUBE-SVC-ZGWW2L4XLRSDZ3EF ! -s 172.16.0.0/16 -d 10.10.200.125/32 -p tcp -m comment --comment &amp;quot;kube-system/hubble-ui:http cluster IP&amp;quot; -m tcp --dport 80 -j KUBE-MARK-MASQ</span>
<span class="c">#    # &lt;span style="color: green;"&gt;ğŸ‘‰ (7)&lt;/span&gt;-A KUBE-SVC-ZGWW2L4XLRSDZ3EF -m comment --comment &amp;quot;kube-system/hubble-ui:http -&amp;gt; 172.16.0.223:8081&amp;quot; -j KUBE-SEP-UOFUVE4S3JB7NP6T</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ (1) PREROUTING =&gt; (2) KUBE-SERVICES =&gt; (3) KUBE-NODEPORTS &lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    if ë…¸ë“œ í¬íŠ¸ì¸ 30732ë¡œ ì ‘ì†:&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;        =&gt; (4,5) KUBE-EXT-ZGWW2L4XLRSDZ3EF&lt;/span&gt; </span>
<span class="c"># &lt;span style="color: green;"&gt;        =&gt; (6,7) KUBE-SVC-ZGWW2L4XLRSDZ3EF =&gt; (8,9) KUBE-SEP-UOFUVE4S3JB7NP6T =&gt; 172.16.0.223:8081&lt;/span&gt;</span>

<span class="nv">$ </span>conntrack <span class="nt">-L</span>
<span class="nv">$ </span>conntrack <span class="nt">-L</span> |grep <span class="nt">-v</span> 2379

<span class="c"># Install Hubble Client</span>
<span class="nv">$ HUBBLE_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="si">)</span>
<span class="nv">$ HUBBLE_ARCH</span><span class="o">=</span>amd64
<span class="nv">$ </span><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">HUBBLE_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi</span>
<span class="nv">$ </span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/hubble/releases/download/<span class="nv">$HUBBLE_VERSION</span>/hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
<span class="nv">$ </span><span class="nb">sha256sum</span> <span class="nt">--check</span> hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz.sha256sum
<span class="nv">$ </span><span class="nb">sudo tar </span>xzvfC hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="c"># =&gt; hubble</span>
<span class="nv">$ </span><span class="nb">rm </span>hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>

<span class="c"># Hubble API Access : localhost TCP 4245 Relay ë¥¼ í†µí•´ ì ‘ê·¼, observe ë¥¼ í†µí•´ì„œ flow ì¿¼ë¦¬ í™•ì¸ ê°€ëŠ¥!</span>
<span class="nv">$ </span>cilium hubble port-forward &amp;
<span class="c"># =&gt; [1] 16534</span>

<span class="c"># CLI ë¡œ Hubble API ìƒíƒœ í™•ì¸</span>
<span class="nv">$ </span>hubble status
<span class="c"># =&gt; Healthcheck (via localhost:4245): Ok</span>
<span class="c">#    Current/Max Flows: 12,285/12,285 (100.00%)</span>
<span class="c">#    Flows/s: 24.50</span>
<span class="c">#    Connected Nodes: 3/3</span>

<span class="c"># query the flow API and look for flows</span>
<span class="nv">$ </span>hubble observe
<span class="c"># =&gt; Oct 01 13:26:17.501: kube-system/local-path-provisioner-6795b5f9d8-84m96:60994 (ID:11088) -&amp;gt; 192.168.10.10:6443 (kube-apiserver) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 13:26:17.660: kube-system/hubble-ui-59bb4cb67b-r48tz:47372 (ID:37523) -&amp;gt; kube-system/hubble-relay-88f7f89d4-fcq2s:4245 (ID:4124) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 13:26:17.797: 127.0.0.1:36150 (world) &amp;lt;&amp;gt; kube-system/hubble-ui-59bb4cb67b-r48tz (ID:37523) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Oct 01 13:26:17.914: 192.168.10.102:38716 (host) -&amp;gt; 192.168.10.10:6443 (kube-apiserver) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 13:26:18.011: 127.0.0.1:36160 (world) &amp;lt;&amp;gt; kube-system/hubble-ui-59bb4cb67b-r48tz (ID:37523) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Oct 01 13:26:18.067: 10.0.2.15:59486 (host) -&amp;gt; kube-system/metrics-server-cdcc87586-g5m2d:10250 (ID:27624) to-endpoint FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 13:26:18.067: 10.0.2.15:59486 (host) &amp;lt;- kube-system/metrics-server-cdcc87586-g5m2d:10250 (ID:27624) to-stack FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    ...</span>
<span class="c"># hubble observe --pod netpod</span>
<span class="c"># hubble observe --namespace galaxy --http-method POST --http-path /v1/request-landing</span>
<span class="c"># hubble observe --pod deathstar --protocol http</span>
<span class="c"># hubble observe --pod deathstar --verdict DROPPED</span>
</code></pre></div></div>

<h4 id="ë…¸ë“œê°„-íŒŒë“œ-í†µì‹ ">ë…¸ë“œê°„ íŒŒë“œ í†µì‹ </h4>

<ul>
  <li>
    <p>Endpoint to Endpoint í†µì‹  íŒ¨í‚· íë¦„ë„
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_12.png" alt="img.png" class="image-center w-100" loading="lazy" width="1382" height="390"></p>
  </li>
  <li>
    <p>Egress to Endpoint í†µì‹  íŒ¨í‚· íë¦„ë„
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_13.png" alt="img_1.png" class="image-center w-100" loading="lazy" width="1386" height="758"></p>
  </li>
  <li>
    <p>Ingress to Endpoint í†µì‹  íŒ¨í‚· íë¦„ë„
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_14.png" alt="img_2.png" class="image-center w-100" loading="lazy" width="1626" height="783"></p>
  </li>
  <li>
    <p>íŒŒë“œ ìƒì„± ë° í™•ì¸</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: netpod
  labels:
    app: netpod
spec:
  nodeName: k3s-m
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod1
  labels:
    app: webpod
spec:
  nodeName: k3s-w1
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod2
  labels:
    app: webpod
spec:
  nodeName: k3s-w2
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/netpod created</span>
<span class="c">#    pod/webpod1 created</span>
<span class="c">#    pod/webpod2 created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME      READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    netpod    1/1     Running   0          36s   172.16.0.147   k3s-m    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    webpod1   1/1     Running   0          36s   172.16.1.247   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    webpod2   1/1     Running   0          36s   172.16.2.84    k3s-w2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="nv">$ </span>c0 status <span class="nt">--verbose</span> | <span class="nb">grep </span>Allocated <span class="nt">-A5</span>
<span class="c"># =&gt; Allocated addresses:</span>
<span class="c">#      172.16.0.147 (default/netpod)</span>
<span class="c">#      172.16.0.223 (kube-system/hubble-ui-59bb4cb67b-r48tz [restored])</span>
<span class="c">#      172.16.0.227 (router)</span>
<span class="c">#      172.16.0.26 (health)</span>
<span class="c">#    IPv4 BIG TCP:           Disabled</span>
<span class="nv">$ </span>c1 status <span class="nt">--verbose</span> | <span class="nb">grep </span>Allocated <span class="nt">-A5</span>
<span class="c"># =&gt; Allocated addresses:</span>
<span class="c">#      172.16.1.21 (kube-system/coredns-7b98449c4-x5756 [restored])</span>
<span class="c">#      172.16.1.224 (health)</span>
<span class="c">#      172.16.1.247 (default/webpod1)</span>
<span class="c">#      172.16.1.82 (router)</span>
<span class="c">#      172.16.1.99 (kube-system/hubble-relay-88f7f89d4-fcq2s [restored])</span>
<span class="nv">$ </span>c2 status <span class="nt">--verbose</span> | <span class="nb">grep </span>Allocated <span class="nt">-A5</span>
<span class="c"># =&gt; Allocated addresses:</span>
<span class="c">#      172.16.2.184 (kube-system/local-path-provisioner-6795b5f9d8-84m96 [restored])</span>
<span class="c">#      172.16.2.223 (kube-system/metrics-server-cdcc87586-g5m2d [restored])</span>
<span class="c">#      172.16.2.25 (router)</span>
<span class="c">#      172.16.2.8 (health)</span>
<span class="c">#      172.16.2.84 (default/webpod2)</span>

<span class="nv">$ </span>kubectl get ciliumendpoints
<span class="c"># =&gt; NAME      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    netpod    27629               ready            172.16.0.147</span>
<span class="c">#    webpod1   64309               ready            172.16.1.247</span>
<span class="c">#    webpod2   64309               ready            172.16.2.84</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>
<span class="c"># =&gt; root@k3s-m:~# kubectl get ciliumendpoints -A</span>
<span class="c">#    NAMESPACE     NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    default       netpod                                    27629               ready            172.16.0.147</span>
<span class="c">#    default       webpod1                                   64309               ready            172.16.1.247</span>
<span class="c">#    default       webpod2                                   64309               ready            172.16.2.84</span>
<span class="c">#    kube-system   coredns-7b98449c4-x5756                   11970               ready            172.16.1.21</span>
<span class="c">#    kube-system   hubble-relay-88f7f89d4-fcq2s              4124                ready            172.16.1.99</span>
<span class="c">#    kube-system   hubble-ui-59bb4cb67b-r48tz                37523               ready            172.16.0.223</span>
<span class="c">#    kube-system   local-path-provisioner-6795b5f9d8-84m96   11088               ready            172.16.2.184</span>
<span class="c">#    kube-system   metrics-server-cdcc87586-g5m2d            27624               ready            172.16.2.223</span>
<span class="nv">$ </span>c0 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    640        Disabled           Disabled          37523      k8s:app.kubernetes.io/name=hubble-ui                                                172.16.0.223   ready</span>
<span class="c">#                                                               k8s:app.kubernetes.io/part-of=cilium</span>
<span class="c">#                                                               k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#                                                               k8s:k8s-app=hubble-ui</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 bpf endpoint list
<span class="c"># =&gt; IP ADDRESS        LOCAL ENDPOINT INFO</span>
<span class="c">#    192.168.10.10:0   (localhost)</span>
<span class="c">#    10.0.2.15:0       (localhost)</span>
<span class="c">#    172.16.0.147:0    id=2724  sec_id=27629 flags=0x0000 ifindex=19  mac=52:59:78:2F:C0:BE nodemac=7E:77:FA:0A:D3:CC</span>
<span class="c">#    172.16.0.26:0     id=1598  sec_id=4     flags=0x0000 ifindex=17  mac=CE:24:50:27:35:B9 nodemac=FE:57:C1:AD:A6:28</span>
<span class="c">#    172.16.0.223:0    id=640   sec_id=37523 flags=0x0000 ifindex=9   mac=AE:B8:81:A6:B1:28 nodemac=C2:21:B8:92:DA:FD</span>
<span class="c">#    172.16.0.227:0    (localhost)</span>
<span class="nv">$ </span>c0 map get cilium_lxc
<span class="c"># =&gt; Key              Value                                                                                            State   Error</span>
<span class="c">#    172.16.0.147:0   id=2724  sec_id=27629 flags=0x0000 ifindex=19  mac=52:59:78:2F:C0:BE nodemac=7E:77:FA:0A:D3:CC   sync</span>
<span class="c">#    172.16.0.223:0   id=640   sec_id=37523 flags=0x0000 ifindex=9   mac=AE:B8:81:A6:B1:28 nodemac=C2:21:B8:92:DA:FD   sync</span>
<span class="c">#    172.16.0.26:0    id=1598  sec_id=4     flags=0x0000 ifindex=17  mac=CE:24:50:27:35:B9 nodemac=FE:57:C1:AD:A6:28   sync</span>
<span class="nv">$ </span>c0 ip list
<span class="c"># =&gt; IP                  IDENTITY                                                                         SOURCE</span>
<span class="c">#    0.0.0.0/0           reserved:world</span>
<span class="c">#    10.0.2.15/32        reserved:host</span>
<span class="c">#                        reserved:kube-apiserver</span>
<span class="c">#    172.16.0.26/32      reserved:health</span>
<span class="c">#    172.16.0.147/32     k8s:app=netpod                                                                   custom-resource</span>
<span class="c">#                        k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>íŒŒë“œ ë³€ìˆ˜ ì§€ì •</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í…ŒìŠ¤íŠ¸ íŒŒë“œë“¤ IP</span>
<span class="nv">$ NETPODIP</span><span class="o">=</span><span class="si">$(</span>kubectl get pods netpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.podIP}'</span><span class="si">)</span>
<span class="nv">$ WEBPOD1IP</span><span class="o">=</span><span class="si">$(</span>kubectl get pods webpod1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.podIP}'</span><span class="si">)</span>
<span class="nv">$ WEBPOD2IP</span><span class="o">=</span><span class="si">$(</span>kubectl get pods webpod2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.podIP}'</span><span class="si">)</span>

<span class="c"># ë‹¨ì¶•í‚¤(alias) ì§€ì •</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">p0</span><span class="o">=</span><span class="s2">"kubectl exec -it netpod  -- "</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">p1</span><span class="o">=</span><span class="s2">"kubectl exec -it webpod1 -- "</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">p2</span><span class="o">=</span><span class="s2">"kubectl exec -it webpod2 -- "</span>
</code></pre></div></div>

<ul>
  <li>íŒŒë“œì˜ ARP ë™ì‘ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># netpod ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>p0 ip <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    18: eth0@if19: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000 link-netnsid 0</span>
<span class="c">#        inet 172.16.0.147/32 scope global eth0</span>
<span class="nv">$ </span>p0 route <span class="nt">-n</span>
<span class="c"># =&gt; Kernel IP routing table</span>
<span class="c">#    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span>
<span class="c">#    0.0.0.0         172.16.0.227    0.0.0.0         UG    0      0        0 eth0</span>
<span class="c">#    172.16.0.227    0.0.0.0         255.255.255.255 UH    0      0        0 eth0</span>
<span class="nv">$ </span>p0 ping <span class="nt">-c</span> 1 <span class="nv">$WEBPOD1IP</span> <span class="o">&amp;&amp;</span> p0 ping <span class="nt">-c</span> 1 <span class="nv">$WEBPOD2IP</span>
<span class="c"># =&gt; PING 172.16.1.247 (172.16.1.247) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.16.1.247: icmp_seq=1 ttl=62 time=0.642 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.16.1.247 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.642/0.642/0.642/0.000 ms</span>
<span class="c">#    PING 172.16.2.84 (172.16.2.84) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.16.2.84: icmp_seq=1 ttl=62 time=0.716 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.16.2.84 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.716/0.716/0.716/0.000 ms</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_15.png" alt="img.png" loading="lazy" width="1392" height="925"></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>p0 curl <span class="nt">-s</span> <span class="nv">$WEBPOD1IP</span> <span class="o">&amp;&amp;</span> p0 curl <span class="nt">-s</span> <span class="nv">$WEBPOD2IP</span>
<span class="c"># =&gt; Hostname: webpod1</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 172.16.1.247</span>
<span class="c">#    RemoteAddr: 172.16.0.147:51692</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 172.16.1.247</span>
<span class="c">#    User-Agent: curl/8.7.1</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    </span>
<span class="c">#    Hostname: webpod2</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 172.16.2.84</span>
<span class="c">#    RemoteAddr: 172.16.0.147:32796</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 172.16.2.84</span>
<span class="c">#    User-Agent: curl/8.7.1</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>p0 curl <span class="nt">-s</span> <span class="nv">$WEBPOD1IP</span>:8080 <span class="p">;</span> p0 curl <span class="nt">-s</span> <span class="nv">$WEBPOD2IP</span>:8080
<span class="c"># =&gt; command terminated with exit code 7</span>
<span class="c">#    command terminated with exit code 7</span>
<span class="nv">$ </span>p0 ping <span class="nt">-c</span> 1 8.8.8.8 <span class="o">&amp;&amp;</span> p0 curl <span class="nt">-s</span> wttr.in/seoul
<span class="c"># =&gt; PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 8.8.8.8: icmp_seq=1 ttl=61 time=39.1 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 8.8.8.8 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 39.095/39.095/39.095/0.000 ms</span>
<span class="c">#    Weather report: seoul</span>
<span class="c">#    </span>
<span class="c">#         \  /       Partly cloudy</span>
<span class="c">#       _ /&amp;quot;&amp;quot;.-.     16 Â°C</span>
<span class="c">#         \_(   ).   â† 4 km/h</span>
<span class="c">#         /(___(__)  10 km</span>
<span class="c">#                    0.0 mm</span>
<span class="c">#                                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Sat 26 Oct â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”‚            Morning           â”‚             Noon      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     Evening           â”‚             Night            â”‚</span>
<span class="c">#    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="c">#    â”‚     \   /     Sunny          â”‚     \   /     Sunny          â”‚               Overcast       â”‚    \  /       Partly Cloudy  â”‚</span>
<span class="c">#    â”‚      .-.      16 Â°C          â”‚      .-.      21 Â°C          â”‚      .--.     20 Â°C          â”‚  _ /&amp;quot;&amp;quot;.-.     19 Â°C          â”‚</span>
<span class="c">#    â”‚   â€• (   ) â€•   â†™ 5-7 km/h     â”‚   â€• (   ) â€•   â†™ 5-6 km/h     â”‚   .-(    ).   â† 4-6 km/h     â”‚    \_(   ).   â†™ 4-7 km/h     â”‚</span>
<span class="c">#    â”‚      `-â€™      10 km          â”‚      `-â€™      10 km          â”‚  (___.__)__)  10 km          â”‚    /(___(__)  10 km          â”‚</span>
<span class="c">#    â”‚     /   \     0.0 mm | 0%    â”‚     /   \     0.0 mm | 0%    â”‚               0.0 mm | 0%    â”‚               0.0 mm | 0%    â”‚</span>
<span class="c">#    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="c">#                                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Sun 27 Oct â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”‚            Morning           â”‚             Noon      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     Evening           â”‚             Night            â”‚</span>
<span class="c">#    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="c">#    â”‚               Overcast       â”‚               Cloudy         â”‚     \   /     Clear          â”‚     \   /     Clear          â”‚</span>
<span class="c">#    â”‚      .--.     16 Â°C          â”‚      .--.     19 Â°C          â”‚      .-.      19 Â°C          â”‚      .-.      17 Â°C          â”‚</span>
<span class="c">#    â”‚   .-(    ).   â† 1 km/h       â”‚   .-(    ).   â†“ 4-5 km/h     â”‚   â€• (   ) â€•   â†˜ 9-13 km/h    â”‚   â€• (   ) â€•   â†˜ 5-7 km/h     â”‚</span>
<span class="c">#    â”‚  (___.__)__)  10 km          â”‚  (___.__)__)  10 km          â”‚      `-â€™      10 km          â”‚      `-â€™      10 km          â”‚</span>
<span class="c">#    â”‚               0.0 mm | 0%    â”‚               0.0 mm | 0%    â”‚     /   \     0.0 mm | 0%    â”‚     /   \     0.0 mm | 0%    â”‚</span>
<span class="c">#    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="c">#                                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Mon 28 Oct â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="c">#    â”‚            Morning           â”‚             Noon      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     Evening           â”‚             Night            â”‚</span>
<span class="c">#    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="c">#    â”‚     \   /     Sunny          â”‚    \  /       Partly Cloudy  â”‚               Cloudy         â”‚  _`/&amp;quot;&amp;quot;.-.     Patchy rain neâ€¦â”‚</span>
<span class="c">#    â”‚      .-.      16 Â°C          â”‚  _ /&amp;quot;&amp;quot;.-.     20 Â°C          â”‚      .--.     20 Â°C          â”‚   ,\_(   ).   19 Â°C          â”‚</span>
<span class="c">#    â”‚   â€• (   ) â€•   â† 5-6 km/h     â”‚    \_(   ).   â† 6-7 km/h     â”‚   .-(    ).   â†™ 6-9 km/h     â”‚    /(___(__)  â† 8-10 km/h    â”‚</span>
<span class="c">#    â”‚      `-â€™      10 km          â”‚    /(___(__)  10 km          â”‚  (___.__)__)  10 km          â”‚      â€˜ â€˜ â€˜ â€˜  10 km          â”‚</span>
<span class="c">#    â”‚     /   \     0.0 mm | 0%    â”‚               0.0 mm | 0%    â”‚               0.0 mm | 0%    â”‚     â€˜ â€˜ â€˜ â€˜   0.0 mm | 67%   â”‚</span>
<span class="c">#    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="c">#    Location: á„‰á…¥á„‹á…®á†¯á„á…³á†¨á„‡á…§á†¯á„‰á…µ, á„ƒá…¢á„’á…¡á†«á„†á…µá†«á„€á…®á†¨ [37.5666791,126.9782914]</span>
<span class="c">#    </span>
<span class="c">#    Follow @igor_chubin for wttr.in updates</span>

<span class="nv">$ </span>p0 ip <span class="nt">-c</span> neigh
<span class="c"># =&gt; 172.16.0.227 dev eth0 lladdr 7e:77:fa:0a:d3:cc STALE</span>

<span class="c"># hubble cli í™•ì¸</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> netpod
<span class="c"># =&gt; Oct 01 14:29:21.248: kube-system/coredns-7b98449c4-7kqtg:53 (ID:11970) &amp;lt;&amp;gt; default/netpod (ID:27629) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Oct 01 14:29:21.248: kube-system/kube-dns:53 (world) &amp;lt;&amp;gt; default/netpod (ID:27629) post-xlate-rev TRANSLATED (UDP)</span>
<span class="c">#    Oct 01 14:29:21.248: default/netpod:34162 (ID:27629) -&amp;gt; 5.9.243.187:80 (world) to-network FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 14:29:21.481: default/netpod:34162 (ID:27629) -&amp;gt; 5.9.243.187:80 (world) to-network FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:29:21.481: default/netpod:34162 (ID:27629) &amp;lt;- 5.9.243.187:80 (world) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Oct 01 14:29:21.481: default/netpod:34162 (ID:27629) -&amp;gt; 5.9.243.187:80 (world) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 14:29:21.816: default/netpod:34162 (ID:27629) &amp;lt;- 5.9.243.187:80 (world) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:29:21.819: default/netpod:34162 (ID:27629) -&amp;gt; 5.9.243.187:80 (world) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:29:22.052: default/netpod:34162 (ID:27629) &amp;lt;- 5.9.243.187:80 (world) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:29:22.052: default/netpod:34162 (ID:27629) -&amp;gt; 5.9.243.187:80 (world) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> webpod1
<span class="c"># =&gt; Oct 01 14:33:40.392: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 14:33:40.392: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Oct 01 14:33:40.392: default/netpod:60282 (ID:27629) &amp;lt;&amp;gt; default/webpod1 (ID:64309) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Oct 01 14:33:40.392: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 14:33:40.392: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:33:40.393: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:33:40.393: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:33:40.393: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:33:40.394: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 14:33:40.405: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 14:33:40.406: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Oct 01 14:33:40.406: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Oct 01 14:33:40.406: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:33:40.407: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Oct 01 14:33:40.407: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:33:40.408: default/netpod:60282 (ID:27629) &amp;lt;- default/webpod1:80 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Oct 01 14:33:40.408: default/netpod:60282 (ID:27629) -&amp;gt; default/webpod1:80 (ID:64309) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 80í¬íŠ¸ë¡œ ì ‘ì†í–ˆì„ë•Œ ì •ìƒì ì¸ ì‘ë‹µ íŒ¨í‚·ë“¤&lt;/span&gt;</span>

<span class="c">#    Oct 01 14:33:43.956: default/netpod:34488 (ID:27629) -&amp;gt; default/webpod1:8080 (ID:64309) to-endpoint FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 14:33:43.956: default/netpod:34488 (ID:27629) &amp;lt;- default/webpod1:8080 (ID:64309) to-network FORWARDED (TCP Flags: ACK, RST)</span>
<span class="c">#    Oct 01 14:33:43.970: default/netpod:34488 (ID:27629) -&amp;gt; default/webpod1:8080 (ID:64309) to-network FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 14:33:43.970: default/netpod:34488 (ID:27629) &amp;lt;- default/webpod1:8080 (ID:64309) to-endpoint FORWARDED (TCP Flags: ACK, RST)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì—´ë ¤ìˆì§€ ì•Šì€ 8080í¬íŠ¸ë¡œ ì ‘ì†í–ˆì„ë•Œ ì˜¤ë¥˜ê°€ ë°œìƒí•œ íŒ¨í‚·ë“¤&lt;/span&gt;</span>

<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> webpod2

<span class="c"># BPF maps : ëª©ì ì§€ íŒŒë“œì™€ í†µì‹  ì‹œ ì–´ëŠê³³ìœ¼ë¡œ ë³´ë‚´ì•¼ ë ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤</span>
<span class="nv">$ </span>c0 map get cilium_ipcache
<span class="c"># =&gt; Key                 Value                                                                     State   Error</span>
<span class="c">#    172.16.2.182/32     identity=27624 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    172.16.2.8/32       identity=4 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;       sync</span>
<span class="c">#    172.16.0.147/32     identity=27629 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;          sync</span>
<span class="c">#    172.16.0.223/32     identity=37523 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;          sync</span>
<span class="c">#    192.168.10.10/32    identity=1 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    172.16.0.26/32      identity=4 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    10.0.2.15/32        identity=1 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    192.168.10.102/32   identity=6 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    172.16.1.82/32      identity=6 encryptkey=0 tunnelendpoint=192.168.10.101, flags=&amp;lt;none&amp;gt;       sync</span>
<span class="c">#    172.16.2.237/32     identity=11970 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    172.16.2.216/32     identity=64309 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    0.0.0.0/0           identity=2 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    172.16.2.111/32     identity=11088 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    172.16.1.224/32     identity=4 encryptkey=0 tunnelendpoint=192.168.10.101, flags=&amp;lt;none&amp;gt;       sync</span>
<span class="c">#    172.16.2.25/32      identity=6 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;       sync</span>
<span class="c">#    192.168.10.101/32   identity=6 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="c">#    172.16.0.148/32     identity=4124 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;           sync</span>
<span class="c">#    172.16.1.247/32     identity=64309 encryptkey=0 tunnelendpoint=192.168.10.101, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    172.16.0.227/32     identity=1 encryptkey=0 tunnelendpoint=0.0.0.0, flags=&amp;lt;none&amp;gt;              sync</span>
<span class="nv">$ </span>c0 map get cilium_ipcache | <span class="nb">grep</span> <span class="nv">$WEBPOD1IP</span>
<span class="c"># =&gt; 172.16.1.247/32     identity=64309 encryptkey=0 tunnelendpoint=192.168.10.101, flags=&amp;lt;none&amp;gt;   sync</span>

<span class="c"># netpod ì˜ LXC ë³€ìˆ˜ ì§€ì •</span>
<span class="c">#$ LXC=&lt;k3s-mì˜ ê°€ì¥ ë‚˜ì¤‘ì— lxc ì´ë¦„&gt;</span>
<span class="nv">$ LXC</span><span class="o">=</span>lxcd551b3b4058f

<span class="c"># íŒŒë“œì™€ veth pair ì— IPê°€ ì—†ìŠµë‹ˆë‹¤! proxy_arp ë„ ì—†ìŠµë‹ˆë‹¤! í•˜ì§€ë§Œ GW MAC ìš”ì²­ ì‹œ lxc(veth)ì˜ MAC ìœ¼ë¡œ ì‘ë‹µì´ ì˜µë‹ˆë‹¤! &gt;&gt; eBPF Magic!</span>
<span class="c"># Cilium hijacks ARP table of POD1, forces the next hop to be the peer end (host side) of the veth pair.</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr show dev <span class="nv">$LXC</span>
<span class="c"># =&gt; 23: lxcd551b3b4058f@if22: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="c">#        link/ether fa:32:54:4b:16:d7 brd ff:ff:ff:ff:ff:ff link-netns cni-8634ff07-8cb9-608a-1baf-dc929d510a84</span>
<span class="c">#        inet6 fe80::f832:54ff:fe4b:16d7/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_16.png" alt="img.png" class="image-center" loading="lazy" width="1392" height="820">
<em class="image-caption">webpod1,2ì™€ wttr.in ì ‘ì† í…ŒìŠ¤íŠ¸ í›„ Hubble UI</em></p>

<h4 id="ì„œë¹„ìŠ¤-í†µì‹ -í™•ì¸">ì„œë¹„ìŠ¤ í†µì‹  í™•ì¸</h4>

<h5 id="ì†Œì¼“-ê¸°ë°˜-ë¡œë“œë°¸ëŸ°ì‹±-ì†Œê°œ">ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± ì†Œê°œ</h5>

<ul>
  <li>ì°¸ê³  : <a href="https://velog.io/@haruband/K8SCilium-Socket-Based-LoadBalancing-%EA%B8%B0%EB%B2%95">https://velog.io/@haruband/K8SCilium-Socket-Based-LoadBalancing-%EA%B8%B0%EB%B2%95</a>
</li>
  <li>ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±(ì™¼ìª½) vs ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±(ì˜¤ë¥¸ìª½) ë¹„êµ
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_17.png" alt="img.png" loading="lazy" width="897" height="378">
ìœ„ì˜ ê·¸ë¦¼ì—ì„œ ì²˜ëŸ¼ ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±ì€ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ DNAT ë˜ëŠ” ê³¼ì •ì„ ê±°ì¹˜ëŠ”ë°, <strong>ì†Œì¼“ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±ì€ DNATí•˜ëŠ” ê³¼ì •ì´ í•„ìš”ê°€ ì—†ìŠµ</strong>ë‹ˆë‹¤.
    <ul>
      <li>ìœ„ì˜ ê·¸ë¦¼ì„ í’€ì–´ì„œ ì„¤ëª…í•˜ìë©´ ìœ„ì˜ ì˜ˆì—ì„œ Pod1ì—ì„œ ë™ì‘í•˜ëŠ” ì•±ì´ <code class="language-plaintext highlighter-rouge">connect()</code> ì‹œìŠ¤í…œ ì½œì„ ì´ìš©í•´ì„œ ì†Œì¼“ì„ ì—°ê²°í• ë•Œ ëª©ì ì§€ ì£¼ì†Œê°€
ì„œë¹„ìŠ¤ ì£¼ì†Œ (192.168.0.1)ì´ë©´ ì†Œì¼“ì˜ ëª©ì ì§€ ì£¼ì†Œë¥¼ ë°”ë¡œ ë°±ì—”ë“œ ì£¼ì†Œ(10.0.0.2)ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. ì´í›„ ë°ì´í„° ì „ì†¡ì€ 
<strong>ë°”ë¡œ ë°±ì—”ë“œ ì£¼ì†Œ(10.0.0.2)ë¡œ ì „ì†¡ë˜ê¸° ë•Œë¬¸</strong>ì— <strong>DNAT ë³€í™˜ ë° ì—­ë³€í™˜ ê³¼ì •ì´ í•„ìš”ì—†ì–´</strong>ì§‘ë‹ˆë‹¤.</li>
      <li><em>ì´ëŠ” ciliumì´ L7ì—ì„œ íŒŒë“œ/ì„œë¹„ìŠ¤ì˜ ì˜ë¯¸ë¥¼ ì´í•´í•˜ê³  ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤!</em></li>
      <li>ì‹¬ì§€ì–´ ì„œë¹„ìŠ¤ ì£¼ì†Œë¥¼ ë°±ì—”ë“œ ì£¼ì†Œë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì€ <strong>ì‹œìŠ¤í…œì½œ ë ˆë²¨ì—ì„œ ì´ë£¨ì–´ì§€ë©°</strong>, ì»¤ë„ì—ì„œ íŒ¨í‚·ì´ ìƒì„±ë˜ê¸°ë„ ì „ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Socket Operations : BPF Socket Operations programì€ root cgroupì— ì—°ê²°ë˜ë©° TCP event(ESTABLISHED)ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.</li>
  <li>Socket send/recv : Socket send/recv í›…ì€ TCP socketì˜ ëª¨ë“  ì†¡ìˆ˜ì‹  ì‘ì—…ì—ì„œ ì‹¤í–‰ë˜ë©°, hookì—ì„œ ê²€ì‚¬/ì‚­ì œ/ë¦¬ë‹¤ì´ë ‰ì…˜ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>
<code class="language-plaintext highlighter-rouge">connect()</code>ì™€ <code class="language-plaintext highlighter-rouge">sendto()</code> ì†Œì¼“ í•¨ìˆ˜ì— ì—°ê²°ëœ í”„ë¡œê·¸ë¨(<code class="language-plaintext highlighter-rouge">connect4</code>, <code class="language-plaintext highlighter-rouge">sendmsg4</code>)ì—ì„œëŠ” ì†Œì¼“ì˜ ëª©ì ì§€ ì£¼ì†Œë¥¼ ë°±ì—”ë“œ ì£¼ì†Œì™€ í¬íŠ¸ë¡œ ë³€í™˜í•˜ê³ , 
cilium_lb4_backends ë§µì— ë°±ì—”ë“œ ì£¼ì†Œì™€ í¬íŠ¸ë¥¼ ë“±ë¡í•´ë†“ìŠµë‹ˆë‹¤. ì´í›„ <code class="language-plaintext highlighter-rouge">recvmsg()</code> ì†Œì¼“ í•¨ìˆ˜ì— ì—°ê²°ëœ í”„ë¡œê·¸ë¨(<code class="language-plaintext highlighter-rouge">recvmsg4</code>)ì—ì„œëŠ”
ilium_lb4_reverse_nat ë§µì„ ì´ìš©í•´ì„œ ëª©ì ì§€ ì£¼ì†Œì™€ í¬íŠ¸ë¥¼ ë‹¤ì‹œ ì„œë¹„ìŠ¤ ì£¼ì†Œì™€ í¬íŠ¸ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_18.png" alt="img.png" class="image-center" loading="lazy" width="850" height="570">
<em class="image-caption">ciliumì˜ ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± ë™ì‘ ë°©ì‹ - <a href="https://k8s.networkop.co.uk/services/clusterip/dataplane/ebpf/">ë§í¬</a></em>
</li>
</ul>

<h5 id="ì„œë¹„ìŠ¤-ìƒì„±-ë°-ì ‘ì†-í™•ì¸">ì„œë¹„ìŠ¤ ìƒì„± ë° ì ‘ì† í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì„œë¹„ìŠ¤ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Service
metadata:
  name: svc
spec:
  ports:
    - name: svc-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; service/svc created</span>

<span class="c"># ì„œë¹„ìŠ¤ ìƒì„± í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc,ep svc
<span class="c"># =&gt; NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/svc   ClusterIP   10.10.200.121   &amp;lt;none&amp;gt;        80/TCP    13s</span>
<span class="c">#    </span>
<span class="c">#    NAME            ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/svc   172.16.1.247:80,172.16.2.216:80   13s</span>

<span class="c"># ë…¸ë“œì— iptables ë”ì´ìƒ KUBE-SVC rule ì´ ìƒì„±ë˜ì§€ ì•ŠëŠ”ë‹¤!</span>
<span class="nv">$ </span>iptables-save | <span class="nb">grep </span>KUBE-SVC
<span class="nv">$ </span>iptables-save | <span class="nb">grep </span>CILIUM

<span class="c"># ì„œë¹„ìŠ¤IPë¥¼ ë³€ìˆ˜ì— ì§€ì •</span>
<span class="nv">$ SVCIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.clusterIP}'</span><span class="si">)</span>

<span class="c"># Pod1 ì—ì„œ Service(ClusterIP) ì ‘ì† íŠ¸ë˜í”½ ë°œìƒ</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>netpod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$SVCIP</span>
<span class="c"># =&gt; Hostname: webpod2</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.16.2.216</span>
<span class="c">#    IP: fe80::844e:b2ff:fed0:7d5</span>
<span class="c">#    RemoteAddr: 172.16.0.147:36844</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 10.10.200.121</span>
<span class="c">#    User-Agent: curl/8.7.1</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>netpod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$SVCIP</span> | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod1</span>

<span class="c"># ì§€ì†ì ìœ¼ë¡œ ì ‘ì† íŠ¸ë˜í”½ ë°œìƒ</span>
<span class="nv">$ SVCIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.clusterIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec </span>netpod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$SVCIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span><span class="nb">echo</span> <span class="s2">"-----"</span><span class="p">;</span><span class="nb">sleep </span>1<span class="p">;</span><span class="k">done</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>netpod <span class="nt">--</span> tcpdump <span class="nt">-enni</span> any <span class="nt">-q</span>
<span class="c"># =&gt; 15:01:03.468433 eth0  Out ifindex 18 52:59:78:2f:c0:be 172.16.0.147.57744 &amp;gt; 172.16.1.247.80: tcp 0</span>
<span class="c">#    15:01:03.468761 eth0  In  ifindex 18 7e:77:fa:0a:d3:cc 172.16.1.247.80 &amp;gt; 172.16.0.147.57744: tcp 0</span>
<span class="c">#    15:01:03.468801 eth0  Out ifindex 18 52:59:78:2f:c0:be 172.16.0.147.57744 &amp;gt; 172.16.1.247.80: tcp 0</span>
<span class="c">#    15:01:03.469249 eth0  Out ifindex 18 52:59:78:2f:c0:be 172.16.0.147.57744 &amp;gt; 172.16.1.247.80: tcp 76</span>
<span class="c">#    15:01:03.469852 eth0  In  ifindex 18 7e:77:fa:0a:d3:cc 172.16.1.247.80 &amp;gt; 172.16.0.147.57744: tcp 0</span>
<span class="c">#    15:01:03.469852 eth0  In  ifindex 18 7e:77:fa:0a:d3:cc 172.16.1.247.80 &amp;gt; 172.16.0.147.57744: tcp 312</span>
<span class="c">#    15:01:03.469888 eth0  Out ifindex 18 52:59:78:2f:c0:be 172.16.0.147.57744 &amp;gt; 172.16.1.247.80: tcp 0</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ íŒŒë“œì—ì„œ SVC(ClusterIP) ì ‘ì† ì‹œ tcpdump ë¡œ í™•ì¸ &gt;&gt; íŒŒë“œ ë‚´ë¶€ ìº¡ì³ì¸ë°,&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    SVC(10.10.200.121)ëŠ” ë³´ì´ì§€ ì•Šê³ , DNAT ëœ web-pod ì˜ IPê°€ í™•ì¸ë©ë‹ˆë‹¤! It's Magic!&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>netpod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s2">"ngrep -tW byline -d eth0 '' 'tcp port 80'"</span>
<span class="c"># =&gt; T 2024/10/01 15:02:58.406586 172.16.0.147:48018 -&amp;gt; 172.16.2.216:80 [AP] #4</span>
<span class="c">#    GET / HTTP/1.1.</span>
<span class="c">#    Host: 10.10.200.121.</span>
<span class="c">#    User-Agent: curl/8.7.1.</span>
<span class="c">#    Accept: */*.</span>
<span class="c">#    ...</span>

<span class="c"># ì„œë¹„ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>c0 service list
<span class="c"># =&gt; ID   Frontend              Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    11   10.10.200.121:80      ClusterIP      1 =&amp;gt; 172.16.1.247:80 (active)</span>
<span class="c">#                                              2 =&amp;gt; 172.16.2.216:80 (active)</span>
<span class="nv">$ </span>c0 bpf lb list
<span class="c"># =&gt; SERVICE ADDRESS           BACKEND ADDRESS (REVNAT_ID) (SLOT)</span>
<span class="c">#    0.0.0.0:30405 (0)         0.0.0.0:0 (8) (0) [NodePort, non-routable]</span>
<span class="c">#    ...</span>
<span class="c">#    10.10.200.121:80 (1)      172.16.1.247:80 (11) (1)</span>
<span class="c">#    10.10.200.121:80 (2)      172.16.2.216:80 (11) (2)</span>
<span class="c">#    ...</span>

<span class="c"># BPF maps</span>
<span class="nv">$ </span>c0 map list <span class="nt">--verbose</span>
<span class="nv">$ </span>c0 map list <span class="nt">--verbose</span> | <span class="nb">grep </span>lb
<span class="c"># =&gt; ## Map: cilium_lb4_backends_v3</span>
<span class="c">#    ## Map: cilium_lb_affinity_match</span>
<span class="c">#    ## Map: cilium_lb4_source_range</span>
<span class="c">#    ## Map: cilium_lb4_affinity</span>
<span class="c">#    ## Map: cilium_lb4_services_v2</span>
<span class="c">#    ## Map: cilium_lb4_reverse_nat</span>
<span class="c">#    ## Map: cilium_lb4_reverse_sk</span>
<span class="c">#    ## Map: cilium_skip_lb4</span>
<span class="nv">$ </span>c0 map get cilium_lb4_services_v2
<span class="c"># =&gt; Key                       Value                 State   Error</span>
<span class="c">#    ...</span>
<span class="c">#    10.10.200.121:80 (1)      20 0 (11) [0x0 0x0]   sync</span>
<span class="c">#    10.10.200.121:80 (0)      0 2 (11) [0x0 0x0]    sync</span>
<span class="c">#    10.10.200.121:80 (2)      21 0 (11) [0x0 0x0]   sync</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 map get cilium_lb4_backends_v3
<span class="c"># =&gt; Key                       Value                 State   Error</span>
<span class="c">#    ...</span>
<span class="c">#    21    ANY://172.16.2.216    sync</span>
<span class="c">#    20    ANY://172.16.1.247    sync</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 map get cilium_lb4_reverse_nat
<span class="c"># =&gt; Key                       Value                 State   Error</span>
<span class="c">#    ...</span>
<span class="c">#    11    10.10.200.121:80      sync</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 map get cilium_lb4_reverse_sk
<span class="c"># =&gt; Key                       Value                 State   Error</span>
<span class="c">#    ...</span>
<span class="c">#    [172.16.2.216]:20480, 22906     [10.10.200.121]:20480, 2816</span>
<span class="c">#    [172.16.1.247]:20480, 19024     [10.10.200.121]:20480, 2816</span>
<span class="c">#    [172.16.2.216]:20480, 30734     [10.10.200.121]:20480, 2816</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 map get cilium_lxc
<span class="c"># =&gt; Key              Value                                                                                            State   Error</span>
<span class="c">#    172.16.0.147:0   id=2724  sec_id=27629 flags=0x0000 ifindex=19  mac=52:59:78:2F:C0:BE nodemac=7E:77:FA:0A:D3:CC   sync</span>
<span class="c">#    172.16.0.223:0   id=640   sec_id=37523 flags=0x0000 ifindex=9   mac=AE:B8:81:A6:B1:28 nodemac=C2:21:B8:92:DA:FD   sync</span>
<span class="c">#    172.16.0.26:0    id=1606  sec_id=4     flags=0x0000 ifindex=21  mac=A2:52:92:B7:C0:D9 nodemac=C2:C0:3A:67:BE:B2   sync</span>
<span class="c">#    172.16.0.148:0   id=655   sec_id=4124  flags=0x0000 ifindex=23  mac=2E:AF:13:F1:DD:88 nodemac=FA:32:54:4B:16:D7   sync</span>
<span class="nv">$ </span>c0 map get cilium_ipcache
<span class="c"># =&gt; 172.16.2.216/32     identity=64309 encryptkey=0 tunnelendpoint=192.168.10.102, flags=&amp;lt;none&amp;gt;   sync</span>
<span class="c">#    172.16.1.247/32     identity=64309 encryptkey=0 tunnelendpoint=192.168.10.101, flags=&amp;lt;none&amp;gt;   sync</span>
</code></pre></div></div>

<h4 id="prometheusì™€-grafanaë¥¼-í†µí•œ-cilium-ëª¨ë‹ˆí„°ë§">Prometheusì™€ Grafanaë¥¼ í†µí•œ Cilium ëª¨ë‹ˆí„°ë§</h4>

<h5 id="ì„¤ì •">ì„¤ì •</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.16.3/examples/kubernetes/addons/prometheus/monitoring-example.yaml
<span class="c"># =&gt; namespace/cilium-monitoring created</span>
<span class="c">#    serviceaccount/prometheus-k8s created</span>
<span class="c">#    configmap/grafana-config created</span>
<span class="c">#    configmap/grafana-cilium-dashboard created</span>
<span class="c">#    configmap/grafana-cilium-operator-dashboard created</span>
<span class="c">#    configmap/grafana-hubble-dashboard created</span>
<span class="c">#    configmap/grafana-hubble-l7-http-metrics-by-workload created</span>
<span class="c">#    configmap/prometheus created</span>
<span class="c">#    clusterrole.rbac.authorization.k8s.io/prometheus created</span>
<span class="c">#    clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span>
<span class="c">#    service/grafana created</span>
<span class="c">#    service/prometheus created</span>
<span class="c">#    deployment.apps/grafana created</span>
<span class="c">#    deployment.apps/prometheus created</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME                              READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/grafana-65d4578dc4-zcmgz      1/1     Running   0          36s</span>
<span class="c">#    pod/prometheus-7cc8784659-bqchf   1/1     Running   0          36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/grafana      ClusterIP   10.10.200.223   &amp;lt;none&amp;gt;        3000/TCP   36s</span>
<span class="c">#    service/prometheus   ClusterIP   10.10.200.90    &amp;lt;none&amp;gt;        9090/TCP   36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/grafana      1/1     1            1           36s</span>
<span class="c">#    deployment.apps/prometheus   1/1     1            1           36s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                    DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/grafana-65d4578dc4      1         1         1       36s</span>
<span class="c">#    replicaset.apps/prometheus-7cc8784659   1         1         1       36s</span>

<span class="c"># íŒŒë“œì™€ ì„œë¹„ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod,svc,ep <span class="nt">-o</span> wide <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME                              READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/grafana-65d4578dc4-zcmgz      1/1     Running   0          49s   172.16.1.208   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/prometheus-7cc8784659-bqchf   1/1     Running   0          49s   172.16.1.248   k3s-w1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE   SELECTOR</span>
<span class="c">#    service/grafana      ClusterIP   10.10.200.223   &amp;lt;none&amp;gt;        3000/TCP   49s   app=grafana</span>
<span class="c">#    service/prometheus   ClusterIP   10.10.200.90    &amp;lt;none&amp;gt;        9090/TCP   49s   app=prometheus</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS           AGE</span>
<span class="c">#    endpoints/grafana      172.16.1.208:3000   49s</span>
<span class="c">#    endpoints/prometheus   172.16.1.248:9090   49s</span>

<span class="c"># NodePort ì„¤ì •</span>
<span class="nv">$ </span>kubectl patch svc grafana <span class="nt">-n</span> cilium-monitoring <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>
<span class="nv">$ </span>kubectl patch svc prometheus <span class="nt">-n</span> cilium-monitoring <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>

<span class="c"># Grafana ì›¹ ì ‘ì†</span>
<span class="nv">$ GPT</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> cilium-monitoring grafana <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Grafana URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$GPT</span><span class="s2">"</span>
<span class="c"># =&gt; Grafana URL = http://54.180.146.116:32172</span>

<span class="c"># Prometheus ì›¹ ì ‘ì† ì •ë³´ í™•ì¸</span>
<span class="nv">$ PPT</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> cilium-monitoring prometheus <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.ports[0].nodePort<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Prometheus URL = http://</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span><span class="s2">:</span><span class="nv">$PPT</span><span class="s2">"</span>
<span class="c"># =&gt; Prometheus URL = http://54.180.146.116:30426</span>
</code></pre></div></div>

<h5 id="grafana--prometheus-nodeport-ë¡œ-ì›¹-ì ‘ì†-í›„-í™•ì¸">grafana , prometheus NodePort ë¡œ ì›¹ ì ‘ì† í›„ í™•ì¸</h5>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_19.png" alt="img.png" class="image-center" loading="lazy" width="1392" height="820">
<em class="image-caption">Prometheus ëª¨ë‹ˆí„°ë§ í™”ë©´</em></p>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_21.png" alt="img_1.png" class="image-center" loading="lazy" width="1392" height="1281">
<em class="image-caption">Grafana ëª¨ë‹ˆí„°ë§ í™”ë©´</em></p>

<h4 id="network-policy-l3-l4-l7">Network Policy (L3, L4, L7)</h4>

<h5 id="cilium-ë³´ì•ˆ-ì†Œê°œ">Cilium ë³´ì•ˆ ì†Œê°œ</h5>

<p>Ciliumì€ ì—¬ëŸ¬ ë ˆë²¨ì˜ ë³´ì•ˆ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. <a href="https://docs.cilium.io/en/stable/security/network/intro/">ë¬¸ì„œ</a>
ê·¸ ì¤‘ì—ì„œ ë‹¤ìŒ 3ê°€ì§€ë¥¼ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>ID ê¸°ë°˜ (L3) : ì—”ë“œí¬ì¸íŠ¸ ê°„ì˜ ì—°ê²° ì •ì±…ì„ ì •ì˜í•  ë•Œ, ì—”ë“œí¬ì¸íŠ¸ì˜ IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ IDëŠ” ì—”ë“œí¬ì¸íŠ¸ì˜ ë„¤íŠ¸ì›Œí¬ ì£¼ì†Œì™€ ë¬´ê´€í•˜ê²Œ ìœ ì§€ë˜ë©°, 
k8sì˜ labelì„ í†µí•´ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤. ì¦‰, íŒŒë“œê°„ì— ê³µìœ í•  ìˆ˜ ìˆìœ¼ë©°, ë„¤íŠ¸ì›Œí¬ ì£¼ì†Œê°€ ë³€ê²½ë˜ì–´ë„ ìœ ì§€ë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_22.png" alt="img.png" class="image-center w-80" loading="lazy" width="1346" height="632">
<em class="image-caption"><a href="https://docs.cilium.io/en/stable/security/network/identity/">https://docs.cilium.io/en/stable/security/network/identity/</a></em>
</li>
  <li>í¬íŠ¸ê¸°ë°˜ (L4) : ì—”ë“œí¬ì¸íŠ¸ ê°„ì˜ ì—°ê²° ì •ì±…ì„ ì •ì˜í•  ë•Œ, í¬íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŠ” L3 ì •ì±…ê³¼ í•¨ê»˜ ì‚¬ìš©ë  ìˆ˜ ìˆì–´ì„œ,
<code class="language-plaintext highlighter-rouge">role=frontend</code>ë¼ëŠ” ë ˆì´ë¸”ì„ ê°€ì§„ ì—”ë“œí¬ì¸íŠ¸ëŠ” 443 í¬íŠ¸ë¡œ outgoing ì—°ê²°ì„ í—ˆìš©í•˜ê³ , <code class="language-plaintext highlighter-rouge">role=backend</code>ë¼ëŠ” ë ˆì´ë¸”ì„ ê°€ì§„ ì—”ë“œí¬ì¸íŠ¸ëŠ” 
443 í¬íŠ¸ë¡œ incoming ì—°ê²°ì„ í—ˆìš©í•˜ëŠ” ë“±ì˜ ì •ì±…ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì–´í”Œë¦¬ì¼€ì´ì…˜ (http) ê¸°ë°˜ (L7) : HTTPí†µì‹ ê³¼ RPC í”„ë¡œí† ì½œì˜ ë³´ì•ˆì„ ìœ„í•´ì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì •ë°€í•˜ê²Œ ì •ì±…ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ëŠ” HTTP í—¤ë”, ë©”ì†Œë“œ, ê²½ë¡œ, ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë“±ì„ ì‚¬ìš©í•˜ì—¬ ì •ì±…ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>í”„ë¡ì‹œ ì£¼ì… : Envoy - <a href="https://docs.cilium.io/en/stable/security/network/proxy/">Docs</a>, <a href="https://docs.cilium.io/en/stable/security/network/proxy/envoy/">Envoy</a>
        <ul>
          <li>Ciliumì€ ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ëŒ€í•´ Layer 4 í”„ë¡ì‹œ(ì˜ˆ) Envoy)ë¥¼ ì£¼ì…ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ëŠ” ê³ ì°¨ì›ì˜ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ê°•ì œí•  ìˆ˜ ìˆëŠ” ê¸°ë°˜ì´ ë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_23.png" alt="img.png" class="image-center" loading="lazy" width="1090" height="627">
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_24.png" alt="img.png" class="image-center" loading="lazy" width="1159" height="855">
</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="network-policy-ê´€ë ¨-ebpf-datapath">Network Policy ê´€ë ¨ eBPF Datapath</h5>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_25.png" alt="img.png" class="image-center w-80" loading="lazy" width="1500" height="642"></p>

<ul>
  <li>Prefilter : PrefilterëŠ” XDP í”„ë¡œê·¸ë¨ì„ í†µí•´ ìˆ˜í–‰ë˜ë©°, ìµœê³ ì˜ ì„±ëŠ¥ì„ ìœ„í•´ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ í•„í„°ë§í•˜ëŠ” prefilter ê·œì¹™ë“¤ì„ ì œê³µí•©ë‹ˆë‹¤.
íŠ¹íˆ CIDR mapë“¤ì„ ì‚¬ìš©í•´ IP ì£¼ì†Œë¥¼ í•„í„°ë§í•˜ëŠ” ë“±ì˜ ë™ì‘ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>Endpoint policy : ì •ì±…ì— ë”°ë¼ íŒ¨í‚·ì„ ì°¨ë‹¨/ì „ë‹¬í•˜ê±°ë‚˜, ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬í•˜ê±°ë‚˜, L7ë¡œ ì •ì±… ì „ë‹¬ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>Cilium datapathëŠ” L3ì™€ L4 ì •ì±…ì„ ê°•ì œí•˜ê±°ë‚˜, íŒ¨í‚·ê³¼ IDë¥¼ ë§¤í•‘í•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>L7 policy : L7 ì •ì±…ì€ í”„ë¡ì‹œ íŠ¸ë˜í”½ì„ Ciliumì˜ userspace proxy instance, ì¦‰ Envoyë¡œ ì „ë‹¬í•©ë‹ˆë‹¤. Envoy ëŠ” íŠ¸ë˜í”½ì„ ì „ë‹¬í•˜ê±°ë‚˜
L7 ì •ì±…ì— ì˜í•´ ì°¨ë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <ul>
      <li>ğŸ‘‰ L7 ì •ì±…ì€ hookê³¼ Userspace Proxy(envoy)ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ ì¡°ê¸ˆ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h5 id="ì‹¤ìŠµ">ì‹¤ìŠµ</h5>

<ul>
  <li>ìŠ¤íƒ€ì›Œì¦ˆì—ì„œ ì˜ê°ë°›ì€ ì˜ˆì œë¥¼ í†µí•´ Network Policyë¥¼ ì ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.
    <ul>
      <li>ë””í”Œë¡œì´ë¨¼íŠ¸(ì›¹ ì„œë²„, deathstar, replicas 2), íŒŒë“œ(xwing, tiefighter), ì„œë¹„ìŠ¤(ClusterIP, service/deathstar)</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°°í¬</span>
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.16.3/examples/minikube/http-sw-app.yaml
<span class="c"># =&gt; service/deathstar created</span>
<span class="c">#    deployment.apps/deathstar created</span>
<span class="c">#    pod/tiefighter created</span>
<span class="c">#    pod/xwing created</span>
<span class="nv">$ </span>kubectl get all
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/deathstar-689f66b57d-mm72v   1/1     Running   0          15s</span>
<span class="c">#    pod/deathstar-689f66b57d-pz56p   1/1     Running   0          15s</span>
<span class="c">#    pod/tiefighter                   1/1     Running   0          15s</span>
<span class="c">#    pod/xwing                        1/1     Running   0          15s</span>
<span class="c">#    </span>
<span class="c">#    NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/deathstar    ClusterIP   10.10.200.162   &amp;lt;none&amp;gt;        80/TCP    15s</span>
<span class="c">#    service/kubernetes   ClusterIP   10.10.200.1     &amp;lt;none&amp;gt;        443/TCP   8h</span>
<span class="c">#    </span>
<span class="c">#    NAME                        READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/deathstar   2/2     2            2           15s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                   DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/deathstar-689f66b57d   2         2         2       15s</span>

<span class="c"># íŒŒë“œ ë¼ë²¨ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">--show-labels</span>
<span class="c"># =&gt; NAME                         READY   STATUS    RESTARTS   AGE   LABELS</span>
<span class="c">#    deathstar-689f66b57d-mm72v   1/1     Running   0          24s   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=689f66b57d</span>
<span class="c">#    deathstar-689f66b57d-pz56p   1/1     Running   0          24s   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=689f66b57d</span>
<span class="c">#    tiefighter                   1/1     Running   0          24s   app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire</span>
<span class="c">#    xwing                        1/1     Running   0          24s   app.kubernetes.io/name=xwing,class=xwing,org=alliance</span>

<span class="c"># cilium endpoint í™•ì¸</span>
<span class="nv">$ </span>kubectl get ciliumendpoints
<span class="c"># =&gt; NAME                         SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    deathstar-689f66b57d-mm72v   391                 ready            172.16.2.35</span>
<span class="c">#    deathstar-689f66b57d-pz56p   391                 ready            172.16.1.232</span>
<span class="c">#    tiefighter                   9002                ready            172.16.0.5</span>
<span class="c">#    xwing                        10812               ready            172.16.2.31</span>

<span class="nv">$ </span>c0 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    ...</span>
<span class="c">#    2481       Disabled           Disabled          9002       k8s:app.kubernetes.io/name=tiefighter                                               172.16.0.5     ready</span>
<span class="c">#                                                               k8s:class=tiefighter</span>
<span class="c">#                                                               k8s:org=empire</span>
<span class="nv">$ </span>c1 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                        IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    ...</span>
<span class="c">#    1063       Disabled           Disabled          391        k8s:app.kubernetes.io/name=deathstar                                                      172.16.1.232   ready</span>
<span class="c">#                                                               k8s:class=deathstar</span>
<span class="c">#                                                               k8s:org=empire</span>
<span class="nv">$ </span>c2 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                      IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    ...</span>
<span class="c">#    1695       Disabled           Disabled          391        k8s:app.kubernetes.io/name=deathstar                                                    172.16.2.35    ready</span>
<span class="c">#                                                               k8s:class=deathstar</span>
<span class="c">#                                                               k8s:org=empire</span>
<span class="c">#    2810       Disabled           Disabled          10812      k8s:app.kubernetes.io/name=xwing                                                        172.16.2.31    ready</span>
<span class="c">#                                                               k8s:class=xwing</span>
<span class="c">#                                                               k8s:org=alliance</span>

<span class="c"># ë°ìŠ¤ìŠ¤íƒ€ SVC(ClusterIP) ì ‘ì†í•˜ì—¬ ì›¹ íŒŒë“œ ì—°ê²° í™•ì¸ &gt;&gt; Hubble UI ì—ì„œ ì‹¤ì‹œê°„ í™•ì¸í•´ë³´ì!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>hubble observe
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_26.png" alt="img.png" loading="lazy" width="1392" height="820"></p>

<ul>
  <li>Identity-Aware and HTTP-Aware Policy Enforcement <code class="language-plaintext highlighter-rouge">Apply an L3/L4 Policy</code> - <a href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-an-l3-l4-policy">Link</a> &amp; Hubble CLI - <a href="https://docs.cilium.io/en/stable/gettingstarted/hubble_cli/">ë§í¬</a>
    <ul>
      <li>Cilium ì—ì„œëŠ” Endpoint IP ëŒ€ì‹ , <strong>íŒŒë“œ</strong>ì˜ <strong>Labels(ë¼ë²¨)</strong>ì„ ì‚¬ìš©(ê¸°ì¤€)í•˜ì—¬ <strong>ë³´ì•ˆ ì •ì±…ì„ ì ìš©</strong>í•©ë‹ˆë‹¤.</li>
      <li>
<strong>IP/Port</strong> í•„í„°ë§ì„ <strong>L3/L4 ë„¤íŠ¸ì›Œí¬ ì •ì±…</strong>ì´ë¼ê³  í•©ë‹ˆë‹¤.</li>
      <li>ì•„ë˜ ì²˜ëŸ¼ â€˜org=empireâ€™ Labels(ë¼ë²¨) ë¶€ì°©ëœ íŒŒë“œë§Œ í—ˆìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
      <li>Cilium ì€ <strong>stateful connection tracking</strong>ì„ ì§€ì›í•˜ë¯€ë¡œ ë¦¬í„´ íŠ¸ë˜í”½ì€ ìë™ìœ¼ë¡œ í—ˆìš©ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># L3/L4 ì •ì±… ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f - 
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "rule1"
spec:
  description: "L3-L4 policy to restrict deathstar access to empire ships only"
  endpointSelector:
    matchLabels:
      org: empire
      class: deathstar
  ingress:
  - fromEndpoints:
    - matchLabels:
        org: empire
    toPorts:
    - ports:
      - port: "80"
        protocol: TCP
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/rule1 created</span>

<span class="c"># ì •ì±… í™•ì¸</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME    AGE</span>
<span class="c">#    rule1   9s</span>
<span class="nv">$ </span>kubectl describe cnp rule1
<span class="nv">$ </span>c0 policy get
<span class="c"># =&gt; [</span>
<span class="c">#      {</span>
<span class="c">#        &amp;quot;endpointSelector&amp;quot;: {</span>
<span class="c">#          &amp;quot;matchLabels&amp;quot;: {</span>
<span class="c">#            &amp;quot;any:class&amp;quot;: &amp;quot;deathstar&amp;quot;,</span>
<span class="c">#            &amp;quot;any:org&amp;quot;: &amp;quot;empire&amp;quot;,</span>
<span class="c">#            &amp;quot;k8s:io.kubernetes.pod.namespace&amp;quot;: &amp;quot;default&amp;quot;</span>
<span class="c">#          }</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;ingress&amp;quot;: [</span>
<span class="c">#          {</span>
<span class="c">#            &amp;quot;fromEndpoints&amp;quot;: [</span>
<span class="c">#              {</span>
<span class="c">#                &amp;quot;matchLabels&amp;quot;: {</span>
<span class="c">#                  &amp;quot;any:org&amp;quot;: &amp;quot;empire&amp;quot;,</span>
<span class="c">#                  &amp;quot;k8s:io.kubernetes.pod.namespace&amp;quot;: &amp;quot;default&amp;quot;</span>
<span class="c">#                }</span>
<span class="c">#              }</span>
<span class="c">#            ],</span>
<span class="c">#            &amp;quot;toPorts&amp;quot;: [</span>
<span class="c">#              {</span>
<span class="c">#                &amp;quot;ports&amp;quot;: [</span>
<span class="c">#                  {</span>
<span class="c">#                    &amp;quot;port&amp;quot;: &amp;quot;80&amp;quot;,</span>
<span class="c">#                    &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;</span>
<span class="c">#                  }</span>
<span class="c">#                ]</span>
<span class="c">#              }</span>
<span class="c">#            ]</span>
<span class="c">#          }</span>
<span class="c">#        ],</span>
<span class="c">#        ...</span>
<span class="c">#        &amp;quot;enableDefaultDeny&amp;quot;: {</span>
<span class="c">#          &amp;quot;ingress&amp;quot;: true,</span>
<span class="c">#          &amp;quot;egress&amp;quot;: false</span>
<span class="c">#        },</span>
<span class="c">#        ...</span>
<span class="c">#      }</span>
<span class="c">#    ]</span>

<span class="c"># íŒŒë“œ curl ì ‘ì† ì‹œë„ ì‹œ íŒŒë“œ sh ì ‘ì† í›„ curl ì‹œë„í•˜ì!</span>
<span class="c"># ë°ìŠ¤ìŠ¤íƒ€ SVC(ClusterIP) ì ‘ì†í•˜ì—¬ ì›¹ íŒŒë“œ ì—°ê²° í™•ì¸ &gt;&gt; Hubble UI ì—ì„œ drop í™•ì¸!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; (ì—†ìŒ)</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ì ‘ì†ì´ drop ë©ë‹ˆë‹¤. xwingì€ í—ˆìš©ë˜ëŠ” `org=empire`ì¸ ì—”ë“œí¬ì¸íŠ¸ê°€ ì•„ë‹Œ `org=alliance`ì¸ ì—”ë“œí¬ì¸íŠ¸ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># hubble cli ëª¨ë‹ˆí„°ë§ </span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> xwing
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> tiefighter
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar
<span class="c"># =&gt; Oct 01 16:28:28.825: default/xwing:39224 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-mm72v:80 (ID:391) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 16:28:28.825: default/xwing:39224 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-mm72v:80 (ID:391) Policy denied DROPPED (TCP Flags: SYN)</span>

<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar <span class="nt">--verdict</span> DROPPED
<span class="c"># =&gt; Oct 01 16:27:50.894: default/xwing:43148 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-pz56p:80 (ID:391) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 16:27:50.894: default/xwing:43148 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-pz56p:80 (ID:391) Policy denied DROPPED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 16:28:24.676: default/xwing:43148 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-pz56p:80 (ID:391) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span>
<span class="c">#    Oct 01 16:28:24.676: default/xwing:43148 (ID:10812) &amp;lt;&amp;gt; default/deathstar-689f66b57d-pz56p:80 (ID:391) Policy denied DROPPED (TCP Flags: SYN)</span>

<span class="c"># Inspecting the Policy</span>
<span class="c"># If we run cilium endpoint list again we will see that the pods with the label org=empire and class=deathstar</span>
<span class="c"># now have ingress policy enforcement enabled as per the policy above.</span>

<span class="c"># endpoint list ì—ì„œ ì •ì±… ì ìš© í™•ì¸</span>
<span class="nv">$ </span>c0 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    2481       Disabled           Disabled          9002       k8s:app.kubernetes.io/name=tiefighter                                               172.16.0.5     ready</span>
<span class="c">#                                                               k8s:class=tiefighter</span>
<span class="c">#                                                               k8s:org=empire </span>
<span class="nv">$ </span>c1 endpoint list | <span class="nb">grep </span>deathstar
<span class="c"># =&gt; 1063       Enabled            Disabled          391        k8s:app.kubernetes.io/name=deathstar                                                      172.16.1.232   ready</span>
<span class="c">#                                                               k8s:class=deathstar</span>
<span class="nv">$ </span>c2 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                      IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    1695       Enabled            Disabled          391        k8s:app.kubernetes.io/name=deathstar                                                    172.16.2.35    ready</span>
<span class="c">#                                                               k8s:class=deathstar</span>
<span class="c">#                                                               k8s:org=empire</span>
<span class="c">#    2810       Disabled           Disabled          10812      k8s:app.kubernetes.io/name=xwing                                                        172.16.2.31    ready</span>
<span class="c">#                                                               k8s:class=xwing</span>
<span class="c">#                                                               k8s:org=alliance</span>
</code></pre></div></div>

<ul>
  <li>Identity-Aware and HTTP-Aware Policy Enforcement Apply and Test HTTP-aware L7 Policy - <a href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-and-test-http-aware-l7-policy">Docs</a>
    <ul>
      <li>HTTP L7 í•„í„°ë§ì„ ì ìš© : PUT /v1/exhaust-port ìš”ì²­ì„ ì°¨ë‹¨í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë°ìŠ¤ìŠ¤íƒ€ SVC(ClusterIP) ì ‘ì†</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPUT</span> deathstar.default.svc.cluster.local/v1/exhaust-port
<span class="c"># =&gt; Panic: deathstar exploded</span>
<span class="c">#    ...</span>

<span class="c"># POST /v1/request-landing API í˜¸ì¶œë§Œ í—ˆìš© ì •ì±…ìœ¼ë¡œ ê¸°ì¡´ ì •ì±… ë‚´ìš©ì„ ì—…ë°ì´íŠ¸(configured)!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f - 
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "rule1"
spec:
  description: "L7 policy to restrict access to specific HTTP call"
  endpointSelector:
    matchLabels:
      org: empire
      class: deathstar
  ingress:
  - fromEndpoints:
    - matchLabels:
        org: empire
    toPorts:
    - ports:
      - port: "80"
        protocol: TCP
      rules:
        http:
        - method: "POST"
          path: "/v1/request-landing"
</span><span class="no">EOF

</span><span class="c"># ì •ì±… í™•ì¸</span>
<span class="nv">$ </span>kubectl describe ciliumnetworkpolicies
<span class="c"># =&gt; Name:         rule1</span>
<span class="c">#    Namespace:    default</span>
<span class="c">#    Labels:       &amp;lt;none&amp;gt;</span>
<span class="c">#    Annotations:  &amp;lt;none&amp;gt;</span>
<span class="c">#    API Version:  cilium.io/v2</span>
<span class="c">#    Kind:         CiliumNetworkPolicy</span>
<span class="c">#    Metadata:</span>
<span class="c">#      Creation Timestamp:  2024-10-01T16:24:53Z</span>
<span class="c">#      Generation:          2</span>
<span class="c">#      Resource Version:    32642</span>
<span class="c">#      UID:                 d3527eec-5832-4273-b805-c006c728a8af</span>
<span class="c">#    Spec:</span>
<span class="c">#      Description:  L7 policy to restrict access to specific HTTP call</span>
<span class="c">#      Endpoint Selector:</span>
<span class="c">#        Match Labels:</span>
<span class="c">#          Class:  deathstar</span>
<span class="c">#          Org:    empire</span>
<span class="c">#      Ingress:</span>
<span class="c">#        From Endpoints:</span>
<span class="c">#          Match Labels:</span>
<span class="c">#            Org:  empire</span>
<span class="c">#        To Ports:</span>
<span class="c">#          Ports:</span>
<span class="c">#            Port:      80</span>
<span class="c">#            Protocol:  TCP</span>
<span class="c">#          Rules:</span>
<span class="c">#            Http:</span>
<span class="c">#              Method:  POST</span>
<span class="c">#              Path:    /v1/request-landing</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 policy get

<span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>c1 monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
<span class="nv">$ </span>c2 monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
<span class="c"># =&gt; &amp;lt;- Request http from 0 ([k8s:app.kubernetes.io/name=tiefighter k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]) to 1695 ([k8s:app.kubernetes.io/name=deathstar k8s:class=deathstar k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]), identity 9002-&amp;gt;391, verdict Forwarded POST http://deathstar.default.svc.cluster.local/v1/request-landing =&amp;gt; 0</span>
<span class="c">#    &amp;lt;- Response http to 0 ([k8s:app.kubernetes.io/name=tiefighter k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]) from 1695 ([k8s:app.kubernetes.io/name=deathstar k8s:class=deathstar k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]), identity 391-&amp;gt;9002, verdict Forwarded POST http://deathstar.default.svc.cluster.local/v1/request-landing =&amp;gt; 200</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar <span class="nt">--verdict</span> DROPPED

<span class="c"># ì ‘ê·¼ í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPUT</span> deathstar.default.svc.cluster.local/v1/exhaust-port
<span class="c"># =&gt; Access denied</span>

<span class="c">## hubble cli ì— ì°¨ë‹¨ ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar <span class="nt">--verdict</span> DROPPED
<span class="c"># =&gt; Oct 01 16:41:48.094: default/tiefighter:51860 (ID:9002) -&amp;gt; default/deathstar-689f66b57d-mm72v:80 (ID:391) http-request DROPPED (HTTP/1.1 PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port)</span>
<span class="c">#    Oct 01 16:41:48.094: default/tiefighter:51860 (ID:9002) &amp;lt;- default/deathstar-689f66b57d-mm72v:80 (ID:391) http-response FORWARDED (HTTP/1.1 403 0ms (PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port))</span>

<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> deathstar <span class="nt">--protocol</span> http
<span class="c"># =&gt; Oct 01 16:39:57.041: default/tiefighter:57616 (ID:9002) &amp;lt;- default/deathstar-689f66b57d-mm72v:80 (ID:391) http-response FORWARDED (HTTP/1.1 200 2ms (POST http://deathstar.default.svc.cluster.local/v1/request-landing))</span>

<span class="c"># ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.16.3/examples/minikube/http-sw-app.yaml
<span class="c"># =&gt; service &amp;quot;deathstar&amp;quot; deleted</span>
<span class="c">#    deployment.apps &amp;quot;deathstar&amp;quot; deleted</span>
<span class="c">#    pod &amp;quot;tiefighter&amp;quot; deleted</span>
<span class="c">#    pod &amp;quot;xwing&amp;quot; deleted</span>
<span class="nv">$ </span>kubectl delete cnp rule1
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io &amp;quot;rule1&amp;quot; deleted</span>
</code></pre></div></div>

<h4 id="bandwidth-manager">Bandwidth Manager</h4>

<h5 id="bandwidth-manager-ì†Œê°œ">Bandwidth Manager ì†Œê°œ</h5>

<ul>
  <li>Ciliumì€ Bandwidth(ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­)ê³¼ Latency optimization(ì§€ì—° ì‹œê°„ ìµœì í™”)ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. - <a href="https://docs.cilium.io/en/stable/network/kubernetes/bandwidth-manager/">Link</a> , <a href="https://cilium.io/use-cases/bandwidth-optimization/">Home</a> , <a href="https://www.youtube.com/watch?v=QTSS6ktK8hY">Youtube</a>
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_27.png" alt="img.png" class="image-center w-80" loading="lazy" width="1190" height="578">
<em class="image-caption"><a href="https://cilium.io/use-cases/bandwidth-optimization/">https://cilium.io/use-cases/bandwidth-optimization/</a></em>
    <ul>
      <li>bandwidth managerëŠ” TCPì™€ UDP ë¶€í•˜ë¥¼ ìµœì í™” í•˜ê³ , íš¨ìœ¨ì ìœ¼ë¡œ ê°œë³„ íŒŒë“œì˜ ì ‘ì†ë¥ ì„ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. - <strong>EDT</strong>(Earliest Departure Time) ì™€ <strong>eBPF</strong> ì‚¬ìš©</li>
      <li>
<code class="language-plaintext highlighter-rouge">kubernetes.io/egress-bandwidth</code> Pod <strong>annotation</strong> ì€ egress íŠ¸ë˜í”½ì— ëŒ€í•´ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ì˜ ëŒ€ì—­í­ ì œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤.</li>
      <li>
<del><code class="language-plaintext highlighter-rouge">kubernetes.io/ingress-bandwidth</code></del> <strong>annotation</strong> ì€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
      <li>direct routing mode, tunneling mode ë‘˜ ë‹¤ ì§€ì›í•©ë‹ˆë‹¤.</li>
      <li>Limitations : L7 ì •ì±…ê³¼ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w8/20241026_kans_w8_28.png" alt="img.png" class="image-center w-80" loading="lazy" width="722" height="496">
</li>
    </ul>
  </li>
</ul>

<h5 id="ì„¤ì •-ë°-í™•ì¸">ì„¤ì • ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì¸í„°í˜ì´ìŠ¤ tc qdisc í™•ì¸</span>
<span class="nv">$ </span>tc qdisc show dev enp0s8
<span class="c"># =&gt; qdisc fq_codel 0: root refcnt 2 limit 10240p flows 1024 quantum 1514 target 5ms interval 100ms memory_limit 32Mb ecn drop_batch 64</span>
<span class="c">#    qdisc clsact ffff: parent ffff:fff1</span>

<span class="c"># ì„¤ì •</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="nt">--set</span> bandwidthManager.enabled<span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Release &amp;quot;cilium&amp;quot; has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="c"># ì ìš© í™•ì¸</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>bandwidth
<span class="c"># =&gt; enable-bandwidth-manager                          true</span>

<span class="c"># egress bandwidth limitation ë™ì‘í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>c0 status | <span class="nb">grep  </span>BandwidthManager
<span class="c"># =&gt; BandwidthManager:        EDT with BPF [CUBIC] [enp0s3, enp0s8]</span>

<span class="c"># ì¸í„°í˜ì´ìŠ¤ tc qdisc í™•ì¸ : ì„¤ì • ì „í›„ ì˜µì…˜ê°’ë“¤ì´ ìƒë‹¹íˆ ì¶”ê°€ëœë‹¤</span>
<span class="nv">$ </span>tc qdisc
<span class="nv">$ </span>tc qdisc show dev enp0s8
<span class="c"># =&gt; qdisc fq 8006: root refcnt 2 limit 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 3028b initial_quantum 15140b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_cap</span>
<span class="c">#    qdisc clsact ffff: parent ffff:fff1</span>
</code></pre></div></div>

<h5 id="ë™ì‘-ë°-í™•ì¸">ë™ì‘ ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ íŠ¸ë˜í”½ ë°œìƒ ì„œë²„/í´ë¼ì´ì–¸íŠ¸ íŒŒë“œ ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
---
apiVersion: v1
kind: Pod
metadata:
  annotations:
    # Limits egress bandwidth to 10Mbit/s.
    kubernetes.io/egress-bandwidth: "10M"
  labels:
    # This pod will act as server.
    app.kubernetes.io/name: netperf-server
  name: netperf-server
spec:
  containers:
  - name: netperf
    image: cilium/netperf
    ports:
    - containerPort: 12865
---
apiVersion: v1
kind: Pod
metadata:
  # This Pod will act as client.
  name: netperf-client
spec:
  affinity:
    # Prevents the client from being scheduled to the
    # same node as the server.
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - netperf-server
        topologyKey: kubernetes.io/hostname
  containers:
  - name: netperf
    args:
    - sleep
    - infinity
    image: cilium/netperf
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/netperf-server created</span>
<span class="c">#    pod/netperf-client created</span>

<span class="c"># egress BW ì œí•œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe pod netperf-server | <span class="nb">grep </span>Annotations:
<span class="c"># =&gt; Annotations:      kubernetes.io/egress-bandwidth: 10M</span>

<span class="c"># egress BW ì œí•œì´ ì„¤ì •ëœ íŒŒë“œê°€ ìˆëŠ” cilium pod ì—ì„œ ì œí•œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>c0 bpf bandwidth list
<span class="nv">$ </span>c1 bpf bandwidth list
<span class="nv">$ </span>c2 bpf bandwidth list
<span class="c"># =&gt; IDENTITY   EGRESS BANDWIDTH (BitsPerSec)</span>
<span class="c">#    1391       10M</span>

<span class="nv">$ </span>c0 endpoint list
<span class="nv">$ </span>c1 endpoint list
<span class="nv">$ </span>c2 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                      IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    1391       Disabled           Disabled          8191       k8s:app.kubernetes.io/name=netperf-server                                               172.16.2.106   ready</span>
<span class="c">#    ...</span>

<span class="c"># íŠ¸ë˜í”½ ë°œìƒ &gt;&gt; Hubble UI ì—ì„œ í™•ì¸</span>
<span class="c"># egress traffic of the netperf-server Pod has been limited to 10Mbit per second. </span>
<span class="nv">$ NETPERF_SERVER_IP</span><span class="o">=</span><span class="si">$(</span>kubectl get pod netperf-server <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>netperf-client <span class="nt">--</span> netperf <span class="nt">-t</span> TCP_MAERTS <span class="nt">-H</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NETPERF_SERVER_IP</span><span class="k">}</span><span class="s2">"</span>
<span class="c"># =&gt; Recv   Send    Send</span>
<span class="c">#    Socket Socket  Message  Elapsed</span>
<span class="c">#    Size   Size    Size     Time     Throughput</span>
<span class="c">#    bytes  bytes   bytes    secs.    10^6bits/sec</span>
<span class="c">#    131072  16384  16384    10.01       9.13</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 10Mbps ì œí•œ í™•ì¸!&lt;/span&gt;</span>

<span class="c"># 5M ì œí•œ ì„¤ì • í›„ í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl get pod netperf-server <span class="nt">-o</span> json | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s|10M|5M|g'</span> | kubectl apply <span class="nt">-f</span> -
<span class="c"># =&gt; pod/netperf-server configured</span>
<span class="nv">$ </span>c0 bpf bandwidth list
<span class="nv">$ </span>c1 bpf bandwidth list
<span class="nv">$ </span>c2 bpf bandwidth list
<span class="c"># =&gt; IDENTITY   EGRESS BANDWIDTH (BitsPerSec)</span>
<span class="c">#    1391       5M</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>netperf-client <span class="nt">--</span> netperf <span class="nt">-t</span> TCP_MAERTS <span class="nt">-H</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NETPERF_SERVER_IP</span><span class="k">}</span><span class="s2">"</span>
<span class="c"># =&gt; Recv   Send    Send</span>
<span class="c">#    Socket Socket  Message  Elapsed</span>
<span class="c">#    Size   Size    Size     Time     Throughput</span>
<span class="c">#    bytes  bytes   bytes    secs.    10^6bits/sec</span>
<span class="c">#    </span>
<span class="c">#    131072  16384  16384    10.01       4.59</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 4.5Mbps ì œí•œ í™•ì¸!&lt;/span&gt;</span>

<span class="c"># 20M ì œí•œ ì„¤ì • í›„ í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl get pod netperf-server <span class="nt">-o</span> json | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s|5M|20M|g'</span> | kubectl apply <span class="nt">-f</span> -
<span class="c"># =&gt; pod/netperf-server configured</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>netperf-client <span class="nt">--</span> netperf <span class="nt">-t</span> TCP_MAERTS <span class="nt">-H</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NETPERF_SERVER_IP</span><span class="k">}</span><span class="s2">"</span>
<span class="c"># =&gt; Recv   Send    Send</span>
<span class="c">#    Socket Socket  Message  Elapsed</span>
<span class="c">#    Size   Size    Size     Time     Throughput</span>
<span class="c">#    bytes  bytes   bytes    secs.    10^6bits/sec</span>
<span class="c">#    131072  16384  16384    10.00      18.40</span>
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ 19Mbps ì œí•œ í™•ì¸!&lt;/span&gt;</span>

<span class="nv">$ </span>tc qdisc show dev enp0s8
<span class="c"># =&gt; qdisc fq 8006: root refcnt 2 limit 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 3028b initial_quantum 15140b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_cap</span>
<span class="c">#    qdisc clsact ffff: parent ffff:fff1</span>

<span class="c"># ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete pod netperf-client netperf-server
</code></pre></div></div>

<h4 id="l2-announcements--l2-aware-lb-beta">L2 Announcements / L2 Aware LB (Beta)</h4>

<ul>
  <li>ì°¸ê³  ë§í¬ : <a href="https://docs.cilium.io/en/stable/network/l2-announcements/">Link</a> , <a href="https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/">Blog</a>
</li>
  <li>L2 AnnouncementsëŠ” ë¡œì»¬ ì˜ì—­ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì„œë¹„ìŠ¤ë¥¼ í‘œì‹œí•˜ê³  ë„ë‹¬ ê°€ëŠ¥í•˜ê²Œ ë§Œë“œëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. 
ì´ ê¸°ëŠ¥ì€ ì£¼ë¡œ ì‚¬ë¬´ì‹¤ ë˜ëŠ” ìº í¼ìŠ¤ ë„¤íŠ¸ì›Œí¬ì™€ ê°™ì´ BGP ê¸°ë°˜ ë¼ìš°íŒ…ì´ ì—†ëŠ” ë„¤íŠ¸ì›Œí¬ ë‚´ì—ì„œ ì˜¨í”„ë ˆë¯¸ìŠ¤ ë°°í¬ë¥¼ ìœ„í•´ ê³ ì•ˆë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ExternalIP ë° LoadBalancer IPì— ëŒ€í•œ ARP ì¿¼ë¦¬ì— ì‘ë‹µí•©ë‹ˆë‹¤. 
ì´ëŸ¬í•œ IPëŠ” ì—¬ëŸ¬ ë…¸ë“œì˜ ê°€ìƒ IP(ë„¤íŠ¸ì›Œí¬ ì¥ì¹˜ì— ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ)ì´ë¯€ë¡œ ê° ì„œë¹„ìŠ¤ì— ëŒ€í•´ í•œ ë²ˆì— í•œ ë…¸ë“œê°€ 
ARP ì¿¼ë¦¬ì— ì‘ë‹µí•˜ê³  MAC ì£¼ì†Œë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.
ì´ ë…¸ë“œëŠ” ì„œë¹„ìŠ¤ ë¡œë“œ ë°¸ëŸ°ì‹± ê¸°ëŠ¥ìœ¼ë¡œ ë¡œë“œ ë°¸ëŸ°ì‹±ì„ ìˆ˜í–‰í•˜ì—¬ ë¶ìª½/ë‚¨ìª½ ë¡œë“œ ë°¸ëŸ°ì„œ ì—­í• ì„ í•©ë‹ˆë‹¤.</li>
  <li>NodePort ì„œë¹„ìŠ¤ì— ë¹„í•´ ì´ ê¸°ëŠ¥ì˜ ì¥ì ì€ ê° ì„œë¹„ìŠ¤ê°€ ê³ ìœ í•œ IPë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ê°€ ë™ì¼í•œ í¬íŠ¸ ë²ˆí˜¸ë¥¼
ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. 
NodePortë¥¼ ì‚¬ìš©í•  ë•Œ íŠ¸ë˜í”½ì„ ë³´ë‚¼ í˜¸ìŠ¤íŠ¸ë¥¼ ê²°ì •í•˜ëŠ” ê²ƒì€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë‹¬ë ¤ ìˆìœ¼ë©° ë…¸ë“œê°€ ë‹¤ìš´ë˜ë©´
IP+Port ì½¤ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤. L2 ê³µì§€ë¥¼ ì‚¬ìš©í•˜ë©´ ì„œë¹„ìŠ¤ VIPê°€ ë‹¤ë¥¸ ë…¸ë“œë¡œ ê°„ë‹¨íˆ ë§ˆì´ê·¸ë ˆì´ì…˜ë˜ê³  ê³„ì† ì‘ë™í•©ë‹ˆë‹¤.</li>
  <li>ì´ë¥¼ í†µí•´ MetalLBì™€ ê°™ì€ ì™¸ë¶€ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ Ciliumìœ¼ë¡œ ëŒ€ì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w8/20241026_kans_w8_29.png" alt="img.png" class="image-center w-80" loading="lazy" width="1414" height="820">
<em class="image-caption"><a href="https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/">https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/</a></em></p>

<h5 id="ì„¤ì •-ë°-í™•ì¸-1">ì„¤ì • ë° í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> l2announcements.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> externalIPs.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> l2announcements.leaseDuration<span class="o">=</span>3s <span class="nt">--set</span> l2announcements.leaseRenewDeadline<span class="o">=</span>1s <span class="nt">--set</span> l2announcements.leaseRetryPeriod<span class="o">=</span>200ms
<span class="c"># =&gt; Release &amp;quot;cilium&amp;quot; has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>
 
<span class="c">#</span>
<span class="nv">$ </span>c0 config <span class="nt">--all</span> | <span class="nb">grep </span>L2
<span class="c"># =&gt; EnableL2Announcements             : true</span>
<span class="c">#    EnableL2NeighDiscovery            : true</span>

<span class="c"># CiliumL2AnnouncementPolicy ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f - 
apiVersion: "cilium.io/v2alpha1"
kind: CiliumL2AnnouncementPolicy
metadata:
  name: policy1
spec:
  serviceSelector:
    matchLabels:
      color: blue
  nodeSelector:
    matchExpressions:
      - key: node-role.kubernetes.io/control-plane
        operator: DoesNotExist
  interfaces:
  - ^enp0s[0-9]+
  externalIPs: true
  loadBalancerIPs: true
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliuml2announcementpolicy.cilium.io/policy1 created</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get ciliuml2announcementpolicy
<span class="c"># =&gt; NAME      AGE</span>
<span class="c">#    policy1   7s</span>
<span class="nv">$ </span>kubectl describe l2announcement

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f - 
apiVersion: "cilium.io/v2alpha1"
kind: CiliumLoadBalancerIPPool
metadata:
  name: "cilium-pool"
spec:
  allowFirstLastIPs: "No"
  blocks:
  - cidr: "10.10.200.0/29"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumloadbalancerippool.cilium.io/cilium-pool created</span>

<span class="c"># cilium ip pool ì¡°íšŒ</span>
<span class="nv">$ </span>kubectl get CiliumLoadBalancerIPPool
<span class="c"># =&gt; NAME          DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-pool   false      False         6               9s</span>
</code></pre></div></div>

<h5 id="í…ŒìŠ¤íŠ¸ìš©-íŒŒë“œ-ì„œë¹„ìŠ¤-ìƒì„±">í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ, ì„œë¹„ìŠ¤ ìƒì„±</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: webpod1
  labels:
    app: webpod
spec:
  nodeName: k3s-w1
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod2
  labels:
    app: webpod
spec:
  nodeName: k3s-w2
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Service
metadata:
  name: svc1
spec:
  ports:
    - name: svc1-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer  # ğŸ‘‰ ì„œë¹„ìŠ¤ íƒ€ì…ì´ LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: svc2
spec:
  ports:
    - name: svc2-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer  # ğŸ‘‰ ì„œë¹„ìŠ¤ íƒ€ì…ì´ LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: svc3
spec:
  ports:
    - name: svc3-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer  # ğŸ‘‰ ì„œë¹„ìŠ¤ íƒ€ì…ì´ LoadBalancer
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/webpod1 created</span>
<span class="c">#    pod/webpod2 created</span>
<span class="c">#    service/svc1 created</span>
<span class="c">#    service/svc2 created</span>
<span class="c">#    service/svc3 created</span>
</code></pre></div></div>

<h5 id="ì ‘ì†-í™•ì¸">ì ‘ì† í™•ì¸</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get svc,ep
<span class="c"># =&gt; NAME                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/kubernetes   ClusterIP      10.10.200.1     &amp;lt;none&amp;gt;        443/TCP        10h</span>
<span class="c">#    service/svc1         LoadBalancer   10.10.200.214   10.10.200.1   80:30456/TCP   98s</span>
<span class="c">#    service/svc2         LoadBalancer   10.10.200.240   10.10.200.2   80:30367/TCP   98s</span>
<span class="c">#    service/svc3         LoadBalancer   10.10.200.155   10.10.200.3   80:31800/TCP   98s</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                        AGE</span>
<span class="c">#    endpoints/kubernetes   192.168.10.10:6443               10h</span>
<span class="c">#    endpoints/svc1         172.16.1.32:80,172.16.2.115:80   98s</span>
<span class="c">#    endpoints/svc2         172.16.1.32:80,172.16.2.115:80   98s</span>
<span class="c">#    endpoints/svc3         172.16.1.32:80,172.16.2.115:80   98s</span>

<span class="c">#</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> 10.10.200.1
<span class="c"># =&gt; Hostname: webpod1</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 172.16.1.32</span>
<span class="c">#    RemoteAddr: 192.168.10.10:58036</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 10.10.200.1</span>
<span class="c">#    User-Agent: curl/7.81.0</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> 10.10.200.2
<span class="c"># =&gt; Hostname: webpod2</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 172.16.2.115</span>
<span class="c">#    RemoteAddr: 192.168.10.10:53496</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 10.10.200.2</span>
<span class="c">#    User-Agent: curl/7.81.0</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> 10.10.200.3
<span class="c"># =&gt; Hostname: webpod1</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: 172.16.1.32</span>
<span class="c">#    RemoteAddr: 192.168.10.10:54098</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 10.10.200.3</span>
<span class="c">#    User-Agent: curl/7.81.0</span>
<span class="c">#    Accept: */*</span>
</code></pre></div></div>

<p>ì´ìƒê³¼ ê°™ì´ Cilium ë§Œìœ¼ë¡œ Loadbalancerìœ í˜•ì˜ Serviceë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>

<hr>

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì´ë²ˆ ê¸€ì—ì„œëŠ” Cilium CNIì˜ ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì„ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.
Cilium CNIì€ ì•Œë©´ ì•Œìˆ˜ë¡ â€œëíŒì™•â€, â€œItâ€™s magic!â€ì´ë¼ëŠ” ë§ì´ ê³„ì† ë– ì˜¬ëìŠµë‹ˆë‹¤.
ì•„ë˜ì˜ ë§ê³¼ ì°¸ ë§ë‹¿ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.</p>

<blockquote>
  <p>â€œì¶©ë¶„íˆ ë°œë‹¬í•œ ê³¼í•™ ê¸°ìˆ ì€ ë§ˆë²•ê³¼ êµ¬ë³„í•  ìˆ˜ ì—†ë‹¤â€ - ì•„ì„œ í´ë¼í¬</p>
</blockquote>

<p>ìŠ¤í„°ë”” ì¤‘ì—ë„ ê°€ì‹œë‹¤ ë‹˜ì´ â€œë©ë‹ˆë‹¤â€ë¥¼ ì—°ë°œí•˜ì…”ì„œ â€œë‹¤ ë˜ëŠ” í˜ì´â€ KB í˜ì´ ê´‘ê³ ê°€ ìƒê°ë‚¬ìŠµë‹ˆë‹¤. 
ì •ë§ ë‹¤ ë˜ëŠ” CNIì¸ê²ƒ ê°™ìŠµë‹ˆë‹¤.
ë¬¼ë¡  eBPFë‚˜ Envoyì™€ ê°™ì€ ê¸°ìˆ ë“¤ì´ ìˆì—ˆê¸°ì— Ciliumì´ ê°€ëŠ¥í•œ ê²ƒì´ì§€ë§Œ, ì°¸ ëŒ€ë‹¨í•©ë‹ˆë‹¤.
ì´ë²ˆì— ì‹¤ìŠµí•œê²ƒ ì™¸ì—ë„ ë” ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì´ ìˆì–´ì„œ, ë”ìš±ë” ê³µë¶€í•´ì•¼ê² ë‹¤ëŠ” ìƒê°ì´ ë“­ë‹ˆë‹¤.</p>

<p>ì–´ëŠë§ ë‹¤ìŒì£¼ê°€ ë§ˆì§€ë§‰ ì£¼ì°¨ì…ë‹ˆë‹¤. ì´ëŸ° ì €ëŸ° ì¼ë“¤ë¡œ ìŠ¤í„°ë”” í¬ê¸°í• ê¹Œ í•˜ëŠ” ë•Œë„ ìˆì—ˆëŠ”ë° ì–´ì°Œì €ì°Œ ì˜ ë²„í…¼ìŠµë‹ˆë‹¤. 
ë‹¤ìŒì£¼ì—ëŠ” ì¢€ ë” ì¼ì° ê³¼ì œë¥¼ ì œì¶œí•  ìˆ˜ ìˆê¸°ë¥¼ ë°”ë¼ë©°
ì´ë§Œ í¬ìŠ¤íŒ…ì„ ë§ˆì¹˜ê² ìŠµë‹ˆë‹¤.</p>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">ë“¤ì–´ê°€ë©°</a></li>
<li class="toc-entry toc-h2">
<a href="#cilium">Cilium</a>
<ul>
<li class="toc-entry toc-h3"><a href="#bpfebpf-%EC%86%8C%EA%B0%9C">BPF/eBPF ì†Œê°œ</a></li>
<li class="toc-entry toc-h3">
<a href="#cilium-%EC%86%8C%EA%B0%9C">Cilium ì†Œê°œ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#cilium-%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90">Cilium ì•„í‚¤í…ì³</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#cilium-%EC%8B%A4%EC%8A%B5">Cilium ì‹¤ìŠµ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#cilium-%EC%84%A4%EC%B9%98">Cilium ì„¤ì¹˜</a></li>
<li class="toc-entry toc-h4"><a href="#cilium-%EA%B8%B0%EB%B3%B8%EC%A0%95%EB%B3%B4-%ED%99%95%EC%9D%B8">Cilium ê¸°ë³¸ì •ë³´ í™•ì¸</a></li>
<li class="toc-entry toc-h4"><a href="#hubble">Hubble</a></li>
<li class="toc-entry toc-h4"><a href="#%EB%85%B8%EB%93%9C%EA%B0%84-%ED%8C%8C%EB%93%9C-%ED%86%B5%EC%8B%A0">ë…¸ë“œê°„ íŒŒë“œ í†µì‹ </a></li>
<li class="toc-entry toc-h4"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4-%ED%86%B5%EC%8B%A0-%ED%99%95%EC%9D%B8">ì„œë¹„ìŠ¤ í†µì‹  í™•ì¸</a></li>
<li class="toc-entry toc-h4"><a href="#prometheus%EC%99%80-grafana%EB%A5%BC-%ED%86%B5%ED%95%9C-cilium-%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">Prometheusì™€ Grafanaë¥¼ í†µí•œ Cilium ëª¨ë‹ˆí„°ë§</a></li>
<li class="toc-entry toc-h4"><a href="#network-policy-l3-l4-l7">Network Policy (L3, L4, L7)</a></li>
<li class="toc-entry toc-h4"><a href="#bandwidth-manager">Bandwidth Manager</a></li>
<li class="toc-entry toc-h4"><a href="#l2-announcements--l2-aware-lb-beta">L2 Announcements / L2 Aware LB (Beta)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">ë§ˆì¹˜ë©°</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2024-10-26-KANS-Study-Week8/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2024-10-19-KANS-Study-Week7/">Â« [KANS 3ê¸°] Service Mesh : Istio - Mode (Sidecar, Ambient)</a>
  
  
  <a class="next" href="/posts/2024-11-03-KANS-Study-Week9/">[KANS 3ê¸°] AWS EKS : VPC CNI Â»</a>
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2024-10-26-KANS-Study-Week8/";
this.page.identifier = "/posts/KANS Study - Week8";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>

<!--      <div class="adsbygoogle-side">-->
<!--        &lt;!&ndash; ad_side &ndash;&gt;-->
<!--        <ins class="adsbygoogle "-->
<!--             style="display: block"-->
<!--             data-ad-client="ca-pub-6564723532026864"-->
<!--             data-ad-slot="1339398797"-->
<!--             data-ad-format="auto"-->
<!--             data-full-width-responsive="true"></ins>-->
<!--      </div>-->
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>ê³µë¶€ ê¸°ë¡ê³¼ ê°œë°œ ì´ì•¼ê¸°ë¥¼ ë‹´ì€ ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>

<!--    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6564723532026864"-->
<!--            crossorigin="anonymous"></script>-->
<!--    <script>-->
<!--    (adsbygoogle = window.adsbygoogle || []).push({});-->
<!--    </script>-->
  </body>

</html>
