<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[KANS 3ê¸°] AWS EKS : VPC CNI | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[KANS 3ê¸°] AWS EKS : VPC CNI">
<meta property="og:locale" content="ko">
<meta name="description" content="ì´ë²ˆ ì£¼ì—ëŠ” AWS EKSì˜ VPC CNIì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.">
<meta property="og:description" content="ì´ë²ˆ ì£¼ì—ëŠ” AWS EKSì˜ VPC CNIì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2024-11-03-KANS-Study-Week9/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2024-11-03-KANS-Study-Week9/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-11-03T00:00:18+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[KANS 3ê¸°] AWS EKS : VPC CNI">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-11-03T00:00:18+09:00","datePublished":"2024-11-03T00:00:18+09:00","description":"ì´ë²ˆ ì£¼ì—ëŠ” AWS EKSì˜ VPC CNIì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.","headline":"[KANS 3ê¸°] AWS EKS : VPC CNI","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2024-11-03-KANS-Study-Week9/"},"url":"https://sweetlittlebird.github.io/posts/2024-11-03-KANS-Study-Week9/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">ì†Œê°œ</a><a class="page-link" href="/posts/">ê¸€ ëª©ë¡</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[KANS 3ê¸°] AWS EKS : VPC CNI</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-11-03T00:00:18+09:00" itemprop="datePublished">2024ë…„ 11ì›” 03ì¼ì— ì‘ì„±
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>ëª©ì°¨</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">ë“¤ì–´ê°€ë©°</a></li>
<li class="toc-entry toc-h2">
<a href="#aws-eks--vpc-cni">AWS EKS : VPC CNI</a>
<ul>
<li class="toc-entry toc-h3">
<a href="#aws-vpc-cni-%EC%86%8C%EA%B0%9C">AWS VPC CNI ì†Œê°œ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#calico-cni%EC%99%80%EC%9D%98-%EC%B0%A8%EC%9D%B4%EC%A0%90">Calico CNIì™€ì˜ ì°¨ì´ì </a></li>
<li class="toc-entry toc-h4"><a href="#ipv4-prefix-%EC%9C%84%EC%9E%84-delegation">IPv4 Prefix ìœ„ì„ (Delegation)</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%EC%8B%A4%EC%8A%B5-%EC%A4%80%EB%B9%84">ì‹¤ìŠµ ì¤€ë¹„</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EA%B5%AC%EC%84%B1-%ED%99%98%EA%B2%BD">êµ¬ì„± í™˜ê²½</a></li>
<li class="toc-entry toc-h4"><a href="#%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%85%8C%EC%8A%A4%ED%8A%B8">ë°°í¬ ë° í…ŒìŠ¤íŠ¸</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%EB%85%B8%EB%93%9C%EC%97%90%EC%84%9C-%EA%B8%B0%EB%B3%B8-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A0%95%EB%B3%B4-%ED%99%95%EC%9D%B8">ë…¸ë“œì—ì„œ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%9B%8C%EC%BB%A4-%EB%85%B8%EB%93%9C-%EA%B8%B0%EB%B3%B8-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EA%B5%AC%EC%84%B1">ì›Œì»¤ ë…¸ë“œ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ êµ¬ì„±</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-%EB%B3%B4%EC%A1%B0-ipv4-%EC%A3%BC%EC%86%8C%EB%A5%BC-%ED%8C%8C%EB%93%9C%EA%B0%80-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94%EC%A7%80-%ED%99%95%EC%9D%B8">[ì‹¤ìŠµ] ë³´ì¡° IPv4 ì£¼ì†Œë¥¼ íŒŒë“œê°€ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-%ED%85%8C%EC%8A%A4%ED%8A%B8%EC%9A%A9-%ED%8C%8C%EB%93%9C-%EC%83%9D%EC%84%B1---nicolakanetshoot">[ì‹¤ìŠµ] í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ ìƒì„± - nicolaka/netshoot</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%EB%85%B8%EB%93%9C%EA%B0%84-%ED%8C%8C%EB%93%9C-%ED%86%B5%EC%8B%A0">ë…¸ë“œê°„ íŒŒë“œ í†µì‹ </a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-%ED%8C%8C%EB%93%9C%EA%B0%84-%ED%86%B5%EC%8B%A0-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EB%B0%8F-%ED%99%95%EC%9D%B8--%EB%B3%84%EB%8F%84%EC%9D%98-nat-%EB%8F%99%EC%9E%91-%EC%97%86%EC%9D%B4-%ED%86%B5%EC%8B%A0-%EA%B0%80%EB%8A%A5">[ì‹¤ìŠµ] íŒŒë“œê°„ í†µì‹  í…ŒìŠ¤íŠ¸ ë° í™•ì¸ : ë³„ë„ì˜ NAT ë™ì‘ ì—†ì´ í†µì‹  ê°€ëŠ¥!</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%ED%8C%8C%EB%93%9C%EC%97%90%EC%84%9C-%EC%99%B8%EB%B6%80-%ED%86%B5%EC%8B%A0">íŒŒë“œì—ì„œ ì™¸ë¶€ í†µì‹ </a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-%ED%8C%8C%EB%93%9C%EC%97%90%EC%84%9C-%EC%99%B8%EB%B6%80-%ED%86%B5%EC%8B%A0-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EB%B0%8F-%ED%99%95%EC%9D%B8">[ì‹¤ìŠµ] íŒŒë“œì—ì„œ ì™¸ë¶€ í†µì‹  í…ŒìŠ¤íŠ¸ ë° í™•ì¸</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%EB%85%B8%EB%93%9C%EC%9D%98-%ED%8C%8C%EB%93%9C-%EC%83%9D%EC%84%B1-%EA%B0%AF%EC%88%98-%EC%A0%9C%ED%95%9C">ë…¸ë“œì˜ íŒŒë“œ ìƒì„± ê°¯ìˆ˜ ì œí•œ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%82%AC%EC%A0%84-%EC%A4%80%EB%B9%84--kube-ops-view-%EC%84%A4%EC%B9%98">ì‚¬ì „ ì¤€ë¹„ : kube-ops-view ì„¤ì¹˜</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%9B%8C%EC%BB%A4-%EB%85%B8%EB%93%9C%EC%9D%98-%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%ED%83%80%EC%9E%85-%EB%B3%84-%ED%8C%8C%EB%93%9C-%EC%83%9D%EC%84%B1-%EA%B0%AF%EC%88%98-%EC%A0%9C%ED%95%9C">ì›Œì»¤ ë…¸ë“œì˜ ì¸ìŠ¤í„´ìŠ¤ íƒ€ì… ë³„ íŒŒë“œ ìƒì„± ê°¯ìˆ˜ ì œí•œ</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%9B%8C%EC%BB%A4-%EB%85%B8%EB%93%9C%EC%9D%98-%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%EC%A0%95%EB%B3%B4-%ED%99%95%EC%9D%B8--t3medium-%EC%82%AC%EC%9A%A9-%EC%8B%9C">ì›Œì»¤ ë…¸ë“œì˜ ì¸ìŠ¤í„´ìŠ¤ ì •ë³´ í™•ì¸ : t3.medium ì‚¬ìš© ì‹œ</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%B5%9C%EB%8C%80-%ED%8C%8C%EB%93%9C-%EC%83%9D%EC%84%B1-%EB%B0%8F-%ED%99%95%EC%9D%B8">ìµœëŒ€ íŒŒë“œ ìƒì„± ë° í™•ì¸</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#service--aws-loadbalancer-controller">Service &amp; AWS LoadBalancer Controller</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%A2%85%EB%A5%98">ì„œë¹„ìŠ¤ ì¢…ë¥˜</a></li>
<li class="toc-entry toc-h4"><a href="#nlb-%EB%AA%A8%EB%93%9C-%EC%A0%84%EC%B2%B4-%EC%A0%95%EB%A6%AC">NLB ëª¨ë“œ ì „ì²´ ì •ë¦¬</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#ingress">Ingress</a>
<ul>
<li class="toc-entry toc-h4"><a href="#aws-load-balancer-controller--ingress-alb-ip-%EB%AA%A8%EB%93%9C-%EB%8F%99%EC%9E%91-with-aws-vpc-cni">AWS Load Balancer Controller + Ingress (ALB) IP ëª¨ë“œ ë™ì‘ with AWS VPC CNI</a></li>
<li class="toc-entry toc-h4"><a href="#kubernetes-%EC%9D%91%EC%9A%A9%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%A8%EC%9D%84-%EC%99%B8%EB%B6%80%EB%A1%9C-%EB%85%B8%EC%B6%9C-%EC%8B%9C%ED%82%A4%EB%8A%94-%EB%B0%A9%EB%B2%95%EB%93%A4-%EB%B9%84%EA%B5%90">Kubernetes ì‘ìš©í”„ë¡œê·¸ë¨ì„ ì™¸ë¶€ë¡œ ë…¸ì¶œ ì‹œí‚¤ëŠ” ë°©ë²•ë“¤ ë¹„êµ</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#externaldns">ExternalDNS</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5-%EC%99%84%EB%A3%8C-%ED%9B%84-%EC%9E%90%EC%9B%90-%EC%82%AD%EC%A0%9C">ì‹¤ìŠµ ì™„ë£Œ í›„ ìì› ì‚­ì œ</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">ë§ˆì¹˜ë©°</a></li>
</ul>
    </div>
    <h2 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h2>

<p>ì•ˆë…•í•˜ì„¸ìš”. ì´ë²ˆ ì£¼ì—ëŠ” AWS EKSì˜ VPC CNIì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
KANS 3ê¸° 9ì£¼ì°¨ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr>

<h2 id="aws-eks--vpc-cni">AWS EKS : VPC CNI</h2>

<h3 id="aws-vpc-cni-ì†Œê°œ">AWS VPC CNI ì†Œê°œ</h3>

<ul>
  <li>AWS VPC CNIëŠ” AWSì—ì„œ ì œê³µí•˜ëŠ” CNI(Container Network Interface) í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ, AWS VPC(Virtual Private Cloud)ì˜ ë„¤íŠ¸ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒë“œ ê°„ í†µì‹ ì„ ì§€ì›í•˜ëŠ” CNI í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</li>
  <li>AWS VPC CNIì˜ íŠ¹ì§•
    <ul>
      <li>ê°€ì¥ í° íŠ¹ì§•ì€ íŒŒë“œì˜ IP ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ê³¼ ë…¸ë“œ(ì¸ìŠ¤í„´ìŠ¤)ì˜ IP ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì´ ê°™ì•„ì„œ ì§ì ‘ í†µì‹ ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. - 
<a href="https://github.com/aws/amazon-vpc-cni-k8s">Github</a>, <a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md">Proposal</a>
</li>
      <li>ë˜í•œ VPCì™€ í†µí•©ë˜ì–´ VPC Flow logsë‚˜ VPC ë¼ìš°íŒ… ì •ì±…, ë³´ì•ˆ ê·¸ë£¹(Security Group) ë“±ì„ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ì•„ë˜ì—ì„œ ì„¤ëª…í•  Warm Poolì„ í†µí•´ ë…¸ë“œì˜ IP ì£¼ì†Œë¥¼ ì¬ì‚¬ìš©í•˜ì—¬ íŒŒë“œì˜ ìƒì„±ê³¼ ì‚­ì œë¥¼ ë¹ ë¥´ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Amazon VPC CNIëŠ” í¬ê²Œ ë‘ê°€ì§€ êµ¬ì„±ìš”ì†Œë¡œ  ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.
    <ul>
      <li>CNI ë°”ì´ë„ˆë¦¬ : íŒŒë“œê°„ í†µì‹ ì„ í™œì„±í™” í•˜ë„ë¡ íŒŒë“œ ë„¤íŠ¸ì›Œí¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. CNI ë°”ì´ë„ˆë¦¬ëŠ” ë…¸ë“œì˜ ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ì‹¤í–‰ë˜ë©°,
ìƒˆë¡œìš´ íŒŒë“œê°€ ì¶”ê°€ë˜ê±°ë‚˜, ê¸°ì¡´ íŒŒë“œê°€ ì œê±° ë ë•Œ kubeletì— ì˜í•´ í˜¸ì¶œë©ë‹ˆë‹¤.</li>
      <li>ipamd : IP ì£¼ì†Œë¥¼ í• ë‹¹í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë°ëª¬ìœ¼ë¡œ ë‹¤ìŒì„ ë‹´ë‹¹ í•©ë‹ˆë‹¤.
        <ul>
          <li>ë…¸ë“œì—ì„œ ENI(<code class="language-plaintext highlighter-rouge">Elastic Network Interface</code> - EC2ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì¼ì¢…ì˜ ê°€ìƒ ëœì¹´ë“œ) ê´€ë¦¬</li>
          <li>ì‚¬ìš©ê°€ëŠ¥í•œ IP ì£¼ì†Œë“¤ì˜ ì›œí’€ ìœ ì§€</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ë©´ EC2ëŠ” ê¸°ë³¸ ì„œë¸Œë„·ê³¼ ì—°ê²°ëœ ê¸°ë³¸ ENIë¥¼ ìƒì„±í•˜ê³  ì—°ê²°í•©ë‹ˆë‹¤.
í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ëª¨ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” í¬ë“œëŠ” ë…¸ë“œ ê¸°ë³¸ ENIì— í• ë‹¹ëœ ê¸°ë³¸ IP ì£¼ì†Œë¥¼ 
ì‚¬ìš©í•˜ë©° í˜¸ìŠ¤íŠ¸ì™€ ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê³µìœ í•©ë‹ˆë‹¤.</li>
</ul>

<blockquote>
  <p><strong>ì›œí’€(warm pool)</strong>ì€
  ë…¸ë“œê°€ í”„ë¡œë¹„ì €ë‹ ë  ë•Œ ë¯¸ë¦¬ í• ë‹¹ëœ IP ì£¼ì†Œë“¤ì˜ ì§‘í•©ì…ë‹ˆë‹¤. 
  ì´ê²ƒì€ ë…¸ë“œê°€ í”„ë¡œë¹„ì €ë‹ ë  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ IP ì£¼ì†Œë¥¼ í• ë‹¹í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê³ , ë…¸ë“œê°€ ì‚­ì œë˜ì–´ë„ IP ì£¼ì†Œë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ì—¬
  ì¡°ê¸ˆ ë” ë¹ ë¥¸ íŒŒë“œì˜ ìƒì„±ê³¼ ì‚­ì œë¥¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.</p>
</blockquote>

<ul>
  <li>EC2 ì¸ìŠ¤í„´ìŠ¤ë³„ ìµœëŒ€ ì‚¬ìš©ê°€ëŠ¥í•œ ENI ê°¯ìˆ˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥´ë©°, 
ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ë³„ ENI ê°¯ìˆ˜ëŠ” <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#network-cards">ì—¬ê¸°</a>ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
ì´ ENI ê°¯ìˆ˜ì— ë”°ë¼ í• ë‹¹ ê°€ëŠ¥í•œ IP ì£¼ì†Œì˜ ê°¯ìˆ˜ê°€ ê²°ì •ë˜ë©°, ì´ì— ë”°ë¼ íŒŒë“œì˜ ê°¯ìˆ˜ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>
    <p>ê° ENIëŠ” í• ë‹¹í•  ìˆ˜ ìˆëŠ” IPìˆ˜ê°€ ì œí•œë˜ì–´ ìˆìœ¼ë©°, ì´ ìˆ˜ëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤.
ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ë³„ ENI ë‹¹ IP í• ë‹¹ ìˆ˜ëŠ” <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AvailableIpPerENI.html">ì—¬ê¸°</a>ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ENI ë‹¹ í• ë‹¹í•  ìˆ˜ ìˆëŠ” IP ë¥¼ slot ì´ë¼ê³  í•˜ë©°, ì´ slotì€ VPC CNIë¥¼ í†µí•´ íŒŒë“œì— í• ë‹¹ë©ë‹ˆë‹¤.</p>

    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_1.png" alt="img.png" class="image-center" loading="lazy" width="2048" height="766">
<em class="image-caption">íŒŒë“œì— IPë¥¼ í• ë‹¹í•˜ê¸° ìœ„í•œ ì ˆì°¨</em></p>
  </li>
</ul>

<h4 id="calico-cniì™€ì˜-ì°¨ì´ì ">Calico CNIì™€ì˜ ì°¨ì´ì </h4>

<ul>
  <li>ë…¸ë“œì™€ íŒŒë“œì˜ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì„ ë™ì¼í•˜ê²Œ ì„¤ì •í•¨ìœ¼ë¡œì¨ NAT(Network Address Translation)ì„ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ë˜ê¸° ë•Œë¬¸ì—
ì„±ëŠ¥ì´ í–¥ìƒë˜ê³  ì§€ì—°ì´ ìµœì†Œí™” ë©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_2.png" alt="img.png" class="image-center w-80" loading="lazy" width="889" height="390"></p>

<ul>
  <li>íŒŒë“œê°„ í†µì‹ ì‹œ Calico CNI ë“±ì˜ ì¼ë°˜ì ì¸ CNIëŠ” ì˜¤ë²„ë ˆì´(VXLAN, IP-in-IP)ë¥¼ ì‚¬ìš©í•˜ì—¬ í†µì‹ í•˜ì§€ë§Œ,
AWS VPC CNIëŠ” VPCì˜ ë„¤íŠ¸ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ì ‘ í†µì‹ í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_3.png" alt="img_1.png" class="image-center w-90" loading="lazy" width="1381" height="433"></p>

<h4 id="ipv4-prefix-ìœ„ì„-delegation">IPv4 Prefix ìœ„ì„ (Delegation)</h4>

<ul>
  <li>ì•ì„œ ì•Œì•„ ë³¸ê²ƒ ì²˜ëŸ¼ ê° íŒŒë“œëŠ” ë…¸ë“œì˜ ENIì— í• ë‹¹ëœ IP ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ê³ , ENIë‹¹ IP (slot) ìˆ˜ì™€ ENI ê°¯ìˆ˜ëŠ”
ì¸ìŠ¤í„´ìŠ¤ë³„ë¡œ ì œí•œì´ ìˆê³ , ì´ ê°’ì´ í° í¸ì´ ì•„ë‹™ë‹ˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸°ìœ„í•´ IPv4 Prefix ìœ„ì„ì´ ë„ì…ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>IPv4 PrefixëŠ” ENI ë³„ë¡œ IPë¥¼ í• ë‹¹í•˜ì§€ ì•Šê³ , /28ì˜ ì ‘ë‘ì‚¬ ê¸¸ì´ CIDR ë¸”ë¡ì„ ë…¸ë“œì— í• ë‹¹í•˜ì—¬ íŒŒë“œì— í• ë‹¹í•  IP ì£¼ì†Œë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
ì´ë ‡ê²Œ í•˜ë©´ ê° ìŠ¬ëë‹¹ 16ê°œì˜ IPì£¼ì†Œë¥¼ í• ë‹¹í•  ìˆ˜ ìˆì–´ì„œ ë‹¤ìŒê³¼ ê°™ì€ ê°¯ìˆ˜ì˜ ìµœëŒ€ IP ë˜ëŠ” íŒŒë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ìµœëŒ€ ì‚¬ìš©ê°€ëŠ¥í•œ IP ìˆ˜ ê³„ì‚° : 
<code class="language-plaintext highlighter-rouge">ì‚¬ìš©ê°€ëŠ¥í•œ íŒŒë“œ IP ìˆ˜ = (ìµœëŒ€ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤(ENI) ê°¯ìˆ˜ * (ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ë‹¹ slot ìˆ˜ - 1) * 16)</code>
    <ul>
      <li>ë‹¨, ì‹¤ì œë¡œëŠ” ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•ë³„ë¡œ ê¶Œì¥ë˜ëŠ” ìµœëŒ€ ê°¯ìˆ˜ë¡œ ì„ ì •ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_4.png" alt="img.png" class="image-center" loading="lazy" width="1899" height="906"></p>

<ul>
  <li>ì°¸ê³  ë§í¬ : <a href="https://trans.yonghochoi.com/translations/aws_vpc_cni_increase_pods_per_node_limits.ko">Amazon VPC CNI í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ ë…¸ë“œë‹¹ íŒŒë“œìˆ˜ ì œí•œ ëŠ˜ë¦¬ê¸°</a>
</li>
</ul>

<hr>

<h3 id="ì‹¤ìŠµ-ì¤€ë¹„">ì‹¤ìŠµ ì¤€ë¹„</h3>

<h4 id="êµ¬ì„±-í™˜ê²½">êµ¬ì„± í™˜ê²½</h4>

<ul>
  <li>ì‚¬ì „ ì¤€ë¹„ë¬¼ : AWS ê³„ì •, SSH í‚¤ í˜ì–´, IAM ê³„ì • ìƒì„± í›„ í‚¤</li>
  <li>ì „ì²´ êµ¬ì„±ë„ : VPC 1ê°œ(í¼ë¸”ë¦­ ì„œë¸Œë„· 3ê°œ, í”„ë¼ì´ë¹— ì„œë¸Œë„· 3ê°œ), EKS í´ëŸ¬ìŠ¤í„°(Control Plane), ê´€ë¦¬í˜• ë…¸ë“œ ê·¸ë£¹(EC2 3ëŒ€), Add-on
<img src="/assets/2024/kans-3th/w9/20241102_kans_w9_28.png" alt="img.png" class="image-center" loading="lazy" width="1370" height="705">
    <ul>
      <li>CloudFormation ìŠ¤íƒ ì‹¤í–‰ ì‹œ <strong>íŒŒë¼ë¯¸í„°</strong>ë¥¼ ê¸°ì…í•˜ë©´, í•´ë‹¹ ì •ë³´ê°€ ë°˜ì˜ë˜ì–´ ë°°í¬ë©ë‹ˆë‹¤.</li>
      <li>ì‹¤ìŠµ í™˜ê²½ì„ ìœ„í•œ <strong>VPC</strong> 1ê°œê°€ ìƒì„±ë˜ê³ , <strong>í¼ë¸”ë¦­</strong> ì„œë¸Œë„· 3ê°œì™€ <strong>í”„ë¼ì´ë¹—</strong> ì„œë¸Œë„· 3ê°œê°€ ìƒì„±ë©ë‹ˆë‹¤.</li>
      <li>CloudFormation ì— EC2ì˜ <strong>UserData</strong> ë¶€ë¶„(<strong>Script</strong> ì‹¤í–‰)ìœ¼ë¡œ Amazon EKS <strong>ì„¤ì¹˜(with OIDC, Endpoint Public)</strong>ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</li>
      <li>
<strong>ê´€ë¦¬í˜• ë…¸ë“œ ê·¸ë£¹</strong>(ì›Œì»¤ ë…¸ë“œ)ëŠ” AZ1~AZ3ë¥¼ ì‚¬ìš©í•˜ì—¬, ê¸°ë³¸ <strong>3</strong>ëŒ€ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤</li>
      <li>
<strong>Add-on</strong> ê°™ì´ ì„¤ì¹˜ ë¨ : ìµœì‹  ë²„ì „ - kube-proxy, coredns, aws vpc cni - <a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-add-ons.html">ë§í¬</a>
</li>
      <li>
<strong>ë…¸ë“œ</strong>ì— <strong>EC2 IAM Profile</strong> ê¶Œí•œ ì¶”ê°€ : external-dns-access, full-ecr-access, alb-ingress-access, awsLoadBalancerController</li>
    </ul>
  </li>
</ul>

<h4 id="ë°°í¬-ë°-í…ŒìŠ¤íŠ¸">ë°°í¬ ë° í…ŒìŠ¤íŠ¸</h4>

<ul>
  <li>ë°°í¬
    <ul>
      <li>aws clië¥¼ ì„¤ì¹˜í•˜ê³ , aws configureë¡œ ìê²©ì¦ëª…ì„ ì„¤ì • í›„ ì•„ë˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.</li>
      <li>ë‹¤ìŒì˜ íŒŒë¼ë¯¸í„°ê°€ ìˆê³ , <img class="emoji" title=":point_right:" alt=":point_right:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f449.png" height="20" width="20" loading="lazy"> í‘œì‹œê°€ ìˆëŠ” ë¶€ë¶„ì€ í•„ìˆ˜ë¡œ ì„¤ì •í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.
        <ul>
          <li>
<strong>Deploy EC2</strong>
            <ol>
              <li>
<img class="emoji" title=":point_right:" alt=":point_right:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f449.png" height="20" width="20" loading="lazy"> <strong>KeyName</strong> : ì‘ì—…ìš© bastion ec2ì— SSH ì ‘ì†ì„ ìœ„í•œ <strong>SSH í‚¤í˜ì–´</strong> ì„ íƒ <em>â† ë¯¸ë¦¬ SSH í‚¤ ìƒì„± í•´ë‘ì!</em>
</li>
              <li>
<img class="emoji" title=":point_right:" alt=":point_right:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f449.png" height="20" width="20" loading="lazy"> <strong>MyIamUserAccessKeyID</strong> : <strong>ê´€ë¦¬ì</strong> ìˆ˜ì¤€ì˜ ê¶Œí•œì„ ê°€ì§„ IAM Userì˜ ì•¡ì„¸ìŠ¤ í‚¤ID ì…ë ¥</li>
              <li>
<img class="emoji" title=":point_right:" alt=":point_right:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f449.png" height="20" width="20" loading="lazy"> <strong>MyIamUserSecretAccessKey</strong> : <strong>ê´€ë¦¬ì</strong> ìˆ˜ì¤€ì˜ ê¶Œí•œì„ ê°€ì§„ IAM Userì˜ <strong>ì‹œí¬ë¦¿ í‚¤ID</strong> ì…ë ¥ <strong>â† ë…¸ì¶œë˜ì§€ ì•Šê²Œ ë³´ì•ˆ ì£¼ì˜</strong>
</li>
              <li>
<img class="emoji" title=":point_right:" alt=":point_right:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f449.png" height="20" width="20" loading="lazy"> <strong>SgIngressSshCidr</strong> : ì‘ì—…ìš© bastion ec2ì— <strong>SSH ì ‘ì† ê°€ëŠ¥í•œ IP</strong> ì…ë ¥ (<strong>ì§‘ ê³µì¸IP</strong>/32 ì…ë ¥), ë³´ì•ˆê·¸ë£¹ ì¸ë°”ìš´ë“œ ê·œì¹™ì— ë°˜ì˜ë¨</li>
              <li>MyInstanceType: ì‘ì—…ìš© bastion EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ íƒ€ì… (ê¸°ë³¸ <strong>t3.medium</strong>) â‡’ ë³€ê²½ ê°€ëŠ¥</li>
              <li>LatestAmiId : ì‘ì—…ìš© bastion EC2ì— ì‚¬ìš©í•  AMIëŠ” ì•„ë§ˆì¡´ë¦¬ëˆ…ìŠ¤2 ìµœì‹  ë²„ì „ ì‚¬ìš©</li>
            </ol>
          </li>
          <li>
<strong>EKS Config</strong>
            <ol>
              <li>
<strong>ClusterBaseName</strong> : EKS <strong>í´ëŸ¬ìŠ¤í„° ì´ë¦„</strong>ì´ë©°, <strong>myeks</strong> ê¸°ë³¸ê°’ ì‚¬ìš©ì„ ê¶Œì¥ â†’ ì´ìœ : ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ íƒœê·¸ëª…ê³¼ ì‹¤ìŠµ ì»¤ë©˜ë“œì—ì„œ ì‚¬ìš©</li>
              <li>
<strong>KubernetesVersion</strong> : EKS í˜¸í™˜, ì¿ ë²„ë„¤í‹°ìŠ¤ ë²„ì „ (ê¸°ë³¸ v1.30, ì‹¤ìŠµì€ <strong>1.30</strong> ë²„ì „ ì‚¬ìš©)</li>
              <li>
<strong>WorkerNodeInstanceType</strong>: ì›Œì»¤ ë…¸ë“œ EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ íƒ€ì… (ê¸°ë³¸ <strong>t3.medium</strong>) â‡’ ë³€ê²½ ê°€ëŠ¥</li>
              <li>
<strong>WorkerNodeCount</strong> : ì›Œì»¤ë…¸ë“œì˜ ê°¯ìˆ˜ë¥¼ ì…ë ¥ (ê¸°ë³¸ 3ëŒ€) â‡’ ë³€ê²½ ê°€ëŠ¥</li>
              <li>
<strong>WorkerNodeVolumesize</strong> : ì›Œì»¤ë…¸ë“œì˜ EBS ë³¼ë¥¨ í¬ê¸° (ê¸°ë³¸ 80GiB) â‡’ ë³€ê²½ ê°€ëŠ¥</li>
            </ol>
          </li>
          <li>
<strong>Region AZ</strong> : ë¦¬ì „ê³¼ ê°€ìš©ì˜ì—­ì„ ì§€ì •, ê¸°ë³¸ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># YAML íŒŒì¼ ë‹¤ìš´ë¡œë“œ</span>
<span class="nv">$ </span>curl <span class="nt">-O</span> https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/kans/eks-oneclick.yaml

<span class="c"># CloudFormation ìŠ¤íƒ ë°°í¬</span>
<span class="c"># aws cloudformation deploy --template-file eks-oneclick.yaml --stack-name myeks --parameter-overrides KeyName=&lt;My SSH Keyname&gt; SgIngressSshCidr=&lt;My Home Public IP Address&gt;/32 MyIamUserAccessKeyID=&lt;IAM Userì˜ ì•¡ì„¸ìŠ¤í‚¤&gt; MyIamUserSecretAccessKey=&lt;IAM Userì˜ ì‹œí¬ë¦¿ í‚¤&gt; ClusterBaseName='&lt;eks ì´ë¦„&gt;' --region ap-northeast-2</span>
<span class="c"># ì˜ˆì‹œ) aws cloudformation deploy --template-file eks-oneclick.yaml --stack-name myeks --parameter-overrides KeyName=aws-ec2 SgIngressSshCidr=$(curl -s ipinfo.io/ip)/32  MyIamUserAccessKeyID=AKIA5... MyIamUserSecretAccessKey='CVNa2...' ClusterBaseName=myeks --region ap-northeast-2</span>

<span class="c">## Tip. ì›Œì»¤ë…¸ë“œ ì¸ìŠ¤í„´ìŠ¤ íƒ€ì… ë³€ê²½ : WorkerNodeInstanceType=t3.xlarge</span>
<span class="c"># ì˜ˆì‹œ) aws cloudformation deploy --template-file eks-oneclick.yaml --stack-name myeks --parameter-overrides KeyName=aws-ec2 SgIngressSshCidr=$(curl -s ipinfo.io/ip)/32  MyIamUserAccessKeyID=AKIA5... MyIamUserSecretAccessKey='CVNa2...' ClusterBaseName=myeks --region ap-northeast-2 WorkerNodeInstanceType=t3.xlarge </span>

<span class="nv">$ </span>aws cloudformation deploy <span class="nt">--template-file</span> eks-oneclick.yaml <span class="nt">--stack-name</span> myeks <span class="se">\</span>
  <span class="nt">--parameter-overrides</span> <span class="nv">KeyName</span><span class="o">=</span>aws-ec2 <span class="se">\</span>
  <span class="nv">SgIngressSshCidr</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> ipinfo.io/ip<span class="si">)</span>/32 <span class="se">\</span>
  <span class="nv">MyIamUserAccessKeyID</span><span class="o">=</span>AKIA5... <span class="se">\</span>
  <span class="nv">MyIamUserSecretAccessKey</span><span class="o">=</span><span class="s1">'CVNa2...'</span> <span class="se">\ </span> 
  <span class="nv">ClusterBaseName</span><span class="o">=</span>myeks <span class="se">\ </span>
  <span class="nt">--region</span> ap-northeast-2
<span class="c"># =&gt; Waiting for changeset to be created..</span>
<span class="c">#    Waiting for stack create/update to complete</span>
<span class="c">#    Successfully created/updated stack - myeks</span>

<span class="c"># CloudFormation ìŠ¤íƒ ë°°í¬ ì™„ë£Œ í›„ ì‘ì—…ìš© EC2 IP ì¶œë ¥</span>
<span class="nv">$ </span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> myeks <span class="nt">--query</span> <span class="s1">'Stacks[*].Outputs[0].OutputValue'</span> <span class="nt">--output</span> text
<span class="c"># =&gt; 3.35.140.75</span>

<span class="c"># ì‘ì—…ìš© EC2 SSH ì ‘ì†</span>
<span class="nv">$ </span>ssh <span class="nt">-i</span> ~/.ssh/aws-ec2-key.cer ec2-user@<span class="si">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> myeks <span class="nt">--query</span> <span class="s1">'Stacks[*].Outputs[0].OutputValue'</span> <span class="nt">--output</span> text<span class="si">)</span>
<span class="c"># =&gt;    ,     #_</span>
<span class="c">#       ~\_  ####_        Amazon Linux 2</span>
<span class="c">#      ~~  \_#####\</span>
<span class="c">#      ~~     \###|       AL2 End of Life is 2025-06-30.</span>
<span class="c">#      ~~       \#/ ___</span>
<span class="c">#       ~~       V~' '-&amp;gt;</span>
<span class="c">#        ~~~         /    A newer version of Amazon Linux is available!</span>
<span class="c">#          ~~._.   _/</span>
<span class="c">#             _/ _/       Amazon Linux 2023, GA and supported until 2028-03-15.</span>
<span class="c">#           _/m/'           https://aws.amazon.com/linux/amazon-linux-2023/</span>
<span class="c">#    </span>
<span class="c">#    10 package(s) needed for security, out of 13 available</span>
<span class="c">#    Run &amp;quot;sudo yum update&amp;quot; to apply all updates.</span>
<span class="c">#    [root@myeks-bastion ~]#</span>
</code></pre></div></div>

<ul>
  <li>ì‘ì—…ìš© EC2ì— SSH í‚¤ íŒŒì¼ ì‚¬ìš©í•˜ì—¬ SSH ì ‘ì† í›„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ì¿ ë²„ë„¤í‹°ìŠ¤ ì •ìƒ ì„¤ì¹˜ í™•ì¸ì€ ìŠ¤íƒ ìƒì„± ì‹œì‘ í›„ 20ë¶„ í›„ ì ‘ì†í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</li>
  <li>ì ‘ì† í›„ ê¸°ë³¸ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># SSH ì ‘ì†</span>
<span class="nv">$ </span>ssh <span class="nt">-i</span> ~/.ssh/aws-ec2-key.cer ec2-user@<span class="si">$(</span>aws cloudformation describe-stacks <span class="nt">--stack-name</span> myeks <span class="nt">--query</span> <span class="s1">'Stacks[*].Outputs[0].OutputValue'</span> <span class="nt">--output</span> text<span class="si">)</span>

<span class="c"># cloud-init ì‹¤í–‰ ê³¼ì • ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-f</span> /var/log/cloud-init-output.log
<span class="c"># =&gt;  ...</span>
<span class="c">#     69  dnsmasq                  available    [ =stable ]</span>
<span class="c">#     70  unbound1.17              available    [ =stable ]</span>
<span class="c">#     72  collectd-python3         available    [ =stable ]</span>
<span class="c">#    â€  Note on end-of-support. Use 'info' subcommand.</span>
<span class="c">#    Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span>
<span class="c">#    cloudinit End!</span>
<span class="c">#    Cloud-init v. 19.3-46.amzn2.0.2 finished at Sat, 01 Nov 2024 07:27:24 +0000. Datasource DataSourceEc2.  Up 84.79 seconds</span>

<span class="c"># cloud-init ì •ìƒ ì™„ë£Œ í›„ eksctl ì‹¤í–‰ ê³¼ì • ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-f</span> /root/create-eks.log
<span class="c"># =&gt; ...</span>
<span class="c">#    2024-10-01 16:26:46 [â„¹]  deploying stack &amp;quot;eksctl-myeks-cluster&amp;quot;</span>
<span class="c">#    2024-10-01 16:27:16 [â„¹]  waiting for CloudFormation stack &amp;quot;eksctl-myeks-cluster&amp;quot;</span>
<span class="c">#    ...</span>
<span class="c">#    2024-10-01 16:40:31 [âœ”]  EKS cluster &amp;quot;myeks&amp;quot; in &amp;quot;ap-northeast-2&amp;quot; region is ready</span>

<span class="c"># default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì ìš©</span>
<span class="nv">$ </span>kubectl ns default
<span class="c"># =&gt; Context &amp;quot;anonym@myeks.ap-northeast-2.eksctl.io&amp;quot; modified.</span>
<span class="c">#    Active namespace is &amp;quot;default&amp;quot;.</span>

<span class="c"># ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://CF0FD5E1EEB937DD6FF881B7EBADDFD4.yl4.ap-northeast-2.eks.amazonaws.com</span>
<span class="c">#    CoreDNS is running at https://CF0FD5E1EEB937DD6FF881B7EBADDFD4.yl4.ap-northeast-2.eks.amazonaws.com/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="nv">$ </span>eksctl get cluster
<span class="c"># =&gt; NAME REGION    EKSCTL CREATED</span>
<span class="c">#    myeks  ap-northeast-2  True</span>
<span class="nv">$ </span>eksctl get nodegroup <span class="nt">--cluster</span> <span class="nv">$CLUSTER_NAME</span>
<span class="c"># =&gt; CLUSTER  NODEGROUP STATUS  CREATED               MIN SIZE  MAX SIZE  DESIRED CAPACITY  INSTANCE TYPE  IMAGE ID    ASG NAME                                      TYPE</span>
<span class="c">#    myeks    ng1       ACTIVE  2024-10-01T07:37:58Z  3         3         3                 t3.medium      AL2_x86_64  eks-ng1-4ec975e7-9584-1403-37c4-fc55cc2ec860  managed</span>

<span class="c"># í™˜ê²½ë³€ìˆ˜ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">export</span> | egrep <span class="s1">'ACCOUNT|AWS_|CLUSTER|KUBERNETES|VPC|Subnet'</span>
<span class="nv">$ </span><span class="nb">export</span> | egrep <span class="s1">'ACCOUNT|AWS_|CLUSTER|KUBERNETES|VPC|Subnet'</span> | egrep <span class="nt">-v</span> <span class="s1">'SECRET|KEY'</span>
<span class="c"># =&gt; declare -x ACCOUNT_ID=&amp;quot;123456789012&amp;quot;</span>
<span class="c">#    declare -x AWS_DEFAULT_REGION=&amp;quot;ap-northeast-2&amp;quot;</span>
<span class="c">#    declare -x AWS_PAGER=&amp;quot;&amp;quot;</span>
<span class="c">#    declare -x AWS_REGION=&amp;quot;ap-northeast-2&amp;quot;</span>
<span class="c">#    declare -x CLUSTER_NAME=&amp;quot;myeks&amp;quot;</span>
<span class="c">#    declare -x KUBERNETES_VERSION=&amp;quot;1.30&amp;quot;</span>
<span class="c">#    declare -x PrivateSubnet1=&amp;quot;subnet-02550e25cd3a9d814&amp;quot;</span>
<span class="c">#    declare -x PrivateSubnet2=&amp;quot;subnet-0c2adfcc3d586e58d&amp;quot;</span>
<span class="c">#    declare -x PrivateSubnet3=&amp;quot;subnet-04dd8e21b159de4cb&amp;quot;</span>
<span class="c">#    declare -x PubSubnet1=&amp;quot;subnet-0a06ed52d587bd707&amp;quot;</span>
<span class="c">#    declare -x PubSubnet2=&amp;quot;subnet-00b4dacf7eef35d33&amp;quot;</span>
<span class="c">#    declare -x PubSubnet3=&amp;quot;subnet-03c911c48452b41b2&amp;quot;</span>
<span class="c">#    declare -x VPCID=&amp;quot;vpc-0837921f515624150&amp;quot;</span>

<span class="c"># ì¸ì¦ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">cat</span> /root/.kube/config
<span class="nv">$ </span>kubectl config view
<span class="nv">$ </span>kubectl ctx
<span class="c"># =&gt; anonym@myeks.ap-northeast-2.eksctl.io</span>

<span class="c"># ë…¸ë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get node <span class="nt">--label-columns</span><span class="o">=</span>node.kubernetes.io/instance-type,eks.amazonaws.com/capacityType,topology.kubernetes.io/zone
<span class="c"># =&gt; NAME                                               STATUS   ROLES    AGE     VERSION               INSTANCE-TYPE   CAPACITYTYPE   ZONE</span>
<span class="c">#    ip-192-168-1-186.ap-northeast-2.compute.internal   Ready    &amp;lt;none&amp;gt;   7m26s   v1.30.4-eks-a737599   t3.medium       ON_DEMAND      ap-northeast-2a</span>
<span class="c">#    ip-192-168-2-92.ap-northeast-2.compute.internal    Ready    &amp;lt;none&amp;gt;   7m22s   v1.30.4-eks-a737599   t3.medium       ON_DEMAND      ap-northeast-2b</span>
<span class="c">#    ip-192-168-3-235.ap-northeast-2.compute.internal   Ready    &amp;lt;none&amp;gt;   7m22s   v1.30.4-eks-a737599   t3.medium       ON_DEMAND      ap-northeast-2c</span>
<span class="nv">$ </span>eksctl get iamidentitymapping <span class="nt">--cluster</span> myeks
<span class="c"># =&gt; ARN                      USERNAME        GROUPS          ACCOUNT</span>
<span class="c">#    arn:aws:iam::123456789012:role/eksctl-myeks-nodegroup-ng1-NodeInstanceRole-kPdCWLD1sAsU  system:node: system:bootstrappers,system:nodes</span>

<span class="c"># krew í”ŒëŸ¬ê·¸ì¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl krew list
<span class="c"># =&gt; PLUGIN   VERSION</span>
<span class="c">#    ctx      v0.9.5</span>
<span class="c">#    get-all  v1.3.8</span>
<span class="c">#    krew     v0.4.4</span>
<span class="c">#    neat     v2.0.4</span>
<span class="c">#    ns       v0.9.5</span>
<span class="c">#    stern    v1.31.0</span>

<span class="c"># ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ëª¨ë“  ë¦¬ì†ŒìŠ¤ í™•ì¸</span>
<span class="nv">$ </span>kubectl get-all
</code></pre></div></div>

<ul>
  <li>ë…¸ë“œ ì ‘ì† í™•ì¸ ë° SSH ì ‘ì†</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë…¸ë“œ IP í™•ì¸ ë° PrivateIP ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ </span>aws ec2 describe-instances <span class="nt">--query</span> <span class="s2">"Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key=='Name']|[0].Value,Status:State.Name}"</span> <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>instance-state-name,Values<span class="o">=</span>running <span class="nt">--output</span> table
<span class="c"># =&gt; ------------------------------------------------------------------</span>
<span class="c">#    |                        DescribeInstances                       |</span>
<span class="c">#    +----------------+-----------------+------------------+----------+</span>
<span class="c">#    |  InstanceName  |  PrivateIPAdd   |   PublicIPAdd    | Status   |</span>
<span class="c">#    +----------------+-----------------+------------------+----------+</span>
<span class="c">#    |  myeks-ng1-Node|  192.168.2.92   |  43.203.143.233  |  running |</span>
<span class="c">#    |  myeks-ng1-Node|  192.168.3.235  |  15.164.95.12    |  running |</span>
<span class="c">#    |  myeks-bastion |  192.168.1.100  |  3.35.140.75     |  running |</span>
<span class="c">#    |  myeks-ng1-Node|  192.168.1.186  |  3.38.183.82     |  running |</span>
<span class="c">#    +----------------+-----------------+------------------+----------+</span>
<span class="nv">$ N1</span><span class="o">=</span><span class="si">$(</span>kubectl get node <span class="nt">--label-columns</span><span class="o">=</span>topology.kubernetes.io/zone <span class="nt">--selector</span><span class="o">=</span>topology.kubernetes.io/zone<span class="o">=</span>ap-northeast-2a <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[0].status.addresses[0].address<span class="o">}</span><span class="si">)</span>
<span class="nv">$ N2</span><span class="o">=</span><span class="si">$(</span>kubectl get node <span class="nt">--label-columns</span><span class="o">=</span>topology.kubernetes.io/zone <span class="nt">--selector</span><span class="o">=</span>topology.kubernetes.io/zone<span class="o">=</span>ap-northeast-2b <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[0].status.addresses[0].address<span class="o">}</span><span class="si">)</span>
<span class="nv">$ N3</span><span class="o">=</span><span class="si">$(</span>kubectl get node <span class="nt">--label-columns</span><span class="o">=</span>topology.kubernetes.io/zone <span class="nt">--selector</span><span class="o">=</span>topology.kubernetes.io/zone<span class="o">=</span>ap-northeast-2c <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[0].status.addresses[0].address<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export N1=</span><span class="nv">$N1</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export N2=</span><span class="nv">$N2</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export N3=</span><span class="nv">$N3</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$N1</span>, <span class="nv">$N2</span>, <span class="nv">$N3</span>
<span class="c"># =&gt; 192.168.1.186, 192.168.2.92, 192.168.3.235</span>

<span class="c"># ë³´ì•ˆê·¸ë£¹ IDì™€ ë³´ì•ˆê·¸ë£¹ ì´ë¦„(Nameì•„ë‹˜ì„ ì£¼ì˜!) í™•ì¸</span>
<span class="nv">$ </span>aws ec2 describe-security-groups <span class="nt">--query</span> <span class="s1">'SecurityGroups[*].[GroupId, GroupName]'</span> <span class="nt">--output</span> text
<span class="c"># =&gt; sg-07b8900660cb85dff default</span>
<span class="c">#    sg-0ece66fedd1fb4abe myeks-EKSEC2SG-1GNaTdbIbBNG</span>
<span class="c">#    sg-07663468a536ba88b eksctl-myeks-cluster-ControlPlaneSecurityGroup-S7dWa32uw1S7</span>
<span class="c">#    sg-0edc706b941f0aef7 eksctl-myeks-cluster-ClusterSharedNodeSecurityGroup-sO3DEJP4xewT</span>
<span class="c">#    sg-02c614a038ec1f7e7 eks-cluster-sg-myeks-104368993</span>
<span class="c">#    sg-036e220bf3d8aaf20 eksctl-myeks-nodegroup-ng1-remoteAccess</span>
<span class="c">#    sg-035e2b98b5ac89231 default</span>

<span class="c"># ë…¸ë“œ ë³´ì•ˆê·¸ë£¹ ID í™•ì¸</span>
<span class="nv">$ </span>aws ec2 describe-security-groups <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>group-name,Values<span class="o">=</span><span class="k">*</span>ng1<span class="k">*</span> <span class="nt">--query</span> <span class="s2">"SecurityGroups[*].[GroupId]"</span> <span class="nt">--output</span> text
<span class="c"># =&gt; sg-036e220bf3d8aaf20</span>
<span class="nv">$ NGSGID</span><span class="o">=</span><span class="si">$(</span>aws ec2 describe-security-groups <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>group-name,Values<span class="o">=</span><span class="k">*</span>ng1<span class="k">*</span> <span class="nt">--query</span> <span class="s2">"SecurityGroups[*].[GroupId]"</span> <span class="nt">--output</span> text<span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$NGSGID</span>
<span class="c"># =&gt; sg-036e220bf3d8aaf20</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export NGSGID=</span><span class="nv">$NGSGID</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/profile

<span class="c"># ë…¸ë“œ ë³´ì•ˆê·¸ë£¹ì— eksctl-host ì—ì„œ ë…¸ë“œ(íŒŒë“œ)ì— ì ‘ì† ê°€ëŠ¥í•˜ê²Œ ë£°(Rule) ì¶”ê°€ ì„¤ì •</span>
<span class="nv">$ </span>aws ec2 authorize-security-group-ingress <span class="nt">--group-id</span> <span class="nv">$NGSGID</span> <span class="nt">--protocol</span> <span class="s1">'-1'</span> <span class="nt">--cidr</span> 192.168.1.100/32

<span class="c"># eksctl-host ì—ì„œ ë…¸ë“œì˜IPë‚˜ coredns íŒŒë“œIPë¡œ ping í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 <span class="nv">$N1</span>
<span class="c"># =&gt; PING 192.168.1.186 (192.168.1.186) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.1.186: icmp_seq=1 ttl=255 time=0.492 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.1.186 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.492/0.492/0.492/0.000 ms</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 <span class="nv">$N2</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 <span class="nv">$N3</span>

<span class="c"># ì›Œì»¤ ë…¸ë“œ SSH ì ‘ì† : '-i ~/.ssh/id_rsa' ìƒëµ ê°€ëŠ¥</span>
<span class="nv">$ </span><span class="k">for </span>node <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span>ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no ec2-user@<span class="nv">$node</span> <span class="nb">hostname</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N1</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N2</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N3</span>
<span class="nv">$ </span><span class="nb">exit</span>
</code></pre></div></div>

<ul>
  <li>Add-on ì •ë³´í™•ì¸ : ìµœì‹  ë²„ì „ - kube-proxy, coredns, aws vpc cni - ë§í¬ mgmt</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë“  íŒŒë“œì˜ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pods <span class="nt">--all-namespaces</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].spec.containers[*].image}"</span> | <span class="nb">tr</span> <span class="nt">-s</span> <span class="s1">'[[:space:]]'</span> <span class="s1">'\n'</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span>
<span class="c"># =&gt;       3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-network-policy-agent:v1.1.4-eksbuild.1</span>
<span class="c">#          3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon-k8s-cni:v1.18.6-eksbuild.1</span>
<span class="c">#          2 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/eks/coredns:v1.11.3-eksbuild.2</span>
<span class="c">#          3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/eks/kube-proxy:v1.30.5-minimal-eksbuild.2</span>
<span class="c"># ìœ„ ë²„ì „ì€ Add-on ìœ¼ë¡œ ìµœì‹  ë²„ì „ ì„¤ì¹˜</span>
<span class="nv">$ </span>kubectl get pods <span class="nt">-A</span>
<span class="nv">$ </span>kubectl get pods <span class="nt">--all-namespaces</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[*].spec.containers[*].image}"</span> | <span class="nb">tr</span> <span class="nt">-s</span> <span class="s1">'[[:space:]]'</span> <span class="s1">'\n'</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span>
<span class="c"># =&gt;       3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-network-policy-agent:v1.1.4-eksbuild.1</span>
<span class="c">#          3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon-k8s-cni:v1.18.6-eksbuild.1</span>
<span class="c">#          2 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/eks/coredns:v1.11.3-eksbuild.2</span>
<span class="c">#          3 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/eks/kube-proxy:v1.30.5-minimal-eksbuild.2</span>

<span class="c"># eksctl ì„¤ì¹˜/ì—…ë°ì´íŠ¸ addon í™•ì¸</span>
<span class="nv">$ </span>eksctl get addon <span class="nt">--cluster</span> <span class="nv">$CLUSTER_NAME</span>
<span class="c"># =&gt; NAME        VERSION             STATUS  ISSUES      IAMROLE                                                                       UPDATE                AVAILABLE  CONFIGURATION  VALUES  POD      IDENTITY  ASSOCIATION  ROLES</span>
<span class="c">#    coredns     v1.11.3-eksbuild.2  ACTIVE  0</span>
<span class="c">#    kube-proxy  v1.30.5-eksbuild.2  ACTIVE  0</span>
<span class="c">#    vpc-cni     v1.18.6-eksbuild.1  ACTIVE  0           arn:aws:iam::123456789012:role/eksctl-myeks-addon-vpc-cni-Role1-QUy8qUBqFjcx  enableNetworkPolicy:  &amp;quot;true&amp;quot;</span>

<span class="c"># (ì°¸ê³ ) eks ì„¤ì¹˜ yaml ì¤‘ addon ë‚´ìš©</span>
<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-n11</span> myeks.yaml
<span class="c"># =&gt; addons:</span>
<span class="c">#      - name: vpc-cni # no version is specified so it deploys the default version</span>
<span class="c">#        version: latest # auto discovers the latest available</span>
<span class="c">#        attachPolicyARNs:</span>
<span class="c">#          - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy</span>
<span class="c">#        configurationValues: |-</span>
<span class="c">#          enableNetworkPolicy: &amp;quot;true&amp;quot;</span>
<span class="c">#      - name: kube-proxy</span>
<span class="c">#        version: latest</span>
<span class="c">#      - name: coredns</span>
<span class="c">#        version: latest</span>
</code></pre></div></div>

<hr>

<h3 id="ë…¸ë“œì—ì„œ-ê¸°ë³¸-ë„¤íŠ¸ì›Œí¬-ì •ë³´-í™•ì¸">ë…¸ë“œì—ì„œ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</h3>

<h4 id="ì›Œì»¤-ë…¸ë“œ-ê¸°ë³¸-ë„¤íŠ¸ì›Œí¬-êµ¬ì„±">ì›Œì»¤ ë…¸ë“œ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ êµ¬ì„±</h4>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_5.png" alt="img.png" class="image-center w-60" loading="lazy" width="757" height="787"></p>

<ul>
  <li>ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” í˜¸ìŠ¤íŠ¸(Root)ì™€ íŒŒë“œë³„(Per Pod)ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤.</li>
  <li>íŠ¹ì •í•œ íŒŒë“œ (kube-proxy, aws-node)ëŠ” í˜¸ìŠ¤íŠ¸ì˜ IPë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. =&gt; íŒŒë“œì˜ Host Network ì˜µì…˜ - <a href="https://xn--vj5b11biyw.kr/306">ì°¸ê³ </a>
</li>
  <li>t3.medium ì˜ ê²½ìš° ENI ë§ˆë‹¤ ìµœëŒ€ 6ê°œì˜ IPë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ENI ë‹¹ 5ê°œì˜ ë³´ì¡° IP)</li>
  <li>ENI0, ENI1 ìœ¼ë¡œ 2ê°œì˜ ENIëŠ” ìì‹ ì˜ IP ì´ì™¸ì— ì¶”ê°€ì ìœ¼ë¡œ 5ê°œì˜ ë³´ì¡° í”„ë¼ì´ë¹— IPë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>coredns íŒŒë“œëŠ” vethìœ¼ë¡œ í˜¸ìŠ¤íŠ¸ì—ëŠ” eniY@ifN ì¸í„°í˜ì´ìŠ¤ì™€ íŒŒë“œì— eth0ê³¼ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<h4 id="ì‹¤ìŠµ-ë³´ì¡°-ipv4-ì£¼ì†Œë¥¼-íŒŒë“œê°€-ì‚¬ìš©í•˜ëŠ”ì§€-í™•ì¸">[ì‹¤ìŠµ] ë³´ì¡° IPv4 ì£¼ì†Œë¥¼ íŒŒë“œê°€ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># coredns íŒŒë“œ IP ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                       READY   STATUS    RESTARTS   AGE   IP             NODE                                               NOMINATED NODE   READINESS GATES</span>
<span class="c">#    coredns-699d8c5988-bvxtz   1/1     Running   0          18m   192.168.1.30   ip-192-168-1-186.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    coredns-699d8c5988-vt68k   1/1     Running   0          18m   192.168.3.82   ip-192-168-3-235.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># ë…¸ë“œì˜ ë¼ìš°íŒ… ì •ë³´ í™•ì¸ &gt;&gt; EC2 ë„¤íŠ¸ì›Œí¬ ì •ë³´ì˜ 'ë³´ì¡° í”„ë¼ì´ë¹— IPv4 ì£¼ì†Œ'ì™€ ë¹„êµí•´ë³´ì</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-c</span> route<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.1.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.186</span>
<span class="c">#    192.168.1.30 dev eni319ad74733c scope link</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.2.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.2.0/24 dev eth0 proto kernel scope link src 192.168.2.92</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.3.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.3.0/24 dev eth0 proto kernel scope link src 192.168.3.235</span>
<span class="c">#    192.168.3.82 dev enid438418b082 scope link</span>

<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ë…¸ë“œì˜ IPì™€ íŒŒë“œì˜ IPê°€ ê°™ì€ ëŒ€ì—­ì„ì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    ì˜ˆë¥¼ ë“¤ì–´ì„œ ë…¸ë“œ IPê°€ 192.168.1.186ì¸ ê²½ìš° íŒŒë“œëŠ” 192.168.1.30ìœ¼ë¡œ&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    ë™ì¼í•œ IP ëŒ€ì—­ìœ¼ë¡œ, ë³´ì¡° IPv4ê°€ ì‚¬ìš©ë¨ì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div></div>

<h4 id="ì‹¤ìŠµ-í…ŒìŠ¤íŠ¸ìš©-íŒŒë“œ-ìƒì„±---nicolakanetshoot">[ì‹¤ìŠµ] í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ ìƒì„± - <a href="https://github.com/nicolaka/netshoot">nicolaka/netshoot</a>
</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [í„°ë¯¸ë„1~3] ë…¸ë“œ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N1</span>
<span class="c"># =&gt; [ec2-user@ip-192-168-1-186 ~]$</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"ip link | egrep 'eth|eni' ;echo;echo "</span><span class="o">[</span>ROUTE TABLE]<span class="s2">"; route -n | grep eni"</span>
<span class="c"># =&gt; 2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc</span>
<span class="c">#     mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 02:35:26:fe:f6:2f brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    3: eni319ad74733c@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    mtu 9001 qdisc noqueue state UP mode DEFAULT group defaul</span>
<span class="c">#    t</span>
<span class="c">#        link/ether 16:69:60:63:cf:f7 brd ff:ff:ff:ff:ff:ff li</span>
<span class="c">#    nk-netns cni-a953612e-ef39-78ca-660c-2a1ecde16b39</span>
<span class="c">#    4: eth1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc</span>
<span class="c">#     mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 02:86:42:43:71:d1 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    </span>
<span class="c">#    [ROUTE TABLE]</span>
<span class="c">#    192.168.1.30    0.0.0.0         255.255.255.255 UH    0</span>
<span class="c">#        0        0 eni319ad74733c</span>

<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N2</span>
<span class="c"># =&gt; [ec2-user@ip-192-168-2-92 ~]$</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"ip link | egrep 'eth|eni' ;echo;echo "</span><span class="o">[</span>ROUTE TABLE]<span class="s2">"; route -n | grep eni"</span>
<span class="c"># =&gt; 2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc</span>
<span class="c">#     mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 06:bc:36:ed:7c:d3 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    </span>
<span class="c">#    [ROUTE TABLE]</span>

<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N3</span>
<span class="c"># =&gt; [ec2-user@ip-192-168-3-235 ~]$</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"ip link | egrep 'eth|eni' ;echo;echo "</span><span class="o">[</span>ROUTE TABLE]<span class="s2">"; route -n | grep eni"</span>
<span class="c"># =&gt; 2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc</span>
<span class="c">#     mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 0a:3e:a1:00:00:05 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    3: enid438418b082@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt;</span>
<span class="c">#    mtu 9001 qdisc noqueue state UP mode DEFAULT group defaul</span>
<span class="c">#    t</span>
<span class="c">#        link/ether 02:50:3a:92:0e:1b brd ff:ff:ff:ff:ff:ff li</span>
<span class="c">#    nk-netns cni-23569158-d846-4981-4105-ec08005e9b95</span>
<span class="c">#    4: eth1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc</span>
<span class="c">#     mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 0a:e8:ac:41:8c:ab brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    </span>
<span class="c">#    [ROUTE TABLE]</span>
<span class="c">#    192.168.3.82    0.0.0.0         255.255.255.255 UH    0</span>
<span class="c">#        0        0 enid438418b082</span>

<span class="c"># í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ netshoot-pod ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netshoot-pod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: netshoot-pod
  template:
    metadata:
      labels:
        app: netshoot-pod
    spec:
      containers:
      - name: netshoot-pod
        image: nicolaka/netshoot
        command: ["tail"]
        args: ["-f", "/dev/null"]
      terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/netshoot-pod created</span>

<span class="c"># íŒŒë“œ ì´ë¦„ ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ PODNAME1</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[0].metadata.name<span class="o">}</span><span class="si">)</span>
<span class="nv">$ PODNAME2</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[1].metadata.name<span class="o">}</span><span class="si">)</span>
<span class="nv">$ PODNAME3</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[2].metadata.name<span class="o">}</span><span class="si">)</span>

<span class="c"># íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                            READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES</span>
<span class="c">#    netshoot-pod-74b7555dc7-6qsvf   1/1     Running   0          29s   192.168.1.112   ip-192-168-1-186.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    netshoot-pod-74b7555dc7-x6lxb   1/1     Running   0          29s   192.168.2.172   ip-192-168-2-92.ap-northeast-2.compute.internal    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    netshoot-pod-74b7555dc7-x7r96   1/1     Running   0          29s   192.168.3.246   ip-192-168-3-235.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span><span class="o">=</span>custom-columns<span class="o">=</span>NAME:.metadata.name,IP:.status.podIP
<span class="c"># =&gt; NAME                            IP</span>
<span class="c">#    netshoot-pod-74b7555dc7-6qsvf   192.168.1.112</span>
<span class="c">#    netshoot-pod-74b7555dc7-x6lxb   192.168.2.172</span>
<span class="c">#    netshoot-pod-74b7555dc7-x7r96   192.168.3.246</span>

<span class="c"># ë…¸ë“œì— ë¼ìš°íŒ… ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-c</span> route<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.1.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.186</span>
<span class="c">#    192.168.1.30 dev eni319ad74733c scope link</span>
<span class="c">#    192.168.1.112 dev eni7ecb7efa346 scope link  # &lt;span style="color: green;"&gt;ğŸ‘‰ ì¶”ê°€ëœ ì‹ ê·œ íŒŒë“œì˜ IPv4 ë³´ì¡° IP&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.2.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.2.0/24 dev eth0 proto kernel scope link src 192.168.2.92</span>
<span class="c">#    192.168.2.172 dev enif06a5cbfaaa scope link  # &lt;span style="color: green;"&gt;ğŸ‘‰ ì¶”ê°€ëœ ì‹ ê·œ íŒŒë“œì˜ IPv4 ë³´ì¡° IP&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    default via 192.168.3.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.3.0/24 dev eth0 proto kernel scope link src 192.168.3.235</span>
<span class="c">#    192.168.3.82 dev enid438418b082 scope link</span>
<span class="c">#    192.168.3.246 dev eniea7f0ec96dd scope link  # &lt;span style="color: green;"&gt;ğŸ‘‰ ì¶”ê°€ëœ ì‹ ê·œ íŒŒë“œì˜ IPv4 ë³´ì¡° IP&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>íŒŒë“œê°€ ìƒì„±ë˜ë©´, ì›Œì»¤ ë…¸ë“œì— eniY@ifN ì¶”ê°€ë˜ê³  ë¼ìš°íŒ… í…Œì´ë¸”ì—ë„ ì •ë³´ê°€ ì¶”ê°€ëœê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ eniY ì •ë³´ í™•ì¸ - ì›Œì»¤ ë…¸ë“œ EC2</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë…¸ë“œ3ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>ssh ec2-user@<span class="nv">$N3</span>
<span class="nt">----------------</span>
<span class="nv">$ </span>ip <span class="nt">-br</span> <span class="nt">-c</span> addr show
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8 ::1/128</span>
<span class="c">#    eth0             UP             192.168.3.235/24 fe80::83e:a1ff:fe00:5/64</span>
<span class="c">#    enid438418b082@if3 UP             fe80::50:3aff:fe92:e1b/64</span>
<span class="c">#    eth1             UP             192.168.3.236/24 fe80::8e8:acff:fe41:8cab/64</span>
<span class="c">#    eniea7f0ec96dd@if3 UP             fe80::8cd8:57ff:fee7:29c/64</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nb">link</span>
<span class="c"># =&gt; 1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
<span class="c">#    2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 0a:3e:a1:00:00:05 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    3: enid438418b082@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP mode DEFAULT group default</span>
<span class="c">#        link/ether 02:50:3a:92:0e:1b brd ff:ff:ff:ff:ff:ff link-netns cni-23569158-d846-4981-4105-ec08005e9b95</span>
<span class="c">#    4: eth1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc mq state UP mode DEFAULT group default qlen 1000</span>
<span class="c">#        link/ether 0a:e8:ac:41:8c:ab brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#    5: eniea7f0ec96dd@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP mode DEFAULT group default</span>
<span class="c">#        link/ether 8e:d8:57:e7:02:9c brd ff:ff:ff:ff:ff:ff link-netns cni-508d7216-7484-4497-a023-c6236435d535</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc mq state UP group default qlen 1000</span>
<span class="c">#        link/ether 0a:3e:a1:00:00:05 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 192.168.3.235/24 brd 192.168.3.255 scope global dynamic eth0</span>
<span class="c">#           valid_lft 2166sec preferred_lft 2166sec</span>
<span class="c">#        inet6 fe80::83e:a1ff:fe00:5/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    3: enid438418b082@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP group default</span>
<span class="c">#        link/ether 02:50:3a:92:0e:1b brd ff:ff:ff:ff:ff:ff link-netns cni-23569158-d846-4981-4105-ec08005e9b95</span>
<span class="c">#        inet6 fe80::50:3aff:fe92:e1b/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    4: eth1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc mq state UP group default qlen 1000</span>
<span class="c">#        link/ether 0a:e8:ac:41:8c:ab brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet 192.168.3.236/24 brd 192.168.3.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::8e8:acff:fe41:8cab/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    5: eniea7f0ec96dd@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP group default</span>
<span class="c">#        link/ether 8e:d8:57:e7:02:9c brd ff:ff:ff:ff:ff:ff link-netns cni-508d7216-7484-4497-a023-c6236435d535</span>
<span class="c">#        inet6 fe80::8cd8:57ff:fee7:29c/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>ip route <span class="c"># í˜¹ì€ route -n</span>
<span class="c"># =&gt; default via 192.168.3.1 dev eth0</span>
<span class="c">#    169.254.169.254 dev eth0</span>
<span class="c">#    192.168.3.0/24 dev eth0 proto kernel scope link src 192.168.3.235</span>
<span class="c">#    192.168.3.82 dev enid438418b082 scope link</span>
<span class="c">#    192.168.3.246 dev eniea7f0ec96dd scope link</span>
  
<span class="c"># ë§ˆì§€ë§‰ ìƒì„±ëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì •ë³´ ì¶œë ¥ -t net(ë„¤íŠ¸ì›Œí¬ íƒ€ì…)</span>
<span class="nv">$ </span><span class="nb">sudo </span>lsns <span class="nt">-o</span> PID,COMMAND <span class="nt">-t</span> net | <span class="nb">awk</span> <span class="s1">'NR&gt;2 {print $1}'</span> | <span class="nb">tail</span> <span class="nt">-n</span> 1
<span class="c"># =&gt; 9774</span>
  
<span class="c"># ë§ˆì§€ë§‰ ìƒì„±ëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ net PID ì •ë³´ ì¶œë ¥ -t net(ë„¤íŠ¸ì›Œí¬ íƒ€ì…)ë¥¼ ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ MyPID</span><span class="o">=</span><span class="si">$(</span><span class="nb">sudo </span>lsns <span class="nt">-o</span> PID,COMMAND <span class="nt">-t</span> net | <span class="nb">awk</span> <span class="s1">'NR&gt;2 {print $1}'</span> | <span class="nb">tail</span> <span class="nt">-n</span> 1<span class="si">)</span>
  
<span class="c"># PID ì •ë³´ë¡œ íŒŒë“œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> <span class="nv">$MyPID</span> <span class="nt">-n</span> ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    3: eth0@if5: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP group default</span>
<span class="c">#        link/ether 6a:d5:4d:a7:45:7e brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
<span class="c">#        inet 192.168.3.246/32 scope global eth0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::68d5:4dff:fea7:457e/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> <span class="nv">$MyPID</span> <span class="nt">-n</span> ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 169.254.1.1 dev eth0</span>
<span class="c">#    169.254.1.1 dev eth0 scope link</span>
  
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------</span>
</code></pre></div></div>

<ul>
  <li>í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ ì ‘ì†(exec) í›„ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ ì ‘ì†(exec) í›„ Shell ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> zsh
<span class="c"># =&gt;  netshoot-pod-74b7555dc7-6qsvf î‚° ~ î‚°</span>
  
<span class="c"># ì•„ë˜ë¶€í„°ëŠ” pod-1 Shell ì—ì„œ ì‹¤í–‰ : ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</span>
<span class="nt">----------------------------</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    3: eth0@if5: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP group default</span>
<span class="c">#        link/ether c6:cb:41:a0:85:57 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
<span class="c">#        inet 192.168.1.112/32 scope global eth0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::c4cb:41ff:fea0:8557/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 169.254.1.1 dev eth0</span>
<span class="c">#    169.254.1.1 dev eth0 scope link</span>
<span class="nv">$ </span>route <span class="nt">-n</span>
<span class="c"># =&gt; Kernel IP routing table</span>
<span class="c">#    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span>
<span class="c">#    0.0.0.0         169.254.1.1     0.0.0.0         UG    0      0        0 eth0</span>
<span class="c">#    169.254.1.1     0.0.0.0         255.255.255.255 UH    0      0        0 eth0</span>
<span class="c">#$ ping -c 1 &lt;pod-2 IP&gt;</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 192.168.2.172
<span class="c"># =&gt; PING 192.168.2.172 (192.168.2.172) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.2.172: icmp_seq=1 ttl=125 time=1.25 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.2.172 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.249/1.249/1.249/0.000 ms</span>
<span class="nv">$ </span>ps
<span class="c"># =&gt; PID   USER     TIME  COMMAND</span>
<span class="c">#        1 root      0:00 tail -f /dev/null</span>
<span class="c">#      109 root      0:00 zsh</span>
<span class="c">#      186 root      0:00 ps</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/resolv.conf
<span class="c"># =&gt; search default.svc.cluster.local svc.cluster.local cluster.local ap-northeast-2.compute.internal</span>
<span class="c">#    nameserver 10.100.0.10</span>
<span class="c">#    options ndots:5</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">----------------------------</span>
  
<span class="c"># íŒŒë“œ2 Shell ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME2</span> <span class="nt">--</span> ip <span class="nt">-c</span> addr
<span class="c"># =&gt; ...</span>
<span class="c">#    3: eth0@if3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 9001 qdisc noqueue state UP group default</span>
<span class="c">#        link/ether 02:ea:11:63:f6:9f brd ff:ff:ff:ff:ff:ff link-netnsid 0</span>
<span class="c">#        inet 192.168.2.172/32 scope global eth0</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#        inet6 fe80::ea:11ff:fe63:f69f/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
  
<span class="c"># íŒŒë“œ3 Shell ì‹¤í–‰</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME3</span> <span class="nt">--</span> ip <span class="nt">-br</span> <span class="nt">-c</span> addr
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8 ::1/128</span>
<span class="c">#    eth0@if5         UP             192.168.3.246/32 fe80::68d5:4dff:fea7:457e/64</span>
</code></pre></div></div>

<hr>

<h3 id="ë…¸ë“œê°„-íŒŒë“œ-í†µì‹ ">ë…¸ë“œê°„ íŒŒë“œ í†µì‹ </h3>

<ul>
  <li>
<strong>íŒŒë“œê°„ í†µì‹  íë¦„</strong> : AWS VPC CNIì˜ ê²½ìš° ë³„ë„ì˜ ì˜¤ë²„ë ˆì´(Overlay) í†µì‹  ê¸°ìˆ ì—†ì´, VPCì—ì„œ Nativeí•˜ê²Œ íŒŒë“œê°„ ì§ì ‘ í†µì‹ ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_6.png" alt="img.png" class="image-center" loading="lazy" width="1576" height="648"></p>

<ul>
  <li>íŒŒë“œê°„ í†µì‹  ê³¼ì • ì°¸ê³ </li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_7.png" alt="img.png" class="image-center" loading="lazy" width="1810" height="395">
<em class="image-caption"><a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md">https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md</a></em></p>

<h4 id="ì‹¤ìŠµ-íŒŒë“œê°„-í†µì‹ -í…ŒìŠ¤íŠ¸-ë°-í™•ì¸--ë³„ë„ì˜-nat-ë™ì‘-ì—†ì´-í†µì‹ -ê°€ëŠ¥">[ì‹¤ìŠµ] íŒŒë“œê°„ í†µì‹  í…ŒìŠ¤íŠ¸ ë° í™•ì¸ : ë³„ë„ì˜ NAT ë™ì‘ ì—†ì´ í†µì‹  ê°€ëŠ¥!</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># íŒŒë“œ IP ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ PODIP1</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[0].status.podIP<span class="o">}</span><span class="si">)</span>
<span class="nv">$ PODIP2</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[1].status.podIP<span class="o">}</span><span class="si">)</span>
<span class="nv">$ PODIP3</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-pod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.items[2].status.podIP<span class="o">}</span><span class="si">)</span>

<span class="c"># íŒŒë“œ1 Shell ì—ì„œ íŒŒë“œ2ë¡œ ping í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nv">$PODIP2</span>
<span class="c"># =&gt; PING 192.168.2.172 (192.168.2.172) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.2.172: icmp_seq=1 ttl=125 time=0.915 ms</span>
<span class="c">#    64 bytes from 192.168.2.172: icmp_seq=2 ttl=125 time=0.870 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.2.172 ping statistics ---</span>
<span class="c">#    2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.870/0.892/0.915/0.022 ms</span>

<span class="c"># íŒŒë“œ2 Shell ì—ì„œ íŒŒë“œ3ë¡œ ping í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME2</span> <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nv">$PODIP3</span>
<span class="c"># =&gt; PING 192.168.3.246 (192.168.3.246) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.3.246: icmp_seq=1 ttl=125 time=1.79 ms</span>
<span class="c">#    64 bytes from 192.168.3.246: icmp_seq=2 ttl=125 time=1.25 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.3.246 ping statistics ---</span>
<span class="c">#    2 packets transmitted, 2 received, 0% packet loss, time 1002ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.245/1.516/1.788/0.271 ms</span>

<span class="c"># íŒŒë“œ3 Shell ì—ì„œ íŒŒë“œ1ë¡œ ping í…ŒìŠ¤íŠ¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME3</span> <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nv">$PODIP1</span>
<span class="c"># =&gt; PING 192.168.1.112 (192.168.1.112) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.1.112: icmp_seq=1 ttl=125 time=1.08 ms</span>
<span class="c">#    64 bytes from 192.168.1.112: icmp_seq=2 ttl=125 time=1.23 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.1.112 ping statistics ---</span>
<span class="c">#    2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.084/1.155/1.227/0.071 ms</span>

<span class="c"># ì›Œì»¤ ë…¸ë“œ EC2 : TCPDUMP í™•ì¸</span>
<span class="c">## For Pod to external (outside VPC) traffic, we will program iptables to SNAT using Primary IP address on the Primary ENI.</span>
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> any <span class="nt">-nn</span> icmp
<span class="c"># =&gt; 08:11:33.865634 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 1, length 64</span>
<span class="c">#    08:11:33.865684 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 1, length 64</span>
<span class="c">#    08:11:33.867117 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 1, length 64</span>
<span class="c">#    08:11:33.867195 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 1, length 64</span>
<span class="c">#    08:11:34.866610 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 2, length 64</span>
<span class="c">#    08:11:34.866654 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 2, length 64</span>
<span class="c">#    08:11:34.867865 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 2, length 64</span>
<span class="c">#    08:11:34.867891 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 2, length 64</span>
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> eth1 <span class="nt">-nn</span> icmp
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ìº¡ì³ëœ íŒ¨í‚·ì´ ì—†ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> icmp
<span class="c"># =&gt; 08:11:33.865689 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 1, length 64</span>
<span class="c">#    08:11:33.867117 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 1, length 64</span>
<span class="c">#    08:11:34.866654 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 2, length 64</span>
<span class="c">#    08:11:34.867865 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 2, length 64</span>
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> eniYYYYYYYY <span class="nt">-nn</span> icmp
<span class="c"># =&gt; 08:11:33.865643 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 1, length 64</span>
<span class="c">#    08:11:33.867195 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 1, length 64</span>
<span class="c">#    08:11:34.866610 IP 192.168.2.172 &amp;gt; 192.168.3.246: ICMP echo request, id 19, seq 2, length 64</span>
<span class="c">#    08:11:34.867891 IP 192.168.3.246 &amp;gt; 192.168.2.172: ICMP echo reply, id 19, seq 2, length 64</span>

<span class="c"># [ì›Œì»¤ ë…¸ë“œ1]</span>
<span class="c"># routing policy database management í™•ì¸</span>
<span class="nv">$ </span>ip rule
<span class="c"># =&gt; 0: from all lookup local</span>
<span class="c">#    512: from all to 192.168.1.30 lookup main</span>
<span class="c">#    512: from all to 192.168.1.112 lookup main</span>
<span class="c">#    1024:  from all fwmark 0x80/0x80 lookup main</span>
<span class="c">#    32766: from all lookup main</span>
<span class="c">#    32767: from all lookup default</span>

<span class="c"># routing table management í™•ì¸</span>
<span class="nv">$ </span>ip route show table <span class="nb">local</span>
<span class="c"># =&gt; broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1</span>
<span class="c">#    local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1</span>
<span class="c">#    local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1</span>
<span class="c">#    broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1</span>
<span class="c">#    broadcast 192.168.1.0 dev eth0 proto kernel scope link src 192.168.1.186</span>
<span class="c">#    broadcast 192.168.1.0 dev eth1 proto kernel scope link src 192.168.1.9</span>
<span class="c">#    local 192.168.1.9 dev eth1 proto kernel scope host src 192.168.1.9</span>
<span class="c">#    local 192.168.1.186 dev eth0 proto kernel scope host src 192.168.1.186</span>
<span class="c">#    broadcast 192.168.1.255 dev eth0 proto kernel scope link src 192.168.1.186</span>
<span class="c">#    broadcast 192.168.1.255 dev eth1 proto kernel scope link src 192.168.1.9</span>

<span class="c"># ë””í´íŠ¸ ë„¤íŠ¸ì›Œí¬ ì •ë³´ë¥¼ eth0 ì„ í†µí•´ì„œ ë¹ ì ¸ë‚˜ê°„ë‹¤</span>
<span class="nv">$ </span>ip route show table main
<span class="c"># =&gt; default via 192.168.1.1 dev eth0</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<hr>

<h3 id="íŒŒë“œì—ì„œ-ì™¸ë¶€-í†µì‹ ">íŒŒë“œì—ì„œ ì™¸ë¶€ í†µì‹ </h3>

<ul>
  <li>íŒŒë“œì—ì„œ ì™¸ë¶€ í†µì‹  íë¦„ : iptable ì— SNAT ì„ í†µí•˜ì—¬ ë…¸ë“œì˜ eth0 IPë¡œ ë³€ê²½ë˜ì–´ì„œ ì™¸ë¶€ì™€ í†µì‹ í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_8.png" alt="img.png" class="image-center" loading="lazy" width="1453" height="464">
<em class="image-caption"><a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md">https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md</a></em></p>

<ul>
  <li>VPC CNI ì˜ External source network address translation (<code class="language-plaintext highlighter-rouge">SNAT</code>) ì„¤ì •ì— ë”°ë¼, ì™¸ë¶€(ì¸í„°ë„·) í†µì‹  ì‹œ <strong>SNAT</strong> í•˜ê±°ë‚˜ í˜¹ì€ <strong>SNAT ì—†ì´</strong> í†µì‹ ì„ í•  ìˆ˜ ìˆë‹¤ - <a href="https://docs.aws.amazon.com/eks/latest/userguide/external-snat.html">ë§í¬</a>
</li>
</ul>

<h4 id="ì‹¤ìŠµ-íŒŒë“œì—ì„œ-ì™¸ë¶€-í†µì‹ -í…ŒìŠ¤íŠ¸-ë°-í™•ì¸">
<strong>[ì‹¤ìŠµ] íŒŒë“œì—ì„œ ì™¸ë¶€ í†µì‹ </strong> í…ŒìŠ¤íŠ¸ ë° í™•ì¸</h4>

<ul>
  <li>íŒŒë“œ shell ì‹¤í–‰ í›„ ì™¸ë¶€ë¡œ ping í…ŒìŠ¤íŠ¸ &amp; ì›Œì»¤ ë…¸ë“œì—ì„œ tcpdump ë° iptables ì •ë³´ í™•ì¸</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì‘ì—…ìš© EC2 : pod-1 Shell ì—ì„œ ì™¸ë¶€ë¡œ ping</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> ping <span class="nt">-c</span> 1 www.google.com
<span class="c"># =&gt; PING www.google.com (172.217.25.164) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from kix06s19-in-f4.1e100.net (172.217.25.164): icmp_seq=1 ttl=104 time=39.0 ms</span>
<span class="c">#    </span>
<span class="c">#    --- www.google.com ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 38.967/38.967/38.967/0.000 ms</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> ping <span class="nt">-i</span> 0.1 www.google.com
  
<span class="c"># ì›Œì»¤ ë…¸ë“œ EC2 : TCPDUMP í™•ì¸</span>
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> any <span class="nt">-nn</span> icmp
<span class="nv">$ </span><span class="nb">sudo </span>tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span> icmp
  
<span class="c"># ì‘ì—…ìš© EC2 : í¼ë¸”ë¦­IP í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> curl <span class="nt">-s</span> ipinfo.io/ip<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
  
<span class="c"># ì‘ì—…ìš© EC2 : pod-1 Shell ì—ì„œ ì™¸ë¶€ ì ‘ì† í™•ì¸ - ê³µì¸IPëŠ” ì–´ë–¤ ì£¼ì†Œì¸ê°€?</span>
<span class="c">## The right way to check the weather - [ë§í¬](https://github.com/chubin/wttr.in)</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$PODNAME1</span> <span class="nv">$PODNAME2</span> <span class="nv">$PODNAME3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; Pod : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$i</span> <span class="nt">--</span> curl <span class="nt">-s</span> ipinfo.io/ip<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> curl <span class="nt">-s</span> wttr.in/seoul
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> curl <span class="nt">-s</span> wttr.in/seoul?format<span class="o">=</span>3
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> curl <span class="nt">-s</span> wttr.in/Moon
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$PODNAME1</span> <span class="nt">--</span> curl <span class="nt">-s</span> wttr.in/:help
  
<span class="c"># ì›Œì»¤ ë…¸ë“œ EC2</span>
<span class="nv">$ </span>ip rule
<span class="nv">$ </span>ip route show table main
<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-L</span> <span class="nt">-n</span> <span class="nt">-v</span> <span class="nt">-t</span> nat
<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
  
<span class="c"># íŒŒë“œê°€ ì™¸ë¶€ì™€ í†µì‹ ì‹œì—ëŠ” ì•„ë˜ ì²˜ëŸ¼ 'AWS-SNAT-CHAIN-0' ë£°(rule)ì— ì˜í•´ì„œ SNAT ë˜ì–´ì„œ ì™¸ë¶€ì™€ í†µì‹ !</span>
<span class="c"># ì°¸ê³ ë¡œ ë’¤ IPëŠ” eth0(ENI ì²«ë²ˆì§¸)ì˜ IP ì£¼ì†Œì…ë‹ˆë‹¤.</span>
<span class="c"># --random-fully ë™ì‘ - [ë§í¬1](https://ssup2.github.io/issue/Linux_TCP_SYN_Packet_Drop_SNAT_Port_Race_Condition/)  [ë§í¬2](https://ssup2.github.io/issue/Kubernetes_TCP_Connection_Delay_VXLAN_CNI_Plugin/)</span>
<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span> | <span class="nb">grep</span> <span class="s1">'A AWS-SNAT-CHAIN'</span>
<span class="c"># =&gt; -A AWS-SNAT-CHAIN-0 -d 192.168.0.0/16 -m comment --comment &amp;quot;AWS SNAT CHAIN&amp;quot; -j RETURN</span>
<span class="c">#    -A AWS-SNAT-CHAIN-0 ! -o vlan+ -m comment --comment &amp;quot;AWS, SNAT&amp;quot; -m addrtype ! --dst-type LOCAL -j SNAT --to-source 192.168.2.92 --random-fully</span>
  
<span class="c">## ì•„ë˜ 'mark 0x4000/0x4000' ë§¤ì¹­ë˜ì§€ ì•Šì•„ì„œ RETURN ë¨!</span>
<span class="c"># =&gt; -A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN</span>
<span class="c">#    -A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0</span>
<span class="c">#    -A KUBE-POSTROUTING -m comment --comment &amp;quot;kubernetes service traffic requiring SNAT&amp;quot; -j MASQUERADE --random-fully</span>
<span class="c">#    ...</span>
  
<span class="c"># ì¹´ìš´íŠ¸ í™•ì¸ ì‹œ AWS-SNAT-CHAIN-0ì— ë§¤ì¹­ë˜ì–´, ëª©ì ì§€ê°€ 192.168.0.0/16 ì•„ë‹ˆê³  ì™¸ë¶€ ë¹ ì ¸ë‚˜ê°ˆë•Œ SNAT 192.168.1.251(EC2 ë…¸ë“œ1 IP) ë³€ê²½ë˜ì–´ ë‚˜ê°‘ë‹ˆë‹¤.</span>
<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> filter <span class="nt">--zero</span><span class="p">;</span> <span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">--zero</span><span class="p">;</span> <span class="nb">sudo </span>iptables <span class="nt">-t</span> mangle <span class="nt">--zero</span><span class="p">;</span> <span class="nb">sudo </span>iptables <span class="nt">-t</span> raw <span class="nt">--zero</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'sudo iptables -v --numeric --table nat --list AWS-SNAT-CHAIN-0; echo ; sudo iptables -v --numeric --table nat --list KUBE-POSTROUTING; echo ; sudo iptables -v --numeric --table nat --list POSTROUTING'</span>
<span class="c"># =&gt; Chain AWS-SNAT-CHAIN-0 (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination</span>
<span class="c">#       12  1106 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16  /* AWS SNAT CHAIN */</span>
<span class="c">#       31  1924 SNAT       all  --  *      !vlan+  0.0.0.0/0            0.0.0.0/0            /* AWS, SNAT */ ADDRTYPE match dst-type !LOCAL to:192.168.2.92 random-fully</span>
<span class="c">#    </span>
<span class="c">#    Chain KUBE-POSTROUTING (1 references)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination</span>
<span class="c">#       53  3630 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match ! 0x4000/0x4000</span>
<span class="c">#        0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            MARK xor 0x4000</span>
<span class="c">#        0     0 MASQUERADE  all  --  * * 0.0.0.0/0            0.0.0.0/0            /* kubernetes service traffic requiring SNAT */ random-fully</span>
<span class="c">#    </span>
<span class="c">#    Chain POSTROUTING (policy ACCEPT 22 packets, 1706 bytes)</span>
<span class="c">#     pkts bytes target     prot opt in     out     source               destination</span>
<span class="c">#       53  3630 KUBE-POSTROUTING  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */</span>
<span class="c">#       53  3630 AWS-SNAT-CHAIN-0  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* AWS SNAT CHAIN */</span>
  
<span class="c"># conntrack í™•ì¸</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>conntrack <span class="nt">-L</span> <span class="nt">-n</span> |grep <span class="nt">-v</span> <span class="s1">'169.254.169'</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    udp      17 29 src=192.168.1.186 dst=146.56.40.151 sport=50772 dport=123 src=146.56.40.151 dst=192.168.1.186 sport=123 dport=47629 mark=128 use=1</span>
<span class="c">#    tcp      6 86395 ESTABLISHED src=192.168.1.186 dst=52.95.197.175 sport=45832 dport=443 src=52.95.197.175 dst=192.168.1.186 sport=443 dport=30346 [ASSURED] mark=128 use=1</span>
<span class="c">#    tcp      6 86395 ESTABLISHED src=192.168.1.186 dst=52.95.195.121 sport=48862 dport=443 src=52.95.195.121 dst=192.168.1.186 sport=443 dport=41664 [ASSURED] mark=128 use=1</span>
<span class="c">#    conntrack v1.4.4 (conntrack-tools): 59 flow entries have been shown.</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    conntrack v1.4.4 (conntrack-tools): 50 flow entries have been shown.</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    conntrack v1.4.4 (conntrack-tools): 51 flow entries have been shown.</span>
<span class="c">#    udp      17 23 src=192.168.3.235 dst=146.56.40.151 sport=51849 dport=123 src=146.56.40.151 dst=192.168.3.235 sport=123 dport=29777 mark=128 use=1</span>
</code></pre></div></div>

<ul>
  <li>ë‹¤ìŒ ì‹¤ìŠµì„ ìœ„í•´ì„œ íŒŒë“œ ì‚­ì œ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete deploy netshoot-pod
<span class="c"># =&gt; deployment.apps &amp;quot;netshoot-pod&amp;quot; deleted</span>
</code></pre></div></div>

<hr>

<h3 id="ë…¸ë“œì˜-íŒŒë“œ-ìƒì„±-ê°¯ìˆ˜-ì œí•œ">ë…¸ë“œì˜ íŒŒë“œ ìƒì„± ê°¯ìˆ˜ ì œí•œ</h3>

<h4 id="ì‚¬ì „-ì¤€ë¹„--kube-ops-view-ì„¤ì¹˜">ì‚¬ì „ ì¤€ë¹„ : kube-ops-view ì„¤ì¹˜</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kube-ops-view</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="c"># =&gt; &amp;quot;geek-cookbook&amp;quot; has been added to your repositories</span>
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>LoadBalancer <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system
<span class="c"># =&gt; NAME: kube-ops-view</span>
<span class="c">#    LAST DEPLOYED: Sat Oct  1 17:30:33 2024</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    1. Get the application URL by running these commands:</span>
<span class="c">#         NOTE: It may take a few minutes for the LoadBalancer IP to be available.</span>
<span class="c">#               You can watch the status of by running 'kubectl get svc -w kube-ops-view'</span>
<span class="c">#      export SERVICE_IP=$(kubectl get svc --namespace kube-system kube-ops-view -o jsonpath='{.status.loadBalancer.ingress[0].ip}')</span>
<span class="c">#      echo http://$SERVICE_IP:8080</span>

<span class="c"># kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 ë°°ìœ¨)</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> kube-system kube-ops-view <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span> | <span class="nb">awk</span> <span class="s1">'{ print "KUBE-OPS-VIEW URL = http://"$1":8080/#scale=1.5"}'</span>
<span class="c"># =&gt; KUBE-OPS-VIEW URL = http://ae19b387d6fee48239f44d3f9f121378-262130081.ap-northeast-2.elb.amazonaws.com:8080/#scale=1.5</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_29.png" alt="img.png" class="image-center" loading="lazy" width="887" height="516"></p>

<ul>
  <li>
<strong>Secondary IPv4 addresses</strong> (ê¸°ë³¸ê°’) : ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•ì— ìµœëŒ€ ENI ê°¯ìˆ˜ì™€ í• ë‹¹ ê°€ëŠ¥ IP ìˆ˜ë¥¼ ì¡°í•©í•˜ì—¬ ì„ ì •</li>
</ul>

<h4 id="ì›Œì»¤-ë…¸ë“œì˜-ì¸ìŠ¤í„´ìŠ¤-íƒ€ì…-ë³„-íŒŒë“œ-ìƒì„±-ê°¯ìˆ˜-ì œí•œ">ì›Œì»¤ ë…¸ë“œì˜ ì¸ìŠ¤í„´ìŠ¤ íƒ€ì… ë³„ íŒŒë“œ ìƒì„± ê°¯ìˆ˜ ì œí•œ</h4>

<ul>
  <li>
<strong>ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…</strong> ë³„ ENI ìµœëŒ€ ê°¯ìˆ˜ì™€ í• ë‹¹ ê°€ëŠ¥í•œ ìµœëŒ€ IP ê°¯ìˆ˜ì— ë”°ë¼ì„œ íŒŒë“œ ë°°ì¹˜ ê°¯ìˆ˜ê°€ ê²°ì •ë¨</li>
  <li>ë‹¨, aws-node ì™€ kube-proxy íŒŒë“œëŠ” í˜¸ìŠ¤íŠ¸ì˜ IPë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œ ìµœëŒ€ ê°¯ìˆ˜ì—ì„œ ì œì™¸í•¨</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_9.png" alt="img.png" class="image-center w-90" loading="lazy" width="932" height="787"></p>

<blockquote>
  <p>ğŸ‘‰ ìµœëŒ€ íŒŒë“œ ìƒì„± ê°¯ìˆ˜ : <code class="language-plaintext highlighter-rouge">(Number of network interfaces for the instance type Ã— (the number of IP addressess per network interface - 1)) + 2</code></p>
</blockquote>

<h4 id="ì›Œì»¤-ë…¸ë“œì˜-ì¸ìŠ¤í„´ìŠ¤-ì •ë³´-í™•ì¸--t3medium-ì‚¬ìš©-ì‹œ">ì›Œì»¤ ë…¸ë“œì˜ ì¸ìŠ¤í„´ìŠ¤ ì •ë³´ í™•ì¸ : t3.medium ì‚¬ìš© ì‹œ</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># t3 íƒ€ì…ì˜ ì •ë³´(í•„í„°) í™•ì¸</span>
<span class="nv">$ </span>aws ec2 describe-instance-types <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>instance-type,Values<span class="o">=</span>t3.<span class="k">*</span> <span class="se">\</span>
  <span class="nt">--query</span> <span class="s2">"InstanceTypes[].{Type: InstanceType, MaxENI: NetworkInfo.MaximumNetworkInterfaces, IPv4addr: NetworkInfo.Ipv4AddressesPerInterface}"</span> <span class="se">\</span>
  <span class="nt">--output</span> table
<span class="c"># =&gt; --------------------------------------</span>
<span class="c">#    |        DescribeInstanceTypes       |</span>
<span class="c">#    +----------+----------+--------------+</span>
<span class="c">#    | IPv4addr | MaxENI   |    Type      |</span>
<span class="c">#    +----------+----------+--------------+</span>
<span class="c">#    |  12      |  3       |  t3.large    |</span>
<span class="c">#    |  6       |  3       |  t3.medium   |</span>
<span class="c">#    |  15      |  4       |  t3.2xlarge  |</span>
<span class="c">#    |  15      |  4       |  t3.xlarge   |</span>
<span class="c">#    |  2       |  2       |  t3.micro    |</span>
<span class="c">#    |  2       |  2       |  t3.nano     |</span>
<span class="c">#    |  4       |  3       |  t3.small    |</span>
<span class="c">#    +----------+----------+--------------+</span>

<span class="c"># c5 íƒ€ì…ì˜ ì •ë³´(í•„í„°) í™•ì¸</span>
<span class="nv">$ </span>aws ec2 describe-instance-types <span class="nt">--filters</span> <span class="nv">Name</span><span class="o">=</span>instance-type,Values<span class="o">=</span>c5<span class="k">*</span>.<span class="k">*</span> <span class="se">\</span>
  <span class="nt">--query</span> <span class="s2">"InstanceTypes[].{Type: InstanceType, MaxENI: NetworkInfo.MaximumNetworkInterfaces, IPv4addr: NetworkInfo.Ipv4AddressesPerInterface}"</span> <span class="se">\</span>
  <span class="nt">--output</span> table
<span class="c"># =&gt; ----------------------------------------</span>
<span class="c">#    |         DescribeInstanceTypes        |</span>
<span class="c">#    +----------+----------+----------------+</span>
<span class="c">#    | IPv4addr | MaxENI   |     Type       |</span>
<span class="c">#    +----------+----------+----------------+</span>
<span class="c">#    |  30      |  8       |  c5d.12xlarge  |</span>
<span class="c">#    |  10      |  3       |  c5d.large     |</span>
<span class="c">#    |  10      |  3       |  c5n.large     |</span>
<span class="c">#    |  15      |  4       |  c5n.2xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5.4xlarge    |</span>
<span class="c">#    |  15      |  4       |  c5a.xlarge    |</span>
<span class="c">#    |  30      |  8       |  c5a.4xlarge   |</span>
<span class="c">#    |  15      |  4       |  c5d.2xlarge   |</span>
<span class="c">#    |  50      |  15      |  c5d.24xlarge  |</span>
<span class="c">#    |  30      |  8       |  c5.12xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5n.9xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5a.12xlarge  |</span>
<span class="c">#    |  15      |  4       |  c5.xlarge     |</span>
<span class="c">#    |  30      |  8       |  c5n.4xlarge   |</span>
<span class="c">#    |  50      |  15      |  c5n.18xlarge  |</span>
<span class="c">#    |  50      |  15      |  c5.24xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5d.4xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5.9xlarge    |</span>
<span class="c">#    |  15      |  4       |  c5a.2xlarge   |</span>
<span class="c">#    |  50      |  15      |  c5.metal      |</span>
<span class="c">#    |  50      |  15      |  c5a.24xlarge  |</span>
<span class="c">#    |  50      |  15      |  c5d.18xlarge  |</span>
<span class="c">#    |  50      |  15      |  c5a.16xlarge  |</span>
<span class="c">#    |  30      |  8       |  c5a.8xlarge   |</span>
<span class="c">#    |  50      |  15      |  c5n.metal     |</span>
<span class="c">#    |  50      |  15      |  c5d.metal     |</span>
<span class="c">#    |  10      |  3       |  c5.large      |</span>
<span class="c">#    |  15      |  4       |  c5.2xlarge    |</span>
<span class="c">#    |  15      |  4       |  c5d.xlarge    |</span>
<span class="c">#    |  10      |  3       |  c5a.large     |</span>
<span class="c">#    |  50      |  15      |  c5.18xlarge   |</span>
<span class="c">#    |  30      |  8       |  c5d.9xlarge   |</span>
<span class="c">#    |  15      |  4       |  c5n.xlarge    |</span>
<span class="c">#    +----------+----------+----------------+  </span>

<span class="c"># íŒŒë“œ ì‚¬ìš© ê°€ëŠ¥ ê³„ì‚° ì˜ˆì‹œ : aws-node ì™€ kube-proxy íŒŒë“œëŠ” host-networking ì‚¬ìš©ìœ¼ë¡œ IP 2ê°œ ë‚¨ìŒ</span>
<span class="c"># ((MaxENI * (IPv4addr-1)) + 2)</span>
<span class="c"># t3.medium ê²½ìš° : ((3 * (6 - 1) + 2 ) = 17ê°œ &gt;&gt; aws-node ì™€ kube-proxy 2ê°œ ì œì™¸í•˜ë©´ 15ê°œ</span>

<span class="c"># ì›Œì»¤ë…¸ë“œ ìƒì„¸ ì •ë³´ í™•ì¸ : ë…¸ë“œ ìƒì„¸ ì •ë³´ì˜ Allocatable ì— pods ì— 17ê°œ ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe node | <span class="nb">grep </span>Allocatable: <span class="nt">-A6</span>
<span class="c"># =&gt; Allocatable:</span>
<span class="c">#      cpu:                1930m</span>
<span class="c">#      ephemeral-storage:  27905944324</span>
<span class="c">#      hugepages-1Gi:      0</span>
<span class="c">#      hugepages-2Mi:      0</span>
<span class="c">#      memory:             3388304Ki</span>
<span class="c">#      pods:               17</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h4 id="ìµœëŒ€-íŒŒë“œ-ìƒì„±-ë°-í™•ì¸">ìµœëŒ€ íŒŒë“œ ìƒì„± ë° í™•ì¸</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì›Œì»¤ ë…¸ë“œ EC2 - ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>ip <span class="nt">-br</span> <span class="nt">-c</span> addr show <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"--------------"</span> <span class="p">;</span> <span class="nb">date</span> <span class="s2">"+%Y-%m-%d %H:%M:%S"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>

<span class="c"># ì‘ì—…ìš© EC2 - í„°ë¯¸ë„1</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pods -o wide'</span>

<span class="c"># ì‘ì—…ìš© EC2 - í„°ë¯¸ë„2</span>
<span class="c"># ë””í”Œë¡œì´ë¨¼íŠ¸ ìƒì„±</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-O</span> https://raw.githubusercontent.com/gasida/PKOS/main/2/nginx-dp.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> nginx-dp.yaml
<span class="c"># =&gt; deployment.apps/nginx-deployment created</span>

<span class="c"># íŒŒë“œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span><span class="o">=</span>custom-columns<span class="o">=</span>NAME:.metadata.name,IP:.status.podIP
<span class="c"># =&gt; NAME                                IP</span>
<span class="c">#    nginx-deployment-6f999cfffb-44rw7   192.168.1.230</span>
<span class="c">#    nginx-deployment-6f999cfffb-xk4nh   192.168.3.246</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-brief</span> addr | <span class="nb">wc</span> <span class="nt">-l</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    5</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    4</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    5</span>

<span class="c"># íŒŒë“œ ì¦ê°€ í…ŒìŠ¤íŠ¸ &gt;&gt; íŒŒë“œ ì •ìƒ ìƒì„± í™•ì¸, ì›Œì»¤ ë…¸ë“œì—ì„œ eth, eni ê°¯ìˆ˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl scale deployment nginx-deployment <span class="nt">--replicas</span><span class="o">=</span>8
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-brief</span> addr | <span class="nb">wc</span> <span class="nt">-l</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    7</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    6</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    7</span>

<span class="c"># íŒŒë“œ ì¦ê°€ í…ŒìŠ¤íŠ¸ &gt;&gt; íŒŒë“œ ì •ìƒ ìƒì„± í™•ì¸, ì›Œì»¤ ë…¸ë“œì—ì„œ eth, eni ê°¯ìˆ˜ í™•ì¸ &gt;&gt; ì–´ë–¤ì¼ì´ ë²Œì–´ì¡ŒëŠ”ê°€?</span>
<span class="nv">$ </span>kubectl scale deployment nginx-deployment <span class="nt">--replicas</span><span class="o">=</span>15
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-brief</span> addr | <span class="nb">wc</span> <span class="nt">-l</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    9</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    9</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    10</span>

<span class="c"># íŒŒë“œ ì¦ê°€ í…ŒìŠ¤íŠ¸ &gt;&gt; íŒŒë“œ ì •ìƒ ìƒì„± í™•ì¸, ì›Œì»¤ ë…¸ë“œì—ì„œ eth, eni ê°¯ìˆ˜ í™•ì¸ &gt;&gt; ì–´ë–¤ì¼ì´ ë²Œì–´ì¡ŒëŠ”ê°€?</span>
<span class="nv">$ </span>kubectl scale deployment nginx-deployment <span class="nt">--replicas</span><span class="o">=</span>30
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-brief</span> addr | <span class="nb">wc</span> <span class="nt">-l</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    15</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    15</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    15</span>

<span class="c"># íŒŒë“œ ì¦ê°€ í…ŒìŠ¤íŠ¸ &gt;&gt; íŒŒë“œ ì •ìƒ ìƒì„± í™•ì¸, ì›Œì»¤ ë…¸ë“œì—ì„œ eth, eni ê°¯ìˆ˜ í™•ì¸ &gt;&gt; ì–´ë–¤ì¼ì´ ë²Œì–´ì¡ŒëŠ”ê°€?</span>
<span class="nv">$ </span>kubectl scale deployment nginx-deployment <span class="nt">--replicas</span><span class="o">=</span>50
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="nv">$N1</span> <span class="nv">$N2</span> <span class="nv">$N3</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> ssh ec2-user@<span class="nv">$i</span> <span class="nb">sudo </span>ip <span class="nt">-brief</span> addr | <span class="nb">wc</span> <span class="nt">-l</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; node 192.168.1.186 &amp;lt;&amp;lt;</span>
<span class="c">#    19</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.2.92 &amp;lt;&amp;lt;</span>
<span class="c">#    19</span>
<span class="c">#    &amp;gt;&amp;gt; node 192.168.3.235 &amp;lt;&amp;lt;</span>
<span class="c">#    19</span>

<span class="c"># íŒŒë“œ ìƒì„± ì‹¤íŒ¨!</span>
<span class="nv">$ </span>kubectl get pods | <span class="nb">grep </span>Pending
<span class="c"># =&gt; nginx-deployment-6f999cfffb-59cj6   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-5z5qg   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-6gk4m   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-bhzc8   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-hlns8   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-n64nc   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-w8x7g   0/1     Pending   0          69s</span>
<span class="c">#    nginx-deployment-6f999cfffb-zb2pk   0/1     Pending   0          69s</span>

<span class="c">#$ kubectl describe pod &lt;Pending íŒŒë“œ&gt; | grep Events: -A5</span>
<span class="nv">$ </span>kubectl describe pod nginx-deployment-6f999cfffb-59cj6 | <span class="nb">grep </span>Events: <span class="nt">-A5</span>
<span class="c"># =&gt; Events:</span>
<span class="c">#      Type     Reason            Age   From               Message</span>
<span class="c">#      ----     ------            ----  ----               -------</span>
<span class="c">#      Warning  FailedScheduling  101s  default-scheduler  0/3 nodes are available: 3 Too many pods. preemption: 0/3 nodes are available: 3 No preemption victims found for incoming pod.</span>
</code></pre></div></div>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_30.png" alt="img.png" class="image-center" loading="lazy" width="910" height="516"></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë””í”Œë¡œì´ë¨¼íŠ¸ ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete deploy nginx-deployment
<span class="c"># =&gt; deployment.apps &amp;quot;nginx-deployment&amp;quot; deleted</span>
</code></pre></div></div>

<ul>
  <li>ğŸ‘‰ í•´ê²° ë°©ì•ˆ : IPv4 Prefix Delegation, WARM &amp; MIN IP/Prefix Targets, Custom Network</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_10.png" alt="img.png" class="image-center w-80" loading="lazy" width="937" height="780">
<em class="image-caption">IPv4 Prefix Delegationì„ í†µí•œ IP ê°¯ìˆ˜ ì œí•œ í•´ì†Œ</em></p>

<hr>

<h3 id="service--aws-loadbalancer-controller">Service &amp; AWS LoadBalancer Controller</h3>

<h4 id="ì„œë¹„ìŠ¤-ì¢…ë¥˜">ì„œë¹„ìŠ¤ ì¢…ë¥˜</h4>

<ul>
  <li>ClusterIP íƒ€ì…</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_16.png" alt="img.png" class="image-center w-90" loading="lazy" width="1111" height="382"></p>

<ul>
  <li>NodePort íƒ€ì…</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_17.png" alt="img_1.png" class="image-center w-90" loading="lazy" width="972" height="375"></p>

<ul>
  <li>LoadBalancer íƒ€ì… (ê¸°ë³¸ ëª¨ë“œ) : NLB ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_18.png" alt="img_2.png" class="image-center w-90" loading="lazy" width="1157" height="362"></p>

<ul>
  <li>Service (LoadBalancer Controller) : AWS Load Balancer Controller + NLB IP ëª¨ë“œ ë™ì‘ with AWS VPC CNI</li>
</ul>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_19.png" alt="img_3.png" class="image-center w-90" loading="lazy" width="1146" height="429"></p>

<h4 id="nlb-ëª¨ë“œ-ì „ì²´-ì •ë¦¬">NLB ëª¨ë“œ ì „ì²´ ì •ë¦¬</h4>

<h5 id="instance-mode">Instance mode</h5>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_20.png" alt="img_4.png" class="image-center w-90" loading="lazy" width="1099" height="647">
<em class="image-caption"><a href="https://aws.amazon.com/blogs/networking-and-content-delivery/deploying-aws-load-balancer-controller-on-amazon-eks/">https://aws.amazon.com/blogs/networking-and-content-delivery/deploying-aws-load-balancer-controller-on-amazon-eks/</a></em></p>

<ul>
  <li>
<strong>externalTrafficPolicy</strong>ì— ë”°ë¥¸ ë™ì‘ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">externalTrafficPolicy: ClusterIP</code> : 2ë²ˆ ë¶„ì‚° ë° SNATìœ¼ë¡œ Client IP í™•ì¸ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. &lt;- LoadBalancer íƒ€ì… (ê¸°ë³¸ ëª¨ë“œ) ë™ì‘</li>
      <li>
<code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> : 1ë²ˆ ë¶„ì‚° ë° ClientIPê°€ ìœ ì§€ë˜ê³ , ì›Œì»¤ ë…¸ë“œì˜ iptablesì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        <ul>
          <li>
            <p><strong>í†µì‹  íë¦„</strong> : ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ê°€ â€˜ë¡œë“œë°¸ëŸ°ì„œâ€™ ì ‘ì† ì‹œ ë¶€í•˜ë¶„ì‚° ë˜ì–´ ë…¸ë“œ ë„ë‹¬ í›„ iptables ë£°ë¡œ ëª©ì ì§€ íŒŒë“œì™€ í†µì‹ ë©ë‹ˆë‹¤.</p>

            <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_21.png" alt="img_5.png" class="image-center w-90" loading="lazy" width="1156" height="356">
<em class="image-caption"><code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code>ì¼ë•Œì˜ í†µì‹ íë¦„ì˜ ì˜ˆ</em></p>

            <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_22.png" alt="img_6.png" class="image-center w-90" loading="lazy" width="752" height="242"></p>

            <ul>
              <li>ë…¸ë“œëŠ” ì™¸ë¶€ì— ê³µê°œë˜ì§€ ì•Šê³  ë¡œë“œë°¸ëŸ°ì„œë§Œ ì™¸ë¶€ì— ê³µê°œë˜ë©°, ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ëŠ” ë¡œë“œë°¸ëœì„œì— ì ‘ì†ì„ í•  ë¿ ë‚´ë¶€ ë…¸ë“œì˜ ì •ë³´ë¥¼ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
              <li>ë¡œë“œë°¸ëŸ°ì„œê°€ ë¶€í•˜ë¶„ì‚°í•˜ì—¬ íŒŒë“œê°€ ì¡´ì¬í•˜ëŠ” ë…¸ë“œë“¤ì—ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤. iptables ë£°ì—ì„œëŠ” ìì‹ ì˜ ë…¸ë“œì— ìˆëŠ” íŒŒë“œë§Œ ì—°ê²°í•©ë‹ˆë‹¤. (<code class="language-plaintext highlighter-rouge">externalTrafficPolicy: local</code>)</li>
              <li>DNATê°€ 2ë²ˆ ë™ì‘í•©ë‹ˆë‹¤. (1) ë¡œë“œë°¸ëŸ°ì„œ ì ‘ì† í›„ ë¹ ì ¸ ë‚˜ê°ˆë•Œ, (2) ë…¸ë“œì˜ iptables ë£°ì—ì„œ íŒŒë“œIP ì „ë‹¬ ì‹œ</li>
              <li>ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ì˜ IPê°€ ë³´ì¡´ë©ë‹ˆë‹¤. AWS NLB ëŠ” <strong>íƒ€ì¼“</strong>ì´ <strong>ì¸ìŠ¤í„´ìŠ¤</strong>ì¼ ê²½ìš° í´ë¼ì´ì–¸íŠ¸ IPë¥¼ ìœ ì§€, iptables ë£° ê²½ìš°ë„ <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: local</code> ë¡œ í´ë¼ì´ì–¸íŠ¸ IPë¥¼ ë³´ì¡´í•©ë‹ˆë‹¤.</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ë¶€í•˜ë¶„ì‚° ìµœì í™”</strong> : ë…¸ë“œì— íŒŒë“œê°€ ì—†ì„ ê²½ìš° â€˜ë¡œë“œë°¸ëŸ°ì„œâ€™ì—ì„œ ë…¸ë“œì— í—¬ìŠ¤ ì²´í¬(ìƒíƒœ ê²€ì‚¬)ê°€ ì‹¤íŒ¨í•˜ì—¬ í•´ë‹¹ ë…¸ë“œë¡œëŠ” ì™¸ë¶€ ìš”ì²­ íŠ¸ë˜í”½ì„ ì „ë‹¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_23.png" alt="img_7.png" class="image-center w-90" loading="lazy" width="928" height="293">
<img src="/assets/2024/kans-3th/w9/20241102_kans_w9_26.png" alt="img.png" loading="lazy" width="884" height="250"></p>

    <p>ìœ„ì˜ ì´ë¯¸ì§€ ì²˜ëŸ¼ 3ë²ˆì§¸ ì¸ìŠ¤í„´ìŠ¤(Node3)ì€ ìƒíƒœ í™•ì¸ì´ ì‹¤íŒ¨í•œ ê²½ìš°, í•´ë‹¹ ë…¸ë“œë¡œëŠ” ì™¸ë¶€ ìš”ì²­ íŠ¸ë˜í”½ ì „ë‹¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<h5 id="ip-mode">IP mode</h5>

<ul>
  <li>
    <p>IP ëª¨ë“œëŠ” ë°˜ë“œì‹œ AWS LoadBalancer ì»¨íŠ¸ë¡¤ëŸ¬ íŒŒë“œ ë° ì •ì±… ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>

    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_24.png" alt="img_8.png" class="image-center w-90" loading="lazy" width="1106" height="650">
<em class="image-caption"><a href="https://aws.amazon.com/blogs/networking-and-content-delivery/deploying-aws-load-balancer-controller-on-amazon-eks/">https://aws.amazon.com/blogs/networking-and-content-delivery/deploying-aws-load-balancer-controller-on-amazon-eks/</a></em></p>

    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">Proxy Protocol v2 ë¹„í™œì„±í™”</code> â‡’ NLBì—ì„œ ë°”ë¡œ íŒŒë“œë¡œ ì¸ì…ë˜ë©°, ë‹¨ ClientIPê°€ NLBë¡œ SNAT ë˜ì–´ Client IP í™•ì¸ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li>
<code class="language-plaintext highlighter-rouge">Proxy Protocol v2 í™œì„±í™”</code> â‡’ NLBì—ì„œ ë°”ë¡œ íŒŒë“œë¡œ ì¸ì… ë° ClientIP í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¨, PPv2ë¥¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¸ì§€í•  ìˆ˜ ìˆê²Œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>
    <p><strong>AWS LoadBalancer Controller ë°°í¬</strong> - <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/deploy/installation/"><strong>Link</strong></a></p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># Helm Chart ì„¤ì¹˜</span>
<span class="nv">$ </span>helm repo add eks https://aws.github.io/eks-charts
<span class="c"># =&gt; &amp;quot;eks&amp;quot; has been added to your repositories</span>
<span class="nv">$ </span>helm repo update
<span class="c"># =&gt; Hang tight while we grab the latest from your chart repositories...</span>
<span class="c">#    ...Successfully got an update from the &amp;quot;eks&amp;quot; chart repository</span>
<span class="c">#    ...Successfully got an update from the &amp;quot;geek-cookbook&amp;quot; chart repository</span>
<span class="c">#    Update Complete. âˆHappy Helming!âˆ</span>
<span class="nv">$ </span>helm <span class="nb">install </span>aws-load-balancer-controller eks/aws-load-balancer-controller <span class="nt">-n</span> kube-system <span class="nt">--set</span> <span class="nv">clusterName</span><span class="o">=</span><span class="nv">$CLUSTER_NAME</span>
<span class="c"># =&gt; NAME: aws-load-balancer-controller</span>
<span class="c">#    LAST DEPLOYED: Sat Oct  1 17:45:09 2024</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    AWS Load Balancer controller installed!</span>
  
<span class="c">## ì„¤ì¹˜ í™•ì¸</span>
<span class="nv">$ </span>kubectl get crd
<span class="c"># =&gt; NAME                                         CREATED AT</span>
<span class="c">#    ...</span>
<span class="c">#    ingressclassparams.elbv2.k8s.aws             2024-10-01T08:45:08Z</span>
<span class="c">#    ...</span>
<span class="c">#    targetgroupbindings.elbv2.k8s.aws            2024-10-01T08:45:08Z</span>
<span class="nv">$ </span>kubectl get deployment <span class="nt">-n</span> kube-system aws-load-balancer-controller
<span class="c"># =&gt; NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    aws-load-balancer-controller   2/2     2            2           58s</span>
<span class="nv">$ </span>kubectl describe deploy <span class="nt">-n</span> kube-system aws-load-balancer-controller
<span class="nv">$ </span>kubectl describe deploy <span class="nt">-n</span> kube-system aws-load-balancer-controller | <span class="nb">grep</span> <span class="s1">'Service Account'</span>
<span class="c"># =&gt;   Service Account:  aws-load-balancer-controller</span>
  
<span class="c"># í´ëŸ¬ìŠ¤í„°ë¡¤, ë¡¤ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe clusterrolebindings.rbac.authorization.k8s.io aws-load-balancer-controller-rolebinding
<span class="nv">$ </span>kubectl describe clusterroles.rbac.authorization.k8s.io aws-load-balancer-controller-role
<span class="c"># =&gt; ...</span>
<span class="c">#    PolicyRule:</span>
<span class="c">#      Resources                                     Non-Resource URLs  Resource Names  Verbs</span>
<span class="c">#      ---------                                     -----------------  --------------  -----</span>
<span class="c">#      targetgroupbindings.elbv2.k8s.aws             []                 []              [create delete get list patch update watch]</span>
<span class="c">#      events                                        []                 []              [create patch]</span>
<span class="c">#      configmaps                                    []                 []              [get delete create update]</span>
<span class="c">#      ingresses                                     []                 []              [get list patch update watch]</span>
<span class="c">#      services                                      []                 []              [get list patch update watch]</span>
<span class="c">#      ingresses.extensions                          []                 []              [get list patch update watch]</span>
<span class="c">#      services.extensions                           []                 []              [get list patch update watch]</span>
<span class="c">#      ingresses.networking.k8s.io                   []                 []              [get list patch update watch]</span>
<span class="c">#      services.networking.k8s.io                    []                 []              [get list patch update watch]</span>
<span class="c">#      endpoints                                     []                 []              [get list watch]</span>
<span class="c">#      namespaces                                    []                 []              [get list watch]</span>
<span class="c">#      nodes                                         []                 []              [get list watch]</span>
<span class="c">#      pods                                          []                 []              [get list watch]</span>
<span class="c">#      endpointslices.discovery.k8s.io               []                 []              [get list watch]</span>
<span class="c">#      ingressclassparams.elbv2.k8s.aws              []                 []              [get list watch]</span>
<span class="c">#      ingressclasses.networking.k8s.io              []                 []              [get list watch]</span>
<span class="c">#      ingresses/status                              []                 []              [update patch]</span>
<span class="c">#      pods/status                                   []                 []              [update patch]</span>
<span class="c">#      services/status                               []                 []              [update patch]</span>
<span class="c">#      targetgroupbindings/status                    []                 []              [update patch]</span>
<span class="c">#      ingresses.elbv2.k8s.aws/status                []                 []              [update patch]</span>
<span class="c">#      pods.elbv2.k8s.aws/status                     []                 []              [update patch]</span>
<span class="c">#      services.elbv2.k8s.aws/status                 []                 []              [update patch]</span>
<span class="c">#      targetgroupbindings.elbv2.k8s.aws/status      []                 []              [update patch]</span>
<span class="c">#      ingresses.extensions/status                   []                 []              [update patch]</span>
<span class="c">#      pods.extensions/status                        []                 []              [update patch]</span>
<span class="c">#      services.extensions/status                    []                 []              [update patch]</span>
<span class="c">#      targetgroupbindings.extensions/status         []                 []              [update patch]</span>
<span class="c">#      ingresses.networking.k8s.io/status            []                 []              [update patch]</span>
<span class="c">#      pods.networking.k8s.io/status                 []                 []              [update patch]</span>
<span class="c">#      services.networking.k8s.io/status             []                 []              [update patch]</span>
<span class="c">#      targetgroupbindings.networking.k8s.io/status  []                 []              [update patch]</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ì„œë¹„ìŠ¤/íŒŒë“œ ë°°í¬ í…ŒìŠ¤íŠ¸ with NLB - <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/service/nlb/">ë§í¬</a> <a href="https://docs.aws.amazon.com/eks/latest/userguide/network-load-balancing.html">NLB</a></p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod,svc,ep
  
<span class="c"># ì‘ì—…ìš© EC2 - ë””í”Œë¡œì´ë¨¼íŠ¸ &amp; ì„œë¹„ìŠ¤ ìƒì„±</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-O</span> https://raw.githubusercontent.com/gasida/PKOS/main/2/echo-service-nlb.yaml
<span class="nv">$ </span><span class="nb">cat </span>echo-service-nlb.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> echo-service-nlb.yaml
<span class="c"># =&gt; deployment.apps/deploy-echo created</span>
<span class="c">#    service/svc-nlb-ip-type created</span>
  
<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,pod
<span class="c"># =&gt; NAME                          READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/deploy-echo   2/2     2            2           10s</span>
<span class="c">#    </span>
<span class="c">#    NAME                               READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/deploy-echo-857b6cfb88-452cd   1/1     Running   0          10s</span>
<span class="c">#    pod/deploy-echo-857b6cfb88-5xz5j   1/1     Running   0          10s</span>
<span class="nv">$ </span>kubectl get svc,ep,ingressclassparams,targetgroupbindings
<span class="c"># =&gt; NAME                      TYPE           CLUSTER-IP      EXTERNAL-IP                                                                         PORT(S)        AGE</span>
<span class="c">#    service/kubernetes        ClusterIP      10.100.0.1      &amp;lt;none&amp;gt;                                                                              443/TCP        76m</span>
<span class="c">#    service/svc-nlb-ip-type   LoadBalancer   10.100.83.184   k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com   80:30771/TCP   21s</span>
<span class="c">#    </span>
<span class="c">#    NAME                        ENDPOINTS                              AGE</span>
<span class="c">#    endpoints/kubernetes        192.168.1.65:443,192.168.3.189:443     76m</span>
<span class="c">#    endpoints/svc-nlb-ip-type   192.168.1.112:8080,192.168.2.24:8080   21s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                   GROUP-NAME   SCHEME   IP-ADDRESS-TYPE   AGE</span>
<span class="c">#    ingressclassparams.elbv2.k8s.aws/alb                                           3m9s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                               SERVICE-NAME      SERVICE-PORT   TARGET-TYPE   AGE</span>
<span class="c">#    targetgroupbinding.elbv2.k8s.aws/k8s-default-svcnlbip-f58255c318   svc-nlb-ip-type   80             ip            16s</span>
<span class="nv">$ </span>kubectl get targetgroupbindings <span class="nt">-o</span> json | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;apiVersion&amp;quot;: &amp;quot;v1&amp;quot;,</span>
<span class="c">#      &amp;quot;items&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;apiVersion&amp;quot;: &amp;quot;elbv2.k8s.aws/v1beta1&amp;quot;,</span>
<span class="c">#          &amp;quot;kind&amp;quot;: &amp;quot;TargetGroupBinding&amp;quot;,</span>
<span class="c">#          &amp;quot;metadata&amp;quot;: {</span>
<span class="c">#            &amp;quot;annotations&amp;quot;: {</span>
<span class="c">#              &amp;quot;elbv2.k8s.aws/checkpoint&amp;quot;: &amp;quot;gs98wrXMlQMdFGryEbrFbVngcODAXK0Yk4czpOdn9bg/biShKK1OQPD05qA040YQHH29qU6aPNq6J-fRu4M-dKY&amp;quot;,</span>
<span class="c">#              &amp;quot;elbv2.k8s.aws/checkpoint-timestamp&amp;quot;: &amp;quot;1730537287&amp;quot;</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;creationTimestamp&amp;quot;: &amp;quot;2024-10-01T08:48:04Z&amp;quot;,</span>
<span class="c">#            &amp;quot;finalizers&amp;quot;: [</span>
<span class="c">#              &amp;quot;elbv2.k8s.aws/resources&amp;quot;</span>
<span class="c">#            ],</span>
<span class="c">#            &amp;quot;generation&amp;quot;: 1,</span>
<span class="c">#            &amp;quot;labels&amp;quot;: {</span>
<span class="c">#              &amp;quot;service.k8s.aws/stack-name&amp;quot;: &amp;quot;svc-nlb-ip-type&amp;quot;,</span>
<span class="c">#              &amp;quot;service.k8s.aws/stack-namespace&amp;quot;: &amp;quot;default&amp;quot;</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;name&amp;quot;: &amp;quot;k8s-default-svcnlbip-f58255c318&amp;quot;,</span>
<span class="c">#            &amp;quot;namespace&amp;quot;: &amp;quot;default&amp;quot;,</span>
<span class="c">#            &amp;quot;resourceVersion&amp;quot;: &amp;quot;17369&amp;quot;,</span>
<span class="c">#            &amp;quot;uid&amp;quot;: &amp;quot;bdf37bcf-7fab-47ad-8b73-fb97c0239c9a&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;spec&amp;quot;: {</span>
<span class="c">#            &amp;quot;ipAddressType&amp;quot;: &amp;quot;ipv4&amp;quot;,</span>
<span class="c">#            &amp;quot;networking&amp;quot;: {</span>
<span class="c">#              &amp;quot;ingress&amp;quot;: [</span>
<span class="c">#                {</span>
<span class="c">#                  &amp;quot;from&amp;quot;: [</span>
<span class="c">#                    {</span>
<span class="c">#                      &amp;quot;securityGroup&amp;quot;: {</span>
<span class="c">#                        &amp;quot;groupID&amp;quot;: &amp;quot;sg-0a7a0dcdcda95c9fc&amp;quot;</span>
<span class="c">#                      }</span>
<span class="c">#                    }</span>
<span class="c">#                  ],</span>
<span class="c">#                  &amp;quot;ports&amp;quot;: [</span>
<span class="c">#                    {</span>
<span class="c">#                      &amp;quot;port&amp;quot;: 8080,</span>
<span class="c">#                      &amp;quot;protocol&amp;quot;: &amp;quot;TCP&amp;quot;</span>
<span class="c">#                    }</span>
<span class="c">#                  ]</span>
<span class="c">#                }</span>
<span class="c">#              ]</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;serviceRef&amp;quot;: {</span>
<span class="c">#              &amp;quot;name&amp;quot;: &amp;quot;svc-nlb-ip-type&amp;quot;,</span>
<span class="c">#              &amp;quot;port&amp;quot;: 80</span>
<span class="c">#            },</span>
<span class="c">#            &amp;quot;targetGroupARN&amp;quot;: &amp;quot;arn:aws:elasticloadbalancing:ap-northeast-2:123456789012:targetgroup/k8s-default-svcnlbip-f58255c318/0cfa12d6c579f11b&amp;quot;,</span>
<span class="c">#            &amp;quot;targetType&amp;quot;: &amp;quot;ip&amp;quot;,</span>
<span class="c">#            &amp;quot;vpcID&amp;quot;: &amp;quot;vpc-0837921f515624150&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;status&amp;quot;: {</span>
<span class="c">#            &amp;quot;observedGeneration&amp;quot;: 1</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      ],</span>
<span class="c">#      &amp;quot;kind&amp;quot;: &amp;quot;List&amp;quot;,</span>
<span class="c">#      &amp;quot;metadata&amp;quot;: {</span>
<span class="c">#        &amp;quot;resourceVersion&amp;quot;: &amp;quot;&amp;quot;</span>
<span class="c">#      }</span>
<span class="c">#    }</span>
  
<span class="c"># (ì˜µì…˜) ë¹ ë¥¸ ì‹¤ìŠµì„ ìœ„í•´ì„œ ë“±ë¡ ì·¨ì†Œ ì§€ì—°(ë“œë ˆì´ë‹ ê°„ê²©) ìˆ˜ì • : ê¸°ë³¸ê°’ 300ì´ˆ</span>
<span class="nv">$ </span>vi echo-service-nlb.yaml
<span class="nt">---</span>
..
apiVersion: v1
kind: Service
metadata:
  name: svc-nlb-ip-type
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: <span class="s2">"8080"</span>
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: <span class="s2">"true"</span>
    service.beta.kubernetes.io/aws-load-balancer-target-group-attributes: deregistration_delay.timeout_seconds<span class="o">=</span>60
...
:wq!
<span class="nt">---</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> echo-service-nlb.yaml
<span class="c"># =&gt; deployment.apps/deploy-echo unchanged</span>
<span class="c">#    service/svc-nlb-ip-type configured</span>
  
<span class="c"># AWS ELB(NLB) ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>aws elbv2 describe-load-balancers | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;LoadBalancers&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;LoadBalancerArn&amp;quot;: &amp;quot;arn:aws:elasticloadbalancing:ap-northeast-2:123456789012:loadbalancer/net/k8s-default-svcnlbip-50f5d03f41/f28c6aa861a2e815&amp;quot;,</span>
<span class="c">#          &amp;quot;DNSName&amp;quot;: &amp;quot;k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com&amp;quot;,</span>
<span class="c">#          &amp;quot;CanonicalHostedZoneId&amp;quot;: &amp;quot;ZIBE1TIR4HY56&amp;quot;,</span>
<span class="c">#          &amp;quot;CreatedTime&amp;quot;: &amp;quot;2024-10-01T08:48:03.532000+00:00&amp;quot;,</span>
<span class="c">#          &amp;quot;LoadBalancerName&amp;quot;: &amp;quot;k8s-default-svcnlbip-50f5d03f41&amp;quot;,</span>
<span class="c">#          &amp;quot;Scheme&amp;quot;: &amp;quot;internet-facing&amp;quot;,</span>
<span class="c">#          &amp;quot;VpcId&amp;quot;: &amp;quot;vpc-0837921f515624150&amp;quot;,</span>
<span class="c">#          &amp;quot;State&amp;quot;: {</span>
<span class="c">#            &amp;quot;Code&amp;quot;: &amp;quot;provisioning&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;Type&amp;quot;: &amp;quot;network&amp;quot;,</span>
<span class="c">#          &amp;quot;AvailabilityZones&amp;quot;: [</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;ZoneName&amp;quot;: &amp;quot;ap-northeast-2a&amp;quot;,</span>
<span class="c">#              &amp;quot;SubnetId&amp;quot;: &amp;quot;subnet-0a06ed52d587bd707&amp;quot;,</span>
<span class="c">#              &amp;quot;LoadBalancerAddresses&amp;quot;: []</span>
<span class="c">#            },</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;ZoneName&amp;quot;: &amp;quot;ap-northeast-2c&amp;quot;,</span>
<span class="c">#              &amp;quot;SubnetId&amp;quot;: &amp;quot;subnet-03c911c48452b41b2&amp;quot;,</span>
<span class="c">#              &amp;quot;LoadBalancerAddresses&amp;quot;: []</span>
<span class="c">#            },</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;ZoneName&amp;quot;: &amp;quot;ap-northeast-2b&amp;quot;,</span>
<span class="c">#              &amp;quot;SubnetId&amp;quot;: &amp;quot;subnet-00b4dacf7eef35d33&amp;quot;,</span>
<span class="c">#              &amp;quot;LoadBalancerAddresses&amp;quot;: []</span>
<span class="c">#            }</span>
<span class="c">#          ],</span>
<span class="c">#          &amp;quot;SecurityGroups&amp;quot;: [</span>
<span class="c">#            &amp;quot;sg-0a7a0dcdcda95c9fc&amp;quot;,</span>
<span class="c">#            &amp;quot;sg-0e325a379a10ced56&amp;quot;</span>
<span class="c">#          ],</span>
<span class="c">#          &amp;quot;IpAddressType&amp;quot;: &amp;quot;ipv4&amp;quot;,</span>
<span class="c">#          &amp;quot;EnablePrefixForIpv6SourceNat&amp;quot;: &amp;quot;off&amp;quot;</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
<span class="nv">$ </span>aws elbv2 describe-load-balancers <span class="nt">--query</span> <span class="s1">'LoadBalancers[*].State.Code'</span> <span class="nt">--output</span> text
<span class="c"># =&gt; provisioning</span>
<span class="nv">$ ALB_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-load-balancers <span class="nt">--query</span> <span class="s1">'LoadBalancers[?contains(LoadBalancerName, `k8s-default-svcnlbip`) == `true`].LoadBalancerArn'</span> | jq <span class="nt">-r</span> <span class="s1">'.[0]'</span><span class="si">)</span>
<span class="nv">$ </span>aws elbv2 describe-target-groups <span class="nt">--load-balancer-arn</span> <span class="nv">$ALB_ARN</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;TargetGroups&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;TargetGroupArn&amp;quot;: &amp;quot;arn:aws:elasticloadbalancing:ap-northeast-2:123456789012:targetgroup/k8s-default-svcnlbip-f58255c318/0cfa12d6c579f11b&amp;quot;,</span>
<span class="c">#          &amp;quot;TargetGroupName&amp;quot;: &amp;quot;k8s-default-svcnlbip-f58255c318&amp;quot;,</span>
<span class="c">#          &amp;quot;Protocol&amp;quot;: &amp;quot;TCP&amp;quot;,</span>
<span class="c">#          &amp;quot;Port&amp;quot;: 8080,</span>
<span class="c">#          &amp;quot;VpcId&amp;quot;: &amp;quot;vpc-0837921f515624150&amp;quot;,</span>
<span class="c">#          &amp;quot;HealthCheckProtocol&amp;quot;: &amp;quot;TCP&amp;quot;,</span>
<span class="c">#          &amp;quot;HealthCheckPort&amp;quot;: &amp;quot;8080&amp;quot;,</span>
<span class="c">#          &amp;quot;HealthCheckEnabled&amp;quot;: true,</span>
<span class="c">#          &amp;quot;HealthCheckIntervalSeconds&amp;quot;: 10,</span>
<span class="c">#          &amp;quot;HealthCheckTimeoutSeconds&amp;quot;: 10,</span>
<span class="c">#          &amp;quot;HealthyThresholdCount&amp;quot;: 3,</span>
<span class="c">#          &amp;quot;UnhealthyThresholdCount&amp;quot;: 3,</span>
<span class="c">#          &amp;quot;LoadBalancerArns&amp;quot;: [</span>
<span class="c">#            &amp;quot;arn:aws:elasticloadbalancing:ap-northeast-2:123456789012:loadbalancer/net/k8s-default-svcnlbip-50f5d03f41/f28c6aa861a2e815&amp;quot;</span>
<span class="c">#          ],</span>
<span class="c">#          &amp;quot;TargetType&amp;quot;: &amp;quot;ip&amp;quot;,</span>
<span class="c">#          &amp;quot;IpAddressType&amp;quot;: &amp;quot;ipv4&amp;quot;</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
<span class="nv">$ TARGET_GROUP_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-target-groups <span class="nt">--load-balancer-arn</span> <span class="nv">$ALB_ARN</span> | jq <span class="nt">-r</span> <span class="s1">'.TargetGroups[0].TargetGroupArn'</span><span class="si">)</span>
<span class="nv">$ </span>aws elbv2 describe-target-health <span class="nt">--target-group-arn</span> <span class="nv">$TARGET_GROUP_ARN</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;TargetHealthDescriptions&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Target&amp;quot;: {</span>
<span class="c">#            &amp;quot;Id&amp;quot;: &amp;quot;192.168.2.24&amp;quot;,</span>
<span class="c">#            &amp;quot;Port&amp;quot;: 8080,</span>
<span class="c">#            &amp;quot;AvailabilityZone&amp;quot;: &amp;quot;ap-northeast-2b&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;HealthCheckPort&amp;quot;: &amp;quot;8080&amp;quot;,</span>
<span class="c">#          &amp;quot;TargetHealth&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;healthy&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;AdministrativeOverride&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;no_override&amp;quot;,</span>
<span class="c">#            &amp;quot;Reason&amp;quot;: &amp;quot;AdministrativeOverride.NoOverride&amp;quot;,</span>
<span class="c">#            &amp;quot;Description&amp;quot;: &amp;quot;No override is currently active on target&amp;quot;</span>
<span class="c">#          }</span>
<span class="c">#        },</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Target&amp;quot;: {</span>
<span class="c">#            &amp;quot;Id&amp;quot;: &amp;quot;192.168.1.112&amp;quot;,</span>
<span class="c">#            &amp;quot;Port&amp;quot;: 8080,</span>
<span class="c">#            &amp;quot;AvailabilityZone&amp;quot;: &amp;quot;ap-northeast-2a&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;HealthCheckPort&amp;quot;: &amp;quot;8080&amp;quot;,</span>
<span class="c">#          &amp;quot;TargetHealth&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;initial&amp;quot;,</span>
<span class="c">#            &amp;quot;Reason&amp;quot;: &amp;quot;Elb.InitialHealthChecking&amp;quot;,</span>
<span class="c">#            &amp;quot;Description&amp;quot;: &amp;quot;Initial health checks in progress&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;AdministrativeOverride&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;no_override&amp;quot;,</span>
<span class="c">#            &amp;quot;Reason&amp;quot;: &amp;quot;AdministrativeOverride.NoOverride&amp;quot;,</span>
<span class="c">#            &amp;quot;Description&amp;quot;: &amp;quot;No override is currently active on target&amp;quot;</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
  
<span class="c"># ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc svc-nlb-ip-type <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span> | <span class="nb">awk</span> <span class="s1">'{ print "Pod Web URL = http://"$1 }'</span>
<span class="c"># =&gt; Pod Web URL = http://k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com</span>
  
<span class="c"># íŒŒë“œ ë¡œê¹… ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>deploy-websrv <span class="nt">-f</span>
  
<span class="c"># ë¶„ì‚° ì ‘ì† í™•ì¸</span>
<span class="nv">$ NLB</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-nlb-ip-type <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span>
<span class="c"># =&gt; Hostname: deploy-echo-857b6cfb88-5xz5j</span>
<span class="c">#    </span>
<span class="c">#    Pod Information:</span>
<span class="c">#     -no pod information available-</span>
<span class="c">#    </span>
<span class="c">#    Server values:</span>
<span class="c">#     server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#    </span>
<span class="c">#    Request Information:</span>
<span class="c">#     client_address=192.168.3.171</span>
<span class="c">#     method=GET</span>
<span class="c">#     real path=/</span>
<span class="c">#     query=</span>
<span class="c">#     request_version=1.1</span>
<span class="c">#     request_uri=http://k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com:8080/</span>
<span class="c">#    </span>
<span class="c">#    Request Headers:</span>
<span class="c">#     accept=*/*</span>
<span class="c">#     host=k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com</span>
<span class="c">#     user-agent=curl/8.3.0</span>
<span class="c">#    </span>
<span class="c">#    Request Body:</span>
<span class="c">#     -no body in request-</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span> | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt; 52 Hostname: deploy-echo-857b6cfb88-452cd</span>
<span class="c">#    48 Hostname: deploy-echo-857b6cfb88-5xz5j</span>
  
<span class="c"># ì§€ì†ì ì¸ ì ‘ì† ì‹œë„ : ì•„ë˜ ìƒì„¸ ë™ì‘ í™•ì¸ ì‹œ ìœ ìš©(íŒ¨í‚· ë¤í”„ ë“±)</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$NLB</span> | egrep <span class="s1">'Hostname|client_address'</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"----------"</span> <span class="p">;</span> <span class="nb">date</span> <span class="s2">"+%Y-%m-%d %H:%M:%S"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Hostname: deploy-echo-857b6cfb88-5xz5j</span>
<span class="c">#     client_address=192.168.1.39</span>
<span class="c">#    ----------</span>
<span class="c">#    2024-10-01 17:52:08</span>
<span class="c">#    Hostname: deploy-echo-857b6cfb88-452cd</span>
<span class="c">#     client_address=192.168.3.171</span>
<span class="c">#    ----------</span>
<span class="c">#    2024-10-01 17:52:09</span>
<span class="c">#    Hostname: deploy-echo-857b6cfb88-5xz5j</span>
<span class="c">#     client_address=192.168.1.39</span>
<span class="c">#    ----------</span>
<span class="c">#    2024-10-01 17:52:10</span>
<span class="c">#    Hostname: deploy-echo-857b6cfb88-452cd</span>
<span class="c">#     client_address=192.168.3.171</span>
<span class="c">#    ...</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>íŒŒë“œ 2ê°œ â†’ 1ê°œ â†’ 3ê°œ ì„¤ì • ì‹œ ë™ì‘ì„ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤. íŒŒë“œì˜ IPê°€ auto discoveryë˜ëŠ”ë° ì´ê²ƒì€ serviceì— ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ë¥¼ ì‚¬ìš©í•œ ê²ƒì…ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># (ì‹ ê·œ í„°ë¯¸ë„) ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws elbv2 describe-target-health <span class="nt">--target-group-arn</span> <span class="nv">$TARGET_GROUP_ARN</span> <span class="nt">--output</span> text<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; TARGETHEALTHDESCRIPTIONS 8080</span>
<span class="c">#    ADMINISTRATIVEOVERRIDE No override is currently active on target AdministrativeOverride.NoOverride no_override</span>
<span class="c">#    TARGET ap-northeast-2b 192.168.2.24  8080</span>
<span class="c">#    TARGETHEALTH healthy</span>
<span class="c">#    TARGETHEALTHDESCRIPTIONS 8080</span>
<span class="c">#    ADMINISTRATIVEOVERRIDE No override is currently active on target AdministrativeOverride.NoOverride no_override</span>
<span class="c">#    TARGET ap-northeast-2a 192.168.1.112 8080</span>
<span class="c">#    TARGETHEALTH healthy</span>
<span class="c">#    ...</span>
    
<span class="c"># ì‘ì—…ìš© EC2 - íŒŒë“œ 1ê°œ ì„¤ì • </span>
<span class="nv">$ </span>kubectl scale deployment deploy-echo <span class="nt">--replicas</span><span class="o">=</span>1
    
<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep
<span class="c"># =&gt; NAME                          READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/deploy-echo   1/1     1            1           6m34s</span>
<span class="c">#    </span>
<span class="c">#    NAME                               READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/deploy-echo-857b6cfb88-452cd   1/1     Running   0          6m34s</span>
<span class="c">#    </span>
<span class="c">#    NAME                      TYPE           CLUSTER-IP      EXTERNAL-IP                                                                         PORT(S)        AGE</span>
<span class="c">#    service/kubernetes        ClusterIP      10.100.0.1      &amp;lt;none&amp;gt;                                                                              443/TCP        82m</span>
<span class="c">#    service/svc-nlb-ip-type   LoadBalancer   10.100.83.184   k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com   80:30771/TCP   6m34s</span>
<span class="c">#    </span>
<span class="c">#    NAME                        ENDPOINTS                            AGE</span>
<span class="c">#    endpoints/kubernetes        192.168.1.65:443,192.168.3.189:443   82m</span>
<span class="c">#    endpoints/svc-nlb-ip-type   192.168.2.24:8080                    6m34s</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span>
<span class="c"># =&gt; Hostname: deploy-echo-857b6cfb88-452cd</span>
<span class="c">#    </span>
<span class="c">#    Pod Information:</span>
<span class="c">#     -no pod information available-</span>
<span class="c">#    </span>
<span class="c">#    Server values:</span>
<span class="c">#     server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#    </span>
<span class="c">#    Request Information:</span>
<span class="c">#     client_address=192.168.3.171</span>
<span class="c">#     method=GET</span>
<span class="c">#     real path=/</span>
<span class="c">#     query=</span>
<span class="c">#     request_version=1.1</span>
<span class="c">#     request_uri=http://k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com:8080/</span>
<span class="c">#    </span>
<span class="c">#    Request Headers:</span>
<span class="c">#     accept=*/*</span>
<span class="c">#     host=k8s-default-svcnlbip-50f5d03f41-f28c6aa861a2e815.elb.ap-northeast-2.amazonaws.com</span>
<span class="c">#     user-agent=curl/8.3.0</span>
<span class="c">#    </span>
<span class="c">#    Request Body:</span>
<span class="c">#     -no body in request-</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$NLB</span> | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;     100 Hostname: deploy-echo-857b6cfb88-452cd</span>
    
<span class="c"># ì‘ì—…ìš© EC2 - íŒŒë“œ 3ê°œ ì„¤ì • </span>
<span class="nv">$ </span>kubectl scale deployment deploy-echo <span class="nt">--replicas</span><span class="o">=</span>3
<span class="c"># =&gt; deployment.apps/deploy-echo scaled</span>
    
<span class="c"># í™•ì¸ : NLB ëŒ€ìƒ íƒ€ì¼“ì´ ì•„ì§ initial ì¼ ë•Œ 100ë²ˆ ë°˜ë³µ ì ‘ì† ì‹œ ì–´ë–»ê²Œ ë˜ëŠ”ì§€ í™•ì¸í•´ë³´ì!</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep
<span class="c"># =&gt; NAME                          READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/deploy-echo   3/3     3            3           7m41s</span>
<span class="c">#    </span>
<span class="c">#    NAME                               READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    ...</span>
<span class="c">#    pod/deploy-echo-857b6cfb88-8wn7b   1/1     Running   0          10s</span>
<span class="c">#    pod/deploy-echo-857b6cfb88-qhqbt   1/1     Running   0          10s</span>
<span class="c">#    </span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAME                        ENDPOINTS                                                 AGE</span>
<span class="c">#    ...</span>
<span class="c">#    endpoints/svc-nlb-ip-type   192.168.1.161:8080,192.168.2.24:8080,192.168.3.241:8080   7m41s</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$NLB</span> | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      37 Hostname: deploy-echo-857b6cfb88-452cd</span>
<span class="c">#         33 Hostname: deploy-echo-857b6cfb88-8wn7b</span>
<span class="c">#         30 Hostname: deploy-echo-857b6cfb88-qhqbt</span>
    
<span class="c"># </span>
<span class="nv">$ </span>kubectl describe deploy <span class="nt">-n</span> kube-system aws-load-balancer-controller | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s1">'Service Account'</span>
<span class="c"># =&gt;   Service Account:  aws-load-balancer-controller</span>
    
<span class="c"># [AWS LB Ctrl] í´ëŸ¬ìŠ¤í„° ë¡¤ ë°”ì¸ë”© ì •ë³´ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe clusterrolebindings.rbac.authorization.k8s.io aws-load-balancer-controller-rolebinding
    
<span class="c"># [AWS LB Ctrl] í´ëŸ¬ìŠ¤í„°ë¡¤ í™•ì¸ </span>
<span class="nv">$ </span>kubectl describe clusterroles.rbac.authorization.k8s.io aws-load-balancer-controller-role
</code></pre></div>    </div>

    <ul>
      <li>ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ:  <code class="language-plaintext highlighter-rouge">kubectl delete deploy deploy-echo; kubectl delete svc svc-nlb-ip-type</code>
</li>
    </ul>
  </li>
  <li>
<strong>(ì‹¬í™”) Pod readiness gate</strong> : ALB/NLB ëŒ€ìƒ(ip mode)ì´ ALB/NLBì˜ í—¬ìŠ¤ì²´í¬ì— ì˜í•´ ì •ìƒì¼ ê²½ìš° í•´ë‹¹ íŒŒë“œë¡œ ì „ë‹¬í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. - <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.7/deploy/pod_readiness_gate/">Link</a> <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-readiness-gate">K8S</a>
    <ul>
      <li>
        <p>ì‚¬ì „ ì¤€ë¹„</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># ë°”ë¡œ ìœ„ì—ì„œ ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œí–ˆë‹¤ë©´, ë‹¤ì‹œ ìƒì„± : deregistration_delay.timeout_seconds=60 í™•ì¸</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> echo-service-nlb.yaml
<span class="c"># =&gt; deployment.apps/deploy-echo created</span>
<span class="c">#    service/svc-nlb-ip-type created</span>
<span class="nv">$ </span>kubectl scale deployment deploy-echo <span class="nt">--replicas</span><span class="o">=</span>1
<span class="c"># =&gt; deployment.apps/deploy-echo scaled</span>
    
<span class="c">#</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                           READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES</span>
<span class="c">#    deploy-echo-857b6cfb88-sx8lg   1/1     Running   0          14m   192.168.3.124   ip-192-168-3-235.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
    
<span class="c"># mutatingwebhookconfigurations í™•ì¸ : mutating ëŒ€ìƒ(ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì•„ë˜ ë§¤ì¹­ ì‹œ)</span>
<span class="nv">$ </span>kubectl get mutatingwebhookconfigurations
<span class="c"># =&gt; NAME                            WEBHOOKS   AGE</span>
<span class="c">#    aws-load-balancer-webhook       3          28m</span>
<span class="c">#    pod-identity-webhook            1          102m</span>
<span class="c">#    vpc-resource-mutating-webhook   1          102m</span>
<span class="nv">$ </span>kubectl get mutatingwebhookconfigurations aws-load-balancer-webhook <span class="nt">-o</span> yaml | kubectl neat
<span class="c"># =&gt; ...</span>
<span class="c">#      name: mpod.elbv2.k8s.aws</span>
<span class="c">#      namespaceSelector:</span>
<span class="c">#        matchExpressions:</span>
<span class="c">#        - key: elbv2.k8s.aws/pod-readiness-gate-inject</span>
<span class="c">#          operator: In</span>
<span class="c">#          values:</span>
<span class="c">#          - enabled</span>
<span class="c">#      objectSelector:</span>
<span class="c">#        matchExpressions:</span>
<span class="c">#        - key: app.kubernetes.io/name</span>
<span class="c">#          operator: NotIn</span>
<span class="c">#          values:</span>
<span class="c">#          - aws-load-balancer-controller</span>
<span class="c">#    ...</span>
    
<span class="c"># í˜„ì¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get ns <span class="nt">--show-labels</span>
<span class="c"># =&gt; NAME              STATUS   AGE    LABELS</span>
<span class="c">#    default           Active   103m   kubernetes.io/metadata.name=default</span>
<span class="c">#    kube-node-lease   Active   103m   kubernetes.io/metadata.name=kube-node-lease</span>
<span class="c">#    kube-public       Active   103m   kubernetes.io/metadata.name=kube-public</span>
<span class="c">#    kube-system       Active   103m   kubernetes.io/metadata.name=kube-system</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì„¤ì • ë° í™•ì¸</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># (í„°ë¯¸ë„ ê°ê° 2ê°œ) ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ ALB_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-load-balancers <span class="nt">--query</span> <span class="s1">'LoadBalancers[?contains(LoadBalancerName, `k8s-default-svcnlbip`) == `true`].LoadBalancerArn'</span> | jq <span class="nt">-r</span> <span class="s1">'.[0]'</span><span class="si">)</span>
<span class="nv">$ TARGET_GROUP_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-target-groups <span class="nt">--load-balancer-arn</span> <span class="nv">$ALB_ARN</span> | jq <span class="nt">-r</span> <span class="s1">'.TargetGroups[0].TargetGroupArn'</span><span class="si">)</span>
    
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod,svc,ep <span class="nt">-owide</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws elbv2 describe-target-health <span class="nt">--target-group-arn</span> <span class="nv">$TARGET_GROUP_ARN</span> <span class="nt">--output</span> text<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
    
<span class="c">#</span>
<span class="nv">$ </span>kubectl label namespace default elbv2.k8s.aws/pod-readiness-gate-inject<span class="o">=</span>enabled
<span class="c"># =&gt; namespace/default labeled</span>
<span class="nv">$ </span>kubectl get ns <span class="nt">--show-labels</span>
<span class="c"># =&gt; NAME              STATUS   AGE    LABELS</span>
<span class="c">#    default           Active   108m   elbv2.k8s.aws/pod-readiness-gate-inject=enabled,kubernetes.io/metadata.name=default</span>
<span class="c">#    kube-node-lease   Active   108m   kubernetes.io/metadata.name=kube-node-lease</span>
<span class="c">#    kube-public       Active   108m   kubernetes.io/metadata.name=kube-public</span>
<span class="c">#    kube-system       Active   108m   kubernetes.io/metadata.name=kube-system</span>
    
<span class="c"># READINESS GATES í•­ëª© ì¶”ê°€ í™•ì¸</span>
<span class="nv">$ </span>kubectl describe pod
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                           READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES</span>
<span class="c">#    deploy-echo-857b6cfb88-sx8lg   1/1     Running   0          20m   192.168.3.124   ip-192-168-3-235.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
    
<span class="c">#</span>
<span class="nv">$ </span>kubectl delete pod <span class="nt">--all</span>
<span class="c"># =&gt; pod &amp;quot;deploy-echo-857b6cfb88-sx8lg&amp;quot; deleted</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                           READY   STATUS    RESTARTS   AGE   IP             NODE                                              NOMINATED NODE   READINESS GATES</span>
<span class="c">#    deploy-echo-857b6cfb88-njwdj   1/1     Running   0          54s   192.168.2.18   ip-192-168-2-92.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           1/1</span>
    
<span class="nv">$ </span>kubectl describe pod
<span class="c"># =&gt; ...</span>
<span class="c">#    Readiness Gates:</span>
<span class="c">#      Type                                                          Status</span>
<span class="c">#      target-health.elbv2.k8s.aws/k8s-default-svcnlbip-2e5acb9719   True</span>
<span class="c">#    Conditions:</span>
<span class="c">#      Type                                                          Status</span>
<span class="c">#      target-health.elbv2.k8s.aws/k8s-default-svcnlbip-2e5acb9719   True</span>
<span class="c">#      PodReadyToStartContainers                                     True</span>
<span class="c">#      Initialized                                                   True</span>
<span class="c">#      Ready                                                         True</span>
<span class="c">#      ContainersReady                                               True</span>
<span class="c">#      PodScheduled                                                  True</span>
<span class="c">#      ...</span>
    
<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> yaml | yh
<span class="c"># =&gt; ...</span>
<span class="c">#        readinessGates:</span>
<span class="c">#        - conditionType: target-health.elbv2.k8s.aws/k8s-default-svcnlbip-2e5acb9719</span>
<span class="c">#    ...</span>
<span class="c">#      status:</span>
<span class="c">#        conditions:</span>
<span class="c">#        - lastProbeTime: null</span>
<span class="c">#          lastTransitionTime: &amp;quot;2024-10-01T09:21:28Z&amp;quot;</span>
<span class="c">#          status: &amp;quot;True&amp;quot;</span>
<span class="c">#          type: target-health.elbv2.k8s.aws/k8s-default-svcnlbip-2e5acb9719</span>
<span class="c">#    ...</span>
    
<span class="c"># ë¶„ì‚° ì ‘ì† í™•ì¸</span>
<span class="nv">$ NLB</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-nlb-ip-type <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span>
<span class="c"># =&gt; Hostname: deploy-echo-857b6cfb88-njwdj</span>
<span class="c">#    </span>
<span class="c">#    Pod Information:</span>
<span class="c">#     -no pod information available-</span>
<span class="c">#    </span>
<span class="c">#    Server values:</span>
<span class="c">#     server_version=nginx: 1.13.0 - lua: 10008</span>
<span class="c">#    </span>
<span class="c">#    Request Information:</span>
<span class="c">#     client_address=192.168.3.71</span>
<span class="c">#     method=GET</span>
<span class="c">#     real path=/</span>
<span class="c">#     query=</span>
<span class="c">#     request_version=1.1</span>
<span class="c">#     request_uri=http://k8s-default-svcnlbip-f4c21d9697-0d3512de2bf74357.elb.ap-northeast-2.amazonaws.com:8080/</span>
<span class="c">#    </span>
<span class="c">#    Request Headers:</span>
<span class="c">#     accept=*/*</span>
<span class="c">#     host=k8s-default-svcnlbip-f4c21d9697-0d3512de2bf74357.elb.ap-northeast-2.amazonaws.com</span>
<span class="c">#     user-agent=curl/8.3.0</span>
<span class="c">#    </span>
<span class="c">#    Request Body:</span>
<span class="c">#     -no body in request-</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span> | <span class="nb">grep </span>Hostname <span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;     100 Hostname: deploy-echo-857b6cfb88-njwdj</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ:  <code class="language-plaintext highlighter-rouge">kubectl delete deploy deploy-echo; kubectl delete svc svc-nlb-ip-type</code></p>
      </li>
    </ul>
  </li>
  <li>NLB ëŒ€ìƒ íƒ€ì¼“ì„ <strong>Instance mode</strong> ë¡œ ì„¤ì •í•´ë³´ê¸°
    <ul>
      <li>ë‹¤ìŒ ë§í¬ì—ì„œ í™•ì¸í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<a href="https://www.notion.so/AWS-NLB-Client-IP-Proxy-protocol-57827e2c83fc474992b37e65db81f669?pvs=21">AWS NLB - Client IP í™•ì¸ &amp; Proxy protocol</a>
</li>
    </ul>
  </li>
  <li>
    <p>NLB IP Target &amp; <strong>Proxy Protocol v2</strong> í™œì„±í™” : NLBì—ì„œ ë°”ë¡œ íŒŒë“œë¡œ ì¸ì… ë° ClientIP í™•ì¸ ì„¤ì • - <a href="https://www.notion.so/AWS-NLB-Client-IP-Proxy-protocol-57827e2c83fc474992b37e65db81f669?pvs=21">ë§í¬</a> <a href="https://hub.docker.com/r/gasida/httpd/tags">image</a> <a href="https://canaryrelease.tistory.com/42">ì°¸ê³ </a></p>

    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_25.png" alt="img_9.png" class="image-center w-90" loading="lazy" width="751" height="671"></p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ìƒì„±</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gasida-web
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gasida-web
  template:
    metadata:
      labels:
        app: gasida-web
    spec:
      terminationGracePeriodSeconds: 0
      containers:
      - name: gasida-web
        image: sweetlittlebird/httpd:pp
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: svc-nlb-ip-type-pp
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: "*"
spec:
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
  type: LoadBalancer
  loadBalancerClass: service.k8s.aws/nlb
  selector:
    app: gasida-web
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/gasida-web created</span>
<span class="c">#    service/svc-nlb-ip-type-pp created</span>

<span class="c"># apacheì— proxy protocol í™œì„±í™” í™•ì¸</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>deploy/gasida-web <span class="nt">--</span> apachectl <span class="nt">-t</span> <span class="nt">-D</span> DUMP_MODULES
<span class="c"># =&gt; Loaded Modules:</span>
<span class="c">#     ...</span>
<span class="c">#     remoteip_module (shared)</span>
<span class="c">#     ...</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>deploy/gasida-web <span class="nt">--</span> <span class="nb">cat</span> /usr/local/apache2/conf/httpd.conf
<span class="c"># =&gt; ...</span>
<span class="c">#    RemoteIPProxyProtocol On</span>
<span class="c">#    ...</span>

<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc,ep
<span class="c"># =&gt; NAME                         TYPE           CLUSTER-IP       EXTERNAL-IP                                                                         PORT(S)        AGE</span>
<span class="c">#    service/kubernetes           ClusterIP      10.100.0.1       &amp;lt;none&amp;gt;                                                                              443/TCP        5h52m</span>
<span class="c">#    service/svc-nlb-ip-type-pp   LoadBalancer   10.100.160.172   k8s-default-svcnlbip-c11e4bd02e-ec82d8f688f176d3.elb.ap-northeast-2.amazonaws.com   80:31348/TCP   36m</span>
<span class="c">#    </span>
<span class="c">#    NAME                           ENDPOINTS                            AGE</span>
<span class="c">#    endpoints/kubernetes           192.168.1.65:443,192.168.3.189:443   5h52m</span>
<span class="c">#    endpoints/svc-nlb-ip-type-pp   192.168.2.51:80                      36m</span>
<span class="nv">$ </span>kubectl describe svc svc-nlb-ip-type-pp
<span class="nv">$ </span>kubectl describe svc svc-nlb-ip-type-pp | <span class="nb">grep </span>Annotations: <span class="nt">-A5</span>
<span class="c"># =&gt; Annotations: service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: true</span>
<span class="c">#                 service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip   # &lt;span style="color: green;"&gt;ğŸ‘‰ NLB Target Typeì´ IPì…ë‹ˆë‹¤.&lt;/span&gt;</span>
<span class="c">#                 service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: *</span>
<span class="c">#                 service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing</span>
<span class="c">#    Selector:    app=gasida-web</span>
<span class="c">#    Type:        LoadBalancer</span>

<span class="c"># ì ‘ì† í™•ì¸</span>
<span class="nv">$ NLB</span><span class="o">=</span><span class="si">$(</span>kubectl get svc svc-nlb-ip-type-pp <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$NLB</span>
<span class="c"># =&gt; &amp;lt;html&amp;gt;&amp;lt;body&amp;gt;&amp;lt;h1&amp;gt;It works!&amp;lt;/h1&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;</span>

<span class="c"># ì§€ì†ì ì¸ ì ‘ì† ì‹œë„ : ì•„ë˜ ìƒì„¸ ë™ì‘ í™•ì¸ ì‹œ ìœ ìš©(íŒ¨í‚· ë¤í”„ ë“±)</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$NLB</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"----------"</span> <span class="p">;</span> <span class="nb">date</span> <span class="s2">"+%Y-%m-%d %H:%M:%S"</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>

<span class="c"># ë² ìŠ¤ì³” í˜¸ìŠ¤íŠ¸ IP í™•ì¸</span>
<span class="nv">$ </span>curl ipinfo.io/ip
<span class="c"># =&gt; 3.35.140.75</span>

<span class="c"># ë¡œê·¸ í™•ì¸</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>gasida-web <span class="nt">-f</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    3.35.140.75 - - [01/Oct/2024:13:46:35 +0000] &amp;quot;GET / HTTP/1.1&amp;quot; 200 45</span>
<span class="c">#    3.35.140.75 - - [01/Oct/2024:13:46:36 +0000] &amp;quot;GET / HTTP/1.1&amp;quot; 200 45</span>
<span class="c">#    3.35.140.75 - - [01/Oct/2024:13:46:37 +0000] &amp;quot;GET / HTTP/1.1&amp;quot; 200 45</span>
<span class="c">#    3.35.140.75 - - [01/Oct/2024:13:46:38 +0000] &amp;quot;GET / HTTP/1.1&amp;quot; 200 45</span>

<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ proxy protocolì„ í†µí•´ ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ì˜ IPê°€ ì „ë‹¬ë˜ì–´ ë¡œê·¸ì— ë‚¨ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.&lt;/span&gt;</span>

<span class="c"># ì‚­ì œ</span>
<span class="nv">$ </span>kubectl delete deploy gasida-web<span class="p">;</span> kubectl delete svc svc-nlb-ip-type-pp
</code></pre></div></div>

<hr>

<h3 id="ingress">Ingress</h3>

<ul>
  <li>IngressëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ì„œë¹„ìŠ¤(ClusterIP, NodePort, Loadbalancer)ë¥¼ ì™¸ë¶€ë¡œ ë…¸ì¶œ(<strong>HTTP/HTTPS</strong>)ì‹œí‚¤ëŠ” ì¼ì¢…ì˜ Web Proxy ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</li>
</ul>

<h4 id="aws-load-balancer-controller--ingress-alb-ip-ëª¨ë“œ-ë™ì‘-with-aws-vpc-cni">
<strong>AWS Load Balancer Controller</strong> + <strong>Ingress (ALB) IP ëª¨ë“œ</strong> ë™ì‘ with <strong>AWS VPC CNI</strong>
</h4>

<p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_11.png" alt="img.png" class="image-center w-90" loading="lazy" width="1136" height="411"></p>

<ul>
  <li>
    <p>ì„œë¹„ìŠ¤/íŒŒë“œ ë°°í¬ í…ŒìŠ¤íŠ¸ with Ingress(ALB) - <a href="https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html">ALB</a></p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># ê²Œì„ íŒŒë“œì™€ Service, Ingress ë°°í¬</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-O</span> https://raw.githubusercontent.com/gasida/PKOS/main/3/ingress1.yaml
<span class="nv">$ </span><span class="nb">cat </span>ingress1.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> ingress1.yaml
<span class="c"># =&gt; namespace/game-2048 created</span>
<span class="c">#    deployment.apps/deployment-2048 created</span>
<span class="c">#    service/service-2048 created</span>
<span class="c">#    ingress.networking.k8s.io/ingress-2048 created</span>
  
<span class="c"># ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod,ingress,svc,ep <span class="nt">-n</span> game-2048
  
<span class="c"># ìƒì„± í™•ì¸</span>
<span class="nv">$ </span>kubectl get-all <span class="nt">-n</span> game-2048
<span class="c"># =&gt; NAME                                                               NAMESPACE  AGE</span>
<span class="c">#    configmap/kube-root-ca.crt                                         game-2048  38s</span>
<span class="c">#    endpoints/service-2048                                             game-2048  38s</span>
<span class="c">#    pod/deployment-2048-85f8c7d69-gz295                                game-2048  38s</span>
<span class="c">#    pod/deployment-2048-85f8c7d69-t2blb                                game-2048  38s</span>
<span class="c">#    serviceaccount/default                                             game-2048  38s</span>
<span class="c">#    service/service-2048                                               game-2048  38s</span>
<span class="c">#    deployment.apps/deployment-2048                                    game-2048  38s</span>
<span class="c">#    replicaset.apps/deployment-2048-85f8c7d69                          game-2048  38s</span>
<span class="c">#    endpointslice.discovery.k8s.io/service-2048-s58q4                  game-2048  38s</span>
<span class="c">#    targetgroupbinding.elbv2.k8s.aws/k8s-game2048-service2-00c3b27023  game-2048  34s</span>
<span class="c">#    ingress.networking.k8s.io/ingress-2048                             game-2048  38s</span>
<span class="nv">$ </span>kubectl get ingress,svc,ep,pod <span class="nt">-n</span> game-2048
<span class="c"># =&gt; NAME                                     CLASS   HOSTS   ADDRESS                                                                       PORTS   AGE</span>
<span class="c">#    ingress.networking.k8s.io/ingress-2048   alb     *       k8s-game2048-ingress2-70d50ce3fd-333540411.ap-northeast-2.elb.amazonaws.com   80      49s</span>
<span class="c">#    </span>
<span class="c">#    NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/service-2048   NodePort   10.100.41.151   &amp;lt;none&amp;gt;        80:32522/TCP   49s</span>
<span class="c">#    </span>
<span class="c">#    NAME                     ENDPOINTS                          AGE</span>
<span class="c">#    endpoints/service-2048   192.168.1.112:80,192.168.2.18:80   49s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                  READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/deployment-2048-85f8c7d69-gz295   1/1     Running   0          49s</span>
<span class="c">#    pod/deployment-2048-85f8c7d69-t2blb   1/1     Running   0          49s</span>
<span class="nv">$ </span>kubectl get targetgroupbindings <span class="nt">-n</span> game-2048
<span class="c"># =&gt; NAME                               SERVICE-NAME   SERVICE-PORT   TARGET-TYPE   AGE</span>
<span class="c">#    k8s-game2048-service2-00c3b27023   service-2048   80             ip            56s</span>
  
<span class="c"># ALB ìƒì„± í™•ì¸</span>
<span class="nv">$ </span>aws elbv2 describe-load-balancers <span class="nt">--query</span> <span class="s1">'LoadBalancers[?contains(LoadBalancerName, `k8s-game2048`) == `true`]'</span> | jq
<span class="nv">$ ALB_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-load-balancers <span class="nt">--query</span> <span class="s1">'LoadBalancers[?contains(LoadBalancerName, `k8s-game2048`) == `true`].LoadBalancerArn'</span> | jq <span class="nt">-r</span> <span class="s1">'.[0]'</span><span class="si">)</span>
<span class="nv">$ </span>aws elbv2 describe-target-groups <span class="nt">--load-balancer-arn</span> <span class="nv">$ALB_ARN</span>
<span class="nv">$ TARGET_GROUP_ARN</span><span class="o">=</span><span class="si">$(</span>aws elbv2 describe-target-groups <span class="nt">--load-balancer-arn</span> <span class="nv">$ALB_ARN</span> | jq <span class="nt">-r</span> <span class="s1">'.TargetGroups[0].TargetGroupArn'</span><span class="si">)</span>
<span class="nv">$ </span>aws elbv2 describe-target-health <span class="nt">--target-group-arn</span> <span class="nv">$TARGET_GROUP_ARN</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;TargetHealthDescriptions&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Target&amp;quot;: {</span>
<span class="c">#            &amp;quot;Id&amp;quot;: &amp;quot;192.168.1.112&amp;quot;,</span>
<span class="c">#            &amp;quot;Port&amp;quot;: 80,</span>
<span class="c">#            &amp;quot;AvailabilityZone&amp;quot;: &amp;quot;ap-northeast-2a&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;HealthCheckPort&amp;quot;: &amp;quot;80&amp;quot;,</span>
<span class="c">#          &amp;quot;TargetHealth&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;healthy&amp;quot;</span>
<span class="c">#          }</span>
<span class="c">#        },</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Target&amp;quot;: {</span>
<span class="c">#            &amp;quot;Id&amp;quot;: &amp;quot;192.168.2.18&amp;quot;,</span>
<span class="c">#            &amp;quot;Port&amp;quot;: 80,</span>
<span class="c">#            &amp;quot;AvailabilityZone&amp;quot;: &amp;quot;ap-northeast-2b&amp;quot;</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;HealthCheckPort&amp;quot;: &amp;quot;80&amp;quot;,</span>
<span class="c">#          &amp;quot;TargetHealth&amp;quot;: {</span>
<span class="c">#            &amp;quot;State&amp;quot;: &amp;quot;healthy&amp;quot;</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
  
<span class="c"># Ingress í™•ì¸</span>
<span class="nv">$ </span>kubectl describe ingress <span class="nt">-n</span> game-2048 ingress-2048
<span class="nv">$ </span>kubectl get ingress <span class="nt">-n</span> game-2048 ingress-2048 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.loadBalancer.ingress[*].hostname}{'</span><span class="se">\n</span><span class="s2">'}"</span>
<span class="c"># =&gt; k8s-game2048-ingress2-70d50ce3fd-333540411.ap-northeast-2.elb.amazonaws.com</span>
  
<span class="c"># ê²Œì„ ì ‘ì† : ALB ì£¼ì†Œë¡œ ì›¹ ì ‘ì†</span>
<span class="nv">$ </span>kubectl get ingress <span class="nt">-n</span> game-2048 ingress-2048 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress[0].hostname<span class="o">}</span> | <span class="nb">awk</span> <span class="s1">'{ print "Game URL = http://"$1 }'</span>
<span class="c"># =&gt; Game URL = http://k8s-game2048-ingress2-70d50ce3fd-333540411.ap-northeast-2.elb.amazonaws.com</span>
  
<span class="c"># íŒŒë“œ IP í™•ì¸</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> game-2048 <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                              READY   STATUS    RESTARTS   AGE     IP              NODE                                               NOMINATED NODE   READINESS GATES</span>
<span class="c">#    deployment-2048-85f8c7d69-gz295   1/1     Running   0          3m42s   192.168.2.18    ip-192-168-2-92.ap-northeast-2.compute.internal    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    deployment-2048-85f8c7d69-t2blb   1/1     Running   0          3m42s   192.168.1.112   ip-192-168-1-186.ap-northeast-2.compute.internal   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
</code></pre></div>    </div>
    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_31.png" alt="img.png" loading="lazy" width="951" height="1027"></p>

    <ul>
      <li>
        <p><strong>ALB ëŒ€ìƒ ê·¸ë£¹</strong>ì— ë“±ë¡ëœ ëŒ€ìƒ í™•ì¸ : ALBì—ì„œ íŒŒë“œ IPë¡œ ì§ì ‘ ì „ë‹¬</p>

        <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_32.png" alt="img.png" class="image-center" loading="lazy" width="1561" height="880">
<em class="image-caption">íŒŒë“œ IPë¡œ ë°”ë¡œ ì§ì ‘ ì—°ê²°ëœ ALB ëŒ€ìƒ ê·¸ë£¹</em></p>
      </li>
      <li>
        <p>íŒŒë“œ 3ê°œë¡œ ì¦ê°€</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„1</span>
<span class="nv">$ </span>watch kubectl get pod <span class="nt">-n</span> game-2048
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws elbv2 describe-target-health <span class="nt">--target-group-arn</span> <span class="nv">$TARGET_GROUP_ARN</span> <span class="nt">--output</span> text<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
    
<span class="c"># í„°ë¯¸ë„2 : íŒŒë“œ 3ê°œë¡œ ì¦ê°€</span>
<span class="nv">$ </span>kubectl scale deployment <span class="nt">-n</span> game-2048 deployment-2048 <span class="nt">--replicas</span> 3
<span class="c"># =&gt; deployment.apps/deployment-2048 scaled</span>
</code></pre></div>        </div>
        <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_33.png" alt="img.png" class="image-center" loading="lazy" width="1551" height="560">
<em class="image-caption">ì¶”ê°€ëœ íŒŒë“œ IPê°€ ì—°ê²°ë¨</em></p>
      </li>
      <li>
        <p>íŒŒë“œ 1ê°œë¡œ ê°ì†Œ</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„2 : íŒŒë“œ 1ê°œë¡œ ê°ì†Œ</span>
<span class="nv">$ </span>kubectl scale deployment <span class="nt">-n</span> game-2048 deployment-2048 <span class="nt">--replicas</span> 1
<span class="c"># =&gt; deployment.apps/deployment-2048 scaled</span>
</code></pre></div>        </div>

        <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_34.png" alt="img.png" class="image-center" loading="lazy" width="1539" height="737">
<em class="image-caption">ì‚­ì œë˜ëŠ” 2ê°œì˜ íŒŒë“œê°€ ì‚­ì œ ì¤‘ì„ì„ í™•ì¸</em></p>
      </li>
      <li>
        <p>ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤  ì‚­ì œ</p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete ingress ingress-2048 <span class="nt">-n</span> game-2048
<span class="nv">$ </span>kubectl delete svc service-2048 <span class="nt">-n</span> game-2048 <span class="o">&amp;&amp;</span> kubectl delete deploy deployment-2048 <span class="nt">-n</span> game-2048 <span class="o">&amp;&amp;</span> kubectl delete ns game-2048
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h4 id="kubernetes-ì‘ìš©í”„ë¡œê·¸ë¨ì„-ì™¸ë¶€ë¡œ-ë…¸ì¶œ-ì‹œí‚¤ëŠ”-ë°©ë²•ë“¤-ë¹„êµ">Kubernetes ì‘ìš©í”„ë¡œê·¸ë¨ì„ ì™¸ë¶€ë¡œ ë…¸ì¶œ ì‹œí‚¤ëŠ” ë°©ë²•ë“¤ ë¹„êµ</h4>

<ul>
  <li>ê°„ëµí•˜ê²Œ Kubernetes ì‘ìš©í”„ë¡œê·¸ë¨ì„ ì™¸ë¶€ë¡œ ë…¸ì¶œ ì‹œê¸°ëŠ” ë°©ë²•ë“¤ì„ ë¹„êµí•´ë³´ê² ìŠµë‹ˆë‹¤.</li>
  <li>ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒ ë¸”ë¡œê·¸ì—ì„œ ì‚´í´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://aws.amazon.com/blogs/containers/exposing-kubernetes-applications-part-1-service-and-ingress-resources/">Exposing Kubernetes Applications, Part 1: Service and Ingress Resources </a>
    <ol>
      <li>Exposing a <strong>Service</strong> : In-tree Service Controller
  <img src="/assets/2024/kans-3th/w9/20241102_kans_w9_12.png" alt="img.png" class="image-center" loading="lazy" width="879" height="360">
        <ul>
          <li>AWS CLB(Classic Load Balancer)ë‚˜ AWS NLB(Network Load Balancer)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ì§ì ‘ ì™¸ë¶€ë¡œ ë…¸ì¶œí•©ë‹ˆë‹¤.
 í•˜ì§€ë§Œ ì„œë¹„ìŠ¤ ìˆ˜ê°€ ë§ì•„ì§€ë©´ Load Balancerì˜ ìˆ˜ë„ ë§ì•„ì§€ê²Œ ë˜ì–´ ê´€ë¦¬ê°€ ì–´ë ¤ì›Œì§‘ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>
<strong>Ingress Implementations : External Load Balancer</strong>
  <img src="/assets/2024/kans-3th/w9/20241102_kans_w9_13.png" alt="img.png" class="image-center" loading="lazy" width="879" height="358">
        <ul>
          <li>ì™¸ë¶€ì— ALB(Application Load Balancer)ë¥¼ ìƒì„±í•˜ê³  ë¼ìš°íŒ…í•©ë‹ˆë‹¤. ì´ë•Œ ì™¸ë¶€ì˜ ALBê°€ Ingress ruleì„ ALB ruleë¡œ ë³€í™˜í•˜ì—¬ 
 ì™¸ë¶€ ALBê°€ ì§ì ‘ íŒŒë“œì™€ í†µì‹ í•©ë‹ˆë‹¤. ì•ì—ì„œ ë³¸ ì„œë¹„ìŠ¤ë¥¼ ì§ì ‘ ì™¸ë¶€ë¡œ ë…¸ì¶œí•˜ëŠ”ê²ƒ ë³´ë‹¤, CSP(Cloud Service Provider)ì—ì„œ ì œê³µí•˜ëŠ”
 í™•ì¥ì„±ì´ë‚˜, DDOS ë°©ì–´ê¸°ëŠ¥ ë“±ì„ í™œìš© í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>
<strong>Ingress Implementations : Internal Reverse Proxy</strong>
  <img src="/assets/2024/kans-3th/w9/20241102_kans_w9_14.png" alt="img.png" class="image-center" loading="lazy" width="879" height="360">
        <ul>
          <li>ì™¸ë¶€ì˜ ALBì— ë”í•´ nginx ë“±ì˜ Layer 7 ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ ë‘ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ì´ ë°©ì‹ì€ ì™¸ë¶€ ALBê°€ ì§ì ‘ íŒŒë“œì™€ í†µì‹ í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼,
 ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ í†µí•´ í†µì‹ í•˜ê²Œ ë©ë‹ˆë‹¤. ì„±ëŠ¥ìƒìœ¼ë¡œëŠ” ë¶ˆì´ìµì´ ìˆì§€ë§Œ L7 ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œì—ì„œ ì œê³µí•˜ëŠ” ì¶”ê°€ ê¸°ëŠ¥ë“¤ì„ í™œìš© í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>í•˜ì§€ë§Œ ê´€ë¦¬ìš”ì†Œê°€ ì¶”ê°€ë˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ì´ë¥¼ ê³ ë ¤í•˜ì—¬ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>
<strong>Kubernetes Gateway API</strong>
  <img src="/assets/2024/kans-3th/w9/20241102_kans_w9_15.png" alt="img.png" class="image-center" loading="lazy" width="879" height="358">
        <ul>
          <li>Kubernetes Gateway APIëŠ” Ingress Controllerë¥¼ ëŒ€ì²´í•˜ëŠ” ìƒˆë¡œìš´ APIë¡œ í˜„ì‹œì ì—ì„œ Beta ìƒíƒœë¡œ, ì •ì‹ ì§€ì›í•˜ì§€ëŠ” ì•ŠëŠ”ë“¯í•˜ë©°,
 ì™¸ë¶€ Loadbalancerë‚˜ Internal reverse proxy ë°©ì‹ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ol>
  </li>
</ul>

<h3 id="externaldns">ExternalDNS</h3>

<ul>
  <li>
    <p>K8S ì„œë¹„ìŠ¤/ì¸ê·¸ë ˆìŠ¤ ìƒì„± ì‹œ ë„ë©”ì¸ì„ ì„¤ì •í•˜ë©´, AWS(Route 53), Azure(DNS), GCP(Cloud DNS)ì— A ë ˆì½”ë“œ(TXT ë ˆì½”ë“œ)ê°€ ìë™ìœ¼ë¡œ ìƒì„±/ì‚­ì œë©ë‹ˆë‹¤.
<img src="/assets/2024/kans-3th/w9/20241102_kans_w9_27.png" alt="img.png" class="image-center" loading="lazy" width="1375" height="756">
<em class="image-caption"><a href="https://edgehog.blog/a-self-hosted-external-dns-resolver-for-kubernetes-111a27d6fc2c">https://edgehog.blog/a-self-hosted-external-dns-resolver-for-kubernetes-111a27d6fc2c</a></em></p>
  </li>
  <li>
    <p>AWS Route 53 ì •ë³´ í™•ì¸ &amp; ë³€ìˆ˜ ì§€ì • : Public ë„ë©”ì¸ ì†Œìœ ë¥¼ í•˜ê³  ìˆì–´ì•¼ í•©ë‹ˆë‹¤</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># ìì‹ ì˜ ë„ë©”ì¸ ë³€ìˆ˜ ì§€ì • : ì†Œìœ í•˜ê³  ìˆëŠ” ìì‹ ì˜ ë„ë©”ì¸ì„ ì…ë ¥í•˜ì‹œë©´ ë©ë‹ˆë‹¤</span>
<span class="c">#$ MyDomain=&lt;ìì‹ ì˜ ë„ë©”ì¸&gt;</span>
<span class="nv">$ MyDomain</span><span class="o">=</span>kans.loremipsum.sweetlittlebird.io
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"export MyDomain=kans.loremipsum.sweetlittlebird.io"</span> <span class="o">&gt;&gt;</span> /etc/profile
  
<span class="c"># ìì‹ ì˜ Route 53 ë„ë©”ì¸ ID ì¡°íšŒ ë° ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ </span>aws route53 list-hosted-zones-by-name <span class="nt">--dns-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDomain</span><span class="k">}</span><span class="s2">."</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;HostedZones&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Id&amp;quot;: &amp;quot;/hostedzone/Z0416620XQJAGAPWXO31&amp;quot;,</span>
<span class="c">#          &amp;quot;Name&amp;quot;: &amp;quot;kans.loremipsum.sweetlittlebird.io.&amp;quot;,</span>
<span class="c">#          &amp;quot;CallerReference&amp;quot;: &amp;quot;3aba3324-d6a0-44a4-82b5-004044e06dd6&amp;quot;,</span>
<span class="c">#          &amp;quot;Config&amp;quot;: {</span>
<span class="c">#            &amp;quot;Comment&amp;quot;: &amp;quot;&amp;quot;,</span>
<span class="c">#            &amp;quot;PrivateZone&amp;quot;: false</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;ResourceRecordSetCount&amp;quot;: 3</span>
<span class="c">#        }</span>
<span class="c">#      ],</span>
<span class="c">#      &amp;quot;DNSName&amp;quot;: &amp;quot;kans.loremipsum.sweetlittlebird.io.&amp;quot;,</span>
<span class="c">#      &amp;quot;IsTruncated&amp;quot;: false,</span>
<span class="c">#      &amp;quot;MaxItems&amp;quot;: &amp;quot;100&amp;quot;</span>
<span class="c">#    }</span>
<span class="nv">$ </span>aws route53 list-hosted-zones-by-name <span class="nt">--dns-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDomain</span><span class="k">}</span><span class="s2">."</span> <span class="nt">--query</span> <span class="s2">"HostedZones[0].Name"</span>
<span class="c"># =&gt; &amp;quot;kans.loremipsum.sweetlittlebird.io.&amp;quot;</span>
<span class="nv">$ </span>aws route53 list-hosted-zones-by-name <span class="nt">--dns-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDomain</span><span class="k">}</span><span class="s2">."</span> <span class="nt">--query</span> <span class="s2">"HostedZones[0].Id"</span> <span class="nt">--output</span> text
<span class="c"># =&gt; /hostedzone/Z0416620XQJAGAPWXO31</span>
<span class="nv">$ MyDnzHostedZoneId</span><span class="o">=</span><span class="sb">`</span>aws route53 list-hosted-zones-by-name <span class="nt">--dns-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDomain</span><span class="k">}</span><span class="s2">."</span> <span class="nt">--query</span> <span class="s2">"HostedZones[0].Id"</span> <span class="nt">--output</span> text<span class="sb">`</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$MyDnzHostedZoneId</span>
<span class="c"># =&gt; /hostedzone/Z0416620XQJAGAPWXO31</span>
  
<span class="c"># (ì˜µì…˜) NS ë ˆì½”ë“œ íƒ€ì… ì²«ë²ˆì§¸ ì¡°íšŒ</span>
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--output</span> json <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'NS']"</span> | jq <span class="nt">-r</span> <span class="s1">'.[0].ResourceRecords[].Value'</span>
<span class="c"># =&gt; ns-979.awsdns-58.net.</span>
<span class="c">#    ns-1489.awsdns-58.org.</span>
<span class="c">#    ns-355.awsdns-44.com.</span>
<span class="c">#    ns-1760.awsdns-28.co.uk.</span>
<span class="c"># (ì˜µì…˜) A ë ˆì½”ë“œ íƒ€ì… ëª¨ë‘ ì¡°íšŒ</span>
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--output</span> json <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A']"</span>
<span class="c"># =&gt; []</span>
  
<span class="c"># A ë ˆì½”ë“œ íƒ€ì… ì¡°íšŒ</span>
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A']"</span> | jq
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A'].Name"</span> | jq
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A'].Name"</span> <span class="nt">--output</span> text
  
<span class="c"># A ë ˆì½”ë“œ ê°’ ë°˜ë³µ ì¡°íšŒ</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A']"</span> | jq <span class="p">;</span> <span class="nb">date</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
</code></pre></div>    </div>
  </li>
  <li>ExternalDNS ì„¤ì¹˜ - <a href="https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md">ë§í¬</a>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># EKS ë°°í¬ ì‹œ Node IAM Role ì„¤ì •ë˜ì–´ ìˆìŒ</span>
<span class="c"># eksctl create cluster ... --external-dns-access ...</span>
  
<span class="c"># </span>
<span class="c">#$ MyDomain=&lt;ìì‹ ì˜ ë„ë©”ì¸&gt;</span>
<span class="nv">$ MyDomain</span><span class="o">=</span>kans.loremipsum.sweetlittlebird.io
  
<span class="c"># ìì‹ ì˜ Route 53 ë„ë©”ì¸ ID ì¡°íšŒ ë° ë³€ìˆ˜ ì§€ì •</span>
<span class="nv">$ MyDnzHostedZoneId</span><span class="o">=</span><span class="si">$(</span>aws route53 list-hosted-zones-by-name <span class="nt">--dns-name</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDomain</span><span class="k">}</span><span class="s2">."</span> <span class="nt">--query</span> <span class="s2">"HostedZones[0].Id"</span> <span class="nt">--output</span> text<span class="si">)</span>
  
<span class="c"># ë³€ìˆ˜ í™•ì¸</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$MyDomain</span>, <span class="nv">$MyDnzHostedZoneId</span>
<span class="c"># =&gt; kans.loremipsum.sweetlittlebird.io, /hostedzone/Z0416620XQJAGAPWXO31</span>
  
<span class="c"># ExternalDNS ë°°í¬</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-O</span> https://raw.githubusercontent.com/gasida/PKOS/main/aews/externaldns.yaml
<span class="nv">$ </span><span class="nb">cat </span>externaldns.yaml
<span class="nv">$ MyDomain</span><span class="o">=</span><span class="nv">$MyDomain</span> <span class="nv">MyDnzHostedZoneId</span><span class="o">=</span><span class="nv">$MyDnzHostedZoneId</span> envsubst &lt; externaldns.yaml | kubectl apply <span class="nt">-f</span> -
<span class="c"># =&gt; serviceaccount/external-dns created</span>
<span class="c">#    clusterrole.rbac.authorization.k8s.io/external-dns created</span>
<span class="c">#    clusterrolebinding.rbac.authorization.k8s.io/external-dns-viewer created</span>
<span class="c">#    deployment.apps/external-dns created</span>
  
<span class="c"># í™•ì¸ ë° ë¡œê·¸ ëª¨ë‹ˆí„°ë§</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-l</span> app.kubernetes.io/name<span class="o">=</span>external-dns <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME                            READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    external-dns-648996678b-7r4mz   1/1     Running   0          12s</span>
<span class="nv">$ </span>kubectl logs deploy/external-dns <span class="nt">-n</span> kube-system <span class="nt">-f</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p>(ì°¸ê³ ) ê¸°ì¡´ì— ExternalDNSë¥¼ í†µí•´ ì‚¬ìš©í•œ A/TXT ë ˆì½”ë“œê°€ ìˆëŠ” ì¡´ì˜ ê²½ìš°ì— policy ì •ì±…ì„ upsert-only ë¡œ ì„¤ì • í›„ ì‚¬ìš© í•˜ì - <a href="https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md#deploy-externaldns">Link</a></p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>- <span class="c">#--policy=upsert-only # would prevent ExternalDNS from deleting any records, omit to enable full synchronization</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Service(<strong>NLB</strong>) + ë„ë©”ì¸ ì—°ë™(<strong>ExternalDNS</strong>) - <a href="https://www.whatsmydns.net/">ë„ë©”ì¸ì²´í¬</a>
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># í„°ë¯¸ë„1 (ëª¨ë‹ˆí„°ë§)</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s1">'kubectl get pod,svc'</span>
<span class="nv">$ </span>kubectl logs deploy/external-dns <span class="nt">-n</span> kube-system <span class="nt">-f</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:18:10Z&amp;quot; level=info msg=&amp;quot;Instantiating new Kubernetes client&amp;quot;</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:18:10Z&amp;quot; level=info msg=&amp;quot;Using inCluster-config based on serviceaccount-token&amp;quot;</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:18:10Z&amp;quot; level=info msg=&amp;quot;Created Kubernetes client https://10.100.0.1:443&amp;quot;</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:18:11Z&amp;quot; level=info msg=&amp;quot;Applying provider record filter for domains: [kans.loremipsum.sweetlittlebird.io. .kans.loremipsum.sweetlittlebird.io.]&amp;quot;</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:18:11Z&amp;quot; level=info msg=&amp;quot;All records are already up to date&amp;quot;</span>
<span class="c">#    ... (deployment ë°°í¬ í›„) ...</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:20:11Z&amp;quot; level=info msg=&amp;quot;Applying provider record filter for domains: [kans.loremipsum.sweetlittlebird.io. .kans.loremipsum.sweetlittlebird.io.]&amp;quot;</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:20:12Z&amp;quot; level=info msg=&amp;quot;Desired change: CREATE cname-tetris.kans.loremipsum.sweetlittlebird.io TXT&amp;quot; profile=default zoneID=/hostedzone/Z0416620XQJAGAPWXO31 zoneName=kans.loremipsum.sweetlittlebird.io.</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:20:12Z&amp;quot; level=info msg=&amp;quot;Desired change: CREATE tetris.kans.loremipsum.sweetlittlebird.io A&amp;quot; profile=default zoneID=/hostedzone/Z0416620XQJAGAPWXO31 zoneName=kans.loremipsum.sweetlittlebird.io.</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:20:12Z&amp;quot; level=info msg=&amp;quot;Desired change: CREATE tetris.kans.loremipsum.sweetlittlebird.io TXT&amp;quot; profile=default zoneID=/hostedzone/Z0416620XQJAGAPWXO31 zoneName=kans.loremipsum.sweetlittlebird.io.</span>
<span class="c">#    time=&amp;quot;2024-10-01T14:20:12Z&amp;quot; level=info msg=&amp;quot;3 record(s) were successfully updated&amp;quot; profile=default zoneID=/hostedzone/Z0416620XQJAGAPWXO31 zoneName=kans.loremipsum.sweetlittlebird.io.</span>
  
<span class="c"># í…ŒíŠ¸ë¦¬ìŠ¤ ë””í”Œë¡œì´ë¨¼íŠ¸ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tetris
  labels:
    app: tetris
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tetris
  template:
    metadata:
      labels:
        app: tetris
    spec:
      containers:
      - name: tetris
        image: bsord/tetris
---
apiVersion: v1
kind: Service
metadata:
  name: tetris
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
    #service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "80"
spec:
  selector:
    app: tetris
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  type: LoadBalancer
  loadBalancerClass: service.k8s.aws/nlb
</span><span class="no">EOF
  
</span><span class="c"># ë°°í¬ í™•ì¸</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep tetris
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/tetris   0/1     1            0           5s</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE           CLUSTER-IP      EXTERNAL-IP                                                                       PORT(S)        AGE</span>
<span class="c">#    service/tetris   LoadBalancer   10.100.39.204   k8s-default-tetris-4d2a39458c-e91cd840ce214644.elb.ap-northeast-2.amazonaws.com   80:32310/TCP   5s</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS   AGE</span>
<span class="c">#    endpoints/tetris   &amp;lt;none&amp;gt;      5s</span>
  
<span class="c"># NLBì— ExternanDNS ë¡œ ë„ë©”ì¸ ì—°ê²°</span>
<span class="nv">$ </span>kubectl annotate service tetris <span class="s2">"external-dns.alpha.kubernetes.io/hostname=tetris.</span><span class="nv">$MyDomain</span><span class="s2">"</span>
<span class="c"># =&gt; service/tetris annotated</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A']"</span> | jq <span class="p">;</span> <span class="nb">date</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; [</span>
<span class="c">#      {</span>
<span class="c">#        &amp;quot;Name&amp;quot;: &amp;quot;tetris.kans.loremipsum.sweetlittlebird.io.&amp;quot;,</span>
<span class="c">#        &amp;quot;Type&amp;quot;: &amp;quot;A&amp;quot;,</span>
<span class="c">#        &amp;quot;AliasTarget&amp;quot;: {</span>
<span class="c">#          &amp;quot;HostedZoneId&amp;quot;: &amp;quot;ZIBE1TIR4HY56&amp;quot;,</span>
<span class="c">#          &amp;quot;DNSName&amp;quot;: &amp;quot;k8s-default-tetris-4d2a39458c-e91cd840ce214644.elb.ap-northeast-2.amazonaws.com.&amp;quot;,</span>
<span class="c">#          &amp;quot;EvaluateTargetHealth&amp;quot;: true</span>
<span class="c">#        }</span>
<span class="c">#      }</span>
<span class="c">#    ]</span>
<span class="c">#    Sat Oct  1 23:21:27 KST 2024</span>
<span class="c">#    ...</span>
  
<span class="c"># Route53ì— Aë ˆì½”ë“œ í™•ì¸</span>
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A']"</span> | jq
<span class="c"># =&gt; [</span>
<span class="c">#      {</span>
<span class="c">#        &amp;quot;Name&amp;quot;: &amp;quot;tetris.kans.loremipsum.sweetlittlebird.io.&amp;quot;,</span>
<span class="c">#        &amp;quot;Type&amp;quot;: &amp;quot;A&amp;quot;,</span>
<span class="c">#        &amp;quot;AliasTarget&amp;quot;: {</span>
<span class="c">#          &amp;quot;HostedZoneId&amp;quot;: &amp;quot;ZIBE1TIR4HY56&amp;quot;,</span>
<span class="c">#          &amp;quot;DNSName&amp;quot;: &amp;quot;k8s-default-tetris-4d2a39458c-e91cd840ce214644.elb.ap-northeast-2.amazonaws.com.&amp;quot;,</span>
<span class="c">#          &amp;quot;EvaluateTargetHealth&amp;quot;: true</span>
<span class="c">#        }</span>
<span class="c">#      }</span>
<span class="c">#    ]</span>
<span class="nv">$ </span>aws route53 list-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MyDnzHostedZoneId</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--query</span> <span class="s2">"ResourceRecordSets[?Type == 'A'].Name"</span> | jq .[]
<span class="c"># =&gt; &amp;quot;tetris.kans.loremipsum.sweetlittlebird.io.&amp;quot;</span>
  
<span class="c"># í™•ì¸</span>
<span class="nv">$ </span>dig +short tetris.<span class="nv">$MyDomain</span> @8.8.8.8
<span class="c"># =&gt; 3.38.82.70</span>
<span class="c">#    3.36.187.152</span>
<span class="c">#    3.35.184.161</span>
<span class="nv">$ </span>dig +short tetris.<span class="nv">$MyDomain</span>
<span class="c"># =&gt; 3.38.82.70</span>
  
<span class="c"># ë„ë©”ì¸ ì²´í¬</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"My Domain Checker = https://www.whatsmydns.net/#A/tetris.</span><span class="nv">$MyDomain</span><span class="s2">"</span>
<span class="c"># =&gt; My Domain Checker = https://www.whatsmydns.net/#A/tetris.kans.loremipsum.sweetlittlebird.io</span>
  
<span class="c"># ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸ ë° ì ‘ì†</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Tetris Game URL = http://tetris.</span><span class="nv">$MyDomain</span><span class="s2">"</span>
<span class="c"># =&gt; Tetris Game URL = http://tetris.kans.loremipsum.sweetlittlebird.io</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p>ì›¹ ì ‘ì†(http) â†’ í™”ì‚´í‘œí‚¤, ì¼ì‹œì¤‘ì§€(space bar)</p>

        <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_35.png" alt="img.png" class="image-center" loading="lazy" width="686" height="649"></p>
      </li>
    </ul>
  </li>
  <li>
    <p>Ingress(ALB + HTTPS) + ë„ë©”ì¸ ì—°ë™(ExternalDNS)</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># í…ŒíŠ¸ë¦¬ìŠ¤ ë””í”Œë¡œì´ë¨¼íŠ¸ ë°°í¬</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tetris
  labels:
    app: tetris
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tetris
  template:
    metadata:
      labels:
        app: tetris
    spec:
      containers:
      - name: tetris
        image: bsord/tetris
---
apiVersion: v1
kind: Service
metadata:
  name: tetris
  labels:
    app: tetris
spec:
  selector:
    app: tetris
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  type: LoadBalancer
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tetris-ingress
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:123456789012:certificate/256538f4-6c5d-4109-9d4d-9aa6af41adaa
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'
spec:
  ingressClassName: alb
  rules:
    - http:
        paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: tetris
              port:
                number: 80  
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/tetris created</span>
<span class="c">#    service/tetris created</span>
<span class="c">#    ingress.networking.k8s.io/tetris-ingress created</span>
  
<span class="c"># ingressì— ë„ë©”ì¸ ë¶€ì—¬</span>
<span class="nv">$ </span>kubectl annotate ingress tetris-ingress <span class="s2">"external-dns.alpha.kubernetes.io/hostname=tetris2.</span><span class="nv">$MyDomain</span><span class="s2">"</span>
<span class="c"># =&gt; ingress.networking.k8s.io/tetris-ingress annotated</span>
  
<span class="c"># &lt;span style="color: green;"&gt;ğŸ‘‰ ê¸°ì¡´ì— ì‚¬ìš©í–ˆë˜ ë„ë©”ì¸(tetris.$MyDomain)ì„ ì‚¬ìš©í•˜ë©´ DNS ë ˆì½”ë“œê°€ ì „íŒŒë˜ëŠ”ë° ì‹œê°„ì´ ë” ê±¸ë¦¬ê¸° ë•Œë¬¸ì—&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ë‹¤ë¥¸ ë„ë©”ì¸ (tetris2.$MyDomain)ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.&lt;/span&gt;</span>
</code></pre></div>    </div>

    <p><img src="/assets/2024/kans-3th/w9/20241102_kans_w9_36.png" alt="img.png" class="image-center" loading="lazy" width="1297" height="859">
<em class="image-caption">dns ì ìš© í™•ì¸ (<a href="https://www.whatsmydns.net/">í™•ì¸ ì‚¬ì´íŠ¸ ë§í¬</a>)</em></p>

    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">https://tetris2.kans.loremipsum.sweetlittlebird.io</code> ë¡œ ì ‘ì†í•˜ì—¬ https í†µì‹  í™•ì¸
<img src="/assets/2024/kans-3th/w9/20241102_kans_w9_37.png" alt="img.png" class="image-center" loading="lazy" width="914" height="563">
<em class="image-caption">https ì ìš© í™•ì¸</em>
</li>
    </ul>
  </li>
  <li>
<strong>ë¦¬ì†ŒìŠ¤ ì‚­ì œ</strong> : <code class="language-plaintext highlighter-rouge">kubectl delete deploy,svc tetris</code> â† ì‚­ì œ ì‹œ externaldns ì— ì˜í•´ì„œ Aë ˆì½”ë“œë„ ê°™ì´ ì‚­ì œë©ë‹ˆë‹¤.</li>
</ul>

<ul>
  <li>
    <p>(ì°¸ê³ ) ACM í¼ë¸”ë¦­ ì¸ì¦ì„œ ìš”ì²­ ë° í•´ë‹¹ ì¸ì¦ì„œì— ëŒ€í•œ Route53 ë„ë©”ì¸ ê²€ì¦ ì„¤ì • with AWS CLI</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># ê°ì ìì‹ ì˜ ë„ë©”ì¸ ë³€ìˆ˜ ì§€ì •</span>
<span class="c">#$ MyDomain=&lt;ê°ì ìì‹ ì˜ ë„ë©”ì¸&gt;</span>
<span class="nv">$ MyDomain</span><span class="o">=</span>kans.loremipsum.sweetlittlebird.io
  
<span class="c"># ACM í¼ë¸”ë¦­ ì¸ì¦ì„œ ìš”ì²­</span>
<span class="nv">$ CERT_ARN</span><span class="o">=</span><span class="si">$(</span>aws acm request-certificate <span class="se">\</span>
  <span class="nt">--domain-name</span> <span class="nv">$MyDomain</span> <span class="se">\</span>
  <span class="nt">--validation-method</span> <span class="s1">'DNS'</span> <span class="se">\</span>
  <span class="nt">--key-algorithm</span> <span class="s1">'RSA_2048'</span> <span class="se">\</span>
  | jq <span class="nt">--raw-output</span> <span class="s1">'.CertificateArn'</span><span class="si">)</span>
  
<span class="c"># ìƒì„±í•œ ì¸ì¦ì„œ CNAME ì´ë¦„ ê°€ì ¸ì˜¤ê¸°</span>
<span class="nv">$ CnameName</span><span class="o">=</span><span class="si">$(</span>aws acm describe-certificate <span class="se">\</span>
  <span class="nt">--certificate-arn</span> <span class="nv">$CERT_ARN</span> <span class="se">\</span>
  <span class="nt">--query</span> <span class="s1">'Certificate.DomainValidationOptions[*].ResourceRecord.Name'</span> <span class="se">\</span>
  <span class="nt">--output</span> text<span class="si">)</span>
  
<span class="c"># ìƒì„±í•œ ì¸ì¦ì„œ CNAME ê°’ ê°€ì ¸ì˜¤ê¸°</span>
<span class="nv">$ CnameValue</span><span class="o">=</span><span class="si">$(</span>aws acm describe-certificate <span class="se">\</span>
  <span class="nt">--certificate-arn</span> <span class="nv">$CERT_ARN</span> <span class="se">\</span>
  <span class="nt">--query</span> <span class="s1">'Certificate.DomainValidationOptions[*].ResourceRecord.Value'</span> <span class="se">\</span>
  <span class="nt">--output</span> text<span class="si">)</span>
  
<span class="c"># ì •ìƒ ì¶œë ¥ í™•ì¸í•˜ê¸°</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CERT_ARN</span>, <span class="nv">$CnameName</span>, <span class="nv">$CnameValue</span>
<span class="c"># =&gt; arn:aws:acm:ap-northeast-2:123456789012:certificate/256538f4-6c5d-4109-9d4d-9aa6af41adaa, _e784949706a5e6eee7f350436cc9d501.kans.loremipsum.sweetlittlebird.io., _e62ee6e59a48ea2f3d1ab952d289bcea.djqtsrsxkq.acm-validations.aws.</span>
  
<span class="c"># ë ˆì½”ë“œ íŒŒì¼</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; cname.json
{
  "Comment": "create a acm's CNAME record",
  "Changes": [
    {
      "Action": "CREATE",
      "ResourceRecordSet": {
        "Name": "CnameName",
        "Type": "CNAME",
        "TTL": 300,
        "ResourceRecords": [
          {
            "Value": "CnameValue"
          }
        ]
      }
    }
  ]
}
</span><span class="no">EOT
  
</span><span class="c"># CNAME ì´ë¦„, ê°’ ì¹˜í™˜í•˜ê¸°</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/CnameName/</span><span class="nv">$CnameName</span><span class="s2">/g"</span> cname.json
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/CnameValue/</span><span class="nv">$CnameValue</span><span class="s2">/g"</span> cname.json
<span class="nv">$ </span><span class="nb">cat </span>cname.json
<span class="c"># =&gt; {</span>
<span class="c">#      &amp;quot;Comment&amp;quot;: &amp;quot;create a acm's CNAME record&amp;quot;,</span>
<span class="c">#      &amp;quot;Changes&amp;quot;: [</span>
<span class="c">#        {</span>
<span class="c">#          &amp;quot;Action&amp;quot;: &amp;quot;CREATE&amp;quot;,</span>
<span class="c">#          &amp;quot;ResourceRecordSet&amp;quot;: {</span>
<span class="c">#            &amp;quot;Name&amp;quot;: &amp;quot;_e784949706a5e6eee7f350436cc9d501.kans.loremipsum.sweetlittlebird.io.&amp;quot;,</span>
<span class="c">#            &amp;quot;Type&amp;quot;: &amp;quot;CNAME&amp;quot;,</span>
<span class="c">#            &amp;quot;TTL&amp;quot;: 300,</span>
<span class="c">#            &amp;quot;ResourceRecords&amp;quot;: [</span>
<span class="c">#              {</span>
<span class="c">#                &amp;quot;Value&amp;quot;: &amp;quot;_e62ee6e59a48ea2f3d1ab952d289bcea.djqtsrsxkq.acm-validations.aws.&amp;quot;</span>
<span class="c">#              }</span>
<span class="c">#            ]</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
  
<span class="c"># í•´ë‹¹ ì¸ì¦ì„œì— ëŒ€í•œ Route53 ë„ë©”ì¸ ê²€ì¦ ì„¤ì •ì„ ìœ„í•œ Route53 ë ˆì½”ë“œ ìƒì„±</span>
<span class="nv">$ </span>aws route53 change-resource-record-sets <span class="nt">--hosted-zone-id</span> <span class="nv">$MyDnzHostedZoneId</span> <span class="nt">--change-batch</span> file://cname.json
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="ì‹¤ìŠµ-ì™„ë£Œ-í›„-ìì›-ì‚­ì œ">ì‹¤ìŠµ ì™„ë£Œ í›„ ìì› ì‚­ì œ</h3>

<ul>
  <li>ì‚­ì œ : ì¥ì (1ì¤„ ëª…ë ¹ì–´ë¡œ ì™„ì „ ì‚­ì œ), ë‹¨ì (ì‚­ì œ ì‹¤í–‰ê³¼ ì™„ë£Œê¹Œì§€ SSH ì„¸ì…˜ ìœ ì§€ í•„ìš”)
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>eksctl delete cluster <span class="nt">--name</span> <span class="nv">$CLUSTER_NAME</span> <span class="o">&amp;&amp;</span> aws cloudformation delete-stack <span class="nt">--stack-name</span> <span class="nv">$CLUSTER_NAME</span>
</code></pre></div>    </div>
  </li>
</ul>

<hr>

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>

<p>ì™€.. ë“œë””ì–´ ë§ˆì§€ë§‰ ì£¼ì°¨ì¸ 9ì£¼ì°¨ ê³¼ì œë¥¼ ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤.
ë§ˆì§€ë§‰ ì£¼ì°¨ì¸ ë§Œí¼ ê³¼ì œë¥¼ ë¹¨ë¦¬ ë§ˆì¹˜ê³  ì‹¶ì—ˆì§€ë§Œ, ìƒê°ë³´ë‹¤ ì‹œê°„ì´ ë§ì´ ê±¸ë ¤ì„œ ê²°êµ­ ì˜¤ëŠ˜ë„ ìì •ì„ ë„˜ê¸´ ì¼ìš”ì¼ì…ë‹ˆë‹¤. <img class="emoji" title=":cry:" alt=":cry:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f622.png" height="20" width="20" loading="lazy">
ë§¤ê³¼ì œë§ˆë‹¤ ì €ë„ ì‹œê°„ì„ ë§ì´ ìŸì§€ë§Œ, ê°€ì‹œë‹¤ ë‹˜ì„ ë¹„ë¡¯í•˜ì—¬ ìŠ¤í„°ë”” ì¡°ë ¥ìë¶„ë“¤ì´ ì´ ìŠ¤í„°ë””ë¥¼ ìœ„í•´ ì§€ê¸ˆê¹Œì§€ ì–¼ë§ˆë‚˜ ë§ì€ ì‹œê°„ì„ íˆ¬ìí•˜ì…¨ì„ì§€
ìƒê°í•˜ë©´ ìŠ¤ìŠ¤ë¡œê°€ ë¨¸ì“±í•˜ë©´ì„œë„, ê°ì‚¬í•¨ê³¼ ì¡´ê²½ì‹¬ì„ ëŠë‚ë‹ˆë‹¤.</p>

<p>ì´ë²ˆ ìŠ¤í„°ë””ë¥¼ í†µí•´ ë§ì€ ê²ƒì„ ë°°ì› ê³ , ë¸”ë¡œê·¸ë¥¼ ì‘ì„±í•˜ëŠ”ë° ìˆì–´ì„œë„ ë§ì€ ë„ì›€ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.
íšŒì‚¬ì—ì„œ í•„ìš”í•œ ê¸€ë§Œ ì“°ë‹¤ê°€, ì •ë§ ì˜¤ëœë§Œì— ê°œì¸ì„ ìœ„í•œ ê¸€ë„ ì´ë ‡ê²Œ ê¾¸ì¤€íˆ ì“´ê²ƒë„ ì°¸ ì˜¤ëœë§Œì…ë‹ˆë‹¤. 
ì§€ë‚œ í…Œë¼í¼ ìŠ¤í„°ë””ë¶€í„° í•˜ë©´ 5ê°œì›” ì •ë„ëŠ” ê±°ì˜ ë§¤ì£¼ ê¸€ì„ ì¼ë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤. 
â€”ë¬¼ë¡  ì‹¤ìŠµ ìœ„ì£¼ì—¬ì„œ â€œê¸€â€ì„ ì“´ê²Œ ë§ëƒëŠ” ë¬¸ì œê°€ ìˆê¸´í•©ë‹ˆë‹¤.â€” 
ì˜ˆì „ì—ëŠ” ì •ë§ ì‹œë¥ì–ì€ ë¸”ë¡œê·¸ ê¸€ë„ ë§ì´ ì¼ì—ˆëŠ”ë°, ë‚˜ì´ë„ ë“¤ê³ , ì‚¬íšŒì  ì§€ìœ„ë„ (ì•„ì§ì€ ë‚®ì§€ë§Œ ì˜ˆì „ë³´ë‹¤) ë†’ì•„ì§€ë‹¤ë³´ë‹ˆ
ê¸€ì„ ì“°ëŠ”ë° ìˆì–´ì„œë„ ì¡°ê¸ˆì€ ë¶€ë‹´ì´ ë˜ì—ˆì—ˆëŠ”ë°, ì´ë²ˆ ìŠ¤í„°ë””ë¥¼ í†µí•´ ë‹¤ì‹œ ê¸€ì„ ì“°ëŠ” ì¬ë¯¸ì™€ ê¸€ì„ ì“¸ ìˆ˜ ìˆë‹¤ëŠ” ìì‹ ê°ì„ ëŠë¼ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
ì•ìœ¼ë¡œë„ ìŠ¤í„°ë””ê°€ ì•„ë‹ˆë”ë¼ë„ ê¾¸ì¤€íˆ ê¸€ì„ ì“°ê³  ì‹¶ìŠµë‹ˆë‹¤.</p>

<p>ì•½ 3ê°œì›” ê°„ ìŠ¤í„°ë””ë¥¼ ì˜ ì´ëŒì–´ì£¼ì‹  ê°€ì‹œë‹¤ ë‹˜ê³¼ ì¡°ë ¥ì ë¶„ë“¤ê»˜ í° ê°ì‚¬ë¥¼ ë“œë¦½ë‹ˆë‹¤. <img class="emoji" title=":bow:" alt=":bow:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f647.png" height="20" width="20" loading="lazy"></p>

<p>ìŠ¤í„°ë””ì— ì°¸ì—¬í•˜ì‹  ëª¨ë“  ë¶„ë“¤ë„ ê³ ìƒ ë§ìœ¼ì…¨ìŠµë‹ˆë‹¤. ë‹¤ìŒì— ë˜ ëµ ìˆ˜ ìˆê¸°ë¥¼ ê¸°ëŒ€í•©ë‹ˆë‹¤. <img class="emoji" title=":smile:" alt=":smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png" height="20" width="20" loading="lazy"></p>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">ë“¤ì–´ê°€ë©°</a></li>
<li class="toc-entry toc-h2">
<a href="#aws-eks--vpc-cni">AWS EKS : VPC CNI</a>
<ul>
<li class="toc-entry toc-h3">
<a href="#aws-vpc-cni-%EC%86%8C%EA%B0%9C">AWS VPC CNI ì†Œê°œ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#calico-cni%EC%99%80%EC%9D%98-%EC%B0%A8%EC%9D%B4%EC%A0%90">Calico CNIì™€ì˜ ì°¨ì´ì </a></li>
<li class="toc-entry toc-h4"><a href="#ipv4-prefix-%EC%9C%84%EC%9E%84-delegation">IPv4 Prefix ìœ„ì„ (Delegation)</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%EC%8B%A4%EC%8A%B5-%EC%A4%80%EB%B9%84">ì‹¤ìŠµ ì¤€ë¹„</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EA%B5%AC%EC%84%B1-%ED%99%98%EA%B2%BD">êµ¬ì„± í™˜ê²½</a></li>
<li class="toc-entry toc-h4"><a href="#%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%85%8C%EC%8A%A4%ED%8A%B8">ë°°í¬ ë° í…ŒìŠ¤íŠ¸</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%EB%85%B8%EB%93%9C%EC%97%90%EC%84%9C-%EA%B8%B0%EB%B3%B8-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A0%95%EB%B3%B4-%ED%99%95%EC%9D%B8">ë…¸ë“œì—ì„œ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%9B%8C%EC%BB%A4-%EB%85%B8%EB%93%9C-%EA%B8%B0%EB%B3%B8-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EA%B5%AC%EC%84%B1">ì›Œì»¤ ë…¸ë“œ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ êµ¬ì„±</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-%EB%B3%B4%EC%A1%B0-ipv4-%EC%A3%BC%EC%86%8C%EB%A5%BC-%ED%8C%8C%EB%93%9C%EA%B0%80-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94%EC%A7%80-%ED%99%95%EC%9D%B8">[ì‹¤ìŠµ] ë³´ì¡° IPv4 ì£¼ì†Œë¥¼ íŒŒë“œê°€ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-%ED%85%8C%EC%8A%A4%ED%8A%B8%EC%9A%A9-%ED%8C%8C%EB%93%9C-%EC%83%9D%EC%84%B1---nicolakanetshoot">[ì‹¤ìŠµ] í…ŒìŠ¤íŠ¸ìš© íŒŒë“œ ìƒì„± - nicolaka/netshoot</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%EB%85%B8%EB%93%9C%EA%B0%84-%ED%8C%8C%EB%93%9C-%ED%86%B5%EC%8B%A0">ë…¸ë“œê°„ íŒŒë“œ í†µì‹ </a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-%ED%8C%8C%EB%93%9C%EA%B0%84-%ED%86%B5%EC%8B%A0-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EB%B0%8F-%ED%99%95%EC%9D%B8--%EB%B3%84%EB%8F%84%EC%9D%98-nat-%EB%8F%99%EC%9E%91-%EC%97%86%EC%9D%B4-%ED%86%B5%EC%8B%A0-%EA%B0%80%EB%8A%A5">[ì‹¤ìŠµ] íŒŒë“œê°„ í†µì‹  í…ŒìŠ¤íŠ¸ ë° í™•ì¸ : ë³„ë„ì˜ NAT ë™ì‘ ì—†ì´ í†µì‹  ê°€ëŠ¥!</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%ED%8C%8C%EB%93%9C%EC%97%90%EC%84%9C-%EC%99%B8%EB%B6%80-%ED%86%B5%EC%8B%A0">íŒŒë“œì—ì„œ ì™¸ë¶€ í†µì‹ </a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%8B%A4%EC%8A%B5-%ED%8C%8C%EB%93%9C%EC%97%90%EC%84%9C-%EC%99%B8%EB%B6%80-%ED%86%B5%EC%8B%A0-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EB%B0%8F-%ED%99%95%EC%9D%B8">[ì‹¤ìŠµ] íŒŒë“œì—ì„œ ì™¸ë¶€ í†µì‹  í…ŒìŠ¤íŠ¸ ë° í™•ì¸</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#%EB%85%B8%EB%93%9C%EC%9D%98-%ED%8C%8C%EB%93%9C-%EC%83%9D%EC%84%B1-%EA%B0%AF%EC%88%98-%EC%A0%9C%ED%95%9C">ë…¸ë“œì˜ íŒŒë“œ ìƒì„± ê°¯ìˆ˜ ì œí•œ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%82%AC%EC%A0%84-%EC%A4%80%EB%B9%84--kube-ops-view-%EC%84%A4%EC%B9%98">ì‚¬ì „ ì¤€ë¹„ : kube-ops-view ì„¤ì¹˜</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%9B%8C%EC%BB%A4-%EB%85%B8%EB%93%9C%EC%9D%98-%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%ED%83%80%EC%9E%85-%EB%B3%84-%ED%8C%8C%EB%93%9C-%EC%83%9D%EC%84%B1-%EA%B0%AF%EC%88%98-%EC%A0%9C%ED%95%9C">ì›Œì»¤ ë…¸ë“œì˜ ì¸ìŠ¤í„´ìŠ¤ íƒ€ì… ë³„ íŒŒë“œ ìƒì„± ê°¯ìˆ˜ ì œí•œ</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%9B%8C%EC%BB%A4-%EB%85%B8%EB%93%9C%EC%9D%98-%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%EC%A0%95%EB%B3%B4-%ED%99%95%EC%9D%B8--t3medium-%EC%82%AC%EC%9A%A9-%EC%8B%9C">ì›Œì»¤ ë…¸ë“œì˜ ì¸ìŠ¤í„´ìŠ¤ ì •ë³´ í™•ì¸ : t3.medium ì‚¬ìš© ì‹œ</a></li>
<li class="toc-entry toc-h4"><a href="#%EC%B5%9C%EB%8C%80-%ED%8C%8C%EB%93%9C-%EC%83%9D%EC%84%B1-%EB%B0%8F-%ED%99%95%EC%9D%B8">ìµœëŒ€ íŒŒë“œ ìƒì„± ë° í™•ì¸</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#service--aws-loadbalancer-controller">Service &amp; AWS LoadBalancer Controller</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%A2%85%EB%A5%98">ì„œë¹„ìŠ¤ ì¢…ë¥˜</a></li>
<li class="toc-entry toc-h4"><a href="#nlb-%EB%AA%A8%EB%93%9C-%EC%A0%84%EC%B2%B4-%EC%A0%95%EB%A6%AC">NLB ëª¨ë“œ ì „ì²´ ì •ë¦¬</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#ingress">Ingress</a>
<ul>
<li class="toc-entry toc-h4"><a href="#aws-load-balancer-controller--ingress-alb-ip-%EB%AA%A8%EB%93%9C-%EB%8F%99%EC%9E%91-with-aws-vpc-cni">AWS Load Balancer Controller + Ingress (ALB) IP ëª¨ë“œ ë™ì‘ with AWS VPC CNI</a></li>
<li class="toc-entry toc-h4"><a href="#kubernetes-%EC%9D%91%EC%9A%A9%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%A8%EC%9D%84-%EC%99%B8%EB%B6%80%EB%A1%9C-%EB%85%B8%EC%B6%9C-%EC%8B%9C%ED%82%A4%EB%8A%94-%EB%B0%A9%EB%B2%95%EB%93%A4-%EB%B9%84%EA%B5%90">Kubernetes ì‘ìš©í”„ë¡œê·¸ë¨ì„ ì™¸ë¶€ë¡œ ë…¸ì¶œ ì‹œí‚¤ëŠ” ë°©ë²•ë“¤ ë¹„êµ</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#externaldns">ExternalDNS</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5-%EC%99%84%EB%A3%8C-%ED%9B%84-%EC%9E%90%EC%9B%90-%EC%82%AD%EC%A0%9C">ì‹¤ìŠµ ì™„ë£Œ í›„ ìì› ì‚­ì œ</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">ë§ˆì¹˜ë©°</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2024-11-03-KANS-Study-Week9/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2024-10-26-KANS-Study-Week8/">Â« [KANS 3ê¸°] Cilium CNI</a>
  
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2024-11-03-KANS-Study-Week9/";
this.page.identifier = "/posts/KANS Study - Week9";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>ê³µë¶€ ê¸°ë¡ê³¼ ê°œë°œ ì´ì•¼ê¸°ë¥¼ ë‹´ì€ ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>
  </body>

</html>
