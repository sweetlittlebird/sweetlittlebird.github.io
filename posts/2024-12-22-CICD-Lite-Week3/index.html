<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[CI/CD] Jenkins CI/ArgoCD + K8S | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[CI/CD] Jenkins CI/ArgoCD + K8S">
<meta property="og:locale" content="ko">
<meta name="description" content="이번 주에는 ArgoCD와 Jenkins를 사용하여 Kubernetes로의 배포를 하는 CI/CD를 구성해보겠습니다.">
<meta property="og:description" content="이번 주에는 ArgoCD와 Jenkins를 사용하여 Kubernetes로의 배포를 하는 CI/CD를 구성해보겠습니다.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2024-12-22-CICD-Lite-Week3/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2024-12-22-CICD-Lite-Week3/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-12-22T00:01:18+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[CI/CD] Jenkins CI/ArgoCD + K8S">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-12-22T00:01:18+09:00","datePublished":"2024-12-22T00:01:18+09:00","description":"이번 주에는 ArgoCD와 Jenkins를 사용하여 Kubernetes로의 배포를 하는 CI/CD를 구성해보겠습니다.","headline":"[CI/CD] Jenkins CI/ArgoCD + K8S","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2024-12-22-CICD-Lite-Week3/"},"url":"https://sweetlittlebird.github.io/posts/2024-12-22-CICD-Lite-Week3/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body class="body--contents">
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">소개</a><a class="page-link" href="/posts/">글 목록</a>
</div>
      </nav>
</div>
  
  <span id="scroll-indicator"></span>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[CI/CD] Jenkins CI/ArgoCD + K8S</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-12-22T00:01:18+09:00" itemprop="datePublished">2024년 12월 22일에 작성
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>목차</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#jenkins-ciargocd--k8s">Jenkins CI/ArgoCD + K8S</a>
<ul>
<li class="toc-entry toc-h3">
<a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1">실습환경 구성</a>
<ul>
<li class="toc-entry toc-h4"><a href="#jenkins-gogs-%EC%84%A4%EC%B9%98">Jenkins, Gogs 설치</a></li>
<li class="toc-entry toc-h4"><a href="#jenkins-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EC%B4%88%EA%B8%B0%EC%84%A4%EC%A0%95">Jenkins 컨테이너 초기설정</a></li>
<li class="toc-entry toc-h4"><a href="#gogs-%EC%B4%88%EA%B8%B0-%EC%84%A4%EC%A0%95">Gogs 초기 설정</a></li>
<li class="toc-entry toc-h4"><a href="#%EB%8F%84%EC%BB%A4-%ED%97%88%EB%B8%8C--%EC%84%A4%EC%A0%95">도커 허브  설정</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#jenkins-ci--k8s-kind">Jenkins CI + K8S (Kind)</a>
<ul>
<li class="toc-entry toc-h4"><a href="#kind-%EC%86%8C%EA%B0%9C-%EB%B0%8F-%EC%84%A4%EC%B9%98">Kind 소개 및 설치</a></li>
<li class="toc-entry toc-h4"><a href="#kind%EB%A1%9C-kubernetes-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EB%B0%B0%ED%8F%AC---3%EB%85%B8%EB%93%9C">Kind로 Kubernetes 클러스터 배포 - 3노드</a></li>
<li class="toc-entry toc-h4"><a href="#jenkins-%EC%84%A4%EC%A0%95--plugin-%EC%84%A4%EC%B9%98-%EC%9E%90%EA%B2%A9%EC%A6%9D%EB%AA%85-%EC%84%A4%EC%A0%95">Jenkins 설정 : Plugin 설치, 자격증명 설정</a></li>
<li class="toc-entry toc-h4"><a href="#kubernetes-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%EC%97%90-%EC%9D%91%EC%9A%A9%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%A8-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0">Kubernetes 클러스터에 응용프로그램 배포하기</a></li>
<li class="toc-entry toc-h4"><a href="#k8s%EC%97%90-docker-hub-%EC%9D%B8%EC%A6%9D%ED%86%A0%ED%81%B0-%EB%93%B1%EB%A1%9D-%ED%9B%84-%EB%8B%A4%EC%8B%9C-%EB%B0%B0%ED%8F%AC">K8S에 Docker Hub 인증토큰 등록 후 다시 배포</a></li>
<li class="toc-entry toc-h4"><a href="#gogs-webhook%EC%9D%84-%ED%86%B5%ED%95%B4-jenkins-pipeline-%EC%9E%90%EB%8F%99%ED%99%94">Gogs Webhook을 통해 Jenkins Pipeline 자동화</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#jenkins-cicd--k8s-kind">Jenkins CI/CD + K8S (Kind)</a></li>
<li class="toc-entry toc-h3">
<a href="#jenkins-ci--argocd--k8s-kind">Jenkins CI + ArgoCD + K8S (Kind)</a>
<ul>
<li class="toc-entry toc-h4"><a href="#argocd-%EC%86%8C%EA%B0%9C">ArgoCD 소개</a></li>
<li class="toc-entry toc-h4"><a href="#argocd-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EA%B8%B0%EB%B3%B8%EC%84%A4%EC%A0%95">ArgoCD 설치 및 기본설정</a></li>
<li class="toc-entry toc-h4"><a href="#helm-chart%EB%A5%BC-%ED%86%B5%ED%95%9C-%EB%B0%B0%ED%8F%AC-%EC%8B%A4%EC%8A%B5">Helm chart를 통한 배포 실습</a></li>
<li class="toc-entry toc-h4"><a href="#argocd-declarative-setup%EC%9C%BC%EB%A1%9C-%EB%B0%B0%ED%8F%AC-%EC%8B%A4%EC%8A%B5">ArgoCD Declarative Setup으로 배포 실습</a></li>
<li class="toc-entry toc-h4"><a href="#argocd%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-full-cicd-%EA%B5%AC%EC%84%B1">ArgoCD를 이용한 Full CI/CD 구성</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#argo-rollout--k8skind">Argo Rollout + K8S(Kind)</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
    </div>
    <h2 id="들어가며">들어가며</h2>

<p>이번 주에는 ArgoCD와 Jenkins를 사용하여 Kubernetes로의 배포를 하는 CI/CD를 구성해보겠습니다.</p>

<h2 id="jenkins-ciargocd--k8s">Jenkins CI/ArgoCD + K8S</h2>

<h3 id="실습환경-구성">실습환경 구성</h3>

<ul>
  <li>이번에는 개발 PC에 Jenkins와 Gogs를 설치하고, Kind를 사용하여 Kubernetes 클러스터를 구성하고 ArgoCD를 설치하여 CI/CD를 구성해보겠습니다.</li>
</ul>

<h4 id="jenkins-gogs-설치">Jenkins, Gogs 설치</h4>

<ul>
  <li>Jenkins의 경우 1주차에서 설치하였지만 다시 한번 되짚어 보겠습니다.</li>
  <li>또한 이번에는 Gitlab 클라우드 서비스 대신, 자체 PC에 Gogs를 설치하여 사용해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 작업 디렉토리 생성 후 이동</span>
<span class="nv">$ </span><span class="nb">mkdir </span>cicd-labs
<span class="nv">$ </span><span class="nb">cd </span>cicd-labs

<span class="c"># </span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; docker-compose.yaml
services:

  jenkins:
    container_name: jenkins
    image: jenkins/jenkins
    restart: unless-stopped
    networks:
      - cicd-network
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - jenkins_home:/var/jenkins_home

  gogs:
    container_name: gogs
    image: gogs/gogs
    restart: unless-stopped
    networks:
      - cicd-network
    ports:
      - "10022:22"
      - "3000:3000"
    volumes:
      - gogs-data:/data

volumes:
  jenkins_home:
  gogs-data:

networks:
  cicd-network:
    driver: bridge
</span><span class="no">EOT


</span><span class="c"># 배포</span>
<span class="nv">$ </span>docker compose up <span class="nt">-d</span>
<span class="c"># =&gt; [+] Running 2/2</span>
<span class="c">#     ⠿ Container jenkins  Started  0.5s</span>
<span class="c">#     ⠿ Container gogs     Started  0.5s</span>
<span class="nv">$ </span>docker compose ps
<span class="c"># =&gt; NAME                COMMAND                  SERVICE             STATUS              PORTS</span>
<span class="c">#    gogs                &amp;quot;/app/gogs/docker/st…&amp;quot;   gogs                running (healthy)   0.0.0.0:10022-&amp;gt;22/tcp, 0.0.0.0:3000-&amp;gt;3000/tcp</span>
<span class="c">#    jenkins             &amp;quot;/usr/bin/tini -- /u…&amp;quot;   jenkins             running             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp</span>

<span class="c"># 기본 정보 확인</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>gogs jenkins <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; container : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> docker compose <span class="nb">exec</span> <span class="nv">$i</span> sh <span class="nt">-c</span> <span class="s2">"whoami &amp;&amp; pwd"</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &amp;gt;&amp;gt; container : gogs &amp;lt;&amp;lt;</span>
<span class="c">#    root</span>
<span class="c">#    /app/gogs</span>
<span class="c">#    </span>
<span class="c">#    &amp;gt;&amp;gt; container : jenkins &amp;lt;&amp;lt;</span>
<span class="c">#    jenkins</span>
<span class="c">#    /</span>

<span class="c"># 도커를 이용하여 각 컨테이너로 접속</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins bash
<span class="nv">$ </span><span class="nb">exit</span>

<span class="nv">$ </span>docker compose <span class="nb">exec </span>gogs bash
<span class="nv">$ </span><span class="nb">exit</span>
</code></pre></div></div>

<h4 id="jenkins-컨테이너-초기설정">Jenkins 컨테이너 초기설정</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Jenkins 초기 암호 확인</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins <span class="nb">cat</span> /var/jenkins_home/secrets/initialAdminPassword
<span class="c"># =&gt; 3da38dccc7d14d1a8bee4b02c4e09da8</span>

<span class="c"># Jenkins 웹 접속 주소 확인 : 계정 / 암호 입력 &gt;&gt; **admin / qwe123**</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:8080"</span> <span class="c"># macOS</span>

<span class="c"># (참고) 로그 확인 : 플러그인 설치 과정 확인</span>
<span class="nv">$ </span>docker compose logs jenkins <span class="nt">-f</span>

<span class="c"># IP 확인 (MacOS 기준)</span>
<span class="nv">$ </span>ifconfig | <span class="nb">grep</span> <span class="s2">"inet "</span> | <span class="nb">grep</span> <span class="nt">-v</span> 127.0.0
<span class="c"># =&gt; inet &lt;span style="color: red;"&gt;10.0.4.3&lt;/span&gt; netmask 0xffffff00 broadcast 10.0.4.255</span>
<span class="c"># 또는</span>
<span class="nv">$ </span>ipconfig getifaddr en0
<span class="c"># =&gt; &lt;span style="color: red;"&gt;10.0.4.3&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>Jenkins URL 설정</li>
</ul>

<p>앞서 확인한 IP 주소를 이용하여 Jenkins URL을 설정합니다.</p>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_1.png" alt="img.png" loading="lazy" width="1078" height="636"></p>

<ul>
  <li>1주차때와 마찬가지로 Docker-out-of-Docker를 사용하겠습니다. 자세한 내용은 <a href="https://sweetlittlebird.github.io/posts/2024-12-08-CICD-Lite-Week1/#jenkins-%EC%86%8C%EA%B0%9C">1주차 내용</a>을 참고하세요.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Jenkins 컨테이너 내부에 도커 실행 파일 설치</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins bash
<span class="nt">-----------------------------------------------------</span>
<span class="nv">$ </span><span class="nb">id</span>

<span class="nv">$ </span>curl <span class="nt">-fsSL</span> https://download.docker.com/linux/debian/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="c"># =&gt; uid=0(root) gid=0(root) groups=0(root)</span>
<span class="nv">$ </span><span class="nb">chmod </span>a+r /etc/apt/keyrings/docker.asc
<span class="nv">$ </span><span class="nb">echo</span> <span class="se">\</span>
  <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian </span><span class="se">\</span><span class="s2">
  </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="se">\</span>
  <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
<span class="nv">$ </span>apt-get update <span class="o">&amp;&amp;</span> apt <span class="nb">install </span>docker-ce-cli curl tree jq yq <span class="nt">-y</span>

<span class="nv">$ </span>docker info
<span class="c"># =&gt; Client: Docker Engine - Community</span>
<span class="c">#     Version:    27.4.1</span>
<span class="c">#     Context:    default</span>
<span class="c">#     Debug Mode: false</span>
<span class="c">#     Plugins:</span>
<span class="c">#      buildx: Docker Buildx (Docker Inc.)</span>
<span class="c">#        Version:  v0.19.3</span>
<span class="c">#        Path:     /usr/libexec/docker/cli-plugins/docker-buildx</span>
<span class="c">#      compose: Docker Compose (Docker Inc.)</span>
<span class="c">#        Version:  v2.32.1</span>
<span class="c">#        Path:     /usr/libexec/docker/cli-plugins/docker-compose</span>
<span class="c">#    </span>
<span class="c">#    Server:</span>
<span class="c">#     Containers: 29</span>
<span class="c">#      Running: 2</span>
<span class="c">#      Paused: 0</span>
<span class="c">#      Stopped: 27</span>
<span class="c">#     Images: 42</span>
<span class="c">#     Server Version: 20.10.12</span>
<span class="c">#     Storage Driver: overlay2</span>
<span class="c">#      Backing Filesystem: extfs</span>
<span class="c">#      Supports d_type: true</span>
<span class="c">#      Native Overlay Diff: true</span>
<span class="c">#      userxattr: false</span>
<span class="c">#     Logging Driver: json-file</span>
<span class="c">#     Cgroup Driver: cgroupfs</span>
<span class="c">#     Cgroup Version: 2</span>
<span class="c">#     ...</span>
<span class="c">#     Insecure Registries:</span>
<span class="c">#      hubproxy.docker.internal:5000</span>
<span class="c">#      127.0.0.0/8</span>
<span class="c">#     Live Restore Enabled: false</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE             COMMAND                  CREATED        STATUS                    PORTS                                              NAMES</span>
<span class="c">#    110494b9ca48   gogs/gogs         &amp;quot;/app/gogs/docker/st…&amp;quot;   14 hours ago   Up 37 minutes (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins   &amp;quot;/usr/bin/tini -- /u…&amp;quot;   14 hours ago   Up 37 minutes             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 DooD이기 때문에 호스트에서 동작중인 컨테이너가 보입니다.&lt;/span&gt;</span>
<span class="nv">$ </span>which docker
<span class="c"># =&gt; /usr/bin/docker</span>

<span class="c"># Jenkins 컨테이너 내부에서 root가 아닌 jenkins 유저도 docker를 실행할 수 있도록 권한을 부여</span>
<span class="nv">$ </span>groupadd <span class="nt">-g</span> 2000 <span class="nt">-f</span> docker  <span class="c"># macOS(Container)</span>
<span class="c"># $ groupadd -g 1001 -f docker  # Windows WSL2(Container) &gt;&gt; cat /etc/group 에서 docker 그룹ID를 지정</span>

<span class="nv">$ </span><span class="nb">chgrp </span>docker /var/run/docker.sock
<span class="nv">$ </span><span class="nb">chmod </span>g+w /var/run/docker.sock
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /var/run/docker.sock
<span class="c"># =&gt; srwxrwxr-x 1 root docker 0 Oct 01 06:03 /var/run/docker.sock</span>
<span class="nv">$ </span>usermod <span class="nt">-aG</span> docker jenkins
<span class="nv">$ </span><span class="nb">cat</span> /etc/group | <span class="nb">grep </span>docker
<span class="c"># =&gt; docker:x:2000:jenkins</span>

<span class="nb">exit</span>
<span class="nt">--------------------------------------------</span>

<span class="c"># jenkins item 실행 시 docker 명령 실행 권한 에러 발생 : Jenkins 컨테이너 재기동으로 위 설정 내용을 Jenkins app 에도 적용 필요</span>
<span class="nv">$ </span>docker compose restart jenkins
<span class="c"># =&gt; [+] Running 1/1</span>
<span class="c">#     ⠿ Container jenkins  Started    0.9s</span>
<span class="c"># $ sudo docker compose restart jenkins  # Windows 경우 이후부터 sudo 붙여서 실행하자</span>

<span class="c"># jenkins user로 docker 명령 실행 확인</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins <span class="nb">id</span>
<span class="c"># =&gt; uid=1000(jenkins) gid=1000(jenkins) groups=1000(jenkins),2000(docker)</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins docker info
<span class="c"># =&gt; Client: Docker Engine - Community</span>
<span class="c">#     Version:    27.4.1</span>
<span class="c">#     ...</span>
<span class="c">#    </span>
<span class="c">#    Server:</span>
<span class="c">#     Containers: 29</span>
<span class="c">#      Running: 2</span>
<span class="c">#      Paused: 0</span>
<span class="c">#      Stopped: 27</span>
<span class="c">#     Images: 42</span>
<span class="c">#     Server Version: 20.10.12</span>
<span class="c">#     ...</span>
<span class="c">#     Live Restore Enabled: false</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE             COMMAND                  CREATED        STATUS                    PORTS                                              NAMES</span>
<span class="c">#    110494b9ca48   gogs/gogs         &amp;quot;/app/gogs/docker/st…&amp;quot;   14 hours ago   Up 41 minutes (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins   &amp;quot;/usr/bin/tini -- /u…&amp;quot;   14 hours ago   Up 57 seconds             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>
</code></pre></div></div>

<ul>
  <li>OS 재부팅시에 jenkins 컨테이너에서 docker 실행이 실패하는 경우가 있는데, 그럴 경우 아래와 같이 docker 그룹을 다시 지정합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 소켓 파일의 권한 확인</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins <span class="nb">ls</span> <span class="nt">-l</span> /var/run/docker.sock
<span class="c"># =&gt; srwxr-xr-x 1 root root 0 Oct 01 05:22 /var/run/docker.sock</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 그룹이 root로 복구되어있습니다. docker 그룹으로 다시 변경해야 합니다.&lt;/span&gt;</span>

<span class="c"># 소켓 파일에 docker 그룹을 다시 지정</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins <span class="nb">chgrp </span>docker /var/run/docker.sock

<span class="c"># 소켓 파일에 docker 그룹 쓰기권한 다시 지정</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins <span class="nb">chmod </span>g+w /var/run/docker.sock

<span class="c"># 확인</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins <span class="nb">ls</span> <span class="nt">-l</span> /var/run/docker.sock
<span class="c"># =&gt; srwxrwxr-x 1 root docker 0 Oct 01 05:22 /var/run/docker.sock</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins docker info
</code></pre></div></div>

<h4 id="gogs-초기-설정">Gogs 초기 설정</h4>

<ul>
  <li>초기설정을 위해 웹 접속을 합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 초기 설정 웹 접속</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:3000/install"</span> <span class="c"># macOS</span>
<span class="c"># 웹 브라우저에서 http://127.0.0.1:3000/install 접속 # Windows</span>
</code></pre></div></div>

<ul>
  <li>다음과 같이 설정값을 변경합니다.
    <ul>
      <li>Database Type : SQLite3</li>
      <li>Application URL : <code class="language-plaintext highlighter-rouge">http://&lt;앞에서 확인한 IP&gt;:3000/</code>
</li>
      <li>Default Branch : main</li>
      <li>관리자 계정 설정 클릭 : username : devops, password : qwe123, email입력
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_2.png" alt="img.png" loading="lazy" width="1078" height="974">
</li>
    </ul>
  </li>
  <li>Install Gogs 버튼 클릭 =&gt; 관리자 계정으로 로그인</li>
</ul>

<h5 id="access-token-발행">Access Token 발행</h5>

<ul>
  <li>로그인 후 Your Settings &gt; Applications &gt; Generate New Token 클릭 &gt; Token Name(devops) &gt; Generate Token 클릭하여 토큰을 발행합니다.</li>
  <li>발행된 토큰(<code class="language-plaintext highlighter-rouge">a85f33b7fd28ac1ed83c3233fc4ca3a67c04c296</code>)을 복사하여 안전한 곳에 기록해둡니다.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_3.png" alt="img.png" loading="lazy" width="1302" height="717"></p>

<h5 id="repository-생성">Repository 생성</h5>

<ul>
  <li>우측상단의 <code class="language-plaintext highlighter-rouge">+</code> 버튼을 클릭하여 나오는 메뉴에서 New Repository를 클릭해서 새로운 Repository를 다음과 같이 2개 생성합니다.</li>
  <li>
<strong>개발팀용</strong>
    <ul>
      <li>Repository Name : <strong>dev-app</strong>
</li>
      <li>Visibility : (<strong>Check</strong>) This repository is <strong>Private</strong>
</li>
      <li>.gitignore : <strong>Python</strong>
</li>
      <li>Readme : Default → (Check) initialize this repository with selected files and template</li>
    </ul>

    <p>⇒ Create Repository 클릭 =&gt; Repo 주소 확인 (<code class="language-plaintext highlighter-rouge">http://10.0.4.3:3000/devops/dev-apps.git</code>)</p>
  </li>
  <li>
<strong>데브옵스팀용</strong>
    <ul>
      <li>Repository Name : <strong>ops-deploy</strong>
</li>
      <li>Visibility : (<strong>체크</strong>) This repository is <strong>Private</strong>
</li>
      <li>Readme : Default → (체크) initialize this repository with selected files and template</li>
    </ul>

    <p>⇒ Create Repository 클릭 =&gt; Repo 주소 확인 (<code class="language-plaintext highlighter-rouge">http://10.0.4.3:3000/devops/ops-deploy.git</code>)</p>
  </li>
</ul>

<h5 id="gogs-실습을-위해-호스트-pc의-git-설정">Gogs 실습을 위해 호스트 PC의 git 설정</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># (옵션) GIT 인증 정보 초기화</span>
<span class="nv">$ </span>git credential-cache <span class="nb">exit</span>

<span class="c">#</span>
<span class="c"># $ git clone &lt;각자 Gogs dev-app repo 주소&gt;</span>
<span class="nv">$ </span>git clone http://10.0.4.3:3000/devops/dev-app.git
<span class="c"># =&gt; Cloning into 'dev-app'...</span>
<span class="c">#    Username for 'http://10.0.4.3:3000': devops</span>
<span class="c">#    Password for 'http://a@10.0.4.3:3000': # &lt;span style="color: green;"&gt;앞서 발급받은 access key 입력&lt;/span&gt;</span>

<span class="c">#    remote: Enumerating objects: 4, done.</span>
<span class="c">#    remote: Counting objects: 100% (4/4), done.</span>
<span class="c">#    remote: Compressing objects: 100% (3/3), done.</span>
<span class="c">#    remote: Total 4 (delta 0), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    Unpacking objects: 100% (4/4), 705 bytes | 352.00 KiB/s, done.</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cd </span>dev-app

<span class="c">#</span>
<span class="nv">$ </span>git config user.name <span class="s2">"devops"</span>
<span class="nv">$ </span>git config user.email <span class="s2">"a@a.com"</span>
<span class="nv">$ </span>git config init.defaultBranch main
<span class="nv">$ </span>git config credential.helper store

<span class="c">#</span>
<span class="nv">$ </span>git branch
<span class="c"># =&gt; * main</span>
<span class="nv">$ </span>git remote <span class="nt">-v</span>
<span class="c"># =&gt; origin  http://10.0.4.3:3000/devops/dev-app.git (fetch)</span>
<span class="c">#    origin  http://10.0.4.3:3000/devops/dev-app.git (push)</span>

<span class="c"># server.py 파일 작성</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> server.py <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
from http.server import ThreadingHTTPServer, BaseHTTPRequestHandler
from datetime import datetime
import socket

class RequestHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()
        
        now = datetime.now()
        hostname = socket.gethostname()
        response_string = now.strftime("The time is %-I:%M:%S %p, VERSION 0.0.1</span><span class="se">\n</span><span class="sh">")
        response_string += f"Server hostname: {hostname}</span><span class="se">\n</span><span class="sh">"
        self.wfile.write(bytes(response_string, "utf-8")) 

def startServer():
    try:
        server = ThreadingHTTPServer(('', 80), RequestHandler)
        print("Listening on " + ":".join(map(str, server.server_address)))
        server.serve_forever()
    except KeyboardInterrupt:
        server.shutdown()

if __name__ == "__main__":
    startServer()
</span><span class="no">EOF

</span><span class="c"># Dockerfile 생성</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Dockerfile <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
FROM python:3.12
ENV PYTHONUNBUFFERED 1
COPY . /app
WORKDIR /app 
CMD python3 server.py
</span><span class="no">EOF

</span><span class="c"># VERSION 파일 생성</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"0.0.1"</span> <span class="o">&gt;</span> VERSION

<span class="c">#</span>
<span class="nv">$ </span>git status
<span class="c"># =&gt; On branch main</span>
<span class="c">#    Your branch is up to date with 'origin/main'.</span>
<span class="c">#    </span>
<span class="c">#    Untracked files:</span>
<span class="c">#      (use &amp;quot;git add &amp;lt;file&amp;gt;...&amp;quot; to include in what will be committed)</span>
<span class="c">#            Dockerfile</span>
<span class="c">#            VERSION</span>
<span class="c">#            server.py</span>
<span class="c">#    </span>
<span class="c">#    nothing added to commit but untracked files present (use &amp;quot;git add&amp;quot; to track)</span>
<span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add dev-app"</span>
<span class="c"># =&gt; [main 3531233] Add dev-app</span>
<span class="c">#     3 files changed, 32 insertions(+)</span>
<span class="c">#     create mode 100644 Dockerfile</span>
<span class="c">#     create mode 100644 VERSION</span>
<span class="c">#     create mode 100644 server.py</span>
<span class="nv">$ </span>git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; Enumerating objects: 6, done.</span>
<span class="c">#    Counting objects: 100% (6/6), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (4/4), done.</span>
<span class="c">#    Writing objects: 100% (5/5), 900 bytes | 900.00 KiB/s, done.</span>
<span class="c">#    Total 5 (delta 0), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/dev-app.git</span>
<span class="c">#       5c906c3..3531233  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div></div>

<ul>
  <li>Gogs Repo에서 확인
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_4.png" alt="img.png" loading="lazy" width="999" height="304">
</li>
</ul>

<h4 id="도커-허브--설정">도커 허브  설정</h4>

<ul>
  <li>도커 허브에 로그인하여 dev-app이라는 Repository를 생성합니다. 도커허브 소개와 Repository 생성은 <a href="https://sweetlittlebird.github.io/posts/2024-12-08-CICD-Lite-Week1/#docker-hub-%EC%86%8C%EA%B0%9C">1주차 내용</a>을 참고하세요.</li>
  <li>배포를 편하게 하기위해 Token도 발급하여 사용해보겠습니다.
    <ol>
      <li>계정 &gt; Account Settings &gt; Security 클릭
  <img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_5.png" alt="img.png" class="image-center" loading="lazy" width="364" height="423">
</li>
      <li>New Access Token 클릭
        <ul>
          <li>Token Name : devops</li>
          <li>Expireation date : 만료일을 적절히 선택합니다.</li>
          <li>권한은 Read, Write, Delete를 선택합니다.</li>
          <li>Create 클릭하여 토큰을 생성하고, 발급된 토큰을 복사하여 안전한 곳에 저장합니다.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_6.png" alt="img.png" class="image-center" loading="lazy" width="1054" height="283">
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_7.png" alt="img_1.png" class="image-center" loading="lazy" width="648" height="390">
</li>
          <li>발급된 토큰 : <code class="language-plaintext highlighter-rouge">dckr_****</code>
</li>
        </ul>
      </li>
    </ol>
  </li>
</ul>

<hr>

<h3 id="jenkins-ci--k8s-kind">Jenkins CI + K8S (Kind)</h3>

<h4 id="kind-소개-및-설치">Kind 소개 및 설치</h4>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_8.png" alt="img.png" class="w-20 image-center" loading="lazy" width="985" height="594"></p>

<ul>
  <li>Kind는 Kubernetes in Docker의 줄임말로, 로컬 환경에서 쉽게 Kubernetes 클러스터를 구성할 수 있도록 도와주는 도구입니다.</li>
  <li>이름처럼 Docker를 이용하여 Kubernetes 클러스터를 구성하며, Docker를 이용하기 때문에 다양한 환경에서 쉽게 사용할 수 있습니다.</li>
  <li>Kind는 HA를 포함한 멀티노드를 지원하지만, 테스트와 실험적인 목적으로만 사용하기를 추천합니다.</li>
  <li>Kind는 클러스터를 구성하기 위해 kubeadm을 사용합니다.</li>
  <li>
<a href="https://sweetlittlebird.github.io/posts/2024-09-07-KANS-Study-Week2/#kind-%EC%86%8C%EA%B0%9C-%EB%B0%8F-%EC%84%A4%EC%B9%98">Kind 소개 및 설치</a>, <a href="https://kind.sigs.k8s.io/docs/user/quick-start/">Kind 공식문서</a>
</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_9.png" alt="img.png" class="image-center" loading="lazy" width="2048" height="1152">
<em class="image-caption">Kind 구성도</em></p>

<h5 id="kind-및-툴-설치">Kind 및 툴 설치</h5>

<ul>
  <li>필수 툴 설치</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install Kind</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kind
<span class="nv">$ </span>kind <span class="nt">--version</span>
<span class="c"># =&gt; kind version 0.26.0</span>

<span class="c"># Install kubectl</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubernetes-cli
<span class="nv">$ </span>kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Client Version: v1.31.0</span>
<span class="c">#    Kustomize Version: v5.4.2</span>
<span class="c">#    Kubecolor Version: v0.4.0</span>

<span class="c">## kubectl -&gt; k 단축키 설정</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"alias kubectl=kubecolor"</span> <span class="o">&gt;&gt;</span> ~/.zshrc

<span class="c"># Install Helm</span>
<span class="nv">$ </span>brew <span class="nb">install </span>helm
<span class="nv">$ </span>helm version
<span class="c"># =&gt; version.BuildInfo{Version:&amp;quot;v3.15.4&amp;quot;, GitCommit:&amp;quot;fa9efb07d9d8debbb4306d72af76a383895aa8c4&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;, GoVersion:&amp;quot;go1.22.6&amp;quot;}</span>
</code></pre></div></div>

<ul>
  <li>(권장) 유용한 툴 설치</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 툴 설치</span>
<span class="nv">$ </span>brew <span class="nb">install </span>krew
<span class="nv">$ </span>brew <span class="nb">install </span>kube-ps1
<span class="nv">$ </span>brew <span class="nb">install </span>kubectx

<span class="c"># kubectl 출력 시 하이라이트 처리</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubecolor
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"alias kubectl=kubecolor"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"compdef kubecolor=kubectl"</span> <span class="o">&gt;&gt;</span> ~/.zshrc

<span class="c"># krew 플러그인 설치</span>
<span class="nv">$ </span>kubectl krew <span class="nb">install </span>neat stren
</code></pre></div></div>

<h5 id="kind-기본-사용---클러스터-배포-및-확인">Kind 기본 사용 - 클러스터 배포 및 확인</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 클러스터 배포 전 확인</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE             COMMAND                  CREATED        STATUS                 PORTS                                              NAMES</span>
<span class="c">#    110494b9ca48   gogs/gogs         &amp;quot;/app/gogs/docker/st…&amp;quot;   19 hours ago   Up 5 hours (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins   &amp;quot;/usr/bin/tini -- /u…&amp;quot;   19 hours ago   Up 4 hours             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>

<span class="c"># Create a cluster with kind</span>
<span class="nv">$ </span>kind create cluster
<span class="c"># =&gt; Creating cluster &amp;quot;kind&amp;quot; ...</span>
<span class="c">#     ✓ Ensuring node image (kindest/node:v1.32.0) 🖼</span>
<span class="c">#     ✓ Preparing nodes 📦</span>
<span class="c">#     ✓ Writing configuration 📜</span>
<span class="c">#     ✓ Starting control-plane 🕹️</span>
<span class="c">#     ✓ Installing CNI 🔌</span>
<span class="c">#     ✓ Installing StorageClass 💾</span>
<span class="c">#    Set kubectl context to &amp;quot;kind-kind&amp;quot;</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-kind</span>
<span class="c">#    </span>
<span class="c">#    Not sure what to do next? 😅  Check out https://kind.sigs.k8s.io/docs/user/quick-start/</span>

<span class="c"># 클러스터 배포 확인</span>
<span class="nv">$ </span>kind get clusters
<span class="c"># =&gt; kind</span>
<span class="nv">$ </span>kind get nodes
<span class="c"># =&gt; kind-control-plane</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://127.0.0.1:64234</span>
<span class="c">#    CoreDNS is running at https://127.0.0.1:64234/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="c">#    </span>
<span class="c">#    To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>

<span class="c"># 노드 정보 확인</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                 STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    kind-control-plane   Ready    control-plane   63s   v1.32.0   172.20.0.2    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.24</span>

<span class="c"># 파드 정보 확인</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-system          coredns-668d6bf9bc-8pqmk                     1/1     Running   0          67s</span>
<span class="c">#    kube-system          coredns-668d6bf9bc-9ngw2                     1/1     Running   0          67s</span>
<span class="c">#    kube-system          etcd-kind-control-plane                      1/1     Running   0          74s</span>
<span class="c">#    kube-system          kindnet-zlwz2                                1/1     Running   0          67s</span>
<span class="c">#    kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          74s</span>
<span class="c">#    kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          74s</span>
<span class="c">#    kube-system          kube-proxy-nbp2t                             1/1     Running   0          67s</span>
<span class="c">#    kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          74s</span>
<span class="c">#    local-path-storage   local-path-provisioner-58cc7856b6-wl6z8      1/1     Running   0          67s</span>
<span class="nv">$ </span>kubectl get componentstatuses
<span class="c"># =&gt; NAME                 STATUS    MESSAGE   ERROR</span>
<span class="c">#    controller-manager   Healthy   ok</span>
<span class="c">#    scheduler            Healthy   ok</span>
<span class="c">#    etcd-0               Healthy   ok</span>

<span class="c"># 컨트롤플레인 (컨테이너) 노드 1대가 실행</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS                 PORTS                                              NAMES</span>
<span class="c">#    3d4063180754   kindest/node:v1.32.0   &amp;quot;/usr/local/bin/entr…&amp;quot;   About a minute ago   Up About a minute      127.0.0.1:64234-&amp;gt;6443/tcp                          kind-control-plane</span>
<span class="c">#    110494b9ca48   gogs/gogs              &amp;quot;/app/gogs/docker/st…&amp;quot;   19 hours ago         Up 5 hours (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins        &amp;quot;/usr/bin/tini -- /u…&amp;quot;   19 hours ago         Up 4 hours             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>
<span class="nv">$ </span>docker images
<span class="c"># =&gt; REPOSITORY                                                                   TAG           IMAGE ID       CREATED         SIZE</span>
<span class="c">#    kindest/node                                                                 &amp;lt;none&amp;gt;        b5a8f8764a3e   7 days ago      1.05GB</span>

<span class="c"># kube config 파일 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
<span class="c"># 혹은</span>
<span class="c"># $ cat $KUBECONFIG # KUBECONFIG 변수 지정 사용 시</span>

<span class="c"># nginx 파드 배포 및 확인 : 컨트롤플레인 노드인데 파드가 배포 될까요?</span>
<span class="nv">$ </span>kubectl run nginx <span class="nt">--image</span><span class="o">=</span>nginx:alpine
<span class="c"># =&gt; pod/nginx created</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME    READY   STATUS    RESTARTS   AGE   IP           NODE                 NOMINATED NODE   READINESS GATES</span>
<span class="c">#    nginx   1/1     Running   0          10s   10.244.0.5   kind-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># 노드에 Taints 정보 확인</span>
<span class="nv">$ </span>kubectl describe node | <span class="nb">grep </span>Taints
<span class="c"># =&gt; Taints:             &amp;lt;none&amp;gt;</span>

<span class="c"># 클러스터 삭제</span>
<span class="nv">$ </span>kind delete cluster
<span class="c"># =&gt; Deleting cluster &amp;quot;kind&amp;quot; ...</span>
<span class="c">#    Deleted nodes: [&amp;quot;kind-control-plane&amp;quot;]</span>

<span class="c"># kube config 삭제 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
<span class="c"># 혹은</span>
<span class="c"># $ cat $KUBECONFIG # KUBECONFIG 변수 지정 사용 시</span>
</code></pre></div></div>

<h4 id="kind로-kubernetes-클러스터-배포---3노드">Kind로 Kubernetes 클러스터 배포 - 3노드</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 클러스터 배포 전 확인</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE             COMMAND                  CREATED        STATUS                 PORTS                                              NAMES</span>
<span class="c">#    110494b9ca48   gogs/gogs         &amp;quot;/app/gogs/docker/st…&amp;quot;   19 hours ago   Up 5 hours (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins   &amp;quot;/usr/bin/tini -- /u…&amp;quot;   19 hours ago   Up 4 hours             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>

<span class="c"># 방안1 : 환경변수 지정</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$PWD</span>/kubeconfig

<span class="c"># Create a cluster with kind</span>
<span class="c"># $ MyIP=&lt;각자 자신의 PC IP&gt;</span>
<span class="nv">$ MyIP</span><span class="o">=</span>10.0.4.3

<span class="nv">$ </span><span class="nb">cd</span> ..
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> kind-3node.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
networking:
  apiServerAddress: "</span><span class="nv">$MyIP</span><span class="sh">"
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  - containerPort: 30003
    hostPort: 30003
- role: worker
- role: worker
</span><span class="no">EOF
</span><span class="nv">$ </span>kind create cluster <span class="nt">--config</span> kind-3node.yaml <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.30.6
<span class="c"># =&gt; Creating cluster &amp;quot;myk8s&amp;quot; ...</span>
<span class="c">#     ✓ Ensuring node image (kindest/node:v1.30.6) 🖼</span>
<span class="c">#     ✓ Preparing nodes 📦 📦 📦</span>
<span class="c">#     ✓ Writing configuration 📜</span>
<span class="c">#     ✓ Starting control-plane 🕹️</span>
<span class="c">#     ✓ Installing CNI 🔌</span>
<span class="c">#     ✓ Installing StorageClass 💾</span>
<span class="c">#     ✓ Joining worker nodes 🚜</span>
<span class="c">#    Set kubectl context to &amp;quot;kind-myk8s&amp;quot;</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-myk8s</span>
<span class="c">#    </span>
<span class="c">#    Thanks for using kind! 😊</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kind get nodes <span class="nt">--name</span> myk8s
<span class="c"># =&gt; myk8s-control-plane</span>
<span class="c">#    myk8s-worker</span>
<span class="c">#    myk8s-worker2</span>
<span class="nv">$ </span>kubens default
<span class="c"># =&gt; Context &amp;quot;kind-myk8s&amp;quot; modified.</span>
<span class="c">#    Active namespace is &amp;quot;default&amp;quot;.</span>

<span class="c"># kind 는 별도 도커 네트워크 생성 후 사용 : 기본값 172.18.0.0/16</span>
<span class="nv">$ </span>docker network <span class="nb">ls</span>
<span class="c"># =&gt; NETWORK ID     NAME                     DRIVER    SCOPE</span>
<span class="c">#    8204a0851463   host                     host      local</span>
<span class="c">#    3bbcc6aa8f38   kind                     bridge    local</span>
<span class="nv">$ </span>docker inspect kind | jq
<span class="c"># =&gt; [</span>
<span class="c">#      {</span>
<span class="c">#        &amp;quot;Name&amp;quot;: &amp;quot;kind&amp;quot;,</span>
<span class="c">#        &amp;quot;Id&amp;quot;: &amp;quot;3bbcc6aa8f388f86f02478f41de1e4dd917e5812b6cf6257972e4af0bedf5021&amp;quot;,</span>
<span class="c">#        &amp;quot;Created&amp;quot;: &amp;quot;2024-10-01T11:37:09.195259833Z&amp;quot;,</span>
<span class="c">#        &amp;quot;Scope&amp;quot;: &amp;quot;local&amp;quot;,</span>
<span class="c">#        &amp;quot;Driver&amp;quot;: &amp;quot;bridge&amp;quot;,</span>
<span class="c">#        &amp;quot;EnableIPv6&amp;quot;: true,</span>
<span class="c">#        &amp;quot;IPAM&amp;quot;: {</span>
<span class="c">#          &amp;quot;Driver&amp;quot;: &amp;quot;default&amp;quot;,</span>
<span class="c">#          &amp;quot;Options&amp;quot;: {},</span>
<span class="c">#          &amp;quot;Config&amp;quot;: [</span>
<span class="c">#            {</span>
<span class="c">#              &amp;quot;Subnet&amp;quot;: &amp;quot;172.20.0.0/16&amp;quot;,</span>
<span class="c">#              &amp;quot;Gateway&amp;quot;: &amp;quot;172.20.0.1&amp;quot;</span>
<span class="c">#            }</span>
<span class="c">#          ]</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;Internal&amp;quot;: false,</span>
<span class="c">#        &amp;quot;Attachable&amp;quot;: false,</span>
<span class="c">#        &amp;quot;Ingress&amp;quot;: false,</span>
<span class="c">#        &amp;quot;ConfigFrom&amp;quot;: {</span>
<span class="c">#          &amp;quot;Network&amp;quot;: &amp;quot;&amp;quot;</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;ConfigOnly&amp;quot;: false,</span>
<span class="c">#        &amp;quot;Containers&amp;quot;: {</span>
<span class="c">#          &amp;quot;35739bf3542771236d47fd4dcb27da13814184a3de57c7203904f66ecbab4710&amp;quot;: {</span>
<span class="c">#            &amp;quot;Name&amp;quot;: &amp;quot;myk8s-worker&amp;quot;,</span>
<span class="c">#            &amp;quot;EndpointID&amp;quot;: &amp;quot;5de8e9e48e611f2c4cb908649f5dcdf63c82d624b85f85a6573ced7cbd454554&amp;quot;,</span>
<span class="c">#            &amp;quot;MacAddress&amp;quot;: &amp;quot;02:42:ac:14:00:03&amp;quot;,</span>
<span class="c">#            &amp;quot;IPv4Address&amp;quot;: &amp;quot;172.20.0.3/16&amp;quot;,</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;48023a25d056141b00747f14ff52da2b46c46c0d0edbeb714dedd1f3c71360e4&amp;quot;: {</span>
<span class="c">#            &amp;quot;Name&amp;quot;: &amp;quot;myk8s-control-plane&amp;quot;,</span>
<span class="c">#            &amp;quot;EndpointID&amp;quot;: &amp;quot;9d51136474882d6ca7a4aabe7291e26527f44c3b88c7191b654506fdf1d65c84&amp;quot;,</span>
<span class="c">#            &amp;quot;MacAddress&amp;quot;: &amp;quot;02:42:ac:14:00:04&amp;quot;,</span>
<span class="c">#            &amp;quot;IPv4Address&amp;quot;: &amp;quot;172.20.0.4/16&amp;quot;,</span>
<span class="c">#          },</span>
<span class="c">#          &amp;quot;fefdfb00a2228f646119483a24503e1dc8bd74292e462fc9fa2ef3446004b4af&amp;quot;: {</span>
<span class="c">#            &amp;quot;Name&amp;quot;: &amp;quot;myk8s-worker2&amp;quot;,</span>
<span class="c">#            &amp;quot;EndpointID&amp;quot;: &amp;quot;c669ce7940abb8722b7ac41cc533c260838d31881c915a49147829e9d28a746c&amp;quot;,</span>
<span class="c">#            &amp;quot;MacAddress&amp;quot;: &amp;quot;02:42:ac:14:00:02&amp;quot;,</span>
<span class="c">#            &amp;quot;IPv4Address&amp;quot;: &amp;quot;172.20.0.2/16&amp;quot;,</span>
<span class="c">#          }</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;Options&amp;quot;: {</span>
<span class="c">#          &amp;quot;com.docker.network.bridge.enable_ip_masquerade&amp;quot;: &amp;quot;true&amp;quot;,</span>
<span class="c">#          &amp;quot;com.docker.network.driver.mtu&amp;quot;: &amp;quot;1500&amp;quot;</span>
<span class="c">#        },</span>
<span class="c">#        &amp;quot;Labels&amp;quot;: {}</span>
<span class="c">#      }</span>
<span class="c">#    ]</span>

<span class="c"># k8s api 주소 확인 : 어떻게 로컬에서 접속이 되는 걸까?</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://10.0.4.3:51235</span>
<span class="c">#    CoreDNS is running at https://10.0.4.3:51235/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="c">#    </span>
<span class="c">#    To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 docker가 10.0.4.3:51235 접속시 kind 컨테이너의 6443 포트로 포워딩 해주고&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   ~/.kube/config 에서 10.0.4.3:51235를 apiserver 주소로 지정하고 있기 때문에 접속이 가능합니다.&lt;/span&gt;</span>

<span class="c"># 노드 정보 확인 : CRI 는 containerd 사용</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   3m8s    v1.30.6   172.20.0.4    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker          Ready    &amp;lt;none&amp;gt;          2m48s   v1.30.6   172.20.0.3    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>
<span class="c">#    myk8s-worker2         Ready    &amp;lt;none&amp;gt;          2m48s   v1.30.6   172.20.0.2    &amp;lt;none&amp;gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://1.7.18</span>

<span class="c"># 파드 정보 확인 : CNI 는 kindnet 사용</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-o</span> wide
<span class="c"># =&gt; NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE     IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system          coredns-55cb58b774-m7h2c                      1/1     Running   0          3m7s    10.244.0.2   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          coredns-55cb58b774-z88v5                      1/1     Running   0          3m7s    10.244.0.3   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          etcd-myk8s-control-plane                      1/1     Running   0          3m22s   172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kindnet-mp6mj                                 1/1     Running   0          3m7s    172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kindnet-q2k9w                                 1/1     Running   0          3m4s    172.20.0.2   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kindnet-t99c4                                 1/1     Running   0          3m4s    172.20.0.3   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-apiserver-myk8s-control-plane            1/1     Running   0          3m21s   172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-controller-manager-myk8s-control-plane   1/1     Running   0          3m21s   172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-proxy-f85sx                              1/1     Running   0          3m7s    172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-proxy-ltckc                              1/1     Running   0          3m4s    172.20.0.2   myk8s-worker2         &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-proxy-njr42                              1/1     Running   0          3m4s    172.20.0.3   myk8s-worker          &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    kube-system          kube-scheduler-myk8s-control-plane            1/1     Running   0          3m21s   172.20.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    local-path-storage   local-path-provisioner-7d4d9bdcc5-jhl5h       1/1     Running   0          3m7s    10.244.0.4   myk8s-control-plane   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># 쿠버네티스 네임스페이스 확인 &gt;&gt; 도커 컨테이너에서 배운 네임스페이스와 다릅니다!</span>
<span class="nv">$ </span>kubectl get namespaces
<span class="c"># =&gt; NAME                 STATUS   AGE</span>
<span class="c">#    default              Active   3m42s</span>
<span class="c">#    kube-node-lease      Active   3m42s</span>
<span class="c">#    kube-public          Active   3m42s</span>
<span class="c">#    kube-system          Active   3m42s</span>
<span class="c">#    local-path-storage   Active   3m35s</span>

<span class="c"># 컨트롤플레인/워커 노드(컨테이너) 확인 : 도커 컨테이너 이름은 myk8s-control-plane , myk8s-worker/worker-2 임을 확인</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS                 PORTS                                                            NAMES</span>
<span class="c">#    35739bf35427   kindest/node:v1.30.6   &amp;quot;/usr/local/bin/entr…&amp;quot;   4 minutes ago   Up 4 minutes                                                                            myk8s-worker</span>
<span class="c">#    48023a25d056   kindest/node:v1.30.6   &amp;quot;/usr/local/bin/entr…&amp;quot;   4 minutes ago   Up 4 minutes           0.0.0.0:30000-30003-&amp;gt;30000-30003/tcp, 10.0.4.3:51235-&amp;gt;6443/tcp   myk8s-control-plane</span>
<span class="c">#    fefdfb00a222   kindest/node:v1.30.6   &amp;quot;/usr/local/bin/entr…&amp;quot;   4 minutes ago   Up 4 minutes                                                                            myk8s-worker2</span>
<span class="nv">$ </span>docker images

<span class="c"># 디버그용 내용 출력에 ~/.kube/config 권한 인증 로드</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-v6</span>
<span class="c"># =&gt; I1221 20:19:47.265879   56969 loader.go:395] Config loaded from file:  /Users/anonym/Documents/GitHub/cicd-lite/w3/1/dev-app/kubeconfig</span>
<span class="c">#    I1221 20:19:47.354543   56969 round_trippers.go:553] GET https://10.0.4.3:51235/api/v1/namespaces/default/pods?limit=500 200 OK in 79 milliseconds</span>
<span class="c">#    No resources found in default namespace.</span>

<span class="c"># kube config 파일 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$KUBECONFIG</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> <span class="nv">$KUBECONFIG</span>
<span class="c"># =&gt; .rw------- anonym staff 5.5 KB Sat Oct 01 20:16:21 2024  /Users/user/Documents/GitHub/cicd-lite/w3/1/dev-app/kubeconfig</span>
</code></pre></div></div>

<h5 id="kube-ops-view-설치">kube-ops-view 설치</h5>

<ul>
  <li>kube-ops-view는 쿠버네티스 클러스터의 상태를 시각적으로 보여주는 대시보드입니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kube-ops-view</span>
<span class="c"># helm show values geek-cookbook/kube-ops-view</span>
<span class="nv">$ </span>helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
<span class="nv">$ </span>helm <span class="nb">install </span>kube-ops-view geek-cookbook/kube-ops-view <span class="nt">--version</span> 1.2.2 <span class="nt">--set</span> service.main.type<span class="o">=</span>NodePort,service.main.ports.http.nodePort<span class="o">=</span>30001 <span class="nt">--set</span> env.TZ<span class="o">=</span><span class="s2">"Asia/Seoul"</span> <span class="nt">--namespace</span> kube-system

<span class="c"># 설치 확인</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep <span class="nt">-n</span> kube-system <span class="nt">-l</span> app.kubernetes.io/instance<span class="o">=</span>kube-ops-view
<span class="c"># =&gt; NAME                            READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/kube-ops-view   1/1     1            1           25s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                 READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/kube-ops-view-796947d6dc-6b6xx   1/1     Running   0          25s</span>
<span class="c">#    </span>
<span class="c">#    NAME                    TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/kube-ops-view   NodePort   10.96.18.59   &amp;lt;none&amp;gt;        8080:30001/TCP   25s</span>
<span class="c">#    </span>
<span class="c">#    NAME                      ENDPOINTS         AGE</span>
<span class="c">#    endpoints/kube-ops-view   10.244.1.2:8080   25s</span>

<span class="c"># kube-ops-view 접속 URL 확인 (1.5 , 2 배율)</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:30001/#scale=1.5"</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:30001/#scale=2"</span>
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_10.png" alt="img.png" class="w-80 image-center" loading="lazy" width="558" height="271"></p>

<h5 id="클러스터-삭제">클러스터 삭제</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 클러스터 삭제</span>
<span class="nv">$ </span>kind delete cluster <span class="nt">--name</span> myk8s
<span class="c"># =&gt; Deleting cluster &amp;quot;myk8s&amp;quot; ...</span>
<span class="c">#    Deleted nodes: [&amp;quot;myk8s-worker&amp;quot; &amp;quot;myk8s-control-plane&amp;quot; &amp;quot;myk8s-worker2&amp;quot;]</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE             COMMAND                  CREATED        STATUS                 PORTS                                              NAMES</span>
<span class="c">#    110494b9ca48   gogs/gogs         &amp;quot;/app/gogs/docker/st…&amp;quot;   19 hours ago   Up 6 hours (healthy)   0.0.0.0:3000-&amp;gt;3000/tcp, 0.0.0.0:10022-&amp;gt;22/tcp      gogs</span>
<span class="c">#    8b7c591c828d   jenkins/jenkins   &amp;quot;/usr/bin/tini -- /u…&amp;quot;   19 hours ago   Up 5 hours             0.0.0.0:8080-&amp;gt;8080/tcp, 0.0.0.0:50000-&amp;gt;50000/tcp   jenkins</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$KUBECONFIG</span>
<span class="nv">$ </span><span class="nb">unset </span>KUBECONFIG
</code></pre></div></div>

<h4 id="jenkins-설정--plugin-설치-자격증명-설정">Jenkins 설정 : Plugin 설치, 자격증명 설정</h4>

<ul>
  <li>Jenkins Plugin 설치 : Dashboard &gt; Manage Jenkins &gt; Plugins &gt; Available plugins 탭에서 설치
    <ul>
      <li>
<strong>Pipeline Stage View</strong> - <a href="https://plugins.jenkins.io/pipeline-stage-view/">Docs</a>
</li>
      <li>
<strong>Docker Pipeline</strong> : building, testing, and using Docker images from Jenkins Pipeline - <a href="https://plugins.jenkins.io/docker-workflow/">Docs</a>
</li>
      <li>
<strong>Gogs</strong> : Webhook Plugin - <a href="https://plugins.jenkins.io/gogs-webhook/">Docs</a>
        <ul>
          <li>예시 : <code class="language-plaintext highlighter-rouge">http(s)://&lt;&lt; jenkins-server &gt;&gt;/gogs-webhook/?job=&lt;&lt;jobname&gt;&gt;</code>
</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>자격증명 설정 : Dashboard &gt; Manage Jenkins &gt; Credentials &gt; Global &gt; Add Credentials 에서 추가
    <ol>
      <li>Gogs Repo 자격증명 설정 : <strong>gogs-crd</strong>
        <ul>
          <li>Kind : Username with password</li>
          <li>Username : <code class="language-plaintext highlighter-rouge">devops</code>
</li>
          <li>Password : <code class="language-plaintext highlighter-rouge">&lt;Gogs 토큰&gt;</code>
</li>
          <li>ID : <code class="language-plaintext highlighter-rouge">gogs-crd</code>
</li>
        </ul>
      </li>
      <li>도커 허브 자격증명 설정 : <strong>dockerhub-crd</strong>
        <ul>
          <li>Kind : Username with password</li>
          <li>Username : <code class="language-plaintext highlighter-rouge">&lt;도커 계정명&gt;</code>
</li>
          <li>Password : <code class="language-plaintext highlighter-rouge">&lt;도커 계정 암호 혹은 토큰&gt;</code>
</li>
          <li>ID : <code class="language-plaintext highlighter-rouge">dockerhub-crd</code>
</li>
        </ul>
      </li>
      <li>k8s(kind) 자격증명 설정 : <strong>k8s-crd</strong>
        <ul>
          <li>Kind : <code class="language-plaintext highlighter-rouge">Secret file</code>
</li>
          <li>File : <code class="language-plaintext highlighter-rouge">&lt;kubeconfig 파일 업로드&gt;</code>
</li>
          <li>ID : <code class="language-plaintext highlighter-rouge">k8s-crd</code>
</li>
        </ul>
      </li>
    </ol>
  </li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_11.png" alt="img.png" class="image-center" loading="lazy" width="1212" height="776">
<em class="image-caption">Jenkins 자격증명 설정 결과</em></p>

<h5 id="jenkins-item-생성-pipeline">Jenkins item 생성 (Pipeline)</h5>

<ul>
  <li>간단한 Pipeline 스크립트를 작성하여 gogs와 도커허브의 자격증명이 잘 연동됨을 확인해보겠습니다.</li>
  <li>아래의 Pipeline 스크립트를 <code class="language-plaintext highlighter-rouge">pipeline-ci</code>라는 이름으로 생성합니다.</li>
</ul>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">DOCKER_IMAGE</span> <span class="o">=</span> <span class="s1">'&lt;자신의 도커 허브 계정&gt;/dev-app'</span> <span class="c1">// Docker 이미지 이름</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Checkout'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                 <span class="n">git</span> <span class="nl">branch:</span> <span class="s1">'main'</span><span class="o">,</span>
                 <span class="nl">url:</span> <span class="s1">'http://&lt;PC의 IP&gt;:3000/devops/dev-app.git'</span><span class="o">,</span>  <span class="c1">// Git에서 코드 체크아웃</span>
                 <span class="nl">credentialsId:</span> <span class="s1">'gogs-crd'</span>  <span class="c1">// Credentials ID</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Read VERSION'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="c1">// VERSION 파일 읽기</span>
                    <span class="kt">def</span> <span class="n">version</span> <span class="o">=</span> <span class="n">readFile</span><span class="o">(</span><span class="s1">'VERSION'</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span>
                    <span class="n">echo</span> <span class="s2">"Version found: ${version}"</span>
                    <span class="c1">// 환경 변수 설정</span>
                    <span class="n">env</span><span class="o">.</span><span class="na">DOCKER_TAG</span> <span class="o">=</span> <span class="n">version</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Docker Build and Push'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s1">'https://index.docker.io/v1/'</span><span class="o">,</span> <span class="s1">'dockerhub-crd'</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// DOCKER_TAG 사용</span>
                        <span class="kt">def</span> <span class="n">appImage</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="s2">"${DOCKER_IMAGE}:${DOCKER_TAG}"</span><span class="o">)</span>
                        <span class="n">appImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
                        <span class="n">appImage</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="s2">"latest"</span><span class="o">)</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">post</span> <span class="o">{</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s2">"Docker image ${DOCKER_IMAGE}:${DOCKER_TAG} has been built and pushed successfully!"</span>
        <span class="o">}</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s2">"Pipeline failed. Please check the logs."</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>지금 빌드 =&gt; 콘솔 Output 확인
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_12.png" alt="img.png" class="image-center" loading="lazy" width="1504" height="751">
</li>
  <li>도커 허브 확인
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_13.png" alt="img.png" class="image-center" loading="lazy" width="1212" height="843">
    <ul>
      <li>자격증명들이 잘 연동되어, 파이프라인에서 지정한것 처럼 버전명의 태그(0.0.1)과 latest 태그가 잘 생성되었습니다!</li>
    </ul>
  </li>
</ul>

<h4 id="kubernetes-클러스터에-응용프로그램-배포하기">Kubernetes 클러스터에 응용프로그램 배포하기</h4>

<ul>
  <li>Jenkins Pipeline을 통해 Kubernetes 클러스터에 응용프로그램을 배포해보겠습니다.</li>
  <li>먼저 Kubernetes 클러스터에 배포할때 사용하는 deployment에 대해 알아보겠습니다.</li>
</ul>

<h5 id="deployment-소개">Deployment 소개</h5>

<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<div class="mermaid">
  graph TD
      subgraph Deployment
          subgraph ReplicaSet
              direction TB
              subgraph Pod[Pod]
                  direction LR
                  Container1(Container)
                  Container2(Container)
              end
              subgraph Pod2[Pod]
                  direction LR
                  Container3(Container)
                  Container4(Container)
              end
              subgraph Pod3[Pod]
                  direction LR
                  Container5(Container)
              end
          end
      end
  classDef Pod fill:#fff,stroke:#ccc,stroke-width:2px;
  classDef ReplicaSet fill:#fff,stroke:#ccc,stroke-width:2px;
  classDef Deployment fill:#fff,stroke:#ccc,stroke-width:2px;
  class Pod,Pod2,Pod3 Pod;
  class Deployment Deployment;
  </div>
<p><em class="image-caption">Kubernetes 배포 구조</em></p>

<ul>
  <li>Kubernetes를 배포하는 최소단위는 <strong>Pod</strong>이며, <strong>하나 이상의 컨테이너로 구성</strong>됩니다.</li>
  <li>Pod는 <strong>ReplicaSet</strong>에 의해 관리되며, ReplicaSet은 <strong>Pod의 수를 유지하도록 관리</strong>합니다.</li>
  <li>
    <p><strong>Deployment</strong>는 <strong>ReplicaSet을 관리하며, Pod의 배포 및 업데이트를 관리</strong>합니다.</p>
  </li>
  <li>Kubernetes는 manifest라는 yaml 파일을 통해 리소스를 정의하고, 선언형 방식으로 원하는 상태를 선언시 해당 상태를 충족시키기 위해 클러스터를 조정합니다.</li>
  <li>아래는 kubernetes의 manifest의 구조입니다.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>apiVersion: ...   <span class="c"># &lt;span style="color: green;"&gt;👉 리소스를 만드는데 사용할 Kubernetes API 버전&lt;/span&gt;</span>
kind: ...         <span class="c"># &lt;span style="color: green;"&gt;👉 만들고자 하는 리소스의 종류&lt;/span&gt;</span>
metadata:
    ...           <span class="c"># &lt;span style="color: green;"&gt;👉 리소스를 식별하는 고유 데이터와 상태와 관련없는 메타데이터&lt;/span&gt;</span>
spec:
    ...           <span class="c"># &lt;span style="color: green;"&gt;👉 리소스의 원하는 상태를 정의&lt;/span&gt;</span>
</code></pre></div>    </div>
  </li>
</ul>

<h5 id="deployment-배포-실습">Deployment 배포 실습</h5>

<ul>
  <li>
    <p>앞서 작성한 Jenkins Pipeline을 통해 빌드된 도커 이미지를 Kubernetes 클러스터에 응용프로그램을 배포해보겠습니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 디플로이먼트 오브젝트 배포 : 리플리카(파드 2개), 컨테이너 이미지 &gt;&gt; 아래 도커 계정 부분만 변경해서 배포해보자</span>
<span class="c">#$ DHUSER=&lt;도커 허브 계정명&gt;</span>
<span class="nv">$ DHUSER</span><span class="o">=</span>sweetlittlebird
  
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: timeserver
spec:
  replicas: 2
  selector:
    matchLabels:
      pod: timeserver-pod
  template:
    metadata:
      labels:
        pod: timeserver-pod
    spec:
      containers:
      - name: timeserver-container
        image: docker.io/</span><span class="nv">$DHUSER</span><span class="sh">/dev-app:0.0.1
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/timeserver created</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get deploy,pod <span class="nt">-o</span> wide
  
<span class="c"># 배포 상태 확인 : kube-ops-view 웹 확인</span>
<span class="nv">$ </span>kubectl get deploy,pod <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                         READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS             IMAGES                                    SELECTOR</span>
<span class="c">#    deployment.apps/timeserver   0/2     2            0           45s   timeserver-container   docker.io/sweetlittlebird/dev-app:0.0.1   pod=timeserver-pod</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS             RESTARTS   AGE   IP           NODE            NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/timeserver-5b5ff6d859-s282p   0/1     &lt;span style="color: red;"&gt;ImagePullBackOff&lt;/span&gt;   0          45s   10.244.2.2   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/timeserver-5b5ff6d859-v7gs7   0/1     &lt;span style="color: red;"&gt;ImagePullBackOff&lt;/span&gt;   0          45s   10.244.1.2   myk8s-worker    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 배포상태가 ImagePullBackOff로 배포가 되지 않았습니다.&lt;/span&gt;</span>
  
<span class="nv">$ </span>kubectl describe pod
<span class="c"># =&gt; Name:             timeserver-5b5ff6d859-s282p</span>
<span class="c">#    ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type     Reason     Age                    From               Message</span>
<span class="c">#      ----     ------     ----                   ----               -------</span>
<span class="c">#      Normal   Scheduled  5m38s                  default-scheduler  Successfully assigned default/timeserver-5b5ff6d859-s282p to myk8s-worker2</span>
<span class="c">#      Normal   Pulling    4m4s (x4 over 5m37s)   kubelet            Pulling image &amp;quot;docker.io/sweetlittlebird/dev-app:0.0.1&amp;quot;</span>
<span class="c">#      Warning  Failed     4m3s (x4 over 5m35s)   kubelet            Failed to pull image &amp;quot;docker.io/sweetlittlebird/dev-app:0.0.1&amp;quot;: failed to pull and unpack image &amp;quot;docker.io/sweetlittlebird/dev-app:0.0.1&amp;quot;: failed to resolve reference &amp;quot;docker.io/sweetlittlebird/dev-app:0.0.1&amp;quot;: pull access denied, repository does not exist or may require authorization: server message: insufficient_scope: authorization failed</span>
<span class="c">#      Warning  Failed     4m3s (x4 over 5m35s)   kubelet            Error: ErrImagePull</span>
<span class="c">#      Warning  Failed     3m48s (x6 over 5m35s)  kubelet            Error: ImagePullBackOff</span>
<span class="c">#      Normal   BackOff    22s (x20 over 5m35s)   kubelet            Back-off pulling image &amp;quot;docker.io/sweetlittlebird/dev-app:0.0.1&amp;quot;```</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_14.png" alt="img.png" class="image-center" loading="lazy" width="815" height="553">
<em class="image-caption">Kube-Ops-View를 통해 살펴본 Kubernetes 클러스터에 timeserver 배포 실패</em></p>

<ul>
  <li>위와 같이 Image pull error가 나면서 배포가 실패했습니다.</li>
  <li>
<code class="language-plaintext highlighter-rouge">kubectl describe pod</code>를 통해 확인한 결과, <code class="language-plaintext highlighter-rouge">pull access denied, repository does not exist or may require authorization: server message: insufficient_scope: authorization failed</code>와 같은 메시지가 나타나고
이는 Kubernetes 클러스터에서 도커 이미지를 pull할 때 도커 허브에 인증 토큰이 되어있지 않아서 발생한 문제를 의미합니다.</li>
  <li>도커 허브의 인증토큰을 등록하고 다시 시도해보겠습니다.</li>
</ul>

<h4 id="k8s에-docker-hub-인증토큰-등록-후-다시-배포">K8S에 Docker Hub 인증토큰 등록 후 다시 배포</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s secret : 도커 자격증명 설정</span>
 
<span class="nv">$ </span>kubectl get secret <span class="nt">-A</span>  <span class="c"># 기존 시크릿 확인</span>
<span class="c"># =&gt; NAMESPACE     NAME                                  TYPE                            DATA   AGE</span>
<span class="c">#    kube-system   bootstrap-token-abcdef                bootstrap.kubernetes.io/token   6      164m</span>
<span class="c">#    kube-system   sh.helm.release.v1.kube-ops-view.v1   helm.sh/release.v1              1      25m</span>

<span class="c">#$ DHUSER=&lt;도커 허브 계정&gt;</span>
<span class="c">#$ DHPASS=&lt;도커 허브 암호 혹은 토큰&gt;</span>

<span class="nv">$ DHUSER</span><span class="o">=</span>sweetlittlebird
<span class="nv">$ DHPASS</span><span class="o">=</span>dckr_<span class="k">****</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$DHUSER</span> <span class="nv">$DHPASS</span>
<span class="c"># =&gt; sweetlittlebird dckr_****</span>

<span class="c"># 도커 허브 시크릿 생성</span>
<span class="nv">$ </span>kubectl create secret docker-registry dockerhub-secret <span class="se">\</span>
  <span class="nt">--docker-server</span><span class="o">=</span>https://index.docker.io/v1/ <span class="se">\</span>
  <span class="nt">--docker-username</span><span class="o">=</span><span class="nv">$DHUSER</span> <span class="se">\</span>
  <span class="nt">--docker-password</span><span class="o">=</span><span class="nv">$DHPASS</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get secret
<span class="c"># =&gt; NAME               TYPE                             DATA   AGE</span>
<span class="c">#    dockerhub-secret   kubernetes.io/dockerconfigjson   1      8s</span>
<span class="nv">$ </span>kubectl describe secret
<span class="c"># =&gt; Name:         dockerhub-secret</span>
<span class="c">#    Namespace:    default</span>
<span class="c">#    Labels:       &amp;lt;none&amp;gt;</span>
<span class="c">#    Annotations:  &amp;lt;none&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    Type:  kubernetes.io/dockerconfigjson</span>
<span class="c">#    </span>
<span class="c">#    Data</span>
<span class="c">#    ====</span>
<span class="c">#    .dockerconfigjson:  205 bytes</span>
<span class="nv">$ </span>kubectl get secrets <span class="nt">-o</span> yaml | kubectl neat  <span class="c"># base64 인코딩 확인</span>
<span class="c"># =&gt; apiVersion: v1</span>
<span class="c">#    items:</span>
<span class="c">#    - apiVersion: v1</span>
<span class="c">#      data:</span>
<span class="c">#        .dockerconfigjson: eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJzZWNyZXRsaXR0bGViaXJkIiwicGFzc3dvcmQiOiJkY2tyX3BhdF9QdWNpVTRIMFBPZVpYWGNvV1VNd1ozTVpZVEUiLCJhdXRoIjoiYzJWamNtVjBiR2wwZEd4bFltbHlaRHBrWTJ0eVgzQmhkRjlRZFdOcFZUUklNRkJQWlZwWVdHTnZWMVZOZDFvelRWcFpWRVU9In19fQ==</span>
<span class="c">#      kind: Secret</span>
<span class="c">#      metadata:</span>
<span class="c">#        name: dockerhub-secret</span>
<span class="c">#        namespace: default</span>
<span class="c">#      type: kubernetes.io/dockerconfigjson</span>
<span class="c">#    kind: List</span>
<span class="c">#    metadata: {}</span>

<span class="nv">$ SECRET</span><span class="o">=</span><span class="nv">eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJzZWNyZXRsaXR0bGViaXJkIiwicGFzc3dvcmQiOiJkY2tyX3BhdF9QdWNpVTRIMFBPZVpYWGNvV1VNd1ozTVpZVEUiLCJhdXRoIjoiYzJWamNtVjBiR2wwZEd4bFltbHlaRHBrWTJ0eVgzQmhkRjlRZFdOcFZUUklNRkJQWlZwWVdHTnZWMVZOZDFvelRWcFpWRVU9In19fQ</span><span class="o">==</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SECRET</span><span class="s2">"</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="p">;</span> <span class="nb">echo</span>
<span class="c"># =&gt; {&amp;quot;auths&amp;quot;:{&amp;quot;https://index.docker.io/v1/&amp;quot;:{&amp;quot;username&amp;quot;:&amp;quot;sweetlittlebird&amp;quot;,&amp;quot;password&amp;quot;:&amp;quot;dckr_****&amp;quot;,&amp;quot;auth&amp;quot;:&amp;quot;c2VjcmV0bGl0dGxlYmlyZDpkY2tyX3BhdF9QdWNpVTRIMFBPZVpYWGNvV1VNd1ozTVpZVEU=&amp;quot;}}}</span>

<span class="c"># 도커허브 인증 토큰이 등록되었으니 다시 배포해보겠습니다.</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: timeserver
spec:
  replicas: 2
  selector:
    matchLabels:
      pod: timeserver-pod
  template:
    metadata:
      labels:
        pod: timeserver-pod
    spec:
      containers:
      - name: timeserver-container
        image: docker.io/</span><span class="nv">$DHUSER</span><span class="sh">/dev-app:0.0.1
      imagePullSecrets:
      - name: dockerhub-secret
</span><span class="no">EOF
</span><span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get deploy,pod <span class="nt">-o</span> wide

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get deploy,pod
<span class="c"># =&gt; NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/timeserver   2/2     2            2           39s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/timeserver-549cc9bc89-k6n6g   1/1     Running   0          39s</span>
<span class="c">#    pod/timeserver-549cc9bc89-kdmgx   1/1     Running   0          39s</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 배포가 잘 되었습니다!&lt;/span&gt;</span>

<span class="c"># 접속을 위한 curl 파드 생성</span>
<span class="nv">$ </span>kubectl run curl-pod <span class="nt">--image</span><span class="o">=</span>curlimages/curl:latest <span class="nt">--command</span> <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s2">"while true; do sleep 3600; done"</span>
<span class="c"># =&gt; pod/curl-pod created</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                          READY   STATUS    RESTARTS   AGE    IP           NODE            NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                      1/1     Running   0          22s    10.244.2.6   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    timeserver-549cc9bc89-k6n6g   1/1     Running   0          103s   10.244.2.5   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    timeserver-549cc9bc89-kdmgx   1/1     Running   0          103s   10.244.1.6   myk8s-worker    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>

<span class="c"># timeserver 파드 IP 1개 확인 후 접속 확인</span>
<span class="c">#$ PODIP1=&lt;timeserver-Y 파드 IP&gt;</span>
<span class="nv">$ PODIP1</span><span class="o">=</span>10.244.2.5

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nv">$PODIP1</span>
<span class="c"># =&gt; The time is 2:51:54 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-k6n6g</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nv">$PODIP1</span>
<span class="c"># =&gt; The time is 2:52:03 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-k6n6g</span>

<span class="c"># 로그 확인</span>
<span class="nv">$ </span>kubectl logs deploy/timeserver
<span class="nv">$ </span>kubectl logs deploy/timeserver <span class="nt">-f</span>
<span class="nv">$ </span>kubectl stern deploy/timeserver
<span class="nv">$ </span>kubectl stern <span class="nt">-l</span> <span class="nv">pod</span><span class="o">=</span>timeserver-pod
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_15.png" alt="img.png" class="image-center" loading="lazy" width="815" height="553"></p>

<ul>
  <li>kube-ops-view를 통해서도 배포가 잘 되었음을 확인할 수 있습니다.</li>
  <li>파드 1개 삭제 후 동작을 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="c">#$ POD1NAME=&lt;파드 1개 이름&gt;</span>
<span class="nv">$ POD1NAME</span><span class="o">=</span>timeserver-549cc9bc89-k6n6g

<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                          READY   STATUS    RESTARTS   AGE    IP           NODE            NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                      1/1     Running   0          22s    10.244.2.6   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    timeserver-549cc9bc89-k6n6g   1/1     Running   0          103s   10.244.2.5   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    timeserver-549cc9bc89-kdmgx   1/1     Running   0          103s   10.244.1.6   myk8s-worker    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="nv">$ </span>kubectl delete pod <span class="nv">$POD1NAME</span> <span class="o">&amp;&amp;</span> kubectl get pod <span class="nt">-w</span>
<span class="c"># =&gt; pod &amp;quot;timeserver-549cc9bc89-k6n6g&amp;quot; deleted              # &lt;span style="color: green;"&gt;👉 분명히 timeserver 파드 1개를 삭제하였는데&lt;/span&gt;</span>
<span class="c">#    NAME                          READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    curl-pod                      1/1     Running   0          115s</span>
<span class="c">#    timeserver-549cc9bc89-kdmgx   1/1     Running   0          7m20s</span>
<span class="c">#    timeserver-549cc9bc89-pvm5k   1/1     Running   0          31s   # &lt;span style="color: green;"&gt;👉 다시 새로운 파드가 생성되었습니다.&lt;/span&gt;</span>

<span class="c"># 셀프 힐링 , 파드 IP 변경 -&gt; 고정 진입점(고정 IP/도메인네임) 필요 =&gt; Service</span>
<span class="nv">$ </span>kubectl get deploy,rs,pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                         READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS             IMAGES                                    SELECTOR</span>
<span class="c">#    deployment.apps/timeserver   2/2     2            2           10m   timeserver-container   docker.io/sweetlittlebird/dev-app:0.0.1   pod=timeserver-pod</span>
<span class="c">#    </span>
<span class="c">#    NAME                                    DESIRED   CURRENT   READY   AGE   CONTAINERS             IMAGES                                    SELECTOR</span>
<span class="c">#    replicaset.apps/timeserver-549cc9bc89   2         2         2       10m   timeserver-container   docker.io/sweetlittlebird/dev-app:0.0.1   pod=timeserver-pod,pod-template-hash=549cc9bc89</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS    RESTARTS   AGE     IP           NODE            NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/curl-pod                      1/1     Running   0          4m56s   10.244.2.7   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/timeserver-549cc9bc89-kdmgx   1/1     Running   0          10m     10.244.1.6   myk8s-worker    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/timeserver-549cc9bc89-pvm5k   1/1     Running   0          3m32s   10.244.2.8   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
</code></pre></div></div>

<ul>
  <li>위와 같이 파드가 삭제되면 ReplicaSet에 의해 새로운 파드가 생성되는 것을 확인할 수 있습니다.</li>
  <li>이때 IP가 변경되어 새로운 파드가 생성되는데, 이렇게 되면 매번 파드가 생성될때 마다 IP가 변경되어 서비스를 제공하기 어렵습니다.</li>
  <li>이를 해결하기 위해 <strong>Service</strong>를 사용합니다.</li>
</ul>

<h5 id="service-소개">Service 소개</h5>

<ul>
  <li>
<strong>Service</strong>는 Pod의 집합에 대한 고정된 진입점을 제공합니다. 앞서 살펴본것과 같이 Pod는 생성/삭제되면 IP가 변경되는데, 이를 Service를 통해 고정된 IP로 접근할 수 있습니다.</li>
  <li>Deployment를 통해 Pod가 여러 개 생성되면, Service는 이들을 하나의 집합으로 묶어서 부하분산(Load Balancing)을 제공합니다.</li>
  <li>Service는 Deployment를 대상으로 하지않고, Pod를 대상으로 합니다. Pod의 Label Selector를 통해 Service는 Pod를 선택합니다. 
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_16.png" alt="img.png" class="image-center" loading="lazy" width="702" height="610">
<em class="image-caption">Service와 Deployment, Pod manifest의 관계</em>
</li>
  <li>Service는 다음과 같은 종류가 있습니다.
    <ul>
      <li>
<strong>ClusterIP</strong> : 클러스터 내부에서만 접근 가능합니다.</li>
      <li>
<strong>NodePort</strong> : 클러스터 내부에서는 물론 외부에서 접근 가능합니다. 이때 파드가 동작하는 노드 IP의 지정된 포트로 접근 가능합니다.</li>
      <li>
<strong>LoadBalancer</strong> : 클라우드 제공자의 로드밸런서를 사용하여 외부에서 접근 가능합니다.</li>
    </ul>
  </li>
</ul>

<h5 id="service-배포-실습">Service 배포 실습</h5>

<ul>
  <li>간단한 서비스를 배포해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 서비스 생성</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: timeserver
spec:
  selector:
    pod: timeserver-pod
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    nodePort: 30000
  type: NodePort
</span><span class="no">EOF
</span><span class="c"># =&gt; service/timeserver created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get service,ep timeserver <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span>
<span class="c">#    service/timeserver   NodePort   10.96.204.127   &amp;lt;none&amp;gt;        80:30000/TCP   13s   pod=timeserver-pod</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                     AGE</span>
<span class="c">#    endpoints/timeserver   10.244.1.6:80,10.244.2.8:80   13s</span>

<span class="c"># Service(ClusterIP)로 접속 확인 : 도메인네임 방식</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl timeserver
<span class="c"># =&gt; The time is 3:29:30 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl timeserver.default.svc.cluster.local
<span class="c"># =&gt; The time is 3:29:33 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>

<span class="c"># Service(ClusterIP)로 접속 확인 : 클러스터 IP 방식</span>
<span class="nv">$ </span>kubectl get svc timeserver <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span>
<span class="c"># =&gt; 10.96.204.127</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="si">$(</span>kubectl get svc timeserver <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.clusterIP<span class="o">}</span><span class="si">)</span>
<span class="c"># =&gt; The time is 3:29:40 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>

<span class="c"># Service(NodePort)로 접속 확인 "노드IP:NodePort"</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; The time is 3:32:43 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-&lt;span style="color: red;"&gt;kdmgx&lt;/span&gt;</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; The time is 3:32:59 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-&lt;span style="color: red;"&gt;pvm5k&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 서비스가 2개의 Pod 사이를 Load balancing 하는것을 확인 할 수 있습니다.&lt;/span&gt;</span>

<span class="c"># 반복 접속 해두기 : 부하분산 확인</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 | <span class="nb">grep </span>name <span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> http://127.0.0.1:30000 | <span class="nb">grep </span>name<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;   54 Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#      46 Server hostname: timeserver-549cc9bc89-kdmgx</span>

<span class="c"># 파드 복제복 증가 : service endpoint 대상에 자동 추가</span>
<span class="nv">$ </span>kubectl scale deployment timeserver <span class="nt">--replicas</span> 4
<span class="c"># =&gt; deployment.apps/timeserver scaled</span>
<span class="nv">$ </span>kubectl get service,ep timeserver <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span>
<span class="c">#    service/timeserver   NodePort   10.96.204.127   &amp;lt;none&amp;gt;        80:30000/TCP   37m   pod=timeserver-pod</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                                               AGE</span>
<span class="c">#    endpoints/timeserver   10.244.1.6:80,10.244.1.7:80,10.244.2.8:80 + 1 more...   37m</span>

<span class="c"># 반복 접속 해두기 : 부하분산 확인</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 | <span class="nb">grep </span>name <span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-h9q6p</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-h9q6p</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> http://127.0.0.1:30000 | <span class="nb">grep </span>name<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;   29 Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#      27 Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#      22 Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#      22 Server hostname: timeserver-549cc9bc89-h9q6p</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 파드 수 만큼 자동으로 로드밸런싱 되는것을 확인 할 수 있습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="앱-업데이트-후-재배포">앱 업데이트 후 재배포</h5>

<ul>
  <li>샘플 앱의 server.py와 VERSION 파일을 업데이트하고, Jenkins Pipeline을 통해 새로운 버전을 배포해보겠습니다.</li>
  <li>먼저 샘플 앱의 업데이트를 진행합니다.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 업데이트</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s/0.0.1/0.0.2/g'</span> server.py
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"0.0.2"</span> <span class="o">&gt;</span> VERSION
<span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Update to 0.0.2"</span>
<span class="c"># =&gt; main c17ce89] Update to 0.0.2</span>
<span class="c">#     2 files changed, 2 insertions(+), 2 deletions(-)</span>
<span class="nv">$ </span>git push origin main
<span class="c"># =&gt; Enumerating objects: 7, done.</span>
<span class="c">#    Counting objects: 100% (7/7), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (3/3), done.</span>
<span class="c">#    Writing objects: 100% (4/4), 332 bytes | 332.00 KiB/s, done.</span>
<span class="c">#    Total 4 (delta 2), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/dev-app.git</span>
<span class="c">#       3531233..c17ce89  main -&amp;gt; main</span>
</code></pre></div>    </div>
  </li>
  <li>Jenkins에서 Build Now를 클릭하여 통해 새로운 버전을 docker hub에 업로드 합니다.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_17.png" alt="img.png" loading="lazy" width="1006" height="199"></p>

<ul>
  <li>새로운 버전이 docker hub에 업로드 되었으니, Kubernetes 클러스터에 배포해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 파드 복제복 증가</span>
<span class="nv">$ </span>kubectl scale deployment timeserver <span class="nt">--replicas</span> 4
<span class="c"># =&gt; deployment.apps/timeserver scaled</span>
<span class="nv">$ </span>kubectl get service,ep timeserver <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span>
<span class="c">#    service/timeserver   NodePort   10.96.204.127   &amp;lt;none&amp;gt;        80:30000/TCP   45m   pod=timeserver-pod</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                                               AGE</span>
<span class="c">#    endpoints/timeserver   10.244.1.6:80,10.244.1.7:80,10.244.2.8:80 + 1 more...   45m</span>

<span class="c"># 반복 접속 해두기 : 부하분산 확인</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 | <span class="nb">grep </span>name <span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-h9q6p</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> http://127.0.0.1:30000 | <span class="nb">grep </span>name<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;   32 Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#      27 Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#      25 Server hostname: timeserver-549cc9bc89-kdmgx</span>
<span class="c">#      16 Server hostname: timeserver-549cc9bc89-h9q6p</span>

<span class="c"># 업데이트를 배포하기 위해서 kubectl set image를 통해 컨테이너 이미지를 변경합니다.</span>
<span class="c"># $ kubectl set image deployment timeserver timeserver-container=$DHUSER/dev-app:0.0.Y &amp;&amp; watch -d "kubectl get deploy,ep timeserver; echo; kubectl get rs,pod"</span>
<span class="nv">$ </span>kubectl <span class="nb">set </span>image deployment timeserver timeserver-container<span class="o">=</span><span class="nv">$DHUSER</span>/dev-app:0.0.2 <span class="o">&amp;&amp;</span> watch <span class="nt">-d</span> <span class="s2">"kubectl get deploy,ep timeserver; echo; kubectl get rs,pod"</span>
<span class="c"># =&gt; Every 2.0s: kubectl get deploy,ep timeserver; echo; kubectl get rs,pod                                                                 Balthazar.local: Sun Oct 01 01:17:30 2024</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS        RESTARTS   AGE</span>
<span class="c">#    pod/timeserver-549cc9bc89-h9q6p   1/1     Terminating   0          11m</span>
<span class="c">#    pod/timeserver-549cc9bc89-kdmgx   1/1     Terminating   0          88m</span>
<span class="c">#    pod/timeserver-549cc9bc89-pvm5k   1/1     Terminating   0          81m</span>
<span class="c">#    pod/timeserver-549cc9bc89-xlbck   1/1     Terminating   0          11m</span>
<span class="c">#    pod/timeserver-6f476fdbf-f8hw5    1/1     Running       0          9s</span>
<span class="c">#    pod/timeserver-6f476fdbf-k5fsn    1/1     Running       0          9s</span>
<span class="c">#    pod/timeserver-6f476fdbf-qq465    1/1     Running       0          4s</span>
<span class="c">#    pod/timeserver-6f476fdbf-tvrl5    1/1     Running       0          3s</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 기존 버전의 파드가 종료되고 새로운 파드가 replica 수 만큼 생성 되는 것을 확인 할 수 있습니다.&lt;/span&gt;</span>

<span class="c"># 롤링업데이트를 확인하기 위해 별도의 터미널에서 다음의 명령을 입력합니다.</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000<span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    The time is 4:17:24 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    The time is 4:17:25 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#    The time is 4:17:26 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-xlbck</span>
<span class="c">#    The time is 4:17:27 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-pvm5k</span>
<span class="c">#    The time is 4:17:28 PM, VERSION 0.0.2</span>
<span class="c">#    Server hostname: timeserver-6f476fdbf-k5fsn</span>
<span class="c">#    The time is 4:17:29 PM, VERSION 0.0.2</span>
<span class="c">#    Server hostname: timeserver-6f476fdbf-qq465</span>
<span class="c">#    The time is 4:17:30 PM, VERSION 0.0.2</span>
<span class="c">#    Server hostname: timeserver-6f476fdbf-tvrl5</span>
<span class="c">#    The time is 4:17:31 PM, VERSION 0.0.2</span>
<span class="c">#    Server hostname: timeserver-6f476fdbf-f8hw5</span>
<span class="c">#    The time is 4:17:32 PM, VERSION 0.0.2</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 롤링업데이트를 통해 서비스 중단 없이 배포가 잘 됨을 확인 할 수 있습니다.&lt;/span&gt;</span>


<span class="c"># 롤링 업데이트 확인</span>
<span class="nv">$ </span>kubectl get deploy,rs,pod,svc,ep <span class="nt">-owide</span>

<span class="c"># kubectl get deploy $DEPLOYMENT_NAME</span>
<span class="nv">$ </span>kubectl get deploy timeserver
<span class="c"># =&gt; NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    timeserver   4/4     4            4           90m</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 READY는 전체 replica 중 몇 개의 파드가 서비스가 가능한지 알려줍니다.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;    UP-TO-DATE는 몇 개의 파드가 현재의 버전(상태)인지 알려줍니다.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl get pods <span class="nt">-l</span> <span class="nv">pod</span><span class="o">=</span>timeserver-pod
<span class="c"># =&gt; NAME                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    timeserver-6f476fdbf-f8hw5   1/1     Running   0          3m3s</span>
<span class="c">#    timeserver-6f476fdbf-k5fsn   1/1     Running   0          3m3s</span>
<span class="c">#    timeserver-6f476fdbf-qq465   1/1     Running   0          2m58s</span>
<span class="c">#    timeserver-6f476fdbf-tvrl5   1/1     Running   0          2m57s</span>
</code></pre></div></div>

<h4 id="gogs-webhook을-통해-jenkins-pipeline-자동화">Gogs Webhook을 통해 Jenkins Pipeline 자동화</h4>

<ul>
  <li>Jenkins Pipeline을 통해 새로운 버전을 배포하는 과정을 자동화하기 위해 Gogs Webhook을 설정해보겠습니다.</li>
  <li>git push를 통해 새로운 버전을 업로드하면, Gogs Webhook을 통해 Jenkins Pipeline이 자동으로 실행되어 새로운 버전의 도커 이미지가 docker hub에 업로드되도록 합니다.</li>
</ul>

<h5 id="gogs-설정-수정-및-webhook-설정">Gogs 설정 수정 및 Webhook 설정</h5>

<ul>
  <li>
    <p>먼저 gogs 컨테이너의 app.ini 파일을 수정하여 jenkins가 gogs에 접근할 수 있도록 설정합니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># app.ini 파일 수정</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>gogs vi /data/gogs/conf/app.ini
</code></pre></div>    </div>

    <div class="language-ini highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># app.ini
</span><span class="err">...</span>
<span class="nn">[security]</span>
<span class="py">INSTALL_LOCK</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">SECRET_KEY</span>   <span class="p">=</span> <span class="s">atxaUPQcbAEwpIu</span>
<span class="py">LOCAL_NETWORK_ALLOWLIST</span> <span class="p">=</span> <span class="s">10.0.4.3 # 각자 자신의 PC IP</span>
<span class="err">...</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Gogs 컨테이너를 재기동합니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker compose restart gogs
</code></pre></div>    </div>
  </li>
  <li>
    <p>Gogs 에서 Webhook을 설정합니다.</p>
    <ol>
      <li>Repository를 선택후 우측의 Settings &gt; Webhooks &gt; Add a new webhook에서 Gogs를 선택합니다.
  <img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_18.png" alt="img.png" loading="lazy" width="1212" height="865">
</li>
      <li>Payload URL : <code class="language-plaintext highlighter-rouge">http://&lt;Jenkins의 IP = PC의 IP&gt;:8080/gogs-webhook/?job=SCM-Pipeline/</code>
</li>
      <li>Content Type : <code class="language-plaintext highlighter-rouge">application/json</code>
</li>
      <li>Secret : <code class="language-plaintext highlighter-rouge">qwe123</code>
</li>
      <li>When should this webhook be triggered? : Just the push event</li>
      <li>Active : 체크</li>
      <li>Add Webhook을 클릭하여 웹훅을 저장합니다.</li>
    </ol>
  </li>
</ul>

<h5 id="jenkins에서-gogs-webhook을-통한-pipeline-생성">Jenkins에서 Gogs Webhook을 통한 Pipeline 생성</h5>

<ul>
  <li>이번에는 Jenkins에서 앞서 생성한 Gogs Webhook을 통해 새로운 버전을 배포하는 Pipeline을 생성해보겠습니다.</li>
  <li>Dashboard &gt; New Item 을 선택합니다.
    <ul>
      <li>item name : SCM-Pipeline</li>
      <li>item type : Pipeline</li>
      <li>OK를 클릭합니다.</li>
    </ul>
  </li>
  <li>Pipeline 설정을 다음과 같이 설정합니다.
    <ul>
      <li>GitHub project : <code class="language-plaintext highlighter-rouge">http://&lt;PC의 IP&gt;:3000/&lt;Gogs 계정명&gt;/dev-app.git</code>
</li>
      <li>Use Gogs secret : <code class="language-plaintext highlighter-rouge">qwe123</code>
</li>
      <li>Build Triggers : Build when a change is pushed to Gogs 체크</li>
      <li>Pipeline script from SCM
        <ul>
          <li>SCM : Git
            <ul>
              <li>Repo URL : <code class="language-plaintext highlighter-rouge">http://&lt;PC의 IP&gt;:3000/&lt;Gogs 계정명&gt;/dev-app.git</code>
</li>
              <li>Credentials : <code class="language-plaintext highlighter-rouge">devops/*</code>
</li>
              <li>Branch : <code class="language-plaintext highlighter-rouge">*/main</code>
</li>
            </ul>
          </li>
          <li>Script Path : <code class="language-plaintext highlighter-rouge">Jenkinsfile</code> 
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_19.png" alt="img.png" loading="lazy" width="1034" height="1458">
</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="jenkinsfile-작성-후-git-push">Jenkinsfile 작성 후 Git Push</h5>

<ul>
  <li>Jenkinsfile을 작성합니다.</li>
</ul>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">DOCKER_IMAGE</span> <span class="o">=</span> <span class="s1">'&lt;자신의 도커 허브 계정&gt;/dev-app'</span> <span class="c1">// Docker 이미지 이름</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Checkout'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                 <span class="n">git</span> <span class="nl">branch:</span> <span class="s1">'main'</span><span class="o">,</span>
                 <span class="nl">url:</span> <span class="s1">'http://&lt;PC의 IP&gt;:3000/devops/dev-app.git'</span><span class="o">,</span>  <span class="c1">// Git에서 코드 체크아웃</span>
                 <span class="nl">credentialsId:</span> <span class="s1">'gogs-crd'</span>  <span class="c1">// Credentials ID</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Read VERSION'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="c1">// VERSION 파일 읽기</span>
                    <span class="kt">def</span> <span class="n">version</span> <span class="o">=</span> <span class="n">readFile</span><span class="o">(</span><span class="s1">'VERSION'</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span>
                    <span class="n">echo</span> <span class="s2">"Version found: ${version}"</span>
                    <span class="c1">// 환경 변수 설정</span>
                    <span class="n">env</span><span class="o">.</span><span class="na">DOCKER_TAG</span> <span class="o">=</span> <span class="n">version</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Docker Build and Push'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s1">'https://index.docker.io/v1/'</span><span class="o">,</span> <span class="s1">'dockerhub-crd'</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// DOCKER_TAG 사용</span>
                        <span class="kt">def</span> <span class="n">appImage</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="s2">"${DOCKER_IMAGE}:${DOCKER_TAG}"</span><span class="o">)</span>
                        <span class="n">appImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
                        <span class="n">appImage</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="s2">"latest"</span><span class="o">)</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">post</span> <span class="o">{</span>
        <span class="n">success</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s2">"Docker image ${DOCKER_IMAGE}:${DOCKER_TAG} has been built and pushed successfully!"</span>
        <span class="o">}</span>
        <span class="n">failure</span> <span class="o">{</span>
            <span class="n">echo</span> <span class="s2">"Pipeline failed. Please check the logs."</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>VERSION 파일과 server.py 파일을 0.0.2 =&gt; 0.0.3으로 수정합니다.</li>
  <li>작성된 파일 push</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"VERSION </span><span class="si">$(</span><span class="nb">cat </span>VERSION<span class="si">)</span><span class="s2"> Changed"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
</code></pre></div></div>

<ul>
  <li>Push와 거의 동시에 Jenkins에서 Build가 시작되고 성공적으로 빌드가 되었습니다.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_20.png" alt="img.png" loading="lazy" width="1392" height="910"></p>

<ul>
  <li>Docker hub에도 0.0.3 버전이 업로드 잘 되었습니다.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_21.png" alt="img.png" loading="lazy" width="1052" height="200"></p>

<ul>
  <li>Gogs에서 Repository &gt; Settings &gt; Webhooks &gt; 웹훅 클릭하면 웹훅 전달 로그를 확인할 수 있습니다.
Gogs =&gt; Jenkins의 방향으로 Webhook이 전달되었음을 확인할 수 있습니다.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_22.png" alt="img.png" loading="lazy" width="753" height="619"></p>

<ul>
  <li>마지막으로 Kubernetes 클러스터에서 새로운 버전을 배포하겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl <span class="nb">set </span>image deployment timeserver timeserver-container<span class="o">=</span><span class="nv">$DHUSER</span>/dev-app:0.0.3 <span class="o">&amp;&amp;</span> watch <span class="nt">-d</span> <span class="s2">"kubectl get deploy,ep timeserver; echo; kubectl get rs,pod"</span>
</code></pre></div></div>

<hr>

<h3 id="jenkins-cicd--k8s-kind">Jenkins CI/CD + K8S (Kind)</h3>

<ul>
  <li>이번에는 Jenkins에서 바로 Kubernetes 클러스터에 배포할 수 있도록 하는 실습을 진행해보겠습니다.</li>
  <li>Jenkins 컨테이너 내부에 필요한 툴(kubectl, helm)을 설치 하겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install kubectl, helm</span>
<span class="nv">$ </span>docker compose <span class="nb">exec</span> <span class="nt">--privileged</span> <span class="nt">-u</span> root jenkins bash
<span class="nt">--------------------------------------------</span>
<span class="c">#curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl" </span>
<span class="nv">$ </span>curl <span class="nt">-LO</span> <span class="s2">"https://dl.k8s.io/release/</span><span class="si">$(</span>curl <span class="nt">-L</span> <span class="nt">-s</span> https://dl.k8s.io/release/stable.txt<span class="si">)</span><span class="s2">/bin/linux/arm64/kubectl"</span>  <span class="c"># macOS</span>
<span class="c"># $ curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"  # WindowOS</span>

<span class="nv">$ </span><span class="nb">install</span> <span class="nt">-o</span> root <span class="nt">-g</span> root <span class="nt">-m</span> 0755 kubectl /usr/local/bin/kubectl
<span class="nv">$ </span>kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Client Version: v1.32.0</span>
<span class="c">#    Kustomize Version: v5.5.0</span>

<span class="c">#</span>
<span class="nv">$ </span>curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
<span class="nv">$ </span>helm version
<span class="c"># =&gt; version.BuildInfo{Version:&amp;quot;v3.16.4&amp;quot;, GitCommit:&amp;quot;7877b45b63f95635153b29a42c0c2f4273ec45ca&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;, GoVersion:&amp;quot;go1.22.7&amp;quot;}</span>

<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">--------------------------------------------</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Client Version: v1.32.0</span>
<span class="c">#    Kustomize Version: v5.5.0</span>
<span class="nv">$ </span>docker compose <span class="nb">exec </span>jenkins helm version
<span class="c"># =&gt; version.BuildInfo{Version:&amp;quot;v3.16.4&amp;quot;, GitCommit:&amp;quot;7877b45b63f95635153b29a42c0c2f4273ec45ca&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;, GoVersion:&amp;quot;go1.22.7&amp;quot;}</span>
</code></pre></div></div>

<ul>
  <li>Jenkins Item 생성(Pipeline) : item name(k8s-cmd)</li>
</ul>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">KUBECONFIG</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">(</span><span class="s1">'k8s-crd'</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'List Pods'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">'''
                # Fetch and display Pods
                kubectl get pods -A --kubeconfig "$KUBECONFIG"
                '''</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_23.png" alt="img.png" loading="lazy" width="1462" height="1415"></p>

<h5 id="jenkins를-이용한-blue-green-배포-실습">Jenkins를 이용한 blue-green 배포 실습</h5>

<ul>
  <li>디플로이먼트 / 서비스 yaml 파일 작성 - http-echo 및 코드 push</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># </span>
<span class="nv">$ </span><span class="nb">cd </span>dev-app

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">mkdir </span>deploy

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> deploy/echo-server-blue.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-server-blue
spec:
  replicas: 2
  selector:
    matchLabels:
      app: echo-server
      version: blue
  template:
    metadata:
      labels:
        app: echo-server
        version: blue
    spec:
      containers:
      - name: echo-server
        image: hashicorp/http-echo
        args:
        - "-text=Hello from Blue"
        ports:
        - containerPort: 5678
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> deploy/echo-server-service.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Service
metadata:
  name: echo-server-service
spec:
  selector:
    app: echo-server
    version: blue
  ports:
  - protocol: TCP
    port: 80
    targetPort: 5678
    nodePort: 30000
  type: NodePort
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> deploy/echo-server-green.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-server-green
spec:
  replicas: 2
  selector:
    matchLabels:
      app: echo-server
      version: green
  template:
    metadata:
      labels:
        app: echo-server
        version: green
    spec:
      containers:
      - name: echo-server
        image: hashicorp/http-echo
        args:
        - "-text=Hello from Green"
        ports:
        - containerPort: 5678
</span><span class="no">EOF

</span><span class="c">#</span>
<span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Add echo server yaml"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; main 76adc73] Add echo server yaml</span>
<span class="c">#     3 files changed, 60 insertions(+)</span>
<span class="c">#     create mode 100644 deploy/echo-server-blue.yaml</span>
<span class="c">#     create mode 100644 deploy/echo-server-green.yaml</span>
<span class="c">#     create mode 100644 deploy/echo-server-service.yaml</span>
<span class="c">#    Enumerating objects: 7, done.</span>
<span class="c">#    Counting objects: 100% (7/7), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (6/6), done.</span>
<span class="c">#    Writing objects: 100% (6/6), 789 bytes | 789.00 KiB/s, done.</span>
<span class="c">#    Total 6 (delta 2), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/dev-app.git</span>
<span class="c">#       60f336b..76adc73  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div></div>

<ul>
  <li>Jenkins에서 Pipeline을 작성하여 배포해 보겠습니다.</li>
  <li>먼저, 이전 실습에서 배포한 deployment와 service를 삭제합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete deploy,svc timeserver
<span class="c"># =&gt; deployment.apps &amp;quot;timeserver&amp;quot; deleted</span>
<span class="c">#    service &amp;quot;timeserver&amp;quot; deleted</span>
</code></pre></div></div>

<ul>
  <li>반복접속을 미리 실행해둡니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 별도의 터미널에서 실행</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> <span class="nb">sleep </span>1  <span class="p">;</span> kubectl get deploy <span class="nt">-owide</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> kubectl get svc,ep echo-server-service <span class="nt">-owide</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"------------"</span> <span class="p">;</span> <span class="k">done</span>
<span class="c"># 혹은 </span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 <span class="p">;</span> <span class="nb">date</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>Jenkins에서 Pipeline 생성 : item name(k8s-bluegreen)</li>
</ul>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="n">any</span>

    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">KUBECONFIG</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">(</span><span class="s1">'k8s-crd'</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Checkout'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                 <span class="n">git</span> <span class="nl">branch:</span> <span class="s1">'main'</span><span class="o">,</span>
                 <span class="nl">url:</span> <span class="s1">'http://&lt;PC의 IP&gt;:3000/devops/dev-app.git'</span><span class="o">,</span>  <span class="c1">// Git에서 코드 체크아웃</span>
                 <span class="nl">credentialsId:</span> <span class="s1">'gogs-crd'</span>  <span class="c1">// Credentials ID</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'container image build'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">"container image build"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'container image upload'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">echo</span> <span class="s2">"container image upload"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'k8s deployment blue version'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">"kubectl apply -f ./deploy/echo-server-blue.yaml --kubeconfig $KUBECONFIG"</span>
                <span class="n">sh</span> <span class="s2">"kubectl apply -f ./deploy/echo-server-service.yaml --kubeconfig $KUBECONFIG"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'approve green version'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">input</span> <span class="nl">message:</span> <span class="s1">'approve green version'</span><span class="o">,</span> <span class="nl">ok:</span> <span class="s2">"Yes"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'k8s deployment green version'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
	        	<span class="n">sh</span> <span class="s2">"kubectl apply -f ./deploy/echo-server-green.yaml --kubeconfig $KUBECONFIG"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'approve version switching'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">returnValue</span> <span class="o">=</span> <span class="n">input</span> <span class="nl">message:</span> <span class="s1">'Green switching?'</span><span class="o">,</span> <span class="nl">ok:</span> <span class="s2">"Yes"</span><span class="o">,</span> <span class="nl">parameters:</span> <span class="o">[</span><span class="n">booleanParam</span><span class="o">(</span><span class="nl">defaultValue:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">'IS_SWITCHED'</span><span class="o">)]</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">returnValue</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s2">"kubectl patch svc echo-server-service -p '{\"spec\": {\"selector\": {\"version\": \"green\"}}}' --kubeconfig $KUBECONFIG"</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">'Blue Rollback'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">returnValue</span> <span class="o">=</span> <span class="n">input</span> <span class="nl">message:</span> <span class="s1">'Blue Rollback?'</span><span class="o">,</span> <span class="nl">parameters:</span> <span class="o">[</span><span class="n">choice</span><span class="o">(</span><span class="nl">choices:</span> <span class="o">[</span><span class="s1">'done'</span><span class="o">,</span> <span class="s1">'rollback'</span><span class="o">],</span> <span class="nl">name:</span> <span class="s1">'IS_ROLLBACk'</span><span class="o">)]</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">returnValue</span> <span class="o">==</span> <span class="s2">"done"</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s2">"kubectl delete -f ./deploy/echo-server-blue.yaml --kubeconfig $KUBECONFIG"</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">returnValue</span> <span class="o">==</span> <span class="s2">"rollback"</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">sh</span> <span class="s2">"kubectl patch svc echo-server-service -p '{\"spec\": {\"selector\": {\"version\": \"blue\"}}}' --kubeconfig $KUBECONFIG"</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Build Now로 배포 후 동작을 확인합니다.
    <ul>
      <li>blue 버전이 배포된 다음 green 버전을 배포할지 승인 여부를 묻습니다.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_24.png" alt="img.png" loading="lazy" width="907" height="400">
</li>
      <li>승인하면 green 버전이 배포됩니다. 하지만 아직 트래픽은 Blue로만 흐릅니다.
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get deploy <span class="nt">-owide</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> kubectl get svc,ep echo-server-service <span class="nt">-owide</span>
<span class="c"># =&gt; Hello from Blue</span>
<span class="c">#    </span>
<span class="c">#    NAME                READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS    IMAGES                SELECTOR</span>
<span class="c">#    echo-server-blue    2/2     2            2           3m46s   echo-server   hashicorp/http-echo   app=echo-server,version=blue</span>
<span class="c">#    echo-server-green   2/2     2            2           31s     echo-server   hashicorp/http-echo   app=echo-server,version=green</span>
<span class="c">#    </span>
<span class="c">#    NAME                          TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE     SELECTOR</span>
<span class="c">#    service/echo-server-service   NodePort   10.96.40.148   &amp;lt;none&amp;gt;        80:30000/TCP   3m45s   app=echo-server,version=blue</span>
<span class="c">#    </span>
<span class="c">#    NAME                            ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/echo-server-service   10.244.1.8:5678,10.244.2.8:5678   3m45s</span>
</code></pre></div>        </div>
      </li>
      <li>green으로 배포할지 승인하면 마침내 green으로 트래픽이 전달 됩니다. 
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_25.png" alt="img.png" loading="lazy" width="306" height="312">
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get deploy <span class="nt">-owide</span> <span class="p">;</span> <span class="nb">echo</span> <span class="p">;</span> kubectl get svc,ep echo-server-service <span class="nt">-owide</span>
<span class="c"># =&gt; Hello from Green</span>
<span class="c">#    </span>
<span class="c">#    NAME                READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS    IMAGES                SELECTOR</span>
<span class="c">#    echo-server-blue    2/2     2            2           6m14s   echo-server   hashicorp/http-echo   app=echo-server,version=blue</span>
<span class="c">#    echo-server-green   2/2     2            2           2m59s   echo-server   hashicorp/http-echo   app=echo-server,version=green</span>
<span class="c">#    </span>
<span class="c">#    NAME                          TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE     SELECTOR</span>
<span class="c">#    service/echo-server-service   NodePort   10.96.40.148   &amp;lt;none&amp;gt;        80:30000/TCP   6m13s   app=echo-server,version=green</span>
<span class="c">#    </span>
<span class="c">#    NAME                            ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/echo-server-service   10.244.1.9:5678,10.244.2.9:5678   6m13s</span>
</code></pre></div>        </div>
      </li>
      <li>마지막으로 blue를 롤백할지 물으며, 승인하면 blue가 삭제 됩니다.
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># =&gt; Hello from Green</span>
<span class="c">#    </span>
<span class="c">#    NAME                READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS    IMAGES                SELECTOR</span>
<span class="c">#    echo-server-green   2/2     2            2           4m55s   echo-server   hashicorp/http-echo   app=echo-server,version=green</span>
<span class="c">#    </span>
<span class="c">#    NAME                          TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE    SELECTOR</span>
<span class="c">#    service/echo-server-service   NodePort   10.96.40.148   &amp;lt;none&amp;gt;        80:30000/TCP   8m9s   app=echo-server,version=green</span>
<span class="c">#    </span>
<span class="c">#    NAME                            ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/echo-server-service   10.244.1.9:5678,10.244.2.9:5678   8m9s</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>실습 완료 후 삭제</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete deploy echo-server-blue echo-server-green
<span class="nv">$ </span>kubectl delete svc echo-server-service
</code></pre></div></div>

<h3 id="jenkins-ci--argocd--k8s-kind">Jenkins CI + ArgoCD + K8S (Kind)</h3>

<h4 id="argocd-소개">ArgoCD 소개</h4>

<ul>
  <li>ArgoCD는 GitOps를 지원하는 CD 도구로, Kubernetes 클러스터에 배포된 애플리케이션의 상태를 지속적으로 모니터링하고,
Git 저장소에 정의된 상태와 실제 상태가 일치하지 않을 경우 자동으로 동기화하여 애플리케이션을 원하는 상태로 유지하는 툴입니다.</li>
  <li>ArgoCD의 아키텍쳐
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_26.png" alt="img.png" loading="lazy" width="743" height="708">
</li>
  <li>ArgoCD는 배포된 애플리케이션의 상태인 Kubernetes manifest를 다음의 방식들로 정의할 수 있습니다.
    <ul>
      <li>
<a href="https://kustomize.io/">Kustomize</a> 애플리케이션</li>
      <li>
<a href="https://helm.sh/">helm</a> chart</li>
      <li>
<a href="https://jsonnet.org/">jsonnet</a> 파일</li>
      <li>yaml/json manifest 파일이 있는 디렉터리</li>
      <li>기타 config management plugin에서 정의한 파일</li>
    </ul>
  </li>
  <li>자세한 사항은 <a href="https://argoproj.github.io/">공식 홈페이지</a>나 <a href="https://malwareanalysis.tistory.com/tag/ArgoCD">악분님 ArgoCD 정리 블로그</a>를 참고해주세요.</li>
</ul>

<h4 id="argocd-설치-및-기본설정">ArgoCD 설치 및 기본설정</h4>

<ul>
  <li>ArgoCD를 설치하고 기본 설정을 진행해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 네임스페이스 생성 및 파라미터 파일 작성</span>
<span class="nv">$ </span>kubectl create ns argocd
<span class="c"># =&gt; namespace/argocd created</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; argocd-values.yaml
dex:
  enabled: false

server:
  service:
    type: NodePort
    nodePortHttps: 30002
</span><span class="no">EOF

</span><span class="c"># 설치</span>
<span class="nv">$ </span>helm repo add argo https://argoproj.github.io/argo-helm
<span class="c"># =&gt; &amp;quot;argo&amp;quot; has been added to your repositories</span>
<span class="nv">$ </span>helm <span class="nb">install </span>argocd argo/argo-cd <span class="nt">--version</span> 7.7.10 <span class="nt">-f</span> argocd-values.yaml <span class="nt">--namespace</span> argocd
<span class="c"># =&gt; NAME: argocd</span>
<span class="c">#    LAST DEPLOYED: Sun Oct 01 16:53:42 2024</span>
<span class="c">#    NAMESPACE: argocd</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    In order to access the server UI you have the following options:</span>
<span class="c">#    </span>
<span class="c">#    1. kubectl port-forward service/argocd-server -n argocd 8080:443</span>
<span class="c">#        and then open the browser on http://localhost:8080 and accept the certificate</span>
<span class="c">#    </span>
<span class="c">#    2. enable ingress in the values file `server.ingress.enabled` and either</span>
<span class="c">#          - Add the annotation for ssl passthrough: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-1-ssl-passthrough</span>
<span class="c">#          - Set the `configs.params.&amp;quot;server.insecure&amp;quot;` in the values file and terminate SSL at your ingress: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-2-multiple-ingress-objects-and-hosts</span>
<span class="c">#    </span>
<span class="c">#    After reaching the UI the first time you can login with username: admin and the random password generated during the installation. You can find the password by running:</span>
<span class="c">#    kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=&amp;quot;{.data.password}&amp;quot; | base64 -d</span>
<span class="c">#    (You should delete the initial secret afterwards as suggested by the Getting Started Guide: https://argo-cd.readthedocs.io/en/stable/getting_started/#4-login-using-the-cli)</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get pod,svc,ep <span class="nt">-n</span> argocd
<span class="c"># =&gt; NAME                                                    READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/argocd-application-controller-0                     1/1     Running   0          4m55s</span>
<span class="c">#    pod/argocd-applicationset-controller-856f6bd788-zvtd2   1/1     Running   0          4m55s</span>
<span class="c">#    pod/argocd-notifications-controller-764b9d6597-z4mrx    1/1     Running   0          4m55s</span>
<span class="c">#    pod/argocd-redis-5c67786686-qwx8f                       1/1     Running   0          4m55s</span>
<span class="c">#    pod/argocd-repo-server-c9f8b6dbf-jpjcq                  1/1     Running   0          4m55s</span>
<span class="c">#    pod/argocd-server-7bff46b6bd-7n6vx                      1/1     Running   0          4m55s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span>
<span class="c">#    service/argocd-applicationset-controller   ClusterIP   10.96.166.245   &amp;lt;none&amp;gt;        7000/TCP                     4m55s</span>
<span class="c">#    service/argocd-redis                       ClusterIP   10.96.46.103    &amp;lt;none&amp;gt;        6379/TCP                     4m55s</span>
<span class="c">#    service/argocd-repo-server                 ClusterIP   10.96.117.132   &amp;lt;none&amp;gt;        8081/TCP                     4m55s</span>
<span class="c">#    service/argocd-server                      NodePort    10.96.75.70     &amp;lt;none&amp;gt;        80:30080/TCP,443:30002/TCP   4m55s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                         ENDPOINTS                           AGE</span>
<span class="c">#    endpoints/argocd-applicationset-controller   10.244.2.13:7000                    4m55s</span>
<span class="c">#    endpoints/argocd-redis                       10.244.2.12:6379                    4m55s</span>
<span class="c">#    endpoints/argocd-repo-server                 10.244.1.11:8081                    4m55s</span>
<span class="c">#    endpoints/argocd-server                      10.244.1.10:8080,10.244.1.10:8080   4m55s</span>
<span class="nv">$ </span>kubectl get crd | <span class="nb">grep </span>argo
<span class="c"># =&gt; applications.argoproj.io      2024-10-01T07:54:01Z</span>
<span class="c">#    applicationsets.argoproj.io   2024-10-01T07:54:01Z</span>
<span class="c">#    appprojects.argoproj.io       2024-10-01T07:54:01Z</span>

<span class="c"># 최초 접속 암호 확인</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> argocd get secret argocd-initial-admin-secret <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data.password}"</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="p">;</span><span class="nb">echo</span>
<span class="c"># =&gt; ZaQfvE9xrehyKxvl</span>

<span class="c"># Argo CD 웹 접속 주소 확인 : 초기 암호 입력 (admin 계정)</span>
<span class="nv">$ </span>open <span class="s2">"https://127.0.0.1:30002"</span> <span class="c"># macOS</span>
<span class="c">## Windows OS경우 직접 웹 브라우저에서 https://127.0.0.1:30002 접속</span>
</code></pre></div></div>

<ul>
  <li>Argo CD 웹 접속 확인 - 위에서 확인한 초기 비밀번호로 로그인합니다.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_27.png" alt="img.png" class="image-center" loading="lazy" width="1178" height="743">
<em class="image-caption">Argo CD 웹 초기 화면</em>
    <ul>
      <li>User Info &gt; Update password로 admin 계정 암호를 변경합니다. (qwe12345)</li>
    </ul>
  </li>
  <li>Settings &gt; Clusters, Projects, Accounts 등 기본정보를 확인해봅니다.</li>
  <li>실습을 위해 ops-deploy Repo를 등록해보겠습니다.
    <ul>
      <li>Settings &gt; Repositories &gt; Connect Repo 클릭
        <ul>
          <li>connection method : VIA HTTPS</li>
          <li>Type : git</li>
          <li>Project : default</li>
          <li>Repo URL : http://<pc ip="">:3000/devops/ops-deploy</pc>
</li>
          <li>Username : devops</li>
          <li>Password : <gogs></gogs>
</li>
        </ul>

        <p>=&gt;  입력 후 CONNECT 클릭
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_28.png" alt="img.png" loading="lazy" width="955" height="96"></p>
      </li>
      <li>모든 정보가 정확하여 연결이 되면 연결상태가 Successful로 등록됩니다.</li>
    </ul>
  </li>
</ul>

<h4 id="helm-chart를-통한-배포-실습">Helm chart를 통한 배포 실습</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">mkdir </span>nginx-chart
<span class="nv">$ </span><span class="nb">cd </span>nginx-chart

<span class="nv">$ </span><span class="nb">mkdir </span>templates

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> templates/configmap.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: ConfigMap
metadata:
  name: 
data:
  index.html: |
</span><span class="no">
EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> templates/deployment.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: 
spec:
  replicas: 
  selector:
    matchLabels:
      app: 
  template:
    metadata:
      labels:
        app: 
    spec:
      containers:
      - name: nginx
        image: :
        ports:
        - containerPort: 80
        volumeMounts:
        - name: index-html
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
      volumes:
      - name: index-html
        configMap:
          name: 
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> templates/service.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Service
metadata:
  name: 
spec:
  selector:
    app: 
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
    nodePort: 30000
  type: NodePort
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> values.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;Nginx version 1.26.1&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: 1.26.1

replicaCount: 1
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> Chart.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v2
name: nginx-chart
description: A Helm chart for deploying Nginx with custom index.html
type: application
version: 1.0.0
appVersion: "1.26.1"
</span><span class="no">EOF

</span><span class="c"># 이전 timeserver/service(nodeport) 삭제</span>
<span class="nv">$ </span>kubectl delete deploy,svc <span class="nt">--all</span>

<span class="c"># 직접 배포 해보기</span>
<span class="nv">$ </span>helm <span class="nb">install </span>dev-nginx <span class="nb">.</span> <span class="nt">-f</span> values.yaml
<span class="c"># =&gt; NAME: dev-nginx</span>
<span class="c">#    LAST DEPLOYED: Sun Oct 01 19:54:23 2024</span>
<span class="c">#    NAMESPACE: default</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="nv">$ </span>helm list
<span class="c"># =&gt; NAME       NAMESPACE REVISION  UPDATED                             STATUS    CHART             APP VERSION</span>
<span class="c">#    dev-nginx  default   1         2024-10-01 19:54:23.03644 +0900 KST deployed  nginx-chart-1.0.0 1.26.1     </span>
<span class="nv">$ </span>kubectl get deploy,svc,ep,cm dev-nginx <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                        READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR</span>
<span class="c">#    deployment.apps/dev-nginx   1/1     1            1           4s    nginx        nginx:1.26.1   app=dev-nginx</span>
<span class="c">#    </span>
<span class="c">#    NAME                TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span>
<span class="c">#    service/dev-nginx   NodePort   10.96.79.233   &amp;lt;none&amp;gt;        80:30000/TCP   4s    app=dev-nginx</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS        AGE</span>
<span class="c">#    endpoints/dev-nginx   10.244.1.16:80   4s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  DATA   AGE</span>
<span class="c">#    configmap/dev-nginx   1      4s</span>

<span class="c">#</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; &lt;!DOCTYPE html&amp;gt;</span>
<span class="c">#    &amp;lt;html&amp;gt;</span>
<span class="c">#    &amp;lt;head&amp;gt;</span>
<span class="c">#      &amp;lt;title&amp;gt;Welcome to Nginx!&amp;lt;/title&amp;gt;</span>
<span class="c">#    &amp;lt;/head&amp;gt;</span>
<span class="c">#    &amp;lt;body&amp;gt;</span>
<span class="c">#      &amp;lt;h1&amp;gt;Hello, Kubernetes!&amp;lt;/h1&amp;gt;</span>
<span class="c">#      &amp;lt;p&amp;gt;Nginx version 1.26.1&amp;lt;/p&amp;gt;</span>
<span class="c">#    &amp;lt;/body&amp;gt;</span>
<span class="c">#    &amp;lt;/html&amp;gt;</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> http://127.0.0.1:30000 | <span class="nb">grep </span>version
<span class="c"># =&gt;   &amp;lt;p&amp;gt;Nginx version 1.26.1&amp;lt;/p&amp;gt;</span>
<span class="nv">$ </span>open http://127.0.0.1:30000

<span class="c"># value 값 변경 후 적용 해보기 : version/tag, replicaCount</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> values.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;Nginx version 1.26.2&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: 1.26.2

replicaCount: 2
</span><span class="no">EOF

</span><span class="c"># helm chart 업그레이드 적용</span>
<span class="nv">$ </span>helm upgrade dev-nginx <span class="nb">.</span> <span class="nt">-f</span> values.yaml
<span class="c"># =&gt; Release &amp;quot;dev-nginx&amp;quot; has been upgraded. Happy Helming!</span>
<span class="c">#    NAME: dev-nginx</span>
<span class="c">#    LAST DEPLOYED: Sun Oct 01 19:56:59 2024</span>
<span class="c">#    NAMESPACE: default</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 2</span>
<span class="c">#    TEST SUITE: None</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>helm list
<span class="c"># =&gt; NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION</span>
<span class="c">#    dev-nginx       default         2               2024-10-01 19:56:59.30731 +0900 KST     deployed        nginx-chart-1.0.0       1.26.1</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep,cm dev-nginx <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                        READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR</span>
<span class="c">#    deployment.apps/dev-nginx   &lt;span style="color: red;"&gt;2/2     2            2&lt;/span&gt;           38s   nginx        &lt;span style="color: red;"&gt;nginx:1.26.2&lt;/span&gt;   app=dev-nginx</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 Replica가 2개로 늘어나서 파드가 2개가 되었고 버전 1.26.2가 적용되었습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; &amp;lt;!DOCTYPE html&amp;gt;</span>
<span class="c">#    &amp;lt;html&amp;gt;</span>
<span class="c">#    &amp;lt;head&amp;gt;</span>
<span class="c">#      &amp;lt;title&amp;gt;Welcome to Nginx!&amp;lt;/title&amp;gt;</span>
<span class="c">#    &amp;lt;/head&amp;gt;</span>
<span class="c">#    &amp;lt;body&amp;gt;</span>
<span class="c">#      &amp;lt;h1&amp;gt;Hello, Kubernetes!&amp;lt;/h1&amp;gt;</span>
<span class="c">#      &amp;lt;p&amp;gt;Nginx version 1.26.2&amp;lt;/p&amp;gt;</span>
<span class="c">#    &amp;lt;/body&amp;gt;</span>
<span class="c">#    &amp;lt;/html&amp;gt;</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> http://127.0.0.1:30000 | <span class="nb">grep </span>version
<span class="c"># =&gt;   &amp;lt;p&amp;gt;Nginx version 1.26.2&amp;lt;/p&amp;gt;</span>
<span class="nv">$ </span>open http://127.0.0.1:30000

<span class="c"># 확인 후 삭제</span>
<span class="nv">$ </span>helm uninstall dev-nginx
</code></pre></div></div>

<h5 id="repoops-deploy-에-nginx-helm-chart-를-argo-cd를-통한-배포-1">Repo(ops-deploy) 에 nginx helm chart 를 Argo CD를 통한 배포 1</h5>

<ul>
  <li>git 작업</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">mkdir </span>cicd-labs
<span class="nv">$ </span><span class="nb">cd </span>cicd-labs
<span class="nv">$ </span>git clone http://10.0.4.3:3000/devops/ops-deploy.git
<span class="c"># =&gt; Cloning into 'ops-deploy'...</span>
<span class="c">#    remote: Enumerating objects: 3, done.</span>
<span class="c">#    remote: Counting objects: 100% (3/3), done.</span>
<span class="c">#    remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    Unpacking objects: 100% (3/3), 228 bytes | 114.00 KiB/s, done.</span>
<span class="nv">$ </span><span class="nb">cd </span>ops-deploy

<span class="c">#</span>
<span class="nv">$ </span>git config user.name <span class="s2">"devops"</span>
<span class="nv">$ </span>git config user.email <span class="s2">"a@a.com"</span>
<span class="nv">$ </span>git config init.defaultBranch main
<span class="nv">$ </span>git config credential.helper store

<span class="c">#</span>
<span class="nv">$ VERSION</span><span class="o">=</span>1.26.1
<span class="nv">$ </span><span class="nb">mkdir </span>nginx-chart
<span class="nv">$ </span><span class="nb">mkdir </span>nginx-chart/templates

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/VERSION <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
</span><span class="nv">$VERSION</span><span class="sh">
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/templates/configmap.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: ConfigMap
metadata:
  name: 
data:
  index.html: |
</span><span class="no">
EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/templates/deployment.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: 
spec:
  replicas: 
  selector:
    matchLabels:
      app: 
  template:
    metadata:
      labels:
        app: 
    spec:
      containers:
      - name: nginx
        image: :
        ports:
        - containerPort: 80
        volumeMounts:
        - name: index-html
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
      volumes:
      - name: index-html
        configMap:
          name: 
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/templates/service.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Service
metadata:
  name: 
spec:
  selector:
    app: 
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
    nodePort: 30000
  type: NodePort
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/values-dev.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;DEV : Nginx version </span><span class="nv">$VERSION</span><span class="sh">&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: </span><span class="nv">$VERSION</span><span class="sh">

replicaCount: 1
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/values-prd.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;PRD : Nginx version </span><span class="nv">$VERSION</span><span class="sh">&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: </span><span class="nv">$VERSION</span><span class="sh">

replicaCount: 2
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/Chart.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v2
name: nginx-chart
description: A Helm chart for deploying Nginx with custom index.html
type: application
version: 1.0.0
appVersion: "</span><span class="nv">$VERSION</span><span class="sh">"
</span><span class="no">EOF

</span><span class="nv">$ </span>tree nginx-chart
<span class="c"># =&gt; nginx-chart</span>
<span class="c">#    ├── Chart.yaml</span>
<span class="c">#    ├── VERSION</span>
<span class="c">#    ├── templates</span>
<span class="c">#    │   ├── configmap.yaml</span>
<span class="c">#    │   ├── deployment.yaml</span>
<span class="c">#    │   └── service.yaml</span>
<span class="c">#    ├── values-dev.yaml</span>
<span class="c">#    └── values-prd.yaml</span>

<span class="c">#</span>
<span class="nv">$ </span>git status <span class="o">&amp;&amp;</span> git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Add nginx helm chart"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; On branch main</span>
<span class="c">#    Your branch is up to date with 'origin/main'.</span>
<span class="c">#    </span>
<span class="c">#    Untracked files:</span>
<span class="c">#      (use &amp;quot;git add &amp;lt;file&amp;gt;...&amp;quot; to include in what will be committed)</span>
<span class="c">#            nginx-chart/</span>
<span class="c">#    </span>
<span class="c">#    nothing added to commit but untracked files present (use &amp;quot;git add&amp;quot; to track)</span>
<span class="c">#    [main 2bcfda2] Add nginx helm chart</span>
<span class="c">#     7 files changed, 88 insertions(+)</span>
<span class="c">#     create mode 100644 nginx-chart/Chart.yaml</span>
<span class="c">#     create mode 100644 nginx-chart/VERSION</span>
<span class="c">#     create mode 100644 nginx-chart/templates/configmap.yaml</span>
<span class="c">#     create mode 100644 nginx-chart/templates/deployment.yaml</span>
<span class="c">#     create mode 100644 nginx-chart/templates/service.yaml</span>
<span class="c">#     create mode 100644 nginx-chart/values-dev.yaml</span>
<span class="c">#     create mode 100644 nginx-chart/values-prd.yaml</span>
<span class="c">#    Enumerating objects: 12, done.</span>
<span class="c">#    Counting objects: 100% (12/12), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (10/10), done.</span>
<span class="c">#    Writing objects: 100% (11/11), 1.44 KiB | 1.44 MiB/s, done.</span>
<span class="c">#    Total 11 (delta 1), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/ops-deploy.git</span>
<span class="c">#       f7dc047..2bcfda2  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_29.png" alt="img.png" loading="lazy" width="996" height="138"></p>

<h5 id="argo-cd에-app-등록">Argo CD에 App 등록</h5>

<ul>
  <li>ArgoCD에서 Application &gt; New App을 클릭하여 애플리케이션을 등록합니다.
    <ul>
      <li>GENERAL
        <ul>
          <li>App Name : dev-nginx</li>
          <li>Project Name : default</li>
          <li>SYNC POLICY : Manual</li>
          <li>SYNC OPTIONS : AUTO-CREATE NAMESPACE(Check)</li>
        </ul>
      </li>
      <li>Source
        <ul>
          <li>Repo URL : <code class="language-plaintext highlighter-rouge">&lt;설정되어 있는 것 선택&gt;</code> (http://10.0.4.3:3000/devops/ops-deploy)</li>
          <li>Revision : HEAD</li>
          <li>PATH : nginx-chart</li>
        </ul>
      </li>
      <li>DESTINATION
        <ul>
          <li>Cluster URL : <code class="language-plaintext highlighter-rouge">&lt;기본값&gt;</code>
</li>
          <li>NAMESPACE : dev-nginx</li>
        </ul>
      </li>
      <li>HELM
        <ul>
          <li>Values files : values-dev.yaml 
=&gt; 작성 후 상단 CREATE 클릭</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_30.png" alt="img.png" class="image-center" loading="lazy" width="523" height="340">
<em class="image-caption">Argo CD Application 등록 직후</em></p>

<ul>
  <li>등록 직후에는 git에 등록된 manifest 파일의 내용과 현재 k8s의 상태가 다르기 때문에 <code class="language-plaintext highlighter-rouge">OutOfSync</code> 상태로 표시됩니다.</li>
  <li>dev-nginx를 클릭해서 보면 리소스의 배치와 어떤 리소스가 <code class="language-plaintext highlighter-rouge">OutOfSync</code>인지 표시가 됩니다.</li>
  <li>다음 명령을 입력해서 application의 배포상태를 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd
<span class="c"># =&gt; NAME        SYNC STATUS   HEALTH STATUS</span>
<span class="c">#    dev-nginx   OutOfSync     Missing</span>

<span class="nv">$ </span>kubectl describe applications <span class="nt">-n</span> argocd dev-nginx
<span class="c"># =&gt; ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason           Age    From                           Message</span>
<span class="c">#      ----    ------           ----   ----                           -------</span>
<span class="c">#      Normal  ResourceCreated  7m38s  argocd-server                  admin created application</span>
<span class="c">#      Normal  ResourceUpdated  7m     argocd-application-controller  Updated sync status:  -&amp;gt; Unknown</span>
<span class="c">#      Normal  ResourceUpdated  6m58s  argocd-application-controller  Updated health status:  -&amp;gt; Healthy</span>
<span class="c">#      Normal  ResourceUpdated  3m35s  argocd-application-controller  Updated sync status: Unknown -&amp;gt; OutOfSync</span>
<span class="c">#      Normal  ResourceUpdated  3m35s  argocd-application-controller  Updated health status: Healthy -&amp;gt; Missing</span>

<span class="c"># 반복 접속 시도</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 http://127.0.0.1:30000 <span class="p">;</span> <span class="nb">date</span> <span class="p">;</span> <span class="nb">echo</span> <span class="s2">"------------"</span> <span class="p">;</span> <span class="nb">sleep </span>1 <span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>ArgoCD에서 DIFF 버튼을 클릭하면 현재 상태와 git에 등록된 상태를 비교할 수 있습니다.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_31.png" alt="img.png" class="image-center" loading="lazy" width="1022" height="682">
<em class="image-caption">Argo CD Application DIFF 화면</em>
</li>
  <li>SYNC 버튼을 클릭하여 git의 manifest에 지정된 상태와 k8s의 상태를 동기화 해보겠습니다.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_32.png" alt="img.png" loading="lazy" width="1092" height="700">
</li>
  <li>동기화가 완료되면 다음과 같이 노란색 화살표 아이콘 대신 녹색 체크표시가 나면서 <code class="language-plaintext highlighter-rouge">Synced</code> 상태로 변경됩니다. 
또한 동시에 Kubernetes에 NGINX가 배포가 잘 되었습니다.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_33.png" alt="img.png" class="image-center" loading="lazy" width="1081" height="764">
<em class="image-caption">Argo CD Application 동기화 완료</em>
</li>
</ul>

<h5 id="코드-수정-후-반영-확인">코드 수정 후 반영 확인</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ VERSION</span><span class="o">=</span>1.26.2

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/VERSION <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
</span><span class="nv">$VERSION</span><span class="sh">
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/values-dev.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;DEV : Nginx version </span><span class="nv">$VERSION</span><span class="sh">&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: </span><span class="nv">$VERSION</span><span class="sh">

replicaCount: 2
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> nginx-chart/values-prd.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
indexHtml: |
  &lt;!DOCTYPE html&gt;
  &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Nginx!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, Kubernetes!&lt;/h1&gt;
    &lt;p&gt;PRD : Nginx version </span><span class="nv">$VERSION</span><span class="sh">&lt;/p&gt;
  &lt;/body&gt;
  &lt;/html&gt;

image:
  repository: nginx
  tag: </span><span class="nv">$VERSION</span><span class="sh">

replicaCount: 2
</span><span class="no">EOF

</span><span class="c">#</span>
<span class="nv">$ </span>git status <span class="o">&amp;&amp;</span> git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Update nginx version </span><span class="si">$(</span><span class="nb">cat </span>nginx-chart/VERSION<span class="si">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; On branch main</span>
<span class="c">#    Your branch is up to date with 'origin/main'.</span>
<span class="c">#    </span>
<span class="c">#    Changes not staged for commit:</span>
<span class="c">#      (use &amp;quot;git add &amp;lt;file&amp;gt;...&amp;quot; to update what will be committed)</span>
<span class="c">#      (use &amp;quot;git restore &amp;lt;file&amp;gt;...&amp;quot; to discard changes in working directory)</span>
<span class="c">#            modified:   nginx-chart/VERSION</span>
<span class="c">#            modified:   nginx-chart/values-dev.yaml</span>
<span class="c">#            modified:   nginx-chart/values-prd.yaml</span>
<span class="c">#    </span>
<span class="c">#    no changes added to commit (use &amp;quot;git add&amp;quot; and/or &amp;quot;git commit -a&amp;quot;)</span>
<span class="c">#    [main e1b02a2] Update nginx version 1.26.2</span>
<span class="c">#     3 files changed, 6 insertions(+), 6 deletions(-)</span>
<span class="c">#    Enumerating objects: 11, done.</span>
<span class="c">#    Counting objects: 100% (11/11), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (5/5), done.</span>
<span class="c">#    Writing objects: 100% (6/6), 589 bytes | 589.00 KiB/s, done.</span>
<span class="c">#    Total 6 (delta 2), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/ops-deploy.git</span>
<span class="c">#       2bcfda2..e1b02a2  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>
</code></pre></div></div>

<ul>
  <li>Argo CD 웹 확인 =&gt; REFRESH 클릭
    <ul>
      <li>ArgoCD는 주기적으로 동기화 되나 바로 확인하려면 REFRESH 버튼을 클릭해야 합니다. (기본 주기는 3분)
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_34.png" alt="img.png" class="image-center" loading="lazy" width="886" height="233">
</li>
      <li>DIFF로 확인하면 manifest 파일의 변경사항이 나타납니다.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_35.png" alt="img.png" class="image-center" loading="lazy" width="1108" height="167">
</li>
    </ul>
  </li>
  <li>SYNC &gt; SYNCHRONIZE를 클릭하여 동기화 해보겠습니다.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 배포확인</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> dev-nginx <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE   IP           NODE            NOMINATED NODE   READINESS GATES</span>
<span class="c">#    pod/dev-nginx-5db658bd4f-nfldn   1/1     Running   0          8s    10.244.1.7   myk8s-worker    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    pod/dev-nginx-5db658bd4f-rxmfz   1/1     Running   0          10s   10.244.2.6   myk8s-worker2   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span>
<span class="c">#    service/dev-nginx   NodePort   10.96.233.99   &amp;lt;none&amp;gt;        80:30000/TCP   16m   app=dev-nginx</span>
<span class="c">#    </span>
<span class="c">#    NAME                        READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR</span>
<span class="c">#    deployment.apps/dev-nginx   2/2     2            2           16m   nginx        &lt;span style="color: red;"&gt;nginx:1.26.2&lt;/span&gt;   app=dev-nginx</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 변경된 버전이 잘 배포되었습니다.&lt;/span&gt;</span>
<span class="c">#    </span>
<span class="c">#    NAME                                   DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR</span>
<span class="c">#    replicaset.apps/dev-nginx-5db658bd4f   2         2         2       11s   nginx        nginx:1.26.2   app=dev-nginx,pod-template-hash=5db658bd4f</span>
<span class="c">#    replicaset.apps/dev-nginx-77d44dfbf6   0         0         0       16m   nginx        nginx:1.26.1   app=dev-nginx,pod-template-hash=77d44dfbf6</span>
</code></pre></div>    </div>
  </li>
  <li>여기에서 replicaset은 기존 1.26.1이 남아있는데 그것은 ArgoCD가 Rollback을 지원하기 위해 기존 replicaset을 남겨서 관리하기 때문입니다.</li>
  <li>몇개의 history를 남길지는 설정에서 변경할 수 있습니다.</li>
  <li>ArgoCD웹 에서 APP 삭제하고 아래의 명령으로 삭제 진행상황을 확인합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get all <span class="nt">-n</span> dev-nginx <span class="nt">-o</span> wide
</code></pre></div></div>

<h4 id="argocd-declarative-setup으로-배포-실습">ArgoCD Declarative Setup으로 배포 실습</h4>

<ul>
  <li>이번에는 ArgoCD 애플리케이션 자체를 yaml로 생성해보겠습니다.</li>
  <li>이를 통해 애플리케이션을 생성하고 배포하는 과정을 자동화할 수 있습니다.</li>
  <li>자세한 사항은 다음 공식 문서를 참고하세요. <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/">ArgoCD Declarative Setup - Project, applications, ArgoCD Settings - Docs</a>
</li>
  <li>dev-nginx App 생성 및 Auto SYNC</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Declarative 방식으로 ArgoCD App 생성</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: dev-nginx
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    helm:
      valueFiles:
      - values-dev.yaml
    path: nginx-chart
    repoURL: http://10.0.4.3:3000/devops/ops-deploy
    targetRevision: HEAD
  syncPolicy:
    automated:
      prune: true
    syncOptions:
    - CreateNamespace=true
  destination:
    namespace: dev-nginx
    server: https://kubernetes.default.svc
</span><span class="no">EOF
</span><span class="c"># =&gt; application.argoproj.io/dev-nginx created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd dev-nginx
<span class="c"># =&gt; NAME        SYNC STATUS   HEALTH STATUS</span>
<span class="c">#    dev-nginx   Synced        Healthy</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 automated sync 정책이어서 배포 직후 동기화 된 상태가 됩니다.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd dev-nginx <span class="nt">-o</span> yaml | kubectl neat
<span class="nv">$ </span>kubectl describe applications <span class="nt">-n</span> argocd dev-nginx
<span class="c"># =&gt; ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason              Age   From                           Message</span>
<span class="c">#      ----    ------              ----  ----                           -------</span>
<span class="c">#      Normal  ResourceUpdated     80s   argocd-application-controller  Updated sync status:  -&amp;gt; Unknown</span>
<span class="c">#      Normal  ResourceUpdated     80s   argocd-application-controller  Updated health status:  -&amp;gt; Healthy</span>
<span class="c">#      Normal  OperationStarted    57s   argocd-application-controller  Initiated automated sync to 'e1b02a29e47a839ebcc93e46ee9da1f2d5320148'</span>
<span class="c">#      Normal  ResourceUpdated     57s   argocd-application-controller  Updated sync status: Unknown -&amp;gt; OutOfSync</span>
<span class="c">#      Normal  ResourceUpdated     57s   argocd-application-controller  Updated health status: Healthy -&amp;gt; Missing</span>
<span class="c">#      Normal  ResourceUpdated     57s   argocd-application-controller  Updated sync status: OutOfSync -&amp;gt; Synced</span>
<span class="c">#      Normal  ResourceUpdated     57s   argocd-application-controller  Updated health status: Missing -&amp;gt; Progressing</span>
<span class="c">#      Normal  OperationCompleted  57s   argocd-application-controller  Sync operation to e1b02a29e47a839ebcc93e46ee9da1f2d5320148 succeeded</span>
<span class="c">#      Normal  ResourceUpdated     55s   argocd-application-controller  Updated health status: Progressing -&amp;gt; Healthy</span>
<span class="nv">$ </span>kubectl get pod,svc,ep,cm <span class="nt">-n</span> dev-nginx
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/dev-nginx-5db658bd4f-blcr6   1/1     Running   0          74s</span>
<span class="c">#    pod/dev-nginx-5db658bd4f-k984k   1/1     Running   0          74s</span>
<span class="c">#    </span>
<span class="c">#    NAME                TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/dev-nginx   NodePort   10.96.176.134   &amp;lt;none&amp;gt;        80:30000/TCP   74s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS                     AGE</span>
<span class="c">#    endpoints/dev-nginx   10.244.1.8:80,10.244.2.8:80   74s</span>
<span class="c">#    </span>
<span class="c">#    NAME                         DATA   AGE</span>
<span class="c">#    configmap/dev-nginx          1      74s</span>
<span class="c">#    configmap/kube-root-ca.crt   1      24m</span>

<span class="c">#</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; &amp;lt;!DOCTYPE html&amp;gt;</span>
<span class="c">#    &amp;lt;html&amp;gt;</span>
<span class="c">#    &amp;lt;head&amp;gt;</span>
<span class="c">#      &amp;lt;title&amp;gt;Welcome to Nginx!&amp;lt;/title&amp;gt;</span>
<span class="c">#    &amp;lt;/head&amp;gt;</span>
<span class="c">#    &amp;lt;body&amp;gt;</span>
<span class="c">#      &amp;lt;h1&amp;gt;Hello, Kubernetes!&amp;lt;/h1&amp;gt;</span>
<span class="c">#      &amp;lt;p&amp;gt;DEV : Nginx version 1.26.2&amp;lt;/p&amp;gt;</span>
<span class="c">#    &amp;lt;/body&amp;gt;</span>
<span class="c">#    &amp;lt;/html&amp;gt;</span>
<span class="nv">$ </span>open http://127.0.0.1:30000

<span class="c"># Argo CD App 삭제</span>
<span class="nv">$ </span>kubectl delete applications <span class="nt">-n</span> argocd dev-nginx
<span class="c"># =&gt; application.argoproj.io &amp;quot;dev-nginx&amp;quot; deleted</span>
</code></pre></div></div>

<ul>
  <li>prd-nginx App 생성 및 Auto SYNC</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prd-nginx
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: prd-nginx
    server: https://kubernetes.default.svc
  project: default
  source:
    helm:
      valueFiles:
      - values-prd.yaml
    path: nginx-chart
    repoURL: http://10.0.4.3:3000/devops/ops-deploy
    targetRevision: HEAD
  syncPolicy:
    automated:
      prune: true
    syncOptions:
    - CreateNamespace=true
</span><span class="no">EOF
</span><span class="c"># =&gt; application.argoproj.io/prd-nginx created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd prd-nginx
<span class="c"># =&gt; NAME        SYNC STATUS   HEALTH STATUS</span>
<span class="c">#    prd-nginx   Synced        Healthy</span>
<span class="nv">$ </span>kubectl describe applications <span class="nt">-n</span> argocd prd-nginx
<span class="c"># =&gt; ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason              Age   From                           Message</span>
<span class="c">#      ----    ------              ----  ----                           -------</span>
<span class="c">#      Normal  ResourceUpdated     28s   argocd-application-controller  Updated sync status:  -&amp;gt; Unknown</span>
<span class="c">#      Normal  ResourceUpdated     28s   argocd-application-controller  Updated health status:  -&amp;gt; Healthy</span>
<span class="c">#      Normal  OperationStarted    18s   argocd-application-controller  Initiated automated sync to 'e1b02a29e47a839ebcc93e46ee9da1f2d5320148'</span>
<span class="c">#      Normal  ResourceUpdated     18s   argocd-application-controller  Updated sync status: Unknown -&amp;gt; OutOfSync</span>
<span class="c">#      Normal  ResourceUpdated     18s   argocd-application-controller  Updated health status: Healthy -&amp;gt; Missing</span>
<span class="c">#      Normal  ResourceUpdated     15s   argocd-application-controller  Updated sync status: OutOfSync -&amp;gt; Synced</span>
<span class="c">#      Normal  ResourceUpdated     15s   argocd-application-controller  Updated health status: Missing -&amp;gt; Progressing</span>
<span class="c">#      Normal  OperationCompleted  15s   argocd-application-controller  Sync operation to e1b02a29e47a839ebcc93e46ee9da1f2d5320148 succeeded</span>
<span class="c">#      Normal  ResourceUpdated     13s   argocd-application-controller  Updated health status: Progressing -&amp;gt; Healthy</span>
<span class="nv">$ </span>kubectl get pod,svc,ep,cm <span class="nt">-n</span> prd-nginx
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/prd-nginx-645b5ffbbf-9jp6g   1/1     Running   0          45s</span>
<span class="c">#    pod/prd-nginx-645b5ffbbf-ch6q2   1/1     Running   0          45s</span>
<span class="c">#    </span>
<span class="c">#    NAME                TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/prd-nginx   NodePort   10.96.206.18   &amp;lt;none&amp;gt;        80:30000/TCP   45s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS                     AGE</span>
<span class="c">#    endpoints/prd-nginx   10.244.1.9:80,10.244.2.9:80   45s</span>
<span class="c">#    </span>
<span class="c">#    NAME                         DATA   AGE</span>
<span class="c">#    configmap/kube-root-ca.crt   1      47s</span>
<span class="c">#    configmap/prd-nginx          1      45s</span>

<span class="c">#</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; &amp;lt;!DOCTYPE html&amp;gt;</span>
<span class="c">#    &amp;lt;html&amp;gt;</span>
<span class="c">#    &amp;lt;head&amp;gt;</span>
<span class="c">#      &amp;lt;title&amp;gt;Welcome to Nginx!&amp;lt;/title&amp;gt;</span>
<span class="c">#    &amp;lt;/head&amp;gt;</span>
<span class="c">#    &amp;lt;body&amp;gt;</span>
<span class="c">#      &amp;lt;h1&amp;gt;Hello, Kubernetes!&amp;lt;/h1&amp;gt;</span>
<span class="c">#      &amp;lt;p&amp;gt;PRD : Nginx version 1.26.2&amp;lt;/p&amp;gt;</span>
<span class="c">#    &amp;lt;/body&amp;gt;</span>
<span class="c">#    &amp;lt;/html&amp;gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 PRD nginx가 잘 배포되었습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>open http://127.0.0.1:30000

<span class="c"># Argo CD App 삭제</span>
<span class="nv">$ </span>kubectl delete applications <span class="nt">-n</span> argocd prd-nginx
<span class="c"># =&gt; application.argoproj.io &amp;quot;prd-nginx&amp;quot; deleted</span>
</code></pre></div></div>

<h4 id="argocd를-이용한-full-cicd-구성">ArgoCD를 이용한 Full CI/CD 구성</h4>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_36.png" alt="img.png" loading="lazy" width="2048" height="1049"></p>

<ul>
  <li>최종적으로 위와 같이 CI/CD 파이프라인을 구성해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cd </span>ops-deploy
<span class="nv">$ </span><span class="nb">mkdir </span>dev-app

<span class="c"># 도커 계정 정보</span>
<span class="c">#$ DHUSER=&lt;도커 허브 계정&gt;</span>
<span class="nv">$ DHUSER</span><span class="o">=</span>sweetlittlebird

<span class="c"># 버전 정보 </span>
<span class="nv">$ VERSION</span><span class="o">=</span>0.0.1

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> dev-app/VERSION <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
</span><span class="nv">$VERSION</span><span class="sh">
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> dev-app/timeserver.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: timeserver
spec:
  replicas: 2
  selector:
    matchLabels:
      pod: timeserver-pod
  template:
    metadata:
      labels:
        pod: timeserver-pod
    spec:
      containers:
      - name: timeserver-container
        image: docker.io/</span><span class="nv">$DHUSER</span><span class="sh">/dev-app:</span><span class="nv">$VERSION</span><span class="sh">
      imagePullSecrets:
      - name: dockerhub-secret
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> dev-app/service.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Service
metadata:
  name: timeserver
spec:
  selector:
    pod: timeserver-pod
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    nodePort: 30000
  type: NodePort
</span><span class="no">EOF

</span><span class="c">#</span>
<span class="nv">$ </span>git status <span class="o">&amp;&amp;</span> git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Add dev-app deployment yaml"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
</code></pre></div></div>

<ul>
  <li>ArgoCD에 app 생성</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: timeserver
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    path: dev-app
    repoURL: http://10.0.4.3:3000/devops/ops-deploy
    targetRevision: HEAD
  syncPolicy:
    automated:
      prune: true
    syncOptions:
    - CreateNamespace=true
  destination:
    namespace: default
    server: https://kubernetes.default.svc
</span><span class="no">EOF
</span><span class="c"># =&gt; application.argoproj.io/timeserver created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd timeserver
<span class="c"># =&gt; NAME         SYNC STATUS   HEALTH STATUS</span>
<span class="c">#    timeserver   Synced        Healthy</span>
<span class="nv">$ </span>kubectl get applications <span class="nt">-n</span> argocd timeserver <span class="nt">-o</span> yaml | kubectl neat
<span class="nv">$ </span>kubectl describe applications <span class="nt">-n</span> argocd timeserver
<span class="c"># =&gt; ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason              Age   From                           Message</span>
<span class="c">#      ----    ------              ----  ----                           -------</span>
<span class="c">#      Normal  OperationStarted    23s   argocd-application-controller  Initiated automated sync to 'd64cb772abc1646bd74abbd47b688eeb6d59d65a'</span>
<span class="c">#      Normal  ResourceUpdated     23s   argocd-application-controller  Updated sync status:  -&amp;gt; OutOfSync</span>
<span class="c">#      Normal  ResourceUpdated     23s   argocd-application-controller  Updated health status:  -&amp;gt; Missing</span>
<span class="c">#      Normal  ResourceUpdated     23s   argocd-application-controller  Updated sync status: OutOfSync -&amp;gt; Synced</span>
<span class="c">#      Normal  OperationCompleted  23s   argocd-application-controller  Sync operation to d64cb772abc1646bd74abbd47b688eeb6d59d65a succeeded</span>
<span class="c">#      Normal  ResourceUpdated     23s   argocd-application-controller  Updated health status: Missing -&amp;gt; Progressing</span>
<span class="c">#      Normal  ResourceUpdated     21s   argocd-application-controller  Updated health status: Progressing -&amp;gt; Healthy</span>
<span class="nv">$ </span>kubectl get deploy,rs,pod
<span class="c"># =&gt; NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/timeserver   2/2     2            2           42s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                    DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/timeserver-549cc9bc89   2         2         2       42s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS    RESTARTS      AGE</span>
<span class="c">#    pod/curl-pod                      1/1     Running   2 (51m ago)   21h</span>
<span class="c">#    pod/timeserver-549cc9bc89-5bsfm   1/1     Running   0             42s</span>
<span class="c">#    pod/timeserver-549cc9bc89-rwcsz   1/1     Running   0             42s</span>
<span class="nv">$ </span>kubectl get svc,ep timeserver
<span class="c"># =&gt; NAME                 TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/timeserver   NodePort   10.96.45.219   &amp;lt;none&amp;gt;        80:30000/TCP   50s</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS                       AGE</span>
<span class="c">#    endpoints/timeserver   10.244.1.10:80,10.244.2.10:80   50s</span>

<span class="c">#</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; The time is 12:16:57 PM, VERSION 0.0.1</span>
<span class="c">#    Server hostname: timeserver-549cc9bc89-5bsfm</span>
<span class="nv">$ </span>open http://127.0.0.1:30000
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_37.png" alt="img.png" loading="lazy" width="1545" height="594"></p>

<h5 id="dev-app-repo-코드-작업">dev-app Repo 코드 작업</h5>

<ul>
  <li>dev-app Repo에 VERSION 업데이트 시 =&gt; ops-deploy Repo 에 dev-app 에 파일에 버전 정보 업데이트 작업 추가
    <ol>
      <li>기존 버전 정보는 VERSION 파일 내에 정보를 가져와서 변수 지정 : <code class="language-plaintext highlighter-rouge">OLDVER=$(cat dev-app/VERSION)</code>
</li>
      <li>신규 버전 정보는 environment 도커 태그 정보를 가져와서 변수 지정 : <code class="language-plaintext highlighter-rouge">NEWVER=$(echo ${DOCKER_TAG})</code>
</li>
      <li>이후 sed 로 ops-deploy Repo 에 dev-app/VERSION, timeserver.yaml 2개 파일에 ‘기존 버전’ → ‘신규 버전’으로 값 변경</li>
      <li>이후 ops-deploy Repo 에 git push ⇒ Argo CD app 가 최대 3분 사이에 변경 확인 후 AutoSync 로 신규 버전 업데이트 진행</li>
    </ol>
  </li>
  <li>아래는 dev-app 에 위치한 Jenkinsfile로 젠킨스에 SCM-Pipeline (SCM:git) 으로 사용되고 있는 파일을 수정해서 실습에 사용하겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Jenkinsfile</span>
pipeline <span class="o">{</span>
    agent any
    environment <span class="o">{</span>
        DOCKER_IMAGE <span class="o">=</span> <span class="s1">'sweetlittlebird/dev-app'</span> // Docker 이미지 이름
        GOGSCRD <span class="o">=</span> credentials<span class="o">(</span><span class="s1">'gogs-crd'</span><span class="o">)</span>
    <span class="o">}</span>
    stages <span class="o">{</span>
        stage<span class="o">(</span><span class="s1">'dev-app Checkout'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                 git branch: <span class="s1">'main'</span>,
                 url: <span class="s1">'http://10.0.4.3:3000/devops/dev-app.git'</span>,  // Git에서 코드 체크아웃
                 credentialsId: <span class="s1">'gogs-crd'</span>  // Credentials ID
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'Read VERSION'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                script <span class="o">{</span>
                    // VERSION 파일 읽기
                    def version <span class="o">=</span> readFile<span class="o">(</span><span class="s1">'VERSION'</span><span class="o">)</span>.trim<span class="o">()</span>
                    <span class="nb">echo</span> <span class="s2">"Version found: </span><span class="k">${</span><span class="nv">version</span><span class="k">}</span><span class="s2">"</span>
                    // 환경 변수 설정
                    env.DOCKER_TAG <span class="o">=</span> version
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'Docker Build and Push'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                script <span class="o">{</span>
                    docker.withRegistry<span class="o">(</span><span class="s1">'https://index.docker.io/v1/'</span>, <span class="s1">'dockerhub-crd'</span><span class="o">)</span> <span class="o">{</span>
                        // DOCKER_TAG 사용
                        def appImage <span class="o">=</span> docker.build<span class="o">(</span><span class="s2">"</span><span class="k">${</span><span class="nv">DOCKER_IMAGE</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">DOCKER_TAG</span><span class="k">}</span><span class="s2">"</span><span class="o">)</span>
                        appImage.push<span class="o">()</span>
                        appImage.push<span class="o">(</span><span class="s2">"latest"</span><span class="o">)</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'ops-deploy Checkout'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                 git branch: <span class="s1">'main'</span>,
                 url: <span class="s1">'http://10.0.4.3:3000/devops/ops-deploy.git'</span>,  // Git에서 코드 체크아웃
                 credentialsId: <span class="s1">'gogs-crd'</span>  // Credentials ID
            <span class="o">}</span>
        <span class="o">}</span>
        stage<span class="o">(</span><span class="s1">'ops-deploy version update push'</span><span class="o">)</span> <span class="o">{</span>
            steps <span class="o">{</span>
                sh <span class="s1">'''
                OLDVER=$(cat dev-app/VERSION)
                NEWVER=$(echo ${DOCKER_TAG})
                sed -i -e "s/$OLDVER/$NEWVER/" dev-app/timeserver.yaml
                sed -i -e "s/$OLDVER/$NEWVER/" dev-app/VERSION
                git add ./dev-app
                git config user.name "devops"
                git config user.email "a@a.com"
                git commit -m "version update ${DOCKER_TAG}"
                git push http://${GOGSCRD_USR}:${GOGSCRD_PSW}@10.0.4.3:3000/devops/ops-deploy.git
                '''</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    post <span class="o">{</span>
        success <span class="o">{</span>
            <span class="nb">echo</span> <span class="s2">"Docker image </span><span class="k">${</span><span class="nv">DOCKER_IMAGE</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">DOCKER_TAG</span><span class="k">}</span><span class="s2"> has been built and pushed successfully!"</span>
        <span class="o">}</span>
        failure <span class="o">{</span>
            <span class="nb">echo</span> <span class="s2">"Pipeline failed. Please check the logs."</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>아래는 dev-app (Repo) 에서 VERSION과 server.py 수정 후 git push를 진행합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># VERSION 파일 수정 : 0.0.4</span>
<span class="c"># server.py 파일 수정 : 0.0.4</span>

<span class="c"># git push : VERSION, server.py, Jenkinsfile</span>
git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"VERSION </span><span class="si">$(</span><span class="nb">cat </span>VERSION<span class="si">)</span><span class="s2"> Changed"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
</code></pre></div></div>
<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_38.png" alt="img.png" loading="lazy" width="976" height="286"></p>

<ul>
  <li>ArgoCD 웹에서 동작을 확인해보겠습니다.</li>
  <li>Jenkins Pipeline이 실행되면서 dev-app Repo의 버전 정보가 변경되고, ops-deploy Repo의 dev-app/VERSION 파일과 timeserver.yaml 파일이 
변경되어 ArgoCD가 변경사항을 감지하고 자동으로 배포를 진행합니다.</li>
  <li>REFRESH 버튼을 클릭하거나 ArgoCD WebHook 설정시 즉시 반영이 가능합니다.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_39.png" alt="img.png" loading="lazy" width="1451" height="631"></p>

<ul>
  <li>dev-app Repo에서 몇번 더 버전을 업데이트 해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># VERSION 파일 수정 : 0.0.5</span>
<span class="c"># server.py 파일 수정 : 0.0.5</span>

<span class="c"># git push : VERSION, server.py, Jenkinsfile</span>
<span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"VERSION </span><span class="si">$(</span><span class="nb">cat </span>VERSION<span class="si">)</span><span class="s2"> Changed"</span> <span class="o">&amp;&amp;</span> git push <span class="nt">-u</span> origin main
<span class="c"># =&gt; [main 881d051] VERSION 0.0.5 Changed</span>
<span class="c">#     2 files changed, 2 insertions(+), 2 deletions(-)</span>
<span class="c">#    Enumerating objects: 7, done.</span>
<span class="c">#    Counting objects: 100% (7/7), done.</span>
<span class="c">#    Delta compression using up to 8 threads</span>
<span class="c">#    Compressing objects: 100% (3/3), done.</span>
<span class="c">#    Writing objects: 100% (4/4), 329 bytes | 329.00 KiB/s, done.</span>
<span class="c">#    Total 4 (delta 2), reused 0 (delta 0), pack-reused 0</span>
<span class="c">#    To http://10.0.4.3:3000/devops/dev-app.git</span>
<span class="c">#       1d4cec2..881d051  main -&amp;gt; main</span>
<span class="c">#    branch 'main' set up to track 'origin/main'.</span>

<span class="c"># 배포 결과 확인</span>
<span class="nv">$ </span>curl http://127.0.0.1:30000
<span class="c"># =&gt; The time is 12:34:14 PM, VERSION 0.0.5</span>
<span class="c">#    Server hostname: timeserver-7546694df7-wds9r</span>
</code></pre></div></div>

<ul>
  <li>CI/CD가 잘 동작하여 최신버전이 배포됨을 확인 할 수 있습니다.</li>
</ul>

<hr>

<h3 id="argo-rollout--k8skind">Argo Rollout + K8S(Kind)</h3>

<ul>
  <li>Argo는 ArgoCD 뿐만 아니라 다양한 프로젝트를 제공하고 있으며, 그중의 하나가 Argo Rollout입니다.</li>
  <li>Argo Rollout은 Kubernetes의 Deployment, StatefulSet, DaemonSet, Job, CronJob 등의 리소스를 대체하여 롤아웃을 관리하는 컨트롤러입니다.</li>
  <li>다음과 같은 기능을 제공합니다. <a href="https://argoproj.github.io/argo-rollouts/concepts/">문서</a>
    <ul>
      <li>Blue-Green 업데이트 전략
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_40.png" alt="img.png" class="image-center" loading="lazy" width="600" height="776">
</li>
      <li>Canary 업데이트 전략
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_41.png" alt="img_1.png" class="image-center" loading="lazy" width="600" height="776">
</li>
      <li>세밀하고 가중치가 부여된 트래픽 전환</li>
      <li>자동화된 롤백 및 프로모션</li>
      <li>수동 판단</li>
      <li>사용자 정의 가능한 메트릭 쿼리 및 비즈니스 KPI 분석</li>
      <li>인그레스 컨트롤러 통합: NGINX, ALB, Apache APISIX</li>
      <li>서비스 메쉬 통합: Istio, Linkerd, SMI</li>
      <li>여러 제공자의 동시 사용: SMI + NGINX, Istio + ALB 등</li>
      <li>메트릭 제공자 통합: Prometheus, Wavefront, Kayenta, Web, Kubernetes Jobs, Datadog, New Relic, Graphite, InfluxDB</li>
    </ul>
  </li>
</ul>

<h5 id="argo-rollout-설치-및-실습">Argo Rollout 설치 및 실습</h5>

<ul>
  <li>Argo Rollout을 설치해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 네임스페이스 생성 및 파라미터 파일 작성</span>
<span class="nv">$ </span>kubectl create ns argo-rollouts
<span class="c"># =&gt; namespace/argo-rollouts created</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; argorollouts-values.yaml
dashboard:
  enabled: true
  service:
    type: NodePort
    nodePort: 30003
</span><span class="no">EOT

</span><span class="c"># 설치</span>
<span class="nv">$ </span>helm <span class="nb">install </span>argo-rollouts argo/argo-rollouts <span class="nt">--version</span> 2.35.1 <span class="nt">-f</span> argorollouts-values.yaml <span class="nt">--namespace</span> argo-rollouts
<span class="c"># =&gt; NAME: argo-rollouts</span>
<span class="c">#    LAST DEPLOYED: Sun Oct 01 23:05:23 2024</span>
<span class="c">#    NAMESPACE: argo-rollouts</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> argo-rollouts
<span class="c"># =&gt; NAME                                           READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/argo-rollouts-86469b5878-j6p5k             1/1     Running   0          42s</span>
<span class="c">#    pod/argo-rollouts-86469b5878-vlr6z             1/1     Running   0          43s</span>
<span class="c">#    pod/argo-rollouts-dashboard-7c88d965fc-l6lml   1/1     Running   0          43s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/argo-rollouts-dashboard   NodePort   10.96.195.148   &amp;lt;none&amp;gt;        3100:30003/TCP   43s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/argo-rollouts             2/2     2            2           43s</span>
<span class="c">#    deployment.apps/argo-rollouts-dashboard   1/1     1            1           43s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                 DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/argo-rollouts-86469b5878             2         2         2       43s</span>
<span class="c">#    replicaset.apps/argo-rollouts-dashboard-7c88d965fc   1         1         1       43s</span>
<span class="nv">$ </span>kubectl get crds
<span class="c"># =&gt; NAME                                   CREATED AT</span>
<span class="c">#    analysisruns.argoproj.io               2024-10-01T14:05:24Z</span>
<span class="c">#    analysistemplates.argoproj.io          2024-10-01T14:05:24Z</span>
<span class="c">#    applications.argoproj.io               2024-10-01T07:54:01Z</span>
<span class="c">#    applicationsets.argoproj.io            2024-10-01T07:54:01Z</span>
<span class="c">#    appprojects.argoproj.io                2024-10-01T07:54:01Z</span>
<span class="c">#    clusteranalysistemplates.argoproj.io   2024-10-01T14:05:24Z</span>
<span class="c">#    experiments.argoproj.io                2024-10-01T14:05:24Z</span>
<span class="c">#    rollouts.argoproj.io                   2024-10-01T14:05:24Z</span>

<span class="c"># Argo rollouts 대시보드 접속 주소 확인</span>
<span class="nv">$ </span>open <span class="s2">"http://127.0.0.1:30003"</span>
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_42.png" alt="img.png" loading="lazy" width="1050" height="382"></p>

<ul>
  <li>Argo Rollout을 이용해서 배포를 진행해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run the following command to deploy the initial Rollout and Service:</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/argoproj/argo-rollouts/master/docs/getting-started/basic/rollout.yaml
<span class="c"># =&gt; rollout.argoproj.io/rollouts-demo created</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/argoproj/argo-rollouts/master/docs/getting-started/basic/service.yaml
<span class="c"># =&gt; service/rollouts-demo created</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get rollout
<span class="c"># =&gt; NAME            DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    rollouts-demo   5         5         5            5           16s</span>
<span class="nv">$ </span>kubectl describe rollout
<span class="c"># =&gt; ...</span>
<span class="c">#    Events:</span>
<span class="c">#      Type    Reason                  Age   From                 Message</span>
<span class="c">#      ----    ------                  ----  ----                 -------</span>
<span class="c">#      Normal  RolloutAddedToInformer  25s   rollouts-controller  Rollout resource added to informer: default/rollouts-demo</span>
<span class="c">#      Normal  RolloutNotCompleted     25s   rollouts-controller  Rollout not completed, started update to revision 1 (687d76d795)</span>
<span class="c">#      Normal  RolloutUpdated          25s   rollouts-controller  Rollout updated to revision 1</span>
<span class="c">#      Normal  NewReplicaSetCreated    25s   rollouts-controller  Created ReplicaSet rollouts-demo-687d76d795 (revision 1)</span>
<span class="c">#      Normal  ScalingReplicaSet       25s   rollouts-controller  Scaled up ReplicaSet rollouts-demo-687d76d795 (revision 1) from 0 to 5</span>
<span class="c">#      Normal  RolloutCompleted        25s   rollouts-controller  Rollout completed update to revision 1 (687d76d795): Initial deploy</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rollouts-demo
<span class="c"># =&gt; NAME                             READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    rollouts-demo-687d76d795-7pbl9   1/1     Running   0          46s</span>
<span class="c">#    rollouts-demo-687d76d795-bnl2c   1/1     Running   0          46s</span>
<span class="c">#    rollouts-demo-687d76d795-ggzsq   1/1     Running   0          46s</span>
<span class="c">#    rollouts-demo-687d76d795-vtnlj   1/1     Running   0          46s</span>
<span class="c">#    rollouts-demo-687d76d795-xmk2x   1/1     Running   0          46s</span>
<span class="nv">$ </span>kubectl get svc,ep rollouts-demo
<span class="c"># =&gt; NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/rollouts-demo   ClusterIP   10.96.237.173   &amp;lt;none&amp;gt;        80/TCP    47s</span>
<span class="c">#    </span>
<span class="c">#    NAME                      ENDPOINTS                                                        AGE</span>
<span class="c">#    endpoints/rollouts-demo   10.244.1.14:8080,10.244.1.15:8080,10.244.1.16:8080 + 2 more...   47s</span>
<span class="nv">$ </span>kubectl get rollouts rollouts-demo <span class="nt">-o</span> yaml | kubectl neat
<span class="c"># =&gt; ...</span>
<span class="c">#    spec:</span>
<span class="c">#      replicas: 5</span>
<span class="c">#      revisionHistoryLimit: 2</span>
<span class="c">#      selector:</span>
<span class="c">#        matchLabels:</span>
<span class="c">#          app: rollouts-demo</span>
<span class="c">#      strategy:</span>
<span class="c">#        canary:</span>
<span class="c">#          steps:</span>
<span class="c">#          - setWeight: 20</span>
<span class="c">#          - setWeight: 40</span>
<span class="c">#          - pause:</span>
<span class="c">#              duration: 10</span>
<span class="c">#          - setWeight: 60</span>
<span class="c">#          - pause:</span>
<span class="c">#              duration: 10</span>
<span class="c">#          - setWeight: 80</span>
<span class="c">#          - pause:</span>
<span class="c">#              duration: 10</span>
<span class="c">#      ...</span>
</code></pre></div></div>

<ul>
  <li>
    <p>우측상단의 NAMESPACE를 default로 변경하고 rollout-demo를 클릭하면 다음의 rollout 화면이 나타납니다.
<img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_43.png" alt="img.png" loading="lazy" width="1176" height="754"></p>
  </li>
  <li>
    <p>rollouts-demo:blue를 rollouts-demo:yellow로 변경해서 배포해보겠습니다.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl edit rollouts rollouts-demo
...
     - image: argoproj/rollouts-demo:yellow
...
<span class="c"># =&gt; rollout.argoproj.io/rollouts-demo edited</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 위와 같이 rollouts-demo/blue를 rollouts-demo/yellow로 변경합니다.&lt;/span&gt;</span>

<span class="c"># 파드 label 정보 확인</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>rollouts-demo <span class="nt">-owide</span> <span class="nt">--show-labels</span>
</code></pre></div></div>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_44.png" alt="img.png" loading="lazy" width="1297" height="1120"></p>

<ul>
  <li>위와같이 yellow가 20% 만큼 canary 배포되고 정자 상태에 있습니다.</li>
  <li>Promote 버튼을 클릭하여 보겠습니다.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_45.png" alt="img.png" loading="lazy" width="570" height="144"></p>

<ul>
  <li>정해진 rollout rule에 따라 10초씩 대기 후 20%씩 canary 배포 비율을 높여서 최종적으로 전체가 yellow로 배포됩니다.</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_46.png" alt="img.png" loading="lazy" width="1141" height="858"></p>

<h2 id="마치며">마치며</h2>

<p>이번주에는 생각보다 실습량이 많아서 시간이 많이 걸렸습니다. 
하지만, K8S에 CI/CD 배포하는것과 ArgoCD와 Argo Rollout을 이용한 CI/CD 파이프라인 구성을 경험해볼 수 있어서 좋았습니다.
특히 ArgoCD와 Argo Rollout은 웹 UI는 조금 날것 느낌이 났지만,
기능이나 컨셉 자체는 좋은것 같고, 
선언적인 방식이나 CLI를 통해서 자동화할 수 있으니 다양하게 활용할 수 있을것 같습니다.</p>

<p>스터디 컨셉이 CI/CD 맛보기여서 가벼운 마음으로 시작했는데
실제 스터디는 가볍지 않았던것 같습니다.<br>
이 맛에 스터디합니다. 
<img class="emoji" title=":sweat_smile:" alt=":sweat_smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png" height="20" width="20" loading="lazy"> 맛보기가 이 정도이니 본편은 얼마나 깊고 넓을지 기대가 됩니다.</p>

<p>연말에 어수선한 가운데 다들 스터디 참여하신 분들 모두 고생 많으셨고, 
진행해주신 가시다님께 감사드립니다.</p>

<p>긴 글 읽어주셔서 감사합니다. 
한 해 마무리 잘 하시고, 건강한 모습으로 내년에 또 뵙기를 기원합니다. <img class="emoji" title=":bow:" alt=":bow:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f647.png" height="20" width="20" loading="lazy"><img class="emoji" title=":bowing_woman:" alt=":bowing_woman:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f647-2640.png" height="20" width="20" loading="lazy"></p>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#jenkins-ciargocd--k8s">Jenkins CI/ArgoCD + K8S</a>
<ul>
<li class="toc-entry toc-h3">
<a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1">실습환경 구성</a>
<ul>
<li class="toc-entry toc-h4"><a href="#jenkins-gogs-%EC%84%A4%EC%B9%98">Jenkins, Gogs 설치</a></li>
<li class="toc-entry toc-h4"><a href="#jenkins-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EC%B4%88%EA%B8%B0%EC%84%A4%EC%A0%95">Jenkins 컨테이너 초기설정</a></li>
<li class="toc-entry toc-h4"><a href="#gogs-%EC%B4%88%EA%B8%B0-%EC%84%A4%EC%A0%95">Gogs 초기 설정</a></li>
<li class="toc-entry toc-h4"><a href="#%EB%8F%84%EC%BB%A4-%ED%97%88%EB%B8%8C--%EC%84%A4%EC%A0%95">도커 허브  설정</a></li>
</ul>
</li>
<li class="toc-entry toc-h3">
<a href="#jenkins-ci--k8s-kind">Jenkins CI + K8S (Kind)</a>
<ul>
<li class="toc-entry toc-h4"><a href="#kind-%EC%86%8C%EA%B0%9C-%EB%B0%8F-%EC%84%A4%EC%B9%98">Kind 소개 및 설치</a></li>
<li class="toc-entry toc-h4"><a href="#kind%EB%A1%9C-kubernetes-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EB%B0%B0%ED%8F%AC---3%EB%85%B8%EB%93%9C">Kind로 Kubernetes 클러스터 배포 - 3노드</a></li>
<li class="toc-entry toc-h4"><a href="#jenkins-%EC%84%A4%EC%A0%95--plugin-%EC%84%A4%EC%B9%98-%EC%9E%90%EA%B2%A9%EC%A6%9D%EB%AA%85-%EC%84%A4%EC%A0%95">Jenkins 설정 : Plugin 설치, 자격증명 설정</a></li>
<li class="toc-entry toc-h4"><a href="#kubernetes-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%EC%97%90-%EC%9D%91%EC%9A%A9%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%A8-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0">Kubernetes 클러스터에 응용프로그램 배포하기</a></li>
<li class="toc-entry toc-h4"><a href="#k8s%EC%97%90-docker-hub-%EC%9D%B8%EC%A6%9D%ED%86%A0%ED%81%B0-%EB%93%B1%EB%A1%9D-%ED%9B%84-%EB%8B%A4%EC%8B%9C-%EB%B0%B0%ED%8F%AC">K8S에 Docker Hub 인증토큰 등록 후 다시 배포</a></li>
<li class="toc-entry toc-h4"><a href="#gogs-webhook%EC%9D%84-%ED%86%B5%ED%95%B4-jenkins-pipeline-%EC%9E%90%EB%8F%99%ED%99%94">Gogs Webhook을 통해 Jenkins Pipeline 자동화</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#jenkins-cicd--k8s-kind">Jenkins CI/CD + K8S (Kind)</a></li>
<li class="toc-entry toc-h3">
<a href="#jenkins-ci--argocd--k8s-kind">Jenkins CI + ArgoCD + K8S (Kind)</a>
<ul>
<li class="toc-entry toc-h4"><a href="#argocd-%EC%86%8C%EA%B0%9C">ArgoCD 소개</a></li>
<li class="toc-entry toc-h4"><a href="#argocd-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EA%B8%B0%EB%B3%B8%EC%84%A4%EC%A0%95">ArgoCD 설치 및 기본설정</a></li>
<li class="toc-entry toc-h4"><a href="#helm-chart%EB%A5%BC-%ED%86%B5%ED%95%9C-%EB%B0%B0%ED%8F%AC-%EC%8B%A4%EC%8A%B5">Helm chart를 통한 배포 실습</a></li>
<li class="toc-entry toc-h4"><a href="#argocd-declarative-setup%EC%9C%BC%EB%A1%9C-%EB%B0%B0%ED%8F%AC-%EC%8B%A4%EC%8A%B5">ArgoCD Declarative Setup으로 배포 실습</a></li>
<li class="toc-entry toc-h4"><a href="#argocd%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-full-cicd-%EA%B5%AC%EC%84%B1">ArgoCD를 이용한 Full CI/CD 구성</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#argo-rollout--k8skind">Argo Rollout + K8S(Kind)</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2024-12-22-CICD-Lite-Week3/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2024-12-14-CICD-Lite-Week2/">« [CI/CD] GitHub Actions CI/CD</a>
  
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2024-12-22-CICD-Lite-Week3/";
this.page.identifier = "/posts/CICD Lite - Week3";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>

<!--      <div class="adsbygoogle-side">-->
<!--        &lt;!&ndash; ad_side &ndash;&gt;-->
<!--        <ins class="adsbygoogle "-->
<!--             style="display: block"-->
<!--             data-ad-client="ca-pub-6564723532026864"-->
<!--             data-ad-slot="1339398797"-->
<!--             data-ad-format="auto"-->
<!--             data-full-width-responsive="true"></ins>-->
<!--      </div>-->
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>공부 기록과 개발 이야기를 담은 블로그입니다.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>

<!--    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6564723532026864"-->
<!--            crossorigin="anonymous"></script>-->
<!--    <script>-->
<!--    (adsbygoogle = window.adsbygoogle || []).push({});-->
<!--    </script>-->
  </body>

</html>
