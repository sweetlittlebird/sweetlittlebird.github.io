<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[Cilium] (Observability) Hubble, Prometheus, Grafana | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[Cilium] (Observability) Hubble, Prometheus, Grafana">
<meta property="og:locale" content="ko">
<meta name="description" content="이번에는 Hubble, Prometheus, Grafana를 이용하여 Cilium의 Observability를 살펴보겠습니다.">
<meta property="og:description" content="이번에는 Hubble, Prometheus, Grafana를 이용하여 Cilium의 Observability를 살펴보겠습니다.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2025-07-27-Cilium-Week2/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2025-07-27-Cilium-Week2/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2025-07-27T00:10:18+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[Cilium] (Observability) Hubble, Prometheus, Grafana">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-07-27T00:10:18+09:00","datePublished":"2025-07-27T00:10:18+09:00","description":"이번에는 Hubble, Prometheus, Grafana를 이용하여 Cilium의 Observability를 살펴보겠습니다.","headline":"[Cilium] (Observability) Hubble, Prometheus, Grafana","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2025-07-27-Cilium-Week2/"},"url":"https://sweetlittlebird.github.io/posts/2025-07-27-Cilium-Week2/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body class="body--contents">
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">소개</a><a class="page-link" href="/posts/">글 목록</a>
</div>
      </nav>
</div>
  
  <span id="scroll-indicator"></span>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[Cilium] (Observability) Hubble, Prometheus, Grafana</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-07-27T00:10:18+09:00" itemprop="datePublished">2025년 07월 27일에 작성
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>목차</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#%EC%8B%A4%EC%8A%B5-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1">실습 환경 구성</a>
<ul>
<li class="toc-entry toc-h3">
<a href="#%EC%8B%A4%EC%8A%B5-%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC-%ED%8C%8C%EC%9D%BC-%EC%9E%91%EC%84%B1">실습 환경 배포 파일 작성</a>
<ul>
<li class="toc-entry toc-h4"><a href="#vagrantfile">Vagrantfile</a></li>
<li class="toc-entry toc-h4"><a href="#init_cfgsh">init_cfg.sh</a></li>
<li class="toc-entry toc-h4"><a href="#k8s-ctrsh">k8s-ctr.sh</a></li>
<li class="toc-entry toc-h4"><a href="#k8s-wsh">k8s-w.sh</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC">실습환경 배포</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-agent-%EB%8B%A8%EC%B6%95%ED%82%A4-%EC%A7%80%EC%A0%95">Cilium Agent 단축키 지정</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#network-observability-with-hubble">Network Observability with Hubble</a>
<ul>
<li class="toc-entry toc-h3"><a href="#hubble-%EC%86%8C%EA%B0%9C">Hubble 소개</a></li>
<li class="toc-entry toc-h3"><a href="#hubble-observability-%EC%84%A4%EC%B9%98">Hubble Observability 설치</a></li>
<li class="toc-entry toc-h3">
<a href="#star-wars-demo%EB%A5%BC-%ED%86%B5%ED%95%9C-hubbleui-%EC%B2%B4%ED%97%98">Star Wars Demo를 통한 Hubble/UI 체험</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EB%8D%B0%EB%AA%A8-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%B0%ED%8F%AC">데모 애플리케이션 배포</a></li>
<li class="toc-entry toc-h4"><a href="#%ED%98%84%EC%9E%AC-%EC%A0%91%EA%B7%BC%EC%83%81%ED%83%9C-%ED%99%95%EC%9D%B8">현재 접근상태 확인</a></li>
<li class="toc-entry toc-h4"><a href="#l3l4-%EC%A0%95%EC%B1%85-%EC%A0%81%EC%9A%A9">L3/L4 정책 적용</a></li>
<li class="toc-entry toc-h4"><a href="#http-aware-l7-%EC%A0%95%EC%B1%85-%EC%A0%81%EC%9A%A9-%EB%B0%8F-%ED%85%8C%EC%8A%A4%ED%8A%B8">HTTP-aware L7 정책 적용 및 테스트</a></li>
<li class="toc-entry toc-h4"><a href="#configuring-hubble-exporter">Configuring Hubble Exporter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#prometheus%EC%99%80-grafana%EB%A5%BC-%ED%86%B5%ED%95%9C-%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">Prometheus와 Grafana를 통한 모니터링</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%83%98%ED%94%8C-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%99%95%EC%9D%B8">샘플 애플리케이션 배포 및 확인</a></li>
<li class="toc-entry toc-h3"><a href="#prometheus-%EC%99%80-grafana-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EC%84%A4%EC%A0%95">Prometheus 와 Grafana 설치 및 설정</a></li>
<li class="toc-entry toc-h3"><a href="#cilium%EA%B3%BC-hubble-%EB%A9%94%ED%8A%B8%EB%A6%AD-%EC%BC%9C%EA%B8%B0">Cilium과 Hubble 메트릭 켜기</a></li>
<li class="toc-entry toc-h3"><a href="#prometheus%EC%99%80-grafana-%EC%A0%91%EC%86%8D%ED%95%B4%EC%84%9C-%ED%99%95%EC%9D%B8">Prometheus와 Grafana 접속해서 확인</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#monitoring--metrics">Monitoring &amp; Metrics</a>
<ul>
<li class="toc-entry toc-h3"><a href="#cilium-metrics-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EC%88%98%EC%A7%91-%EB%B0%A9%EB%B2%95">Cilium Metrics 설정 및 수집 방법</a></li>
<li class="toc-entry toc-h3"><a href="#hubble-metrics-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EC%88%98%EC%A7%91-%EB%B0%A9%EB%B2%95">Hubble Metrics 설정 및 수집 방법</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#layer-7-protocol-visibility">Layer 7 Protocol Visibility</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5">실습</a></li>
<li class="toc-entry toc-h3"><a href="#security-implications-%EB%B0%8F-%EC%8B%A4%EC%8A%B5">Security Implications 및 실습</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#pwru-packet-where-are-you">pwru (Packet where are you)</a>
<ul>
<li class="toc-entry toc-h3"><a href="#pwru-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EC%8B%A4%ED%96%89">pwru 설치 및 실행</a></li>
<li class="toc-entry toc-h3"><a href="#%EB%B9%8C%EB%93%9C-%ED%8A%B8%EB%9F%AC%EB%B8%94%EC%8A%88%ED%8C%85-%EB%B0%8F-%EC%8B%A4%ED%96%89">빌드 트러블슈팅 및 실행</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
    </div>
    <h2 id="들어가며">들어가며</h2>

<p>이번에는 Hubble, Prometheus, Grafana 등을 이용하여 Cilium의 관측성(Observability)에 대해 살펴보겠습니다.</p>

<hr>

<h2 id="실습-환경-구성">실습 환경 구성</h2>

<ul>
  <li>실습 환경 소개</li>
</ul>

<p>실습 환경은 지난주와 거의 유사합니다. 단, 파드 IP 대역이 <code class="language-plaintext highlighter-rouge">10.244.0.0/16</code>에서 <code class="language-plaintext highlighter-rouge">172.20.0.0/16</code>으로 변경되었습니다.</p>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_1.png" alt="img.png" loading="lazy" width="1750" height="614"></p>

<ul>
  <li>배포 가상 머신은 컨트롤플레인인 k8s-ctr, 워커노드 k8s-w1, k8s-w2로 구성되어 있습니다.
    <ul>
      <li>eth0 : 10.0.2.15 (모든 노드가 동일)</li>
      <li>eth1 : 192.168.10.100~102</li>
    </ul>
  </li>
  <li>초기 프로비저닝시 <code class="language-plaintext highlighter-rouge">kubeadm init</code>과 <code class="language-plaintext highlighter-rouge">join</code> 을 실행하여 클러스터를 구성하며, <strong>이번에는 Cilium CNI가 설치된 상태로 배포됩니다</strong>.</li>
</ul>

<h3 id="실습-환경-배포-파일-작성">실습 환경 배포 파일 작성</h3>

<h4 id="vagrantfile"><strong>Vagrantfile</strong></h4>
<ul>
  <li>가상머신을 정의하고 부팅시 실행할 프로비저닝 설정을 합니다.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Variables</span>
<span class="no">K8SV</span> <span class="o">=</span> <span class="s1">'1.33.2-1.1'</span> <span class="c1"># Kubernetes Version : apt list -a kubelet , ex) 1.32.5-1.1</span>
<span class="no">CONTAINERDV</span> <span class="o">=</span> <span class="s1">'1.7.27-1'</span> <span class="c1"># Containerd Version : apt list -a containerd.io , ex) 1.6.33-1</span>
<span class="no">CILIUMV</span> <span class="o">=</span> <span class="s1">'1.17.6'</span> <span class="c1"># Cilium CNI Version : https://github.com/cilium/cilium/tags</span>
<span class="no">N</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># max number of worker nodes</span>

<span class="c1"># Base Image  https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-24.04</span>
<span class="no">BOX_IMAGE</span> <span class="o">=</span> <span class="s2">"bento/ubuntu-24.04"</span>
<span class="no">BOX_VERSION</span> <span class="o">=</span> <span class="s2">"202502.21.0"</span>

<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1">#-ControlPlane Node</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-ctr"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>

    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">2048</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.100"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60000</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span> <span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-ctr.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">N</span><span class="p">,</span> <span class="no">CILIUMV</span> <span class="p">]</span>
  <span class="k">end</span>

  <span class="c1">#-Worker Nodes Subnet1</span>
  <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="no">N</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.10</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="s2">"6000</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-w.sh"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="init_cfgsh"><strong>init_cfg.sh</strong></h4>
<ul>
  <li>프로비저닝시 vagrant가 실행할 초기 설정 스크립트입니다. arguments로 Kubernetes 버전과 Containerd 버전등을 받아서 설치합니다.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>

<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime <span class="c"># Change Timezone</span>

<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="nb">echo</span> <span class="s2">"[TASK 3] Disable and turn off SWAP"</span>
swapoff <span class="nt">-a</span> <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'/swap/s/^/#/'</span> /etc/fstab

<span class="nb">echo</span> <span class="s2">"[TASK 4] Install Packages"</span>
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>apt-transport-https ca-certificates curl gpg <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="c"># Download the public signing key for the Kubernetes package repositories.</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nt">-m</span> 755 /etc/apt/keyrings
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$1</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+)\..*/\1/p'</span><span class="si">)</span>
curl <span class="nt">-fsSL</span> https://pkgs.k8s.io/core:/stable:/v<span class="nv">$K8SMMV</span>/deb/Release.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/kubernetes-apt-keyring.gpg
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v</span><span class="nv">$K8SMMV</span><span class="s2">/deb/ /"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list.d/kubernetes.list
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null

<span class="c"># packets traversing the bridge are processed by iptables for filtering</span>
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
<span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> <span class="o">&gt;&gt;</span> /etc/sysctl.d/k8s.conf

<span class="c"># enable br_netfilter for iptables </span>
modprobe br_netfilter
modprobe overlay
<span class="nb">echo</span> <span class="s2">"br_netfilter"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
<span class="nb">echo</span> <span class="s2">"overlay"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf

<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)"</span>
<span class="c"># Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version</span>
apt update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="c"># apt list -a kubelet ; apt list -a containerd.io</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubectl</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubeadm</span><span class="o">=</span><span class="nv">$1</span> containerd.io<span class="o">=</span><span class="nv">$2</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-mark hold kubelet kubeadm kubectl <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="c"># containerd configure to default and cgroup managed by systemd</span>
containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SystemdCgroup = false/SystemdCgroup = true/g'</span> /etc/containerd/config.toml

<span class="c"># avoid WARN&amp;ERRO(default endpoints) when crictl run  </span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
</span><span class="no">EOF

</span><span class="c"># ready to install for k8s </span>
systemctl restart containerd <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable </span>containerd
systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet

<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Packages &amp; Helm"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get <span class="nb">install</span> <span class="nt">-y</span> bridge-utils sshpass net-tools conntrack ngrep tcpdump ipset arping wireguard jq tree bash-completion unzip kubecolor termshark <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
curl <span class="nt">-s</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash <span class="o">&gt;</span>/dev/null 2&gt;&amp;1

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div></div>

<h4 id="k8s-ctrsh"><strong>k8s-ctr.sh</strong></h4>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">kubeadm init</code>으로 컨트롤플레인을 설정하고, Cilium CNI를 설치합니다. 또한 편의를 위한 <code class="language-plaintext highlighter-rouge">k</code>, <code class="language-plaintext highlighter-rouge">kc</code> 등의 alias를 설정합니다.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane config Start &lt;&lt;&lt;&lt;"</span>

<span class="nb">echo</span> <span class="s2">"[TASK 1] Initial Kubernetes"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-init-ctr-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-init-ctr-config.yaml
kubeadm init <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-init-ctr-config.yaml"</span> <span class="nt">--skip-phases</span><span class="o">=</span>addon/kube-proxy  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1


<span class="nb">echo</span> <span class="s2">"[TASK 2] Setting kube config file"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /root/.kube
<span class="nb">cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf /root/.kube/config
<span class="nb">chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> /root/.kube/config


<span class="nb">echo</span> <span class="s2">"[TASK 3] Source the completion"</span>
<span class="nb">echo</span> <span class="s1">'source &lt;(kubectl completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'source &lt;(kubeadm completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile


<span class="nb">echo</span> <span class="s2">"[TASK 4] Alias kubectl to k"</span>
<span class="nb">echo</span> <span class="s1">'alias k=kubectl'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'alias kc=kubecolor'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'complete -F __start_kubectl k'</span> <span class="o">&gt;&gt;</span> /etc/profile


<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubectx &amp; Kubens"</span>
git clone https://github.com/ahmetb/kubectx /opt/kubectx <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubens /usr/local/bin/kubens
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubectx /usr/local/bin/kubectx


<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Kubeps &amp; Setting PS1"</span>
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1 <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">"</span><span class="no">EOT</span><span class="sh">" &gt;&gt; /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
function get_cluster_short() {
  echo "</span><span class="nv">$1</span><span class="sh">" | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=') '
PS1='</span><span class="si">$(</span>kube_ps1<span class="si">)</span><span class="sh">'</span><span class="nv">$PS1</span><span class="sh">
</span><span class="no">EOT
</span>kubectl config rename-context <span class="s2">"kubernetes-admin@kubernetes"</span> <span class="s2">"HomeLab"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1


<span class="nb">echo</span> <span class="s2">"[TASK 7] Install Cilium CNI"</span>
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
helm repo add cilium https://helm.cilium.io/ <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm repo update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> <span class="nv">$2</span> <span class="nt">--namespace</span> kube-system <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.100 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="se">\</span>
<span class="nt">--set</span> ipam.mode<span class="o">=</span><span class="s2">"cluster-pool"</span> <span class="nt">--set</span> ipam.operator.clusterPoolIPv4PodCIDRList<span class="o">={</span><span class="s2">"172.20.0.0/16"</span><span class="o">}</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>172.20.0.0/16 <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> endpointRoutes.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1


<span class="nb">echo</span> <span class="s2">"[TASK 8] Install Cilium CLI"</span>
<span class="nv">CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz


<span class="nb">echo</span> <span class="s2">"[TASK 9] local DNS with hosts file"</span>
<span class="nb">echo</span> <span class="s2">"192.168.10.100 k8s-ctr"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;<span class="o">=</span><span class="nv">$1</span><span class="p">;</span> i++  <span class="o">))</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"192.168.10.10</span><span class="nv">$i</span><span class="s2"> k8s-w</span><span class="nv">$i</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts<span class="p">;</span> <span class="k">done


</span><span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div></div>

<ul>
  <li>
    <p>부가적으로 <code class="language-plaintext highlighter-rouge">kubeadm-init-ctr-config.yaml</code> 파일은 다음과 같이 작성되어 있습니다.</p>

    <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kubeadm.k8s.io/v1beta4</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">InitConfiguration</span>
<span class="na">bootstrapTokens</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">token</span><span class="pi">:</span> <span class="s2">"</span><span class="s">123456.1234567890123456"</span>
  <span class="na">ttl</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0s"</span>
  <span class="na">usages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">signing</span>
  <span class="pi">-</span> <span class="s">authentication</span>
<span class="na">localAPIEndpoint</span><span class="pi">:</span>
  <span class="na">advertiseAddress</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.10.100"</span>
<span class="na">nodeRegistration</span><span class="pi">:</span>
  <span class="na">kubeletExtraArgs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">node-ip</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.10.100"</span>
  <span class="na">criSocket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">unix:///run/containerd/containerd.sock"</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kubeadm.k8s.io/v1beta4</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterConfiguration</span>
<span class="na">kubernetesVersion</span><span class="pi">:</span> <span class="s">v1.33.2</span>
<span class="na">networking</span><span class="pi">:</span>
  <span class="na">podSubnet</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.244.0.0/16"</span>
  <span class="na">serviceSubnet</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.96.0.0/16"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="k8s-wsh"><strong>k8s-w.sh</strong></h4>
<ul>
  <li>워커노드에서 <code class="language-plaintext highlighter-rouge">kubeadm join</code>을 실행하여 컨트롤플레인에 조인합니다.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;"</span>

<span class="nb">echo</span> <span class="s2">"[TASK 1] K8S Controlplane Join"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-join-worker-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-join-worker-config.yaml
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/NODE_IP_PLACEHOLDER/</span><span class="k">${</span><span class="nv">NODEIP</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-join-worker-config.yaml
kubeadm <span class="nb">join</span> <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-join-worker-config.yaml"</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1

<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div></div>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">kubeadm-join-worker-config.yaml</code> 파일은 다음과 같이 작성되어 있습니다.
    <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kubeadm.k8s.io/v1beta4</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">JoinConfiguration</span>
<span class="na">discovery</span><span class="pi">:</span>
  <span class="na">bootstrapToken</span><span class="pi">:</span>
    <span class="na">token</span><span class="pi">:</span> <span class="s2">"</span><span class="s">123456.1234567890123456"</span>
    <span class="na">apiServerEndpoint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.10.100:6443"</span>
    <span class="na">unsafeSkipCAVerification</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">nodeRegistration</span><span class="pi">:</span>
  <span class="na">criSocket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">unix:///run/containerd/containerd.sock"</span>
  <span class="na">kubeletExtraArgs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">node-ip</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">NODE_IP_PLACEHOLDER"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="실습환경-배포">실습환경 배포</h3>

<ul>
  <li>배포</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vagrant up
</code></pre></div></div>

<ul>
  <li>[k8s-ctr] 접속 후 기본 정보 확인</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s-ctr 접속</span>
<span class="nv">$ </span>vagrant ssh k8s-ctr
<span class="nt">---</span>
<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
<span class="c"># =&gt; 127.0.0.1 localhost</span>
<span class="c">#    127.0.1.1 vagrant</span>
<span class="c">#    ...</span>
<span class="c">#    127.0.2.1 k8s-ctr k8s-ctr</span>
<span class="c">#    192.168.10.100 k8s-ctr</span>
<span class="c">#    192.168.10.101 k8s-w1</span>
<span class="c">#    192.168.10.102 k8s-w2</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-w1 <span class="nb">hostname</span>
<span class="c"># =&gt; k8s-w1</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-w2 <span class="nb">hostname</span>
<span class="c"># =&gt; k8s-w2</span>

<span class="c">#</span>
<span class="nv">$ </span>ifconfig | <span class="nb">grep</span> <span class="nt">-iEA1</span> <span class="s1">'eth[0-9]:'</span>
<span class="c"># =&gt; eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255</span>
<span class="c">#    --</span>
<span class="c">#    eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 192.168.10.100  netmask 255.255.255.0  broadcast 192.168.10.255</span>

<span class="c"># 클러스터 정보 확인</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt;                             "--service-cluster-ip-range=10.96.0.0/16",</span>
<span class="c">#                                "--cluster-cidr=10.244.0.0/16",</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubeadm-config
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubelet-config

<span class="c"># 노드 정보 : 상태, INTERNAL-IP 확인</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME      STATUS   ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    k8s-ctr   Ready    control-plane   14m   v1.33.2   &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt;   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w1    Ready    &lt;none&gt;          11m   v1.33.2   &lt;span style="color: green;"&gt;192.168.10.101&lt;/span&gt;   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w2    Ready    &lt;none&gt;          10m   v1.33.2   &lt;span style="color: green;"&gt;192.168.10.102&lt;/span&gt;   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>

<span class="c"># 노드별 kubeadm-flags.env 정보 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> /var/lib/kubelet/kubeadm-flags.env
<span class="c"># =&gt; KUBELET_KUBEADM_ARGS="--container-runtime-endpoint=unix:///run/containerd/containerd.sock --node-ip=192.168.10.100 --pod-infra-container-image=registry.k8s.io/pause:3.10"</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">cat</span> /var/lib/kubelet/kubeadm-flags.env <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>

<span class="c"># 파드 정보 : 상태, 파드 IP 확인</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'</span>
<span class="c"># =&gt; k8s-ctr 10.244.0.0/24</span>
<span class="c">#    k8s-w1  10.244.1.0/24</span>
<span class="c">#    k8s-w2  10.244.2.0/24</span>
<span class="nv">$ </span>kubectl get ciliumnode <span class="nt">-o</span> json | <span class="nb">grep </span>podCIDRs <span class="nt">-A2</span>
<span class="c"># =&gt;                     "podCIDRs": [ "172.20.0.0/24" ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [ "172.20.1.0/24" ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [ "172.20.2.0/24" ],</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-2rgdx&lt;/span&gt;                       1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-envoy-q97fq&lt;/span&gt;                 1/1     Running   0          12m   192.168.10.102   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-envoy-xzxd6&lt;/span&gt;                 1/1     Running   0          13m   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-envoy-zzzw5&lt;/span&gt;                 1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-fdqhq&lt;/span&gt;                       1/1     Running   0          12m   192.168.10.102   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-kv67c&lt;/span&gt;                       1/1     Running   0          13m   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   &lt;span style="color: green;"&gt;cilium-operator-5bc66f5b9b-xps5x&lt;/span&gt;   1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-4h2lt           1/1     &lt;span style="color: green;"&gt;Running&lt;/span&gt;   0          15m   172.20.0.233     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-7m82r           1/1     &lt;span style="color: green;"&gt;Running&lt;/span&gt;   0          15m   172.20.0.167     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   etcd-k8s-ctr                       1/1     Running   0          16m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-apiserver-k8s-ctr             1/1     Running   0          16m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-controller-manager-k8s-ctr    1/1     Running   0          16m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system   kube-scheduler-k8s-ctr             1/1     Running   0          16m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 cilium CNI가 설치되어있고, CNI가 설치되었기 때문에 coredns가 Running 상태로 시작됨을 알 수 있습니다.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 또한 kube-proxy가 설치되지 않았고, Cilium이 kube-proxy를 대체하고 있음을 알 수 있습니다.&lt;/span&gt;</span>

<span class="c"># iptables 확인</span>
<span class="nv">$ </span>iptables-save
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
</code></pre></div></div>

<ul>
  <li>[k8s-ctr] cilium 설치 정보 확인</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium 상태 확인</span>
<span class="nv">$ </span>which cilium
<span class="c"># =&gt; /usr/local/bin/cilium</span>
<span class="nv">$ </span>cilium status
<span class="c"># =&gt;     /¯¯\</span>
<span class="c">#     /¯¯\__/¯¯\    Cilium:             OK</span>
<span class="c">#     \__/¯¯\__/    Operator:           OK</span>
<span class="c">#     /¯¯\__/¯¯\    Envoy DaemonSet:    OK</span>
<span class="c">#     \__/¯¯\__/    Hubble Relay:       disabled</span>
<span class="c">#        \__/       ClusterMesh:        disabled</span>
<span class="c">#    </span>
<span class="c">#    DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3</span>
<span class="c">#    Deployment             cilium-operator          Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Containers:            cilium                   Running: 3</span>
<span class="c">#                           cilium-envoy             Running: 3</span>
<span class="c">#                           cilium-operator          Running: 1</span>
<span class="c">#                           clustermesh-apiserver</span>
<span class="c">#                           hubble-relay</span>
<span class="c">#    Cluster Pods:          2/2 managed by Cilium</span>
<span class="c">#    Helm chart version:    1.17.6</span>
<span class="c">#    Image versions         cilium             quay.io/cilium/cilium:v1.17.6@sha256:544de3d4fed7acba72758413812780a4972d47c39035f2a06d6145d8644a3353: 3</span>
<span class="c">#                           cilium-envoy       quay.io/cilium/cilium-envoy:v1.33.4-1752151664-7c2edb0b44cf95f326d628b837fcdd845102ba68@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3</span>
<span class="c">#                           cilium-operator    quay.io/cilium/operator-generic:v1.17.6@sha256:91ac3bf7be7bed30e90218f219d4f3062a63377689ee7246062fa0cc3839d096: 1</span>
<span class="nv">$ </span>cilium config view
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg config
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg status <span class="nt">--verbose</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg metrics list

<span class="c">#</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>

<span class="c"># monitor</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">-v</span>

<span class="c">## Filter for only the events related to endpoint</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">--related-to</span><span class="o">=</span>&lt;<span class="nb">id</span><span class="o">&gt;</span>

<span class="c">## Show notifications only for dropped packet events</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">--type</span> drop

<span class="c">## Don’t dissect packet payload, display payload in hex information</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">-v</span> <span class="nt">--hex</span>

<span class="c">## Layer7</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
</code></pre></div></div>

<h3 id="cilium-agent-단축키-지정">Cilium Agent 단축키 지정</h3>

<ul>
  <li>
<a href="https://sweetlittlebird.github.io/posts/2025-07-20-Cilium-Week1/#%EB%A7%88%EC%B9%98%EB%A9%B0">[Cilium] 실습 환경 구성 및 Cilium 설치</a>의 Cilium CMD Cheatsheet를 참고하여 환경변수와 alias를 지정합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium 파드 이름</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-ctr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w2  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CILIUMPOD0</span> <span class="nv">$CILIUMPOD1</span> <span class="nv">$CILIUMPOD2</span>
<span class="c"># =&gt; cilium-5kc8d cilium-w9st8 cilium-l8lm7</span>

<span class="c"># 단축키(alias) 지정</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>

<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2bpf</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- bpftool"</span>
</code></pre></div></div>

<h2 id="network-observability-with-hubble">Network Observability with Hubble</h2>

<h3 id="hubble-소개">Hubble 소개</h3>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_2.png" alt="img.png" class="image-center w-80" loading="lazy" width="2400" height="840"></p>

<ul>
  <li>
<strong>Hubble</strong>은 Cilium과 eBPF를 기반으로 구축된 <strong>완전히 분산된 네트워킹 및 보안 관측 가능성 플랫폼</strong>입니다.
서비스의 통신 및 동작뿐만 아니라 네트워킹 인프라에 대한 깊은 가시성을 투명하게 제공합니다.</li>
  <li>
<strong>Hubble</strong>은 오버헤드를 최소화 하는 동적 접근 방식을 제공하며, 다중 클러스터(ClusterMesh) 환경에서도 노드 수준, 컨트롤러 수준 또는
클러스터 간 가시성을 제공할 수 있습니다.</li>
  <li>
<strong>Hubble API</strong>는 Cilium 에이전트가 실행되는 개별 노드에서 작동합니다. Hubble CLI는 로컬 유닉스 도메인 소켓을 통해 제공되는 Hubble API를 쿼리할 수 있습니다.</li>
  <li>
<strong>Hubble Relay</strong>를 배포하면 클러스터 메시 시나리오에서 전체 클러스터 또는 여러 클러스터에 대한 가시성을 제공합니다. 이 모드에서는
Hubble CLI를 Hubble Relay에 연결하여 모든 노드에서 수집된 이벤트를 쿼리하거나, Hubble UI를 통해 Hubble 데이터에 접근할 수 있습니다.</li>
  <li>서비스 의존성 및 통신 그래프를 시각화 할 수 있습니다.</li>
  <li>네트워크 정책 모니터링 및 알림을 제공하여 네트워크 통신 실패 등을 모니터링 하고 원인을 파악하는데 도움을 줍니다.</li>
  <li>애플리케이션 성능 모니터링을 통해 서비스 간의 지연 시간, 오류율 등을 측정하고 분석할 수 있습니다.</li>
  <li>보안 정책 모니터링을 통해 네트워크 정책 위반, 의심스러운 트래픽 등을 감지하고 대응할 수 있습니다.</li>
</ul>

<h3 id="hubble-observability-설치">Hubble Observability 설치</h3>

<ul>
  <li>관련 문서 : <a href="https://docs.cilium.io/en/stable/observability/hubble/setup/">docs</a>
</li>
  <li>설치 전 확인</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>cilium status
<span class="c"># =&gt; ...</span>
<span class="c">#     \__/¯¯\__/    Hubble Relay:       disabled</span>
<span class="c">#    ...</span>
<span class="c">#    Containers:            cilium                   Running: 3</span>
<span class="c">#                           cilium-envoy             Running: 3</span>
<span class="c">#                           cilium-operator          Running: 1</span>
<span class="c">#                           clustermesh-apiserver</span>
<span class="c">#                           hubble-relay</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> hubble
<span class="c"># =&gt; enable-hubble                                     false</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 현재 Hubble이 설치되어 있지 않습니다.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq
<span class="c"># =&gt; ...</span>
<span class="c">#        "enable-hubble": "false",</span>
<span class="c">#</span>
<span class="nv">$ </span>kubectl get secret <span class="nt">-n</span> kube-system | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'cilium-ca|hubble'</span>
<span class="c"># =&gt; (공백) </span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'cilium|hubble'</span> | <span class="nb">tee </span>before.txt
<span class="c"># =&gt; LISTEN 0      4096        127.0.0.1:37303      0.0.0.0:*    users:(("cilium-agent",pid=2853,fd=42))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:*    users:(("cilium-operator",pid=2153,fd=9))</span>
<span class="c">#    LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=25))</span>
<span class="c">#    LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=24))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:*    users:(("cilium-agent",pid=2853,fd=6))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:*    users:(("cilium-operator",pid=2153,fd=6))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=27))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=26))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:*    users:(("cilium-agent",pid=2853,fd=51))</span>
<span class="c">#    LISTEN 0      4096                *:9963             *:*    users:(("cilium-operator",pid=2153,fd=7))</span>
</code></pre></div></div>

<ul>
  <li>Hubble 설치</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 설치방안 1 : hubble 활성화, 메트릭 설정 등등</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>31234 <span class="se">\</span>
  <span class="nt">--set</span> hubble.export.static.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.export.static.filePath<span class="o">=</span>/var/run/cilium/hubble/events.log <span class="se">\</span>
  <span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    NAME: cilium</span>
<span class="c">#    LAST DEPLOYED: Thu Jul 24 23:16:48 2025</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 2</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    You have successfully installed Cilium with Hubble Relay and Hubble UI.</span>
<span class="c">#    </span>
<span class="c">#    Your release version is 1.17.6.  </span>

<span class="c"># 설치방안 2 : hubble 활성화</span>
<span class="nv">$ </span>cilium hubble <span class="nb">enable</span>
<span class="nv">$ </span>cilium hubble <span class="nb">enable</span> <span class="nt">--ui</span>

<span class="c"># cilium status를 통한 hubble 설치 상태 확인</span>
<span class="nv">$ </span>cilium status
<span class="c"># =&gt; ...</span>
<span class="c">#     \__/¯¯\__/    Hubble Relay:       OK</span>
<span class="c">#    ...</span>
<span class="c">#    Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Deployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1</span>
<span class="c">#    Containers:            hubble-relay             Running: 1</span>
<span class="c">#                           hubble-ui                Running: 1</span>

<span class="c"># hubble 관련 설정 정보 확인</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> hubble
<span class="c"># =&gt; enable-hubble                                     true</span>
<span class="c">#    enable-hubble-open-metrics                        true</span>
<span class="c">#    hubble-disable-tls                                false</span>
<span class="c">#    hubble-export-allowlist</span>
<span class="c">#    hubble-export-denylist</span>
<span class="c">#    hubble-export-fieldmask</span>
<span class="c">#    hubble-export-file-max-backups                    5</span>
<span class="c">#    hubble-export-file-max-size-mb                    10</span>
<span class="c">#    hubble-export-file-path                           /var/run/cilium/hubble/events.log</span>
<span class="c">#    hubble-listen-address                             :4244</span>
<span class="c">#    hubble-metrics                                    dns drop tcp flow port-distribution icmp httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction</span>
<span class="c">#    hubble-metrics-server                             :9965</span>
<span class="c">#    hubble-metrics-server-enable-tls                  false</span>
<span class="c">#    hubble-socket-path                                /var/run/cilium/hubble.sock</span>
<span class="c">#    hubble-tls-cert-file                              /var/lib/cilium/tls/hubble/server.crt</span>
<span class="c">#    hubble-tls-client-ca-files                        /var/lib/cilium/tls/hubble/client-ca.crt</span>
<span class="c">#    hubble-tls-key-file                               /var/lib/cilium/tls/hubble/server.key</span>

<span class="c"># config map에서 hubble 관련 설정 정보 확인</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | <span class="nb">grep</span> <span class="nt">-i</span> hubble
<span class="c"># =&gt;         "enable-hubble": "true",</span>
<span class="c">#            "enable-hubble-open-metrics": "true",</span>
<span class="c">#            "hubble-disable-tls": "false",</span>
<span class="c">#            "hubble-export-allowlist": "",</span>
<span class="c">#    ...</span>

<span class="c"># hubble 관련 secret 정보 확인</span>
<span class="nv">$ </span>kubectl get secret <span class="nt">-n</span> kube-system | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'cilium-ca|hubble'</span>
<span class="c"># =&gt; cilium-ca                      Opaque                          2      4m57s</span>
<span class="c">#    hubble-relay-client-certs      kubernetes.io/tls               3      4m57s</span>
<span class="c">#    hubble-server-certs            kubernetes.io/tls               3      4m57s</span>

<span class="c"># TCP 포트 4244를 모든 cilium을 실행하는 노드에서 열어야 할 필요가 있음</span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'cilium|hubble'</span> | <span class="nb">tee </span>after.txt
<span class="c"># =&gt; LISTEN 0      4096        127.0.0.1:37303      0.0.0.0:*    users:(("cilium-agent",pid=4891,fd=52))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:*    users:(("cilium-operator",pid=2153,fd=9))</span>
<span class="c">#    LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=25))</span>
<span class="c">#    LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=24))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:*    users:(("cilium-agent",pid=4891,fd=6))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:*    users:(("cilium-operator",pid=2153,fd=6))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=27))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=2224,fd=26))</span>
<span class="c">#    LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:*    users:(("cilium-agent",pid=4891,fd=62))</span>
<span class="c">#    LISTEN 0      4096                *:4244             *:*    users:(("cilium-agent",pid=4891,fd=55))</span>
<span class="c">#    LISTEN 0      4096                *:9965             *:*    users:(("cilium-agent",pid=4891,fd=34))</span>
<span class="c">#    LISTEN 0      4096                *:9962             *:*    users:(("cilium-agent",pid=4891,fd=7))</span>
<span class="c">#    LISTEN 0      4096                *:9963             *:*    users:(("cilium-operator",pid=2153,fd=7))</span>

<span class="c"># Hubble 실행 전과 후의 리스닝 포트 변경확인</span>
<span class="nv">$ </span>vi <span class="nt">-d</span> before.txt after.txt
<span class="c"># =&gt;   LISTEN 0      4096        127.0.0.1:37303      0.0.0.0:|  LISTEN 0      4096        127.0.0.1:37303      0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:|  LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:|  LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:</span>
<span class="c">#      LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:|  LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:</span>
<span class="c">#      -------------------------------------------------------|  &lt;span style="background-color: green; color: #fff;"&gt;LISTEN 0      4096                *:4244             *:&lt;/span&gt;</span>
<span class="c">#      -------------------------------------------------------|  &lt;span style="background-color: green; color: #fff;"&gt;LISTEN 0      4096                *:9965             *:&lt;/span&gt;</span>
<span class="c">#      -------------------------------------------------------|  &lt;span style="background-color: green; color: #fff;"&gt;LISTEN 0      4096                *:9962             *:&lt;/span&gt;</span>
<span class="c">#      LISTEN 0      4096                *:9963             *:|  LISTEN 0      4096                *:9963             *:</span>

<span class="c"># 각 노드의 4244 포트 오픈 확인</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>ss <span class="nt">-tnlp</span> |grep 4244 <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    LISTEN 0      4096               *:4244             *:*    users:(("cilium-agent",pid=3528,fd=50))</span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    LISTEN 0      4096               *:4244             *:*    users:(("cilium-agent",pid=3268,fd=46))</span>

<span class="c"># Hubble Relay Pod 확인</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>hubble-relay
<span class="c"># =&gt; NAME                           READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    hubble-relay-5dcd46f5c-n4zfx   1/1     Running   0          12m</span>

<span class="nv">$ </span>kc describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>hubble-relay
<span class="c"># =&gt; Name:             hubble-relay-5dcd46f5c-n4zfx</span>
<span class="c">#    Namespace:        kube-system</span>
<span class="c">#    Service Account:  hubble-relay</span>
<span class="c">#    Labels:           app.kubernetes.io/name=hubble-relay</span>
<span class="c">#                      app.kubernetes.io/part-of=cilium</span>
<span class="c">#                      k8s-app=hubble-relay</span>
<span class="c">#    ...</span>
<span class="c">#        Image:         quay.io/cilium/hubble-relay:v1.17.6@sha256:7d17ec10b3d37341c18ca56165b2f29a715cb8ee81311fd07088d8bf68c01e60</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kc get svc,ep <span class="nt">-n</span> kube-system hubble-relay
<span class="c"># =&gt; NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/hubble-relay   ClusterIP   10.96.207.219   &lt;none&gt;        80/TCP    14m</span>
<span class="c">#    </span>
<span class="c">#    NAME                     ENDPOINTS           AGE</span>
<span class="c">#    endpoints/hubble-relay   172.20.2.214:4245   14m</span>

<span class="c"># hubble-relay 는 hubble-peer 의 서비스(ClusterIP :443)을 통해 모든 노드의 :4244에 요청 가져올 수 있음</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME                                                   DATA   AGE</span>
<span class="c">#    cilium-config                                          158    23h</span>
<span class="c">#    cilium-envoy-config                                    1      23h</span>
<span class="c">#    ...</span>
<span class="c">#    hubble-relay-config                                    1      17m</span>
<span class="c">#    hubble-ui-nginx                                        1      17m</span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system hubble-relay-config
<span class="c"># =&gt; ...</span>
<span class="c">#    cluster-name: default</span>
<span class="c">#    peer-service: "hubble-peer.kube-system.svc.cluster.local.:443"</span>
<span class="c">#    listen-address: :4245</span>
<span class="c">#    ...</span>

<span class="c"># Hubble Peer Pod 확인</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> kube-system hubble-peer
<span class="c"># =&gt; NAME                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/hubble-peer   ClusterIP   10.96.12.202   &lt;none&gt;        443/TCP   21m</span>
<span class="c">#    </span>
<span class="c">#    NAME                    ENDPOINTS                                                     AGE</span>
<span class="c">#    endpoints/hubble-peer   192.168.10.100:4244,192.168.10.101:4244,192.168.10.102:4244   21m</span>

<span class="c">#</span>
<span class="nv">$ </span>kc describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>hubble-ui
<span class="c"># =&gt; ...</span>
<span class="c">#      frontend:</span>
<span class="c">#        Port:           8081/TCP</span>
<span class="c">#        ...</span>
<span class="c">#      backend:</span>
<span class="c">#        Port:           8090/TCP</span>
<span class="c">#        ...</span>

<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> kube-system hubble-ui-nginx
<span class="c"># =&gt; ...</span>
<span class="c">#    nginx.conf:</span>
<span class="c">#    ----</span>
<span class="c">#    server {</span>
<span class="c">#        listen       8081;</span>
<span class="c">#        listen       [::]:8081;</span>
<span class="c">#        server_name  localhost;</span>
<span class="c">#        root /app;</span>
<span class="c">#        index index.html;</span>
<span class="c">#        client_max_body_size 1G;</span>
<span class="c">#    </span>
<span class="c">#        location / {</span>
<span class="c">#            proxy_set_header Host $host;</span>
<span class="c">#            proxy_set_header X-Real-IP $remote_addr;</span>
<span class="c">#    </span>
<span class="c">#            location /api {</span>
<span class="c">#                proxy_http_version 1.1;</span>
<span class="c">#                proxy_pass_request_headers on;</span>
<span class="c">#                proxy_pass http://127.0.0.1:8090;</span>
<span class="c">#            }</span>
<span class="c">#            location / {</span>
<span class="c">#                # double `/index.html` is required here</span>
<span class="c">#                try_files $uri $uri/ /index.html /index.html;</span>
<span class="c">#            }</span>
<span class="c">#    </span>
<span class="c">#            # Liveness probe</span>
<span class="c">#            location /healthz {</span>
<span class="c">#                access_log off;</span>
<span class="c">#                add_header Content-Type text/plain;</span>
<span class="c">#                return 200 'ok';</span>
<span class="c">#            }</span>
<span class="c">#        }</span>
<span class="c">#    }</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> kube-system hubble-ui
<span class="c"># =&gt; NAME                TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/hubble-ui   NodePort   10.96.183.249   &lt;none&gt;        80:31234/TCP   26m</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS           AGE</span>
<span class="c">#    endpoints/hubble-ui   172.20.1.189:8081   26m</span>

<span class="c"># hubble ui 웹 접속 주소 확인</span>
<span class="nv">$ NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"http://</span><span class="nv">$NODEIP</span><span class="s2">:31234"</span>
<span class="c"># =&gt; http://192.168.10.100:31234</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Hubble ui 접속 테스트 -&gt; 접속 후 kube-system 네임스페이스 선택
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_3.png" alt="img.png" class="image-center" loading="lazy" width="1197" height="858"></p>
  </li>
  <li>
    <p>Hubble Client 설치 - <a href="https://docs.cilium.io/en/stable/observability/hubble/setup/#install-the-hubble-client">docs</a></p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ HUBBLE_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="si">)</span>
<span class="nv">$ HUBBLE_ARCH</span><span class="o">=</span>amd64
<span class="nv">$ </span><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">HUBBLE_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi</span>
<span class="nv">$ </span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/hubble/releases/download/<span class="nv">$HUBBLE_VERSION</span>/hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
<span class="nv">$ </span><span class="nb">sudo tar </span>xzvfC hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="c"># =&gt; hubble</span>
<span class="nv">$ </span>which hubble
<span class="c"># =&gt; /usr/local/bin/hubble</span>
<span class="nv">$ </span>hubble status
<span class="c"># =&gt; failed getting status: rpc error: code = Unavailable desc = connection error: desc = "transport: Error while dialing: dial tcp 127.0.0.1:4245: connect: connection refused"</span>
</code></pre></div></div>

<ul>
  <li>Hubble client를 설치했지만 기본적으로 localhost를 통해 연결을 시도하기 때문에 연결이 되지 않습니다.
포트포워딩을 통해 hubble relay를 통해 연결할 수 있도록 설정합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt;   Hubble Relay is available at 127.0.0.1:4245</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 4245 포트가 localhost로 포워딩 되었습니다.&lt;/span&gt;</span>

<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep </span>4245
<span class="c"># =&gt; LISTEN 0      4096        127.0.0.1:4245       0.0.0.0:*    users:(("cilium",pid=3402,fd=7))</span>

<span class="c"># Now you can validate that you can access the Hubble API via the installed CLI</span>
<span class="nv">$ </span>hubble status
<span class="c"># =&gt; Healthcheck (via localhost:4245): Ok</span>
<span class="c">#    Current/Max Flows: 12,285/12,285 (100.00%)</span>
<span class="c">#    Flows/s: 31.55</span>
<span class="c">#    Connected Nodes: 3/3</span>

<span class="c"># hubble (api) server 기본 접속 주소 확인</span>
<span class="nv">$ </span>hubble config view 
<span class="c"># =&gt; ...</span>
<span class="c">#    port-forward-port: "4245"</span>
<span class="c">#    server: localhost:4245</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h3 id="star-wars-demo를-통한-hubbleui-체험">Star Wars Demo를 통한 Hubble/UI 체험</h3>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_4.png" alt="img.png" class="image-center w-80" loading="lazy" width="1294" height="920">
<em class="image-caption">목표 배포상태</em></p>

<ul>
  <li>스타워즈에서 영감을 받은 예제이며, deathstar, xwing, tiefighter의 세가지 마이크로 서비스로 구성되어 있습니다.</li>
  <li>deathstar는 80포트에서 http 웹서비스를 실행하며, 두 개의 pod 복제본에 걸쳐 로드 밸런싱을 수행합니다.</li>
  <li>deathstar 서비스는 empire의 우주선에 착륙 서비스를 제공하여 착륙 포트 요청을 할 수 있도록 합니다.</li>
  <li>tiefighter는 일반적인 제국 우주선의 착륙 요청 클라이언트 서비스를 나타내며 xwing은 연합 우주선의 착륙 요청 클라이언트 서비스를 나타냅니다.</li>
  <li>deathstar 착륙 서비스에 대한 접근 제어를 위한 다양한 보안 정책을 테스트하기 위하여 구성되었습니다.</li>
</ul>

<h4 id="데모-애플리케이션-배포">데모 애플리케이션 배포</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/http-sw-app.yaml
<span class="c"># =&gt; service/deathstar created</span>
<span class="c">#    deployment.apps/deathstar created</span>
<span class="c">#    pod/tiefighter created</span>
<span class="c">#    pod/xwing created</span>

<span class="c"># 파드 라벨 labels 확인</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">--show-labels</span>
<span class="c"># =&gt; NAME                        READY   STATUS    RESTARTS   AGE   LABELS</span>
<span class="c">#    deathstar-8c4c77fb7-5zqmp   1/1     Running   0          12h   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=8c4c77fb7</span>
<span class="c">#    deathstar-8c4c77fb7-h2rsh   1/1     Running   0          12h   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=8c4c77fb7</span>
<span class="c">#    tiefighter                  1/1     Running   0          12h   app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire</span>
<span class="c">#    xwing                       1/1     Running   0          12h   app.kubernetes.io/name=xwing,class=xwing,org=alliance</span>

<span class="nv">$ </span>kubectl get deploy,svc,ep deathstar
<span class="c"># =&gt; NAME                        READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/deathstar   2/2     2            2           12h</span>
<span class="c">#    </span>
<span class="c">#    NAME                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/deathstar   ClusterIP   10.96.153.126   &lt;none&gt;        80/TCP    12h</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS                        AGE</span>
<span class="c">#    endpoints/deathstar   172.20.1.67:80,172.20.2.251:80   12h</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get ciliumendpoints.cilium.io <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE     NAME                           SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    default       deathstar-8c4c77fb7-5zqmp      46219               ready            172.20.2.251</span>
<span class="c">#    default       deathstar-8c4c77fb7-h2rsh      46219               ready            172.20.1.67</span>
<span class="c">#    default       tiefighter                     50993               ready            172.20.2.254</span>
<span class="c">#    default       xwing                          14847               ready            172.20.2.111</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-7m82r       30923               ready            172.20.0.134</span>
<span class="c">#    kube-system   coredns-674b8bbfcf-dnc5n       30923               ready            172.20.1.13</span>
<span class="c">#    kube-system   hubble-relay-5dcd46f5c-n4zfx   5844                ready            172.20.2.144</span>
<span class="c">#    kube-system   hubble-ui-76d4965bb6-7mcft     14841               ready            172.20.1.30</span>
<span class="nv">$ </span>kubectl get ciliumidentities.cilium.io
<span class="c"># =&gt; NAME    NAMESPACE     AGE</span>
<span class="c">#    10901   default       12h</span>
<span class="c">#    14841   kube-system   37h</span>
<span class="c">#    14847   default       12h</span>
<span class="c">#    30923   kube-system   2d13h</span>
<span class="c">#    46219   default       12h</span>
<span class="c">#    50993   default       12h</span>
<span class="c">#    5844    kube-system   37h</span>

<span class="c"># in a multi-node installation, only the ones running on the same node will be listed</span>
<span class="c"># cilium 엔드포인트 목록 확인. 명령을 실행한 노드의 엔드포인트만 확인 가능합니다.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    1332       Disabled           Disabled          1          k8s:node-role.kubernetes.io/control-plane                                                          ready</span>
<span class="c">#                                                               k8s:node.kubernetes.io/exclude-from-external-load-balancers</span>
<span class="c">#                                                               reserved:host</span>
<span class="c">#    1814       Disabled           Disabled          30923      k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.20.0.134   ready</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=coredns</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#                                                               k8s:k8s-app=kube-dns</span>
<span class="nv">$ </span>c0 endpoint list
<span class="c"># =&gt; ...</span>
<span class="c">#    1814 Disabled Disabled 30923 k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system 172.20.0.134   ready</span>
<span class="nv">$ </span>c1 endpoint list
<span class="c"># =&gt; ...</span>
<span class="c">#    507  Disabled Disabled 46219 k8s:app.kubernetes.io/name=deathstar                                       172.20.1.67   ready</span>
<span class="c">#    ...</span>
<span class="c">#    966  Disabled Disabled 30923 k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system 172.20.1.13   ready</span>
<span class="c">#    ...</span>
<span class="c">#    1864 Disabled Disabled 14841 k8s:app.kubernetes.io/name=hubble-ui                                       172.20.1.30   ready</span>
<span class="nv">$ </span>c2 endpoint list
<span class="c"># =&gt; ENDPOINT POLICY (ingress) POLICY (egress) IDENTITY LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#             ENFORCEMENT      ENFORCEMENT</span>
<span class="c">#    309      &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;         &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;        14847    k8s:app.kubernetes.io/name=xwing                                                    172.20.2.111   ready</span>
<span class="c">#    721      &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;         &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;        50993    k8s:app.kubernetes.io/name=tiefighter                                               172.20.2.254   ready</span>
<span class="c">#    1282     &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;         &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;        1        reserved:host                                                                                      ready</span>
<span class="c">#    1391     &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;         &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;        46219    k8s:app.kubernetes.io/name=deathstar                                                172.20.2.251   ready</span>
<span class="c">#                                                       &lt;span style="color: green;"&gt;k8s:class=deathstar&lt;/span&gt;</span>
<span class="c">#                                                       k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default</span>
<span class="c">#                                                       k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                       k8s:io.cilium.k8s.policy.serviceaccount=default</span>
<span class="c">#                                                       k8s:io.kubernetes.pod.namespace=default</span>
<span class="c">#                                                       &lt;span style="color: green;"&gt;k8s:org=empire&lt;/span&gt;</span>
<span class="c">#    3027     &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;         &lt;span style="color: green;"&gt;Disabled&lt;/span&gt;        5844     k8s:app.kubernetes.io/name=hubble-relay                                             172.20.2.144   ready</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 현재 ingress/egress 에 정책(Policy) 없음을 확인 할 수 있습니다. 또한 label을 통해 다양한 정보를 확인할 수 있습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h4 id="현재-접근상태-확인">현재 접근상태 확인</h4>

<ul>
  <li>deathstar 서비스의 관점에서는 org=empire 라벨이 있는 우주선만 착륙을 요청할 수 있습니다.</li>
  <li>아직까지는 ingress/egress 정책이 없기 때문에 제국 우주선 뿐만 아니라 연합의 우주선 착륙 요청도 허용됩니다.</li>
  <li>아래의 명령을 통해 확인해보겠습니다</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 아래 출력에서 xwing 와 tiefighter 의 IDENTITY 값을 확인합니다.</span>
<span class="nv">$ </span>c1 endpoint list | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'xwing|tiefighter|deathstar'</span>
<span class="c"># =&gt; 507        Disabled           Disabled          &lt;span style="color: green;"&gt;46219&lt;/span&gt;      k8s:app.kubernetes.io/name=deathstar                                                172.20.1.67   ready</span>
<span class="nv">$ </span>c2 endpoint list | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'xwing|tiefighter|deathstar'</span>
<span class="c"># =&gt; 309        Disabled           Disabled          &lt;span style="color: green;"&gt;14847&lt;/span&gt;      k8s:app.kubernetes.io/name=xwing                                                    172.20.2.111   ready</span>
<span class="c">#    721        Disabled           Disabled          &lt;span style="color: green;"&gt;50993&lt;/span&gt;      k8s:app.kubernetes.io/name=tiefighter                                               172.20.2.254   ready</span>
<span class="c">#    1391       Disabled           Disabled          &lt;span style="color: green;"&gt;46219&lt;/span&gt;      k8s:app.kubernetes.io/name=deathstar                                                172.20.2.251   ready</span>
<span class="nv">$ XWINGID</span><span class="o">=</span>14847
<span class="nv">$ TIEFIGHTERID</span><span class="o">=</span>50993
<span class="nv">$ DEATHSTARID</span><span class="o">=</span>46219

<span class="c"># 모니터링 준비 : 터미널 3개, 단축키 설정</span>
<span class="c">## 각각 monitor 확인</span>
<span class="nv">$ </span>c0 monitor <span class="nt">-v</span> <span class="nt">-v</span>
<span class="nv">$ </span>c1 monitor <span class="nt">-v</span> <span class="nt">-v</span>
<span class="nv">$ </span>c2 monitor <span class="nt">-v</span> <span class="nt">-v</span>

<span class="c"># 모니터링 준비 : 터미널 1개</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span>

<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--from-identity</span> <span class="nv">$XWINGID</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> udp <span class="nt">--from-identity</span> <span class="nv">$XWINGID</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$XWINGID</span>

<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$DEATHSTARID</span>

<span class="c"># 호출 시도 1</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing <span class="p">;</span> <span class="nb">sleep </span>5 <span class="p">;</span> <span class="k">done</span>

<span class="c"># 호출 시도 2</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing <span class="p">;</span> <span class="nb">sleep </span>5 <span class="p">;</span> <span class="k">done</span>

<span class="c">## 모니터링</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$TIEFIGHTERID</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$DEATHSTARID</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_5.png" alt="img.png" class="image-center" loading="lazy" width="1068" height="642">
<em class="image-caption">Hubble UI에서 모니터링</em></p>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_6.png" alt="img.png" class="image-center" loading="lazy" width="2279" height="1083">
<em class="image-caption">hubble observe에서 모니터링</em></p>

<ul>
  <li>제국군 우주선 tiefighter 뿐만아니라 연합군 우주선 xwing의 착륙 요청도 허용되고 있는것을 확인할 수 있습니다.</li>
</ul>

<h4 id="l3l4-정책-적용">L3/L4 정책 적용</h4>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-an-l3-l4-policy">관련문서</a></li>
  <li>L3/L4 정책을 적용하여 제국 우주선만 착륙 요청을 허용하도록 합니다.</li>
</ul>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_7.png" alt="img.png" class="image-center" loading="lazy" width="1308" height="926">
<em class="image-caption">L3/L4 정책 적용 후 목표 상태</em></p>

<ul>
  <li>Cilium의 보안정책은 <strong>Endpoint의 IP주소는 중요하지 않고</strong>, Pod의 <strong>label을 사용하여 보안 정책을 정의</strong>할 수 있습니다.</li>
  <li>아래의 정책을 적용하여 제국 우주선만 착륙 요청을 허용하도록 합니다. 이렇게하면 org=empire 라벨이 있는 Pod만 착륙 요청을 허용하게 되고,
해당 라벨이 없는 파드는 deathstar 서비스에 연결조차 할 수 없습니다. 이 정책은 IP 프로토콜(네트워크 계층 3)와 TCP 프로토콜(전송 계층 4)에만 적용하는
L3/L4 네트워크 보안 정책이라고 합니다.</li>
  <li>참고 : Cilium은 <strong>상태별 연결 추적</strong>을 수행합니다. 
즉, 프론트엔드가 백엔드에 도달할 수 있으면, 동일한 TCP/UDP 연결내의 응답은 자동으로 허용된다는것을 의미합니다.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CiliumNetworkPolicy</span>
<span class="c1">## CiliumNetworkPolicys는 "endpointSelector"를 사용하여 팟 레이블에서 정책이 적용되는 소스와 목적지를 식별합니다. </span>
<span class="c1">## 아래 정책은 TCP 포트 80에서 레이블(org=empire)이 있는 모든 팟에서 레이블(org=empire, class=deathstar)이 있는 데스스타 팟으로 전송되는 트래픽을 화이트리스트로 작성합니다.</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cilium.io/v2"</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CiliumNetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rule1"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">L3-L4</span><span class="nv"> </span><span class="s">policy</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">restrict</span><span class="nv"> </span><span class="s">deathstar</span><span class="nv"> </span><span class="s">access</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">empire</span><span class="nv"> </span><span class="s">ships</span><span class="nv"> </span><span class="s">only"</span>
  <span class="na">endpointSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">org</span><span class="pi">:</span> <span class="s">empire</span>
      <span class="na">class</span><span class="pi">:</span> <span class="s">deathstar</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">fromEndpoints</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">matchLabels</span><span class="pi">:</span>
        <span class="na">org</span><span class="pi">:</span> <span class="s">empire</span>
    <span class="na">toPorts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">80"</span>
        <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/sw_l3_l4_policy.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/rule1 created</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME    AGE   VALID</span>
<span class="c">#    rule1   8s    True</span>
<span class="nv">$ </span>kubectl get cnp <span class="nt">-o</span> json | jq
<span class="c"># =&gt; ...</span>
<span class="c">#          "spec": {</span>
<span class="c">#            "description": "L3-L4 policy to restrict deathstar access to empire ships only",</span>
<span class="c">#            "endpointSelector": {</span>
<span class="c">#              "matchLabels": {</span>
<span class="c">#                "class": "deathstar",</span>
<span class="c">#                "org": "empire"</span>
<span class="c">#              }</span>
<span class="c">#            },</span>
<span class="c">#            "ingress": [ { </span>
<span class="c">#                 "fromEndpoints": [ { "matchLabels": { "org": "empire" } } ],</span>
<span class="c">#                 "toPorts": [ { "ports": [ { "port": "80", "protocol": "TCP" } ] } ]</span>
<span class="c">#            } ]</span>
<span class="c">#          },</span>
<span class="c">#    ...</span>

<span class="c"># 모니터링</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--type</span> drop

<span class="c"># 호출 시도 1 </span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing <span class="nt">--connect-timeout</span> 2
<span class="c"># =&gt; command terminated with exit code 28</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 연합군의 우주선 xwing의 착륙 요청은 거부되었습니다!&lt;/span&gt;</span>

<span class="c"># &lt;span style="color: green;"&gt;👉 DROP 된 패킷 모니터링&lt;/span&gt;</span>
<span class="c"># =&gt; (⎈|HomeLab:N/A) root@k8s-ctr:~# hubble observe -f --type drop</span>
<span class="c">#    Jul 26 07:50:53.384: default/xwing:46590 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) Policy denied DROPPED (TCP Flags: SYN)</span>
<span class="c">#    Jul 26 07:50:54.407: default/xwing:46590 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) Policy denied DROPPED (TCP Flags: SYN)</span>

<span class="c"># 모니터링 </span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$DEATHSTARID</span>

<span class="c"># 호출 시도 2</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 제국군의 우주선 tiefighter의 착륙 요청은 허용되었습니다!&lt;/span&gt;</span>

<span class="c"># &lt;span style="color: green;"&gt;👉 허용된 패킷 모니터링&lt;/span&gt;</span>
<span class="c"># =&gt; (⎈|HomeLab:N/A) root@k8s-ctr:~# hubble observe -f --protocol tcp --from-identity $DEATHSTARID</span>
<span class="c">#    Jul 26 07:52:52.016: default/tiefighter:43410 (ID:50993) &lt;- default/deathstar-8c4c77fb7-5zqmp:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Jul 26 07:52:52.016: default/deathstar-8c4c77fb7-5zqmp:80 (ID:46219) &lt;&gt; default/tiefighter (ID:50993) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Jul 26 07:52:52.016: default/deathstar-8c4c77fb7-5zqmp:80 (ID:46219) &lt;&gt; default/tiefighter (ID:50993) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Jul 26 07:52:52.019: default/tiefighter:43410 (ID:50993) &lt;- default/deathstar-8c4c77fb7-5zqmp:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Jul 26 07:52:52.021: default/tiefighter:43410 (ID:50993) &lt;- default/deathstar-8c4c77fb7-5zqmp:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_8.png" alt="img.png" loading="lazy" width="1197" height="858"></p>

<ul>
  <li>정책을 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># deathstar 에 ingress 에 policy 활성화 확인</span>
<span class="nv">$ </span>c0 endpoint list
<span class="nv">$ </span>c1 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4          STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    ...</span>
<span class="c">#    507        &lt;span style="color: green;"&gt;Enabled&lt;/span&gt;            Disabled          46219      k8s:app.kubernetes.io/name=deathstar                                                172.20.1.67   ready</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c2 endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    ...</span>
<span class="c">#    1391       &lt;span style="color: green;"&gt;Enabled&lt;/span&gt;            Disabled          46219      k8s:app.kubernetes.io/name=deathstar                                                172.20.2.251   ready</span>
<span class="c">#    ...</span>
                                                           
<span class="nv">$ </span>kc describe cnp rule1
<span class="c"># =&gt; ...</span>
<span class="c">#    Spec:</span>
<span class="c">#      Description:  L3-L4 policy to restrict deathstar access to empire ships only</span>
<span class="c">#      Endpoint Selector:</span>
<span class="c">#        Match Labels:</span>
<span class="c">#          Class:  deathstar</span>
<span class="c">#          Org:    empire</span>
<span class="c">#      Ingress:</span>
<span class="c">#        From Endpoints:</span>
<span class="c">#          Match Labels:</span>
<span class="c">#            Org:  empire</span>
<span class="c">#        To Ports:</span>
<span class="c">#          Ports:</span>
<span class="c">#            Port:      80</span>
<span class="c">#            Protocol:  TCP</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>Life of a Packet : L7 동작 처리는 cilium-envoy 데몬셋이 담당합니다. <a href="https://docs.cilium.io/en/stable/network/ebpf/lifeofapacket/">Docs</a>
</li>
</ul>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_9.png" alt="img.png" loading="lazy" width="1626" height="783"></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get ds <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span>
<span class="c">#    cilium         3         3         3       3            3           kubernetes.io/os=linux   2d17h</span>
<span class="c">#    cilium-envoy   3         3         3       3            3           kubernetes.io/os=linux   2d17h</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium-envoy <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 READY   STATUS    RESTARTS        AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    cilium-envoy-q97fq   1/1     Running   3 (3h59m ago)   2d16h   192.168.10.102   k8s-w2    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    cilium-envoy-xzxd6   1/1     Running   3 (3h59m ago)   2d16h   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    cilium-envoy-zzzw5   1/1     Running   3 (3h59m ago)   2d17h   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kc describe ds <span class="nt">-n</span> kube-system cilium-envoy
<span class="c"># =&gt;     Mounts:</span>
<span class="c">#          /sys/fs/bpf from bpf-maps (rw)</span>
<span class="c">#          /var/run/cilium/envoy/ from envoy-config (ro)</span>
<span class="c">#          /var/run/cilium/envoy/artifacts from envoy-artifacts (ro)</span>
<span class="c">#          &lt;span style="color: green;"&gt;/var/run/cilium/envoy/sockets from envoy-sockets (rw)&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c">#       envoy-config:</span>
<span class="c">#        Type:      ConfigMap (a volume populated by a ConfigMap)</span>
<span class="c">#        Name:      &lt;span style="color: green;"&gt;cilium-envoy-config&lt;/span&gt;</span>
<span class="c">#        Optional:  false</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> ss <span class="nt">-xnp</span> | <span class="nb">grep</span> <span class="nt">-i</span> <span class="nt">-envoy</span>
<span class="c"># =&gt; u_str  ESTAB  0  0  /var/run/cilium/envoy/sockets/admin.sock  16193  *  16192</span>
<span class="c">#    u_str  ESTAB  0  0  /var/run/cilium/envoy/sockets/admin.sock  17068  *  17067</span>
<span class="c">#    u_str  ESTAB  0  0  /var/run/cilium/envoy/sockets/xds.sock    15993  *  15992  users:(("cilium-agent",pid=1,fd=106))</span>

<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> kube-system cilium-envoy-config
<span class="c"># =&gt; ...</span>
<span class="c">#    Data</span>
<span class="c">#    ====</span>
<span class="c">#    bootstrap-config.json:</span>
<span class="c">#    ----</span>
<span class="c">#    {"admin":{"address":{"pipe":{"path":"/var/run/cilium/envoy/sockets/admin.sock"}}}...</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h4 id="http-aware-l7-정책-적용-및-테스트">HTTP-aware L7 정책 적용 및 테스트</h4>

<ul>
  <li>HTTP-aware L7 정책을 적용하고 테스트해보겠습니다. <a href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-and-test-http-aware-l7-policy">Docs</a>
</li>
</ul>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_10.png" alt="img.png" class="image-center" loading="lazy" width="1354" height="968"></p>

<ul>
  <li>이전의 간단한 시나리오에서는 tiefighter와 xwing에게 deathstar API에 대한 전체 액세스 권한을 부여하거나, 접속 자체를 차단하는것으로 충분햇습니다.</li>
  <li>하지만 마이크로 서비스 간의 강력한 보안(즉, 최소 권한 격리를 강제하는 것)을 제공하기 위해서는 deathstar API를 호출하는 각 서비스가 운영에 필요한 HTTP 요청만 수행하도록 제한 할 수 있어야 합니다.</li>
  <li>예를 들어 deathstar 서비스가 임의의 제국 우주선이 호출해서는 안 되는 유지보수 API를 제공한다고 가정해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 모니터링 &gt;&gt; Layer3/4 에서는 애플리케이션 상태를 확인 할 수 없음!</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--from-identity</span> <span class="nv">$DEATHSTARID</span>
<span class="c"># =&gt; Jul 26 08:29:39.157: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-network FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Jul 26 08:29:39.161: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-network FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Jul 26 08:29:39.164: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Jul 26 08:29:39.201: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Jul 26 08:29:39.201: default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) &lt;&gt; default/tiefighter (ID:50993) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Jul 26 08:29:39.201: default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) &lt;&gt; default/tiefighter (ID:50993) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Jul 26 08:29:39.205: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Jul 26 08:29:39.207: default/tiefighter:48472 (ID:50993) &lt;- default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>

<span class="c"># 호출해서는 안 되는 일부 유지보수 API를 노출</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPUT</span> deathstar.default.svc.cluster.local/v1/exhaust-port
<span class="c"># =&gt; Panic: deathstar exploded</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 임의로 호출해서는 안되는 API가 실행되어 deathstar가 폭발했습니다!&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="cilium을-통한-l7-정책-적용">cilium을 통한 L7 정책 적용</h5>

<ul>
  <li>cilium은 HTTP 계층(L7) 정책을 적용하여 tiefighter가 사용할 수 있는 API URL을 제한할 수 있습니다. 다음은 tiefighter가 POST /v1/request-landing URL에만 액세스할 수 있도록 하는 정책입니다.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 기존 rule1 정책을 업데이트 해서 사용</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cilium.io/v2"</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CiliumNetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rule1"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">L7</span><span class="nv"> </span><span class="s">policy</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">restrict</span><span class="nv"> </span><span class="s">access</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">specific</span><span class="nv"> </span><span class="s">HTTP</span><span class="nv"> </span><span class="s">call"</span>
  <span class="na">endpointSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">org</span><span class="pi">:</span> <span class="s">empire</span>
      <span class="na">class</span><span class="pi">:</span> <span class="s">deathstar</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">fromEndpoints</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">matchLabels</span><span class="pi">:</span>
        <span class="na">org</span><span class="pi">:</span> <span class="s">empire</span>
    <span class="na">toPorts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">80"</span>
        <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">rules</span><span class="pi">:</span>
        <span class="na">http</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">method</span><span class="pi">:</span> <span class="s2">"</span><span class="s">POST"</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/v1/request-landing"</span>
</code></pre></div></div>

<ul>
  <li>tiefigher 에는 착륙 요청만 허용하는 L7 정책 적용후 deathstar 서비스에 착륙 요청을 해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Update the existing rule to apply L7-aware policy to protect deathstar using:</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/sw_l3_l4_l7_policy.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/rule1 configured</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME    AGE    VALID</span>
<span class="c">#    rule1   168m   True</span>
<span class="nv">$ </span>kc describe cnp
<span class="c"># =&gt; ...</span>
<span class="c">#    Spec:</span>
<span class="c">#      Description:  L7 policy to restrict access to specific HTTP call</span>
<span class="c">#      Endpoint Selector:</span>
<span class="c">#        Match Labels:</span>
<span class="c">#          Class:  deathstar</span>
<span class="c">#          Org:    empire</span>
<span class="c">#      Ingress:</span>
<span class="c">#        From Endpoints:</span>
<span class="c">#          Match Labels:</span>
<span class="c">#            Org:  empire</span>
<span class="c">#        To Ports:</span>
<span class="c">#          Ports:</span>
<span class="c">#            Port:      80</span>
<span class="c">#            Protocol:  TCP</span>
<span class="c">#          Rules:</span>
<span class="c">#            Http:</span>
<span class="c">#              Method:  POST</span>
<span class="c">#              Path:    /v1/request-landing</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>c0 policy get

<span class="c"># 파드 이름 지정하여 모니터링</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--pod</span> deathstar <span class="nt">--protocol</span> http
Jul 20 01:28:02.184: default/tiefighter:59020 <span class="o">(</span>ID:19274<span class="o">)</span> -&gt; default/deathstar-8c4c77fb7-9klws:80 <span class="o">(</span>ID:318<span class="o">)</span> http-request FORWARDED <span class="o">(</span>HTTP/1.1 POST http://deathstar.default.svc.cluster.local/v1/request-landing<span class="o">)</span>
Jul 20 01:28:02.190: default/tiefighter:59020 <span class="o">(</span>ID:19274<span class="o">)</span> &lt;- default/deathstar-8c4c77fb7-9klws:80 <span class="o">(</span>ID:318<span class="o">)</span> http-response FORWARDED <span class="o">(</span>HTTP/1.1 200 6ms <span class="o">(</span>POST http://deathstar.default.svc.cluster.local/v1/request-landing<span class="o">))</span>

<span class="c"># 착륙 요청을 테스트해보겠습니다.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 당연히 API 호출에 성공합니다.&lt;/span&gt;</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_11.png" alt="img.png" loading="lazy" width="1083" height="538"></p>

<ul>
  <li>이번에는 tiefighter가 허용되지 않은 API를 호출해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 파드 이름 지정하여 드랍된 패킷 모니터링</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--pod</span> deathstar <span class="nt">--verdict</span> DROPPED
<span class="c"># =&gt; Jul 26 10:48:17.734: default/tiefighter:40606 (ID:50993) -&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) http-request DROPPED (HTTP/1.1 PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port)</span>

<span class="c"># 혹은</span>
<span class="nv">$ </span>c1 monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
<span class="nv">$ </span>c2 monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
<span class="c"># =&gt; &lt;- Request http from 721 ([k8s:app.kubernetes.io/name=tiefighter k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]) to 1391 ([k8s:app.kubernetes.io/name=deathstar k8s:class=deathstar k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]), identity 50993-&gt;46219, verdict Denied PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port =&gt; 0</span>
<span class="c">#    &lt;- Response http to 721 ([k8s:app.kubernetes.io/name=tiefighter k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]) from 1391 ([k8s:app.kubernetes.io/name=deathstar k8s:class=deathstar k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire]), identity 46219-&gt;50993, verdict Forwarded PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port =&gt; 403</span>

<span class="c"># 앞서 deathstar를 폭파시켰던 tiefighter에게 허용되지 않은 API를 호출해보겠습니다.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>tiefighter <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPUT</span> deathstar.default.svc.cluster.local/v1/exhaust-port
<span class="c"># =&gt; Access denied</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_12.png" alt="img.png" class="image-center" loading="lazy" width="1063" height="115">
<em class="image-caption">L7 정책에 의해 허용되지 않은 API 호출이 거부된 모습</em></p>

<ul>
  <li>xwing으로 착륙요청을 해서 위와 차이점을 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 모니터링 : 파드 이름 지정</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--pod</span> xwing

<span class="c"># 호출 시도 : 위와 아래 실행 종료의 차이점을 이해해보자!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">-XPOST</span> deathstar.default.svc.cluster.local/v1/request-landing <span class="nt">--connect-timeout</span> 2
<span class="c"># =&gt; command terminated with exit code 28</span>

<span class="c"># (⎈|HomeLab:N/A) root@k8s-ctr:~# hubble observe -f --pod xwing</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Jul 26 10:50:31.048: default/xwing:57832 (ID:14847) -&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) to-network FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Jul 26 10:50:31.049: default/xwing:57832 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span>
<span class="c">#    Jul 26 10:50:31.049: default/xwing:57832 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) Policy denied DROPPED (TCP Flags: SYN)</span>
<span class="c">#    ...</span>
<span class="c">#    Jul 26 10:50:32.053: default/xwing:57832 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span>
<span class="c">#    Jul 26 10:50:32.053: default/xwing:57832 (ID:14847) &lt;&gt; default/deathstar-8c4c77fb7-h2rsh:80 (ID:46219) Policy denied DROPPED (TCP Flags: SYN)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 xwing의 deathstar로의 접근은 TCP (L4) 연결 자체가 차단(DROP)됨을 확인할 수 있습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_13.png" alt="img.png" class="image-center" loading="lazy" width="1042" height="144">
<em class="image-caption">xwing이 L7 정책 이전에 L4 정책에 의해 deathstar로의 접근이 차단된 모습</em></p>

<ul>
  <li>다음 실습을 위해 리소스를 삭제하겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 다음 실습을 위해 리소스 삭제</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/http-sw-app.yaml
<span class="c"># =&gt; service "deathstar" deleted</span>
<span class="c">#    deployment.apps "deathstar" deleted</span>
<span class="c">#    pod "tiefighter" deleted</span>
<span class="c">#    pod "xwing" deleted</span>
<span class="nv">$ </span>kubectl delete cnp rule1
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io "rule1" deleted</span>

<span class="c"># 삭제 확인</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; No resources found in default namespace.</span>
</code></pre></div></div>

<h4 id="configuring-hubble-exporter">Configuring Hubble Exporter</h4>

<ul>
  <li>흐름 로그 - <a href="https://docs.cilium.io/en/stable/observability/hubble/configuration/export/">Docs</a>
</li>
  <li>Hubble Exporter는 나중에 사용할 수 있도록 Hubble flows 로그를 파일에 저장하는 cilium-agent의 기능입니다.</li>
  <li>Hubble Exporter는 file rotation, size limits, filters, field masks를 지원합니다.</li>
  <li>Hubble Exporter는 다음과 같이 설정합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># &lt;span style="color: green;"&gt;👉 이미 cilium 설치할때 적용되어서 실습 과정에는 적용할 필요가 없습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.export.static.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.export.static.filePath<span class="o">=</span>/var/run/cilium/hubble/events.log

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout status ds/cilium
</code></pre></div></div>

<ul>
  <li>Hubble Exporter의 설정을 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | <span class="nb">grep </span>hubble-export
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>hubble-export
<span class="c"># =&gt; hubble-export-allowlist</span>
<span class="c">#    hubble-export-denylist</span>
<span class="c">#    hubble-export-fieldmask</span>
<span class="c">#    hubble-export-file-max-backups   5     # rotate된 Hubble export 파일을 유지할 수 있는 최대 개수. (기본값: 5)</span>
<span class="c">#    hubble-export-file-max-size-mb   10    # Hubble export 파일을 rotate할 때의 크기(MB). (기본값: 10)</span>
<span class="c">#    hubble-export-file-path          /var/run/cilium/hubble/events.log   # 대상 로그 파일의 경로. (기본값: /var/run/cilium/hubble/events.log)</span>

<span class="c"># Verify that flow logs are stored in target files</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">--</span> <span class="nb">tail</span> <span class="nt">-f</span> /var/run/cilium/hubble/events.log
<span class="c"># &lt;span style="color: green;"&gt;👉 로그가 계속 나옵니다.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'tail -f /var/run/cilium/hubble/events.log'</span> | jq
<span class="c"># &lt;span style="color: green;"&gt;👉 로그가 json 형태로 계속 나옵니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h2 id="prometheus와-grafana를-통한-모니터링">Prometheus와 Grafana를 통한 모니터링</h2>

<ul>
  <li>Prometheus와 Grafana를 통해 Cilium의 모니터링을 할 수 있습니다. <a href="https://docs.cilium.io/en/stable/observability/grafana/">Docs</a>
</li>
  <li>널리 알려진 툴들이라 다들 아시겠지만 간략하게 소개해 보겠습니다.
    <ul>
      <li>
<strong>Prometheus</strong> : 오픈 소스 모니터링 시스템으로, 시계열 데이터베이스를 사용하여 메트릭을 수집하고 저장합니다. 일종의 TSDB(Time Series Database)로, 메트릭을 수집하고 쿼리할 수 있는 강력한 기능을 제공합니다.</li>
      <li>
<strong>Grafana</strong> : 시각화 도구로, Prometheus와 같은 데이터 소스에서 수집된 메트릭을 대시보드 형태로 시각화할 수 있습니다. 다양한 플러그인을 통해 다양한 데이터 소스를 지원합니다.</li>
    </ul>
  </li>
  <li>추천글
    <ul>
      <li>악분님 프로메테우스 오퍼레이터 소개 - <a href="https://malwareanalysis.tistory.com/566">Blog</a>
</li>
      <li>hanhorang님 타노스 소개 - <a href="https://hanhorang31.github.io/post/pkos2-4-monitoring/">Blog</a>
</li>
      <li>[AWS EC2] 프로메테우스 직접 설치 - <a href="https://prometheus.io/docs/prometheus/latest/getting_started/">Docs</a>
</li>
    </ul>
  </li>
</ul>

<h3 id="샘플-애플리케이션-배포-및-확인">샘플 애플리케이션 배포 및 확인</h3>

<ul>
  <li>Prometheus와 Grafana를 설치하기 전에 샘플 애플리케이션을 배포하고, Cilium의 모니터링을 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 샘플 애플리케이션 배포</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF

</span><span class="c"># k8s-ctr 노드에 curl-pod 파드 배포</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span></code></pre></div></div>

<ul>
  <li>샘플 애플리케이션이 배포되었는지 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 배포 확인</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   2/2     2            2           41s   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.147.79   &lt;none&gt;        80/TCP    41s   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                       AGE</span>
<span class="c">#    endpoints/webpod   172.20.1.4:80,172.20.2.101:80   41s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="c"># =&gt; NAME           ADDRESSTYPE   PORTS   ENDPOINTS                 AGE</span>
<span class="c">#    webpod-g9ldp   IPv4          80      172.20.1.4,172.20.2.101   49s</span>
<span class="nv">$ </span>kubectl get ciliumendpoints
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  472                 ready            172.20.0.43</span>
<span class="c">#    webpod-697b545f57-mvz92   18655               ready            172.20.2.101</span>
<span class="c">#    webpod-697b545f57-ns4sw   18655               ready            172.20.1.4</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg endpoint list
<span class="c"># =&gt; ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS</span>
<span class="c">#               ENFORCEMENT        ENFORCEMENT</span>
<span class="c">#    272        Disabled           Disabled          472        k8s:app=curl                                                                        172.20.0.43    ready</span>
<span class="c">#                                                               k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=default</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=default</span>
<span class="c">#    1332       Disabled           Disabled          1          k8s:node-role.kubernetes.io/control-plane                                                          ready</span>
<span class="c">#                                                               k8s:node.kubernetes.io/exclude-from-external-load-balancers</span>
<span class="c">#                                                               reserved:host</span>
<span class="c">#    1814       Disabled           Disabled          30923      k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.20.0.134   ready</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#                                                               k8s:io.cilium.k8s.policy.serviceaccount=coredns</span>
<span class="c">#                                                               k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#                                                               k8s:k8s-app=kube-dns</span>

<span class="c"># 통신 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-mvz92</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s webpod | grep Hostname; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-ns4sw</span>
<span class="c">#    Hostname: webpod-697b545f57-mvz92</span>
<span class="c">#    Hostname: webpod-697b545f57-mvz92</span>
<span class="c">#    Hostname: webpod-697b545f57-ns4sw</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h3 id="prometheus-와-grafana-설치-및-설정">Prometheus 와 Grafana 설치 및 설정</h3>

<ul>
  <li>이번 예제는 Prometheus와 Grafana를 한번에 설치하는 예제를 따라하며 진행해보겠습니다. <a href="https://www.youtube.com/watch?v=DdWksYq5Pv4">Youtube 영상</a>
    <ul>
      <li>배포 파일에 Grafana에는 Cilium Dashboard가 포함되어 있습니다.</li>
      <li>이번 예제 배포파일에는 Prometheus와 Grafana가 Cilium과 Hubble의 메트릭을 자동으로 수집하고 시각화할 수 있도록 설정되어 있습니다.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/kubernetes/addons/prometheus/monitoring-example.yaml
<span class="c"># =&gt; namespace/cilium-monitoring created</span>
<span class="c">#    serviceaccount/prometheus-k8s created</span>
<span class="c">#    configmap/grafana-config created</span>
<span class="c">#    configmap/grafana-cilium-dashboard created</span>
<span class="c">#    configmap/grafana-cilium-operator-dashboard created</span>
<span class="c">#    configmap/grafana-hubble-dashboard created</span>
<span class="c">#    configmap/grafana-hubble-l7-http-metrics-by-workload created</span>
<span class="c">#    configmap/prometheus created</span>
<span class="c">#    clusterrole.rbac.authorization.k8s.io/prometheus created</span>
<span class="c">#    clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span>
<span class="c">#    service/grafana created</span>
<span class="c">#    service/prometheus created</span>
<span class="c">#    deployment.apps/grafana created</span>
<span class="c">#    deployment.apps/prometheus created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get deploy,pod,svc,ep <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/grafana      0/1     1            0           14s</span>
<span class="c">#    deployment.apps/prometheus   1/1     1            1           14s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              READY   STATUS              RESTARTS   AGE</span>
<span class="c">#    pod/grafana-5c69859d9-7cpvl       0/1     ContainerCreating   0          14s</span>
<span class="c">#    pod/prometheus-6fc896bc5d-9xfll   1/1     Running             0          14s</span>
<span class="c">#    </span>
<span class="c">#    NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/grafana      ClusterIP   10.96.10.188   &lt;none&gt;        3000/TCP   14s</span>
<span class="c">#    service/prometheus   ClusterIP   10.96.218.78   &lt;none&gt;        9090/TCP   14s</span>
<span class="c">#    </span>
<span class="c">#    NAME                   ENDPOINTS           AGE</span>
<span class="c">#    endpoints/grafana      &lt;none&gt;              14s</span>
<span class="c">#    endpoints/prometheus   172.20.2.115:9090   14s</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME                                         DATA   AGE</span>
<span class="c">#    grafana-cilium-dashboard                     1      23s</span>
<span class="c">#    grafana-cilium-operator-dashboard            1      23s</span>
<span class="c">#    grafana-config                               3      24s</span>
<span class="c">#    grafana-hubble-dashboard                     1      23s</span>
<span class="c">#    grafana-hubble-l7-http-metrics-by-workload   1      23s</span>
<span class="c">#    kube-root-ca.crt                             1      24s</span>
<span class="c">#    prometheus                                   1      23s</span>

<span class="c"># 프로메테우스 서버 설정</span>
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring prometheus

<span class="c"># 그라파나 서버 설정</span>
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring grafana-config

<span class="c"># 그파라나 대시보드들 주입을 위한 설정 확인</span>
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring grafana-cilium-dashboard
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring grafana-hubble-dashboard
<span class="c"># &lt;span style="color: green;"&gt;👉 설정 내용이 길어서 캡쳐는 생략하겠습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="cilium과-hubble-메트릭-켜기">Cilium과 Hubble 메트릭 켜기</h3>

<ul>
  <li>이번 예제에는 Cilium과 Hubble의 메트릭을 Prometheus와 Grafana가 수집할 수 있도록 설정되어 있습니다.</li>
  <li>하지만 기본적으로 Cilium, Hubble, Cilium Operator의 메트릭은 비활성화되어 있습니다.</li>
  <li>따라서 Prometheus와 Grafana가 Cilium과 Hubble의 메트릭을 수집할 수 있도록 설정을 변경해야 합니다. <a href="https://docs.cilium.io/en/stable/observability/grafana/#deploy-cilium-and-hubble-with-metrics-enabled">Docs</a>
</li>
  <li>메트릭을 활성화하면 구성요소가 실행중인 모든 노드에 각각 <code class="language-plaintext highlighter-rouge">9962</code>, <code class="language-plaintext highlighter-rouge">9965</code>, <code class="language-plaintext highlighter-rouge">9963</code> 포트가 열립니다.</li>
  <li>Cilium, Hubble, Cilium Operator은 다음 helm 값으로 서로 독립적으로 활성화 할 수 있습니다.
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">prometheus.enabled=true</code>: cilium-agent 메트릭 켜기.</li>
      <li>
<code class="language-plaintext highlighter-rouge">operator.prometheus.enabled=true</code>: cilium-operator 메트릭 켜기.</li>
      <li>
<code class="language-plaintext highlighter-rouge">hubble.metrics.enabled</code>: 주어진 Hubble 메트릭 목록을 켜기
        <ul>
          <li>Hubble 메트릭 실행을 위해서는 <code class="language-plaintext highlighter-rouge">hubble.enabled=true</code>으로 설정되어 있어야 합니다.</li>
          <li>
<a href="https://docs.cilium.io/en/stable/observability/metrics/#hubble-exported-metrics">Hubble exported metrics</a>에서 활성화 할 수 있는 Hubble 메트릭을 확인 가능합니다..</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># &lt;span style="color: green;"&gt;👉 이번 예제에서는 이미 활성화 되어있습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> 1.17.6 <span class="se">\</span>
   <span class="nt">--namespace</span> kube-system <span class="se">\</span>
   <span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
   <span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span>

<span class="c"># 호스트에 포트 정보 확인</span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'9962|9963|9965'</span>
<span class="c"># =&gt; LISTEN 0      4096                *:9962             *:*    users:(("cilium-agent",pid=2870,fd=7))     # cilium 메트릭</span>
<span class="c">#    LISTEN 0      4096                *:9963             *:*    users:(("cilium-operator",pid=1917,fd=7))  # cilium-opeator 메트릭</span>
<span class="c">#    LISTEN 0      4096                *:9965             *:*    users:(("cilium-agent",pid=2870,fd=31))    # hubble 메트릭</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 9963 포트는 cilium-operator 메트릭을 위한 포트로 컨트롤 플레인 노드에서만 열리는듯 합니다.&lt;/span&gt;</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w2 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'9962|9963|9965'</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    LISTEN 0      4096               *:9965             *:*    users:(("cilium-agent",pid=2032,fd=39))     # hubble 메트릭</span>
<span class="c">#    LISTEN 0      4096               *:9962             *:*    users:(("cilium-agent",pid=2032,fd=7))      # cilium 메트릭</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w2 &lt;&lt;</span>
<span class="c">#    LISTEN 0      4096               *:9962             *:*    users:(("cilium-agent",pid=2036,fd=7))      # cilium 메트릭</span>
<span class="c">#    LISTEN 0      4096               *:9965             *:*    users:(("cilium-agent",pid=2036,fd=30))     # hubble 메트릭</span>
</code></pre></div></div>

<h3 id="prometheus와-grafana-접속해서-확인">Prometheus와 Grafana 접속해서 확인</h3>

<ul>
  <li>Prometheus와 Grafana를 호스트에서 접속하기 위해 NodePort를 사용하여 접속할 수 있도록 설정하겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    grafana      ClusterIP   10.96.10.188   &lt;none&gt;        3000/TCP   10m</span>
<span class="c">#    prometheus   ClusterIP   10.96.218.78   &lt;none&gt;        9090/TCP   10m</span>

<span class="c"># NodePort 설정</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> cilium-monitoring prometheus <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 9090, "targetPort": 9090, "nodePort": 30001}]}}'</span>
<span class="c"># =&gt; service/prometheus patched</span>
<span class="nv">$ </span>kubectl patch svc <span class="nt">-n</span> cilium-monitoring grafana <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 3000, "targetPort": 3000, "nodePort": 30002}]}}'</span>
<span class="c"># =&gt; service/grafana patched</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> cilium-monitoring
<span class="c"># =&gt; NAME         TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    grafana      NodePort   10.96.10.188   &lt;none&gt;        3000:30002/TCP   11m</span>
<span class="c">#    prometheus   NodePort   10.96.218.78   &lt;none&gt;        9090:30001/TCP   11m</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 NodePort가 각각 30002, 30001로 설정되었습니다.&lt;/span&gt;</span>

<span class="c"># 접속 주소 확인</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"http://192.168.10.100:30001"</span>  <span class="c"># prometheus</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"http://192.168.10.100:30002"</span>  <span class="c"># grafana</span>
</code></pre></div></div>

<ul>
  <li>간혹 Prometheus의 접속시 서버와 브라우저간의 시간 차이가 발생할 수 있습니다.
    <ul>
      <li>이때는 모든 가상머신을 reboot후 재접속하면 해결되는듯 합니다.</li>
    </ul>
  </li>
  <li>Prometheus 접속 확인
    <ul>
      <li>설정확인
        <ul>
          <li>Status &gt; Configuration에서 Prometheus 설정을 확인할 수 있습니다.</li>
          <li>Status &gt; Service Discovery에서 kubernetes의 통한 서비스 디스커버리를 통해 수집된 대상을 확인할 수 있습니다.</li>
          <li>Status &gt; Targets에서 Cilium, Hubble, Cilium Operator의 메트릭이 수집되고 있는지 확인할 수 있습니다.</li>
        </ul>
      </li>
      <li>기본 쿼리창에서 <code class="language-plaintext highlighter-rouge">cilium_</code>, <code class="language-plaintext highlighter-rouge">cilium_operator_</code>, <code class="language-plaintext highlighter-rouge">hubble_</code>로 시작하는 메트릭을 검색해보면 Cilium, Hubble, Cilium Operator의 메트릭을 확인할 수 있습니다.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_14.png" alt="img.png" class="image-center" loading="lazy" width="1494" height="1128">
<em class="image-caption"><code class="language-plaintext highlighter-rouge">hubble_drop_total</code> 메트릭 검색 예제</em>
</li>
    </ul>
  </li>
  <li>Grafana 접속 확인
    <ul>
      <li>Configuration &gt; Data Sources에서 Prometheus 서비스의 도메인 주소를 확인할 수 있고, Prometheus에서 수집한 메트릭을 사용하고 있는것을 확인할 수 있습니다.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_15.png" alt="img.png" class="image-center" loading="lazy" width="353" height="184">
</li>
      <li>Dashboard &gt; General : 미리 설정된 대시보드를 확인할 수 있습니다.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_16.png" alt="img.png" class="image-center" loading="lazy" width="402" height="318">
</li>
    </ul>
  </li>
  <li>Cilium Metric 대시보드 및 간단 쿼리문 알아보기 : Generic, API, Cilium(BPF, kvstore, NW info, Endpoints, k8s integration)
    <ul>
      <li>Cilium Metric 대시보드는 전체적인 Cilium의 메트릭을 확인할 수 있는 대시보드입니다.</li>
      <li>map ops (average node) 패널 분석
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_17.png" alt="img.png" class="image-center" loading="lazy" width="1909" height="1113">
        <ul>
          <li>위의 캡쳐에서 본바와 같이 아래와 같은 PromQL 쿼리문을 사용합니다.
            <div class="language-sql highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="n">topk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="k">avg</span><span class="p">(</span><span class="n">rate</span><span class="p">(</span><span class="n">cilium_bpf_map_ops_total</span><span class="p">{</span><span class="n">k8s_app</span><span class="o">=</span><span class="nv">"cilium"</span><span class="p">,</span> <span class="n">pod</span><span class="o">=~</span><span class="nv">"$pod"</span><span class="p">}[</span><span class="mi">5</span><span class="n">m</span><span class="p">]))</span> <span class="k">by</span> <span class="p">(</span><span class="n">pod</span><span class="p">,</span> <span class="n">map_name</span><span class="p">,</span> <span class="k">operation</span><span class="p">))</span>
</code></pre></div>            </div>
          </li>
          <li>Prometheus에서 위의 쿼리를 바탕으로 쿼리를 해서 분석해 보겠습니다.
            <ul>
              <li>
<a href="https://docs.cilium.io/en/stable/observability/metrics/">공식문서</a>에서 확인해보면 <code class="language-plaintext highlighter-rouge">cilium_bpf_map_ops_total</code>는
수행된 eBPF Map 작업수를 나타냅니다.
                <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#</span>
cilium_bpf_map_ops_total 
<span class="c"># &lt;span style="color: green;"&gt;👉 전체 cilium_bpf_map_ops_total 조회&lt;/span&gt;</span>
cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s_app이 cilium인 cilium_bpf_map_ops_total 조회&lt;/span&gt;</span>
cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span>, <span class="nv">pod</span><span class="o">=</span><span class="s2">"cilium-4hghz"</span><span class="o">}</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s_app이 cilium이면서 pod 명이 cilium-4hghz인 cilium_bpf_map_ops_total 조회&lt;/span&gt;</span>
  
<span class="c"># 최근 5분 간의 데이터로 증가율 계산</span>
rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">)</span> <span class="c"># Graph 확인</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s_app이 cilium인 cilium_bpf_map_ops_total 의 5분간 데이터 증가율 계산&lt;/span&gt;</span>
  
<span class="c"># 여러 시계열(metric series)의 값의 평균</span>
avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">))</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s_app이 cilium인 cilium_bpf_map_ops_total 의 5분간 데이터 증가율의 평균&lt;/span&gt;</span>
  
<span class="c"># 집계 함수(예: sum, avg, max, rate)와 함께 사용하여 어떤 레이블(label)을 기준으로 그룹화할지를 지정하는 그룹핑(grouping) </span>
avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">))</span> by <span class="o">(</span>pod<span class="o">)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 pod명으로 그룹핑&lt;/span&gt;</span>
avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">))</span> by <span class="o">(</span>pod, map_name<span class="o">)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 pod명과 map이름으로 그룹핑&lt;/span&gt;</span>
avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">))</span> by <span class="o">(</span>pod, map_name, operation<span class="o">)</span> <span class="c"># Graph 확인</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 pod명과 map이름, map 동작으로 그룹핑&lt;/span&gt;</span>
  
<span class="c"># 시계열 중에서 가장 큰 k개를 선택</span>
topk<span class="o">(</span>5, avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span><span class="o">}[</span>5m]<span class="o">)))</span> by <span class="o">(</span>pod, map_name, operation<span class="o">)</span>
topk<span class="o">(</span>5, avg<span class="o">(</span>rate<span class="o">(</span>cilium_bpf_map_ops_total<span class="o">{</span><span class="nv">k8s_app</span><span class="o">=</span><span class="s2">"cilium"</span>, <span class="nv">pod</span><span class="o">=</span><span class="s2">"cilium-4hghz"</span><span class="o">}[</span>5m]<span class="o">)))</span> by <span class="o">(</span>pod, map_name, operation<span class="o">)</span>
</code></pre></div>                </div>
              </li>
            </ul>
          </li>
          <li>Grafana 해당 대시보드 편집해서 Variables을 확인해보겠습니다.
            <ul>
              <li>앞선 PromQL 쿼리문에서 <code class="language-plaintext highlighter-rouge">$pod</code>는 Variables로 설정되어 있습니다. 이를 확인해보겠습니다.</li>
              <li>해당 dashboard &gt; Settings &gt; Variables에서 <code class="language-plaintext highlighter-rouge">$pod</code>를 확인할 수 있습니다.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_18.png" alt="img.png" class="image-center" loading="lazy" width="810" height="349">
</li>
              <li>
<code class="language-plaintext highlighter-rouge">label_values(cilium_version, pod)</code>는 Prometheus에서 <code class="language-plaintext highlighter-rouge">cilium_version</code>으로 쿼리해서 얻어지는 label들 중 <code class="language-plaintext highlighter-rouge">pod</code>값을 취함을 의미합니다.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_19.png" alt="img.png" class="image-center" loading="lazy" width="926" height="372">
</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Cilium Operator 대시보드 : IPAM 관련 메트릭을 주로 확인할 수 있습니다. IPAM은 IP 주소 관리(IP Address Management)로, Cilium에서 IP 주소를 할당하고 관리하는 기능입니다.</li>
  <li>Hubble 대시보드 : General Processing, Network, Network Policy, HTTP, DNS 관련 메트릭을 확인할 수 있습니다.
    <ul>
      <li>Hubble L7 HTTP Metrics by Workload 대시보드 : HTTP 요청 및 응답에 대한 메트릭을 확인할 수 있습니다.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_20.png" alt="img.png" loading="lazy" width="1798" height="1118">
</li>
    </ul>
  </li>
</ul>

<hr>

<h2 id="monitoring--metrics">Monitoring &amp; Metrics</h2>

<h3 id="cilium-metrics-설정-및-수집-방법">Cilium Metrics 설정 및 수집 방법</h3>

<p><a href="https://docs.cilium.io/en/stable/observability/metrics/#cilium-metrics">Docs</a></p>

<ul>
  <li>Cilium Metrics는 Cilium 자체의 상태, 즉 Cilium Agent, Cilium Envoy, Cilium Operator 프로세스에 대한 메트릭을 수집하고 제공합니다.</li>
  <li>Prometheus에서 수집할 수 있도록 하려면 <code class="language-plaintext highlighter-rouge">prometheus.enabled=true</code>로 설정해서 helm chart를 설치해야 합니다.</li>
  <li>Cilium Metrics는 <code class="language-plaintext highlighter-rouge">cilium_</code>라는 접두사를 가진 메트릭을 Prometheus에 제공합니다.</li>
  <li>Envoy Metrics는 <code class="language-plaintext highlighter-rouge">envoy_</code>라는 접두사를 가진 메트릭을 Prometheus에 제공하며, Cilium이 정의한 메트릭은 <code class="language-plaintext highlighter-rouge">cilium_envoy_</code>라는 접두사를 가집니다.</li>
  <li>Kubernetes에서 실행 및 수집될때 pod 이름과 namespace를 포함한 레이블을 추가합니다.</li>
  <li>설정 방법 (본 실습에서는 이미 적용되어 있습니다.)
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> 1.17.6 <span class="se">\</span>
  <span class="nt">--namespace</span> kube-system <span class="se">\</span>
  <span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span>

  <span class="c"># The ports can be configured via prometheus.port, envoy.prometheus.port, or operator.prometheus.port respectively.</span>
  <span class="nt">--set</span> prometheus.port
  <span class="nt">--set</span> envoy.prometheus.port
  <span class="nt">--set</span> operator.prometheus.port
  ...
</code></pre></div>    </div>
  </li>
  <li>Metric이 활성화되면 모든 Cilium 구성요소에는 다음과 같은 annotation이 표시됩니다. annotation은 Prometheus가 메트릭을 수집할지 여부를 알리는데 사용됩니다.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># cilium-agent 데몬셋 파드</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium | <span class="nb">grep </span>prometheus
<span class="c"># =&gt;                       prometheus.io/port: 9962</span>
<span class="c">#                          prometheus.io/scrape: true</span>
  
<span class="nv">$ </span>curl 192.168.10.100:9962/metrics
<span class="c"># =&gt; # HELP cilium_agent_api_process_time_seconds Duration of processed API calls labeled by path, method and return code.</span>
<span class="c">#    # TYPE cilium_agent_api_process_time_seconds histogram</span>
<span class="c">#    cilium_agent_api_process_time_seconds_bucket{method="DELETE",path="/v1/endpoint",return_code="404",le="0.005"} 3</span>
<span class="c">#    cilium_agent_api_process_time_seconds_bucket{method="DELETE",path="/v1/endpoint",return_code="404",le="0.01"} 3</span>
<span class="c">#    cilium_agent_api_process_time_seconds_bucket{method="DELETE",path="/v1/endpoint",return_code="404",le="0.025"} 3</span>
<span class="c">#    ...</span>
  
<span class="c"># cilium-operator 디플로이먼트 파드 </span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> <span class="nv">name</span><span class="o">=</span>cilium-operator | <span class="nb">grep </span>prometheus
<span class="c"># =&gt; Annotations:          prometheus.io/port: 9963</span>
<span class="c">#                          prometheus.io/scrape: true</span>
  
<span class="nv">$ </span>curl 192.168.10.100:9963/metrics
<span class="c"># =&gt; # HELP certwatcher_read_certificate_errors_total Total number of certificate read errors</span>
<span class="c">#    # TYPE certwatcher_read_certificate_errors_total counter</span>
<span class="c">#    certwatcher_read_certificate_errors_total 0</span>
<span class="c">#    # HELP certwatcher_read_certificate_total Total number of certificate reads</span>
<span class="c">#    # TYPE certwatcher_read_certificate_total counter</span>
<span class="c">#    certwatcher_read_certificate_total 0</span>
<span class="c">#    ...</span>
</code></pre></div>    </div>
  </li>
  <li>Prometheus는  다음의 scrape_configs 섹션의 설정을 기반으로 자동으로 Cilium과 Envoy의 메트릭을 수집합니다.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring prometheus
<span class="c"># =&gt; prometheus.yaml:</span>
<span class="c">#    ...</span>
<span class="c">#    scrape_configs:</span>
<span class="c">#      ...    </span>
<span class="c">#      # https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L156</span>
<span class="c">#      - job_name: 'kubernetes-pods'</span>
<span class="c">#        kubernetes_sd_configs:</span>
<span class="c">#          - role: pod</span>
<span class="c">#        relabel_configs:</span>
<span class="c">#          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span>
<span class="c">#            action: keep</span>
<span class="c">#            regex: true</span>
<span class="c">#          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: __metrics_path__</span>
<span class="c">#            regex: (.+)</span>
<span class="c">#          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span>
<span class="c">#            action: replace</span>
<span class="c">#            regex: (.+):(?:\d+);(\d+)</span>
<span class="c">#            replacement: ${1}:${2}</span>
<span class="c">#            target_label: __address__</span>
<span class="c">#          - action: labelmap</span>
<span class="c">#            regex: __meta_kubernetes_pod_label_(.+)</span>
<span class="c">#          - source_labels: [__meta_kubernetes_namespace]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: namespace</span>
<span class="c">#          - source_labels: [__meta_kubernetes_pod_name]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: pod</span>
<span class="c">#          - source_labels: [__meta_kubernetes_pod_container_port_number]</span>
<span class="c">#            action: keep</span>
<span class="c">#            regex: \d+</span>
<span class="c">#    ...</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_21.png" alt="img.png" loading="lazy" width="953" height="752"></p>

<h3 id="hubble-metrics-설정-및-수집-방법">Hubble Metrics 설정 및 수집 방법</h3>

<p><a href="https://docs.cilium.io/en/stable/observability/metrics/#hubble-metrics">Docs</a></p>

<ul>
  <li>Cilium Metric은 Cilium의 상태를 모니터링 할 수 있게 해주지만, Hubble Metric은 Cilium이 관리하는 Kubernetes pod의 네트워크 동작을 연결과 보안과 관련하여 모니터링 할 수 있게 해줍니다.</li>
  <li>설정은 다음과 같습니다. (실습환경에서는 이미 적용되어 있습니다.)
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> 1.17.6 <span class="se">\</span>
<span class="nt">--namespace</span> kube-system <span class="se">\</span>
<span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span>
<span class="nt">--set</span> hubble.metrics.port
</code></pre></div>    </div>
  </li>
  <li>L7 메트릭은 L7 가시성 활성화가 필요합니다.</li>
  <li>
<code class="language-plaintext highlighter-rouge">hubble.metrics.enabled</code> 설정은 Hubble에서 수집할 메트릭을 지정합니다.
    <ul>
      <li>예를 들어, <code class="language-plaintext highlighter-rouge">hubble.metrics.enabled</code> 값을 Helm 챠트 value에 설정하면, Cilium 챠트는 <code class="language-plaintext highlighter-rouge">hubble-metrics</code>라는 헤드리스 서비스를 생성합니다.</li>
      <li>이 서비스는 <code class="language-plaintext highlighter-rouge">prometheus.io/scrape:'true'</code> annotation을 갖고 있어 Prometheus의 대상이 됩니다.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># hubble-metrics 헤드리스 서비스 정보 확인</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> kube-system hubble-metrics
<span class="c"># =&gt; NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    hubble-metrics   ClusterIP   None         &lt;none&gt;        9965/TCP   2d</span>
<span class="nv">$ </span>kc describe svc <span class="nt">-n</span> kube-system hubble-metrics
<span class="c"># =&gt; Annotations:              meta.helm.sh/release-name: cilium</span>
<span class="c">#                              meta.helm.sh/release-namespace: kube-system</span>
<span class="c">#                              prometheus.io/port: 9965</span>
<span class="c">#                              prometheus.io/scrape: true</span>
<span class="c">#    ...</span>
<span class="c">#    Endpoints:                192.168.10.102:9965,192.168.10.100:9965,192.168.10.101:9965</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>curl 192.168.10.100:9965/metrics
<span class="c"># =&gt; # HELP grpc_server_handled_total Total number of RPCs completed on the server, regardless of success or failure.</span>
<span class="c">#    # TYPE grpc_server_handled_total counter</span>
<span class="c">#    grpc_server_handled_total{grpc_code="Aborted",grpc_method="Check",grpc_service="grpc.health.v1.Health",grpc_type="unary"} 0</span>
<span class="c">#    grpc_server_handled_total{grpc_code="Aborted",grpc_method="GetAgentEvents",grpc_service="observer.Observer",grpc_type="server_stream"} 0</span>
<span class="c">#    grpc_server_handled_total{grpc_code="Aborted",grpc_method="GetDebugEvents",grpc_service="observer.Observer",grpc_type="server_stream"} 0</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kc describe cm <span class="nt">-n</span> cilium-monitoring prometheus
<span class="c"># =&gt; prometheus.yaml:</span>
<span class="c">#    ...</span>
<span class="c">#    scrape_configs:</span>
<span class="c">#      # https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L79</span>
<span class="c">#      - job_name: 'kubernetes-endpoints'</span>
<span class="c">#        kubernetes_sd_configs:</span>
<span class="c">#          - role: endpoints</span>
<span class="c">#        relabel_configs:</span>
<span class="c">#          - source_labels: [__meta_kubernetes_pod_label_k8s_app]</span>
<span class="c">#            action: keep</span>
<span class="c">#            regex: cilium</span>
<span class="c">#          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span>
<span class="c">#            action: keep</span>
<span class="c">#            regex: true</span>
<span class="c">#          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: __scheme__</span>
<span class="c">#            regex: (https?)</span>
<span class="c">#          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: __metrics_path__</span>
<span class="c">#            regex: (.+)</span>
<span class="c">#          - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: __address__</span>
<span class="c">#            regex: (.+)(?::\d+);(\d+)</span>
<span class="c">#            replacement: $1:$2</span>
<span class="c">#          - action: labelmap</span>
<span class="c">#            regex: __meta_kubernetes_service_label_(.+)</span>
<span class="c">#          - source_labels: [__meta_kubernetes_namespace]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: namespace</span>
<span class="c">#          - source_labels: [__meta_kubernetes_service_name]</span>
<span class="c">#            action: replace</span>
<span class="c">#            target_label: service</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w2/20250727_cilium_w2_22.png" alt="img.png" loading="lazy" width="953" height="568"></p>

<h2 id="layer-7-protocol-visibility">Layer 7 Protocol Visibility</h2>

<ul>
  <li>Monitoring Datapath State는 기본적으로 L3/L4 패킷에 대한 가시성을 제공합니다.</li>
  <li>HTTP나 DNS같은 L7 프로토콜에 대한 가시성을 제공하기 위해서는 L7 프로토콜 가시성을 활성화해야 합니다.</li>
  <li>L7 트래픽에 대한 가시성을 활성화 하려면 L7 규칙을 지정하는 CiliumNetworkPolicy를 만들어야 합니다.</li>
  <li>CiliumNetworkPolicy는 L7 규칙과 일치하는 트래픽의 흐름이 Cilium에 표시되므로 최종사용자에게 노출될 수 있습니다.</li>
  <li>L7 네트워크 정책은 가시성을 가능하게 할 뿐만 아니라 pod에 들어가고 나가는 트래픽을 제어할 수 있음을 기억해야 합니다.</li>
</ul>

<h3 id="실습">실습</h3>

<ul>
  <li>다음 예제는 DNS(TCP/UDP/53) 및 HTTP(TCP/80 및 TCP/8080) 트래픽을 기본 네임스페이스 내에 표시할 수 있도록 L7 규칙을 지정합니다.</li>
  <li>하나는 DNS 규칙과 하나는 HTTP 규칙을 제공하며, 한 출력 통신을 제외하고 일치하지 않는 모든것을 삭제합니다.</li>
  <li>규칙이 L7 일치 조건이 생략되거나 와일드카드 처리되면 L4 섹션과 일치하는 모든 요청이 허용됩니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 반복 접속 해둔 상태</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s webpod | grep Hostname; sleep 1; done'</span>

<span class="c"># default 네임스페이스에 있는 Pod들의 egress(출방향) 트래픽을 제어하며, L7 HTTP 및 DNS 트래픽에 대한 가시성과 제어를 설정</span>
<span class="c">## method/path 기반 필터링은 안 하지만, HTTP 요청 정보는 Envoy를 통해 기록/관찰됨</span>
<span class="c">## cilium-envoy를 경유하게 됨 (DNS + HTTP 모두 L7 처리 대상)</span>
<span class="c">## 이 정책이 적용되면, 명시된 egress 외의 모든 egress 트래픽은 차단됩니다 (Cilium 정책은 default-deny 모델임)</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "l7-visibility"
spec:
  endpointSelector:
    matchLabels:
      "k8s:io.kubernetes.pod.namespace": default  # default 네임스페이스 안의 모든 Pod에 대해 egress 정책이 적용
  egress:
  - toPorts:
    - ports:
      - port: "53"
        protocol: ANY  # TCP, UDP 둘 다 허용
      rules:
        dns:
        - matchPattern: "*"  # 모든 도메인 조회 허용, L7 가시성 활성화
  - toEndpoints:
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": default
    toPorts:
    - ports:
      - port: "80"  # default 다른 파드의 HTTP TCP 80 요청 허용
        protocol: TCP
      - port: "8080"  # default 다른 파드의 HTTP TCP 8080 요청 허용
        protocol: TCP
      rules:
        http: [{}]  # 모든 HTTP 요청을 허용, L7 가시성 활성화
</span><span class="no">EOF

</span><span class="nv">$ </span>kubectl get cnp <span class="nt">-o</span> yaml
<span class="c"># =&gt;   kind: CiliumNetworkPolicy</span>
<span class="c">#      ...</span>
<span class="c">#      spec:</span>
<span class="c">#        egress:</span>
<span class="c">#        - toPorts:</span>
<span class="c">#          - ports:</span>
<span class="c">#            - port: "53"</span>
<span class="c">#              protocol: ANY</span>
<span class="c">#            rules:</span>
<span class="c">#              dns:</span>
<span class="c">#              - matchPattern: '*'</span>
<span class="c">#        - toEndpoints:</span>
<span class="c">#          - matchLabels:</span>
<span class="c">#              k8s:io.kubernetes.pod.namespace: default</span>
<span class="c">#          toPorts:</span>
<span class="c">#          - ports:</span>
<span class="c">#            - port: "80"</span>
<span class="c">#              protocol: TCP</span>
<span class="c">#            - port: "8080"</span>
<span class="c">#              protocol: TCP</span>
<span class="c">#            rules:</span>
<span class="c">#              http:</span>
<span class="c">#              - {}</span>
<span class="c">#        endpointSelector:</span>
<span class="c">#          matchLabels:</span>
<span class="c">#            k8s:io.kubernetes.pod.namespace: default</span>
<span class="c">#      ...</span>

<span class="c"># 호출 확인 : cilium-envoy 경유 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> webpod
<span class="c"># =&gt; Hostname: webpod-697b545f57-mvz92</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.2.101</span>
<span class="c">#    IP: fe80::68c6:baff:fe2c:766b</span>
<span class="c">#    &lt;span style="color: green;"&gt;RemoteAddr: 172.20.0.43:39216&lt;/span&gt; # 해당 IP는 curl-pod 의 IP로 cilium-envoy IP로 SNAT 되지 않았음!</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: webpod</span>
<span class="c">#    User-Agent: curl/8.14.1</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    &lt;span style="color: green;"&gt;X-Envoy-Expected-Rq-Timeout-Ms: 3600000&lt;/span&gt;   # cilium-envoy 경유 확인</span>
<span class="c">#    &lt;span style="color: green;"&gt;X-Envoy-Internal: true&lt;/span&gt;</span>
<span class="c">#    X-Forwarded-Proto: http</span>
<span class="c">#    X-Request-Id: 913dbacf-5559-4d13-8855-afaa41979f4e</span>

<span class="c"># 가시성 확인</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">-t</span> l7 <span class="nt">-o</span> compact
<span class="c"># =&gt; Jul 26 14:58:47.953: default/curl-pod:34773 (ID:472) -&gt; kube-system/coredns-674b8bbfcf-7m82r:53 (ID:30923) dns-request proxy FORWARDED (DNS Query webpod.default.svc.cluster.local. AAAA)</span>
<span class="c">#    Jul 26 14:58:47.953: default/curl-pod:34773 (ID:472) -&gt; kube-system/coredns-674b8bbfcf-7m82r:53 (ID:30923) dns-request proxy FORWARDED (DNS Query webpod.default.svc.cluster.local. A)</span>
<span class="c">#    Jul 26 14:58:47.954: default/curl-pod:34773 (ID:472) &lt;- kube-system/coredns-674b8bbfcf-7m82r:53 (ID:30923) dns-response proxy FORWARDED (DNS Answer "10.96.147.79" TTL: 30 (Proxy webpod.default.svc.cluster.local. A))</span>
<span class="c">#    Jul 26 14:58:47.956: default/curl-pod:34773 (ID:472) &lt;- kube-system/coredns-674b8bbfcf-7m82r:53 (ID:30923) dns-response proxy FORWARDED (DNS Answer  TTL: 4294967295 (Proxy webpod.default.svc.cluster.local. AAAA))</span>
<span class="c">#    Jul 26 14:58:47.961: default/curl-pod:52022 (ID:472) -&gt; default/webpod-697b545f57-mvz92:80 (ID:18655) http-request FORWARDED (HTTP/1.1 GET http://webpod/)</span>
<span class="c">#    Jul 26 14:58:47.967: default/curl-pod:52022 (ID:472) &lt;- default/webpod-697b545f57-mvz92:80 (ID:18655) http-response FORWARDED (HTTP/1.1 200 5ms (GET http://webpod/))</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>Grafana에서 L7 HTTP Metrics by Workload 대시보드를 확인해보면, HTTP 요청 및 응답에 대한 메트릭을 확인할 수 있습니다.
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_23.png" alt="img.png" class="image-center" loading="lazy" width="1798" height="1295">
    <ul>
      <li>이때 현재 label에는 destination_workload가 포함되어있지 않아서 메트릭이 나타나지 않는데 Destination Workload를 임시로 <code class="language-plaintext highlighter-rouge">.*</code> (정규표현식에서 와일드 카드)로 하거나 PromQL에서 해당 부분을 제외하거나 label에 추가하면 메트릭을 확인할 수 있습니다.</li>
    </ul>
  </li>
  <li>Prometheus에서도 <code class="language-plaintext highlighter-rouge">rate(hubble_http_requests_total[5m])</code>를 통해 확인해 보겠습니다. 
<img src="/assets/2025/cilium/w2/20250727_cilium_w2_24.png" alt="img.png" loading="lazy" width="1798" height="1118">
</li>
</ul>

<h3 id="security-implications-및-실습">Security Implications 및 실습</h3>

<p><a href="https://docs.cilium.io/en/stable/observability/visibility/#security-implications">Docs</a></p>

<ul>
  <li>L7 트래픽 모니터링은 <strong>사용자 이름, 비밀번호, 쿼리 매개변수, API 키</strong> 등 잠재적으로 민감한 정보를 포함할 수 있기 때문에 보안에 주의해야 합니다.</li>
  <li>기본적으로 Hubble은 L7 트래픽의 민감 정보를 필터링하지 않습니다.</li>
  <li>간단한 실습을 해보겠습니다.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">-t</span> l7
<span class="c"># =&gt; Jul 26 15:50:11.494: default/curl-pod:49308 (ID:472) -&gt; default/webpod-697b545f57-mvz92:80 (ID:18655) http-request FORWARDED (HTTP/1.1 GET http://webpod/?user_id=1234)</span>
<span class="c">#    Jul 26 15:50:11.499: default/curl-pod:49308 (ID:472) &lt;- default/webpod-697b545f57-mvz92:80 (ID:18655) http-response FORWARDED (HTTP/1.1 200 5ms (GET http://webpod/?user_id=1234))</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 아래의 curl 명령으로 보낸 user_id가 그대로 보이는것을 확인할 수 있습니다.&lt;/span&gt;</span>
  
<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'curl -s webpod/?user_id=1234'</span>
  
<span class="c"># 민감정보 미출력 설정</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">extraArgs</span><span class="o">=</span><span class="s2">"{--hubble-redact-enabled,--hubble-redact-http-urlquery}"</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    NAME: cilium</span>
<span class="c">#    LAST DEPLOYED: Sun Jul 27 00:51:08 2025</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 10</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    You have successfully installed Cilium with Hubble Relay and Hubble UI.</span>
<span class="c">#    </span>
<span class="c">#    Your release version is 1.17.6.</span>
  
<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'curl -s webpod/?user_id=1234'</span>
  
<span class="c">#</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">-t</span> l7
<span class="c"># =&gt; Jul 26 15:51:49.594: default/curl-pod:53276 (ID:472) -&gt; default/webpod-697b545f57-ns4sw:80 (ID:18655) http-request FORWARDED (HTTP/1.1 GET http://webpod/)</span>
<span class="c">#    Jul 26 15:51:49.601: default/curl-pod:53276 (ID:472) &lt;- default/webpod-697b545f57-ns4sw:80 (ID:18655) http-response FORWARDED (HTTP/1.1 200 9ms (GET http://webpod/))</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 민감정보가 필터링 된것을 확인할 수 있습니다.&lt;/span&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>보안을 강화하기 위해 Cilium은 허블이 레이어 7 흐름에 존재하는 민감한 정보를 처리(제거나 마스킹)할 수 있도록 <code class="language-plaintext highlighter-rouge">--hubble-redact-enabled</code> 옵션을 제공합니다.
    <ul>
      <li>HTTP에서 URL 쿼리 파라메터(GET)을 필터링 하기위해 <code class="language-plaintext highlighter-rouge">--hubble-redact-http-urlquery</code>를 사용 =&gt; URL의 <code class="language-plaintext highlighter-rouge">?query=value</code> 제거
        <ul>
          <li>예시) 설정 전
            <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="s2">"method"</span>: <span class="s2">"GET"</span>,
<span class="s2">"url"</span>: <span class="s2">"/user/profile?user_id=1234&amp;token=abcd1234"</span>,
<span class="s2">"status"</span>: 200
</code></pre></div>            </div>
          </li>
          <li>예시) 설정 후 : <code class="language-plaintext highlighter-rouge">--set extraArgs="{--hubble-redact-http-urlquery}”</code>
            <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="s2">"method"</span>: <span class="s2">"GET"</span>,
<span class="s2">"url"</span>: <span class="s2">"/user/profile"</span>, <span class="c"># 쿼리 문자열이 제거되어 출력, 민감 정보 보호됨</span>
<span class="s2">"status"</span>: 200
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>HTTP에서 사용자정보 (basic auth의 아이디 비밀번호) 등을 필터링하기위해 <code class="language-plaintext highlighter-rouge">--hubble-redact-http-userinfo</code>를 사용 =&gt; URL의 <code class="language-plaintext highlighter-rouge">user:pass@</code> 제거</li>
      <li>Kafka에서 API 키를 필터링하려면 <code class="language-plaintext highlighter-rouge">--hubble-redact-kafka-apikey</code> 사용</li>
      <li>HTTP 헤더를 필터링하기 위해서는 허용리스트(<code class="language-plaintext highlighter-rouge">--hubble-redact-http-headers-allow</code>) 또는 거부리스트 (<code class="language-plaintext highlighter-rouge">--hubble-redact-http-headers-deny</code>)를 사용</li>
    </ul>
  </li>
</ul>

<hr>

<h2 id="pwru-packet-where-are-you">pwru (Packet where are you)</h2>

<ul>
  <li>pwru는 eBPF 기반의 linux 커널 디버거입니다. <a href="https://github.com/cilium/pwru">https://github.com/cilium/pwru</a>
</li>
  <li>주요 특징
    <ul>
      <li>eBPF 기반 네트워크 트레이싱 툴로, 커널 패킷 경로를 실시간으로 모니터링합니다.</li>
      <li>고급 필터링 기능을 제공하여, 관심 있는 패킷만 골라서 추적할 수 있습니다</li>
      <li>네트워크 트러블슈팅, 즉 패킷 손실 및 처리 위치 파악, 다양한 커널 모듈과의 상호작용 등을 이해하는 데 유용합니다.</li>
      <li>커맨드라인에서 다양한 옵션과 PCAP 필터를 적용해서 상세 분석을 할 수 있습니다.</li>
    </ul>
  </li>
</ul>

<h3 id="pwru-설치-및-실행">pwru 설치 및 실행</h3>

<ul>
  <li>
<a href="https://medium.com/@Nikhil690/debugging-packet-drops-and-kernel-flows-with-pwru-fc03f3d479a4">PWRU: Debugging Packets and Kernel Flows</a>를 바탕으로 실행해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Prerequisites</span>
<span class="nv">$ </span><span class="nb">sudo </span>apt update
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> clang llvm gcc make flex bison byacc yacc libpcap-dev golang

<span class="c"># Building PWRU from Source</span>
<span class="c">## Clone the PWRU GitHub repository</span>
<span class="nv">$ </span>git clone https://github.com/cilium/pwru.git
<span class="c"># =&gt; Cloning into 'pwru'...</span>
<span class="c">#    remote: Enumerating objects: 7681, done.</span>
<span class="c">#    remote: Counting objects: 100% (211/211), done.</span>
<span class="c">#    remote: Compressing objects: 100% (127/127), done.</span>
<span class="c">#    remote: Total 7681 (delta 117), reused 94 (delta 83), pack-reused 7470 (from 3)</span>
<span class="c">#    Receiving objects: 100% (7681/7681), 9.40 MiB | 18.12 MiB/s, done.</span>
<span class="c">#    Resolving deltas: 100% (4723/4723), done.</span>

<span class="c">## Navigate to the project directory</span>
<span class="nv">$ </span><span class="nb">cd </span>pwru

<span class="c">## Build the project : Compile the eBPF object files, Build the userspace Go application, Link everything together</span>
<span class="nv">$ </span>make
<span class="c"># =&gt; ...</span>
<span class="c">#    TARGET_GOARCH=&lt;span style="color: green;"&gt;amd64&lt;/span&gt; go generate</span>
<span class="c">#    Generating for &lt;span style="color: green;"&gt;amd64&lt;/span&gt;</span>
<span class="c">#    CC=cc GOARCH=&lt;span style="color: green;"&gt;amd64&lt;/span&gt; CGO_ENABLED=1 go build  \</span>
<span class="c">#            -ldflags "-w -s \</span>
<span class="c">#            -X 'github.com/cilium/pwru/internal/pwru.Version=v1.0.10-pre-110-gbd7ffd8'"</span>
<span class="c">#    # runtime/cgo</span>
<span class="c">#    &lt;span style="background-color: red; color: #fff;"&gt;cc: error: unrecognized command-line option '-m64'&lt;/span&gt;</span>
<span class="c">#    make: *** [Makefile:22: pwru] Error 1</span>
</code></pre></div></div>

<ul>
  <li>M1 Mac에서 빌드할 때는 <code class="language-plaintext highlighter-rouge">-m64</code> 옵션이 문제를 일으키는것 같습니다.</li>
</ul>

<h3 id="빌드-트러블슈팅-및-실행">빌드 트러블슈팅 및 실행</h3>

<ul>
  <li>빌드 로그를 봤을때 자꾸 amd64로 빌드하려고 하는것 같습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
<span class="c"># =&gt; Linux k8s-ctr 6.8.0-53-generic #55-Ubuntu SMP PREEMPT_DYNAMIC Fri Jan 17 15:02:14 UTC 2025 &lt;span style="color: green;"&gt;aarch64 aarch64 aarch64&lt;/span&gt; GNU/Linux</span>
</code></pre></div></div>

<ul>
  <li>하지만 제 환경은 aarch64으로 뭔기 빌드 설정이 잘못된것 같습니다. 빌드 스크립트를 수정하고 PR을 올리면 좋겠지만 시간이 없으므로 arm64로 강제로 빌드해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># (기존) TARGET_GOARCH=amd64 go generate</span>
<span class="nv">$ TARGET_GOARCH</span><span class="o">=</span>arm64 go generate
<span class="c"># =&gt; Generating for arm64</span>

<span class="c"># (기존) CC=cc GOARCH=amd64 CGO_ENABLED=1 go build  \</span>
<span class="c">#         -ldflags "-w -s \</span>
<span class="c">#         -X 'github.com/cilium/pwru/internal/pwru.Version=v1.0.10-pre-110-gbd7ffd8'"</span>
<span class="nv">$ CC</span><span class="o">=</span>cc <span class="nv">GOARCH</span><span class="o">=</span>arm64 <span class="nv">CGO_ENABLED</span><span class="o">=</span>1 go build  <span class="se">\</span>
        <span class="nt">-ldflags</span> <span class="s2">"-w -s </span><span class="se">\</span><span class="s2">
        -X 'github.com/cilium/pwru/internal/pwru.Version=v1.0.10-pre-110-gbd7ffd8'"</span>
<span class="c"># =&gt; # github.com/cilium/pwru</span>
<span class="c">#    /usr/bin/ld: /tmp/go-link-4205941405/000020.o: in function `_cgo_77133bf98b3a_C2func_getaddrinfo':</span>
<span class="c">#    /tmp/go-build/cgo_unix_cgo.cgo2.c:60:(.text+0x30): warning: Using 'getaddrinfo' in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span>
<span class="c">#    /usr/bin/ld: /root/pwru/internal/libpcap/../../libpcap/libpcap.a(nametoaddr.o): in function `pcap_nametoaddr':</span>
<span class="c">#    /root/pwru/libpcap/./nametoaddr.c:181:(.text+0x8): warning: Using 'gethostbyname' in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span>
<span class="c">#    /usr/bin/ld: /root/pwru/internal/libpcap/../../libpcap/libpcap.a(nametoaddr.o): in function `pcap_nametonetaddr':</span>
<span class="c">#    /root/pwru/libpcap/./nametoaddr.c:270:(.text+0x104): warning: Using 'getnetbyname_r' in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span>
<span class="c">#    /usr/bin/ld: /root/pwru/internal/libpcap/../../libpcap/libpcap.a(nametoaddr.o): in function `pcap_nametoproto':</span>
<span class="c">#    /root/pwru/libpcap/./nametoaddr.c:527:(.text+0x4cc): warning: Using 'getprotobyname_r' in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 warning이 뜨긴 했지만 빌드가 된것 같습니다.&lt;/span&gt;</span>

<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> pwru
<span class="c"># =&gt; -rwxr-xr-x 1 root root 8561904 Jul 27 00:39 pwru</span>
</code></pre></div></div>

<ul>
  <li>빌드가 완료되면 <code class="language-plaintext highlighter-rouge">pwru</code> 실행파일이 생성됩니다. 이 파일을 실행하면 PWRU를 사용할 수 있습니다.</li>
  <li>리눅스 커널과 eBPF 서브시스템에 직접 상호작용하기 때문에 root 권한으로 실행해야 합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Running PWRU</span>
<span class="c">## Since PWRU interacts directly with kernel functions and eBPF subsystems, you need root permissions to run it:</span>
<span class="nv">$ </span><span class="nb">sudo</span> ./pwru <span class="o">[</span>options] <span class="o">[</span>pcap-filter]

<span class="c"># ICMP (ping) 패킷을 추적해보겠습니다.</span>
<span class="nv">$ </span><span class="nb">sudo</span> ./pwru <span class="nt">--output-tuple</span> icmp
<span class="c"># =&gt; 2025/07/27 00:40:49 Attaching kprobes (via kprobe)...</span>
<span class="c">#    1669 / 1669 [--------------------------------------------------------] 100.00% 1455 p/s</span>
<span class="c">#    2025/07/27 00:40:50 Attached (ignored 5)</span>
<span class="c">#    2025/07/27 00:40:50 Listening for events..  # &lt;span style="color: green;"&gt;👉 eBPF 설치하는 과정이 종료되고 이벤트를 listening 하고 있습니다.&lt;/span&gt;</span>
<span class="c">#    SKB                CPU PROCESS          NETNS      MARK/x        IFACE       PROTO  MTU   LEN   TUPLE FUNC</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 0               0         0x0000 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     ip_send_skb</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 0               0         0x0000 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     __ip_local_out</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 0               0         0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     nf_hook_slow</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00             0         0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     ip_output</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     nf_hook_slow</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     apparmor_ip_postroute</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     ip_finish_output</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     __ip_finish_output</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  84    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     ip_finish_output2</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     __dev_queue_xmit</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 c00           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     qdisc_pkt_len_init</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     netdev_core_pick_tx</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     dev_qdisc_enqueue</span>
<span class="c">#    0xffff00005f10c300 0   ~/bin/ping:42701 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     __skb_get_hash</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     sch_direct_xmit</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     validate_xmit_skb_list</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     validate_xmit_skb</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     netif_skb_features</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     skb_network_protocol</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     validate_xmit_xfrm</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     dev_hard_start_xmit</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     skb_clone_tx_timestamp</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     napi_consume_skb</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     skb_release_head_state</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     sock_wfree</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     skb_release_data</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     skb_free_head</span>
<span class="c">#    0xffff00005f10c300 1   ~/sbin/sshd:6275 4026531840 300           eth0:2      0x0800 1500  98    10.0.2.15:0-&gt;8.8.8.8:0(icmp)     napi_skb_cache_put</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 0             eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     inet_gro_receive</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 0             eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_defer_rx_timestamp</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 0             eth0:2      0x0800 1500  98    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_ensure_writable</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_rcv_core</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     nf_hook_slow</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     nf_ip_checksum</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     __skb_checksum_complete</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_route_input_noref</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_route_input_slow</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     fib_validate_source</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     __fib_validate_source</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_local_deliver</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     nf_hook_slow</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_local_deliver_finish</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ip_protocol_deliver_rcu</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     raw_local_deliver</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     raw_v4_input</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_clone</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     raw_rcv</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_push</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ipv4_pktinfo_prepare</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     sock_queue_rcv_skb_reason</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     sk_filter_trim_cap</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     security_sock_rcv_skb</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     apparmor_socket_sock_rcv_skb</span>
<span class="c">#    0xffff00005f10c400 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     __sock_queue_rcv_skb</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     icmp_rcv</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 56    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     ping_rcv</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 56    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_push</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     kfree_skb_reason(SKB_DROP_REASON_NO_SOCKET)</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 65536 64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_release_head_state</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_release_data</span>
<span class="c">#    0xffff000007add600 0   &lt;empty&gt;:0        4026531840 300           eth0:2      0x0800 1500  64    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     kfree_skbmem</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     __sock_recv_cmsgs</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     __sock_recv_timestamp</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_free_datagram</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     consume_skb</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_release_head_state</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     sock_rfree</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_release_data</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     skb_free_head</span>
<span class="c">#    0xffff00005f10c400 1   &lt;empty&gt;:42701    4026531840 300             0         0x0800 0     84    8.8.8.8:0-&gt;10.0.2.15:0(icmp)     kfree_skbmem</span>

<span class="c"># 다른 터미널에서 ping 명령어를 실행해보겠습니다.</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 8.8.8.8
<span class="c"># =&gt; PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 8.8.8.8: icmp_seq=1 ttl=255 time=38.7 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 8.8.8.8 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 38.740/38.740/38.740/0.000 ms</span>
</code></pre></div></div>

<ul>
  <li>ping 한번 보냈을 뿐인데 엄청난 량의 정보가 나왔습니다. 자세한 자료는 아래의 참고 자료를 참고해보시기 바랍니다.</li>
  <li>참고 자료
    <ul>
      <li><a href="https://nuguni.tistory.com/97">네트워크 패킷 추적 도구 - PWRU: Packet, Where Are You?</a></li>
      <li><a href="https://cilium.io/blog/2023/03/22/packet-where-are-you/">Going from Packet Where Aren’t You to pwru</a></li>
      <li><a href="https://medium.com/@Nikhil690/debugging-packet-drops-and-kernel-flows-with-pwru-fc03f3d479a4">PWRU: Debugging Packets and Kernel Flows</a></li>
    </ul>
  </li>
</ul>

<hr>

<h2 id="마치며">마치며</h2>

<p>이번 포스트에서는 Cilium의 관측성(Observability)을 위한 Hubble과 Prometheus/Grafana 연동, 각종 메트릭 그리고 PWRU를 설치하고 사용해보았습니다.
굉장히 많은 정보량에 압도되었습니다. 그래도 차근차근 따라가면서 실습해보니 Cilium의 관측성 기능을 이해하는데 큰 도움이 되었습니다.</p>

<p>관측성 도구들은 정말 강력하고 유용한 기능이지만 민감한 정보가 노출될 수 있기 때문에, 프로덕션 환경에서는 주의해서 사용해야 할 것 같습니다.
특히 끊임없이 새로운 기술이 나오고, 새로운 툴들이 나오고, 쉽게 설치하고 버전을 바꾸고 하는 현실에서
사소한 설정하나로 정보 유출이 발생할 수 있다는 점이 무섭기도 합니다. 
개발환경이나 내부에서 충분히 테스트하고 검증한 후에 프로덕션 환경에 적용하는 것이 중요할 것 같습니다.</p>

<p>이제 조금씩 회사 업무에도 Cilium을 적용하고 있어서 이번에 학습한 관측성 기능들을 활용해서
Cilium을 더 잘 이해하고, 문제를 해결하는데 도움이 될 것 같습니다.
이번 주도 스터디 준비해주신 모든 분들께 감사드립니다. <img class="emoji" title=":bow:" alt=":bow:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f647.png" height="20" width="20" loading="lazy"></p>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#%EC%8B%A4%EC%8A%B5-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1">실습 환경 구성</a>
<ul>
<li class="toc-entry toc-h3">
<a href="#%EC%8B%A4%EC%8A%B5-%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC-%ED%8C%8C%EC%9D%BC-%EC%9E%91%EC%84%B1">실습 환경 배포 파일 작성</a>
<ul>
<li class="toc-entry toc-h4"><a href="#vagrantfile">Vagrantfile</a></li>
<li class="toc-entry toc-h4"><a href="#init_cfgsh">init_cfg.sh</a></li>
<li class="toc-entry toc-h4"><a href="#k8s-ctrsh">k8s-ctr.sh</a></li>
<li class="toc-entry toc-h4"><a href="#k8s-wsh">k8s-w.sh</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC">실습환경 배포</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-agent-%EB%8B%A8%EC%B6%95%ED%82%A4-%EC%A7%80%EC%A0%95">Cilium Agent 단축키 지정</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#network-observability-with-hubble">Network Observability with Hubble</a>
<ul>
<li class="toc-entry toc-h3"><a href="#hubble-%EC%86%8C%EA%B0%9C">Hubble 소개</a></li>
<li class="toc-entry toc-h3"><a href="#hubble-observability-%EC%84%A4%EC%B9%98">Hubble Observability 설치</a></li>
<li class="toc-entry toc-h3">
<a href="#star-wars-demo%EB%A5%BC-%ED%86%B5%ED%95%9C-hubbleui-%EC%B2%B4%ED%97%98">Star Wars Demo를 통한 Hubble/UI 체험</a>
<ul>
<li class="toc-entry toc-h4"><a href="#%EB%8D%B0%EB%AA%A8-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%B0%ED%8F%AC">데모 애플리케이션 배포</a></li>
<li class="toc-entry toc-h4"><a href="#%ED%98%84%EC%9E%AC-%EC%A0%91%EA%B7%BC%EC%83%81%ED%83%9C-%ED%99%95%EC%9D%B8">현재 접근상태 확인</a></li>
<li class="toc-entry toc-h4"><a href="#l3l4-%EC%A0%95%EC%B1%85-%EC%A0%81%EC%9A%A9">L3/L4 정책 적용</a></li>
<li class="toc-entry toc-h4"><a href="#http-aware-l7-%EC%A0%95%EC%B1%85-%EC%A0%81%EC%9A%A9-%EB%B0%8F-%ED%85%8C%EC%8A%A4%ED%8A%B8">HTTP-aware L7 정책 적용 및 테스트</a></li>
<li class="toc-entry toc-h4"><a href="#configuring-hubble-exporter">Configuring Hubble Exporter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#prometheus%EC%99%80-grafana%EB%A5%BC-%ED%86%B5%ED%95%9C-%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">Prometheus와 Grafana를 통한 모니터링</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%83%98%ED%94%8C-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%99%95%EC%9D%B8">샘플 애플리케이션 배포 및 확인</a></li>
<li class="toc-entry toc-h3"><a href="#prometheus-%EC%99%80-grafana-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EC%84%A4%EC%A0%95">Prometheus 와 Grafana 설치 및 설정</a></li>
<li class="toc-entry toc-h3"><a href="#cilium%EA%B3%BC-hubble-%EB%A9%94%ED%8A%B8%EB%A6%AD-%EC%BC%9C%EA%B8%B0">Cilium과 Hubble 메트릭 켜기</a></li>
<li class="toc-entry toc-h3"><a href="#prometheus%EC%99%80-grafana-%EC%A0%91%EC%86%8D%ED%95%B4%EC%84%9C-%ED%99%95%EC%9D%B8">Prometheus와 Grafana 접속해서 확인</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#monitoring--metrics">Monitoring &amp; Metrics</a>
<ul>
<li class="toc-entry toc-h3"><a href="#cilium-metrics-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EC%88%98%EC%A7%91-%EB%B0%A9%EB%B2%95">Cilium Metrics 설정 및 수집 방법</a></li>
<li class="toc-entry toc-h3"><a href="#hubble-metrics-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EC%88%98%EC%A7%91-%EB%B0%A9%EB%B2%95">Hubble Metrics 설정 및 수집 방법</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#layer-7-protocol-visibility">Layer 7 Protocol Visibility</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5">실습</a></li>
<li class="toc-entry toc-h3"><a href="#security-implications-%EB%B0%8F-%EC%8B%A4%EC%8A%B5">Security Implications 및 실습</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#pwru-packet-where-are-you">pwru (Packet where are you)</a>
<ul>
<li class="toc-entry toc-h3"><a href="#pwru-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EC%8B%A4%ED%96%89">pwru 설치 및 실행</a></li>
<li class="toc-entry toc-h3"><a href="#%EB%B9%8C%EB%93%9C-%ED%8A%B8%EB%9F%AC%EB%B8%94%EC%8A%88%ED%8C%85-%EB%B0%8F-%EC%8B%A4%ED%96%89">빌드 트러블슈팅 및 실행</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2025-07-27-Cilium-Week2/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2025-07-20-Cilium-Week1/">« [Cilium] 실습 환경 구성 및 Cilium 설치</a>
  
  
  <a class="next" href="/posts/2025-08-03-Cilium-Week3/">[Cilium] Networking - 노드의 파드들간 통신 상세 part 1 »</a>
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2025-07-27-Cilium-Week2/";
this.page.identifier = "/posts/Cilium - Week2";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>

<!--      <div class="adsbygoogle-side">-->
<!--        &lt;!&ndash; ad_side &ndash;&gt;-->
<!--        <ins class="adsbygoogle "-->
<!--             style="display: block"-->
<!--             data-ad-client="ca-pub-6564723532026864"-->
<!--             data-ad-slot="1339398797"-->
<!--             data-ad-format="auto"-->
<!--             data-full-width-responsive="true"></ins>-->
<!--      </div>-->
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>공부 기록과 개발 이야기를 담은 블로그입니다.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6564723532026864" crossorigin="anonymous"></script>
    <!--<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>-->
  </body>

</html>
