<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[Cilium] Networking - 노드의 파드들간 통신 상세 part 2 | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[Cilium] Networking - 노드의 파드들간 통신 상세 part 2">
<meta property="og:locale" content="ko">
<meta name="description" content="이번 포스트에서는 Overlay Network인 VXLAN을 통한 파드간 통신과 Kubernetes 서비스, LB-IPAM 등을 통한 통신을 살펴보겠습니다.">
<meta property="og:description" content="이번 포스트에서는 Overlay Network인 VXLAN을 통한 파드간 통신과 Kubernetes 서비스, LB-IPAM 등을 통한 통신을 살펴보겠습니다.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2025-08-10-Cilium-Week4/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2025-08-10-Cilium-Week4/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2025-08-10T00:10:18+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[Cilium] Networking - 노드의 파드들간 통신 상세 part 2">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-08-10T00:10:18+09:00","datePublished":"2025-08-10T00:10:18+09:00","description":"이번 포스트에서는 Overlay Network인 VXLAN을 통한 파드간 통신과 Kubernetes 서비스, LB-IPAM 등을 통한 통신을 살펴보겠습니다.","headline":"[Cilium] Networking - 노드의 파드들간 통신 상세 part 2","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2025-08-10-Cilium-Week4/"},"url":"https://sweetlittlebird.github.io/posts/2025-08-10-Cilium-Week4/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body class="body--contents">
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">소개</a><a class="page-link" href="/posts/">글 목록</a>
</div>
      </nav>
</div>
  
  <span id="scroll-indicator"></span>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[Cilium] Networking - 노드의 파드들간 통신 상세 part 2</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-08-10T00:10:18+09:00" itemprop="datePublished">2025년 08월 10일에 작성
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>목차</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#%EC%8B%A4%EC%8A%B5-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1">실습 환경 구성</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC-%ED%8C%8C%EC%9D%BC">실습환경 배포 파일</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%EB%B6%84%EC%84%9D-%ED%88%B4-%EC%84%A4%EC%B9%98">실습환경 배포 및 분석 툴 설치</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#native-routing-mode">Native Routing Mode</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%83%98%ED%94%8C-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%99%95%EC%9D%B8">샘플 애플리케이션 배포 및 확인</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%86%B5%EC%8B%A0-%ED%99%95%EC%9D%B8-%EB%B0%8F-hubble%EB%A1%9C-%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">통신 확인 및 hubble로 모니터링</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#overlay-network-encapsulated-mode">Overlay Network (Encapsulated) Mode</a>
<ul>
<li class="toc-entry toc-h3"><a href="#vxlan-%EC%84%A4%EC%A0%95">VXLAN 설정</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%8C%8C%EB%93%9C%EA%B0%84-%ED%86%B5%EC%8B%A0-%ED%99%95%EC%9D%B8">파드간 통신 확인</a></li>
<li class="toc-entry toc-h3">
<a href="#%EB%8F%84%EC%A0%84%EA%B3%BC%EC%A0%9C2-vxlan-%EB%8C%80%EC%8B%A0-geneve-%EB%AA%A8%EB%93%9C-%EC%82%AC%EC%9A%A9">도전과제2. VXLAN 대신 GENEVE 모드 사용</a>
<ul>
<li class="toc-entry toc-h4"><a href="#geneve-%EC%86%8C%EA%B0%9C">GENEVE 소개</a></li>
<li class="toc-entry toc-h4"><a href="#geneve-%EC%8B%A4%EC%8A%B5">GENEVE 실습</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#k8s-service">K8S Service</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EB%82%B4%EB%B6%80%EB%A5%BC-%EC%99%B8%EB%B6%80%EC%97%90-%EB%85%B8%EC%B6%9C%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95%EC%9D%98-%EB%B0%9C%EC%A0%84%EB%8B%A8%EA%B3%84">클러스터 내부를 외부에 노출하는 방법의 발전단계</a></li>
<li class="toc-entry toc-h3">
<a href="#service-%EC%A2%85%EB%A5%98">Service 종류</a>
<ul>
<li class="toc-entry toc-h4"><a href="#clusterip-%ED%83%80%EC%9E%85">ClusterIP 타입</a></li>
<li class="toc-entry toc-h4"><a href="#nodeport-%ED%83%80%EC%9E%85">NodePort 타입</a></li>
<li class="toc-entry toc-h4"><a href="#loadbalancer-%ED%83%80%EC%9E%85">LoadBalancer 타입</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4%EC%9D%98-%EA%B5%AC%EC%A1%B0">서비스의 구조</a></li>
<li class="toc-entry toc-h3">
<a href="#kube-proxy-%EB%AA%A8%EB%93%9C">kube-proxy 모드</a>
<ul>
<li class="toc-entry toc-h4"><a href="#userspace-proxy-%EB%AA%A8%EB%93%9C-%ED%98%84%EC%9E%AC%EB%8A%94-%EB%AF%B8%EC%82%AC%EC%9A%A9">userspace proxy 모드 (현재는 미사용)</a></li>
<li class="toc-entry toc-h4"><a href="#iptables-proxy-%EB%AA%A8%EB%93%9C">iptables proxy 모드</a></li>
<li class="toc-entry toc-h4"><a href="#ipvs-proxy-%EB%AA%A8%EB%93%9C">ipvs proxy 모드</a></li>
<li class="toc-entry toc-h4"><a href="#nftables-proxy-%EB%AA%A8%EB%93%9C">nftables proxy 모드</a></li>
<li class="toc-entry toc-h4"><a href="#ebpf-%EB%AA%A8%EB%93%9C--xdp">eBPF 모드 + XDP</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#service-lb-ipam">Service LB-IPAM</a></li>
<li class="toc-entry toc-h2">
<a href="#cilium-l2-announcement">Cilium L2 Announcement</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%B0%B8%EA%B3%A0-metallb-layer2-%EB%AA%A8%EB%93%9C">(참고) MetalLB Layer2 모드</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-layer-2-l2-announcement-using-arp">Cilium Layer 2 (L2) Announcement Using ARP</a></li>
<li class="toc-entry toc-h3"><a href="#service-lb-ipam-%EA%B8%B0%EB%8A%A5">Service LB-IPAM 기능</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
    </div>
    <h2 id="들어가며">들어가며</h2>

<p>이번 포스트에서는 Overlay Network인 VXLAN을 통한 파드간 통신과 Kubernetes 서비스의 외부 노출, LB-IPAM 등을 통한 통신을 살펴보겠습니다.</p>

<hr>

<h2 id="실습-환경-구성">실습 환경 구성</h2>

<ul>
  <li>이번 실습에서는 다음 그림과 같이 k8s-w0를 별도의 네트워크에 배치하고 router를 통해 k8s-w0와 k8s-ctr/w1 노드간 통신을 확인합니다.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_2.png" alt="img.png" class="image-center" loading="lazy" width="1810" height="1017">
    <ul>
      <li>기본 배포 가상 머신 : k8s-ctr, k8s-w1, k8s-w0, router</li>
      <li>
<strong>router</strong> : router : 192.168.10.0/24 ↔ 192.168.20.0/24 대역 라우팅 역할, k8s 에 join 되지 않은 서버, loop1/loop2 dump 인터페이스 배치</li>
      <li>
<strong>k8s-w0</strong> : k8s-ctr/w1 노드와 다른 네트워크 대역에 배치됩니다.</li>
      <li>실습 동작에 필요한 static routing이 설저된 상태로 배포 됩니다.</li>
      <li>Cilium CNI v1.18이 설치된 상태로 배포됩니다.</li>
    </ul>
  </li>
</ul>

<h3 id="실습환경-배포-파일">실습환경 배포 파일</h3>

<ul>
  <li>
    <p><strong>Vagrantfile</strong> : 가상머신 정의, 부팅 시 초기 프로비저닝 설정을 포함하는 Vagrantfile입니다.</p>

    <div class="language-ruby highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># Variables</span>
<span class="no">K8SV</span> <span class="o">=</span> <span class="s1">'1.33.2-1.1'</span> <span class="c1"># Kubernetes Version : apt list -a kubelet , ex) 1.32.5-1.1</span>
<span class="no">CONTAINERDV</span> <span class="o">=</span> <span class="s1">'1.7.27-1'</span> <span class="c1"># Containerd Version : apt list -a containerd.io , ex) 1.6.33-1</span>
<span class="no">CILIUMV</span> <span class="o">=</span> <span class="s1">'1.18.0'</span> <span class="c1"># Cilium CNI Version : https://github.com/cilium/cilium/tags</span>
<span class="no">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># max number of worker nodes</span>
  
<span class="c1"># Base Image  https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-24.04</span>
<span class="no">BOX_IMAGE</span> <span class="o">=</span> <span class="s2">"bento/ubuntu-24.04"</span>
<span class="no">BOX_VERSION</span> <span class="o">=</span> <span class="s2">"202502.21.0"</span>
  
<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
<span class="c1">#-ControlPlane Node</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-ctr"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
        
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">2560</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.100"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60000</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span> <span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/k8s-ctr.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">N</span><span class="p">,</span> <span class="no">CILIUMV</span><span class="p">,</span> <span class="no">K8SV</span> <span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/route-add1.sh"</span>
    <span class="k">end</span>
  
<span class="c1">#-Worker Nodes Subnet1</span>
  <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="no">N</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.10</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="s2">"6000</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/k8s-w.sh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/route-add1.sh"</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
<span class="c1">#-Router Node</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"router"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"router"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">768</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"router"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.200"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60009</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.20.200"</span><span class="p">,</span> <span class="ss">auto_config: </span><span class="kp">false</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/router.sh"</span>
    <span class="k">end</span>
  
<span class="c1">#-Worker Nodes Subnet2</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w0"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w0"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w0"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.20.100"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60010</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/k8s-w.sh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/route-add2.sh"</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>init_cfg.sh</strong> : args 참고하여 초기 설정을 수행하는 스크립트입니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime <span class="c"># Change Timezone</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Disable and turn off SWAP"</span>
swapoff <span class="nt">-a</span> <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'/swap/s/^/#/'</span> /etc/fstab
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Install Packages"</span>
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>apt-transport-https ca-certificates curl gpg <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># Download the public signing key for the Kubernetes package repositories.</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nt">-m</span> 755 /etc/apt/keyrings
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$1</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+)\..*/\1/p'</span><span class="si">)</span>
curl <span class="nt">-fsSL</span> https://pkgs.k8s.io/core:/stable:/v<span class="nv">$K8SMMV</span>/deb/Release.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/kubernetes-apt-keyring.gpg
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v</span><span class="nv">$K8SMMV</span><span class="s2">/deb/ /"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list.d/kubernetes.list
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
  
<span class="c"># packets traversing the bridge are processed by iptables for filtering</span>
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
<span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> <span class="o">&gt;&gt;</span> /etc/sysctl.d/k8s.conf
  
<span class="c"># enable br_netfilter for iptables </span>
modprobe br_netfilter
modprobe overlay
<span class="nb">echo</span> <span class="s2">"br_netfilter"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
<span class="nb">echo</span> <span class="s2">"overlay"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)"</span>
<span class="c"># Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version</span>
apt update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># apt list -a kubelet ; apt list -a containerd.io</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubectl</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubeadm</span><span class="o">=</span><span class="nv">$1</span> containerd.io<span class="o">=</span><span class="nv">$2</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-mark hold kubelet kubeadm kubectl <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># containerd configure to default and cgroup managed by systemd</span>
containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SystemdCgroup = false/SystemdCgroup = true/g'</span> /etc/containerd/config.toml
  
<span class="c"># avoid WARN&amp;ERRO(default endpoints) when crictl run  </span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
</span><span class="no">EOF
  
</span><span class="c"># ready to install for k8s </span>
systemctl restart containerd <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable </span>containerd
systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Packages &amp; Helm"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get <span class="nb">install</span> <span class="nt">-y</span> bridge-utils sshpass net-tools conntrack ngrep tcpdump ipset arping wireguard jq yq tree bash-completion unzip kubecolor termshark <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
curl <span class="nt">-s</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>k8s-ctr.sh</strong> : kubeadm init를 통하여 kubernetes controlplane 노드를 설정하고 Cilium CNI 설치, 편리성 설정(k, kc)하는 스크립트입니다. local-path-storageclass와 metrics-server도 설치합니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Initial Kubernetes"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-init-ctr-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/kubeadm-init-ctr-config.yaml
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$3</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/p'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/K8S_VERSION_PLACEHOLDER/v</span><span class="k">${</span><span class="nv">K8SMMV</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-init-ctr-config.yaml
kubeadm init <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-init-ctr-config.yaml"</span>  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Setting kube config file"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /root/.kube
<span class="nb">cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf /root/.kube/config
<span class="nb">chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> /root/.kube/config
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Source the completion"</span>
<span class="nb">echo</span> <span class="s1">'source &lt;(kubectl completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'source &lt;(kubeadm completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Alias kubectl to k"</span>
<span class="nb">echo</span> <span class="s1">'alias k=kubectl'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'alias kc=kubecolor'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'complete -F __start_kubectl k'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubectx &amp; Kubens"</span>
git clone https://github.com/ahmetb/kubectx /opt/kubectx <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubens /usr/local/bin/kubens
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubectx /usr/local/bin/kubectx
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Kubeps &amp; Setting PS1"</span>
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1 <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">"</span><span class="no">EOT</span><span class="sh">" &gt;&gt; /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
function get_cluster_short() {
  echo "</span><span class="nv">$1</span><span class="sh">" | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=') '
PS1='</span><span class="si">$(</span>kube_ps1<span class="si">)</span><span class="sh">'</span><span class="nv">$PS1</span><span class="sh">
</span><span class="no">EOT
</span>kubectl config rename-context <span class="s2">"kubernetes-admin@kubernetes"</span> <span class="s2">"HomeLab"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 7] Install Cilium CNI"</span>
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
helm repo add cilium https://helm.cilium.io/ <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm repo update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> <span class="nv">$2</span> <span class="nt">--namespace</span> kube-system <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.100 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="se">\</span>
<span class="nt">--set</span> ipam.mode<span class="o">=</span><span class="s2">"cluster-pool"</span> <span class="nt">--set</span> ipam.operator.clusterPoolIPv4PodCIDRList<span class="o">={</span><span class="s2">"172.20.0.0/16"</span><span class="o">}</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>172.20.0.0/16 <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>30003 <span class="se">\</span>
<span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span> <span class="se">\</span>
<span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 8] Install Cilium / Hubble CLI"</span>
<span class="nv">CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz
  
<span class="nv">HUBBLE_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="si">)</span>
<span class="nv">HUBBLE_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">HUBBLE_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/hubble/releases/download/<span class="nv">$HUBBLE_VERSION</span>/hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 9] Remove node taint"</span>
kubectl taint nodes k8s-ctr node-role.kubernetes.io/control-plane-
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 10] local DNS with hosts file"</span>
<span class="nb">echo</span> <span class="s2">"192.168.10.100 k8s-ctr"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.10.200 router"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.20.100 k8s-w0"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;<span class="o">=</span><span class="nv">$1</span><span class="p">;</span> i++  <span class="o">))</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"192.168.10.10</span><span class="nv">$i</span><span class="s2"> k8s-w</span><span class="nv">$i</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts<span class="p">;</span> <span class="k">done
  
  
</span><span class="nb">echo</span> <span class="s2">"[TASK 11] Dynamically provisioning persistent local storage with Kubernetes"</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.31/deploy/local-path-storage.yaml <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch storageclass local-path <span class="nt">-p</span> <span class="s1">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 12] Install Prometheus &amp; Grafana"</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.0/examples/kubernetes/addons/prometheus/monitoring-example.yaml <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch svc <span class="nt">-n</span> cilium-monitoring prometheus <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 9090, "targetPort": 9090, "nodePort": 30001}]}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch svc <span class="nt">-n</span> cilium-monitoring grafana <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort", "ports": [{"port": 3000, "targetPort": 3000, "nodePort": 30002}]}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># echo "[TASK 12] Install Prometheus Stack"</span>
<span class="c"># helm repo add prometheus-community https://prometheus-community.github.io/helm-charts  &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># cat &lt;&lt;EOT &gt; monitor-values.yaml</span>
<span class="c"># prometheus:</span>
<span class="c">#   prometheusSpec:</span>
<span class="c">#     scrapeInterval: "15s"</span>
<span class="c">#     evaluationInterval: "15s"</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30001</span>
  
<span class="c"># grafana:</span>
<span class="c">#   defaultDashboardsTimezone: Asia/Seoul</span>
<span class="c">#   adminPassword: prom-operator</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30002</span>
  
<span class="c"># alertmanager:</span>
<span class="c">#   enabled: false</span>
<span class="c"># defaultRules:</span>
<span class="c">#   create: false</span>
<span class="c"># prometheus-windows-exporter:</span>
<span class="c">#   prometheus:</span>
<span class="c">#     monitor:</span>
<span class="c">#       enabled: false</span>
<span class="c"># EOT</span>
<span class="c"># helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack --version 75.15.1 \</span>
<span class="c">#   -f monitor-values.yaml --create-namespace --namespace monitoring  &gt;/dev/null 2&gt;&amp;1</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 13] Install Metrics-server"</span>
helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm upgrade <span class="nt">--install</span> metrics-server metrics-server/metrics-server <span class="nt">--set</span> <span class="s1">'args[0]=--kubelet-insecure-tls'</span> <span class="nt">-n</span> kube-system  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 14] Install k9s"</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>wget https://github.com/derailed/k9s/releases/latest/download/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb <span class="nt">-O</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt <span class="nb">install</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p><strong>kubeadm-init-ctr-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  apiVersion: kubeadm.k8s.io/v1beta4
  kind: InitConfiguration
  bootstrapTokens:
  - token: <span class="s2">"123456.1234567890123456"</span>
    ttl: <span class="s2">"0s"</span>
    usages:
    - signing
    - authentication
  localAPIEndpoint:
    advertiseAddress: <span class="s2">"192.168.10.100"</span>
  nodeRegistration:
    kubeletExtraArgs:
      - name: node-ip
        value: <span class="s2">"192.168.10.100"</span>
    criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
  <span class="nt">---</span>
  apiVersion: kubeadm.k8s.io/v1beta4
  kind: ClusterConfiguration
  kubernetesVersion: <span class="s2">"K8S_VERSION_PLACEHOLDER"</span>
  networking:
    podSubnet: <span class="s2">"10.244.0.0/16"</span>
    serviceSubnet: <span class="s2">"10.96.0.0/16"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
<strong>k8s-w.sh</strong> : kubernetes worker 노드 설정, kubeadm join 등을 수행하는  스크립트입니다.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;"</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] K8S Controlplane Join"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-join-worker-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-join-worker-config.yaml
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/NODE_IP_PLACEHOLDER/</span><span class="k">${</span><span class="nv">NODEIP</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-join-worker-config.yaml
kubeadm <span class="nb">join</span> <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-join-worker-config.yaml"</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
    <ul>
      <li>
        <p><strong>kubeadm-join-worker-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>apiVersion: kubeadm.k8s.io/v1beta4
kind: JoinConfiguration
discovery:
  bootstrapToken:
    token: <span class="s2">"123456.1234567890123456"</span>
    apiServerEndpoint: <span class="s2">"192.168.10.100:6443"</span>
    unsafeSkipCAVerification: <span class="nb">true
</span>nodeRegistration:
  criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
  kubeletExtraArgs:
    - name: node-ip
      value: <span class="s2">"NODE_IP_PLACEHOLDER"</span>    
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>route-add1.sh</strong> : k8s node 들이 내부망과 통신을 위한 route 설정 스크립트입니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt;&gt; /etc/netplan/50-vagrant.yaml
      routes:
      - to: 192.168.20.0/24
        via: 192.168.10.200
      - to: 172.20.0.0/16
        via: 192.168.10.200
      - to: 10.10.0.0/16
        via: 192.168.10.200
</span><span class="no">EOT
  
</span>netplan apply
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>route-add2.sh</strong> : k8s node 들이 내부망과 통신을 위한 route 설정 스크립트입니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt;&gt; /etc/netplan/50-vagrant.yaml
      routes:
      - to: 192.168.10.0/24
        via: 192.168.20.200
      - to: 172.20.0.0/16
        via: 192.168.20.200
      - to: 10.10.0.0/16
        via: 192.168.20.200
</span><span class="no">EOT
  
</span>netplan apply
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>router.sh</strong> : router 역할과 추가적으로 웹서버 역할을 하는 서버의 초기 설정을 담당합니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 0] Setting eth2"</span>
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOT</span><span class="sh"> &gt;&gt; /etc/netplan/50-vagrant.yaml
    eth2:
      addresses:
      - 192.168.20.200/24
</span><span class="no">EOT
  
</span>netplan apply
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Add Kernel setting - IP Forwarding"</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g'</span> /etc/sysctl.conf
sysctl <span class="nt">-p</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Setting Dummy Interface"</span>
modprobe dummy
ip <span class="nb">link </span>add loop1 <span class="nb">type </span>dummy
ip <span class="nb">link set </span>loop1 up
ip addr add 10.10.1.200/24 dev loop1
  
ip <span class="nb">link </span>add loop2 <span class="nb">type </span>dummy
ip <span class="nb">link set </span>loop2 up
ip addr add 10.10.2.200/24 dev loop2
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Packages"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>net-tools jq yq tree ngrep tcpdump arping termshark <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Apache"</span>
apt <span class="nb">install </span>apache2 <span class="nt">-y</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"&lt;h1&gt;Web Server : </span><span class="si">$(</span><span class="nb">hostname</span><span class="si">)</span><span class="s2">&lt;/h1&gt;"</span> <span class="o">&gt;</span> /var/www/html/index.html
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="실습환경-배포-및-분석-툴-설치">실습환경 배포 및 분석 툴 설치</h3>

<ul>
  <li>
    <p>실습환경 배포</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vagrant up
<span class="c"># =&gt; ...    </span>
<span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;</span>
<span class="c">#    ==&gt; k8s-w0: Running provisioner: shell...</span>
<span class="c">#        k8s-w0: Running: /var/folders/7k/qy6rsdds57z3tmyn9_7hhd8r0000gn/T/vagrant-shell20250807-27868-fg24bd.sh</span>
<span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;</span>
<span class="c">#        k8s-w0: [TASK 1] K8S Controlplane Join</span>
<span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;</span>
<span class="c">#    ==&gt; k8s-w0: Running provisioner: shell...</span>
<span class="c">#        k8s-w0: Running: /var/folders/7k/qy6rsdds57z3tmyn9_7hhd8r0000gn/T/vagrant-shell20250807-27868-fzndov.sh</span>
<span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;</span>
<span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>기본정보 확인</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s-ctr 노드에 접속</span>
<span class="nv">$ </span>vagrant ssh k8s-ctr

<span class="nt">---------------------------------</span>

<span class="c"># k9s 설치</span>
<span class="nv">$ CLI_ARCH</span><span class="o">=</span>amd64
<span class="nv">$ </span><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi</span>
<span class="nv">$ </span>wget https://github.com/derailed/k9s/releases/latest/download/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb <span class="nt">-O</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb
<span class="nv">$ </span>apt <span class="nb">install</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb
<span class="nv">$ </span>k9s <span class="c"># node/pod 정보 확인 - metrics-server 설치되어 있어서, cpu/mem 확인 가능</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
<span class="c"># =&gt; 127.0.2.1 k8s-ctr k8s-ctr</span>
<span class="c">#    192.168.10.100 k8s-ctr</span>
<span class="c">#    192.168.20.100 k8s-w0</span>
<span class="c">#    192.168.10.101 k8s-w1</span>
<span class="c">#    192.168.10.200 router</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-w0 <span class="nb">hostname</span>
<span class="c"># =&gt; k8s-w0</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s-w0는 k8s-ctr과 다른 네트워크에 있지만 정적 route 설정이 되어 있어서 접속이 가능합니다.&lt;/span&gt;</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@k8s-w1 <span class="nb">hostname</span>
<span class="c"># =&gt; k8s-w1</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@router <span class="nb">hostname</span>
<span class="c"># =&gt; router</span>

<span class="c"># 클러스터 정보 확인</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://192.168.10.100:6443</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt;                             "--service-cluster-ip-range=10.96.0.0/16",</span>
<span class="c">#                                "--cluster-cidr=10.244.0.0/16",                           </span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubeadm-config
<span class="c"># =&gt; ...</span>
<span class="c">#      podSubnet: 10.244.0.0/16</span>
<span class="c">#      serviceSubnet: 10.96.0.0/16</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubelet-config

<span class="c"># 노드 정보 : 상태, INTERNAL-IP 확인</span>
<span class="nv">$ </span>ifconfig | <span class="nb">grep</span> <span class="nt">-iEA1</span> <span class="s1">'eth[0-9]:'</span>
<span class="c"># =&gt; eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255</span>
<span class="c">#    --</span>
<span class="c">#    eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 192.168.10.100  netmask 255.255.255.0  broadcast 192.168.10.255</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME      STATUS   ROLES           AGE     VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    k8s-ctr   Ready    control-plane   9m41s   v1.33.2   192.168.10.100   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w0    Ready    &lt;none&gt;          4m37s   v1.33.2   192.168.20.100   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w1    Ready    &lt;none&gt;          7m13s   v1.33.2   192.168.10.101   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27</span>

<span class="c"># 파드 정보 : 상태, 파드 IP 확인</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'</span>
<span class="c"># =&gt; k8s-ctr 10.244.0.0/24</span>
<span class="c">#    k8s-w0  10.244.3.0/24</span>
<span class="c">#    k8s-w1  10.244.1.0/24</span>
<span class="nv">$ </span>kubectl get ciliumnode <span class="nt">-o</span> json | <span class="nb">grep </span>podCIDRs <span class="nt">-A2</span>
<span class="c"># =&gt;                     "podCIDRs": [</span>
<span class="c">#                            "172.20.0.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "172.20.2.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "172.20.1.0/24"</span>
<span class="c">#                        ],</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      READY   STATUS    RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    cilium-monitoring    grafana-5c69859d9-n82rg                   1/1     Running   0          10m     172.20.0.209     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    cilium-monitoring    prometheus-6fc896bc5d-m82wl               1/1     Running   0          10m     172.20.0.230     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-c8265                              1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-envoy-2x4fb                        1/1     Running   0          7m54s   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-envoy-fktjl                        1/1     Running   0          5m18s   192.168.20.100   k8s-w0    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-envoy-gw7cw                        1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-h5k5g                              1/1     Running   0          5m18s   192.168.20.100   k8s-w0    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-operator-76788cffb7-8nhzr          1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-tzlkp                              1/1     Running   0          7m54s   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-bkc4b                  1/1     Running   0          10m     172.20.0.42      k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-jdxtw                  1/1     Running   0          10m     172.20.0.185     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          etcd-k8s-ctr                              1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          hubble-relay-5b48c999f9-vh8jq             1/1     Running   0          10m     172.20.0.156     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          hubble-ui-655f947f96-vv266                2/2     Running   0          10m     172.20.0.147     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-apiserver-k8s-ctr                    1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-controller-manager-k8s-ctr           1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-5qw8d                          1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-7z4ds                          1/1     Running   0          7m54s   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-twtfn                          1/1     Running   0          5m18s   192.168.20.100   k8s-w0    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-scheduler-k8s-ctr                    1/1     Running   0          10m     192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          metrics-server-5dd7b49d79-25cdj           1/1     Running   0          9m59s   172.20.0.253     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-rxvrq   1/1     Running   0          10m     172.20.0.103     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    cilium-monitoring    grafana-5c69859d9-n82rg                   9513                ready            172.20.0.209</span>
<span class="c">#    cilium-monitoring    prometheus-6fc896bc5d-m82wl               47077               ready            172.20.0.230</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-bkc4b                  2750                ready            172.20.0.42</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-jdxtw                  2750                ready            172.20.0.185</span>
<span class="c">#    kube-system          hubble-relay-5b48c999f9-vh8jq             17251               ready            172.20.0.156</span>
<span class="c">#    kube-system          hubble-ui-655f947f96-vv266                10805               ready            172.20.0.147</span>
<span class="c">#    kube-system          metrics-server-5dd7b49d79-25cdj           14866               ready            172.20.0.253</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-rxvrq   11456               ready            172.20.0.103</span>

<span class="c"># ipam 모드 확인</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> ^ipam
<span class="c"># =&gt; ipam                                              cluster-pool</span>

<span class="c"># iptables 확인</span>
<span class="nv">$ </span>iptables-save
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span>
</code></pre></div></div>

<ul>
  <li>[k8s-ctr] cilium 설치정보 확인</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium 상태 확인</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq
<span class="nv">$ </span>cilium status
<span class="nv">$ </span>cilium config view
<span class="c"># =&gt; ...</span>
<span class="c">#    auto-direct-node-routes                           true</span>
<span class="c">#    ...</span>
<span class="c">#    routing-mode                                      native</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg status <span class="nt">--verbose</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg metrics list

<span class="c"># monitor</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">-v</span>

<span class="c">## Filter for only the events related to endpoint</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">--related-to</span><span class="o">=</span>&lt;<span class="nb">id</span><span class="o">&gt;</span>

<span class="c">## Show notifications only for dropped packet events</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">--type</span> drop

<span class="c">## Don’t dissect packet payload, display payload in hex information</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">-v</span> <span class="nt">--hex</span>

<span class="c">## Layer7</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">--type</span> l7
</code></pre></div></div>

<ul>
  <li>네트워크 정보 확인 : <code class="language-plaintext highlighter-rouge">autoDirectNodeRoutes=true</code> 동작 이해</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># router 네트워크 인터페이스 정보 확인</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr
<span class="c"># =&gt; lo               UNKNOWN        127.0.0.1/8</span>
<span class="c">#    eth0             UP             10.0.2.15/24 metric 100</span>
<span class="c">#    eth1             UP             192.168.10.200/24</span>
<span class="c">#    eth2             UP             192.168.20.200/24</span>
<span class="c">#    loop1            UNKNOWN        10.10.1.200/24</span>
<span class="c">#    loop2            UNKNOWN        10.10.2.200/24</span>

<span class="c"># k8s node 네트워크 인터페이스 정보 확인</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth1
<span class="c"># =&gt; 3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet 192.168.10.100/24 brd 192.168.10.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth1
<span class="c"># =&gt; 3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet 192.168.10.101/24 brd 192.168.10.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w0 ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth1
<span class="c"># =&gt; 3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet 192.168.20.100/24 brd 192.168.20.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># 라우팅 정보 확인</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.10.1.0/24 dev loop1 proto kernel scope link src 10.10.1.200</span>
<span class="c">#    10.10.2.0/24 dev loop2 proto kernel scope link src 10.10.2.200</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.200</span>
<span class="c">#    192.168.20.0/24 dev eth2 proto kernel scope link src 192.168.20.200</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>static
<span class="c"># =&gt; 10.10.0.0/16 via 192.168.10.200 dev eth1 proto static</span>
<span class="c">#    172.20.0.0/16 via 192.168.10.200 dev eth1 proto static</span>
<span class="c">#    192.168.20.0/24 via 192.168.10.200 dev eth1 proto static</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 192.168.10.0/24와 192.168.20.0/24 네트워크의 routing 등을 위해서 router에 static route 설정이 되어 있습니다.&lt;/span&gt;</span>

<span class="c">## --set routingMode=native --set autoDirectNodeRoutes=true 동작을 정확히 이해해보자!</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; 10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.10.0.0/16 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    172.20.0.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.0.0/16 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    172.20.0.201 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.1.0/24 via 192.168.10.101 dev eth1 proto kernel</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100</span>
<span class="c">#    &lt;span style="color: green;"&gt;192.168.20.0/24 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.10.0.0/16 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    172.20.0.0/24 via 192.168.10.100 dev eth1 proto kernel</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.0.0/16 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    172.20.1.0/24 via 172.20.1.197 dev cilium_host proto kernel src 172.20.1.197</span>
<span class="c">#    172.20.1.197 dev cilium_host proto kernel scope link</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.101</span>
<span class="c">#    &lt;span style="color: green;"&gt;192.168.20.0/24 via 192.168.10.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w0 ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.10.0.0/16 via 192.168.20.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.0.0/16 via 192.168.20.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    172.20.2.0/24 via 172.20.2.25 dev cilium_host proto kernel src 172.20.2.25</span>
<span class="c">#    172.20.2.25 dev cilium_host proto kernel scope link</span>
<span class="c">#    &lt;span style="color: green;"&gt;192.168.10.0/24 via 192.168.20.200 dev eth1 proto static&lt;/span&gt;</span>
<span class="c">#    192.168.20.0/24 dev eth1 proto kernel scope link src 192.168.20.100</span>

<span class="c"># 통신 확인</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 10.10.1.200     <span class="c"># router loop1 </span>
<span class="c"># =&gt; PING 10.10.1.200 (10.10.1.200) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 10.10.1.200: icmp_seq=1 ttl=64 time=0.780 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 10.10.1.200 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 0.780/0.780/0.780/0.000 ms</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 192.168.20.100  <span class="c"># k8s-w0 eth1</span>
<span class="c"># =&gt; PING 192.168.20.100 (192.168.20.100) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.20.100: icmp_seq=1 ttl=63 time=1.82 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.20.100 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.821/1.821/1.821/0.000 ms</span>

<span class="c"># 목적지까지 경우하는 라우팅 정보 제공</span>
<span class="c">## Path MTU (pmtu): 출발지에서 목적지까지 모든 네트워크 경로 상에서 통과할 수 있는 최대 패킷 크기(Byte), IP fragmentation 없이 전송 가능한 가장 큰 패킷 크기를 의미.</span>
<span class="c">## pmtu 1500: 전체 경로의 최소 MTU는 1500 , hops 2: 총 2단계 라우터/노드를 거쳐서 도달 , back 2: 응답도 동일한 hop 수로 돌아옴 </span>
<span class="nv">$ </span>tracepath <span class="nt">-n</span> 192.168.20.100
<span class="c"># =&gt;  1?: [LOCALHOST]                      pmtu 1500</span>
<span class="c">#     1:  192.168.10.200                                        2.759ms</span>
<span class="c">#     1:  192.168.10.200                                        0.994ms</span>
<span class="c">#     2:  192.168.20.100                                        1.461ms reached</span>
<span class="c">#         Resume: pmtu 1500 hops 2 back 2</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s-ctr(192.168.10.100)에서 k8s-w0(192.168.20.100)은 다른 네트워크이기 때문에&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   직접적으로 통신할 수 없고, router(192.168.10.200)를 거쳐서 routing되어 통신이 됩니다.&lt;/span&gt;</span>
</code></pre></div></div>

<hr>

<h2 id="native-routing-mode">Native Routing Mode</h2>

<h3 id="샘플-애플리케이션-배포-및-확인">샘플 애플리케이션 배포 및 확인</h3>

<ul>
  <li>샘플 애플리케이션 배포 : <code class="language-plaintext highlighter-rouge">cilium-dbg</code>
</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 샘플 애플리케이션 배포</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># k8s-ctr 노드에 curl-pod 파드 배포</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>
</code></pre></div></div>

<ul>
  <li>확인</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 배포 확인</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   3/3     3            3           53s   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.129.95   &lt;none&gt;        80/TCP    53s   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                                        AGE</span>
<span class="c">#    endpoints/webpod   172.20.0.131:80,172.20.1.217:80,172.20.2.73:80   53s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="c"># =&gt; NAME           ADDRESSTYPE   PORTS   ENDPOINTS                               AGE</span>
<span class="c">#    webpod-njp7j   IPv4          80      172.20.0.131,172.20.2.73,172.20.1.217   65s</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="c"># IP 확인</span>
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  21500               ready            172.20.0.89</span>
<span class="c">#    webpod-697b545f57-b46tz   17081               ready            172.20.0.131          # &lt;span style="color: green;"&gt;k8s-wctr&lt;/span&gt;</span>
<span class="c">#    webpod-697b545f57-66grn   17081               ready            172.20.1.217          # &lt;span style="color: green;"&gt;k8s-w1&lt;/span&gt;</span>
<span class="c">#    webpod-697b545f57-24ck5   17081               ready            172.20.2.73           # &lt;span style="color: green;"&gt;k8s-w0&lt;/span&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg ip list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg endpoint list

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg service list
<span class="c"># =&gt; ...</span>
<span class="c">#    20   10.96.129.95:80/TCP     ClusterIP      1 =&gt; 172.20.0.131:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 172.20.1.217:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; 172.20.2.73:80/TCP (active)</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf lb list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf lb list | <span class="nb">grep </span>10.96.129.95
<span class="c"># =&gt; 10.96.129.95:80/TCP (3)        172.20.2.73:80/TCP (20) (3)</span>
<span class="c">#    10.96.129.95:80/TCP (0)        0.0.0.0:0 (20) (0) [ClusterIP, non-routable]</span>
<span class="c">#    10.96.129.95:80/TCP (1)        172.20.0.131:80/TCP (20) (1)</span>
<span class="c">#    10.96.129.95:80/TCP (2)        172.20.1.217:80/TCP (20) (2)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 cilium의 load balancer가 각 파드의 IP을 확인하고, 해당 IP로 요청을 전달합니다.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf nat list

<span class="c"># map</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map list | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'0             0'</span>
<span class="c"># =&gt; Name                           Num entries   Num errors   Cache enabled</span>
<span class="c">#    cilium_policy_v2_03166         3             0            true</span>
<span class="c">#    cilium_policy_v2_01270         3             0            true</span>
<span class="c">#    cilium_policy_v2_01641         3             0            true</span>
<span class="c">#    cilium_policy_v2_01688         3             0            true</span>
<span class="c">#    cilium_lb4_reverse_nat         20            0            true</span>
<span class="c">#    cilium_lxc                     13            0            true</span>
<span class="c">#    cilium_policy_v2_02965         3             0            true</span>
<span class="c">#    cilium_runtime_config          256           0            true</span>
<span class="c">#    cilium_ipcache_v2              22            0            true</span>
<span class="c">#    cilium_policy_v2_00459         2             0            true</span>
<span class="c">#    cilium_policy_v2_00222         3             0            true</span>
<span class="c">#    cilium_policy_v2_03535         3             0            true</span>
<span class="c">#    cilium_policy_v2_02230         3             0            true</span>
<span class="c">#    cilium_lb4_services_v2         45            0            true</span>
<span class="c">#    cilium_lb4_backends_v3         16            0            true</span>
<span class="c">#    cilium_lb4_reverse_sk          9             0            true</span>
<span class="c">#    cilium_policy_v2_00745         3             0            true</span>
<span class="c">#    cilium_policy_v2_01678         3             0            true</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_services_v2
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_services_v2 | <span class="nb">grep </span>10.96.129.95
<span class="c"># =&gt; Key                            Value                     State   Error</span>
<span class="c">#    10.96.129.95:80/TCP (3)        15 0[0] (20) [0x0 0x0]</span>
<span class="c">#    10.96.129.95:80/TCP (2)        16 0[0] (20) [0x0 0x0]</span>
<span class="c">#    10.96.129.95:80/TCP (0)        0 3[0] (20) [0x0 0x0]</span>
<span class="c">#    10.96.129.95:80/TCP (1)        14 0[0] (20) [0x0 0x0]   </span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_backends_v3
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_reverse_nat
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_ipcache_v2
</code></pre></div></div>

<h3 id="통신-확인-및-hubble로-모니터링">통신 확인 및 hubble로 모니터링</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 통신 확인 : 문제 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-66grn</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; ---</span>
<span class="c">#    Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-66grn</span>
<span class="c">#    ---  # &lt;span style="color: green;"&gt;👉 k8s-w0 노드에 배포된 webpod 파드에 대해서는 통신이 되지 않습니다.&lt;/span&gt;</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s-ctr 노드와 k8s-w1 노드에 배포된 webpod 파드에 대해서는 통신이 되지만,&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   k8s-w0 노드에 배포된 webpod 파드에 대해서는 통신이 되지 않습니다.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   왜냐하면, 노드간의 통신은 router에서 정적 라우팅을 통해 통신이 가능하지만,&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   파드 간의 통신에 대해서는 routing 처리가 되어있지 않기 때문입니다.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   이번 포스트에서는 Encapsulation Mode를 통해 이 문제를 해결해보고&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   다음 포스트에서 Native Routing Mode를 통해 이 문제를 해결해보겠습니다.&lt;/span&gt;</span>

<span class="c"># k8s-w0 노드에 배포된 webpod 파드 IP 지정</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPOD</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w0 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; 172.20.2.73</span>

<span class="c"># 신규 터미널 [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>

<span class="c"># </span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$WEBPOD</span>

<span class="c"># 신규 터미널 [router] : 라우팅이 어떻게 되는가?</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>
<span class="c"># =&gt; 14:29:00.156370 eth1  In  IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 35, seq 1, length 64</span>
<span class="c">#    14:29:00.156388 eth0  Out IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 35, seq 1, length 64</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s-ctr 노드의 파드(172.20.0.89)에서 k8s-w0 노드의 파드(172.20.2.73)로 ping을 보내면,&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   서로간의 라우팅이 되어있지 않기 때문에 ping이 실패합니다.&lt;/span&gt;</span>

<span class="c"># 신규 터미널 [router]</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="nv">$ </span>ip route get 172.20.2.36   <span class="c"># &lt;span style="color: green;"&gt;👉 172.20.2.36으로 통신할때 사용되는 라우팅 정보 확인하는 명령어&lt;/span&gt;</span>
<span class="c"># =&gt; 172.20.2.36 via 10.0.2.2 dev eth0 src 10.0.2.15 uid 0</span>

<span class="c"># [k8s-ctr]에서 반복 호출</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>

<span class="c"># 신규 터미널 [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nn</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s-w0노드의 파드로 통신을 시도하여 통신이 안 될 때 마다 router의 tcpdump에 통신이 안 되는 로그가 찍힙니다.&lt;/span&gt;</span>

<span class="c"># hubble 확인</span>
<span class="c"># hubble ui 웹 접속 주소 확인 : default 네임스페이스 확인</span>
<span class="nv">$ NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"http://</span><span class="nv">$NODEIP</span><span class="s2">:30003"</span>
<span class="c"># =&gt; http://192.168.10.100:30003</span>

<span class="c"># hubble relay 포트 포워딩 실행</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; ℹ️  Hubble Relay is available at 127.0.0.1:4245</span>
<span class="nv">$ </span>hubble status
<span class="c"># =&gt; Healthcheck (via localhost:4245): Ok</span>

<span class="c"># flow log 모니터링</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--pod</span> curl-pod
<span class="c"># =&gt; ...</span>
<span class="c">#    Aug  9 05:38:54.615: default/curl-pod:46490 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Aug  9 05:38:54.618: default/curl-pod:46490 (ID:21500) &lt;- default/webpod-697b545f57-66grn:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Aug  9 05:38:54.618: default/curl-pod:46490 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Aug  9 05:38:55.627: default/curl-pod (ID:21500) &lt;&gt; 10.96.129.95:80 (world) pre-xlate-fwd TRACED (TCP)</span>
<span class="c">#    Aug  9 05:38:55.627: default/curl-pod (ID:21500) &lt;&gt; &lt;span style="color: green;"&gt;default/webpod-697b545f57-24ck5:80&lt;/span&gt; (ID:17081) post-xlate-fwd TRANSLATED (TCP)</span>
<span class="c">#    Aug  9 05:38:55.628: default/curl-pod:37198 (ID:21500) -&gt; &lt;span style="color: green;"&gt;default/webpod-697b545f57-24ck5:80&lt;/span&gt; (ID:17081) to-network FORWARDED &lt;span style="color: green;"&gt;(TCP Flags: SYN)&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;👉 k8s-w0 노드에 배포된 webpod 파드(default/webpod-697b545f57-24ck5)로 통신을 시도할 때,&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;    라우팅이 되지 않아 SYN 패킷에 대한 ACK 패킷이 오지 않기 때문에, 통신이 되지 않습니다.&lt;/span&gt;</span>
<span class="c">#    Aug  9 05:38:57.528: default/curl-pod:46498 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Aug  9 05:38:57.528: default/curl-pod:46498 (ID:21500) &lt;- default/webpod-697b545f57-66grn:80 (ID:17081) to-network FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Aug  9 05:38:57.528: default/curl-pod:46498 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Aug  9 05:38:57.529: default/curl-pod:46498 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
</code></pre></div></div>

<hr>

<h2 id="overlay-network-encapsulated-mode">Overlay Network (Encapsulated) Mode</h2>

<ul>
  <li>앞에서 살펴본 것과 같이 k8s-ctr 노드와 k8s-w0 노드가 다른 네트워크에 있는 경우,
라우팅 장비에서 라우팅 룰을 추가해서 노드간에는 통신이 가능하지만,
파드 간의 통신은 라우팅 룰이 없기 때문에 통신이 되지 않습니다.</li>
  <li>이러한 경우에도 파드 간의 통신을 가능하게 하기 위해서 Cilium에서는 Overlay Network(Encapsulated) Mode를 제공합니다.</li>
  <li>VXLAN과 GENEVE 등을 지원하는데, 이번 포스트에서는 VXLAN을 통해 통신이 되도록 해보겠습니다.</li>
</ul>

<h3 id="vxlan-설정">VXLAN 설정</h3>

<p><a href="https://docs.cilium.io/en/stable/network/concepts/routing/">Docs</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [커널 구성 옵션] Requirements for Tunneling and Routing</span>
<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'CONFIG_VXLAN=y|CONFIG_VXLAN=m|CONFIG_GENEVE=y|CONFIG_GENEVE=m|CONFIG_FIB_RULES=y'</span> /boot/config-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>
<span class="nv">CONFIG_FIB_RULES</span><span class="o">=</span>y <span class="c"># 커널에 내장됨</span>
<span class="nv">CONFIG_VXLAN</span><span class="o">=</span>m <span class="c"># 모듈로 컴파일됨 → 커널에 로드해서 사용</span>
<span class="nv">CONFIG_GENEVE</span><span class="o">=</span>m <span class="c"># 모듈로 컴파일됨 → 커널에 로드해서 사용</span>

<span class="c">#  커널 로드</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span>
<span class="nv">$ </span>modprobe vxlan <span class="c"># modprobe geneve</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span>
<span class="c"># =&gt; vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  1 vxlan</span>
<span class="c">#    udp_tunnel             36864  1 vxlan</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 modprobe 명령어로 커널 모듈이 로딩 되어 vxlan과 필요 모듈들이 활성화 되었습니다.&lt;/span&gt;</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>modprobe vxlan <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  1 vxlan</span>
<span class="c">#    udp_tunnel             36864  1 vxlan</span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  1 vxlan</span>
<span class="c">#    udp_tunnel             36864  1 vxlan</span>

<span class="c"># k8s-w1 노드에 배포된 webpod 파드 IP 지정</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD1</span>
<span class="c"># =&gt; 172.20.1.217</span>

<span class="c"># 반복 ping 실행해두기</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nv">$WEBPOD1</span>


<span class="c"># 업그레이드</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--version</span> 1.18.0 <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>tunnel <span class="nt">--set</span> <span class="nv">tunnelProtocol</span><span class="o">=</span>vxlan <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="c"># 설정을 적용하기 위해서 Cilium DaemonSet을 재시작합니다.</span>
<span class="nv">$ </span>kubectl rollout restart <span class="nt">-n</span> kube-system ds/cilium

<span class="c"># 설정 확인</span>
<span class="nv">$ </span>cilium features status
<span class="nv">$ </span>cilium features status | <span class="nb">grep </span>datapath_network
<span class="c"># =&gt; Cilium   Agents</span>
<span class="c">#    Uniform  Name                             Labels              k8s-ctr  k8s-w0  k8s-w1</span>
<span class="c">#    Yes      cilium_feature_datapath_network  mode=&lt;span style="color: green;"&gt;overlay-vxlan&lt;/span&gt;  1        1        1</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status | <span class="nb">grep</span> ^Routing
<span class="c"># =&gt; Routing:                 Network: &lt;span style="color: green;"&gt;Tunnel [vxlan]&lt;/span&gt;   Host: BPF</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>tunnel
<span class="c"># =&gt; routing-mode                                      &lt;span style="color: green;"&gt;tunnel&lt;/span&gt;</span>
<span class="c">#    tunnel-protocol                                   &lt;span style="color: green;"&gt;vxlan&lt;/span&gt;</span>
<span class="c">#    tunnel-source-port-range                          0-0</span>

<span class="c"># cilium_vxlan 확인</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr show dev cilium_vxlan
<span class="c"># =&gt; 26: cilium_vxlan: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether 42:59:64:e0:f6:38 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::4059:64ff:fee0:f638/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr show dev cilium_vxlan <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    8: cilium_vxlan: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether 02:c4:af:d7:83:fc brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::c4:afff:fed7:83fc/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    8: cilium_vxlan: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether ee:f6:72:2b:b9:b9 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::ecf6:72ff:fe2b:b9b9/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># 라우팅 정보 확인 : k8s node 간 다른 네트워크 대역에 있더라도, 파드의 네트워크 대역 정보가 라우팅에 올라왔다!</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>cilium_host
<span class="c"># =&gt; 172.20.0.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201</span>
<span class="c">#    172.20.0.201 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.1.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201 mtu 1450</span>
<span class="c">#    172.20.2.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201 mtu 1450 </span>

<span class="nv">$ </span>ip route get 172.20.1.10
<span class="c"># =&gt; 172.20.1.10 dev cilium_host src 172.20.0.201 uid 0</span>
<span class="c">#        cache mtu 1450</span>
<span class="nv">$ </span>ip route get 172.20.2.10
<span class="c"># =&gt; 172.20.2.10 dev cilium_host src 172.20.0.201 uid 0</span>
<span class="c">#        cache mtu 1450</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 MTU는 Maximum Transmission Unit의 약자로, 네트워크에서 전송할 수 있는 최대 패킷 크기를 의미합니다.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   본래의 MTU는 1500이지만, VXLAN이 이미 50 bytes를 사용하기 때문에&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   최대 1450 bytes까지 전송할 수 있는것을 확인할 수 있습니다.&lt;/span&gt;</span>

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route | <span class="nb">grep </span>cilium_host <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    172.20.0.0/24 via 172.20.1.197 dev cilium_host proto kernel src 172.20.1.197 mtu 1450</span>
<span class="c">#    172.20.1.0/24 via 172.20.1.197 dev cilium_host proto kernel src 172.20.1.197</span>
<span class="c">#    172.20.1.197 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.2.0/24 via 172.20.1.197 dev cilium_host proto kernel src 172.20.1.197 mtu 1450</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    172.20.0.0/24 via 172.20.2.25 dev cilium_host proto kernel src 172.20.2.25 mtu 1450</span>
<span class="c">#    172.20.1.0/24 via 172.20.2.25 dev cilium_host proto kernel src 172.20.2.25 mtu 1450</span>
<span class="c">#    172.20.2.0/24 via 172.20.2.25 dev cilium_host proto kernel src 172.20.2.25</span>
<span class="c">#    172.20.2.25 dev cilium_host proto kernel scope link</span>

<span class="c"># cilium 파드 이름 지정</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-ctr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w0  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CILIUMPOD0</span> <span class="nv">$CILIUMPOD1</span> <span class="nv">$CILIUMPOD2</span>
<span class="c"># =&gt; cilium-4jf9p cilium-dqgbw cilium-sqx45</span>

<span class="c"># router 역할 IP 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CILIUMPOD0</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium status <span class="nt">--all-addresses</span> | <span class="nb">grep </span>router
<span class="c"># =&gt;   172.20.0.201 (router)</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CILIUMPOD1</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium status <span class="nt">--all-addresses</span> | <span class="nb">grep </span>router
<span class="c"># =&gt;   172.20.1.197 (router)</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CILIUMPOD2</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium status <span class="nt">--all-addresses</span> | <span class="nb">grep </span>router
<span class="c"># =&gt;   172.20.2.25 (router)</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf ipcache list
<span class="c"># =&gt; IP PREFIX/ADDRESS   IDENTITY</span>
<span class="c">#    ...</span>
<span class="c">#    172.20.0.201/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel</span>
<span class="c">#    172.20.2.25/32      identity=6 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel</span>
<span class="c">#    172.20.1.197/32     identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=&lt;none&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD0</span> <span class="nt">--</span> cilium-dbg bpf ipcache list
<span class="c"># =&gt; IP PREFIX/ADDRESS   IDENTITY</span>
<span class="c">#    ...</span>
<span class="c">#    172.20.0.201/32     identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=&lt;none&gt;</span>
<span class="c">#    172.20.2.25/32      identity=6 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel</span>
<span class="c">#    172.20.1.197/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.101 flags=hastunnel</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD1</span> <span class="nt">--</span> cilium-dbg bpf ipcache list
<span class="c"># =&gt; IP PREFIX/ADDRESS   IDENTITY</span>
<span class="c">#    ...</span>
<span class="c">#    172.20.1.197/32     identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=&lt;none&gt;</span>
<span class="c">#    172.20.0.201/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel</span>
<span class="c">#    172.20.2.25/32      identity=6 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD2</span> <span class="nt">--</span> cilium-dbg bpf ipcache list
<span class="c"># =&gt; IP PREFIX/ADDRESS   IDENTITY</span>
<span class="c">#    ...</span>
<span class="c">#    172.20.0.201/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel</span>
<span class="c">#    172.20.2.25/32      identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=&lt;none&gt;</span>
<span class="c">#    172.20.1.197/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.101 flags=hastunnel</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf socknat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD0</span> <span class="nt">--</span> cilium-dbg bpf socknat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD1</span> <span class="nt">--</span> cilium-dbg bpf socknat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD2</span> <span class="nt">--</span> cilium-dbg bpf socknat list
</code></pre></div></div>

<h3 id="파드간-통신-확인">파드간 통신 확인</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 통신 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; ---</span>
<span class="c">#    Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-24ck5  # &lt;span style="color: green;"&gt;👉 k8s-w0 노드에 배포된 webpod 파드에 대해서도 통신이 됩니다.&lt;/span&gt;</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-66grn</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 VXLAN 설정 후 이전에는 통신이 되지 않던 k8s-w0 노드에 배포된 webpod 파드에 대해서도 통신이 됩니다.&lt;/span&gt;</span>

<span class="c"># k8s-w0 노드에 배포된 webpod 파드 IP 지정</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPOD</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w0 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; 172.20.2.73</span>

<span class="c"># 신규 터미널 [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 8472 <span class="nt">-nn</span>

<span class="c"># [k8s-ctr] 에서 ping 실행</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; PING 172.20.2.73 (172.20.2.73) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.20.2.73: icmp_seq=1 ttl=63 time=1.77 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.20.2.73 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.769/1.769/1.769/0.000 ms</span>
<span class="c">#    command terminated with exit code 1</span>

<span class="c"># [router]에서 tcpdump 확인 (VXLAN 포트 8472/udp로 통신이 되는지 확인)</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 8472 <span class="nt">-nn</span>
<span class="c"># =&gt; 16:17:25.514596 eth1  In  IP 192.168.10.100.56046 &gt; 192.168.20.100.8472: OTV, flags [I] (0x08), overlay 0, instance 21500</span>
<span class="c">#    IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 11684, seq 1, length 64</span>
<span class="c">#    16:17:25.514636 eth2  Out IP 192.168.10.100.56046 &gt; 192.168.20.100.8472: OTV, flags [I] (0x08), overlay 0, instance 21500</span>
<span class="c">#    IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 11684, seq 1, length 64</span>
<span class="c">#    16:17:25.515307 eth2  In  IP 192.168.20.100.59302 &gt; 192.168.10.100.8472: OTV, flags [I] (0x08), overlay 0, instance 17081</span>
<span class="c">#    IP 172.20.2.73 &gt; 172.20.0.89: ICMP echo reply, id 11684, seq 1, length 64</span>
<span class="c">#    16:17:25.515315 eth1  Out IP &lt;span style="color: green;"&gt;192.168.20.100.59302 &gt; 192.168.10.100.8472&lt;/span&gt;: OTV, flags [I] (0x08), overlay 0, instance 17081</span>
<span class="c">#    IP &lt;span style="color: green;"&gt;172.20.2.73 &gt; 172.20.0.89&lt;/span&gt;: ICMP echo reply, id 11684, seq 1, length 64</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 VXLAN을 통해 파드 IP간 통신이 노드간 IP로 캡슐화되어 통신이 되는 것을 확인할 수 있습니다.&lt;/span&gt;</span>

<span class="c"># 신규 터미널 [router] : 라우팅이 어떻게 되는가?</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>
<span class="c"># =&gt; (없음)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 VXLAN을 통해 캡슐화된 패킷으로 통신이 되기 때문에 직접적으로 ICMP(ping) 패킷은 보이지 않습니다.&lt;/span&gt;</span>

<span class="c"># 반복 접속</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>

<span class="c"># 신규 터미널 [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 8472 <span class="nt">-w</span> /tmp/vxlan.pcap
<span class="nv">$ </span>tshark <span class="nt">-r</span> /tmp/vxlan.pcap <span class="nt">-d</span> udp.port<span class="o">==</span>8472,vxlan
<span class="c"># =&gt;     1   0.000000  172.20.0.89 → 172.20.2.73  TCP 130 53224 → 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2585589520 TSecr=0 WS=128</span>
<span class="c">#        2   0.000015  172.20.0.89 → 172.20.2.73  TCP 130 [TCP Retransmission] 53224 → 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2585589520 TSecr=0 WS=128</span>
<span class="c">#        3   0.000633  172.20.2.73 → 172.20.0.89  TCP 130 80 → 53224 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3020660677 TSecr=2585589520 WS=128</span>
<span class="c">#        4   0.000637  172.20.2.73 → 172.20.0.89  TCP 130 [TCP Retransmission] 80 → 53224 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3020660677 TSecr=2585589520 WS=128</span>
<span class="c">#        5   0.001244  172.20.0.89 → 172.20.2.73  TCP 122 53224 → 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2585589521 TSecr=3020660677</span>
<span class="c">#        6   0.001245  172.20.0.89 → 172.20.2.73  TCP 122 [TCP Dup ACK 5#1] 53224 → 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2585589521 TSecr=3020660677</span>
<span class="c">#        7   0.002239  172.20.0.89 → 172.20.2.73  HTTP 192 GET / HTTP/1.1</span>
<span class="c">#        8   0.002247  172.20.0.89 → 172.20.2.73  TCP 192 [TCP Retransmission] 53224 → 80 [PSH, ACK] Seq=1 Ack=1 Win=64896 Len=70 TSval=2585589522 TSecr=3020660677</span>
<span class="c">#        9   0.002625  172.20.2.73 → 172.20.0.89  TCP 122 80 → 53224 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3020660679 TSecr=2585589522</span>
<span class="c">#       10   0.002628  172.20.2.73 → 172.20.0.89  TCP 122 [TCP Dup ACK 9#1] 80 → 53224 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3020660679 TSecr=2585589522</span>
<span class="c">#       11   0.004215  172.20.2.73 → 172.20.0.89  HTTP 441 HTTP/1.1 200 OK  (text/plain)</span>
<span class="c">#       12   0.004221  172.20.2.73 → 172.20.0.89  TCP 441 [TCP Retransmission] 80 → 53224 [PSH, ACK] Seq=1 Ack=71 Win=64256 Len=319 TSval=3020660680 TSecr=2585589522</span>
<span class="c">#       13   0.004783  172.20.0.89 → 172.20.2.73  TCP 122 53224 → 80 [ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2585589525 TSecr=3020660680</span>
<span class="c">#       14   0.004785  172.20.0.89 → 172.20.2.73  TCP 122 [TCP Dup ACK 13#1] 53224 → 80 [ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2585589525 TSecr=3020660680</span>
<span class="c">#       15   0.005245  172.20.0.89 → 172.20.2.73  TCP 122 53224 → 80 [FIN, ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2585589525 TSecr=3020660680</span>
<span class="c">#       16   0.005248  172.20.0.89 → 172.20.2.73  TCP 122 [TCP Retransmission] 53224 → 80 [FIN, ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2585589525 TSecr=3020660680</span>
<span class="c">#       17   0.005631  172.20.2.73 → 172.20.0.89  TCP 122 80 → 53224 [FIN, ACK] Seq=320 Ack=72 Win=64256 Len=0 TSval=3020660682 TSecr=2585589525</span>
<span class="c">#       18   0.005633  172.20.2.73 → 172.20.0.89  TCP 122 [TCP Retransmission] 80 → 53224 [FIN, ACK] Seq=320 Ack=72 Win=64256 Len=0 TSval=3020660682 TSecr=2585589525</span>
<span class="c">#       19   0.006526  172.20.0.89 → 172.20.2.73  TCP 122 53224 → 80 [ACK] Seq=72 Ack=321 Win=64640 Len=0 TSval=2585589526 TSecr=3020660682</span>
<span class="c">#       20   0.006529  172.20.0.89 → 172.20.2.73  TCP 122 [TCP Dup ACK 19#1] 53224 → 80 [ACK] Seq=72 Ack=321 Win=64640 Len=0 TSval=2585589526 TSecr=3020660682</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 tshark로도 VXLAN 캡슐화된 패킷을 해석할 수 있지만 조금 더 원활한 해석을 위해서 termshark를 사용해보겠습니다.&lt;/span&gt;</span>

<span class="nv">$ </span>termshark <span class="nt">-r</span> /tmp/vxlan.pcap
<span class="c"># =&gt; termshark 2.4.0  |  vxlan.pcap                                                         Analysis    Misc</span>
<span class="c">#    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span>
<span class="c">#    ┃Filter:                                                                               &lt;Apply&gt; &lt;Recent&gt; ┃</span>
<span class="c">#    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛</span>
<span class="c">#     No. -  Time -      Source -           Dest -             Proto -  Length -  Info -                     ▲</span>
<span class="c">#     2      0.000015    192.168.10.100     192.168.20.100     UDP      130       56560 → 8472 Len=82</span>
<span class="c">#     3      0.000633    192.168.20.100     192.168.10.100     UDP      130       38192 → 8472 Len=82        █</span>
<span class="c">#     4      0.000637    192.168.20.100     192.168.10.100     UDP      130       38192 → 8472 Len=82</span>
<span class="c">#     5      0.001244    192.168.10.100     192.168.20.100     UDP      122       56560 → 8472 Len=74</span>
<span class="c">#     6      0.001245    192.168.10.100     192.168.20.100     UDP      122       56560 → 8472 Len=74</span>
<span class="c">#     7      0.002239    192.168.10.100     192.168.20.100     UDP      192       56560 → 8472 Len=144       ▼</span>
<span class="c">#    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
<span class="c">#    [+] Frame 2: 130 bytes on wire (1040 bits), 130 bytes captured (1040 bits) [=]</span>
<span class="c">#    [+] Linux cooked capture v2</span>
<span class="c">#    [+] Internet Protocol Version 4, Src: 192.168.10.100, Dst: 192.168.20.100</span>
<span class="c">#    [+] User Datagram Protocol, Src Port: 56560, Dst Port: 8472</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 기본 termshark 명령어로는 VXLAN 캡슐화된 패킷을 해석할 수 없어서 8472/udp로 캡슐화된 패킷이 보이지 않습니다.&lt;/span&gt;</span>

<span class="nv">$ </span>termshark <span class="nt">-r</span> /tmp/vxlan.pcap <span class="nt">-d</span> udp.port<span class="o">==</span>8472,vxlan
<span class="c"># =&gt; termshark 2.4.0  |  vxlan.pcap                                                         Analysis    Misc</span>
<span class="c">#    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span>
<span class="c">#    ┃Filter:                                                                               &lt;Apply&gt; &lt;Recent&gt; ┃</span>
<span class="c">#    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛</span>
<span class="c">#     No. Time - Source - Dest -   Prot Lengt Info -                                                         ▲</span>
<span class="c">#     1   0.0000 172.20.0 172.20.2 TCP  130   53224 → 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSva</span>
<span class="c">#     2   0.0000 172.20.0 172.20.2 TCP  130   [TCP Retransmission] 53224 → 80 [SYN] Seq=0 Win=64860 Len=0 MS █</span>
<span class="c">#     3   0.0006 172.20.2 172.20.0 TCP  130   80 → 53224 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SAC</span>
<span class="c">#     4   0.0006 172.20.2 172.20.0 TCP  130   [TCP Retransmission] 80 → 53224 [SYN, ACK] Seq=0 Ack=1 Win=643</span>
<span class="c">#     5   0.0012 172.20.0 172.20.2 TCP  122   53224 → 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2585589521</span>
<span class="c">#     6   0.0012 172.20.0 172.20.2 TCP  122   [TCP Dup ACK 5#1] 53224 → 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0</span>
<span class="c">#     7   0.0022 172.20.0 172.20.2 HTTP 192   GET / HTTP/1.1</span>
<span class="c">#     8   0.0022 172.20.0 172.20.2 TCP  192   [TCP Retransmission] 53224 → 80 [PSH, ACK] Seq=1 Ack=1 Win=648</span>
<span class="c">#     9   0.0026 172.20.2 172.20.0 TCP  122   80 → 53224 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3020660679</span>
<span class="c">#     10  0.0026 172.20.2 172.20.0 TCP  122   [TCP Dup ACK 9#1] 80 → 53224 [ACK] Seq=1 Ack=71 Win=64256 Len=</span>
<span class="c">#     11  0.0042 172.20.2 172.20.0 HTTP 441   HTTP/1.1 200 OK  (text/plain)                                  ▼</span>
<span class="c">#    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
<span class="c">#    [+] Frame 7: 192 bytes on wire (1536 bits), 192 bytes captured (1536 bits)</span>
<span class="c">#    [+] Linux cooked capture v2 [=]</span>
<span class="c">#    [+] Internet Protocol Version 4, &lt;span style="color: green; border: 2px solid rgba(255, 0, 0, 0.5); padding: 1px 4px;"&gt;Src: 192.168.10.100, Dst: 192.168.20.100&lt;/span&gt;</span>
<span class="c">#    [+] User Datagram Protocol, Src Port: 56560, Dst Port: 8472</span>
<span class="c">#    [+] &lt;span style="color: green; border: 2px solid rgba(255, 0, 0, 0.5); padding: 1px 4px;"&gt;Virtual eXtensible Local Area Network&lt;/span&gt;</span>
<span class="c">#    [+] Ethernet II, Src: 46:02:28:c8:e7:b6 (46:02:28:c8:e7:b6), Dst: ca:7a:5c:b2:2c:4a (ca:7a:5c:b2:2c:4a)</span>
<span class="c">#    [+] Internet Protocol Version 4, Src: &lt;span style="color: green; border: 2px solid rgba(255, 0, 0, 0.5); padding: 1px 4px;"&gt;172.20.0.89, Dst: 172.20.2.73&lt;/span&gt;</span>
<span class="c">#    [+] Transmission Control Protocol, Src Port: 53224, Dst Port: 80, Seq: 1, Ack: 1, Len: 70</span>
<span class="c">#    [-] Hypertext Transfer Protocol</span>
<span class="c">#      [+] GET / HTTP/1.1</span>
<span class="c">#          Host: webpod</span>
<span class="c">#          User-Agent: curl/8.14.1</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 -d udp.port==8472,vxlan 옵션을 통해 VXLAN 캡슐화된 패킷을 해석할 수 있습니다.&lt;/span&gt;</span>

<span class="c"># 신규 터미널 [k8s-ctr] hubble flow log 모니터링 : overlay 통신 모드 확인!</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--pod</span> curl-pod
<span class="c"># =&gt; ...</span>
<span class="c">#    Aug  9 07:34:42.262: default/curl-pod:37272 (ID:21500) -&gt; default/webpod-697b545f57-24ck5:80 (ID:17081) &lt;span style="color: green;"&gt;to-overlay FORWARDED&lt;/span&gt; (TCP Flags: SYN)</span>
<span class="c">#    Aug  9 07:34:42.263: default/curl-pod:37272 (ID:21500) &lt;- default/webpod-697b545f57-24ck5:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Aug  9 07:34:42.263: default/curl-pod:37272 (ID:21500) -&gt; default/webpod-697b545f57-24ck5:80 (ID:17081) &lt;span style="color: green;"&gt;to-overlay FORWARDED&lt;/span&gt; (TCP Flags: ACK)</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w4/20250810_cilium_w4_3.png" alt="img.png" class="image-center" loading="lazy" width="1386" height="758">
<em class="image-caption">파드에서 나갈때 패킷 흐름</em></p>

<p><img src="/assets/2025/cilium/w4/20250810_cilium_w4_4.png" alt="img_1.png" class="image-center" loading="lazy" width="1626" height="783">
<em class="image-caption">파드로 인입시 패킷 흐름</em></p>

<ul>
  <li>이상과 같이 VXLAN을 통해서 파드간 통신이 가능해졌습니다. 하지만 VXLAN 등의 캡슐화 기술을 사용하게 되면, 다음의 단점이 있습니다.
    <ul>
      <li>50 bytes의 캡슐화 오버헤드가 발생합니다. (MTU 감소 및 그로인한 패킷 fragmentation 발생 가능성)</li>
      <li>캡슐화 및 디캡슐화 과정에서 CPU 리소스가 소모됩니다.</li>
      <li>같은 네트워크 대역에 있더라도 VXLAN을 통해 캡슐화 됩니다.</li>
    </ul>
  </li>
  <li>VXLAN은 별도의 네트워크 설정 없이 노드간 통신이 가능하다는 장점이 있지만, 위와 같은 문제들로 인프라적인 지원이 가능하다면 Native Routing을 사용하는 것이 좋습니다.</li>
  <li>MTU(Maximum Transmission Unit)는 네트워크에서 전송할 수 있는 최대 패킷 크기를 의미합니다. VXLAN을 사용하면 MTU가 감소하게 되며, 이는 패킷이 분할(fragmentation)되어 전송될 수 있음을 의미합니다. 따라서, VXLAN을 사용할 때는 MTU 설정을 주의 깊게 관리해야 합니다.</li>
  <li>MTU에 대한 간단한 실험을 하고 다음 단계로 넘어가겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># -M do : Don't Fragment (DF) 플래그를 설정하여 조각화 방지</span>
<span class="c"># -s 1472 : 페이로드(payload) 크기, 즉 ICMP 데이터 크기</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nt">-M</span> <span class="k">do</span> <span class="nt">-s</span> 1472 <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; PING 172.20.2.73 (172.20.2.73) 1472(1500) bytes of data.</span>
<span class="c">#    ping: sendmsg: Message too large</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 ping 명령어를 통해 VXLAN 에 의한 MTU (1450 bytes)보다 큰 1500 bytes를 강제로 전송하면 &lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   "ping: sendmsg: Message too large" 에러가 발생합니다.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   즉, MTU보다 큰 패킷은 전송할 수 없음을 확인할 수 있으며, MTU 단위로 패킷이 분할(fragmentation)되어 전송됩니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="도전과제2-vxlan-대신-geneve-모드-사용">
<code class="language-plaintext highlighter-rouge">도전과제2.</code> VXLAN 대신 GENEVE 모드 사용</h3>

<ul>
  <li>Cilium은 VXLAN 외에도 GENEVE 모드를 지원합니다. GENEVE는 VXLAN보다 더 유연하고 확장 가능한 캡슐화 프로토콜입니다.</li>
</ul>

<h4 id="geneve-소개">GENEVE 소개</h4>

<ul>
  <li>GENEVE(Generic Network Virtualization Encapsulation)는 VXLAN/NVGRE 등과 유사한 네트워크 가상화 캡슐화 프로토콜로 좀 더 발전된 기능을 제공합니다.</li>
  <li>주요 특징은 다음과 같습니다.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_17.png" alt="img.png" class="image-center w-80" loading="lazy" width="960" height="376">
<em class="image-caption">Geneve 헤더 구조 - <a href="https://www.redhat.com/en/blog/what-geneve">출처</a></em>
    <ul>
      <li>
<strong>확장성 높은 옵션 필드(TLV:Type-Length-Value)</strong> : 고정 헤더 구조에서 벗어나  유동적으로 다양한 옵션을 추가할 수 있어 다양한 환경과 요구사항에 맞는 발전이 가능합니다. (단, 늘어난 헤더 크기가 오버헤드로 작용합니다.)</li>
      <li>
<strong>UDP 기반 처리</strong> : VXLAN과 마찬가지로 UDP 6081 포트를 사용하며, 하드웨어·소프트웨어에서 호환성이 뛰어납니다.</li>
      <li>
<strong>표준화된 프로토콜</strong> : Cisco 주도로 만들어진 VXLAN과 달리, 처음부터 IETF에서 <strong>범람하는 캡슐화 프로토콜을 통합할 목적으로 만든</strong> 프로토콜로, 더 널리 채택될 가능성이 높습니다.</li>
      <li>
<strong>확장 가능한 서비스</strong> : 정책, 전송 보안, 서비스 체이닝 등 다양한 서비스에 대한 확장성을 제공하며, SDN(Software Defined Networking) 환경에서 유용합니다.</li>
      <li>
<strong>하드웨어 오프로드</strong> : VXLAN도 NIC 오프로드를 지원하지만, Geneve는 설계시 부터 하드웨어 오프로드를 고려하여 설계되어, 성능이 향상될 수 있습니다.</li>
    </ul>
  </li>
</ul>

<h4 id="geneve-실습">GENEVE 실습</h4>

<ul>
  <li>실습을 통해 GENEVE 모드를 사용하여 파드 간 통신을 설정해보겠습니다.</li>
</ul>

<h5 id="geneve-모드-설정">GENEVE 모드 설정</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># GENEVE 커널 모듈 로드</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span>
<span class="c"># =&gt; vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  1 vxlan</span>
<span class="c">#    udp_tunnel             36864  1 vxlan</span>
<span class="nv">$ </span>modprobe geneve
<span class="nv">$ </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span>
<span class="c"># =&gt; &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve                 45056  0&lt;/span&gt;</span>
<span class="c">#    vxlan                 147456  0</span>
<span class="c">#    ...</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>modprobe geneve <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> <span class="nb">sudo </span>lsmod | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'vxlan|geneve'</span> <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve                 45056  0&lt;/span&gt;</span>
<span class="c">#    vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  2 &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve&lt;/span&gt;,vxlan</span>
<span class="c">#    udp_tunnel             36864  2 &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve&lt;/span&gt;,vxlan</span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve                 45056  0&lt;/span&gt;</span>
<span class="c">#    vxlan                 147456  0</span>
<span class="c">#    ip6_udp_tunnel         16384  2 &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve&lt;/span&gt;,vxlan</span>
<span class="c">#    udp_tunnel             36864  2 &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;geneve&lt;/span&gt;,vxlan</span>

<span class="c"># k8s-w1 노드에 배포된 webpod 파드 IP 지정</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD1</span>
<span class="c"># =&gt; 172.20.1.198</span>

<span class="c"># 반복 ping 실행해두기</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nv">$WEBPOD1</span>


<span class="c"># 업그레이드</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--version</span> 1.18.0 <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>tunnel <span class="nt">--set</span> <span class="nv">tunnelProtocol</span><span class="o">=</span>geneve <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="c"># 설정을 적용하기 위해서 Cilium DaemonSet을 재시작합니다.</span>
<span class="nv">$ </span>kubectl rollout restart <span class="nt">-n</span> kube-system ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># 설정 확인</span>
<span class="nv">$ </span>cilium features status
<span class="nv">$ </span>cilium features status | <span class="nb">grep </span>datapath_network
<span class="c"># =&gt; Cilium   Agents</span>
<span class="c">#    Uniform  Name                             Labels              k8s-ctr  k8s-w0  k8s-w1</span>
<span class="c">#    Yes      cilium_feature_datapath_network                                         mode=&lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;overlay-geneve&lt;/span&gt;                               1        1       1</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status | <span class="nb">grep</span> ^Routing
<span class="c"># =&gt; Routing:                 Network: &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;Tunnel [geneve]&lt;/span&gt;   Host: BPF</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>tunnel
<span class="c"># =&gt; routing-mode                                      tunnel</span>
<span class="c">#    tunnel-protocol                                   geneve</span>
<span class="c">#    tunnel-source-port-range                          0-0</span>

<span class="c"># cilium_geneve 확인</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr show dev cilium_geneve
<span class="c"># =&gt; 29: cilium_geneve: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether 9e:6f:d6:29:71:60 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::9c6f:d6ff:fe29:7160/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> addr show dev cilium_geneve <span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    11: cilium_geneve: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether c2:bd:d4:eb:63:fd brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::c0bd:d4ff:feeb:63fd/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    11: cilium_geneve: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/ether 0e:fd:73:c8:6f:37 brd ff:ff:ff:ff:ff:ff</span>
<span class="c">#        inet6 fe80::cfd:73ff:fec8:6f37/64 scope link</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># 라우팅 정보 확인 : k8s node 간 다른 네트워크 대역에 있더라도, 파드의 네트워크 대역 정보가 라우팅에 올라왔다!</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>cilium_host
<span class="c"># =&gt; 172.20.0.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201</span>
<span class="c">#    172.20.0.201 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.1.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201 mtu 1450</span>
<span class="c">#    172.20.2.0/24 via 172.20.0.201 dev cilium_host proto kernel src 172.20.0.201 mtu 1450 </span>

<span class="nv">$ </span>ip route get 172.20.1.10
<span class="c"># =&gt; 172.20.1.10 dev cilium_host src 172.20.0.201 uid 0</span>
<span class="c">#        cache mtu 1450</span>
<span class="nv">$ </span>ip route get 172.20.2.10
<span class="c"># =&gt; 172.20.2.10 dev cilium_host src 172.20.0.201 uid 0</span>
<span class="c">#        cache mtu 1450</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 geneve도 VXLAN과 마찬가지로 50 bytes의 캡슐화 오버헤드가 발생하는것 같습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>커널 모듈을 로드하고, helm을 통해 GENEVE 모드 설정을 바꾸고, daemonset을 재시작하는것 만으로 
간단하게 VXLAN 모드에서 GENEVE 모드로 변경할 수 있었습니다.</li>
  <li>VXLAN 모드로 변경할때와 마찬가지로 <strong>daemonset이 재시작 되는 동안 파드간 통신이 중단</strong>되는것을 확인할 수 있었습니다.
운영 환경에서는 주의가 필요합니다.</li>
</ul>

<h5 id="파드간-통신-확인-1">파드간 통신 확인</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s-w0 노드에 배포된 webpod 파드 IP 지정</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">WEBPOD</span><span class="o">=</span><span class="si">$(</span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w0 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].status.podIP}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; 172.20.2.73</span>

<span class="c"># 신규 터미널 [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 8472 <span class="nt">-nn</span>

<span class="c"># [k8s-ctr] 에서 ping 실행</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> ping <span class="nt">-c</span> 2 <span class="nt">-w</span> 1 <span class="nt">-W</span> 1 <span class="nv">$WEBPOD</span>
<span class="c"># =&gt; PING 172.20.2.73 (172.20.2.73) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 172.20.2.73: icmp_seq=1 ttl=63 time=4.10 ms</span>
<span class="c">#    64 bytes from 172.20.2.73: icmp_seq=2 ttl=63 time=1.47 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 172.20.2.73 ping statistics ---</span>
<span class="c">#    2 packets transmitted, 2 received, 0% packet loss, time 1000ms</span>
<span class="c">#    rtt min/avg/max/mdev = 1.473/2.786/4.100/1.313 ms</span>

<span class="c"># [router]에서 tcpdump 확인 (GENEVE 포트 6081/udp로 통신이 되는지 확인)</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 6081 <span class="nt">-nn</span>
<span class="c"># =&gt; 00:17:18.537335 eth1  In  IP 192.168.10.100.54038 &gt; 192.168.20.100.6081: Geneve, Flags [none], vni 0x53fc: IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 59783, seq 1, length 64</span>
<span class="c">#    00:17:18.537385 eth2  Out IP 192.168.10.100.54038 &gt; 192.168.20.100.6081: Geneve, Flags [none], vni 0x53fc: IP 172.20.0.89 &gt; 172.20.2.73: ICMP echo request, id 59783, seq 1, length 64</span>
<span class="c">#    00:17:18.538608 eth2  In  IP 192.168.20.100.61597 &gt; 192.168.10.100.6081: Geneve, Flags [none], vni 0x42b9: IP 172.20.2.73 &gt; 172.20.0.89: ICMP echo reply, id 59783, seq 1, length 64</span>
<span class="c">#    00:17:18.538616 eth1  Out IP &lt;span style="color: green;"&gt;192.168.20.100.61597 &gt; 192.168.10.100.6081&lt;/span&gt;: &lt;span style="color: green;"&gt;Geneve&lt;/span&gt;, Flags [none], vni 0x42b9: IP &lt;span style="color: green;"&gt;172.20.2.73 &gt; 172.20.0.89&lt;/span&gt;: ICMP echo reply, id 59783, seq 1, length 64</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 GENEVE을 통해 파드 IP간 통신이 노드간 IP로 캡슐화되어 통신이 되는 것을 확인할 수 있습니다.&lt;/span&gt;</span>

<span class="c"># 신규 터미널 [router] : 라우팅이 어떻게 되는가?</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>
<span class="c"># =&gt; (없음)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 GENEVE을 통해 캡슐화된 패킷으로 통신이 되기 때문에 직접적으로 ICMP(ping) 패킷은 보이지 않습니다.&lt;/span&gt;</span>

<span class="c"># 반복 접속</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>

<span class="c"># 신규 터미널 [router]</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> any udp port 6081 <span class="nt">-w</span> /tmp/geneve.pcap
<span class="nv">$ </span>tshark <span class="nt">-r</span> /tmp/geneve.pcap <span class="nt">-d</span> udp.port<span class="o">==</span>6081,geneve
<span class="c"># =&gt;     1   0.000000  172.20.0.89 → 172.20.2.73  TCP 130 44270 → 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2614161702 TSecr=0 WS=128</span>
<span class="c">#        2   0.000026  172.20.0.89 → 172.20.2.73  TCP 130 [TCP Retransmission] 44270 → 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2614161702 TSecr=0 WS=128</span>
<span class="c">#        3   0.000809  172.20.2.73 → 172.20.0.89  TCP 130 80 → 44270 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3049232850 TSecr=2614161702 WS=128</span>
<span class="c">#        4   0.000817  172.20.2.73 → 172.20.0.89  TCP 130 [TCP Retransmission] 80 → 44270 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3049232850 TSecr=2614161702 WS=128</span>
<span class="c">#        5   0.001933  172.20.0.89 → 172.20.2.73  TCP 122 44270 → 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2614161704 TSecr=3049232850</span>
<span class="c">#        6   0.001940  172.20.0.89 → 172.20.2.73  TCP 122 [TCP Dup ACK 5#1] 44270 → 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2614161704 TSecr=3049232850</span>
<span class="c">#        7   0.002279  172.20.0.89 → 172.20.2.73  HTTP 192 GET / HTTP/1.1</span>
<span class="c">#        8   0.002446  172.20.0.89 → 172.20.2.73  TCP 192 [TCP Retransmission] 44270 → 80 [PSH, ACK] Seq=1 Ack=1 Win=64896 Len=70 TSval=2614161705 TSecr=3049232850</span>
<span class="c">#        9   0.004700  172.20.2.73 → 172.20.0.89  TCP 122 80 → 44270 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3049232852 TSecr=2614161705</span>
<span class="c">#       10   0.004712  172.20.2.73 → 172.20.0.89  TCP 122 [TCP Dup ACK 9#1] 80 → 44270 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3049232852 TSecr=2614161705</span>
<span class="c">#       11   0.005871  172.20.2.73 → 172.20.0.89  HTTP 441 HTTP/1.1 200 OK  (text/plain)</span>
<span class="c">#       12   0.005874  172.20.2.73 → 172.20.0.89  TCP 441 [TCP Retransmission] 80 → 44270 [PSH, ACK] Seq=1 Ack=71 Win=64256 Len=319 TSval=3049232855 TSecr=2614161705</span>
<span class="c">#       13   0.006514  172.20.0.89 → 172.20.2.73  TCP 122 44270 → 80 [ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2614161709 TSecr=3049232855</span>
<span class="c">#       14   0.006527  172.20.0.89 → 172.20.2.73  TCP 122 [TCP Dup ACK 13#1] 44270 → 80 [ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2614161709 TSecr=3049232855</span>
<span class="c">#       15   0.006916  172.20.0.89 → 172.20.2.73  TCP 122 44270 → 80 [FIN, ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2614161709 TSecr=3049232855</span>
<span class="c">#       16   0.006922  172.20.0.89 → 172.20.2.73  TCP 122 [TCP Retransmission] 44270 → 80 [FIN, ACK] Seq=71 Ack=320 Win=64640 Len=0 TSval=2614161709 TSecr=3049232855</span>
<span class="c">#       17   0.007468  172.20.2.73 → 172.20.0.89  TCP 122 80 → 44270 [FIN, ACK] Seq=320 Ack=72 Win=64256 Len=0 TSval=3049232856 TSecr=2614161709</span>
<span class="c">#       18   0.007474  172.20.2.73 → 172.20.0.89  TCP 122 [TCP Retransmission] 80 → 44270 [FIN, ACK] Seq=320 Ack=72 Win=64256 Len=0 TSval=3049232856 TSecr=2614161709</span>
<span class="c">#       19   0.008120  172.20.0.89 → 172.20.2.73  TCP 122 44270 → 80 [ACK] Seq=72 Ack=321 Win=64640 Len=0 TSval=2614161710 TSecr=3049232856</span>
<span class="c">#       20   0.008125  172.20.0.89 → 172.20.2.73  TCP 122 [TCP Dup ACK 19#1] 44270 → 80 [ACK] Seq=72 Ack=321 Win=64640 Len=0 TSval=2614161710 TSecr=3049232856</span>
<span class="c">#       ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 tshark로도 GENEVE 캡슐화된 패킷을 해석할 수 있지만 조금 더 원활한 해석을 위해서 termshark를 사용해보겠습니다.&lt;/span&gt;</span>

<span class="nv">$ </span>termshark <span class="nt">-r</span> /tmp/geneve.pcap <span class="nt">-d</span> udp.port<span class="o">==</span>6081,geneve
<span class="c"># =&gt; termshark 2.4.0  |  geneve.pcap                                                                                                                                  Analysis    Misc</span>
<span class="c">#    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span>
<span class="c">#    ┃Filter:                                                                                                                                                         &lt;Apply&gt; &lt;Recent&gt; ┃</span>
<span class="c">#    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛</span>
<span class="c">#     No. - Time -    Source -     Dest -       Proto - Length - Info -                                                                                                                ▲</span>
<span class="c">#     1     0.000000  172.20.0.89  172.20.2.73  TCP     130      44270 → 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2614161702 TSecr=0 WS=128</span>
<span class="c">#     2     0.000026  172.20.0.89  172.20.2.73  TCP     130      [TCP Retransmission] 44270 → 80 [SYN] Seq=0 Win=64860 Len=0 MSS=1410 SACK_PERM TSval=2614161702 TSecr=0 WS=128</span>
<span class="c">#     3     0.000809  172.20.2.73  172.20.0.89  TCP     130      80 → 44270 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3049232850 TSecr=2614161702 WS=128         █</span>
<span class="c">#     4     0.000817  172.20.2.73  172.20.0.89  TCP     130      [TCP Retransmission] 80 → 44270 [SYN, ACK] Seq=0 Ack=1 Win=64308 Len=0 MSS=1410 SACK_PERM TSval=3049232850 TSecr=2614</span>
<span class="c">#     5     0.001933  172.20.0.89  172.20.2.73  TCP     122      44270 → 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2614161704 TSecr=3049232850</span>
<span class="c">#     6     0.001940  172.20.0.89  172.20.2.73  TCP     122      [TCP Dup ACK 5#1] 44270 → 80 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2614161704 TSecr=3049232850</span>
<span class="c">#     7     0.002279  172.20.0.89  172.20.2.73  HTTP    192      GET / HTTP/1.1</span>
<span class="c">#     8     0.002446  172.20.0.89  172.20.2.73  TCP     192      [TCP Retransmission] 44270 → 80 [PSH, ACK] Seq=1 Ack=1 Win=64896 Len=70 TSval=2614161705 TSecr=3049232850</span>
<span class="c">#     9     0.004700  172.20.2.73  172.20.0.89  TCP     122      80 → 44270 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3049232852 TSecr=2614161705</span>
<span class="c">#     10    0.004712  172.20.2.73  172.20.0.89  TCP     122      [TCP Dup ACK 9#1] 80 → 44270 [ACK] Seq=1 Ack=71 Win=64256 Len=0 TSval=3049232852 TSecr=2614161705</span>
<span class="c">#     11    0.005871  172.20.2.73  172.20.0.89  HTTP    441      HTTP/1.1 200 OK  (text/plain)                                                                                         ▼</span>
<span class="c">#    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
<span class="c">#    [+] Linux cooked capture v2</span>
<span class="c">#    [+] Internet Protocol Version 4, &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;Src: 192.168.10.100, Dst: 192.168.20.100&lt;/span&gt;</span>
<span class="c">#    [+] User Datagram Protocol, Src Port: 41753, Dst Port: 6081</span>
<span class="c">#    [+] &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;Generic Network Virtualization Encapsulation&lt;/span&gt;, VNI: 0x0053fc [=]</span>
<span class="c">#    [+] Ethernet II, Src: 46:02:28:c8:e7:b6 (46:02:28:c8:e7:b6), Dst: ca:7a:5c:b2:2c:4a (ca:7a:5c:b2:2c:4a)</span>
<span class="c">#    [+] Internet Protocol Version 4, Src: &lt;span style="color: green; padding: 2px 3px; border: 2px solid red; margin: 0 -5px;"&gt;172.20.0.89, Dst: 172.20.2.73&lt;/span&gt;</span>
<span class="c">#    [+] Transmission Control Protocol, Src Port: 44270, Dst Port: 80, Seq: 1, Ack: 1, Len: 70</span>
<span class="c">#    [-] Hypertext Transfer Protocol</span>
<span class="c">#      [+] GET / HTTP/1.1</span>
<span class="c">#          Host: webpod</span>
<span class="c">#          User-Agent: curl/8.14.1</span>
<span class="c">#          Accept: */*</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 -d udp.port==6081,geneve 옵션을 통해 VXLAN 캡슐화된 패킷을 해석할 수 있습니다.&lt;/span&gt;</span>

<span class="c"># 신규 터미널 [k8s-ctr] hubble flow log 모니터링 : overlay 통신 모드 확인!</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--pod</span> curl-pod
<span class="c"># =&gt; ...</span>
<span class="c">#    Aug  9 15:29:04.546: default/curl-pod:53356 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-overlay FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Aug  9 15:29:04.548: default/curl-pod:53356 (ID:21500) &lt;- default/webpod-697b545f57-66grn:80 (ID:17081) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Aug  9 15:29:04.548: default/curl-pod:53356 (ID:21500) -&gt; default/webpod-697b545f57-66grn:80 (ID:17081) to-overlay FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>GENEVE 모드로 변경한 후에도 파드 간 통신이 정상적으로 이루어지는 것을 확인할 수 있었습니다.</li>
</ul>

<hr>

<h2 id="k8s-service">K8S Service</h2>

<h3 id="클러스터-내부를-외부에-노출하는-방법의-발전단계">클러스터 내부를 외부에 노출하는 방법의 발전단계</h3>

<ol>
  <li>파드 생성 : K8S 클러스터 내부에서만 접속
  <img src="/assets/2025/cilium/w4/20250810_cilium_w4_5.png" alt="img.png" class="image-left" loading="lazy" width="199" height="144"><br>
</li>
  <li>서비스(<strong>Cluster</strong> Type) 연결 : K8S 클러스터 내부에서만 접속
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_6.png" alt="img_1.png" class="image-left" loading="lazy" width="508" height="171">
    <ul>
      <li>동일한 애플리케이션의 다수의 파드의 접속을 용이하게 하기 위한 서비스에 접속</li>
      <li>
<strong>고정 접속(호출)</strong> 방법을 제공 : 흔히 말하는 ‘<strong>고정 Virtual IP</strong>’ 와 ‘<strong>Domain주소</strong>’ 생성<br><br>
</li>
    </ul>
  </li>
  <li>서비스(<strong>NodePort</strong> Type) 연결 : 외부 클라이언트가 서비스를 통해서 클러스터 내부의 파드로 접속
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_7.png" alt="img_2.png" class="image-left" loading="lazy" width="818" height="247">
    <ul>
      <li>서비스(<strong>NodePort</strong> Type)의 일부 단점을 보완한 서비스(<strong>LoadBalancer</strong> Type) 도 있습니다.</li>
    </ul>
  </li>
</ol>

<h3 id="service-종류">Service 종류</h3>

<h4 id="clusterip-타입">ClusterIP 타입</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_1.png" alt="img.png" class="w-80 image-center" loading="lazy" width="1111" height="382"></p>

<ul>
  <li>동일한 애플리케이션을 실행하는 여러 Pod에 접속을 용이하기 위해 사용합니다.</li>
  <li>ClusterIP는 Cluster 내부에서만 접근이 가능하며 외부에서는 접근이 불가능합니다.</li>
  <li>iptables 의 NAT 기능을 이용하여 Pod에 접근하며, 동일한 iptables 분산룰을 각 노드에 적용합니다.</li>
</ul>

<h4 id="nodeport-타입">NodePort 타입</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_2.png" alt="img.png" class="w-80 image-center" loading="lazy" width="972" height="375"></p>

<ul>
  <li>NodePort는 ClusterIP와 같이 Cluster 내부에서 접근이 가능하며, 외부에서도 접근이 가능합니다.</li>
  <li>NodePort도 ClusterIP와 같이 iptables의 NAT 기능을 이용하여 Pod에 접근하며, 각 노드에 NodePort를 할당합니다.</li>
  <li>외부에서는 NodePort를 통해 각 노드에 접근 할 수 있습니다.</li>
</ul>

<h4 id="loadbalancer-타입">LoadBalancer 타입</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_3.png" alt="img.png" class="w-80 image-center" loading="lazy" width="1157" height="362"></p>

<ul>
  <li>LoadBalancer도 외부에서 접근이 가능하며, 클라우드 서비스에서 제공하는 LoadBalancer를 사용합니다. (AWS의 경우 ELB(Elastic Load Balancer)가 사용됩니다.)</li>
  <li>온프레미스 환경에서도 MetalLB와 같은 LoadBalancer를 사용할 수 있습니다.</li>
</ul>

<h3 id="서비스의-구조">서비스의 구조</h3>

<p>서비스를 선언시 <code class="language-plaintext highlighter-rouge">port</code>와 <code class="language-plaintext highlighter-rouge">targetPort</code>, 그리고 <code class="language-plaintext highlighter-rouge">label selector</code> 를 사용합니다. 각각의 역할은 다음과 같습니다.</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">port</code> : 서비스가 listen 할 포트를 지정합니다.</li>
  <li>
<code class="language-plaintext highlighter-rouge">targetPort</code> : 대상 파드의 port를 지정합니다.</li>
  <li>
<code class="language-plaintext highlighter-rouge">label selector</code>  : 대상 파드를 특정합니다.</li>
</ul>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_7.png" alt="img.png" loading="lazy" width="824" height="221"></p>

<h3 id="kube-proxy-모드">kube-proxy 모드</h3>

<ul>
  <li>kube-proxy는 쿠버네티스 클러스터에서 서비스의 트래픽을 파드로 라우팅하는 역할을 합니다.</li>
  <li>
<strong>선택사항이지만</strong>, 반드시 kube-proxy를 대체할 수 있는 대안이 배포되어야 합니다. (예) cilium 등)</li>
  <li>kube-proxy는 서비스 통신 동작에 대한 설정을 관리합니다. 데몬셋으로 배포되어 모든 노드에 파드가 생성됩니다.</li>
  <li>kube-proxy 모드의 종류는 userspace proxy 모드, iptables proxy 모드, ipvs proxy 모드, nftables proxy 모드 등이 있습니다.</li>
</ul>

<h4 id="userspace-proxy-모드-현재는-미사용">userspace proxy 모드 (현재는 미사용)</h4>

<p><img src="/assets/2025/cilium/w4/20250810_cilium_w4_8.png" alt="img.png" class="image-center w-80" loading="lazy" width="800" height="633">
<em class="image-caption">출처 : <a href="https://medium.com/finda-tech/kubernetes-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A0%95%EB%A6%AC-fccd4fd0ae6">https://medium.com/finda-tech/kubernetes-네트워크-정리-fccd4fd0ae6</a></em></p>

<ul>
  <li>기초적인 모드이며 사용자 영역의 kube-proxy를 통해 NIC1으로 들어온 패킷을 NIC2로 전달하여 목적 파드로 전달합니다.</li>
  <li>이렇게 하는 과정에서 커널영역(netfilter)과 사용자영역(kube-proxy)를 오가는 과정에서 스위칭에 의한 오버헤드가 발생하는 단점이 있습니다.</li>
</ul>

<h4 id="iptables-proxy-모드">iptables proxy 모드</h4>

<p><img src="/assets/2025/cilium/w4/20250810_cilium_w4_9.png" alt="img.png" class="image-center w-80" loading="lazy" width="700" height="522">
<em class="image-caption">출처 : <a href="https://medium.com/finda-tech/kubernetes-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A0%95%EB%A6%AC-fccd4fd0ae6">https://medium.com/finda-tech/kubernetes-네트워크-정리-fccd4fd0ae6</a></em></p>

<ul>
  <li>쿠버네티스 설치시 기본 모드이며, userspace proxy 모드와는 달리 kube-proxy는 트래픽 전달에 직접 관여하지는 않고, netfilter(iptables)를 사용하여 트래픽을 전달합니다.</li>
  <li>iptables proxy 모드는 트래픽 전달 과정에서 kube-proxy를 경유하지 않고, 커널 영역과 사용자 영역 전환이 필요하지 않아서, 유저스페이스 proxy 모드에 비해 오버헤드가 줄어듭니다.</li>
  <li>단점으로는 iptables 규칙이 많아 질 경우 모든 규칙 평가 하는데 지연이 발생할 수 있습니다.</li>
  <li>또한 장애시 모든 규칙을 확인하기 어려워 장애 처리에 불리합니다.</li>
</ul>

<h4 id="ipvs-proxy-모드">ipvs proxy 모드</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_10.png" alt="img.png" loading="lazy" width="939" height="274"></p>

<ul>
  <li>IPVS Mode는 Linue Kernel에서 제공하는 L4 Load Balacner인 IPVS가 Service Proxy 역할을 수행하는 Mode입니다.</li>
  <li>Packet Load Balancing 수행시 IPVS가 iptables보다 높은 성능을 보이기 때문에 IPVS Mode는 iptables Mode보다 높은 성능을 보여준다</li>
  <li>IPVS 프록시 모드는 iptables 모드와 유사한 netfilter hook 기능을 기반으로 하지만, 해시 테이블을 기본 데이터 구조로 사용하고 <strong>커널 스페이스</strong>에서 동작하여 효율 적으로 동작합니다.</li>
  <li>다른 프록시 모드와 비교했을 때, IPVS 모드는 높은 네트워크 트래픽 처리량도 지원합니다.</li>
</ul>

<h4 id="nftables-proxy-모드">nftables proxy 모드</h4>
<ul>
  <li>nftables 는 iptables를 대체하기 위해 개발된 패킷 필터링 프레임워크로, iptables 보다 더 유연하고 강력한 규칙 설정을 제공합니다.</li>
  <li>하지만 아직  실험적으로 개발중인 단계로 실무에서는 ipvs proxy 모드를 권장합니다.</li>
</ul>

<h4 id="ebpf-모드--xdp">eBPF 모드 + XDP</h4>

<p><img src="/assets/2024/kans-3th/w4/20240928_kans_w4_11.png" alt="img.png" class="w-90 image-center" loading="lazy" width="1205" height="1232"></p>

<ul>
  <li>앞에서 알아보았던 모든 모드들이 netfilter 기반인데 반해, eBPF 모드 +  XDP 는 netfilter 전 단계에서 트래픽 라우팅을 처리하여 훨씬 효율 적입니다. calico나 cilium을 사용하여서 eBPF 모드를 사용할 수 있습니다.</li>
</ul>

<hr>

<h2 id="service-lb-ipam">Service LB-IPAM</h2>

<p><img src="/assets/2025/cilium/w4/20250810_cilium_w4_10.png" alt="img.png" class="image-center" loading="lazy" width="1280" height="742">
<em class="image-caption">출처 : <a href="https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/#load-balancer-ipam">https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/</a></em></p>

<ul>
  <li>LoadBalancer IP Address Management (LB IPAM) 소개 - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/">Docs</a>, <a href="https://www.youtube.com/watch?v=amC00re6-5k">Youtube</a>
    <ul>
      <li>LB-IPAM은 Cilium에서 제공하는 LoadBalancer IP Address Management 기능으로 LoadBalancer 서비스의 External-IP 를 관리합니다. 이 기능은 AWS 등의 클라우드 제공업체에서 제공하는 기능이지만
Private Cloud 환경에서는 K8S 자체에서는 지원하지 않기 때문에 MetalLB와 같은 솔루션을 사용해야 합니다.</li>
      <li>Cilium은 LB-IPAM을 통해서 MetalLB와 같은 솔루션 없이도 LoadBalancer 서비스를 지원합니다.</li>
      <li>LB-IPAM은 <code class="language-plaintext highlighter-rouge">Cilium BGP Control Plane</code> 및 <code class="language-plaintext highlighter-rouge">L2 Announcements</code> / <code class="language-plaintext highlighter-rouge">L2 Aware LB</code> 등의 기능과 함께 사용됩니다. LB-IPAM이 서비스 객체 및 기타 기능에 IP를 할당하고, <code class="language-plaintext highlighter-rouge">L2 Announcements</code>를 통해서 IP를 노출하고, <code class="language-plaintext highlighter-rouge">L2 Aware LB</code>를 통해서 IP를 라우팅합니다.</li>
      <li>LB IPAM은 항상 활성화되어 있지만 휴면 상태입니다. 첫 번째 IP 풀이 클러스터에 추가되면 컨트롤러가 활성화됩니다.</li>
      <li>기능
        <ul>
          <li>Service Selectors - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#service-selectors">Docs</a>
</li>
          <li>Disabling a Pool - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#disabling-a-pool">Docs</a>
</li>
          <li>Service 사용 확인 - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#services">Docs</a>
</li>
          <li>LoadBalancerClass : BGP or L2 지정 - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#loadbalancerclass">Docs</a>
</li>
          <li>Requesting IPs : 특정 Service에 EX-IP를 직접 설정 - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#loadbalancerclass">Docs</a>
</li>
          <li>Sharing Keys : EX-IP 1개를 각기 다른 Port 를 통해서 사용 - <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#requesting-ips">Docs</a>
</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>[k8s 클러스터 내부] webpod 서비스를 LoadBalancer Type 설정 with Cilium LB IPAM</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get CiliumLoadBalancerIPPool <span class="nt">-A</span>
<span class="c"># =&gt; No resources found</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 아직 등록된 IP Pool이 없으므로, CiliumLoadBalancerIPPool 리소스가 없습니다.&lt;/span&gt;</span>

<span class="c"># cilium ip pool 생성</span>
<span class="c"># 충돌나지 않는지 대역 확인 할 것!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"  # v1.17 : cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: "cilium-lb-ippool"
spec:
  blocks:
  - start: "192.168.10.211"
    stop:  "192.168.10.215"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumloadbalancerippool.cilium.io/cilium-lb-ippool created</span>

<span class="nv">$ </span>kubectl get CiliumLoadBalancerIPPool <span class="nt">-A</span>
<span class="c"># =&gt; NAME               DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-lb-ippool   false      False         5               13s</span>

<span class="c"># CiliumLoadBalancerIPPool 축약어 : ippools,ippool,lbippool,lbippools</span>
<span class="nv">$ </span>kubectl api-resources | <span class="nb">grep</span> <span class="nt">-i</span> CiliumLoadBalancerIPPool
<span class="c"># =&gt; ciliumloadbalancerippools           ippools,ippool,lbippool,lbippools   cilium.io/v2                      false        CiliumLoadBalancerIPPool</span>

<span class="nv">$ </span>kubectl get ippools
<span class="c"># =&gt; NAME               DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-lb-ippool   false      False         5               101s</span>

<span class="c"># webpod 서비스를 LoadBalancer Type 변경 설정</span>
<span class="nv">$ </span>kubectl patch svc webpod <span class="nt">-p</span> <span class="s1">'{"spec":{"type":"LoadBalancer"}}'</span>
<span class="c"># =&gt; service/webpod patched</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get svc webpod
<span class="c"># =&gt; NAME     TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)        AGE</span>
<span class="c">#    webpod   LoadBalancer   10.96.129.95   &lt;span style="color: green;"&gt;192.168.10.211&lt;/span&gt;   80:32203/TCP   3h17m</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 webpod 서비스가 LoadBalancer Type으로 변경되었으며, EXTERNAL-IP로 Cilium LB IP Pool에서 할당된 IP가 설정되었습니다.&lt;/span&gt;</span>

<span class="c"># LBIP로 curl 요청 확인 : k8s 노드들에서 LB EXIP로 통신 가능!</span>
<span class="nv">$ </span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span>
<span class="c"># =&gt; 192.168.10.211</span>
<span class="nv">$ LBIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.0.131</span>
<span class="c">#    IP: fe80::48ca:7aff:fee8:da55</span>
<span class="c">#    RemoteAddr: 172.20.0.201:38068</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 192.168.10.211</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.0.131</span>
<span class="c">#    IP: fe80::48ca:7aff:fee8:da55</span>
<span class="c">#    RemoteAddr: 172.20.0.89:33706</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 192.168.10.211</span>
<span class="c">#    User-Agent: curl/8.14.1</span>
<span class="c">#    Accept: */*</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname   <span class="c"># 대상 파드 이름 출력</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr <span class="c"># 대상 파드 입장에서 소스 IP 출력(Layer3)</span>
<span class="c"># =&gt; RemoteAddr: 172.20.0.89:46452</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 curl-pod의 파드 IP가 소스 IP로 출력됩니다.&lt;/span&gt;</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr <span class="c"># k8s-ctr 노드에서 curl 요청시 소스 IP 출력</span>
<span class="c"># =&gt; RemoteAddr: 172.20.0.201:35196</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s-ctr 노드의 cilium_host의 IP가 출력됩니다.&lt;/span&gt;</span>

<span class="c"># 반복 접속 : </span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      38 Hostname: webpod-697b545f57-66grn</span>
<span class="c">#         35 Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#         27 Hostname: webpod-697b545f57-24ck5</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 각 노드의 webpod 파드로 Loadbalancing이 잘 이루어지고 있습니다.&lt;/span&gt;</span>

<span class="c"># IP 할당 확인</span>
<span class="nv">$ </span>kubectl get ippools
<span class="c"># =&gt; NAME               DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-lb-ippool   false      False         4               8m</span>
<span class="nv">$ </span>kubectl get ippools <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].status.conditions[?(@.type!="cilium.io/PoolConflict")]}'</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "lastTransitionTime": "2025-08-09T08:27:06Z",</span>
<span class="c">#      "message": "5",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsTotal"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "lastTransitionTime": "2025-08-09T08:27:06Z",</span>
<span class="c">#      "message": "4",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsAvailable"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "lastTransitionTime": "2025-08-09T08:27:06Z",</span>
<span class="c">#      "message": "1",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsUsed"</span>
<span class="c">#    }</span>

<span class="nv">$ </span>kubectl get svc webpod <span class="nt">-o</span> json | jq
<span class="nv">$ </span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status}'</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "conditions": [</span>
<span class="c">#        {</span>
<span class="c">#          "lastTransitionTime": "2025-08-09T08:29:01Z",</span>
<span class="c">#          "message": "",</span>
<span class="c">#          "reason": "satisfied",</span>
<span class="c">#          "status": "True",</span>
<span class="c">#          "type": "cilium.io/IPAMRequestSatisfied"</span>
<span class="c">#        }</span>
<span class="c">#      ],</span>
<span class="c">#      "loadBalancer": {</span>
<span class="c">#        "ingress": [</span>
<span class="c">#          {</span>
<span class="c">#            "ip": "192.168.10.211",</span>
<span class="c">#            "ipMode": "VIP"</span>
<span class="c">#          }</span>
<span class="c">#        ]</span>
<span class="c">#      }</span>
<span class="c">#    }</span>
</code></pre></div></div>

<ul>
  <li>[k8s 클러스터 외부] webpod 서비스를 LoadBalancer External IP로 호출 확인</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># router : K8S 외부에서 통신 불가! </span>
<span class="nv">$ LBIP</span><span class="o">=</span>192.168.10.211
<span class="nv">$ </span>curl <span class="nt">--connect-timeout</span> 1 <span class="nv">$LBIP</span>
<span class="c"># =&gt; curl: (28) Failed to connect to 192.168.10.211 port 80 after 1002 ms: Timeout was reached</span>
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 1
<span class="c"># =&gt; ARPING 192.168.10.211</span>
<span class="c">#    Timeout</span>
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 100000
<span class="c"># =&gt; ARPING 192.168.10.211</span>
<span class="c">#    Timeout</span>
<span class="c">#    Timeout</span>
<span class="c">#    Timeout</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 클러스터 외부에서는 webpod 서비스의 LoadBalancer External IP로 통신이 불가능합니다.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   LB External IP가 외부로 광고(Announcement) 되지 않기 때문입니다.&lt;/span&gt;</span>
</code></pre></div></div>

<hr>

<h2 id="cilium-l2-announcement">Cilium L2 Announcement</h2>

<h3 id="참고-metallb-layer2-모드">(참고) MetalLB Layer2 모드</h3>

<ul>
  <li><a href="https://metallb.universe.tf/concepts/layer2/">Docs</a></li>
  <li>MetalLB는 Layer2 모드에서 BGP를 사용하지 않고, ARP(IPv4) 또는 NDP(IPv6)를 사용하여 IP 주소를 광고합니다.</li>
  <li>하나의 노드 (Leader Node)에서만 IP 주소를 광고하며, Leader Node가 장애가 발생하면 다른 노드가 Leader Node로 승격되어 IP 주소를 광고합니다.</li>
  <li>MetalLB의 장점은 별도의 하드웨어나 라우팅 장치가 없어도 어떠한 이더넷 네트워크에서도 동작한다는 점입니다.</li>
  <li>
    <p>아래는 MetalLB Layer2 모드에서 GARP 패킷을 통해 VIP(Virtual IP : 서비스의 IP)를 광고하는 예시입니다.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_11.png" alt="img.png" class="image-center w-80" loading="lazy" width="1074" height="439">
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_12.png" alt="img_1.png" class="image-center w-80" loading="lazy" width="1100" height="231"></p>
  </li>
  <li>MetalLB Layer 2 모드에서는 기본적으로 모든 트래픽이 Leader Node로 전달되며, kube-proxy 등을 통해 각 노드로 트래픽이 분산됩니다.</li>
  <li>
    <p>이로 인해 Leader Node에 장애가 발생하면 트래픽이 중단될 수 있습니다.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_13.png" alt="img_2.png" class="image-center w-80" loading="lazy" width="1106" height="553"></p>
  </li>
  <li>Leader Node가 장애가 발생하면, 다른 노드가 Leader Node로 승격되어 IP 주소를 광고합니다. 
이때 새로운 Leader Node가 IP 주소를 GARP로 광고하기 전에 일정 시간 동안 트래픽이 중단될 수 있습니다.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_14.png" alt="img_3.png" class="image-center w-80" loading="lazy" width="1087" height="365">
</li>
</ul>

<h3 id="cilium-layer-2-l2-announcement-using-arp">Cilium Layer 2 (L2) Announcement Using ARP</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/l2-announcements/">Docs</a></li>
  <li>L2 Announcements은 로컬 영역 네트워크에서 서비스를 가시화하고 도달할 수 있도록 하는 기능입니다.</li>
  <li>이 기능은 주로 사무실이나 캠퍼스 네트워크와 같은 BGP 기반 라우팅 없이 네트워크 내에서 
온프레미스 배포를 목적으로 합니다.</li>
  <li>이 기능을 사용하면 ExternalIPs 또는 LoadBalancer IP에 대한 ARP 쿼리에 응답합니다. 
이러한 IP는 여러 노드에 있는 VIP(Virtual IP)이므로 각 서비스에 대해 한 번에 하나의 노드가 
ARP 쿼리에 응답하고 MAC 주소로 응답합니다. 
이 노드는 서비스 로드 밸런싱 기능으로 로드 밸런싱을 수행하여 north/south(내부&lt;=&gt;외부) 로드 밸런서 역할을 합니다.</li>
  <li>이 기능의 장점은 각 서비스가 고유한 IP를 사용할 수 있어 여러 서비스가 동일한 포트 번호를 사용할 
수 있다는 점입니다. NodePort를 사용할 때 트래픽을 보낼 호스트를 결정하는 것은 클라이언트의 몫이며, 
노드가 다운되면 IP+Port 조합을 사용할 수 없게 됩니다. L2 Announcements를 통해 서비스 VIP는 다른 노드로 마이그레이션하면 계속 작동하게 됩니다.
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_15.png" alt="img.png" class="image-center" loading="lazy" width="1280" height="530">
<img src="/assets/2025/cilium/w4/20250810_cilium_w4_16.png" alt="img_1.png" class="image-center" loading="lazy" width="1280" height="600">
</li>
</ul>

<h5 id="k8s-클러스터-외부-webpod-서비스를-loadbalancer-external-ip로-호출확인">[k8s 클러스터 외부] webpod 서비스를 LoadBalancer External IP로 호출확인</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 모니터링 : router VM</span>
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 100000
<span class="c"># =&gt; ARPING 192.168.10.211</span>
<span class="c">#    Timeout</span>
<span class="c">#    Timeout</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 설정 업그레이드 및 CiliumL2AnnouncementPolicy을 통해 정책 설정 시점부터 통신이 됩니다.&lt;/span&gt;</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.211): index=0 time=1.101 msec</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.211): index=1 time=1.967 msec</span>
<span class="c">#    ...</span>

<span class="c"># 설정 업그레이드</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--namespace</span> kube-system <span class="nt">--version</span> 1.18.0 <span class="nt">--reuse-values</span> <span class="se">\</span>
   <span class="nt">--set</span> l2announcements.enabled<span class="o">=</span><span class="nb">true</span> 
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>

<span class="nv">$ </span>kubectl rollout restart <span class="nt">-n</span> kube-system ds/cilium
<span class="nv">$ </span>watch <span class="nt">-d</span> kubectl get pod <span class="nt">-A</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg config <span class="nt">--all</span> | <span class="nb">grep </span>EnableL2Announcements
<span class="c"># =&gt; EnableL2Announcements             : true</span>

<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>enable-l2
<span class="c"># =&gt; enable-l2-announcements                           true</span>
<span class="c">#    enable-l2-neigh-discovery                         false</span>

<span class="c"># 정책 설정 : arp 광고하게 될 service 와 node 지정(controlplane 제외) -&gt; 설정 직후 arping 확인!</span>
<span class="c">## 제약사항 : L2 ARP 모드에서 LB IPPool 은 같은 네트워크 대역에서만 유효. -&gt; k8s-w0 을 제외한 이유. 포함 시 리더 노드 선정 시 동작 실패 상황 발생!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2alpha1"  # not v2
kind: CiliumL2AnnouncementPolicy
metadata:
  name: policy1
spec:
  serviceSelector:
    matchLabels:
      app: webpod
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/hostname
        operator: NotIn
        values:
          - k8s-w0
  interfaces:
  - ^eth[1-9]+
  externalIPs: true
  loadBalancerIPs: true
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliuml2announcementpolicy.cilium.io/policy1 created</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 정책 설정 후 부터 arping이 성공합니다.&lt;/span&gt;</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; NAME                                   HOLDER                                                                      AGE</span>
<span class="c">#    cilium-l2announce-default-webpod       k8s-w1                                                                      2m56s</span>
<span class="c">#    ...</span>

<span class="c"># 현재 리더 역할 노드 확인</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease/cilium-l2announce-default-webpod <span class="nt">-o</span> yaml | yq
<span class="c"># =&gt; ...</span>
<span class="c">#    spec:</span>
<span class="c">#      acquireTime: "2025-08-09T12:01:16.067503Z"</span>
<span class="c">#      holderIdentity: k8s-w1</span>
<span class="c">#      leaseDurationSeconds: 15</span>
<span class="c">#      leaseTransitions: 0</span>
<span class="c">#      renewTime: "2025-08-09T12:05:03.883829Z"</span>

<span class="c"># cilium 파드 이름 지정</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-ctr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w0  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CILIUMPOD0</span> <span class="nv">$CILIUMPOD1</span> <span class="nv">$CILIUMPOD2</span>
<span class="c"># =&gt; cilium-9dp58 cilium-tj7tw cilium-nftrl</span>

<span class="c"># 현재 해당 IP에 대한 리더가 위치한 노드의 cilium-agent 파드 내에서 정보 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD0</span> <span class="nt">--</span> cilium-dbg shell <span class="nt">--</span> db/show l2-announce
<span class="c"># =&gt; IP   NetworkInterface</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD1</span> <span class="nt">--</span> cilium-dbg shell <span class="nt">--</span> db/show l2-announce
<span class="c"># =&gt; IP               NetworkInterface</span>
<span class="c">#    192.168.10.211   eth1</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 리더 파드가 k8s-w1에 있기 때문에 k8s-w1의 IP와 Network Interface만 나옵니다.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nv">$CILIUMPOD2</span> <span class="nt">--</span> cilium-dbg shell <span class="nt">--</span> db/show l2-announce
<span class="c"># =&gt; IP   NetworkInterface</span>

<span class="c"># 로그 확인</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs ds/cilium | <span class="nb">grep</span> <span class="s2">"l2"</span>

<span class="c"># router VM : LBIP로 curl 요청 확인</span>
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 1000

<span class="nv">$ </span>curl <span class="nt">--connect-timeout</span> 1 <span class="nv">$LBIP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b46tz</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.0.131</span>
<span class="c">#    IP: fe80::48ca:7aff:fee8:da55</span>
<span class="c">#    RemoteAddr: 172.20.1.197:44454</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 192.168.10.211</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>

<span class="c"># VIP 에 대한 mac 주소가 리더 노드의 mac 주소와 동일함을 확인</span>
<span class="nv">$ </span>arp <span class="nt">-a</span>
<span class="c"># =&gt; ? (192.168.10.211) at 08:00:27:8e:9b:f8 [ether] on eth1</span>
<span class="c">#    ? (192.168.10.101) at 08:00:27:8e:9b:f8 [ether] on eth1</span>
<span class="c">#    ? (192.168.10.100) at 08:00:27:42:b2:8c [ether] on eth1</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-24ck5</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr
<span class="c"># =&gt; RemoteAddr: 192.168.10.200:57078</span>

<span class="c"># 리더 노드가 아닌 다른 노드에 webpod 통신 시, SNAT 됨 : arp 동작(리더 노드)으로 인한 제약 사항</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr<span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; RemoteAddr: 192.168.10.200:57284</span>
<span class="c">#    RemoteAddr: 192.168.10.200:57294   </span>
<span class="c">#    RemoteAddr: 172.20.1.197:57306   # &lt;span style="color: green;"&gt;👉 leader node인 k8s-w1이 아닌 다른 노드의 파드가 응답한 경우 SNAT으로 인해 다른 IP가 표시됨&lt;/span&gt;</span>
<span class="c">#    RemoteAddr: 172.20.1.197:57310 </span>
<span class="c">#    RemoteAddr: 192.168.10.200:57364</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h5 id="l2-announcement-리더-노드에-주입-후-failover-확인">L2 Announcement 리더 노드에 주입 후 Failover 확인</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 신규 터미널 (router) : 반복 호출</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>

<span class="c"># 현재 리더 노드 확인</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; NAME                                   HOLDER                                                                      AGE</span>
<span class="c">#    cilium-l2announce-default-webpod       k8s-w1                                                                      19m</span>

<span class="c"># 리더 노드 강제 reboot</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1  <span class="nb">sudo </span>reboot
<span class="c"># &lt;span style="color: green;"&gt;👉 리더 노드 재부팅시 curl이 타임아웃 되어 통신이 안 됩니다.&lt;/span&gt;</span>

<span class="c"># 신규 터미널 (router) : arp 변경(갱신) 확인</span>
<span class="nv">$ </span>arp <span class="nt">-a</span>
<span class="c"># =&gt; ? (192.168.10.211) at &lt;span style="color: green;"&gt;08:00:27:42:b2:8c&lt;/span&gt; [ether] on eth1</span>
<span class="c">#    ? (192.168.10.101) at 08:00:27:8e:9b:f8 [ether] on eth1</span>
<span class="c">#    ? (192.168.10.100) at 08:00:27:42:b2:8c [ether] on eth1</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 VIP(192.168.10.211)의 MAC 주소가 k8s-ctr의 eth1로 변경되었습니다.&lt;/span&gt;</span>

<span class="c"># 현재 리더 노드 확인</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; cilium-l2announce-default-webpod       k8s-ctr                                                                     24m</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 예상대로 k8s-ctr 노드가 리더 노드로 승격되었습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="service-lb-ipam-기능">Service LB-IPAM 기능</h3>

<h5 id="service-추가시-동작">Service 추가시 동작</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netshoot-web
  labels:
    app: netshoot-web
spec:
  replicas: 3
  selector:
    matchLabels:
      app: netshoot-web
  template:
    metadata:
      labels:
        app: netshoot-web
    spec:
      terminationGracePeriodSeconds: 0
      containers:
        - name: netshoot
          image: nicolaka/netshoot
          ports:
            - containerPort: 8080
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          command: ["sh", "-c"]
          args:
            - |
              while true; do 
                { echo -e "HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="sh">Content-Type: text/plain</span><span class="se">\r\n\r\n</span><span class="sh">OK from </span><span class="se">\$</span><span class="sh">POD_NAME"; } | nc -l -p 8080 -q 1;
              done
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/netshoot-web created</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: netshoot-web
  labels:
    app: netshoot-web
spec:
  type: LoadBalancer
  selector:
    app: netshoot-web
  ports:
    - name: http
      port: 80      
      targetPort: 8080
</span><span class="no">EOF
</span><span class="c"># =&gt; service/netshoot-web created</span>

<span class="c"># LB IP 확인</span>
<span class="nv">$ </span>kubectl get svc netshoot-web
<span class="c"># =&gt; NAME           TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)        AGE</span>
<span class="c">#    netshoot-web   LoadBalancer   10.96.170.130   &lt;span style="color: green;"&gt;192.168.10.212&lt;/span&gt;   80:30240/TCP   8s</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2alpha1"  # not v2
kind: CiliumL2AnnouncementPolicy
metadata:
  name: policy2
spec:
  serviceSelector:
    matchLabels:
      app: netshoot-web
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/hostname
        operator: NotIn
        values:
          - k8s-w0
  interfaces:
  - ^eth[1-9]+
  externalIPs: true
  loadBalancerIPs: true
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliuml2announcementpolicy.cilium.io/policy2 created</span>

<span class="c"># Service 별로 리더 노드가 다름 : 즉, 외부 인입 시 Service 별로 나름 분산(?) 처리.. </span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; cilium-l2announce-default-netshoot-web   k8s-w1                                                                      36s</span>
<span class="c">#    cilium-l2announce-default-webpod         k8s-ctr                                                                     116m</span>

<span class="c"># 호출 확인</span>
<span class="c">## LBIP로 curl 요청 확인 : k8s 노드들에서 LB EXIP로 통신 가능!</span>
<span class="nv">$ </span>kubectl get svc netshoot-web <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span>
<span class="c"># =&gt; 192.168.10.212</span>
<span class="nv">$ LB2IP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc netshoot-web <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-jsh8p</span>

<span class="c">## 신규터미널 (router)</span>
<span class="nv">$ LB2IP</span><span class="o">=</span>192.168.10.212
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LB2IP</span> <span class="nt">-c</span> 2
<span class="c"># =&gt; ARPING 192.168.10.212</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.212): index=0 time=452.250 usec</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.212): index=1 time=580.375 usec</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.10.212 statistics ---</span>
<span class="c">#    2 packets transmitted, 2 packets received,   0% unanswered (0 extra)</span>
<span class="c">#    rtt min/avg/max/std-dev = 0.452/0.516/0.580/0.064 ms</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-5zb78</span>
</code></pre></div></div>

<ul>
  <li>특이하게도 Service별로 리더 노드가 다릅니다. 서비스가 여러개인 경우에는 서비스 별로 분산되는 효과가 있어서
리더 노드에 부하가 집중되는 문제가 다소 완화될 것으로 보입니다.</li>
</ul>

<h5 id="requesting-ips">Requesting IPs</h5>

<ul>
  <li>특정 Service의 External IP를 직접 설정할 수 있습니다. <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#loadbalancerclass">Docs</a>
</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Service netshoot-web 에 EX-IP를 직접 지정 변경</span>
<span class="nv">$ </span>kubectl edit svc netshoot-web 
<span class="c"># 또는 k9s → svc → &lt;e&gt; edit</span>
<span class="nt">---</span>
<span class="c">## metadata.annotations 아래 아래 추가</span>
  annotations:
    <span class="s2">"lbipam.cilium.io/ips"</span>: <span class="s2">"192.168.10.215"</span>
<span class="nt">---</span>
<span class="c"># =&gt; service/netshoot-web edited</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc netshoot-web
<span class="c"># =&gt; NAME           TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)        AGE</span>
<span class="c">#    netshoot-web   LoadBalancer   10.96.170.130   &lt;span style="color: green;"&gt;192.168.10.215&lt;/span&gt;   80:30240/TCP   9m6s</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 annotation을 통해 지정한 EXTERNAL-IP(192.168.10.215)가 설정되었습니다.&lt;/span&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc netshoot-web <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span>
<span class="c"># =&gt; 192.168.10.215</span>
<span class="nv">$ LB2IP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc netshoot-web <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-5zb78</span>
</code></pre></div></div>

<h5 id="sharing-keys">Sharing Keys</h5>

<ul>
  <li>External IP 1개를 각기 다른 Port를 통해서 사용할 수 있습니다. <a href="https://docs.cilium.io/en/stable/network/lb-ipam/#requesting-ips">Docs</a>
</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: netshoot-web2
  labels:
    app: netshoot-web
spec:
  type: LoadBalancer
  selector:
    app: netshoot-web
  ports:
    - name: http
      port: 8080      
      targetPort: 8080
</span><span class="no">EOF
</span><span class="c"># =&gt; service/netshoot-web2 created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-web
<span class="c"># =&gt; NAME            TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)          AGE</span>
<span class="c">#    netshoot-web    LoadBalancer   10.96.170.130   192.168.10.215   80:30240/TCP     12m</span>
<span class="c">#    netshoot-web2   LoadBalancer   10.96.75.231    192.168.10.212   8080:31278/TCP   14s</span>

<span class="c"># Service netshoot-web에 annotations 추가</span>
<span class="nv">$ </span>kubectl edit svc netshoot-web 
<span class="c"># 또는 k9s → svc → &lt;e&gt; edit</span>
<span class="nt">---</span> 
<span class="c">## metadata.annotations 아래 아래 추가</span>
  annotations:
    <span class="s2">"lbipam.cilium.io/ips"</span>: <span class="s2">"192.168.10.215"</span>
    <span class="s2">"lbipam.cilium.io/sharing-key"</span>: <span class="s2">"1234"</span>
<span class="nt">---</span>
<span class="c"># =&gt; service/netshoot-web edited</span>

<span class="c"># 동일하게 netshoot-web2 서비스에도 annotations 추가</span>
<span class="nv">$ </span>kubectl edit svc netshoot-web2 
<span class="c"># =&gt; service/netshoot-web2 edited</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>netshoot-web
<span class="c"># =&gt; NAME            TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)          AGE</span>
<span class="c">#    netshoot-web    LoadBalancer   10.96.170.130   192.168.10.215   80:30240/TCP     18m</span>
<span class="c">#    netshoot-web2   LoadBalancer   10.96.75.231    192.168.10.215   8080:31278/TCP   5m36s</span>

<span class="c"># sharing-key 사용되는 IP는 모든 같은 리더 노드 사용</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; cilium-l2announce-default-netshoot-web    k8s-w1                                                                      17m</span>
<span class="c">#    cilium-l2announce-default-netshoot-web2   k8s-w1                                                                      5m45s</span>
<span class="c">#    cilium-l2announce-default-webpod          k8s-ctr                                                                     133m</span>

<span class="c"># 호출 확인</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-5zb78</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 netshoot-web 서비스 응답&lt;/span&gt;</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>:8080
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-4fsnp</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 netshoot-web2 서비스 응답&lt;/span&gt;</span>

<span class="c"># 신규터미널 (router)</span>
<span class="nv">$ LB2IP</span><span class="o">=</span>192.168.10.215
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LB2IP</span> <span class="nt">-c</span> 2
<span class="c"># =&gt; ARPING 192.168.10.215</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.215): index=0 time=1.236 msec</span>
<span class="c">#    60 bytes from 08:00:27:8e:9b:f8 (192.168.10.215): index=1 time=372.519 usec</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.10.215 statistics ---</span>
<span class="c">#    2 packets transmitted, 2 packets received,   0% unanswered (0 extra)</span>
<span class="c">#    rtt min/avg/max/std-dev = 0.373/0.804/1.236/0.432 ms</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-jsh8p</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LB2IP</span>:8080
<span class="c"># =&gt; OK from netshoot-web-5c59d94bd4-5zb78</span>
</code></pre></div></div>

<hr>

<h2 id="마치며">마치며</h2>

<p>이번 포스트에서도 노드의 파드들간 통신에 대해서 알아보았습니다.
가장 관심 있게 본 점은 Cilium의 LoadBalancer IPAM 기능을 통해서 MetalLB (L2 모드)를 대체할 수 있다는 것입니다.
MetalLB라는 추가적인 구성요소 없이 Cilium 만으로 LoadBalancer Service를 구현할 수 있다는 점이 매력적인것 같습니다. <img class="emoji" title=":relaxed:" alt=":relaxed:" src="https://github.githubassets.com/images/icons/emoji/unicode/263a.png" height="20" width="20" loading="lazy"></p>

<p>점점 더 Cilium의 매력에 빠져드는것 같습니다. 다음 주에도 Cilium에 대해서 더 알아보도록 하겠습니다. <img class="emoji" title=":smile:" alt=":smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png" height="20" width="20" loading="lazy"></p>

<ul>
  <li>약어 소개
    <ul>
      <li>
<strong>S.IP</strong> : Source IP, 출발지(소스) IP</li>
      <li>
<strong>D.IP</strong> : Destination IP, 도착치(목적지) IP</li>
      <li>
<strong>S.Port</strong> : Source Port, 출발지(소스) 포트</li>
      <li>
<strong>D.Port</strong> : Destination Port, 도착지(목적지) 포트</li>
      <li>
<strong>NAT</strong> : Network Address Translation, 네트워크 주소 변환</li>
      <li>
<strong>SNAT</strong> : Source IP 를 NAT 처리, 일반적으로 출발지 IP를 변환</li>
      <li>
<strong>DNAT</strong> : Destination IP 를 NAT 처리, 일반적으로 목적지 IP와 목적지 포트를 변환</li>
    </ul>
  </li>
</ul>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#%EC%8B%A4%EC%8A%B5-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1">실습 환경 구성</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC-%ED%8C%8C%EC%9D%BC">실습환경 배포 파일</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%EB%B6%84%EC%84%9D-%ED%88%B4-%EC%84%A4%EC%B9%98">실습환경 배포 및 분석 툴 설치</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#native-routing-mode">Native Routing Mode</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%83%98%ED%94%8C-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%99%95%EC%9D%B8">샘플 애플리케이션 배포 및 확인</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%86%B5%EC%8B%A0-%ED%99%95%EC%9D%B8-%EB%B0%8F-hubble%EB%A1%9C-%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">통신 확인 및 hubble로 모니터링</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#overlay-network-encapsulated-mode">Overlay Network (Encapsulated) Mode</a>
<ul>
<li class="toc-entry toc-h3"><a href="#vxlan-%EC%84%A4%EC%A0%95">VXLAN 설정</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%8C%8C%EB%93%9C%EA%B0%84-%ED%86%B5%EC%8B%A0-%ED%99%95%EC%9D%B8">파드간 통신 확인</a></li>
<li class="toc-entry toc-h3">
<a href="#%EB%8F%84%EC%A0%84%EA%B3%BC%EC%A0%9C2-vxlan-%EB%8C%80%EC%8B%A0-geneve-%EB%AA%A8%EB%93%9C-%EC%82%AC%EC%9A%A9">도전과제2. VXLAN 대신 GENEVE 모드 사용</a>
<ul>
<li class="toc-entry toc-h4"><a href="#geneve-%EC%86%8C%EA%B0%9C">GENEVE 소개</a></li>
<li class="toc-entry toc-h4"><a href="#geneve-%EC%8B%A4%EC%8A%B5">GENEVE 실습</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#k8s-service">K8S Service</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EB%82%B4%EB%B6%80%EB%A5%BC-%EC%99%B8%EB%B6%80%EC%97%90-%EB%85%B8%EC%B6%9C%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95%EC%9D%98-%EB%B0%9C%EC%A0%84%EB%8B%A8%EA%B3%84">클러스터 내부를 외부에 노출하는 방법의 발전단계</a></li>
<li class="toc-entry toc-h3">
<a href="#service-%EC%A2%85%EB%A5%98">Service 종류</a>
<ul>
<li class="toc-entry toc-h4"><a href="#clusterip-%ED%83%80%EC%9E%85">ClusterIP 타입</a></li>
<li class="toc-entry toc-h4"><a href="#nodeport-%ED%83%80%EC%9E%85">NodePort 타입</a></li>
<li class="toc-entry toc-h4"><a href="#loadbalancer-%ED%83%80%EC%9E%85">LoadBalancer 타입</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4%EC%9D%98-%EA%B5%AC%EC%A1%B0">서비스의 구조</a></li>
<li class="toc-entry toc-h3">
<a href="#kube-proxy-%EB%AA%A8%EB%93%9C">kube-proxy 모드</a>
<ul>
<li class="toc-entry toc-h4"><a href="#userspace-proxy-%EB%AA%A8%EB%93%9C-%ED%98%84%EC%9E%AC%EB%8A%94-%EB%AF%B8%EC%82%AC%EC%9A%A9">userspace proxy 모드 (현재는 미사용)</a></li>
<li class="toc-entry toc-h4"><a href="#iptables-proxy-%EB%AA%A8%EB%93%9C">iptables proxy 모드</a></li>
<li class="toc-entry toc-h4"><a href="#ipvs-proxy-%EB%AA%A8%EB%93%9C">ipvs proxy 모드</a></li>
<li class="toc-entry toc-h4"><a href="#nftables-proxy-%EB%AA%A8%EB%93%9C">nftables proxy 모드</a></li>
<li class="toc-entry toc-h4"><a href="#ebpf-%EB%AA%A8%EB%93%9C--xdp">eBPF 모드 + XDP</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#service-lb-ipam">Service LB-IPAM</a></li>
<li class="toc-entry toc-h2">
<a href="#cilium-l2-announcement">Cilium L2 Announcement</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%B0%B8%EA%B3%A0-metallb-layer2-%EB%AA%A8%EB%93%9C">(참고) MetalLB Layer2 모드</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-layer-2-l2-announcement-using-arp">Cilium Layer 2 (L2) Announcement Using ARP</a></li>
<li class="toc-entry toc-h3"><a href="#service-lb-ipam-%EA%B8%B0%EB%8A%A5">Service LB-IPAM 기능</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2025-08-10-Cilium-Week4/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2025-08-03-Cilium-Week3/">« [Cilium] Networking - 노드의 파드들간 통신 상세 part 1</a>
  
  
  <a class="next" href="/posts/2025-08-17-Cilium-Week5/">[Cilium] BGP Control Plane &amp; ClusterMesh »</a>
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2025-08-10-Cilium-Week4/";
this.page.identifier = "/posts/Cilium - Week4";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>

<!--      <div class="adsbygoogle-side">-->
<!--        &lt;!&ndash; ad_side &ndash;&gt;-->
<!--        <ins class="adsbygoogle "-->
<!--             style="display: block"-->
<!--             data-ad-client="ca-pub-6564723532026864"-->
<!--             data-ad-slot="1339398797"-->
<!--             data-ad-format="auto"-->
<!--             data-full-width-responsive="true"></ins>-->
<!--      </div>-->
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>공부 기록과 개발 이야기를 담은 블로그입니다.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6564723532026864" crossorigin="anonymous"></script>
    <!--<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>-->
  </body>

</html>
