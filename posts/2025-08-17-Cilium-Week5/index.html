<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[Cilium] BGP Control Plane &amp; ClusterMesh | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[Cilium] BGP Control Plane &amp; ClusterMesh">
<meta property="og:locale" content="ko">
<meta name="description" content="이번 포스트에서는 BGP를 통한 라우팅과 kind, cluster-mesh를 통한 멀티 클러스터 환경에서의 Cilium 동작을 살펴보겠습니다.">
<meta property="og:description" content="이번 포스트에서는 BGP를 통한 라우팅과 kind, cluster-mesh를 통한 멀티 클러스터 환경에서의 Cilium 동작을 살펴보겠습니다.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2025-08-17-Cilium-Week5/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2025-08-17-Cilium-Week5/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2025-08-17T00:10:18+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[Cilium] BGP Control Plane &amp; ClusterMesh">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-08-17T00:10:18+09:00","datePublished":"2025-08-17T00:10:18+09:00","description":"이번 포스트에서는 BGP를 통한 라우팅과 kind, cluster-mesh를 통한 멀티 클러스터 환경에서의 Cilium 동작을 살펴보겠습니다.","headline":"[Cilium] BGP Control Plane &amp; ClusterMesh","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2025-08-17-Cilium-Week5/"},"url":"https://sweetlittlebird.github.io/posts/2025-08-17-Cilium-Week5/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body class="body--contents">
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">소개</a><a class="page-link" href="/posts/">글 목록</a>
</div>
      </nav>
</div>
  
  <span id="scroll-indicator"></span>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[Cilium] BGP Control Plane &amp; ClusterMesh</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-08-17T00:10:18+09:00" itemprop="datePublished">2025년 08월 17일에 작성
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>목차</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#%EC%8B%A4%EC%8A%B5-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1">실습 환경 구성</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC-%ED%8C%8C%EC%9D%BC">실습환경 배포 파일</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC">실습환경 배포</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%83%98%ED%94%8C-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%86%B5%EC%8B%A0-%EB%AC%B8%EC%A0%9C-%ED%99%95%EC%9D%B8">샘플 애플리케이션 배포 및 통신 문제 확인</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#cilium-bgp-control-plane">Cilium BGP Control Plane</a>
<ul>
<li class="toc-entry toc-h4"><a href="#bgp%EC%84%A4%EC%A0%95-%ED%9B%84-%ED%86%B5%EC%8B%A0-%ED%99%95%EC%9D%B8">BGP 설정 후 통신 확인</a></li>
<li class="toc-entry toc-h3"><a href="#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0-%ED%9B%84-%ED%86%B5%EC%8B%A0">문제 해결 후 통신</a></li>
<li class="toc-entry toc-h3"><a href="#%EB%85%B8%EB%93%9C-%EC%9C%A0%EC%A7%80%EB%B3%B4%EC%88%98-k8s-w0-%EC%8B%A4%EC%8A%B5">노드 유지보수 (k8s-w0) 실습</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#kind">Kind</a>
<ul>
<li class="toc-entry toc-h3"><a href="#kind-%EC%86%8C%EA%B0%9C">Kind 소개</a></li>
<li class="toc-entry toc-h3">
<a href="#kind-%EC%84%A4%EC%B9%98">Kind 설치</a>
<ul>
<li class="toc-entry toc-h4"><a href="#docker-desktop-%EB%B0%8F-%ED%95%84%EC%88%98-%ED%88%B4-%EC%84%A4%EC%B9%98">Docker Desktop 및 필수 툴 설치</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#kind-%EA%B8%B0%EB%B3%B8-%EC%82%AC%EC%9A%A9---%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%99%95%EC%9D%B8">kind 기본 사용 - 클러스터 배포 및 확인</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#cluster-mesh">Cluster Mesh</a>
<ul>
<li class="toc-entry toc-h4"><a href="#kind-k8s-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-west-east-%EB%B0%B0%ED%8F%AC">kind k8s 클러스터 west, east 배포</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-cni-%EB%B0%B0%ED%8F%AC">Cilium CNI 배포</a></li>
<li class="toc-entry toc-h3"><a href="#clustermesh-%EB%B0%B0%ED%8F%AC">ClusterMesh 배포</a></li>
<li class="toc-entry toc-h3"><a href="#west-%ED%8C%8C%EB%93%9C---east-%ED%8C%8C%EB%93%9C-%EA%B0%84-%EC%A7%81%EC%A0%91-%ED%86%B5%EC%8B%A0-%ED%99%95%EC%9D%B8-with-static-routing">west 파드 &lt;-&gt; east 파드 간 직접 통신 확인 with static routing</a></li>
<li class="toc-entry toc-h3"><a href="#load-balancing--service-discovery">Load-Balancing &amp; Service Discovery</a></li>
<li class="toc-entry toc-h3"><a href="#service-affinity">Service Affinity</a></li>
<li class="toc-entry toc-h3"><a href="#clustermesh-apiserver-%ED%8C%8C%EB%93%9C-%EC%A0%95%EB%B3%B4-%ED%99%95%EC%9D%B8">clustermesh-apiserver 파드 정보 확인</a></li>
<li class="toc-entry toc-h3"><a href="#kind-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EC%82%AD%EC%A0%9C">kind 클러스터 삭제</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
    </div>
    <h2 id="들어가며">들어가며</h2>

<p>이번 포스트에서는 BGP를 통한 라우팅과 kind, cluster-mesh를 통한 멀티 클러스터 환경에서의 Cilium 동작을 살펴보겠습니다.</p>

<hr>

<h2 id="실습-환경-구성">실습 환경 구성</h2>

<ul>
  <li>이번 실습에서는 지난 실습과 마찬가지로 k8s-w0를 별도의 네트워크에 배치하고 router를 통해 k8s-w0와 k8s-ctr/w1 노드간 통신을 확인합니다. 하지만 이번 실습에서는 frr을 설치하여 BGP 라우팅을 통해 통신을 확인해보겠습니다.
<img src="/assets/2025/cilium/w5/20250817_cilium_w5_1.png" alt="20250817_cilium_w5_1.png" class="image-center image-bg" loading="lazy" width="1828" height="1022">
    <ul>
      <li>기본 배포 가상 머신 : k8s-ctr, k8s-w1, k8s-w0, router (<strong>frr 라우팅</strong>)</li>
      <li>
<strong>router</strong> : router : 192.168.<strong>10</strong>.0/24 ↔ 192.168.<strong>20</strong>.0/24 대역 라우팅 역할, k8s 에 join 되지 않은 서버이며, BGP 동작을 위해 <a href="https://docs.frrouting.org/en/stable-10.4/about.html">frr</a> 툴이 설치되어있습니다.</li>
      <li>
<strong>k8s-w0</strong> : k8s-ctr/w1 노드와 다른 네트워크 대역에 배치됩니다.</li>
      <li>실습 동작에 필요한 static routing이 설저된 상태로 배포 됩니다.</li>
    </ul>
  </li>
</ul>

<h3 id="실습환경-배포-파일">실습환경 배포 파일</h3>

<ul>
  <li>
    <p><strong>Vagrantfile</strong> : 가상머신 정의, 부팅 시 초기 프로비저닝 설정을 포함하는 Vagrantfile입니다.</p>

    <div class="language-ruby highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># Variables</span>
<span class="no">K8SV</span> <span class="o">=</span> <span class="s1">'1.33.2-1.1'</span> <span class="c1"># Kubernetes Version : apt list -a kubelet , ex) 1.32.5-1.1</span>
<span class="no">CONTAINERDV</span> <span class="o">=</span> <span class="s1">'1.7.27-1'</span> <span class="c1"># Containerd Version : apt list -a containerd.io , ex) 1.6.33-1</span>
<span class="no">CILIUMV</span> <span class="o">=</span> <span class="s1">'1.18.0'</span> <span class="c1"># Cilium CNI Version : https://github.com/cilium/cilium/tags</span>
<span class="no">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># max number of worker nodes</span>
  
<span class="c1"># Base Image  https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-24.04</span>
<span class="no">BOX_IMAGE</span> <span class="o">=</span> <span class="s2">"bento/ubuntu-24.04"</span>
<span class="no">BOX_VERSION</span> <span class="o">=</span> <span class="s2">"202508.03.0"</span>
  
<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1">#-ControlPlane Node</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-ctr"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
  
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">2560</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.100"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60000</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span> <span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/k8s-ctr.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">N</span><span class="p">,</span> <span class="no">CILIUMV</span><span class="p">,</span> <span class="no">K8SV</span> <span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/route-add1.sh"</span>
  <span class="k">end</span>
  
  <span class="c1">#-Worker Nodes Subnet1</span>
  <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="no">N</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.10</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="s2">"6000</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/k8s-w.sh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/route-add1.sh"</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="c1">#-Router Node</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"router"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"router"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">768</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"router"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.200"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60009</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.20.200"</span><span class="p">,</span> <span class="ss">auto_config: </span><span class="kp">false</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/router.sh"</span>
  <span class="k">end</span>
  
  <span class="c1">#-Worker Nodes Subnet2</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w0"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w0"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w0"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.20.100"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60010</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/k8s-w.sh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/5w/route-add2.sh"</span>
  <span class="k">end</span>
  
<span class="k">end</span>

</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>init_cfg.sh</strong> : args 참고하여 초기 설정을 수행하는 스크립트입니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime <span class="c"># Change Timezone</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Disable and turn off SWAP"</span>
swapoff <span class="nt">-a</span> <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'/swap/s/^/#/'</span> /etc/fstab
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Install Packages"</span>
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>apt-transport-https ca-certificates curl gpg <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># Download the public signing key for the Kubernetes package repositories.</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nt">-m</span> 755 /etc/apt/keyrings
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$1</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+)\..*/\1/p'</span><span class="si">)</span>
curl <span class="nt">-fsSL</span> https://pkgs.k8s.io/core:/stable:/v<span class="nv">$K8SMMV</span>/deb/Release.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/kubernetes-apt-keyring.gpg
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v</span><span class="nv">$K8SMMV</span><span class="s2">/deb/ /"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list.d/kubernetes.list
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
  
<span class="c"># packets traversing the bridge are processed by iptables for filtering</span>
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
<span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> <span class="o">&gt;&gt;</span> /etc/sysctl.d/k8s.conf
  
<span class="c"># enable br_netfilter for iptables </span>
modprobe br_netfilter
modprobe overlay
<span class="nb">echo</span> <span class="s2">"br_netfilter"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
<span class="nb">echo</span> <span class="s2">"overlay"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)"</span>
<span class="c"># Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version</span>
apt update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># apt list -a kubelet ; apt list -a containerd.io</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubectl</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubeadm</span><span class="o">=</span><span class="nv">$1</span> containerd.io<span class="o">=</span><span class="nv">$2</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-mark hold kubelet kubeadm kubectl <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># containerd configure to default and cgroup managed by systemd</span>
containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SystemdCgroup = false/SystemdCgroup = true/g'</span> /etc/containerd/config.toml
  
<span class="c"># avoid WARN&amp;ERRO(default endpoints) when crictl run  </span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
</span><span class="no">EOF
  
</span><span class="c"># ready to install for k8s </span>
systemctl restart containerd <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable </span>containerd
systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Packages &amp; Helm"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get <span class="nb">install</span> <span class="nt">-y</span> bridge-utils sshpass net-tools conntrack ngrep tcpdump ipset arping wireguard jq yq tree bash-completion unzip kubecolor termshark <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
curl <span class="nt">-s</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>k8s-ctr.sh</strong> : kubeadm init를 통하여 kubernetes controlplane 노드를 설정하고 Cilium CNI 설치, 편리성 설정(k, kc)하는 스크립트입니다. local-path-storageclass와 metrics-server도 설치합니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Initial Kubernetes"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-init-ctr-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/kubeadm-init-ctr-config.yaml
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$3</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/p'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/K8S_VERSION_PLACEHOLDER/v</span><span class="k">${</span><span class="nv">K8SMMV</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-init-ctr-config.yaml
kubeadm init <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-init-ctr-config.yaml"</span>  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Setting kube config file"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /root/.kube
<span class="nb">cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf /root/.kube/config
<span class="nb">chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> /root/.kube/config
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Source the completion"</span>
<span class="nb">echo</span> <span class="s1">'source &lt;(kubectl completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'source &lt;(kubeadm completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Alias kubectl to k"</span>
<span class="nb">echo</span> <span class="s1">'alias k=kubectl'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'alias kc=kubecolor'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'complete -F __start_kubectl k'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubectx &amp; Kubens"</span>
git clone https://github.com/ahmetb/kubectx /opt/kubectx <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubens /usr/local/bin/kubens
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubectx /usr/local/bin/kubectx
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Kubeps &amp; Setting PS1"</span>
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1 <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">"</span><span class="no">EOT</span><span class="sh">" &gt;&gt; /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
function get_cluster_short() {
  echo "</span><span class="nv">$1</span><span class="sh">" | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=') '
PS1='</span><span class="si">$(</span>kube_ps1<span class="si">)</span><span class="sh">'</span><span class="nv">$PS1</span><span class="sh">
</span><span class="no">EOT
</span>kubectl config rename-context <span class="s2">"kubernetes-admin@kubernetes"</span> <span class="s2">"HomeLab"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 7] Install Cilium CNI"</span>
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
helm repo add cilium https://helm.cilium.io/ <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm repo update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> <span class="nv">$2</span> <span class="nt">--namespace</span> kube-system <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.100 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="se">\</span>
<span class="nt">--set</span> ipam.mode<span class="o">=</span><span class="s2">"cluster-pool"</span> <span class="nt">--set</span> ipam.operator.clusterPoolIPv4PodCIDRList<span class="o">={</span><span class="s2">"172.20.0.0/16"</span><span class="o">}</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>172.20.0.0/16 <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> bgpControlPlane.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>30003 <span class="se">\</span>
<span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span> <span class="se">\</span>
<span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 8] Install Cilium / Hubble CLI"</span>
<span class="nv">CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz
  
<span class="nv">HUBBLE_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="si">)</span>
<span class="nv">HUBBLE_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">HUBBLE_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/hubble/releases/download/<span class="nv">$HUBBLE_VERSION</span>/hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 9] Remove node taint"</span>
kubectl taint nodes k8s-ctr node-role.kubernetes.io/control-plane-
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 10] local DNS with hosts file"</span>
<span class="nb">echo</span> <span class="s2">"192.168.10.100 k8s-ctr"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.10.200 router"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.20.100 k8s-w0"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;<span class="o">=</span><span class="nv">$1</span><span class="p">;</span> i++  <span class="o">))</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"192.168.10.10</span><span class="nv">$i</span><span class="s2"> k8s-w</span><span class="nv">$i</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts<span class="p">;</span> <span class="k">done
  
  
</span><span class="nb">echo</span> <span class="s2">"[TASK 11] Dynamically provisioning persistent local storage with Kubernetes"</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.31/deploy/local-path-storage.yaml <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch storageclass local-path <span class="nt">-p</span> <span class="s1">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="c"># echo "[TASK 12] Install Prometheus &amp; Grafana"</span>
<span class="c"># kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.18.0/examples/kubernetes/addons/prometheus/monitoring-example.yaml &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># kubectl patch svc -n cilium-monitoring prometheus -p '{"spec": {"type": "NodePort", "ports": [{"port": 9090, "targetPort": 9090, "nodePort": 30001}]}}' &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># kubectl patch svc -n cilium-monitoring grafana -p '{"spec": {"type": "NodePort", "ports": [{"port": 3000, "targetPort": 3000, "nodePort": 30002}]}}' &gt;/dev/null 2&gt;&amp;1</span>
  
<span class="c"># echo "[TASK 12] Install Prometheus Stack"</span>
<span class="c"># helm repo add prometheus-community https://prometheus-community.github.io/helm-charts  &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># cat &lt;&lt;EOT &gt; monitor-values.yaml</span>
<span class="c"># prometheus:</span>
<span class="c">#   prometheusSpec:</span>
<span class="c">#     scrapeInterval: "15s"</span>
<span class="c">#     evaluationInterval: "15s"</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30001</span>
  
<span class="c"># grafana:</span>
<span class="c">#   defaultDashboardsTimezone: Asia/Seoul</span>
<span class="c">#   adminPassword: prom-operator</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30002</span>
  
<span class="c"># alertmanager:</span>
<span class="c">#   enabled: false</span>
<span class="c"># defaultRules:</span>
<span class="c">#   create: false</span>
<span class="c"># prometheus-windows-exporter:</span>
<span class="c">#   prometheus:</span>
<span class="c">#     monitor:</span>
<span class="c">#       enabled: false</span>
<span class="c"># EOT</span>
<span class="c"># helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack --version 75.15.1 \</span>
<span class="c">#   -f monitor-values.yaml --create-namespace --namespace monitoring  &gt;/dev/null 2&gt;&amp;1</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 13] Install Metrics-server"</span>
helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm upgrade <span class="nt">--install</span> metrics-server metrics-server/metrics-server <span class="nt">--set</span> <span class="s1">'args[0]=--kubelet-insecure-tls'</span> <span class="nt">-n</span> kube-system  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 14] Install k9s"</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>wget https://github.com/derailed/k9s/releases/latest/download/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb <span class="nt">-O</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt <span class="nb">install</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p><strong>kubeadm-init-ctr-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration
bootstrapTokens:
- token: <span class="s2">"123456.1234567890123456"</span>
  ttl: <span class="s2">"0s"</span>
  usages:
  - signing
  - authentication
localAPIEndpoint:
  advertiseAddress: <span class="s2">"192.168.10.100"</span>
nodeRegistration:
  kubeletExtraArgs:
    - name: node-ip
      value: <span class="s2">"192.168.10.100"</span>
  criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
<span class="nt">---</span>
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
kubernetesVersion: <span class="s2">"K8S_VERSION_PLACEHOLDER"</span>
networking:
  podSubnet: <span class="s2">"10.244.0.0/16"</span>
  serviceSubnet: <span class="s2">"10.96.0.0/16"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
<strong>k8s-w.sh</strong> : kubernetes worker 노드 설정, kubeadm join 등을 수행하는  스크립트입니다.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;"</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] K8S Controlplane Join"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-join-worker-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-join-worker-config.yaml
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/NODE_IP_PLACEHOLDER/</span><span class="k">${</span><span class="nv">NODEIP</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-join-worker-config.yaml
kubeadm <span class="nb">join</span> <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-join-worker-config.yaml"</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
    <ul>
      <li>
        <p><strong>kubeadm-join-worker-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>apiVersion: kubeadm.k8s.io/v1beta4
kind: JoinConfiguration
discovery:
  bootstrapToken:
    token: <span class="s2">"123456.1234567890123456"</span>
    apiServerEndpoint: <span class="s2">"192.168.10.100:6443"</span>
    unsafeSkipCAVerification: <span class="nb">true
</span>nodeRegistration:
  criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
  kubeletExtraArgs:
    - name: node-ip
      value: <span class="s2">"NODE_IP_PLACEHOLDER"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>route-add1.sh</strong> : k8s node 들이 내부망과 통신을 위한 route 설정 스크립트입니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt;&gt; /etc/netplan/50-vagrant.yaml
      routes:
      - to: 192.168.20.0/24
        via: 192.168.10.200
      # - to: 172.20.0.0/16
      #   via: 192.168.10.200
</span><span class="no">EOT
  
</span>netplan apply
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>route-add2.sh</strong> : k8s node 들이 내부망과 통신을 위한 route 설정 스크립트입니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt;&gt; /etc/netplan/50-vagrant.yaml
      routes:
      - to: 192.168.10.0/24
        via: 192.168.20.200
      # - to: 172.20.0.0/16
      #   via: 192.168.20.200
</span><span class="no">EOT
  
</span>netplan apply
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>router.sh</strong> : router(<strong>frr - BGP</strong>) 역할, 간단 웹 서버 역할</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 0] Setting eth2"</span>
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOT</span><span class="sh"> &gt;&gt; /etc/netplan/50-vagrant.yaml
    eth2:
      addresses:
      - 192.168.20.200/24
</span><span class="no">EOT
  
</span>netplan apply
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Add Kernel setting - IP Forwarding"</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g'</span> /etc/sysctl.conf
sysctl <span class="nt">-p</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Setting Dummy Interface"</span>
modprobe dummy
ip <span class="nb">link </span>add loop1 <span class="nb">type </span>dummy
ip <span class="nb">link set </span>loop1 up
ip addr add 10.10.1.200/24 dev loop1
  
ip <span class="nb">link </span>add loop2 <span class="nb">type </span>dummy
ip <span class="nb">link set </span>loop2 up
ip addr add 10.10.2.200/24 dev loop2
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Packages"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>net-tools jq yq tree ngrep tcpdump arping termshark <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Apache"</span>
apt <span class="nb">install </span>apache2 <span class="nt">-y</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"&lt;h1&gt;Web Server : </span><span class="si">$(</span><span class="nb">hostname</span><span class="si">)</span><span class="s2">&lt;/h1&gt;"</span> <span class="o">&gt;</span> /var/www/html/index.html
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 7] Configure FRR"</span>
apt <span class="nb">install </span>frr <span class="nt">-y</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/^bgpd=no/bgpd=yes/g"</span> /etc/frr/daemons
  
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt;&gt; /etc/frr/frr.conf
!
router bgp 65000
  bgp router-id </span><span class="nv">$NODEIP</span><span class="sh">
  bgp graceful-restart
  no bgp ebgp-requires-policy
  bgp bestpath as-path multipath-relax
  maximum-paths 4
  network 10.10.1.0/24
</span><span class="no">EOF
  
  
</span>systemctl daemon-reexec <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl restart frr <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl <span class="nb">enable </span>frr <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="실습환경-배포">실습환경 배포</h3>

<h5 id="실습환경-배포-1">실습환경 배포</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>vagrant up
  <span class="c"># =&gt;     k8s-w0: &gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;</span>
  <span class="c">#    ==&gt; k8s-w0: Running provisioner: shell...</span>
  <span class="c">#        k8s-w0: Running: /var/folders/7k/qy6rsdds57z3tmyn9_7hhd8r0000gn/T/vagrant-shell20250815-16129-ssrxpm.sh</span>
  <span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;</span>
  <span class="c">#        k8s-w0: [TASK 1] K8S Controlplane Join</span>
  <span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;</span>
  <span class="c">#    ==&gt; k8s-w0: Running provisioner: shell...</span>
  <span class="c">#        k8s-w0: Running: /var/folders/7k/qy6rsdds57z3tmyn9_7hhd8r0000gn/T/vagrant-shell20250815-16129-iotl22.sh</span>
  <span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;</span>
  <span class="c">#        k8s-w0: &gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;</span>
</code></pre></div></div>

<h5 id="기본정보-확인">기본정보 확인</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium 상태 확인 : bgp-control-plane 미리 활성화.</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq
<span class="nv">$ </span>cilium status 
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> bgp
<span class="c"># =&gt; bgp-router-id-allocation-ip-pool</span>
<span class="c">#    bgp-router-id-allocation-mode                     default</span>
<span class="c">#    bgp-secrets-namespace                             kube-system</span>
<span class="c">#    enable-bgp-control-plane                          true</span>
<span class="c">#    enable-bgp-control-plane-status-report            true</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg status <span class="nt">--verbose</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg metrics list 

<span class="c"># monitor</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg monitor <span class="nt">-v</span> <span class="nt">-v</span>
...
</code></pre></div></div>

<h5 id="네트워크-정보-확인--autodirectnoderoutesfalse">네트워크 정보 확인 : <code class="language-plaintext highlighter-rouge">autoDirectNodeRoutes=false</code>
</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># router 네트워크 인터페이스 정보 확인</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-br</span> <span class="nt">-c</span> <span class="nt">-4</span> addr

<span class="c"># k8s node 네트워크 인터페이스 정보 확인</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth1
<span class="c"># =&gt; 3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet &lt;span style="color: green;"&gt;192.168.10.100/24&lt;/span&gt; brd 192.168.10.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> <span class="nt">-4</span> addr show dev eth1<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; 3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet &lt;span style="color: green;"&gt;192.168.10.101/24&lt;/span&gt; brd 192.168.10.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="c">#        altname enp0s9</span>
<span class="c">#        inet &lt;span style="color: green;"&gt;192.168.20.100/24&lt;/span&gt; brd 192.168.20.255 scope global eth1</span>
<span class="c">#           valid_lft forever preferred_lft forever</span>

<span class="c"># 라우팅 정보 확인</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.200</span>
<span class="c">#    192.168.20.0/24 dev eth2 proto kernel scope link src 192.168.20.200</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>static
<span class="c"># =&gt; 192.168.20.0/24 via 192.168.10.200 dev eth1 proto static</span>

<span class="c">## 노드별 PodCIDR 라우팅이 없습니다!</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    172.20.0.0/24 via 172.20.0.222 dev cilium_host proto kernel src 172.20.0.222</span>
<span class="c">#    172.20.0.222 dev cilium_host proto kernel scope link</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100</span>
<span class="c">#    192.168.20.0/24 via 192.168.10.200 dev eth1 proto static</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>w1 w0 <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : k8s-</span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-<span class="nv">$i</span> ip <span class="nt">-c</span> route<span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    172.20.1.0/24 via 172.20.1.44 dev cilium_host proto kernel src 172.20.1.44</span>
<span class="c">#    172.20.1.44 dev cilium_host proto kernel scope link</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.101</span>
<span class="c">#    192.168.20.0/24 via 192.168.10.200 dev eth1 proto static</span>
<span class="c">#    </span>
<span class="c">#    &gt;&gt; node : k8s-w0 &lt;&lt;</span>
<span class="c">#    default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    172.20.2.0/24 via 172.20.2.246 dev cilium_host proto kernel src 172.20.2.246</span>
<span class="c">#    172.20.2.246 dev cilium_host proto kernel scope link</span>
<span class="c">#    192.168.10.0/24 via 192.168.20.200 dev eth1 proto static</span>
<span class="c">#    192.168.20.0/24 dev eth1 proto kernel scope link src 192.168.20.100</span>

<span class="c"># 통신 확인</span>
<span class="nv">$ </span>ping <span class="nt">-c</span> 1 192.168.20.100  <span class="c"># k8s-w0 eth1</span>
<span class="c"># =&gt; PING 192.168.20.100 (192.168.20.100) 56(84) bytes of data.</span>
<span class="c">#    64 bytes from 192.168.20.100: icmp_seq=1 ttl=63 time=2.46 ms</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.20.100 ping statistics ---</span>
<span class="c">#    1 packets transmitted, 1 received, 0% packet loss, time 0ms</span>
<span class="c">#    rtt min/avg/max/mdev = 2.461/2.461/2.461/0.000 ms</span>
</code></pre></div></div>

<ul>
  <li>현재노드간 통신은 가능하지만 pod 간 통신은 불가능합니다.</li>
  <li>
<code class="language-plaintext highlighter-rouge">autoDirectNodeRoutes=false</code>을 통해 자동으로 같은 L2 네트워크에 있는 노드들간의 PodCIDR 라우팅하는 기능이 꺼져있어서 라우팅 룰이 없기때문입니다.</li>
</ul>

<h3 id="샘플-애플리케이션-배포-및-통신-문제-확인">샘플 애플리케이션 배포 및 통신 문제 확인</h3>

<ul>
  <li>샘플 애플리케이션 배포</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 샘플 애플리케이션 배포</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># k8s-ctr 노드에 curl-pod 파드 배포</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>
</code></pre></div></div>

<ul>
  <li>통신 문제 확인 : 노드 내의 파드간에만 통신이 되는 중입니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 배포 확인</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   3/3     3            3           102s   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE    SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.28.4   &lt;none&gt;        80/TCP    102s   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                                      AGE</span>
<span class="c">#    endpoints/webpod   172.20.0.72:80,172.20.1.7:80,172.20.2.190:80   102s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="c"># =&gt; NAME           ADDRESSTYPE   PORTS   ENDPOINTS                             AGE</span>
<span class="c">#    webpod-4pxps   IPv4          80      172.20.0.72,172.20.1.7,172.20.2.190   2m23s</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="c"># IP 확인</span>
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  47416               ready            172.20.0.187</span>
<span class="c">#    &lt;span style="color: green;"&gt;webpod-697b545f57-j6b7t&lt;/span&gt;   9975                ready            &lt;span style="color: green;"&gt;172.20.0.72&lt;/span&gt;</span>
<span class="c">#    webpod-697b545f57-n7fk7   9975                ready            172.20.2.190</span>
<span class="c">#    webpod-697b545f57-rl4d2   9975                ready            172.20.1.7</span>

<span class="c"># 통신 문제 확인 : 노드 내의 파드들 끼리만 통신되는 중!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-j6b7t</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s-ctr에서 실행중이어서 같은 k8s-ctr에 있는 파드와는 통신이 됩니다.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 webpod | <span class="nb">grep </span>Hostname
<span class="c"># &lt;span style="color: green;"&gt;👉 다시 실행했을때는 Kubernetes Service에 의해 다른 노드의 파드로 로드밸런싱되어 통신이 실패합니다.&lt;/span&gt;</span>
<span class="c"># =&gt; command terminated with exit code 28</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ---</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ---</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 여러번 실행해도 k8s-ctr 노드에 있는 파드만 통신이 되는것을 확인할 수 있습니다.&lt;/span&gt;</span>

<span class="c"># cilium-dbg, map</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg ip list
<span class="c"># =&gt; IP                  IDENTITY                                                                            SOURCE</span>
<span class="c">#    ...</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.1.7/32&lt;/span&gt;       k8s:app=webpod                                                                      custom-resource</span>
<span class="c">#    ...</span>
<span class="c">#    &lt;span style="color: green;"&gt;172.20.2.190/32&lt;/span&gt;     k8s:app=webpod                                                                      custom-resource</span>
<span class="c">#    ...</span>
<span class="c">#    192.168.10.101/32   reserved:remote-node</span>
<span class="c">#    192.168.20.100/32   reserved:remote-node</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 cilium도 다른 노드의 파드 IP를 알고 있지만, 라우팅이 되지 않아서 통신이 되지 않습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg endpoint list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg service list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf lb list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf nat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map list | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'0             0'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_services_v2
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_backends_v3
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_reverse_nat
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_ipcache_v2
</code></pre></div></div>

<hr>

<h2 id="cilium-bgp-control-plane">Cilium BGP Control Plane</h2>

<ul>
  <li>Cilium BGP Control Plane (BGPv2) : Cilium Custom Resources 를 통해 BGP 설정이 관리 가능합니다. - <a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-v2/">Docs</a>, <a href="https://github.com/cilium/cilium/tree/main/operator/pkg/bgpv2">Code</a>
<img src="/assets/2025/cilium/w5/20250817_cilium_w5_2.png" alt="img.png" class="image-center image-bg" loading="lazy" width="1152" height="726">
<em class="image-caption"><a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-v2/">https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-v2/</a></em>
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">CiliumBGPClusterConfig</code>: BGP 인스턴스와 여러 노드에 적용되는 피어 구성을 정의합니다.</li>
      <li>
<code class="language-plaintext highlighter-rouge">CiliumBGPPeerConfig</code>: 공통 BGP 피어링 설정을 정의합니다. 여러 피어에서 사용할 수 있습니다.</li>
      <li>
<code class="language-plaintext highlighter-rouge">CiliumBGPAdvertisement</code>: BGP 라우팅 테이블에 삽입되는 접두사를 정의합니다.</li>
      <li>
<code class="language-plaintext highlighter-rouge">CiliumBGPNodeConfigOverride</code>: 세밀한 제어를 제공하기 위해 특정 노드에 대한 BGP 설정 오버라이드을 정의합니다.</li>
    </ul>
  </li>
</ul>

<h4 id="bgp설정-후-통신-확인">BGP 설정 후 통신 확인</h4>

<blockquote>
  <p>Cilium의 BGP는 기본적으로 외부 경로를 커널 라우팅 테이블에 주입하지 않습니다.</p>
</blockquote>

<ul>
  <li>[router] router 접속 후 설정 : <code class="language-plaintext highlighter-rouge">sshpass -p 'vagrant' ssh vagrant@router</code>
</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s-ctr 에서 router 로 ssh 접속</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router

<span class="c"># BGP 관련 프로세스를 확인합니다.</span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep</span> <span class="nt">-iE</span> <span class="s1">'zebra|bgpd'</span>
<span class="c"># =&gt; LISTEN 0      3          127.0.0.1:2601      0.0.0.0:*    users:(("zebra",pid=4144,fd=23))</span>
<span class="c">#    LISTEN 0      3          127.0.0.1:2605      0.0.0.0:*    users:(("bgpd",pid=4149,fd=18))</span>
<span class="c">#    LISTEN 0      4096         0.0.0.0:179       0.0.0.0:*    users:(("bgpd",pid=4149,fd=22))</span>
<span class="c">#    LISTEN 0      4096            [::]:179          [::]:*    users:(("bgpd",pid=4149,fd=23))</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span> |grep frr
<span class="c"># =&gt; root        4131       1  0 16:49 ?        00:00:03 /usr/lib/frr/watchfrr -d -F traditional zebra bgpd staticd</span>
<span class="c">#    frr         4144       1  0 16:49 ?        00:00:01 /usr/lib/frr/zebra -d -F traditional -A 127.0.0.1 -s 90000000</span>
<span class="c">#    frr         4149       1  0 16:49 ?        00:00:00 /usr/lib/frr/bgpd -d -F traditional -A 127.0.0.1</span>
<span class="c">#    frr         4156       1  0 16:49 ?        00:00:00 /usr/lib/frr/staticd -d -F traditional -A 127.0.0.1</span>

<span class="c"># frr 설정을 확인합니다.</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show running'</span>   <span class="c"># 명령을 통해 현재 설정을 확인할 수 있습니다.</span>
<span class="c"># =&gt; uilding configuration...</span>
<span class="c">#    </span>
<span class="c">#    Current configuration:</span>
<span class="c">#    !</span>
<span class="c">#    frr version 8.4.4</span>
<span class="c">#    frr defaults traditional</span>
<span class="c">#    hostname router</span>
<span class="c">#    log syslog informational</span>
<span class="c">#    no ipv6 forwarding</span>
<span class="c">#    service integrated-vtysh-config</span>
<span class="c">#    !</span>
<span class="c">#    router bgp 65000</span>
<span class="c">#     bgp router-id 192.168.10.200</span>
<span class="c">#     no bgp ebgp-requires-policy</span>
<span class="c">#     bgp graceful-restart</span>
<span class="c">#     bgp bestpath as-path multipath-relax</span>
<span class="c">#     !</span>
<span class="c">#     address-family ipv4 unicast</span>
<span class="c">#      network 10.10.1.0/24</span>
<span class="c">#      maximum-paths 4</span>
<span class="c">#     exit-address-family</span>
<span class="c">#    exit</span>
<span class="c">#    !</span>
<span class="c">#    end</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/frr/frr.conf
<span class="c"># =&gt; ... </span>
<span class="c">#    log syslog informational</span>
<span class="c">#    !</span>
<span class="c">#    router bgp 65000</span>
<span class="c">#      bgp router-id 192.168.10.200</span>
<span class="c">#      bgp graceful-restart</span>
<span class="c">#      no bgp ebgp-requires-policy</span>
<span class="c">#      bgp bestpath as-path multipath-relax</span>
<span class="c">#      maximum-paths 4</span>
<span class="c">#      network 10.10.1.0/24</span>

<span class="c">#</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show running'</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp summary'</span>
<span class="c"># =&gt; % No BGP neighbors found in VRF default</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp'</span>
<span class="c"># =&gt; BGP table version is 1, local router ID is 192.168.10.200, vrf id 0</span>
<span class="c">#    Default local pref 100, local AS 65000</span>
<span class="c">#    Status codes:  s suppressed, d damped, h history, * valid, &gt; best, = multipath,</span>
<span class="c">#                   i internal, r RIB-failure, S Stale, R Removed</span>
<span class="c">#    Nexthop codes: @NNN nexthop's vrf id, &lt; announce-nh-self</span>
<span class="c">#    Origin codes:  i - IGP, e - EGP, ? - incomplete</span>
<span class="c">#    RPKI validation codes: V valid, I invalid, N Not found</span>
<span class="c">#    </span>
<span class="c">#       Network          Next Hop            Metric LocPrf Weight Path</span>
<span class="c">#    *&gt; 10.10.1.0/24     0.0.0.0                  0         32768 i</span>

<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.10.1.0/24 dev loop1 proto kernel scope link src 10.10.1.200</span>
<span class="c">#    10.10.2.0/24 dev loop2 proto kernel scope link src 10.10.2.200</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.200</span>
<span class="c">#    192.168.20.0/24 dev eth2 proto kernel scope link src 192.168.20.200</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip route'</span>
...
K&gt;<span class="k">*</span> 0.0.0.0/0 <span class="o">[</span>0/100] via 10.0.2.2, eth0, src 10.0.2.15, 00:34:45
...
C&gt;<span class="k">*</span> 192.168.10.0/24 is directly connected, eth1, 00:34:45
C&gt;<span class="k">*</span> 192.168.20.0/24 is directly connected, eth2, 00:34:45
<span class="c"># =&gt; ...    </span>
<span class="c">#    K&gt;* 0.0.0.0/0 [0/100] via 10.0.2.2, eth0, src 10.0.2.15, 06:52:38</span>
<span class="c">#    ...</span>
<span class="c">#    C&gt;* 192.168.10.0/24 is directly connected, eth1, 06:52:38</span>
<span class="c">#    C&gt;* 192.168.20.0/24 is directly connected, eth2, 06:52:38</span>

<span class="c"># Cilium node 연동 설정 방안 1</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 설정 파일을 직접 수정하는 방법입니다.&lt;/span&gt;</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt;&gt; /etc/frr/frr.conf
  neighbor CILIUM peer-group
  neighbor CILIUM remote-as external
  neighbor 192.168.10.100 peer-group CILIUM
  neighbor 192.168.10.101 peer-group CILIUM
  neighbor 192.168.20.100 peer-group CILIUM 
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> /etc/frr/frr.conf
<span class="c"># =&gt; log syslog informational</span>
<span class="c">#    !</span>
<span class="c">#    router bgp 65000</span>
<span class="c">#      bgp router-id 192.168.10.200</span>
<span class="c">#      bgp graceful-restart</span>
<span class="c">#      no bgp ebgp-requires-policy</span>
<span class="c">#      bgp bestpath as-path multipath-relax</span>
<span class="c">#      maximum-paths 4</span>
<span class="c">#      network 10.10.1.0/24</span>
<span class="c">#      neighbor CILIUM peer-group</span>
<span class="c">#      neighbor CILIUM remote-as external</span>
<span class="c">#      neighbor 192.168.10.100 peer-group CILIUM</span>
<span class="c">#      neighbor 192.168.10.101 peer-group CILIUM</span>
<span class="c">#      neighbor 192.168.20.100 peer-group CILIUM</span>

<span class="nv">$ </span>systemctl daemon-reexec <span class="o">&amp;&amp;</span> systemctl restart frr
<span class="nv">$ </span>systemctl status frr <span class="nt">--no-pager</span> <span class="nt">--full</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Aug 15 23:43:00 router zebra[5215]: [VTVCM-Y2NW3] Configuration Read in Took: 00:00:00</span>
<span class="c">#    Aug 15 23:43:00 router staticd[5227]: [VTVCM-Y2NW3] Configuration Read in Took: 00:00:00</span>
<span class="c">#    Aug 15 23:43:00 router bgpd[5220]: [VTVCM-Y2NW3] Configuration Read in Took: 00:00:00</span>
<span class="c">#    Aug 15 23:43:00 router watchfrr[5201]: [QDG3Y-BY5TN] zebra state -&gt; up : connect succeeded</span>
<span class="c">#    Aug 15 23:43:00 router watchfrr[5201]: [QDG3Y-BY5TN] bgpd state -&gt; up : connect succeeded</span>
<span class="c">#    Aug 15 23:43:00 router watchfrr[5201]: [QDG3Y-BY5TN] staticd state -&gt; up : connect succeeded</span>
<span class="c">#    Aug 15 23:43:00 router watchfrr[5201]: [KWE5Q-QNGFC] all daemons up, doing startup-complete notify</span>
<span class="c">#    Aug 15 23:43:00 router frrinit.sh[5190]:  * Started watchfrr</span>
<span class="c">#    Aug 15 23:43:00 router systemd[1]: Started frr.service - FRRouting.</span>

<span class="c"># 모니터링 걸어두기!</span>
<span class="nv">$ </span>journalctl <span class="nt">-u</span> frr <span class="nt">-f</span>

<span class="c"># Cilium node 연동 설정 방안 2</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 frr에서 제공하는 vtysh 명령어를 통해 설정하는 방법입니다.&lt;/span&gt;</span>
<span class="nv">$ </span>vtysh
<span class="nt">---------------------------</span>
?
show ?
show running
show ip route

<span class="c"># config 모드 진입</span>
conf
?

<span class="c">## bgp 65000 설정 진입</span>
router bgp 65000
?
neighbor CILIUM peer-group
neighbor CILIUM remote-as external
neighbor 192.168.10.100 peer-group CILIUM
neighbor 192.168.10.101 peer-group CILIUM
neighbor 192.168.20.100 peer-group CILIUM 
end

<span class="c"># Write configuration to the file (same as write file)</span>
write memory
<span class="c"># &lt;span style="color: green;"&gt;👉 실제로 frr.conf 파일에 설정이 추가됩니다.&lt;/span&gt;</span>

<span class="nb">exit</span>
<span class="nt">---------------------------</span>

<span class="nv">$ </span><span class="nb">cat</span> /etc/frr/frr.conf
</code></pre></div></div>

<ul>
  <li>cilium에 bgp 설정</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 신규 터미널 1 (router) : 모니터링 걸어두기!</span>
<span class="nv">$ </span>journalctl <span class="nt">-u</span> frr <span class="nt">-f</span>

<span class="c"># 신규 터미널 2 (k8s-ctr) : 반복 호출</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>


<span class="c"># BGP 동작할 노드를 위한 label 설정</span>
<span class="nv">$ </span>kubectl label nodes k8s-ctr k8s-w0 k8s-w1 enable-bgp<span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; node/k8s-w0 labeled</span>
<span class="c">#    node/k8s-w1 labeled</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-l</span> enable-bgp<span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; NAME      STATUS   ROLES           AGE     VERSION</span>
<span class="c">#    k8s-ctr   Ready    control-plane   7h35m   v1.33.2</span>
<span class="c">#    k8s-w0    Ready    &lt;none&gt;          7h30m   v1.33.2</span>
<span class="c">#    k8s-w1    Ready    &lt;none&gt;          7h33m   v1.33.2</span>

<span class="c"># Config Cilium BGP</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: cilium.io/v2
kind: CiliumBGPAdvertisement
metadata:
  name: bgp-advertisements
  labels:
    advertise: bgp
spec:
  advertisements:
    - advertisementType: "PodCIDR"
---
apiVersion: cilium.io/v2
kind: CiliumBGPPeerConfig
metadata:
  name: cilium-peer
spec:
  timers:
    holdTimeSeconds: 9
    keepAliveTimeSeconds: 3
  ebgpMultihop: 2
  gracefulRestart:
    enabled: true
    restartTimeSeconds: 15
  families:
    - afi: ipv4
      safi: unicast
      advertisements:
        matchLabels:
          advertise: "bgp"
---
apiVersion: cilium.io/v2
kind: CiliumBGPClusterConfig
metadata:
  name: cilium-bgp
spec:
  nodeSelector:
    matchLabels:
      "enable-bgp": "true"
  bgpInstances:
  - name: "instance-65001"
    localASN: 65001
    peers:
    - name: "tor-switch"
      peerASN: 65000
      peerAddress: 192.168.10.200  # router ip address
      peerConfigRef:
        name: "cilium-peer"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumbgpadvertisement.cilium.io/bgp-advertisements created</span>
<span class="c">#    ciliumbgppeerconfig.cilium.io/cilium-peer created</span>
<span class="c">#    ciliumbgpclusterconfig.cilium.io/cilium-bgp created</span>
</code></pre></div></div>

<ul>
  <li>통신확인</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [k8s-ctr]에서 확인</span>

<span class="c"># BGP 연결 확인</span>
<span class="nv">$ </span>ss <span class="nt">-tnlp</span> | <span class="nb">grep </span>179
<span class="c"># =&gt; (없음)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s-ctr 노드에는 BGP 데몬이 실행되고 있지 않습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>ss <span class="nt">-tnp</span> | <span class="nb">grep </span>179
<span class="c"># =&gt; ESTAB 0      0               192.168.10.100:46459          192.168.10.200:179   users:(("cilium-agent",pid=5674,fd=193))</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 cilium-agent가 BGP 연결을 위해 router와 연결되어 있습니다.&lt;/span&gt;</span>

<span class="c"># cilium bgp 정보 확인</span>
<span class="nv">$ </span>cilium bgp peers
<span class="c"># =&gt; Node      Local AS   Peer AS   Peer Address     Session State   Uptime   Family         Received   Advertised</span>
<span class="c">#    k8s-ctr   65001      65000     192.168.10.200   established     2m20s    ipv4/unicast   4          2</span>
<span class="c">#    k8s-w0    65001      65000     192.168.10.200   established     2m20s    ipv4/unicast   4          2</span>
<span class="c">#    k8s-w1    65001      65000     192.168.10.200   established     2m19s    ipv4/unicast   4          2</span>
<span class="nv">$ </span>cilium bgp routes available ipv4 unicast
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age     Attrs</span>
<span class="c">#    k8s-ctr   65001     172.20.0.0/24   0.0.0.0   2m30s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w0    65001     172.20.2.0/24   0.0.0.0   2m30s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w1    65001     172.20.1.0/24   0.0.0.0   2m30s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>

<span class="nv">$ </span>kubectl get ciliumbgpadvertisements,ciliumbgppeerconfigs,ciliumbgpclusterconfigs
<span class="c"># =&gt; NAME                                                  AGE</span>
<span class="c">#    ciliumbgpadvertisement.cilium.io/bgp-advertisements   2m40s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                        AGE</span>
<span class="c">#    ciliumbgppeerconfig.cilium.io/cilium-peer   2m40s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                          AGE</span>
<span class="c">#    ciliumbgpclusterconfig.cilium.io/cilium-bgp   2m40s</span>
<span class="nv">$ </span>kubectl get ciliumbgpnodeconfigs <span class="nt">-o</span> yaml | yq
<span class="c"># =&gt; ...</span>
<span class="c">#                    "peeringState": "established",</span>
<span class="c">#                    "routeCount": [</span>
<span class="c">#                      {</span>
<span class="c">#                        "advertised": 2,</span>
<span class="c">#                        "afi": "ipv4",</span>
<span class="c">#                        "received": 1,</span>
<span class="c">#                        "safi": "unicast"</span>
<span class="c">#                      }</span>
<span class="c">#                    ],</span>
<span class="c">#    ...</span>

<span class="c"># 신규 터미널 1 (router) : 모니터링 걸어두기!</span>
<span class="nv">$ </span>journalctl <span class="nt">-u</span> frr <span class="nt">-f</span>
<span class="c"># =&gt; Aug 16 00:21:44 router bgpd[5422]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.10.101 in vrf default</span>
<span class="c">#    Aug 16 00:21:44 router bgpd[5422]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.20.100 in vrf default</span>
<span class="c">#    Aug 16 00:21:44 router bgpd[5422]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.10.100 in vrf default</span>

<span class="nv">$ </span>ip <span class="nt">-c</span> route | <span class="nb">grep </span>bgp
<span class="c"># =&gt; 172.20.0.0/24 nhid 32 via 192.168.10.100 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.1.0/24 nhid 30 via 192.168.10.101 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.2.0/24 nhid 31 via 192.168.20.100 dev eth2 proto bgp metric 20</span>

<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp summary'</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span>
<span class="c">#    192.168.10.100  4      65001        88        91        0    0    0 00:04:12            1        4 N/A</span>
<span class="c">#    192.168.10.101  4      65001        88        91        0    0    0 00:04:12            1        4 N/A</span>
<span class="c">#    192.168.20.100  4      65001        88        91        0    0    0 00:04:12            1        4 N/A</span>

<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp'</span>
<span class="c"># =&gt; ...</span>
<span class="c">#       Network          Next Hop            Metric LocPrf Weight Path</span>
<span class="c">#    *&gt; 10.10.1.0/24     0.0.0.0                  0         32768 i</span>
<span class="c">#    *&gt; 172.20.0.0/24    192.168.10.100                         0 65001 i</span>
<span class="c">#    *&gt; 172.20.1.0/24    192.168.10.101                         0 65001 i</span>
<span class="c">#    *&gt; 172.20.2.0/24    192.168.20.100                         0 65001 i</span>

<span class="c"># 신규 터미널 2 (k8s-ctr) : 반복 호출???</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ---</span>
<span class="c">#    ---</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 여전히 k8s-ctr 노드에 있는 파드만 통신이 되고, 다른 노드의 파드와는 통신이 안 됩니다.&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>BGP 정보 전달 확인</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s-ctr tcpdump 해두기</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 tcp port 179 <span class="nt">-w</span> /tmp/bgp.pcap

<span class="c"># router : frr 재시작</span>
<span class="nv">$ </span>systemctl restart frr <span class="o">&amp;&amp;</span> journalctl <span class="nt">-u</span> frr <span class="nt">-f</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    Aug 16 00:28:35 router watchfrr[5625]: [KWE5Q-QNGFC] all daemons up, doing startup-complete notify</span>
<span class="c">#    Aug 16 00:28:41 router bgpd[5643]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.20.100 in vrf default</span>
<span class="c">#    Aug 16 00:28:41 router bgpd[5643]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.10.100 in vrf default</span>
<span class="c">#    Aug 16 00:28:41 router bgpd[5643]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 192.168.10.101 in vrf default</span>

<span class="c"># termshark 실행후 filter에 `bgp.type == 2` 입력해서 bgp update 패킷을 확인합니다.</span>
<span class="nv">$ </span>termshark <span class="nt">-r</span> /tmp/bgp.pcap
 
<span class="c"># 분명 Router 장비를 통해 BGP UPDATE로 받음을 확인.</span>
<span class="nv">$ </span>cilium bgp routes
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age      Attrs</span>
<span class="c">#    k8s-ctr   65001     172.20.0.0/24   0.0.0.0   15m44s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w0    65001     172.20.2.0/24   0.0.0.0   15m44s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w1    65001     172.20.1.0/24   0.0.0.0   15m44s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 cilium 라우팅 정보에는 BGP UPDATE로 받은 정보가 있습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    172.20.0.0/24 via 172.20.0.222 dev cilium_host proto kernel src 172.20.0.222</span>
<span class="c">#    172.20.0.222 dev cilium_host proto kernel scope link</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100</span>
<span class="c">#    192.168.20.0/24 via 192.168.10.200 dev eth1 proto static</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s-ctr 노드의 커널 라우팅 테이블에는 추가되지 않았습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_3.png" alt="img.png" class="image-center image-bg" loading="lazy" width="1208" height="873">
<em class="image-caption">termshark에서 BGP UPDATE 패킷 확인</em></p>

<ul>
  <li>cilium에 BGP 설정이되어 이제 라우팅이 가능해질것 같습니다.</li>
  <li>하지만 커널 라우팅 테이블에는 추가되지 않았습니다. 그 이유는 다음과 같습니다.
    <ul>
      <li>Cilium BGP는 eBPF를 통해 라우팅하기 때문에 커널 라우팅 테이블에 추가할 필요가 없습니다.</li>
      <li>Cilium BGP Speaker가 기반하는 GoBGP 라이브러리는 <code class="language-plaintext highlighter-rouge">disable-fib</code> 상태로 빌드되어 Linux 커널(FIB)에 주입되도록 설정 되어있습니다.</li>
    </ul>
  </li>
</ul>

<h3 id="문제-해결-후-통신">문제 해결 후 통신</h3>

<ul>
  <li>현재 실습 환경은 2개의 NIC(eth0, eth1)을 사용하고 있는 상황으로, default GW가 eth0 경로로 설정 되어 있습니다.</li>
  <li>eth1은 k8s 통신 용도로 사용 중이며, 현재 k8s 파드 사용 대역 통신 전체는 eth1을 통해서 라우팅 설정해야 합니다.</li>
  <li>해당 라우팅을 상단에 네트워크 장비가 받게 되고, 해당 장비는 Cilium Node를 통해 모든 PodCIDR 정보를 알고 있기에, 목적지로 전달 가능합니다.</li>
  <li>결론은 Cilium 으로 BGP 사용 시, 2개 이상의 NIC 사용할 경우에는 Node에 직접 라우팅 설정 및 관리가 필요합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s 파드 사용 대역 통신 전체는 eth1을 통해서 라우팅 설정</span>
<span class="nv">$ </span>ip route add 172.20.0.0/16 via 192.168.10.200
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1 <span class="nb">sudo </span>ip route add 172.20.0.0/16 via 192.168.10.200
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w0 <span class="nb">sudo </span>ip route add 172.20.0.0/16 via 192.168.20.200

<span class="c"># router 가 bgp로 학습한 라우팅 정보 한번 더 확인 : </span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route | <span class="nb">grep </span>bgp
<span class="c"># =&gt; 172.20.0.0/24 nhid 63 via 192.168.10.100 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.1.0/24 nhid 64 via 192.168.10.101 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.2.0/24 nhid 60 via 192.168.20.100 dev eth2 proto bgp metric 20 </span>

<span class="c"># 정상 통신 확인!</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-rl4d2</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-n7fk7</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-j6b7t</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 각 노드의 파드와 잘 통신이 되는것을 확인할 수 있습니다.&lt;/span&gt;</span>

<span class="c"># hubble relay 포트 포워딩 실행</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="nv">$ </span>hubble status
<span class="c"># =&gt; hubble status</span>
<span class="c">#    Healthcheck (via localhost:4245): Ok</span>
<span class="c">#    Current/Max Flows: 12,285/12,285 (100.00%)</span>
<span class="c">#    Flows/s: 65.38</span>
<span class="c">#    Connected Nodes: 3/3</span>

<span class="c"># flow log 모니터링</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--protocol</span> tcp <span class="nt">--pod</span> curl-pod
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_4.png" alt="img.png" class="image-center image-bg" loading="lazy" width="1142" height="793">
<em class="image-caption">curl-pod에서 webpod로 통신하는 흐름 확인</em></p>

<h3 id="노드-유지보수-k8s-w0-실습">노드 유지보수 (k8s-w0) 실습</h3>

<ul>
  <li>노드를 유지보수 하기 위해서 라우팅을 해제시키고, 다시 복구하는 실습을 진행해 보겠습니다. - <a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-operation/#shutting-down-a-node">Docs</a>
</li>
</ul>

<h5 id="노드-유지보수를-위한-설정">노드 유지보수를 위한 설정</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 모니터링 : 반복 호출</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>

<span class="c"># (참고) BGP Control Plane logs</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system <span class="nt">-l</span> <span class="nv">name</span><span class="o">=</span>cilium-operator <span class="nt">-f</span> | <span class="nb">grep</span> <span class="s2">"subsys=bgp-cp-operator"</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium <span class="nt">-f</span> | <span class="nb">grep</span> <span class="s2">"subsys=bgp-control-plane"</span>

<span class="c"># 유지보수를 위한 설정</span>
<span class="nv">$ </span>kubectl drain k8s-w0 <span class="nt">--ignore-daemonsets</span>
<span class="c"># =&gt; evicting pod default/webpod-697b545f57-n7fk7</span>
<span class="c">#    pod/webpod-697b545f57-n7fk7 evicted</span>
<span class="c">#    node/k8s-w0 drained</span>
<span class="nv">$ </span>kubectl label nodes k8s-w0 enable-bgp<span class="o">=</span><span class="nb">false</span> <span class="nt">--overwrite</span>
<span class="c"># =&gt; node/k8s-w0 labeled</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get node
<span class="c"># =&gt; NAME      STATUS                     ROLES           AGE   VERSION</span>
<span class="c">#    k8s-ctr   Ready                      control-plane   8h    v1.33.2</span>
<span class="c">#    k8s-w0    Ready&lt;span style="color: green;"&gt;,SchedulingDisabled&lt;/span&gt;   &lt;none&gt;          8h    v1.33.2</span>
<span class="c">#    k8s-w1    Ready                      &lt;none&gt;          8h    v1.33.2</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 drain을 통해 k8s-w0에 pod 스케줄링이 되지 않도록 설정 되었습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get ciliumbgpnodeconfigs
<span class="c"># =&gt; NAME      AGE</span>
<span class="c">#    k8s-ctr   50m</span>
<span class="c">#    k8s-w1    50m</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 enable-bgp=false로 라벨을 수정해서 cilium bgp node에서 k8s-w0 노드가 제외 되었습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>cilium bgp routes
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age      Attrs</span>
<span class="c">#    k8s-ctr   65001     172.20.0.0/24   0.0.0.0   52m12s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w1    65001     172.20.1.0/24   0.0.0.0   52m12s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="nv">$ </span>cilium bgp peers
<span class="c"># =&gt; Node      Local AS   Peer AS   Peer Address     Session State   Uptime   Family         Received   Advertised</span>
<span class="c">#    k8s-ctr   65001      65000     192.168.10.200   established     45m21s   ipv4/unicast   3          2</span>
<span class="c">#    k8s-w1    65001      65000     192.168.10.200   established     45m21s   ipv4/unicast   3          2   </span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp'"</span>
<span class="c"># =&gt;    Network          Next Hop            Metric LocPrf Weight Path</span>
<span class="c">#    *&gt; 10.10.1.0/24     0.0.0.0                  0         32768 i</span>
<span class="c">#    *&gt; 172.20.0.0/24    192.168.10.100                         0 65001 i</span>
<span class="c">#    *&gt; 172.20.1.0/24    192.168.10.101                         0 65001 i</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip route bgp'"</span>
<span class="c"># =&gt; B&gt;* 172.20.0.0/24 [20/0] via 192.168.10.100, eth1, weight 1, 00:46:08</span>
<span class="c">#    B&gt;* 172.20.1.0/24 [20/0] via 192.168.10.101, eth1, weight 1, 00:46:08</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route | <span class="nb">grep </span>bgp
<span class="c"># =&gt; 172.20.0.0/24 nhid 63 via 192.168.10.100 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.1.0/24 nhid 64 via 192.168.10.101 dev eth1 proto bgp metric 20</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp summary'"</span>
<span class="c"># =&gt; Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span>
<span class="c">#    192.168.10.100  4      65001       915       919        0    0    0 00:45:35            1        3 N/A</span>
<span class="c">#    192.168.10.101  4      65001       915       919        0    0    0 00:45:35            1        3 N/A</span>
<span class="c">#    &lt;span style="color: green;"&gt;192.168.20.100&lt;/span&gt;  4      65001       856       857        0    0    0 00:03:03       Active        0 N/A</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 누적된 통계를 제외하면 router의 BGP 정보에는 k8s-w0 노드가 제외된 것을 확인할 수 있습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="유지보수-완료-후-라우팅-복원">유지보수 완료 후 라우팅 복원</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 원복 설정</span>
<span class="nv">$ </span>kubectl label nodes k8s-w0 enable-bgp<span class="o">=</span><span class="nb">true</span> <span class="nt">--overwrite</span>
<span class="c"># =&gt; node/k8s-w0 labeled</span>
<span class="nv">$ </span>kubectl uncordon k8s-w0
<span class="c"># =&gt; node/k8s-w0 uncordoned</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 node를 다시 스케쥴링 가능하도록 설정합니다.&lt;/span&gt;</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get node
<span class="c"># =&gt; NAME      STATUS   ROLES           AGE   VERSION</span>
<span class="c">#    k8s-ctr   Ready    control-plane   8h    v1.33.2</span>
<span class="c">#    k8s-w0    &lt;span style="color: green;"&gt;Ready&lt;/span&gt;    &lt;none&gt;          8h    v1.33.2</span>
<span class="c">#    k8s-w1    Ready    &lt;none&gt;          8h    v1.33.2</span>
<span class="nv">$ </span>kubectl get ciliumbgpnodeconfigs
<span class="c"># =&gt; NAME      AGE</span>
<span class="c">#    k8s-ctr   57m</span>
<span class="c">#    &lt;span style="color: green;"&gt;k8s-w0    65s&lt;/span&gt;</span>
<span class="c">#    k8s-w1    57m</span>
<span class="nv">$ </span>cilium bgp routes
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age      Attrs</span>
<span class="c">#    k8s-ctr   65001     172.20.0.0/24   0.0.0.0   57m48s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    &lt;span style="color: green;"&gt;k8s-w0    65001     172.20.2.0/24   0.0.0.0   1m25s    [{Origin: i} {Nexthop: 0.0.0.0}]&lt;/span&gt;</span>
<span class="c">#    k8s-w1    65001     172.20.1.0/24   0.0.0.0   57m48s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="nv">$ </span>cilium bgp peers
<span class="c"># =&gt; Node      Local AS   Peer AS   Peer Address     Session State   Uptime   Family         Received   Advertised</span>
<span class="c">#    k8s-ctr   65001      65000     192.168.10.200   established     51m18s   ipv4/unicast   4          2</span>
<span class="c">#    &lt;span style="color: green;"&gt;k8s-w0    65001      65000     192.168.10.200   established     1m52s    ipv4/unicast   4          2&lt;/span&gt;</span>
<span class="c">#    k8s-w1    65001      65000     192.168.10.200   established     51m18s   ipv4/unicast   4          2</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp'"</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip route bgp'"</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route | <span class="nb">grep </span>bgp
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp summary'"</span>

<span class="c"># 노드별 파드 분배 실행</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE     IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                  1/1     Running   0          138m    172.20.0.187   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-d7dn8   1/1     Running   0          9m33s   172.20.1.197   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-j6b7t   1/1     Running   0          138m    172.20.0.72    k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-rl4d2   1/1     Running   0          138m    172.20.1.7     k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="nv">$ </span>kubectl scale deployment webpod <span class="nt">--replicas</span> 0
<span class="nv">$ </span>kubectl scale deployment webpod <span class="nt">--replicas</span> 3
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE    IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod                  1/1     Running   0          138m   172.20.0.187   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-h4lmx   1/1     Running   0          9s     172.20.1.12    k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-q8bzk   1/1     Running   0          9s     172.20.0.161   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-ssc5l   1/1     Running   0          9s     172.20.2.143   &lt;span style="color: green;"&gt;k8s-w0&lt;/span&gt;    &lt;none&gt;           &lt;none&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 webpod의 replica 수를 0으로 줄였다가 3으로 늘려서 노드별로 파드가 분배되는 것을 확인합니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="crd-status-report-끄기">CRD Status Report 끄기</h5>

<ul>
  <li>노드가 많은 대규모 클러스터의 경우, api 서버의 부하를 유발할 수 있어서 <code class="language-plaintext highlighter-rouge">bgp status reporting off</code>이 권장 됩니다. <a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/bgp-control-plane-operation/#disabling-crd-status-report">Docs</a>
</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get ciliumbgpnodeconfigs <span class="nt">-o</span> yaml | yq
<span class="c"># =&gt; ...</span>
<span class="c">#      status:</span>
<span class="c">#        bgpInstances:</span>
<span class="c">#        - localASN: 65001</span>
<span class="c">#          name: instance-65001</span>
<span class="c">#          peers:</span>
<span class="c">#    ...</span>

<span class="c"># 설정</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.0 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> bgpControlPlane.statusReport.enabled<span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># 확인 : CiliumBGPNodeConfig Status 정보가 없다!</span>
<span class="nv">$ </span>kubectl get ciliumbgpnodeconfigs <span class="nt">-o</span> yaml | yq
<span class="c"># =&gt; ...</span>
<span class="c">#     "status": {}</span>
<span class="c">#    ...       </span>
</code></pre></div></div>

<h5 id="serviceloadbalancer---externalip-ips를-bgp로-광고">Service(LoadBalancer - ExternalIP) IPs를 BGP로 광고</h5>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_5.png" alt="img.png" class="image-center image-bg" loading="lazy" width="1280" height="611">
<em class="image-caption"><a href="https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/#l3-announcement-over-bgp">Service(LoadBalancer - ExternalIP) IPs를 BGP로 광고</a></em></p>

<ul>
  <li>Cilium BGP는 Service(LoadBalancer - ExternalIP) IPs를 BGP로 광고할 수 있고, MetalLB를 대체할 수 있습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># LB IPAM Announcement over BGP 설정 예정으로, 노드의 네트워크 대역이 아니여도 가능!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumLoadBalancerIPPool
metadata:
  name: "cilium-pool"
spec:
  allowFirstLastIPs: "No"
  blocks:
  - cidr: "172.16.1.0/24"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumloadbalancerippool.cilium.io/cilium-pool created</span>

<span class="nv">$ </span>kubectl get ippool
<span class="c"># =&gt; NAME          DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-pool   false      False         254             16s</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl patch svc webpod <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "LoadBalancer"}}'</span>
<span class="nv">$ </span>kubectl get svc webpod 
NAME     TYPE           CLUSTER-IP    EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
<span class="c"># =&gt; NAME     TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    webpod   LoadBalancer   10.96.134.232   172.16.1.1    80:31973/TCP   7m5s</span>

<span class="nv">$ </span>kubectl get ippool
<span class="c"># =&gt; NAME          DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-pool   false      False         &lt;span style="color: green;"&gt;253&lt;/span&gt;             8m25s</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 External IP가 할당되어서, 남은 IP수가 하나 줄어서 253개의 IP가 남았습니다.&lt;/span&gt;</span>

<span class="nv">$ </span>kubectl describe svc webpod | <span class="nb">grep</span> <span class="s1">'Traffic Policy'</span>
<span class="c"># =&gt; External Traffic Policy:  Cluster</span>
<span class="c">#    Internal Traffic Policy:  Cluster</span>

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg service list
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    16   &lt;span style="color: green;"&gt;172.16.1.1:80/TCP&lt;/span&gt;      LoadBalancer   1 =&gt; 172.20.0.123:80/TCP (active)</span>
<span class="c">#                                               2 =&gt; 172.20.1.72:80/TCP (active)</span>
<span class="c">#                                               3 =&gt; 172.20.2.138:80/TCP (active)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 ExternalIP와 각 파드의 IP가 매핑된 것을 확인할 수 있습니다.&lt;/span&gt;</span>

<span class="c"># LBIP로 curl 요청 확인</span>
<span class="nv">$ </span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span>
<span class="c"># =&gt; 172.16.1.1</span>
<span class="nv">$ LBIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc webpod <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-2kvd9</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr
<span class="c"># =&gt; RemoteAddr: 192.168.10.100:60634</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr
<span class="c"># =&gt; RemoteAddr: 172.20.0.201:60184</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 같은 노드의 파드로 통신 될 때는 cilium_host IP가, 다른 노드의 파드로 통신 될 때는 node의 IP가 RemoteAddr로 보입니다.&lt;/span&gt;</span>

<span class="c"># 모니터링</span>
<span class="nv">$ </span>watch <span class="s2">"sshpass -p 'vagrant' ssh vagrant@router ip -c route"</span>
<span class="c"># =&gt; default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100</span>
<span class="c">#    10.10.1.0/24 dev loop1 proto kernel scope link src 10.10.1.200</span>
<span class="c">#    10.10.2.0/24 dev loop2 proto kernel scope link src 10.10.2.200</span>
<span class="c">#    172.20.0.0/24 nhid 60 via 192.168.10.100 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.1.0/24 nhid 64 via 192.168.10.101 dev eth1 proto bgp metric 20</span>
<span class="c">#    172.20.2.0/24 nhid 62 via 192.168.20.100 dev eth2 proto bgp metric 20</span>
<span class="c">#    192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.200</span>
<span class="c">#    192.168.20.0/24 dev eth2 proto kernel scope link src 192.168.20.200</span>

<span class="c"># LB EX-IP를 BGP로 광고 설정</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: cilium.io/v2
kind: CiliumBGPAdvertisement
metadata:
  name: bgp-advertisements-lb-exip-webpod
  labels:
    advertise: bgp
spec:
  advertisements:
    - advertisementType: "Service"
      service:
        addresses:
          - LoadBalancerIP
      selector:             
        matchExpressions:
          - { key: app, operator: In, values: [ webpod ] }
</span><span class="no">EOF

</span><span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    172.16.1.1 nhid 70 proto bgp metric 20</span>
<span class="c">#            &lt;span style="color: green;"&gt;nexthop via 192.168.10.100 dev eth1 weight 1&lt;/span&gt; # &lt;span style="color: green;"&gt;👉 BGP 광고 후 3줄이 추가되었습니다.&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;nexthop via 192.168.20.100 dev eth2 weight 1&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;nexthop via 192.168.10.101 dev eth1 weight 1&lt;/span&gt;</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl get CiliumBGPAdvertisement
<span class="c"># =&gt; NAME                                AGE</span>
<span class="c">#    bgp-advertisements                  16m</span>
<span class="c">#    bgp-advertisements-lb-exip-webpod   3m</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bgp route-policies
<span class="c"># =&gt; VRouter   Policy Name                                             Type     Match Peers         Match Families   Match Prefixes (Min..Max Len)   RIB Action   Path Actions</span>
<span class="c">#    65001     allow-local                                             import                                                                        accept</span>
<span class="c">#    65001     tor-switch-ipv4-PodCIDR                                 export   192.168.10.200/32                    172.20.1.0/24 (24..24)          accept</span>
<span class="c">#    65001     tor-switch-ipv4-Service-webpod-default-LoadBalancerIP   export   192.168.10.200/32                    172.16.1.1/32 (32..32)          accept</span>

<span class="nv">$ </span>cilium bgp routes available ipv4 unicast
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age      Attrs</span>
<span class="c">#    k8s-ctr   65001     172.16.1.1/32   0.0.0.0   3m36s    [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.0.0/24   0.0.0.0   12m38s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w0    65001     172.16.1.1/32   0.0.0.0   3m35s    [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.2.0/24   0.0.0.0   12m25s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w1    65001     172.16.1.1/32   0.0.0.0   3m35s    [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.1.0/24   0.0.0.0   12m40s   [{Origin: i} {Nexthop: 0.0.0.0}]  </span>

<span class="c"># 현재 BGP가 동작하는 모든 노드로 전달 가능!</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router ip <span class="nt">-c</span> route
<span class="c"># =&gt; ...</span>
<span class="c">#    172.16.1.1 nhid 70 proto bgp metric 20</span>
<span class="c">#            nexthop via 192.168.10.100 dev eth1 weight 1</span>
<span class="c">#            nexthop via 192.168.20.100 dev eth2 weight 1</span>
<span class="c">#            nexthop via 192.168.10.101 dev eth1 weight 1</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip route bgp'"</span>
<span class="c"># =&gt; B&gt;* 172.16.1.1/32 [20/0] via 192.168.10.100, eth1, weight 1, 00:04:10  </span>
<span class="c">#      *                      via 192.168.10.101, eth1, weight 1, 00:04:10</span>
<span class="c">#      *                      via 192.168.20.100, eth2, weight 1, 00:04:10</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 `B&gt;`로 시작하는 라우팅 정보가 BGP로 광고된 것을 확인할 수 있습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp summary'"</span>
<span class="c"># =&gt; Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span>
<span class="c">#    192.168.10.100  4      65001       332       335        0    0    0 00:14:00            2        5 N/A</span>
<span class="c">#    192.168.10.101  4      65001       331       334        0    0    0 00:14:02            2        5 N/A</span>
<span class="c">#    192.168.20.100  4      65001       333       337        0    0    0 00:13:47            2        5 N/A</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp'"</span>
<span class="c"># =&gt;    Network          Next Hop            Metric LocPrf Weight Path</span>
<span class="c">#    ...</span>
<span class="c">#    *= 172.16.1.1/32    192.168.20.100                         0 65001 i   # * valid, &gt; best, = multipath</span>
<span class="c">#    *&gt;                  192.168.10.100                         0 65001 i</span>
<span class="c">#    *=                  192.168.10.101                         0 65001 i</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 BGP 라우팅 테이블에 Multipath로 등록된 것을 확인할 수 있습니다.&lt;/span&gt;</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"sudo vtysh -c 'show ip bgp 172.16.1.1/32'"</span>
<span class="c"># =&gt; BGP routing table entry for 172.16.1.1/32, version 7</span>
<span class="c">#    Paths: (&lt;span style="color: green;"&gt;3 available&lt;/span&gt;, best #2, table default)</span>
<span class="c">#      Advertised to non peer-group peers:</span>
<span class="c">#      192.168.10.100 192.168.10.101 192.168.20.100</span>
<span class="c">#      65001</span>
<span class="c">#        192.168.20.100 from 192.168.20.100 (192.168.20.100)</span>
<span class="c">#          Origin IGP, valid, external, multipath</span>
<span class="c">#          Last update: Sat Aug 16 16:19:43 2025</span>
<span class="c">#      65001</span>
<span class="c">#        192.168.10.100 from 192.168.10.100 (192.168.10.100)</span>
<span class="c">#          Origin IGP, valid, external, multipath, best (Router ID)</span>
<span class="c">#          Last update: Sat Aug 16 16:19:43 2025</span>
<span class="c">#      65001</span>
<span class="c">#        192.168.10.101 from 192.168.10.101 (192.168.10.101)</span>
<span class="c">#          Origin IGP, valid, external, multipath</span>
<span class="c">#          Last update: Sat Aug 16 16:19:43 2025</span>
</code></pre></div></div>

<h5 id="router에서-ll-external-ip-호출-확인">router에서 LL External IP 호출 확인</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ LBIP</span><span class="o">=</span>172.16.1.1
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-2kvd9</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>RemoteAddr
<span class="c"># =&gt; RemoteAddr: 192.168.10.100:35378</span>

<span class="c"># 반복 접속</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      34 Hostname: webpod-697b545f57-lz8mc</span>
<span class="c">#         33 Hostname: webpod-697b545f57-gzzdb</span>
<span class="c">#         33 Hostname: webpod-697b545f57-2kvd9</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | egrep <span class="s1">'Hostname|RemoteAddr'</span> <span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-2kvd9</span>
<span class="c">#    RemoteAddr: 192.168.10.100:46014</span>
<span class="c">#    Hostname: webpod-697b545f57-lz8mc</span>
<span class="c">#    RemoteAddr: 192.168.10.100:38402</span>
<span class="c">#    Hostname: webpod-697b545f57-gzzdb</span>
<span class="c">#    RemoteAddr: 172.20.0.201:44744</span>
<span class="c">#    ...</span>

<span class="c"># 호출 확인을 쉽게 테스트할 수 있게 k8s-ctr 에서 replicas=2 로 줄여보겠습니다.</span>
<span class="nv">$ </span>kubectl scale deployment webpod <span class="nt">--replicas</span> 2
<span class="c"># =&gt; deployment.apps/webpod scaled</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE   IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c"># =&gt; webpod-697b545f57-nhdcd   1/1     Running   0          3s    172.20.1.130   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-t7wb4   1/1     Running   0          3s    172.20.2.198   k8s-w0    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>cilium bgp routes
<span class="c"># =&gt; Node      VRouter   Prefix          NextHop   Age      Attrs</span>
<span class="c">#    k8s-ctr   65001     172.16.1.1/32   0.0.0.0   10m58s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.0.0/24   0.0.0.0   20m0s    [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w0    65001     172.16.1.1/32   0.0.0.0   10m58s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.2.0/24   0.0.0.0   19m48s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#    k8s-w1    65001     172.16.1.1/32   0.0.0.0   10m57s   [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c">#              65001     172.20.1.0/24   0.0.0.0   20m2s    [{Origin: i} {Nexthop: 0.0.0.0}]</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 파드를 2개로 줄여서 k8s-w0과 k8s-w1에만 파드가 있지만, k8s-ctr에도 파드 및 LB ExtIP의 라우팅 정보가 남아 있습니다.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   이렇게 되면 LB ExtIP 사용시 k8s-ctr로도 접속이 되어서 k8s-w0이나 k8s-w1의 webpod에서 처리되어서 k8s-ctr으로 다시 응답이 리턴되는&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   오버헤드가 생길 수 있다는 것을 의미합니다. 이에 대한 해결 방법은 이후에 알아 보겠습니다.&lt;/span&gt;</span>

<span class="c"># router 에서 정보 확인 : k8s-ctr 노드에 대상 파드가 배치되지 않았지만, 라우팅 경로 설정이 되어 있다.</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp summary'</span>
<span class="c"># =&gt; Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span>
<span class="c">#    192.168.10.100  4      65001       548       552        0    0    0 00:24:49            2        5 N/A</span>
<span class="c">#    192.168.10.101  4      65001       547       550        0    0    0 00:24:51            2        5 N/A</span>
<span class="c">#    192.168.20.100  4      65001       550       553        0    0    0 00:24:36            2        5 N/A</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp'</span>
<span class="c"># =&gt;    Network          Next Hop            Metric LocPrf Weight Path</span>
<span class="c">#    ...</span>
<span class="c">#    *= 172.16.1.1/32    192.168.20.100                         0 65001 i</span>
<span class="c">#    *&gt;                  &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt;                         0 65001 i</span>
<span class="c">#    *=                  192.168.10.101                         0 65001 i</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip bgp 172.16.1.1/32'</span>
<span class="c"># =&gt; BGP routing table entry for 172.16.1.1/32, version 7</span>
<span class="c">#    Paths: (3 available, best #2, table default)</span>
<span class="c">#      Advertised to non peer-group peers:</span>
<span class="c">#      &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt; 192.168.10.101 192.168.20.100</span>
<span class="c">#      65001</span>
<span class="c">#        192.168.20.100 from 192.168.20.100 (192.168.20.100)</span>
<span class="c">#          Origin IGP, valid, external, multipath</span>
<span class="c">#          Last update: Sat Aug 16 16:19:42 2025</span>
<span class="c">#      65001</span>
<span class="c">#        &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt; from 192.168.10.100 (192.168.10.100)</span>
<span class="c">#          Origin IGP, valid, external, multipath, best (Router ID)</span>
<span class="c">#          Last update: Sat Aug 16 16:19:42 2025</span>
<span class="c">#      65001</span>
<span class="c">#        192.168.10.101 from 192.168.10.101 (192.168.10.101)</span>
<span class="c">#          Origin IGP, valid, external, multipath</span>
<span class="c">#          Last update: Sat Aug 16 16:19:42 2025</span>
<span class="nv">$ </span>vtysh <span class="nt">-c</span> <span class="s1">'show ip route bgp'</span>
<span class="c"># =&gt; B&gt;* 172.16.1.1/32 [20/0] via &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt;, eth1, weight 1, 00:17:01</span>
<span class="c">#      *                      via 192.168.10.101, eth1, weight 1, 00:17:01</span>
<span class="c">#      *                      via 192.168.20.100, eth2, weight 1, 00:17:01</span>
<span class="c">#    ...</span>

<span class="c"># [k8s-ctr] 반복 접속</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span><span class="p">;</span>  <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | <span class="nb">grep </span>Hostname<span class="p">;</span> <span class="k">done</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> <span class="nt">-c</span> | <span class="nb">sort</span> <span class="nt">-nr</span>
<span class="c"># =&gt;      52 Hostname: webpod-697b545f57-t7wb4</span>
<span class="c">#         48 Hostname: webpod-697b545f57-nhdcd</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 replicas가 2이기 때문에, webpod의 파드가 k8s-w0, k8s-w1의 2개로 분배되어서 Hostname이 2개가 출력되는 것을 확인할 수 있습니다.&lt;/span&gt;</span>
<span class="nv">$ </span><span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span> | egrep <span class="s1">'Hostname|RemoteAddr'</span> <span class="p">;</span> <span class="nb">sleep </span>0.1<span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-t7wb4</span>
<span class="c">#    RemoteAddr: 192.168.10.100:43914</span>
<span class="c">#    Hostname: webpod-697b545f57-t7wb4</span>
<span class="c">#    RemoteAddr: 192.168.10.100:43920</span>
<span class="c">#    Hostname: webpod-697b545f57-nhdcd</span>
<span class="c">#    RemoteAddr: 192.168.10.100:53840</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 다른 노드에 있는 webpod 파드와 접속이 되어서 k8s-ctr의 NodeIP가 출력됩니다.&lt;/span&gt;</span>

<span class="c"># 신규터미널 (3개) : k8s-w1, k8s-w2, k8s-w0</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> eth1 <span class="nt">-A</span> <span class="nt">-s</span> 0 <span class="nt">-nn</span> <span class="s1">'tcp port 80'</span>

<span class="c"># k8s-ctr 를 경유하거나 등 확인 : ExternalTrafficPolicy 설정 확인</span>
<span class="nv">$ LBIP</span><span class="o">=</span>172.16.1.1
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nv">$LBIP</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s-w0 이나 k8s-w1과 통신이 되며 k8s-ctr의 eth1을 경유해서 패킷이 전송되는 것을 확인할 수 있습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<hr>

<h2 id="kind">Kind</h2>

<h3 id="kind-소개">Kind 소개</h3>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_8.png" alt="img.png" class="w-20 image-center" loading="lazy" width="985" height="594"></p>

<ul>
  <li>Kind는 <strong>K</strong>ubernetes <strong>in</strong> <strong>D</strong>ocker의 줄임말로, 로컬 환경에서 쉽게 Kubernetes 클러스터를 구성할 수 있도록 도와주는 도구입니다.</li>
  <li>이름처럼 Docker를 이용하여 Kubernetes 클러스터를 구성하며, Docker를 이용하기 때문에 다양한 환경에서 쉽게 사용할 수 있습니다.</li>
  <li>Kind는 HA를 포함한 멀티노드를 지원하지만, 테스트와 실험적인 목적으로만 사용하기를 추천합니다.</li>
  <li>Kind는 클러스터를 구성하기 위해 kubeadm을 사용합니다.</li>
  <li>
<a href="https://sweetlittlebird.github.io/posts/2024-09-07-KANS-Study-Week2/#kind-%EC%86%8C%EA%B0%9C-%EB%B0%8F-%EC%84%A4%EC%B9%98">Kind 소개 및 설치</a>, <a href="https://kind.sigs.k8s.io/docs/user/quick-start/">Kind 공식문서</a>
</li>
</ul>

<p><img src="/assets/2024/cicd-lite/w3/20241221_cicd_lite_w3_9.png" alt="img.png" class="image-center" loading="lazy" width="2048" height="1152">
<em class="image-caption"><a href="https://kind.sigs.k8s.io/">Kind 구성도</a></em></p>

<h3 id="kind-설치">Kind 설치</h3>

<ul>
  <li>Apple Silicon 기반 Mac 기준으로 설치를 진행해보겠습니다.</li>
</ul>

<h4 id="docker-desktop-및-필수-툴-설치">Docker Desktop 및 필수 툴 설치</h4>

<ul>
  <li>Docker Desktop 설치 - <a href="https://docs.docker.com/desktop/install/mac-install/">Link</a>
    <ul>
      <li>실습 환경 : Kind 사용하는 도커 엔진 리소스에 최소 <strong>vCPU 4</strong>, <strong>Memory 8GB</strong> 할당을 권고합니다. - <a href="https://kind.sigs.k8s.io/docs/user/quick-start/#settings-for-docker-desktop">링크</a>
</li>
    </ul>
  </li>
  <li>필수 툴 설치
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># Install Kind</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kind
<span class="nv">$ </span>kind <span class="nt">--version</span>
<span class="c"># =&gt; kind version 0.29.0</span>
  
<span class="c"># Install kubectl</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubernetes-cli
<span class="nv">$ </span>kubectl version <span class="nt">--client</span><span class="o">=</span><span class="nb">true</span>
<span class="c"># =&gt; Client Version: v1.33.1</span>
  
<span class="c">## kubectl -&gt; k 단축키 설정</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"alias kubectl=kubecolor"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
  
<span class="c"># Install Helm</span>
<span class="nv">$ </span>brew <span class="nb">install </span>helm
<span class="nv">$ </span>helm version
<span class="c"># =&gt; version.BuildInfo{Version:"v3.18.2", GitCommit:"04cad4610054e5d546aa5c5d9c1b1d5cf68ec1f8", GitTreeState:"clean", GoVersion:"go1.24.3"}</span>
</code></pre></div>    </div>
  </li>
  <li>(선택) 유용한 툴 설치
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 툴 설치</span>
<span class="nv">$ </span>brew <span class="nb">install </span>krew
<span class="nv">$ </span>brew <span class="nb">install </span>kube-ps1
<span class="nv">$ </span>brew <span class="nb">install </span>kubectx
  
<span class="c"># kubectl 출력 시 하이라이트 처리</span>
<span class="nv">$ </span>brew <span class="nb">install </span>kubecolor
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"alias kubectl=kubecolor"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"compdef kubecolor=kubectl"</span> <span class="o">&gt;&gt;</span> ~/.zshrc
</code></pre></div>    </div>
    <h3 id="kind-기본-사용---클러스터-배포-및-확인">kind 기본 사용 - 클러스터 배포 및 확인</h3>
  </li>
</ul>

<blockquote>
  <p>이미 kubeconfig가 있다면, 미리 kubeconfig를 백업 후 kind를 실습하거나, 아래 처럼 kubeconfig 변수를 지정하여 사용하기를 권장합니다.</p>
</blockquote>

<ul>
  <li>(옵션) 별도 kubeconfig 지정 후 사용
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 방안1 : 환경변수 지정</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/Users/&lt;Username&gt;/Downloads/kind/config
  
<span class="c"># 방안2 : 혹은 --kubeconfig ./config 지정 가능</span>
  
<span class="c"># 클러스터 생성</span>
<span class="nv">$ </span>kind create cluster
  
<span class="c"># kubeconfig 파일 확인</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /Users/&lt;Username&gt;/Downloads/kind/config
<span class="c"># =&gt; -rw-------  1 &lt;Username&gt;  staff  5608  4 24 09:05 /Users/&lt;Username&gt;/Downloads/kind/config</span>
  
<span class="c"># 파드 정보 확인</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
  
<span class="c"># 클러스터 삭제</span>
<span class="nv">$ </span>kind delete cluster
<span class="nv">$ </span><span class="nb">unset </span>KUBECONFIG
</code></pre></div>    </div>
  </li>
  <li>Kind 클러스터 배포 및 확인
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 클러스터 배포 전 확인</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span>
  
<span class="c"># Create a cluster with kind</span>
<span class="nv">$ </span>kind create cluster
<span class="c"># =&gt; Creating cluster "kind" ...</span>
<span class="c">#     ✓ Ensuring node image (kindest/node:v1.33.1) 🖼</span>
<span class="c">#     ✓ Preparing nodes 📦</span>
<span class="c">#     ✓ Writing configuration 📜</span>
<span class="c">#     ✓ Starting control-plane 🕹️</span>
<span class="c">#     ✓ Installing CNI 🔌</span>
<span class="c">#     ✓ Installing StorageClass 💾</span>
<span class="c">#    Set kubectl context to "kind-kind"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-kind</span>
  
<span class="c"># 클러스터 배포 확인</span>
<span class="nv">$ </span>kind get clusters
<span class="c"># =&gt; kind</span>
<span class="nv">$ </span>kind get nodes
<span class="c"># =&gt; kind-control-plane</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://127.0.0.1:56460</span>
<span class="c">#    CoreDNS is running at https://127.0.0.1:56460/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="c">#    </span>
<span class="c">#    To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>
  
<span class="c"># 노드 정보 확인</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                 STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    kind-control-plane   Ready    control-plane   48s   v1.33.1   172.20.0.2    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.1.1</span>
  
<span class="c"># 파드 정보 확인</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-922ww                     1/1     Running   0          49s</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-mm68k                     1/1     Running   0          49s</span>
<span class="c">#    kube-system          etcd-kind-control-plane                      1/1     Running   0          55s</span>
<span class="c">#    kube-system          kindnet-cvgzn                                1/1     Running   0          49s</span>
<span class="c">#    kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          55s</span>
<span class="c">#    kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          55s</span>
<span class="c">#    kube-system          kube-proxy-xkczv                             1/1     Running   0          49s</span>
<span class="c">#    kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          55s</span>
<span class="c">#    local-path-storage   local-path-provisioner-7dc846544d-th5jx      1/1     Running   0          49s</span>
<span class="nv">$ </span>kubectl get componentstatuses
<span class="c"># =&gt; NAME                 STATUS    MESSAGE   ERROR</span>
<span class="c">#    scheduler            Healthy   ok</span>
<span class="c">#    controller-manager   Healthy   ok</span>
<span class="c">#    etcd-0               Healthy   ok</span>
  
<span class="c"># 컨트롤플레인 (컨테이너) 노드 1대가 실행</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS              PORTS                       NAMES</span>
<span class="c">#    d2b1bc35791a   kindest/node:v1.33.1   "/usr/local/bin/entr…"   About a minute ago   Up About a minute   127.0.0.1:56460-&gt;6443/tcp   kind-control-plane</span>
<span class="nv">$ </span>docker images
<span class="c"># =&gt; REPOSITORY                                        TAG                                        IMAGE ID       CREATED         SIZE</span>
<span class="c">#    kindest/node                                      &lt;none&gt;                                     071dd73121e8   2 months ago    1.09GB</span>
  
<span class="c"># kube config 파일 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
<span class="c"># 혹은</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$KUBECONFIG</span> <span class="c"># KUBECONFIG 변수 지정 사용 시</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 기존 kube config에 추가적으로 kind 클러스터 관련 항목이 추가된 것을 확인할 수 있습니다.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   또한 current-context: kind-kind여서 kubectl 명령어를 실행하면 kind 클러스터에 연결되어 실행됩니다.&lt;/span&gt;</span>
  
<span class="c"># nginx 파드 배포 및 확인 : 컨트롤플레인 노드인데 파드가 배포 될까요?</span>
<span class="nv">$ </span>kubectl run nginx <span class="nt">--image</span><span class="o">=</span>nginx:alpine
<span class="c"># =&gt; pod/nginx created</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME    READY   STATUS    RESTARTS   AGE   IP           NODE                 NOMINATED NODE   READINESS GATES</span>
<span class="c">#    nginx   1/1     Running   0          11s   10.244.0.5   kind-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 파드가 배포 됩니다!&lt;/span&gt;</span>
  
<span class="c"># 노드에 Taints 정보 확인</span>
<span class="nv">$ </span>kubectl describe node | <span class="nb">grep </span>Taints
<span class="c"># =&gt; Taints:             &lt;none&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 컨트롤플레인이지만 Taints가 없어서 파드가 배포 됩니다.&lt;/span&gt;</span>
  
<span class="c"># 클러스터 삭제</span>
<span class="nv">$ </span>kind delete cluster
<span class="c"># =&gt; Deleting cluster "kind" ...</span>
  
<span class="c"># kube config 삭제 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
<span class="c"># 혹은</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$KUBECONFIG</span> <span class="c"># KUBECONFIG 변수 지정 사용 시</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 kind 클러스터 관련 항목이 삭제된 것을 확인할 수 있습니다.&lt;/span&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>kind로 worker node가 3개인 클러스터 배포 후 기본 정보를 확인해보겠습니다.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 클러스터 배포 전 확인</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span>
  
<span class="c"># Create a cluster with kind</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--name</span> myk8s <span class="nt">--image</span> kindest/node:v1.32.2 <span class="nt">--config</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  - containerPort: 30003
    hostPort: 30003
- role: worker
- role: worker
- role: worker
</span><span class="no">EOF
</span><span class="c"># =&gt; Creating cluster "myk8s" ...</span>
<span class="c">#     ✓ Ensuring node image (kindest/node:v1.32.2) 🖼</span>
<span class="c">#     ✓ Preparing nodes 📦 📦 📦 📦</span>
<span class="c">#     ✓ Writing configuration 📜</span>
<span class="c">#     ✓ Starting control-plane 🕹️</span>
<span class="c">#     ✓ Installing CNI 🔌</span>
<span class="c">#     ✓ Installing StorageClass 💾</span>
<span class="c">#     ✓ Joining worker nodes 🚜</span>
<span class="c">#    Set kubectl context to "kind-myk8s"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-myk8s</span>
<span class="c">#    Have a nice day! 👋</span>
  
<span class="c"># 확인</span>
<span class="nv">$ </span>kind get nodes <span class="nt">--name</span> myk8s
<span class="c"># =&gt; myk8s-worker3</span>
<span class="c">#    myk8s-worker2</span>
<span class="c">#    myk8s-control-plane</span>
<span class="c">#    myk8s-worker</span>
<span class="nv">$ </span>kubens default
<span class="c"># =&gt; Context "kind-myk8s" modified.</span>
<span class="c">#    Active namespace is "default".</span>
  
<span class="c"># kind 는 별도 도커 네트워크 생성 후 사용 : 기본값 172.20.0.0/16</span>
<span class="nv">$ </span>docker network <span class="nb">ls</span>
<span class="c"># =&gt; NETWORK ID     NAME                         DRIVER    SCOPE</span>
<span class="c">#    db5d49a84cd0   bridge                       bridge    local</span>
<span class="c">#    8204a0851463   host                         host      local</span>
<span class="c">#    &lt;span style="color: green;"&gt;3bbcc6aa8f38   kind&lt;/span&gt;                         bridge    local</span>
<span class="nv">$ </span>docker inspect kind | jq
<span class="c"># =&gt; ...</span>
<span class="c">#        "IPAM": {</span>
<span class="c">#          "Config": [</span>
<span class="c">#            {</span>
<span class="c">#              "Subnet": "172.20.0.0/16",</span>
<span class="c">#              "Gateway": "172.20.0.1"</span>
<span class="c">#    ...</span>
<span class="c"># k8s api 주소 확인 : 어떻게 로컬에서 접속이 되는 걸까요?</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at &lt;span style="color: green;"&gt;https://127.0.0.1:57349&lt;/span&gt;</span>
<span class="c">#    CoreDNS is running at https://127.0.0.1:57349/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="c">#    </span>
<span class="c">#    To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span>
  
<span class="c"># 노드 정보 확인 : CRI 는 containerd 사용</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide
<span class="c"># =&gt; NAME                  STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    myk8s-control-plane   Ready    control-plane   3m36s   v1.32.2   172.20.0.5    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.0.3</span>
<span class="c">#    myk8s-worker          Ready    &lt;none&gt;          3m26s   v1.32.2   172.20.0.2    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.0.3</span>
<span class="c">#    myk8s-worker2         Ready    &lt;none&gt;          3m26s   v1.32.2   172.20.0.3    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.0.3</span>
<span class="c">#    myk8s-worker3         Ready    &lt;none&gt;          3m26s   v1.32.2   172.20.0.4    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.0.3</span>
  
<span class="c"># 파드 정보 확인 : CNI 는 kindnet 사용</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-o</span> wide
<span class="c"># =&gt; NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE     IP           NODE                  NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system          coredns-668d6bf9bc-2d5fq                      1/1     Running   0          3m37s   10.244.0.3   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          coredns-668d6bf9bc-f8vg2                      1/1     Running   0          3m37s   10.244.0.4   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          etcd-myk8s-control-plane                      1/1     Running   0          3m45s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          &lt;span style="color: green;"&gt;kindnet-b47qh&lt;/span&gt;                                 1/1     Running   0          3m36s   172.20.0.2   myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          &lt;span style="color: green;"&gt;kindnet-fx7pl&lt;/span&gt;                                 1/1     Running   0          3m38s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          &lt;span style="color: green;"&gt;kindnet-jr9g8&lt;/span&gt;                                 1/1     Running   0          3m36s   172.20.0.4   myk8s-worker3         &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          &lt;span style="color: green;"&gt;kindnet-sck5c&lt;/span&gt;                                 1/1     Running   0          3m36s   172.20.0.3   myk8s-worker2         &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-apiserver-myk8s-control-plane            1/1     Running   0          3m45s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-controller-manager-myk8s-control-plane   1/1     Running   0          3m45s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-5vlx4                              1/1     Running   0          3m36s   172.20.0.4   myk8s-worker3         &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-8kz4j                              1/1     Running   0          3m36s   172.20.0.3   myk8s-worker2         &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-rlnwn                              1/1     Running   0          3m37s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-proxy-znszc                              1/1     Running   0          3m36s   172.20.0.2   myk8s-worker          &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          kube-scheduler-myk8s-control-plane            1/1     Running   0          3m45s   172.20.0.5   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    local-path-storage   local-path-provisioner-7dc846544d-h5xp6       1/1     Running   0          3m37s   10.244.0.2   myk8s-control-plane   &lt;none&gt;           &lt;none&gt;</span>
  
<span class="c"># 네임스페이스 확인 &gt;&gt; 도커 컨테이너에서 배운 네임스페이스와 다릅니다!</span>
<span class="nv">$ </span>kubectl get namespaces
<span class="c"># =&gt; NAME                 STATUS   AGE</span>
<span class="c">#    default              Active   5m31s</span>
<span class="c">#    kube-node-lease      Active   5m31s</span>
<span class="c">#    kube-public          Active   5m31s</span>
<span class="c">#    kube-system          Active   5m31s</span>
<span class="c">#    local-path-storage   Active   5m23s</span>
  
<span class="c"># 컨트롤플레인/워커 노드(컨테이너) 확인 : 도커 컨테이너 이름은 myk8s-control-plane , myk8s-worker/2/3 임을 확인</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS         PORTS                                                             NAMES</span>
<span class="c">#    98bc90974283   kindest/node:v1.32.2   "/usr/local/bin/entr…"   6 minutes ago   Up 5 minutes                                                                     myk8s-worker3</span>
<span class="c">#    4bf34678cbed   kindest/node:v1.32.2   "/usr/local/bin/entr…"   6 minutes ago   Up 5 minutes                                                                     myk8s-worker2</span>
<span class="c">#    f85eef8fcd53   kindest/node:v1.32.2   "/usr/local/bin/entr…"   6 minutes ago   Up 5 minutes   0.0.0.0:30000-30003-&gt;30000-30003/tcp, 127.0.0.1:57349-&gt;6443/tcp   myk8s-control-plane</span>
<span class="c">#    1f27bfafc1ac   kindest/node:v1.32.2   "/usr/local/bin/entr…"   6 minutes ago   Up 5 minutes                                                                     myk8s-worker</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 controlplane의 API 서버(6443/tcp)를 host의 57349포트로 포트포워딩 하고 &lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   kubectl cluster-info에서 확인한것 처럼 kubectl 사용시 127.0.0.1:57349로 접속이 되기 때문에&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   host에서 kubectl로 접속이 가능하게 됩니다.&lt;/span&gt;</span>
<span class="nv">$ </span>docker images
<span class="c"># =&gt; REPOSITORY                                        TAG                                        IMAGE ID       CREATED         SIZE</span>
<span class="c">#    kindest/node                                      &lt;none&gt;                                     071dd73121e8   2 months ago    1.09GB</span>
<span class="c">#    kindest/node                                      &lt;span style="color: green;"&gt;v1.32.2&lt;/span&gt;                                    b5193db9db63   5 months ago    1.06GB</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 클러스터 설치시 버전을 1.32.2로 지정했기 때문에 kindest/node:v1.32.2 이미지가 다운로드된 것을 확인할 수 있습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> myk8s-control-plane ss <span class="nt">-tnlp</span>
<span class="c"># =&gt; State              Recv-Q             Send-Q                           Local Address:Port                            Peer Address:Port             Process</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:10257                                0.0.0.0:*                 users:(("kube-controller",pid=584,fd=3))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:10259                                0.0.0.0:*                 users:(("kube-scheduler",pid=522,fd=3))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:34873                                0.0.0.0:*                 users:(("containerd",pid=105,fd=11))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:10248                                0.0.0.0:*                 users:(("kubelet",pid=705,fd=17))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:10249                                0.0.0.0:*                 users:(("kube-proxy",pid=890,fd=12))</span>
<span class="c">#    LISTEN             0                  4096                                172.20.0.5:2379                                 0.0.0.0:*                 users:(("etcd",pid=646,fd=9))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:2379                                 0.0.0.0:*                 users:(("etcd",pid=646,fd=8))</span>
<span class="c">#    LISTEN             0                  4096                                172.20.0.5:2380                                 0.0.0.0:*                 users:(("etcd",pid=646,fd=7))</span>
<span class="c">#    LISTEN             0                  4096                                 127.0.0.1:2381                                 0.0.0.0:*                 users:(("etcd",pid=646,fd=13))</span>
<span class="c">#    LISTEN             0                  1024                                127.0.0.11:38253                                0.0.0.0:*</span>
<span class="c">#    LISTEN             0                  4096                                         *:10250                                      *:*                 users:(("kubelet",pid=705,fd=11))</span>
<span class="c">#    LISTEN             0                  4096                                         &lt;span style="color: green;"&gt;*:6443&lt;/span&gt;                                       *:*                 users:(("kube-apiserver",pid=562,fd=3))</span>
<span class="c">#    LISTEN             0                  4096                                         *:10256                                      *:*                 users:(("kube-proxy",pid=890,fd=10))</span>
  
<span class="c"># 디버그용 내용 출력에 ~/.kube/config 권한 인증 로드</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-v6</span>
<span class="c"># =&gt; I0816 17:31:00.340008   21457 loader.go:402] &lt;span style="color: green;"&gt;Config loaded from file:  /Users/anonym/.kube/config&lt;/span&gt;</span>
<span class="c">#    I0816 17:31:00.342176   21457 envvar.go:172] "Feature gate default state" feature="ClientsAllowCBOR" enabled=false</span>
<span class="c">#    I0816 17:31:00.342185   21457 envvar.go:172] "Feature gate default state" feature="ClientsPreferCBOR" enabled=false</span>
<span class="c">#    I0816 17:31:00.342188   21457 envvar.go:172] "Feature gate default state" feature="InformerResourceVersion" enabled=false</span>
<span class="c">#    I0816 17:31:00.342190   21457 envvar.go:172] "Feature gate default state" feature="InOrderInformers" enabled=true</span>
<span class="c">#    I0816 17:31:00.342212   21457 envvar.go:172] "Feature gate default state" feature="WatchListClient" enabled=false</span>
<span class="c">#    I0816 17:31:00.378209   21457 round_trippers.go:632] "Response" verb="GET" url="https://127.0.0.1:57349/api/v1/namespaces/default/pods?limit=500" status="200 OK" milliseconds=29</span>
<span class="c">#    No resources found in default namespace.</span>
  
<span class="c"># kube config 파일 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
<span class="c"># 혹은</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="nv">$KUBECONFIG</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 kind-myk8s 클러스터 관련 항목이 추가된 것을 확인할 수 있습니다.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   또한 current-context: kind-myk8s여서 kubectl 명령어를 실행하면 kind-myk8s 클러스터에 연결되어 실행됩니다.&lt;/span&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>Kind 클러스터 삭제
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># 클러스터 삭제</span>
<span class="nv">$ </span>kind delete cluster <span class="nt">--name</span> myk8s
<span class="c"># =&gt; Deleting cluster "myk8s" ...</span>
<span class="c">#    Deleted nodes: ["myk8s-worker3" "myk8s-worker2" "myk8s-control-plane" "myk8s-worker"]</span>
<span class="nv">$ </span>docker ps
<span class="c"># =&gt; CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config
</code></pre></div>    </div>
  </li>
</ul>

<hr>

<h2 id="cluster-mesh">Cluster Mesh</h2>

<blockquote>
  <p>현재 1.18 버전의 ClusterMesh 분산 동작에 이상이 있는것 같아서, 1.17.6 버전으로 실습을 진행하겠습니다.</p>
</blockquote>

<ul>
  <li>Cluster Mesh는 Cilium의 기능 중 하나로, 여러 Kubernetes 클러스터를 연결하여 네트워크를 확장할 수 있는 기능입니다.</li>
</ul>

<h4 id="kind-k8s-클러스터-west-east-배포">kind k8s 클러스터 west, east 배포</h4>

<ul>
  <li><a href="https://docs.cilium.io/en/latest/installation/kind/">관련 문서</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># west 클러스터를 먼저 배포합니다.</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--name</span> west <span class="nt">--image</span> kindest/node:v1.33.2 <span class="nt">--config</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000 # sample apps
    hostPort: 30000
  - containerPort: 30001 # hubble ui
    hostPort: 30001
- role: worker
  extraPortMappings:
  - containerPort: 30002 # sample apps
    hostPort: 30002
networking:
  podSubnet: "10.0.0.0/16"
  serviceSubnet: "10.2.0.0/16"
  disableDefaultCNI: true
  kubeProxyMode: none
</span><span class="no">EOF
</span><span class="c"># =&gt; Creating cluster "west" ...</span>
<span class="c">#     ✓ Ensuring node image (kindest/node:v1.33.2) 🖼</span>
<span class="c">#     ✓ Preparing nodes 📦 📦</span>
<span class="c">#     ✓ Writing configuration 📜</span>
<span class="c">#     ✓ Starting control-plane 🕹️</span>
<span class="c">#     ✓ Installing StorageClass 💾</span>
<span class="c">#     ✓ Joining worker nodes 🚜</span>
<span class="c">#    Set kubectl context to "kind-west"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-west</span>
<span class="c">#    </span>
<span class="c">#    Have a nice day! 👋</span>

<span class="c"># 설치 확인</span>
<span class="nv">$ </span>kubectl ctx
<span class="c"># =&gt;   kind-west</span>
<span class="nv">$ </span>kubectl get node 
<span class="c"># =&gt; NAME                 STATUS     ROLES           AGE   VERSION</span>
<span class="c">#    west-control-plane   NotReady   control-plane   75s   v1.33.2</span>
<span class="c">#    west-worker          NotReady   &lt;none&gt;          64s   v1.33.2</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-5zmlc                     &lt;span style="color: green;"&gt;0/1&lt;/span&gt;     Pending   0          86s</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-b72sk                     &lt;span style="color: green;"&gt;0/1&lt;/span&gt;     Pending   0          86s</span>
<span class="c">#    kube-system          etcd-west-control-plane                      1/1     Running   0          93s</span>
<span class="c">#    kube-system          kube-apiserver-west-control-plane            1/1     Running   0          93s</span>
<span class="c">#    kube-system          kube-controller-manager-west-control-plane   1/1     Running   0          93s</span>
<span class="c">#    kube-system          kube-scheduler-west-control-plane            1/1     Running   0          93s</span>
<span class="c">#    local-path-storage   local-path-provisioner-7dc846544d-vlh7b      &lt;span style="color: green;"&gt;0/1&lt;/span&gt;     Pending   0          86s</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 Cilium 설치를 위해 disableDefaultCNI: true를 지정했기 때문에, CNI가 설치되지 않았고 일부 파드가 Pending 상태입니다.&lt;/span&gt;</span>

<span class="c"># 노드에 기본 툴 설치</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget net-tools dnsutils tcpdump ngrep iputils-ping git -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-worker sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget net-tools dnsutils tcpdump ngrep iputils-ping git -y'</span>

<span class="c"># 이어서 east 클러스터를 배포합니다.</span>
<span class="nv">$ </span>kind create cluster <span class="nt">--name</span> east <span class="nt">--image</span> kindest/node:v1.33.2 <span class="nt">--config</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 31000 # sample apps
    hostPort: 31000
  - containerPort: 31001 # hubble ui
    hostPort: 31001
- role: worker
  extraPortMappings:
  - containerPort: 31002 # sample apps
    hostPort: 31002
networking:
  podSubnet: "10.1.0.0/16"
  serviceSubnet: "10.3.0.0/16"
  disableDefaultCNI: true
  kubeProxyMode: none
</span><span class="no">EOF
</span><span class="c"># =&gt; Creating cluster "east" ...</span>
<span class="c">#     ✓ Ensuring node image (kindest/node:v1.33.2) 🖼</span>
<span class="c">#     ✓ Preparing nodes 📦 📦</span>
<span class="c">#     ✓ Writing configuration 📜</span>
<span class="c">#     ✓ Starting control-plane 🕹️</span>
<span class="c">#     ✓ Installing StorageClass 💾</span>
<span class="c">#     ✓ Joining worker nodes 🚜</span>
<span class="c">#    Set kubectl context to "kind-east"</span>
<span class="c">#    You can now use your cluster with:</span>
<span class="c">#    </span>
<span class="c">#    kubectl cluster-info --context kind-east</span>
<span class="c">#    </span>
<span class="c">#    Have a nice day! 👋</span>

<span class="c"># 설치 확인</span>
<span class="nv">$ </span>kubectl config get-contexts 
<span class="c"># =&gt; CURRENT   NAME         CLUSTER     AUTHINFO    NAMESPACE</span>
<span class="c">#    *         kind-east    kind-east   kind-east</span>
<span class="c">#              kind-west    kind-west   kind-west</span>

<span class="c"># 기본 context를 kind-east로 변경</span>
<span class="nv">$ </span>kubectl config set-context kind-east
<span class="c"># =&gt; Context "kind-east" modified.</span>

<span class="nv">$ </span>kubectl get node <span class="nt">-v</span><span class="o">=</span>6 <span class="nt">--context</span> kind-east
<span class="c"># &lt;span style="color: green;"&gt;👉 kind-east 클러스터의 노드 정보가 출력됩니다.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-v</span><span class="o">=</span>6
<span class="c"># &lt;span style="color: green;"&gt;👉 기본 컨텍스트가 kind-east이기 때문에 kind-east 클러스터의 노드 정보가 출력됩니다.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-v</span><span class="o">=</span>6 <span class="nt">--context</span> kind-west
<span class="c"># &lt;span style="color: green;"&gt;👉 명시적으로 kind-west 컨텍스르틀 지정하여 west 클러스터의 노드 정보가 출력됩니다.&lt;/span&gt;</span>
<span class="nv">$ </span><span class="nb">cat</span> ~/.kube/config

<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 kind-east 클러스터의 파드 정보가 출력됩니다.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">--context</span> kind-west
<span class="c"># &lt;span style="color: green;"&gt;👉 명시적으로 kind-west 컨텍스트를 지정하여 west 클러스터의 파드 정보가 출력됩니다.&lt;/span&gt;</span>

<span class="c"># 노드에 기본 툴 설치</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget net-tools dnsutils tcpdump ngrep iputils-ping git -y'</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker sh <span class="nt">-c</span> <span class="s1">'apt update &amp;&amp; apt install tree psmisc lsof wget net-tools dnsutils tcpdump ngrep iputils-ping git -y'</span>
</code></pre></div></div>

<ul>
  <li>alias 설정</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># alias 설정</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">kwest</span><span class="o">=</span><span class="s1">'kubectl --context kind-west'</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">keast</span><span class="o">=</span><span class="s1">'kubectl --context kind-east'</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kwest get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 STATUS     ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    west-control-plane   NotReady   control-plane   2m57s   v1.33.2   172.20.0.4    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.1.3</span>
<span class="c">#    west-worker          NotReady   &lt;none&gt;          2m45s   v1.33.2   172.20.0.2    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.1.3</span>
<span class="nv">$ </span>keast get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 STATUS     ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    east-control-plane   NotReady   control-plane   9m45s   v1.33.2   172.20.0.5    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.1.3</span>
<span class="c">#    east-worker          NotReady   &lt;none&gt;          9m32s   v1.33.2   172.20.0.3    &lt;none&gt;        Debian GNU/Linux 12 (bookworm)   5.10.76-linuxkit   containerd://2.1.3</span>
</code></pre></div></div>

<h3 id="cilium-cni-배포">Cilium CNI 배포</h3>

<ul>
  <li>Cilium CNI의 ClusterMesh 기능을 사용하기 위해 먼저 Cilium CNI를 배포합니다. <a href="https://docs.cilium.io/en/stable/network/clustermesh/clustermesh/">Docs</a>, <a href="https://nomadxd.github.io/blog/multi-cluster-networking-with-cilium-cluster-mesh">Blog</a>
</li>
  <li>이번에는 Cilium CLI를 사용하여 Cilium CNI를 배포해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium cli 설치</span>
<span class="nv">$ </span>brew <span class="nb">install </span>cilium-cli <span class="c"># macOS</span>

<span class="c">## https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/#install-the-cilium-cli # Windwos WSL2 , 아래 명령어로 설치</span>
<span class="c">#$ CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)</span>
<span class="c">#$ CLI_ARCH=amd64</span>
<span class="c">#$ if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi</span>
<span class="c">#$ curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}</span>
<span class="c">#$ sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum</span>
<span class="c">#$ sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin</span>
<span class="c">#$ rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}</span>

<span class="c"># cilium cli 로 cilium cni 설치해보기 : dry-run</span>
<span class="nv">$ </span>cilium <span class="nb">install</span> <span class="nt">--version</span> 1.17.6 <span class="nt">--set</span> ipam.mode<span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>10.0.0.0/16 <span class="se">\</span>
  <span class="nt">--set</span> ipMasqAgent.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> ipMasqAgent.config.nonMasqueradeCIDRs<span class="o">=</span><span class="s1">'{10.1.0.0/16}'</span> <span class="se">\</span>
  <span class="nt">--set</span> cluster.name<span class="o">=</span>west <span class="nt">--set</span> cluster.id<span class="o">=</span>1 <span class="se">\</span>
  <span class="nt">--context</span> kind-west <span class="nt">--dry-run-helm-values</span>
<span class="c"># =&gt; autoDirectNodeRoutes: true</span>
<span class="c">#    bpf:</span>
<span class="c">#      masquerade: true</span>
<span class="c">#    cluster:</span>
<span class="c">#      id: 1</span>
<span class="c">#      name: west</span>
<span class="c">#    debug:</span>
<span class="c">#      enabled: true</span>
<span class="c">#    endpointHealthChecking:</span>
<span class="c">#      enabled: false</span>
<span class="c">#    healthChecking: false</span>
<span class="c">#    ipMasqAgent:</span>
<span class="c">#      config:</span>
<span class="c">#        nonMasqueradeCIDRs:</span>
<span class="c">#        - 10.1.0.0/16</span>
<span class="c">#      enabled: true</span>
<span class="c">#    ipam:</span>
<span class="c">#      mode: kubernetes</span>
<span class="c">#    ipv4NativeRoutingCIDR: 10.0.0.0/16</span>
<span class="c">#    k8sServiceHost: 172.20.0.4</span>
<span class="c">#    k8sServicePort: 6443</span>
<span class="c">#    kubeProxyReplacement: true</span>
<span class="c">#    operator:</span>
<span class="c">#      replicas: 1</span>
<span class="c">#    routingMode: native  </span>

<span class="c"># cilium cli 로 cilium cni 설치</span>
<span class="nv">$ </span>cilium <span class="nb">install</span> <span class="nt">--version</span> 1.17.6 <span class="nt">--set</span> ipam.mode<span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>10.0.0.0/16 <span class="se">\</span>
  <span class="nt">--set</span> ipMasqAgent.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> ipMasqAgent.config.nonMasqueradeCIDRs<span class="o">=</span><span class="s1">'{10.1.0.0/16}'</span> <span class="se">\</span>
  <span class="nt">--set</span> cluster.name<span class="o">=</span>west <span class="nt">--set</span> cluster.id<span class="o">=</span>1 <span class="se">\</span>
  <span class="nt">--context</span> kind-west
<span class="c"># =&gt; 🔮 Auto-detected Kubernetes kind: kind</span>
<span class="c">#    ℹ️   Using Cilium version 1.17.6</span>
<span class="c">#    ℹ️   Using cluster name "west"</span>
<span class="c">#    ℹ️   Detecting real Kubernetes API server addr and port on Kind</span>
<span class="c">#    🔮 Auto-detected kube-proxy has not been installed</span>
<span class="c">#    ℹ️   Cilium will fully replace all functionalities of kube-proxy  </span>

<span class="nv">$ </span>watch kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">--context</span> kind-west


<span class="c"># dry-run</span>
<span class="nv">$ </span>cilium <span class="nb">install</span> <span class="nt">--version</span> 1.17.6 <span class="nt">--set</span> ipam.mode<span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>10.1.0.0/16 <span class="se">\</span>
  <span class="nt">--set</span> ipMasqAgent.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> ipMasqAgent.config.nonMasqueradeCIDRs<span class="o">=</span><span class="s1">'{10.0.0.0/16}'</span> <span class="se">\</span>
  <span class="nt">--set</span> cluster.name<span class="o">=</span>east <span class="nt">--set</span> cluster.id<span class="o">=</span>2 <span class="se">\</span>
  <span class="nt">--context</span> kind-east <span class="nt">--dry-run-helm-values</span>

<span class="nv">$ </span>cilium <span class="nb">install</span> <span class="nt">--version</span> 1.17.6 <span class="nt">--set</span> ipam.mode<span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>10.1.0.0/16 <span class="se">\</span>
  <span class="nt">--set</span> ipMasqAgent.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> ipMasqAgent.config.nonMasqueradeCIDRs<span class="o">=</span><span class="s1">'{10.0.0.0/16}'</span> <span class="se">\</span>
  <span class="nt">--set</span> cluster.name<span class="o">=</span>east <span class="nt">--set</span> cluster.id<span class="o">=</span>2 <span class="se">\</span>
  <span class="nt">--context</span> kind-east
<span class="c"># =&gt; 🔮 Auto-detected Kubernetes kind: kind</span>
<span class="c">#    ℹ️  Using Cilium version 1.17.6</span>
<span class="c">#    ℹ️  Using cluster name "east"</span>
<span class="c">#    ℹ️  Detecting real Kubernetes API server addr and port on Kind</span>
<span class="c">#    🔮 Auto-detected kube-proxy has not been installed</span>
<span class="c">#    ℹ️  Cilium will fully replace all functionalities of kube-proxy</span>

<span class="nv">$ </span>watch kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">--context</span> kind-east

<span class="c"># 확인</span>
<span class="nv">$ </span>kwest get pod <span class="nt">-A</span> <span class="o">&amp;&amp;</span> keast get pod <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-system          cilium-8tblx                                 1/1     Running   0          4m55s</span>
<span class="c">#    kube-system          cilium-envoy-f9wd9                           1/1     Running   0          4m55s</span>
<span class="c">#    kube-system          cilium-envoy-fvthm                           1/1     Running   0          4m55s</span>
<span class="c">#    kube-system          cilium-fsnxx                                 1/1     Running   0          4m55s</span>
<span class="c">#    kube-system          cilium-operator-7d99d97595-wdt52             1/1     Running   0          4m55s</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-85kzg                     1/1     Running   0          3h2m</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-cf7xm                     1/1     Running   0          3h2m</span>
<span class="c">#    kube-system          etcd-west-control-plane                      1/1     Running   0          3h2m</span>
<span class="c">#    kube-system          kube-apiserver-west-control-plane            1/1     Running   0          3h2m</span>
<span class="c">#    kube-system          kube-controller-manager-west-control-plane   1/1     Running   0          3h2m</span>
<span class="c">#    kube-system          kube-scheduler-west-control-plane            1/1     Running   0          3h2m</span>
<span class="c">#    local-path-storage   local-path-provisioner-7dc846544d-t968t      1/1     Running   0          3h2m</span>
<span class="c">#    NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    kube-system          cilium-envoy-25kb6                           1/1     Running   0          4m7s</span>
<span class="c">#    kube-system          cilium-envoy-xmxkx                           1/1     Running   0          4m7s</span>
<span class="c">#    kube-system          cilium-gvcf9                                 1/1     Running   0          4m7s</span>
<span class="c">#    kube-system          cilium-operator-6d9fc44d58-8xmkb             1/1     Running   0          4m7s</span>
<span class="c">#    kube-system          cilium-w547m                                 1/1     Running   0          4m7s</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-s6bdx                     1/1     Running   0          3h9m</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-sb52k                     1/1     Running   0          3h9m</span>
<span class="c">#    kube-system          etcd-east-control-plane                      1/1     Running   0          3h9m</span>
<span class="c">#    kube-system          kube-apiserver-east-control-plane            1/1     Running   0          3h9m</span>
<span class="c">#    kube-system          kube-controller-manager-east-control-plane   1/1     Running   0          3h9m</span>
<span class="c">#    kube-system          kube-scheduler-east-control-plane            1/1     Running   0          3h9m</span>
<span class="c">#    local-path-storage   local-path-provisioner-7dc846544d-m7trp      1/1     Running   0          3h9m</span>
<span class="nv">$ </span>cilium status <span class="nt">--context</span> kind-west
<span class="nv">$ </span>cilium status <span class="nt">--context</span> kind-east
<span class="nv">$ </span>cilium config view <span class="nt">--context</span> kind-west
<span class="nv">$ </span>cilium config view <span class="nt">--context</span> kind-east
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status <span class="nt">--verbose</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status <span class="nt">--verbose</span>

<span class="nv">$ </span>kwest <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg bpf ipmasq list
<span class="c"># =&gt; IP PREFIX/ADDRESS</span>
<span class="c">#    169.254.0.0/16</span>
<span class="c">#    10.1.0.0/16</span>
<span class="nv">$ </span>keast <span class="nt">-n</span> kube-system <span class="nb">exec </span>ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium-dbg bpf ipmasq list
<span class="c"># =&gt; IP PREFIX/ADDRESS</span>
<span class="c">#    169.254.0.0/16</span>
<span class="c">#    10.0.0.0/16</span>

<span class="c"># coredns 확인 : 둘 다, cluster.local 기본 도메인 네임 사용 중</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system coredns <span class="nt">--context</span> kind-west | <span class="nb">grep </span>kubernetes
<span class="c"># =&gt;     kubernetes cluster.local in-addr.arpa ip6.arpa {</span>

<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system coredns <span class="nt">--context</span> kind-west | <span class="nb">grep </span>kubernetes
<span class="c"># =&gt;     kubernetes cluster.local in-addr.arpa ip6.arpa {</span>

<span class="c"># k9s 사용 시</span>
<span class="nv">$ </span>k9s <span class="nt">--context</span> kind-west
<span class="nv">$ </span>k9s <span class="nt">--context</span> kind-east

<span class="c"># 삭제 시</span>
<span class="c"># cilium uninstall --context kind-west</span>
<span class="c"># cilium uninstall --context kind-east</span>
</code></pre></div></div>

<h3 id="clustermesh-배포">ClusterMesh 배포</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/clustermesh/clustermesh/">관련문서</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 라우팅 정보 확인</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-control-plane ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.0.0.0/24 via 10.0.0.175 dev cilium_host proto kernel src 10.0.0.175</span>
<span class="c">#    10.0.0.175 dev cilium_host proto kernel scope link</span>
<span class="c">#    10.0.1.0/24 via 172.20.0.2 dev eth0 proto kernel</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.4</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-worker ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.0.0.0/24 via 172.20.0.4 dev eth0 proto kernel</span>
<span class="c">#    10.0.1.0/24 via 10.0.1.10 dev cilium_host proto kernel src 10.0.1.10</span>
<span class="c">#    10.0.1.10 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.2</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.1.0.0/24 via 10.1.0.80 dev cilium_host proto kernel src 10.1.0.80</span>
<span class="c">#    10.1.0.80 dev cilium_host proto kernel scope link</span>
<span class="c">#    10.1.1.0/24 via 172.20.0.3 dev eth0 proto kernel</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.5</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.1.0.0/24 via 172.20.0.5 dev eth0 proto kernel</span>
<span class="c">#    10.1.1.0/24 via 10.1.1.94 dev cilium_host proto kernel src 10.1.1.94</span>
<span class="c">#    10.1.1.94 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.3</span>

<span class="c"># Specify the Cluster Name and ID : 이미 설정 되어 있음</span>

<span class="c"># Certificate Authority를 공유하기 위해서 east 클러스터의 cilium-ca 시크릿을 삭제합니다.</span>
<span class="nv">$ </span>keast get secret <span class="nt">-n</span> kube-system cilium-ca
<span class="nv">$ </span>keast delete secret <span class="nt">-n</span> kube-system cilium-ca

<span class="c"># west 클러스터의 cilium-ca 시크릿을 east 클러스터로 복사합니다.</span>
<span class="nv">$ </span>kubectl <span class="nt">--context</span> kind-west get secret <span class="nt">-n</span> kube-system cilium-ca <span class="nt">-o</span> yaml | <span class="se">\</span>
  kubectl <span class="nt">--context</span> kind-east create <span class="nt">-f</span> -
  <span class="c"># =&gt; secret/cilium-ca created</span>

<span class="nv">$ </span>keast get secret <span class="nt">-n</span> kube-system cilium-ca
<span class="c"># =&gt; NAME        TYPE     DATA   AGE</span>
<span class="c">#    cilium-ca   Opaque   2      12s</span>

<span class="c"># 모니터링 : 신규 터미널 2개</span>
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-west <span class="nt">--wait</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    ⚠️  Service type NodePort detected! Service may fail when nodes are removed from the cluster!</span>
<span class="c">#    ✅ Service "clustermesh-apiserver" of type "NodePort" found</span>
<span class="c">#    ✅ Cluster access information is available:</span>
<span class="c">#      - 172.20.0.4:32379</span>
<span class="c">#    ✅ Deployment clustermesh-apiserver is ready</span>
<span class="c">#    ℹ️  KVStoreMesh is disabled</span>
<span class="c">#    </span>
<span class="c">#    </span>
<span class="c">#    🔌 No cluster connected</span>
<span class="c">#    </span>
<span class="c">#    🔀 Global services: [ min:0 / avg:0.0 / max:0 ]  </span>
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-east <span class="nt">--wait</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    ⚠️  Service type NodePort detected! Service may fail when nodes are removed from the cluster!</span>
<span class="c">#    ✅ Service "clustermesh-apiserver" of type "NodePort" found</span>
<span class="c">#    ✅ Cluster access information is available:</span>
<span class="c">#      - 172.20.0.5:32379</span>
<span class="c">#    ✅ Deployment clustermesh-apiserver is ready</span>
<span class="c">#    ℹ️  KVStoreMesh is disabled</span>
<span class="c">#    </span>
<span class="c">#    </span>
<span class="c">#    🔌 No cluster connected</span>
<span class="c">#    </span>
<span class="c">#    🔀 Global services: [ min:0 / avg:0.0 / max:0 ]</span>


<span class="c"># Enable Cluster Mesh : 간단한 실습 환경으로 NodePort 로 진행</span>
<span class="nv">$ </span>cilium clustermesh <span class="nb">enable</span> <span class="nt">--service-type</span> NodePort <span class="nt">--enable-kvstoremesh</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--context</span> kind-west
<span class="c"># =&gt; ⚠️  Using service type NodePort may fail when nodes are removed from the cluster!</span>
<span class="nv">$ </span>cilium clustermesh <span class="nb">enable</span> <span class="nt">--service-type</span> NodePort <span class="nt">--enable-kvstoremesh</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--context</span> kind-east
<span class="c"># =&gt; ⚠️  Using service type NodePort may fail when nodes are removed from the cluster! </span>

<span class="c"># 32379 NodePort 정보 : clustermesh-apiserver 서비스 정보</span>
<span class="nv">$ </span>kwest get svc,ep <span class="nt">-n</span> kube-system clustermesh-apiserver <span class="nt">--context</span> kind-west
<span class="c"># =&gt; NAME                            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/clustermesh-apiserver   NodePort   10.2.173.178   &lt;none&gt;        2379:32379/TCP   2m55s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              ENDPOINTS         AGE</span>
<span class="c">#    endpoints/clustermesh-apiserver   10.0.1.223:2379   2m55s       # 대상 파드는 clustermesh-apiserver 파드 IP</span>

<span class="nv">$ </span>kwest get pod <span class="nt">-n</span> kube-system <span class="nt">-owide</span> | <span class="nb">grep </span>clustermesh
<span class="c"># =&gt; clustermesh-apiserver-5cf45db9cc-r26tw       2/2     Running     0          3m21s   10.0.1.223   west-worker          &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    clustermesh-apiserver-generate-certs-788q6   0/1     Completed   0          3m21s   172.20.0.2   west-worker          &lt;none&gt;           &lt;none&gt;</span>

<span class="nv">$ </span>keast get svc,ep <span class="nt">-n</span> kube-system clustermesh-apiserver <span class="nt">--context</span> kind-east
<span class="c"># =&gt; NAME                            TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/clustermesh-apiserver   NodePort   10.3.201.32   &lt;none&gt;        2379:32379/TCP   2m40s</span>
<span class="c">#    </span>
<span class="c">#    NAME                              ENDPOINTS         AGE</span>
<span class="c">#    endpoints/clustermesh-apiserver   10.1.1.225:2379   2m40s       # 대상 파드는 clustermesh-apiserver 파드 IP</span>

<span class="nv">$ </span>keast get pod <span class="nt">-n</span> kube-system <span class="nt">-owide</span> | <span class="nb">grep </span>clustermesh
<span class="c"># =&gt; clustermesh-apiserver-5cf45db9cc-r4wgj       2/2     Running     0          2m56s   10.1.1.225   east-worker          &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    clustermesh-apiserver-generate-certs-89vnn   0/1     Completed   0          2m56s   172.20.0.3   east-worker          &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># 모니터링 : 신규 터미널 2개</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"cilium clustermesh status --context kind-west --wait"</span>
<span class="nv">$ </span>watch <span class="nt">-d</span> <span class="s2">"cilium clustermesh status --context kind-east --wait"</span>

<span class="c"># Connect Clusters</span>
<span class="nv">$ </span>cilium clustermesh connect <span class="nt">--context</span> kind-west <span class="nt">--destination-context</span> kind-east
<span class="c"># =&gt; ✨ Extracting access information of cluster west...</span>
<span class="c">#    🔑 Extracting secrets from cluster west...</span>
<span class="c">#    ⚠️  Service type NodePort detected! Service may fail when nodes are removed from the cluster!</span>
<span class="c">#    ℹ️  Found ClusterMesh service IPs: [172.20.0.4]</span>
<span class="c">#    ✨ Extracting access information of cluster east...</span>
<span class="c">#    🔑 Extracting secrets from cluster east...</span>
<span class="c">#    ⚠️  Service type NodePort detected! Service may fail when nodes are removed from the cluster!</span>
<span class="c">#    ℹ️  Found ClusterMesh service IPs: [172.20.0.5]</span>
<span class="c">#    ℹ️ Configuring Cilium in cluster kind-west to connect to cluster kind-east</span>
<span class="c">#    ℹ️ Configuring Cilium in cluster kind-east to connect to cluster kind-west</span>
<span class="c">#    ✅ Connected cluster kind-west &lt;=&gt; kind-east!</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-west <span class="nt">--wait</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    ✅ All 2 nodes are connected to all clusters [min:1 / avg:1.0 / max:1]</span>
<span class="c">#    </span>
<span class="c">#    🔌 Cluster Connections:</span>
<span class="c">#      - east: 2/2 configured, 2/2 connected</span>
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-east <span class="nt">--wait</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    ✅ All 2 nodes are connected to all clusters [min:1 / avg:1.0 / max:1]</span>
<span class="c">#    </span>
<span class="c">#    🔌 Cluster Connections:</span>
<span class="c">#      - west: 2/2 configured, 2/2 connected</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 ClusterMesh 연결이 잘 되었습니다.&lt;/span&gt;</span>

<span class="c"># </span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--context</span> kind-west <span class="nt">--</span> cilium-dbg troubleshoot clustermesh
<span class="c"># =&gt; ...</span>
<span class="c">#    Cluster "east":</span>
<span class="c">#    📄 Configuration path: /var/lib/cilium/clustermesh/east</span>
<span class="c">#    </span>
<span class="c">#    🔌 Endpoints:</span>
<span class="c">#       - https://east.mesh.cilium.io:32379</span>
<span class="c">#         ✅ Hostname resolved to: 172.20.0.5</span>
<span class="c">#         ✅ TCP connection successfully established to 172.20.0.5:32379</span>
<span class="c">#         ✅ TLS connection successfully established to 172.20.0.5:32379</span>
<span class="c">#    ...</span>
<span class="c">#    🔑 Digital certificates:</span>
<span class="c">#       ✅ TLS Root CA certificates:</span>
<span class="c">#          - Serial number:       &lt;span style="color: green;"&gt;84:08:1a:87:5e:23:5b:d9:0b:ca:62:3a:46:9b:13:9&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c">#       ✅ TLS client certificates:</span>
<span class="c">#          - Serial number:       65:79:dd:0b:b6:6d:92:6a:59:ce:40:d2:7b:dc:0c:67:ef:c9:96:06</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--context</span> kind-east <span class="nt">--</span> cilium-dbg troubleshoot clustermesh
<span class="c"># =&gt; ...</span>
<span class="c">#    Cluster "west":</span>
<span class="c">#    📄 Configuration path: /var/lib/cilium/clustermesh/west</span>
<span class="c">#    </span>
<span class="c">#    🔌 Endpoints:</span>
<span class="c">#       - https://west.mesh.cilium.io:32379</span>
<span class="c">#         ✅ Hostname resolved to: 172.20.0.4</span>
<span class="c">#         ✅ TCP connection successfully established to 172.20.0.4:32379</span>
<span class="c">#         ✅ TLS connection successfully established to 172.20.0.4:32379</span>
<span class="c">#    ...</span>
<span class="c">#    🔑 Digital certificates:</span>
<span class="c">#       ✅ TLS Root CA certificates:</span>
<span class="c">#          - Serial number:       &lt;span style="color: green;"&gt;84:08:1a:87:5e:23:5b:d9:0b:ca:62:3a:46:9b:13:9&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c">#       ✅ TLS client certificates:</span>
<span class="c">#          - Serial number:       29:14:65:5d:5d:ff:bf:80:24:ba:16:88:a4:55:d3:e0:ba:a3:9d:14</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 서로 다른 클러스터에 대해서 구성을 갖고 있고, 앞서 Cilium CA를 복사했기 때문에, 같은 Root CA를 사용하고 있습니다.&lt;/span&gt;</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kwest get pod <span class="nt">-A</span> <span class="o">&amp;&amp;</span> keast get pod <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                         READY   STATUS      RESTARTS   AGE</span>
<span class="c">#    ...</span>
<span class="c">#    kube-system          clustermesh-apiserver-5cf45db9cc-r26tw       2/2     Running     0          12m</span>
<span class="c">#    kube-system          clustermesh-apiserver-generate-certs-2xlxh   0/1     Completed   0          8m4s</span>
<span class="c">#    ...</span>
<span class="c">#    NAMESPACE            NAME                                         READY   STATUS      RESTARTS   AGE</span>
<span class="c">#    ...</span>
<span class="c">#    kube-system          clustermesh-apiserver-5cf45db9cc-r4wgj       2/2     Running     0          11m</span>
<span class="c">#    kube-system          clustermesh-apiserver-generate-certs-fr5cz   0/1     Completed   0          7m58s</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>cilium status <span class="nt">--context</span> kind-west
<span class="nv">$ </span>cilium status <span class="nt">--context</span> kind-east
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-west
<span class="nv">$ </span>cilium clustermesh status <span class="nt">--context</span> kind-east
<span class="nv">$ </span>cilium config view <span class="nt">--context</span> kind-west
<span class="nv">$ </span>cilium config view <span class="nt">--context</span> kind-east
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status <span class="nt">--verbose</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status <span class="nt">--verbose</span>
<span class="c"># =&gt; ClusterMesh:   1/1 remote clusters ready, 0 global-services</span>
<span class="c">#       west: ready, 2 nodes, 4 endpoints, 3 identities, 0 services, 0 MCS-API service exports, 0 reconnections (last: never)</span>
<span class="c">#       └  etcd: 1/1 connected, leases=0, lock leases=0, has-quorum=true: endpoint status checks are disabled, ID: ea025158a8e3c0a3</span>
<span class="c">#       └  remote configuration: expected=true, retrieved=true, cluster-id=1, kvstoremesh=false, sync-canaries=true, service-exports=disabled</span>
<span class="c">#       └  synchronization status: nodes=true, endpoints=true, identities=true, services=true</span>

<span class="c">#</span>
<span class="nv">$ </span>helm get values <span class="nt">-n</span> kube-system cilium <span class="nt">--kube-context</span> kind-west 
<span class="c"># =&gt; ...</span>
<span class="c">#    cluster:</span>
<span class="c">#      id: 1</span>
<span class="c">#      name: west</span>
<span class="c">#    clustermesh:</span>
<span class="c">#      apiserver:</span>
<span class="c">#        kvstoremesh:</span>
<span class="c">#          enabled: false</span>
<span class="c">#        service:</span>
<span class="c">#          type: NodePort</span>
<span class="c">#        tls:</span>
<span class="c">#          auto:</span>
<span class="c">#            enabled: true</span>
<span class="c">#            method: cronJob</span>
<span class="c">#            schedule: 0 0 1 */4 *</span>
<span class="c">#      config:</span>
<span class="c">#        clusters:</span>
<span class="c">#        - ips:</span>
<span class="c">#          - 172.20.0.5</span>
<span class="c">#          name: east</span>
<span class="c">#          port: 32379</span>
<span class="c">#        enabled: true</span>
<span class="c">#      useAPIServer: true</span>

<span class="nv">$ </span>helm get values <span class="nt">-n</span> kube-system cilium <span class="nt">--kube-context</span> kind-east 
<span class="c"># =&gt; ...</span>
<span class="c">#    cluster:</span>
<span class="c">#      id: 2</span>
<span class="c">#      name: east</span>
<span class="c">#    clustermesh:</span>
<span class="c">#      apiserver:</span>
<span class="c">#        kvstoremesh:</span>
<span class="c">#          enabled: false</span>
<span class="c">#        service:</span>
<span class="c">#          type: NodePort</span>
<span class="c">#        tls:</span>
<span class="c">#          auto:</span>
<span class="c">#            enabled: true</span>
<span class="c">#            method: cronJob</span>
<span class="c">#            schedule: 0 0 1 */4 *</span>
<span class="c">#      config:</span>
<span class="c">#        clusters:</span>
<span class="c">#        - ips:</span>
<span class="c">#          - 172.20.0.4</span>
<span class="c">#          name: west</span>
<span class="c">#          port: 32379</span>
<span class="c">#        enabled: true</span>
<span class="c">#      useAPIServer: true</span>

<span class="c"># 라우팅 정보 확인 : 클러스터간 PodCIDR 라우팅 주입 확인!</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-control-plane ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.0.0.0/24 via 10.0.0.175 dev cilium_host proto kernel src 10.0.0.175</span>
<span class="c">#    10.0.0.175 dev cilium_host proto kernel scope link</span>
<span class="c">#    10.0.1.0/24 via 172.20.0.2 dev eth0 proto kernel</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.1.0.0/24 via 172.20.0.5 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.1.1.0/24 via 172.20.0.3 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.4</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-worker ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    10.0.0.0/24 via 172.20.0.4 dev eth0 proto kernel</span>
<span class="c">#    10.0.1.0/24 via 10.0.1.10 dev cilium_host proto kernel src 10.0.1.10</span>
<span class="c">#    10.0.1.10 dev cilium_host proto kernel scope link</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.1.0.0/24 via 172.20.0.5 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.1.1.0/24 via 172.20.0.3 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.2</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.0.0.0/24 via 172.20.0.4 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.0.1.0/24 via 172.20.0.2 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    10.1.0.0/24 via 10.1.0.80 dev cilium_host proto kernel src 10.1.0.80</span>
<span class="c">#    10.1.0.80 dev cilium_host proto kernel scope link</span>
<span class="c">#    10.1.1.0/24 via 172.20.0.3 dev eth0 proto kernel</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.5</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker ip <span class="nt">-c</span> route
<span class="c"># =&gt; default via 172.20.0.1 dev eth0</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.0.0.0/24 via 172.20.0.4 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    &lt;span style="color: green;"&gt;10.0.1.0/24 via 172.20.0.2 dev eth0 proto kernel&lt;/span&gt;</span>
<span class="c">#    10.1.0.0/24 via 172.20.0.5 dev eth0 proto kernel</span>
<span class="c">#    10.1.1.0/24 via 10.1.1.94 dev cilium_host proto kernel src 10.1.1.94</span>
<span class="c">#    10.1.1.94 dev cilium_host proto kernel scope link</span>
<span class="c">#    172.20.0.0/16 dev eth0 proto kernel scope link src 172.20.0.3</span>
</code></pre></div></div>

<ul>
  <li>Hubble enable</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium helm repo 등록</span>
<span class="nv">$ </span>helm repo add cilium https://helm.cilium.io/
<span class="nv">$ </span>helm repo update

<span class="c"># 설정</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.17.6 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>30001 <span class="nt">--kube-context</span> kind-west
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    NAME: cilium</span>
<span class="c">#    LAST DEPLOYED: Sat Aug 16 21:31:07 2025</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 4</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    You have successfully installed Cilium with Hubble Relay and Hubble UI.</span>
<span class="c">#    </span>
<span class="c">#    Your release version is 1.17.6.  </span>
<span class="nv">$ </span>kwest <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c">## 혹은 cilium hubble enable --ui --relay --context kind-west</span>
<span class="c">## kubectl --context kind-west patch svc -n kube-system hubble-ui -p '{"spec": {"type": "NodePort", "ports": [{"port": 80, "targetPort": 8081, "nodePort": 30001}]}}'</span>

<span class="c"># 설정</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.17.6 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>31001 <span class="nt">--kube-context</span> kind-east
<span class="nv">$ </span>kwest <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c">## 혹은 cilium hubble enable --ui --relay --context kind-east</span>
<span class="c">## kubectl --context kind-east patch svc -n kube-system hubble-ui -p '{"spec": {"type": "NodePort", "ports": [{"port": 80, "targetPort": 8081, "nodePort": 31001}]}}'</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kwest get svc,ep <span class="nt">-n</span> kube-system hubble-ui <span class="nt">--context</span> kind-west
<span class="c"># =&gt; NAME                TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/hubble-ui   NodePort   10.2.253.104   &lt;none&gt;        80:30001/TCP   51s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS         AGE</span>
<span class="c">#    endpoints/hubble-ui   10.0.1.192:8081   51s</span>
<span class="nv">$ </span>keast get svc,ep <span class="nt">-n</span> kube-system hubble-ui <span class="nt">--context</span> kind-east
<span class="c"># =&gt; NAME                TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span>
<span class="c">#    service/hubble-ui   NodePort   10.3.93.132   &lt;none&gt;        80:31001/TCP   26s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  ENDPOINTS   AGE</span>
<span class="c">#    endpoints/hubble-ui   &lt;none&gt;      25s</span>

<span class="c"># hubble-ui 접속 시</span>
<span class="nv">$ </span>open http://localhost:30001
<span class="nv">$ </span>open http://localhost:31001
</code></pre></div></div>

<h3 id="west-파드---east-파드-간-직접-통신-확인-with-static-routing">west 파드 &lt;-&gt; east 파드 간 직접 통신 확인 with static routing</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply --context kind-west -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply --context kind-east -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kwest get pod <span class="nt">-A</span> <span class="o">&amp;&amp;</span> keast get pod <span class="nt">-A</span>
<span class="nv">$ </span>kwest get pod <span class="nt">-owide</span> <span class="o">&amp;&amp;</span> keast get pod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME       READY   STATUS    RESTARTS   AGE   IP           NODE          NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod   1/1     Running   0          20m   10.0.1.101   west-worker   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    NAME       READY   STATUS    RESTARTS   AGE   IP           NODE          NOMINATED NODE   READINESS GATES</span>
<span class="c">#    curl-pod   1/1     Running   0          20m   10.1.1.146   east-worker   &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># west 파드에서 east 파드로 직접 라우팅 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> ping <span class="nt">-c</span> 1 10.1.1.146
<span class="c"># =&gt; 64 bytes from 10.1.1.146: icmp_seq=1 ttl=62 time=1.80 ms</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> ping 10.1.1.146

<span class="c"># 목적지 파드에서 tcpdump 로 확인 : NAT 없이 직접 라우팅.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> tcpdump <span class="nt">-i</span> eth0 <span class="nt">-nn</span>
<span class="c"># =&gt; 14:30:09.035714 IP 10.1.1.146 &gt; 10.0.1.101: ICMP echo request, id 15, seq 1, length 64</span>
<span class="c">#    14:30:09.036120 IP 10.0.1.101 &gt; 10.1.1.146: ICMP echo reply, id 15, seq 1, length 64</span>

<span class="c"># 목적지 k8s 노드?에서 icmp tcpdump 로 확인 : 다른곳 경유하지 않고 직접 노드에서 파드로 인입 확인</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>
<span class="c"># =&gt; (캡쳐된 패킷 없음)</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker tcpdump <span class="nt">-i</span> any icmp <span class="nt">-nn</span>
<span class="c"># =&gt; 14:30:09.035725 lxce19e07e06482 In  IP 10.1.1.146 &gt; 10.0.1.101: ICMP echo request, id 15, seq 1, length 64</span>
<span class="c">#    14:30:09.035904 eth0  Out IP 10.1.1.146 &gt; 10.0.1.101: ICMP echo request, id 15, seq 1, length 64</span>
<span class="c">#    14:30:09.036120 eth0  In  IP 10.0.1.101 &gt; 10.1.1.146: ICMP echo reply, id 15, seq 1, length 64</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 east-control-plane에는 패킷 캡쳐가 없고, tcp dump 상에도 east &lt;-&gt; west 파드 IP간의 직접 통신으로&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   캡쳐되는것으로 보아 다른곳을 경유하지 않고 직접 파드로 인입되는것을 확인할 수 있습니다.&lt;/span&gt;</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> ping <span class="nt">-c</span> 1 10.0.1.101
<span class="c"># =&gt; 64 bytes from 10.0.1.101: icmp_seq=1 ttl=62 time=0.291 ms</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_6.png" alt="img.png" class="image-center" loading="lazy" width="1063" height="451"></p>

<h3 id="load-balancing--service-discovery">Load-Balancing &amp; Service Discovery</h3>

<ul>
  <li>ClusterMesh를 통한 Load-Balacing 및 Service Discovery를 실습을 통해 확인해 보겠습니다.</li>
  <li><a href="https://docs.cilium.io/en/stable/network/clustermesh/services/">관련문서</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply --context kind-west -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
  annotations:
    service.cilium.io/global: "true"
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply --context kind-east -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
  annotations:
    service.cilium.io/global: "true"
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kwest get svc,ep webpod <span class="o">&amp;&amp;</span> keast get svc,ep webpod
<span class="c"># =&gt; NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/webpod   ClusterIP   10.2.184.162   &lt;none&gt;        80/TCP    43s</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                   AGE</span>
<span class="c">#    endpoints/webpod   10.0.1.70:80,10.0.1.77:80   43s</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/webpod   ClusterIP   10.3.136.103   &lt;none&gt;        80/TCP    8s</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS       AGE</span>
<span class="c">#    endpoints/webpod   10.1.1.217:80   8s</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.70:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.0.1.77:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                4 =&gt; 10.1.1.207:80/TCP (active) </span>
                                            
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.0.1.77:80/TCP (active)</span>
<span class="c">#                                               2 =&gt; 10.0.1.70:80/TCP (active)</span>
<span class="c">#                                               3 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                               4 =&gt; 10.1.1.207:80/TCP (active)</span>
 
<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> ping <span class="nt">-c</span> 1 10.1.1.146
<span class="c"># =&gt; 64 bytes from 10.1.1.146: icmp_seq=1 ttl=62 time=1.35 ms</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> ping <span class="nt">-c</span> 1 10.0.1.101
<span class="c"># =&gt; 64 bytes from 10.0.1.101: icmp_seq=1 ttl=62 time=0.889 ms</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="c"># =&gt; ---</span>
<span class="c">#    Hostname: webpod-697b545f57-twg87</span>
<span class="c">#    IP: 10.0.1.77</span>
<span class="c">#    RemoteAddr: 10.0.1.101:36858</span>
<span class="c">#    ...</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-9ndvj</span>
<span class="c">#    IP: 10.0.1.70</span>
<span class="c">#    RemoteAddr: 10.0.1.101:58324</span>
<span class="c">#    ...</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-9ndvj</span>
<span class="c">#    IP: 10.0.1.70</span>
<span class="c">#    RemoteAddr: 10.0.1.101:58354</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-k6wdn</span>
<span class="c">#    IP: 10.1.1.217</span>
<span class="c">#    RemoteAddr: 10.0.1.101:56788</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-k6wdn</span>
<span class="c">#    IP: 10.1.1.217</span>
<span class="c">#    RemoteAddr: 10.1.1.146:41276</span>
<span class="c">#    ...</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-9ndvj</span>
<span class="c">#    IP: 10.0.1.70</span>
<span class="c">#    RemoteAddr: 10.1.1.146:56488</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-924nf</span>
<span class="c">#    IP: 10.1.1.207</span>
<span class="c">#    RemoteAddr: 10.1.1.146:34020</span>
<span class="c">#    ...</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-twg87</span>
<span class="c">#    IP: 10.0.1.77</span>
<span class="c">#    RemoteAddr: 10.1.1.146:44744</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 curl-pod의 클러스터와 관계 없이 west와 east의 webpod가 골고루 사용되고 있습니다.&lt;/span&gt;</span>

<span class="c"># 현재 Service Annotations 설정</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A1</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>

<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A1</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>

<span class="c"># 모니터링 : 반복 접속해두기</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>

<span class="c">#</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 1
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.77:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.0.1.77:80/TCP (active)</span>
<span class="c">#                                               2 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                               3 =&gt; 10.1.1.207:80/TCP (active)</span>

<span class="c"># 로컬 k8s 에 목적지가 없을 경우 어떻게 되나요?</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 0
<span class="c"># =&gt; deployment.apps/webpod scaled</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 west에 webpod가 없으므로, east의 webpod로만 접속이 됩니다.&lt;/span&gt;</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>

<span class="c">#</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 2
<span class="c"># =&gt; deployment.apps/webpod scaled</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; &lt;span style="color: green;"&gt;10.0.1.210:80/TCP&lt;/span&gt; (active)</span>
<span class="c">#                                                4 =&gt; &lt;span style="color: green;"&gt;10.0.1.140:80/TCP&lt;/span&gt; (active)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 west의 webpod가 복구되면 Service Discovery가 되면서, west의 webpod로도 접속이 됩니다.&lt;/span&gt;</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>

<span class="c"># tcpdump 확인 : dataplane flow 확인</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-control-plane tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span> 
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-worker tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span> 
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_8.png" alt="img.png" class="image-center" loading="lazy" width="759" height="425"></p>

<ul>
  <li>west와 east의 각 클러스터에 webpod가 있음에도 클러스터 자신의 webpod 뿐만 아니라 상대방의 webpod로도 접속이 되는것을 확인할 수 있습니다.</li>
  <li>이는 시스템 안정성 면에서는 좋을지 몰라도, 오버헤드를 발생시킬 수 있습니다. 다음의 Service Affinity 설정을 통해 이를 해결할 수 있습니다.</li>
</ul>

<h3 id="service-affinity">Service Affinity</h3>

<ul>
  <li>
<a href="https://docs.cilium.io/en/stable/network/clustermesh/affinity/">관련 문서</a>
<img src="/assets/2025/cilium/w5/20250817_cilium_w5_9.svg" alt="20250817_cilium_w5_9.svg" class="image-center w-100p" loading="lazy" width="100" height="100">
</li>
</ul>

<h5 id="serviceciliumioaffinitylocal">service.cilium.io/affinity=local</h5>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">service.cilium.io/affinity=local</code> 설정을 통해, 각 클러스터의 파드가 자기자신의 클러스터의 파드를 우선하여 접속하도록 설정할 수 있습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 모니터링 : 반복 접속해두기</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>

<span class="c"># 현재 Service Annotations 설정</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A1</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A1</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>

<span class="c"># Session Affinity Local 설정</span>
<span class="nv">$ </span>kwest annotate service webpod service.cilium.io/affinity<span class="o">=</span><span class="nb">local</span> <span class="nt">--overwrite</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: local</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>

<span class="nv">$ </span>keast annotate service webpod service.cilium.io/affinity<span class="o">=</span><span class="nb">local</span> <span class="nt">--overwrite</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: local</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; 13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; 10.0.1.210:80/TCP (active) &lt;span style="color: green;"&gt;(preferred)&lt;/span&gt;</span>
<span class="c">#                                                4 =&gt; 10.0.1.140:80/TCP (active) &lt;span style="color: green;"&gt;(preferred)&lt;/span&gt;</span>

<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; 13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active) &lt;span style="color: green;"&gt;(preferred)&lt;/span&gt;</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active) &lt;span style="color: green;"&gt;(preferred)&lt;/span&gt;</span>
<span class="c">#                                               3 =&gt; 10.0.1.210:80/TCP (active)</span>
<span class="c">#                                               4 =&gt; 10.0.1.140:80/TCP (active) </span>

<span class="c"># 호출 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-mm9g7</span>
<span class="c">#    IP: 10.0.1.210</span>
<span class="c">#    RemoteAddr: 10.0.1.101:52556</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-rspmq</span>
<span class="c">#    IP: 10.0.1.140</span>
<span class="c">#    RemoteAddr: 10.0.1.101:59782</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-rspmq</span>
<span class="c">#    IP: 10.0.1.140</span>
<span class="c">#    RemoteAddr: 10.0.1.101:59782</span>
<span class="c">#    ...    </span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-924nf</span>
<span class="c">#    IP: 10.1.1.207</span>
<span class="c">#    RemoteAddr: 10.1.1.146:42244</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-k6wdn</span>
<span class="c">#    IP: 10.1.1.217</span>
<span class="c">#    RemoteAddr: 10.1.1.146:49716</span>
<span class="c">#    ...    </span>
<span class="c">#    ---    </span>
<span class="c">#    Hostname: webpod-697b545f57-924nf</span>
<span class="c">#    IP: 10.1.1.207</span>
<span class="c">#    RemoteAddr: 10.1.1.146:42244</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-k6wdn</span>
<span class="c">#    IP: 10.1.1.217</span>
<span class="c">#    RemoteAddr: 10.1.1.146:49716</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 Service Affinity 설정 후 각 클러스터는 자기자신의 클러스터의 webpod를 통해 통신이 진행됩니다.&lt;/span&gt;    </span>

<span class="c"># 현재 상태에서 replicas 변경 후 확인 : preferred 동작 이해하기!</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 0
<span class="c"># =&gt; deployment.apps/webpod scaled</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; 13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="c"># =&gt; ---</span>
<span class="c">#    Hostname: webpod-697b545f57-k6wdn</span>
<span class="c">#    IP: 10.1.1.217</span>
<span class="c">#    RemoteAddr: 10.0.1.101:47912</span>
<span class="c">#    ...    </span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-924nf</span>
<span class="c">#    IP: 10.1.1.207</span>
<span class="c">#    RemoteAddr: 10.0.1.101:58092</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 west 클러스터에는 webpod가 없지만, east 클러스터의 webpod로 접속이 진행됩니다.&lt;/span&gt;</span>
<span class="c"># &lt;span style="color: green;"&gt;   이는 preferred 설정으로, west 클러스터의 webpod를 선호하지만 없을 경우 east 클러스터의 webpod로 접속이 진행됩니다.&lt;/span&gt;</span>

<span class="c"># 다시 기본 설정값 적용</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 2

<span class="c"># tcpdump 확인</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-control-plane tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span> 
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> west-worker tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-control-plane tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span> 
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> east-worker tcpdump <span class="nt">-i</span> any tcp port 80 <span class="nt">-nnq</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w5/20250817_cilium_w5_10.png" alt="img.png" class="image-center" loading="lazy" width="778" height="422">
<em class="image-caption">각 클러스터의 webpod로 접속이 진행되는것을 확인할 수 있습니다.</em></p>

<h5 id="serviceciliumioaffinityremote">service.cilium.io/affinity=remote</h5>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">service.cilium.io/affinity=remote</code>로 설정시 자기 자신의 클러스터가 아닌 다른 원격(remote) 클러스터의 파드를 우선 사용하게 됩니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 현재 설정 상태 확인</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.94:80/TCP (active) (preferred)</span>
<span class="c">#                                                2 =&gt; 10.0.1.172:80/TCP (active) (preferred)</span>
<span class="c">#                                                3 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                                4 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active) (preferred)</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active) (preferred)</span>
<span class="c">#                                               3 =&gt; 10.0.1.172:80/TCP (active)</span>
<span class="c">#                                               4 =&gt; 10.0.1.94:80/TCP (active)</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: local</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: local</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>

<span class="c"># remote</span>
<span class="nv">$ </span>kwest annotate service webpod service.cilium.io/affinity<span class="o">=</span>remote <span class="nt">--overwrite</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>keast annotate service webpod service.cilium.io/affinity<span class="o">=</span>remote <span class="nt">--overwrite</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: remote</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: remote</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#    Selector:                 app=webpod</span>
<span class="c">#    Type:                     ClusterIP</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.94:80/TCP (active)</span>
<span class="c">#                                                2 =&gt; 10.0.1.172:80/TCP (active)</span>
<span class="c">#                                                3 =&gt; 10.1.1.207:80/TCP (active) (preferred)</span>
<span class="c">#                                                4 =&gt; 10.1.1.217:80/TCP (active) (preferred)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                               3 =&gt; 10.0.1.172:80/TCP (active) (preferred)</span>
<span class="c">#                                               4 =&gt; 10.0.1.94:80/TCP (active) (preferred)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 affinity를 remote로 하면 다른 클러스터의 pod를 우선 사용합니다.&lt;/span&gt;</span>

<span class="c"># 호출 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>

<span class="c">#</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 0
<span class="c"># =&gt; deployment.apps/webpod scaled</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.1.1.207:80/TCP (active) (preferred)</span>
<span class="c">#                                                2 =&gt; 10.1.1.217:80/TCP (active) (preferred)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 west의 webpod를 다 내리면, east에서도 east의 webpod로만 접속이 진행됩니다.&lt;/span&gt;</span>

<span class="c"># 다시 설정 원복</span>
<span class="nv">$ </span>kwest scale deployment webpod <span class="nt">--replicas</span> 2
</code></pre></div></div>

<h5 id="serviceciliumioshared">service.cilium.io/shared</h5>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">service.cilium.io/shared=false</code>로 하면 해당 클러스터의 webpod는 다른 ClusterMesh 클러스터에서 접근할 수 없게 됩니다.</li>
  <li>즉, west 클러스터에 <code class="language-plaintext highlighter-rouge">shared=false</code>로 설정하면, east 클러스터에서는 west 클러스터의 webpod에 접근할 수 없게 됩니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 현재 설정 상태 확인</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>

<span class="c"># local로 다시 변경</span>
<span class="nv">$ </span>kwest annotate service webpod service.cilium.io/affinity<span class="o">=</span><span class="nb">local</span> <span class="nt">--overwrite</span>
<span class="nv">$ </span>keast annotate service webpod service.cilium.io/affinity<span class="o">=</span><span class="nb">local</span> <span class="nt">--overwrite</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>

<span class="c"># shared=false : 적용 시, 다른 k8s 클러스터가 영향을 받는다!</span>
<span class="nv">$ </span>kwest annotate service webpod service.cilium.io/shared<span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; Annotations:              service.cilium.io/affinity: local</span>
<span class="c">#                              service.cilium.io/global: true</span>
<span class="c">#                              &lt;span style="color: green;"&gt;service.cilium.io/shared: false&lt;/span&gt;</span>
<span class="c">#    Selector:                 app=webpod</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.171:80/TCP (active) (preferred)</span>
<span class="c">#                                                2 =&gt; 10.0.1.92:80/TCP (active) (preferred)</span>
<span class="c">#                                                3 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                                4 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active) (preferred)</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active) (preferred)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 east 클러스터에서는 west 클러스터의 webpod를 이용할 수 없습니다.</span>

<span class="c"># 호출 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-west <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--context</span> kind-east <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod ; sleep 1; echo "---"; done;'</span>

<span class="c"># 다시 설정 원복</span>
<span class="nv">$ </span>kwest annotate service webpod service.cilium.io/shared<span class="o">=</span><span class="nb">true</span> <span class="nt">--overwrite</span>
<span class="c"># =&gt; service/webpod annotated</span>
<span class="nv">$ </span>kwest describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; ...</span>
<span class="c">#                              service.cilium.io/shared: &lt;span style="color: green;"&gt;true&lt;/span&gt;</span>
<span class="nv">$ </span>keast describe svc webpod | <span class="nb">grep </span>Annotations <span class="nt">-A3</span>
<span class="c"># =&gt; ...</span>
<span class="c">#                              service.cilium.io/shared: &lt;span style="color: green;"&gt;true&lt;/span&gt;</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend                Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.2.184.162:80/TCP     ClusterIP      1 =&gt; 10.0.1.171:80/TCP (active) (preferred)</span>
<span class="c">#                                                2 =&gt; 10.0.1.92:80/TCP (active) (preferred)</span>
<span class="c">#                                                3 =&gt; 10.1.1.207:80/TCP (active)</span>
<span class="c">#                                                4 =&gt; 10.1.1.217:80/TCP (active)</span>
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list <span class="nt">--clustermesh-affinity</span>
<span class="c"># =&gt; ID   Frontend               Service Type   Backend</span>
<span class="c">#    ...</span>
<span class="c">#    13   10.3.136.103:80/TCP    ClusterIP      1 =&gt; 10.1.1.217:80/TCP (active) (preferred)</span>
<span class="c">#                                               2 =&gt; 10.1.1.207:80/TCP (active) (preferred)</span>
<span class="c">#                                               3 =&gt; 10.0.1.171:80/TCP (active)</span>
<span class="c">#                                               4 =&gt; 10.0.1.92:80/TCP (active)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 다시 shared=true로 설정하면, east 클러스터에서도 west 클러스터의 webpod를 이용할 수 있습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="clustermesh-apiserver-파드-정보-확인">clustermesh-apiserver 파드 정보 확인</h3>
<ul>
  <li>krew pexec 플러그인 활용 - <a href="https://github.com/ssup2/kpexec">Github</a>
</li>
  <li><a href="https://docs.cilium.io/en/stable/operations/troubleshooting/#state-propagation">관련문서</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium node list 
<span class="c"># =&gt; Name                      IPv4 Address   Endpoint CIDR   IPv6 Address   Endpoint CIDR   Source</span>
<span class="c">#    east/east-control-plane   172.20.0.5     10.1.0.0/24                                    clustermesh</span>
<span class="c">#    east/east-worker          172.20.0.3     10.1.1.0/24                                    clustermesh</span>
<span class="c">#    west/west-control-plane   172.20.0.4     10.0.0.0/24                                    local</span>
<span class="c">#    west/west-worker          172.20.0.2     10.0.1.0/24                                    custom-resource</span>

<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium node list            
<span class="c"># =&gt; Name                      IPv4 Address   Endpoint CIDR   IPv6 Address   Endpoint CIDR   Source</span>
<span class="c">#    east/east-control-plane   172.20.0.5     10.1.0.0/24                                    custom-resource</span>
<span class="c">#    east/east-worker          172.20.0.3     10.1.1.0/24                                    local</span>
<span class="c">#    west/west-control-plane   172.20.0.4     10.0.0.0/24                                    clustermesh</span>
<span class="c">#    west/west-worker          172.20.0.2     10.0.1.0/24                                    clustermesh</span>

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium identity list
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium identity list

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium bpf ipcache list
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium bpf ipcache list
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium map get cilium_ipcache
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium map get cilium_ipcache


<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list
<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium service list

<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium bpf lb list                      
<span class="c"># =&gt; ...</span>
<span class="c">#    10.2.140.84:443/TCP (0)     0.0.0.0:0 (2) (0) [ClusterIP, InternalLocal, non-routable]</span>

<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium bpf lb list                      
<span class="c"># =&gt; ...</span>
<span class="c">#    10.3.70.57:443/TCP (0)     0.0.0.0:0 (2) (0) [ClusterIP, InternalLocal, non-routable]</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>clustermesh-apiserver
<span class="c"># =&gt; ...</span>
<span class="c">#    Containers:</span>
<span class="c">#      etcd:</span>
<span class="c">#        Container ID:  containerd://924c44c01307d2812baa1c15f53b008720f878fedb45c29b8ec35c641d71b0ae</span>
<span class="c">#        Image:         quay.io/cilium/clustermesh-apiserver:v1.17.6@sha256:f619e97432db427e1511bf91af3be8ded418c53a353a09629e04c5880659d1df</span>
<span class="c">#        Image ID:      quay.io/cilium/clustermesh-apiserver@sha256:f619e97432db427e1511bf91af3be8ded418c53a353a09629e04c5880659d1df</span>
<span class="c">#        Ports:         2379/TCP, 9963/TCP</span>
<span class="c">#        Host Ports:    0/TCP, 0/TCP</span>
<span class="c">#        Command:</span>
<span class="c">#          /usr/bin/etcd</span>
<span class="c">#        Args:</span>
<span class="c">#          --data-dir=/var/run/etcd</span>
<span class="c">#          --name=clustermesh-apiserver</span>
<span class="c">#          --client-cert-auth</span>
<span class="c">#          --trusted-ca-file=/var/lib/etcd-secrets/ca.crt</span>
<span class="c">#          --cert-file=/var/lib/etcd-secrets/tls.crt</span>
<span class="c">#          --key-file=/var/lib/etcd-secrets/tls.key</span>
<span class="c">#          --listen-client-urls=https://127.0.0.1:2379,https://[$(HOSTNAME_IP)]:2379</span>
<span class="c">#          --advertise-client-urls=https://[$(HOSTNAME_IP)]:2379</span>
<span class="c">#          --initial-cluster-token=$(INITIAL_CLUSTER_TOKEN)</span>
<span class="c">#          --auto-compaction-retention=1</span>
<span class="c">#          --listen-metrics-urls=http://[$(HOSTNAME_IP)]:9963</span>
<span class="c">#          --metrics=basic</span>
<span class="c">#    ...</span>
<span class="c">#      apiserver:</span>
<span class="c">#        Container ID:  containerd://eecfbc62afc019580ff533a9a4d57b4e2c193ec48a2e15f9875e3866bfdc86dd</span>
<span class="c">#        Image:         quay.io/cilium/clustermesh-apiserver:v1.17.6@sha256:f619e97432db427e1511bf91af3be8ded418c53a353a09629e04c5880659d1df</span>
<span class="c">#        Image ID:      quay.io/cilium/clustermesh-apiserver@sha256:f619e97432db427e1511bf91af3be8ded418c53a353a09629e04c5880659d1df</span>
<span class="c">#        Ports:         9880/TCP, 9962/TCP</span>
<span class="c">#        Host Ports:    0/TCP, 0/TCP</span>
<span class="c">#        Command:</span>
<span class="c">#          /usr/bin/clustermesh-apiserver</span>
<span class="c">#        Args:</span>
<span class="c">#          clustermesh</span>
<span class="c">#          --debug</span>
<span class="c">#          --cluster-name=$(CLUSTER_NAME)</span>
<span class="c">#          --cluster-id=$(CLUSTER_ID)</span>
<span class="c">#          --kvstore-opt=etcd.config=/var/lib/cilium/etcd-config.yaml</span>
<span class="c">#          --kvstore-opt=etcd.qps=20</span>
<span class="c">#          --kvstore-opt=etcd.bootstrapQps=10000</span>
<span class="c">#          --max-connected-clusters=255</span>
<span class="c">#          --health-port=9880</span>
<span class="c">#          --enable-external-workloads=false</span>
<span class="c">#          --prometheus-serve-addr=:9962</span>
<span class="c">#          --controller-group-metrics=all</span>
<span class="c">#    ...</span>

<span class="c"># etcd 컨터이너 로그 확인</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system deployment/clustermesh-apiserver <span class="nt">-c</span> etcd

<span class="c"># apiserver 컨터이너 로그 확인</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system deployment/clustermesh-apiserver <span class="nt">-c</span> apiserver


<span class="c">#</span>
<span class="nv">$ </span>kwest <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium status <span class="nt">--all-clusters</span>
<span class="c"># =&gt; ClusterMesh:            1/1 remote clusters ready, 1 global-services</span>
<span class="c">#       east: ready, 2 nodes, 9 endpoints, 7 identities, 1 services, 0 MCS-API service exports, 0 reconnections (last: never)</span>
<span class="c">#       └  etcd: 1/1 connected, leases=0, lock leases=0, has-quorum=true: endpoint status checks are disabled, ID: b4f3f4384ecc342c</span>
<span class="c">#       └  remote configuration: expected=true, retrieved=true, cluster-id=2, kvstoremesh=false, sync-canaries=true, service-exports=disabled</span>
<span class="c">#       └  synchronization status: nodes=true, endpoints=true, identities=true, services=true</span>

<span class="nv">$ </span>keast <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">-c</span> cilium-agent <span class="nt">--</span> cilium status <span class="nt">--all-clusters</span>
<span class="c"># =&gt; ClusterMesh:            1/1 remote clusters ready, 1 global-services</span>
<span class="c">#       west: ready, 2 nodes, 9 endpoints, 7 identities, 1 services, 0 MCS-API service exports, 0 reconnections (last: never)</span>
<span class="c">#       └  etcd: 1/1 connected, leases=0, lock leases=0, has-quorum=true: endpoint status checks are disabled, ID: ea025158a8e3c0a3</span>
<span class="c">#       └  remote configuration: expected=true, retrieved=true, cluster-id=1, kvstoremesh=false, sync-canaries=true, service-exports=disabled</span>
<span class="c">#       └  synchronization status: nodes=true, endpoints=true, identities=true, services=true</span>

<span class="c"># etcd 컨테이너 bash 진입 후 확인</span>
<span class="c"># krew pexec 플러그인 활용 https://github.com/ssup2/kpexec</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>clustermesh-apiserver
<span class="c"># =&gt; NAME                                     READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    clustermesh-apiserver-5cf45db9cc-r26tw   2/2     Running   0          4h1m</span>
<span class="nv">$ DPOD</span><span class="o">=</span>clustermesh-apiserver-5cf45db9cc-r26tw

<span class="nv">$ </span>kubectl pexec <span class="nv">$DPOD</span> <span class="nt">-it</span> <span class="nt">-T</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> etcd <span class="nt">--</span> bash
<span class="c"># =&gt; Create cnsenter pod (cnsenter-ehk0cx7v3a)</span>
<span class="c">#    Wait to run cnsenter pod (cnsenter-ehk0cx7v3a)</span>
<span class="c">#    </span>
<span class="c">#    If you don't see a command prompt, try pressing enter.</span>
<span class="nt">------------------------------------------------</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span> <span class="nt">-T</span> <span class="nt">-o</span> pid,ppid,comm,args
<span class="nv">$ </span>ps <span class="nt">-ef</span> <span class="nt">-T</span> <span class="nt">-o</span> args
<span class="c"># =&gt; COMMAND</span>
<span class="c">#    /usr/bin/etcd --data-dir=/var/run/etcd --name=clustermesh-apiserver --client-cert-auth --trusted-ca-file=/var/lib/etcd-secrets/ca.crt --cert-file=/var/lib/etcd-secrets/tls.crt --</span>

<span class="nv">$ </span><span class="nb">cat</span> /proc/1/cmdline <span class="p">;</span> <span class="nb">echo</span>
<span class="c"># =&gt; /usr/bin/etcd--data-dir=/var/run/etcd--name=clustermesh-apiserver--client-cert-auth--trusted-ca-file=/var/lib/etcd-secrets/ca.crt--cert-file=/var/lib/etcd-secrets/tls.crt--key-file=/var/lib/etcd-secrets/tls.key--listen-client-urls=https://127.0.0.1:2379,https://[10.0.1.223]:2379--advertise-client-urls=https://[10.0.1.223]:2379--initial-cluster-token=7a3aaa07-ca4f-4627-a84b-d7cb8aff8987--auto-compaction-retention=1--listen-metrics-urls=http://[10.0.1.223]:9963--metrics=basic</span>

<span class="nv">$ </span>ss <span class="nt">-tnlp</span>
<span class="c"># =&gt; LISTEN    0       4096     10.0.1.223:2379     0.0.0.0:*           users:(("etcd",pid=1,fd=8))</span>
<span class="nv">$ </span>ss <span class="nt">-tnp</span>
<span class="c"># =&gt; ESTAB     0       0        10.0.1.223:2379     172.20.0.4:43498    users:(("etcd",pid=1,fd=14))</span>
<span class="c">#    ESTAB     0       0        10.0.1.223:2379     172.20.0.4:39300    users:(("etcd",pid=1,fd=15))</span>

<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">------------------------------------------------</span>

<span class="nv">$ </span>kubectl pexec <span class="nv">$DPOD</span> <span class="nt">-it</span> <span class="nt">-T</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> apiserver <span class="nt">--</span> bash
<span class="nt">------------------------------------------------</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span> <span class="nt">-T</span> <span class="nt">-o</span> pid,ppid,comm,args
<span class="nv">$ </span>ps <span class="nt">-ef</span> <span class="nt">-T</span> <span class="nt">-o</span> args
<span class="c"># =&gt; COMMAND</span>
<span class="c">#    /usr/bin/clustermesh-apiserver clustermesh --debug --cluster-name=west --cluster-id=1 --kvstore-opt=etcd.config=/var/lib/cilium/etcd-config.yaml --kvstore-opt=etcd.qps=20 --kvsto</span>
<span class="nv">$ </span><span class="nb">cat</span> /proc/1/cmdline <span class="p">;</span> <span class="nb">echo</span>
<span class="c"># =&gt; /usr/bin/clustermesh-apiserverclustermesh--debug--cluster-name=west--cluster-id=1--kvstore-opt=etcd.config=/var/lib/cilium/etcd-config.yaml--kvstore-opt=etcd.qps=20--kvstore-opt=etcd.bootstrapQps=10000--max-connected-clusters=255--health-port=9880--enable-external-workloads=false--prometheus-serve-addr=:9962--controller-group-metrics=all</span>

<span class="nv">$ </span>ss <span class="nt">-tnlp</span>
<span class="c"># =&gt; LISTEN           0                4096                          10.0.1.223:2379                           0.0.0.0:*</span>
<span class="c">#    LISTEN           0                4096                           127.0.0.1:2379                           0.0.0.0:*</span>
<span class="nv">$ </span>ss <span class="nt">-tnp</span>
<span class="c"># =&gt; State           Recv-Q           Send-Q                     Local Address:Port                      Peer Address:Port            Process</span>
<span class="c">#    ESTAB           0                0                             10.0.1.223:60950                       172.20.0.4:6443             users:(("clustermesh-api",pid=1,fd=6))</span>
<span class="c">#    ESTAB           0                0                              127.0.0.1:33160                        127.0.0.1:2379             users:(("clustermesh-api",pid=1,fd=7))</span>
<span class="nv">$ </span><span class="nb">exit</span>
<span class="nt">------------------------------------------------</span>
</code></pre></div></div>

<h3 id="kind-클러스터-삭제">kind 클러스터 삭제</h3>

<ul>
  <li>실습 완료 후 kind 클러스터를 삭제합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kind delete cluster <span class="nt">--name</span> west <span class="o">&amp;&amp;</span> kind delete cluster <span class="nt">--name</span> east <span class="o">&amp;&amp;</span> kind delete cluster <span class="nt">--name</span> center
</code></pre></div></div>

<hr>

<h2 id="마치며">마치며</h2>

<p>이번 포스트에서는 BGP를 통한 라우팅 및 BGP를 통한 LoadBalancer - ExternalIP 광고,
ClusterMesh를 통한 클러스터 간 통신을 설정하는 방법에 대해 알아보았습니다.
다양한 유스케이스에 대한 기능이 준비되어있음에 감탄했습니다.</p>

<p>특히 ClusterMesh는 단일 CSP에서도 사용할 수 있지만, 멀티 클라우드 환경이나 하이브리드 클라우드 환경에서도
유용할것 같아서 정말 좋은 기능인것 같습니다.
BGP의 동작에 대해서도 조금이나마 이해를 갖게 되었고, 스터디를 통해서 정말 많은 것을 배워가는것 같습니다.</p>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#%EC%8B%A4%EC%8A%B5-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1">실습 환경 구성</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC-%ED%8C%8C%EC%9D%BC">실습환경 배포 파일</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC">실습환경 배포</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%83%98%ED%94%8C-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%86%B5%EC%8B%A0-%EB%AC%B8%EC%A0%9C-%ED%99%95%EC%9D%B8">샘플 애플리케이션 배포 및 통신 문제 확인</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#cilium-bgp-control-plane">Cilium BGP Control Plane</a>
<ul>
<li class="toc-entry toc-h4"><a href="#bgp%EC%84%A4%EC%A0%95-%ED%9B%84-%ED%86%B5%EC%8B%A0-%ED%99%95%EC%9D%B8">BGP 설정 후 통신 확인</a></li>
<li class="toc-entry toc-h3"><a href="#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0-%ED%9B%84-%ED%86%B5%EC%8B%A0">문제 해결 후 통신</a></li>
<li class="toc-entry toc-h3"><a href="#%EB%85%B8%EB%93%9C-%EC%9C%A0%EC%A7%80%EB%B3%B4%EC%88%98-k8s-w0-%EC%8B%A4%EC%8A%B5">노드 유지보수 (k8s-w0) 실습</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#kind">Kind</a>
<ul>
<li class="toc-entry toc-h3"><a href="#kind-%EC%86%8C%EA%B0%9C">Kind 소개</a></li>
<li class="toc-entry toc-h3">
<a href="#kind-%EC%84%A4%EC%B9%98">Kind 설치</a>
<ul>
<li class="toc-entry toc-h4"><a href="#docker-desktop-%EB%B0%8F-%ED%95%84%EC%88%98-%ED%88%B4-%EC%84%A4%EC%B9%98">Docker Desktop 및 필수 툴 설치</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#kind-%EA%B8%B0%EB%B3%B8-%EC%82%AC%EC%9A%A9---%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%99%95%EC%9D%B8">kind 기본 사용 - 클러스터 배포 및 확인</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#cluster-mesh">Cluster Mesh</a>
<ul>
<li class="toc-entry toc-h4"><a href="#kind-k8s-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-west-east-%EB%B0%B0%ED%8F%AC">kind k8s 클러스터 west, east 배포</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-cni-%EB%B0%B0%ED%8F%AC">Cilium CNI 배포</a></li>
<li class="toc-entry toc-h3"><a href="#clustermesh-%EB%B0%B0%ED%8F%AC">ClusterMesh 배포</a></li>
<li class="toc-entry toc-h3"><a href="#west-%ED%8C%8C%EB%93%9C---east-%ED%8C%8C%EB%93%9C-%EA%B0%84-%EC%A7%81%EC%A0%91-%ED%86%B5%EC%8B%A0-%ED%99%95%EC%9D%B8-with-static-routing">west 파드 &lt;-&gt; east 파드 간 직접 통신 확인 with static routing</a></li>
<li class="toc-entry toc-h3"><a href="#load-balancing--service-discovery">Load-Balancing &amp; Service Discovery</a></li>
<li class="toc-entry toc-h3"><a href="#service-affinity">Service Affinity</a></li>
<li class="toc-entry toc-h3"><a href="#clustermesh-apiserver-%ED%8C%8C%EB%93%9C-%EC%A0%95%EB%B3%B4-%ED%99%95%EC%9D%B8">clustermesh-apiserver 파드 정보 확인</a></li>
<li class="toc-entry toc-h3"><a href="#kind-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EC%82%AD%EC%A0%9C">kind 클러스터 삭제</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2025-08-17-Cilium-Week5/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2025-08-10-Cilium-Week4/">« [Cilium] Networking - 노드의 파드들간 통신 상세 part 2</a>
  
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2025-08-17-Cilium-Week5/";
this.page.identifier = "/posts/Cilium - Week5";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>

<!--      <div class="adsbygoogle-side">-->
<!--        &lt;!&ndash; ad_side &ndash;&gt;-->
<!--        <ins class="adsbygoogle "-->
<!--             style="display: block"-->
<!--             data-ad-client="ca-pub-6564723532026864"-->
<!--             data-ad-slot="1339398797"-->
<!--             data-ad-format="auto"-->
<!--             data-full-width-responsive="true"></ins>-->
<!--      </div>-->
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>공부 기록과 개발 이야기를 담은 블로그입니다.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6564723532026864" crossorigin="anonymous"></script>
    <!--<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>-->
  </body>

</html>
