<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[Cilium] Cilium ServiceMesh | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[Cilium] Cilium ServiceMesh">
<meta property="og:locale" content="ko">
<meta name="description" content="이번 포스트에서는 ServiceMesh이란 무엇인가와 등장배경을 알아보고, Cilium에서 제공하는 ServiceMesh의 각 기능들에 대해 실습을 통하여 알아보도록 하겠습니다.">
<meta property="og:description" content="이번 포스트에서는 ServiceMesh이란 무엇인가와 등장배경을 알아보고, Cilium에서 제공하는 ServiceMesh의 각 기능들에 대해 실습을 통하여 알아보도록 하겠습니다.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2025-08-24-Cilium-Week6/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2025-08-24-Cilium-Week6/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2025-08-24T00:10:18+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[Cilium] Cilium ServiceMesh">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-08-24T00:10:18+09:00","datePublished":"2025-08-24T00:10:18+09:00","description":"이번 포스트에서는 ServiceMesh이란 무엇인가와 등장배경을 알아보고, Cilium에서 제공하는 ServiceMesh의 각 기능들에 대해 실습을 통하여 알아보도록 하겠습니다.","headline":"[Cilium] Cilium ServiceMesh","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2025-08-24-Cilium-Week6/"},"url":"https://sweetlittlebird.github.io/posts/2025-08-24-Cilium-Week6/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body class="body--contents">
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">소개</a><a class="page-link" href="/posts/">글 목록</a>
</div>
      </nav>
</div>
  
  <span id="scroll-indicator"></span>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[Cilium] Cilium ServiceMesh</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-08-24T00:10:18+09:00" itemprop="datePublished">2025년 08월 24일에 작성
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>목차</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#%EC%8B%A4%EC%8A%B5-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1">실습 환경 구성</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC-%ED%8C%8C%EC%9D%BC">실습환경 배포 파일</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC">실습환경 배포</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%83%98%ED%94%8C-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%86%B5%EC%8B%A0-%EB%AC%B8%EC%A0%9C-%ED%99%95%EC%9D%B8">샘플 애플리케이션 배포 및 통신 문제 확인</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#cilium-service-mesh">Cilium Service Mesh</a>
<ul>
<li class="toc-entry toc-h3"><a href="#service-mesh-%EC%86%8C%EA%B0%9C">Service Mesh 소개</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-service-mesh-%EC%86%8C%EA%B0%9C">Cilium Service Mesh 소개</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#k8s-ingress-support">K8S Ingress Support</a>
<ul>
<li class="toc-entry toc-h3"><a href="#cilium-k8s-ingress-support-%EC%86%8C%EA%B0%9C">Cilium K8S Ingress Support 소개</a></li>
<li class="toc-entry toc-h3"><a href="#ingress-http-example--xff-%ED%99%95%EC%9D%B8">Ingress HTTP Example : XFF 확인</a></li>
<li class="toc-entry toc-h3"><a href="#ingress-nginx-%EC%84%A4%EC%B9%98%ED%95%98%EC%97%AC-cilium-ingress%EC%99%80-%EA%B3%B5%EC%A1%B4-%EA%B0%80%EB%8A%A5%EC%97%AC%EB%B6%80-%ED%99%95%EC%9D%B8">Ingress-Nginx 설치하여 Cilium Ingress와 공존 가능여부 확인</a></li>
<li class="toc-entry toc-h3"><a href="#dedicated-mode">Dedicated Mode</a></li>
<li class="toc-entry toc-h3"><a href="#ingress-and-network-policies-example">Ingress and Network Policies Example</a></li>
<li class="toc-entry toc-h3"><a href="#ingress-path-type-example">Ingress Path Type Example</a></li>
<li class="toc-entry toc-h3"><a href="#ingress-example-with-tls-termination">Ingress Example with TLS Termination</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#gateway-api-support">Gateway API Support</a>
<ul>
<li class="toc-entry toc-h3"><a href="#gateway-api-%EC%86%8C%EA%B0%9C">Gateway API 소개</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-gateway-api-%EC%A7%80%EC%9B%90">Cilium Gateway API 지원</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-gateway-api-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EB%B0%B0%ED%8F%AC">Cilium Gateway API 설정 및 배포</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#mutual-authentication-beta">Mutual Authentication (Beta)</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%A3%BC%EC%9A%94-%EA%B0%9C%EB%85%90">주요 개념</a></li>
<li class="toc-entry toc-h3"><a href="#cilium%EC%97%90%EC%84%9C%EC%9D%98-%EC%83%81%ED%98%B8-%EC%9D%B8%EC%A6%9D">Cilium에서의 상호 인증</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#l7-aware-traffic-management">L7-Aware Traffic Management</a>
<ul>
<li class="toc-entry toc-h3"><a href="#l7-aware-traffic-management-%EC%86%8C%EA%B0%9C">L7-Aware Traffic Management 소개</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5-l7-%ED%8A%B8%EB%9E%98%ED%94%BD-%EA%B4%80%EB%A6%AC">실습: L7 트래픽 관리</a></li>
<li class="toc-entry toc-h3"><a href="#l7-aware-traffic-management-%ED%99%9C%EC%84%B1%ED%99%94">L7-Aware Traffic Management 활성화</a></li>
<li class="toc-entry toc-h3"><a href="#l7-load-balancing%EA%B3%BC-url-rewriting">L7 Load Balancing과 URL Rewriting</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
    </div>
    <h2 id="들어가며">들어가며</h2>

<p>이번 포스트에서는 ServiceMesh이란 무엇인가와 등장배경을 알아보고,
Cilium에서 제공하는 ServiceMesh의 각 기능들에 대해 실습을 통하여 알아보도록 하겠습니다.</p>

<hr>

<h2 id="실습-환경-구성">실습 환경 구성</h2>

<ul>
  <li>이번 실습에서는 다음의 구성으로 실습 환경을 구성합니다.
    <ul>
      <li>
<strong>버전</strong> : Kubernetes 1.33.4, Cilium 1.18.1, pwru</li>
      <li>
<strong>기본 배포 가상 머신</strong> : k8s-ctr, k8s-w1, router
        <ul>
          <li>k8s-ctr spec : vCPU 4, Mem 2560</li>
          <li>k8s-w1 spec : vCPU 4, Mem 2560</li>
        </ul>
      </li>
      <li>
<strong>router</strong> : router : 192.168.<strong>10</strong>.0/24 ↔ 192.168.<strong>20</strong>.0/24 대역 라우팅 역할, k8s 에 join 되지 않은 서버입니다.</li>
      <li>실습 동작에 필요한 static routing이 설저된 상태로 배포 됩니다.</li>
    </ul>
  </li>
</ul>

<h3 id="실습환경-배포-파일">실습환경 배포 파일</h3>

<ul>
  <li>
    <p><strong>Vagrantfile</strong> : 가상머신 정의, 부팅 시 초기 프로비저닝 설정을 포함하는 Vagrantfile입니다.</p>

    <div class="language-ruby highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># Variables</span>
<span class="no">K8SV</span> <span class="o">=</span> <span class="s1">'1.33.4-1.1'</span> <span class="c1"># Kubernetes Version : apt list -a kubelet , ex) 1.32.5-1.1</span>
<span class="no">CONTAINERDV</span> <span class="o">=</span> <span class="s1">'1.7.27-1'</span> <span class="c1"># Containerd Version : apt list -a containerd.io , ex) 1.6.33-1</span>
<span class="no">CILIUMV</span> <span class="o">=</span> <span class="s1">'1.18.1'</span> <span class="c1"># Cilium CNI Version : https://github.com/cilium/cilium/tags</span>
<span class="no">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># max number of worker nodes</span>
  
<span class="c1"># Base Image  https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-24.04</span>
<span class="no">BOX_IMAGE</span> <span class="o">=</span> <span class="s2">"bento/ubuntu-24.04"</span>
<span class="no">BOX_VERSION</span> <span class="o">=</span> <span class="s2">"202508.03.0"</span>
  
<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1">#-ControlPlane Node</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-ctr"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
  
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">2560</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-ctr"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.100"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60000</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span> <span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-ctr.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">N</span><span class="p">,</span> <span class="no">CILIUMV</span><span class="p">,</span> <span class="no">K8SV</span> <span class="p">]</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"route-add1.sh"</span>
  <span class="k">end</span>
  
  <span class="c1">#-Worker Nodes Subnet1</span>
  <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="no">N</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--nicpromisc2"</span><span class="p">,</span> <span class="s2">"allow-all"</span><span class="p">]</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1536</span>
        <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"k8s-w</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.10</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="s2">"6000</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"init_cfg.sh"</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span> <span class="no">K8SV</span><span class="p">,</span> <span class="no">CONTAINERDV</span><span class="p">]</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"k8s-w.sh"</span>
      <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"route-add1.sh"</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="c1">#-Router Node</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"router"</span> <span class="k">do</span> <span class="o">|</span><span class="n">subconfig</span><span class="o">|</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="no">BOX_IMAGE</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_version</span> <span class="o">=</span> <span class="no">BOX_VERSION</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="s2">"virtualbox"</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">customize</span> <span class="p">[</span><span class="s2">"modifyvm"</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">"--groups"</span><span class="p">,</span> <span class="s2">"/Cilium-Lab"</span><span class="p">]</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"router"</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">768</span>
      <span class="n">vb</span><span class="p">.</span><span class="nf">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">host_name</span> <span class="o">=</span> <span class="s2">"router"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.10.200"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">22</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">60009</span><span class="p">,</span> <span class="ss">auto_correct: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"ssh"</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"192.168.20.200"</span><span class="p">,</span> <span class="ss">auto_config: </span><span class="kp">false</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
    <span class="n">subconfig</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">path: </span><span class="s2">"router.sh"</span>
  <span class="k">end</span>
  
<span class="k">end</span>

</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>init_cfg.sh</strong> : args 참고하여 초기 설정을 수행하는 스크립트입니다. <strong>pwru</strong>도 설치합니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime <span class="c"># Change Timezone</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Disable and turn off SWAP"</span>
swapoff <span class="nt">-a</span> <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'/swap/s/^/#/'</span> /etc/fstab
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Install Packages"</span>
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>apt-transport-https ca-certificates curl gpg <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># Download the public signing key for the Kubernetes package repositories.</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nt">-m</span> 755 /etc/apt/keyrings
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$1</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+)\..*/\1/p'</span><span class="si">)</span>
curl <span class="nt">-fsSL</span> https://pkgs.k8s.io/core:/stable:/v<span class="nv">$K8SMMV</span>/deb/Release.key | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/kubernetes-apt-keyring.gpg
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v</span><span class="nv">$K8SMMV</span><span class="s2">/deb/ /"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list.d/kubernetes.list
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="nt">-o</span> /etc/apt/keyrings/docker.asc
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span><span class="nb">.</span> /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$VERSION_CODENAME</span><span class="s2">"</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
  
<span class="c"># packets traversing the bridge are processed by iptables for filtering</span>
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
<span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> <span class="o">&gt;&gt;</span> /etc/sysctl.d/k8s.conf
  
<span class="c"># enable br_netfilter for iptables </span>
modprobe br_netfilter
modprobe overlay
<span class="nb">echo</span> <span class="s2">"br_netfilter"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
<span class="nb">echo</span> <span class="s2">"overlay"</span> <span class="o">&gt;&gt;</span> /etc/modules-load.d/k8s.conf
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)"</span>
<span class="c"># Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version</span>
apt update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># apt list -a kubelet ; apt list -a containerd.io</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubectl</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">kubeadm</span><span class="o">=</span><span class="nv">$1</span> containerd.io<span class="o">=</span><span class="nv">$2</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-mark hold kubelet kubeadm kubectl <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
<span class="c"># containerd configure to default and cgroup managed by systemd</span>
containerd config default <span class="o">&gt;</span> /etc/containerd/config.toml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/SystemdCgroup = false/SystemdCgroup = true/g'</span> /etc/containerd/config.toml
  
<span class="c"># avoid WARN&amp;ERRO(default endpoints) when crictl run  </span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
</span><span class="no">EOF
  
</span><span class="c"># ready to install for k8s </span>
systemctl restart containerd <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable </span>containerd
systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Packages &amp; Helm"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get <span class="nb">install</span> <span class="nt">-y</span> bridge-utils sshpass net-tools conntrack ngrep tcpdump ipset arping wireguard jq yq tree bash-completion unzip kubecolor termshark <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
curl <span class="nt">-s</span> https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 7] Install pwru"</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>wget https://github.com/cilium/pwru/releases/download/v1.0.10/pwru-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar</span> <span class="nt">-xvzf</span> pwru-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">mv </span>pwru /usr/local/bin/pwru <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="c"># echo "[TASK 8] Change MTU for eth1"</span>
<span class="c"># ip link set dev eth1 mtu 9000</span>
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>  
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>k8s-ctr.sh</strong> : kubeadm init를 통하여 kubernetes controlplane 노드를 설정하고 Cilium CNI 설치, 편리성 설정(k, kc, k9s)하는 스크립트입니다. local-path-storageclass와 metrics-server도 설치합니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Initial Kubernetes"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-init-ctr-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/kubeadm-init-ctr-config.yaml
<span class="nv">K8SMMV</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$3</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s1">'s/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/p'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/K8S_VERSION_PLACEHOLDER/v</span><span class="k">${</span><span class="nv">K8SMMV</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-init-ctr-config.yaml
kubeadm init <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-init-ctr-config.yaml"</span>  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Setting kube config file"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /root/.kube
<span class="nb">cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf /root/.kube/config
<span class="nb">chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> /root/.kube/config
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Source the completion"</span>
<span class="nb">echo</span> <span class="s1">'source &lt;(kubectl completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'source &lt;(kubeadm completion bash)'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 4] Alias kubectl to k"</span>
<span class="nb">echo</span> <span class="s1">'alias k=kubectl'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'alias kc=kubecolor'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s1">'complete -F __start_kubectl k'</span> <span class="o">&gt;&gt;</span> /etc/profile
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Kubectx &amp; Kubens"</span>
git clone https://github.com/ahmetb/kubectx /opt/kubectx <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubens /usr/local/bin/kubens
<span class="nb">ln</span> <span class="nt">-s</span> /opt/kubectx/kubectx /usr/local/bin/kubectx
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Kubeps &amp; Setting PS1"</span>
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1 <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">"</span><span class="no">EOT</span><span class="sh">" &gt;&gt; /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
function get_cluster_short() {
  echo "</span><span class="nv">$1</span><span class="sh">" | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=') '
PS1='</span><span class="si">$(</span>kube_ps1<span class="si">)</span><span class="sh">'</span><span class="nv">$PS1</span><span class="sh">
</span><span class="no">EOT
</span>kubectl config rename-context <span class="s2">"kubernetes-admin@kubernetes"</span> <span class="s2">"HomeLab"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 7] Install Cilium CNI"</span>
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
helm repo add cilium https://helm.cilium.io/ <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm repo update <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm <span class="nb">install </span>cilium cilium/cilium <span class="nt">--version</span> <span class="nv">$2</span> <span class="nt">--namespace</span> kube-system <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">k8sServiceHost</span><span class="o">=</span>192.168.10.100 <span class="nt">--set</span> <span class="nv">k8sServicePort</span><span class="o">=</span>6443 <span class="se">\</span>
<span class="nt">--set</span> ipam.mode<span class="o">=</span><span class="s2">"cluster-pool"</span> <span class="nt">--set</span> ipam.operator.clusterPoolIPv4PodCIDRList<span class="o">={</span><span class="s2">"172.20.0.0/16"</span><span class="o">}</span> <span class="nt">--set</span> <span class="nv">ipv4NativeRoutingCIDR</span><span class="o">=</span>172.20.0.0/16 <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">routingMode</span><span class="o">=</span>native <span class="nt">--set</span> <span class="nv">autoDirectNodeRoutes</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> endpointRoutes.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">directRoutingSkipUnreachable</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> bpf.masquerade<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">installNoConntrackIptablesRules</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> endpointHealthChecking.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> <span class="nv">healthChecking</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.relay.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.ui.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.ui.service.type<span class="o">=</span>NodePort <span class="nt">--set</span> hubble.ui.service.nodePort<span class="o">=</span>30003 <span class="se">\</span>
<span class="nt">--set</span> prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> operator.prometheus.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> hubble.metrics.enableOpenMetrics<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> hubble.metrics.enabled<span class="o">=</span><span class="s2">"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip</span><span class="se">\,</span><span class="s2">source_namespace</span><span class="se">\,</span><span class="s2">source_workload</span><span class="se">\,</span><span class="s2">destination_ip</span><span class="se">\,</span><span class="s2">destination_namespace</span><span class="se">\,</span><span class="s2">destination_workload</span><span class="se">\,</span><span class="s2">traffic_direction}"</span> <span class="se">\</span>
<span class="nt">--set</span> ingressController.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> ingressController.loadbalancerMode<span class="o">=</span>shared <span class="nt">--set</span> loadBalancer.l7.backend<span class="o">=</span>envoy <span class="se">\</span>
<span class="nt">--set</span> <span class="nv">localRedirectPolicy</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> l2announcements.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
<span class="nt">--set</span> operator.replicas<span class="o">=</span>1 <span class="nt">--set</span> debug.enabled<span class="o">=</span><span class="nb">true</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 8] Install Cilium / Hubble CLI"</span>
<span class="nv">CILIUM_CLI_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="si">)</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/cilium-cli/releases/download/<span class="k">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="k">}</span>/cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>cilium-linux-<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.tar.gz
  
<span class="nv">HUBBLE_VERSION</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="si">)</span>
<span class="nv">HUBBLE_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">HUBBLE_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>curl <span class="nt">-L</span> <span class="nt">--fail</span> <span class="nt">--remote-name-all</span> https://github.com/cilium/hubble/releases/download/<span class="nv">$HUBBLE_VERSION</span>/hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">tar </span>xzvfC hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz /usr/local/bin
<span class="nb">rm </span>hubble-linux-<span class="k">${</span><span class="nv">HUBBLE_ARCH</span><span class="k">}</span>.tar.gz
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 9] Remove node taint"</span>
kubectl taint nodes k8s-ctr node-role.kubernetes.io/control-plane-
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 10] local DNS with hosts file"</span>
<span class="nb">echo</span> <span class="s2">"192.168.10.100 k8s-ctr"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.10.200 router"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="nb">echo</span> <span class="s2">"192.168.20.100 k8s-w0"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;<span class="o">=</span><span class="nv">$1</span><span class="p">;</span> i++  <span class="o">))</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"192.168.10.10</span><span class="nv">$i</span><span class="s2"> k8s-w</span><span class="nv">$i</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/hosts<span class="p">;</span> <span class="k">done
  
  
</span><span class="nb">echo</span> <span class="s2">"[TASK 11] Dynamically provisioning persistent local storage with Kubernetes"</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.31/deploy/local-path-storage.yaml <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
kubectl patch storageclass local-path <span class="nt">-p</span> <span class="s1">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="c"># echo "[TASK 12] Install Prometheus &amp; Grafana"</span>
<span class="c"># kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.18.0/examples/kubernetes/addons/prometheus/monitoring-example.yaml &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># kubectl patch svc -n cilium-monitoring prometheus -p '{"spec": {"type": "NodePort", "ports": [{"port": 9090, "targetPort": 9090, "nodePort": 30001}]}}' &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># kubectl patch svc -n cilium-monitoring grafana -p '{"spec": {"type": "NodePort", "ports": [{"port": 3000, "targetPort": 3000, "nodePort": 30002}]}}' &gt;/dev/null 2&gt;&amp;1</span>
  
<span class="c"># echo "[TASK 12] Install Prometheus Stack"</span>
<span class="c"># helm repo add prometheus-community https://prometheus-community.github.io/helm-charts  &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># cat &lt;&lt;EOT &gt; monitor-values.yaml</span>
<span class="c"># prometheus:</span>
<span class="c">#   prometheusSpec:</span>
<span class="c">#     scrapeInterval: "15s"</span>
<span class="c">#     evaluationInterval: "15s"</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30001</span>
  
<span class="c"># grafana:</span>
<span class="c">#   defaultDashboardsTimezone: Asia/Seoul</span>
<span class="c">#   adminPassword: prom-operator</span>
<span class="c">#   service:</span>
<span class="c">#     type: NodePort</span>
<span class="c">#     nodePort: 30002</span>
  
<span class="c"># alertmanager:</span>
<span class="c">#   enabled: false</span>
<span class="c"># defaultRules:</span>
<span class="c">#   create: false</span>
<span class="c"># prometheus-windows-exporter:</span>
<span class="c">#   prometheus:</span>
<span class="c">#     monitor:</span>
<span class="c">#       enabled: false</span>
<span class="c"># EOT</span>
<span class="c"># helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack --version 75.15.1 \</span>
<span class="c">#   -f monitor-values.yaml --create-namespace --namespace monitoring  &gt;/dev/null 2&gt;&amp;1</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 13] Install Metrics-server"</span>
helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
helm upgrade <span class="nt">--install</span> metrics-server metrics-server/metrics-server <span class="nt">--set</span> <span class="s1">'args[0]=--kubelet-insecure-tls'</span> <span class="nt">-n</span> kube-system  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 14] Install k9s"</span>
<span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi
</span>wget https://github.com/derailed/k9s/releases/latest/download/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb <span class="nt">-O</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt <span class="nb">install</span> /tmp/k9s_linux_<span class="k">${</span><span class="nv">CLI_ARCH</span><span class="k">}</span>.deb  <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Controlplane Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p><strong>kubeadm-init-ctr-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration
bootstrapTokens:
- token: <span class="s2">"123456.1234567890123456"</span>
  ttl: <span class="s2">"0s"</span>
  usages:
  - signing
  - authentication
localAPIEndpoint:
  advertiseAddress: <span class="s2">"192.168.10.100"</span>
nodeRegistration:
  kubeletExtraArgs:
    - name: node-ip
      value: <span class="s2">"192.168.10.100"</span>
  criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
<span class="nt">---</span>
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
kubernetesVersion: <span class="s2">"K8S_VERSION_PLACEHOLDER"</span>
networking:
  podSubnet: <span class="s2">"10.244.0.0/16"</span>
  serviceSubnet: <span class="s2">"10.96.0.0/16"</span>
proxy:
  disabled: <span class="nb">true</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
<strong>k8s-w.sh</strong> : kubernetes worker 노드 설정, kubeadm join 등을 수행하는  스크립트입니다.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] K8S Controlplane Join"</span>
curl <span class="nt">--silent</span> <span class="nt">-o</span> /root/kubeadm-join-worker-config.yaml https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/kubeadm-join-worker-config.yaml
<span class="nv">NODEIP</span><span class="o">=</span><span class="si">$(</span>ip <span class="nt">-4</span> addr show eth1 | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'(?&lt;=inet\s)\d+(\.\d+){3}'</span><span class="si">)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/NODE_IP_PLACEHOLDER/</span><span class="k">${</span><span class="nv">NODEIP</span><span class="k">}</span><span class="s2">/g"</span> /root/kubeadm-join-worker-config.yaml
kubeadm <span class="nb">join</span> <span class="nt">--config</span><span class="o">=</span><span class="s2">"/root/kubeadm-join-worker-config.yaml"</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1
    
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
    <ul>
      <li>
        <p><strong>kubeadm-join-worker-config.yaml</strong></p>

        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>apiVersion: kubeadm.k8s.io/v1beta4
kind: JoinConfiguration
discovery:
  bootstrapToken:
    token: <span class="s2">"123456.1234567890123456"</span>
    apiServerEndpoint: <span class="s2">"192.168.10.100:6443"</span>
    unsafeSkipCAVerification: <span class="nb">true
</span>nodeRegistration:
  criSocket: <span class="s2">"unix:///run/containerd/containerd.sock"</span>
  kubeletExtraArgs:
    - name: node-ip
      value: <span class="s2">"NODE_IP_PLACEHOLDER"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>route-add1.sh</strong> : k8s node 들이 내부망과 통신을 위한 route 설정 스크립트입니다.</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config Start &lt;&lt;&lt;&lt;"</span>
  
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">&gt;&gt; /etc/netplan/50-vagrant.yaml
      routes:
      - to: 192.168.20.0/24
        via: 192.168.10.200
</span><span class="no">EOT
  
</span>netplan apply
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Route Add Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>router.sh</strong> : router 역할, 간단 웹 서버 역할</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config Start &lt;&lt;&lt;&lt;"</span>
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 0] Setting eth2"</span>
<span class="nb">chmod </span>600 /etc/netplan/01-netcfg.yaml
<span class="nb">chmod </span>600 /etc/netplan/50-vagrant.yaml
  
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOT</span><span class="sh"> &gt;&gt; /etc/netplan/50-vagrant.yaml
    eth2:
      addresses:
      - 192.168.20.200/24
</span><span class="no">EOT
  
</span>netplan apply
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 1] Setting Profile &amp; Bashrc"</span>
<span class="nb">echo</span> <span class="s1">'alias vi=vim'</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="nb">echo</span> <span class="s2">"sudo su -"</span> <span class="o">&gt;&gt;</span> /home/vagrant/.bashrc
<span class="nb">ln</span> <span class="nt">-sf</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 2] Disable AppArmor"</span>
systemctl stop ufw <span class="o">&amp;&amp;</span> systemctl disable ufw <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
systemctl stop apparmor <span class="o">&amp;&amp;</span> systemctl disable apparmor <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 3] Add Kernel setting - IP Forwarding"</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g'</span> /etc/sysctl.conf
sysctl <span class="nt">-p</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 5] Install Packages"</span>
<span class="nb">export </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
apt-get <span class="nb">install </span>net-tools jq yq tree ngrep tcpdump arping termshark <span class="nt">-y</span> <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
  
  
<span class="nb">echo</span> <span class="s2">"[TASK 6] Install Apache"</span>
apt <span class="nb">install </span>apache2 <span class="nt">-y</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"&lt;h1&gt;Web Server : </span><span class="si">$(</span><span class="nb">hostname</span><span class="si">)</span><span class="s2">&lt;/h1&gt;"</span> <span class="o">&gt;</span> /var/www/html/index.html
  
  
<span class="nb">echo</span> <span class="s2">"&gt;&gt;&gt;&gt; Initial Config End &lt;&lt;&lt;&lt;"</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="실습환경-배포">실습환경 배포</h3>

<h5 id="실습환경-배포-1">실습환경 배포</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>vagrant up
</code></pre></div></div>

<h5 id="기본정보-확인">기본정보 확인</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
<span class="c"># =&gt; ...</span>
<span class="c">#    127.0.2.1 k8s-ctr k8s-ctr</span>
<span class="c">#    192.168.10.100 k8s-ctr</span>
<span class="c">#    192.168.10.200 router</span>
<span class="c">#    192.168.20.100 k8s-w0</span>
<span class="c">#    192.168.10.101 k8s-w1</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>k8s-w1 router <span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"&gt;&gt; node : </span><span class="nv">$i</span><span class="s2"> &lt;&lt;"</span><span class="p">;</span> sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no vagrant@<span class="nv">$i</span> <span class="nb">hostname</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="k">done</span>
<span class="c"># =&gt; &gt;&gt; node : k8s-w1 &lt;&lt;</span>
<span class="c">#    k8s-w1</span>
<span class="c">#    &gt;&gt; node : router &lt;&lt;</span>
<span class="c">#    router</span>

<span class="c"># 클러스터 정보 확인</span>
<span class="nv">$ </span>kubectl cluster-info
<span class="c"># =&gt; Kubernetes control plane is running at https://192.168.10.100:6443</span>
<span class="c">#    CoreDNS is running at https://192.168.10.100:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<span class="nv">$ </span>kubectl cluster-info dump | <span class="nb">grep</span> <span class="nt">-m</span> 2 <span class="nt">-E</span> <span class="s2">"cluster-cidr|service-cluster-ip-range"</span>
<span class="c"># =&gt;                             "--service-cluster-ip-range=10.96.0.0/16",</span>
<span class="c">#                                "--cluster-cidr=10.244.0.0/16",</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubeadm-config
<span class="c"># =&gt; ...</span>
<span class="c">#    networking:</span>
<span class="c">#      dnsDomain: cluster.local</span>
<span class="c">#      podSubnet: 10.244.0.0/16</span>
<span class="c">#      serviceSubnet: 10.96.0.0/16</span>
<span class="nv">$ </span>kubectl describe cm <span class="nt">-n</span> kube-system kubelet-config

<span class="c"># 노드 정보 : 상태, INTERNAL-IP 확인</span>
<span class="nv">$ </span>ifconfig | <span class="nb">grep</span> <span class="nt">-iEA1</span> <span class="s1">'eth[0-9]:'</span>
<span class="c"># =&gt; eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255</span>
<span class="c">#    --</span>
<span class="c">#    eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span>
<span class="c">#            inet 192.168.10.100  netmask 255.255.255.0  broadcast 192.168.10.255</span>
<span class="nv">$ </span>kubectl get node <span class="nt">-owide</span>
<span class="c"># =&gt; NAME      STATUS   ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span>
<span class="c">#    k8s-ctr   Ready    control-plane   15m   v1.33.4   192.168.10.100   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-71-generic   containerd://1.7.27</span>
<span class="c">#    k8s-w1    Ready    &lt;none&gt;          12m   v1.33.4   192.168.10.101   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-71-generic   containerd://1.7.27</span>

<span class="c"># 파드 정보 : 상태, 파드 IP 확인</span>
<span class="nv">$ </span>kubectl get nodes <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'</span>
<span class="c"># =&gt; k8s-ctr 10.244.0.0/24</span>
<span class="c">#    k8s-w1  10.244.1.0/24</span>
<span class="nv">$ </span>kubectl get ciliumnode <span class="nt">-o</span> json | <span class="nb">grep </span>podCIDRs <span class="nt">-A2</span>
<span class="c"># =&gt;                     "podCIDRs": [</span>
<span class="c">#                            "172.20.0.0/24"</span>
<span class="c">#                        ],</span>
<span class="c">#    --</span>
<span class="c">#                        "podCIDRs": [</span>
<span class="c">#                            "172.20.1.0/24"</span>
<span class="c">#                        ],</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-owide</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      READY   STATUS    RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    kube-system          cilium-2zkt5                              1/1     Running   0          12m   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-8gt4t                              1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-envoy-jhcs2                        1/1     Running   0          12m   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-envoy-txqxb                        1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          cilium-operator-7b4884dcdd-j5hnz          1/1     Running   0          15m   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          hubble-relay-fdd49b976-wdn8n              1/1     Running   0          15m   172.20.0.78      k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    kube-system          hubble-ui-655f947f96-gv9rw                2/2     Running   0          15m   172.20.0.220     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-c944v   1/1     Running   0          14m   172.20.0.176     k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE            NAME                                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-2qlch                  24463               ready            172.20.0.158</span>
<span class="c">#    kube-system          coredns-674b8bbfcf-ltzx4                  24463               ready            172.20.0.157</span>
<span class="c">#    kube-system          hubble-relay-fdd49b976-wdn8n              16977               ready            172.20.0.78</span>
<span class="c">#    kube-system          hubble-ui-655f947f96-gv9rw                40085               ready            172.20.0.220</span>
<span class="c">#    kube-system          metrics-server-5dd7b49d79-9rlxq           931                 ready            172.20.0.4</span>
<span class="c">#    local-path-storage   local-path-provisioner-74f9666bc9-c944v   9074                ready            172.20.0.176</span>

<span class="c"># ipam 모드 확인</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> ^ipam
<span class="c"># =&gt; ipam                                              cluster-pool</span>
<span class="c">#    ipam-cilium-node-update-rate                      15s</span>

<span class="c"># iptables 확인 : TPROXY 관련 규칙 찾아보자!</span>
<span class="nv">$ </span>iptables-save
<span class="nv">$ </span>iptables <span class="nt">-t</span> nat <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span>

<span class="c"># 아래 iptables 룰들은 Pod ↔ Proxy ↔ 외부/내부 서비스 트래픽이 올바르게 프록시를 거치되, 커널 conntrack에 의해 방해받지 않도록 제어 by ChatGPT</span>

<span class="nv">$ </span>iptables <span class="nt">-t</span> mangle <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nt">-i</span> proxy
<span class="c"># =&gt; # "Pod로 가는 트래픽 중 proxy를 거쳐야 하는 경우" 패킷을 식별하기 위해 마킹. 이후 TPROXY 룰에서 이 마크(0x200)를 보고 프록시로 리다이렉션.</span>
<span class="c">#    -A CILIUM_PRE_mangle ! -o lo -m socket --transparent -m mark ! --mark 0xe00/0xf00 -m mark ! --mark 0x800/0xf00 -m comment --comment "cilium: any-&gt;pod redirect proxied traffic to host proxy" -j MARK --set-xmark 0x200/0xffffffff</span>
<span class="c">#    # Pod에서 나가는 DNS 요청(UDP/TCP 53) 을 Cilium host proxy(Envoy 기반)로 강제로 보내어[TPROXY로 리다이렉션 → 127.0.0.1:38715 (Cilium DNS egress proxy 포트)] L7 정책 적용 가능하게 만듦.</span>
<span class="c">#    -A CILIUM_PRE_mangle -p tcp -m mark --mark 0xd9800200 -m comment --comment "cilium: TPROXY to host cilium-dns-egress proxy" -j TPROXY --on-port 32985 --on-ip 127.0.0.1 --tproxy-mark 0x200/0xffffffff</span>
<span class="c">#    -A CILIUM_PRE_mangle -p udp -m mark --mark 0xd9800200 -m comment --comment "cilium: TPROXY to host cilium-dns-egress proxy" -j TPROXY --on-port 32985 --on-ip 127.0.0.1 --tproxy-mark 0x200/0xffffffff</span>

<span class="nv">$ </span>iptables <span class="nt">-t</span> raw <span class="nt">-S</span> | <span class="nb">grep</span> <span class="nt">-i</span> proxy
<span class="c"># =&gt; # 프록시에서 나가는 리턴 트래픽은 NAT/conntrack이 꼬이지 않게 conntrack에서 제외. 즉, proxy ↔ pod 간 트래픽은 BPF가 직접 상태 관리.</span>
<span class="c">#    -A CILIUM_OUTPUT_raw -o lxc+ -m mark --mark 0xa00/0xfffffeff -m comment --comment "cilium: NOTRACK for proxy return traffic" -j CT --notrack</span>
<span class="c">#    -A CILIUM_OUTPUT_raw -o cilium_host -m mark --mark 0xa00/0xfffffeff -m comment --comment "cilium: NOTRACK for proxy return traffic" -j CT --notrack</span>
<span class="c">#    # L7 proxy(Envoy) → upstream(원래 목적지) 트래픽도 conntrack에서 제외.</span>
<span class="c">#    # 이유: Proxy는 자체적으로 연결 추적을 수행하므로 커널 conntrack과 이중 관리되면 충돌/성능 저하 발생.</span>
<span class="c">#    -A CILIUM_OUTPUT_raw -o lxc+ -m mark --mark 0x800/0xe00 -m comment --comment "cilium: NOTRACK for L7 proxy upstream traffic" -j CT --notrack</span>
<span class="c">#    -A CILIUM_OUTPUT_raw -o cilium_host -m mark --mark 0x800/0xe00 -m comment --comment "cilium: NOTRACK for L7 proxy upstream traffic" -j CT --notrack</span>
<span class="c">#    # 앞에서 설명한 "proxy로 리다이렉션된 트래픽" 자체도 conntrack에서 제외. </span>
<span class="c">#    # Proxy 앞뒤 트래픽 모두 커널 conntrack 대신 Cilium/BPF/Envoy가 관리.</span>
<span class="c">#    -A CILIUM_PRE_raw -m mark --mark 0x200/0xf00 -m comment --comment "cilium: NOTRACK for proxy traffic" -j CT --notrack</span>
</code></pre></div></div>

<h5 id="k8s-ctr-cilium-설치-정보-확인">[k8s-ctr] Cilium 설치 정보 확인</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium 상태 확인</span>
<span class="nv">$ </span>kubectl get cm <span class="nt">-n</span> kube-system cilium-config <span class="nt">-o</span> json | jq
<span class="nv">$ </span>cilium status
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'^loadbalancer|l7'</span>
<span class="c"># =&gt; enable-l7-proxy                                   true</span>
<span class="c">#    loadbalancer-l7                                   envoy</span>
<span class="c">#    loadbalancer-l7-algorithm                         round_robin</span>
<span class="c">#    loadbalancer-l7-ports </span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg status <span class="nt">--verbose</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system <span class="nt">-c</span> cilium-agent <span class="nt">-it</span> ds/cilium <span class="nt">--</span> cilium-dbg metrics list
</code></pre></div></div>

<h3 id="샘플-애플리케이션-배포-및-통신-문제-확인">샘플 애플리케이션 배포 및 통신 문제 확인</h3>

<h5 id="샘플-애플리케이션-배포">샘플 애플리케이션 배포</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 샘플 애플리케이션 배포</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># k8s-ctr 노드에 curl-pod 파드 배포</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>
</code></pre></div></div>

<h5 id="통신-확인">통신 확인</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 배포 확인</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   2/2     2            2           27s   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.234.83   &lt;none&gt;        80/TCP    27s   app=webpod</span>
<span class="c">#    NAME               ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/webpod   172.20.0.111:80,172.20.1.212:80   27s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="c"># IP 확인</span>
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  10893               ready            172.20.0.209</span>
<span class="c">#    webpod-697b545f57-gsp8r   11530               ready            172.20.1.212</span>
<span class="c">#    webpod-697b545f57-pwvhp   11530               ready            172.20.0.111</span>

<span class="c"># 통신 문제 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 webpod | <span class="nb">grep </span>Hostname
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-gsp8r</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-pwvhp</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-pwvhp</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 통신 문제가 없습니다!&lt;/span&gt;</span>

<span class="c"># cilium-dbg, map</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg ip list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg endpoint list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg service list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf lb list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf nat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map list | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'0             0'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_services_v2
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_backends_v3
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_reverse_nat
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_ipcache_v2
</code></pre></div></div>

<h5 id="pwru-간단-실습">pwru 간단 실습</h5>

<ul>
  <li>로우레벨의 정보까지 모니터링 가능한 pwru(Packet, Where Are You)를 통해 차단 이유를 확인해 보는 실습을 진행해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 다운로드 https://github.com/cilium/pwru/releases : script 로 다운로드 되어 있음.</span>
<span class="nv">$ </span>wget https://github.com/cilium/pwru/releases/download/v1.0.10/pwru-linux-arm64.tar.gz
<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xvzf</span> pwru-linux-arm64.tar.gz
<span class="nv">$ </span><span class="nb">mv </span>pwru /usr/bin
<span class="nv">$ </span>pwru <span class="nt">-h</span>

<span class="c"># 1.1.1.1 목적지 차단 설정</span>
<span class="nv">$ </span>iptables <span class="nt">-t</span> filter <span class="nt">-I</span> OUTPUT 1 <span class="nt">-m</span> tcp <span class="nt">--proto</span> tcp <span class="nt">--dst</span> 1.1.1.1/32 <span class="nt">-j</span> DROP

<span class="c"># curl 호출 : 아래 모니터링 후 호출</span>
<span class="nv">$ </span>curl 1.1.1.1 <span class="nt">-v</span>

<span class="c"># pwru 모니터링 : 차단 이유 확인! SKB_DROP_REASON_NETFILTER_DROP </span>
<span class="nv">$ </span>pwru <span class="s1">'dst host 1.1.1.1 and tcp and dst port 80'</span>
<span class="c"># =&gt; 2025/08/21 23:45:36 Attaching kprobes (via kprobe)...</span>
<span class="c">#    1667 / 1667 [----------------------------------------------------------] 100.00% 1270 p/s</span>
<span class="c">#    2025/08/21 23:45:38 Attached (ignored 5)</span>
<span class="c">#    2025/08/21 23:45:38 Listening for events..</span>
<span class="c">#    SKB                CPU PROCESS          NETNS      MARK/x        IFACE       PROTO  MTU   LEN   TUPLE FUNC</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0000 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __ip_local_out</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) nf_hook_slow</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) </span>
<span class="c">#       kfree_skb_reason(&lt;span style="color: green;"&gt;SKB_DROP_REASON_NETFILTER_DROP&lt;/span&gt;)</span>
<span class="c">#       &lt;span style="color: green;"&gt;👉 NETFILER에 의해 차단(DROP)됨을 확인할 수 있습니다.&lt;/span&gt;</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) skb_release_head_state</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) tcp_wfree</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) skb_release_data</span>
<span class="c">#    0xffff000004cb58e8 3   ~r/bin/curl:8493 4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) kfree_skbmem</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __skb_clone</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        0          0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __copy_skb_header</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0000 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __ip_local_out</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) nf_hook_slow</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) </span>
<span class="c">#       kfree_skb_reason(&lt;span style="color: green;"&gt;SKB_DROP_REASON_NETFILTER_DROP&lt;/span&gt;)</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) skb_release_head_state</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) tcp_wfree</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) skb_release_data</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) kfree_skbmem</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __skb_clone</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        0          0               0         0x0800 0     60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __copy_skb_header</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0000 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) __ip_local_out</span>
<span class="c">#    0xffff000004cb58e8 3   &lt;empty&gt;:0        4026531840 0               0         0x0800 1500  60    10.0.2.15:60880-&gt;1.1.1.1:80(tcp) nf_hook_slow</span>
<span class="c">#    ^C2025/08/21 23:46:14 Received signal, exiting program..</span>
<span class="c">#    2025/08/21 23:46:14 Detaching kprobes...</span>
<span class="c">#    1662 / 1662 [------------------------------------------------------------------------------------------------------------------------------------------------------] 100.00% 33 p/s</span>
</code></pre></div></div>

<ul>
  <li>통신이 잘 되는것을 확인하였고, 기본적인 점검을 마쳤으니 본격적으로 Cilium의 기능을 살펴보도록 하겠습니다.</li>
</ul>

<hr>

<h2 id="cilium-service-mesh">Cilium Service Mesh</h2>

<h3 id="service-mesh-소개">Service Mesh 소개</h3>

<ul>
  <li>Service Mesh는 마이크로서비스 아키텍처에서 서비스 간의 통신을 관리하고 모니터링하기 위한 인프라 계층입니다. 주로 L7 트래픽 관리, 보안, 모니터링, 로깅 등을 제공합니다.</li>
  <li>등장 배경
    <ul>
      <li>기존에 하나의 모놀리식 애플리케이션이나 소수의 큰 서비스로 구성된 시스템에서는 서비스 간의 통신을 관리하기가 상대적으로 쉬웠습니다.</li>
      <li>하지만 적게는 수십개, 많게는 수천개의 마이크로서비스가 존재하는 Micro Service Architecture 환경에서는 서비스 간의 통신을 관리하고 모니터링하기가 매우 복잡해집니다.</li>
      <li>MSA가 점점 보편화 됨에 따라 서비스 간의 통신을 관리하고 모니터링하기 위해 다음과 같은 기능이 필요하게 되었습니다.
        <ul>
          <li>
<strong>서비스 디스커버리</strong> : 서비스가 동적으로 생성되고 삭제되기 때문에, 서비스의 IP 주소나 포트등을 자동으로 찾아주는 기능</li>
          <li>
<strong>모니터링</strong> : 서비스 간의 통신을 모니터링하고 성능을 측정하는 기능</li>
          <li>
<strong>로깅</strong> : 서비스 간의 통신을 로깅하고 분석</li>
          <li>
<strong>트래픽 관리</strong> : 서비스 간의 트래픽을 제어하고 관리하는 기능. Traffic Shifting, Circuit Breaker, Rate Limiting, Fault Injection 등의 기능을 포함</li>
          <li>
<strong>보안</strong> : 서비스 간의 통신을 암호화하고 인증하는 기능</li>
          <li>
<strong>정책 관리</strong> : 서비스 간의 통신을 제어하고 모니터링하기 위한 정책을 관리하는 기능</li>
        </ul>
      </li>
      <li>이러한 기능들을 서비스 단위로 언어별로 구현해야 했기에 복잡도가 증가하고, 코드 중복이 발생하게 됩니다.</li>
      <li>Service Mesh는 이러한 문제를 해결하기 위해 서비스 간의 통신을 관리하고 모니터링하기 위한 인프라 계층을 제공합니다. 
이를 통해 개발자는 비즈니스 로직에 집중할 수 있고, 운영자는 서비스 간의 통신을 관리하고 모니터링하기가 쉬워집니다.</li>
    </ul>
  </li>
  <li>대표적인 Service Mesh에는 <strong>Istio</strong>, <strong>Linkerd</strong>, <strong>Consul</strong> 등이 있고, Cilium에서도 <strong>Cilium Service Mesh</strong>로 Service Mesh 기능을 제공합니다.</li>
</ul>

<h5 id="기본-동작">기본 동작</h5>

<ul>
  <li>파드간 통신 경로에 프록시를 두고, 트래픽을 모니터링하고 제어하는 방식으로 동작합니다. 따라서 <strong>기존 애플리케이션 코드 변경 없이</strong>도 Service Mesh 기능을 사용할 수 있습니다.
    <ol>
      <li>기존 통신 환경
  <img src="/assets/2025/cilium/w6/20250824_cilium_w6_1.png" alt="img.png" class="image-center w-70 image-bg" loading="lazy" width="1837" height="320">
</li>
      <li>Proxy를 도입하여, 애플리케이션 수정없이 모든 애플리케이션 통신을 프록시를 거치도록 합니다.
  <img src="/assets/2025/cilium/w6/20250824_cilium_w6_2.png" alt="img_1.png" class="image-center w-70 image-bg" loading="lazy" width="1837" height="449">
        <ul>
          <li>파드 내에 사이드카 컨테이너로 주입되어서 동작합니다.</li>
          <li>Proxy 컨테이너가 애플리케이션 트래픽을 가로채고, 이를 처리합니다.</li>
        </ul>
      </li>
      <li>Proxy는 DataPlane 역할을 하며, 이를 중앙에서 관리하는 ControlPlane을 두고 중앙에서 정책을 관리합니다.
  <img src="/assets/2025/cilium/w6/20250824_cilium_w6_3.png" alt="img_2.png" class="image-center w-70 image-bg" loading="lazy" width="1837" height="880">
        <ul>
          <li>Proxy는 ControlPlane에서 설정을 관리하며, 설정관리가 유연하고 풍부한 API를 지원합니다.</li>
          <li>대표적인 Service Mesh의 Proxy로는 Google, Ibm, Lyft가 중심이 되어 개발하고있는 Envoy가 있습니다.
            <ul>
              <li>네트워크 투명성을 목표로 하며, 다양한 필터체인 (L3/L4, HTTP L7)을 지원하며, 동적 구성 API, API 기반 hot reload를 제공합니다.</li>
            </ul>
          </li>
        </ul>
      </li>
    </ol>
  </li>
  <li>
<strong>트래픽 모니터링</strong> : 요청의 에러율, 지연(latency), 컨넥션 개수, 요청 개수 등의 메트릭을 모니터링하며, 특정 서비스간 혹은 특정 요청 경로를 필터링해서 모니터링 할 수 있습니다.</li>
  <li>
<strong>트래픽 컨트롤</strong>
    <ul>
      <li>트래픽 시프팅(Traffic shifting) : 예시) 99% 기존앱 + 1% 신규앱, 특정 단말/사용자는 신규앱에 전달하여 단계적으로 적용하는 카나리 배포 기능</li>
      <li>서킷 브레이커(Circuit Breaker) : 목적지 마이크로서비스에 문제가 있을 시 접속을 차단하고 출발지 마이크로서비스에 요청 에러를 반환하여 연쇄 장애, 시스템 전제 장애 예방합니다.</li>
      <li>폴트 인젝션(Fault Injection) : 의도적으로 요청을 지연 혹은 실패를 구현합니다.</li>
      <li>속도 제한(Rate Limit) : 요청 개수를 제한하여 서비스가 과부하와 리소스 고갈을 방지합니다.</li>
    </ul>
  </li>
</ul>

<h3 id="cilium-service-mesh-소개">Cilium Service Mesh 소개</h3>

<ul>
  <li>
<a href="https://docs.cilium.io/en/stable/network/servicemesh/">Docs</a>, <a href="https://www.youtube.com/watch?v=lZskwr3uXn8">Youtube</a>
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_4.png" alt="img.png" loading="lazy" width="960" height="487">
</li>
  <li>Cilium Service Mesh는 Cilium의 eBPF 기반 네트워킹(L3/L4 담당)과 Envoy Proxy(L7 담당)를 결합하여 강력하고 유연한 Service Mesh 솔루션을 제공합니다.</li>
  <li>
<strong>L3/L4 수준 프로토콜</strong> : eBPF가 수행
    <ul>
      <li>IP, TCP, UDP 등 L3/L4 프로토콜을 지원하며, Cilium의 eBPF 기반 네트워킹 기능을 활용하여 고성능 트래픽 처리를 제공합니다.</li>
      <li>위의 그림에서 보듯이, 기존의 Service Mesh는 L3/L4 트래픽을 처리하기 위해 iptables를 사용하고, 사이드카와 VETH를 통해서 
트래픽을 가로채고 처리합니다. 이렇게 되면 TCP/IP 스택을 파드를 떠나기 전까지만도 3번이나 탐색해야 했습니다.</li>
      <li>Cilium Service Mesh는 eBPF를 통해 Proxy를 Host와 Kernel로 이동하고 사이드카를 제거하여, 
트래픽을 가로채고 처리하는데 필요한 오버헤드를 최소화합니다.</li>
    </ul>
  </li>
  <li>
<strong>L7 수준 프로토콜</strong> : Envoy Proxy가 수행
    <ul>
      <li>HTTP, Kafka, gRPC, DNS와 같은 애플리케이션 계층 프로토콜은 Envoy Proxy를 통해 처리됩니다.
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_5.png" alt="img.png" loading="lazy" width="1090" height="627">
</li>
      <li>Cilium은 이미 타 Service Mesh에서 사이드카 형태로 사용하는 Envoy를 L7 정책이나 관측성(Observability) 기능을 위해 사용하고 있었습니다.</li>
      <li>이미 Cilium이 Envoy를 사용하고 있기 때문에 자연스럽게 Service Mesh 기능을 추가할 수 있었습니다.</li>
      <li>특히 다른 Service Mesh와 달리 Cilium Service Mesh는 Node당 하나의 Envoy Proxy만을 사용합니다.
        <ul>
          <li>istiod의 Ambient 모드와 유사하지만, Cilium의 CNI 기능을 활용하여 더 효율적이고 통합된 구성을 제공합니다.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
<strong>제공 기능</strong>
    <ul>
      <li>
<strong>탄력적인 연결성(Resilient Connectivity)</strong>: 서비스 간 통신은 클라우드, 클러스터, 온프레미스 등 경계를 넘어 가능해야 하며, 통신은 <strong>탄력적</strong>이고 <strong>장애 허용</strong>이 가능해야 합니다.</li>
      <li>
<strong>L7 트래픽 관리(L7 Traffic Management)</strong>: 로드 밸런싱, 속도 제한, 장애 복원력 등은 L7(HTTP, REST, gRPC, WebSocket 등)을 인식해야 합니다.</li>
      <li>
<strong>ID 기반 보안(Identity-based Security)</strong>: 네트워크 식별자에만 의존하는 보안은 더 이상 충분하지 않으며, 송신 및 수신 서비스 모두 네트워크 식별자가 아닌 ID 기반으로 상호 인증할 수 있어야 합니다.</li>
      <li>
<strong>관측성 및 트레이싱(Observability &amp; Tracing)</strong>: 트레이싱과 메트릭 형태의 관측성은 애플리케이션의 안정성, 성능, 가용성을 이해하고 모니터링하며 문제를 해결하는 데 매우 중요합니다.</li>
      <li>
<strong>투명성(Transparency)</strong>: 이 기능들은 애플리케이션 코드를 변경하지 않고도 투명하게 제공되어야 합니다.</li>
    </ul>
  </li>
</ul>

<hr>

<h2 id="k8s-ingress-support">K8S Ingress Support</h2>

<h3 id="cilium-k8s-ingress-support-소개">Cilium K8S Ingress Support 소개</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress/">관련문서</a></li>
  <li>Cilium은 Kubernetes Ingress resource definition을 지원하며 <code class="language-plaintext highlighter-rouge">ingressClassName</code>을 cilium으로 지정함으로써 사용할 수 있습니다.</li>
  <li>경로 기반 라우팅과 TLS termination을 지원합니다. 하위 호환을 위해서 <code class="language-plaintext highlighter-rouge">kubernetes.io/ingress.class</code>을 cilium으로 설정할 수도 있습니다.</li>
  <li>Cilium Ingress Controller는 LoadBalancer Type의 Service로 배포되기 때문에, LoadBalancer를 지원하는 환경을 필요로 합니다.</li>
  <li>Cilium은 로드밸런서 모드를 다음 중 하나로 설정할 수 있습니다. 각 모드는 장단점이 있기 때문에 사용 환경에 따라 적절한 모드를 선택해야 합니다.
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">dedicated</code> : 해당 ingress를 위해서 단독 로드밸런서를 사용합니다. 각 ingress마다 별도의 로드밸런서를 사용하기 때문에, 충돌이 발생하지 않습니다. 하지만 자원 낭비가 발생할 수 있습니다.</li>
      <li>
<code class="language-plaintext highlighter-rouge">shared</code> : 모든 ingress들이 하나의 공통 로드밸런서를 공유합니다. 자원은 절약하지만 path prefix 충돌이 발생할 수 있습니다.</li>
    </ul>
  </li>
  <li>로드밸런서 모드는 변경이 가능하지만, 변경을 위해서는 LB IP 주소가 변경되어야 합니다. 따라서, 변경시 연결이 종료되며, 다운타임이 발생할 수 있습니다.</li>
</ul>

<h5 id="필수-조건">필수 조건</h5>

<ul>
  <li>Cilium은 <code class="language-plaintext highlighter-rouge">nodePort.enabled=true</code>로 설정되어 NodePort가 활성화되어 있거나 <code class="language-plaintext highlighter-rouge">kubeProxyReplacement=true</code>를 통해 kube-proxy를 대체하는 경우에만 Ingress를 지원합니다.</li>
  <li>
<code class="language-plaintext highlighter-rouge">l7Proxy=true</code>로 설정해서 L7 Proxy를 활성화해야 합니다. (기본값)</li>
  <li>기본적으로 LoadBalancer 타입의 Service로 배포되기 때문에, LoadBalancer를 지원하는 환경이 필요합니다. 다른 방법으로는 NodePort를 사용하거나, Cilium 1.16 이상 버전에서는 <a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress/#gs-ingress-host-network-mode">host network</a>에 L7 Proxy를 배포할 수 있습니다.</li>
</ul>

<h5 id="cilium-ingress와-cilium-gateway-api의-다른-ingress-controller와의-차이점">Cilium Ingress와 Cilium Gateway API의 다른 Ingress Controller와의 차이점</h5>

<ul>
  <li>
<strong>CNI와의 밀접한 연결</strong> : 다른 Ingress Controller는 CNI와 독립적으로 동작하지만, Cilium Ingress는 Cilium CNI와 밀접하게 통합되어 있습니다.</li>
  <li>
<strong>eBPF와 TPROXY를 사용하여 투명하게 Envoy에 전달</strong> : 다른 Ingress Controller는 iptables를 사용하여 단순 포트포워딩을 통해 트래픽을 가로채지만, Cilium Ingress는 eBPF와 TPROXY를 사용하여 트래픽을 Envoy에 투명하게 전달합니다. 이를 통해 성능과 확장성이 향상됩니다.
    <ul>
      <li>이를 통해 Client IP Visibility 같은 문제를 해결 할 수 있으며, Cilium의 네트워크 정책 엔진이 Ingress를 통해 들어오는 트래픽에 Cilium Network Policy를 적용할 수 있도록 해줍니다.</li>
      <li>동작 경로 : - [Client] → [K8s Node:Ingress/Gateway Service Port] → (eBPF Service LB) → (TPROXY) → [Envoy Proxy (Pod)]
→ (L7 라우팅/정책 처리) → (eBPF) → [Backend Pod]</li>
    </ul>
  </li>
</ul>

<h5 id="cilium-ingress-구성-및-cilium-network-policy">Cilium Ingress 구성 및 Cilium Network Policy</h5>

<ul>
  <li>노드별 Envoy Proxy에 NetworkPolicy를 적용할 수 있습니다.</li>
  <li>Cilium을 통해 각 백엔드 서비스로 전송되는 Ingress와 Gateway API 트래픽은 각 노드별 Envoy Proxy를 통해 처리됩니다.</li>
  <li>노드별 Envoy Proxy는 eBPF 정책 엔진과 상호작용할 수 있는 특수한 코드를 갖고 있으며, 트래픽에 대해 정책을 적용할 수 있습니다.
이를 통해 Envoy는 Ingress와 Gateway API 트래픽, east-west 트래픽에 대해서 Network Policy Enforcement Point로 작동할 수 있습니다.</li>
  <li>Envoy에 도착한 트래픽은 Cilium의 정책 엔진이 부여한 특수 ingress ID를 할당 받습니다.</li>
  <li>클러스터 외부에서 들어오는 트래픽은 일반적으로 클러스터에 (IP CIDR 정책이 없는 한) world identity가 할당 됩니다.</li>
  <li>이는 실제로 Cilium Ingress에 두개의 논리적 정책 집행 지점이 있다는것을 의미합니다.</li>
  <li>즉, ingress identity에 트래픽이 도착하기 전과 노드별 Envoy를 통해 백엔드 서비스로 전달되기 전입니다.
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_6.png" alt="img.png" loading="lazy" width="1311" height="316">
</li>
  <li>이는 네트워크 정책을 클러스터에 적용할때 world에서 ingress로 들어갈때도 허용(allow)하고, ingress에서 클러스터의 identities (위의 그림에서는 productpage identity)로 전달될때도 동시에 허용(allow)해야 한다는 것을 의미합니다.
Gateway API에서도 동일합니다.</li>
</ul>

<h5 id="source-ip-visibility">Source IP Visibility</h5>

<ul>
  <li>기본값으로 Cilium의 Envoy는 클라이언트의 IP 주소를 <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code> 헤더에 추가하여 
백엔드 서비스로 전달합니다. 이를 통해 백엔드 서비스는 클라이언트의 실제 IP 주소를 알 수 있습니다.</li>
  <li>
<code class="language-plaintext highlighter-rouge">trusted hops</code>를 <code class="language-plaintext highlighter-rouge">0</code>을 기본값으로 설정하여, Envoy가 <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code>헤더의 값을 보는 대신, 연결이 시작된 실제 클라이언트 IP를 사용합니다.</li>
  <li>즉, <code class="language-plaintext highlighter-rouge">trusted hops</code>를 증가 시킴으로써 Envoy가 <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code>의 오른쪽 부터 수를 세는 n번째 항목을 사용하게 할 수 있습니다.</li>
  <li>Envoy는 또한 <code class="language-plaintext highlighter-rouge">X-Envoy-External-Address</code> 헤더를 사용하여 <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code>를 기반으로한 신뢰할 수 있는 클라이언트의 주소를 전달합니다.</li>
</ul>

<h5 id="tls-passthrough와-source-ip-visibility">TLS Passthrough와 Source IP Visibility</h5>

<ul>
  <li>Ingress와 Gateway API는 모두 TLS Passthrough 구성을 지원합니다. (Ingress는 annotation을 통해, Gateway API는 <code class="language-plaintext highlighter-rouge">TLSRoute</code> 리소스를 통해 지원합니다.)</li>
  <li>이 구성을 통해 여러 TLS Passthrough 백엔드가 Load Balancer에서 동일한 TLS 포트를 공유 할 수 있으며, Envoy는 TLS 핸드셰이크의
서버 이름 표시기(SNI)를 기반으로 백엔드를 선택합니다.</li>
  <li>동작방식 : TLS 트래픽 -&gt; Envoy에 도착 -&gt; TCP 스트림 종료 -&gt; Envoy가 클라이언트 hello를 검사하여 SNI를 찾고 백엔드 선택 -&gt; <strong>✨새로운 TCP 스트림 시작</strong> 
-&gt; 다운스트림(외부) 패킷 내부의 TLS 트래픽을 업스트림(백엔드)로 전달</li>
  <li>하지만 이러한 동작은 Source IP Visibility 문제를 발생시킬수 있습니다. 왜냐하면 Envoy가 TLS 스트림의 TCP 프록시를 수행하고 있기 때문입니다.</li>
  <li>새로운 TCP 스트림이 생기기 때문에 백엔드에서 바라본 소스 IP는 Envoy(Cilium 구성에 따라 Node IP인 경우가 많음)입니다.</li>
  <li>즉, TLS Passthrough를 사용하면 백엔드는 Envoy의 IP 주소를 소스 IP로 받게되는 문제가 발생합니다.</li>
</ul>

<h5 id="ingress-path-type과-우선순위">Ingress Path Type과 우선순위</h5>

<ul>
  <li>Ingress 규격은 다음의 세가지 타입의 경로를 지원합니다.
    <ul>
      <li>정확한 값 (<code class="language-plaintext highlighter-rouge">Exact</code>) : 경로가 정확히 일치해야 합니다.</li>
      <li>접두사 (<code class="language-plaintext highlighter-rouge">Prefix</code>) : 경로가 <code class="language-plaintext highlighter-rouge">/</code>로 구분되는 지정된 접두사로 시작해야 합니다.
        <ul>
          <li>마지막 부분은 온전히 동일해야 합니다. 예를들어서 prefix가 <code class="language-plaintext highlighter-rouge">/foo/bar</code>인 경우 <code class="language-plaintext highlighter-rouge">/foo/bar/baz</code>는 일치하지만 <code class="language-plaintext highlighter-rouge">/foo/barbaz</code>는 일치하지 않습니다.</li>
        </ul>
      </li>
      <li>구현 종속 (<code class="language-plaintext highlighter-rouge">ImplementationSpecific</code>) : Ingress Controller에 따라 다르게 동작합니다.
        <ul>
          <li>Cilium Ingress의 경우에는 <code class="language-plaintext highlighter-rouge">Regex</code>, 즉, 정규표현식을 의미합니다.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ingress에 대해서 여러 경로가 구성되어있으면 다음의 순서로 매칭합니다
    <ol>
      <li>정확한 값 (<code class="language-plaintext highlighter-rouge">Exact</code>)</li>
      <li>구현 종속 (<code class="language-plaintext highlighter-rouge">ImplementationSpecific</code>)</li>
      <li>접두사 (<code class="language-plaintext highlighter-rouge">Prefix</code>)</li>
      <li>
<code class="language-plaintext highlighter-rouge">/</code> 접두사 처리</li>
    </ol>
  </li>
  <li>또한 동일한 경로 타입인 경우 경로의 길이가 긴 경로가 우선순위가 높습니다. 예를들어서 <code class="language-plaintext highlighter-rouge">/foo/bar</code>와 <code class="language-plaintext highlighter-rouge">/foo</code>가 있을때 <code class="language-plaintext highlighter-rouge">/foo/bar</code>가 우선순위가 높습니다.</li>
  <li>만약 구현 종속 방식을 사용한다면 <code class="language-plaintext highlighter-rouge">*</code>을 사용할때 주의가 필요합니다. <code class="language-plaintext highlighter-rouge">*</code>문자로 인해서 길이가 길어지지만, 실제 매칭되는 경로는 더 짧을 수 있습니다.
    <ul>
      <li>예를들어서 <code class="language-plaintext highlighter-rouge">/foo/bar/</code>와 <code class="language-plaintext highlighter-rouge">/foo/bar/*</code>가 있을때, <code class="language-plaintext highlighter-rouge">/foo/bar/*</code>는 <code class="language-plaintext highlighter-rouge">/foo/bar/</code>에도 매칭이 되지만, 길이가 길어서 
<code class="language-plaintext highlighter-rouge">/foo/bar/</code>보다 우선순위가 높습니다. 이러한 경우 엉뚱한 백엔드로 트래픽이 전달될 수 있으니 주의해야 합니다.</li>
    </ul>
  </li>
  <li>추가적인 사항은 문서를 참고하시기 바랍니다. <a href="https://docs.cilium.io/en/stable/network/servicemesh/path-types/#gs-ingress-path-types">Docs</a>
</li>
</ul>

<h5 id="ebpf-datapath--ingress-to-endpoint">eBPF Datapath : Ingress to Endpoint</h5>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_7.png" alt="img.png" class="image-center image-bg" loading="lazy" width="1626" height="783">
<em class="image-caption"><a href="https://docs.cilium.io/en/stable/network/ebpf/lifeofapacket/#ingress-to-endpoint">https://docs.cilium.io/en/stable/network/ebpf/lifeofapacket/#ingress-to-endpoint</a></em></p>

<ul>
  <li>
<a href="https://docs.cilium.io/en/stable/network/ebpf/">참고 문서</a>, <a href="https://www.youtube.com/watch?v=0BKU6avwS98">Youtube</a>
</li>
</ul>

<h5 id="cilium-k8s-ingress-support-관련-정보-확인">Cilium K8S Ingress Support 관련 정보 확인</h5>

<ul>
  <li>Cilium Ingress와  Cilium Gateway API는 동시 활성화가 불가능합니다. 단, 다른 Ingress Controller와 Cilium Gateway API는 함께 사용할 수 있습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cilium 설치 시 아래 파라미터 적용되어 있음</span>
<span class="c">## --set ingressController.enabled=true</span>
<span class="c">## --set ingressController.loadbalancerMode=shared</span>
<span class="c">## --set loadBalancer.l7.backend=envoy \</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'^loadbalancer|l7'</span>
<span class="c"># =&gt; enable-l7-proxy                                   true</span>
<span class="c">#    loadbalancer-l7                                   envoy</span>
<span class="c">#    loadbalancer-l7-algorithm                         round_robin</span>
<span class="c">#    loadbalancer-l7-ports</span>

<span class="c"># ingress 에 예약된 내부 IP 확인 : node(cilium-envoy) 별로 존재</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium ip list | <span class="nb">grep </span>ingress
<span class="c"># =&gt; 172.20.0.16/32      reserved:ingress</span>
<span class="c">#    172.20.1.60/32      reserved:ingress</span>

<span class="c"># cilium-envoy 확인</span>
<span class="nv">$ </span>kubectl get ds <span class="nt">-n</span> kube-system cilium-envoy <span class="nt">-owide</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium-envoy <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                 READY   STATUS    RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    cilium-envoy-b25zf   1/1     Running   0          2m50s   192.168.10.101   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    cilium-envoy-hpsbc   1/1     Running   0          4m37s   192.168.10.100   k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>

<span class="nv">$ </span>kc describe pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium-envoy
<span class="c"># =&gt; ...</span>
<span class="c">#    Containers:</span>
<span class="c">#      cilium-envoy:</span>
<span class="c">#        Container ID:  containerd://db82015552f31d7a16d8cada0883cdc7a4f75d39f36e76e0c582b10b1f3988e4</span>
<span class="c">#        Image:         quay.io/cilium/cilium-envoy:v1.34.4-1754895458-68cffdfa568b6b226d70a7ef81fc65dda3b890bf@sha256:247e908700012f7ef56f75908f8c965215c26a27762f296068645eb55450bda2</span>
<span class="c">#        Image ID:      quay.io/cilium/cilium-envoy@sha256:247e908700012f7ef56f75908f8c965215c26a27762f296068645eb55450bda2</span>
<span class="c">#        Port:          9964/TCP</span>
<span class="c">#        Host Port:     9964/TCP</span>
<span class="c">#        Command:</span>
<span class="c">#          /usr/bin/cilium-envoy-starter</span>
<span class="c">#        Args:</span>
<span class="c">#          --</span>
<span class="c">#          -c /var/run/cilium/envoy/bootstrap-config.json</span>
<span class="c">#          --base-id 0</span>
<span class="c">#        ...</span>
<span class="c">#        Mounts:</span>
<span class="c">#          /sys/fs/bpf from bpf-maps (rw)</span>
<span class="c">#          /var/run/cilium/envoy/ from envoy-config (ro)</span>
<span class="c">#          /var/run/cilium/envoy/artifacts from envoy-artifacts (ro)</span>
<span class="c">#          /var/run/cilium/envoy/sockets from envoy-sockets (rw)</span>
<span class="c">#          /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-jxsqh (ro)</span>
<span class="c">#    ...</span>
<span class="c">#    Volumes:</span>
<span class="c">#      envoy-sockets:</span>
<span class="c">#        Type:          HostPath (bare host directory volume)</span>
<span class="c">#        Path:          /var/run/cilium/envoy/sockets</span>
<span class="c">#        HostPathType:  DirectoryOrCreate</span>
<span class="c">#      envoy-artifacts:</span>
<span class="c">#        Type:          HostPath (bare host directory volume)</span>
<span class="c">#        Path:          /var/run/cilium/envoy/artifacts</span>
<span class="c">#        HostPathType:  DirectoryOrCreate</span>
<span class="c">#      envoy-config:</span>
<span class="c">#        Type:      ConfigMap (a volume populated by a ConfigMap)</span>
<span class="c">#        Name:      cilium-envoy-config</span>
<span class="c">#        Optional:  false</span>
<span class="c">#      bpf-maps:</span>
<span class="c">#        Type:          HostPath (bare host directory volume)</span>
<span class="c">#        Path:          /sys/fs/bpf</span>
<span class="c">#        HostPathType:  DirectoryOrCreate</span>
<span class="c">#      kube-api-access-jxsqh:</span>
<span class="c">#        Type:                    Projected (a volume that contains injected data from multiple sources)</span>
<span class="c">#        TokenExpirationSeconds:  3607</span>
<span class="c">#        ConfigMapName:           kube-root-ca.crt</span>
<span class="c">#        Optional:                false</span>
<span class="c">#        DownwardAPI:             true</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /var/run/cilium/envoy/sockets
<span class="c"># =&gt; ...</span>
<span class="c">#    srw-rw---- 1 root 1337   0 Aug 23 14:20 access_log.sock</span>
<span class="c">#    srwxr-xr-x 1 root root   0 Aug 23 14:19 admin.sock</span>
<span class="c">#    drwxr-xr-x 3 root root  60 Aug 23 14:20 envoy</span>
<span class="c">#    srw-rw---- 1 root 1337   0 Aug 23 14:20 xds.sock</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium-envoy <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-al</span> /var/run/cilium/envoy
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium-envoy <span class="nt">--</span> <span class="nb">cat</span> /var/run/cilium/envoy/bootstrap-config.json
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium-envoy <span class="nt">--</span> <span class="nb">cat</span> /var/run/cilium/envoy/bootstrap-config.json <span class="o">&gt;</span> envoy.json
<span class="nv">$ </span><span class="nb">cat </span>envoy.json | jq

<span class="c"># envoy configmap 설정 내용 확인</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get configmap cilium-envoy-config
<span class="c"># =&gt; NAME                  DATA   AGE</span>
<span class="c">#    cilium-envoy-config   1      7m54s</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get configmap cilium-envoy-config <span class="nt">-o</span> json <span class="se">\</span>
  | jq <span class="nt">-r</span> <span class="s1">'.data["bootstrap-config.json"]'</span> <span class="se">\</span>
  | jq <span class="nb">.</span>
<span class="c"># =&gt; ...</span>
<span class="c">#      "admin": {</span>
<span class="c">#        "address": {</span>
<span class="c">#          "pipe": {</span>
<span class="c">#            "path": "/var/run/cilium/envoy/sockets/admin.sock"</span>
<span class="c">#          }</span>
<span class="c">#        }</span>
<span class="c">#      },</span>
<span class="c">#    ...</span>
<span class="c">#        "listeners": [</span>
<span class="c">#          {</span>
<span class="c">#            "address": {</span>
<span class="c">#              "socketAddress": {</span>
<span class="c">#                "address": "0.0.0.0",</span>
<span class="c">#                "portValue": 9964  </span>
<span class="c">#    ...</span>

<span class="nv">$ </span>tree /sys/fs/bpf
<span class="c"># =&gt; /sys/fs/bpf</span>
<span class="c">#    ├── cilium</span>
<span class="c">#    │   ├── devices</span>
<span class="c">#    │   │   ├── cilium_host</span>
<span class="c">#    │   │   │   └── links</span>
<span class="c">#    │   │   │       ├── cil_from_host</span>
<span class="c">#    │   │   │       └── cil_to_host</span>
<span class="c">#    │   │   ├── cilium_net</span>
<span class="c">#    │   │   │   └── links</span>
<span class="c">#    │   │   │       └── cil_to_host</span>
<span class="c">#    │   │   ├── eth0</span>
<span class="c">#    │   │   │   └── links</span>
<span class="c">#    │   │   │       ├── cil_from_netdev</span>
<span class="c">#    │   │   │       └── cil_to_netdev</span>
<span class="c">#    │   │   └── eth1</span>
<span class="c">#    │   │       └── links</span>
<span class="c">#    │   │           ├── cil_from_netdev</span>
<span class="c">#    │   │           └── cil_to_netdev</span>
<span class="c">#    │   ├── endpoints</span>
<span class="c">#    │   │   ├── 1019</span>
<span class="c">#    │   │   │   └── links</span>
<span class="c">#    │   │   │       ├── cil_from_container</span>
<span class="c">#    │   │   │       └── cil_to_container</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> kube-system cilium-envoy
<span class="c"># =&gt; NAME                   TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/cilium-envoy   ClusterIP   None         &lt;none&gt;        9964/TCP   9m24s</span>
<span class="c">#    </span>
<span class="c">#    NAME                     ENDPOINTS                                 AGE</span>
<span class="c">#    endpoints/cilium-envoy   192.168.10.100:9964,192.168.10.101:9964   9m22s</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-n</span> kube-system cilium-ingress
<span class="c"># =&gt; NAME                     TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE</span>
<span class="c">#    service/cilium-ingress   LoadBalancer   10.96.58.190   &lt;pending&gt;     80:32243/TCP,443:30329/TCP   9m35s</span>
<span class="c">#    </span>
<span class="c">#    NAME                       ENDPOINTS              AGE</span>
<span class="c">#    endpoints/cilium-ingress   192.192.192.192:9999   9m35s  # Cilium → Envoy 간의 제어 채널(Control Plane), 외부 클라이언트가 접근하는 데이터 채널이 아님 </span>
</code></pre></div></div>

<h5 id="lb-ipam-설정-후-확인--ciliuml2announcementpolicy">LB-IPAM 설정 후 확인 : CiliumL2AnnouncementPolicy</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 현재 L2 Announcement 활성화 상태</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>l2
<span class="c"># =&gt; enable-l2-announcements                           true</span>
<span class="c">#    enable-l2-neigh-discovery                         false</span>

<span class="c"># 충돌나지 않는지 대역 확인 할 것!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2" 
kind: CiliumLoadBalancerIPPool
metadata:
  name: "cilium-lb-ippool"
spec:
  blocks:
  - start: "192.168.10.211"
    stop:  "192.168.10.215"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumloadbalancerippool.cilium.io/cilium-lb-ippool created</span>
<span class="nv">$ </span>kubectl get ippool
<span class="c"># =&gt; NAME               DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span>
<span class="c">#    cilium-lb-ippool   false      False         4               7s</span>
<span class="nv">$ </span>kubectl get ippools <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].status.conditions[?(@.type!="cilium.io/PoolConflict")]}'</span> | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "lastTransitionTime": "2025-08-23T06:40:43Z",</span>
<span class="c">#      "message": "5",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsTotal"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "lastTransitionTime": "2025-08-23T06:40:43Z",</span>
<span class="c">#      "message": "4",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsAvailable"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "lastTransitionTime": "2025-08-23T06:40:43Z",</span>
<span class="c">#      "message": "1",</span>
<span class="c">#      "observedGeneration": 1,</span>
<span class="c">#      "reason": "noreason",</span>
<span class="c">#      "status": "Unknown",</span>
<span class="c">#      "type": "cilium.io/IPsUsed"</span>
<span class="c">#    }</span>

<span class="c"># L2 Announcement 정책 설정</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2alpha1"
kind: CiliumL2AnnouncementPolicy
metadata:
  name: policy1
spec:
  interfaces:
  - eth1
  externalIPs: true
  loadBalancerIPs: true
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliuml2announcementpolicy.cilium.io/policy1 created</span>

<span class="c"># 현재 리더 역할 노드 확인</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease | <span class="nb">grep</span> <span class="s2">"cilium-l2announce"</span>
<span class="c"># =&gt; cilium-l2announce-kube-system-cilium-ingress  k8s-w1  16s</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system get lease/cilium-l2announce-kube-system-cilium-ingress <span class="nt">-o</span> yaml | yq

<span class="c"># K8S 클러스터 내부 LB EX-IP로 호출 가능</span>
<span class="nv">$ LBIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> kube-system cilium-ingress <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$LBIP</span>
<span class="c"># =&gt; 192.168.10.211</span>
<span class="nv">$ </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 2
<span class="c"># =&gt; ARPING 192.168.10.211</span>
<span class="c">#    60 bytes from 08:00:27:12:18:4f (192.168.10.211): index=0 time=3.241 msec</span>
<span class="c">#    60 bytes from 08:00:27:12:18:4f (192.168.10.211): index=1 time=184.759 usec</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.10.211 statistics ---</span>
<span class="c">#    2 packets transmitted, 2 packets received,   0% unanswered (0 extra)</span>
<span class="c">#    rtt min/avg/max/std-dev = 0.185/1.713/3.241/1.528 ms</span>

<span class="c"># k8s 외부 노드(router)에서 LB EX-IP로 호출 가능 확인</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="nb">sudo </span>arping <span class="nt">-i</span> eth1 <span class="nv">$LBIP</span> <span class="nt">-c</span> 2
<span class="c"># =&gt; ARPING 192.168.10.211</span>
<span class="c">#    60 bytes from 08:00:27:12:18:4f (192.168.10.211): index=0 time=385.109 usec</span>
<span class="c">#    60 bytes from 08:00:27:12:18:4f (192.168.10.211): index=1 time=384.192 usec</span>
<span class="c">#    </span>
<span class="c">#    --- 192.168.10.211 statistics ---</span>
<span class="c">#    2 packets transmitted, 2 packets received,   0% unanswered (0 extra)</span>
<span class="c">#    rtt min/avg/max/std-dev = 0.384/0.385/0.385/0.000 ms</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 k8s 외부 노드에서 LB EX-IP로 호출 가능합니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="ingress-http-example--xff-확인">Ingress HTTP Example : XFF 확인</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/http/">관련문서</a></li>
  <li>이번 예제에서는 ingress를 통해 트래픽을 Istio 프로젝트에서 제공하는 <a href="https://istio.io/latest/docs/examples/bookinfo/">Bookinfo</a> 백엔드로 라우팅해 보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Deploy the Demo App : 공식 문서는 release-1.11 로 ARM CPU 에서 실패한다. 1.26 버전을 높여서 샘플 배포 할 것!</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/istio/istio/release-1.26/samples/bookinfo/platform/kube/bookinfo.yaml
<span class="c"># =&gt; ...</span>
<span class="c">#    service/productpage created</span>
<span class="c">#    serviceaccount/bookinfo-productpage created</span>
<span class="c">#    deployment.apps/productpage-v1 created</span>

<span class="nv">$ </span>kubectl get pod,svc,ep
<span class="c"># =&gt; NAME                                  READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/details-v1-766844796b-fwxlh       &lt;span style="color: green;"&gt;1/1&lt;/span&gt;     Running   0          81s</span>
<span class="c">#    pod/productpage-v1-54bb874995-5zh9b   &lt;span style="color: green;"&gt;1/1&lt;/span&gt;     Running   0          81s</span>
<span class="c">#    pod/ratings-v1-5dc79b6bcd-l4fw4       &lt;span style="color: green;"&gt;1/1&lt;/span&gt;     Running   0          81s</span>
<span class="c">#    pod/reviews-v1-598b896c9d-wxrrw       &lt;span style="color: green;"&gt;1/1&lt;/span&gt;     Running   0          81s</span>
<span class="c">#    ...</span>
<span class="c">#    </span>
<span class="c">#    NAME                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/details       &lt;span style="color: green;"&gt;ClusterIP&lt;/span&gt;   10.96.68.221    &lt;none&gt;        9080/TCP   81s</span>
<span class="c">#    service/kubernetes    &lt;span style="color: green;"&gt;ClusterIP&lt;/span&gt;   10.96.0.1       &lt;none&gt;        443/TCP    92m</span>
<span class="c">#    service/productpage   &lt;span style="color: green;"&gt;ClusterIP&lt;/span&gt;   10.96.86.254    &lt;none&gt;        9080/TCP   81s</span>
<span class="c">#    service/ratings       &lt;span style="color: green;"&gt;ClusterIP&lt;/span&gt;   10.96.108.142   &lt;none&gt;        9080/TCP   81s</span>
<span class="c">#    service/reviews       &lt;span style="color: green;"&gt;ClusterIP&lt;/span&gt;   10.96.47.199    &lt;none&gt;        9080/TCP   81s</span>
<span class="c">#    </span>
<span class="c">#    NAME                    ENDPOINTS                                               AGE</span>
<span class="c">#    endpoints/details       172.20.1.185:9080                                       81s</span>
<span class="c">#    endpoints/kubernetes    192.168.10.100:6443                                     92m</span>
<span class="c">#    endpoints/productpage   172.20.1.100:9080                                       81s</span>
<span class="c">#    endpoints/ratings       172.20.1.247:9080                                       81s</span>
<span class="c">#    endpoints/reviews       172.20.1.114:9080,172.20.1.186:9080,172.20.1.232:9080   81s</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 istio 와 다르게 사이드카 컨테이너가 없어서 파드가 1개의 (1/1) 컨테이너로 동작합니다. NodePort와 LoadBalancer 서비스도 없습니다.&lt;/span&gt;</span>

<span class="c"># </span>
<span class="nv">$ </span>kc describe ingressclasses.networking.k8s.io
<span class="c"># =&gt; Name:         cilium</span>
<span class="c">#    Labels:       app.kubernetes.io/managed-by=Helm</span>
<span class="c">#    Annotations:  meta.helm.sh/release-name: cilium</span>
<span class="c">#                  meta.helm.sh/release-namespace: kube-system</span>
<span class="c">#    Controller:   cilium.io/ingress-controller</span>
<span class="c">#    Events:       &lt;none&gt;</span>
<span class="nv">$ </span>kubectl get ingressclasses.networking.k8s.io
<span class="c"># =&gt; NAME     CONTROLLER                     PARAMETERS   AGE</span>
<span class="c">#    cilium   cilium.io/ingress-controller   &lt;none&gt;       94m</span>


<span class="c"># Basic ingress for istio bookinfo demo application, which can be found in below</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: basic-ingress
  namespace: default
spec:
  ingressClassName: cilium
  rules:
  - http:
      paths:
      - backend:
          service:
            name: details
            port:
              number: 9080
        path: /details
        pathType: Prefix
      - backend:
          service:
            name: productpage
            port:
              number: 9080
        path: /
        pathType: Prefix
</span><span class="no">EOF
</span><span class="c"># =&gt; ingress.networking.k8s.io/basic-ingress created</span>

<span class="c"># Adress 는 cilium-ingress LoadBalancer 의 EX-IP</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> kube-system cilium-ingress
<span class="c"># =&gt; NAME             TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                      AGE</span>
<span class="c">#    cilium-ingress   LoadBalancer   10.96.58.190   192.168.10.211   80:32243/TCP,443:30329/TCP   95m</span>

<span class="nv">$ </span>kubectl get ingress
<span class="c"># =&gt; NAME            CLASS    HOSTS   ADDRESS          PORTS   AGE</span>
<span class="c">#    basic-ingress   cilium   *       192.168.10.211   80      34s</span>

<span class="nv">$ </span>kc describe ingress
<span class="c"># =&gt; ...</span>
<span class="c">#    Rules:</span>
<span class="c">#      Host        Path  Backends</span>
<span class="c">#      ----        ----  --------</span>
<span class="c">#      *</span>
<span class="c">#                  /details   details:9080 (172.20.1.185:9080)</span>
<span class="c">#                  /          productpage:9080 (172.20.1.100:9080)</span>

<span class="c"># 호출 확인</span>
<span class="nv">$ LBIP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> kube-system cilium-ingress <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$LBIP</span>
<span class="c"># =&gt; 192.168.10.211</span>

<span class="c"># 실패하는 호출이 있는가?</span>
<span class="nv">$ </span>curl <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> http://<span class="nv">$LBIP</span>/
<span class="c"># =&gt; 200</span>
<span class="nv">$ </span>curl <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> http://<span class="nv">$LBIP</span>/details/1
<span class="c"># =&gt; 200</span>
<span class="nv">$ </span>curl <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> http://<span class="nv">$LBIP</span>/ratings
<span class="c"># =&gt; 404</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 실패하였습니다. 앞서 살펴본 ingress 룰에는 /ratings가 없고, `/`를 담당하는 productpage에서도 처리하지 않는 URL이기 때문입니다.&lt;/span&gt;</span>

<span class="c"># Access the Bookinfo application</span>
<span class="nv">$ </span>curl <span class="s2">"http://</span><span class="nv">$LBIP</span><span class="s2">/productpage?u=normal"</span>

<span class="c"># 모니터링</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; ℹ️   Hubble Relay is available at 127.0.0.1:4245</span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">-t</span> l7
<span class="c"># or </span>
<span class="c"># $ hubble observe -f --identity ingress</span>
<span class="c"># =&gt; ...</span>

<span class="c"># router에서 호출</span>
<span class="nv">$ </span>curl <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> http://<span class="nv">$LBIP</span>/
<span class="c"># =&gt; 200</span>
<span class="nv">$ </span>curl <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> http://<span class="nv">$LBIP</span>/details/1
<span class="c"># =&gt; 200</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LBIP</span>/
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LBIP</span>/details/1 <span class="nt">-v</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    &lt; server: envoy</span>
<span class="c">#    &lt; date: Sat, 23 Aug 2025 07:06:51 GMT</span>
<span class="c">#    &lt; content-length: 178</span>
<span class="c">#    &lt; x-envoy-upstream-service-time: 18</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LBIP</span>/ratings
<span class="c"># =&gt; &lt;!doctype html&gt;</span>
<span class="c">#    &lt;html lang=en&gt;</span>
<span class="c">#    &lt;title&gt;404 Not Found&lt;/title&gt;</span>
<span class="c">#    &lt;h1&gt;Not Found&lt;/h1&gt;</span>
<span class="c">#    &lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;</span>

<span class="c"># productpage-v1 파드가 배포된 노드 확인 </span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>productpage <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                              READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES</span>
<span class="c">#    productpage-v1-54bb874995-5zh9b   1/1     Running   0          17m   172.20.1.100   k8s-w1   &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># 해당 노드(k8s-w1)에서 veth 인터페이스 정보 확인</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1
<span class="nt">---</span>
<span class="nv">$ PROID</span><span class="o">=</span>172.20.1.100

<span class="nv">$ </span>ip route |grep <span class="nv">$PROID</span>
<span class="c"># =&gt; 172.20.1.100 dev &lt;span style="color: green;"&gt;lxcdd0576ed651e&lt;/span&gt; proto kernel scope link</span>

<span class="nv">$ PROVETH</span><span class="o">=</span>lxcdd0576ed651e

<span class="c"># ngrep 로 veth 트래픽 캡쳐 : productpage 는 9080 TCP Port 사용</span>
<span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> <span class="nv">$PROVETH</span> <span class="s1">''</span> <span class="s1">'tcp port 9080'</span>

<span class="c"># 외부에서 호출 시도</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LBIP</span>

<span class="c"># ngrep 로 veth 트래픽 캡쳐 : productpage 는 9080 TCP Port 사용</span>
<span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> <span class="nv">$PROVETH</span> <span class="s1">''</span> <span class="s1">'tcp port 9080'</span>
<span class="c"># =&gt; &lt;span style="color: green;"&gt;## igress(envoy) 가 XFF에 client-ip 담고, 목적지 파드로 요청&lt;/span&gt;</span>
<span class="c">#    T 2025/08/23 16:10:12.309006 10.0.2.15:32780 -&gt; 172.20.1.100:9080 [AP] #4</span>
<span class="c">#    GET / HTTP/1.1.</span>
<span class="c">#    host: 192.168.10.211.</span>
<span class="c">#    user-agent: curl/8.5.0.</span>
<span class="c">#    accept: */*.</span>
<span class="c">#    &lt;span style="color: green;"&gt;x-forwarded-for: 192.168.10.200.&lt;/span&gt;</span>
<span class="c">#    x-forwarded-proto: http.</span>
<span class="c">#    x-envoy-internal: true.</span>
<span class="c">#    x-request-id: 6d2bda20-5f73-41d3-ac90-159cd56a2386.</span>
<span class="c">#    .</span>
<span class="c">#    </span>
<span class="c">#    &lt;span style="color: green;"&gt;## igress(envoy)로 리턴하는 트래픽&lt;/span&gt;</span>
<span class="c">#    T 2025/08/23 16:10:12.325238 172.20.1.100:9080 -&gt; 10.0.2.15:32780 [AP] #6</span>
<span class="c">#    HTTP/1.1 200 OK.</span>
<span class="c">#    Server: gunicorn.</span>
<span class="c">#    Date: Sat, 23 Aug 2025 07:10:12 GMT.</span>
<span class="c">#    Connection: keep-alive.</span>
<span class="c">#    Content-Type: text/html; charset=utf-8.</span>
<span class="c">#    Content-Length: 2080.</span>
</code></pre></div></div>

<h3 id="ingress-nginx-설치하여-cilium-ingress와-공존-가능여부-확인">Ingress-Nginx 설치하여 Cilium Ingress와 공존 가능여부 확인</h3>

<ul>
  <li>이번에는 Cilium ingress와 Ingress-Nginx가 동시에 활성화 될 수 있는지 확인해보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Ingress-Nginx 컨트롤러 설치</span>
<span class="nv">$ </span>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
<span class="c"># =&gt; "ingress-nginx" has been added to your repositories</span>
<span class="nv">$ </span>helm <span class="nb">install </span>ingress-nginx ingress-nginx/ingress-nginx <span class="nt">--create-namespace</span> <span class="nt">-n</span> ingress-nginx
<span class="c"># =&gt; NAME: ingress-nginx</span>
<span class="c">#    LAST DEPLOYED: Sat Aug 23 16:18:18 2025</span>
<span class="c">#    NAMESPACE: ingress-nginx</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="c">#    NOTES:</span>
<span class="c">#    The ingress-nginx controller has been installed.</span>
<span class="c">#    It may take a few minutes for the load balancer IP to be available.</span>
<span class="c">#    ...</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get all <span class="nt">-n</span> ingress-nginx
<span class="c"># =&gt; NAME                                            READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    pod/ingress-nginx-controller-67bbdf7d8d-qmtp2   1/1     Running   0          34s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                         TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                      AGE</span>
<span class="c">#    service/ingress-nginx-controller             LoadBalancer   10.96.45.145   192.168.10.212   80:32426/TCP,443:30289/TCP   35s</span>
<span class="c">#    service/ingress-nginx-controller-admission   ClusterIP      10.96.79.200   &lt;none&gt;           443/TCP                      35s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/ingress-nginx-controller   1/1     1            1           35s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                                  DESIRED   CURRENT   READY   AGE</span>
<span class="c">#    replicaset.apps/ingress-nginx-controller-67bbdf7d8d   1         1         1       34s</span>
<span class="nv">$ </span>kc describe svc <span class="nt">-n</span> ingress-nginx ingress-nginx-controller
<span class="c"># =&gt; Name:                     ingress-nginx-controller</span>
<span class="c">#    Namespace:                ingress-nginx</span>
<span class="c">#    ...</span>
<span class="c">#    LoadBalancer Ingress:     192.168.10.212 (VIP)</span>
<span class="c">#    Port:                     http  80/TCP</span>
<span class="c">#    TargetPort:               http/TCP</span>
<span class="c">#    NodePort:                 http  32426/TCP</span>
<span class="c">#    Endpoints:                172.20.1.154:80</span>
<span class="c">#    Port:                     https  443/TCP</span>
<span class="c">#    TargetPort:               https/TCP</span>
<span class="c">#    NodePort:                 https  30289/TCP</span>
<span class="c">#    Endpoints:                172.20.1.154:443</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> ingress-nginx
<span class="c"># =&gt; NAME                                 TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                      AGE</span>
<span class="c">#    ingress-nginx-controller             LoadBalancer   10.96.45.145   192.168.10.212   80:32426/TCP,443:30289/TCP   2m</span>
<span class="c">#    ingress-nginx-controller-admission   ClusterIP      10.96.79.200   &lt;none&gt;           443/TCP                      2m</span>
<span class="nv">$ </span>kubectl get ingressclasses.networking.k8s.io
<span class="c"># =&gt; NAME     CONTROLLER                     PARAMETERS   AGE</span>
<span class="c">#    cilium   cilium.io/ingress-controller   &lt;none&gt;       121m</span>
<span class="c">#    nginx    k8s.io/ingress-nginx           &lt;none&gt;       2m6s</span>

<span class="c"># ingress 설정</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webpod-ingress-nginx
  namespace: default
spec:
  ingressClassName: nginx
  rules:
  - host: nginx.webpod.local
    http:
      paths:
      - backend:
          service:
            name: webpod
            port:
              number: 80
        path: /
        pathType: Prefix
</span><span class="no">EOF
</span><span class="c"># =&gt; ingress.networking.k8s.io/webpod-ingress-nginx created</span>

<span class="c"># ingress LB EX-IP 할당 까지 다소 시간 소요..</span>
<span class="nv">$ </span>kubectl get ingress <span class="nt">-w</span>
<span class="c"># =&gt; NAME                   CLASS    HOSTS                ADDRESS          PORTS   AGE</span>
<span class="c">#    basic-ingress          cilium   *                    192.168.10.211   80      29m</span>
<span class="c">#    webpod-ingress-nginx   nginx    nginx.webpod.local   &lt;span style="color: green;"&gt;192.168.10.212&lt;/span&gt;   80      32s</span>

<span class="c">#</span>
<span class="nv">$ LB2IP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc <span class="nt">-n</span> ingress-nginx ingress-nginx-controller <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; 192.168.10.211</span>

<span class="nv">$ </span>curl <span class="nv">$LB2IP</span>
<span class="c"># =&gt; &lt;html&gt;</span>
<span class="c">#    &lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 nginx.webpod.local 호스트명이 없어서 404 에러 발생&lt;/span&gt;</span>
<span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"Host: nginx.webpod.local"</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b5vtj</span>
<span class="c">#    IP: 172.20.0.70</span>
<span class="c">#    RemoteAddr: 172.20.1.154:40984</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: nginx.webpod.local</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    X-Forwarded-For: &lt;span style="color: green;"&gt;192.168.10.100&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"Host: nginx.webpod.local"</span> <span class="nv">$LB2IP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-jp4wc</span>
<span class="c">#    IP: 172.20.1.206</span>
<span class="c">#    RemoteAddr: 172.20.1.154:48320</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: nginx.webpod.local</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    X-Forwarded-For: 192.168.10.100</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s -H 'Host: nginx.webpod.local' </span><span class="nv">$LB2IP</span><span class="s2">"</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-jp4wc</span>
<span class="c">#    ...</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s -H 'Host: nginx.webpod.local' </span><span class="nv">$LB2IP</span><span class="s2">"</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b5vtj</span>
<span class="c">#    ...</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>Cilium Ingress와 Nginx ingress는 동시 활성화가 가능하며, 각각의 EX-IP로 정상 호출이 가능한 것을 확인할 수 있습니다.</li>
</ul>

<h3 id="dedicated-mode">Dedicated Mode</h3>

<ul>
  <li>Cilium Ingress는 기본적으로 Shared Mode로 동작합니다. Dedicated Mode로 변경하는 방법을 알아보겠습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Basic ingress for istio bookinfo demo application, which can be found in below</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webpod-ingress
  namespace: default
  annotations:
    ingress.cilium.io/loadbalancer-mode: dedicated
spec:
  ingressClassName: cilium
  rules:
  - http:
      paths:
      - backend:
          service:
            name: webpod
            port:
              number: 80
        path: /
        pathType: Prefix
</span><span class="no">EOF
</span><span class="c"># =&gt; ingress.networking.k8s.io/webpod-ingress created</span>

<span class="c">#</span>
<span class="nv">$ </span>kc describe ingress webpod-ingress
<span class="c"># =&gt; Name:             webpod-ingress</span>
<span class="c">#    Labels:           &lt;none&gt;</span>
<span class="c">#    Namespace:        default</span>
<span class="c">#    Address:          192.168.10.213</span>
<span class="c">#    Ingress Class:    cilium</span>
<span class="c">#    Default backend:  &lt;default&gt;</span>
<span class="c">#    Rules:</span>
<span class="c">#      Host        Path  Backends</span>
<span class="c">#      ----        ----  --------</span>
<span class="c">#      *</span>
<span class="c">#                  /   webpod:80 (172.20.1.206:80,172.20.0.70:80)</span>
<span class="c">#    Annotations:  ingress.cilium.io/loadbalancer-mode: &lt;span style="color: green;"&gt;dedicated&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl get ingress
<span class="c"># =&gt; NAME                   CLASS    HOSTS                ADDRESS          PORTS   AGE</span>
<span class="c">#    basic-ingress          cilium   *                    192.168.10.211   80      45m</span>
<span class="c">#    &lt;span style="color: green;"&gt;webpod-ingress&lt;/span&gt;         cilium   *                    192.168.10.213   80      29s</span>
<span class="c">#    webpod-ingress-nginx   nginx    nginx.webpod.local   192.168.10.212   80      16m</span>

<span class="nv">$ </span>kubectl get svc,ep cilium-ingress-webpod-ingress
<span class="c"># =&gt; NAME                                    TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                      AGE</span>
<span class="c">#    service/cilium-ingress-webpod-ingress   LoadBalancer   10.96.153.108   192.168.10.213   80:30159/TCP,443:30408/TCP   50s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                      ENDPOINTS              AGE</span>
<span class="c">#    endpoints/cilium-ingress-webpod-ingress   192.192.192.192:9999   50s</span>

<span class="c"># LB EX-IP에 대한 L2 Announcement 의 Leader 노드 확인</span>
<span class="nv">$ </span>kubectl get lease <span class="nt">-n</span> kube-system | <span class="nb">grep </span>ingress
<span class="c"># =&gt; cilium-l2announce-default-cilium-ingress-webpod-ingress   k8s-w1  80s</span>
<span class="c">#    cilium-l2announce-ingress-nginx-ingress-nginx-controller  k8s-w1  21m</span>
<span class="c">#    cilium-l2announce-kube-system-cilium-ingress              k8s-w1  58m</span>

<span class="c"># webpod 파드 IP 확인</span>
<span class="nv">$ </span>kubectl get pod <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE   IP             NODE      NOMINATED NODE   READINESS GATES</span>
<span class="c">#    webpod-697b545f57-b5vtj   1/1     Running   0          12m   172.20.0.70    k8s-ctr   &lt;none&gt;           &lt;none&gt;</span>
<span class="c">#    webpod-697b545f57-jp4wc   1/1     Running   0          12m   172.20.1.206   k8s-w1    &lt;none&gt;           &lt;none&gt;</span>

<span class="c"># k8c-ctr, k8s-w1 노드에서 파드 IP에 veth 찾기(ip -c route) 이후 ngrep 로 각각 트래픽 캡쳐</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-ctr
<span class="nt">---</span> 
<span class="nv">$ </span>ip route | <span class="nb">grep </span>172.20.0.70
<span class="c"># =&gt; 172.20.0.70 dev lxc148c311965e6 proto kernel scope link</span>
<span class="nv">$ WPODVETHCTR</span><span class="o">=</span>lxc148c311965e6
<span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> <span class="nv">$WPODVETHCTR</span> <span class="s1">''</span> <span class="s1">'tcp port 80'</span>
<span class="c"># =&gt; lxc148c311965e6: no IPv4 address assigned: Cannot assign requested address</span>
<span class="c">#    interface: lxc148c311965e6</span>
<span class="c">#    filter: ( tcp port 80 ) and ((ip || ip6) || (vlan &amp;&amp; (ip || ip6)))</span>
<span class="c">#    ###</span>
<span class="c">#    T 2025/08/23 16:48:28.123959 172.20.0.70:80 -&gt; 172.20.1.60:40517 [AP] #3</span>
<span class="c">#    HTTP/1.1 200 OK.</span>
<span class="c">#    Date: Sat, 23 Aug 2025 07:48:28 GMT.</span>
<span class="c">#    Content-Length: 343.</span>
<span class="c">#    Content-Type: text/plain; charset=utf-8.</span>
<span class="c">#    .</span>
<span class="c">#    Hostname: webpod-697b545f57-b5vtj</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.0.70</span>
<span class="c">#    IP: fe80::d46d:b0ff:fe0d:619a</span>
<span class="c">#    RemoteAddr: 172.20.1.60:40517</span>
<span class="c">#    GET / HTTP/1.1.</span>
<span class="c">#    Host: 192.168.10.213.</span>
<span class="c">#    User-Agent: curl/8.5.0.</span>
<span class="c">#    Accept: */*.</span>
<span class="c">#    X-Envoy-Internal: true.</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200.</span>
<span class="c">#    X-Forwarded-Proto: http.</span>
<span class="c">#    X-Request-Id: 01bd1da4-e1f1-47e7-958d-1032c55ec11b.</span>
<span class="c">#    ...</span>
<span class="nt">---</span>

<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@k8s-w1
<span class="nt">---</span> 
<span class="nv">$ </span>ip route | <span class="nb">grep </span>172.20.1.206
<span class="c"># =&gt; 172.20.1.206 dev lxc9e0d1071b53f proto kernel scope link</span>
<span class="nv">$ WPODVETHW1</span><span class="o">=</span>lxc9e0d1071b53f
<span class="nv">$ </span>ngrep <span class="nt">-tW</span> byline <span class="nt">-d</span> <span class="nv">$WPODVETHW1</span> <span class="s1">''</span> <span class="s1">'tcp port 80'</span>
<span class="c"># =&gt; lxc9e0d1071b53f: no IPv4 address assigned: Cannot assign requested address</span>
<span class="c">#    interface: lxc9e0d1071b53f</span>
<span class="c">#    filter: ( tcp port 80 ) and ((ip || ip6) || (vlan &amp;&amp; (ip || ip6)))</span>
<span class="c">#    ####</span>
<span class="c">#    T 2025/08/23 16:48:29.296230 10.0.2.15:34958 -&gt; 172.20.1.206:80 [AP] #4</span>
<span class="c">#    GET / HTTP/1.1.</span>
<span class="c">#    host: 192.168.10.213.</span>
<span class="c">#    user-agent: curl/8.5.0.</span>
<span class="c">#    accept: */*.</span>
<span class="c">#    x-forwarded-for: 192.168.10.200.</span>
<span class="c">#    x-forwarded-proto: http.</span>
<span class="c">#    x-envoy-internal: true.</span>
<span class="c">#    x-request-id: 80e8099d-b64b-4f05-805e-72a4d670024f.</span>
<span class="c">#    .</span>
<span class="c">#    </span>
<span class="c">#    ##</span>
<span class="c">#    T 2025/08/23 16:48:29.300200 172.20.1.206:80 -&gt; 10.0.2.15:34958 [AP] #6</span>
<span class="c">#    HTTP/1.1 200 OK.</span>
<span class="c">#    Date: Sat, 23 Aug 2025 07:48:29 GMT.</span>
<span class="c">#    Content-Length: 342.</span>
<span class="c">#    Content-Type: text/plain; charset=utf-8.</span>
<span class="c">#    .</span>
<span class="c">#    Hostname: webpod-697b545f57-jp4wc</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.1.206</span>
<span class="c">#    IP: fe80::a4ee:c1ff:fed4:b3c3</span>
<span class="c">#    RemoteAddr: 10.0.2.15:34958</span>
<span class="c">#    GET / HTTP/1.1.</span>
<span class="c">#    Host: 192.168.10.213.</span>
<span class="c">#    User-Agent: curl/8.5.0.</span>
<span class="c">#    Accept: */*.</span>
<span class="c">#    X-Envoy-Internal: true.</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200.</span>
<span class="c">#    X-Forwarded-Proto: http.</span>
<span class="c">#    X-Request-Id: 80e8099d-b64b-4f05-805e-72a4d670024f.</span>
<span class="c">#    ...</span>
<span class="nt">---</span>

<span class="c"># router 에서 호출 확인</span>
<span class="nv">$ LB2IP</span><span class="o">=</span><span class="si">$(</span>kubectl get svc cilium-ingress-webpod-ingress <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LB2IP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-jp4wc</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.1.206</span>
<span class="c">#    IP: fe80::a4ee:c1ff:fed4:b3c3</span>
<span class="c">#    RemoteAddr: 10.0.2.15:34958  # webpod 인입 시 S.IP : 마치 L2 Leader 노드에 webpod로 전달되어, 소스IP가 해당 노드의 첫 번째 NIC IP,</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 192.168.10.213</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    X-Envoy-Internal: true</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200</span>
<span class="c">#    X-Forwarded-Proto: http</span>
<span class="c">#    X-Request-Id: 80e8099d-b64b-4f05-805e-72a4d670024f</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router curl <span class="nt">-s</span> http://<span class="nv">$LB2IP</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-b5vtj</span>
<span class="c">#    IP: 127.0.0.1</span>
<span class="c">#    IP: ::1</span>
<span class="c">#    IP: 172.20.0.70</span>
<span class="c">#    IP: fe80::d46d:b0ff:fe0d:619a</span>
<span class="c">#    RemoteAddr: 172.20.1.60:40517  # webpod 인입 시 S.IP : L2 Leader 노드(k8s-w1)에서 다른 노드에 파드로 전달되어, ingress 예약IP로 SNAT</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: 192.168.10.213</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    X-Envoy-Internal: true</span>
<span class="c">#    X-Forwarded-For: 192.168.10.200</span>
<span class="c">#    X-Forwarded-Proto: http</span>
<span class="c">#    X-Request-Id: 01bd1da4-e1f1-47e7-958d-1032c55ec11b</span>
</code></pre></div></div>

<h3 id="ingress-and-network-policies-example">Ingress and Network Policies Example</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress-and-network-policy/">관련 문서</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 클러스터 전체(모든 네임스페이스)에 적용되는 정책 : 참고로 아래 정책 적용 후 Hubble-ui 로 접속 불가!</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: "external-lockdown"
spec:
  description: "Block all the traffic originating from outside of the cluster"
  endpointSelector: {}
  ingress:
  - fromEntities:
    - cluster
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumclusterwidenetworkpolicy.cilium.io/external-lockdown created</span>
<span class="nv">$ </span>kubectl get ciliumclusterwidenetworkpolicy
<span class="c"># =&gt; NAME                VALID</span>
<span class="c">#    external-lockdown   True</span>

<span class="c">#</span>
<span class="nv">$ </span>curl <span class="nt">--fail</span> <span class="nt">-v</span> http://<span class="s2">"</span><span class="nv">$LBIP</span><span class="s2">"</span>/details/1
<span class="c"># =&gt; &lt; HTTP/1.1 403 Forbidden</span>

<span class="c"># </span>
<span class="nv">$ </span>hubble observe <span class="nt">-f</span> <span class="nt">--identity</span> ingress
<span class="c">## k8s-ctr 에서 curl 실행 시</span>
<span class="c"># =&gt; Aug 23 08:10:11.770: 127.0.0.1:36726 (ingress) -&gt; 127.0.0.1:15778 (world) http-request DROPPED (HTTP/1.1 GET http://192.168.10.211/details/1)</span>
<span class="c">#    Aug 23 08:10:11.770: 127.0.0.1:36726 (ingress) &lt;- 127.0.0.1:15778 (world) http-response FORWARDED (HTTP/1.1 403 1ms (GET http://192.168.10.211/details/1))</span>
<span class="c">## router 에서 curl 실행 시</span>
<span class="c"># =&gt; Aug 23 08:10:20.475: 192.168.10.200:43490 (ingress) -&gt; kube-system/cilium-ingress:80 (world) http-request DROPPED (HTTP/1.1 GET http://192.168.10.211/details/1)</span>
<span class="c">#    Aug 23 08:10:20.475: 192.168.10.200:43490 (ingress) &lt;- kube-system/cilium-ingress:80 (world) http-response FORWARDED (HTTP/1.1 403 0ms (GET http://192.168.10.211/details/1))</span>

<span class="c"># router와 k8s-ctr의 요청은 허용하는 정책 적용 </span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: "allow-cidr"
spec:
  description: "Allow all the traffic originating from a specific CIDR"
  endpointSelector:
    matchExpressions:
    - key: reserved:ingress
      operator: Exists
  ingress:
  - fromCIDRSet:
    # Please update the CIDR to match your environment
    - cidr: 192.168.10.200/32
    - cidr: 127.0.0.1/32
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumclusterwidenetworkpolicy.cilium.io/allow-cidr created</span>

<span class="c"># 요청 성공! : k8s-ctr , router 모두 가능</span>
<span class="nv">$ </span>curl <span class="nt">--fail</span> <span class="nt">-v</span> http://<span class="s2">"</span><span class="nv">$LBIP</span><span class="s2">"</span>/details/1
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s --fail -v http://"</span><span class="nv">$LBIP</span><span class="s2">"/details/1"</span>
<span class="c"># =&gt; *   Trying 192.168.10.211:80...</span>
<span class="c">#    * Connected to 192.168.10.211 (192.168.10.211) port 80</span>
<span class="c">#    &gt; GET /details/1 HTTP/1.1</span>
<span class="c">#    &gt; Host: 192.168.10.211</span>
<span class="c">#    &gt; User-Agent: curl/8.5.0</span>
<span class="c">#    &gt; Accept: */*</span>
<span class="c">#    &gt;</span>
<span class="c">#    {"id":1,"author":"William Shakespeare","year":1595,"type":"paperback","pages":200,"publisher":"PublisherA","language":"English","ISBN-10":"1234567890","ISBN-13":"123-1234567890"}&lt; HTTP/1.1 200 OK</span>
<span class="c">#    &lt; content-type: application/json</span>
<span class="c">#    &lt; server: envoy</span>
<span class="c">#    &lt; date: Sat, 23 Aug 2025 08:11:39 GMT</span>
<span class="c">#    &lt; content-length: 178</span>
<span class="c">#    &lt; x-envoy-upstream-service-time: 16</span>
<span class="c">#    &lt;</span>
<span class="c">#    { [178 bytes data]</span>
<span class="c">#    * Connection #0 to host 192.168.10.211 left intact</span>

<span class="c"># Default Deny Ingress Policy : DNS쿼리와 kube-system내의 파드 제외 to deny all traffic by default</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: "default-deny"
spec:
  description: "Block all the traffic (except DNS) by default"
  egress:
  - toEndpoints:
    - matchLabels:
        io.kubernetes.pod.namespace: kube-system
        k8s-app: kube-dns
    toPorts:
    - ports:
      - port: '53'
        protocol: UDP
      rules:
        dns:
        - matchPattern: '*'
  endpointSelector:
    matchExpressions:
    - key: io.kubernetes.pod.namespace
      operator: NotIn
      values:
      - kube-system
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumclusterwidenetworkpolicy.cilium.io/default-deny created</span>
<span class="nv">$ </span>kubectl get ciliumclusterwidenetworkpolicy
<span class="c"># =&gt; NAME                VALID</span>
<span class="c">#    allow-cidr          True</span>
<span class="c">#    default-deny        True</span>
<span class="c">#    external-lockdown   True</span>

<span class="c"># 요청 </span>
<span class="nv">$ </span>curl <span class="nt">--fail</span> <span class="nt">-v</span> http://<span class="s2">"</span><span class="nv">$LBIP</span><span class="s2">"</span>/details/1
<span class="c"># =&gt; &lt; HTTP/1.1 403 Forbidden</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s --fail -v http://"</span><span class="nv">$LBIP</span><span class="s2">"/details/1"</span>
<span class="c"># =&gt; &lt; HTTP/1.1 403 Forbidden</span>

<span class="c"># ingress 를 통해서 인입 시 허용</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: allow-ingress-egress
spec:
  description: "Allow all the egress traffic from reserved ingress identity to any endpoints in the cluster"
  endpointSelector:
    matchExpressions:
    - key: reserved:ingress
      operator: Exists
  egress:
  - toEntities:
    - cluster
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumclusterwidenetworkpolicy.cilium.io/allow-ingress-egress created</span>
<span class="nv">$ </span>kubectl get ciliumclusterwidenetworkpolicy
<span class="c"># =&gt; NAME                   VALID</span>
<span class="c">#    allow-cidr             True</span>
<span class="c">#    allow-ingress-egress   True</span>
<span class="c">#    default-deny           True</span>
<span class="c">#    external-lockdown      True</span>

<span class="c">#</span>
<span class="nv">$ </span>curl <span class="nt">--fail</span> <span class="nt">-v</span> http://<span class="s2">"</span><span class="nv">$LBIP</span><span class="s2">"</span>/details/1
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s --fail -v http://"</span><span class="nv">$LBIP</span><span class="s2">"/details/1"</span>
<span class="c"># =&gt; *   Trying 192.168.10.211:80...</span>
<span class="c">#    * Connected to 192.168.10.211 (192.168.10.211) port 80</span>
<span class="c">#    &gt; GET /details/1 HTTP/1.1</span>
<span class="c">#    &gt; Host: 192.168.10.211</span>
<span class="c">#    &gt; User-Agent: curl/8.5.0</span>
<span class="c">#    &gt; Accept: */*</span>
<span class="c">#    &gt;</span>
<span class="c">#    {"id":1,"author":"William Shakespeare","year":1595,"type":"paperback","pages":200,"publisher":"PublisherA","language":"English","ISBN-10":"1234567890","ISBN-13":"123-1234567890"}&lt; HTTP/1.1 200 OK</span>
<span class="c">#    &lt; content-type: application/json</span>
<span class="c">#    &lt; server: envoy</span>
<span class="c">#    &lt; date: Sat, 23 Aug 2025 08:13:20 GMT</span>
<span class="c">#    &lt; content-length: 178</span>
<span class="c">#    &lt; x-envoy-upstream-service-time: 8</span>
<span class="c">#    &lt;</span>
<span class="c">#    { [178 bytes data]</span>
<span class="c">#    * Connection #0 to host 192.168.10.211 left intact</span>

<span class="c"># 정책 삭제</span>
<span class="nv">$ </span>kubectl delete CiliumClusterwideNetworkPolicy <span class="nt">--all</span>
<span class="c"># =&gt; ciliumclusterwidenetworkpolicy.cilium.io "allow-cidr" deleted</span>
<span class="c">#    ciliumclusterwidenetworkpolicy.cilium.io "allow-ingress-egress" deleted</span>
<span class="c">#    ciliumclusterwidenetworkpolicy.cilium.io "default-deny" deleted</span>
<span class="c">#    ciliumclusterwidenetworkpolicy.cilium.io "external-lockdown" deleted</span>
</code></pre></div></div>

<h3 id="ingress-path-type-example">Ingress Path Type Example</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/path-types/">관련 문서</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Apply the base definitions</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/main/examples/kubernetes/servicemesh/ingress-path-types.yaml
<span class="c"># =&gt; ...</span>
<span class="c">#    deployment.apps/implpath2 created</span>
<span class="c">#    ...</span>
<span class="c">#    service/implpath2 created</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/main/examples/kubernetes/servicemesh/ingress-path-types.yaml
<span class="c"># =&gt; NAME                          READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/exactpath     1/1     1            1           18s</span>
<span class="c">#    deployment.apps/prefixpath    1/1     1            1           18s</span>
<span class="c">#    deployment.apps/prefixpath2   1/1     1            1           18s</span>
<span class="c">#    deployment.apps/implpath      1/1     1            1           18s</span>
<span class="c">#    deployment.apps/implpath2     1/1     1            1           18s</span>
<span class="c">#    </span>
<span class="c">#    NAME                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/prefixpath    ClusterIP   10.96.11.159   &lt;none&gt;        80/TCP    18s</span>
<span class="c">#    service/prefixpath2   ClusterIP   10.96.158.98   &lt;none&gt;        80/TCP    18s</span>
<span class="c">#    service/exactpath     ClusterIP   10.96.46.141   &lt;none&gt;        80/TCP    18s</span>
<span class="c">#    service/implpath      ClusterIP   10.96.88.45    &lt;none&gt;        80/TCP    18s</span>
<span class="c">#    service/implpath2     ClusterIP   10.96.18.242   &lt;none&gt;        80/TCP    18s</span>

<span class="c"># Apply the Ingress</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/main/examples/kubernetes/servicemesh/ingress-path-types-ingress.yaml
<span class="c"># =&gt; ingress.networking.k8s.io/multiple-path-types created</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kc describe ingress multiple-path-types
<span class="c"># =&gt; Rules:</span>
<span class="c">#      Host                   Path  Backends</span>
<span class="c">#      ----                   ----  --------</span>
<span class="c">#      pathtypes.example.com</span>
<span class="c">#                             /exact    exactpath:80 (172.20.1.238:3000)</span>
<span class="c">#                             /         prefixpath:80 (172.20.1.72:3000)</span>
<span class="c">#                             /prefix   prefixpath2:80 (172.20.1.176:3000)</span>
<span class="c">#                             /impl     implpath:80 (172.20.1.210:3000)</span>
<span class="c">#                             /impl.+   implpath2:80 (172.20.1.223:3000)</span>
<span class="nv">$ </span>kc get ingress multiple-path-types <span class="nt">-o</span> yaml
<span class="c"># =&gt; ...</span>
<span class="c">#    spec:</span>
<span class="c">#      ingressClassName: cilium</span>
<span class="c">#      rules:</span>
<span class="c">#      - host: pathtypes.example.com</span>
<span class="c">#        http:</span>
<span class="c">#          paths:</span>
<span class="c">#          - backend:</span>
<span class="c">#              service:</span>
<span class="c">#                name: exactpath</span>
<span class="c">#                port:</span>
<span class="c">#                  number: 80</span>
<span class="c">#            path: /exact</span>
<span class="c">#            pathType: Exact</span>
<span class="c">#          - backend:</span>
<span class="c">#              service:</span>
<span class="c">#                name: prefixpath</span>
<span class="c">#                port:</span>
<span class="c">#                  number: 80</span>
<span class="c">#            path: /</span>
<span class="c">#            pathType: Prefix</span>
<span class="c">#          - backend:</span>
<span class="c">#              service:</span>
<span class="c">#                name: prefixpath2</span>
<span class="c">#                port:</span>
<span class="c">#                  number: 80</span>
<span class="c">#            path: /prefix</span>
<span class="c">#            pathType: Prefix</span>
<span class="c">#          - backend:</span>
<span class="c">#              service:</span>
<span class="c">#                name: implpath</span>
<span class="c">#                port:</span>
<span class="c">#                  number: 80</span>
<span class="c">#            path: /impl</span>
<span class="c">#            pathType: ImplementationSpecific</span>
<span class="c">#          - backend:</span>
<span class="c">#              service:</span>
<span class="c">#                name: implpath2</span>
<span class="c">#                port:</span>
<span class="c">#                  number: 80</span>
<span class="c">#            path: /impl.+</span>
<span class="c">#            pathType: ImplementationSpecific</span>

<span class="c"># 호출 확인</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATHTYPE_IP</span><span class="o">=</span><span class="sb">`</span>k get ing multiple-path-types <span class="nt">-o</span> json | jq <span class="nt">-r</span> <span class="s1">'.status.loadBalancer.ingress[0].ip'</span><span class="sb">`</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/ | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "path": "/",</span>
<span class="c">#      "host": "pathtypes.example.com",</span>
<span class="c">#      "method": "GET",</span>
<span class="c">#      ...</span>
<span class="c">#        "X-Envoy-Internal": [</span>
<span class="c">#          "true"</span>
<span class="c">#        ],</span>
<span class="c">#        "X-Forwarded-For": [</span>
<span class="c">#          "10.0.2.15"</span>
<span class="c">#        ],</span>
<span class="c">#    ...</span>

<span class="c"># 파드명 이름 확인</span>
<span class="nv">$ </span>kubectl get pod | <span class="nb">grep </span>path
<span class="c"># =&gt; exactpath-7488f8c6c6-4w7rx        1/1     Running   0          2m7s</span>
<span class="c">#    implpath-7d8bf85676-qz6t6         1/1     Running   0          2m7s</span>
<span class="c">#    implpath2-56c97c8556-mv66q        1/1     Running   0          2m7s</span>
<span class="c">#    prefixpath-5d6b989d4-kwvv6        1/1     Running   0          2m7s</span>
<span class="c">#    prefixpath2-b7c7c9568-br2nl       1/1     Running   0          2m7s</span>

<span class="c"># Should show prefixpath</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/ | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'path|pod'</span>
<span class="c"># =&gt;  "path": "/",</span>
<span class="c">#     "host": "pathtypes.example.com",</span>
<span class="c">#     "pod": "prefixpath-5d6b989d4-kwvv6"</span>

<span class="c"># Should show exactpath</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/exact | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'path|pod'</span>
<span class="c"># =&gt;  "path": "/exact",</span>
<span class="c">#     "host": "pathtypes.example.com",</span>
<span class="c">#     "pod": "exactpath-7488f8c6c6-4w7rx"</span>

<span class="c"># Should show prefixpath2</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/prefix | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'path|pod'</span>
<span class="c"># =&gt;  "path": "/prefix",</span>
<span class="c">#     "host": "pathtypes.example.com",</span>
<span class="c">#     "pod": "prefixpath2-b7c7c9568-br2nl"</span>

<span class="c"># Should show implpath</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/impl | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'path|pod'</span>
<span class="c"># =&gt;  "path": "/impl",</span>
<span class="c">#     "host": "pathtypes.example.com",</span>
<span class="c">#     "pod": "implpath-7d8bf85676-qz6t6"</span>

<span class="c"># Should show implpath2</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-H</span> <span class="s2">"Host: pathtypes.example.com"</span> http://<span class="nv">$PATHTYPE_IP</span>/implementation | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'path|pod'</span>
<span class="c"># =&gt;  "path": "/implementation",</span>
<span class="c">#     "host": "pathtypes.example.com",</span>
<span class="c">#     "pod": "implpath2-56c97c8556-mv66q"</span>

<span class="c"># 삭제</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/main/examples/kubernetes/servicemesh/ingress-path-types.yaml
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/main/examples/kubernetes/servicemesh/ingress-path-types-ingress.yaml
</code></pre></div></div>

<h3 id="ingress-example-with-tls-termination">Ingress Example with TLS Termination</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/tls-termination/">관련 문서</a></li>
</ul>

<h5 id="tls-인증서와-개인키-생성--mkcert---github">TLS 인증서와 개인키 생성 : mkcert - <a href="https://github.com/FiloSottile/mkcert">Github</a>
</h5>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">mkcert</code>는 로컬 개발 환경에서 신뢰할 수 있는 SSL 인증서를 쉽게 생성할 수 있도록 도와주는 도구입니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># For demonstration purposes we will use a TLS certificate signed by a made-up, self-signed certificate authority (CA). </span>
<span class="c"># One easy way to do this is with mkcert. We want a certificate that will validate bookinfo.cilium.rocks and hipstershop.cilium.rocks, as these are the host names used in this example.</span>
<span class="nv">$ </span>apt <span class="nb">install </span>mkcert <span class="nt">-y</span>
<span class="nv">$ </span>mkcert <span class="nt">-h</span>
<span class="c"># =&gt; Usage of mkcert:</span>
<span class="c">#    </span>
<span class="c">#            $ mkcert -install</span>
<span class="c">#            Install the local CA in the system trust store.</span>
<span class="c">#    </span>
<span class="c">#            $ mkcert example.org</span>
<span class="c">#            Generate "example.org.pem" and "example.org-key.pem".</span>
<span class="c">#    </span>
<span class="c">#            $ mkcert example.com myapp.dev localhost 127.0.0.1 ::1</span>
<span class="c">#            Generate "example.com+4.pem" and "example.com+4-key.pem".</span>
<span class="c">#    </span>
<span class="c">#            $ mkcert "*.example.it"</span>
<span class="c">#            Generate "_wildcard.example.it.pem" and "_wildcard.example.it-key.pem".</span>
<span class="c">#    </span>
<span class="c">#            $ mkcert -uninstall</span>
<span class="c">#            Uninstall the local CA (but do not delete it).</span>
<span class="c">#    </span>
<span class="c">#    For more options, run "mkcert -help".</span>

<span class="c">#</span>
<span class="nv">$ </span>mkcert <span class="s1">'*.cilium.rocks'</span>
<span class="c"># =&gt; Created a new local CA 💥</span>
<span class="c">#    Note: the local CA is not installed in the system trust store.</span>
<span class="c">#    Run "mkcert -install" for certificates to be trusted automatically ⚠️</span>
<span class="c">#    </span>
<span class="c">#    Created a new certificate valid for the following names 📜</span>
<span class="c">#     - "*.cilium.rocks"</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> <span class="k">*</span>.pem
<span class="c"># =&gt; -rw------- 1 root root 1704 Aug 23 17:27 _wildcard.cilium.rocks-key.pem</span>
<span class="c">#    -rw-r--r-- 1 root root 1452 Aug 23 17:27 _wildcard.cilium.rocks.pem</span>

<span class="c">#</span>
<span class="nv">$ </span>openssl x509 <span class="nt">-in</span> _wildcard.cilium.rocks.pem <span class="nt">-text</span> <span class="nt">-noout</span>
<span class="c"># =&gt;         Issuer: O = mkcert development CA, OU = root@k8s-ctr, CN = mkcert root@k8s-ctr</span>
<span class="c">#            Validity</span>
<span class="c">#                Not Before: Aug 23 08:27:20 2025 GMT</span>
<span class="c">#                Not After : Oct 01 08:27:20 2027 GMT</span>
<span class="c">#            Subject: O = mkcert development certificate, OU = root@k8s-ctr</span>
<span class="c">#            ...</span>
<span class="c">#            X509v3 extensions:</span>
<span class="c">#                X509v3 Key Usage: critical</span>
<span class="c">#                    Digital Signature, Key Encipherment</span>
<span class="c">#                X509v3 Extended Key Usage:</span>
<span class="c">#                    TLS Web Server Authentication</span>
<span class="c">#                X509v3 Authority Key Identifier:</span>
<span class="c">#                    4E:3C:EA:36:AE:39:1C:4C:16:E0:55:3A:B8:B3:E3:D6:10:5B:31:FC</span>
<span class="c">#                X509v3 Subject Alternative Name:</span>
<span class="c">#                    &lt;span style="color: green;"&gt;DNS:*.cilium.rocks&lt;/span&gt;</span>

<span class="nv">$ </span>openssl rsa <span class="nt">-in</span> _wildcard.cilium.rocks-key.pem <span class="nt">-text</span> <span class="nt">-noout</span>
<span class="c"># =&gt; Private-Key: (2048 bit, 2 primes)</span>
<span class="c">#    modulus:</span>
<span class="c">#        00:95:4a:de:e4:5c:7a:b6:7e:6c:8a:65:fe:8d:9c:</span>
<span class="c">#    ...</span>

<span class="c"># Mkcert created a key (_wildcard.cilium.rocks-key.pem) and a certificate (_wildcard.cilium.rocks.pem) that we will use for the Gateway service.</span>
<span class="c"># Create a Kubernetes TLS secret with this key and certificate:</span>
<span class="nv">$ </span>kubectl create secret tls demo-cert <span class="nt">--key</span><span class="o">=</span>_wildcard.cilium.rocks-key.pem <span class="nt">--cert</span><span class="o">=</span>_wildcard.cilium.rocks.pem
<span class="c"># =&gt; secret/demo-cert created</span>
<span class="nv">$ </span>kubectl get secret demo-cert <span class="nt">-o</span> json | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "apiVersion": "v1",</span>
<span class="c">#      "data": {</span>
<span class="c">#        "tls.crt": "LS0tLS1CRUdJT...VRFLS0tLS0K",</span>
<span class="c">#        "tls.key": "LS0tLS1CRUdJT...gS0VZLS0tLS0K"</span>
<span class="c">#      },</span>
<span class="c">#      ...</span>
<span class="c">#      "type": "kubernetes.io/tls"</span>
<span class="c">#    }</span>
</code></pre></div></div>

<h5 id="ingress-배포">Ingress 배포</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tls-ingress
  namespace: default
spec:
  ingressClassName: cilium
  rules:
  - host: webpod.cilium.rocks
    http:
      paths:
      - backend:
          service:
            name: webpod
            port:
              number: 80
        path: /
        pathType: Prefix
  - host: bookinfo.cilium.rocks
    http:
      paths:
      - backend:
          service:
            name: details
            port:
              number: 9080
        path: /details
        pathType: Prefix
      - backend:
          service:
            name: productpage
            port:
              number: 9080
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - webpod.cilium.rocks
    - bookinfo.cilium.rocks
    secretName: demo-cert
</span><span class="no">EOF
</span><span class="c"># =&gt; ingress.networking.k8s.io/tls-ingress created</span>

<span class="c">#    </span>
<span class="nv">$ </span>kubectl get ingress tls-ingress
<span class="c"># =&gt; NAME          CLASS    HOSTS                                       ADDRESS          PORTS     AGE</span>
<span class="c">#    tls-ingress   cilium   webpod.cilium.rocks,bookinfo.cilium.rocks   192.168.10.211   80, 443   22s</span>
</code></pre></div></div>

<h5 id="요청하기">요청하기</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 시스템(OS) 신뢰 저장소에 CA 정보 확인</span>
<span class="nv">$ </span><span class="nb">cat</span> /etc/ssl/certs/ca-certificates.crt
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /etc/ssl/certs/ca-certificates.crt
<span class="c"># =&gt; -rw-r--r-- 1 root root 219342 Feb 17  2025 /etc/ssl/certs/ca-certificates.crt</span>

<span class="c"># Install the Mkcert CA into your system so cURL can trust it:</span>
<span class="c"># mkcert -install은 “내 로컬에서 만든 인증서를 시스템이 믿도록” 환경을 꾸며주는 명령.</span>
<span class="nv">$ </span>mkcert <span class="nt">-install</span>
<span class="c"># =&gt; The local CA is now installed in the system trust store! ⚡️</span>

<span class="c"># 1. 로컬 CA(자체 루트 인증기관) 생성</span>
<span class="c"># 아직 없으면 로컬 CA 인증서와 개인키를 만듭니다.</span>
<span class="c"># 파일은 $(mkcert -CAROOT)가 가리키는 사용자 데이터 디렉터리에 저장돼요(예: rootCA.pem, rootCA-key.pem). 이 위치는 mkcert -CAROOT로 확인합니다. </span>
<span class="c">## CA 저장 위치 확인</span>
<span class="nv">$ </span>mkcert <span class="nt">-CAROOT</span>
<span class="c"># =&gt; /root/.local/share/mkcert</span>

<span class="nv">$ </span><span class="nb">ls</span> <span class="s2">"</span><span class="si">$(</span>mkcert <span class="nt">-CAROOT</span><span class="si">)</span><span class="s2">"</span>
<span class="c"># =&gt; rootCA-key.pem  rootCA.pem</span>

<span class="c"># 2. 시스템(OS) 신뢰 저장소에 CA를 등록</span>
<span class="c"># 배포판에 맞는 도구(예: Debian/Ubuntu의 update-ca-certificates, RHEL/Fedora의 update-ca-trust, Arch의 trust)를 사용해 루트 CA 인증서를 시스템 신뢰 저장소에 넣습니다.</span>
<span class="c"># 이렇게 하면 OpenSSL/GnuTLS를 쓰는 대부분의 CLI가 이 CA로 서명된 서버 인증서를 신뢰합니다. (curl도 포함)</span>
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /etc/ssl/certs/ca-certificates.crt
<span class="c"># =&gt; -rw-r--r-- 1 root root 220952 Aug 23 17:31 /etc/ssl/certs/ca-certificates.crt</span>

<span class="c">## 맨 하단에 인증서만 파일로 만들어서 디코딩!</span>
<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-n</span> 50 /etc/ssl/certs/ca-certificates.crt
<span class="c"># =&gt; ...</span>
<span class="c">#    -----END CERTIFICATE-----</span>
<span class="c">#    -----BEGIN CERTIFICATE-----</span>
<span class="c">#    MIIEeTCCAuGgAwIBAgIQHQmaPLojsfEios2wRChKPTANBgkqhkiG9w0BAQsFADBV</span>
<span class="c">#    ...</span>
<span class="c">#    zLFNEfhNUdhcRarky3dp/Jbp16t2QJRYh39gFskAJ1+02uQrsFq14pPnOO1d</span>
<span class="c">#    -----END CERTIFICATE-----</span>
<span class="nv">$ </span>vi 1.pem
<span class="nt">---</span>
<span class="nt">-----BEGIN</span> CERTIFICATE-----
MIIEeTCCAuGgAwIBAgIQHQmaPLojsfEios2wRChKPTANBgkqhkiG9w0BAQsFADBV
...
zLFNEfhNUdhcRarky3dp/Jbp16t2QJRYh39gFskAJ1+02uQrsFq14pPnOO1d
<span class="nt">-----END</span> CERTIFICATE-----
<span class="nt">---</span>
<span class="nv">$ </span>openssl x509 <span class="nt">-in</span> 1.pem <span class="nt">-text</span> <span class="nt">-noout</span>
<span class="c"># =&gt;         Issuer: O = mkcert development CA, OU = root@k8s-ctr, CN = mkcert root@k8s-ctr</span>
<span class="c">#            Validity</span>
<span class="c">#                Not Before: Aug 23 08:27:20 2025 GMT</span>
<span class="c">#                Not After : Aug 23 08:27:20 2035 GMT</span>
<span class="c">#            Subject: O = mkcert development CA, OU = root@k8s-ctr, CN = mkcert root@k8s-ctr</span>
<span class="c">#            Subject Public Key Info:</span>
<span class="c">#    ...</span>
<span class="c">#            X509v3 extensions:</span>
<span class="c">#                X509v3 Key Usage: critical</span>
<span class="c">#                    Certificate Sign</span>
<span class="c">#                X509v3 Basic Constraints: critical</span>
<span class="c">#                    CA:TRUE, pathlen:0</span>
<span class="c">#    ...</span>

<span class="c"># 3. NSS(브라우저) 신뢰 저장소에 등록</span>
<span class="c"># Linux에서는 Firefox/Chromium이 쓰는 NSS 데이터베이스에도 CA를 넣습니다(사전에 certutil 설치 필요). Firefox는 브라우저 재시작이 필요합니다</span>

<span class="c"># Now let's make a request to the Gateway:</span>
<span class="c"># The data should be properly retrieved, using HTTPS (and thus, the TLS handshake was properly achieved).</span>
<span class="c"># In the next challenge, we will see how to use Gateway API for general TLS traffic.</span>
<span class="nv">$ </span>kubectl get ingress tls-ingress <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span>
<span class="c"># =&gt; 192.168.10.211</span>
<span class="nv">$ LBIP</span><span class="o">=</span><span class="si">$(</span>kubectl get ingress tls-ingress <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].ip}'</span><span class="si">)</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">--resolve</span> bookinfo.cilium.rocks:443:<span class="k">${</span><span class="nv">LBIP</span><span class="k">}</span> https://bookinfo.cilium.rocks/details/1 | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "id": 1,</span>
<span class="c">#      "author": "William Shakespeare",</span>
<span class="c">#      "year": 1595,</span>
<span class="c">#      "type": "paperback",</span>
<span class="c">#      "pages": 200,</span>
<span class="c">#      "publisher": "PublisherA",</span>
<span class="c">#      "language": "English",</span>
<span class="c">#      "ISBN-10": "1234567890",</span>
<span class="c">#      "ISBN-13": "123-1234567890"</span>
<span class="c">#    }</span>
  
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">--resolve</span> webpod.cilium.rocks:443:<span class="k">${</span><span class="nv">LBIP</span><span class="k">}</span>   https://webpod.cilium.rocks/ <span class="nt">-v</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    *  CAfile: /etc/ssl/certs/ca-certificates.crt</span>
<span class="c">#    *  CApath: /etc/ssl/certs</span>
<span class="c">#    ...</span>
<span class="c">#    * Server certificate:</span>
<span class="c">#    *  subject: O=mkcert development certificate; OU=root@k8s-ctr</span>
<span class="c">#    *  start date: Aug 23 08:27:20 2025 GMT</span>
<span class="c">#    *  expire date: Oct 01 08:27:20 2027 GMT</span>
<span class="c">#    *  subjectAltName: host "webpod.cilium.rocks" matched cert's "*.cilium.rocks"</span>
<span class="c">#    *  issuer: O=mkcert development CA; OU=root@k8s-ctr; CN=mkcert root@k8s-ctr</span>
<span class="c">#    ...</span>
<span class="c">#    Hostname: webpod-697b545f57-b5vtj</span>
<span class="c">#    ...</span>
<span class="c">#    IP: 172.20.0.70</span>
<span class="c">#    RemoteAddr: 10.0.2.15:51328</span>
<span class="c">#    GET / HTTP/1.1</span>
<span class="c">#    Host: webpod.cilium.rocks</span>
<span class="c">#    User-Agent: curl/8.5.0</span>
<span class="c">#    Accept: */*</span>
<span class="c">#    X-Envoy-Internal: true</span>
<span class="c">#    X-Forwarded-For: 10.0.2.15</span>
<span class="c">#    X-Forwarded-Proto: https</span>
<span class="c">#    X-Request-Id: da68b521-852e-4678-92ed-37f72101d75d</span>
</code></pre></div></div>

<ul>
  <li>TLS Termination이 잘 되어서 https로 요청시 인증서가 유효하고, 서비스로 요청이 잘 전달되는 것을 확인할 수 있습니다.</li>
</ul>

<h5 id="ingress-삭제">ingress 삭제</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete ingress basic-ingress tls-ingress webpod-ingress
<span class="c"># =&gt; ingress.networking.k8s.io "basic-ingress" deleted</span>
<span class="c">#    ingress.networking.k8s.io "tls-ingress" deleted</span>
<span class="c">#    ingress.networking.k8s.io "webpod-ingress" deleted</span>
</code></pre></div></div>

<hr>

<h2 id="gateway-api-support">Gateway API Support</h2>

<h3 id="gateway-api-소개">Gateway API 소개</h3>

<ul>
  <li>Gateway API는 기존의 Ingress API의 한계를 극복하고 대체하기 위한 차세대 API로, 기능을 추가하고, 역할을 분리하고, 더 유연하고 확장 가능한 방식으로 클러스터 외부에서 내부로의 트래픽을 관리할 수 있도록 설계되었습니다.
<a href="https://kubernetes.io/docs/concepts/services-networking/gateway/">Docs</a>, <a href="https://www.youtube.com/watch?v=kbTVzAhtHKs">Youtube</a>
</li>
  <li>기존 Ingress의 한계
    <ul>
      <li>
<strong>고급 라우팅 지원 부족 (URL rewriting 등)</strong> : Ingress Controller 마다 지원하는 기능이 다르고, 특수한 Annotation을 사용해야 하는 등 일관성이 부족합니다.</li>
      <li>
<strong>역할 분리 부족</strong> : Ingress 리소스는 클러스터 운영자와 애플리케이션 개발자 간의 역할 분리가 명확하지 않아, 운영자가 애플리케이션의 라우팅 정책을 완전히 제어할 수 있습니다</li>
      <li>
<strong>프로토콜 제한</strong> : Ingress는 주로 HTTP/HTTPS 트래픽을 처리하도록 설계되어 있어, TCP, UDP 등 다른 프로토콜에 대한 지원이 제한적입니다.</li>
      <li>
<strong>운영 제한</strong> : Ingress의 API는 유연하지 못하여 로드밸런싱을 공유하는 인프라를 여러 팀이 관리하는 클러스터에 적합하지 않는등 운영상의 제약이 있습니다.</li>
    </ul>
  </li>
  <li>서비스 메시(istiod 등)에서 제공하는 풍부한 기능 중 일부 기능들과 운영관리 기능들을 Gateway API를 통해 사용할 수 있습니다.</li>
  <li>주요 기능
    <ul>
      <li>
<strong>개선된 리소스 모델</strong> : Gateway API는 GatewayClass, Gateway 및 Route(HTTPRoute, TCPRoute 등)와 같은 새로운 사용자 정의 리소스를 도입하여 라우팅 규칙을 정의하는 보다 세부적이고 표현력 있는 방법을 제공합니다.</li>
      <li>
<strong>프로토콜 독립적</strong> : 주로 HTTP용으로 설계된 Ingress와 달리 Gateway API는 TCP, UDP, TLS를 포함한 여러 프로토콜을 지원합니다.</li>
      <li>
<strong>강화된 보안</strong> : TLS 구성 및 보다 세부적인 액세스 제어에 대한 기본 제공 지원.</li>
      <li>
<strong>교차 네임스페이스 지원</strong> : 서로 다른 네임스페이스의 서비스로 트래픽을 라우팅하여 보다 유연한 아키텍처를 구축할 수 있는 기능을 제공합니다.</li>
      <li>
<strong>확장성</strong> : API는 사용자 정의 리소스 및 정책으로 쉽게 확장할 수 있도록 설계되었습니다.</li>
      <li>
<strong>역할 지향</strong> : 클러스터 운영자, 애플리케이션 개발자, 보안 팀 간의 관심사를 명확하게 분리합니다.</li>
    </ul>
  </li>
  <li>Gateway API의 구성요소 (Resource)
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_8.png" alt="img.png" loading="lazy" width="466" height="130">
    <ul>
      <li>GatewayClass : 클러스터에서 사용 가능한 Gateway의 유형을 정의합니다. 클래스를 구현하는 컨트롤러에의해 관리 됩니다.</li>
      <li>Gateway : 네트워크 트래픽을 처리하는 인프라스트럭쳐 구성요소를 나타냅니다. (예) 클라우드 로드 밸런서, 프록시 서버 등)</li>
      <li>HTTPRoute : HTTP 트래픽에 특화된 라우팅 규칙을 정의합니다.</li>
      <li>TCPRoute : TCP 트래픽에 특화된 라우팅 규칙을 정의합니다.</li>
      <li>Service : Kubernetes 서비스 리소스와 유사하게,트래픽이 라우팅될 백엔드 서비스를 나타냅니다.</li>
    </ul>
  </li>
  <li>역할 지향에 의한 관심사 분리
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_9.png" alt="img.png" class="image-center w-80" loading="lazy" width="2048" height="1203">
    <ul>
      <li>Ingress의 경우 Ingress 리소스에 대한 권한이 있는 사용자가 Ingress 컨트롤러의 동작을 완전히 제어할 수 있습니다.</li>
      <li>하지만 Gateway API에서는 GatewayClass, Gateway 및 Route 리소스를 통해 역할을 분리하여 각 역할에 대한 권한을 세분화하여
필요한 최소한의 권한만 부여할 수 있습니다.</li>
      <li>역할 지향에 의한 권한 부여 예시 - <a href="https://www.anyflow.net/sw-engineer/kubernetes-gateway-api-1">Blog1</a>, <a href="https://www.anyflow.net/sw-engineer/kubernetes-gateway-api-2">Blog2</a>
        <ul>
          <li>아래의 그림 처럼 “Store 개발자”는 Store namespace에서 해당 store PATH 라우팅 정책을 스스로 관리할 수 있습니다.
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_10.png" alt="img.png" class="image-center" loading="lazy" width="2048" height="1137">
<em class="image-caption"><a href="https://gateway-api.sigs.k8s.io/">https://gateway-api.sigs.k8s.io/</a></em>
</li>
          <li>
<strong>Infrastructure 제공자</strong> : 여러 테넌트를 지원하기위해 여러 격리된 클러스터를 운영하는 인프라를 관리합니다.</li>
          <li>
<strong>Cluster 운영자</strong> : 정책, 네트워크 제어, 애플리케이션 권한 등의 클러스터를 관리합니다. 위의 그림에서는 도메인, 인증서, 전체적인 정책 등을 관리합니다.</li>
          <li>
<strong>Application 개발자</strong> : 클러스터에서 동작하는 애플리케이션을 개발하고 배포, 관리합니다. 위의 그림에서는 개별 애플리케이션에 대한 라우팅 정책을 관리합니다.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="cilium-gateway-api-지원">Cilium Gateway API 지원</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api/">관련 문서</a></li>
  <li>Cilium은 Gateway API를 지원하며, Cilium의 서비스 메시 기능과 통합하여 고급 트래픽 관리 및 보안 기능을 제공합니다.</li>
  <li>Cilium은 아래의 resource에 대해 Gateway API v1.2.0을 지원하고, 모든 중요한 기능에 대한 만족토 테스트를 통과하였습니다. (v1.3은 아직 일부항목이 만족되지 않은 상태입니다. - <a href="https://gateway-api.sigs.k8s.io/implementations/v1.3/">https://gateway-api.sigs.k8s.io/implementations/v1.3/</a>)
    <ul>
      <li><a href="https://gateway-api.sigs.k8s.io/api-types/gatewayclass/">GatewayClass</a></li>
      <li><a href="https://gateway-api.sigs.k8s.io/api-types/gateway/">Gateway</a></li>
      <li><a href="https://gateway-api.sigs.k8s.io/api-types/httproute/">HTTPRoute</a></li>
      <li><a href="https://gateway-api.sigs.k8s.io/api-types/grpcroute/">GRPCRoute</a></li>
      <li><a href="https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.TLSRoute">TLSRoute (experimental)</a></li>
      <li>
<a href="https://gateway-api.sigs.k8s.io/api-types/referencegrant/">ReferenceGrant</a>
        <ul>
          <li>추가적으로 <code class="language-plaintext highlighter-rouge">CiliumGatewayClassConfig</code> CRD를 제공하며, <a href="https://gateway-api.sigs.k8s.io/api-types/gatewayclass/#gatewayclass-parameters">GatewayClass.parametersRef</a>에서 참조할 수 있습니다.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>사전 준비
    <ul>
      <li>Cilium은 NodePort 지원이 활성화(<code class="language-plaintext highlighter-rouge">nodePort.enabled=true</code>) 되어 있어있거나 Kube-Proxy 대체 모드(<code class="language-plaintext highlighter-rouge">kubeProxyReplacement=true</code>)로 동작하고 있어야 합니다.</li>
      <li>Cilium은 L7 프록시 기능이 활성화(<code class="language-plaintext highlighter-rouge">l7Proxy=true</code>) 되어 있어야 합니다. (기본값은 true)</li>
      <li>아래의 Gateway API 1.2.0 CRD가 클러스터에 적용되어 있어야 합니다. (설치과정은 <a href="https://gateway-api.sigs.k8s.io/guides/?h=crds#getting-started-with-gateway-api">문서</a>를 참고하세요.)
        <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c"># CRD 설치</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_gatewayclasses.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_gateways.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_httproutes.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_referencegrants.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_grpcroutes.yaml
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml
    
<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get crd | <span class="nb">grep </span>gateway.networking.k8s.io
<span class="c"># =&gt; gatewayclasses.gateway.networking.k8s.io     2025-08-23T10:48:59Z</span>
<span class="c">#    gateways.gateway.networking.k8s.io           2025-08-23T10:48:59Z</span>
<span class="c">#    grpcroutes.gateway.networking.k8s.io         2025-08-23T10:49:01Z</span>
<span class="c">#    httproutes.gateway.networking.k8s.io         2025-08-23T10:49:00Z</span>
<span class="c">#    referencegrants.gateway.networking.k8s.io    2025-08-23T10:49:01Z</span>
<span class="c">#    tlsroutes.gateway.networking.k8s.io          2025-08-23T10:49:02Z</span>
</code></pre></div>        </div>
      </li>
      <li>기본적으로 Gateway API 컨트롤러는 LoadBalancer 타입의 Service를 생성하여 외부에서 접근할 수 있도록 합니다. 대안으로 Cilium 1.16 이상에서는 Cilium L7 Proxy를 <a href="https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api/#gs-gateway-host-network-mode">호스트 네트워크</a>에 노출 시킬 수도 있습니다.</li>
    </ul>
  </li>
  <li>전반적인 동작 메커니즘
    <ul>
      <li>Cilium은 크게 Cilium Agent와 Cilium Operator의 두 컴포넌트로 구성됩니다.</li>
      <li>Cilium Operator는 모든 Gateway API 리소스를 감시하고, 리소스가 적합한지 검증합니다. 만약 리소스가 적합하다면 구성을 수용해서 Cilium Envoy 구성에 반영합니다.</li>
      <li>Cilium Agent는 각 노드에서 실행되며, Cilium Operator가 제공하는 구성을 사용하여 Envoy나 Envoy DaemonSet을 설정하고 관리합니다. Envoy는 트래픽을 처리하고 라우팅하는 역할을 합니다.</li>
    </ul>
  </li>
</ul>

<h3 id="cilium-gateway-api-설정-및-배포">Cilium Gateway API 설정 및 배포</h3>

<h5 id="cilium-gateway-api-활성화">Cilium Gateway API 활성화</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ingress와 Gateway API는 동시에 사용할 수 없기 때문에 ingressController를 비활성화합니다.</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> ingressController.enabled<span class="o">=</span><span class="nb">false</span> <span class="nt">--set</span> gatewayAPI.enabled<span class="o">=</span><span class="nb">true</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart deployment/cilium-operator
<span class="c"># =&gt; deployment.apps/cilium-operator restarted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c">#</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep </span>gateway-api
<span class="c"># =&gt; enable-gateway-api                                true</span>
<span class="c">#    enable-gateway-api-alpn                           false</span>
<span class="c">#    enable-gateway-api-app-protocol                   false</span>
<span class="c">#    enable-gateway-api-proxy-protocol                 false</span>
<span class="c">#    enable-gateway-api-secrets-sync                   true</span>
<span class="c">#    gateway-api-hostnetwork-enabled                   false</span>
<span class="c">#    gateway-api-hostnetwork-nodelabelselector</span>
<span class="c">#    gateway-api-secrets-namespace                     cilium-secrets</span>
<span class="c">#    gateway-api-service-externaltrafficpolicy         Cluster</span>
<span class="c">#    gateway-api-xff-num-trusted-hops                  0</span>

<span class="c"># cilium-ingress 제거 확인</span>
<span class="nv">$ </span>kubectl get svc,pod <span class="nt">-n</span> kube-system

<span class="nv">$ </span>kubectl get GatewayClass
<span class="c"># =&gt; NAME     CONTROLLER                     ACCEPTED   AGE</span>
<span class="c">#    cilium   io.cilium/gateway-controller   True       64s</span>

<span class="nv">$ </span>kubectl get gateway <span class="nt">-A</span>
<span class="c"># =&gt; No resources found</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 아직 배포된 Gateway가 없습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="cilium-gateway-배포">Cilium Gateway 배포</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: my-gateway
spec:
  gatewayClassName: cilium
  listeners:
  - protocol: HTTP
    port: 80
    name: web-gw
    allowedRoutes:
      namespaces:
        from: Same
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: http-app-1
spec:
  parentRefs:
  - name: my-gateway
    namespace: default
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /details
    backendRefs:
    - name: details
      port: 9080
  - matches:
    - headers:
      - type: Exact
        name: magic
        value: foo
      queryParams:
      - type: Exact
        name: great
        value: example
      path:
        type: PathPrefix
        value: /
      method: GET
    backendRefs:
    - name: productpage
      port: 9080
</span><span class="no">EOF
</span><span class="c"># =&gt; gateway.gateway.networking.k8s.io/my-gateway created</span>
<span class="c">#    httproute.gateway.networking.k8s.io/http-app-1 created</span>

<span class="nv">$ </span>kubectl get svc,ep cilium-gateway-my-gateway
<span class="c"># =&gt; NAME                                TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)        AGE</span>
<span class="c">#    service/cilium-gateway-my-gateway   LoadBalancer   10.96.119.37   192.168.10.211   80:30910/TCP   17s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                  ENDPOINTS              AGE</span>
<span class="c">#    endpoints/cilium-gateway-my-gateway   192.192.192.192:9999   17s</span>

<span class="nv">$ </span>kubectl get gateway
<span class="c"># =&gt; NAME         CLASS    ADDRESS          PROGRAMMED   AGE</span>
<span class="c">#    my-gateway   cilium   192.168.10.211   True         32s</span>

<span class="c">## Accepted: Gateway 구성이 올바르고 수용되었음을 나타냅니다.</span>
<span class="c">## Programmed: Gateway 구성이 Envoy에 성공적으로 적용되었음을 나타냅니다.</span>
<span class="c">## ResolvedRefs: 모든 참조된 시크릿이 발견되고 사용 권한이 있음을 나타냅니다.</span>
<span class="nv">$ </span>kc describe gateway
<span class="c"># =&gt; ...</span>
<span class="c">#      Conditions:</span>
<span class="c">#        Last Transition Time:  2025-08-23T11:11:49Z</span>
<span class="c">#        Message:               Gateway successfully scheduled</span>
<span class="c">#        Observed Generation:   1</span>
<span class="c">#        Reason:                Accepted</span>
<span class="c">#        Status:                True</span>
<span class="c">#        Type:                  Accepted</span>
<span class="c">#        Last Transition Time:  2025-08-23T11:11:49Z</span>
<span class="c">#        Message:               Gateway successfully reconciled</span>
<span class="c">#        Observed Generation:   1</span>
<span class="c">#        Reason:                Programmed</span>
<span class="c">#        Status:                True</span>
<span class="c">#        Type:                  Programmed</span>
<span class="c">#    ...</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get httproutes <span class="nt">-A</span>
<span class="c"># =&gt; NAMESPACE   NAME         HOSTNAMES   AGE</span>
<span class="c">#    default     http-app-1               2m53s</span>

<span class="c"># Accepted: HTTPRoute가 올바르게 수용되었음을 나타냅니다.</span>
<span class="c"># ResolvedRefs: 참조된 서비스가 발견되고 유효한 참조임을 나타냅니다.</span>
<span class="nv">$ </span>kc describe httproutes
<span class="c"># =&gt; ...</span>
<span class="c">#        Conditions:</span>
<span class="c">#          Last Transition Time:  2025-08-23T11:11:49Z</span>
<span class="c">#          Message:               Accepted HTTPRoute</span>
<span class="c">#          Observed Generation:   1</span>
<span class="c">#          Reason:                Accepted</span>
<span class="c">#          Status:                True</span>
<span class="c">#          Type:                  Accepted</span>
<span class="c">#          Last Transition Time:  2025-08-23T11:11:49Z</span>
<span class="c">#          Message:               Service reference is valid</span>
<span class="c">#          Observed Generation:   1</span>
<span class="c">#          Reason:                ResolvedRefs</span>
<span class="c">#          Status:                True</span>
<span class="c">#          Type:                  ResolvedRefs</span>
<span class="c">#    ...</span>

<span class="c"># Cilium Operator 로그 확인</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system deployments/cilium-operator | <span class="nb">grep </span>gateway
</code></pre></div></div>

<h5 id="요청-하기">요청 하기</h5>

<ul>
  <li>HTTP 경로 매칭과 HTTP 헤더 매칭</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ GATEWAY</span><span class="o">=</span><span class="si">$(</span>kubectl get gateway my-gateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.addresses[0].value}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$GATEWAY</span>
<span class="c"># =&gt; 192.168.10.211</span>

<span class="c"># HTTP 경로 매칭</span>
<span class="nv">$ </span>curl <span class="nt">--fail</span> <span class="nt">-s</span> http://<span class="s2">"</span><span class="nv">$GATEWAY</span><span class="s2">"</span>/details/1 | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "id": 1,</span>
<span class="c">#      "author": "William Shakespeare",</span>
<span class="c">#      "year": 1595,</span>
<span class="c">#      "type": "paperback",</span>
<span class="c">#      "pages": 200,</span>
<span class="c">#      "publisher": "PublisherA",</span>
<span class="c">#      "language": "English",</span>
<span class="c">#      "ISBN-10": "1234567890",</span>
<span class="c">#      "ISBN-13": "123-1234567890"</span>
<span class="c">#    }</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s --fail -v http://"</span><span class="nv">$GATEWAY</span><span class="s2">"/details/1"</span>
<span class="c"># =&gt; {"id":1,"author":"William Shakespeare","year":1595,"type":"paperback","pages":200,"publisher":"PublisherA","language":"English","ISBN-10":"1234567890","ISBN-13":"123-1234567890"}</span>
<span class="c">#    &lt; HTTP/1.1 200 OK</span>

<span class="c"># HTTP 헤더 매칭</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">-H</span> <span class="s1">'magic: foo'</span> http://<span class="s2">"</span><span class="nv">$GATEWAY</span><span class="s2">"</span><span class="se">\?</span>great<span class="se">\=</span>example
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'vagrant'</span> ssh vagrant@router <span class="s2">"curl -s -v -H 'magic: foo' http://"</span><span class="nv">$GATEWAY</span><span class="s2">"</span><span class="se">\?</span><span class="s2">great</span><span class="se">\=</span><span class="s2">example"</span>
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
</code></pre></div></div>

<h5 id="https-예제">HTTPS 예제</h5>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/https/">관련 문서</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: tls-gateway
spec:
  gatewayClassName: cilium
  listeners:
  - name: https-1
    protocol: HTTPS
    port: 443
    hostname: "bookinfo.cilium.rocks"
    tls:
      certificateRefs:
      - kind: Secret
        name: demo-cert
  - name: https-2
    protocol: HTTPS
    port: 443
    hostname: "webpod.cilium.rocks"
    tls:
      certificateRefs:
      - kind: Secret
        name: demo-cert
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: https-app-route-1
spec:
  parentRefs:
  - name: tls-gateway
  hostnames:
  - "bookinfo.cilium.rocks"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /details
    backendRefs:
    - name: details
      port: 9080
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: https-app-route-2
spec:
  parentRefs:
  - name: tls-gateway
  hostnames:
  - "webpod.cilium.rocks"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: webpod
      port: 80
</span><span class="no">EOF
</span><span class="c"># =&gt; gateway.gateway.networking.k8s.io/tls-gateway created</span>
<span class="c">#    httproute.gateway.networking.k8s.io/https-app-route-1 created</span>
<span class="c">#    httproute.gateway.networking.k8s.io/https-app-route-2 created</span>

<span class="c">#</span>
<span class="nv">$ </span>kubectl get gateway tls-gateway
<span class="c"># =&gt; NAME          CLASS    ADDRESS          PROGRAMMED   AGE</span>
<span class="c">#    tls-gateway   cilium   192.168.10.213   True         24s</span>

<span class="nv">$ </span>kubectl get httproutes https-app-route-1 https-app-route-2
<span class="c"># =&gt; NAME                HOSTNAMES                   AGE</span>
<span class="c">#    https-app-route-1   ["bookinfo.cilium.rocks"]   36s</span>
<span class="c">#    https-app-route-2   ["webpod.cilium.rocks"]     36s</span>

<span class="c">#</span>
<span class="nv">$ GATEWAY2</span><span class="o">=</span><span class="si">$(</span>kubectl get gateway tls-gateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.addresses[0].value}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$GATEWAY2</span>
<span class="c"># =&gt; 192.168.10.213</span>

<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">--resolve</span> bookinfo.cilium.rocks:443:<span class="k">${</span><span class="nv">GATEWAY2</span><span class="k">}</span> https://bookinfo.cilium.rocks/details/1 | jq
<span class="c"># =&gt; {</span>
<span class="c">#      "id": 1,</span>
<span class="c">#      "author": "William Shakespeare",</span>
<span class="c">#      "year": 1595,</span>
<span class="c">#      "type": "paperback",</span>
<span class="c">#      "pages": 200,</span>
<span class="c">#      "publisher": "PublisherA",</span>
<span class="c">#      "language": "English",</span>
<span class="c">#      "ISBN-10": "1234567890",</span>
<span class="c">#      "ISBN-13": "123-1234567890"</span>
<span class="c">#    }</span>
  
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">--resolve</span> webpod.cilium.rocks:443:<span class="k">${</span><span class="nv">GATEWAY2</span><span class="k">}</span>   https://webpod.cilium.rocks/ <span class="nt">-v</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    * TLSv1.3 (OUT), TLS handshake, Client hello (1):</span>
<span class="c">#    *  CAfile: /etc/ssl/certs/ca-certificates.crt</span>
<span class="c">#    *  CApath: /etc/ssl/certs</span>
<span class="c">#    ...</span>
<span class="c">#    *  subjectAltName: host "webpod.cilium.rocks" matched cert's "*.cilium.rocks"</span>
<span class="c">#    *  issuer: O=mkcert development CA; OU=root@k8s-ctr; CN=mkcert root@k8s-ctr</span>
<span class="c">#    *  SSL certificate verify ok.</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>TLS Termination이 잘 되어서 https로 요청시 인증서가 유효하고, 서비스로 요청이 잘 전달되는 것을 확인할 수 있습니다.</li>
</ul>

<h5 id="tls-route">TLS Route</h5>

<ul>
  <li>TLS Route는 앞에서 살펴본 TLS Termination과는 다르게 TLS Passthrough를 지원합니다.
    <ul>
      <li>
<strong>TLS Termination</strong> : Gateway가 TLS 연결을 종료하고, 내부 서비스로는 평문 HTTP 트래픽을 전달합니다. (즉, Gateway가 클라이언트와 서버 간의 TLS 세션을 종료합니다.)</li>
      <li>
        <p><strong>TLS Passthrough</strong> : Gateway가 TLS 연결을 종료하지 않고, 클라이언트와 서버 간의 TLS 트래픽을 그대로 전달합니다.</p>

        <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
        <div class="mermaid">
graph TD
  A[Client] --&gt;|TLS Handshake| B["Gateway (TLS Termination)"]
  B --&gt;|HTTP Traffic| C[Backend Service]
  A2[Client] --&gt;|TLS Handshake| B2["Gateway (TLS Passthrough)"]
  B2 --&gt;|TLS Traffic| C2[Backend Service]
</div>
      </li>
    </ul>
  </li>
  <li>샘플앱 배포</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Deploy the Demo app : HTTPS 웹서버</span>
<span class="c"># We will be using a NGINX web server. Review the NGINX configuration.</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">EOF</span><span class="sh">' &gt; nginx.conf
events {
}

http {
  log_format main '</span><span class="nv">$remote_addr</span><span class="sh"> - </span><span class="nv">$remote_user</span><span class="sh"> [</span><span class="nv">$time_local</span><span class="sh">]  </span><span class="nv">$status</span><span class="sh"> '
  '"</span><span class="nv">$request</span><span class="sh">" </span><span class="nv">$body_bytes_sent</span><span class="sh"> "</span><span class="nv">$http_referer</span><span class="sh">" '
  '"</span><span class="nv">$http_user_agent</span><span class="sh">" "</span><span class="nv">$http_x_forwarded_for</span><span class="sh">"';
  access_log /var/log/nginx/access.log main;
  error_log  /var/log/nginx/error.log;

  server {
    listen 443 ssl;

    root /usr/share/nginx/html;
    index index.html;

    server_name nginx.cilium.rocks;
    ssl_certificate /etc/nginx-server-certs/tls.crt;
    ssl_certificate_key /etc/nginx-server-certs/tls.key;
  }
}
</span><span class="no">EOF

</span><span class="c"># As you can see, it listens on port 443 for SSL traffic. Notice it specifies the certificate and key previously created.</span>
<span class="c"># We will need to mount the files to the right path (/etc/nginx-server-certs) when we deploy the server.</span>
<span class="c"># The NGINX server configuration is held in a Kubernetes ConfigMap. Let's create it.</span>
<span class="nv">$ </span>kubectl create configmap nginx-configmap <span class="nt">--from-file</span><span class="o">=</span>nginx.conf<span class="o">=</span>./nginx.conf
<span class="c"># =&gt; configmap/nginx-configmap created</span>

<span class="c"># Review the NGINX server Deployment and the Service fronting it:</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: my-nginx
  labels:
    run: my-nginx
spec:
  ports:
    - port: 443
      protocol: TCP
  selector:
    run: my-nginx
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-nginx
spec:
  selector:
    matchLabels:
      run: my-nginx
  replicas: 1
  template:
    metadata:
      labels:
        run: my-nginx
    spec:
      containers:
        - name: my-nginx
          image: nginx
          ports:
            - containerPort: 443
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx
              readOnly: true
            - name: nginx-server-certs
              mountPath: /etc/nginx-server-certs
              readOnly: true
      volumes:
        - name: nginx-config
          configMap:
            name: nginx-configmap
        - name: nginx-server-certs
          secret:
            secretName: demo-cert
</span><span class="no">EOF
</span><span class="c"># =&gt; service/my-nginx created</span>
<span class="c">#    deployment.apps/my-nginx created</span>

<span class="c"># Verify the Service and Deployment have been deployed successfully:</span>
<span class="nv">$ </span>kubectl get deployment,svc,ep my-nginx
<span class="c"># =&gt; NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/my-nginx   1/1     1            1           17s</span>
<span class="c">#    </span>
<span class="c">#    NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="c">#    service/my-nginx   ClusterIP   10.96.141.153   &lt;none&gt;        443/TCP   17s</span>
<span class="c">#    </span>
<span class="c">#    NAME                 ENDPOINTS          AGE</span>
<span class="c">#    endpoints/my-nginx   172.20.1.187:443   17s</span>
</code></pre></div></div>

<ul>
  <li>Gateway 배포</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># </span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: cilium-tls-gateway
spec:
  gatewayClassName: cilium
  listeners:
    - name: https
      hostname: "nginx.cilium.rocks"
      port: 443
      protocol: TLS
      tls:
        mode: Passthrough
      allowedRoutes:
        namespaces:
          from: All
---
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TLSRoute
metadata:
  name: nginx
spec:
  parentRefs:
    - name: cilium-tls-gateway
  hostnames:
    - "nginx.cilium.rocks"
  rules:
    - backendRefs:
        - name: my-nginx
          port: 443
</span><span class="no">EOF
</span><span class="c"># =&gt; gateway.gateway.networking.k8s.io/cilium-tls-gateway created</span>
<span class="c">#    tlsroute.gateway.networking.k8s.io/nginx created</span>

<span class="c"># The Gateway does not actually inspect the traffic aside from using the SNI header for routing. Indeed the hostnames field defines a set of SNI names that should match against the SNI attribute of TLS ClientHello message in TLS handshake.</span>
<span class="c"># Let's now deploy the Gateway and the TLSRoute to the cluste</span>
<span class="nv">$ </span>kubectl get gateway cilium-tls-gateway
<span class="c"># =&gt; NAME                 CLASS    ADDRESS          PROGRAMMED   AGE</span>
<span class="c">#    cilium-tls-gateway   cilium   192.168.10.214   True         10s</span>

<span class="nv">$ GATEWAY</span><span class="o">=</span><span class="si">$(</span>kubectl get gateway cilium-tls-gateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.addresses[0].value}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$GATEWAY</span>
<span class="c"># =&gt; 192.168.10.214</span>

<span class="c"># Let's also double check the TLSRoute has been provisioned successfully and has been attached to the Gateway.</span>
<span class="nv">$ </span>kubectl get tlsroutes.gateway.networking.k8s.io <span class="nt">-o</span> json | jq <span class="s1">'.items[0].status.parents[0]'</span>
<span class="c"># =&gt; {</span>
<span class="c">#      "conditions": [</span>
<span class="c">#        {</span>
<span class="c">#          "lastTransitionTime": "2025-08-23T11:34:35Z",</span>
<span class="c">#          "message": "Accepted TLSRoute",</span>
<span class="c">#          "observedGeneration": 1,</span>
<span class="c">#          "reason": "Accepted",</span>
<span class="c">#          "status": "True",</span>
<span class="c">#          "type": "Accepted"</span>
<span class="c">#        },</span>
<span class="c">#        {</span>
<span class="c">#          "lastTransitionTime": "2025-08-23T11:34:35Z",</span>
<span class="c">#          "message": "Service reference is valid",</span>
<span class="c">#          "observedGeneration": 1,</span>
<span class="c">#          "reason": "ResolvedRefs",</span>
<span class="c">#          "status": "True",</span>
<span class="c">#          "type": "ResolvedRefs"</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>TLS 요청 보내기</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># nginx 파드에서 tcpdump 실행</span>

<span class="c"># nginx 파드로 진입</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> my-nginx-d65548cd4-nn5b4 <span class="nt">--</span> bash
<span class="nt">---</span>
<span class="c"># tcpdump 설치</span>
<span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt <span class="nb">install</span> <span class="nt">-y</span> tcpdump
<span class="c"># tcpdump 실행 (모든 tcp 패킷 캡처)</span>
<span class="nv">$ </span>tcpdump tcp
<span class="c"># =&gt; tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="c">#    listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="c">#    11:41:57.543620 IP 172.20.0.16.37591 &gt; my-nginx-d65548cd4-nn5b4.&lt;span style="color: green;"&gt;443&lt;/span&gt;: Flags [S], seq 2314011092, win 64240, options [mss 1460,sackOK,TS val 363195874 ecr 0,nop,wscale 7], length 0</span>
<span class="c">#    11:41:57.544029 IP my-nginx-d65548cd4-nn5b4.&lt;span style="color: green;"&gt;443&lt;/span&gt; &gt; 172.20.0.16.37591: Flags [S.], seq 3765696136, ack 2314011093, win 65160, options [mss 1460,sackOK,TS val 3668269186 ecr 363195874,nop,wscale 7], length 0</span>
<span class="c">#    11:41:57.546319 IP 172.20.0.16.37591 &gt; my-nginx-d65548cd4-nn5b4.443: Flags [.], ack 1, win 502, options [nop,nop,TS val 363195876 ecr 3668269186], length 0</span>
<span class="c">#    11:41:57.546319 IP 172.20.0.16.37591 &gt; my-nginx-d65548cd4-nn5b4.443: Flags [P.], seq 1:518, ack 1, win 502, options [nop,nop,TS val 363195876 ecr 3668269186], length 517    </span>
<span class="c">#    ...</span>
<span class="nt">---</span>

<span class="c"># k8s-ctr에서 TLS 요청 보내기</span>
<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">--resolve</span> <span class="s2">"nginx.cilium.rocks:443:</span><span class="nv">$GATEWAY</span><span class="s2">"</span> <span class="s2">"https://nginx.cilium.rocks:443"</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    * Server certificate:</span>
<span class="c">#    *  subject: O=mkcert development certificate; OU=root@k8s-ctr</span>
<span class="c">#    *  start date: Aug 23 08:27:20 2025 GMT</span>
<span class="c">#    *  expire date: Oct 01 08:27:20 2027 GMT</span>
<span class="c">#    *  subjectAltName: host "nginx.cilium.rocks" matched cert's "*.cilium.rocks"</span>
<span class="c">#    *  issuer: O=mkcert development CA; OU=root@k8s-ctr; CN=mkcert root@k8s-ctr</span>
<span class="c">#    *  SSL certificate verify ok.</span>
<span class="c">#    ...</span>
<span class="c">#    &lt; HTTP/1.1 200 OK</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>nginx 파드에서 tcpdump 결과 nginx의 https(443) 포트로 인입되어 https(443) 포트를 통해 응답이 나가는 것을 확인할 수 있습니다.</li>
  <li>즉, TLS Termination과는 달리 전체 TLS 트래픽이 nginx 파드까지 전달된 것을 확인할 수 있습니다.</li>
</ul>

<h5 id="gateway-api-주소-지정">Gateway API 주소 지정</h5>

<ul>
  <li>Gateway의 External IP를 직접 지정 가능합니다. - <a href="https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api/#gateway-api-addresses-support">관련 문서</a>
</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl edit gateway tls-gateway
<span class="c"># spec에 addresses 추가</span>
<span class="nt">---</span>
...
spec:
  addresses:                <span class="c"># 추가됨</span>
  - <span class="nb">type</span>: IPAddress         <span class="c">#     </span>
    value: 192.168.10.219   <span class="c"># </span>
  gatewayClassName: cilium
...
<span class="nt">---</span>
<span class="c"># =&gt; gateway.gateway.networking.k8s.io/tls-gateway edited</span>
</code></pre></div></div>

<ul>
  <li>호출 테스트</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ GATEWAY</span><span class="o">=</span><span class="si">$(</span>kubectl get gateway tls-gateway <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.addresses[0].value}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$GATEWAY</span>
<span class="c"># =&gt; 192.168.10.219</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 지정한 IP(192.168.10.219)로 External IP가 변경된 것을 확인할 수 있습니다.&lt;/span&gt;</span>

<span class="nv">$ </span>curl <span class="nt">-v</span> <span class="nt">--resolve</span> <span class="s2">"nginx.cilium.rocks:443:</span><span class="nv">$GATEWAY</span><span class="s2">"</span> <span class="s2">"https://nginx.cilium.rocks:443"</span> 
</code></pre></div></div>

<h5 id="ingress에서-gateway-api로-마이그레이션">Ingress에서 Gateway API로 마이그레이션</h5>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress-to-gateway/ingress-to-gateway/">관련 문서</a></li>
  <li>
<strong>수동 전환</strong> : 기존의 Ingress API 리소스를 참고하여 동일한 구성을 가진 Gateway API 리소스를 수동으로 작성합니다.</li>
  <li>
<strong>자동 전환</strong> : <a href="https://github.com/kubernetes-sigs/ingress2gateway">ingress2gateway</a> 툴과 같은 자동화 도구를 사용하여 Ingress 리소스를 Gateway API 리소스로 변환합니다.</li>
  <li>마이그레이션 예제
    <ul>
      <li>HTTP Migration 예제 - <a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress-to-gateway/http-migration/">Docs</a>
</li>
      <li>TLS Migration 예제 - <a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress-to-gateway/tls-migration/">Docs</a>
</li>
    </ul>
  </li>
</ul>

<h6 id="실습-리소스-삭제">실습 리소스 삭제</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Gateway 삭제</span>
<span class="nv">$ </span>kubectl delete gateway my-gateway tls-gateway cilium-tls-gateway

<span class="c"># Bookinfo 삭제</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/istio/istio/release-1.26/samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></div></div>

<hr>

<h2 id="mutual-authentication-beta">Mutual Authentication (Beta)</h2>

<ul>
  <li>Cilium도 istio와 마찬가지로 SPIFFE(“스피페”라고 발음하는것 같습니다.) 통한 상호 인증을 지원합니다.</li>
  <li>아직은 Beta 단계이기 때문에 프로덕션 환경에서 사용하기에는 무리가 있어보입니다.</li>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/mutual-authentication/mutual-authentication/">관련 문서</a></li>
</ul>

<h3 id="주요-개념">주요 개념</h3>

<ul>
  <li>SPIFFE
    <ul>
      <li>Secure Production Identity Framework For Everyone의 약자로
클라우드 네이티브 환경에서 서비스 간의 신뢰를 구축하기 위한 오픈 소스 표준입니다.</li>
      <li>서비스가 서로를 신뢰할 수 있도록 고유한 식별자(SPIFFE ID)를 제공합니다.</li>
      <li>ID를 발급하고 부트스트랩하기 위해 다음 사양을 정의 합니다.
        <ul>
          <li>SPIFFE ID : 신뢰 도메인 내의 서비스 고유 ID</li>
          <li>Workload Endpoint : 워크로드의 ID를 나타내는 엔드포인트</li>
          <li>Workload API : SPIFFE ID가 포함된 인증서를 서명하고 발급하는 API</li>
          <li>SVID (SPIFFE Verifiable Identity Document) : Workload API가 발급하는 인증서</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>TLS와 mTLS - <a href="https://www.jacobbaek.com/1040">관련 블로그</a>
    <ul>
      <li>TLS (Transport Layer Security) : 네트워크 통신을 암호화하여 데이터의 기밀성과 무결성을 보장하는 프로토콜입니다.</li>
      <li>mTLS (Mutual TLS) : TLS의 확장으로, 클라이언트와 서버가 서로를 인증하는 양방향 인증을 제공합니다.
        <ul>
          <li>기본 TLS가 서버측의 인증서를 활용하여, 적합한 서버임을 증명하는것 과는 달리 mTLS는 클라이언트와 서버 모두가 인증서를 사용하여 서로의 신원을 확인합니다.</li>
          <li>mTLS는 서비스 간의 신뢰를 구축하고, 중간자 공격과 같은 보안 위협을 방지하는 데 효과적입니다.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="cilium에서의-상호-인증">Cilium에서의 상호 인증</h3>

<ul>
  <li>Cilium은 SPIFFE 표준을 준수하는 구현체인 <a href="https://spiffe.io/spire/">spire 서버</a>를 사용하여 상호인증을 구현합니다.</li>
  <li>Cilium은 spire 서버와 통신하여 각 워크로드에 대한 SPIFFE ID를 발급받고, 이를 기반으로 각 노드에서 실행중인 워크로드의 ID 요청을 검증합니다.</li>
  <li>Spire 서버는 Kubernetes에서 실행되는 Spire 에이전트의 검증을 위해 PSAT(Kubernetes Projected Service Account Token)을 사용합니다.</li>
</ul>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_11.png" alt="img.png" class="image-center" loading="lazy" width="1080" height="567">
<img src="/assets/2025/cilium/w6/20250824_cilium_w6_13.png" alt="img_2.png" class="image-center" loading="lazy" width="2048" height="592">
<em class="image-caption">Cilium의 상호인증 구조</em></p>

<h5 id="cilium의-상호-인증-아키텍쳐">Cilium의 상호 인증 아키텍쳐</h5>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_14.png" alt="img.png" class="image-center" loading="lazy" width="960" height="810"></p>

<ul>
  <li>Cilium의 상호 인증은 다음과 같은 주요 구성 요소로 이루어져 있습니다.
    <ul>
      <li>
<strong>Spire 서버</strong> : SPIFFE ID를 발급하고 관리하는 중앙 컴포넌트입니다. Cilium Operator와 통신하여 워크로드의 ID 요청을 처리합니다.</li>
      <li>
<strong>Spire 에이전트</strong> : 각 노드에서 실행되며, Spire 서버와 통신하여 워크로드에 대한 SPIFFE ID를 요청하고 갱신합니다.</li>
      <li>
<strong>Cilium Agent</strong> : 각 노드에서 실행되며, Spire 에이전트와 통신하여 워크로드의 ID를 검증합니다.</li>
    </ul>
  </li>
</ul>

<hr>

<h2 id="l7-aware-traffic-management">L7-Aware Traffic Management</h2>

<h3 id="l7-aware-traffic-management-소개">L7-Aware Traffic Management 소개</h3>

<ul>
  <li>L7-Aware Traffic Management는 HTTP, gRPC와 같은 애플리케이션 계층(Layer 7) 프로토콜의 특성을 이해하고 이를 기반으로 트래픽을 세밀하게 제어하는 기능입니다.</li>
  <li>Cilium은 eBPF와 Envoy 프록시를 통해 강력한 L7 트래픽 관리 기능을 제공합니다.</li>
</ul>

<h5 id="주요-기능">주요 기능</h5>

<ul>
  <li>
<strong>L7 프로토콜 인식</strong>: HTTP, gRPC, Kafka 등 다양한 애플리케이션 계층 프로토콜을 인식하고 제어할 수 있습니다.</li>
  <li>
<strong>고급 로드 밸런싱</strong>: 요청 헤더, 경로, 메소드 등을 기반으로 한 지능적인 로드 밸런싱이 가능합니다.</li>
  <li>
<strong>트래픽 분할</strong>: 동일한 서비스의 여러 버전 간에 트래픽을 비율에 따라 분배할 수 있어 카나리 배포 및 A/B 테스트를 지원합니다.</li>
  <li>
<strong>자동 재시도</strong>: 일시적인 오류 발생 시 요청을 자동으로 재시도하여 애플리케이션의 복원력을 높일 수 있습니다.</li>
  <li>
<strong>타임아웃 및 서킷 브레이킹</strong>: 장애 확산을 방지하기 위한 타임아웃 설정 및 서킷 브레이커 패턴을 지원합니다.</li>
</ul>

<h5 id="구현-방식">구현 방식</h5>

<ul>
  <li>Cilium은 eBPF를 사용하여 네트워크 패킷을 가로채고, L7 처리가 필요한 경우 Envoy 프록시로 트래픽을 리디렉션합니다.</li>
  <li>이러한 아키텍처는 기존 서비스 메시 솔루션에 비해 더 적은 오버헤드를 제공합니다.</li>
</ul>

<h5 id="istio와의-비교">Istio와의 비교</h5>

<ul>
  <li>Cilium의 L7 트래픽 관리는 Istio와 같은 기존 Service Mesh 보다 성능 오버헤드가 적습니다.</li>
  <li>kubeproxy 대신 eBPF를 사용하여 필요한 트래픽만 선택적으로 Envoy 프록시로 리디렉션하기 때문입니다.</li>
  <li>그러나 기능 측면에서는 Istio가 더 풍부한 옵션을 제공할 수 있습니다.</li>
</ul>

<h3 id="실습-l7-트래픽-관리">실습: L7 트래픽 관리</h3>

<ul>
  <li>이번 실습에는 isovalent에서 제공하는 온라인 Lab 환경을 사용합니다. <a href="https://isovalent.com/labs/cilium-envoy-l7-proxy/">https://isovalent.com/labs/cilium-envoy-l7-proxy/</a>
</li>
</ul>

<h5 id="실습환경-설정">실습환경 설정</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 데모 앱 설치</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> sw-pods.yaml
<span class="c"># =&gt; service/deathstar created</span>
<span class="c">#    deployment.apps/deathstar created</span>
<span class="c">#    pod/tiefighter created</span>
<span class="c">#    pod/xwing created</span>

<span class="c"># 앱 배포 확인</span>
<span class="nv">$ </span>kubectl rollout status deployment/deathstar
<span class="c"># =&gt; deployment "deathstar" successfully rolled out</span>

<span class="nv">$ </span>kubectl get pod xwing
<span class="c"># =&gt; NAME    READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    xwing   1/1     Running   0          2m22s</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>xwing <span class="nt">--</span> curl <span class="nt">--max-time</span> 1 <span class="nt">-s</span> <span class="nt">-X</span> POST deathstar.default.svc.cluster.local/v1/request-landing
<span class="c"># =&gt; Ship landed</span>

<span class="nv">$ </span>hubble observe <span class="nt">--to-pod</span> default/deathstar
<span class="c"># =&gt; Aug 23 14:05:42.357: default/xwing (ID:57137) &lt;&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) post-xlate-fwd TRANSLATED (TCP)</span>
<span class="c">#    Aug 23 14:05:42.357: default/xwing:54550 (ID:57137) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-endpoint FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Aug 23 14:05:42.357: default/xwing:54550 (ID:57137) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-endpoint FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Aug 23 14:05:42.357: default/xwing:54550 (ID:57137) &lt;&gt; default/deathstar-67c5c5c88-d9xct (ID:3549) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Aug 23 14:05:42.357: default/xwing:54550 (ID:57137) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Aug 23 14:05:42.358: default/xwing:54550 (ID:57137) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Aug 23 14:05:42.358: default/xwing:54550 (ID:57137) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-endpoint FORWARDED (TCP Flags: ACK)</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_16.png" alt="img.png" loading="lazy" width="759" height="278"></p>

<h5 id="http-트래픽-관측하기">HTTP 트래픽 관측하기</h5>

<ul>
  <li>L7 Cilium Network Policy를 사용하여 HTTP 트래픽을 관측할 수 있습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># The trace:to-proxy filter will show all flows that go through a proxy. In general, this could be either Envoy or the Cilium DNS proxy. </span>
<span class="c"># However, since we have not yet deployed a DNS Network Policy, you will only see flows related to Envoy at the moment.</span>
<span class="nv">$ </span>hubble observe <span class="nt">--type</span> trace:to-proxy
<span class="c"># =&gt; Aug 23 14:10:33.004: default/tiefighter:53502 (ID:13923) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-proxy FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Aug 23 14:10:33.004: default/tiefighter:53502 (ID:13923) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-proxy FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Aug 23 14:10:33.004: default/tiefighter:53502 (ID:13923) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-proxy FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Aug 23 14:10:33.006: default/tiefighter:53502 (ID:13923) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) to-proxy FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    ...</span>

<span class="c"># Let's extract all the flow information based on the protocol (e.g. HTTP) and source pod (e.g. the Tie Fighter), then export the result with the JSON output option, and finally filter with jq to only see the .flow.l7 field. This will show us the specific details parsed from the L7 traffic, such as the method and headers:</span>
<span class="c"># Observe the details of the flow, in particular the envoy-specific headers added to the request:</span>
<span class="c">## X-Envoy-Internal</span>
<span class="c">## X-Request-Id</span>
<span class="nv">$ </span>hubble observe <span class="nt">--protocol</span> http <span class="nt">--from-pod</span> default/tiefighter <span class="nt">-o</span> jsonpb | <span class="se">\</span>
  <span class="nb">head</span> <span class="nt">-n</span> 1 | jq <span class="s1">'.flow.l7'</span>
<span class="c"># =&gt; {</span>
<span class="c">#      "type": "REQUEST",</span>
<span class="c">#      "http": {</span>
<span class="c">#        "method": "POST",</span>
<span class="c">#        "url": "http://deathstar.default.svc.cluster.local/v1/request-landing",</span>
<span class="c">#        "protocol": "HTTP/1.1",</span>
<span class="c">#        "headers": [</span>
<span class="c">#          {</span>
<span class="c">#            "key": ":scheme",</span>
<span class="c">#            "value": "http"</span>
<span class="c">#          },</span>
<span class="c">#          {</span>
<span class="c">#            "key": "Accept",</span>
<span class="c">#            "value": "*/*"</span>
<span class="c">#          },</span>
<span class="c">#          {</span>
<span class="c">#            "key": "User-Agent",</span>
<span class="c">#            "value": "curl/7.88.1"</span>
<span class="c">#          },</span>
<span class="c">#          {</span>
<span class="c">#            "key": "X-Envoy-Internal",</span>
<span class="c">#            "value": "true"</span>
<span class="c">#          },</span>
<span class="c">#          {</span>
<span class="c">#            "key": "X-Request-Id",</span>
<span class="c">#            "value": "45ee8e37-6ae0-48bf-925d-13c98532b113"</span>
<span class="c">#          }</span>
<span class="c">#        ]</span>
<span class="c">#      }</span>
<span class="c">#    }</span>

<span class="c"># Let's use the X-Request-Id to match a request and its response.</span>
<span class="c"># First, we'll need to make sure egress traffic from the Tie Fighter is captured by Envoy, so we'll need a L7 CNP for that.</span>
<span class="c"># If we apply an egress CNP though, this will disrupt DNS requests, which are also egress traffic, so we need to add a DNS policy as well:</span>
<span class="nv">$ </span><span class="nb">cat </span>policies/tiefighter.yaml
<span class="c"># =&gt; apiVersion: cilium.io/v2</span>
<span class="c">#    kind: CiliumNetworkPolicy</span>
<span class="c">#    metadata:</span>
<span class="c">#      name: tiefighter</span>
<span class="c">#      namespace: default</span>
<span class="c">#    spec:</span>
<span class="c">#      endpointSelector:</span>
<span class="c">#        matchLabels:</span>
<span class="c">#          org: empire</span>
<span class="c">#          class: tiefighter</span>
<span class="c">#      egress:</span>
<span class="c">#        - toEndpoints:</span>
<span class="c">#            - matchLabels:</span>
<span class="c">#                class: deathstar</span>
<span class="c">#                org: empire</span>
<span class="c">#          toPorts:</span>
<span class="c">#            - ports:</span>
<span class="c">#                - port: "80"</span>
<span class="c">#                  protocol: TCP</span>
<span class="c">#              rules:</span>
<span class="c">#                http:</span>
<span class="c">#                - method: POST</span>
<span class="c">#                  path: /v1/request-landing</span>
              
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> policies/dns.yaml <span class="nt">-f</span> policies/tiefighter.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/dns created</span>
<span class="c">#    ciliumnetworkpolicy.cilium.io/tiefighter created</span>

<span class="c"># All these flows are ingress flows, as you can see by filtering for HTTP flows in the egress direction, which should return nothing:</span>
<span class="c"># You can now see egress requests from the Tie Fighter being forwarded to the Death Star, as well as the responses from the Death Star:</span>
<span class="c"># When using Kubernetes Network Policies, responses are automatically allowed and do not require an explicit rule.</span>
<span class="c"># This is why egress traffic corresponding to the response from the Death Star to the Tie Fighter is allowed, even though there is not egress policy for it.</span>
<span class="nv">$ </span>hubble observe <span class="nt">--protocol</span> http <span class="nt">--traffic-direction</span> egress
<span class="c"># =&gt; Aug 23 14:12:40.875: default/tiefighter:57526 (ID:13923) -&gt; default/deathstar-67c5c5c88-d9xct:80 (ID:3549) http-request FORWARDED (HTTP/1.1 POST http://deathstar.default.svc.cluster.local/v1/request-landing)</span>
<span class="c">#    Aug 23 14:12:40.876: default/tiefighter:57526 (ID:13923) &lt;- default/deathstar-67c5c5c88-d9xct:80 (ID:3549) http-response FORWARDED (HTTP/1.1 200 0ms (POST http://deathstar.default.svc.cluster.local/v1/request-landing))</span>
<span class="c">#    ...</span>

<span class="c"># Now, let's match request IDs! Run the following command to record some Hubble HTTP flows and save them to a file:</span>
<span class="nv">$ </span>hubble observe <span class="nt">--namespace</span> default <span class="nt">--protocol</span> http <span class="nt">-o</span> jsonpb <span class="o">&gt;</span> flows.json

<span class="c"># Find the first EGRESS flow in the file and get its ID:</span>
<span class="nv">$ REQUEST_ID</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat </span>flows.json | jq <span class="nt">-r</span> <span class="s1">'.flow | select(.source.labels[0]=="k8s:app.kubernetes.io/name=tiefighter" and .traffic_direction=="EGRESS") .l7.http.headers[] | select(.key=="X-Request-Id") .value'</span> | <span class="nb">head</span> <span class="nt">-n1</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$REQUEST_ID</span>
<span class="c"># =&gt; 91e9eb02-b1a7-4379-9825-8c6f72124d04</span>

<span class="c"># Then find all flows with this request ID in the file and display their source identities:</span>
<span class="c">## an egress flow from the tiefighter to the deathstar, corresponding to the original request</span>
<span class="c">## the ingress flow for the same request, being forwarded from the proxy to the Death Star</span>
<span class="c">## another egress flow for the response, from the deathstar to the tiefighter</span>
<span class="c">## the corresponding ingress flow from the deathstar pod to the tiefighter</span>

<span class="nv">$ </span><span class="nb">cat </span>flows.json | <span class="se">\</span>
  jq <span class="s1">'select(.flow.l7.http.headers[] | .value == "'</span><span class="nv">$REQUEST_ID</span><span class="s1">'") .flow | {src_label: .source.labels[0], dst_label: .destination.labels[0], traffic_direction, type: .l7.type, time}'</span>
<span class="c"># =&gt; {</span>
<span class="c">#      "src_label": "k8s:app.kubernetes.io/name=tiefighter",</span>
<span class="c">#      "dst_label": "k8s:app.kubernetes.io/name=deathstar",</span>
<span class="c">#      "traffic_direction": "EGRESS",</span>
<span class="c">#      "type": "REQUEST",</span>
<span class="c">#      "time": "2025-08-23T14:13:38.661418360Z"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "src_label": "k8s:app.kubernetes.io/name=tiefighter",</span>
<span class="c">#      "dst_label": "k8s:app.kubernetes.io/name=deathstar",</span>
<span class="c">#      "traffic_direction": "INGRESS",</span>
<span class="c">#      "type": "REQUEST",</span>
<span class="c">#      "time": "2025-08-23T14:13:38.661841958Z"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "src_label": "k8s:app.kubernetes.io/name=deathstar",</span>
<span class="c">#      "dst_label": "k8s:app.kubernetes.io/name=tiefighter",</span>
<span class="c">#      "traffic_direction": "INGRESS",</span>
<span class="c">#      "type": "RESPONSE",</span>
<span class="c">#      "time": "2025-08-23T14:13:38.662308747Z"</span>
<span class="c">#    }</span>
<span class="c">#    {</span>
<span class="c">#      "src_label": "k8s:app.kubernetes.io/name=deathstar",</span>
<span class="c">#      "dst_label": "k8s:app.kubernetes.io/name=tiefighter",</span>
<span class="c">#      "traffic_direction": "EGRESS",</span>
<span class="c">#      "type": "RESPONSE",</span>
<span class="c">#      "time": "2025-08-23T14:13:38.662497732Z"</span>
<span class="c">#    }</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_17.png" alt="img.png" loading="lazy" width="1438" height="804"></p>

<h5 id="l7-메트릭">L7 메트릭</h5>

<ul>
  <li>Envoy를 통해 Hubble에서 L7 메트릭을 수집할 수 있고, Prometheus로 내보낼 수 있습니다.</li>
</ul>

<p><img src="/assets/2025/cilium/w6/20250824_cilium_w6_15.png" alt="img.png" class="image-center image-bg" loading="lazy" width="1999" height="1100">
<em class="image-caption">Cilium의 L7 메트릭 수집</em></p>

<h5 id="envoy를-통한-l7-네트워크-정책-적용">Envoy를 통한 L7 네트워크 정책 적용</h5>

<ul>
  <li>
<strong>HTTP</strong> : 지난 포스트에서 <a href="https://sweetlittlebird.github.io/posts/2025-07-27-Cilium-Week2/#http-aware-l7-%EC%A0%95%EC%B1%85-%EC%A0%81%EC%9A%A9-%EB%B0%8F-%ED%85%8C%EC%8A%A4%ED%8A%B8">[Cilium] (Observability) Hubble, Prometheus, Grafana</a>
Http-aware L7 정책 적용 및 테스트를 다뤘습니다. 해당 포스트를 참고해주세요.</li>
</ul>

<h3 id="l7-aware-traffic-management-활성화">L7-Aware Traffic Management 활성화</h3>

<ul>
  <li>CiliumEnvoyConfig , CiliumClusterwideEnvoyConfig - <a href="https://docs.cilium.io/en/stable/network/servicemesh/l7-traffic-management/">Docs</a>
    <ul>
      <li>주의사항 :
        <ul>
          <li>CiliumEnvoyConfig 리소스는 최소한의 검증만 수행되며 정의된 충돌 해결 동작이 없습니다. 즉, EnvoyConfig의 동일한 구성 부분을 수정하는 CEC를 여러 개 만들면 결과를 예측할 수 없을 수 있습니다.</li>
          <li>이 최소한의 검증 외에도, CiliumEnvoyConfig는 사용자에게 구성의 정확성에 대한 피드백을 최소한으로 제공합니다. 따라서 CEC가 바람직하지 않은 결과를 초래할 경우, 문제 해결을 위해서는 문제의 CiliumEnvoyConfig를 확인할 수 있는 대신 EnvoyConfig를 검토해야 합니다.</li>
          <li>CiliumEnvoyConfig는 Cilium의 Ingress 및 Gateway API 지원을 통해 노드별 Envoy 프록시를 통해 트래픽을 유도하는 데 사용됩니다. 자동 생성된 구성과 충돌하거나 수정하는 CEC를 만들면 결과를 예측할 수 없을 수 있습니다. 이러한 사용 사례에서는 CEC를 사용하는 데 매우 주의하세요. 위의 위험은 Cilium에서 생성된 모든 구성이 가능한 한 의미적으로 유효한지 확인함으로써 관리됩니다.</li>
          <li>CiliumEnvoyConfig 리소스를 직접 생성하는 경우(즉, Cilium Ingress 또는 Gateway API 컨트롤러를 통해 생성하지 않고), CEC가 E/W 트래픽을 관리하려는 경우 레이블 cilium.io/use-original-source-address : “false”를 설정합니다. 그렇지 않으면, EnvoyConfig는 업스트림 연결 풀의 소켓을 원래 소스 주소/포트에 바인딩합니다. 이로 인해 포드가 동일한 파이프라인 HTTP/1.1 또는 HTTP/2 연결을 통해 여러 요청을 보낼 때 5-tup 충돌이 발생할 수 있습니다. (Cilium 에이전트는 부모 Ref가 Cilium Ingress 또는 Gateway API 컨트롤러를 가리키는 모든 CEC가 cilium.io/use-original-source-address 을 “false”로 설정한 것으로 가정하지만, 다른 모든 CEC는 이 레이블을 “true”로 설정한 것으로 가정합니다.)</li>
          <li>현재는 Envoy API v3만 지원합니다. - <a href="https://docs.cilium.io/en/stable/network/servicemesh/l7-traffic-management/#supported-envoy-api-versions">Docs</a>
</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>설정
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> ingressController.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> gatewayAPI.enabled<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--set</span> envoyConfig.enabled<span class="o">=</span><span class="nb">true</span>  <span class="nt">--set</span> loadBalancer.l7.backend<span class="o">=</span>envoy
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
  
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart deployment/cilium-operator
<span class="c"># =&gt; deployment.apps/cilium-operator restarted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium-envoy
<span class="c"># =&gt; daemonset.apps/cilium-envoy restarted</span>
  
<span class="c">#</span>
<span class="nv">$ </span>cilium config view |grep <span class="nt">-i</span> envoy
<span class="c"># =&gt; enable-envoy-config                               true</span>
<span class="c">#    envoy-access-log-buffer-size                      4096</span>
<span class="c">#    envoy-base-id                                     0</span>
<span class="c">#    envoy-config-retry-interval                       15s</span>
<span class="c">#    envoy-keep-cap-netbindservice                     false</span>
<span class="c">#    envoy-secrets-namespace                           cilium-secrets</span>
<span class="c">#    external-envoy-proxy                              true</span>
<span class="c">#    loadbalancer-l7                                   envoy</span>
<span class="nv">$ </span>cilium status <span class="nt">--wait</span>
</code></pre></div>    </div>
  </li>
  <li>지원하는 Envoy 확장 리소스 유형
    <ul>
      <li>확장은 Envoy 빌드에 선택적으로 포함될 수 있는 리소스 유형입니다. Envoy 문서에서 언급되는 표준 유형들, 
예를 들어 <code class="language-plaintext highlighter-rouge">type.googleapis.com/envoy.config.listener.v3.Listener</code>와 
<code class="language-plaintext highlighter-rouge">type.googleapis.com/envoy.config.route.v3.RouteConfiguration</code>은 항상 사용할 수 있습니다.</li>
      <li>Cilium 노드는 Cilium HTTP 정책 적용 및 관측 가능성을 지원하기 위해 Envoy 이미지를 배포합니다.
이 Envoy 빌드는 Cilium Agent의 요구사항에 최적화되어 있으며 
Envoy 코드베이스에서 사용할 수 있는 많은 Envoy 확장들을 포함하지 않습니다.</li>
      <li>사용 가능한 Envoy 확장을 확인하려면 <a href="https://github.com/cilium/proxy/blob/main/envoy_build_config/extensions_build_config.bzl">Envoy 확장 구성 파일</a>을 참조하세요. 
<code class="language-plaintext highlighter-rouge">#</code>으로 주석 처리되지 않은 확장만이 Cilium Envoy 이미지에 빌드됩니다. 
사용자 피드백에 따라 내장 확장 목록을 발전해 나갈 것입니다.</li>
    </ul>
  </li>
</ul>

<h3 id="l7-load-balancing과-url-rewriting">L7 Load Balancing과 URL Rewriting</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/network/servicemesh/envoy-traffic-management/">관련 문서</a></li>
  <li>두 백엔드 서비스(echo-service-1/2) 간의 요청 부하를 분산하고, URL을 Rewrite하는 Envoy 구성을 생성해 보겠습니다.</li>
</ul>

<h5 id="실습-환경-구성-1">실습 환경 구성</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 샘플 애플리케이션 배포</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes/servicemesh/envoy/test-application.yaml
<span class="c"># =&gt; configmap/coredns-configmap created</span>
<span class="c">#    deployment.apps/client created</span>
<span class="c">#    deployment.apps/client2 created</span>
<span class="c">#    deployment.apps/echo-service-1 created</span>
<span class="c">#    deployment.apps/echo-service-2 created</span>
<span class="c">#    service/echo-service-1 created</span>
<span class="c">#    service/echo-service-2 created</span>

<span class="c"># 확인</span>
<span class="c">## 두 개의 클라이언트 배포 client , client2</span>
<span class="c">## 두 가지 서비스, echo-service-1, echo-service-2</span>
<span class="nv">$ </span>kubectl get <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes/servicemesh/envoy/test-application.yaml
<span class="c"># =&gt; NAME                          DATA   AGE</span>
<span class="c">#    configmap/coredns-configmap   1      30s</span>
<span class="c">#    </span>
<span class="c">#    NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="c">#    deployment.apps/client           1/1     1            1           30s</span>
<span class="c">#    deployment.apps/client2          1/1     1            1           30s</span>
<span class="c">#    deployment.apps/echo-service-1   1/1     1            1           30s</span>
<span class="c">#    deployment.apps/echo-service-2   1/1     1            1           30s</span>
<span class="c">#    </span>
<span class="c">#    NAME                     TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span>
<span class="c">#    service/echo-service-1   NodePort   10.96.162.98   &lt;none&gt;        8080:30749/TCP   30s</span>
<span class="c">#    service/echo-service-2   NodePort   10.96.78.11    &lt;none&gt;        8080:31200/TCP   30s</span>

<span class="c"># client2 에 대한 Pod ID로 환경 변수 지정</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CLIENT2</span><span class="o">=</span><span class="si">$(</span>kubectl get pods <span class="nt">-l</span> <span class="nv">name</span><span class="o">=</span>client2 <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CLIENT2</span>
<span class="c"># =&gt; client2-c97ddf6cf-2gm94</span>

<span class="c"># Start Observing Traffic with Hubble</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; ℹ️   Hubble Relay is available at 127.0.0.1:4245</span>
<span class="nv">$ </span>hubble observe <span class="nt">--from-pod</span> <span class="nv">$CLIENT2</span> <span class="nt">-f</span>


<span class="c"># You should be able to get a response from both of the backend services individually from client2:</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-2:8080/
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>

<span class="c"># Verify that you get a 404 error response if you curl to the non-existent URL /foo on these services:</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/foo
<span class="c"># =&gt; &lt; HTTP/1.1 404 Not Found</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-2:8080/foo 
<span class="c"># =&gt; &lt; HTTP/1.1 404 Not Found</span>
</code></pre></div></div>

<h5 id="l7-정책-추가">L7 정책 추가</h5>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">one.one.one.one</code> 도메인에 대한 HTTP GET 요청을 허용하는 정책과 echo 서비스의 <code class="language-plaintext highlighter-rouge">/</code> 경로에 대한 HTTP GET 요청을 허용하는 정책을 추가합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Adding a Layer 7 policy introduces the Envoy proxy into the path for this traffic</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes/servicemesh/envoy/client-egress-l7-http.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/client-egress-l7-http created</span>

<span class="c"># client2 is allowed to contact one.one.one.one/ on port 80 and the echo Pod</span>
<span class="c"># on port 8080. HTTP introspection is enabled for client2.</span>
<span class="c"># The toFQDNs section relies on DNS introspection being performed by</span>
<span class="c"># the client-egress-only-dns policy.</span>
apiVersion: <span class="s2">"cilium.io/v2"</span>
kind: CiliumNetworkPolicy
metadata:
  name: client-egress-l7-http
spec:
  description: <span class="s2">"Allow GET one.one.one.one:80/ and GET &lt;echo&gt;:8080/ from client2"</span>
  endpointSelector:
    matchLabels:
      other: client
  egress:
    <span class="c"># Allow GET / requests towards echo pods.</span>
    - toEndpoints:
        - matchLabels:
            k8s:kind: <span class="nb">echo
      </span>toPorts:
        - ports:
            - port: <span class="s2">"8080"</span>
              protocol: TCP
          rules:
            http:
              - method: <span class="s2">"GET"</span>
                path: <span class="s2">"/"</span>
    <span class="c"># Allow GET / requests, only towards one.one.one.one.</span>
    - toFQDNs:
        - matchName: <span class="s2">"one.one.one.one"</span>
      toPorts:
        - ports:
            - port: <span class="s2">"80"</span>
              protocol: TCP
          rules:
            http:
              - method: <span class="s2">"GET"</span>
                path: <span class="s2">"/"</span>
                
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes/servicemesh/envoy/client-egress-only-dns.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/client-egress-only-dns created</span>

apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: client-egress-only-dns
spec:
  endpointSelector:
    matchLabels:
      kind: client
  egress:
    - toPorts:
        - ports:
            - port: <span class="s2">"53"</span>
              protocol: ANY
          rules:
            dns:
              - matchPattern: <span class="s2">"*"</span>
      toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s:k8s-app: kube-dns
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s:k8s-app: coredns

<span class="c"># Make a request to a backend service (either will do):</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 echo 서비스의 / 경로에 대해서는 승인 정책이 적용되었기 때문에 200 OK 응답을 받을 수 있습니다.&lt;/span&gt;</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-2:8080/foo
<span class="c"># =&gt; &lt; HTTP/1.1 403 Forbidden</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 /foo는 승인 정책에 포함되지 않았기 때문에 403 Forbidden 응답을 받습니다.&lt;/span&gt;</span>

<span class="nv">$ </span>hubble observe <span class="nt">--from-pod</span> <span class="nv">$CLIENT2</span> <span class="nt">-f</span>
<span class="c"># =&gt; Aug 23 15:01:32.615: default/client2-c97ddf6cf-2gm94:35118 (ID:30927) -&gt; default/echo-service-2-5df858689b-lbtff:8080 (ID:15303) http-request DROPPED (HTTP/1.1 GET http://echo-service-2:8080/foo)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 Hubble에서 트래픽을 관찰해보면, echo-service-2로의 요청이 DROPPED된 것을 확인할 수 있습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="l7-load-balancing과-url-rewriting-적용">L7 Load Balancing과 URL Rewriting 적용</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Envoy 로드 밸런싱 및 URL 재작성 추가 : 두 백엔드 echo-서비스 간에 50/50의 부하 분산 , 경로 /foo를 다시 작성합니다/</span>
<span class="c"># Apply the envoy-traffic-management-test.yaml file, which defines a CiliumClusterwideEnvoyConfig</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes/servicemesh/envoy/envoy-traffic-management-test.yaml
<span class="c"># =&gt; ciliumclusterwideenvoyconfig.cilium.io/envoy-lb-listener created</span>

apiVersion: cilium.io/v2
kind: CiliumClusterwideEnvoyConfig
metadata:
  name: envoy-lb-listener
spec:
  services:
    - name: echo-service-1
      namespace: default
    - name: echo-service-2
      namespace: default
  resources:
    - <span class="s2">"@type"</span>: type.googleapis.com/envoy.config.listener.v3.Listener
      name: envoy-lb-listener
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                <span class="s2">"@type"</span>: type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: envoy-lb-listener
                rds:
                  route_config_name: lb_route
                use_remote_address: <span class="nb">true
                </span>skip_xff_append: <span class="nb">true
                </span>http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      <span class="s2">"@type"</span>: type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
    - <span class="s2">"@type"</span>: type.googleapis.com/envoy.config.route.v3.RouteConfiguration
      name: lb_route
      virtual_hosts:
        - name: <span class="s2">"lb_route"</span>
          domains: <span class="o">[</span> <span class="s2">"*"</span> <span class="o">]</span>
          routes:
            - match:
                prefix: <span class="s2">"/"</span>
              route:
                weighted_clusters:
                  clusters:
                    - name: <span class="s2">"default/echo-service-1"</span>
                      weight: 50
                    - name: <span class="s2">"default/echo-service-2"</span>
                      weight: 50
                retry_policy:
                  retry_on: 5xx
                  num_retries: 3
                  per_try_timeout: 1s
                regex_rewrite:
                  pattern:
                    google_re2: <span class="o">{</span> <span class="o">}</span>
                    regex: <span class="s2">"^/foo.*$"</span>
                  substitution: <span class="s2">"/"</span>
    - <span class="s2">"@type"</span>: type.googleapis.com/envoy.config.cluster.v3.Cluster
      name: <span class="s2">"default/echo-service-1"</span>
      connect_timeout: 5s
      lb_policy: ROUND_ROBIN
      <span class="nb">type</span>: EDS
      outlier_detection:
        split_external_local_origin_errors: <span class="nb">true
        </span>consecutive_local_origin_failure: 2
    - <span class="s2">"@type"</span>: type.googleapis.com/envoy.config.cluster.v3.Cluster
      name: <span class="s2">"default/echo-service-2"</span>
      connect_timeout: 3s
      lb_policy: ROUND_ROBIN
      <span class="nb">type</span>: EDS
      outlier_detection:
        split_external_local_origin_errors: <span class="nb">true
        </span>consecutive_local_origin_failure: 2

<span class="c"># CiliumClusterwideEnvoyConfig 약자 ccec</span>
<span class="nv">$ </span>kubectl get ccec <span class="nt">-o</span> yaml | yq
<span class="nv">$ </span>kubectl get ccec 
<span class="c"># =&gt; NAME                AGE</span>
<span class="c">#    envoy-lb-listener   21s</span>

<span class="c"># 50:50 LB 분산 호출됨</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/foo

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/foo
<span class="c"># =&gt; &lt; HTTP/1.1 200 OK</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 URL Rewriting이 적용되어 /foo 경로에 대한 요청이 /로 다시 작성되어 200 OK 응답을 받습니다.&lt;/span&gt;</span>

<span class="c"># 하지만 네트워크 정책은 여전히 /로 다시 작성되지 않은 경로에 대한 요청을 방지합니다. </span>
<span class="c"># 예를 들어, 이 요청은 패킷이 삭제되고 403 금지 응답 코드가 생성</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$CLIENT2</span> <span class="nt">--</span> curl <span class="nt">-v</span> echo-service-1:8080/bar
<span class="c"># =&gt; &lt; HTTP/1.1 403 Forbidden</span>

<span class="c">## rewrite 되지 않은 /bar 경로에 대한 요청에 대한 hubble 출력</span>
<span class="c"># =&gt; Aug 23 15:26:06.041: default/client2-c97ddf6cf-2gm94:50256 (ID:30927) -&gt; default/echo-service-2-5df858689b-lbtff:8080 (ID:15303) http-request DROPPED (HTTP/1.1 GET http://echo-service-1:8080/bar)</span>

<span class="c"># 로그 확인</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system logs daemonsets/cilium-envoy
</code></pre></div></div>

<hr>

<h2 id="마치며">마치며</h2>

<p>이번 포스트에서도 Cilium Service Mesh에서 제공하는 다양한 기능을 살펴보았습니다.
특히 기존에 Nginx Ingress를 사용하면서 세부적인 설정을 하려면 annotation도 찾아보고, 해당 annotation의 동작을 이해하기 위해서
nginx 문서도 봐야했는데, Gateway API가 이를 해결 할 것 같아서 기대됩니다.</p>

<p>상호 인증만 Beta를 벗어나면 istio같은 기존 서비스 메시 솔루션을 대체할 수 있을것 같다는 생각이 듭니다.
eBPF와 Envoy라는 튼튼한 기초가 있으니 다양한 기능들을 확장해 나가는것 같아서
초기 설계와 철학이 얼마나 중요한지 다시 한번 느끼게 됩니다.</p>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2">
<a href="#%EC%8B%A4%EC%8A%B5-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1">실습 환경 구성</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC-%ED%8C%8C%EC%9D%BC">실습환경 배포 파일</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC">실습환경 배포</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%83%98%ED%94%8C-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%B0%ED%8F%AC-%EB%B0%8F-%ED%86%B5%EC%8B%A0-%EB%AC%B8%EC%A0%9C-%ED%99%95%EC%9D%B8">샘플 애플리케이션 배포 및 통신 문제 확인</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#cilium-service-mesh">Cilium Service Mesh</a>
<ul>
<li class="toc-entry toc-h3"><a href="#service-mesh-%EC%86%8C%EA%B0%9C">Service Mesh 소개</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-service-mesh-%EC%86%8C%EA%B0%9C">Cilium Service Mesh 소개</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#k8s-ingress-support">K8S Ingress Support</a>
<ul>
<li class="toc-entry toc-h3"><a href="#cilium-k8s-ingress-support-%EC%86%8C%EA%B0%9C">Cilium K8S Ingress Support 소개</a></li>
<li class="toc-entry toc-h3"><a href="#ingress-http-example--xff-%ED%99%95%EC%9D%B8">Ingress HTTP Example : XFF 확인</a></li>
<li class="toc-entry toc-h3"><a href="#ingress-nginx-%EC%84%A4%EC%B9%98%ED%95%98%EC%97%AC-cilium-ingress%EC%99%80-%EA%B3%B5%EC%A1%B4-%EA%B0%80%EB%8A%A5%EC%97%AC%EB%B6%80-%ED%99%95%EC%9D%B8">Ingress-Nginx 설치하여 Cilium Ingress와 공존 가능여부 확인</a></li>
<li class="toc-entry toc-h3"><a href="#dedicated-mode">Dedicated Mode</a></li>
<li class="toc-entry toc-h3"><a href="#ingress-and-network-policies-example">Ingress and Network Policies Example</a></li>
<li class="toc-entry toc-h3"><a href="#ingress-path-type-example">Ingress Path Type Example</a></li>
<li class="toc-entry toc-h3"><a href="#ingress-example-with-tls-termination">Ingress Example with TLS Termination</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#gateway-api-support">Gateway API Support</a>
<ul>
<li class="toc-entry toc-h3"><a href="#gateway-api-%EC%86%8C%EA%B0%9C">Gateway API 소개</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-gateway-api-%EC%A7%80%EC%9B%90">Cilium Gateway API 지원</a></li>
<li class="toc-entry toc-h3"><a href="#cilium-gateway-api-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EB%B0%B0%ED%8F%AC">Cilium Gateway API 설정 및 배포</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#mutual-authentication-beta">Mutual Authentication (Beta)</a>
<ul>
<li class="toc-entry toc-h3"><a href="#%EC%A3%BC%EC%9A%94-%EA%B0%9C%EB%85%90">주요 개념</a></li>
<li class="toc-entry toc-h3"><a href="#cilium%EC%97%90%EC%84%9C%EC%9D%98-%EC%83%81%ED%98%B8-%EC%9D%B8%EC%A6%9D">Cilium에서의 상호 인증</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#l7-aware-traffic-management">L7-Aware Traffic Management</a>
<ul>
<li class="toc-entry toc-h3"><a href="#l7-aware-traffic-management-%EC%86%8C%EA%B0%9C">L7-Aware Traffic Management 소개</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%EC%8A%B5-l7-%ED%8A%B8%EB%9E%98%ED%94%BD-%EA%B4%80%EB%A6%AC">실습: L7 트래픽 관리</a></li>
<li class="toc-entry toc-h3"><a href="#l7-aware-traffic-management-%ED%99%9C%EC%84%B1%ED%99%94">L7-Aware Traffic Management 활성화</a></li>
<li class="toc-entry toc-h3"><a href="#l7-load-balancing%EA%B3%BC-url-rewriting">L7 Load Balancing과 URL Rewriting</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2025-08-24-Cilium-Week6/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2025-08-17-Cilium-Week5/">« [Cilium] BGP Control Plane &amp; ClusterMesh</a>
  
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2025-08-24-Cilium-Week6/";
this.page.identifier = "/posts/Cilium - Week6";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>

<!--      <div class="adsbygoogle-side">-->
<!--        &lt;!&ndash; ad_side &ndash;&gt;-->
<!--        <ins class="adsbygoogle "-->
<!--             style="display: block"-->
<!--             data-ad-client="ca-pub-6564723532026864"-->
<!--             data-ad-slot="1339398797"-->
<!--             data-ad-format="auto"-->
<!--             data-full-width-responsive="true"></ins>-->
<!--      </div>-->
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>공부 기록과 개발 이야기를 담은 블로그입니다.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6564723532026864" crossorigin="anonymous"></script>
    <!--<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>-->
  </body>

</html>
