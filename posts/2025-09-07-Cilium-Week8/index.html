<!DOCTYPE html>
<html lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[Cilium] Cilium Security &amp; Tetragon | Sweet Little Bird</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="[Cilium] Cilium Security &amp; Tetragon">
<meta property="og:locale" content="ko">
<meta name="description" content="이번 포스트에서는 Cilium의 Security와 eBPF 기반의 런타임 보안 및 관찰 도구인 Tetragon 대해 실습을 통하여 알아보도록 하겠습니다.">
<meta property="og:description" content="이번 포스트에서는 Cilium의 Security와 eBPF 기반의 런타임 보안 및 관찰 도구인 Tetragon 대해 실습을 통하여 알아보도록 하겠습니다.">
<link rel="canonical" href="https://sweetlittlebird.github.io/posts/2025-09-07-Cilium-Week8/">
<meta property="og:url" content="https://sweetlittlebird.github.io/posts/2025-09-07-Cilium-Week8/">
<meta property="og:site_name" content="Sweet Little Bird">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2025-09-07T00:10:18+09:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="[Cilium] Cilium Security &amp; Tetragon">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-09-07T00:10:18+09:00","datePublished":"2025-09-07T00:10:18+09:00","description":"이번 포스트에서는 Cilium의 Security와 eBPF 기반의 런타임 보안 및 관찰 도구인 Tetragon 대해 실습을 통하여 알아보도록 하겠습니다.","headline":"[Cilium] Cilium Security &amp; Tetragon","mainEntityOfPage":{"@type":"WebPage","@id":"https://sweetlittlebird.github.io/posts/2025-09-07-Cilium-Week8/"},"url":"https://sweetlittlebird.github.io/posts/2025-09-07-Cilium-Week8/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/dist/photoswipe.min.css">
  <link rel="stylesheet" href="/assets/dist/main.min.css">
  <link rel="stylesheet" href="/assets/dist/main_dark.min.css" media="(prefers-color-scheme: dark)">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.css" integrity="sha512-NzqTHTrO48HsIamogmIaVhTXoSgRF24Cn+ynrNYrFuKrY0AdDbmcNieiOHsQARS/r0Gax9VwV3/rVMHs3ipUlg==" crossorigin="anonymous" referrerpolicy="no-referrer">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&display=swap" rel="stylesheet">-->
  <link href="https://fonts.googleapis.com/css2?family=Elsie+Swash+Caps:wght@400;900&amp;family=Milonga&amp;display=swap" rel="stylesheet">

  <link rel="shortcut icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon/favicon.ico" type="image/x-icon">
<link type="application/atom+xml" rel="alternate" href="https://sweetlittlebird.github.io/feed.xml" title="Sweet Little Bird">
</head>
<body class="body--contents">
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Sweet Little Bird</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/about/">소개</a><a class="page-link" href="/posts/">글 목록</a>
</div>
      </nav>
</div>
  
  <span id="scroll-indicator"></span>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[Cilium] Cilium Security &amp; Tetragon</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-09-07T00:10:18+09:00" itemprop="datePublished">2025년 09월 07일에 작성
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="table-of-content">
      <header>목차</header>
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC">실습환경 배포</a></li>
<li class="toc-entry toc-h2">
<a href="#cilium-security-%EA%B3%B5%EC%8B%9D%EB%AC%B8%EC%84%9C">Cilium Security 공식문서</a>
<ul>
<li class="toc-entry toc-h3"><a href="#cilium%EC%9D%B4-%EC%A0%9C%EA%B3%B5%ED%95%98%EB%8A%94-%EB%B3%B4%EC%95%88-%EA%B0%9C%EC%9A%94">Cilium이 제공하는 보안 개요</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#cilium-security-%EC%8B%A4%EC%8A%B5">Cilium Security 실습</a>
<ul>
<li class="toc-entry toc-h3"><a href="#-lab1-locking-down-external-access-with-dns-based-policies">🔬 Lab1. Locking Down External Access with DNS-Based Policies</a></li>
<li class="toc-entry toc-h3"><a href="#transparent-encryption-with-wireguard">Transparent Encryption with WireGuard</a></li>
<li class="toc-entry toc-h3"><a href="#-lab2-wireguard-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EC%8B%A4%EC%8A%B5">🔬 Lab2. WireGuard 설정 및 실습</a></li>
<li class="toc-entry toc-h3"><a href="#inspecting-tls-encrypted-connections">Inspecting TLS Encrypted Connections</a></li>
<li class="toc-entry toc-h3"><a href="#-lab3-tls-interception-%EC%8B%A4%EC%8A%B5">🔬 Lab3. TLS Interception 실습</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#tetragon">Tetragon</a>
<ul>
<li class="toc-entry toc-h3"><a href="#tetragon-%EC%86%8C%EA%B0%9C">Tetragon 소개</a></li>
<li class="toc-entry toc-h3"><a href="#tetragon-%EC%84%A4%EC%B9%98">Tetragon 설치</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%ED%96%89-%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">실행 모니터링</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%8C%8C%EC%9D%BC-%EC%A0%91%EC%86%8D-%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">파일 접속 모니터링</a></li>
<li class="toc-entry toc-h3"><a href="#policy-enforcement">Policy Enforcement</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
    </div>
    <h2 id="들어가며">들어가며</h2>

<p>이번 포스트에서는 Cilium의 Security와 eBPF 기반의 런타임 보안 및 관찰 도구인 Tetragon 대해 실습을 통하여 알아보도록 하겠습니다.</p>

<hr>

<h2 id="실습환경-배포">실습환경 배포</h2>

<ul>
  <li>실습 환경 소개
    <ul>
      <li>실습 환경 : k8s(1.33.4), cilium(1.18.1) - 기본 배포 가상 머신 : k8s-ctr, k8s-w1, k8s-w2</li>
      <li>이번 실습에는 워커 노드간 보안 정책을 적용하고 통신 암호화 등을 살펴보기 위해서 워커노드를 2개 두는 구성을 하였습니다.</li>
    </ul>
  </li>
  <li>실습 환경 배포</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir </span>cilium-lab <span class="o">&amp;&amp;</span> <span class="nb">cd </span>cilium-lab
<span class="nv">$ </span>curl <span class="nt">-O</span> https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/8w/Vagrantfile
<span class="nv">$ </span>vagrant up
<span class="c"># =&gt; ...</span>
<span class="c">#    ==&gt; k8s-w2: Running provisioner: shell...</span>
<span class="c">#        k8s-w2: Running: /var/folders/7k/qy6rsdds57z3tmyn9_7hhd8r0000gn/T/vagrant-shell20250905-16290-5f5n6v.sh</span>
<span class="c">#        k8s-w2: &gt;&gt;&gt;&gt; K8S Node config Start &lt;&lt;&lt;&lt;</span>
<span class="c">#        k8s-w2: [TASK 1] K8S Controlplane Join</span>
<span class="c">#        k8s-w2: &gt;&gt;&gt;&gt; K8S Node config End &lt;&lt;&lt;&lt;</span>
<span class="nv">$ </span>vagrant ssh k8s-ctr
</code></pre></div></div>

<hr>

<h2 id="cilium-security-공식문서">Cilium Security 공식문서</h2>

<h3 id="cilium이-제공하는-보안-개요">Cilium이 제공하는 보안 개요</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/security/network/intro/">관련문서</a></li>
  <li>Cilium은 크게 다음의 보안 기능을 제공합니다.
    <ul>
      <li>Identity-Based (Layer3)</li>
      <li>Port Level (Layer4)</li>
      <li>Application protocol Level (Layer7)</li>
    </ul>
  </li>
  <li>
<strong>Cilium 보안 정책의 특징</strong>
    <ul>
      <li>
<strong>정책이 없는 경우</strong>, 기본적으로 <strong>모든 트래픽이 허용</strong>됩니다.</li>
      <li>첫번째 정책 <strong>규칙이 적용되면</strong>, <strong>허용된 트래픽을 제외한 모든 트래픽이 차단</strong>됩니다.</li>
      <li>세션 기반 프로토콜에 대해 <strong>상태저장 정책이 적용</strong>되며, <strong>응답 패킷은 자동으로 허용</strong>됩니다. - <a href="https://docs.cilium.io/en/stable/security/network/policyenforcement/#policy-enforcement">관련문서</a>
</li>
    </ul>
  </li>
  <li>
<strong>Envoy Proxy 통합</strong> - <a href="https://docs.cilium.io/en/stable/security/network/proxy/envoy/">Docs</a>
<img src="/assets/2025/cilium/w8/20250907_cilium_w8_2.png" alt="img.png" class="image-center" loading="lazy" width="1090" height="627">
<em class="image-caption"><a href="https://docs.cilium.io/en/stable/security/network/proxy/envoy/">https://docs.cilium.io/en/stable/security/network/proxy/envoy/</a></em>
    <ul>
      <li>Cilium은 Envoy Proxy와 통합되어 Layer7 보안 정책을 적용할 수 있습니다.</li>
      <li>Envoy Proxy는 L7 프록시로서 HTTP, gRPC, Kafka 등의 프로토콜을 지원합니다.</li>
      <li>Envoy Proxy를 통해 세밀한 애플리케이션 레벨의 보안 정책을 적용할 수 있습니다.</li>
    </ul>
  </li>
  <li>
<strong>투명한 암호화</strong> :
IPSec or WireGuard 로 Cilium 관리하는 호스트 트래픽과 엔드포인트 간 트래픽의 투명한 암호화 지원합니다. - <a href="https://docs.cilium.io/en/stable/security/network/encryption/">Docs</a> , <a href="https://www.youtube.com/watch?v=vj7M-t9MK6s">Youtube</a>
<img src="/assets/2025/cilium/w8/20250907_cilium_w8_4.png" alt="img.png" loading="lazy" width="691" height="284">
    <ul>
      <li>각 모드의 단점
        <ul>
          <li>IPSec : BPF 호스트 라우팅에서는 미동작하며, IPsec 터널당 단일 CPU 코어로 제한됩니다. - <a href="https://docs.cilium.io/en/stable/security/network/encryption-ipsec/">Docs</a>
</li>
          <li>WireGuard : 터널 모드(VXLAN, GENEVE)에서는 두 번 캡슐화됩니다. - <a href="https://docs.cilium.io/en/stable/security/network/encryption-wireguard/">Docs</a> , <a href="https://www.youtube.com/watch?v=-awkPi3D60E">Youtube</a>
</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="identity-기반-보안-정책---docs">Identity 기반 보안 정책 - <a href="https://docs.cilium.io/en/stable/gettingstarted/terminology/#identity">Docs</a>
</h5>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_1.png" alt="img.png" class="image-center w-60" loading="lazy" width="1346" height="632">
<em class="image-caption">Identity <a href="https://docs.cilium.io/en/stable/security/network/identity/">https://docs.cilium.io/en/stable/security/network/identity/</a></em></p>
<ul>
  <li>Cilium은 Pod에 IP주소가 아닌 Identity를 부여하고 Identity를 기반으로 보안 정책을 적용합니다.</li>
  <li>Identity는 Namespace, Labels, ServiceAccount 등을 기반으로 생성됩니다.</li>
  <li>Pod의 IP주소는 변경될 수 있지만, Identity는 변경되기 때문에 보안 정책이 안정적으로 유지될 수 있습니다.</li>
  <li>또한 동일한 Security Relevant Labels를 가진 Pod들은 동일한 Identity를 공유합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get ciliumendpoints.cilium.io <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME                              SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    coredns-674b8bbfcf-2njqx          &lt;span style="color: green;"&gt;15719&lt;/span&gt;               ready            172.20.0.37</span>
<span class="c">#    coredns-674b8bbfcf-gwsh5          &lt;span style="color: green;"&gt;15719&lt;/span&gt;               ready            172.20.0.1</span>
<span class="c">#    hubble-relay-fdd49b976-t5sms      64548               ready            172.20.0.102</span>
<span class="c">#    hubble-ui-655f947f96-vjkrg        3186                ready            172.20.0.197</span>
<span class="c">#    metrics-server-5dd7b49d79-rbbwk   883                 ready            172.20.0.166 </span>

<span class="nv">$ </span>kubectl get ciliumidentities.cilium.io 
<span class="c"># =&gt; NAME    NAMESPACE            AGE</span>
<span class="c">#    &lt;span style="color: green;"&gt;15719&lt;/span&gt;   kube-system          57m</span>
<span class="c">#    2887    cilium-monitoring    57m</span>
<span class="c">#    3186    kube-system          57m</span>
<span class="c">#    38953   local-path-storage   57m</span>
<span class="c">#    61576   cilium-monitoring    57m</span>
<span class="c">#    64548   kube-system          57m</span>
<span class="c">#    883     kube-system          57m</span>
</code></pre></div></div>

<ul>
  <li>identity 부여 과정
    <ul>
      <li>Pod 또는 Container가 생성되면, Cilium은 컨테이너 런타밈에서 수집한 이벤트를 기반으로 네트워크에서 Pod 또는 Container를 나타내는 엔드포인트를 생성합니다.</li>
      <li>엔드포인트의 ID는 엔드포인트에서 파생된 Pod 또는 Container와 연관된 레이블을 기반으로 결정됩니다.</li>
      <li>다음 단계로 Cilium은 생성된 엔드포인트의 ID를 확인하며, Pod 또는 Container의 레이블이 변경되면 엔드포인트 ID가 재확인 되며 필요에따라 변경됩니다.</li>
    </ul>
  </li>
</ul>

<h5 id="cilium-identity-정보-확인-및-변경-실습">Cilium Identity 정보 확인 및 변경 실습</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get ciliumidentities.cilium.io 15719 <span class="nt">-o</span> yaml | yq
<span class="c"># =&gt; {</span>
<span class="c">#      "apiVersion": "cilium.io/v2",</span>
<span class="c">#      "kind": "CiliumIdentity",</span>
<span class="c">#      "metadata": {</span>
<span class="c">#        "creationTimestamp": "2025-09-05T14:14:26Z",</span>
<span class="c">#        "generation": 1,</span>
<span class="c">#        "labels": {</span>
<span class="c">#          "io.kubernetes.pod.namespace": "kube-system"</span>
<span class="c">#        },</span>
<span class="c">#        "name": "15719",</span>
<span class="c">#        "resourceVersion": "796",</span>
<span class="c">#        "uid": "e3b7045e-5a91-47fc-abff-0d8f86330dbf"</span>
<span class="c">#      },</span>
<span class="c">#      "security-labels": {</span>
<span class="c">#        "k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name": "kube-system",</span>
<span class="c">#        "k8s:io.cilium.k8s.policy.cluster": "default",</span>
<span class="c">#        "k8s:io.cilium.k8s.policy.serviceaccount": "coredns",</span>
<span class="c">#        "k8s:io.kubernetes.pod.namespace": "kube-system",</span>
<span class="c">#        "k8s:k8s-app": "kube-dns"</span>
<span class="c">#      }</span>
<span class="c">#    }</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium identity list
<span class="c"># =&gt; ...</span>
<span class="c">#    15719   k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system</span>
<span class="c">#            k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#            k8s:io.cilium.k8s.policy.serviceaccount=coredns</span>
<span class="c">#            k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#            k8s:k8s-app=kube-dns</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl get pod <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">--show-labels</span>
<span class="c"># =&gt; NAME                       READY   STATUS    RESTARTS   AGE   LABELS</span>
<span class="c">#    coredns-674b8bbfcf-2njqx   1/1     Running   0          65m   k8s-app=kube-dns,pod-template-hash=674b8bbfcf</span>
<span class="c">#    coredns-674b8bbfcf-gwsh5   1/1     Running   0          65m   k8s-app=kube-dns,pod-template-hash=674b8bbfcf</span>

<span class="c"># 기동 중인 파드에 label 추가 후 cilium id(보안 label)에 반영 될지? : 반영되는가? 얼마나 시간이 걸리는가? ID가 변경되지는 않는가?</span>
<span class="nv">$ </span>kubectl label pods <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nv">study</span><span class="o">=</span>8w
<span class="c"># =&gt; pod/coredns-674b8bbfcf-2njqx labeled</span>
<span class="c">#    pod/coredns-674b8bbfcf-gwsh5 labeled</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium identity list
<span class="c"># =&gt; ...</span>
<span class="c">#    15719   k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system</span>
<span class="c">#            k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#            k8s:io.cilium.k8s.policy.serviceaccount=coredns</span>
<span class="c">#            k8s:io.kubernetes.pod.namespace=kube-system</span>
<span class="c">#            k8s:k8s-app=kube-dns</span>
<span class="c">#    &lt;span style="color: green;"&gt;38787   k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.cilium.k8s.policy.cluster=default&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.cilium.k8s.policy.serviceaccount=coredns&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.kubernetes.pod.namespace=kube-system&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:k8s-app=kube-dns&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:study=8w&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 study=8w 라벨에 대한 새로운 ID(38787)가 생성되었습니다..&lt;/span&gt;</span>

<span class="c"># (위 내용 확인 후 아래 진행) coredns deployment 에 spec.template.metadata.labels에 아래 추가 시 반영 확인</span>
<span class="nv">$ </span>kubectl edit deploy <span class="nt">-n</span> kube-system coredns
<span class="nt">---</span>
...
  template:
    metadata:
      labels:
        app: testing
        k8s-app: kube-dns
...
<span class="nt">---</span>
<span class="c"># =&gt; deployment.apps/coredns edited</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium identity list
<span class="c"># =&gt; ...</span>
<span class="c">#    &lt;span style="color: green;"&gt;30461   k8s:app=testing&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.cilium.k8s.policy.cluster=default&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.cilium.k8s.policy.serviceaccount=coredns&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:io.kubernetes.pod.namespace=kube-system&lt;/span&gt;</span>
<span class="c">#            &lt;span style="color: green;"&gt;k8s:k8s-app=kube-dns&lt;/span&gt;</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>Cilium은 pod update 이벤트를 watch하므로, labels 변경 시 endpoint가 waiting-for-identity 상태로 전환되어 새로운 identity를 할당받습니다.
이로 인해 security labels와 관련된 네트워크 정책도 자동으로 재적용됩니다.</li>
  <li>예시:
    <ul>
      <li>간단한 pod(simple-pod)를 생성하면 초기 security identity(예: 26830)가 할당됩니다.</li>
      <li>이후 <code class="language-plaintext highlighter-rouge">kubectl label pod/simple-pod run=not-simple-pod --overwrite</code>로 labels를 변경하면, <code class="language-plaintext highlighter-rouge">kubectl get ciliumendpoints</code> 명령에서 identity가 새 값(예: 8710)으로 업데이트된 것을 확인할 수 있습니다. 이는 policy enforcement에 즉시 반영됩니다.</li>
    </ul>
  </li>
  <li>단, 대규모 클러스터에서 자주 labels를 변경하면 identity 할당이 빈번해져 성능 저하가 발생할 수 있으므로, identity-relevant labels를 제한하는 것이 권장됩니다</li>
</ul>

<h5 id="special-identities">Special Identities</h5>

<ul>
  <li>Cilium에서 관리하는 모든 엔드포인트는 ID가 할당 됩니다.</li>
  <li>Cilium에서 관리하지 않는 엔드포인트의 통신을 허용하기 위해서 특수 ID를 제공합니다.</li>
  <li>예약된 특수 ID에는 <code class="language-plaintext highlighter-rouge">reserved</code>라는 접두사가 붙습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 예약된 특수 ID 확인 </span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium identity list
<span class="c"># =&gt; ID      LABELS</span>
<span class="c">#    1       reserved:host</span>
<span class="c">#            reserved:kube-apiserver</span>
<span class="c">#    2       reserved:world</span>
<span class="c">#    3       reserved:unmanaged</span>
<span class="c">#    4       reserved:health</span>
<span class="c">#    5       reserved:init</span>
<span class="c">#    6       reserved:remote-node</span>
<span class="c">#    7       reserved:kube-apiserver</span>
<span class="c">#            reserved:remote-node</span>
<span class="c">#    8       reserved:ingress</span>
<span class="c">#    9       reserved:world-ipv4</span>
<span class="c">#    10      reserved:world-ipv6</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th><strong>Identity</strong></th>
      <th><strong>숫자ID</strong></th>
      <th><strong>설명</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:unknown</code></td>
      <td>0</td>
      <td>ID을 확인할 수 없습니다.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:host</code></td>
      <td>1</td>
      <td>로컬 호스트. 로컬 호스트 IP 중 하나에서 시작되거나 지정된 모든 트래픽입니다.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:world</code></td>
      <td>2</td>
      <td>클러스터 외부의 모든 네트워크 엔드포인트</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:unmanaged</code></td>
      <td>3</td>
      <td>Cilium에서 관리하지 않는 엔드포인트, 예를 들어 Cilium이 설치되기 전에 시작된 Kubernetes Pod입니다.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:health</code></td>
      <td>4</td>
      <td>Cilium 에이전트가 생성한 상태 확인 트래픽입니다.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:init</code></td>
      <td>5</td>
      <td>ID가 아직 확인되지 않은 엔드포인트에는 init ID가 할당됩니다. 이는 보안 ID를 도출하는 데 필요한 일부 메타데이터가 아직 없는 엔드포인트 단계를 나타냅니다. 이는 일반적으로 부트스트래핑 단계에서 발생합니다. init ID는 엔드포인트 생성 시점에 레이블을 알 수 없는 경우에만 할당됩니다. Docker 플러그인의 경우가 여기에 해당할 수 있습니다.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:remote-node</code></td>
      <td>6</td>
      <td>모든 원격 클러스터 호스트의 집합입니다. 로컬 노드를 제외한 연결된 클러스터 내 모든 호스트의 IP 중 하나에서 시작되거나 해당 IP로 지정된 모든 트래픽입니다.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:kube-apiserver</code></td>
      <td>7</td>
      <td>kube-apiserver를 실행하는 백엔드가 있는 원격 노드입니다.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">reserved:ingress</code></td>
      <td>8</td>
      <td>Ingress 프록시 연결에 대한 소스 주소로 사용되는 IP에 제공됩니다.</td>
    </tr>
  </tbody>
</table>

<h5 id="클러스터에서의-identity-관리">클러스터에서의 Identity 관리</h5>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_5.png" alt="img.png" loading="lazy" width="1450" height="795"></p>

<ul>
  <li>ID는 전체 클러스터에서 유효합니다.
    <ul>
      <li>즉, 여러 클러스터 노드에서 여러 개의 포드 또는 컨테이너가 시작되더라도 ID 관련 레이블을 공유하는 경우 모든 포드 또는 컨테이너가 단일 ID를 공유합니다.</li>
      <li>이를 위해서는 클러스터 노드 간의 조정이 필요합니다.</li>
    </ul>
  </li>
  <li>엔드포인트 ID를 확인하는 작업은 <strong>분산 키-값 저장소</strong>를 통해 수행됩니다.</li>
  <li>분산 키-값 저장소는 <em>다음 값이 이전에 확인되지 않은 경우 새로운 고유 식별자를 생성하는</em> 형태의 원자적 연산을 수행할 수 있도록 합니다.</li>
  <li>이를 통해 각 클러스터 노드는 ID 관련 레이블 하위 집합을 생성한 다음 키-값 저장소를 쿼리하여 ID를 도출할 수 있습니다.</li>
  <li>레이블 집합이 이전에 쿼리되었는지 여부에 따라 새 ID가 생성되거나 초기 쿼리의 ID가 반환됩니다.</li>
</ul>

<h5 id="networkpolicy--3가지-형식-제공---docs">NetworkPolicy : 3가지 형식 제공 - <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/">Docs</a>
</h5>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_6.png" alt="img.png" class="image-center" loading="lazy" width="2048" height="1395">
<em class="image-caption"><a href="https://isovalent.com/blog/post/intro-to-cilium-network-policies/">https://isovalent.com/blog/post/intro-to-cilium-network-policies/</a></em></p>

<ul>
  <li>
<strong>표준 Network Policy</strong> : Pod의 ingress 또는 egress 시 L3 및 L4 정책을 지원하는 <strong>표준</strong> <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#networkpolicy">NetworkPolicy 리소스입니다.</a>
</li>
  <li>
<strong>확장 CiliumNetworkPolicy</strong> : <strong>3~7 계층</strong>에서 <strong>수신</strong> 및 <strong>송신</strong> 모두에 대한 정책 지정을 지원하는 <a href="https://docs.cilium.io/en/stable/glossary/#term-CustomResourceDefinition">CustomResourceDefinition</a> 으로 제공되는 확장된 <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#ciliumnetworkpolicy">CiliumNetworkPolicy 형식입니다.</a>
</li>
  <li>
<strong>CiliumClusterwideNetworkPolicy</strong> : <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#ciliumclusterwidenetworkpolicy">CiliumClusterwideNetworkPolicy</a> 형식 은 Cilium에서 적용할 <strong>클러스터 전체 정책을 지정</strong>하는 클러스터 범위 <a href="https://docs.cilium.io/en/stable/glossary/#term-CustomResourceDefinition">CustomResourceDefinition</a> 입니다. 이 사양은 네임스페이스가 지정되지 않은 <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#ciliumnetworkpolicy">CiliumNetworkPolicy</a> 와 동일합니다 .</li>
</ul>

<h5 id="policy-enforcement-modes-by-cilium-network-policy---docs">Policy Enforcement Modes by Cilium Network Policy - <a href="https://docs.cilium.io/en/stable/security/policy/intro/">Docs</a>
</h5>

<ul>
  <li>
<strong>Policy Enforcement Modes</strong>
    <ul>
      <li>
<strong>default</strong> : 정책이 없는 경우 모든 트래픽이 허용됩니다. 정책이 적용되면 허용된 트래픽을 제외한 모든 트래픽이 차단됩니다.</li>
      <li>
<strong>always</strong> : 정책이 없는 경우 모든 트래픽이 차단됩니다. 정책이 적용되면 허용된 트래픽을 제외한 모든 트래픽이 차단됩니다.</li>
      <li>
<strong>never</strong> : 정책이 없는 경우 모든 트래픽이 허용됩니다. 정책이 적용되더라도 모든 트래픽이 허용됩니다.</li>
    </ul>
  </li>
  <li>
<strong>Endpoint default policy</strong>
    <ul>
      <li>
<strong>기본적으로 모든 엔드포인트에 대해 모든 송신 및 수신 트래픽이 허용됩니다. 네트워크 정책에 따라 엔드포인트가 선택되면 명시적으로 허용된</strong> 트래픽 만 허용되는 기본 거부 상태로 전환됩니다 . 이 상태는 방향별로 적용됩니다.
        <ul>
          <li>규칙이 엔드포인트를 선택 하고 해당 규칙에 수신 섹션이 있는 경우, 엔드포인트는 수신에 대해 기본 거부 모드로 전환됩니다.</li>
          <li>규칙이 엔드포인트를 선택 하고 규칙에 송신 섹션이 있는 경우, 엔드포인트는 송신에 대해 기본 거부 모드로 전환됩니다.</li>
        </ul>
      </li>
      <li>
<code class="language-plaintext highlighter-rouge">EnableDefaultDeny</code> <a href="https://docs.cilium.io/en/stable/security/policy/language/#l7-policy">7계층 정책</a> 에는 적용되지 않습니다.
        <ul>
          <li>7계층 모두 허용이 포함되지 않은 7계층 규칙을 추가하면 default-deny가 명시적으로 비활성화된 경우에도 삭제가 발생합니다.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
<strong>Rule Basics</strong>
    <ul>
      <li>
<strong>endpointSelector / nodeSelector</strong> : 
정책 규칙이 적용될 엔드포인트 또는 노드를 선택합니다. 정책 규칙은 선택기에 지정된 레이블과 일치하는 모든 엔드포인트에 적용됩니다.</li>
      <li>
<strong>ingress</strong> : 
엔드포인트의 유입 시, 즉 엔드포인트에 들어오는 모든 네트워크 패킷에 적용해야 하는 규칙 목록입니다.</li>
      <li>
<strong>egress</strong> : 
엔드포인트의 출구에서 적용되어야 하는 규칙 목록, 즉 엔드포인트를 떠나는 모든 네트워크 패킷에 적용되어야 하는 규칙 목록입니다.</li>
      <li>
<strong>labels</strong> :
레이블은 규칙을 식별하는 데 사용됩니다. 레이블을 사용하여 규칙을 나열하고 삭제할 수 있습니다. Kubernetes를
통해 가져온 정책 규칙에는 <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#networkpolicy">NetworkPolicy</a> 
또는 <a href="https://docs.cilium.io/en/stable/network/kubernetes/policy/#ciliumnetworkpolicy">CiliumNetworkPolicy</a> 리소스에 
지정된 이름에 해당하는 레이블이 자동으로 <code class="language-plaintext highlighter-rouge">io.cilium.k8s.policy.name=NAME</code>지정됩니다.</li>
    </ul>
  </li>
</ul>

<h5 id="cilium-endpoint-lifecycle---docs">Cilium Endpoint Lifecycle - <a href="https://docs.cilium.io/en/stable/security/policy/lifecycle/">Docs</a>
</h5>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_7.png" alt="img.png" class="image-center" loading="lazy" width="1455" height="955">
  <em class="image-caption"><a href="https://docs.cilium.io/en/stable/security/policy/lifecycle/">https://docs.cilium.io/en/stable/security/policy/lifecycle/</a></em></p>

<ul>
  <li>
<strong>restoring</strong> : Cilium이 시작되기 전에 엔드포인트가 시작되었으며 Cilium이 네트워킹 구성을 복원하고 있습니다.</li>
  <li>
<strong>waiting-for-identity</strong> : Cilium이 엔드포인트에 고유한 ID를 할당하고 있습니다.</li>
  <li>
<strong>waiting-to-regenerate</strong> : 엔드포인트가 ID를 수신했으며 네트워킹 구성이 다시 생성될 때까지 기다리고 있습니다.</li>
  <li>
<strong>regenerating</strong> : 엔드포인트의 네트워킹 구성이 재생성되고 있습니다. 여기에는 해당 엔드포인트에 대한 eBPF 프로그래밍이 포함됩니다.</li>
  <li>
<strong>ready</strong> : 엔드포인트의 네트워킹 구성이 성공적으로 다시 생성되었습니다.</li>
  <li>
<strong>disconnecting</strong> : 엔드포인트가 삭제되고 있습니다.</li>
  <li>
<strong>disconnected</strong> : 엔드포인트가 삭제되었습니다.</li>
</ul>

<h5 id="기타-정보">기타 정보</h5>

<ul>
  <li>
<strong>정책 에디터 온라인 사이트</strong> : <a href="https://editor.networkpolicy.io/">https://editor.networkpolicy.io/</a>, 
<a href="https://isovalent.com/blog/post/tutorial-network-policy-editor/">https://isovalent.com/blog/post/tutorial-network-policy-editor/</a>
</li>
  <li>
<strong>Identity Management Mode</strong> : <a href="https://docs.cilium.io/en/stable/network/kubernetes/identity-management-mode/">Docs</a>
</li>
  <li>
<strong>Using Kubernetes Constructs In Policy</strong> : 정책에서 쿠버네티스 리소스를 활용 - <a href="https://docs.cilium.io/en/stable/security/policy/kubernetes/">Docs</a>
</li>
  <li>
<strong>Network Policy Troubleshooting</strong> - <a href="https://docs.cilium.io/en/stable/security/policy/troubleshooting/">Docs</a> &amp; <strong>Caveats</strong> - <a href="https://docs.cilium.io/en/stable/security/policy/caveats/">Docs</a>
</li>
  <li>
<strong>Threat Model</strong> : <a href="https://docs.cilium.io/en/stable/security/threat-model/">Docs</a>
</li>
  <li>
<strong>Tutorial: Cilium Network Policy in Practice (Part 2)</strong> : <a href="https://isovalent.com/blog/post/tutorial-cilium-network-policy/">Blog</a>
</li>
</ul>

<hr>

<h2 id="cilium-security-실습">Cilium Security 실습</h2>

<h3 id="-lab1-locking-down-external-access-with-dns-based-policies">🔬 Lab1. Locking Down External Access with DNS-Based Policies</h3>

<ul>
  <li>DNS 기반 보안 정책 - <a href="https://docs.cilium.io/en/stable/security/dns/">Docs</a>
    <ul>
      <li>CIDR 또는 IP 기반 정책은 외부 서비스와 연결된 IP가 자주 변경될 수 있으므로 관리가 어렵고 번거롭습니다.</li>
      <li>Cilium의 DNS 기반 정책은 DNS-IP 매핑 추적과 같은 복잡한 측면을 관리하는 동시에 액세스 제어를 쉽게 지정할 수 있는 메커니즘을 제공합니다.</li>
      <li>이 가이드에서는 다음 사항에 대해 알아봅니다.
        <ul>
          <li>DNS 기반 정책을 사용하여 클러스터 외부 서비스에 대한 이탈 액세스 제어</li>
          <li>패턴(또는 와일드카드)을 사용하여 DNS 도메인 하위 집합을 허용 목록에 추가</li>
          <li>외부 서비스 접근 제한을 위한 DNS, 포트 및 L7 규칙 결합</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h5 id="데모-애플리케이션-배포">데모 애플리케이션 배포</h5>

<ul>
  <li>Empire의 mediabot pod가 Empire의 git 저장소 관리를 위해 GitHub에 접근해야 하는 간단한 시나리오를 사용하겠습니다.</li>
  <li>pod는 다른 외부 서비스에 접근할 수 없어야 합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># hubble ui 에 pod name 표기를 위해 app labels 추가 &gt;&gt; 빼고 배포해보고 차이점을 확인해보자.</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; dns-sw-app.yaml
apiVersion: v1
kind: Pod
metadata:
  name: mediabot
  labels:
    org: empire
    class: mediabot
    app: mediabot
spec:
  containers:
  - name: mediabot
    image: quay.io/cilium/json-mock:v1.3.8@sha256:5aad04835eda9025fe4561ad31be77fd55309af8158ca8663a72f6abb78c2603
</span><span class="no">EOF
  
</span><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> dns-sw-app.yaml
<span class="c"># =&gt; pod/mediabot created</span>
<span class="nv">$ </span>kubectl <span class="nb">wait </span>pod/mediabot <span class="nt">--for</span><span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready
<span class="c"># =&gt; pod/mediabot condition met</span>
  
<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium identity list
<span class="c"># =&gt; ...</span>
<span class="c">#    23762   k8s:app=mediabot</span>
<span class="c">#            k8s:class=mediabot</span>
<span class="c">#            k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default</span>
<span class="c">#            k8s:io.cilium.k8s.policy.cluster=default</span>
<span class="c">#            k8s:io.cilium.k8s.policy.serviceaccount=default</span>
<span class="c">#            k8s:io.kubernetes.pod.namespace=default</span>
<span class="c">#            k8s:org=empire</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl get pods
<span class="c"># =&gt; NAME       READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    mediabot   1/1     Running   0          86s</span>
  
<span class="c"># 외부 통신 확인 : hubble ui 에서 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://api.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 https://support.github.com | <span class="nb">head</span> <span class="nt">-1</span> 
<span class="c"># =&gt; HTTP/2 302</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_8.png" alt="img.png" class="image-center w-80" loading="lazy" width="490" height="446"></p>

<h5 id="dns-egress-정책-적용--1--mediabot포드가-apigithubcom에만-액세스하도록-허용">DNS Egress 정책 적용  1 : <code class="language-plaintext highlighter-rouge">mediabot</code>포드가 <code class="language-plaintext highlighter-rouge">api.github.com</code>에만 액세스하도록 허용</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "fqdn"
spec:
  endpointSelector:
    matchLabels:
      org: empire
      class: mediabot
  egress:
  - toFQDNs:
    - matchName: "api.github.com"
  - toEndpoints:
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": kube-system
        "k8s:k8s-app": kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: ANY
      rules:
        dns:
        - matchPattern: "*"
</span><span class="no">EOF
</span><span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/fqdn created</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME   AGE   VALID</span>
<span class="c">#    fqdn   11s   True</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium policy selectors 
<span class="c"># =&gt; SELECTOR                                                                                                                                                                      LABELS         USERS   IDENTITIES</span>
<span class="c">#    &amp;LabelSelector{MatchLabels:map[string]string{any.class: mediabot,any.org: empire,k8s.io.kubernetes.pod.namespace: default,},MatchExpressions:[]LabelSelectorRequirement{},}   default/fqdn   1       23762 </span>

<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> dns
<span class="c"># =&gt; dnsproxy-enable-transparent-mode                  true</span>
<span class="c">#    dnsproxy-socket-linger-timeout                    10</span>
<span class="c">#    hubble-metrics                                    dns drop tcp flow port-distribution icmp httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction</span>
<span class="c">#    tofqdns-dns-reject-response-code                  refused</span>
<span class="c">#    tofqdns-enable-dns-compression                    true</span>
<span class="c">#    tofqdns-endpoint-max-ip-per-hostname              1000</span>
<span class="c">#    tofqdns-idle-connection-grace-period              0s</span>
<span class="c">#    tofqdns-max-deferred-connection-deletes           10000</span>
<span class="c">#    tofqdns-preallocate-identities                    true</span>
<span class="c">#    tofqdns-proxy-response-max-delay                  100ms</span>

<span class="c"># 외부 통신 확인 : hubble ui 에서 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://api.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>

<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 https://support.github.com | <span class="nb">head</span> <span class="nt">-1</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_9.png" alt="img.png" class="image-center w-80" loading="lazy" width="686" height="501">
<em class="image-caption">api.github.com으로만 접속이 허용된 상태</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c"># cilium-agent 내에 go 로 구현된 lightweight proxy 가 DNS 쿼리/응답 감시와 ~~캐싱 처리~~ : 기본 30초?</span>
<span class="nv">$ </span>cilium hubble port-forward&amp;
<span class="c"># =&gt; ℹ️   Hubble Relay is available at 127.0.0.1:4245</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> mediabot
<span class="c"># =&gt; ...</span>
<span class="c">#    Sep  6 07:57:02.807: default/mediabot:59702 (ID:23762) &lt;- kube-system/coredns-674b8bbfcf-hcdsq:53 (ID:41039) dns-response proxy FORWARDED (DNS Answer "20.200.245.245" TTL: 30 (Proxy api.github.com. A))</span>
<span class="c">#    ...</span>
<span class="c">#    Sep  6 07:57:02.809: default/mediabot:59458 (ID:23762) -&gt; api.github.com:443 (ID:16777217) policy-verdict:L3-Only EGRESS ALLOWED (TCP Flags: SYN)</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 api.github.com 으로의 접속은 허용됨&lt;/span&gt;</span>
<span class="c">#    ...</span>
<span class="c">#    Sep  6 07:48:26.004: default/mediabot:43181 (ID:23762) &lt;- kube-system/coredns-674b8bbfcf-nxkpb:53 (ID:41039) dns-response proxy FORWARDED (DNS Answer  TTL: 4294967295 (Proxy support.github.com. AAAA))</span>
<span class="c">#    ...</span>
<span class="c">#    Sep  6 07:48:26.025: default/mediabot:34138 (ID:23762) &lt;&gt; support.github.com:443 (world) policy-verdict:none EGRESS DENIED (TCP Flags: SYN)</span>
<span class="c"># &lt;span style="color: red;"&gt;👉 support.github.com 으로의 접속은 차단됨&lt;/span&gt;</span>
<span class="c">#    ...</span>

<span class="c"># (옵션) coredns 로그로 직접 확인해보기</span>
<span class="c"># k9s -&gt; configmap (coredns) : log 추가</span>

<span class="c">## 로깅 활성화</span>
<span class="nv">$ </span>kubectl logs <span class="nt">-n</span> kube-system <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-dns <span class="nt">-f</span>
<span class="c"># =&gt; [INFO] 172.20.1.42:46910 - 17176 "A IN api.github.com.default.svc.cluster.local. udp 58 false 512" NXDOMAIN qr,aa,rd 151 0.001380815s</span>
<span class="c">#    [INFO] 172.20.1.42:46910 - 10271 "AAAA IN api.github.com.default.svc.cluster.local. udp 58 false 512" NXDOMAIN qr,aa,rd 151 0.000691012s</span>
<span class="c">#    [INFO] 172.20.1.42:59040 - 34206 "A IN api.github.com.svc.cluster.local. udp 50 false 512" NXDOMAIN qr,aa,rd 143 0.001186301s</span>
<span class="c">#    [INFO] 172.20.1.42:59040 - 38304 "AAAA IN api.github.com.svc.cluster.local. udp 50 false 512" NXDOMAIN qr,aa,rd 143 0.001266842s</span>
<span class="c">#    [INFO] 172.20.1.42:47633 - 16595 "AAAA IN api.github.com.cluster.local. udp 46 false 512" NXDOMAIN qr,aa,rd 139 0.007288392s</span>
<span class="c">#    [INFO] 172.20.1.42:47633 - 42706 "A IN api.github.com.cluster.local. udp 46 false 512" NXDOMAIN qr,aa,rd 139 0.032957929s</span>
<span class="c">#    [INFO] 172.20.1.42:48160 - 48028 "AAAA IN api.github.com. udp 32 false 512" NOERROR qr,rd,ra 116 0.046812603s</span>
<span class="c">#    [INFO] 172.20.1.42:48160 - 49818 "A IN api.github.com. udp 32 false 512" NOERROR qr,rd,ra 62 0.043482105s</span>
<span class="c">#    ...</span>

<span class="c">## 호출</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://api.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://api.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> mediabot
<span class="c"># =&gt; Sep  6 08:01:46.195: default/mediabot:39968 (ID:23762) -&gt; kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) to-endpoint FORWARDED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.197: default/mediabot:39968 (ID:23762) &lt;&gt; kube-system/coredns-6c95f59f49-fgbmq (ID:41039) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.198: default/mediabot:39968 (ID:23762) &lt;- kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) to-network FORWARDED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.198: default/mediabot:39968 (ID:23762) &lt;&gt; kube-system/coredns-6c95f59f49-fgbmq (ID:41039) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.228: default/mediabot:49139 (ID:23762) -&gt; kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) to-endpoint FORWARDED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.230: default/mediabot:49139 (ID:23762) &lt;&gt; kube-system/coredns-6c95f59f49-fgbmq (ID:41039) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.238: default/mediabot:49139 (ID:23762) &lt;&gt; kube-system/coredns-6c95f59f49-fgbmq (ID:41039) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.238: default/mediabot:49139 (ID:23762) &lt;- kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) to-network FORWARDED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.409: default/mediabot:49139 (ID:23762) &lt;- kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) dns-response proxy FORWARDED (DNS Answer  TTL: 4294967295 (Proxy api.github.com. AAAA))</span>
<span class="c">#    Sep  6 08:01:46.410: default/mediabot:49139 (ID:23762) &lt;- kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) dns-response proxy FORWARDED (DNS Answer "20.200.245.245" TTL: 1 (Proxy api.github.com. A))</span>
<span class="c">#    Sep  6 08:01:46.410: kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) &lt;&gt; default/mediabot (ID:23762) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.410: kube-system/kube-dns:53 (world) &lt;&gt; default/mediabot (ID:23762) post-xlate-rev TRANSLATED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.410: kube-system/coredns-6c95f59f49-fgbmq:53 (ID:41039) &lt;&gt; default/mediabot (ID:23762) pre-xlate-rev TRACED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.410: kube-system/kube-dns:53 (world) &lt;&gt; default/mediabot (ID:23762) post-xlate-rev TRANSLATED (UDP)</span>
<span class="c">#    Sep  6 08:01:46.412: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) policy-verdict:L3-Only EGRESS ALLOWED (TCP Flags: SYN)</span>
<span class="c">#    Sep  6 08:01:46.412: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: SYN)</span>
<span class="c">#    Sep  6 08:01:46.421: default/mediabot:46244 (ID:23762) &lt;- api.github.com:443 (ID:16777217) to-endpoint FORWARDED (TCP Flags: SYN, ACK)</span>
<span class="c">#    Sep  6 08:01:46.422: api.github.com:443 (ID:16777217) &lt;&gt; default/mediabot (ID:23762) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Sep  6 08:01:46.422: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: ACK)</span>
<span class="c">#    Sep  6 08:01:46.424: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Sep  6 08:01:46.433: default/mediabot:46244 (ID:23762) &lt;- api.github.com:443 (ID:16777217) to-endpoint FORWARDED (TCP Flags: ACK, PSH)</span>
<span class="c">#    Sep  6 08:01:46.464: api.github.com:443 (ID:16777217) &lt;&gt; default/mediabot (ID:23762) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Sep  6 08:01:46.465: api.github.com:443 (ID:16777217) &lt;&gt; default/mediabot (ID:23762) pre-xlate-rev TRACED (TCP)</span>
<span class="c">#    Sep  6 08:01:46.685: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Sep  6 08:01:46.703: default/mediabot:46244 (ID:23762) &lt;- api.github.com:443 (ID:16777217) to-endpoint FORWARDED (TCP Flags: ACK, FIN)</span>
<span class="c">#    Sep  6 08:01:46.703: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: RST)</span>
<span class="c">#    Sep  6 08:01:46.703: default/mediabot:46244 (ID:23762) -&gt; api.github.com:443 (ID:16777217) to-network FORWARDED (TCP Flags: RST)</span>
<span class="c">#    Sep  6 08:01:46.705: default/mediabot:46244 (ID:23762) &lt;- api.github.com:443 (ID:16777217) to-endpoint FORWARDED (TCP Flags: ACK, RST)</span>

<span class="c">## cilium 파드 이름</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD0</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-ctr <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD1</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w1  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CILIUMPOD2</span><span class="o">=</span><span class="si">$(</span>kubectl get <span class="nt">-l</span> k8s-app<span class="o">=</span>cilium pods <span class="nt">-n</span> kube-system <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span>k8s-w2  <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$CILIUMPOD0</span> <span class="nv">$CILIUMPOD1</span> <span class="nv">$CILIUMPOD2</span>
<span class="c"># =&gt; cilium-p8r4t cilium-vrh7l cilium-rmd6z</span>

<span class="c">## 단축키(alias) 지정</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c0</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD0</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c1</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD1</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>
<span class="nv">$ </span><span class="nb">alias </span><span class="nv">c2</span><span class="o">=</span><span class="s2">"kubectl exec -it </span><span class="nv">$CILIUMPOD2</span><span class="s2"> -n kube-system -c cilium-agent -- cilium"</span>

<span class="c">##</span>
<span class="nv">$ </span>c0 fqdn cache list
<span class="c"># =&gt; Endpoint   Source   FQDN   TTL   ExpirationTime   IPs</span>
<span class="nv">$ </span>c1 fqdn cache list
<span class="c"># =&gt; Endpoint   Source       FQDN                  TTL   ExpirationTime             IPs</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.108.133</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.110.133</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.109.133</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.111.133</span>
<span class="c">#    1039       connection   api.github.com.       0     2025-09-06T08:26:39.259Z   20.200.245.245</span>
<span class="nv">$ </span>c2 fqdn cache list
<span class="c"># =&gt; Endpoint   Source   FQDN   TTL   ExpirationTime   IPs</span>

<span class="nv">$ </span>c0 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": []</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c1 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": [</span>
<span class="c">#        {</span>
<span class="c">#          "regexString": "^api[.]github[.]com[.]$",</span>
<span class="c">#          "selectorString": "MatchName: api.github.com, MatchPattern: "</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c2 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": []</span>
<span class="c">#    }</span>
</code></pre></div></div>

<ul>
  <li>cilium-agent 내에 go 로 구현된 lightweight proxy 가 DNS 쿼리/응답 감시와 <del>캐싱 처리</del> - <a href="https://github.com/cilium/cilium/blob/main/pkg/fqdn/dnsproxy/proxy.go">Code</a>
</li>
</ul>

<h5 id="dns-egress-정책-적용--2--모든-github-하위-도메인예-패턴에-액세스">DNS Egress 정책 적용  2 : 모든 GitHub 하위 도메인(예: 패턴)에 액세스.</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># fqdn 캐시 초기화 및 정책 삭제</span>
<span class="nv">$ </span>kubectl delete cnp fqdn
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io "fqdn" deleted</span>
<span class="nv">$ </span>c1 fqdn cache clean <span class="nt">-f</span>
<span class="c"># =&gt; FQDN proxy cache cleared</span>
<span class="nv">$ </span>c2 fqdn cache clean <span class="nt">-f</span>
<span class="c"># =&gt; FQDN proxy cache cleared</span>

<span class="c"># dns-pattern.yaml 내용</span>
apiVersion: <span class="s2">"cilium.io/v2"</span>
kind: CiliumNetworkPolicy
metadata:
  name: <span class="s2">"fqdn"</span>
spec:
  endpointSelector:
    matchLabels:
      org: empire
      class: mediabot
  egress:
  - toFQDNs:
    - matchName: <span class="s2">"*.github.com"</span>
  - toEndpoints:
    - matchLabels:
        <span class="s2">"k8s:io.kubernetes.pod.namespace"</span>: kube-system
        <span class="s2">"k8s:k8s-app"</span>: kube-dns
    toPorts:
    - ports:
      - port: <span class="s2">"53"</span>
        protocol: ANY
      rules:
        dns:
        - matchPattern: <span class="s2">"*"</span>

<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes-dns/dns-pattern.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/fqdn created</span>
<span class="nv">$ </span>c1 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": [</span>
<span class="c">#        {</span>
<span class="c">#          "regexString": "^[-a-zA-Z0-9_]*[.]github[.]com[.]$",</span>
<span class="c">#          "selectorString": "MatchName: , MatchPattern: *.github.com"</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c2 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": []</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c1 fqdn cache list
<span class="c"># =&gt; Endpoint   Source   FQDN   TTL   ExpirationTime   IPs</span>
<span class="nv">$ </span>c2 fqdn cache list
<span class="c"># =&gt; Endpoint   Source   FQDN   TTL   ExpirationTime   IPs</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME   AGE   VALID</span>
<span class="c">#    fqdn   59s   True</span>

<span class="c"># 외부 통신 확인 : hubble ui 에서 확인 &gt;&gt; github.com 은 공식 문서 설명대로라면 안되야됨..</span>
<span class="c">##  It is important to note and test that this doesn’t allow access to github.com because the *. </span>
<span class="c">## in the pattern requires one subdomain to be present in the DNS name</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://support.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 302</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://gist.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 302</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 https://github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 https://cilium.io| <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; command terminated with exit code 28</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 *.github.com 으로의 접속만 허용되기 때문에 cilium.io 접속은 차단됨&lt;/span&gt;</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_10.png" alt="img.png" class="image-center" loading="lazy" width="1282" height="1010"></p>

<h5 id="dns-egress-정책-적용--3--dns-port-조합-적용">DNS Egress 정책 적용  3 : DNS, Port 조합 적용</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># dns-port.yaml 내용</span>
apiVersion: <span class="s2">"cilium.io/v2"</span>
kind: CiliumNetworkPolicy
metadata:
  name: <span class="s2">"fqdn"</span>
spec:
  endpointSelector:
    matchLabels:
      org: empire
      class: mediabot
  egress:
  - toFQDNs:
    - matchPattern: <span class="s2">"*.github.com"</span>
    toPorts:
    - ports:
      - port: <span class="s2">"443"</span>
        protocol: TCP
  - toEndpoints:
    - matchLabels:
        <span class="s2">"k8s:io.kubernetes.pod.namespace"</span>: kube-system
        <span class="s2">"k8s:k8s-app"</span>: kube-dns
    toPorts:
    - ports:
      - port: <span class="s2">"53"</span>
        protocol: ANY
      rules:
        dns:
        - matchPattern: <span class="s2">"*"</span>

<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes-dns/dns-port.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/fqdn configured</span>
<span class="nv">$ </span>c1 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": [</span>
<span class="c">#        {</span>
<span class="c">#          "regexString": "^[-a-zA-Z0-9_]*[.]github[.]com[.]$",</span>
<span class="c">#          "selectorString": "MatchName: , MatchPattern: *.github.com"</span>
<span class="c">#        }</span>
<span class="c">#      ]</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c2 fqdn names
<span class="c"># =&gt; {</span>
<span class="c">#      "DNSPollNames": null,</span>
<span class="c">#      "FQDNPolicySelectors": []</span>
<span class="c">#    }</span>
<span class="nv">$ </span>c1 fqdn cache list
<span class="c"># =&gt; Endpoint   Source       FQDN                  TTL   ExpirationTime             IPs</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.110.133</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.109.133</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.111.133</span>
<span class="c">#    1039       connection   gist.github.com.      0     2025-09-06T08:26:39.259Z   20.200.245.247</span>
<span class="c">#    1039       connection   github.com.           0     2025-09-06T08:26:39.259Z   20.200.245.247</span>
<span class="c">#    1039       connection   cilium.io.            0     2025-09-06T08:26:39.259Z   104.198.14.52</span>
<span class="c">#    1039       connection   support.github.com.   0     2025-09-06T08:26:39.259Z   185.199.108.133</span>
<span class="nv">$ </span>c2 fqdn cache list
<span class="c"># =&gt; Endpoint   Source   FQDN   TTL   ExpirationTime   IPs</span>
<span class="nv">$ </span>c1 fqdn cache clean <span class="nt">-f</span>
<span class="c"># =&gt; FQDN proxy cache cleared</span>
<span class="nv">$ </span>c2 fqdn cache clean <span class="nt">-f</span>
<span class="c"># =&gt; FQDN proxy cache cleared</span>

<span class="c"># 외부 통신 확인 : hubble ui 에서 확인 </span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://support.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 302</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 http://support.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; command terminated with exit code 28</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_11.png" alt="img.png" class="image-center w-80" loading="lazy" width="605" height="257">
<em class="image-caption">*.github.com의 443 포트만 허용되는 상태</em></p>

<h5 id="실습-리소스-삭제">실습 리소스 삭제</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes-dns/dns-sw-app.yaml
<span class="c"># =&gt; pod "mediabot" deleted</span>
<span class="nv">$ </span>kubectl delete cnp fqdn
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io "fqdn" deleted</span>
</code></pre></div></div>

<h5 id="샘플-애플리케이션-배포-및-통신-문제-확인">샘플 애플리케이션 배포 및 통신 문제 확인</h5>

<ul>
  <li>샘플 애플리케이션 배포</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 샘플 애플리케이션 배포</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
</span><span class="no">EOF
</span><span class="c"># =&gt; deployment.apps/webpod created</span>
<span class="c">#    service/webpod created</span>

<span class="c"># k8s-ctr 노드에 curl-pod 파드 배포</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
</span><span class="no">EOF
</span><span class="c"># =&gt; pod/curl-pod created</span>
</code></pre></div></div>

<ul>
  <li>통신 확인</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 배포 확인</span>
<span class="nv">$ </span>kubectl get deploy,svc,ep webpod <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES           SELECTOR</span>
<span class="c">#    deployment.apps/webpod   2/2     2            2           47s   webpod       traefik/whoami   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span>
<span class="c">#    service/webpod   ClusterIP   10.96.194.188   &lt;none&gt;        80/TCP    47s   app=webpod</span>
<span class="c">#    </span>
<span class="c">#    NAME               ENDPOINTS                         AGE</span>
<span class="c">#    endpoints/webpod   172.20.1.252:80,172.20.2.124:80   47s</span>
<span class="nv">$ </span>kubectl get endpointslices <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>webpod
<span class="c"># =&gt; NAME           ADDRESSTYPE   PORTS   ENDPOINTS                   AGE</span>
<span class="c">#    webpod-mr2xg   IPv4          80      172.20.1.252,172.20.2.124   59s</span>
<span class="nv">$ </span>kubectl get ciliumendpoints <span class="c"># IP 확인</span>
<span class="c"># =&gt; NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6</span>
<span class="c">#    curl-pod                  1846                ready            172.20.0.190</span>
<span class="c">#    webpod-697b545f57-p9hhs   4449                ready            172.20.2.124</span>
<span class="c">#    webpod-697b545f57-rcgf8   4449                ready            172.20.1.252</span>

<span class="c"># 통신 문제 확인</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl <span class="nt">-s</span> <span class="nt">--connect-timeout</span> 1 webpod | <span class="nb">grep </span>Hostname
<span class="c"># =&gt; Hostname: webpod-697b545f57-rcgf8</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'</span>
<span class="c"># =&gt; Hostname: webpod-697b545f57-rcgf8</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-rcgf8</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-rcgf8</span>
<span class="c">#    ---</span>
<span class="c">#    Hostname: webpod-697b545f57-p9hhs</span>
<span class="c">#    ...</span>

<span class="c"># cilium-dbg, map</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg ip list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg endpoint list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg service list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf lb list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg bpf nat list
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map list | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'0             0'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_services_v2
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_backends_v3
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_lb4_reverse_nat
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium-dbg map get cilium_ipcache_v2
</code></pre></div></div>

<h3 id="transparent-encryption-with-wireguard">Transparent Encryption with WireGuard</h3>

<ul>
  <li>각 노드는 자체 암호화 키 쌍을 자동으로 생성하고 Kubernetes CiliumNode 커스텀 리소스 객체의 <code class="language-plaintext highlighter-rouge">io.cilium.network.wg-pub-key</code> 어노테이션을 통해 공개 키를 배포합니다.</li>
  <li>각 노드의 <strong>공개키</strong>는 해당 노드에서 실행 중인 Cilium 관리 엔드포인트의 트래픽을 암호화 및 암호 해독하는 데 다른 노드에서 사용됩니다.</li>
  <li>한 노드 내에서 파드(엔드포인트)간 통신 시에는 암호화 되지 않습니다.</li>
  <li>WireGuard 터널 엔드포인트는 각 노드의 UDP 포트 51871에서 노출됩니다.</li>
  <li>제한 사항 : L7 정책 시행 및 가시성, eBPF 기반 호스트 라우팅</li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_12.png" alt="img.png" class="image-center w-80" loading="lazy" width="1008" height="567"></p>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_14.gif" alt="20250907_cilium_w8_14.gif" class="image-center" loading="lazy" width="1500" height="844">
<em class="image-caption">Wireguard를 이용한 암호화</em></p>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_15.svg" alt="20250907_cilium_w8_15.svg" class="image-center" loading="lazy" width="1626" height="783"></p>

<h3 id="-lab2-wireguard-설정-및-실습">🔬 Lab2. WireGuard 설정 및 실습</h3>

<ul>
  <li>터널모드는 두 번 캡슐화 됩니다. - <a href="https://docs.cilium.io/en/stable/security/network/encryption-wireguard/">Docs</a>, <a href="https://www.youtube.com/watch?v=-awkPi3D60E">Youtube</a>
</li>
  <li>WireGuard 터널 엔드포인트는 51871각 노드의 UDP 포트에 노출됩니다.</li>
  <li>WireGuard 설정</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [커널 구성 옵션] CONFIG_WIREGUARD=m on Linux 5.6 and newe </span>
<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-ar</span>
<span class="c"># =&gt; Linux k8s-ctr 6.8.0-71-generic #71-Ubuntu SMP PREEMPT_DYNAMIC Tue Jul 22 16:44:45 UTC 2025 aarch64 aarch64 aarch64 GNU/Linux</span>
<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'CONFIG_WIREGUARD=m'</span> /boot/config-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>
<span class="c"># =&gt; CONFIG_WIREGUARD=m</span>

<span class="c"># 설정 전 기본 정보 확인</span>
<span class="nv">$ </span>ip <span class="nt">-c</span> addr
<span class="nv">$ </span>ip <span class="nt">-c</span> route
<span class="nv">$ </span>ip rule show

<span class="c"># 설정</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> encryption.enabled<span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> encryption.type<span class="o">=</span>wireguard
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> wireguard
<span class="c"># =&gt; enable-wireguard                                  true</span>
<span class="c">#    wireguard-persistent-keepalive                    0s</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium encrypt status
<span class="c"># =&gt; Encryption: Wireguard</span>
<span class="c">#    Interface: cilium_wg0</span>
<span class="c">#            Public key: chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=</span>
<span class="c">#            Number of peers: 2</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status | <span class="nb">grep </span>Encryption
<span class="c"># =&gt; Encryption:              Wireguard   [NodeEncryption: Disabled, cilium_wg0 (Pubkey: chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=, Port: 51871, Peers: 2)]   </span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium debuginfo <span class="nt">--output</span> json
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium debuginfo <span class="nt">--output</span> json | jq .encryption
<span class="c"># =&gt; {</span>
<span class="c">#      "wireguard": {</span>
<span class="c">#        "interfaces": [</span>
<span class="c">#          {</span>
<span class="c">#            "listen-port": 51871,</span>
<span class="c">#            "name": "cilium_wg0",</span>
<span class="c">#            "peer-count": 2,</span>
<span class="c">#            "peers": [</span>
<span class="c">#              {</span>
<span class="c">#                "allowed-ips": [</span>
<span class="c">#                  "172.20.0.0/24",</span>
<span class="c">#                  "192.168.10.100/32",</span>
<span class="c">#                  "172.20.0.103/32",</span>
<span class="c">#                  "172.20.0.93/32",</span>
<span class="c">#                  "172.20.0.36/32",</span>
<span class="c">#                  "172.20.0.5/32",</span>
<span class="c">#                  "172.20.0.168/32",</span>
<span class="c">#                  "172.20.0.27/32",</span>
<span class="c">#                  "172.20.0.190/32"</span>
<span class="c">#                ],</span>
<span class="c">#                "endpoint": "192.168.10.100:51871",</span>
<span class="c">#                "last-handshake-time": "0001-01-01T00:00:00.000Z",</span>
<span class="c">#                "public-key": "9Pva2PmR3ETq7N/GVRHD4IsmmSYEoJTEFzXg7Qe/FGo="</span>
<span class="c">#              },</span>
<span class="c">#              {</span>
<span class="c">#                "allowed-ips": [</span>
<span class="c">#                  "192.168.10.101/32",</span>
<span class="c">#                  "172.20.1.93/32",</span>
<span class="c">#                  "172.20.1.252/32",</span>
<span class="c">#                  "172.20.1.0/24",</span>
<span class="c">#                  "172.20.1.105/32",</span>
<span class="c">#                  "172.20.1.6/32"</span>
<span class="c">#                ],</span>
<span class="c">#                "endpoint": "192.168.10.101:51871",</span>
<span class="c">#                "last-handshake-time": "0001-01-01T00:00:00.000Z",</span>
<span class="c">#                "public-key": "ZkvKJ95K9Bo6xE6DnkFfRPUHNCsuRAnIejCP7OqObB8="</span>
<span class="c">#              }</span>
<span class="c">#            ],</span>
<span class="c">#            "public-key": "chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw="</span>
<span class="c">#          }</span>
<span class="c">#        ],</span>
<span class="c">#        "node-encryption": "Disabled"</span>
<span class="c">#      }</span>
<span class="c">#    }</span>

<span class="nv">$ </span>ip <span class="nt">-d</span> <span class="nt">-c</span> addr show cilium_wg0
<span class="c"># =&gt; 24: cilium_wg0: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu 1420 qdisc noqueue state UNKNOWN group default</span>
<span class="c">#        link/none  promiscuity 0  allmulti 0 minmtu 0 maxmtu 2147483552</span>
<span class="c">#        wireguard numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 tso_max_size 65536 tso_max_segs 65535 gro_max_size 65536</span>
<span class="nv">$ </span>ip rule show
<span class="c"># =&gt; 9:      from all fwmark 0x200/0xf00 lookup 2004</span>
<span class="c">#    10:     from all fwmark 0xa00/0xf00 lookup 2005</span>
<span class="c">#    100:    from all lookup local</span>
<span class="c">#    32766:  from all lookup main</span>
<span class="c">#    32767:  from all lookup default </span>

<span class="c"># wg 정보 확인</span>
<span class="nv">$ </span>wg <span class="nt">-h</span>
<span class="nv">$ </span>wg show
<span class="c"># =&gt; interface: cilium_wg0</span>
<span class="c">#      public key: 9Pva2PmR3ETq7N/GVRHD4IsmmSYEoJTEFzXg7Qe/FGo=</span>
<span class="c">#      private key: (hidden)</span>
<span class="c">#      listening port: 51871</span>
<span class="c">#      fwmark: 0xe00</span>
<span class="c">#    </span>
<span class="c">#    peer: chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=</span>
<span class="c">#      endpoint: 192.168.10.102:51871</span>
<span class="c">#      allowed ips: 192.168.10.102/32, 172.20.2.243/32, 172.20.2.226/32, 172.20.2.125/32, 172.20.2.124/32, 172.20.2.140/32, 172.20.2.0/24, 172.20.2.171/32</span>
<span class="c">#    </span>
<span class="c">#    peer: ZkvKJ95K9Bo6xE6DnkFfRPUHNCsuRAnIejCP7OqObB8=</span>
<span class="c">#      endpoint: 192.168.10.101:51871</span>
<span class="c">#      allowed ips: 172.20.1.0/24, 172.20.1.105/32, 172.20.1.93/32, 172.20.1.6/32, 192.168.10.101/32, 172.20.1.252/32</span>

<span class="nv">$ </span>wg show all public-key
<span class="c"># =&gt; cilium_wg0      9Pva2PmR3ETq7N/GVRHD4IsmmSYEoJTEFzXg7Qe/FGo=</span>
<span class="nv">$ </span>wg show all private-key
<span class="nv">$ </span>wg show all preshared-keys
<span class="nv">$ </span>wg show all endpoints
<span class="c"># =&gt; cilium_wg0      chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=    192.168.10.102:51871</span>
<span class="c">#    ZkvKJ95K9Bo6xE6DnkFfRPUHNCsuRAnIejCP7OqObB8=    192.168.10.101:51871</span>
<span class="nv">$ </span>wg show all transfer
<span class="c"># =&gt; cilium_wg0      chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=    0       0</span>
<span class="c">#    cilium_wg0      ZkvKJ95K9Bo6xE6DnkFfRPUHNCsuRAnIejCP7OqObB8=    0       0</span>

<span class="c"># 퍼블릭 키 확인</span>
<span class="nv">$ </span>kubectl get cn <span class="nt">-o</span> yaml | <span class="nb">grep </span>annotations <span class="nt">-A1</span>
<span class="c"># =&gt;     annotations:</span>
<span class="c">#          network.cilium.io/wg-pub-key: 9Pva2PmR3ETq7N/GVRHD4IsmmSYEoJTEFzXg7Qe/FGo=</span>
<span class="c">#    --</span>
<span class="c">#        annotations:</span>
<span class="c">#          network.cilium.io/wg-pub-key: ZkvKJ95K9Bo6xE6DnkFfRPUHNCsuRAnIejCP7OqObB8=</span>
<span class="c">#    --</span>
<span class="c">#        annotations:</span>
<span class="c">#          network.cilium.io/wg-pub-key: chlVHrcv7vafkretDiAyIn0+1bU4xVDzxhSxEUBx9lw=</span>
</code></pre></div></div>

<ul>
  <li>통신 확인</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># curl 호출</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod
<span class="c"># =&gt; Hostname: webpod-697b545f57-rcgf8</span>
<span class="c">#    ...</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> curl-pod <span class="nt">--</span> curl webpod
<span class="c"># =&gt; Hostname: webpod-697b545f57-p9hhs</span>
<span class="c">#    ...</span>

<span class="c"># tcpdump</span>
<span class="nv">$ </span>tcpdump <span class="nt">-i</span> cilium_wg0 <span class="nt">-n</span>
<span class="nv">$ </span>tcpdump <span class="nt">-eni</span> any udp port 51871
<span class="nv">$ </span>tcpdump <span class="nt">-eni</span> any udp port 51871 <span class="nt">-w</span> /tmp/wg.pcap  <span class="c"># vagrant scp k8s-ctr:/tmp/wg.pcap . &gt; wireshark 로 확인</span>

<span class="nv">$ </span>termshark /tmp/wg.pcap
<span class="c"># =&gt; termshark 2.4.0  |  wg.pcap                                                                                                                                      Analysis    Misc</span>
<span class="c">#    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span>
<span class="c">#    ┃Filter:                                                                                                                                                         &lt;Apply&gt; &lt;Recent&gt; ┃</span>
<span class="c">#    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛</span>
<span class="c">#     No. -   Time -       Source -              Dest -                Proto -        Length -    Info -                                                                               ▲</span>
<span class="c">#     &lt;span style="background-color: #2080fd; color: #fff;"&gt;1       0.000000     192.168.10.100        192.168.10.102        WireGuard      192         Transport Data, receiver=0x12FBD5BA, counter=28, datalen=112                         █&lt;/span&gt;</span>
<span class="c">#     2       0.001455     192.168.10.100        192.168.10.102        WireGuard      192         Transport Data, receiver=0x12FBD5BA, counter=29, datalen=112</span>
<span class="c">#     3       0.026152     192.168.10.102        192.168.10.100        WireGuard      240         Transport Data, receiver=0xF6874881, counter=22, datalen=160</span>
<span class="c">#     4       0.026152     192.168.10.102        192.168.10.100        WireGuard      288         Transport Data, receiver=0xF6874881, counter=23, datalen=208</span>
<span class="c">#    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
<span class="c">#    [+] Frame 1: 192 bytes on wire (1536 bits), 192 bytes captured (1536 bits)</span>
<span class="c">#    [+] Linux cooked capture v2</span>
<span class="c">#    [+] Internet Protocol Version 4, Src: 192.168.10.100, Dst: 192.168.10.102</span>
<span class="c">#    [+] User Datagram Protocol, Src Port: 51871, Dst Port: 51871</span>
<span class="c">#    [-] WireGuard Protocol</span>
<span class="c">#          Type: Transport Data (4)</span>
<span class="c">#          Reserved: 000000</span>
<span class="c">#          Receiver: 0x12fbd5ba</span>
<span class="c">#          Counter: 28</span>
<span class="c">#    &lt;span style="background-color: #2080fd; color: #fff;"&gt;      Encrypted Packet [=]          &lt;/span&gt;</span>
<span class="c">#    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
<span class="c">#     0000   08 00 00 00 00 00 00 03  00 01 04 06 08 00 27 5d   ........ ......']</span>
<span class="c">#     0010   09 97 00 00 45 00 00 ac  70 7e 00 00 40 11 73 a8   ....E... p~..@.s.</span>
<span class="c">#     0020   c0 a8 0a 64 c0 a8 0a 66  ca 9f ca 9f 00 98 96 c4   ...d...f ........</span>
<span class="c">#     0030   04 00 00 00 ba d5 fb 12  1c 00 00 00 00 00 00 00   ........ ........</span>
<span class="c">#     0040   e6 &lt;span style="background-color: #2080fd; color: #fff;"&gt;08 0f da 17 ab 05 18  ad a8 92 a6 53 17 5e 27&lt;/span&gt;   ........ ....S.^'</span>
<span class="c">#     0050   &lt;span style="background-color: #2080fd; color: #fff;"&gt;79 e8 ce 06 41 63 c2 9b  e1 51 3b b7 a1 a9 82 09&lt;/span&gt;   y...Ac.. .Q;.....</span>
<span class="c">#     0060   &lt;span style="background-color: #2080fd; color: #fff;"&gt;f5 71 8a f3 f9 ad aa 78  40 01 cd e6 22 43 cb 6d&lt;/span&gt;   .q.....x @..."C.m</span>
<span class="c">#     0070   &lt;span style="background-color: #2080fd; color: #fff;"&gt;3e 06 60 40 67 27 5e 96  8b 6f 43 87 32 89 bb 54&lt;/span&gt;   &gt;.`@g'^. .oC.2..T</span>
<span class="c">#     0080   &lt;span style="background-color: #2080fd; color: #fff;"&gt;cc dd 61 ff 0b 52 32 31  7a e0 9f 1f de 50 6e d5&lt;/span&gt;   ..a..R21 z....Pn.</span>
<span class="c">#     0090   &lt;span style="background-color: #2080fd; color: #fff;"&gt;0a 69 d4 d3 9c 73 8d a3  60 ff 34 2b 51 40 65 48&lt;/span&gt;   .i...s.. `.4+Q@eH</span>
<span class="c">#     00a0   &lt;span style="background-color: #2080fd; color: #fff;"&gt;19 8d 8c fb e3 41 40 13  63 06 b8 1a 96 64 10 58&lt;/span&gt;   .....A@. c....d.X</span>
<span class="c">#     00b0   &lt;span style="background-color: #2080fd; color: #fff;"&gt;44 3b fa 0c 7d f8 09 98  f3 50 98 7c 64 04 cd 59&lt;/span&gt;   D;..}... .P.|d..Y</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 패킷이 암호화 되어 있는 것을 확인할 수 있습니다.&lt;/span&gt;</span>

<span class="c"># query the flow API and look for flows</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> curl-pod
</code></pre></div></div>

<ul>
  <li>
<strong>Node-to-Node Encryption (beta)</strong> : 아직 베타 기능이지만 <code class="language-plaintext highlighter-rouge">--set encryption.nodeEncryption=true</code> 옵션을 통해 노드 - 노드 , 노드 - 파드 간 트래픽도 암호화 할 수 있습니다.</li>
  <li>설정 원복</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">--set</span> encryption.enabled<span class="o">=</span><span class="nb">false</span>
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> wireguard
<span class="c"># =&gt; (없음)</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium encrypt status
<span class="c"># =&gt; Encryption: Disabled</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nt">-n</span> kube-system ds/cilium <span class="nt">--</span> cilium status | <span class="nb">grep </span>Encryption
<span class="c"># =&gt; Encryption:              Disabled</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 WireGuard 인터페이스 및 설정이 제거된 것을 확인할 수 있습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h3 id="inspecting-tls-encrypted-connections">Inspecting TLS Encrypted Connections</h3>

<ul>
  <li><a href="https://docs.cilium.io/en/stable/security/tls-visibility/">관련문서</a></li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_16.png" alt="img.png" class="image-center" loading="lazy" width="1204" height="688">
<em class="image-caption"><a href="https://docs.cilium.io/en/stable/security/tls-visibility/">https://docs.cilium.io/en/stable/security/tls-visibility/</a></em></p>

<ul>
  <li>쿠버네티스 환경에서 네트워크 트래픽은 보안을 위해 TLS(Transport Layer Security)로 암호화되는 경우가 많습니다.</li>
  <li>그러나 암호화된 연결은 정책 적용이나 가시성 확보 측면에서 제약이 생길 수 있습니다.</li>
  <li>Cilium은 이러한 문제를 해결하기 위해 <strong>TLS 암호화된 연결도 투명하게 검사할 수 있는 기능</strong>을 제공합니다.</li>
</ul>

<h5 id="소개">소개</h5>

<ul>
  <li>Cilium은 <strong>HTTPS와 같은 TLS 보호 연결에서도 API 인식 가시성과 정책 적용</strong>을 지원합니다.</li>
  <li>기존 하드웨어 방화벽과 유사하지만, 전적으로 <strong>쿠버네티스 워커 노드의 소프트웨어 방식</strong>으로 동작합니다.</li>
  <li>네트워크 보안팀은 <strong>내부 인증 기관(CA)</strong>을 생성하여 클라이언트가 이를 신뢰하도록 설정합니다.</li>
  <li>Cilium은 TLS 연결을 중간에서 종료하고 내부 CA 서명 인증서를 사용하여 대상 서비스와 <strong>새로운 TLS 연결</strong>을 맺습니다.</li>
  <li>이를 통해 <strong>애플리케이션 계층 데이터 검사</strong>와 <strong>정책 적용</strong>이 가능해집니다.</li>
</ul>

<h5 id="tls-검사-구성-단계">TLS 검사 구성 단계</h5>

<p>TLS 검사를 구현하려면 CA 기반 모델을 따라야 하며, 기본 절차는 다음과 같습니다:</p>

<ol>
  <li>
<strong>내부 CA 생성</strong>: CA 인증서를 생성하여 <strong>내부인증기관</strong>을 만듭니다.</li>
  <li>
<strong>대상 서비스 인증서 요청</strong>: DNS 이름과 일치하는 서명 요청(CSR: Certificate Signing Request)을 생성합니다.</li>
  <li>
<strong>CA 서명 인증서 발급</strong>: 내부 CA로 서명된 인증서를 만듭니다.</li>
  <li>
<strong>클라이언트 신뢰 체인 구성</strong>: 클라이언트에 CA 인증서를 설치합니다.</li>
  <li>
<strong>Cilium 구성</strong>: 새로운 TLS 연결을 생성할 때 사용할 신뢰할 CA 집합을 지정합니다.</li>
</ol>

<blockquote>
  <p>⚠️ 운영 환경에서는 <strong>CA 개인 키 보관이 매우 중요</strong>합니다.<br>
개인 키가 유출되면 TLS 트래픽을 누구나 가로채어 검사할 수 있기 때문입니다.<br>
반대로 인증서는 공개 정보이므로 민감하지 않습니다.</p>
</blockquote>

<h5 id="tls-검사-동작-방식">TLS 검사 동작 방식</h5>

<ul>
  <li>Cilium은 클라이언트와의 원래 TLS 연결을 종료하고, Envoy를 통해 대상 서비스와 새로운 TLS 연결을 수립합니다.</li>
  <li>네트워크 정책에는 <code class="language-plaintext highlighter-rouge">terminatingTLS</code> 및 <code class="language-plaintext highlighter-rouge">originatingTLS</code> 설정이 필요합니다.</li>
  <li>이 과정에서 핵심은 <strong>Envoy에 인증서를 전달하는 방식</strong>입니다.</li>
  <li>
    <p><strong>NPDS</strong>(원래의 버전)와 <strong>SDS</strong>(새롭고 향상된 버전) 두 가지 방식을 제공하고 있으며 각각 장단점이 있습니다.</p>
  </li>
  <li>
<strong>NPDS (Network Policy Discovery Service)</strong>
    <ul>
      <li>인증서와 키를 Base64 텍스트로 인라인 전송합니다.</li>
      <li>단순하지만 동일 인증서를 여러 정책에서 사용할 경우 <strong>Envoy 메모리에 중복 저장</strong>됩니다.</li>
      <li>대규모 환경에서는 메모리 사용량이 급증할 수 있는 단점이 있습니다.</li>
    </ul>
  </li>
  <li>
<strong>SDS (Secret Discovery Service)</strong>
    <ul>
      <li>Cilium 1.17부터 도입된 개선된 방식입니다.</li>
      <li>Kubernetes 시크릿을 참조하여 Envoy SDS API를 통해 전달합니다.</li>
      <li>인증서가 <strong>참조 기반으로 전달</strong>되므로 중복 저장이 사라집니다.</li>
      <li>메모리 효율성과 보안이 뛰어나며, <strong>Cilium 1.17 이후 기본값</strong>으로 권장됩니다.</li>
    </ul>
  </li>
</ul>

<h5 id="tls-interception-구성-cilium-117">TLS Interception 구성 (Cilium 1.17+)</h5>

<ul>
  <li>Cilium은 세 가지 방법으로 TLS Interception을 구성할 수 있습니다:</li>
</ul>

<ol>
  <li>
<strong>SDS (권장 방식)</strong>
    <ul>
      <li>정책에서 참조한 시크릿을 <code class="language-plaintext highlighter-rouge">cilium-secrets</code> 네임스페이스에 복사 후 SDS로 동기화합니다.</li>
      <li>기본값이자 가장 안전하고 효율적인 방식입니다.</li>
    </ul>
  </li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tls</span><span class="pi">:</span>
  <span class="na">readSecretsOnlyFromSecretsNamespace</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">secretsNamespace</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">cilium-secrets</span> <span class="c1"># This setting is optional, as it is the default</span>
  <span class="na">secretSync</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre></div></div>

<ol>
  <li>
<strong>NPDS 인라인 방식</strong> (비권장)
    <ul>
      <li>클러스터 내 어느 네임스페이스든 시크릿을 저장할 수 있고, Cilium이 직접 읽어 Envoy에 전달합니다.</li>
      <li>보안 범위가 크게 확장되므로 권장되지 않습니다.</li>
    </ul>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tls:
  readSecretsOnlyFromSecretsNamespace: <span class="nb">false
  </span>secretSync:
    enabled: <span class="nb">false</span>
</code></pre></div></div>

<ol>
  <li>
<strong>하위 호환 모드</strong>
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">cilium-secrets</code> 네임스페이스를 직접 참조합니다.</li>
      <li>업그레이드 호환성을 위해 유지되는 옵션입니다.</li>
    </ul>
  </li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tls</span><span class="pi">:</span>
  <span class="na">readSecretsOnlyFromSecretsNamespace</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">secretsNamespace</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">cilium-secrets</span> <span class="c1"># This setting is optional, as it is the default</span>
  <span class="na">secretSync</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="kc">false</span>
</code></pre></div></div>

<ul>
  <li>Helm 설정 주요 항목
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">tls.secretsNamespace.name</code> : 정책 비밀 네임스페이스 (기본값: <code class="language-plaintext highlighter-rouge">cilium-secrets</code>)</li>
      <li>
<code class="language-plaintext highlighter-rouge">tls.readSecretsOnlyFromSecretsNamespace</code> : 지정 네임스페이스에서만 비밀 읽기 (기본값: <code class="language-plaintext highlighter-rouge">true</code>)</li>
      <li>
<code class="language-plaintext highlighter-rouge">tls.secretSync.enabled</code> : sSDS 사용을 위한 비밀 동기화 활성화 (기본값: <code class="language-plaintext highlighter-rouge">true</code>)</li>
    </ul>
  </li>
</ul>

<h5 id="cilium-tls-interception-설정-sds-mode">Cilium TLS Interception 설정 (SDS Mode)</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl get all,secret,cm <span class="nt">-n</span> cilium-secrets
<span class="c"># =&gt; NAME                         DATA   AGE</span>
<span class="c">#    configmap/kube-root-ca.crt   1      3h33m</span>

<span class="c">#</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; tls-config.yaml
tls:
  readSecretsOnlyFromSecretsNamespace: true
  secretsNamespace:
    name: cilium-secrets # This setting is optional, as it is the default
  secretSync:
    enabled: true
</span><span class="no">EOF

</span><span class="nv">$ </span>helm upgrade cilium cilium/cilium <span class="nt">--version</span> 1.18.1 <span class="nt">--namespace</span> kube-system <span class="nt">--reuse-values</span> <span class="se">\</span>
  <span class="nt">-f</span> tls-config.yaml
<span class="c"># =&gt; Release "cilium" has been upgraded. Happy Helming!</span>
<span class="c">#    ...</span>

<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart deploy/cilium-operator
<span class="c"># =&gt; deployment.apps/cilium-operator restarted</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> kube-system rollout restart ds/cilium
<span class="c"># =&gt; daemonset.apps/cilium restarted</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>cilium config view | <span class="nb">grep</span> <span class="nt">-i</span> secret
<span class="c"># =&gt; enable-ingress-secrets-sync                       true</span>
<span class="c">#    enable-policy-secrets-sync                        true</span>
<span class="c">#    ingress-secrets-namespace                         cilium-secrets</span>
<span class="c">#    policy-secrets-namespace                          cilium-secrets</span>
<span class="c">#    policy-secrets-only-from-secrets-namespace        true</span>
</code></pre></div></div>

<h3 id="-lab3-tls-interception-실습">🔬 Lab3. TLS Interception 실습</h3>

<ul>
  <li>
    <p><a href="https://docs.cilium.io/en/stable/security/tls-visibility/#deploy-the-demo-application">관련문서</a></p>
  </li>
  <li>TLS 가로채기를 시연하기 위해 DNS 인식 정책 예제에 사용한 것과 동일한 <code class="language-plaintext highlighter-rouge">mediabot</code>애플리케이션을 사용할 것입니다. 이 애플리케이션은 HTTPS를 사용하여 Star Wars API 서비스에 액세스합니다. 이는 일반적으로 Cilium과 같은 네트워크 계층 메커니즘이 통신의 HTTP 계층 세부 정보를 볼 수 없음을 의미합니다. 모든 애플리케이션 데이터는 네트워크로 전송되기 전에 TLS를 사용하여 암호화되기 때문입니다.</li>
  <li>다음의 항목을 실습하면서 TLS 가로채기 기능을 이해해 보겠습니다.
    <ul>
      <li>
<strong>TLS 가로채기를 활성화</strong>하기 위해 <strong>내부 인증 기관(CA)과 해당 CA가 서명한 관련 인증서</strong> 생성</li>
      <li>
<strong>DNS 기반 정책 규칙</strong>을 사용하여 <strong>가로챌 트래픽을 선택</strong>하려면 <strong>Cilium 네트워크 정책을</strong> 사용</li>
      <li>cilium monitor를 사용하여 <strong>HTTP 요청의 세부 사항을 검사</strong>
</li>
    </ul>
  </li>
</ul>

<h5 id="단일-포드-mediabot-애플리케이션을-생성">단일 포드 mediabot 애플리케이션을 생성</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># </span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; dns-sw-app.yaml
apiVersion: v1
kind: Pod
metadata:
  name: mediabot
  labels:
    org: empire
    class: mediabot
    app: mediabot
spec:
  containers:
  - name: mediabot
    image: quay.io/cilium/json-mock:v1.3.8@sha256:5aad04835eda9025fe4561ad31be77fd55309af8158ca8663a72f6abb78c2603
</span><span class="no">EOF

</span><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> dns-sw-app.yaml
<span class="c"># =&gt; pod/mediabot created</span>
<span class="nv">$ </span>kubectl <span class="nb">wait </span>pod/mediabot <span class="nt">--for</span><span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready
<span class="c"># =&gt; pod/mediabot condition met</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get pods
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    mediabot                  1/1     Running   0          16s</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> https://api.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 200</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> curl <span class="nt">-I</span> <span class="nt">-s</span> <span class="nt">--max-time</span> 5 https://support.github.com | <span class="nb">head</span> <span class="nt">-1</span>
<span class="c"># =&gt; HTTP/2 302</span>
</code></pre></div></div>

<h5 id="tls-키-및-인증서-생성-및-설치">TLS 키 및 인증서 생성 및 설치</h5>

<ul>
  <li>아래의 이미지는 생성되거나 복사되는 암호화 데이터가 포함된 다양한 파일과 시스템의 어떤 구성 요소가 해당 파일에 액세스해야 하는지 설명합니다.</li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_17.png" alt="img.png" class="image-center" loading="lazy" width="1204" height="688">
<em class="image-caption">암호화 데이터와 시스템의 구성요소간의 액세스 관계도</em></p>

<ul>
  <li>로컬 시스템에 openssl이 이미 설치되어 있다면 사용할 수 있지만, 그렇지 않은 경우 간단한 단축키를 사용하여 cilium 포드 내에서 실행한 후 결과 명령을 실행할 수 있습니다.</li>
  <li>Kubernetes 시크릿을 생성하거나 포드에 복사할 때 cilium 포드에서 결과 파일을 복사하는 데 사용할 수 있습니다 .</li>
</ul>

<h5 id="내부-인증-기관ca-만들기">내부 인증 기관(CA) 만들기</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 'myCA.key'라는 이름의 CA 개인 키를 생성합니다.</span>
<span class="nv">$ </span>openssl genrsa <span class="nt">-des3</span> <span class="nt">-out</span> myCA.key 2048
<span class="c"># =&gt; Enter PEM pass phrase: qwe123          # &lt;span style="color: green;"&gt;CA 인증서에서 사용할 비밀번호 입력&lt;/span&gt;</span>
<span class="c">#    Verifying - Enter PEM pass phrase: qwe123</span>

<span class="nv">$ </span><span class="nb">ls</span> <span class="k">*</span>.key
<span class="c"># =&gt; myCA.key</span>

<span class="c"># 개인 키에서 CA 인증서를 생성</span>
<span class="nv">$ </span>openssl req <span class="nt">-x509</span> <span class="nt">-new</span> <span class="nt">-nodes</span> <span class="nt">-key</span> myCA.key <span class="nt">-sha256</span> <span class="nt">-days</span> 1825 <span class="nt">-out</span> myCA.crt
<span class="c"># =&gt; Enter pass phrase for myCA.key: qwe123   # &lt;span style="color: green;"&gt;개인 키 비밀번호 입력&lt;/span&gt;</span>
<span class="c">#    You are about to be asked to enter information that will be incorporated</span>
<span class="c">#    into your certificate request.</span>
<span class="c">#    What you are about to enter is what is called a Distinguished Name or a DN.</span>
<span class="c">#    There are quite a few fields but you can leave some blank</span>
<span class="c">#    For some fields there will be a default value,</span>
<span class="c">#    If you enter '.', the field will be left blank.</span>
<span class="c">#    -----</span>
<span class="c">#    Country Name (2 letter code) [AU]:KR</span>
<span class="c">#    State or Province Name (full name) [Some-State]:Seoul</span>
<span class="c">#    Locality Name (eg, city) []:Seoul</span>
<span class="c">#    Organization Name (eg, company) [Internet Widgits Pty Ltd]:cloudneta</span>
<span class="c">#    Organizational Unit Name (eg, section) []:study</span>
<span class="c">#    Common Name (e.g. server FQDN or YOUR name) []:cloudneta.net</span>
<span class="c">#    Email Address []:</span>

<span class="nv">$ </span><span class="nb">ls</span> <span class="k">*</span>.crt
<span class="c"># =&gt; myCA.crt</span>

<span class="nv">$ </span>openssl x509 <span class="nt">-in</span> myCA.crt <span class="nt">-noout</span> <span class="nt">-text</span>
<span class="c"># =&gt; ...</span>
<span class="c">#            Issuer: C = KR, ST = Seoul, L = Seoul, O = cloudneta, OU = study, CN = cloudneta.net</span>
<span class="c">#            Validity</span>
<span class="c">#                Not Before: Sep  6 10:55:56 2025 GMT</span>
<span class="c">#                Not After : Sep  5 10:55:56 2030 GMT</span>
<span class="c">#            Subject: C = KR, ST = Seoul, L = Seoul, O = cloudneta, OU = study, CN = cloudneta.net</span>
<span class="c">#    ...</span>
<span class="c">#                X509v3 Basic Constraints: critical</span>
<span class="c">#                    CA:TRUE</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<h5 id="지정된-dns-이름에-대한-개인-키-및-인증서-서명-요청-생성">지정된 DNS 이름에 대한 개인 키 및 인증서 서명 요청 생성</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 검사를 위해 가로채려는 대상 서비스의 DNS 이름과 일치하는 일반 이름을 사용하여 내부 개인 키와 인증서 서명을 생성합니다</span>
<span class="c">## 이 예에서는 httpbin.org</span>

<span class="c"># 먼저 개인 키를 만듭니다.</span>
<span class="nv">$ </span>openssl genrsa <span class="nt">-out</span> internal-httpbin.key 2048
<span class="nv">$ </span><span class="nb">ls </span>internal-httpbin.key
<span class="c"># =&gt; internal-httpbin.key</span>

<span class="c"># 다음으로, 인증서 서명 요청을 생성하고, 메시지가 표시되면 일반 이름 필드에 대상 서비스의 DNS 이름을 지정합니다. </span>
<span class="c"># 다른 모든 메시지에는 원하는 값을 입력할 수 있습니다.</span>
<span class="c"># 특정 값이어야 하는 유일한 필드는 클라이언트에 제공될 정확한 DNS 대상을 보장하는 것입니다. Common Name: httpbin.org</span>
<span class="c"># 이 예제 워크플로는 정책 YAML(아래)의 toFQDNs 규칙도 인증서의 DNS 이름과 일치하도록 업데이트되는 한 모든 DNS 이름에 적용됩니다.</span>
<span class="nv">$ </span>openssl req <span class="nt">-new</span> <span class="nt">-key</span> internal-httpbin.key <span class="nt">-out</span> internal-httpbin.csr
<span class="c"># =&gt; ...</span>
<span class="c">#    Common Name (e.g. server FQDN or YOUR name) []:httpbin.org</span>
<span class="c">#    ...</span>

<span class="nv">$ </span><span class="nb">ls </span>internal-httpbin.csr
<span class="c"># =&gt; internal-httpbin.csr</span>
</code></pre></div></div>

<h5 id="ca를-사용하여-dns-이름에-대한-서명된-인증서-생성">CA를 사용하여 DNS 이름에 대한 서명된 인증서 생성</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 내부 CA 개인 키를 사용하여 httpbin.org에 대한 서명된 인증서를 생성합니다 internal-httpbin.crt</span>
<span class="nv">$ </span>openssl x509 <span class="nt">-req</span> <span class="nt">-days</span> 360 <span class="nt">-in</span> internal-httpbin.csr <span class="nt">-CA</span> myCA.crt <span class="nt">-CAkey</span> myCA.key <span class="nt">-CAcreateserial</span> <span class="nt">-out</span> internal-httpbin.crt <span class="nt">-sha256</span>
<span class="c"># =&gt; Certificate request self-signature ok</span>
<span class="c">#    subject=C = KR, ST = Seoul, L = Seoul, O = cloudneta, OU = study, CN = httpbin.org</span>
<span class="c">#    Enter pass phrase for myCA.key: qwe123     &lt;span style="color: green;"&gt;CA 개인 키 비밀번호 입력&lt;/span&gt;</span>
  
<span class="nv">$ </span><span class="nb">ls </span>internal-httpbin.crt
<span class="c"># =&gt; internal-httpbin.crt</span>
<span class="nv">$ </span>openssl x509 <span class="nt">-in</span> internal-httpbin.crt <span class="nt">-noout</span> <span class="nt">-text</span>
<span class="c"># =&gt; ...</span>
<span class="c">#            Issuer: C = KR, ST = Seoul, L = Seoul, O = cloudneta, OU = study, CN = cloudneta.net   # &lt;span style="color: green;"&gt;내부 CA 인증서 정보&lt;/span&gt;</span>
<span class="c">#            Validity</span>
<span class="c">#                Not Before: Sep  6 11:00:18 2025 GMT</span>
<span class="c">#                Not After : Sep  1 11:00:18 2026 GMT</span>
<span class="c">#            Subject: C = KR, ST = Seoul, L = Seoul, O = cloudneta, OU = study, CN = httpbin.org    # &lt;span style="color: green;"&gt;대상 서비스 인증서 정보&lt;/span&gt;</span>
  
<span class="c"># 다음으로 대상 서비스에 대한 개인 키와 서명된 인증서를 모두 포함하는 Kubernetes 비밀을 생성합니다.</span>
<span class="nv">$ </span>kubectl create secret tls httpbin-tls-data <span class="nt">-n</span> kube-system <span class="nt">--cert</span><span class="o">=</span>internal-httpbin.crt <span class="nt">--key</span><span class="o">=</span>internal-httpbin.key
<span class="c"># =&gt; secret/httpbin-tls-data created</span>
<span class="nv">$ </span>kubectl get secret <span class="nt">-n</span> kube-system  httpbin-tls-data
<span class="c"># =&gt; NAME               TYPE                DATA   AGE</span>
<span class="c">#    httpbin-tls-data   kubernetes.io/tls   2      10s  </span>
</code></pre></div></div>

<h5 id="클라이언트-포드-내에서-신뢰할-수-있는-ca로-내부-ca-추가">클라이언트 포드 내에서 신뢰할 수 있는 CA로 내부 CA 추가</h5>

<ul>
  <li>CA 인증서가 클라이언트 포드에 저장된 후에도 애플리케이션에서 사용하는 TLS 라이브러리가 CA 파일을 인식하는지 확인해야 합니다.
    <ul>
      <li>대부분의 Linux 애플리케이션은 Linux 배포판과 함께 제공되는 신뢰할 수 있는 CA 인증서 세트를 자동으로 사용합니다.
        <ul>
          <li>이 가이드에서는 Ubuntu 컨테이너를 클라이언트로 사용하므로 Ubuntu별 지침에 따라 업데이트합니다. 다른 Linux 배포판은 다른 메커니즘을 사용합니다.</li>
        </ul>
      </li>
      <li>개별 애플리케이션은 OS 인증서 저장소를 사용하는 대신 자체 인증서 저장소를 활용할 수 있습니다. 자세한 내용은 애플리케이션 또는 애플리케이션 런타임 설명서를 참조하십시오.</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /usr/local/share/ca-certificates/
<span class="c"># =&gt; total 0</span>
  
<span class="c"># Ubuntu의 경우 먼저 추가 CA 인증서를 클라이언트 Pod 파일 시스템에 복사합니다.</span>
<span class="nv">$ </span>kubectl <span class="nb">cp </span>myCA.crt default/mediabot:/usr/local/share/ca-certificates/myCA.crt
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /usr/local/share/ca-certificates/
<span class="c"># =&gt; total 4</span>
<span class="c">#    -rw-r--r-- 1 root root 1342 Sep  6 11:03 myCA.crt</span>
  
<span class="c"># /etc/ssl/certs/ca-certificates.crt에 있는 신뢰할 수 있는 인증 기관의 글로벌 세트에 이 인증서를 추가하는 Ubuntu 전용 유틸리티 실행</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /etc/ssl/certs/ca-certificates.crt <span class="c"># 사이즈, 생성/수정 날짜 확인</span>
<span class="c"># =&gt; -rw-r--r-- 1 root root 213777 Jan  9  2024 /etc/ssl/certs/ca-certificates.crt</span>
<span class="nv">$ </span>kubectl <span class="nb">exec </span>mediabot <span class="nt">--</span> update-ca-certificates
<span class="c"># =&gt; Updating certificates in /etc/ssl/certs...</span>
<span class="c">#    rehash: warning: skipping ca-certificates.crt,it does not contain exactly one certificate or CRL</span>
<span class="c">#    1 added, 0 removed; done.</span>
<span class="c">#    Running hooks in /etc/ca-certificates/update.d...</span>
<span class="c">#    done.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /etc/ssl/certs/ca-certificates.crt <span class="c"># 사이즈, 생성/수정 날짜 확인</span>
<span class="c"># =&gt; -rw-r--r-- 1 root root 215119 Sep  6 11:04 /etc/ssl/certs/ca-certificates.crt</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 신규 CA 인증서가 추가되어 파일 크기와 수정 날짜가 변경된 것을 확인할 수 있습니다.&lt;/span&gt;</span>
</code></pre></div></div>

<h5 id="cilium에-신뢰할-수-있는-ca-목록-제공">Cilium에 신뢰할 수 있는 CA 목록 제공</h5>

<ul>
  <li>다음으로, Cilium이 <strong>보조 TLS 연결을 시작할</strong> 때 <strong>신뢰해야 하는 CA 세트를 제공</strong>합니다. 이 목록은 조직에서 신뢰하는 <strong>표준 글로벌 CA 세트와</strong> 일치해야 합니다. 논리적인 옵션 중 하나는 운영 체제에서 신뢰하는 표준 CA 세트입니다. 이는 TLS 검사 도입 이전에 사용되던 CA 세트이기 때문입니다.</li>
  <li>간단하게 설명하기 위해 이 예에서 우리는 m<strong>ediabot 포드의 Ubuntu 파일 시스템에서 이 목록을 복사</strong>할 것입니다. 하지만 이 신뢰할 수 있는 CA 목록은 특정 TLS 클라이언트나 서버에만 국한되지 않는다는 점을 이해하는 것이 중요합니다. 따라서 TLS 검사에 참여하는 TLS 클라이언트나 서버의 수에 관계없이 이 단계는 한 번만 수행하면 됩니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">cp </span>default/mediabot:/etc/ssl/certs/ca-certificates.crt ca-certificates.crt
  
<span class="c">#  이 인증서 번들을 사용하여 Kubernetes 비밀을 생성하여 Cilium이 인증서 번들을 읽고 이를 사용하여 나가는 TLS 연결을 검증할 수 있도록 합니다.</span>
<span class="nv">$ </span>kubectl create secret generic tls-orig-data <span class="nt">-n</span> kube-system <span class="nt">--from-file</span><span class="o">=</span>ca.crt<span class="o">=</span>./ca-certificates.crt
<span class="c"># =&gt; secret/tls-orig-data created</span>
<span class="nv">$ </span>kubectl get secret <span class="nt">-n</span> kube-system tls-orig-data
<span class="c"># =&gt; NAME            TYPE     DATA   AGE</span>
<span class="c">#    tls-orig-data   Opaque   1      7s  </span>
</code></pre></div></div>

<h5 id="apply-dns-and-tls-aware-egress-policy">Apply DNS and TLS-aware Egress Policy</h5>

<ul>
  <li>지금까지 TLS 검사를 활성화하기 위한 키와 인증서를 생성했지만, Cilium에 어떤 트래픽을 가로채서 검사할지 알려주지 않았습니다. 이 작업은 다른 Cilium 네트워크 정책에 사용되는 것과 동일한 Cilium 네트워크 정책 구조를 사용하여 수행됩니다.</li>
  <li>다음 Cilium 네트워크 정책은 Cilium이 <code class="language-plaintext highlighter-rouge">mediabot</code>포드와 . 사이의 통신에 대해 HTTP 인식 검사를 수행해야 함을 나타냅니다 <code class="language-plaintext highlighter-rouge">httpbin.org</code>.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cilium.io/v2"</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CiliumNetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">l7-visibility-tls"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s">L7 policy with TLS</span>
  <span class="na">endpointSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">org</span><span class="pi">:</span> <span class="s">empire</span>
      <span class="na">class</span><span class="pi">:</span> <span class="s">mediabot</span>
  <span class="na">egress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">toFQDNs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">matchName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">httpbin.org"</span>
    <span class="na">toPorts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">443"</span>
        <span class="na">protocol</span><span class="pi">:</span> <span class="s2">"</span><span class="s">TCP"</span>
      <span class="na">terminatingTLS</span><span class="pi">:</span>
        <span class="na">secret</span><span class="pi">:</span>
          <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kube-system"</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">httpbin-tls-data"</span>
      <span class="na">originatingTLS</span><span class="pi">:</span>
        <span class="na">secret</span><span class="pi">:</span>
          <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kube-system"</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">tls-orig-data"</span>
      <span class="na">rules</span><span class="pi">:</span>
        <span class="na">http</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="pi">{}</span>
  <span class="pi">-</span> <span class="na">toPorts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">53"</span>
        <span class="na">protocol</span><span class="pi">:</span> <span class="s">ANY</span>
      <span class="na">rules</span><span class="pi">:</span>
        <span class="na">dns</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">matchPattern</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>
</code></pre></div></div>

<ul>
  <li>즉 , 이 정책은 출구 접근 권한이 있는 <code class="language-plaintext highlighter-rouge">endpointSelector</code>라벨이 있는 포드에만 적용됩니다 .<code class="language-plaintext highlighter-rouge">class: mediabot, org:empire</code>
</li>
  <li>첫 번째 출구 섹션에서는 사양을 사용하여 TCP 포트 443 출구를 허용합니다 .<code class="language-plaintext highlighter-rouge">toFQDNs: matchNamehttpbin.org</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">http</code>toFQDNs 규칙 아래의 섹션은 이러한 연결이 모든 요청을 허용하는 정책에 따라 HTTP로 구문 분석되어야 함을 나타 냅니다 <code class="language-plaintext highlighter-rouge">{}</code>.</li>
  <li>및 섹션은 <strong>TLS 가로채기를 사용하여 mediabot에서의 초기 TLS 연결을 종료</strong>하고 .에 대한 <strong>새로운 아웃바운드 TLS 연결을 시작</strong>해야 함을 나타 <code class="language-plaintext highlighter-rouge">terminatingTLS</code>냅니다 .<code class="language-plaintext highlighter-rouge">originatingTLShttpbin.org</code>
</li>
  <li>두 번째 출구 섹션은 <code class="language-plaintext highlighter-rouge">mediabot</code>포드가 <code class="language-plaintext highlighter-rouge">kube-dns</code>서비스에 접근할 수 있도록 합니다. Cilium이 지정된 패턴과 일치하는 DNS 조회를 검사하고 허용하도록 지시합니다. 이 경우 모든 DNS 쿼리를 검사하고 허용합니다.<code class="language-plaintext highlighter-rouge">rules: dns</code>
</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 모니터링 : hubble cli 나 ui 에서 https 이니 L7 정보 확인 불가능</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> mediabot <span class="nt">-f</span>
  
<span class="c"># </span>
<span class="nv">$ </span>kubectl get pods
<span class="c"># =&gt; NAME                      READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    mediabot                  1/1     Running   0          19m</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> curl <span class="nt">-sL</span> <span class="s1">'https://httpbin.org/anything'</span>
<span class="c"># =&gt; {</span>
<span class="c">#      "args": {},</span>
<span class="c">#      "data": "",</span>
<span class="c">#      "files": {},</span>
<span class="c">#      "form": {},</span>
<span class="c">#      "headers": {</span>
<span class="c">#        "Accept": "*/*",</span>
<span class="c">#        "Host": "httpbin.org",</span>
<span class="c">#        "User-Agent": "curl/7.88.1",</span>
<span class="c">#        "X-Amzn-Trace-Id": "Root=1-68bc1691-6a809d304ab6834b5a89a5ca"</span>
<span class="c">#      },</span>
<span class="c">#      "json": null,</span>
<span class="c">#      "method": "GET",</span>
<span class="c">#      "origin": "211.229.62.113",</span>
<span class="c">#      "url": "https://httpbin.org/anything"</span>
<span class="c">#    }</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> curl <span class="nt">-sL</span> <span class="s1">'https://httpbin.org/headers'</span> <span class="nt">-v</span> <span class="c"># 서버 인증서 확인</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    * Server certificate:</span>
<span class="c">#    *  subject: CN=httpbin.org</span>
<span class="c">#    *  start date: Jul 20 00:00:00 2025 GMT</span>
<span class="c">#    *  expire date: Aug 17 23:59:59 2026 GMT</span>
<span class="c">#    *  subjectAltName: host "httpbin.org" matched cert's "httpbin.org"</span>
<span class="c">#    *  issuer: &lt;span style="color: green;"&gt;C=US; O=Amazon; CN=Amazon RSA 2048 M03&lt;/span&gt; # &lt;span style="color: green;"&gt;👉 원래의 인증기관(CA)에서 발급한 인증서&lt;/span&gt;</span>
<span class="c">#    *  SSL certificate verify ok.</span>
  
<span class="c"># 정책 적용</span>
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes-tls-inspection/l7-visibility-tls.yaml
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io/l7-visibility-tls created</span>
<span class="nv">$ </span>kubectl get cnp
<span class="c"># =&gt; NAME                AGE   VALID</span>
<span class="c">#    l7-visibility-tls   7s    True  </span>
</code></pre></div></div>

<h5 id="demonstrating-tls-inspection">Demonstrating TLS Inspection</h5>

<ul>
  <li>우리가 푸시한 정책은 에서 <code class="language-plaintext highlighter-rouge">mediabot</code>로의 모든 HTTPS 요청을 허용 <code class="language-plaintext highlighter-rouge">httpbin.org</code>하지만 모든 데이터는 HTTP 계층에서 구문 분석한다는 점을 기억하세요. 즉, cilium monitor는 모든 HTTP 요청과 응답을 보고합니다.</li>
  <li>이를 확인하려면 새 창을 열고 다음 명령을 실행하여 <code class="language-plaintext highlighter-rouge">mediabot</code>포드와 동일한 Kubernetes 워커 노드에서 실행 중인 cilium 포드의 이름(예: cilium-97s78)을 식별합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 모니터링 : hubble cli 나 ui 에서 https 이니 L7 정보 확인 불가능</span>
<span class="nv">$ </span>hubble observe <span class="nt">--pod</span> mediabot <span class="nt">-f</span>
  
<span class="c">#</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> curl <span class="nt">-sL</span> <span class="s1">'https://httpbin.org/anything'</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mediabot <span class="nt">--</span> curl <span class="nt">-sL</span> <span class="s1">'https://httpbin.org/headers'</span> <span class="nt">-v</span> <span class="c"># 서버 인증서 확인</span>
<span class="c"># =&gt; ...</span>
<span class="c">#    * Server certificate:</span>
<span class="c">#    *  subject: C=KR; ST=Seoul; L=Seoul; O=cloudneta; OU=study; CN=httpbin.org</span>
<span class="c">#    *  start date: Sep  6 11:00:18 2025 GMT</span>
<span class="c">#    *  expire date: Sep  1 11:00:18 2026 GMT</span>
<span class="c">#    *  common name: httpbin.org (matched)</span>
<span class="c">#    *  issuer: &lt;span style="color: green;"&gt;C=KR; ST=Seoul; L=Seoul; O=cloudneta; OU=study; CN=cloudneta.net&lt;/span&gt; </span>
<span class="c">#  &lt;span style="color: green;"&gt;👉 내부 인증기관(CA)에서 발급한 인증서로 교체되어 있습니다!&lt;/span&gt;</span>
<span class="c">#  &lt;span style="color: green;"&gt;    즉, 우리가 만든 CA에서 발급한 인증서로 TLS 연결이 맺어진 것을 확인할 수 있으며&lt;/span&gt;</span>
<span class="c">#  &lt;span style="color: green;"&gt;    TLS 가로채기가 성공적으로 이루어진 것입니다.&lt;/span&gt;</span>
<span class="c">#    *  SSL certificate verify ok.</span>
</code></pre></div></div>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_18.png" alt="img.png" class="image-center" loading="lazy" width="1238" height="966"></p>

<ul>
  <li>원래는 알 수 없었던 L7 정보가 인증서 교체후 “GET /anything” 으로 확인되는 것을 확인할 수 있습니다.</li>
</ul>

<h5 id="실습-리소스-삭제-1">실습 리소스 삭제</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/1.18.1/examples/kubernetes-dns/dns-sw-app.yaml
<span class="c"># =&gt; pod "mediabot" deleted</span>
<span class="nv">$ </span>kubectl delete cnp l7-visibility-tls
<span class="c"># =&gt; ciliumnetworkpolicy.cilium.io "l7-visibility-tls" deleted</span>
<span class="nv">$ </span>kubectl delete secret <span class="nt">-n</span> kube-system tls-orig-data
<span class="c"># =&gt; secret "tls-orig-data" deleted</span>
<span class="nv">$ </span>kubectl delete secret <span class="nt">-n</span> kube-system httpbin-tls-data
<span class="c"># =&gt; secret "httpbin-tls-data" deleted</span>
</code></pre></div></div>

<hr>

<h2 id="tetragon">Tetragon</h2>

<ul>
  <li>
<strong>Tetragon 소개 Youtube 영상</strong> : eCHO Episode 194: Tetragon Everywhere
    <iframe width="560" height="315" src="https://www.youtube.com/embed/JDvmlECqYg4?si=uimpIPgm5g-OeRAJ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
  </li>
  <li>Tetragon Resources - <a href="https://tetragon.io/docs/resources/">Link</a>
</li>
</ul>

<h3 id="tetragon-소개">Tetragon 소개</h3>

<ul>
  <li>
<strong>Tetragon</strong>은 <strong>eBPF 기반의 런타임 보안 및 관찰 도구</strong>입니다. - <a href="https://tetragon.io/docs/overview/">Docs</a>
</li>
  <li>
<strong>Linux 커널의 모든 함수에 연결</strong>하여 인수, 반환 값, Tetragon이 <strong>프로세스에 대해 수집하는 관련 메타데이터</strong>(예: 실행 파일 이름), <strong>파일</strong> 및 기타 속성을 <strong>필터링할</strong> 수 있습니다.</li>
  <li>
<strong>Kubernetes 환경을 인식</strong>하며, 네임스페이스, 포드 등의 Kubernetes ID를 이해하므로 개별 작업 부하와 관련하여 보안 이벤트 감지를 구성할 수 있습니다.</li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_19.png" alt="img.png" loading="lazy" width="1678" height="1188"></p>

<ul>
  <li>
<strong>Tetragon</strong>은 다음과 같은 보안에 중요한 이벤트를 감지하고 대응할 수 있습니다.
    <ul>
      <li>
<strong>Process</strong> 실행 및 종료 events</li>
      <li>
<strong>System</strong> 콜 호출 및 반환</li>
      <li>네트워크와 파일 액세스를 포함한 <strong>I/O</strong> 활동</li>
    </ul>
  </li>
  <li>Kubernetes 환경에서 Tetragon을 사용하면 Kubernetes를 인식합니다.
    <ul>
      <li>즉, 네임스페이스, 포드 등의 Kubernetes ID를 이해하므로 개별 작업 부하와 관련하여 보안 이벤트 감지를 구성할 수 있습니다.</li>
    </ul>
  </li>
</ul>

<h5 id="기능-개요">기능 개요</h5>

<ul>
  <li>
<strong>eBPF 실시간 처리</strong>
    <ul>
      <li>모든 정책과 필터링을 <strong>커널 내부 eBPF</strong>에서 직접 수행합니다.
        <ul>
          <li>이벤트를 유저 공간으로 보내지 않고 커널에서 차단/반응 처리 → 성능 향상.</li>
        </ul>
      </li>
      <li>고빈도 이벤트(send, read, write 등)도 커널에서 바로 필터링하므로 <strong>관측 오버헤드가 감소</strong>됩니다.</li>
      <li>파일, 소켓, 바이너리 이름, 네임스페이스, 권한(capabilities) 등 <strong>세부 필터링을 지원</strong>합니다.</li>
      <li>이렇게 지정된 이벤트만 유저 공간으로 전달하므로 자원 사용 효율적입니다.</li>
    </ul>
  </li>
  <li>
<strong>eBPF 유연한 추적</strong>
    <ul>
      <li>Tetragon은 <strong>리눅스 커널의 모든 함수에 연결(hook)이 가능</strong>하고, 이를 통해
함수의 인자, 반환값, 프로세스/파일 메타데이터 등 다양한 기준으로 필터링합니다.</li>
      <li>사용자가 직접 <strong>트레이싱 정책(tracing policy)</strong>을 작성해 보안/관측 시나리오를 해결 가능합니다.</li>
      <li>저장소에는 여러 예시가 제공되며, 사용자는 이를 기반으로 <strong>자신만의 정책</strong>을 만들 수 있습니다.</li>
      <li>특정 커널 함수 추적도 가능하며, <strong>엔진에 하드코딩된 제한 없습니다.</strong>
</li>
      <li>시스템콜 트레이싱에서 흔히 발생하는 문제(잘못된 데이터 읽기, 악의적 조작, 페이지 폴트 누락 등)를 <strong>커널 깊숙한 곳에서 안정적으로 훅킹</strong>하여 회피합니다.</li>
      <li>개발자 다수가 커널 개발 경험을 갖고 있어, 다양한 <strong>보안 및 관측 유스케이스를 지원하는 정책 세트</strong>를 제공합니다.</li>
    </ul>
  </li>
  <li>
<strong>eBPF을 통한 커널 인식</strong>
    <ul>
      <li>eBPF를 통해 Tetragon은 <strong>리눅스 커널 상태에 직접 접근</strong>합니다.</li>
      <li>이를 쿠버네티스 정보나 사용자 정책과 결합해 <strong>실시간 커널 레벨 규칙 적용</strong>이 가능합니다.</li>
      <li>예를 들어, <strong>애플리케이션이 권한을 변경</strong>할 때, 해당 <strong>프로세스가 시스템 호출을 완료</strong>하고 추가 시스템 호출을 실행하기 전에 <strong>경고를 발생</strong>시키거나 <strong>프로세스를 종료하는 정책을 생성</strong>할 수 있습니다.</li>
    </ul>
  </li>
</ul>

<h3 id="tetragon-설치">Tetragon 설치</h3>

<ul>
  <li><a href="https://tetragon.io/docs/getting-started/">관련문서</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /proc 파일 시스템 액세스 필요.</span>
<span class="c"># 기본적으로 Tetragon은 이벤트 로그의 노이즈를 줄이기 위해 kube-system 이벤트를 필터링합니다. </span>
<span class="nv">$ </span>helm repo add cilium https://helm.cilium.io
<span class="nv">$ </span>helm repo update
<span class="c"># =&gt; ...Successfully got an update from the "cilium" chart repository</span>
<span class="c">#    Update Complete. ⎈Happy Helming!⎈</span>
<span class="nv">$ </span>helm <span class="nb">install </span>tetragon cilium/tetragon <span class="nt">-n</span> kube-system
<span class="c"># =&gt; NAME: tetragon</span>
<span class="c">#    LAST DEPLOYED: Sat Sep  6 21:14:53 2025</span>
<span class="c">#    NAMESPACE: kube-system</span>
<span class="c">#    STATUS: deployed</span>
<span class="c">#    REVISION: 1</span>
<span class="c">#    TEST SUITE: None</span>
<span class="nv">$ </span>kubectl rollout status <span class="nt">-n</span> kube-system ds/tetragon <span class="nt">-w</span>
<span class="c"># =&gt; daemon set "tetragon" successfully rolled out</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get deploy tetragon-operator <span class="nt">-owide</span>
<span class="c"># =&gt; NAME                READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS          IMAGES                                    SELECTOR</span>
<span class="c">#    tetragon-operator   1/1     1            1           37s   tetragon-operator   quay.io/cilium/tetragon-operator:v1.5.0   app.kubernetes.io/instance=tetragon,app.kubernetes.io/name=tetragon-operator</span>
<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get cm tetragon-operator-config tetragon-config
<span class="c"># =&gt; NAME                       DATA   AGE</span>
<span class="c">#    tetragon-operator-config   9      45s</span>
<span class="c">#    tetragon-config            33     45s</span>

<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get ds tetragon <span class="nt">-owide</span>
<span class="c"># =&gt; NAME       DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE   CONTAINERS               IMAGES                                                                      SELECTOR</span>
<span class="c">#    tetragon   3         3         3       3            3           &lt;none&gt;          54s   export-stdout,tetragon   quay.io/cilium/hubble-export-stdout:v1.1.0,quay.io/cilium/tetragon:v1.5.0   app.kubernetes.io/instance=tetragon,app.kubernetes.io/name=tetragon</span>
<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get svc,ep tetragon
<span class="c"># =&gt; NAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/tetragon   ClusterIP   10.96.248.15   &lt;none&gt;        2112/TCP   75s</span>
<span class="c">#    </span>
<span class="c">#    NAME                 ENDPOINTS                                                     AGE</span>
<span class="c">#    endpoints/tetragon   192.168.10.100:2112,192.168.10.101:2112,192.168.10.102:2112   75s</span>
<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get svc,ep tetragon-operator-metrics
<span class="c"># =&gt; NAME                                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span>
<span class="c">#    service/tetragon-operator-metrics   ClusterIP   10.96.105.200   &lt;none&gt;        2113/TCP   83s</span>
<span class="c">#    </span>
<span class="c">#    NAME                                  ENDPOINTS          AGE</span>
<span class="c">#    endpoints/tetragon-operator-metrics   172.20.1.32:2113   83s</span>

<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get pod <span class="nt">-l</span> app.kubernetes.io/part-of<span class="o">=</span>tetragon <span class="nt">-owide</span>
<span class="nv">$ </span>k <span class="nt">-n</span> kube-system get pod <span class="nt">-l</span> app.kubernetes.io/name<span class="o">=</span>tetragon
<span class="nv">$ </span>kc <span class="nt">-n</span> kube-system describe pod <span class="nt">-l</span> app.kubernetes.io/name<span class="o">=</span>tetragon
<span class="c"># =&gt; ...</span>
<span class="c">#    Containers:</span>
<span class="c">#      export-stdout:</span>
<span class="c">#        Container ID:  containerd://eb8abd117200c08e26b7efc02ae15ff14a618d1fa282b30530db973468ad1dcf</span>
<span class="c">#        Image:         quay.io/cilium/hubble-export-stdout:v1.1.0</span>
<span class="c">#    ...</span>
<span class="c">#      tetragon:</span>
<span class="c">#        Container ID:  containerd://7b283b22db614b6288a01c09e302349720d85e64ab85d449173abec9597ddce8</span>
<span class="c">#        Image:         quay.io/cilium/tetragon:v1.5.0</span>
<span class="c">#    ...</span>
</code></pre></div></div>

<ul>
  <li>데모 애플리케이션 배포</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/cilium/v1.18.1/examples/minikube/http-sw-app.yaml
<span class="c"># =&gt; service/deathstar created</span>
<span class="c">#    deployment.apps/deathstar created</span>
<span class="c">#    pod/tiefighter created</span>
<span class="c">#    pod/xwing created</span>

<span class="c"># 확인</span>
<span class="nv">$ </span>kubectl get pods
<span class="c"># =&gt; NAME                         READY   STATUS    RESTARTS   AGE</span>
<span class="c">#    deathstar-86f85ffb4d-2z9dv   1/1     Running   0          23s</span>
<span class="c">#    deathstar-86f85ffb4d-djnhm   1/1     Running   0          23s</span>
<span class="c">#    tiefighter                   1/1     Running   0          23s</span>
<span class="c">#    xwing                        1/1     Running   0          23s</span>
</code></pre></div></div>

<h3 id="실행-모니터링">실행 모니터링</h3>

<ul>
  <li>시스템의 모든 실행을 추적합니다. - <a href="https://tetragon.io/docs/getting-started/execution/">Docs</a>, <a href="https://yuki-nakamura.com/2024/05/23/tetragon-process-lifecycle-observation-tetragon-agent-part/">Blog</a>
</li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_20.png" alt="img.png" class="image-center" loading="lazy" width="2048" height="966">
<em class="image-caption"><a href="https://isovalent.com/blog/post/top-tetragon-use-cases/">https://isovalent.com/blog/post/top-tetragon-use-cases/</a></em></p>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_21.png" alt="img_1.png" class="image-center" loading="lazy" width="2041" height="443">
<em class="image-caption"><a href="https://yuki-nakamura.com/2024/05/23/tetragon-process-lifecycle-observation-tetragon-agent-part/">https://yuki-nakamura.com/2024/05/23/tetragon-process-lifecycle-observation-tetragon-agent-part/</a></em></p>

<ul>
  <li>Tetragon은 실행 이벤트를 JSON 로그와 GRPC 스트림을 통해 공개합니다. 사용자는 이를 통해 시스템의 모든 실행 과정을 관찰할 수 있습니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 여러 노드가 있는 클러스터에서는 사용하는 Tetragon Pod가 "xwing" Pod와 동일한 노드에 있어야 실행 이벤트를 캡처할 수 있습니다.</span>
<span class="c"># 이 명령을 사용하면 "**xwing**" Pod와 동일한 Kubernetes **노드**에 있는 **Tetragon Pod의 이름을** 가져올 수 있습니다.</span>
<span class="nv">$ POD</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> kube-system get pods <span class="nt">-l</span> <span class="s1">'app.kubernetes.io/name=tetragon'</span> <span class="nt">-o</span> name <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span><span class="si">$(</span>kubectl get pod xwing <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.nodeName}'</span><span class="si">))</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$POD</span>
<span class="c"># =&gt; pod/tetragon-fwccq</span>
  
<span class="c"># 터미널1</span>
<span class="c"># 일치하는 Pod를 식별한 후 해당 Pod를 대상으로 지정하여 명령을 실행합니다 : Tetragon에서 캡처한 실행 이벤트를 반환</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra <span class="nt">-h</span>
<span class="c"># 압축 실행 이벤트에는 이벤트 유형, 포드 이름, 바이너리, 인수가 포함됩니다. 종료 이벤트에는 반환 코드가 포함됩니다.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
  
<span class="c">## JSON 형식으로 전체 실행 이벤트를 보려면 명령 -o compact에서 옵션을 제거</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">--pods</span> xwing
  
<span class="c"># 터미널2</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'curl https://ebpf.io/applications/#tetragon'</span>

<span class="c"># 터미털 1</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; 🚀 process default/xwing /usr/bin/bash -c "curl https://ebpf.io/applications/#tetragon"</span>
<span class="c">#    🚀 process default/xwing /usr/bin/curl https://ebpf.io/applications/#tetragon</span>
<span class="c">#    💥 exit    default/xwing /usr/bin/curl https://ebpf.io/applications/#tetragon 0 </span>

<span class="c"># 터미널2</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'curl https://httpbin.org'</span>

<span class="c"># 터미털 1</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; 🚀 process default/xwing /usr/bin/bash -c "curl https://httpbin.org"</span>
<span class="c">#    🚀 process default/xwing /usr/bin/curl https://httpbin.org</span>
<span class="c">#    💥 exit    default/xwing /usr/bin/curl https://httpbin.org 0</span>

<span class="c"># 터미널2</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'cat /etc/passwd'</span>

<span class="c"># 터미털 1</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; 🚀 process default/xwing /usr/bin/bash -c "cat /etc/passwd"</span>
<span class="c">#    🚀 process default/xwing /usr/bin/cat /etc/passwd</span>
<span class="c">#    💥 exit    default/xwing /usr/bin/cat /etc/passwd 0</span>
</code></pre></div></div>

<h3 id="파일-접속-모니터링">파일 접속 모니터링</h3>

<ul>
  <li>추적 정책으로 민감 파일 모니터링 - <a href="https://tetragon.io/docs/getting-started/file-events/">Docs</a>, <a href="https://isovalent.com/blog/post/file-monitoring-with-ebpf-and-tetragon-part-1/">Blog</a>
</li>
</ul>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_22.png" alt="img.png" class="image-center" loading="lazy" width="1080" height="608">
<em class="image-caption"><a href="https://isovalent.com/blog/post/file-monitoring-with-ebpf-and-tetragon-part-1/">https://isovalent.com/blog/post/file-monitoring-with-ebpf-and-tetragon-part-1/</a></em></p>

<p><img src="/assets/2025/cilium/w8/20250907_cilium_w8_23.png" alt="img_1.png" class="image-center" loading="lazy" width="2048" height="1065">
<em class="image-caption">Figure 3: In-kernel vs user-space filtering</em></p>

<ul>
  <li>YAML 구성 파일을 통해 Tetragon에 <strong>추적 정책</strong>을 추가하면 Tetragon의 기본 실행 추적 기능을 확장할 수 있습니다.</li>
  <li>이러한 정책은 <strong>커널에서 필터링을 수행</strong>하여 커널에서 실행 중인 BPF 프로그램에서 <strong>관심 있는 이벤트</strong>만 <strong>사용자 공간에 게시</strong>되도록 합니다.</li>
  <li>이를 통해 사용량이 많은 시스템에서도 <strong>오버헤드를 낮게 유지</strong>할 수 있습니다.</li>
  <li>아래의 Manifest는 <a href="https://tetragon.io/docs/getting-started/execution/">실행 모니터링</a> 의 예시를 확장하여 Linux에서 <strong>민감한 파일을 모니터링</strong>하는 정책을 적용합니다.</li>
  <li>민감 파일 모니터링 정책 적용</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># file_monitoring.yaml</span>
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: <span class="s2">"file-monitoring-filtered"</span>
spec:
  kprobes:
  - call: <span class="s2">"security_file_permission"</span>
    syscall: <span class="nb">false
    </span><span class="k">return</span>: <span class="nb">true
    </span>args:
    - index: 0
      <span class="nb">type</span>: <span class="s2">"file"</span> <span class="c"># (struct file *) used for getting the path</span>
    - index: 1
      <span class="nb">type</span>: <span class="s2">"int"</span> <span class="c"># 0x04 is MAY_READ, 0x02 is MAY_WRITE</span>
    returnArg:
      index: 0
      <span class="nb">type</span>: <span class="s2">"int"</span>
    returnArgAction: <span class="s2">"Post"</span>
    selectors:
    - matchArgs:      
      - index: 0
        operator: <span class="s2">"Prefix"</span>
        values:
        - <span class="s2">"/boot"</span>           <span class="c"># Reads to sensitive directories</span>
        - <span class="s2">"/root/.ssh"</span>      <span class="c"># Reads to sensitive files we want to know about</span>
        - <span class="s2">"/etc/shadow"</span>
        - <span class="s2">"/etc/profile"</span>
        - <span class="s2">"/etc/sudoers"</span>
        - <span class="s2">"/etc/pam.conf"</span>   <span class="c"># Reads global shell configs bash/csh supported</span>
        - <span class="s2">"/etc/bashrc"</span>
        - <span class="s2">"/etc/csh.cshrc"</span>
        - <span class="s2">"/etc/csh.login"</span>  <span class="c"># Add additional sensitive files here</span>
      - index: 1
        operator: <span class="s2">"Equal"</span>
        values:
        - <span class="s2">"4"</span> <span class="c"># MAY_READ</span>

<span class="c"># Manifest 적용</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/tetragon/main/examples/quickstart/file_monitoring.yaml
<span class="c"># =&gt; tracingpolicy.cilium.io/file-monitoring-filtered created</span>
<span class="nv">$ </span>kubectl get tracingpolicy
<span class="c"># =&gt; NAME                       AGE</span>
<span class="c">#    file-monitoring-filtered   55s</span>
</code></pre></div></div>

<ul>
  <li><strong>Tetragon 파일 액세스 이벤트 관찰</strong></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 터미널2 : 이벤트를 생성하기위애 정책에 참조된 중요한(민감한) 파일을 읽어보세요</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'cat /etc/shadow'</span>

<span class="c"># 터미널1</span>
<span class="nv">$ POD</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> kube-system get pods <span class="nt">-l</span> <span class="s1">'app.kubernetes.io/name=tetragon'</span> <span class="nt">-o</span> name <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span><span class="si">$(</span>kubectl get pod xwing <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.nodeName}'</span><span class="si">))</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; 🚀 process default/xwing /usr/bin/bash -c "cat /etc/shadow"</span>
<span class="c">#    🚀 process default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    📚 read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    📚 read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    📚 read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    📚 read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    💥 exit    default/xwing /usr/bin/cat /etc/shadow 0  </span>

<span class="c"># 터미널2 : 추적 정책에 따라 Tetragon은 민감한 디렉토리에 쓰기를 시도하는 경우(예: /etc디렉토리에 쓰기를 시도하는 경우)에 대한 응답으로 쓰기 이벤트를 생성합니다.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'echo foo &gt;&gt; /etc/bar'</span>

<span class="c"># 터미널1</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; 🚀 process default/xwing /usr/bin/bash -c "echo foo &gt;&gt; /etc/bar"</span>
<span class="c">#    📝 write   default/xwing /usr/bin/bash /etc/bar</span>
<span class="c">#    📝 write   default/xwing /usr/bin/bash /etc/bar</span>
<span class="c">#    💥 exit    default/xwing /usr/bin/bash -c "echo foo &gt;&gt; /etc/bar" 0 </span>

<span class="c"># 정책 삭제</span>
<span class="nv">$ </span>kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/tetragon/main/examples/quickstart/file_monitoring.yaml
<span class="c"># =&gt; tracingpolicy.cilium.io "file-monitoring-filtered" deleted</span>
</code></pre></div></div>

<h3 id="policy-enforcement">Policy Enforcement</h3>

<ul>
  <li>커널 수준에서 정책 제한을 적용관련 내용을 살펴보겠습니다. - <a href="https://tetragon.io/docs/getting-started/enforcement/">Docs</a>
</li>
  <li>Tetragon의 추적 정책은 파일 액세스 이벤트나 네트워크 연결 이벤트와 같은 이벤트를 보고하기 위해 커널 함수를 모니터링하고, 해당 커널 함수에 제한을 적용할 수 있도록 지원합니다.</li>
  <li>Tetragon에서 커널 내 필터링을 사용하면 커널에서 사용자 공간으로 전송되는 이벤트를 제한하여 성능을 크게 향상시킬 수 있습니다.</li>
  <li>또한, 커널 내 필터링을 통해 Tetragon은 커널 수준에서 정책 제한을 적용할 수 있습니다.</li>
  <li>예를 들어, <code class="language-plaintext highlighter-rouge">SIGKILL</code>정책 위반이 감지되었을 때 프로세스에 를 실행하면 해당 프로세스는 더 이상 실행되지 않습니다.</li>
  <li>정책 적용이 시스템 호출을 통해 트리거되는 경우, 애플리케이션은 시스템 호출에서 반환되지 않고 종료됩니다.</li>
  <li>이 섹션에서는 이 시작 가이드에서 이미 배포한 Tetragon 기능(실행, 파일 추적 및 네트워크 추적 정책)에 아래의 네트워크 및 파일 정책 적용을 추가합니다.
    <ul>
      <li>Kubernetes 클러스터에서 나가는 <strong>네트워크 트래픽을 제한</strong>하는 정책 적용</li>
      <li>
<strong>민감한 파일에 블록 쓰기 및 읽기 작업</strong> 적용</li>
    </ul>
  </li>
  <li>구체적인 구현 세부 사항은 <a href="https://tetragon.io/docs/concepts/enforcement/">시행</a> 개념 섹션을 참조하세요.</li>
</ul>

<h5 id="파일-액세스-제한-적용">파일 액세스 제한 적용</h5>

<ul>
  <li>
<a href="https://tetragon.io/docs/getting-started/file-events/">다음은 파일 액세스 모니터링</a> 의 예시를 적용하여 민감한 파일이 읽히지 않도록 확장하는 방법입니다.</li>
  <li>사용되는 정책은 이며 <a href="https://github.com/cilium/tetragon/blob/main/examples/quickstart/file_monitoring_enforce.yaml"><code class="language-plaintext highlighter-rouge">file_monitoring_enforce.yaml</code></a>, 필요에 따라 검토하고 확장할 수 있습니다.</li>
  <li>관찰 정책과 적용 정책의 유일한 차이점은 애플리케이션에 작업 블록을 추가 <code class="language-plaintext highlighter-rouge">SIGKILL</code>하고 작업 시 오류를 반환한다는 것입니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># file_monitoring_enforce.yaml : matchaction 확인</span>
apiVersion: cilium.io/v1alpha1
kind: TracingPolicyNamespaced
metadata:
  name: <span class="s2">"file-monitoring-filtered"</span>
spec:
  kprobes:
  - call: <span class="s2">"security_file_permission"</span>
    syscall: <span class="nb">false
    </span><span class="k">return</span>: <span class="nb">true
    </span>args:
    - index: 0
      <span class="nb">type</span>: <span class="s2">"file"</span> <span class="c"># (struct file *) used for getting the path</span>
    - index: 1
      <span class="nb">type</span>: <span class="s2">"int"</span> <span class="c"># 0x04 is MAY_READ, 0x02 is MAY_WRITE</span>
    returnArg:
      index: 0
      <span class="nb">type</span>: <span class="s2">"int"</span>
    returnArgAction: <span class="s2">"Post"</span>
    selectors:
    - matchArgs:
      - index: 0
        operator: <span class="s2">"Prefix"</span>
        values:
        - <span class="s2">"/boot"</span>           <span class="c"># Reads to sensitive directories</span>
        - <span class="s2">"/root/.ssh"</span>      <span class="c"># Reads to sensitive files we want to know about</span>
        - <span class="s2">"/etc/shadow"</span>
        - <span class="s2">"/etc/profile"</span>
        - <span class="s2">"/etc/sudoers"</span>
        - <span class="s2">"/etc/pam.conf"</span>   <span class="c"># Reads global shell configs bash/csh supported</span>
        - <span class="s2">"/etc/bashrc"</span>
        - <span class="s2">"/etc/csh.cshrc"</span>
        - <span class="s2">"/etc/csh.login"</span>  <span class="c"># Add additional sensitive files here</span>
      - index: 1
        operator: <span class="s2">"Equal"</span>
        values:
        - <span class="s2">"4"</span> <span class="c"># MAY_READ</span>
      matchActions:
      - action: Sigkill
...
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/cilium/tetragon/main/examples/quickstart/file_monitoring_enforce.yaml
<span class="c"># =&gt; tracingpolicynamespaced.cilium.io/file-monitoring-filtered created</span>
<span class="nv">$ </span>kubectl get tracingpolicynamespaced
<span class="c"># =&gt; NAME                       AGE</span>
<span class="c">#    file-monitoring-filtered   11s</span>
  
<span class="c"># 터미널1</span>
<span class="nv">$ POD</span><span class="o">=</span><span class="si">$(</span>kubectl <span class="nt">-n</span> kube-system get pods <span class="nt">-l</span> <span class="s1">'app.kubernetes.io/name=tetragon'</span> <span class="nt">-o</span> name <span class="nt">--field-selector</span> spec.nodeName<span class="o">=</span><span class="si">$(</span>kubectl get pod xwing <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.nodeName}'</span><span class="si">))</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; 🚀 process default/xwing /usr/bin/bash -c "cat /etc/shadow"</span>
<span class="c">#    🚀 process default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    📚 read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    📚 read    default/xwing /usr/bin/cat /etc/shadow</span>
<span class="c">#    💥 exit    default/xwing /usr/bin/cat /etc/shadow &lt;span style="color: green;"&gt;SIGKILL&lt;/span&gt;</span>
  
<span class="c"># 터미널2 : 정의된 정책에 포함된 파일 중 하나인 민감한 파일을 읽어보세요</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'cat /etc/shadow'</span>
<span class="c"># =&gt; command terminated with exit code 137</span>
<span class="c"># &lt;span style="color: green;"&gt;👉 이번에는 "cat /etc/shadow" 명령이 SIGKILL로 인해 종료된 것을 확인할 수 있습니다.&lt;/span&gt;</span>
  
<span class="c"># 시행된 파일 정책에 포함되지 않은 파일을 읽거나 쓰려는 시도는 영향을 받지 않습니다.</span>
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> xwing <span class="nt">--</span> bash <span class="nt">-c</span> <span class="s1">'echo foo &gt; /tmp/test.txt'</span>

<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-n</span> kube-system <span class="nv">$POD</span> <span class="nt">-c</span> tetragon <span class="nt">--</span> tetra getevents <span class="nt">-o</span> compact <span class="nt">--pods</span> xwing
<span class="c"># =&gt; 🚀 process default/xwing /usr/bin/bash -c "echo foo &gt; /tmp/test.txt"</span>
<span class="c">#    💥 exit    default/xwing /usr/bin/bash -c "echo foo &gt; /tmp/test.txt" 0  </span>
</code></pre></div></div>

<hr>

<h2 id="마치며">마치며</h2>

<p>Cilium Security와 Tetragon에 대해 알아보았습니다.
Cilium 자체도 다양한 보안 기능을 제공하고 있는데 Tetragon까지 더해지니
다양한 보안 요구사항을 충족시킬 수 있을 것 같습니다.
TLS Interception 기능도 흥미로웠는데 완전 MITM 공격인것 같으면서도
트러블 슈팅에 큰 도움이 될 수 있을 것 같습니다.</p>

<p>벌써 Cilium 스터디가 끝났습니다.
Cilium 설치와 기본 설정에서 부터, Hubble을 비롯한 관측성과 파드 네트워크 상세, BGP 라우팅, 서비스메시, Performance, Security와 Tetragon 등등
따라가기도 벅찼지만 많은 것을 배울 수 있었던 시간이었습니다.
매주 스터디 마다 느낀 점은 Cilium의 생태계는 정말 넓고 깊다는 것입니다.
앞으로도 꾸준히 공부하고 실습하면서 익혀나가야 할 것 같습니다.</p>

<p>실습할때 복잡한 Kubernetes 구성이 필요한 경우도 많았는데
매번 편리하게 환경을 구축할 수 있도록 해주셔서 환경 구성에는 어려움없이 진행할 수 있었습니다.
매주 실습자료 준비와 진행에 애써주신 가시다 님께 감사드립니다. <img class="emoji" title=":bow:" alt=":bow:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f647.png" height="20" width="20" loading="lazy"></p>

  </div>

  <div id="toc-minimap" class="toc-minimap collapsed">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0">들어가며</a></li>
<li class="toc-entry toc-h2"><a href="#%EC%8B%A4%EC%8A%B5%ED%99%98%EA%B2%BD-%EB%B0%B0%ED%8F%AC">실습환경 배포</a></li>
<li class="toc-entry toc-h2">
<a href="#cilium-security-%EA%B3%B5%EC%8B%9D%EB%AC%B8%EC%84%9C">Cilium Security 공식문서</a>
<ul>
<li class="toc-entry toc-h3"><a href="#cilium%EC%9D%B4-%EC%A0%9C%EA%B3%B5%ED%95%98%EB%8A%94-%EB%B3%B4%EC%95%88-%EA%B0%9C%EC%9A%94">Cilium이 제공하는 보안 개요</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#cilium-security-%EC%8B%A4%EC%8A%B5">Cilium Security 실습</a>
<ul>
<li class="toc-entry toc-h3"><a href="#-lab1-locking-down-external-access-with-dns-based-policies">🔬 Lab1. Locking Down External Access with DNS-Based Policies</a></li>
<li class="toc-entry toc-h3"><a href="#transparent-encryption-with-wireguard">Transparent Encryption with WireGuard</a></li>
<li class="toc-entry toc-h3"><a href="#-lab2-wireguard-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EC%8B%A4%EC%8A%B5">🔬 Lab2. WireGuard 설정 및 실습</a></li>
<li class="toc-entry toc-h3"><a href="#inspecting-tls-encrypted-connections">Inspecting TLS Encrypted Connections</a></li>
<li class="toc-entry toc-h3"><a href="#-lab3-tls-interception-%EC%8B%A4%EC%8A%B5">🔬 Lab3. TLS Interception 실습</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#tetragon">Tetragon</a>
<ul>
<li class="toc-entry toc-h3"><a href="#tetragon-%EC%86%8C%EA%B0%9C">Tetragon 소개</a></li>
<li class="toc-entry toc-h3"><a href="#tetragon-%EC%84%A4%EC%B9%98">Tetragon 설치</a></li>
<li class="toc-entry toc-h3"><a href="#%EC%8B%A4%ED%96%89-%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">실행 모니터링</a></li>
<li class="toc-entry toc-h3"><a href="#%ED%8C%8C%EC%9D%BC-%EC%A0%91%EC%86%8D-%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81">파일 접속 모니터링</a></li>
<li class="toc-entry toc-h3"><a href="#policy-enforcement">Policy Enforcement</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#%EB%A7%88%EC%B9%98%EB%A9%B0">마치며</a></li>
</ul>
  </div>
<a class="u-url" href="/posts/2025-09-07-Cilium-Week8/" hidden></a>
</article>



<div class="PageNavigation">
  
  <a class="prev" href="/posts/2025-08-31-Cilium-Week7/">« [Cilium] K8S/Cilium Performance</a>
  
  
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https://sweetlittlebird.github.io/posts/2025-09-07-Cilium-Week8/";
this.page.identifier = "/posts/Cilium - Week8";
};
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
      </div>

<!--      <div class="adsbygoogle-side">-->
<!--        &lt;!&ndash; ad_side &ndash;&gt;-->
<!--        <ins class="adsbygoogle "-->
<!--             style="display: block"-->
<!--             data-ad-client="ca-pub-6564723532026864"-->
<!--             data-ad-slot="1339398797"-->
<!--             data-ad-format="auto"-->
<!--             data-full-width-responsive="true"></ins>-->
<!--      </div>-->
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Sweet Little Bird</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Sweet Little Bird</li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/sweetlittlebird"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sweetlittlebird</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>공부 기록과 개발 이야기를 담은 블로그입니다.</p>
      </div>
    </div>

  </div>

</footer>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>
      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
            <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>
          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
          </button>
          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
          </button>
          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWGY9N8QXY"></script>

    
    <script async src="/assets/dist/app.min.js"></script>
    
  
    <a href="#" id="back-to-top"><span>Back to Top</span></a>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6564723532026864" crossorigin="anonymous"></script>
    <!--<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>-->
  </body>

</html>
